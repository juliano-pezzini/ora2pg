-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_mens_itens_limite_pck.obter_regras_itens_limite ( nr_seq_contrato_p pls_contrato.nr_sequencia%type, nr_seq_titular_p pls_segurado.nr_sequencia%type, nr_seq_segurado_p pls_segurado.nr_sequencia%type, dt_mesano_referencia_p pls_mensalidade_segurado.dt_mesano_referencia%type, dt_referencia_p pls_mensalidade.dt_referencia%type, nr_seq_plano_p pls_plano.nr_sequencia%type, nr_seq_segurado_ant_p pls_segurado.nr_seq_segurado_ant%type, nr_seq_titular_ant_p pls_segurado.nr_seq_titular%type) AS $body$
DECLARE


regra_index_w			bigint;
item_index_w			bigint;
apropriacao_index_w		bigint;
vl_total_item_familia_w		double precision;
ie_apropriacao_w		varchar(1);
nr_seq_titular_w		pls_segurado.nr_sequencia%type;
nr_seq_contrato_ant_w		pls_contrato.nr_sequencia%type;
nr_seq_plano_ant_w		pls_plano.nr_sequencia%type;
nr_seq_regra_lim_copart_ant_w	pls_regra_limite_copartic.nr_sequencia%type;
qt_apropriacao_regra_ant_w	bigint;
vl_segurado_anterior_w		double precision;
vl_total_segurado_anterior_w	double precision;
vl_total_itens_referencia_w	double precision;
dt_referencia_w			timestamp;
nr_seq_titular_ant_w		pls_segurado.nr_seq_titular%type;
nr_seq_titular_anterior_w	pls_segurado.nr_seq_titular%type;
excecao_copartic_index_w	bigint;

c01 CURSOR FOR
	SELECT	coalesce(a.ie_acao,1) ie_acao,
		coalesce(a.ie_aplicacao_regra,'I') ie_aplicacao_regra,
		a.nr_sequencia nr_seq_regra,
		a.vl_max_copartic,
		coalesce(a.ie_parcela, 'B') ie_parcela
	from	pls_regra_limite_copartic	a
	where	a.nr_seq_contrato	= nr_seq_contrato_p
	and	((a.nr_seq_plano_contrato = nr_seq_plano_p) or (coalesce(a.nr_seq_plano_contrato::text, '') = ''))
	and	(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
	and	dt_mesano_referencia_p	between coalesce(a.dt_inicio_vigencia,dt_mesano_referencia_p) and coalesce(a.dt_fim_vigencia,dt_mesano_referencia_p)
	
union

	SELECT	coalesce(a.ie_acao,1) ie_acao,
		coalesce(a.ie_aplicacao_regra,'I') ie_aplicacao_regra,
		a.nr_sequencia nr_seq_regra,
		a.vl_max_copartic,
		coalesce(a.ie_parcela, 'B') ie_parcela
	from	pls_regra_limite_copartic	a
	where	coalesce(a.nr_seq_contrato::text, '') = ''
	and	a.nr_seq_plano = nr_seq_plano_p
	and	(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
	and	not exists (	select	1
				from	pls_regra_limite_copartic x
				where	x.nr_seq_contrato = nr_seq_contrato_p
				and	(x.dt_liberacao IS NOT NULL AND x.dt_liberacao::text <> ''))
	and	dt_mesano_referencia_p	between coalesce(a.dt_inicio_vigencia,dt_mesano_referencia_p) and coalesce(a.dt_fim_vigencia,dt_mesano_referencia_p);

c02 CURSOR(	nr_seq_regra_pc		pls_regra_limite_copartic.nr_sequencia%type) FOR
	SELECT	b.ie_tipo_item,
		b.nr_seq_tipo_lanc
	from	pls_regra_limite_mens_item	b
	where	b.nr_seq_regra	= nr_seq_regra_pc;
	
C03 CURSOR(	nr_seq_regra_pc 	pls_regra_limite_copartic.nr_sequencia%type) FOR
	SELECT	nr_seq_centro_apropriacao
	from	pls_regra_limite_mens_apro
	where	nr_seq_regra = nr_seq_regra_pc;

-- Verificar se tem excecao na regra de coparticipacao	

c04 CURSOR(	nr_seq_regra_pc 	pls_regra_limite_copartic.nr_sequencia%type) FOR
	SELECT	a.nr_seq_tipo_coparticipacao
	from	pls_regra_limite_exc_copar	a
	where	a.nr_seq_regra = nr_seq_regra_pc;

BEGIN
current_setting('pls_mens_itens_limite_pck.regra_limite_item_w')::vetor.delete;
regra_index_w		:= 0;

for vet_c01_w in c01 loop
	begin
	
	if (vet_c01_w.ie_parcela = 'B') then
		dt_referencia_w	:= dt_mesano_referencia_p;
	elsif (vet_c01_w.ie_parcela = 'P') then
		dt_referencia_w	:= dt_referencia_p;
	end if;

	regra_index_w			:= regra_index_w + 1;
	item_index_w			:= 0;
	apropriacao_index_w		:= 0;
	vl_total_item_familia_w		:= 0;
	vl_segurado_anterior_w		:= 0;
	vl_total_segurado_anterior_w	:= 0;
	vl_total_itens_referencia_w	:= 0;
	ie_apropriacao_w		:= 'N';
	excecao_copartic_index_w	:= 0;
	
	current_setting('pls_mens_itens_limite_pck.regra_limite_item_w')::vetor[regra_index_w].ie_acao		:= vet_c01_w.ie_acao;
	current_setting('pls_mens_itens_limite_pck.regra_limite_item_w')::vetor[regra_index_w].ie_aplicacao_regra	:= vet_c01_w.ie_aplicacao_regra;
	current_setting('pls_mens_itens_limite_pck.regra_limite_item_w')::vetor[regra_index_w].nr_seq_regra		:= vet_c01_w.nr_seq_regra;
	current_setting('pls_mens_itens_limite_pck.regra_limite_item_w')::vetor[regra_index_w].vl_maximo_item	:= vet_c01_w.vl_max_copartic;
	
	for vet_c03_w in c03(vet_c01_w.nr_seq_regra) loop
		begin
		apropriacao_index_w	:= apropriacao_index_w + 1;
		ie_apropriacao_w	:= 'S';
		
		current_setting('pls_mens_itens_limite_pck.regra_limite_item_w')::vetor[regra_index_w].regra_apropriacao(apropriacao_index_w).nr_seq_centro_apropriacao	:= vet_c03_w.nr_seq_centro_apropriacao;
		end;
	end loop;
	
	-- Regra excecao coparticipacao

	for vet_c04_w in c04(vet_c01_w.nr_seq_regra ) loop
		begin
		excecao_copartic_index_w		:= excecao_copartic_index_w + 1;
		
		current_setting('pls_mens_itens_limite_pck.regra_limite_item_w')::vetor[regra_index_w].regra_excecao_copartic(excecao_copartic_index_w).nr_seq_tipo_coparticipacao	:= vet_c04_w.nr_seq_tipo_coparticipacao;
		end;
	end loop;
	
	current_setting('pls_mens_itens_limite_pck.regra_limite_item_w')::vetor[regra_index_w].ie_apropriacao	:= ie_apropriacao_w;
	
	nr_seq_titular_w	:= coalesce(nr_seq_titular_p, nr_seq_segurado_p);
	
	--Adicionar os itens da regra no array

	for vet_c02_w in c02(vet_c01_w.nr_seq_regra) loop
		begin
		item_index_w 	:= item_index_w + 1;
		
		current_setting('pls_mens_itens_limite_pck.regra_limite_item_w')::vetor[regra_index_w].regra_item(item_index_w).ie_tipo_item 	:= vet_c02_w.ie_tipo_item;
		current_setting('pls_mens_itens_limite_pck.regra_limite_item_w')::vetor[regra_index_w].regra_item(item_index_w).nr_seq_tipo_lanc 	:= vet_c02_w.nr_seq_tipo_lanc;
		
		if (vet_c01_w.ie_aplicacao_regra = 'F') then --Somar o valor dos itens 
			if (ie_apropriacao_w = 'S') then
				if (current_setting('pls_mens_itens_limite_pck.regra_limite_item_w')::vetor[regra_index_w].regra_apropriacao.count > 0) then
					for i in current_setting('pls_mens_itens_limite_pck.regra_limite_item_w')::vetor[regra_index_w].regra_apropriacao.first..regra_limite_item_w[regra_index_w].regra_apropriacao.last loop
						begin
						vl_total_item_familia_w	:= vl_total_item_familia_w + pls_mens_itens_pck.obter_valor(	nr_seq_titular_w, null, vet_c02_w.ie_tipo_item,
																	current_setting('pls_mens_itens_limite_pck.regra_limite_item_w')::vetor[regra_index_w].regra_apropriacao(i).nr_seq_centro_apropriacao, vet_c02_w.nr_seq_tipo_lanc, dt_referencia_w,
																	vet_c01_w.ie_parcela);
						end;
					end loop;
				end if;
			else
				vl_total_item_familia_w	:= vl_total_item_familia_w + pls_mens_itens_pck.obter_valor(	nr_seq_titular_w, null, vet_c02_w.ie_tipo_item,
															null, vet_c02_w.nr_seq_tipo_lanc, dt_referencia_w,
															vet_c01_w.ie_parcela);
			end if;
		elsif	(vet_c01_w.ie_aplicacao_regra = 'I' AND vet_c01_w.ie_parcela = 'P') then
			if (ie_apropriacao_w = 'S') then
				if (current_setting('pls_mens_itens_limite_pck.regra_limite_item_w')::vetor[regra_index_w].regra_apropriacao.count > 0) then
					for i in current_setting('pls_mens_itens_limite_pck.regra_limite_item_w')::vetor[regra_index_w].regra_apropriacao.first..regra_limite_item_w[regra_index_w].regra_apropriacao.last loop
						begin
						vl_total_itens_referencia_w	:= vl_total_itens_referencia_w + pls_mens_itens_pck.obter_valor(	null, nr_seq_segurado_p, vet_c02_w.ie_tipo_item,
																			current_setting('pls_mens_itens_limite_pck.regra_limite_item_w')::vetor[regra_index_w].regra_apropriacao(i).nr_seq_centro_apropriacao, vet_c02_w.nr_seq_tipo_lanc, dt_referencia_w,
																			vet_c01_w.ie_parcela);
						end;
					end loop;
				end if;
			else
				vl_total_itens_referencia_w := vl_total_itens_referencia_w + pls_mens_itens_pck.obter_valor(	null, nr_seq_segurado_p, vet_c02_w.ie_tipo_item,
																null, vet_c02_w.nr_seq_tipo_lanc, dt_referencia_w,
																vet_c01_w.ie_parcela);
			end if;
		end if;
		end;
	end loop;

	if (nr_seq_segurado_ant_p IS NOT NULL AND nr_seq_segurado_ant_p::text <> '') or (nr_seq_titular_ant_p IS NOT NULL AND nr_seq_titular_ant_p::text <> '') then
		if (nr_seq_segurado_ant_p IS NOT NULL AND nr_seq_segurado_ant_p::text <> '') then
			select	nr_seq_contrato,
				nr_seq_plano,
				nr_seq_titular
			into STRICT	nr_seq_contrato_ant_w,
				nr_seq_plano_ant_w,
				nr_seq_titular_ant_w
			from	pls_segurado
			where	nr_sequencia = nr_seq_segurado_ant_p;
		elsif (nr_seq_titular_ant_p IS NOT NULL AND nr_seq_titular_ant_p::text <> '') then
			select	nr_seq_contrato,
				nr_seq_plano,
				nr_seq_titular
			into STRICT	nr_seq_contrato_ant_w,
				nr_seq_plano_ant_w,
				nr_seq_titular_ant_w
			from	pls_segurado
			where	nr_sequencia = nr_seq_titular_ant_p;
		end if;
		
		if	(nr_seq_contrato_ant_w IS NOT NULL AND nr_seq_contrato_ant_w::text <> '' AND nr_seq_plano_ant_w IS NOT NULL AND nr_seq_plano_ant_w::text <> '') then
			select	max(a.nr_sequencia)
			into STRICT	nr_seq_regra_lim_copart_ant_w
			from	pls_regra_limite_copartic	a
			where	a.nr_seq_contrato	= nr_seq_contrato_ant_w
			and	((a.nr_seq_plano_contrato = nr_seq_plano_ant_w) or (coalesce(a.nr_seq_plano_contrato::text, '') = ''))
			and	(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
			and	dt_referencia_w	between coalesce(a.dt_inicio_vigencia,dt_referencia_w) and coalesce(a.dt_fim_vigencia,dt_referencia_w);
			
			if (nr_seq_regra_lim_copart_ant_w IS NOT NULL AND nr_seq_regra_lim_copart_ant_w::text <> '') then
				select	count(1)
				into STRICT	qt_apropriacao_regra_ant_w
				from	pls_regra_limite_mens_apro
				where	nr_seq_regra = nr_seq_regra_lim_copart_ant_w;
				
				if (vet_c01_w.ie_aplicacao_regra = 'I') then
					if (qt_apropriacao_regra_ant_w > 0) then
						if (vet_c01_w.ie_parcela = 'B') then
							select	coalesce(sum(a.vl_apropriacao),0) vl_apropriacao
							into STRICT	vl_segurado_anterior_w
							from	(SELECT	coalesce(d.vl_apropriacao,0) vl_apropriacao,
									d.nr_seq_centro_apropriacao,
									'20' ie_tipo_item,
									c.nr_seq_tipo_lanc,
									null nr_seq_tipo_coparticipacao
								from	pls_mensalidade_seg_item	c,
									pls_mensalidade_segurado	b,
									pls_mensalidade			a,
									pls_mens_seg_item_aprop		d
								where	b.nr_sequencia			= c.nr_seq_mensalidade_seg
								and	a.nr_sequencia			= b.nr_seq_mensalidade
								and	c.nr_sequencia			= d.nr_seq_item
								and	b.nr_seq_segurado 		= nr_seq_segurado_ant_p
								and	b.dt_mesano_referencia		= dt_referencia_w
								and	coalesce(a.ie_cancelamento::text, '') = ''
								and	c.ie_tipo_item = '20'
								
union all

								SELECT	coalesce(d.vl_apropriacao,0) vl_apropriacao,
									d.nr_seq_centro_apropriacao,
									c.ie_tipo_item,
									c.nr_seq_tipo_lanc,
									(select	max(x.nr_seq_tipo_coparticipacao)
									from	pls_conta_coparticipacao y,
										pls_regra_coparticipacao x
									where	x.nr_sequencia = y.nr_seq_regra
									and	y.nr_sequencia = e.nr_seq_conta_copartic) nr_seq_tipo_coparticipacao
								from	pls_mensalidade_seg_item	c,
									pls_mensalidade_segurado	b,
									pls_mensalidade			a,
									pls_mensalidade_item_conta	e,
									pls_mens_item_conta_aprop	d
								where	b.nr_sequencia			= c.nr_seq_mensalidade_seg
								and	a.nr_sequencia			= b.nr_seq_mensalidade
								and	c.nr_sequencia 			= e.nr_seq_item
								and	e.nr_sequencia			= d.nr_seq_mens_item_conta
								and	b.nr_seq_segurado 		= nr_seq_segurado_ant_p
								and	b.dt_mesano_referencia		= dt_referencia_w
								and	coalesce(a.ie_cancelamento::text, '') = ''
								and	c.ie_tipo_item <> '20') a
							where	exists (	select	1
									from	pls_regra_limite_mens_apro x
									where	x.nr_seq_regra = nr_seq_regra_lim_copart_ant_w
									and	x.nr_seq_centro_apropriacao = a.nr_seq_centro_apropriacao)
							and	exists (	select	1
									from	pls_regra_limite_mens_item x
									where	x.ie_tipo_item = a.ie_tipo_item
									and (coalesce(x.nr_seq_tipo_lanc::text, '') = '' or x.nr_seq_tipo_lanc = a.nr_seq_tipo_lanc)
									and	x.nr_seq_regra = nr_seq_regra_lim_copart_ant_w)
							and not exists (	select	1
									from	pls_regra_limite_exc_copar x
									where	x.nr_seq_tipo_coparticipacao = a.nr_seq_tipo_coparticipacao
									and	x.nr_seq_regra = nr_seq_regra_lim_copart_ant_w);
						elsif (vet_c01_w.ie_parcela = 'P') then
							select	coalesce(sum(a.vl_apropriacao),0) vl_apropriacao
							into STRICT	vl_segurado_anterior_w
							from	(SELECT	coalesce(d.vl_apropriacao,0) vl_apropriacao,
									d.nr_seq_centro_apropriacao,
									'20' ie_tipo_item,
									c.nr_seq_tipo_lanc,
									null nr_seq_tipo_coparticipacao
								from	pls_mensalidade_seg_item	c,
									pls_mensalidade_segurado	b,
									pls_mensalidade			a,
									pls_mens_seg_item_aprop		d
								where	b.nr_sequencia			= c.nr_seq_mensalidade_seg
								and	a.nr_sequencia			= b.nr_seq_mensalidade
								and	c.nr_sequencia			= d.nr_seq_item
								and	b.nr_seq_segurado 		= nr_seq_segurado_ant_p
								and	a.dt_referencia			= dt_referencia_w
								and	coalesce(a.ie_cancelamento::text, '') = ''
								and	c.ie_tipo_item = '20'
								
union all

								SELECT	coalesce(d.vl_apropriacao,0) vl_apropriacao,
									d.nr_seq_centro_apropriacao,
									c.ie_tipo_item,
									null nr_seq_tipo_lanc,
									(select	max(x.nr_seq_tipo_coparticipacao)
									from	pls_conta_coparticipacao y,
										pls_regra_coparticipacao x
									where	x.nr_sequencia = y.nr_seq_regra
									and	y.nr_sequencia = e.nr_seq_conta_copartic) nr_seq_tipo_coparticipacao
								from	pls_mensalidade_seg_item	c,
									pls_mensalidade_segurado	b,
									pls_mensalidade			a,
									pls_mensalidade_item_conta	e,
									pls_mens_item_conta_aprop	d
								where	b.nr_sequencia			= c.nr_seq_mensalidade_seg
								and	a.nr_sequencia			= b.nr_seq_mensalidade
								and	c.nr_sequencia 			= e.nr_seq_item
								and	e.nr_sequencia			= d.nr_seq_mens_item_conta
								and	b.nr_seq_segurado 		= nr_seq_segurado_ant_p
								and	a.dt_referencia			= dt_referencia_w
								and	coalesce(a.ie_cancelamento::text, '') = ''
								and	c.ie_tipo_item <> '20') a
							where	exists (	select	1
									from	pls_regra_limite_mens_apro x
									where	x.nr_seq_regra = nr_seq_regra_lim_copart_ant_w
									and	x.nr_seq_centro_apropriacao = a.nr_seq_centro_apropriacao)
							and	exists (	select	1
									from	pls_regra_limite_mens_item x
									where	x.ie_tipo_item = a.ie_tipo_item
									and (coalesce(x.nr_seq_tipo_lanc::text, '') = '' or x.nr_seq_tipo_lanc = a.nr_seq_tipo_lanc)
									and	x.nr_seq_regra = nr_seq_regra_lim_copart_ant_w)
							and not exists (	select	1
									from	pls_regra_limite_exc_copar x
									where	x.nr_seq_tipo_coparticipacao = a.nr_seq_tipo_coparticipacao
									and	x.nr_seq_regra = nr_seq_regra_lim_copart_ant_w);
						end if;
					else
						if (vet_c01_w.ie_parcela = 'B') then
							select	coalesce(sum(a.vl_item),0) vl_item
							into STRICT	vl_segurado_anterior_w
							from	(SELECT	coalesce(c.vl_item,0) vl_item,
									null nr_seq_tipo_coparticipacao,
									c.nr_seq_tipo_lanc,
									'20' ie_tipo_item								
								from	pls_mensalidade_seg_item	c,
									pls_mensalidade_segurado	b,
									pls_mensalidade			a
								where	b.nr_sequencia			= c.nr_seq_mensalidade_seg
								and	a.nr_sequencia			= b.nr_seq_mensalidade
								and	b.nr_seq_segurado 		= nr_seq_segurado_ant_p
								and	b.dt_mesano_referencia		= dt_referencia_w
								and	coalesce(a.ie_cancelamento::text, '') = ''
								and	c.ie_tipo_item = '20'
								
union all

								SELECT	coalesce(d.vl_item, 0) vl_item,
									(select	max(x.nr_seq_tipo_coparticipacao)
									from	pls_conta_coparticipacao y,
										pls_regra_coparticipacao x
									where	x.nr_sequencia = y.nr_seq_regra
									and	y.nr_sequencia = d.nr_seq_conta_copartic) nr_seq_tipo_coparticipacao,
									null nr_seq_tipo_lanc,
									c.ie_tipo_item
								from	pls_mensalidade_seg_item	c,
									pls_mensalidade_segurado	b,
									pls_mensalidade			a,
									pls_mensalidade_item_conta	d
								where	b.nr_sequencia			= c.nr_seq_mensalidade_seg
								and	a.nr_sequencia			= b.nr_seq_mensalidade
								and	c.nr_sequencia			= d.nr_seq_item
								and	b.dt_mesano_referencia		= dt_referencia_w
								and	coalesce(a.ie_cancelamento::text, '') = ''
								and	c.ie_tipo_item <> '20') a
							where	exists (	select	1
										from	pls_regra_limite_mens_item x
										where	x.ie_tipo_item = a.ie_tipo_item
										and (coalesce(x.nr_seq_tipo_lanc::text, '') = '' or x.nr_seq_tipo_lanc = a.nr_seq_tipo_lanc)
										and	x.nr_seq_regra = nr_seq_regra_lim_copart_ant_w)
							and not exists (	select	1
									from	pls_regra_limite_exc_copar x
									where	x.nr_seq_tipo_coparticipacao = a.nr_seq_tipo_coparticipacao
									and	x.nr_seq_regra = nr_seq_regra_lim_copart_ant_w);
						elsif (vet_c01_w.ie_parcela = 'P') then
							select	coalesce(sum(a.vl_item),0)
							into STRICT	vl_segurado_anterior_w
							from	(SELECT	coalesce(c.vl_item,0) vl_item,
									null nr_seq_tipo_coparticipacao,
									c.nr_seq_tipo_lanc,
									'20' ie_tipo_item		
								from	pls_mensalidade_seg_item	c,
									pls_mensalidade_segurado	b,
									pls_mensalidade			a
								where	b.nr_sequencia			= c.nr_seq_mensalidade_seg
								and	a.nr_sequencia			= b.nr_seq_mensalidade
								and	b.nr_seq_segurado 		= nr_seq_segurado_ant_p
								and	a.dt_referencia			= dt_referencia_w
								and	coalesce(a.ie_cancelamento::text, '') = ''
								and	c.ie_tipo_item = '20'
								
union all

								SELECT	coalesce(d.vl_item, 0) vl_item,
									(select	max(x.nr_seq_tipo_coparticipacao)
									from	pls_conta_coparticipacao y,
										pls_regra_coparticipacao x
									where	x.nr_sequencia = y.nr_seq_regra
									and	y.nr_sequencia = d.nr_seq_conta_copartic) nr_seq_tipo_coparticipacao,
									null nr_seq_tipo_lanc,
									c.ie_tipo_item
								from	pls_mensalidade_seg_item	c,
									pls_mensalidade_segurado	b,
									pls_mensalidade			a,
									pls_mensalidade_item_conta	d
								where	b.nr_sequencia			= c.nr_seq_mensalidade_seg
								and	a.nr_sequencia			= b.nr_seq_mensalidade
								and	c.nr_sequencia			= d.nr_seq_item
								and	b.dt_mesano_referencia		= dt_referencia_w
								and	coalesce(a.ie_cancelamento::text, '') = ''
								and	c.ie_tipo_item <> '20') a
							where	exists (	select	1
									from	pls_regra_limite_mens_item x
									where	x.ie_tipo_item = a.ie_tipo_item
									and (coalesce(x.nr_seq_tipo_lanc::text, '') = '' or x.nr_seq_tipo_lanc = a.nr_seq_tipo_lanc)
									and	x.nr_seq_regra = nr_seq_regra_lim_copart_ant_w)
							and not exists (	select	1
									from	pls_regra_limite_exc_copar x
									where	x.nr_seq_tipo_coparticipacao = a.nr_seq_tipo_coparticipacao
									and	x.nr_seq_regra = nr_seq_regra_lim_copart_ant_w);
							
						end if;
					end if;

					for r_c02_w in c02(nr_seq_regra_lim_copart_ant_w) loop
						begin
						if (qt_apropriacao_regra_ant_w > 0) then
							for r_c03_w in c03(nr_seq_regra_lim_copart_ant_w) loop
								begin
								vl_total_segurado_anterior_w := vl_total_segurado_anterior_w + pls_mens_itens_pck.obter_valor(	null, nr_seq_segurado_ant_p, r_c02_w.ie_tipo_item,
																				r_c03_w.nr_seq_centro_apropriacao, r_c02_w.nr_seq_tipo_lanc, dt_referencia_w,
																				vet_c01_w.ie_parcela);
								end;
							end loop;
						else
							vl_total_segurado_anterior_w := vl_total_segurado_anterior_w + pls_mens_itens_pck.obter_valor(	null, nr_seq_segurado_ant_p, r_c02_w.ie_tipo_item,
																			null, r_c02_w.nr_seq_tipo_lanc, dt_referencia_w,
																			vet_c01_w.ie_parcela);
						end if;
						end;
					end loop;
				elsif (vet_c01_w.ie_aplicacao_regra = 'F') then
					if (nr_seq_titular_ant_p IS NOT NULL AND nr_seq_titular_ant_p::text <> '') then
						nr_seq_titular_anterior_w	:= nr_seq_titular_ant_p;
					else
						nr_seq_titular_anterior_w	:= coalesce(nr_seq_titular_ant_w, nr_seq_segurado_ant_p);
					end if;	
									
					if (qt_apropriacao_regra_ant_w > 0) then
						if (vet_c01_w.ie_parcela = 'B') then
							select	coalesce(sum(a.vl_apropriacao),0) vl_apropriacao
							into STRICT	vl_segurado_anterior_w
							from	(SELECT	coalesce(d.vl_apropriacao,0) vl_apropriacao,
									d.nr_seq_centro_apropriacao,
									'20' ie_tipo_item,
									c.nr_seq_tipo_lanc,
									null nr_seq_tipo_coparticipacao
								from	pls_mensalidade_seg_item	c,
									pls_mensalidade_segurado	b,
									pls_mensalidade			a,
									pls_mens_seg_item_aprop		d
								where	b.nr_sequencia			= c.nr_seq_mensalidade_seg
								and	a.nr_sequencia			= b.nr_seq_mensalidade
								and	c.nr_sequencia			= d.nr_seq_item
								and (b.nr_seq_segurado 		= nr_seq_titular_anterior_w or b.nr_seq_titular = nr_seq_titular_anterior_w)
								and	b.dt_mesano_referencia		= dt_referencia_w
								and	coalesce(a.ie_cancelamento::text, '') = ''
								and	c.ie_tipo_item = '20'
								
union all

								SELECT	coalesce(d.vl_apropriacao,0) vl_apropriacao,
									d.nr_seq_centro_apropriacao,
									c.ie_tipo_item,
									null nr_seq_tipo_lanc,
									(select	max(x.nr_seq_tipo_coparticipacao)
									from	pls_conta_coparticipacao y,
										pls_regra_coparticipacao x
									where	x.nr_sequencia = y.nr_seq_regra
									and	y.nr_sequencia = e.nr_seq_conta_copartic) nr_seq_tipo_coparticipacao
								from	pls_mensalidade_seg_item	c,
									pls_mensalidade_segurado	b,
									pls_mensalidade			a,
									pls_mensalidade_item_conta	e,
									pls_mens_item_conta_aprop	d
								where	b.nr_sequencia			= c.nr_seq_mensalidade_seg
								and	c.nr_sequencia 			= e.nr_seq_item
								and	e.nr_sequencia			= d.nr_seq_mens_item_conta
								and	a.nr_sequencia			= b.nr_seq_mensalidade
								and (b.nr_seq_segurado 		= nr_seq_titular_anterior_w or b.nr_seq_titular = nr_seq_titular_anterior_w)
								and	b.dt_mesano_referencia		= dt_referencia_w
								and	coalesce(a.ie_cancelamento::text, '') = ''
								and	c.ie_tipo_item <> '20') a
							where	exists (	select	1
									from	pls_regra_limite_mens_apro x
									where	x.nr_seq_regra = nr_seq_regra_lim_copart_ant_w
									and	x.nr_seq_centro_apropriacao = a.nr_seq_centro_apropriacao)
							and	exists (	select	1
									from	pls_regra_limite_mens_item x
									where	x.ie_tipo_item = a.ie_tipo_item
									and (coalesce(x.nr_seq_tipo_lanc::text, '') = '' or x.nr_seq_tipo_lanc = a.nr_seq_tipo_lanc)
									and	x.nr_seq_regra = nr_seq_regra_lim_copart_ant_w)
							and not exists (	select	1
									from	pls_regra_limite_exc_copar x
									where	x.nr_seq_tipo_coparticipacao = a.nr_seq_tipo_coparticipacao
									and	x.nr_seq_regra = nr_seq_regra_lim_copart_ant_w);
						elsif (vet_c01_w.ie_parcela = 'P') then
							select	coalesce(sum(a.vl_apropriacao),0)
							into STRICT	vl_segurado_anterior_w
							from	(SELECT	coalesce(d.vl_apropriacao,0) vl_apropriacao,
									d.nr_seq_centro_apropriacao,
									'20' ie_tipo_item,
									c.nr_seq_tipo_lanc,
									null nr_seq_tipo_coparticipacao
								from	pls_mensalidade_seg_item	c,
									pls_mensalidade_segurado	b,
									pls_mensalidade			a,
									pls_mens_seg_item_aprop		d
								where	b.nr_sequencia			= c.nr_seq_mensalidade_seg
								and	a.nr_sequencia			= b.nr_seq_mensalidade
								and	c.nr_sequencia			= d.nr_seq_item
								and (b.nr_seq_segurado 		= nr_seq_titular_anterior_w or b.nr_seq_titular = nr_seq_titular_anterior_w)
								and	a.dt_referencia			= dt_referencia_w
								and	coalesce(a.ie_cancelamento::text, '') = ''
								and	c.ie_tipo_item = '20'
								
union all

								SELECT	coalesce(d.vl_apropriacao,0) vl_apropriacao,
									d.nr_seq_centro_apropriacao,
									c.ie_tipo_item,
									null nr_seq_tipo_lanc,
									(select	max(x.nr_seq_tipo_coparticipacao)
									from	pls_conta_coparticipacao y,
										pls_regra_coparticipacao x
									where	x.nr_sequencia = y.nr_seq_regra
									and	y.nr_sequencia = e.nr_seq_conta_copartic) nr_seq_tipo_coparticipacao
								from	pls_mensalidade_seg_item	c,
									pls_mensalidade_segurado	b,
									pls_mensalidade			a,
									pls_mensalidade_item_conta	e,
									pls_mens_item_conta_aprop	d
								where	b.nr_sequencia			= c.nr_seq_mensalidade_seg
								and	a.nr_sequencia			= b.nr_seq_mensalidade
								and	c.nr_sequencia 			= e.nr_seq_item
								and	e.nr_sequencia			= d.nr_seq_mens_item_conta
								and (b.nr_seq_segurado 		= nr_seq_titular_anterior_w or b.nr_seq_titular = nr_seq_titular_anterior_w)
								and	a.dt_referencia			= dt_referencia_w
								and	coalesce(a.ie_cancelamento::text, '') = ''
								and	c.ie_tipo_item <> '20') a
							where	exists (	select	1
									from	pls_regra_limite_mens_apro x
									where	x.nr_seq_regra = nr_seq_regra_lim_copart_ant_w
									and	x.nr_seq_centro_apropriacao = a.nr_seq_centro_apropriacao)
							and	exists (	select	1
									from	pls_regra_limite_mens_item x
									where	x.ie_tipo_item = a.ie_tipo_item
									and (coalesce(x.nr_seq_tipo_lanc::text, '') = '' or x.nr_seq_tipo_lanc = a.nr_seq_tipo_lanc)
									and	x.nr_seq_regra = nr_seq_regra_lim_copart_ant_w)
							and not exists (	select	1
									from	pls_regra_limite_exc_copar x
									where	x.nr_seq_tipo_coparticipacao = a.nr_seq_tipo_coparticipacao
									and	x.nr_seq_regra = nr_seq_regra_lim_copart_ant_w);
						end if;
					else
						if (vet_c01_w.ie_parcela = 'B') then
							select	coalesce(sum(a.vl_item),0) vl_item
							into STRICT	vl_segurado_anterior_w
							from	(SELECT	coalesce(c.vl_item,0) vl_item,
									null nr_seq_tipo_coparticipacao,
									c.nr_seq_tipo_lanc,
									'20' ie_tipo_item			
								from	pls_mensalidade_seg_item	c,
									pls_mensalidade_segurado	b,
									pls_mensalidade			a
								where	b.nr_sequencia			= c.nr_seq_mensalidade_seg
								and	a.nr_sequencia			= b.nr_seq_mensalidade
								and (b.nr_seq_segurado 		= nr_seq_titular_anterior_w or b.nr_seq_titular = nr_seq_titular_anterior_w)
								and	b.dt_mesano_referencia		= dt_referencia_w
								and	coalesce(a.ie_cancelamento::text, '') = ''
								and	c.ie_tipo_item = '20'
								
union all

								SELECT	coalesce(d.vl_item, 0) vl_item,
									(select	max(x.nr_seq_tipo_coparticipacao)
									from	pls_conta_coparticipacao y,
										pls_regra_coparticipacao x
									where	x.nr_sequencia = y.nr_seq_regra
									and	y.nr_sequencia = d.nr_seq_conta_copartic) nr_seq_tipo_coparticipacao,
									null nr_seq_tipo_lanc,
									c.ie_tipo_item
								from	pls_mensalidade_seg_item	c,
									pls_mensalidade_segurado	b,
									pls_mensalidade			a,
									pls_mensalidade_item_conta	d
								where	b.nr_sequencia			= c.nr_seq_mensalidade_seg
								and	a.nr_sequencia			= b.nr_seq_mensalidade
								and	c.nr_sequencia			= d.nr_seq_item
								and	b.dt_mesano_referencia		= dt_referencia_w
								and (b.nr_seq_segurado = nr_seq_titular_w or b.nr_seq_titular = nr_seq_titular_w)
								and	coalesce(a.ie_cancelamento::text, '') = ''
								and	c.ie_tipo_item <> '20') a
							where	exists (	select	1
									from	pls_regra_limite_mens_item x
									where	x.ie_tipo_item = a.ie_tipo_item
									and (coalesce(x.nr_seq_tipo_lanc::text, '') = '' or x.nr_seq_tipo_lanc = a.nr_seq_tipo_lanc)
									and	x.nr_seq_regra = nr_seq_regra_lim_copart_ant_w)
							and not exists (	select	1
									from	pls_regra_limite_exc_copar x
									where	x.nr_seq_tipo_coparticipacao = a.nr_seq_tipo_coparticipacao
									and	x.nr_seq_regra = nr_seq_regra_lim_copart_ant_w);
						elsif (vet_c01_w.ie_parcela = 'P') then
							select	coalesce(sum(a.vl_item),0) vl_item
							into STRICT	vl_segurado_anterior_w
							from	(SELECT	coalesce(c.vl_item,0) vl_item,
									null nr_seq_tipo_coparticipacao,
									c.nr_seq_tipo_lanc,
									'20' ie_tipo_item		
								from	pls_mensalidade_seg_item	c,
									pls_mensalidade_segurado	b,
									pls_mensalidade			a
								where	b.nr_sequencia			= c.nr_seq_mensalidade_seg
								and	a.nr_sequencia			= b.nr_seq_mensalidade
								and (b.nr_seq_segurado 		= nr_seq_titular_anterior_w or b.nr_seq_titular = nr_seq_titular_anterior_w)
								and	a.dt_referencia			= dt_referencia_w
								and	coalesce(a.ie_cancelamento::text, '') = ''
								and	c.ie_tipo_item = '20'
								
union all

								SELECT	coalesce(d.vl_item, 0) vl_item,
									(select	max(x.nr_seq_tipo_coparticipacao)
									from	pls_conta_coparticipacao y,
										pls_regra_coparticipacao x
									where	x.nr_sequencia = y.nr_seq_regra
									and	y.nr_sequencia = d.nr_seq_conta_copartic) nr_seq_tipo_coparticipacao,
									null nr_seq_tipo_lanc,
									c.ie_tipo_item
								from	pls_mensalidade_seg_item	c,
									pls_mensalidade_segurado	b,
									pls_mensalidade			a,
									pls_mensalidade_item_conta	d
								where	b.nr_sequencia			= c.nr_seq_mensalidade_seg
								and	a.nr_sequencia			= b.nr_seq_mensalidade
								and	c.nr_sequencia			= d.nr_seq_item
								and	b.dt_mesano_referencia		= dt_referencia_w
								and (b.nr_seq_segurado = nr_seq_titular_w or b.nr_seq_titular = nr_seq_titular_w)
								and	coalesce(a.ie_cancelamento::text, '') = ''
								and	c.ie_tipo_item <> '20') a
							where	exists (	select	1
									from	pls_regra_limite_mens_item x
									where	x.ie_tipo_item = a.ie_tipo_item
									and (coalesce(x.nr_seq_tipo_lanc::text, '') = '' or x.nr_seq_tipo_lanc = a.nr_seq_tipo_lanc)
									and	x.nr_seq_regra = nr_seq_regra_lim_copart_ant_w)
							and not exists (	select	1
									from	pls_regra_limite_exc_copar x
									where	x.nr_seq_tipo_coparticipacao = a.nr_seq_tipo_coparticipacao
									and	x.nr_seq_regra = nr_seq_regra_lim_copart_ant_w);
						end if;
					end if;

					for r_c02_w in c02(nr_seq_regra_lim_copart_ant_w) loop
						begin
						if (qt_apropriacao_regra_ant_w > 0) then
							for r_c03_w in c03(nr_seq_regra_lim_copart_ant_w) loop
								begin
								vl_total_segurado_anterior_w := vl_total_segurado_anterior_w + pls_mens_itens_pck.obter_valor(	nr_seq_titular_anterior_w, null, r_c02_w.ie_tipo_item,
																				r_c03_w.nr_seq_centro_apropriacao, r_c02_w.nr_seq_tipo_lanc, dt_referencia_w,
																				vet_c01_w.ie_parcela);
								end;
							end loop;
						else
							vl_total_segurado_anterior_w := vl_total_segurado_anterior_w + pls_mens_itens_pck.obter_valor(	nr_seq_titular_anterior_w, null, r_c02_w.ie_tipo_item,
																			null, r_c02_w.nr_seq_tipo_lanc, dt_referencia_w,
																			vet_c01_w.ie_parcela);
						end if;
						end;
					end loop;				
				end if;

				vl_total_segurado_anterior_w	:= vl_total_segurado_anterior_w + vl_segurado_anterior_w;

				if (vl_total_segurado_anterior_w > vet_c01_w.vl_max_copartic) then
					vl_total_segurado_anterior_w	:= vet_c01_w.vl_max_copartic;
				end if;
			end if;
		end if;
	end if;
	
	if (vet_c01_w.ie_aplicacao_regra = 'F') then		
		if (ie_apropriacao_w  = 'S') then
			if (vet_c01_w.ie_parcela = 'B') then
				select	coalesce(sum(a.vl_apropriacao),0)
				into STRICT	current_setting('pls_mens_itens_limite_pck.regra_limite_item_w')::vetor[regra_index_w].vl_item_gerado_mes
				from	(SELECT	coalesce(d.vl_apropriacao,0) vl_apropriacao,
						d.nr_seq_centro_apropriacao,
						'20' ie_tipo_item,
						c.nr_seq_tipo_lanc,
						null nr_seq_tipo_coparticipacao
					from	pls_mensalidade_seg_item	c,
						pls_mensalidade_segurado	b,
						pls_mensalidade			a,
						pls_mens_seg_item_aprop		d
					where	b.nr_sequencia			= c.nr_seq_mensalidade_seg
					and	a.nr_sequencia			= b.nr_seq_mensalidade
					and	c.nr_sequencia			= d.nr_seq_item
					and (b.nr_seq_segurado 		= nr_seq_titular_w or b.nr_seq_titular = nr_seq_titular_w)
					and	a.dt_referencia			= dt_referencia_w
					and	coalesce(a.ie_cancelamento::text, '') = ''
					and	c.ie_tipo_item = '20'
					
union all

					SELECT	coalesce(d.vl_apropriacao,0) vl_apropriacao,
						d.nr_seq_centro_apropriacao,
						c.ie_tipo_item,
						null nr_seq_tipo_lanc,
						(select	max(x.nr_seq_tipo_coparticipacao)
						from	pls_conta_coparticipacao y,
							pls_regra_coparticipacao x
						where	x.nr_sequencia = y.nr_seq_regra
						and	y.nr_sequencia = e.nr_seq_conta_copartic) nr_seq_tipo_coparticipacao
					from	pls_mensalidade_seg_item	c,
						pls_mensalidade_segurado	b,
						pls_mensalidade			a,
						pls_mensalidade_item_conta	e,
						pls_mens_item_conta_aprop	d
					where	b.nr_sequencia			= c.nr_seq_mensalidade_seg
					and	a.nr_sequencia			= b.nr_seq_mensalidade
					and	c.nr_sequencia 			= e.nr_seq_item
					and	e.nr_sequencia			= d.nr_seq_mens_item_conta
					and (b.nr_seq_segurado 		= nr_seq_titular_w or b.nr_seq_titular = nr_seq_titular_w)
					and	a.dt_referencia			= dt_referencia_w
					and	coalesce(a.ie_cancelamento::text, '') = ''
					and	c.ie_tipo_item <> '20') a
				where	exists (	select	1
						from	table(pls_mens_itens_limite_pck.obter_apropriacao_regra(regra_index_w)) x
						where	x.nr_seq_centro_apropriacao = a.nr_seq_centro_apropriacao)
				and	exists (	select	1
						from	table(pls_mens_itens_limite_pck.obter_itens_regra_valor(regra_index_w)) x
						where	x.ie_tipo_item = a.ie_tipo_item
						and (coalesce(x.nr_seq_tipo_lanc::text, '') = '' or x.nr_seq_tipo_lanc = a.nr_seq_tipo_lanc))
				and	not exists (	select	1
							from	table(pls_mens_itens_limite_pck.obter_nr_tipo_copartic_exce(regra_index_w)) x
							where	x.nr_seq_tipo_coparticipacao = a.nr_seq_tipo_coparticipacao);
			elsif (vet_c01_w.ie_parcela = 'P') then
				select	coalesce(sum(a.vl_apropriacao),0)
				into STRICT	current_setting('pls_mens_itens_limite_pck.regra_limite_item_w')::vetor[regra_index_w].vl_item_gerado_mes
				from	(SELECT	coalesce(d.vl_apropriacao,0) vl_apropriacao,
						d.nr_seq_centro_apropriacao,
						'20' ie_tipo_item,
						c.nr_seq_tipo_lanc,
						null nr_seq_tipo_coparticipacao
					from	pls_mensalidade_seg_item	c,
						pls_mensalidade_segurado	b,
						pls_mensalidade			a,
						pls_mens_seg_item_aprop		d
					where	b.nr_sequencia			= c.nr_seq_mensalidade_seg
					and	a.nr_sequencia			= b.nr_seq_mensalidade
					and	c.nr_sequencia			= d.nr_seq_item
					and (b.nr_seq_segurado 		= nr_seq_titular_w or b.nr_seq_titular = nr_seq_titular_w)
					and	a.dt_referencia			= dt_referencia_w
					and	coalesce(a.ie_cancelamento::text, '') = ''
					and	c.ie_tipo_item = '20'
					
union all

					SELECT	coalesce(d.vl_apropriacao,0) vl_apropriacao,
						d.nr_seq_centro_apropriacao,
						c.ie_tipo_item,
						null nr_seq_tipo_lanc,
						(select	max(x.nr_seq_tipo_coparticipacao)
						from	pls_conta_coparticipacao y,
							pls_regra_coparticipacao x
						where	x.nr_sequencia = y.nr_seq_regra
						and	y.nr_sequencia = e.nr_seq_conta_copartic) nr_seq_tipo_coparticipacao
					from	pls_mensalidade_seg_item	c,
						pls_mensalidade_segurado	b,
						pls_mensalidade			a,
						pls_mensalidade_item_conta	e,
						pls_mens_item_conta_aprop	d
					where	b.nr_sequencia			= c.nr_seq_mensalidade_seg
					and	a.nr_sequencia			= b.nr_seq_mensalidade
					and	c.nr_sequencia 			= e.nr_seq_item
					and	e.nr_sequencia			= d.nr_seq_mens_item_conta
					and (b.nr_seq_segurado 		= nr_seq_titular_w or b.nr_seq_titular = nr_seq_titular_w)
					and	a.dt_referencia			= dt_referencia_w
					and	coalesce(a.ie_cancelamento::text, '') = ''
					and	c.ie_tipo_item <> '20') a
				where	exists (	select	1
						from	table(pls_mens_itens_limite_pck.obter_apropriacao_regra(regra_index_w)) x
						where	x.nr_seq_centro_apropriacao = a.nr_seq_centro_apropriacao)
				and	exists (	select	1
						from	table(pls_mens_itens_limite_pck.obter_itens_regra_valor(regra_index_w)) x
						where	x.ie_tipo_item = a.ie_tipo_item
						and (coalesce(x.nr_seq_tipo_lanc::text, '') = '' or x.nr_seq_tipo_lanc = a.nr_seq_tipo_lanc))
				and	not exists (	select	1
							from	table(pls_mens_itens_limite_pck.obter_nr_tipo_copartic_exce(regra_index_w)) x
							where	x.nr_seq_tipo_coparticipacao = a.nr_seq_tipo_coparticipacao);
			end if;
		else
			if (vet_c01_w.ie_parcela = 'B') then
				select	coalesce(sum(a.vl_item),0) vl_item
				into STRICT	current_setting('pls_mens_itens_limite_pck.regra_limite_item_w')::vetor[regra_index_w].vl_item_gerado_mes
				from	(SELECT	coalesce(c.vl_item, 0) vl_item,
						null nr_seq_tipo_coparticipacao,
						c.nr_seq_tipo_lanc,
						'20' ie_tipo_item
					from	pls_mensalidade_seg_item	c,
						pls_mensalidade_segurado	b,
						pls_mensalidade			a
					where	b.nr_sequencia			= c.nr_seq_mensalidade_seg
					and	a.nr_sequencia			= b.nr_seq_mensalidade
					and	b.dt_mesano_referencia		= dt_referencia_w
					and (b.nr_seq_segurado = nr_seq_titular_w or b.nr_seq_titular = nr_seq_titular_w)
					and	coalesce(a.ie_cancelamento::text, '') = ''
					and	c.ie_tipo_item = '20'
					
union all

					SELECT	coalesce(d.vl_item, 0) vl_item,
						(select	max(x.nr_seq_tipo_coparticipacao)
						from	pls_conta_coparticipacao y,
							pls_regra_coparticipacao x
						where	x.nr_sequencia = y.nr_seq_regra
						and	y.nr_sequencia = d.nr_seq_conta_copartic) nr_seq_tipo_coparticipacao,
						null nr_seq_tipo_lanc,
						c.ie_tipo_item
					FROM pls_mensalidade_segurado b, pls_mensalidade a, pls_mensalidade_seg_item c
LEFT OUTER JOIN pls_mensalidade_item_conta d ON (c.nr_sequencia = d.nr_seq_item)
WHERE b.nr_sequencia			= c.nr_seq_mensalidade_seg and a.nr_sequencia			= b.nr_seq_mensalidade  and b.dt_mesano_referencia		= dt_referencia_w and (b.nr_seq_segurado = nr_seq_titular_w or b.nr_seq_titular = nr_seq_titular_w) and coalesce(a.ie_cancelamento::text, '') = '' and c.ie_tipo_item <> '20' ) a
				where	exists (	select	1
						from	table(pls_mens_itens_limite_pck.obter_itens_regra_valor(regra_index_w)) x
						where	x.ie_tipo_item = a.ie_tipo_item
						and (coalesce(x.nr_seq_tipo_lanc::text, '') = '' or x.nr_seq_tipo_lanc = a.nr_seq_tipo_lanc))
				and	not exists (	select	1
							from	table(pls_mens_itens_limite_pck.obter_nr_tipo_copartic_exce(regra_index_w)) x
							where	x.nr_seq_tipo_coparticipacao = a.nr_seq_tipo_coparticipacao);
							
			elsif (vet_c01_w.ie_parcela = 'P') then
				select	coalesce(sum(a.vl_item),0) vl_item
				into STRICT	current_setting('pls_mens_itens_limite_pck.regra_limite_item_w')::vetor[regra_index_w].vl_item_gerado_mes
				from	(SELECT	coalesce(c.vl_item,0) vl_item,
						null nr_seq_tipo_coparticipacao,
						c.nr_seq_tipo_lanc,
						'20' ie_tipo_item
					from	pls_mensalidade_seg_item	c,
						pls_mensalidade_segurado	b,
						pls_mensalidade			a
					where	b.nr_sequencia			= c.nr_seq_mensalidade_seg
					and	a.nr_sequencia			= b.nr_seq_mensalidade
					and	a.dt_referencia			= dt_referencia_w
					and (b.nr_seq_segurado = nr_seq_titular_w or b.nr_seq_titular = nr_seq_titular_w)
					and	coalesce(a.ie_cancelamento::text, '') = ''
					and	c.ie_tipo_item = '20'
					
union all

					SELECT	coalesce(d.vl_item,0) vl_item,
						(select	max(x.nr_seq_tipo_coparticipacao)
						from	pls_conta_coparticipacao y,
							pls_regra_coparticipacao x
						where	x.nr_sequencia = y.nr_seq_regra
						and	y.nr_sequencia = d.nr_seq_conta_copartic) nr_seq_tipo_coparticipacao,
						null nr_seq_tipo_lanc,
						c.ie_tipo_item
					from	pls_mensalidade_seg_item	c,
						pls_mensalidade_segurado	b,
						pls_mensalidade			a,
						pls_mensalidade_item_conta	d
					where	b.nr_sequencia			= c.nr_seq_mensalidade_seg
					and	a.nr_sequencia			= b.nr_seq_mensalidade
					and	c.nr_sequencia			= d.nr_seq_item
					and	a.dt_referencia			= dt_referencia_w
					and (b.nr_seq_segurado = nr_seq_titular_w or b.nr_seq_titular = nr_seq_titular_w)
					and	coalesce(a.ie_cancelamento::text, '') = ''
					and	c.ie_tipo_item <> '20') a
				where	exists (	select	1
						from	table(pls_mens_itens_limite_pck.obter_itens_regra_valor(regra_index_w)) x
						where	x.ie_tipo_item = a.ie_tipo_item
						and (coalesce(x.nr_seq_tipo_lanc::text, '') = '' or x.nr_seq_tipo_lanc = a.nr_seq_tipo_lanc))
				and	not exists (	select	1
							from	table(pls_mens_itens_limite_pck.obter_nr_tipo_copartic_exce(regra_index_w)) x
							where	x.nr_seq_tipo_coparticipacao = a.nr_seq_tipo_coparticipacao);
			end if;
		end if;
		--Obter o valor cobrado em mensalidades que ainda nao foram persistidas no banco (vetores)

		current_setting('pls_mens_itens_limite_pck.regra_limite_item_w')::vetor[regra_index_w].vl_item_gerado_mes	:= current_setting('pls_mens_itens_limite_pck.regra_limite_item_w')::vetor[regra_index_w].vl_item_gerado_mes + vl_total_item_familia_w + vl_total_segurado_anterior_w;
	elsif (vet_c01_w.ie_aplicacao_regra = 'I') then
		if (ie_apropriacao_w  = 'S') then
			if (vet_c01_w.ie_parcela = 'B')  then
				select	coalesce(sum(a.vl_apropriacao),0)
				into STRICT	current_setting('pls_mens_itens_limite_pck.regra_limite_item_w')::vetor[regra_index_w].vl_item_gerado_mes
				from	(SELECT	coalesce(d.vl_apropriacao,0) vl_apropriacao,
						d.nr_seq_centro_apropriacao,
						'20' ie_tipo_item,
						c.nr_seq_tipo_lanc,
						null nr_seq_tipo_coparticipacao
					from	pls_mensalidade_seg_item	c,
						pls_mensalidade_segurado	b,
						pls_mensalidade			a,
						pls_mens_seg_item_aprop		d
					where	b.nr_sequencia			= c.nr_seq_mensalidade_seg
					and	a.nr_sequencia			= b.nr_seq_mensalidade
					and	c.nr_sequencia			= d.nr_seq_item
					and	b.nr_seq_segurado		= nr_seq_segurado_p
					and	b.dt_mesano_referencia		= dt_referencia_w
					and	coalesce(a.ie_cancelamento::text, '') = ''
					and	c.ie_tipo_item = '20'
					
union all

					SELECT	coalesce(d.vl_apropriacao,0) vl_apropriacao,
						d.nr_seq_centro_apropriacao,
						c.ie_tipo_item,
						null nr_seq_tipo_lanc,
						(select	max(x.nr_seq_tipo_coparticipacao)
						from	pls_conta_coparticipacao y,
							pls_regra_coparticipacao x
						where	x.nr_sequencia = y.nr_seq_regra
						and	y.nr_sequencia = e.nr_seq_conta_copartic) nr_seq_tipo_coparticipacao
					from	pls_mensalidade_seg_item	c,
						pls_mensalidade_segurado	b,
						pls_mensalidade			a,
						pls_mensalidade_item_conta	e,
						pls_mens_item_conta_aprop	d
					where	b.nr_sequencia			= c.nr_seq_mensalidade_seg
					and	a.nr_sequencia			= b.nr_seq_mensalidade
					and	c.nr_sequencia 			= e.nr_seq_item
					and	e.nr_sequencia			= d.nr_seq_mens_item_conta
					and	b.nr_seq_segurado		= nr_seq_segurado_p
					and	b.dt_mesano_referencia		= dt_referencia_w
					and	coalesce(a.ie_cancelamento::text, '') = ''
					and	c.ie_tipo_item <> '20') a
				where	exists (	select	1
						from	table(pls_mens_itens_limite_pck.obter_apropriacao_regra(regra_index_w)) x
						where	x.nr_seq_centro_apropriacao = a.nr_seq_centro_apropriacao)
				and	exists (	select	1
						from	table(pls_mens_itens_limite_pck.obter_itens_regra_valor(regra_index_w)) x
						where	x.ie_tipo_item = a.ie_tipo_item
						and (coalesce(x.nr_seq_tipo_lanc::text, '') = '' or x.nr_seq_tipo_lanc = a.nr_seq_tipo_lanc))
				and	not exists (	select	1
							from	table(pls_mens_itens_limite_pck.obter_nr_tipo_copartic_exce(regra_index_w)) x
							where	x.nr_seq_tipo_coparticipacao = a.nr_seq_tipo_coparticipacao);
			elsif (vet_c01_w.ie_parcela = 'P')  then
				select	coalesce(sum(a.vl_apropriacao),0)
				into STRICT	current_setting('pls_mens_itens_limite_pck.regra_limite_item_w')::vetor[regra_index_w].vl_item_gerado_mes
				from	(SELECT	coalesce(d.vl_apropriacao,0) vl_apropriacao,
						d.nr_seq_centro_apropriacao,
						'20' ie_tipo_item,
						c.nr_seq_tipo_lanc,
						null nr_seq_tipo_coparticipacao
					from	pls_mensalidade_seg_item	c,
						pls_mensalidade_segurado	b,
						pls_mensalidade			a,
						pls_mens_seg_item_aprop		d
					where	b.nr_sequencia			= c.nr_seq_mensalidade_seg
					and	a.nr_sequencia			= b.nr_seq_mensalidade
					and	c.nr_sequencia			= d.nr_seq_item
					and	b.nr_seq_segurado		= nr_seq_segurado_p
					and	a.dt_referencia			= dt_referencia_w
					and	coalesce(a.ie_cancelamento::text, '') = ''
					and	c.ie_tipo_item = '20'
					
union all

					SELECT	coalesce(d.vl_apropriacao,0) vl_apropriacao,
						d.nr_seq_centro_apropriacao,
						c.ie_tipo_item,
						null nr_seq_tipo_lanc,
						(select	max(x.nr_seq_tipo_coparticipacao)
						from	pls_conta_coparticipacao y,
							pls_regra_coparticipacao x
						where	x.nr_sequencia = y.nr_seq_regra
						and	y.nr_sequencia = e.nr_seq_conta_copartic) nr_seq_tipo_coparticipacao
					from	pls_mensalidade_seg_item	c,
						pls_mensalidade_segurado	b,
						pls_mensalidade			a,
						pls_mensalidade_item_conta	e,
						pls_mens_item_conta_aprop	d
					where	b.nr_sequencia			= c.nr_seq_mensalidade_seg
					and	a.nr_sequencia			= b.nr_seq_mensalidade
					and	c.nr_sequencia 			= e.nr_seq_item
					and	e.nr_sequencia			= d.nr_seq_mens_item_conta
					and	b.nr_seq_segurado		= nr_seq_segurado_p
					and	a.dt_referencia			= dt_referencia_w
					and	coalesce(a.ie_cancelamento::text, '') = ''
					and	c.ie_tipo_item <> '20') a
				where	exists (	select	1
						from	table(pls_mens_itens_limite_pck.obter_apropriacao_regra(regra_index_w)) x
						where	x.nr_seq_centro_apropriacao = a.nr_seq_centro_apropriacao)
				and	exists (	select	1
						from	table(pls_mens_itens_limite_pck.obter_itens_regra_valor(regra_index_w)) x
						where	x.ie_tipo_item = a.ie_tipo_item
						and (coalesce(x.nr_seq_tipo_lanc::text, '') = '' or x.nr_seq_tipo_lanc = a.nr_seq_tipo_lanc))
				and	not exists (	select	1
							from	table(pls_mens_itens_limite_pck.obter_nr_tipo_copartic_exce(regra_index_w)) x
							where	x.nr_seq_tipo_coparticipacao = a.nr_seq_tipo_coparticipacao);
			end if;
		else
			if (vet_c01_w.ie_parcela = 'B') then
				select	coalesce(sum(a.vl_item),0) vl_item
				into STRICT	current_setting('pls_mens_itens_limite_pck.regra_limite_item_w')::vetor[regra_index_w].vl_item_gerado_mes
				from	(SELECT	coalesce(c.vl_item,0) vl_item,
						null nr_seq_tipo_coparticipacao,
						c.nr_seq_tipo_lanc,
						'20' ie_tipo_item
					from	pls_mensalidade_seg_item	c,
						pls_mensalidade_segurado	b,
						pls_mensalidade			a
					where	b.nr_sequencia			= c.nr_seq_mensalidade_seg
					and	a.nr_sequencia			= b.nr_seq_mensalidade
					and	b.nr_seq_segurado		= nr_seq_segurado_p
					and	b.dt_mesano_referencia		= dt_referencia_w
					and	coalesce(a.ie_cancelamento::text, '') = ''
					and	c.ie_tipo_item = '20'
					
union all

					SELECT	coalesce(d.vl_item,0) vl_item,
						(select	max(x.nr_seq_tipo_coparticipacao)
						from	pls_conta_coparticipacao y,
							pls_regra_coparticipacao x
						where	x.nr_sequencia = y.nr_seq_regra
						and	y.nr_sequencia = d.nr_seq_conta_copartic) nr_seq_tipo_coparticipacao,
						null nr_seq_tipo_lanc,
						c.ie_tipo_item
					from	pls_mensalidade_seg_item	c,
						pls_mensalidade_segurado	b,
						pls_mensalidade			a,
						pls_mensalidade_item_conta	d
					where	b.nr_sequencia			= c.nr_seq_mensalidade_seg
					and	a.nr_sequencia			= b.nr_seq_mensalidade
					and	c.nr_sequencia			= d.nr_seq_item
					and	b.nr_seq_segurado		= nr_seq_segurado_p
					and	b.dt_mesano_referencia		= dt_referencia_w
					and	coalesce(a.ie_cancelamento::text, '') = ''
					and	c.ie_tipo_item <> '20') a
				where	exists (	select	1
						from	table(pls_mens_itens_limite_pck.obter_itens_regra_valor(regra_index_w)) x
						where	x.ie_tipo_item = a.ie_tipo_item
						and (coalesce(x.nr_seq_tipo_lanc::text, '') = '' or x.nr_seq_tipo_lanc = a.nr_seq_tipo_lanc))
				and	not exists (	select	1
							from	table(pls_mens_itens_limite_pck.obter_nr_tipo_copartic_exce(regra_index_w)) x
							where	x.nr_seq_tipo_coparticipacao = a.nr_seq_tipo_coparticipacao);

			elsif (vet_c01_w.ie_parcela = 'P')  then
				select	coalesce(sum(a.vl_item),0) vl_item
				into STRICT	current_setting('pls_mens_itens_limite_pck.regra_limite_item_w')::vetor[regra_index_w].vl_item_gerado_mes
				from	(SELECT	coalesce(c.vl_item,0) vl_item,
						null nr_seq_tipo_coparticipacao,
						c.nr_seq_tipo_lanc,
						'20' ie_tipo_item
					from	pls_mensalidade_seg_item	c,
						pls_mensalidade_segurado	b,
						pls_mensalidade			a
					where	b.nr_sequencia			= c.nr_seq_mensalidade_seg
					and	a.nr_sequencia			= b.nr_seq_mensalidade
					and	b.nr_seq_segurado		= nr_seq_segurado_p
					and	a.dt_referencia			= dt_referencia_w
					and	coalesce(a.ie_cancelamento::text, '') = ''
					and	c.ie_tipo_item = '20'
					
union all

					SELECT	coalesce(d.vl_item,0) vl_item,
						(select	max(x.nr_seq_tipo_coparticipacao)
						from	pls_conta_coparticipacao y,
							pls_regra_coparticipacao x
						where	x.nr_sequencia = y.nr_seq_regra
						and	y.nr_sequencia = d.nr_seq_conta_copartic) nr_seq_tipo_coparticipacao,
						null nr_seq_tipo_lanc,
						c.ie_tipo_item
					from	pls_mensalidade_seg_item	c,
						pls_mensalidade_segurado	b,
						pls_mensalidade			a,
						pls_mensalidade_item_conta	d
					where	b.nr_sequencia			= c.nr_seq_mensalidade_seg
					and	a.nr_sequencia			= b.nr_seq_mensalidade
					and	c.nr_sequencia			= d.nr_seq_item
					and	b.nr_seq_segurado		= nr_seq_segurado_p
					and	a.dt_referencia			= dt_referencia_w
					and	coalesce(a.ie_cancelamento::text, '') = ''
					and	c.ie_tipo_item <> '20') a
				where	exists (	select	1
						from	table(pls_mens_itens_limite_pck.obter_itens_regra_valor(regra_index_w)) x
						where	x.ie_tipo_item = a.ie_tipo_item
						and (coalesce(x.nr_seq_tipo_lanc::text, '') = '' or x.nr_seq_tipo_lanc = a.nr_seq_tipo_lanc))
				and	not exists (	select	1
							from	table(pls_mens_itens_limite_pck.obter_nr_tipo_copartic_exce(regra_index_w)) x
							where	x.nr_seq_tipo_coparticipacao = a.nr_seq_tipo_coparticipacao);
			end if;
		end if;
		current_setting('pls_mens_itens_limite_pck.regra_limite_item_w')::vetor[regra_index_w].vl_item_gerado_mes	:= current_setting('pls_mens_itens_limite_pck.regra_limite_item_w')::vetor[regra_index_w].vl_item_gerado_mes + vl_total_itens_referencia_w + vl_total_segurado_anterior_w;
	end if;
	end;
end loop;

commit;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_mens_itens_limite_pck.obter_regras_itens_limite ( nr_seq_contrato_p pls_contrato.nr_sequencia%type, nr_seq_titular_p pls_segurado.nr_sequencia%type, nr_seq_segurado_p pls_segurado.nr_sequencia%type, dt_mesano_referencia_p pls_mensalidade_segurado.dt_mesano_referencia%type, dt_referencia_p pls_mensalidade.dt_referencia%type, nr_seq_plano_p pls_plano.nr_sequencia%type, nr_seq_segurado_ant_p pls_segurado.nr_seq_segurado_ant%type, nr_seq_titular_ant_p pls_segurado.nr_seq_titular%type) FROM PUBLIC;
