-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE ctb_sped_ecd_pck.gerar_interf_k310_ecd (regra_sped_p INOUT ctb_sped_ecd_pck.regra_sped, nm_usuario_p text, cd_conta_contabil_p text) AS $body$
DECLARE



ds_linha_w                  	varchar(8000);
sep_w                        	varchar(1)     := '|';
tp_registro_w                	varchar(15)    := 'K310';

c01 CURSOR(
	cd_conta_contabil_pc 		conta_contabil.cd_conta_contabil%type,
	dt_ref_inicial_pc 		ctb_sped_controle.dt_ref_inicial%type,
	dt_ref_final_pc 		ctb_sped_controle.dt_ref_final%type,
	cd_empresa_pc 			ctb_sped_controle.cd_empresa%type
	) FOR
	SELECT	x.cd_empresa,
		x.ie_tipo_conta,
		x.cd_conta_contabil,
		x.vl_movimento
	from (	SELECT	e.cd_empresa,
			'D'  ie_tipo_conta,
			coalesce(m.cd_conta_debito,m.cd_conta_credito) cd_conta_contabil,
			sum(m.vl_movimento) vl_movimento
		from	ctb_movimento m,
			estabelecimento e,
			ctb_mes_ref re
		where	m.cd_estabelecimento = e.cd_estabelecimento
		and	m.nr_seq_mes_ref 	= re.nr_sequencia
		and	re.dt_referencia between dt_ref_inicial_pc and dt_ref_final_pc
		and	e.cd_empresa 		= cd_empresa_pc
		and	m.cd_conta_debito 	= cd_conta_contabil_pc
		and	(m.cd_conta_debito IS NOT NULL AND m.cd_conta_debito::text <> '')
		and	m.ie_eliminacao_lancto = 'S'
		group by e.cd_empresa,
			m.cd_conta_debito,
			m.cd_conta_credito
		
union all

		select	e.cd_empresa,
			'C'  ie_tipo_conta,
			coalesce(m.cd_conta_credito,m.cd_conta_debito) cd_conta_contabil,
			sum(m.vl_movimento) vl_movimento
		from	ctb_movimento m,
			estabelecimento e,
			ctb_mes_ref re
		where	m.cd_estabelecimento = e.cd_estabelecimento
		and	m.nr_seq_mes_ref 	= re.nr_sequencia
		and	re.dt_referencia between dt_ref_inicial_pc and dt_ref_final_pc
		and	e.cd_empresa 		= cd_empresa_pc
		and	m.cd_conta_credito 	= cd_conta_contabil_pc
		and	(m.cd_conta_credito IS NOT NULL AND m.cd_conta_credito::text <> '')
		and	m.ie_eliminacao_lancto = 'S'
		group by e.cd_empresa, 
			m.cd_conta_debito,
			m.cd_conta_credito
		order  by 1)
	x;

type vetor_c01 is table of c01%rowtype index by integer;
vetor_c01_w    vetor_c01;
	
BEGIN
open c01(
	cd_conta_contabil_pc    => cd_conta_contabil_p,
	dt_ref_inicial_pc 	=> regra_sped_p.dt_ref_inicial,
	dt_ref_final_pc 	=> regra_sped_p.dt_ref_final,
	cd_empresa_pc 		=> regra_sped_p.cd_empresa
	);
	loop fetch c01 bulk collect into vetor_c01_w limit 1000;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		for i in vetor_c01_w.first .. vetor_c01_w.last loop
		begin
		
		        ds_linha_w   := substr(sep_w    ||
			tp_registro_w      		|| sep_w ||
			vetor_c01_w[i].cd_empresa      || sep_w ||
			replace(replace(campo_mascara_virgula(vetor_c01_w[i].vl_movimento),'.',''),'-','')  || sep_w ||
			vetor_c01_w[i].ie_tipo_conta  || sep_w,1,8000);
			
			regra_sped_p.cd_registro_variavel := tp_registro_w;
			regra_sped_p => regra_sped_p := ctb_sped_ecd_pck.inserir_registros_vetor(regra_sped_p => regra_sped_p, ds_linha_p => ds_linha_w);
				regra_sped_p 			=>	regra_sped_p := ctb_sped_ecd_pck.gerar_interf_k315_ecd(	regra_sped_p 			=>	regra_sped_p, nm_usuario_p 			=>	nm_usuario_p, cd_conta_contabil_p		=> 	vetor_c01_w[i].cd_conta_contabil, ie_debito_credito_elimin_p	=>	vetor_c01_w[i].ie_tipo_conta
						);		
		end;
		end loop;
		regra_sped_p => regra_sped_p := ctb_sped_ecd_pck.persistir_registros_em_lote(regra_sped_p => regra_sped_p, nm_usuario_p => nm_usuario_p);
	end loop;
close c01;
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ctb_sped_ecd_pck.gerar_interf_k310_ecd (regra_sped_p INOUT ctb_sped_ecd_pck.regra_sped, nm_usuario_p text, cd_conta_contabil_p text) FROM PUBLIC;
