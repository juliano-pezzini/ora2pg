-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE ctb_sped_ecd_pck.gerar_interf_0000_ecd (regra_sped_p INOUT ctb_sped_ecd_pck.regra_sped, nm_usuario_p text) AS $body$
DECLARE



ds_linha_w			varchar(8000);
ie_gerar_157_w			varchar(1);
ie_gerar_I051_w			varchar(1);
ie_houve_troca_w		varchar(1)	:= 'N';
sep_w				varchar(1)	:= '|';
ind_centralizada_w		smallint	:= 0;
ind_mudanc_pc_w			smallint	:= 0;
cd_empresa_controladora_w	empresa.cd_empresa%type;
cd_cnpj_matriz_w		estabelecimento.cd_cgc%type;
cd_scp_w			estabelecimento.cd_cgc%type := '';
ie_porte_empresa_w		empresa.ie_porte_empresa%type;
ie_consolida_multi_empresa_w    ctb_regra_sped.ie_consolida_multi_empresa%type;
cod_plan_ref_w			ctb_regra_sped.cd_empresa_resp%type;

c_establecimento CURSOR(
	cd_estabelecimento_pc 	 estabelecimento.cd_estabelecimento%type,
	ie_arquivo_pc 		 ctb_regra_sped.ie_arquivo%type
	)FOR
	SELECT  '0000' tp_registro,
		substr(CASE WHEN ie_arquivo_pc='ECD' THEN 'LECD' WHEN ie_arquivo_pc='FCONT' THEN 'LALU' END ,1,4) ds_lecd,
		substr(obter_razao_social(a.cd_cgc),1,255) ds_razao_social,
		a.cd_cgc cd_cnpj,
		substr(obter_dados_pf_pj(null, a.cd_cgc, 'UF'),1,2) sg_estado,
		a.cd_inscricao_estadual cd_inscricao_estadual,
		lpad(coalesce(substr(obter_dados_pf_pj(null, a.cd_cgc, 'CDMDV'),1,7),a.cd_localidade),7,0) cd_municipio_ibge,
		a.cd_inscricao_municipal nr_inscricao_municipal,
		null cd_ind_situacao_especial
	from	estabelecimento	a
	where	a.cd_estabelecimento	= cd_estabelecimento_pc;

type vetor_estabelecimento is table of c_establecimento%rowtype index by integer;
v_estabelecimento_w    vetor_estabelecimento;

type vetor_ctb_sped_registro is table of ctb_sped_registro%rowtype index by integer;
v_ctb_sped_registro_w  vetor_ctb_sped_registro;
	
BEGIN

cod_plan_ref_w:= regra_sped_p.cd_empresa_resp;

ie_consolida_multi_empresa_w 	:= 'N';
cd_empresa_controladora_w 	:=  holding_pck.get_emp_controladora_grupo(NULL, regra_sped_p.cd_empresa);
if (cd_empresa_controladora_w = regra_sped_p.cd_empresa) then
	ie_consolida_multi_empresa_w := 'S';
end if;

begin
select	coalesce(ie_porte_empresa,'P')
into STRICT	ie_porte_empresa_w
from	empresa
where	cd_empresa	= regra_sped_p.cd_empresa;

exception
	when others then
	ie_porte_empresa_w	:= 'P';
end;

if (ie_porte_empresa_w = 'G') then
	ie_porte_empresa_w	:= '1';
else
	ie_porte_empresa_w	:= '0';
end if;

open c_establecimento(
	cd_estabelecimento_pc  	=> regra_sped_p.cd_estabelecimento,
	ie_arquivo_pc 		=> regra_sped_p.ie_arquivo
	);
	loop fetch c_establecimento bulk collect into v_estabelecimento_w limit 1000;
		EXIT WHEN NOT FOUND; /* apply on c_establecimento */
		for i in v_estabelecimento_w.first .. v_estabelecimento_w.last loop
		begin
		
		if (regra_sped_p.cd_versao = '1.0') then
			ds_linha_w	:= substr(	sep_w || v_estabelecimento_w[i].tp_registro			||
							sep_w || v_estabelecimento_w[i].ds_lecd 			||
							sep_w || to_char(regra_sped_p.dt_ref_inicial,'ddmmyyyy') 	||
							sep_w || to_char(regra_sped_p.dt_ref_final,'ddmmyyyy')		||
							sep_w || v_estabelecimento_w[i].ds_razao_social  		||
							sep_w || v_estabelecimento_w[i].cd_cnpj  			||
							sep_w || v_estabelecimento_w[i].sg_estado			||
							sep_w || v_estabelecimento_w[i].cd_inscricao_estadual  		||
							sep_w || v_estabelecimento_w[i].cd_municipio_ibge  		||
							sep_w || v_estabelecimento_w[i].nr_inscricao_municipal		||
							sep_w || v_estabelecimento_w[i].cd_ind_situacao_especial	||
							sep_w, 1, 8000);
		elsif (regra_sped_p.cd_versao = '2.0') then		
			ds_linha_w	:= substr(	sep_w || v_estabelecimento_w[i].tp_registro			||
							sep_w || v_estabelecimento_w[i].ds_lecd 			||
							sep_w || to_char(regra_sped_p.dt_ref_inicial,'ddmmyyyy') 	||
							sep_w || to_char(regra_sped_p.dt_ref_final,'ddmmyyyy')		||
							sep_w || v_estabelecimento_w[i].ds_razao_social  		||
							sep_w || v_estabelecimento_w[i].cd_cnpj  			||
							sep_w || v_estabelecimento_w[i].sg_estado			||
							sep_w || v_estabelecimento_w[i].cd_inscricao_estadual  		||
							sep_w || v_estabelecimento_w[i].cd_municipio_ibge  		||
							sep_w || v_estabelecimento_w[i].nr_inscricao_municipal		||
							sep_w || v_estabelecimento_w[i].cd_ind_situacao_especial	||
							sep_w || regra_sped_p.ie_inicio_periodo 			||
							sep_w || regra_sped_p.ie_nire					||
							sep_w || regra_sped_p.ie_finalidade_escrit			||
							sep_w || regra_sped_p.cd_hash_substituida			||
							sep_w || regra_sped_p.nr_nire_subst				||
							sep_w || ie_porte_empresa_w					||
							sep_w, 1, 8000);
							
		elsif (regra_sped_p.cd_versao = '3.0') then			
			ds_linha_w	:= substr(	sep_w || v_estabelecimento_w[i].tp_registro			||
							sep_w || v_estabelecimento_w[i].ds_lecd 			||
							sep_w || to_char(regra_sped_p.dt_ref_inicial,'ddmmyyyy') 	||
							sep_w || to_char(regra_sped_p.dt_ref_final,'ddmmyyyy')		||
							sep_w || v_estabelecimento_w[i].ds_razao_social  		||
							sep_w || v_estabelecimento_w[i].cd_cnpj  			||
							sep_w || v_estabelecimento_w[i].sg_estado			||
							sep_w || v_estabelecimento_w[i].cd_inscricao_estadual  		||
							sep_w || v_estabelecimento_w[i].cd_municipio_ibge  		||
							sep_w || v_estabelecimento_w[i].nr_inscricao_municipal		||
							sep_w || v_estabelecimento_w[i].cd_ind_situacao_especial	||
							sep_w || regra_sped_p.ie_inicio_periodo				||
							sep_w || regra_sped_p.ie_nire					||
							sep_w || regra_sped_p.ie_finalidade_escrit			||
							sep_w || regra_sped_p.cd_hash_substituida			||
							sep_w || regra_sped_p.nr_nire_subst				||
							sep_w || ie_porte_empresa_w					||
							sep_w || regra_sped_p.ie_tipo_ecd				||
							sep_w || ''							||
							sep_w, 1, 8000);
							
		elsif (regra_sped_p.cd_versao = '4.0') then			
			ds_linha_w	:= substr(	sep_w || v_estabelecimento_w[i].tp_registro			||
							sep_w || v_estabelecimento_w[i].ds_lecd 			||
							sep_w || to_char(regra_sped_p.dt_ref_inicial,'ddmmyyyy') 	||
							sep_w || to_char(regra_sped_p.dt_ref_final,'ddmmyyyy')		||
							sep_w || v_estabelecimento_w[i].ds_razao_social  		||
							sep_w || v_estabelecimento_w[i].cd_cnpj  			||
							sep_w || v_estabelecimento_w[i].sg_estado			||
							sep_w || v_estabelecimento_w[i].cd_inscricao_estadual  		||
							sep_w || v_estabelecimento_w[i].cd_municipio_ibge  		||
							sep_w || v_estabelecimento_w[i].nr_inscricao_municipal		||
							sep_w || v_estabelecimento_w[i].cd_ind_situacao_especial	||
							sep_w || regra_sped_p.ie_inicio_periodo				||
							sep_w || regra_sped_p.ie_nire					||
							sep_w || regra_sped_p.ie_finalidade_escrit			||
							sep_w || regra_sped_p.cd_hash_substituida			||
							sep_w || regra_sped_p.nr_nire_subst				||
							sep_w || ie_porte_empresa_w					||
							sep_w || regra_sped_p.ie_tipo_ecd				||
							sep_w || ''							||
							sep_w || 'N'							||
							sep_w, 1, 8000);
		
		
		elsif (regra_sped_p.cd_versao in ('5.0','6.0','7.0')) then

			if (regra_sped_p.cd_versao = '7.0') and (regra_sped_p.ie_tipo_ecd = '2') then
				cd_scp_w := v_estabelecimento_w[i].cd_cnpj;
				begin
				select	cd_cgc
				into STRICT	cd_cnpj_matriz_w
				from	estabelecimento
				where	cd_empresa = regra_sped_p.cd_empresa
				and	ie_tipo_estab = 'M';

				v_estabelecimento_w[i].cd_cnpj := coalesce(cd_cnpj_matriz_w, v_estabelecimento_w[i].cd_cnpj);

				exception when others then
					v_estabelecimento_w[i].cd_cnpj := coalesce(cd_cnpj_matriz_w, v_estabelecimento_w[i].cd_cnpj);
				end;
			end if;
	
			ds_linha_w	:= substr(	sep_w || v_estabelecimento_w[i].tp_registro			||
							sep_w || v_estabelecimento_w[i].ds_lecd 			||
							sep_w || to_char(regra_sped_p.dt_ref_inicial,'ddmmyyyy') 	||
							sep_w || to_char(regra_sped_p.dt_ref_final,'ddmmyyyy')		||
							sep_w || v_estabelecimento_w[i].ds_razao_social  		||
							sep_w || v_estabelecimento_w[i].cd_cnpj  			||
							sep_w || v_estabelecimento_w[i].sg_estado			||
							sep_w || v_estabelecimento_w[i].cd_inscricao_estadual  		||
							sep_w || v_estabelecimento_w[i].cd_municipio_ibge  		||
							sep_w || v_estabelecimento_w[i].nr_inscricao_municipal		||
							sep_w || regra_sped_p.ie_sit_especial_ecd			||
							sep_w || regra_sped_p.ie_inicio_periodo				||
							sep_w || regra_sped_p.ie_nire					||
							sep_w || regra_sped_p.ie_finalidade_escrit			||
							sep_w || regra_sped_p.cd_hash_substituida			||
							sep_w || ie_porte_empresa_w					||
							sep_w || regra_sped_p.ie_tipo_ecd				||
							sep_w || cd_scp_w						||
							sep_w || 'N'							||
							sep_w || ie_consolida_multi_empresa_w 				||
							sep_w, 1, 8000);
							
		elsif (regra_sped_p.cd_versao  = '8.0') then

			if (regra_sped_p.ie_tipo_ecd = '2') then
				cd_scp_w := v_estabelecimento_w[i].cd_cnpj;
				begin
				select	cd_cgc
				into STRICT	cd_cnpj_matriz_w
				from	estabelecimento
				where	cd_empresa = regra_sped_p.cd_empresa
				and	ie_tipo_estab = 'M';

				v_estabelecimento_w[i].cd_cnpj := coalesce(cd_cnpj_matriz_w, v_estabelecimento_w[i].cd_cnpj);

				exception when others then
					v_estabelecimento_w[i].cd_cnpj := coalesce(cd_cnpj_matriz_w, v_estabelecimento_w[i].cd_cnpj);
				end;
			end if;
		
			if (regra_sped_p.ie_consolida_empresa = 'N') then
				ind_centralizada_w := 1;
			end if;

			select	max(coalesce(ie_gerar,'N'))
			into STRICT	ie_gerar_157_w
			from	ctb_regra_sped_registro
			where	nr_seq_regra_sped = regra_sped_p.nr_sequencia
			and	cd_registro = 'I157';
		
			if (ie_gerar_157_w = 'S') then
				select	coalesce(max('S'),'N')
				into STRICT	ie_houve_troca_w
				from	ctb_mes_ref			b,
					ctb_saldo_alteracao_conta	a
				where	b.nr_sequencia		= a.nr_seq_mes_ref
				and	b.dt_referencia	between trunc(regra_sped_p.dt_ref_inicial,'mm') and fim_dia(regra_sped_p.dt_ref_final)  LIMIT 1;
			end if;
		
			if (ie_gerar_157_w =  'S' and ie_houve_troca_w = 'S') then
				ind_mudanc_pc_w := 1;
			end if;
			
			select	coalesce(max(ie_gerar),'N')
			into STRICT	ie_gerar_I051_w
			from	ctb_regra_sped_registro a
			where	a.nr_seq_regra_sped = regra_sped_p.nr_sequencia
			and	a.cd_registro = 'I051';
			
			if (ie_gerar_I051_w =  'N') then
				cod_plan_ref_w := null;
			end if;
		
			ds_linha_w	:= substr(	sep_w || v_estabelecimento_w[i].tp_registro			||
							sep_w || v_estabelecimento_w[i].ds_lecd 			||
							sep_w || to_char(regra_sped_p.dt_ref_inicial,'ddmmyyyy') 	||
							sep_w || to_char(regra_sped_p.dt_ref_final,'ddmmyyyy')		||
							sep_w || v_estabelecimento_w[i].ds_razao_social  		||
							sep_w || v_estabelecimento_w[i].cd_cnpj  			||
							sep_w || v_estabelecimento_w[i].sg_estado			||
							sep_w || v_estabelecimento_w[i].cd_inscricao_estadual  		||
							sep_w || v_estabelecimento_w[i].cd_municipio_ibge  		||
							sep_w || v_estabelecimento_w[i].nr_inscricao_municipal		||
							sep_w || regra_sped_p.ie_sit_especial_ecd			||
							sep_w || regra_sped_p.ie_inicio_periodo				||
							sep_w || regra_sped_p.ie_nire					||
							sep_w || regra_sped_p.ie_finalidade_escrit			||
							sep_w || regra_sped_p.cd_hash_substituida			||
							sep_w || ie_porte_empresa_w					||
							sep_w || regra_sped_p.ie_tipo_ecd				||
							sep_w || cd_scp_w						||
							sep_w || 'N'							||
							sep_w || ie_consolida_multi_empresa_w 				||
							sep_w || ind_centralizada_w	 				||
							sep_w || ind_mudanc_pc_w	 				||
							sep_w || cod_plan_ref_w		 				||
							sep_w, 1, 8000);						
		end if;
		regra_sped_p.cd_registro_variavel := '0000';
		regra_sped_p => regra_sped_p := ctb_sped_ecd_pck.inserir_registros_vetor(regra_sped_p => regra_sped_p, ds_linha_p => ds_linha_w);

		end;
		end loop;
		regra_sped_p => regra_sped_p := ctb_sped_ecd_pck.persistir_registros_em_lote(regra_sped_p => regra_sped_p, nm_usuario_p => nm_usuario_p);
	end loop;
close c_establecimento;
		
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ctb_sped_ecd_pck.gerar_interf_0000_ecd (regra_sped_p INOUT ctb_sped_ecd_pck.regra_sped, nm_usuario_p text) FROM PUBLIC;
