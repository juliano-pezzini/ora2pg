-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE ctb_sped_ecd_pck.gerar_interf_i012_ecd (regra_sped_p INOUT ctb_sped_ecd_pck.regra_sped, nm_usuario_p text) AS $body$
DECLARE

			

ds_linha_w		varchar(8000);
sep_w			varchar(1) := '|';
tp_registro_w		varchar(15) := 'I012';
cd_codigo_conta_ecd_w	varchar(2);


c01 CURSOR(
		nr_seq_regra_sped_pc 		 ctb_sped_controle.nr_seq_regra_sped%type,
		ie_forma_escrituracao_pc 	 ctb_regra_sped.ie_forma_escrituracao%type,
		nr_seq_cont_principal_pc	 ctb_sped_controle.nr_seq_cont_principal%type
	)FOR
SELECT	x.nr_sequencia,
	x.nr_livro,
	x.ds_livro ,
        x.cd_conta_contabil
from (	select	b.nr_sequencia,
		b.nr_livro,
		b.ds_livro ,
		c.cd_conta_contabil
	FROM ctb_regra_sped_livro_aux a, ctb_livro_auxiliar b
LEFT OUTER JOIN ctb_livro_aux_conta c ON (b.nr_sequencia = c.nr_seq_livro)
WHERE a.nr_seq_livro_aux 	= b.nr_sequencia  and a.nr_seq_regra_sped 	= nr_seq_regra_sped_pc and ie_forma_escrituracao_pc not in ('A','Z')
	
union all

	SELECT  0,
		nr_livro,
		ds_natureza_livro,
		null
	from   	ctb_sped_controle a
	where	a.nr_sequencia 		= nr_seq_cont_principal_pc
	and     ie_forma_escrituracao_pc in ('A','Z') 
) x;

type vetor_c01 is table of c01%rowtype index by integer;
vetor_c01_w    vetor_c01;

type vetor_ctb_sped_registro is table of ctb_sped_registro%rowtype index by integer;
v_ctb_sped_registro_w  vetor_ctb_sped_registro;

BEGIN

open c01(
	nr_seq_regra_sped_pc 	 => regra_sped_p.nr_seq_regra_sped,
	ie_forma_escrituracao_pc => regra_sped_p.ie_forma_escrituracao,
	nr_seq_cont_principal_pc => regra_sped_p.nr_seq_cont_principal
	);
	loop fetch c01 bulk collect into vetor_c01_w limit 1000;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		for i in vetor_c01_w.first .. vetor_c01_w.last loop
		tp_registro_w	:= 'I012';
		ds_linha_w	:= substr(	sep_w || tp_registro_w 				||
						sep_w || vetor_c01_w[i].nr_livro	 	|| 
						sep_w || vetor_c01_w[i].ds_livro		|| 
						sep_w || 0		 			|| 
						sep_w || ''	 				|| sep_w,1,8000);

		regra_sped_p.cd_registro_variavel := tp_registro_w;
		regra_sped_p => regra_sped_p := ctb_sped_ecd_pck.inserir_registros_vetor(regra_sped_p => regra_sped_p, ds_linha_p => ds_linha_w);
		tp_registro_w	:= 'I015';
		if (vetor_c01_w[i](.cd_conta_contabil IS NOT NULL AND .cd_conta_contabil::text <> '')) then
			cd_codigo_conta_ecd_w	:= ctb_sped_ecd_pck.obter_cod_conta_ecd(ie_tipo_conta_p	=> 'C',
								ie_apres_conta_ctb_p	=> regra_sped_p.ie_apres_conta_ctb, 
								cd_empresa_p		=> null, 
								cd_conta_contabil_p	=> vetor_c01_w[i].cd_conta_contabil, 
								cd_classificacao_p	=> null,
								dt_vigencia_p		=> regra_sped_p.dt_ref_final);
								
			ds_linha_w	:= substr(	sep_w || tp_registro_w  			||
							sep_w || cd_codigo_conta_ecd_w			|| sep_w,1,8000);

			regra_sped_p.cd_registro_variavel := tp_registro_w;
			regra_sped_p => regra_sped_p := ctb_sped_ecd_pck.inserir_registros_vetor(regra_sped_p => regra_sped_p, ds_linha_p => ds_linha_w);
		end if;
		end loop;
		regra_sped_p => regra_sped_p := ctb_sped_ecd_pck.persistir_registros_em_lote(regra_sped_p => regra_sped_p, nm_usuario_p => nm_usuario_p);
	end loop;
close c01;	

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ctb_sped_ecd_pck.gerar_interf_i012_ecd (regra_sped_p INOUT ctb_sped_ecd_pck.regra_sped, nm_usuario_p text) FROM PUBLIC;
