-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE ctb_sped_ecd_pck.gerar_interf_j935_ecd (regra_sped_p INOUT ctb_sped_ecd_pck.regra_sped, nm_usuario_p text) AS $body$
DECLARE


sep_w				varchar(1)	:= '|';
tp_registro_w			varchar(15)	:= 'J935';
ds_linha_w			varchar(8000);

cd_pf_cnpj_w			varchar(50) 	:= '';
cd_pf_auditor_w			empresa.cd_pf_auditor%type;
nm_pessoa_fisica_w		pessoa_fisica.nm_pessoa_fisica%type;
nr_cpf_w			pessoa_fisica.nr_cpf%type;
ds_codigo_prof_w		pessoa_fisica.ds_codigo_prof%type;
cd_cnpj_auditor_w		empresa.cd_cnpj_auditor%type;
ds_razao_social_auditoria_w	pessoa_juridica.ds_razao_social%type;
cd_cvm_w			pessoa_juridica.cd_cvm%type;
cd_cgc_w			pessoa_juridica.cd_cgc%type;
ie_porte_empresa_w		empresa.ie_porte_empresa%type;


c_estabelecimento CURSOR(
	cd_pf_auditor_pc	 empresa.cd_pf_auditor%type,
	cd_cnpj_auditor_pc 	 empresa.cd_cnpj_auditor%type,
	cd_estabelecimento_pc 	 estabelecimento.cd_estabelecimento%type
	) FOR
	SELECT	coalesce(cd_pf_auditor,cd_pf_auditor_pc) cd_pf_auditor,
		coalesce(cd_cnpj_auditor, cd_cnpj_auditor_pc) cd_cnpj_auditor
	from	estabelecimento
	where   cd_estabelecimento	= cd_estabelecimento_pc
	and 	ie_porte_empresa_w	= 'G';
	
type vetor_estabelecimento is table of c_estabelecimento%rowtype index by integer;
v_estabelecimento_w    vetor_estabelecimento;

BEGIN
select	max(cd_pf_auditor),
	max(cd_cnpj_auditor),
	max(ie_porte_empresa)
into STRICT	cd_pf_auditor_w,
	cd_cnpj_auditor_w,
	ie_porte_empresa_w
from	empresa
where	cd_empresa	= regra_sped_p.cd_empresa;

open c_estabelecimento(
	cd_pf_auditor_pc	=>	cd_pf_auditor_w,
	cd_cnpj_auditor_pc	=>	cd_cnpj_auditor_w,
	cd_estabelecimento_pc  	=>	regra_sped_p.cd_estabelecimento
	);
	loop fetch c_estabelecimento bulk collect into v_estabelecimento_w limit 1000;
	EXIT WHEN NOT FOUND; /* apply on c_estabelecimento */
		for i in v_estabelecimento_w.first .. v_estabelecimento_w.last loop
		begin
		
		if ( v_estabelecimento_w[i](.cd_pf_auditor IS NOT NULL AND .cd_pf_auditor::text <> '')) then
			select	a.nm_pessoa_fisica,
				a.ds_codigo_prof,
				a.nr_cpf
			into STRICT	nm_pessoa_fisica_w,
				ds_codigo_prof_w,
				nr_cpf_w
			from	pessoa_fisica	a
			where	a.cd_pessoa_fisica	= v_estabelecimento_w[i].cd_pf_auditor;
			
			cd_pf_cnpj_w := nr_cpf_w;
		
		elsif ( v_estabelecimento_w[i](.cd_cnpj_auditor IS NOT NULL AND .cd_cnpj_auditor::text <> '')) then
			begin
			select	ds_razao_social,
				cd_cvm
			into STRICT	ds_razao_social_auditoria_w,
				cd_cvm_w
			from	pessoa_juridica a
			where	cd_cgc	= v_estabelecimento_w[i].cd_cnpj_auditor;
			exception when others then
				ds_razao_social_auditoria_w	:= '';
			end;
			
			cd_pf_cnpj_w := v_estabelecimento_w[i].cd_cnpj_auditor;
		end if;
		
		if ( regra_sped_p.cd_versao in ('7.0','8.0')) then
			ds_linha_w	:= substr(	sep_w || tp_registro_w ||
							sep_w || cd_pf_cnpj_w ||
							sep_w || coalesce(nm_pessoa_fisica_w,ds_razao_social_auditoria_w) ||
							sep_w || coalesce(ds_codigo_prof_w,cd_cvm_w) ||
							sep_w ,1,8000);	
		else
			ds_linha_w	:= substr(	sep_w || tp_registro_w ||
							sep_w || coalesce(nm_pessoa_fisica_w,ds_razao_social_auditoria_w) ||
							sep_w || coalesce(ds_codigo_prof_w,cd_cvm_w) ||
							sep_w ,1,8000);
		
		end if;
		regra_sped_p.cd_registro_variavel := tp_registro_w;
		regra_sped_p => regra_sped_p := ctb_sped_ecd_pck.inserir_registros_vetor(regra_sped_p => regra_sped_p, ds_linha_p => ds_linha_w);
		
		end;
		end loop;
		
		regra_sped_p => regra_sped_p := ctb_sped_ecd_pck.persistir_registros_em_lote(regra_sped_p => regra_sped_p, nm_usuario_p => nm_usuario_p);
	end loop;
close c_estabelecimento;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ctb_sped_ecd_pck.gerar_interf_j935_ecd (regra_sped_p INOUT ctb_sped_ecd_pck.regra_sped, nm_usuario_p text) FROM PUBLIC;
