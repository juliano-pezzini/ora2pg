-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pfcs_pck_operating_rooms.calc_pacu_destinations (cd_establishment_p bigint, nm_user_p text) AS $body$
DECLARE

        cur_transfers CURSOR FOR
        SELECT bed.ie_classification cd_unit_classification,
            count(pat.nr_sequencia) qt_patients,
            count(case when pat.ie_over_threshold = PFCS_PCK_CONSTANTS.IE_YES then 1 end) qt_delays
        from pfcs_detail_patient pat,
            pfcs_detail_bed bed,
            pfcs_detail_schedule sch,
            pfcs_panel_detail pd
        where pat.nr_seq_detail = pd.nr_sequencia
            and bed.nr_seq_detail = pd.nr_sequencia
            and sch.nr_seq_detail = pd.nr_sequencia
            and pd.nr_seq_indicator = PFCS_PCK_INDICATORS.NR_OR_PACU_OCCUPANCY
            and pd.ie_situation = PFCS_PCK_CONSTANTS.IE_ACTIVE
            and pat.ie_transfer_order_status = PFCS_PCK_CONSTANTS.IE_YES
            and pd.nr_seq_operational_level = cd_establishment_p
        group by bed.ie_classification;

        pfcs_panel_seq_w        pfcs_panel.nr_sequencia%type;
        qt_discharges_w         integer := 0;
        qt_discharge_delays_w   integer := 0;
        qt_transfers_w          integer := 0;
        qt_unkown_w             integer := 0;

BEGIN
        select  coalesce(max(p.vl_indicator_help),0)
        into STRICT    qt_unkown_w
        from    pfcs_panel p
        where   p.nr_seq_indicator = PFCS_PCK_INDICATORS.NR_OR_PACU_OCCUPANCY
        and     p.nr_seq_operational_level = cd_establishment_p;

        if (qt_unkown_w > 0) then
            select count(pat.nr_sequencia), count(case when pat.ie_over_threshold = PFCS_PCK_CONSTANTS.IE_YES then 1 end)
            into STRICT qt_discharges_w, qt_discharge_delays_w
            from pfcs_detail_patient pat,
                pfcs_detail_bed bed,
                pfcs_detail_schedule sch,
                pfcs_panel_detail pd
            where pat.nr_seq_detail = pd.nr_sequencia
                and pat.ie_discharge_order_status = PFCS_PCK_CONSTANTS.IE_YES
                and bed.nr_seq_detail = pd.nr_sequencia
                and sch.nr_seq_detail = pd.nr_sequencia
                and pd.nr_seq_indicator = PFCS_PCK_INDICATORS.NR_OR_PACU_OCCUPANCY
                and pd.ie_situation = PFCS_PCK_CONSTANTS.IE_ACTIVE
                and pd.nr_seq_operational_level = cd_establishment_p;

            for c01_w in cur_transfers loop
                qt_transfers_w := qt_transfers_w + c01_w.qt_patients;
                 := pfcs_pck.pfcs_generate_results(
                    vl_indicator_p => c01_w.qt_patients, vl_indicator_help_p => c01_w.qt_delays, cd_reference_aux_p => c01_w.cd_unit_classification, nr_seq_indicator_p => PFCS_PCK_INDICATORS.NR_OR_PACU_DESTINATION, nr_seq_operational_level_p => cd_establishment_p, nm_usuario_p => nm_user_p, nr_seq_panel_p => pfcs_panel_seq_w);
            end loop;
        end if;

         := pfcs_pck.pfcs_generate_results(
            vl_indicator_p => qt_discharges_w, vl_indicator_help_p => qt_discharge_delays_w, cd_reference_value_p => PFCS_PCK_CONSTANTS.CD_EXPR_DISCHARGE, nr_seq_indicator_p => PFCS_PCK_INDICATORS.NR_OR_PACU_DESTINATION, nr_seq_operational_level_p => cd_establishment_p, nm_usuario_p => nm_user_p, nr_seq_panel_p => pfcs_panel_seq_w);
        pfcs_pck.pfcs_generate_results(
            vl_indicator_p => (qt_unkown_w - qt_discharges_w - qt_transfers_w),
            cd_reference_value_p => PFCS_PCK_CONSTANTS.CD_EXPR_UNKOWN,
            nr_seq_indicator_p => PFCS_PCK_INDICATORS.NR_OR_PACU_DESTINATION,
            nr_seq_operational_level_p => cd_establishment_p,
            nm_usuario_p => nm_user_p,
            nr_seq_panel_p => pfcs_panel_seq_w);

        CALL pfcs_pck.pfcs_activate_records(
            nr_seq_indicator_p => PFCS_PCK_INDICATORS.NR_OR_PACU_DESTINATION,
            nr_seq_operational_level_p => cd_establishment_p,
            nm_usuario_p => nm_user_p);
    END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pfcs_pck_operating_rooms.calc_pacu_destinations (cd_establishment_p bigint, nm_user_p text) FROM PUBLIC;
