-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pfcs_pck_operating_rooms.calc_unconfirmed_surgeries (cd_establishment_p bigint, nm_user_p text) AS $body$
DECLARE

        cur_patients CURSOR(nr_seq_organization_p  bigint) FOR
        SELECT pat.patient_id id_patient,
            pfcs_get_human_name(pat.nr_sequencia, PFCS_PCK_CONSTANTS.DS_PATIENT) nm_patient,
            pat.gender ds_gender,
            round(months_between(coalesce(pat.deceased_date, clock_timestamp()), pat.birthdate)) qt_patient_age,
            pfcs_pck_utils.get_network_validation(pat.nr_sequencia) ie_in_network,
            appt.ds_reason ds_procedure,
            appt.period_start dt_procedure,
            appt.id_appointment cd_appointment
        from pfcs_patient pat,
            pfcs_appointment appt,
            pfcs_general_rule rule
        where  upper(appt.si_status) = PFCS_PCK_CONSTANTS.SI_STATUS_PENDING
            and appt.period_start <= (clock_timestamp() + COALESCE(rule.QT_TIME_PENDING_SURGERIES, PFCS_PCK_CONSTANTS.VL_PENDING_SURGERIES_RULE) / 24)
            and appt.nr_seq_patient = pat.nr_sequencia
            and pat.nr_seq_organization = nr_seq_organization_p;

        pfcs_panel_seq_w        pfcs_panel.nr_sequencia%type;
        pfcs_panel_detail_seq_w pfcs_panel_detail.nr_sequencia%type;
        nr_seq_organization_w   pfcs_organization.nr_sequencia%type;
        qt_pending_w            integer := 0;

BEGIN
        nr_seq_organization_w := pfcs_pck_utils.get_organization_sequence(cd_establishment_p);
        for c01_w in cur_patients(nr_seq_organization_w) loop
            qt_pending_w := qt_pending_w + 1;

            select  nextval('pfcs_panel_detail_seq')
            into STRICT    pfcs_panel_detail_seq_w
;

            insert into pfcs_panel_detail(
                nr_sequencia,
                nm_usuario,
                dt_atualizacao,
                nm_usuario_nrec,
                dt_atualizacao_nrec,
                ie_situation,
                nr_seq_indicator,
                nr_seq_operational_level)
            values (
                pfcs_panel_detail_seq_w,
                nm_user_p,
                clock_timestamp(),
                nm_user_p,
                clock_timestamp(),
                PFCS_PCK_CONSTANTS.IE_TEMPORARY,
                PFCS_PCK_INDICATORS.NR_OR_PENDING_SURGERY,
                cd_establishment_p);

            insert into pfcs_detail_patient(
                nr_sequencia,
                nm_usuario,
                dt_atualizacao,
                nm_usuario_nrec,
                dt_atualizacao_nrec,
                nr_seq_detail,
                id_patient,
                nm_patient,
                ds_gender,
                ds_age_range,
                ds_coverage_network
            ) values (
                nextval('pfcs_detail_patient_seq'),
                nm_user_p,
                clock_timestamp(),
                nm_user_p,
                clock_timestamp(),
                pfcs_panel_detail_seq_w,
                c01_w.id_patient,
                c01_w.nm_patient,
                c01_w.ds_gender,
                c01_w.qt_patient_age,
                c01_w.ie_in_network
            );

            insert into pfcs_detail_schedule(
                nr_sequencia,
                nm_usuario,
                dt_atualizacao,
                nm_usuario_nrec,
                dt_atualizacao_nrec,
                nr_seq_detail,
                ds_procedure,
                dt_schedule,
                cd_appointment)
            values (
                nextval('pfcs_detail_schedule_seq'),
                nm_user_p,
                clock_timestamp(),
                nm_user_p,
                clock_timestamp(),
                pfcs_panel_detail_seq_w,
                c01_w.ds_procedure,
                c01_w.dt_procedure,
                c01_w.cd_appointment);
        end loop;

         := pfcs_pck.pfcs_generate_results(
            vl_indicator_p => qt_pending_w, nr_seq_indicator_p => PFCS_PCK_INDICATORS.NR_OR_PENDING_SURGERY, nr_seq_operational_level_p => cd_establishment_p, nm_usuario_p => nm_user_p, nr_seq_panel_p => pfcs_panel_seq_w);

        CALL pfcs_pck.pfcs_update_detail(
            nr_seq_indicator_p => PFCS_PCK_INDICATORS.NR_OR_PENDING_SURGERY,
            nr_seq_panel_p => pfcs_panel_seq_w,
            nr_seq_operational_level_p => cd_establishment_p,
            nm_usuario_p => nm_user_p);

        CALL pfcs_pck.pfcs_activate_records(
            nr_seq_indicator_p => PFCS_PCK_INDICATORS.NR_OR_PENDING_SURGERY,
            nr_seq_operational_level_p => cd_establishment_p,
            nm_usuario_p => nm_user_p);
    END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pfcs_pck_operating_rooms.calc_unconfirmed_surgeries (cd_establishment_p bigint, nm_user_p text) FROM PUBLIC;
