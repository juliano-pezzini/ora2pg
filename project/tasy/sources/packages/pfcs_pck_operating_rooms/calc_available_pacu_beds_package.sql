-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pfcs_pck_operating_rooms.calc_available_pacu_beds (cd_establishment_p bigint, nm_user_p text) AS $body$
DECLARE

        pfcs_panel_seq_w        pfcs_panel.nr_sequencia%type;
        qt_available_beds_w     integer := 0;
        qt_occupied_beds_w      integer := 0;

BEGIN
        select  count(uni.nr_seq_location)
        into STRICT    qt_available_beds_w
        from    unidade_atendimento uni,
                setor_atendimento sec
        where   pfcs_get_bed_status(
                    uni.ie_status_unidade,
                    PFCS_PCK_CONSTANTS.IE_CENSUS,
                    sec.cd_estabelecimento) = PFCS_PCK_CONSTANTS.IE_AVAILABLE_BEDS
        and     sec.ie_rpa = PFCS_PCK_CONSTANTS.IE_YES_BR
        and     sec.ie_situacao = PFCS_PCK_CONSTANTS.IE_ACTIVE
        and     uni.ie_situacao = PFCS_PCK_CONSTANTS.IE_ACTIVE
        and     uni.cd_setor_atendimento = sec.cd_setor_atendimento
        and     sec.cd_estabelecimento = cd_establishment_p;

        select  coalesce(max(p.vl_indicator_help),0)
        into STRICT    qt_occupied_beds_w
        from    pfcs_panel p
        where   p.nr_seq_indicator = PFCS_PCK_INDICATORS.NR_OR_PACU_OCCUPANCY
        and     p.nr_seq_operational_level = cd_establishment_p;

         := pfcs_pck.pfcs_generate_results(
            vl_indicator_p => pfcs_pck_utils.get_zero_if_negative(qt_available_beds_w - qt_occupied_beds_w), nr_seq_indicator_p => PFCS_PCK_INDICATORS.NR_OR_AVAILABLE_BEDS, nr_seq_operational_level_p => cd_establishment_p, nm_usuario_p => nm_user_p, nr_seq_panel_p => pfcs_panel_seq_w);

        CALL pfcs_pck.pfcs_activate_records(
            nr_seq_indicator_p => PFCS_PCK_INDICATORS.NR_OR_AVAILABLE_BEDS,
            nr_seq_operational_level_p => cd_establishment_p,
            nm_usuario_p => nm_user_p);
    END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pfcs_pck_operating_rooms.calc_available_pacu_beds (cd_establishment_p bigint, nm_user_p text) FROM PUBLIC;
