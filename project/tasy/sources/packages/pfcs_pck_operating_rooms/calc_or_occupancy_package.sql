-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pfcs_pck_operating_rooms.calc_or_occupancy (cd_establishment_p bigint, nm_user_p text) AS $body$
DECLARE

        cur_procedures CURSOR(nr_seq_organization_p  bigint) FOR
        SELECT enc.id_encounter nr_encounter,
            pat.patient_id id_patient,
            pfcs_get_human_name(pat.nr_sequencia, PFCS_PCK_CONSTANTS.DS_PATIENT) nm_patient,
            pat.gender ds_gender,
            round(months_between(coalesce(pat.deceased_date, clock_timestamp()), pat.birthdate)) qt_patient_age,
            pfcs_pck_utils.get_network_validation(pat.nr_sequencia) ie_in_network,
            enc.period_start dt_period_start,
            enc.dt_expected_discharge,
            pfcs_pck_utils.get_room_name(appt.nr_seq_location) ds_surgery_room,
            proc.ds_coding_disp ds_procedure,
            proc.period_start dt_procedure,
            appt.id_appointment cd_appointment
        from pfcs_patient pat,
            pfcs_encounter enc,
            pfcs_appointment appt,
            pfcs_procedure proc
        where proc.nr_seq_patient = pat.nr_sequencia
            and enc.nr_seq_patient = pat.nr_sequencia
            and (   upper(proc.si_status) = PFCS_PCK_CONSTANTS.SI_STATUS_IN_PROGRESS or (   pfcs_pck_utils.get_if_surgical_room(enc.nr_seq_location) = PFCS_PCK_CONSTANTS.IE_YES and
                        coalesce(upper(proc.si_status),PFCS_PCK_CONSTANTS.SI_STATUS_UNKOWN) = PFCS_PCK_CONSTANTS.SI_STATUS_UNKOWN) )
            and proc.cd_category = PFCS_PCK_CONSTANTS.CD_SURGICAL_PROCEDURE
            and appt.nr_seq_patient = proc.nr_seq_patient
            and appt.nr_seq_procedure = proc.nr_sequencia
            and pat.nr_seq_organization = nr_seq_organization_p;

        pfcs_panel_seq_w            pfcs_panel.nr_sequencia%type;
        pfcs_panel_detail_seq_w     pfcs_panel_detail.nr_sequencia%type;
        nr_seq_organization_w       pfcs_organization.nr_sequencia%type;
        qt_rooms_w                  integer := 0;
        qt_surgeries_in_progress_w  integer := 0;

BEGIN
        nr_seq_organization_w := pfcs_pck_utils.get_organization_sequence(cd_establishment_p);

        select  count(uni.nr_seq_location)
        into STRICT    qt_rooms_w
        from    unidade_atendimento uni,
                setor_atendimento sec
        where   uni.ie_exibir_cc = PFCS_PCK_CONSTANTS.IE_YES_BR
        and     sec.cd_setor_atendimento = uni.cd_setor_atendimento
        and     sec.ie_situacao = PFCS_PCK_CONSTANTS.IE_ACTIVE
        and     uni.ie_situacao = PFCS_PCK_CONSTANTS.IE_ACTIVE
        and     sec.cd_estabelecimento = cd_establishment_p;

        for c01_w in cur_procedures(nr_seq_organization_w) loop
            qt_surgeries_in_progress_w := qt_surgeries_in_progress_w + 1;

            select  nextval('pfcs_panel_detail_seq')
            into STRICT    pfcs_panel_detail_seq_w
;

            insert into pfcs_panel_detail(
                nr_sequencia,
                nm_usuario,
                dt_atualizacao,
                nm_usuario_nrec,
                dt_atualizacao_nrec,
                ie_situation,
                nr_seq_indicator,
                nr_seq_operational_level)
            values (
                pfcs_panel_detail_seq_w,
                nm_user_p,
                clock_timestamp(),
                nm_user_p,
                clock_timestamp(),
                PFCS_PCK_CONSTANTS.IE_TEMPORARY,
                PFCS_PCK_INDICATORS.NR_OR_OCCUPANCY,
                cd_establishment_p);

            insert into pfcs_detail_patient(
                nr_sequencia,
                nm_usuario,
                dt_atualizacao,
                nm_usuario_nrec,
                dt_atualizacao_nrec,
                nr_seq_detail,
                nr_encounter_varchar,
                dt_entrance,
                id_patient,
                nm_patient,
                ds_gender,
                ds_age_range,
                dt_expected_discharge,
                ds_coverage_network)
            values (
                nextval('pfcs_detail_patient_seq'),
                nm_user_p,
                clock_timestamp(),
                nm_user_p,
                clock_timestamp(),
                pfcs_panel_detail_seq_w,
                c01_w.nr_encounter,
                c01_w.dt_period_start,
                c01_w.id_patient,
                c01_w.nm_patient,
                c01_w.ds_gender,
                c01_w.qt_patient_age,
                c01_w.dt_expected_discharge,
                c01_w.ie_in_network);

            insert into pfcs_detail_schedule(
                nr_sequencia,
                nm_usuario,
                dt_atualizacao,
                nm_usuario_nrec,
                dt_atualizacao_nrec,
                nr_seq_detail,
                ds_procedure,
                ds_room,
                dt_schedule,
                cd_appointment)
            values (
                nextval('pfcs_detail_schedule_seq'),
                nm_user_p,
                clock_timestamp(),
                nm_user_p,
                clock_timestamp(),
                pfcs_panel_detail_seq_w,
                c01_w.ds_procedure,
                c01_w.ds_surgery_room,
                c01_w.dt_procedure,
                c01_w.cd_appointment);
        end loop;

         := pfcs_pck.pfcs_generate_results(
            vl_indicator_p => qt_rooms_w, vl_indicator_help_p => qt_surgeries_in_progress_w, nr_seq_indicator_p => PFCS_PCK_INDICATORS.NR_OR_OCCUPANCY, nr_seq_operational_level_p => cd_establishment_p, nm_usuario_p => nm_user_p, nr_seq_panel_p => pfcs_panel_seq_w);
         := pfcs_pck.pfcs_generate_results(
            vl_indicator_p => qt_rooms_w, vl_indicator_help_p => qt_surgeries_in_progress_w, nr_seq_indicator_p => PFCS_PCK_INDICATORS.NR_VC_OR_CAPACITY, nr_seq_operational_level_p => cd_establishment_p, nm_usuario_p => nm_user_p, nr_seq_panel_p => pfcs_panel_seq_w);

        CALL pfcs_pck.pfcs_update_detail(
            nr_seq_indicator_p => PFCS_PCK_INDICATORS.NR_OR_OCCUPANCY,
            nr_seq_panel_p => pfcs_panel_seq_w,
            nr_seq_operational_level_p => cd_establishment_p,
            nm_usuario_p => nm_user_p);

        CALL pfcs_pck.pfcs_activate_records(
            nr_seq_indicator_p => PFCS_PCK_INDICATORS.NR_OR_OCCUPANCY,
            nr_seq_operational_level_p => cd_establishment_p,
            nm_usuario_p => nm_user_p);
         CALL pfcs_pck.pfcs_activate_records(
            nr_seq_indicator_p => PFCS_PCK_INDICATORS.NR_VC_OR_CAPACITY,
            nr_seq_operational_level_p => cd_establishment_p,
            nm_usuario_p => nm_user_p);
    END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pfcs_pck_operating_rooms.calc_or_occupancy (cd_establishment_p bigint, nm_user_p text) FROM PUBLIC;
