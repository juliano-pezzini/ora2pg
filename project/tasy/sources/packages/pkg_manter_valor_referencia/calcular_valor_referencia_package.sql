-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pkg_manter_valor_referencia.calcular_valor_referencia ( nr_prescricao_p bigint, nr_seq_prescr_p bigint, nr_seq_exame_p bigint ) RETURNS LAB_LOTE_VAL_REF%ROWTYPE AS $body$
DECLARE

        dt_coleta_w            timestamp;
        qt_dias_w              double precision := 0;
        qt_horas_w             bigint := 0;
        ie_sexo_w              varchar(1);
        cd_pessoa_fisica_w     prescr_medica.cd_pessoa_fisica%type;
        nr_seq_material_w      exame_lab_result_item.nr_seq_material%type;
        nr_seq_metodo_w        exame_lab_result_item.nr_seq_metodo%type;
        refer                  lab_lote_val_ref%rowtype;


BEGIN

        select  cd_pessoa_fisica
        into STRICT    cd_pessoa_fisica_w
        from    prescr_medica
        where   nr_prescricao = nr_prescricao_p;

        select  to_date(to_char(max(coalesce(b.dt_coleta_ficha_f,clock_timestamp())),'dd/mm/yyyy')||' '||to_char(max(coalesce(b.hr_coleta_f,clock_timestamp())),'hh24:mi:ss'),'dd/mm/yyyy hh24:mi:ss')
        into STRICT    dt_coleta_w
        from    prescr_procedimento a,
                lote_ent_sec_ficha b
        where   a.nr_prescricao = b.nr_prescricao
        and     a.nr_prescricao = nr_prescricao_p;

        if (dt_coleta_w IS NOT NULL AND dt_coleta_w::text <> '') then

            select  obter_dias_entre_datas(obter_data_nascto_pf(cd_pessoa_fisica_w), dt_coleta_w),
                    substr(obter_sexo_prescricao(nr_prescricao_p),1,1),
                    round(obter_hora_entre_datas(obter_data_nascto_pf(cd_pessoa_fisica_w),dt_coleta_w))
            into STRICT    qt_dias_w,
                    ie_sexo_w,
                    qt_horas_w
;

        end if;

        select  coalesce(a.nr_seq_material,0),
                coalesce(a.nr_seq_metodo,0)
        into STRICT    nr_seq_material_w,
                nr_seq_metodo_w
        from    exame_lab_result_item a,
                exame_lab_resultado b
        where   a.nr_seq_resultado = b.nr_seq_resultado
          and   b.nr_prescricao = nr_prescricao_p
          and   a.nr_seq_prescr = nr_seq_prescr_p
          and   (a.nr_seq_material IS NOT NULL AND a.nr_seq_material::text <> '');

        select  qt_minima,
                qt_maxima,
                qt_percent_min,
                qt_percent_max,
                ds_observacao
        into STRICT    refer.qt_minima,
                refer.qt_maxima,
                refer.qt_percent_min,
                refer.qt_percent_max,
                refer.ds_observacao
        from (
            SELECT  qt_minima,
                    qt_maxima,
                    qt_percent_min,
                    qt_percent_max,
                    ds_observacao
            from    exame_lab_padrao
            where   ((ie_sexo = ie_sexo_w) or (ie_sexo = '0'))
              and   nr_seq_exame = nr_seq_exame_p
              and   coalesce(nr_seq_material,nr_seq_material_w) = nr_seq_material_w
              and   coalesce(nr_seq_metodo, nr_seq_metodo_w) = nr_seq_metodo_w
              and   (((trunc((qt_dias_w / 365.25),2) between coalesce(qt_idade_min,0) and coalesce(qt_idade_max,99999)) and (ie_periodo = 'A')) or
                    ((((qt_dias_w / 365.25) * 12) between coalesce(qt_idade_min,0) and coalesce(qt_idade_max,99999)) and (ie_periodo = 'M')) or
                    ((qt_dias_w between coalesce(qt_idade_min,0) and coalesce(qt_idade_max,99999)) and (ie_periodo = 'D')) or
                    ((qt_horas_w between coalesce(qt_idade_min,0) and coalesce(qt_idade_max,99999)) and (ie_periodo = 'H')))
              and   ie_tipo_valor in (0,3)
              and   coalesce(ie_situacao,'A') = 'A'
            order by
                    coalesce(nr_seq_material, 9999999999), coalesce(nr_seq_metodo, 9999999999), ie_sexo, CASE WHEN ie_periodo='D' THEN 1 WHEN ie_periodo='M' THEN 2  ELSE 3 END ) alias34 LIMIT 1;

        select nextval('lab_lote_val_ref_seq') into STRICT refer.nr_sequencia;
        refer.nr_prescricao := nr_prescricao_p;
        refer.nr_seq_prescr := nr_seq_prescr_p;
        refer.nr_seq_exame := nr_seq_exame_p;

        return refer;
    END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pkg_manter_valor_referencia.calcular_valor_referencia ( nr_prescricao_p bigint, nr_seq_prescr_p bigint, nr_seq_exame_p bigint ) FROM PUBLIC;
