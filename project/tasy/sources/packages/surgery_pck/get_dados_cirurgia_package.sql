-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION surgery_pck.get_dados_cirurgia (nr_cirurgia_p bigint) RETURNS SETOF T_OBJETO_ROW_DATA AS $body$
DECLARE


t_objeto_row_w						t_objeto_row;


BEGIN
if (coalesce(nr_cirurgia_p,0) > 0) then
	SELECT	nr_atendimento,
				SUBSTR(obter_nome_pf_pj(cd_pessoa_fisica, NULL),1,60),
				SUBSTR(CASE WHEN ie_status_cirurgia='1' THEN wheb_mensagem_pck.get_texto(802692) WHEN ie_status_cirurgia='2' THEN wheb_mensagem_pck.get_texto(802693) WHEN ie_status_cirurgia='3' THEN wheb_mensagem_pck.get_texto(802694) WHEN ie_status_cirurgia='4' THEN wheb_mensagem_pck.get_texto(802695) END ,1,60),
				SUBSTR(obter_ds_descricao_setor(cd_setor_atendimento),1,100),
				obter_dif_data(coalesce(dt_inicio_cirurgia, clock_timestamp()), coalesce(dt_fim_cirurgia,clock_timestamp()),''),
				obter_dif_data(coalesce(dt_inicio_anestesia, clock_timestamp()), coalesce(dt_fim_anestesia,clock_timestamp()),''),
				SUBSTR(obter_valor_dominio(36,cd_tipo_anestesia),1,150),
				dt_inicio_real,
				dt_termino,
				dt_entr_matmed,
				qt_ric,
				coalesce(nr_min_duracao_real,nr_min_duracao_prev) nr_min_duracao,
				cd_medico_cirurgiao,
				ie_carater_cirurgia,
				ie_asa_estado_paciente,
				ie_porte,
				cd_tipo_cirurgia,
				cd_medico_anestesista,
				substr(obter_nome_pf(cd_medico_anestesista),1,90) nm_medico_anestesista,
				dt_entrada_unidade,
            nr_min_duracao_prev
	into STRICT		t_objeto_row_w.nr_atendimento,
				t_objeto_row_w.nm_pessoa_fisica,
				t_objeto_row_w.ds_status_cirurgia,
				t_objeto_row_w.ds_setor_atendimento,
				t_objeto_row_w.nr_tempo_cirurgia,
				t_objeto_row_w.nr_tempo_anestesia,
				t_objeto_row_w.ds_tipo_anestesia,
				t_objeto_row_w.dt_inicio_real,
				t_objeto_row_w.dt_termino,
				t_objeto_row_w.dt_entr_matmed,
				t_objeto_row_w.qt_ric,
				t_objeto_row_w.nr_min_duracao,
				t_objeto_row_w.cd_medico_cirurgiao,
				t_objeto_row_w.ie_carater_cirurgia,
				t_objeto_row_w.ie_asa_estado_paciente,
				t_objeto_row_w.ie_porte,
				t_objeto_row_w.cd_tipo_cirurgia,
				t_objeto_row_w.cd_medico_anestesista,
				t_objeto_row_w.nm_medico_anestesista,
				t_objeto_row_w.dt_entrada_unidade,
            t_objeto_row_w.nr_min_duracao_prev
	FROM		cirurgia
	WHERE		nr_cirurgia = nr_cirurgia_p;

	if (t_objeto_row_w.nr_atendimento IS NOT NULL AND t_objeto_row_w.nr_atendimento::text <> '') and (t_objeto_row_w.dt_entrada_unidade IS NOT NULL AND t_objeto_row_w.dt_entrada_unidade::text <> '') then
		select	substr(max(b.ds_setor_atendimento),1,30) || ' ' || max(a.cd_unidade_basica) || ' ' || max(a.cd_unidade_compl),
					substr(max(b.ds_setor_atendimento),1,255),
					max(a.cd_unidade_basica) || ' ' || max(a.cd_unidade_compl),
					max(a.nr_seq_interno),
					max(a.cd_setor_atendimento)
		into STRICT		t_objeto_row_w.ds_setor_unid,
					t_objeto_row_w.ds_setor,
					t_objeto_row_w.ds_unidade,
					t_objeto_row_w.nr_seq_interno,
					t_objeto_row_w.cd_setor_atendimento
		from		atend_paciente_unidade a,
					setor_atendimento b
		where		a.cd_setor_atendimento	= b.cd_setor_atendimento
		and		a.nr_atendimento			= t_objeto_row_w.nr_atendimento
		and		a.dt_entrada_unidade		= t_objeto_row_w.dt_entrada_unidade;
	end if;

	RETURN NEXT t_objeto_row_w;
end if;

RETURN;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION surgery_pck.get_dados_cirurgia (nr_cirurgia_p bigint) FROM PUBLIC;
