-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE ptu_a950_pck.valida_geracao_proced ( nr_seq_arq_xml_p pls_imp_arq_A950.nr_sequencia%type, cd_edicao_amb_p edicao_amb.cd_edicao_amb%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE

/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade:	Verifica se os itens que estao presentes apenas no A950, e por consequencia devem ser inseridos
		na tabela de preco, tambem existem na tabela procedimento, para evitar erro de FK
		
		Cada item que nao existir deve gerar um log detalhado, para que seja de facil acesso.
		
		
-------------------------------------------------------------------------------------------------------------------
Locais de chamada direta: 
[ ]  Objetos do dicionario [X] Tasy (Delphi/Java) [ X] Portal [ X]  Relatorios [ ] Outros:
-------------------------------------------------------------------------------------------------------------------
Pontos de atencao:
			Essa validacao nao deve ser impeditiva a importacao, so deve gerar informacoes.

Alteracoes:
-------------------------------------------------------------------------------------------------------------------
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
ie_origem_proced_w	procedimento.ie_origem_proced%type;

--tabela virtual
tb_msg_w		dbms_sql.varchar2_table;

ie_exibir_abort_w	varchar(1) := 'N';

-- carrega os itens que nao tem o cadastro no procedimento
c01 CURSOR(	nr_seq_arq_xml_pc	pls_imp_arq_A950.nr_sequencia%type,
		cd_edicao_amb_pc	edicao_amb.cd_edicao_amb%type,
		ie_origem_proced_pc	procedimento.ie_origem_proced%type) is
with a950 as (	SELECT	a.cd_procedimento_uni
		from	pls_imp_arq_a950_hm	a
		where	a.nr_seq_arq_a950	= nr_seq_arq_xml_pc
		
union all

		SELECT	a.cd_procedimento_uni
		from	pls_imp_arq_a950_sadt	a
		where	a.nr_seq_arq_a950	= nr_seq_arq_xml_pc
		EXCEPT
		select	a.cd_procedimento
		from	preco_tuss	a
		where	a.cd_edicao_amb	= cd_edicao_amb_pc)
select	'O procedimento '||to_char(a.cd_procedimento_uni)||' com origem ['||ie_origem_proced_w||'] - '||obter_valor_dominio(30, ie_origem_proced_w)||', nao esta cadastrado nos procedimentos da operadora / hospital'
from	a950	a
where	not exists (	select	1
			from	procedimento		x
			where	x.cd_procedimento	= a.cd_procedimento_uni
			and	x.ie_origem_proced	= ie_origem_proced_pc);

BEGIN

-- levanta as inf da tabela
select	max(a.ie_origem_proced)
into STRICT	ie_origem_proced_w
from	edicao_amb	a
where	a.cd_edicao_amb	= cd_edicao_amb_p;

-- carrega 
open c01(nr_seq_arq_xml_p, cd_edicao_amb_p, ie_origem_proced_w);
loop
	fetch c01 bulk collect into tb_msg_w limit pls_util_pck.qt_registro_transacao_w;
	exit when tb_msg_w.count = 0;
	
	tb_msg_w := ptu_a950_pck.grava_log_imp_tab_preco(nr_seq_arq_xml_p, cd_edicao_amb_p, tb_msg_w, nm_usuario_p);
end loop;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ptu_a950_pck.valida_geracao_proced ( nr_seq_arq_xml_p pls_imp_arq_A950.nr_sequencia%type, cd_edicao_amb_p edicao_amb.cd_edicao_amb%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;
