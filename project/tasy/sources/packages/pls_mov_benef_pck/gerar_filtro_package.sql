-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_mov_benef_pck.gerar_filtro ( ie_primeiro_select_w bigint) AS $body$
DECLARE


ie_tipo_alt_benef_w	varchar(32767);
ie_nm_campo_pf_w	varchar(32767);
ie_nm_campo_pf_compl_w	varchar(32767);
ie_aux_w		varchar(1) := 'N';

current_setting('pls_mov_benef_pck.c01')::CURSOR CURSOR FOR
SELECT	ie_tipo_alteracao,
	ie_tipo_alt_benef,
	nm_tabela,
	nm_atributo,
	ie_tipo_complemento	
from	pls_mov_benef_regra_alt
where	nr_seq_regra = current_setting('pls_mov_benef_pck.pls_mov_benef_regra_w')::pls_mov_benef_regra%rowtype.nr_sequencia;

BEGIN
if ( ie_primeiro_select_w = 0) then
	for r_c01_w in current_setting('pls_mov_benef_pck.c01')::loop CURSOR
		begin
			if (r_c01_w.ie_tipo_alteracao = 1) then 			
				if (ie_tipo_alt_benef_w IS NOT NULL AND ie_tipo_alt_benef_w::text <> '') then
					ie_tipo_alt_benef_w := ie_tipo_alt_benef_w || ',' || r_c01_w.ie_tipo_alt_benef;
				else
					ie_tipo_alt_benef_w := r_c01_w.ie_tipo_alt_benef;
				end if;
			elsif (r_c01_w.ie_tipo_alteracao = 2) then
				if (r_c01_w.nm_tabela = 'PESSOA_FISICA') then
					if (ie_nm_campo_pf_w IS NOT NULL AND ie_nm_campo_pf_w::text <> '') then
						ie_nm_campo_pf_w := ie_nm_campo_pf_w || ',' || ''''||r_c01_w.nm_atributo||'''';
					else
						ie_nm_campo_pf_w := ''''||r_c01_w.nm_atributo||'''';
					end if;
				elsif ( r_c01_w.nm_tabela = 'COMPL_PESSOA_FISICA') then			
					if (coalesce(ie_nm_campo_pf_compl_w::text, '') = '') then
						ie_nm_campo_pf_compl_w := ' and ( ( select count(1) '
									||' from  tasy_log_alteracao x, '
									||' tasy_log_alt_campo y ' 
									||' where y.nr_seq_log_alteracao   = x.nr_sequencia '
									||' and  x.nm_tabela = ''COMPL_PESSOA_FISICA'' '
									||' and  x.ds_chave_composta like ''%CD_PESSOA_FISICA=''||z.cd_pessoa_fisica||''#@#@NR_SEQUENCIA=''||nvl(obter_seq_tipo_compl_pf(z.cd_pessoa_fisica,null,'||coalesce(substr(r_c01_w.ie_tipo_complemento,1,100),'null')||'),''%'')'
									||' and  y.dt_atualizacao between :DATA_INICIAL and :DATA_FINAL '
									||' and  y.nm_atributo  = '''||r_c01_w.nm_atributo||''') >=1 ';
					else
						ie_nm_campo_pf_compl_w := ie_nm_campo_pf_compl_w
									|| ' or ( select count(1) ' 
									||' from  tasy_log_alteracao x, '
									||' tasy_log_alt_campo y ' 
									||' where y.nr_seq_log_alteracao   = x.nr_sequencia '
									||' and  x.nm_tabela = ''COMPL_PESSOA_FISICA'' '
									||' and  x.ds_chave_composta like ''%CD_PESSOA_FISICA=''||z.cd_pessoa_fisica||''#@#@NR_SEQUENCIA=''||nvl(obter_seq_tipo_compl_pf(z.cd_pessoa_fisica,null,'||coalesce(substr(r_c01_w.ie_tipo_complemento,1,100),'null')||'),''%'')'
									||' and  y.dt_atualizacao between :DATA_INICIAL and :DATA_FINAL '
									||' and  y.nm_atributo  = '''||r_c01_w.nm_atributo||''' ) >=1 ';
					end if;
				end if;
			end if;
		end;
	end loop;
	if (ie_nm_campo_pf_compl_w IS NOT NULL AND ie_nm_campo_pf_compl_w::text <> '') then
		PERFORM set_config('pls_mov_benef_pck.sql_filtros_w', current_setting('pls_mov_benef_pck.sql_filtros_w')::varchar(32767)  || ie_nm_campo_pf_compl_w, false);
		ie_aux_w :='S';
	end if;

	if (ie_tipo_alt_benef_w IS NOT NULL AND ie_tipo_alt_benef_w::text <> '') then
		if (ie_aux_w = 'S') then
			PERFORM set_config('pls_mov_benef_pck.sql_filtros_w', current_setting('pls_mov_benef_pck.sql_filtros_w')::varchar(32767) 	||' or (( select count(1)', false);
		else
			PERFORM set_config('pls_mov_benef_pck.sql_filtros_w', current_setting('pls_mov_benef_pck.sql_filtros_w')::varchar(32767) 	||' and ( (( select count(1)', false);
			ie_aux_w := 'S';
		end if;	
		PERFORM set_config('pls_mov_benef_pck.sql_filtros_w', current_setting('pls_mov_benef_pck.sql_filtros_w')::varchar(32767) ||' from   pls_segurado_historico x'
					       ||' where  x.nr_seq_segurado = z.nr_seq_segurado' 
					       ||' and    ie_tipo_historico in ( '||ie_tipo_alt_benef_w||')'
					       ||' and    dt_historico between :DATA_INICIAL and :DATA_FINAL' 
					       ||' and    x.dt_liberacao_hist is not null )>0) ', false);
	end if;

	if (ie_nm_campo_pf_w IS NOT NULL AND ie_nm_campo_pf_w::text <> '') then
		if (ie_aux_w = 'S') then
			PERFORM set_config('pls_mov_benef_pck.sql_filtros_w', current_setting('pls_mov_benef_pck.sql_filtros_w')::varchar(32767) ||' or (( select count(1)', false);
		else
			PERFORM set_config('pls_mov_benef_pck.sql_filtros_w', current_setting('pls_mov_benef_pck.sql_filtros_w')::varchar(32767) ||' and ( (( select count(1)', false);
			ie_aux_w := 'S';
		end if;
		PERFORM set_config('pls_mov_benef_pck.sql_filtros_w', current_setting('pls_mov_benef_pck.sql_filtros_w')::varchar(32767)  ||' from  tasy_log_alteracao x,'
							||' tasy_log_alt_campo y'
							||' where y.nr_seq_log_alteracao= x.nr_sequencia'
							||' and  x.nm_tabela = ''PESSOA_FISICA'''
							||' and  x.ds_chave_simples = z.cd_pessoa_fisica'
							||' and  y.dt_atualizacao between :DATA_INICIAL and :DATA_FINAL'
							||' and  y.nm_atributo in('||ie_nm_campo_pf_w||'))>0) ', false);
	end if;
	if (ie_aux_w = 'S') then
		PERFORM set_config('pls_mov_benef_pck.sql_filtros_w', current_setting('pls_mov_benef_pck.sql_filtros_w')::varchar(32767) || ' ) ', false);
	end if;
elsif (ie_primeiro_select_w = 1) then
	
	if (	current_setting('pls_mov_benef_pck.pls_mov_benef_regra_w')::pls_mov_benef_regra%(rowtype.ie_tipo_repasse IS NOT NULL AND rowtype.ie_tipo_repasse::text <> '')) then
		PERFORM set_config('pls_mov_benef_pck.sql_filtros_w', current_setting('pls_mov_benef_pck.sql_filtros_w')::varchar(32767) || '	and z.ie_tipo_repasse	= :IE_TIPO_REPASSE ', false);
	end if;

	if (	current_setting('pls_mov_benef_pck.pls_mov_benef_regra_w')::pls_mov_benef_regra%(rowtype.nr_seq_congenere IS NOT NULL AND rowtype.nr_seq_congenere::text <> '')) then
		PERFORM set_config('pls_mov_benef_pck.sql_filtros_w', current_setting('pls_mov_benef_pck.sql_filtros_w')::varchar(32767) || '	and z.nr_seq_congenere	= :NR_SEQ_CONGENERE ', false);
	end if;

	if (	current_setting('pls_mov_benef_pck.pls_mov_benef_regra_w')::pls_mov_benef_regra%(rowtype.ie_tipo_compartilhamento IS NOT NULL AND rowtype.ie_tipo_compartilhamento::text <> '')) then
		PERFORM set_config('pls_mov_benef_pck.sql_filtros_w', current_setting('pls_mov_benef_pck.sql_filtros_w')::varchar(32767) || '	and z.ie_tipo_compartilhamento = :IE_TIPO_COMPARTILHAMENTO ', false);
	end if;

	if (	current_setting('pls_mov_benef_pck.pls_mov_benef_lote_w')::pls_mov_benef_lote%rowtype.ie_tipo_movimento = 'I') then
		PERFORM set_config('pls_mov_benef_pck.sql_filtros_w', current_setting('pls_mov_benef_pck.sql_filtros_w')::varchar(32767) || '	and	z.dt_repasse		between :DATA_INICIAL and :DATA_FINAL ', false);
		
	elsif (	current_setting('pls_mov_benef_pck.pls_mov_benef_lote_w')::pls_mov_benef_lote%rowtype.ie_tipo_movimento = 'E') then
		PERFORM set_config('pls_mov_benef_pck.sql_filtros_w', current_setting('pls_mov_benef_pck.sql_filtros_w')::varchar(32767) || '	and	z.dt_fim_repasse	between :DATA_INICIAL and :DATA_FINAL ', false);

	elsif (	current_setting('pls_mov_benef_pck.pls_mov_benef_lote_w')::pls_mov_benef_lote%rowtype.ie_tipo_movimento = 'A') then
		PERFORM set_config('pls_mov_benef_pck.sql_filtros_w', current_setting('pls_mov_benef_pck.sql_filtros_w')::varchar(32767) || '	and	( z.dt_fim_repasse	is null 
						or	z.dt_fim_repasse	> :DATA_FINAL) ', false);

	elsif (	current_setting('pls_mov_benef_pck.pls_mov_benef_lote_w')::pls_mov_benef_lote%rowtype.ie_tipo_movimento = 'P') then
		PERFORM set_config('pls_mov_benef_pck.sql_filtros_w', current_setting('pls_mov_benef_pck.sql_filtros_w')::varchar(32767) || '	and	(	 z.dt_repasse		between :DATA_INICIAL and :DATA_FINAL 
								or	 z.dt_fim_repasse	between :DATA_INICIAL and :DATA_FINAL	)', false);
	end if;
end if;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_mov_benef_pck.gerar_filtro ( ie_primeiro_select_w bigint) FROM PUBLIC;
