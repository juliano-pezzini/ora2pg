-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


---------------- INSERE TODOS OS DADOS EM UMA TABELA TEMPORARIA.
CREATE OR REPLACE PROCEDURE pls_mov_benef_pck.gerar_dados_temp () AS $body$
DECLARE


ds_sql_w			varchar(32767);

nr_seq_segurado_repasse_w	pls_util_cta_pck.t_number_table;
nr_seq_segurado_w		pls_util_cta_pck.t_number_table;
nr_seq_plano_w			pls_util_cta_pck.t_number_table;
nr_seq_contrato_w		pls_util_cta_pck.t_number_table;
nr_seq_intercambio_w		pls_util_cta_pck.t_number_table;
nr_seq_operadora_w		pls_util_cta_pck.t_number_table;

valor_bind_w			sql_pck.t_dado_bind;
cursor_w			sql_pck.t_cursor;


BEGIN

CALL pls_mov_benef_pck.gerar_filtro(1);

ds_sql_w := 'select	z.nr_seq_segurado_repasse,
			z.nr_seq_segurado,
			z.nr_seq_plano,
			z.nr_seq_contrato,
			z.nr_seq_intercambio,
			z.nr_seq_operadora 
			from	( '
	    ||'	select	a.nr_sequencia nr_seq_segurado_repasse,
			a.nr_seq_segurado nr_seq_segurado,
			b.nr_seq_plano nr_seq_plano,
			b.nr_seq_contrato nr_seq_contrato,
			b.nr_seq_intercambio nr_seq_intercambio,
			a.nr_seq_congenere_atend nr_seq_operadora,
			a.dt_repasse dt_repasse,
			a.dt_fim_repasse dt_fim_repasse,
			a.ie_tipo_repasse ie_tipo_repasse,
			a.nr_seq_congenere nr_seq_congenere,
			a.ie_tipo_compartilhamento ie_tipo_compartilhamento,
			b.cd_pessoa_fisica cd_pessoa_fisica
		from	pls_segurado_repasse a,
			pls_segurado b
		where	b.nr_sequencia	= a.nr_seq_segurado
		and	a.nr_seq_congenere_atend is not null
		and	a.cd_estabelecimento	= :CD_ESTABELECIMENTO ';		
CALL pls_mov_benef_pck.gerar_filtro(0);

if (current_setting('pls_mov_benef_pck.pls_mov_benef_lote_w')::pls_mov_benef_lote%rowtype.ie_tipo_movimento = 'P') then

	ds_sql_w := ds_sql_w || ' 
		union
		select	a.nr_sequencia nr_seq_segurado_repasse,
			b.nr_sequencia,
			b.nr_seq_plano,
			b.nr_seq_contrato,
			b.nr_seq_intercambio,
			a.nr_seq_congenere_atend nr_seq_operadora,
			a.dt_repasse,
			a.dt_fim_repasse,
			a.ie_tipo_repasse,
			a.nr_seq_congenere,
			a.ie_tipo_compartilhamento,
			b.cd_pessoa_fisica
		from	pls_segurado_repasse a,
			pls_segurado b
		where	b.nr_sequencia	= a.nr_seq_segurado
		and	a.nr_seq_congenere_atend is not null
		and	a.cd_estabelecimento	= :CD_ESTABELECIMENTO
		and	((a.dt_repasse	between :DATA_INICIAL and :DATA_FINAL) and a.dt_fim_repasse < :DATA_FINAL)
		and	exists	(select 1
				 from	pls_segurado_historico	c
				 where	c.nr_seq_segurado	= b.nr_sequencia
				 and	c.ie_tipo_historico	<> 7
				 and	c.dt_ocorrencia_sib	between :DATA_INICIAL and :DATA_FINAL )
		union
		select	a.nr_sequencia nr_seq_segurado_repasse,
			b.nr_sequencia,
			b.nr_seq_plano,
			b.nr_seq_contrato,
			b.nr_seq_intercambio,
			a.nr_seq_congenere_atend nr_seq_operadora,
			a.dt_repasse,
			a.dt_fim_repasse,
			a.ie_tipo_repasse,
			a.nr_seq_congenere,
			a.ie_tipo_compartilhamento,
			b.cd_pessoa_fisica
		from	pls_segurado_repasse a,
			pls_segurado b
		where	b.nr_sequencia	= a.nr_seq_segurado
		and	a.nr_seq_congenere_atend is not null
		and	a.cd_estabelecimento	= :CD_ESTABELECIMENTO
		and	((a.dt_repasse	between :DATA_INICIAL and :DATA_FINAL) and a.dt_fim_repasse < :DATA_FINAL)
		and	exists	(select	1
				from	tasy_log_alteracao	d
				where	d.nm_tabela		= ''PESSOA_FISICA''
				and	d.ds_chave_simples	= b.cd_pessoa_fisica
				and	d.dt_atualizacao	between :DATA_INICIAL and :DATA_FINAL 
				union all
				select	1
				from	tasy_log_alteracao	f
				where	f.nm_tabela		= ''COMPL_PESSOA_FISICA''
				and	f.dt_atualizacao	between :DATA_INICIAL and :DATA_FINAL
				and	f.ds_chave_composta	like ''%CD_PESSOA_FISICA='' || b.cd_pessoa_fisica || ''#@%'' )';
end if;

ds_sql_w := ds_sql_w || ' ) z where 1 = 1 ' || current_setting('pls_mov_benef_pck.sql_filtros_w')::varchar(32767);
PERFORM set_config('pls_mov_benef_pck.sql_filtros_w', '', false);

valor_bind_w := sql_pck.bind_variable(':DATA_INICIAL', current_setting('pls_mov_benef_pck.pls_mov_benef_lote_w')::pls_mov_benef_lote%rowtype.dt_movimento_inicial, valor_bind_w);
valor_bind_w := sql_pck.bind_variable(':DATA_FINAL', current_setting('pls_mov_benef_pck.pls_mov_benef_lote_w')::pls_mov_benef_lote%rowtype.dt_movimento_final, valor_bind_w);
valor_bind_w := sql_pck.bind_variable(':NR_SEQ_CONGENERE', current_setting('pls_mov_benef_pck.pls_mov_benef_regra_w')::pls_mov_benef_regra%rowtype.nr_seq_congenere, valor_bind_w);
valor_bind_w := sql_pck.bind_variable(':CD_ESTABELECIMENTO', current_setting('pls_mov_benef_pck.pls_mov_benef_regra_w')::pls_mov_benef_regra%rowtype.cd_estabelecimento, valor_bind_w);
valor_bind_w := sql_pck.bind_variable(':IE_TIPO_REPASSE', current_setting('pls_mov_benef_pck.pls_mov_benef_regra_w')::pls_mov_benef_regra%rowtype.ie_tipo_repasse, valor_bind_w);
valor_bind_w := sql_pck.bind_variable(':IE_TIPO_COMPARTILHAMENTO', current_setting('pls_mov_benef_pck.pls_mov_benef_regra_w')::pls_mov_benef_regra%rowtype.ie_tipo_compartilhamento, valor_bind_w);
valor_bind_w := sql_pck.executa_sql_cursor(ds_sql_w, valor_bind_w);
loop
	fetch cursor_w bulk collect into nr_seq_segurado_repasse_w, nr_seq_segurado_w, nr_seq_plano_w,
					nr_seq_contrato_w, nr_seq_intercambio_w, nr_seq_operadora_w
	limit pls_util_pck.qt_registro_transacao_w;
	exit when nr_seq_segurado_repasse_w.count = 0;
	
	forall i in nr_seq_segurado_repasse_w.first .. nr_seq_segurado_repasse_w.last
		insert	into	pls_mov_benef_temp(	nr_seq_segurado_repasse,
				nr_seq_segurado,
				nr_seq_plano,
				nr_seq_contrato,
				nr_seq_intercambio,
				nr_seq_operadora)
			values (nr_seq_segurado_repasse_w(i),
				nr_seq_segurado_w(i),
				nr_seq_plano_w(i),
				nr_seq_contrato_w(i),
				nr_seq_intercambio_w(i),
				nr_seq_operadora_w(i));
	commit;
end loop;

close cursor_w;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_mov_benef_pck.gerar_dados_temp () FROM PUBLIC;
