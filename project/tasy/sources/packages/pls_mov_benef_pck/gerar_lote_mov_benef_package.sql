-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


---------------- INICIO DO PROCESSO ----------------------
CREATE OR REPLACE PROCEDURE pls_mov_benef_pck.gerar_lote_mov_benef ( nr_seq_lote_p pls_mov_benef_lote.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) AS $body$
DECLARE

qt_registros_w	integer;

BEGIN

CALL exec_sql_dinamico(nm_usuario_p, 'truncate table pls_mov_benef_temp');

select	*
into STRICT	current_setting('pls_mov_benef_pck.pls_mov_benef_lote_w')::pls_mov_benef_lote%rowtype
from	pls_mov_benef_lote
where	nr_sequencia = nr_seq_lote_p;

select	*
into STRICT	current_setting('pls_mov_benef_pck.pls_mov_benef_regra_w')::pls_mov_benef_regra%rowtype
from	pls_mov_benef_regra
where	nr_sequencia = current_setting('pls_mov_benef_pck.pls_mov_benef_lote_w')::pls_mov_benef_lote%rowtype.nr_seq_regra;

PERFORM set_config('pls_mov_benef_pck.nm_usuario_w', nm_usuario_p, false);
PERFORM set_config('pls_mov_benef_pck.cd_estabelecimento_w', cd_estabelecimento_p, false);

CALL CALL pls_mov_benef_pck.gerar_dados_temp();

select	count(1)
into STRICT	qt_registros_w
from	pls_mov_benef_temp;

if (qt_registros_w > 0) then
	CALL inserir_mov_operadora();
	inserir_mov_contrato;
	inserir_mov_plano;
	inserir_mov_beneficiario;
	inserir_mov_benef_dados;
	
	update	pls_mov_benef_lote
	set	dt_geracao_lote	= clock_timestamp(),
		dt_atualizacao	= clock_timestamp(),
		nm_usuario	= nm_usuario_p
	where	nr_sequencia = nr_seq_lote_p;
else
	CALL wheb_mensagem_pck.exibir_mensagem_abort(1067661); -- 'Não existem informações para gerar o lote.';
end if;

commit;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_mov_benef_pck.gerar_lote_mov_benef ( nr_seq_lote_p pls_mov_benef_lote.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) FROM PUBLIC;
