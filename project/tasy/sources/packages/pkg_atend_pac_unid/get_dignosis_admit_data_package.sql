-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

  --
CREATE OR REPLACE FUNCTION pkg_atend_pac_unid.get_dignosis_admit_data (P_NR_ATEND bigint, P_DT_ENTRY timestamp, P_TYPE text DEFAULT 'D') RETURNS varchar AS $body$
DECLARE

    DT  timestamp;
    NR  bigint;
    RET varchar(255);

  
BEGIN
    
    NR := NULL;
    RET := NULL;

    IF coalesce(P_NR_ATEND, 0) <> 0 AND (P_DT_ENTRY IS NOT NULL AND P_DT_ENTRY::text <> '') THEN
      --
      DT := pkg_atend_pac_unid.get_dt_dignosis_admit(P_NR_ATEND, P_DT_ENTRY);
      
      IF (DT IS NOT NULL AND DT::text <> '') THEN
        --
        SELECT MAX(D.NR_SEQ_INTERNO)
          INTO STRICT NR
          FROM DIAGNOSTICO_DOENCA D
         WHERE D.NR_ATENDIMENTO = P_NR_ATEND
           AND D.DT_DIAGNOSTICO = DT
           AND D.IE_SITUACAO = 'A'
           AND D.IE_TIPO_DIAGNOSTICO IN (2, 3);
        --
        IF (NR IS NOT NULL AND NR::text <> '') THEN
          --
          IF coalesce(P_TYPE, 'D') = 'D' THEN
            --
            SELECT MAX(D.CD_DOENCA)
              INTO STRICT RET
              FROM DIAGNOSTICO_DOENCA D
             WHERE D.NR_SEQ_INTERNO = NR;
            --
          ELSE
            --
            SELECT MAX(D.NR_CIRURGIA)
              INTO STRICT NR
              FROM DIAGNOSTICO_DOENCA D
             WHERE D.NR_SEQ_INTERNO = NR;
            --
            IF (NR IS NOT NULL AND NR::text <> '') THEN
              --
              IF coalesce(P_TYPE, 'D') = 'E' THEN
                --
                SELECT CASE WHEN MAX(C.IE_CARATER_CIRURGIA)='E' THEN  'Y'  ELSE 'N' END
                  INTO STRICT RET
                  FROM CIRURGIA C
                 WHERE C.NR_CIRURGIA = NR;
                --
              ELSE
                --
                RET := 'Y';
                --
              END IF;
              --
            END IF;
            --
          END IF;
          --
        END IF;
        --
      END IF;
      --
    END IF;
    --
    RETURN RET;

  END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pkg_atend_pac_unid.get_dignosis_admit_data (P_NR_ATEND bigint, P_DT_ENTRY timestamp, P_TYPE text DEFAULT 'D') FROM PUBLIC;
