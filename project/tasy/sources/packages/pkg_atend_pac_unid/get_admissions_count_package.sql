-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

  --
CREATE OR REPLACE FUNCTION pkg_atend_pac_unid.get_admissions_count (P_START_DATE timestamp, P_END_DATE timestamp, P_CD_ESTAB bigint DEFAULT 0, P_CD_SETOR bigint DEFAULT 0) RETURNS bigint AS $body$
DECLARE


  NR bigint;

  
BEGIN

    IF (P_START_DATE IS NOT NULL AND P_START_DATE::text <> '') AND 
       (P_END_DATE IS NOT NULL AND P_END_DATE::text <> '') AND 
       P_START_DATE <= P_END_DATE THEN

      BEGIN
      
        SELECT COUNT(1)
          INTO STRICT NR
          FROM (SELECT U.NR_ATENDIMENTO,
                       MIN(U.DT_ENTRADA_UNIDADE),
                       S.CD_ESTABELECIMENTO,
                       U.CD_SETOR_ATENDIMENTO,
                       PKG_ATEND_PAC_UNID.GET_MIN_ENTRY_NEXT_UNIT(U.NR_ATENDIMENTO,
                                                                  U.DT_ENTRADA_UNIDADE,
                                                                  U.CD_SETOR_ATENDIMENTO)
                  FROM ATEND_PACIENTE_UNIDADE U, SETOR_ATENDIMENTO S
                 WHERE S.CD_SETOR_ATENDIMENTO = U.CD_SETOR_ATENDIMENTO
                   AND CASE WHEN coalesce(P_CD_ESTAB, 0)=0 THEN  0  ELSE S.CD_ESTABELECIMENTO END  = coalesce(P_CD_ESTAB, 0)
                   AND CASE WHEN coalesce(P_CD_SETOR, 0)=0 THEN  0  ELSE U.CD_SETOR_ATENDIMENTO END  = coalesce(P_CD_SETOR, 0)
                   AND U.IE_PASSAGEM_SETOR NOT IN ('S', 'L')
                   AND S.CD_CLASSIF_SETOR NOT IN ('6', '7', '10')
                   AND U.DT_ENTRADA_UNIDADE BETWEEN
                       PKG_ATEND_PAC_UNID.GET_SYS_DT(CASE WHEN coalesce(P_CD_ESTAB, 0)=0 THEN  S.CD_ESTABELECIMENTO  ELSE P_CD_ESTAB END , P_START_DATE) AND
                       PKG_ATEND_PAC_UNID.GET_SYS_DT(CASE WHEN coalesce(P_CD_ESTAB, 0)=0 THEN  S.CD_ESTABELECIMENTO  ELSE P_CD_ESTAB END , LEAST(FIM_DIA(P_END_DATE), clock_timestamp()))
                 GROUP BY U.NR_ATENDIMENTO,
                          S.CD_ESTABELECIMENTO,
                          U.CD_SETOR_ATENDIMENTO,
                          PKG_ATEND_PAC_UNID.GET_MIN_ENTRY_NEXT_UNIT(U.NR_ATENDIMENTO,
                                                                     U.DT_ENTRADA_UNIDADE,
                                                                     U.CD_SETOR_ATENDIMENTO)) alias19;

      EXCEPTION WHEN OTHERS THEN
        NR := 0;
       END;

    END IF;

    RETURN coalesce(NR, 0);
  
  END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pkg_atend_pac_unid.get_admissions_count (P_START_DATE timestamp, P_END_DATE timestamp, P_CD_ESTAB bigint DEFAULT 0, P_CD_SETOR bigint DEFAULT 0) FROM PUBLIC;
