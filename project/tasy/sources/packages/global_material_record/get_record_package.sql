-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

    
    /*
    * Get all relevant information of the price table
    */
CREATE OR REPLACE FUNCTION global_material_record.get_record (cd_material_glo_p material_global.cd_material_glo%TYPE) RETURNS GLOBAL_MATERIAL_R AS $body$
DECLARE

        nr_seq_tabela_preco_p tabela_preco_material.cd_tab_preco_mat%TYPE;
        table_price_r   global_material_r;

BEGIN
    
        SELECT MAX(cd_tab_preco_mat) 
        INTO STRICT nr_seq_tabela_preco_p
        FROM w_mat_glob_pri_tab_fil 
        WHERE nm_usuario = wheb_usuario_pck.get_nm_usuario 
        AND  cd_estabelecimento   = wheb_usuario_pck.get_cd_estabelecimento;

        IF (nr_seq_tabela_preco_p IS NOT NULL AND nr_seq_tabela_preco_p::text <> '') THEN 
            SELECT 
                dt_inicio_vigencia, dt_final_vigencia, vl_preco
            INTO STRICT table_price_r
            FROM (
                SELECT  
                    dt_inicio_vigencia, 
                    dt_final_vigencia, 
                    vl_preco
                FROM    preco_material_global P
                INNER JOIN tabela_preco_material T ON
                    P.cd_tab_preco_mat = T.cd_tab_preco_mat AND
                    P.cd_estabelecimento = T.cd_estabelecimento
                WHERE   P.cd_material_glo = cd_material_glo_p
                AND     T.cd_tab_preco_mat = nr_seq_tabela_preco_p
                AND     P.cd_estabelecimento = 1
                AND     T.ie_tabela_global = 'S'
                AND     P.ie_situacao = 'A'
                AND     T.ie_situacao = 'A'
                AND     clock_timestamp() BETWEEN P.dt_inicio_vigencia AND coalesce(P.dt_final_vigencia,clock_timestamp())
                ORDER BY P.dt_inicio_vigencia DESC 
            ) alias4 LIMIT 1;
        END IF;
        RETURN table_price_r;
     EXCEPTION
        when no_data_found then
            RETURN table_price_r;
        WHEN too_many_rows THEN
            RETURN table_price_r;
    END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION global_material_record.get_record (cd_material_glo_p material_global.cd_material_glo%TYPE) FROM PUBLIC;
