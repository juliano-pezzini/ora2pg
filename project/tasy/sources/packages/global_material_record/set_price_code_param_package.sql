-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE global_material_record.set_price_code_param (cd_tab_preco_mat_p tabela_preco_material.cd_tab_preco_mat%TYPE) AS $body$
DECLARE


        nm_usuario_w          usuario.nm_usuario%TYPE;
        cd_estabelecimento_w  estabelecimento.cd_estabelecimento%TYPE;
        nr_sequencia_w        w_mat_glob_pri_tab_fil.nr_sequencia%TYPE;
        cd_tab_preco_mat_w    tabela_preco_material.cd_tab_preco_mat%TYPE;

    
BEGIN
        nm_usuario_w := wheb_usuario_pck.get_nm_usuario;
        cd_estabelecimento_w := wheb_usuario_pck.get_cd_estabelecimento;

        SELECT MAX(cd_tab_preco_mat) 
        INTO STRICT cd_tab_preco_mat_w
        FROM tabela_preco_material
        WHERE cd_tab_preco_mat = cd_tab_preco_mat_p
        AND   cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento;

        IF ( coalesce(cd_tab_preco_mat_w::text, '') = '' ) THEN
        
            DELETE FROM w_mat_glob_pri_tab_fil
            WHERE ( nm_usuario = nm_usuario_w
            AND cd_estabelecimento = cd_estabelecimento_w )
            OR TRUNC(dt_filter) < TRUNC(clock_timestamp());

        ELSE
            SELECT MAX(nr_sequencia)
            INTO STRICT nr_sequencia_w
            FROM w_mat_glob_pri_tab_fil
            WHERE nm_usuario = nm_usuario_w
            AND cd_estabelecimento = cd_estabelecimento_w;

            IF (nr_sequencia_w IS NOT NULL AND nr_sequencia_w::text <> '') THEN
                UPDATE w_mat_glob_pri_tab_fil
                SET cd_tab_preco_mat = cd_tab_preco_mat_p,
                    dt_atualizacao = clock_timestamp(),
                    dt_filter = clock_timestamp()
                WHERE nr_sequencia = nr_sequencia_w;

            ELSE
                SELECT nextval('w_mat_glob_pri_tab_fil_seq')
                INTO STRICT nr_sequencia_w
;

                INSERT INTO w_mat_glob_pri_tab_fil(
                    nr_sequencia,
                    nm_usuario,
                    cd_estabelecimento,
                    cd_tab_preco_mat,
                    dt_atualizacao,
                    dt_filter,
                    dt_atualizacao_nrec
                ) VALUES (
                    nr_sequencia_w,
                    nm_usuario_w,
                    cd_estabelecimento_w,
                    cd_tab_preco_mat_p,
                    clock_timestamp(),
                    clock_timestamp(),
                    clock_timestamp()
                );

            END IF;
        END IF;

    END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE global_material_record.set_price_code_param (cd_tab_preco_mat_p tabela_preco_material.cd_tab_preco_mat%TYPE) FROM PUBLIC;
