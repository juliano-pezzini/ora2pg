-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE grava_dados_api_cnes_pck.finalizar_consulta ( nr_seq_estabelecimento_p cnes_api_estabelecimento.nr_sequencia%type, nm_usuario_p cnes_api_estabelecimento.nm_usuario%type) AS $body$
DECLARE

ie_origem_consulta_w		cnes_api_estabelecimento.ie_origem_consulta%type;
cd_cnes_w			cnes_api_estabelecimento.cd_cnes%type;
nr_seq_credenciamento_w		pls_creden_prestador.nr_sequencia%type;
qt_log_erro_w			integer;

BEGIN
select	count(1)
into STRICT	qt_log_erro_w
from	cnes_api_log
where	nr_seq_estabelecimento	= nr_seq_estabelecimento_p;

if (qt_log_erro_w > 0) then
	update	cnes_api_estabelecimento
	set	ie_status	= 4,
		dt_atualizacao	= clock_timestamp(),
		nm_usuario	= nm_usuario_p
	where	nr_sequencia	= nr_seq_estabelecimento_p;
else
	select	ie_origem_consulta,
		cd_cnes
	into STRICT	ie_origem_consulta_w,
		cd_cnes_w
	from	cnes_api_estabelecimento
	where	nr_sequencia	= nr_seq_estabelecimento_p;
	
	update	cnes_api_estabelecimento
	set	ie_status	= 3,
		dt_atualizacao	= clock_timestamp(),
		nm_usuario	= nm_usuario_p
	where	nr_sequencia	= nr_seq_estabelecimento_p;
	
	if (ie_origem_consulta_w = 1) then --Credenciamento prestador
		select	max(nr_sequencia)
		into STRICT	nr_seq_credenciamento_w
		from	pls_creden_prestador
		where	cd_cnes		= cd_cnes_w
		and	ie_status	= 7;
		
		CALL pls_creden_prestador_pck.atualizar_dados_cnes(	nr_seq_credenciamento_p	=> nr_seq_credenciamento_w,
								nr_seq_cnes_api_estab_p	=> nr_seq_estabelecimento_p,
								nm_usuario_p		=> nm_usuario_p);
	end if;
end if;

commit;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE grava_dados_api_cnes_pck.finalizar_consulta ( nr_seq_estabelecimento_p cnes_api_estabelecimento.nr_sequencia%type, nm_usuario_p cnes_api_estabelecimento.nm_usuario%type) FROM PUBLIC;
