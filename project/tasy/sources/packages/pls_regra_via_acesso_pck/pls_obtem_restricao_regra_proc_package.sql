-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


/*------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------*/

CREATE OR REPLACE FUNCTION pls_regra_via_acesso_pck.pls_obtem_restricao_regra_proc ( ie_opcao_p text, dt_inicio_vigencia_p pls_tipo_via_acesso.dt_inicio_vigencia%type, dt_fim_vigencia_p pls_tipo_via_acesso.dt_fim_vigencia%type, cd_guia_referencia_p pls_conta.cd_guia_referencia%type, ie_considerar_horario_p pls_proc_via_acesso.ie_considerar_horario%type, ie_tipo_qt_horario_p pls_proc_via_acesso.ie_tipo_qt_horario%type, qt_horario_p pls_proc_via_acesso.qt_horario%type, cursor_p integer) RETURNS varchar AS $body$
DECLARE

/* ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade: Esta function e responsavel por obter as restricoes e binds para aplicacao das regras de via de acesso dos procedimentos.
+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
 

/* IE_OPCAO_P
	* RESTRICAO
	* BIND 
*/
ds_restricao_w	varchar(4000);
qt_minuto_w	integer;


BEGIN

-- DT_INICIO_VIGENCIA 
if (dt_inicio_vigencia_p IS NOT NULL AND dt_inicio_vigencia_p::text <> '') then
	if (ie_opcao_p = 'RESTRICAO') then		
		ds_restricao_w := ds_restricao_w || ' and b.dt_procedimento_trunc >= :dt_inicio_vigencia		' || pls_util_pck.enter_w;
	else
		dbms_sql.bind_variable(cursor_p, ':dt_inicio_vigencia', dt_inicio_vigencia_p);
	end if;
end if;

-- DT_FIM_VIGENCIA 
if (dt_fim_vigencia_p IS NOT NULL AND dt_fim_vigencia_p::text <> '') then
	if (ie_opcao_p = 'RESTRICAO') then		
		ds_restricao_w := ds_restricao_w || ' and b.dt_procedimento_trunc <= :dt_fim_vigencia			' || pls_util_pck.enter_w;
	else
		dbms_sql.bind_variable(cursor_p, ':dt_fim_vigencia', dt_fim_vigencia_p);
	end if;
end if;

-- CD_GUIA_REFERENCIA
if (cd_guia_referencia_p IS NOT NULL AND cd_guia_referencia_p::text <> '') then
	if (ie_opcao_p = 'RESTRICAO') then		
		ds_restricao_w := ds_restricao_w || ' and b.cd_guia_referencia = :cd_guia_referencia 			' || pls_util_pck.enter_w;
	else
		dbms_sql.bind_variable(cursor_p, ':cd_guia_referencia', cd_guia_referencia_p);
	end if;
else
	if (ie_opcao_p = 'RESTRICAO') then		
		ds_restricao_w := ds_restricao_w || ' and b.cd_guia_referencia is null 					' || pls_util_pck.enter_w ||
						    ' and b.cd_guia is null						' || pls_util_pck.enter_w;
	end if;
end if;

-- IE_CONSIDERAR_HORARIO
if (ie_considerar_horario_p = 'S') then
	if (ie_opcao_p = 'RESTRICAO') then
		ds_restricao_w := ds_restricao_w || ' and (a.hr_inicio_proc = b.hr_inicio_proc)				' || pls_util_pck.enter_w;
	end if;
else
	if (ie_opcao_p = 'RESTRICAO') then
		ds_restricao_w := ds_restricao_w || ' and pls_obter_minutos_intervalo(a.hr_inicio_proc, b.hr_inicio_proc, :qt_minuto) = ''S'' ' || pls_util_pck.enter_w;
	else
		if (ie_tipo_qt_horario_p = 'H') then
			qt_minuto_w := coalesce(qt_horario_p,0) * 60;
		elsif (ie_tipo_qt_horario_p = 'M') then
			qt_minuto_w := coalesce(qt_horario_p,0);
		end if;	
	
		dbms_sql.bind_variable(cursor_p, ':qt_minuto', qt_minuto_w);	
	end if;
end if;
	
return	ds_restricao_w;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pls_regra_via_acesso_pck.pls_obtem_restricao_regra_proc ( ie_opcao_p text, dt_inicio_vigencia_p pls_tipo_via_acesso.dt_inicio_vigencia%type, dt_fim_vigencia_p pls_tipo_via_acesso.dt_fim_vigencia%type, cd_guia_referencia_p pls_conta.cd_guia_referencia%type, ie_considerar_horario_p pls_proc_via_acesso.ie_considerar_horario%type, ie_tipo_qt_horario_p pls_proc_via_acesso.ie_tipo_qt_horario%type, qt_horario_p pls_proc_via_acesso.qt_horario%type, cursor_p integer) FROM PUBLIC;
