-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION wheb_assist_pck.obterparametrofuncao ( cd_funcao_p bigint, nr_parametro_p bigint, cd_perfil_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, vl_padrao_p text) RETURNS varchar AS $body$
DECLARE

		vl_parametro_w	varchar(255);
		id_funcao_w		integer;
	
BEGIN
		if	((current_setting('wheb_assist_pck.cd_estab_ant_w')::estabelecimento.cd_estabelecimento%type <> cd_estabelecimento_p) or (current_setting('wheb_assist_pck.cd_perfil_ant_w')::perfil.cd_perfil%type <> cd_perfil_p) or (current_setting('wheb_assist_pck.nm_usuario_ant_w')::usuario.nm_usuario%type <> nm_usuario_p)) then
			begin
			PERFORM set_config('wheb_assist_pck.cd_estab_ant_w', cd_estabelecimento_p, false);
			PERFORM set_config('wheb_assist_pck.cd_perfil_ant_w', cd_perfil_p, false);
			PERFORM set_config('wheb_assist_pck.nm_usuario_ant_w', nm_usuario_p, false);
			
			CALL wheb_assist_pck.limparparametrosfuncao();
			end;
		end if;
		
		if (cd_funcao_p = 924) then
			id_funcao_w := 1;
		elsif (cd_funcao_p = 1113) then
			id_funcao_w := 2;
		elsif (cd_funcao_p = 8030) then
			id_funcao_w := 3;
		end if;
		
		if (current_setting('wheb_assist_pck.parametros_funcao_w')::parametros_funcao[id_funcao_w].parametro(nr_parametro_p).vl_parametro = 'XPTO') then
			obter_param_usuario(cd_funcao_p, nr_parametro_p, current_setting('wheb_assist_pck.cd_perfil_ant_w')::perfil.cd_perfil%type, current_setting('wheb_assist_pck.nm_usuario_ant_w')::usuario.nm_usuario%type, current_setting('wheb_assist_pck.cd_estab_ant_w')::estabelecimento.cd_estabelecimento%type, vl_parametro_w);
			current_setting('wheb_assist_pck.parametros_funcao_w')::parametros_funcao[id_funcao_w].parametro(nr_parametro_p).vl_parametro	:= coalesce(vl_parametro_w, vl_padrao_p);
		end if;
		
		return current_setting('wheb_assist_pck.parametros_funcao_w')::parametros_funcao[id_funcao_w].parametro(nr_parametro_p).vl_parametro;
		
	exception when others then
		PERFORM set_config('wheb_assist_pck.cd_perfil_w', coalesce(current_setting('wheb_assist_pck.cd_perfil_w')::bigint, obter_perfil_ativo), false);
		PERFORM set_config('wheb_assist_pck.cd_estabelecimento_w', coalesce(current_setting('wheb_assist_pck.cd_estabelecimento_w')::bigint, coalesce(wheb_usuario_pck.get_cd_estabelecimento,1)), false);
		PERFORM set_config('wheb_assist_pck.nm_usuario_w', coalesce(current_setting('wheb_assist_pck.nm_usuario_w')::varchar(50), wheb_usuario_pck.get_nm_usuario), false);
		
		CALL wheb_assist_pck.limparparametrosfuncao();
		
		obter_param_usuario(cd_funcao_p, nr_parametro_p, current_setting('wheb_assist_pck.cd_perfil_w')::bigint, current_setting('wheb_assist_pck.nm_usuario_w')::varchar(50), current_setting('wheb_assist_pck.cd_estabelecimento_w')::bigint, vl_parametro_w);
		
		return vl_parametro_w;
	end;
	
	--- Inicializacao/Limpeza dos parametros da funcao


$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION wheb_assist_pck.obterparametrofuncao ( cd_funcao_p bigint, nr_parametro_p bigint, cd_perfil_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, vl_padrao_p text) FROM PUBLIC;
