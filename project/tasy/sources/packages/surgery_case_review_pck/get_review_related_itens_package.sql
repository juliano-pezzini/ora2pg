-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION surgery_case_review_pck.get_review_related_itens (nr_sequencia_p bigint ) RETURNS varchar AS $body$
DECLARE

								
reviewDet CURSOR(reviewData case_record_tp ) FOR 
SELECT ds_informacao ||' - '|| vl_informacao as detail
  from revisao_cirurgia
 where ie_tabela_referencia = reviewData.ie_tabela_referencia_w
   and ie_campo_referencia = reviewData.ie_campo_referencia_w
   and nr_seq_origem = reviewData.nr_seq_origem_w
   and nr_cirurgia = reviewData.nr_cirurgia_w
   and nr_sequencia <> nr_sequencia_p;

review_w case_record_tp;
r1 reviewDet%rowtype;
ds_return varchar(4000) := null;
ie_all_records_w varchar(1);


BEGIN								
	
	select ie_tabela_referencia,ie_campo_referencia,nr_seq_origem, nr_cirurgia, ds_justificativa, ie_campo_ref_valor, ie_protocolo, nr_protocolo_pepo
	  into STRICT review_w
	  from revisao_cirurgia
	 where nr_sequencia = nr_sequencia_p;
	
	if (review_w.ie_tabela_referencia_w = 'ATENDIMENTO_MONIT_RESP' or review_w.ie_tabela_referencia_w = 'ATEND_MONIT_HEMOD') then
		ie_all_records_w :=  surgery_case_review_pck.check_vital_signs_associate(review_w.nr_seq_origem_w, review_w.ie_tabela_referencia_w, review_w.ie_campo_ref_valor_w );
		
		if (ie_all_records_w = 'N') then
			
			select wheb_mensagem_pck.get_texto(1128831) into STRICT ds_return;
			
			open reviewDet(review_w);

			loop
				fetch reviewDet into r1;
				EXIT WHEN NOT FOUND; /* apply on reviewdet */
		
		  if (reviewDet%rowcount = 1) then
			ds_return := ds_return ||' '|| r1.detail;
		  else
			ds_return := ds_return ||' | '|| r1.detail;
		  end if;
				
		end loop;
		close reviewDet;
		
		end if;
	end if;
	return ds_return;
	
	
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION surgery_case_review_pck.get_review_related_itens (nr_sequencia_p bigint ) FROM PUBLIC;
