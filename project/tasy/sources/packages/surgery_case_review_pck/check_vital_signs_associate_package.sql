-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION surgery_case_review_pck.check_vital_signs_associate (nr_sequencia_p bigint, nm_tabela_p text, nm_atributo_p text ) RETURNS varchar AS $body$
DECLARE

								
c1 CURSOR FOR 
SELECT tva.nm_atributo, ta.ie_tipo_atributo
  from tabela_visao_atributo tva
  inner join tabela_visao tv on tv.nr_sequencia = tva.nr_sequencia
  inner join tabela_atributo ta on ta.nm_tabela = tv.nm_tabela and ta.nm_atributo = tva.nm_atributo
 where tv.nm_tabela = nm_tabela_p
   and tv.nr_sequencia in (97295, 33258, 68825)
   and (tva.nr_seq_apresent IS NOT NULL AND tva.nr_seq_apresent::text <> '')
   and ta.ie_tipo_atributo <> 'FUNCTION'
   and tva.nm_atributo not in ('NR_ATENDIMENTO','DT_SINAL_VITAL','CD_PESSOA_FISICA','NR_CIRURGIA','DT_REFERENCIA','DT_LIBERACAO', 
							   'IE_RPA','NM_USUARIO','IE_PA_MEDIA_AP_INFORMADA', 'IE_PAM_INFORMADA', nm_atributo_p);	

count_w bigint;
sql_w varchar(1000);
return_q varchar(1) := 'S';

BEGIN
	
	for r1 in c1 loop
		if (upper(r1.ie_tipo_atributo) = 'NUMBER') then
			sql_w := 'select count(1) from '|| nm_tabela_p || ' where (' || r1.nm_atributo || ' is not null and to_char('|| r1.nm_atributo || ') <>'''||'0'||''') and nr_sequencia = '|| nr_sequencia_p;
		elsif (upper(r1.ie_tipo_atributo) = 'VARCHAR2') then
		  sql_w := 'select count(1) from '|| nm_tabela_p || ' where ' || r1.nm_atributo || ' is not null and nr_sequencia = '|| nr_sequencia_p;
		else
		  sql_w :='select 0 from dual';
		end if;
		
		EXECUTE sql_w into STRICT count_w;
		if (count_w > 0) then
			return_q := 'N';
		    GOTO endLoop;
		end if;
	end loop;
  <<endLoop>>
	
return return_q;
								
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION surgery_case_review_pck.check_vital_signs_associate (nr_sequencia_p bigint, nm_tabela_p text, nm_atributo_p text ) FROM PUBLIC;
