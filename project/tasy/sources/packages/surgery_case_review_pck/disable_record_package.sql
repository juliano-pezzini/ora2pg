-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE surgery_case_review_pck.disable_record (nr_sequencia_p bigint, nm_usuario_p text, ie_all_records_p text ) AS $body$
DECLARE


review_w case_record_tp;
nr_seq_new bigint;
ie_all_records_w varchar(1):= ie_all_records_p;

  r2 RECORD;

BEGIN
	
	select ie_tabela_referencia,ie_campo_referencia,nr_seq_origem, nr_cirurgia, ds_justificativa, ie_campo_ref_valor, ie_protocolo, nr_protocolo_pepo
	  into STRICT review_w
	  from revisao_cirurgia
	 where nr_sequencia = nr_sequencia_p;
	
	if (ie_all_records_w = 'N' and review_w.ie_tabela_referencia_w in ('ATENDIMENTO_SINAL_VITAL')) then
		ie_all_records_w :=  surgery_case_review_pck.check_vital_signs_associate(review_w.nr_seq_origem_w, review_w.ie_tabela_referencia_w, review_w.ie_campo_ref_valor_w );
	end if;
	
	if ( review_w.ie_tabela_referencia_w = 'EVENTO_CIRURGIA_PACIENTE' and review_w.ie_protocolo_w = 'S') then
		
		for r2 in (SELECT * from revisao_cirurgia where nr_seq_evento = review_w.nr_seq_origem_w) loop
			update revisao_cirurgia
		   set ie_situacao = 'I',
			   dt_inativacao = clock_timestamp(),
			   nm_usuario_inativacao = nm_usuario_p,
			   ds_justificativa = review_w.ds_justificativa_w
		 where ie_tabela_referencia = r2.ie_tabela_referencia
		   and ie_campo_referencia = r2.ie_campo_referencia
		   and nr_seq_origem = r2.nr_seq_origem
		   and nr_cirurgia = r2.nr_cirurgia;
		
		CALL inativar_informacao(r2.ie_tabela_referencia,r2.ie_campo_referencia,r2.nr_seq_origem,r2.ds_justificativa,nm_usuario_p);
			
		end loop;
		
	end if;
		
		
	if (ie_all_records_w = 'S') then
		update revisao_cirurgia
		   set ie_situacao = 'I',
			   dt_inativacao = clock_timestamp(),
			   nm_usuario_inativacao = nm_usuario_p,
			   ds_justificativa = review_w.ds_justificativa_w
		 where ie_tabela_referencia = review_w.ie_tabela_referencia_w
		   and ie_campo_referencia = review_w.ie_campo_referencia_w
		   and nr_seq_origem = review_w.nr_seq_origem_w
		   and nr_cirurgia = review_w.nr_cirurgia_w;
		
		CALL inativar_informacao(review_w.ie_tabela_referencia_w,review_w.ie_campo_referencia_w,review_w.nr_seq_origem_w,review_w.ds_justificativa_w,nm_usuario_p);
	
	elsif (review_w.ie_tabela_referencia_w in ('ATENDIMENTO_SINAL_VITAL')) then
	nr_seq_new  := surgery_case_review_pck.duplicate_record_review( review_w.ie_tabela_referencia_w, review_w.ie_campo_referencia_w, review_w.nr_seq_origem_w, review_w.ie_campo_ref_valor_w, review_w.ds_justificativa_w, nm_usuario_p, nr_seq_new );
	update revisao_cirurgia
	   set nr_seq_origem = nr_seq_new
	 where nr_seq_origem = review_w.nr_seq_origem_w
	   and ie_situacao <> 'I';
	
	end if;
	
		update revisao_cirurgia
	   set ie_status = 'I',
		   dt_atualizacao = clock_timestamp(),
		   nm_usuario = nm_usuario_p
	 where nr_cirurgia = review_w.nr_cirurgia_w
	   and ie_situacao = 'I'
	   and ie_status <> 'I';
	
commit;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE surgery_case_review_pck.disable_record (nr_sequencia_p bigint, nm_usuario_p text, ie_all_records_p text ) FROM PUBLIC;
