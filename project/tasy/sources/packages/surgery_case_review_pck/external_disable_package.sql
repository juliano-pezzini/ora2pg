-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE surgery_case_review_pck.external_disable (nr_cirurgia_p bigint, nm_usuario_p text) AS $body$
DECLARE

							
review CURSOR FOR 
SELECT distinct ie_tabela_referencia,ie_campo_referencia,nr_seq_origem, nr_cirurgia, ds_justificativa, ie_campo_ref_valor, ie_protocolo
  from revisao_cirurgia
 where nr_cirurgia = nr_cirurgia_p
   and ie_situacao = 'A';

count_w bigint;
review_w case_record_tp;
r1 review%rowtype;
sql_w varchar(1000);
nr_seq_review_w bigint;


BEGIN

	open review;

		loop
			fetch review into r1;
			EXIT WHEN NOT FOUND; /* apply on review */
			
			if (r1.ie_tabela_referencia = 'CIRURGIA_AGENTE_ANEST_OCOR' ) then
				
					select count(1)
					  into STRICT count_w
					  from cirurgia_agente_anestesico ag
				inner join cirurgia_agente_anest_ocor ao on ao.nr_seq_cirur_agente = ag.nr_sequencia
					 where ag.nr_cirurgia = nr_cirurgia_p
					   and ao.nr_sequencia = r1.nr_seq_origem
					   and (ao.ie_situacao = 'I' or ag.ie_situacao = 'I');
				
			else
			
			sql_w := 'select count(1) from '|| r1.ie_tabela_referencia || ' where dt_inativacao is not null and nr_cirurgia = '|| nr_cirurgia_p || ' and nr_sequencia = '|| r1.nr_seq_origem;
			
				begin
					EXECUTE sql_w into STRICT count_w;
					exception when others then
					count_w := 0;
				end;
			end if;
		
		if (count_w > 0) then
			update revisao_cirurgia
			   set ie_situacao = 'I',
				   ie_status = 'I',
				   dt_inativacao = clock_timestamp(),
				   ds_justificativa = wheb_mensagem_pck.get_texto(1130570) 
			where ie_tabela_referencia = r1.ie_tabela_referencia
		      and nr_seq_origem = r1.nr_seq_origem;		

		end if;
			
		end loop;
    close review;

	commit;							
END;	

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE surgery_case_review_pck.external_disable (nr_cirurgia_p bigint, nm_usuario_p text) FROM PUBLIC;
