-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


	-->>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>> INSERE CONTROLE DE SALDO DO CONTRATO <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<--	
	/*
	Objetivo: Gerar o gerenciamento de saldo para o contrato e inserir na tabela contrato_gerenciamento.
	Parametros: nr_seq_contrato_p 	 = Numero de sequencia do contrato.
			    nm_usuario_p 		 = Nome do usuario.
				ie_tipo_insert_p     = Quando 'J': indica que o gerenciamento foi disparado pelo Job. 
				                       Quando 'U': disparado diretamente pelo usuario na funcao Controle de Contratos.
	*/
CREATE OR REPLACE PROCEDURE gerenciamento_contrato_pck.inserir_contrato_gerenciamento (nr_seq_contrato_p bigint, nm_usuario_p text, ie_tipo_insert_p text) AS $body$
DECLARE

		
		nr_sequencia_w 		  	  contrato_gerenciamento.nr_sequencia%type;
		vl_comprometido_w 	  	  contrato_gerenciamento.vl_comprometido%type;
		vl_realizado_w 		  	  contrato_gerenciamento.vl_realizado%type;
		vl_saldo_w 			  	  contrato_gerenciamento.vl_saldo%type;
		vl_total_w 			  	  contrato_gerenciamento.vl_total%type;
		qt_itens_utilizado_w  	  contrato_gerenciamento.qt_itens_utilizado%type;
		qt_itens_restante_w   	  contrato_gerenciamento.qt_itens_restante%type;
		vl_solic_compra_w		  contrato_gerenciamento.vl_solic_compra%type;
		qt_solic_compra_w 	  	  contrato_gerenciamento.qt_solic_compra%type;
		qt_solic_compra_item_w 	  contrato_gerenciamento.qt_solic_compra_item%type;
		vl_ordem_compra_w		  contrato_gerenciamento.vl_ordem_compra%type;
		qt_ordem_compra_w 	  	  contrato_gerenciamento.qt_ordem_compra%type;
		qt_ordem_compra_item_w 	  contrato_gerenciamento.qt_ordem_compra_item%type;
		vl_nota_fiscal_w		  contrato_gerenciamento.vl_nota_fiscal%type;
		qt_nota_fiscal_w		  contrato_gerenciamento.qt_nota_fiscal%type;
		qt_nota_fiscal_item_w	  contrato_gerenciamento.qt_nota_fiscal_item%type;
		vl_titulo_pagar_w		  contrato_gerenciamento.vl_titulo_pagar%type;
		qt_titulo_pagar_w		  contrato_gerenciamento.qt_titulo_pagar%type;
		vl_titulo_receber_w		  contrato_gerenciamento.vl_titulo_receber%type;
		qt_titulo_receber_w		  contrato_gerenciamento.qt_titulo_receber%type;
		
		ie_pagar_receber_w		  contrato.ie_pagar_receber%type;		
		ie_novo_registro_usuario varchar(2);
		
		nr_seq_contrato_w	  contrato.nr_sequencia%type;
		
		
BEGIN
		
		ie_novo_registro_usuario := 'N';
		
	    select coalesce(nr_seq_contrato_atual, nr_sequencia)
		  into STRICT nr_seq_contrato_w
          from contrato
		 where nr_sequencia = nr_seq_contrato_p;
		
		ie_pagar_receber_w := gerenciamento_contrato_pck.obter_tipo_contrato(nr_seq_contrato_w);
		
		vl_comprometido_w 	   := gerenciamento_contrato_pck.obter_valor_comprometido(nr_seq_contrato_w, 'S');
		vl_realizado_w 		   := gerenciamento_contrato_pck.obter_valor_realizado(nr_seq_contrato_w, 'S');
		vl_saldo_w 			   := gerenciamento_contrato_pck.obter_valor_saldo(nr_seq_contrato_w, 'S');
		vl_total_w 			   := gerenciamento_contrato_pck.obter_valor_total(nr_seq_contrato_w, 'S');
		qt_itens_utilizado_w   := gerenciamento_contrato_pck.obter_qt_utilizado(nr_seq_contrato_w, 'S');
		qt_itens_restante_w    := gerenciamento_contrato_pck.obter_qt_restante(nr_seq_contrato_w, 'S');
		vl_solic_compra_w 	   := gerenciamento_contrato_pck.obter_qt_vl_item_solic(nr_seq_contrato_w, 'VL', 'S');
		qt_solic_compra_w 	   := gerenciamento_contrato_pck.obter_qt_solic(nr_seq_contrato_w, 'S');
		qt_solic_compra_item_w := gerenciamento_contrato_pck.obter_qt_vl_item_solic(nr_seq_contrato_w, 'QT', 'S');
		vl_ordem_compra_w	   := gerenciamento_contrato_pck.obter_qt_vl_item_ordens(nr_seq_contrato_w, 'VL', 'S');
		qt_ordem_compra_w 	   := gerenciamento_contrato_pck.obter_qt_ordem(nr_seq_contrato_w, 'S');
		qt_ordem_compra_item_w := gerenciamento_contrato_pck.obter_qt_vl_item_ordens(nr_seq_contrato_w, 'QT', 'S');
		vl_nota_fiscal_w 	   := gerenciamento_contrato_pck.obter_qt_vl_item_notas(nr_seq_contrato_w, 'VL', 'S');
		qt_nota_fiscal_w	   := gerenciamento_contrato_pck.obter_qt_nf(nr_seq_contrato_w, 'S');
		qt_nota_fiscal_item_w  := gerenciamento_contrato_pck.obter_qt_vl_item_notas(nr_seq_contrato_w, 'QT', 'S');
		
		if (ie_pagar_receber_w = 'P') then
			vl_titulo_pagar_w	   := gerenciamento_contrato_pck.obter_qt_vl_titulos_pagar(nr_seq_contrato_w, 'VL' ,'S');
			qt_titulo_pagar_w	   := gerenciamento_contrato_pck.obter_qt_vl_titulos_pagar(nr_seq_contrato_w, 'QT' ,'S');
			vl_titulo_receber_w    := 0;
			qt_titulo_receber_w    := 0;
		else
			vl_titulo_receber_w	   := gerenciamento_contrato_pck.obter_qt_vl_titulos_receber(nr_seq_contrato_w, 'VL' ,'S');
			qt_titulo_receber_w	   := gerenciamento_contrato_pck.obter_qt_vl_titulos_receber(nr_seq_contrato_w, 'QT' ,'S');
			vl_titulo_pagar_w	   := 0;
			qt_titulo_pagar_w	   := 0;
		end if;
				
			if (ie_tipo_insert_p <> 'J') then

				select coalesce(max(nr_sequencia),0)
			      into STRICT nr_sequencia_w
			      from contrato_gerenciamento a
			     where a.nr_seq_contrato = nr_seq_contrato_w
			       and a.dt_atualizacao = (SELECT max(b.dt_atualizacao)
										     from contrato_gerenciamento b
										    where b.nr_seq_contrato = a.nr_seq_contrato);
				
				if (nr_sequencia_w <> 0) then
					begin
						update contrato_gerenciamento set nm_usuario           = nm_usuario_p,
														  dt_atualizacao       = clock_timestamp(),
														  vl_comprometido      = vl_comprometido_w,
														  vl_realizado         = vl_realizado_w,
														  vl_saldo             = vl_saldo_w,
														  vl_total             = vl_total_w,
														  qt_itens_utilizado   = qt_itens_utilizado_w,
														  qt_itens_restante    = qt_itens_restante_w,
														  vl_solic_compra      = vl_solic_compra_w,
														  qt_solic_compra      = qt_solic_compra_w,
														  qt_solic_compra_item = qt_solic_compra_item_w,
														  vl_ordem_compra      = vl_ordem_compra_w,
														  qt_ordem_compra      = qt_ordem_compra_w,
														  qt_ordem_compra_item = qt_ordem_compra_item_w,
														  vl_nota_fiscal	   = vl_nota_fiscal_w,
														  qt_nota_fiscal       = qt_nota_fiscal_w, 
														  qt_nota_fiscal_item  = qt_nota_fiscal_item_w,
														  vl_titulo_pagar      = vl_titulo_pagar_w,
														  qt_titulo_pagar      = qt_titulo_pagar_w,
														  vl_titulo_receber    = vl_titulo_receber_w,
														  qt_titulo_receber    = qt_titulo_receber_w
						where nr_sequencia = nr_sequencia_w;
					end;
				else
					ie_novo_registro_usuario := 'S';
				end if;	
			end if;
			
			if (ie_tipo_insert_p = 'J' or ie_novo_registro_usuario = 'S') then
			
				select nextval('contrato_gerenciamento_seq')
				  into STRICT nr_sequencia_w
				;
			
				begin
					insert into contrato_gerenciamento(nr_sequencia,
														nr_seq_contrato,
														nm_usuario,
														nm_usuario_nrec,
														dt_atualizacao,
														dt_atualizacao_nrec,
														vl_comprometido,
														vl_realizado,
														vl_saldo,
														vl_total,
														qt_itens_utilizado,
														qt_itens_restante,
														vl_solic_compra,
														qt_solic_compra,
														qt_solic_compra_item,
														vl_ordem_compra,
														qt_ordem_compra,
														qt_ordem_compra_item,
														vl_nota_fiscal,
														qt_nota_fiscal,
														qt_nota_fiscal_item,
														vl_titulo_pagar,
														qt_titulo_pagar,
														vl_titulo_receber,
														qt_titulo_receber,
														ie_tipo_insert)
														 values (nr_sequencia_w,
														nr_seq_contrato_w,
														nm_usuario_p,
														nm_usuario_p,
														clock_timestamp(),
														clock_timestamp(),
														vl_comprometido_w,
														vl_realizado_w,
														vl_saldo_w,
														vl_total_w,
														qt_itens_utilizado_w,
														qt_itens_restante_w,
														vl_solic_compra_w,
														qt_solic_compra_w,
														qt_solic_compra_item_w,
														vl_ordem_compra_w,
														qt_ordem_compra_w,
														qt_ordem_compra_item_w,
														vl_nota_fiscal_w,
														qt_nota_fiscal_w,
														qt_nota_fiscal_item_w,
														vl_titulo_pagar_w,
														qt_titulo_pagar_w,
														vl_titulo_receber_w,
														qt_titulo_receber_w,
														ie_tipo_insert_p);
					commit;
				end;
				
							
			end if;
			
			if (ie_tipo_insert_p = 'J') then			
				CALL gerenciamento_contrato_pck.gravar_hist_ger_contrato(nr_seq_contrato_w, nr_sequencia_w, nm_usuario_p,
					Wheb_mensagem_pck.get_Texto(1080780, 'QT_TOTAL_P='||coalesce(vl_total_w,0)||
														 ';VL_COMPROMETIDO_P='||coalesce(vl_comprometido_w,0)||
														 ';VL_REALIZADO_P='||coalesce(vl_realizado_w,0)||
														 ';VL_SALDO_P='||coalesce(vl_saldo_w,0)||
														 ';QT_UTILIZADA_P='||coalesce(qt_itens_utilizado_w,0)||
														 ';QT_SALDO_P='||coalesce(qt_itens_restante_w,0)||';'));
			else
				CALL gerenciamento_contrato_pck.gravar_hist_ger_contrato(nr_seq_contrato_w, nr_sequencia_w, nm_usuario_p, 
					Wheb_mensagem_pck.get_Texto(1080781,'QT_TOTAL_P='||coalesce(vl_total_w,0)||
														 ';VL_COMPROMETIDO_P='||coalesce(vl_comprometido_w,0)||
														 ';VL_REALIZADO_P='||coalesce(vl_realizado_w,0)||
														 ';VL_SALDO_P='||coalesce(vl_saldo_w,0)||
														 ';QT_UTILIZADA_P='||coalesce(qt_itens_utilizado_w,0)||
														 ';QT_SALDO_P='||coalesce(qt_itens_restante_w,0)||';'));
			end if;
													
	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerenciamento_contrato_pck.inserir_contrato_gerenciamento (nr_seq_contrato_p bigint, nm_usuario_p text, ie_tipo_insert_p text) FROM PUBLIC;
