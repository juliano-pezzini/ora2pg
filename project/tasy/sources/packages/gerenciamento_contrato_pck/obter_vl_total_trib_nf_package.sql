-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

	
	-->>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>> Obter valor total de tributos vinculado a NF <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<--	
	/*
	Objetivo: Retornar o valor total de tributos da nota fiscal.
	Exemplo:  	+10R$ de tributo, 
				-15R$ de tributo, 
				retorno = -5R$; 
	Parametros: 
	nr_seq_nf_p = Numero de sequencia da nota fiscal
	nr_seq_item_nf_p = Numero do item da nota fiscal(1,2,3,4,5,6,7...)
	*/
CREATE OR REPLACE FUNCTION gerenciamento_contrato_pck.obter_vl_total_trib_nf (nr_seq_nf_p bigint, nr_seq_item_nf_p bigint) RETURNS bigint AS $body$
DECLARE

					
	vl_tributo_d_w	nota_fiscal_item_trib.vl_tributo%type;	
	vl_tributo_s_w	nota_fiscal_item_trib.vl_tributo%type;	
	
	
BEGIN
	
	select coalesce(sum(n.vl_tributo),0)
	  into STRICT vl_tributo_d_w
	  from tributo t,
		   nota_fiscal_item_trib n
	 where t.cd_tributo	   = n.cd_tributo
	   and n.nr_sequencia  = nr_seq_nf_p
	   and n.nr_item_nf    = nr_seq_item_nf_p
	   and ie_soma_diminui = 'D';
	
	select coalesce(sum(n.vl_tributo),0)
	  into STRICT vl_tributo_s_w
	  from tributo t,
		   nota_fiscal_item_trib n
	 where t.cd_tributo	   = n.cd_tributo
	   and n.nr_sequencia  = nr_seq_nf_p
	   and n.nr_item_nf    = nr_seq_item_nf_p
	   and ie_soma_diminui = 'S';
	
	return vl_tributo_s_w - vl_tributo_d_w;
	
	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION gerenciamento_contrato_pck.obter_vl_total_trib_nf (nr_seq_nf_p bigint, nr_seq_item_nf_p bigint) FROM PUBLIC;
