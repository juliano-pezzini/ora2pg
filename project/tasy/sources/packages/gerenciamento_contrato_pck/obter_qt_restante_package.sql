-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

		
	-->>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>> Obter quantidade total de itens restantes do contrato <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<--
	/*
	Objetivo: Retornar a quantidade de itens restantes do contrato passado por parametro.
			  Este se trata da soma do campo "contrato.qt_material_fixa" dos itens do contrato, subtraindo a quantidade ja utilizada.
	Parametros: 
	nr_seq_contrato_p = Numero de sequencia do contrato.
	ie_atual_p        = Quando 'S': Ira verificar a quantidade atual restante de itens do contrato.
					    Quando 'N': Ira retornar o valor de acordo com o ultimo gerenciamento de saldo do contrato existente na tabela "contrato_gerenciamento".
	*/
CREATE OR REPLACE FUNCTION gerenciamento_contrato_pck.obter_qt_restante (nr_seq_contrato_p bigint, ie_atual_p text, nr_seq_regra_contrato_p bigint default null) RETURNS bigint AS $body$
DECLARE

	
	qt_itens_w	    contrato_regra_nf.qt_material_fixa%type;
	qt_restante_w 	contrato_gerenciamento.qt_itens_restante%type;
	
	
BEGIN
	
	qt_itens_w := 0;
	qt_restante_w := 0;
		
	if (ie_atual_p = 'N') then
		begin
			select a.qt_itens_restante
			  into STRICT qt_restante_w
			  from contrato_gerenciamento a
			 where a.nr_seq_contrato = nr_seq_contrato_p
			   and a.dt_atualizacao = (SELECT max(b.dt_atualizacao)
										 from contrato_gerenciamento b
										where b.nr_seq_contrato = a.nr_seq_contrato);
		end;
	else

		select coalesce(sum(qt_material_fixa),0)
		  into STRICT qt_itens_w 
		  from contrato_regra_nf
		 where nr_seq_contrato = nr_seq_contrato_p 
		   and (((nr_seq_regra_contrato_p IS NOT NULL AND nr_seq_regra_contrato_p::text <> '') and nr_seq_regra_contrato_p <> 0 and nr_sequencia = nr_seq_regra_contrato_p) or coalesce(nr_seq_regra_contrato_p::text, '') = '' or nr_seq_regra_contrato_p = 0);
		
		if (qt_itens_w <> 0) then
			qt_restante_w := qt_itens_w - gerenciamento_contrato_pck.obter_qt_utilizado(nr_seq_contrato_p, 'S', nr_seq_regra_contrato_p);
		end if;
		
	end if;
	
	return qt_restante_w;
	
	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION gerenciamento_contrato_pck.obter_qt_restante (nr_seq_contrato_p bigint, ie_atual_p text, nr_seq_regra_contrato_p bigint default null) FROM PUBLIC;
