-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

	
	-->>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>> Obter quantidade total de notas fiscais vinculadas ao contrato <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<--
	/*
	Objetivo: Retornar a quantidade de notas fiscais que possuem itens vinculados ao contrato.
	Parametros: 
	nr_seq_contrato_p = Numero de sequencia do contrato.
	ie_atual_p        = Quando 'S': Ira calcular a quantidade atual de notas vinculadas ao contrato.
					    Quando 'N': Ira retornar o valor de acordo com o ultimo gerenciamento de saldo do contrato existente na tabela "contrato_gerenciamento".
	*/
CREATE OR REPLACE FUNCTION gerenciamento_contrato_pck.obter_qt_nf (nr_seq_contrato_p bigint, ie_atual_p text) RETURNS bigint AS $body$
DECLARE

		
		qt_nota_fiscal_w contrato_gerenciamento.qt_nota_fiscal%type;
		ie_pagar_receber_w contrato.ie_pagar_receber%type;
		
		
BEGIN
		
		qt_nota_fiscal_w := 0;
		
		if (ie_atual_p = 'N') then
			begin
				select a.qt_nota_fiscal
				  into STRICT qt_nota_fiscal_w
				  from contrato_gerenciamento a
				 where a.nr_seq_contrato = nr_seq_contrato_p
				   and a.dt_atualizacao = (SELECT max(b.dt_atualizacao)
											 from contrato_gerenciamento b
											where b.nr_seq_contrato = a.nr_seq_contrato);
			end;
		else
			
			select coalesce(gerenciamento_contrato_pck.obter_tipo_contrato(nr_seq_contrato_p), 'P')
			  into STRICT ie_pagar_receber_w
			;
			
			select count(a.nr_sequencia) qt_nf
			  into STRICT qt_nota_fiscal_w
			  from nota_fiscal a,
			   operacao_nota b
			 where a.ie_situacao = 1
			   and (a.dt_atualizacao_estoque IS NOT NULL AND a.dt_atualizacao_estoque::text <> '')
			   and a.cd_operacao_nf = b.cd_operacao_nf
			   and b.ie_operacao_fiscal = CASE WHEN ie_pagar_receber_w='R' THEN  'S'  ELSE 'E' END
			   and exists (SELECT 	1 
							 from nota_fiscal_item b
							where a.nr_sequencia = b.nr_sequencia
							  and b.qt_item_nf > 0
							  and b.nr_contrato = nr_seq_contrato_p);		
		end if;
		
		return qt_nota_fiscal_w;
	
	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION gerenciamento_contrato_pck.obter_qt_nf (nr_seq_contrato_p bigint, ie_atual_p text) FROM PUBLIC;
