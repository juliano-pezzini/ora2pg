-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

	
	-->>>>>>>>>>>>>>>>>>++++++ VALORES POR FORNECEDOR DO CONTRATO (WCPANEL FORNECEDOR) ++++++<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<--
	
	-->>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>> Valor consumido pelo fornecedor em ordens de compra  <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<--	
	/*
	Objetivo: Retornar o valor consumido pelo fornecedor em ordens de compra vinculadas ao contrato.
	Parametros: 
	nr_seq_contrato_p   = Numero de sequencia do contrato.
	cd_cgc_fornecedor_p = CNPJ do fornecedor.
	*/
CREATE OR REPLACE FUNCTION gerenciamento_contrato_pck.obter_vl_ordens_fornecedor (nr_seq_contrato_p bigint, cd_cgc_fornecedor_p bigint) RETURNS bigint AS $body$
DECLARE

	
	vl_comprometido_w		 contrato_gerenciamento.vl_comprometido%type;	
	vl_total_ordem_w		 ordem_compra_item.vl_unitario_material%type;
	qt_total_item_pend_oc_w	 ordem_compra_item_entrega.qt_prevista_entrega%type;	
	vl_total_nota_w			 nota_fiscal_item.vl_liquido%type;
	cd_moeda_contrato_w		 moeda.cd_moeda%type;
	
	c01 CURSOR(nr_seq_contrato_c bigint, cd_cgc_fornecedor_c bigint) FOR
			SELECT  a.nr_ordem_compra nr_ordem_compra
			  from  ordem_compra a
			 where  (a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
			   and  coalesce(a.nr_seq_motivo_cancel::text, '') = ''
			   and  coalesce(a.cd_pessoa_fisica, a.cd_cgc_fornecedor) = cd_cgc_fornecedor_c
			   and exists (SELECT  1
							 from ordem_compra_item b
							where a.nr_ordem_compra = b.nr_ordem_compra
							  and b.nr_contrato = nr_seq_contrato_c);
	
	
BEGIN
	
	vl_comprometido_w		:= 0;
	vl_total_ordem_w		:= 0;
	qt_total_item_pend_oc_w 	:= 0;
	vl_total_nota_w			:= 0;
	
	cd_moeda_contrato_w := gerenciamento_contrato_pck.obter_moeda_contrato(nr_seq_contrato_p);
	
	For r01 in c01(nr_seq_contrato_p, cd_cgc_fornecedor_p) loop
	
		select sum(round((gerenciamento_contrato_pck.obter_valor_moeda_convertido(nr_seq_contrato_p, cd_moeda_contrato_w, a.cd_moeda, 
									gerenciamento_contrato_pck.obter_qt_vl_liq_oci(a.nr_ordem_compra, b.nr_item_oci, 'VL')))::numeric,2)) vl_total_ordem, 
			   sum((select  coalesce(sum(gerenciamento_contrato_pck.obter_valor_moeda_convertido(nr_seq_contrato_p, cd_moeda_contrato_w, c.cd_moeda, d.vl_liquido)),0)
					  from nota_fiscal c,
						   nota_fiscal_item d
					 where c.nr_sequencia    = d.nr_sequencia
					   and d.nr_ordem_compra = a.nr_ordem_compra
					   and d.nr_item_oci     = b.nr_item_oci
					   and d.nr_contrato = b.nr_contrato
					   and c.ie_situacao     = 1		
					   and (c.dt_atualizacao_estoque IS NOT NULL AND c.dt_atualizacao_estoque::text <> ''))) vl_nota,    
			   sum((select coalesce(sum(qt_prevista_entrega),0) - coalesce(sum(qt_real_entrega),0)
					  from ordem_compra_item_entrega
					 where nr_ordem_compra = a.nr_ordem_compra
					   and nr_item_oci = b.nr_item_oci
					   and coalesce(dt_cancelamento::text, '') = '')) qt_pendente
		  into STRICT vl_total_ordem_w,
			   vl_total_nota_w,
			   qt_total_item_pend_oc_w
		 from 	ordem_compra a,
				ordem_compra_item b
		where	a.nr_ordem_compra = b.nr_ordem_compra
		  and	b.nr_contrato = nr_seq_contrato_p
		  and   a.nr_ordem_compra = r01.nr_ordem_compra
		  and   (a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
		  and   coalesce(a.nr_seq_motivo_cancel::text, '') = ''
		  and	coalesce(b.dt_reprovacao::text, '') = ''
		order by 1;
		
		if (qt_total_item_pend_oc_w > 0) then
			vl_comprometido_w   := vl_comprometido_w + (coalesce(vl_total_ordem_w,0) - coalesce(vl_total_nota_w,0));
		end if;
	
	end loop;

	return	vl_comprometido_w;

	
	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION gerenciamento_contrato_pck.obter_vl_ordens_fornecedor (nr_seq_contrato_p bigint, cd_cgc_fornecedor_p bigint) FROM PUBLIC;
