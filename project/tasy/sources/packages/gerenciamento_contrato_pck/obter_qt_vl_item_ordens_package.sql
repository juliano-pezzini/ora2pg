-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

	
	-->>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>> Quantidade/Valor do item de ordens de compra vinculadas ao contrato. <<<<<<<<<<<<<<<<<<<<<<<<<<<<--
	/*
	Objetivo: Retornar o valor comprometido em ordens de compra vinculadas ao contrato.
	Parametros: 
	nr_seq_contrato_p = Numero de sequencia do contrato.
	ie_qt_vl_p        = Quando passado 'QT': Ira retornar a quantidade total de itens presentes nas ordens de compra, no qual o item e vinculado ao contrato.
	                    Quando passado 'VL': Ira retornar o valor total dos itens presentes nas ordens de compra, no qual o item e vinculado ao contrato.
	ie_atual_p        = Quando 'S': Ira calcular a quantidade/valor atual comprometido em ordens de compra.
					    Quando 'N': Ira retornar o valor de acordo com o ultimo gerenciamento de saldo do contrato existente na tabela "contrato_gerenciamento".
	*/
CREATE OR REPLACE FUNCTION gerenciamento_contrato_pck.obter_qt_vl_item_ordens (nr_seq_contrato_p bigint, ie_qt_vl_p text, ie_atual_p text, nr_seq_regra_contrato_p bigint default null) RETURNS bigint AS $body$
DECLARE

						
		qt_item_ordem_w   contrato_gerenciamento.qt_ordem_compra_item%type;
		vl_ordem_compra_w contrato_gerenciamento.vl_ordem_compra%type;
				
		c01 CURSOR(nr_seq_contrato_c bigint) FOR
			SELECT  a.nr_ordem_compra nr_ordem_compra
			  from  ordem_compra a
			 where  (a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
			   and  coalesce(a.nr_seq_motivo_cancel::text, '') = ''
			   and exists (SELECT  1
							 from ordem_compra_item b
							where a.nr_ordem_compra = b.nr_ordem_compra
							  and b.nr_contrato = nr_seq_contrato_c
							  and (((nr_seq_regra_contrato_p IS NOT NULL AND nr_seq_regra_contrato_p::text <> '') and nr_seq_regra_contrato_p > 0 and b.nr_seq_regra_contrato = nr_seq_regra_contrato_p) or
							        coalesce(nr_seq_regra_contrato_p::text, '') = ''));
		
BEGIN
		
		qt_item_ordem_w := 0;
		vl_ordem_compra_w := 0;
		
			if (ie_atual_p = 'N') then
				begin
					select a.qt_ordem_compra_item,
					       a.vl_ordem_compra
					  into STRICT qt_item_ordem_w,
						   vl_ordem_compra_w
					  from contrato_gerenciamento a
					 where a.nr_seq_contrato = nr_seq_contrato_p
					   and a.dt_atualizacao = (SELECT max(b.dt_atualizacao)
												 from contrato_gerenciamento b
												where b.nr_seq_contrato = a.nr_seq_contrato);
				end;
			else
				begin		
					For r01 in c01(nr_seq_contrato_p) loop
						if (ie_qt_vl_p = 'QT') then
							qt_item_ordem_w   := qt_item_ordem_w + gerenciamento_contrato_pck.obter_qt_vl_item_ordem(nr_seq_contrato_p, r01.nr_ordem_compra, 'QT', nr_seq_regra_contrato_p);
						else
							vl_ordem_compra_w := vl_ordem_compra_w + gerenciamento_contrato_pck.obter_qt_vl_item_ordem(nr_seq_contrato_p, r01.nr_ordem_compra, 'VL');
						end if;
					end loop;
				end;
			end if;
		
		if (ie_qt_vl_p = 'QT') then
			return qt_item_ordem_w;
		else
			return vl_ordem_compra_w;
		end if;
		
	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION gerenciamento_contrato_pck.obter_qt_vl_item_ordens (nr_seq_contrato_p bigint, ie_qt_vl_p text, ie_atual_p text, nr_seq_regra_contrato_p bigint default null) FROM PUBLIC;
