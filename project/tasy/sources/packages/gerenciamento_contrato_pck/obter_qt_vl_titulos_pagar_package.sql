-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

			
	-->>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>++++++ VALORES REALIZADOS ++++++<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<--
	
	-->>>>>>>>>>>>>>>>>>>>>>>>>> Quantidade/Valor total de titulos a pagar vinculados ao contrato <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<--
	/*
	Objetivo: Retornar a quantidade/valor total de titulos a pagar vinculados ao contrato. 
			  Somente titulos nao vinculados a notas fiscais.
	Parametros: 
	nr_seq_contrato_p = Numero de sequencia do contrato.
	ie_qt_vl_p        = Quando passado 'QT': Ira retornar a quantidade total de titulos a pagar vinculados ao contrato.
	                    Quando passado 'VL': Ira retornar o valor total dos titulos a pagar vinculados ao contrato.
	ie_atual_p        = Quando 'S': Ira calcular a quantidade/valor atual realizado em titulos a pagar.
					    Quando 'N': Ira retornar o valor de acordo com o ultimo gerenciamento de saldo do contrato existente na tabela "contrato_gerenciamento".
	*/
CREATE OR REPLACE FUNCTION gerenciamento_contrato_pck.obter_qt_vl_titulos_pagar (nr_seq_contrato_p bigint, ie_qt_vl_p text, ie_atual_p text) RETURNS bigint AS $body$
DECLARE

		
	vl_titulo_pagar_w	contrato_gerenciamento.vl_titulo_pagar%type;
	qt_titulo_pagar_w   contrato_gerenciamento.qt_titulo_pagar%type;
	cd_moeda_contrato_w moeda.cd_moeda%type;
		
	
BEGIN
	vl_titulo_pagar_w   := 0;	
	qt_titulo_pagar_w   := 0;
	cd_moeda_contrato_w := gerenciamento_contrato_pck.obter_moeda_contrato(nr_seq_contrato_p);
	
		if (ie_atual_p = 'N') then
			begin
				select a.vl_titulo_pagar,
					   a.qt_titulo_pagar
				  into STRICT vl_titulo_pagar_w,
					   qt_titulo_pagar_w
				  from contrato_gerenciamento a
				 where a.nr_seq_contrato = nr_seq_contrato_p
				   and a.dt_atualizacao = (SELECT max(b.dt_atualizacao)
											 from contrato_gerenciamento b
											where b.nr_seq_contrato = a.nr_seq_contrato);
			end;
		else
	
			select coalesce(sum(gerenciamento_contrato_pck.obter_valor_moeda_convertido(nr_seq_contrato_p, cd_moeda_contrato_w, a.cd_moeda, gerenciamento_contrato_pck.obter_vl_titulo_pagar(a.nr_titulo))),0),
				   coalesce(count(distinct a.nr_titulo), 0)
			  into STRICT vl_titulo_pagar_w,
			       qt_titulo_pagar_w
			  from titulo_pagar a
			 where a.nr_seq_contrato = nr_seq_contrato_p
			   and ie_situacao in ('A','L','T','B') 
			   and	coalesce(nr_seq_nota_fiscal::text, '') = '';
		end if;
		
	if (ie_qt_vl_p = 'QT') then
		return qt_titulo_pagar_w;
	else
		return vl_titulo_pagar_w;
	end if;
	
	return	vl_titulo_pagar_w;
	
	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION gerenciamento_contrato_pck.obter_qt_vl_titulos_pagar (nr_seq_contrato_p bigint, ie_qt_vl_p text, ie_atual_p text) FROM PUBLIC;
