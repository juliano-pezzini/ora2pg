-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

	
	-->>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>> Valor consumido pelo fornecedor em titulos a receber  <<<<<<<<<<<<<<<<<<<<<<<<<<<--	
	/*
	Objetivo: Retornar o valor consumido pelo fornecedor em titulos a receber vinculados ao contrato.
	Parametros: 
	nr_seq_contrato_p   = Numero de sequencia do contrato.
	cd_cgc_fornecedor_p = CNPJ do fornecedor.
	*/
CREATE OR REPLACE FUNCTION gerenciamento_contrato_pck.obter_vl_tit_receber_fornec (nr_seq_contrato_p bigint, cd_cgc_fornecedor_p bigint) RETURNS bigint AS $body$
DECLARE

		
	vl_titulo_receber_w	contrato_gerenciamento.vl_titulo_receber%type;
	cd_moeda_contrato_w moeda.cd_moeda%type;
	cd_moeda_titulo_w moeda.cd_moeda%type;

	c01 CURSOR(nr_seq_contrato_c bigint, cd_cgc_fornecedor_c bigint) FOR
		SELECT a.nr_titulo,
			   a.cd_moeda
		  into STRICT vl_titulo_receber_w,
			   cd_moeda_titulo_w
		  from titulo_receber a
		 where a.nr_seq_contrato = nr_seq_contrato_c
		   and coalesce(a.cd_pessoa_fisica, a.cd_cgc) = cd_cgc_fornecedor_c
		   and ie_situacao not in (3, 6)
		   and	coalesce(nr_seq_nf_saida::text, '') = '';
	
	
BEGIN
	vl_titulo_receber_w   := 0;	
	cd_moeda_contrato_w := gerenciamento_contrato_pck.obter_moeda_contrato(nr_seq_contrato_p);
	
	For r01 in c01(nr_seq_contrato_p, cd_cgc_fornecedor_p) loop

		vl_titulo_receber_w := vl_titulo_receber_w + gerenciamento_contrato_pck.obter_valor_moeda_convertido(nr_seq_contrato_p, cd_moeda_contrato_w, r01.cd_moeda, gerenciamento_contrato_pck.obter_vl_titulo_receber(r01.nr_titulo));
		
	end loop;

	return vl_titulo_receber_w;

	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION gerenciamento_contrato_pck.obter_vl_tit_receber_fornec (nr_seq_contrato_p bigint, cd_cgc_fornecedor_p bigint) FROM PUBLIC;
