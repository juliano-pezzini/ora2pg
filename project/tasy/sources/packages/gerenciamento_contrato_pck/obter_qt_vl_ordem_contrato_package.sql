-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

	
	-->>>>>>>>>>>>>>>>>>>>>>>>>> Obter valor total dos itens do contrato vinculados a ordem de compra. <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<--	
	/*
	Objetivo: Retornar o valor total dos itens vinculados ao contrato na ordem de compra.
	Parametros: 
	nr_ordem_compra_p = Numero de sequencia da ordem de compra
	nr_seq_contrato_p = Numero de sequencia do contrato.
	*/
CREATE OR REPLACE FUNCTION gerenciamento_contrato_pck.obter_qt_vl_ordem_contrato (nr_ordem_compra_p bigint, nr_seq_contrato_p bigint, qt_vl_p text) RETURNS bigint AS $body$
DECLARE


	vl_item_w				    double precision := 0;
	pr_desconto_w				ordem_compra.pr_desconto%type := 0;
	vl_desconto_w				ordem_compra.vl_desconto%type := 0;
	vl_retorno_w				double precision := 0;
	vl_frete_w					ordem_compra.vl_frete%type := 0;
	vl_despesa_acessoria_w		ordem_compra.vl_despesa_acessoria%type := 0;
	vl_seguro_w					ordem_compra.vl_seguro%type := 0;
	vl_desconto_oc_w			ordem_compra.vl_desconto%type := 0;
	ie_frete_w					ordem_compra.ie_frete%type := 0;
	vl_liquido_unitario_w		double precision;
	vl_cancelado_w				double precision := 0;
	vl_cancelado_ww				double precision := 0;
	cd_estabelecimento_w		smallint;
	ie_desconsidera_cancel_w    parametro_compras.ie_desconsidera_vl_item_cancel%type;
	vl_despesa_doc_w			double precision;
	qt_material_w				ordem_compra_item.qt_material%type;

	c01 CURSOR(nr_seq_contrato_c bigint, nr_ordem_compra_c bigint) FOR
		SELECT b.nr_item_oci,
			   b.qt_prevista_entrega
		  from ordem_compra_item a,
			   ordem_compra_item_entrega b
		 where a.nr_ordem_compra = b.nr_ordem_compra
		   and a.nr_item_oci = b.nr_item_oci
		   and a.nr_ordem_compra = nr_ordem_compra_c
		   and (b.dt_cancelamento IS NOT NULL AND b.dt_cancelamento::text <> '')
		   and a.nr_contrato = nr_seq_contrato_c;

	
BEGIN

	select coalesce(max(pr_desconto),0),
		   coalesce(max(ie_frete),'C'),
		   coalesce(max(vl_frete),0),
		   coalesce(max(vl_despesa_acessoria),0),
		   coalesce(max(vl_despesa_doc),0),
		   coalesce(max(vl_desconto),0),
		   max(cd_estabelecimento),
		   coalesce(max(vl_seguro),0)
	  into STRICT pr_desconto_w,
		   ie_frete_w,
		   vl_frete_w,
		   vl_despesa_acessoria_w,
		   vl_despesa_doc_w,
		   vl_desconto_oc_w,
		   cd_estabelecimento_w,
		   vl_seguro_w
	 from ordem_compra
	where nr_ordem_compra = nr_ordem_compra_p;

	select coalesce(ie_desconsidera_vl_item_cancel,'N')
	  into STRICT ie_desconsidera_cancel_w
	  from parametro_compras
	 where cd_estabelecimento = cd_estabelecimento_w;

	select coalesce(sum(Obter_Valor_Liquido_Oci(nr_ordem_compra, nr_item_oci)),0),
	       coalesce(sum(qt_material),0)
	  into STRICT vl_item_w,
		   qt_material_w
	  from ordem_compra_item
	 where nr_ordem_compra = nr_ordem_compra_p
	   and coalesce(dt_reprovacao::text, '') = ''
	   and nr_contrato = nr_seq_contrato_p;

	if (pr_desconto_w > 0) then
		vl_desconto_w	:= (vl_item_w * pr_desconto_w) / 100;
	end if;

	vl_retorno_w		:= (vl_item_w - vl_desconto_w) - coalesce(vl_desconto_oc_w,0);

	if (vl_despesa_acessoria_w > 0) then
		vl_retorno_w	:= (vl_retorno_w + vl_despesa_acessoria_w);
	end if;

	if (vl_despesa_doc_w > 0) then
		vl_retorno_w	:= (vl_retorno_w + vl_despesa_doc_w);
	end if;

	if (ie_frete_w	= 'F')then
		vl_retorno_w	:= (vl_retorno_w + vl_frete_w);	
	end if;

	if (vl_seguro_w > 0) then
		vl_retorno_w	:= (vl_retorno_w + vl_seguro_w);
	end if;

	if (ie_desconsidera_cancel_w = 'S') then
		
		For r01 in c01(nr_seq_contrato_p, nr_ordem_compra_p) loop
		
			begin
				select	dividir(vl_item_liquido, qt_material)
				  into STRICT	vl_liquido_unitario_w
				  from	ordem_compra_item
				 where	nr_ordem_compra = nr_ordem_compra_p
				   and	nr_item_oci = r01.nr_item_oci
				   and	nr_contrato = nr_seq_contrato_p;
				
				vl_cancelado_w 	:= r01.qt_prevista_entrega * vl_liquido_unitario_w;
				vl_cancelado_ww	:= vl_cancelado_ww + vl_cancelado_w;
			end;
		
		end loop;
	
	end if;

	if (vl_cancelado_ww > 0) then
		vl_retorno_w	:= (vl_retorno_w - vl_cancelado_ww);
	end if;

	if (qt_vl_p = 'VL') then
		return vl_retorno_w;
	else
		return qt_material_w;
	end if;

	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION gerenciamento_contrato_pck.obter_qt_vl_ordem_contrato (nr_ordem_compra_p bigint, nr_seq_contrato_p bigint, qt_vl_p text) FROM PUBLIC;
