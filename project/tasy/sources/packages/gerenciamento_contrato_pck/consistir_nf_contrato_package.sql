-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

	
	
	-->>>>>>>>>>>>>>>>>>>>>>>>>>>>>>> Consistir nota fiscal vinculada ao contrato <<<<<<<<<<<<<<<<<<<<<<<<<<<<<--		
	/*
	Objetivo: Consistir o calculo da nota fiscal caso o contrato nao tenha saldo suficiente para atender essa NF.
	Parametros: 
	nr_seq_nf_p = Numero de sequencia da nota fiscal.
	nm_usuario_p = Nome do usuario.
	*/
CREATE OR REPLACE PROCEDURE gerenciamento_contrato_pck.consistir_nf_contrato (nr_seq_nf_p bigint, nm_usuario_p text) AS $body$
DECLARE

	
	ie_consiste_saldo_contrato_w 	      parametro_compras.ie_cons_saldo_contrato%type;
	
	vl_total_nf_w			nota_fiscal_item.vl_liquido%type;
	
	nr_item_oci_des_w		nota_fiscal_item.nr_item_oci%type;
	nr_ordem_compra_desc_w		nota_fiscal_item.nr_ordem_compra%type;
	vl_desconsiderar_ordem_w	projeto_recurso_saldo.vl_comprometido%type;
	qt_item_nf_desc_w		nota_fiscal_item.qt_item_nf%type;
	qt_material_ordem_desc_w	solic_compra_item.qt_material%type;
	vl_comprometido_w		projeto_recurso_saldo.vl_comprometido%type;
	cd_moeda_contrato_w		 moeda.cd_moeda%type;
	cd_moeda_nf_w		 moeda.cd_moeda%type;
	cd_moeda_oc_w        moeda.cd_moeda%type;
	vl_saldo_contrato_w	contrato_gerenciamento.vl_saldo%type;
	qt_item_nf_w		nota_fiscal_item.qt_item_nf%type;
	qt_comprometido_w	contrato_gerenciamento.qt_itens_restante%type;
	qt_saldo_contrato_w			contrato_gerenciamento.qt_itens_restante%type;
	
	ie_considerar_trib_saldo_w 	projeto_recurso.ie_considerar_trib_saldo%type;
	
	qt_proj_fim_exec		bigint;
	
	c01 CURSOR(nr_seq_nf_c bigint) FOR
		SELECT	nr_contrato nr_seq_contrato
		  from	nota_fiscal_item
		 where	nr_sequencia = nr_seq_nf_c
		   and	(nr_contrato IS NOT NULL AND nr_contrato::text <> '')
		 group by nr_contrato;
	
	c02 CURSOR(nr_seq_nf_c bigint) FOR
		SELECT nr_item_oci,
			   nr_ordem_compra,
		       qt_item_nf
		  from nota_fiscal_item
		 where nr_sequencia = nr_seq_nf_c
		   and nr_ordem_compra > 0;
	
	c03 CURSOR(nr_seq_nf_c bigint) FOR
		SELECT	nr_contrato nr_seq_contrato,
				nr_seq_regra_contrato
		  from	nota_fiscal_item
		 where	nr_sequencia = nr_seq_nf_c
		   and	(nr_contrato IS NOT NULL AND nr_contrato::text <> '')
		 group by nr_contrato, nr_seq_regra_contrato;
	
	c04 CURSOR(nr_seq_nf_c bigint, nr_contrato_c bigint, nr_seq_regra_contrato_c bigint) FOR
		SELECT nr_item_oci,
			   nr_ordem_compra,
		       qt_item_nf
		  from nota_fiscal_item
		 where nr_sequencia = nr_seq_nf_c
		   and nr_ordem_compra > 0
		   and nr_contrato = nr_contrato_c
		   and (coalesce(nr_seq_regra_contrato::text, '') = '' or ((nr_seq_regra_contrato IS NOT NULL AND nr_seq_regra_contrato::text <> '') and nr_seq_regra_contrato = nr_seq_regra_contrato_c));
		
	
BEGIN

	select CASE WHEN gerenciamento_contrato_pck.obter_param_consiste_saldo()='B' THEN  'C' WHEN gerenciamento_contrato_pck.obter_param_consiste_saldo()='A' THEN  'M'  ELSE 'N' END 
	  into STRICT ie_consiste_saldo_contrato_w
	;
	
	begin	
	
		if (ie_consiste_saldo_contrato_w in ('C','M')) then
			
			/* Consiste valor do contrato */

			For r01 in c01(nr_seq_nf_p) loop
			
				cd_moeda_contrato_w := gerenciamento_contrato_pck.obter_moeda_contrato(r01.nr_seq_contrato);
				
				select round((gerenciamento_contrato_pck.aplica_desc_acre_nf(nr_seq_nf_p , coalesce(sum(b.vl_liquido),0)))::numeric,2) - coalesce(sum(gerenciamento_contrato_pck.obter_vl_total_trib_nf(nr_seq_nf_p,b.nr_item_nf)),0),
					   a.cd_moeda
				  into STRICT vl_total_nf_w,
					   cd_moeda_nf_w
				  from nota_fiscal a,
					   nota_fiscal_item b
				 where a.nr_sequencia = b.nr_sequencia
				   and a.nr_sequencia = nr_seq_nf_p
				   and b.nr_contrato = r01.nr_seq_contrato
				   group by a.cd_moeda;
				
				vl_total_nf_w := gerenciamento_contrato_pck.obter_valor_moeda_convertido(r01.nr_seq_contrato, cd_moeda_contrato_w, cd_moeda_nf_w, vl_total_nf_w);
				
				vl_comprometido_w := 0;
				qt_comprometido_w := 0;
				
				ie_considerar_trib_saldo_w := 'N';
				
				For r02 in c02(nr_seq_nf_p) loop				
				
					begin
						select round((gerenciamento_contrato_pck.aplica_desc_acre_oc(r02.nr_ordem_compra, gerenciamento_contrato_pck.obter_vl_liq_oci(r02.nr_ordem_compra, r02.nr_item_oci, ie_considerar_trib_saldo_w)))::numeric,2),
							   a.cd_moeda,
							   b.qt_material
						  into STRICT vl_desconsiderar_ordem_w,
							   cd_moeda_oc_w,
							   qt_material_ordem_desc_w
						  from ordem_compra a,
							   ordem_compra_item b
						 where a.nr_ordem_compra = b.nr_ordem_compra
						   and a.nr_ordem_compra = r02.nr_ordem_compra
						   and b.nr_item_oci = r02.nr_item_oci
						   and b.nr_contrato = r01.nr_seq_contrato;
					exception when others then
						vl_desconsiderar_ordem_w := 0;
						cd_moeda_oc_w := 0;
						qt_material_ordem_desc_w := 0;
					end;
					
					vl_desconsiderar_ordem_w := gerenciamento_contrato_pck.obter_valor_moeda_convertido(r01.nr_seq_contrato, cd_moeda_contrato_w, cd_moeda_oc_w, vl_desconsiderar_ordem_w);
					
					if (r02.qt_item_nf < qt_material_ordem_desc_w) then
						vl_comprometido_w :=  vl_comprometido_w + (dividir_sem_round(vl_desconsiderar_ordem_w,qt_material_ordem_desc_w) * r02.qt_item_nf);
					else
						vl_comprometido_w :=  vl_comprometido_w + vl_desconsiderar_ordem_w;
					end if;
				
				end loop;
				
				vl_saldo_contrato_w := gerenciamento_contrato_pck.obter_valor_saldo(r01.nr_seq_contrato, 'S');
				
				if (gerenciamento_contrato_pck.obter_valor_total(r01.nr_seq_contrato, 'S') > 0 and
                   ((vl_saldo_contrato_w + vl_comprometido_w) < vl_total_nf_w)) then
				
					select CASE WHEN ie_consiste_saldo_contrato_w='C' THEN  'S' WHEN ie_consiste_saldo_contrato_w='M' THEN  'N' END 
					  into STRICT ie_consiste_saldo_contrato_w
					;
					
					CALL gravar_nota_fiscal_consist(nr_seq_nf_p,
									           wheb_mensagem_pck.get_texto(1082502, 'NR_CONTRATO='|| r01.nr_seq_contrato),
											    ie_consiste_saldo_contrato_w,
												'N',
												wheb_mensagem_pck.get_texto(1082838,
												'VL_SALDO_W='|| campo_mascara_virgula_casas(vl_saldo_contrato_w + vl_comprometido_w,4) ||						
												';VL_TRANSACAO_W='|| campo_mascara_virgula_casas(vl_total_nf_w,4)),
												nm_usuario_p,'S');	
				end if;
				
			end loop;
			
			/* Consiste quantidade dos itens do contrato */

			For r03 in c03(nr_seq_nf_p) loop
			
				select sum(b.qt_item_nf)
				  into STRICT qt_item_nf_w
				  from nota_fiscal_item b
				 where b.nr_sequencia = nr_seq_nf_p
				   and b.nr_contrato = r03.nr_seq_contrato
				   and (coalesce(b.nr_seq_regra_contrato::text, '') = '' or ((b.nr_seq_regra_contrato IS NOT NULL AND b.nr_seq_regra_contrato::text <> '') and b.nr_seq_regra_contrato = r03.nr_seq_regra_contrato));
			
				qt_comprometido_w := 0;
				
				For r04 in c04(nr_seq_nf_p, r03.nr_seq_contrato, r03.nr_seq_regra_contrato) loop
					
					Begin
						select b.qt_material
						  into STRICT qt_material_ordem_desc_w
						  from ordem_compra_item b
						 where b.nr_ordem_compra = r04.nr_ordem_compra
						   and b.nr_item_oci = r04.nr_item_oci
						   and b.nr_contrato = r03.nr_seq_contrato;
					exception when others then
						qt_material_ordem_desc_w := 0;
					end;
					
					if (r04.qt_item_nf < qt_material_ordem_desc_w) then
						qt_comprometido_w :=  qt_comprometido_w + r04.qt_item_nf;
					else
						qt_comprometido_w :=  qt_comprometido_w + qt_material_ordem_desc_w;
					end if;
					
				end loop;
				
				qt_saldo_contrato_w := gerenciamento_contrato_pck.obter_qt_restante(r03.nr_seq_contrato, 'S', r03.nr_seq_regra_contrato);

				if (gerenciamento_contrato_pck.obter_qt_fixa_item_contrato(r03.nr_seq_contrato, r03.nr_seq_regra_contrato) > 0 and (qt_saldo_contrato_w + qt_comprometido_w) < qt_item_nf_w) then

					select CASE WHEN ie_consiste_saldo_contrato_w='C' THEN  'S' WHEN ie_consiste_saldo_contrato_w='M' THEN  'N' END
					  into STRICT ie_consiste_saldo_contrato_w
					;
					
					/* Grava consistencia dos itens de contrato */

					CALL gravar_nota_fiscal_consist(nr_seq_nf_p,
									           wheb_mensagem_pck.get_texto(1082502, 'NR_CONTRATO='|| r03.nr_seq_contrato),
											    ie_consiste_saldo_contrato_w,
												'N',
												wheb_mensagem_pck.get_texto(1121703,
												'NR_SEQ_ITEM='|| r03.nr_seq_regra_contrato ||
												';QT_SALDO_W='|| campo_mascara_virgula_casas(qt_saldo_contrato_w + qt_comprometido_w,4) ||
												';QT_TRANSACAO_W='|| campo_mascara_virgula_casas(qt_item_nf_w,4)),
											    nm_usuario_p,'S');
				end if;
				
			end loop;
		end if;
	
	end;
		
	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerenciamento_contrato_pck.consistir_nf_contrato (nr_seq_nf_p bigint, nm_usuario_p text) FROM PUBLIC;
