-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

	
	-->>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>++++++ SALDO ++++++<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<--
	
	-->>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>> Obter valor de saldo do contrato <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<--
	/*
	Objetivo: Retornar o valor de saldo do contrato passado por parametro.
			  Este se trata do valor total do contrato, subtraindo os valores comprometidos e realizados.
	Parametros: 
	nr_seq_contrato_p = Numero de sequencia do contrato.
	ie_atual_p        = Quando 'S': Ira calcular o valor atual comprometido do contrato.
					    Quando 'N': Ira retornar o valor de acordo com o ultimo gerenciamento de saldo do contrato existente na tabela "contrato_gerenciamento".
	*/
CREATE OR REPLACE FUNCTION gerenciamento_contrato_pck.obter_valor_saldo (nr_seq_contrato_p bigint, ie_atual_p text) RETURNS bigint AS $body$
DECLARE

				
	valor_saldo_contrato_w  contrato_gerenciamento.vl_saldo%type;
	valor_total_contrato_w  contrato.vl_total_contrato%type;
	
	
BEGIN
	
	valor_saldo_contrato_w := 0;
	
	if (ie_atual_p = 'N') then
		begin
			select a.vl_saldo
			  into STRICT valor_saldo_contrato_w
			  from contrato_gerenciamento a
			 where a.nr_seq_contrato = nr_seq_contrato_p
			   and a.dt_atualizacao = (SELECT max(b.dt_atualizacao)
										 from contrato_gerenciamento b
										where b.nr_seq_contrato = a.nr_seq_contrato);
		end;
	else
		valor_total_contrato_w := coalesce(gerenciamento_contrato_pck.obter_valor_total(nr_seq_contrato_p, ie_atual_p),0);

		if (valor_total_contrato_w <> 0) then
			valor_saldo_contrato_w := valor_total_contrato_w - (gerenciamento_contrato_pck.obter_valor_comprometido(nr_seq_contrato_p, 'S') + gerenciamento_contrato_pck.obter_valor_realizado(nr_seq_contrato_p, 'S'));
		end if;
	end if;
	
	return valor_saldo_contrato_w;
	
	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION gerenciamento_contrato_pck.obter_valor_saldo (nr_seq_contrato_p bigint, ie_atual_p text) FROM PUBLIC;
