-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

	
	-->>>>>>>>>>>>>>>>>>>>>>>>>> Quantidade/Valor do item da ordem de compra vinculado ao contrato. <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<--
	/*
	Objetivo: Retornar o valor comprometido da ordem de compra passada por parametro vinculada ao contrato.
	Parametros: 
	nr_seq_contrato_p = Numero de sequencia do contrato.
	nr_ordem_compra_p = Numero da ordem de compra.
	ie_qt_vl_p        = Quando passado 'QT': Ira retornar a quantidade total de itens presentes na ordem de compra, no qual o item e vinculado ao contrato.
	                    Quando passado 'VL': Ira retornar o valor total dos itens presentes na ordem de compra, no qual o item e vinculado ao contrato.
	*/
CREATE OR REPLACE FUNCTION gerenciamento_contrato_pck.obter_qt_vl_item_ordem (nr_seq_contrato_p bigint, nr_ordem_compra_p bigint, ie_qt_vl_p text, nr_seq_regra_contrato_p bigint default null) RETURNS bigint AS $body$
DECLARE

	
	vl_comprometido_w		 contrato_gerenciamento.vl_comprometido%type;	
	vl_total_ordem_w		 ordem_compra_item.vl_unitario_material%type;
	qt_total_item_pend_oc_w	 ordem_compra_item_entrega.qt_prevista_entrega%type;	
	vl_total_nota_w			 nota_fiscal_item.vl_liquido%type;
	qt_material_w			 ordem_compra_item.qt_material%type;
	qt_item_nota_w			 nota_fiscal_item.qt_item_nf%type;
	qt_material_total_w      ordem_compra_item.qt_material%type;
	cd_moeda_contrato_w		 moeda.cd_moeda%type;
	
	
BEGIN
	
	vl_comprometido_w		:= 0;
	vl_total_ordem_w		:= 0;
	qt_total_item_pend_oc_w 	:= 0;
	vl_total_nota_w			:= 0;
	qt_material_total_w     := 0;
	
	cd_moeda_contrato_w := gerenciamento_contrato_pck.obter_moeda_contrato(nr_seq_contrato_p);
	
	select sum(round((gerenciamento_contrato_pck.obter_valor_moeda_convertido(nr_seq_contrato_p, cd_moeda_contrato_w, a.cd_moeda,
								gerenciamento_contrato_pck.obter_qt_vl_liq_oci(a.nr_ordem_compra, b.nr_item_oci, 'VL')))::numeric,2)) vl_total_ordem, 
           sum((select  coalesce(sum(gerenciamento_contrato_pck.obter_valor_moeda_convertido(nr_seq_contrato_p, cd_moeda_contrato_w, c.cd_moeda, d.vl_liquido)),0)
				  from nota_fiscal c,
					   nota_fiscal_item d
				 where c.nr_sequencia    = d.nr_sequencia
				   and d.nr_ordem_compra = a.nr_ordem_compra
				   and d.nr_item_oci     = b.nr_item_oci
				   and d.nr_contrato = b.nr_contrato
				   and c.ie_situacao     = 1		
				   and (c.dt_atualizacao_estoque IS NOT NULL AND c.dt_atualizacao_estoque::text <> ''))) vl_nota,    
		   sum((select coalesce(sum(qt_prevista_entrega),0) - coalesce(sum(qt_real_entrega),0)
				  from ordem_compra_item_entrega
				 where nr_ordem_compra = a.nr_ordem_compra
				   and nr_item_oci = b.nr_item_oci
				   and coalesce(dt_cancelamento::text, '') = '')) qt_pendente,
		   sum(gerenciamento_contrato_pck.obter_qt_vl_liq_oci(a.nr_ordem_compra, b.nr_item_oci, 'QT')) qt_material,
		   sum((select  coalesce(sum(d.qt_item_nf),0)
				  from nota_fiscal c,
					   nota_fiscal_item d
				 where c.nr_sequencia    = d.nr_sequencia
				   and d.nr_ordem_compra = a.nr_ordem_compra
				   and d.nr_item_oci     = b.nr_item_oci
				   and d.nr_contrato = b.nr_contrato
				   and c.ie_situacao     = 1		
				   and (c.dt_atualizacao_estoque IS NOT NULL AND c.dt_atualizacao_estoque::text <> ''))) qt_nota
      into STRICT vl_total_ordem_w,
           vl_total_nota_w,
           qt_total_item_pend_oc_w,
		   qt_material_w,
		   qt_item_nota_w
	 from 	ordem_compra a,
			ordem_compra_item b
	where	a.nr_ordem_compra = b.nr_ordem_compra
	  and	b.nr_contrato = nr_seq_contrato_p
	  and   (((nr_seq_regra_contrato_p IS NOT NULL AND nr_seq_regra_contrato_p::text <> '') and nr_seq_regra_contrato_p > 0 and b.nr_seq_regra_contrato = nr_seq_regra_contrato_p) or coalesce(nr_seq_regra_contrato_p::text, '') = '')
	  and   a.nr_ordem_compra = nr_ordem_compra_p
      and   (a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
	  and   coalesce(a.nr_seq_motivo_cancel::text, '') = ''
	  and	coalesce(b.dt_reprovacao::text, '') = ''
	order by 1;
	
	if (qt_total_item_pend_oc_w > 0) then
		vl_comprometido_w   := coalesce(vl_total_ordem_w,0) - coalesce(vl_total_nota_w,0);
		qt_material_total_w := coalesce(qt_material_w,0)    - coalesce(qt_item_nota_w,0);
	end if;
	
	if (ie_qt_vl_p = 'QT') then
		return qt_material_total_w;
	else
		return	vl_comprometido_w;
	end if;
	
	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION gerenciamento_contrato_pck.obter_qt_vl_item_ordem (nr_seq_contrato_p bigint, nr_ordem_compra_p bigint, ie_qt_vl_p text, nr_seq_regra_contrato_p bigint default null) FROM PUBLIC;
