-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

	
	-->>>>>>>>>>>>>>>>>>>>>>>>>>>>>> Quantidade de ordens de compra vinculadas ao contrato <<<<<<<<<<<<<<<<<<<<<<<<<<<<<--
	/*
	Objetivo: Retornar a quantidade de ordens de compra que possuem valores comprometidos vinculadas ao contrato.
	Parametros: 
	nr_seq_contrato_p = Numero de sequencia do contrato.
	ie_atual_p        = Quando 'S': Ira verificar a quantidade atual de ordens de compra vinculadas ao contrato.
					    Quando 'N': Ira verificar a quantidade de acordo com o ultimo gerenciamento de saldo do contrato existente na tabela "contrato_gerenciamento".
	*/
CREATE OR REPLACE FUNCTION gerenciamento_contrato_pck.obter_qt_ordem (nr_seq_contrato_p bigint, ie_atual_p text) RETURNS bigint AS $body$
DECLARE

		
		qt_ordem_w contrato_gerenciamento.qt_ordem_compra%type;
		
		
BEGIN
		
		qt_ordem_w := 0;
		
		if (ie_atual_p = 'N') then
			begin
				select a.qt_ordem_compra
				  into STRICT qt_ordem_w
				  from contrato_gerenciamento a
				 where a.nr_seq_contrato = nr_seq_contrato_p
				   and a.dt_atualizacao = (SELECT max(b.dt_atualizacao)
											 from contrato_gerenciamento b
											where b.nr_seq_contrato = a.nr_seq_contrato);
			end;
		else		
			select count(distinct x.nr_ordem_compra) qt_ordem_compra
			  into STRICT qt_ordem_w
			  from (SELECT a.nr_ordem_compra, 
						  sum((select coalesce(sum(qt_prevista_entrega),0) - coalesce(sum(qt_real_entrega),0)
								 from ordem_compra_item_entrega
								where nr_ordem_compra = a.nr_ordem_compra
								  and nr_item_oci = b.nr_item_oci
								  and coalesce(dt_cancelamento::text, '') = '')) qt_pendente,
						  sum(gerenciamento_contrato_pck.obter_qt_vl_liq_oci(a.nr_ordem_compra, b.nr_item_oci, 'QT')) qt_material,
						  sum((select  coalesce(sum(d.qt_item_nf),0)
								 from nota_fiscal c,
									  nota_fiscal_item d
								where c.nr_sequencia    = d.nr_sequencia
								  and d.nr_ordem_compra = a.nr_ordem_compra
								  and d.nr_item_oci     = b.nr_item_oci
								  and d.nr_contrato = b.nr_contrato
								  and c.ie_situacao     = 1		
								  and (c.dt_atualizacao_estoque IS NOT NULL AND c.dt_atualizacao_estoque::text <> ''))) qt_nota
					 from ordem_compra a,
						  ordem_compra_item b
					where	a.nr_ordem_compra = b.nr_ordem_compra
					  and	b.nr_contrato = nr_seq_contrato_p
					  and (a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
					  and coalesce(a.nr_seq_motivo_cancel::text, '') = ''
					  and	coalesce(b.dt_reprovacao::text, '') = ''
					group by a.nr_ordem_compra) x
			where x.qt_pendente > 0
			  and x.qt_material > x.qt_nota;
		end if;
				
		return qt_ordem_w;
	
	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION gerenciamento_contrato_pck.obter_qt_ordem (nr_seq_contrato_p bigint, ie_atual_p text) FROM PUBLIC;
