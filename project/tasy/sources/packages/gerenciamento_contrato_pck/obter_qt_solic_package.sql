-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

	
	-->>>>>>>>>>>>>>>>>>>>>>>>>>>>>> Quantidade de solicitacoes de compra vinculadas ao contrato <<<<<<<<<<<<<<<<<<<<<<<<<<<<<--
	/*
	Objetivo: Retornar a quantidade de solicitacoes de compra que possuem valores comprometidos vinculadas ao contrato.
	Parametros: 
	nr_seq_contrato_p = Numero de sequencia do contrato.
	ie_atual_p        = Quando 'S': Ira verificar a quantidade atual de solicitacoes de compra vinculadas ao contrato.
					    Quando 'N': Ira verificar a quantidade de acordo com o ultimo gerenciamento de saldo do contrato existente na tabela "contrato_gerenciamento".
	*/
CREATE OR REPLACE FUNCTION gerenciamento_contrato_pck.obter_qt_solic (nr_seq_contrato_p bigint, ie_atual_p text) RETURNS bigint AS $body$
DECLARE

				
		qt_solic_compra_w contrato_gerenciamento.qt_solic_compra%type;
				
		
BEGIN		
		
		if (ie_atual_p = 'N') then
			begin
				select a.qt_solic_compra
				  into STRICT qt_solic_compra_w
				  from contrato_gerenciamento a
				 where a.nr_seq_contrato = nr_seq_contrato_p
				   and a.dt_atualizacao = (SELECT max(b.dt_atualizacao)
											 from contrato_gerenciamento b
											where b.nr_seq_contrato = a.nr_seq_contrato);
			end;
		else 		
			select count(distinct a.nr_solic_compra) qt_solic_compra
			  into STRICT qt_solic_compra_w
			  from solic_compra a
			 where coalesce(a.nr_seq_motivo_cancel::text, '') = ''
			   and (a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
			   and exists (SELECT  1
							 from    solic_compra_item b
							where   b.nr_contrato = nr_seq_contrato_p
							  and	b.vl_unit_previsto > 0
							  and 	coalesce(b.dt_reprovacao::text, '') = ''
							  and	((coalesce(b.dt_baixa::text, '') = '' and coalesce(b.cd_motivo_baixa::text, '') = '')
							   or 	(((b.dt_baixa IS NOT NULL AND b.dt_baixa::text <> '') or (b.cd_motivo_baixa IS NOT NULL AND b.cd_motivo_baixa::text <> '')) 
							  and 	(b.qt_material - coalesce(b.qt_material_cancelado,0) > (select 	coalesce(sum(e.qt_prevista_entrega),0)
																						 from ordem_compra o,
																							  ordem_compra_item i,
																							  ordem_compra_item_entrega e
																						where	o.nr_ordem_compra = i.nr_ordem_compra
																						  and	i.nr_ordem_compra = e.nr_ordem_compra
																						  and	i.nr_item_oci = e.nr_item_oci
																						  and	i.nr_solic_compra = b.nr_solic_compra
																						  and	i.nr_item_solic_compra = b.nr_item_solic_compra
																						  and	(o.dt_liberacao IS NOT NULL AND o.dt_liberacao::text <> '')
																						  and 	coalesce(o.nr_seq_motivo_cancel::text, '') = ''
																						  and	coalesce(e.dt_cancelamento::text, '') = ''))))
							  and     a.nr_solic_compra = b.nr_solic_compra);
		end if;
		
		return qt_solic_compra_w;
		
	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION gerenciamento_contrato_pck.obter_qt_solic (nr_seq_contrato_p bigint, ie_atual_p text) FROM PUBLIC;
