-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

	
	-->>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>> Obter valor convertido de acordo com moeda <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<--
	/*
	Objetivo: Retornar o valor convertido de acordo com cotacao da moeda presente em Cadastros Gerais (Shift+F11) > Aplicacao principal > Cadastros Gerais > Moedas.
	Parametros: 
	cd_moeda_contrato_p  = Codigo da moeda do contrato.
	cd_moeda_documento_p = Codigo da moeda do documento (Ordem de compra/Nota Fiscal).
	vl_converter_p       = Valor a ser convertido.
	*/
CREATE OR REPLACE FUNCTION gerenciamento_contrato_pck.obter_valor_moeda_convertido (nr_seq_contrato_p bigint, cd_moeda_contrato_p moeda.cd_moeda%type, cd_moeda_documento_p moeda.cd_moeda%type, vl_converter_p bigint) RETURNS bigint AS $body$
DECLARE

		
		cd_moeda_local_w 		 moeda.cd_moeda%type;
		vl_cotacao_moeda_w  cotacao_moeda.vl_cotacao%type;
		vl_cotacao_moeda_ww cotacao_moeda.vl_cotacao%type;
		cd_estabelecimento_w 	contrato.cd_estabelecimento%type;
		vl_convertido_w			 double precision;
		cd_moeda_contrato_w 	moeda.cd_moeda%type;
		
		
BEGIN
		
			select max(cd_estabelecimento),
			       max(cd_moeda_estrangeira)
			  into STRICT cd_estabelecimento_w,
				   cd_moeda_contrato_w
			  from contrato
			 where nr_sequencia = nr_seq_contrato_p;

			cd_moeda_local_w 		 := obter_moeda_padrao_empresa(cd_estabelecimento_w, 'E');
			
			if (cd_moeda_contrato_w = 0) then
				cd_moeda_contrato_w := cd_moeda_local_w;
			end if;
			
			if (cd_moeda_documento_p = cd_moeda_contrato_w or vl_converter_p = 0) then
				return vl_converter_p;
			end if;
			
			vl_convertido_w := vl_converter_p;
			
			/* O documento utiliza moeda diferente da local */

			if (cd_moeda_documento_p <> cd_moeda_local_w) then
				vl_cotacao_moeda_w := obter_cotacao_moeda(cd_moeda_documento_p);
				vl_convertido_w := vl_convertido_w * vl_cotacao_moeda_w;		
			end if;
			
			/* O contrato utiliza moeda diferente da local */

			if (cd_moeda_contrato_w <> cd_moeda_local_w) then
				vl_cotacao_moeda_w := obter_cotacao_moeda(cd_moeda_contrato_w);
				vl_convertido_w := Dividir(vl_convertido_w, vl_cotacao_moeda_w);
			end if;
				
		return vl_convertido_w;

	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION gerenciamento_contrato_pck.obter_valor_moeda_convertido (nr_seq_contrato_p bigint, cd_moeda_contrato_p moeda.cd_moeda%type, cd_moeda_documento_p moeda.cd_moeda%type, vl_converter_p bigint) FROM PUBLIC;
