-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pls_gerencia_senha_web_pck.verificar_senha_existente ( ds_senha_p text, nr_seq_usuario_p bigint, ie_tipo_login_p text, qt_senha_diferente_p bigint) RETURNS varchar AS $body$
DECLARE


ie_retorno_w			varchar(1) := 'N';
qt_reg_w				bigint;

  linha RECORD;

BEGIN

qt_reg_w := 0;

if (ie_tipo_login_p = 'P') then

	for linha in (  SELECT  obter_sha2(upper(ds_senha_p) || ds_tec, 256) ds_hash_gerado_w,
							ds_senha
					FROM    pls_usuario_hist_senha_web
					WHERE   nr_seq_usuario_web = nr_seq_usuario_p
					ORDER BY dt_atualizacao DESC) loop

		if (qt_reg_w < qt_senha_diferente_p) then
			if (linha.ds_hash_gerado_w = linha.ds_senha) then
				ie_retorno_w := 'S';
			end if;
		end if;

		qt_reg_w        := qt_reg_w + 1;
	end loop;	
			
elsif (ie_tipo_login_p = 'B') then

	for linha in (  SELECT  obter_sha2(upper(ds_senha_p) || ds_tec, 256) ds_hash_gerado_w,
							ds_senha
					FROM    pls_usuario_hist_senha_web
					WHERE   nr_seq_segurado_web = nr_seq_usuario_p
					ORDER BY dt_atualizacao DESC) loop

		if (qt_reg_w < qt_senha_diferente_p) then
			if (linha.ds_hash_gerado_w = linha.ds_senha) then
				ie_retorno_w := 'S';
			end if;
		end if;

		qt_reg_w        := qt_reg_w + 1;
	end loop;

elsif (ie_tipo_login_p = 'E') then

	for linha in (  SELECT  obter_sha2(upper(ds_senha_p) || ds_tec, 256) ds_hash_gerado_w,
							ds_senha
					FROM    pls_usuario_hist_senha_web
					WHERE   nr_seq_estip_web = nr_seq_usuario_p
					ORDER BY dt_atualizacao DESC) loop

		if (qt_reg_w < qt_senha_diferente_p) then
			if (linha.ds_hash_gerado_w = linha.ds_senha) then
				ie_retorno_w := 'S';
			end if;
		end if;

		qt_reg_w        := qt_reg_w + 1;
	end loop;
	
elsif (ie_tipo_login_p = 'GC') then
	
	for linha in (  SELECT  obter_sha2(upper(ds_senha_p) || ds_tec, 256) ds_hash_gerado_w,
							ds_senha
					FROM    pls_usuario_hist_senha_web
					WHERE   nr_seq_gc_web = nr_seq_usuario_p
					ORDER BY dt_atualizacao DESC) loop

		if (qt_reg_w < qt_senha_diferente_p) then
			if (linha.ds_hash_gerado_w = linha.ds_senha) then
				ie_retorno_w := 'S';
			end if;
		end if;

		qt_reg_w        := qt_reg_w + 1;
	end loop;
	
elsif (ie_tipo_login_p = 'PA') then
	
	for linha in (  SELECT  obter_sha2(upper(ds_senha_p) || ds_tec, 256) ds_hash_gerado_w,
							ds_senha
					FROM    pls_usuario_hist_senha_web
					WHERE   nr_seq_pr_adesao_web = nr_seq_usuario_p
					ORDER BY dt_atualizacao DESC) loop

		if (qt_reg_w < qt_senha_diferente_p) then
			if (linha.ds_hash_gerado_w = linha.ds_senha) then
				ie_retorno_w := 'S';
			end if;
		end if;

		qt_reg_w        := qt_reg_w + 1;
	end loop;
	
elsif (ie_tipo_login_p = 'CO') then
	
	for linha in (  SELECT  obter_sha2(upper(ds_senha_p) || ds_tec, 256) ds_hash_gerado_w,
							ds_senha
					FROM    pls_usuario_hist_senha_web
					WHERE   nr_seq_cooperado_web = nr_seq_usuario_p
					ORDER BY dt_atualizacao DESC) loop

		if (qt_reg_w < qt_senha_diferente_p) then
			if (linha.ds_hash_gerado_w = linha.ds_senha) then
				ie_retorno_w := 'S';
			end if;
		end if;

		qt_reg_w        := qt_reg_w + 1;
	end loop;
				
end if;

return ie_retorno_w;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pls_gerencia_senha_web_pck.verificar_senha_existente ( ds_senha_p text, nr_seq_usuario_p bigint, ie_tipo_login_p text, qt_senha_diferente_p bigint) FROM PUBLIC;
