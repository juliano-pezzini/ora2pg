-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_contab_onl_lote_fin_pck.contab_rec_faturamento ( doc_p INOUT ctb_documento, nm_usuario_p text) AS $body$
DECLARE


	dados_contab_w			dados_contab;
	vet_contas_contabeis_w		vet_contas_contabeis;
	cd_conta_deb_ndc_w		conta_contabil.cd_conta_contabil%type;
	cd_conta_deb_dif_w		conta_contabil.cd_conta_contabil%type;
	cd_conta_deb_taxa_w		conta_contabil.cd_conta_contabil%type;
	cd_conta_deb_taxa_adm_w		conta_contabil.cd_conta_contabil%type;
	cd_conta_deb_ajuste_w		conta_contabil.cd_conta_contabil%type;
	cd_conta_cred_ndc_w		conta_contabil.cd_conta_contabil%type;
	cd_conta_cred_dif_w		conta_contabil.cd_conta_contabil%type;
	cd_conta_cred_taxa_w		conta_contabil.cd_conta_contabil%type;
	cd_conta_cred_taxa_adm_w	conta_contabil.cd_conta_contabil%type;
	cd_conta_cred_ajuste_w		conta_contabil.cd_conta_contabil%type;
	cd_conta_deb_w			conta_contabil.cd_conta_contabil%type;
	cd_conta_cred_w			conta_contabil.cd_conta_contabil%type;
	cd_historico_ndc_w		historico_padrao.cd_historico%type;
	cd_historico_dif_w		historico_padrao.cd_historico%type;
	cd_historico_taxa_w		historico_padrao.cd_historico%type;
	cd_historico_ajuste_w		historico_padrao.cd_historico%type;
	cd_historico_taxa_adm_w		historico_padrao.cd_historico%type;
	cd_historico_w			historico_padrao.cd_historico%type;
	nr_seq_agrupamento_w		w_movimento_contabil.nr_seq_agrupamento%type;
	nr_titulo_fat_w			pls_fatura.nr_titulo%type;
	dt_mesano_referencia_fat_w	pls_lote_faturamento.dt_mesano_referencia%type;
	nr_seq_lote_fat_w		pls_fatura.nr_seq_lote%type;
	nr_seq_conta_w			pls_conta.nr_sequencia%type;
	nr_seq_protocolo_w		pls_conta.nr_seq_protocolo%type;
	nr_seq_prestador_w		pls_conta.nr_seq_prestador_exec%type;
	nr_seq_plano_w			pls_conta.nr_seq_plano%type;
	ie_regulamentacao_w		pls_plano.ie_regulamentacao%type;
	nr_seq_fatura_w			pls_fatura.nr_sequencia%type;
	nr_seq_lote_fatur_w		pls_lote_faturamento.nr_sequencia%type;
	cd_pessoa_fisica_w		pls_prestador.cd_pessoa_fisica%type;
	cd_cgc_prestador_w		pls_prestador.cd_cgc%type;
	cd_cpf_prestador_w		pessoa_fisica.nr_cpf%type;
	nm_prestador_w			pessoa_fisica.nm_pessoa_fisica%type;
	nr_nota_fiscal_w		pls_prot_conta_titulo.nr_nota_fiscal%type;
	nm_pagador_fat_w		pessoa_juridica.nm_fantasia%type;
	cd_pf_pag_w			pls_contrato_pagador.cd_pessoa_fisica%type;
	cd_cgc_pag_w			pls_contrato_pagador.cd_cgc%type;
	nr_seq_pagador_w		pls_fatura.nr_seq_pagador%type;
	ie_tipo_cobranca_fat_w		pls_fatura_mat.ie_tipo_cobranca%type;
	ds_tipo_cobranca_fat_w		valor_dominio.ds_valor_dominio%type;
	nr_nota_fiscal_fat_w		nota_fiscal.nr_nota_fiscal%type;
	cd_centro_custo_w		centro_custo.cd_centro_custo%type;
	nr_seq_segurado_w		pls_conta.nr_seq_segurado%type;
	nr_lote_contabil_w		lote_contabil.nr_lote_contabil%type;
	nr_seq_prot_conta_w		pls_conta.nr_seq_prot_conta%type;
	nr_seq_fatura_conta_w		pls_fatura_conta.nr_sequencia%type;
	nr_seq_regra_cc_w		pls_regra_centro_custo.nr_sequencia%type;
	nr_seq_pos_estab_contab_w	pls_conta_pos_estab_contab.nr_sequencia%type;
	nr_seq_pos_taxa_contab_w	pls_conta_pos_taxa_contab.nr_sequencia%type;
	dt_mes_competencia_w		timestamp;
	ds_compl_historico_w		varchar(255);
	nm_segurado_w			varchar(255);
	nm_agrupador_w			varchar(255);
	ds_conteudo_w			varchar(4000);
	qt_atrib_hist_pad_w		integer;

	
BEGIN

	begin
	select	cd_conta_deb_ndc,
		cd_conta_deb_dif,
		cd_conta_deb_taxa,
		cd_conta_deb_taxa_adm,
		cd_conta_deb_ajuste,	
		cd_conta_cred_ndc,
		cd_conta_cred_dif,
		cd_conta_cred_taxa,
		cd_conta_cred_taxa_adm,
		cd_conta_cred_ajuste,
		cd_historico_ndc,
		cd_historico_dif,
		cd_historico_taxa,
		cd_historico_ajuste,
		cd_historico_taxa_adm,
		nr_seq_conta,
		nr_seq_segurado,
		nr_seq_protocolo,
		nr_seq_prestador,
		nr_seq_fatura,
		nr_seq_lote_fat,
		ie_tipo_cobranca_fat,
		nr_seq_plano,
		nr_seq_pagador,
		nr_titulo_fat,
		dt_mesano_referencia_fat,
		nr_seq_lote_fatur,
		nr_seq_prot_conta,
		nr_seq_fatura_conta,
		nr_seq_pos_estab_contab,
		nr_seq_pos_taxa_contab
	into STRICT	cd_conta_deb_ndc_w,
		cd_conta_deb_dif_w,
		cd_conta_deb_taxa_w,
		cd_conta_deb_taxa_adm_w,
		cd_conta_deb_ajuste_w,	
		cd_conta_cred_ndc_w,
		cd_conta_cred_dif_w,
		cd_conta_cred_taxa_w,
		cd_conta_cred_taxa_adm_w,
		cd_conta_cred_ajuste_w,
		cd_historico_ndc_w,
		cd_historico_dif_w,
		cd_historico_taxa_w,
		cd_historico_ajuste_w,
		cd_historico_taxa_adm_w,
		nr_seq_conta_w,
		nr_seq_segurado_w,
		nr_seq_protocolo_w,
		nr_seq_prestador_w,
		nr_seq_fatura_w,
		nr_seq_lote_fat_w,
		ie_tipo_cobranca_fat_w,
		nr_seq_plano_w,
		nr_seq_pagador_w,
		nr_titulo_fat_w,
		dt_mesano_referencia_fat_w,
		nr_seq_lote_fatur_w,
		nr_seq_prot_conta_w,
		nr_seq_fatura_conta_w,
		nr_seq_pos_estab_contab_w,
		nr_seq_pos_taxa_contab_w	
	from (SELECT	e.cd_conta_deb_ndc,
			e.cd_conta_deb_dif,
			e.cd_conta_deb_taxa,
			h.cd_conta_deb cd_conta_deb_taxa_adm,
			e.cd_conta_deb_provisao cd_conta_deb_ajuste,	
			e.cd_conta_cred_ndc,
			e.cd_conta_cred_dif,
			e.cd_conta_cred_taxa,
			h.cd_conta_cred cd_conta_cred_taxa_adm,
			e.cd_conta_cred_provisao cd_conta_cred_ajuste,
			e.cd_historico_ndc,
			e.cd_historico_dif,
			e.cd_historico_taxa,
			e.cd_historico_ajuste,
			h.cd_historico cd_historico_taxa_adm,
			t.nr_sequencia nr_seq_conta,
			t.nr_seq_segurado,
			t.nr_seq_protocolo,
			t.nr_seq_prestador_exec nr_seq_prestador,
			f.nr_sequencia nr_seq_fatura,
			f.nr_seq_lote nr_seq_lote_fat,
			p.ie_tipo_cobranca ie_tipo_cobranca_fat,
			t.nr_seq_plano,
			f.nr_seq_pagador,
			f.nr_titulo nr_titulo_fat,
			l.dt_mesano_referencia dt_mesano_referencia_fat,
			l.nr_sequencia nr_seq_lote_fatur,
			t.nr_seq_prot_conta,
			c.nr_sequencia nr_seq_fatura_conta,
			e.nr_sequencia nr_seq_pos_estab_contab,
			h.nr_sequencia nr_seq_pos_taxa_contab
		FROM pls_conta t, pls_segurado s, pls_lote_faturamento l, pls_conta_pos_estab_contab e, pls_fatura_evento d, pls_fatura_conta c, pls_conta_pos_estabelecido a, pls_fatura f
LEFT OUTER JOIN titulo_receber r ON (f.nr_titulo = r.nr_titulo)
, pls_fatura_proc p
LEFT OUTER JOIN pls_conta_pos_taxa_contab h ON (p.nr_seq_pos_taxa_contab = h.nr_sequencia)
WHERE t.nr_sequencia 		= a.nr_seq_conta and a.nr_sequencia 		= e.nr_seq_conta_pos and s.nr_sequencia 		= t.nr_seq_segurado and a.nr_sequencia 		= p.nr_seq_conta_pos_estab and c.nr_sequencia 		= p.nr_seq_fatura_conta and d.nr_sequencia 		= c.nr_seq_fatura_evento and f.nr_sequencia 		= d.nr_seq_fatura and l.nr_sequencia 		= f.nr_seq_lote   and doc_p.nr_documento	= t.nr_sequencia and doc_p.nr_seq_doc_compl	= e.nr_Sequencia and doc_p.nr_doc_analitico	= p.nr_sequencia and doc_p.nm_tabela		= 'PLS_FATURA_PROC' and doc_p.nm_atributo	in ('VL_FATURADO_NDC', 'VL_FATURADO_DIF', 'VL_TAXA', 'VL_AJUSTE', 'VL_TAXA_ADM')
		
union all

		SELECT	e.cd_conta_deb_ndc,
			e.cd_conta_deb_dif,
			e.cd_conta_deb_taxa,
			h.cd_conta_deb cd_conta_deb_taxa_adm,
			e.cd_conta_deb_provisao cd_conta_deb_ajuste,		
			e.cd_conta_cred_ndc,
			e.cd_conta_cred_dif,
			e.cd_conta_cred_taxa,
			h.cd_conta_cred cd_conta_cred_taxa_adm,
			e.cd_conta_cred_provisao cd_conta_cred_ajuste,		
			e.cd_historico_ndc,
			e.cd_historico_dif,
			e.cd_historico_taxa,
			e.cd_historico_ajuste,
			h.cd_historico cd_historico_taxa_adm,
			t.nr_sequencia nr_seq_conta,
			t.nr_seq_segurado,
			t.nr_seq_protocolo,
			t.nr_seq_prestador_exec nr_seq_prestador,
			f.nr_sequencia nr_seq_fatura,
			f.nr_seq_lote nr_seq_lote_fat,
			m.ie_tipo_cobranca ie_tipo_cobranca_fat,
			t.nr_seq_plano,
			f.nr_seq_pagador,
			f.nr_titulo nr_titulo_fat,
			l.dt_mesano_referencia dt_mesano_referencia_fat,
			l.nr_sequencia nr_seq_lote_fatur,
			t.nr_seq_prot_conta,
			c.nr_sequencia,
			e.nr_sequencia nr_seq_pos_estab_contab,
			h.nr_sequencia nr_seq_pos_taxa_contab
		FROM pls_conta t, pls_segurado s, pls_lote_faturamento l, pls_conta_pos_estab_contab e, pls_fatura_evento d, pls_fatura_conta c, pls_conta_pos_estabelecido a, pls_fatura f
LEFT OUTER JOIN titulo_receber r ON (f.nr_titulo = r.nr_titulo)
, pls_fatura_mat m
LEFT OUTER JOIN pls_conta_pos_taxa_contab h ON (m.nr_seq_pos_taxa_contab = h.nr_sequencia)
WHERE t.nr_sequencia 		= a.nr_seq_conta and a.nr_sequencia 		= e.nr_seq_conta_pos and s.nr_sequencia 		= t.nr_seq_segurado and a.nr_sequencia 		= m.nr_seq_conta_pos_estab and c.nr_sequencia 		= m.nr_seq_fatura_conta and d.nr_sequencia 		= c.nr_seq_fatura_evento and f.nr_sequencia 		= d.nr_seq_fatura and l.nr_sequencia 		= f.nr_seq_lote   and doc_p.nr_documento	= t.nr_sequencia and doc_p.nr_seq_doc_compl	= e.nr_Sequencia and doc_p.nr_doc_analitico	= m.nr_sequencia and doc_p.nm_tabela		= 'PLS_FATURA_MAT' and doc_p.nm_atributo	in ('VL_FATURADO_NDC', 'VL_FATURADO_DIF', 'VL_TAXA', 'VL_AJUSTE', 'VL_TAXA_ADM') ) alias2;
	exception when no_data_found then
	/* Salva a inconsistencia: "Nao foi possivel identificar o movimento de origem." */

	select 	obter_desc_expressao(950251)
	into STRICT	doc_p.ds_inconsistencia
	;
	return;
	end;

	if (doc_p.nm_atributo = 'VL_FATURADO_NDC') then
		cd_conta_deb_w 	:= coalesce(cd_conta_deb_ndc_w, 'X');
		cd_conta_cred_w := coalesce(cd_conta_cred_ndc_w, 'X');
		cd_historico_w	:= coalesce(cd_historico_ndc_w,0);
	elsif (doc_p.nm_atributo = 'VL_FATURADO_DIF') then
		cd_conta_deb_w 	:= coalesce(cd_conta_deb_dif_w, 'X');
		cd_conta_cred_w := coalesce(cd_conta_cred_dif_w, 'X');
		cd_historico_w	:= coalesce(cd_historico_dif_w, 0);
	elsif (doc_p.nm_atributo = 'VL_TAXA') then
		cd_conta_deb_w 	:= coalesce(cd_conta_deb_taxa_w, 'X');
		cd_conta_cred_w := coalesce(cd_conta_cred_taxa_w, 'X');
		cd_historico_w	:= coalesce(cd_historico_taxa_w, 0);
	elsif (doc_p.nm_atributo = 'VL_AJUSTE') then
		cd_conta_deb_w 	:= coalesce(cd_conta_deb_ajuste_w, 'X');
		cd_conta_cred_w := coalesce(cd_conta_cred_ajuste_w, 'X');
		cd_historico_w	:= coalesce(cd_historico_ajuste_w, 0);
	elsif (doc_p.nm_atributo = 'VL_TAXA_ADM') then
		cd_conta_deb_w 	:= coalesce(cd_conta_deb_taxa_adm_w, 'X');
		cd_conta_cred_w := coalesce(cd_conta_cred_taxa_adm_w, 'X');
		cd_historico_w	:= coalesce(cd_historico_taxa_adm_w, 0);
	end if;

	/* Se nao houver informacoes de contas contabeis ou de historico, nao segue o processo */

	if (cd_conta_deb_w = 'X' or cd_conta_cred_w = 'X' or cd_historico_w = 0) then
		/* Salva a inconsistencia: "Conta nao encontrada" */

		select 	obter_desc_expressao(330747)
		into STRICT	doc_p.ds_inconsistencia
		;
		return;
	end if;

	/* Informacoes presentes no doc_p */

	dados_contab_w.dt_movimento             := doc_p.dt_competencia;
	dados_contab_w.vl_movimento             := doc_p.vl_movimento;
	dados_contab_w.cd_tipo_lote_contabil    := doc_p.cd_tipo_lote_contabil;
	dados_contab_w.cd_estabelecimento       := doc_p.cd_estabelecimento;
	dados_contab_w.cd_historico		:= cd_historico_w;

	/* Numero de agrupamento */

	nm_agrupador_w	:= coalesce(trim(both obter_agrupador_contabil(doc_p.cd_tipo_lote_contabil)), 'NR_SEQ_FATURA');
	if (nm_agrupador_w = 'NR_SEQ_FATURA') then
		nr_seq_agrupamento_w	:= nr_seq_fatura_w;
	elsif (nm_agrupador_w = 'NR_SEQ_LOTE_FATUR') then
		nr_seq_agrupamento_w	:= nr_seq_lote_fatur_w;
	end if;
	dados_contab_w.nr_seq_agrupamento 	:= nr_seq_agrupamento_w;

	/* Informacoes para a obtencao do centro de custo */

	if (coalesce(nr_seq_plano_w::text, '') = '') then
		begin
		select	b.ie_regulamentacao,
			b.nr_sequencia
		into STRICT	ie_regulamentacao_w,
			nr_seq_plano_w
		from	pls_segurado	a,
			pls_plano	b
		where	b.nr_sequencia	= a.nr_seq_plano
		and	a.nr_sequencia	= nr_seq_segurado_w;
		exception
		when others then
			ie_regulamentacao_w	:= null;
			nr_seq_plano_w		:= null;
		end;
	else
		begin
		select	b.ie_regulamentacao
		into STRICT	ie_regulamentacao_w
		from	pls_plano	b
		where	b.nr_sequencia	= nr_seq_plano_w;
		exception
		when others then
			ie_regulamentacao_w	:= null;
		end;
	end if;

	/* Verifica se existe algum atributo cadastrado para aquele historico, levando em consideracao o tipo de lote contabil e estabelecimento/empresa */

	select  count(1)
	into STRICT    qt_atrib_hist_pad_w
	from    historico_padrao_atributo   c,
		historico_padrao            b,
		estabelecimento             a
	where   a.cd_estabelecimento    = doc_p.cd_estabelecimento
	and     a.cd_empresa            = b.cd_empresa
	and     b.cd_historico          = c.cd_historico
	and     c.cd_historico          = cd_historico_w
	and     c.cd_tipo_lote_contabil = doc_p.cd_tipo_lote_contabil;

	if (qt_atrib_hist_pad_w > 0) then

		if (coalesce(nr_seq_protocolo_w,0) > 0) then
			select	dt_mes_competencia
			into STRICT	dt_mes_competencia_w
			from	pls_protocolo_conta
			where	nr_sequencia = nr_seq_protocolo_w;
		end if;

		if (coalesce(nr_seq_prestador_w,0) > 0) then
			select	a.cd_pessoa_fisica,
				a.cd_cgc
			into STRICT	cd_pessoa_fisica_w,
				cd_cgc_prestador_w
			from	pls_prestador	a
			where	a.nr_sequencia	= nr_seq_prestador_w;
			
			begin
			if (cd_cgc_prestador_w IS NOT NULL AND cd_cgc_prestador_w::text <> '') then
				select	substr(a.ds_razao_social,1,80)
				into STRICT	nm_prestador_w
				from	pessoa_juridica	a
				where	a.cd_cgc	= cd_cgc_prestador_w;
			else
				select	substr(a.nm_pessoa_fisica,1,80)
				into STRICT	nm_prestador_w
				from	pessoa_fisica	a
				where	a.cd_pessoa_fisica	= cd_pessoa_fisica_w;
			end if;
			exception
			when others then
				nm_prestador_w	:= null;
			end;
			
			cd_cpf_prestador_w	:= null;
			
			if (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '') then
				select	nr_cpf
				into STRICT	cd_cpf_prestador_w
				from	pessoa_fisica
				where	cd_pessoa_fisica	= cd_pessoa_fisica_w;
			end if;
		end if;
		
		select	max(nr_nota_fiscal)
		into STRICT	nr_nota_fiscal_w
		from	pls_prot_conta_titulo
		where	nr_sequencia	= nr_seq_prot_conta_w;
		
		if (coalesce(nr_seq_fatura_conta_w, 0) > 0) then
			nm_pagador_fat_w	:= null;
			cd_pf_pag_w		:= null;
			cd_cgc_pag_w		:= null;
			
			if (nr_seq_pagador_w IS NOT NULL AND nr_seq_pagador_w::text <> '') then
				select	a.cd_pessoa_fisica,
					a.cd_cgc
				into STRICT	cd_pf_pag_w,
					cd_cgc_pag_w
				from	pls_contrato_pagador	a
				where	a.nr_sequencia		= nr_seq_pagador_w;
				
				begin
				if (cd_cgc_pag_w IS NOT NULL AND cd_cgc_pag_w::text <> '') then
					select	substr(a.nm_fantasia,1,80)
					into STRICT	nm_pagador_fat_w
					from	pessoa_juridica	a
					where	a.cd_cgc	= cd_cgc_pag_w;
				else
					select	substr(a.nm_pessoa_fisica,1,80)
					into STRICT	nm_pagador_fat_w
					from	pessoa_fisica	a
					where	a.cd_pessoa_fisica	= cd_pf_pag_w;
				end if;
				exception
				when others then
					nm_pagador_fat_w	:= null;
				end;
			end if;
		end if;
		
		ds_tipo_cobranca_fat_w	:= substr(obter_valor_dominio(4774, ie_tipo_cobranca_fat_w), 1, 255);
		
		begin
		select	a.nr_nota_fiscal
		into STRICT	nr_nota_fiscal_fat_w
		from	nota_fiscal	a
		where	a.nr_seq_fatura	= nr_seq_fatura_w;
		exception
		when others then
			nr_nota_fiscal_fat_w	:= null;
		end;
	
		ds_conteudo_w	:= substr(	nr_seq_prestador_w		||'#@'||
						nm_prestador_w			||'#@'||
						nr_seq_protocolo_w		||'#@'||
						nr_seq_conta_w			||'#@'||
						cd_cgc_prestador_w		||'#@'||
						cd_cpf_prestador_w		||'#@'||
						nr_nota_fiscal_w		||'#@'||
						nr_seq_lote_fat_w		||'#@'||
						dt_mesano_referencia_fat_w	||'#@'||
						ds_tipo_cobranca_fat_w		||'#@'||
						nm_pagador_fat_w		||'#@'||
						nr_titulo_fat_w			||'#@'||
						nr_nota_fiscal_fat_w		||'#@'||
						dt_mes_competencia_w,1,4000);
		
		begin
		ds_compl_historico_w	:= substr(obter_compl_historico(doc_p.cd_tipo_lote_contabil, dados_contab_w.cd_historico, ds_conteudo_w),1,255);
		exception
		when others then
			ds_compl_historico_w	:= null;
		end;
					
		dados_contab_w.ds_compl_historico	:= substr(ds_compl_historico_w,1,255);
	end if;

	/* Salva as contas contabeis em um vetor, pois sera feito um insert com cada uma delas*/

	vet_contas_contabeis_w := vet_contas_contabeis();
	vet_contas_contabeis_w.extend(2);
	vet_contas_contabeis_w(1)       := cd_conta_cred_w;
	vet_contas_contabeis_w(2)       := cd_conta_deb_w;

	/* Para cada conta conta contabil no vetor, verifica o centro de custo */

	for i in 1..vet_contas_contabeis_w.count loop
		dados_contab_w.cd_centro_custo := null;
		dados_contab_w.cd_conta_cred := null;
		dados_contab_w.cd_conta_deb := null;
		cd_centro_custo_w := null;

		/* Centro de custo */

		SELECT * FROM pls_contab_onl_lote_fin_pck.verifica_centro_custo(  'D', nr_seq_plano_w, doc_p.cd_estabelecimento, '', '', ie_regulamentacao_w, nr_seq_segurado_w, '', cd_centro_custo_w, nr_seq_regra_cc_w, coalesce(vet_contas_contabeis_w(i), 'X')) INTO STRICT cd_centro_custo_w, nr_seq_regra_cc_w;
		dados_contab_w.cd_centro_custo := cd_centro_custo_w;

		/* Segue a ordem das atribuicoes feitas no vetor */

		if (i = 1) then
			dados_contab_w.cd_conta_cred := vet_contas_contabeis_w(i);
		elsif (i = 2) then
			dados_contab_w.cd_conta_deb := vet_contas_contabeis_w(i);
		end if;

		dados_contab_w := pls_contab_onl_lote_fin_pck.contabiliza_movimento(dados_contab_w, nm_usuario_p);
		doc_p.nr_lote_contabil := dados_contab_w.nr_lote_contabil;
	end loop;

	if (coalesce(doc_p.nr_lote_contabil, 0) <> 0) then
		if (coalesce(doc_p.ds_origem, 'X') = 'ESTORNO') then
			nr_lote_contabil_w := 0;
		else
			nr_lote_contabil_w := doc_p.nr_lote_contabil;
		end if;

		update	pls_fatura a
		set	a.nr_lote_contabil	= nr_lote_contabil_w
		where	nr_sequencia		= nr_seq_fatura_w;

		update	pls_conta_pos_estab_contab
		set	nr_lote_contabil	= nr_lote_contabil_w
		where	nr_sequencia		= nr_seq_pos_estab_contab_w;

		if (nr_seq_pos_taxa_contab_w IS NOT NULL AND nr_seq_pos_taxa_contab_w::text <> '') then
			update	pls_conta_pos_taxa_contab
			set	nr_lote_contabil	= nr_lote_contabil_w
			where	nr_sequencia		= nr_seq_pos_taxa_contab_w;
		end if;
	end if;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_contab_onl_lote_fin_pck.contab_rec_faturamento ( doc_p INOUT ctb_documento, nm_usuario_p text) FROM PUBLIC;
