-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_contab_onl_lote_fin_pck.contab_baixa_mens ( doc_p INOUT ctb_documento, nm_usuario_p text) AS $body$
DECLARE


	dados_contab_w			dados_contab;
	ctb_movimento_w			ctb_movimento%rowtype;
	dados_contab_tf_w		ctb_contab_onl_lote_fin_pck.dados_contab_tf;
	ie_permite_estab_dif_w		ctb_regra_estab_dif.ie_permite%type;
	ie_cc_glosa_w			parametro_contas_receber.ie_cc_glosa%type;
	nr_titulo_w			titulo_receber.nr_titulo%type;
	cd_cgc_w			titulo_receber.cd_cgc%type;
	nr_interno_conta_w		titulo_receber.nr_interno_conta%type;
	nr_seq_protocolo_w		titulo_receber.nr_seq_protocolo%type;
	cd_pessoa_fisica_w		titulo_receber.cd_pessoa_fisica%type;
	cd_estab_titulo_w		titulo_receber.cd_estabelecimento%type;
	nr_seq_negociacao_w		titulo_receber.nr_seq_negociacao_origem%type;
	cd_convenio_w			convenio.cd_convenio%type;
	nr_seq_receb_w 			convenio_ret_receb.nr_seq_receb%type;
	nr_seq_retorno_w		titulo_receber_liq.nr_seq_retorno%type;
	nr_seq_ret_item_w		titulo_receber_liq.nr_seq_ret_item%type;
	nr_seq_movto_bco_pend_w		movto_banco_pend_baixa.nr_seq_movto_pend%type;
	nr_bordero_rec_w		titulo_receber_liq.nr_bordero%type;
	nr_seq_baixa_w			titulo_receber_liq.nr_sequencia%type;
	ie_dt_contab_glosa_w		parametro_contas_receber.ie_dt_contab_glosa%type;
	ie_contab_rec_classif_w		parametro_contas_receber.ie_contab_rec_classif%type;
	cd_conta_deb_pls_w		pls_titulo_rec_liq_mens.cd_conta_debito%type;
	cd_conta_rec_pls_w		pls_titulo_rec_liq_mens.cd_conta_credito%type;
	cd_historico_pls_w		pls_titulo_rec_liq_mens.cd_historico%type;
	ds_observacao_titulo_w		titulo_receber.ds_observacao_titulo%type;
	nr_seq_cobr_escrit_w		titulo_receber_liq.nr_seq_cobranca%type;
	nr_seq_nota_credito_w		titulo_receber_nc.nr_seq_nota_credito%type;
	cd_conta_contabil_w		titulo_rec_liq_cc.cd_conta_contabil%type;
	nr_seq_caixa_w			movto_trans_financ.nr_seq_caixa%type;
	nr_seq_caixa_od_w		movto_trans_financ.nr_seq_caixa_od%type;
	nr_seq_movto_trans_fin_w	movto_trans_Financ.nr_sequencia%type;
	cd_centro_custo_w		centro_custo.cd_centro_custo%type;
	nr_seq_conta_banco_w		titulo_receber_liq.nr_seq_conta_banco%type;
	nr_seq_produto_w		titulo_rec_liq_cc.nr_seq_produto%type;
	ie_origem_tit_rec_w		titulo_receber.ie_origem_titulo%type;
	cd_tipo_recebimento_w		titulo_receber_liq.cd_tipo_recebimento%type;
	ie_segmentacao_w		pls_plano.ie_segmentacao%type;
	cd_conta_codificacao_w		pls_contab_codific_item.cd_conta_contabil%type;
	ie_contab_cr_no_cb_w		parametro_controle_banc.ie_contab_cr_no_cb%type;
	cd_conta_transitoria_w		ctb_regra_estab_dif.cd_conta_contabil%type;
	dt_contabil_w			timestamp;
	dt_contabil_tit_w		timestamp;
	ie_tipo_conta_glosa_w		varchar(1);
	nm_agrupador_w			varchar(255);
	nr_nfe_imp_w			varchar(255);
	ds_devedor_w			varchar(255);
	ds_recebimentos_w		varchar(255);
	ds_compl_historico_w		varchar(255);
	ds_conteudo_w			varchar(4000);
	qt_glosa_terceiro_w		integer;
	qt_atrib_hist_pad_w        	integer;
	qt_conta_contabil_w		integer;
	nr_nota_fiscal_w		numeric(38); -- Retorno da function somente_numero()
	
BEGIN

	/* Obtem os parametros necessarios para verificacoes gerais */

	ie_permite_estab_dif_w          := ctb_online_pck.get_permite_estab_dif(doc_p.cd_tipo_lote_contabil, doc_p.cd_estabelecimento);
	cd_conta_transitoria_w          := ctb_online_pck.get_conta_transitoria_estab(doc_p.cd_tipo_lote_contabil, doc_p.cd_estabelecimento);

	select	coalesce(max(ie_cc_glosa), 'N'),
		coalesce(max(ie_contab_rec_classif),'N'),
		coalesce(max(ie_dt_contab_glosa),'R')
	into STRICT	ie_cc_glosa_w,
		ie_contab_rec_classif_w,
		ie_dt_contab_glosa_w
	from	parametro_contas_receber
	where	cd_estabelecimento = doc_p.cd_estabelecimento;

	select	coalesce(max(ie_contab_cr_no_cb), 'N')
	into STRICT	ie_contab_cr_no_cb_w
	from	parametro_controle_banc
	where	cd_estabelecimento	= doc_p.cd_estabelecimento;

	/* Realiza o select de acordo com a tabela/atributo que esta na ctb_documento */

	begin
	if (doc_p.nm_tabela = 'TITULO_RECEBER_LIQ' and doc_p.nm_atributo = 'VL_RECEBIDO') then
		select	a.nr_titulo,
			a.nr_seq_conta_banco,
			0 cd_centro_custo,
			a.dt_recebimento,
			'' cd_conta_contabil,
			a.nr_seq_retorno,
			a.nr_seq_ret_item,
			'' cd_conta_deb_pls,
			'' cd_conta_rec_pls,
			(null)::numeric  cd_historico_pls,
			a.nr_seq_movto_trans_fin,
			b.ds_observacao_titulo,
			(null)::numeric  nr_seq_produto,
			a.nr_sequencia nr_seq_baixa,
			null nr_seq_nota_credito,
			b.ie_origem_titulo,
			a.cd_tipo_recebimento,
			a.nr_seq_cobranca,		
			a.nr_bordero
		into STRICT	nr_titulo_w,
			nr_seq_conta_banco_w,
			cd_centro_custo_w,
			dt_contabil_tit_w,
			cd_conta_contabil_w,
			nr_seq_retorno_w,
			nr_seq_ret_item_w,
			cd_conta_deb_pls_w,
			cd_conta_rec_pls_w,
			cd_historico_pls_w,
			nr_seq_movto_trans_fin_w,
			ds_observacao_titulo_w,
			nr_seq_produto_w,
			nr_seq_baixa_w,
			nr_seq_nota_credito_w,
			ie_origem_tit_rec_w,
			cd_tipo_recebimento_w,
			nr_seq_cobr_escrit_w,
			nr_bordero_rec_w
		from	titulo_receber_liq	a,
			titulo_receber		b
		where	doc_p.nr_documento 	= a.nr_titulo
		and	doc_p.nr_seq_doc_compl 	= a.nr_sequencia
		and	a.nr_titulo		= b.nr_titulo
		and	((ie_permite_estab_dif_w <> 'N') or (b.cd_estabelecimento = doc_p.cd_estabelecimento));

	elsif (doc_p.nm_tabela = 'TITULO_REC_LIQ_CC' and doc_p.nm_atributo = 'VL_RECEBIDO') then
		select	a.nr_titulo,
			a.nr_seq_conta_banco,
			c.cd_centro_custo,
			a.dt_recebimento,
			c.cd_conta_contabil,
			a.nr_seq_retorno,
			a.nr_seq_ret_item,
			'' cd_conta_deb_pls,
			'' cd_conta_rec_pls,
			(null)::numeric  cd_historico_pls,
			a.nr_seq_movto_trans_fin,
			b.ds_observacao_titulo,
			c.nr_seq_produto,
			a.nr_sequencia nr_seq_baixa,
			null nr_seq_nota_credito,
			b.ie_origem_titulo,
			a.cd_tipo_recebimento,
			a.nr_seq_cobranca,
			a.nr_bordero
		into STRICT	nr_titulo_w,
			nr_seq_conta_banco_w,
			cd_centro_custo_w,
			dt_contabil_tit_w,
			cd_conta_contabil_w,
			nr_seq_retorno_w,
			nr_seq_ret_item_w,
			cd_conta_deb_pls_w,
			cd_conta_rec_pls_w,
			cd_historico_pls_w,
			nr_seq_movto_trans_fin_w,
			ds_observacao_titulo_w,
			nr_seq_produto_w,
			nr_seq_baixa_w,
			nr_seq_nota_credito_w,
			ie_origem_tit_rec_w,
			cd_tipo_recebimento_w,
			nr_seq_cobr_escrit_w,
			nr_bordero_rec_w
		from	titulo_rec_liq_cc	c,
			titulo_receber_liq	a,
			titulo_receber		b
		where	doc_p.nr_documento 	= c.nr_titulo
		and	doc_p.nr_seq_doc_compl 	= c.nr_seq_baixa
		and	doc_p.nr_doc_analitico	= c.nr_sequencia
		and	a.nr_sequencia		= c.nr_seq_baixa
		and	a.nr_titulo		= c.nr_titulo
		and	a.nr_titulo		= b.nr_titulo
		and	((ie_permite_estab_dif_w <> 'N') or (b.cd_estabelecimento = doc_p.cd_estabelecimento));

	elsif (doc_p.nm_tabela = 'TITULO_RECEBER_LIQ' and doc_p.nm_atributo = 'VL_DESCONTOS') then
		select	a.nr_titulo,
			a.nr_seq_conta_banco,
			a.cd_centro_custo_desc cd_centro_custo,
			a.dt_recebimento,
			'' cd_conta_contabil,
			a.nr_seq_retorno,
			a.nr_seq_ret_item,
			'' cd_conta_deb_pls,
			'' cd_conta_rec_pls,
			(null)::numeric  cd_historico_pls,
			a.nr_seq_movto_trans_fin,
			b.ds_observacao_titulo,
			(null)::numeric  nr_seq_produto,
			a.nr_sequencia nr_seq_baixa,
			null nr_seq_nota_credito,
			b.ie_origem_titulo,
			a.cd_tipo_recebimento,
			a.nr_seq_cobranca,
			a.nr_bordero
		into STRICT	nr_titulo_w,
			nr_seq_conta_banco_w,
			cd_centro_custo_w,
			dt_contabil_tit_w,
			cd_conta_contabil_w,
			nr_seq_retorno_w,
			nr_seq_ret_item_w,
			cd_conta_deb_pls_w,
			cd_conta_rec_pls_w,
			cd_historico_pls_w,
			nr_seq_movto_trans_fin_w,
			ds_observacao_titulo_w,
			nr_seq_produto_w,
			nr_seq_baixa_w,
			nr_seq_nota_credito_w,
			ie_origem_tit_rec_w,
			cd_tipo_recebimento_w,
			nr_seq_cobr_escrit_w,
			nr_bordero_rec_w
		from	titulo_receber_liq	a,
			titulo_receber		b
		where	doc_p.nr_documento 	= a.nr_titulo
		and	doc_p.nr_seq_doc_compl 	= a.nr_sequencia
		and	a.nr_titulo		= b.nr_titulo
		and	((ie_permite_estab_dif_w <> 'N') or (b.cd_estabelecimento = doc_p.cd_estabelecimento));
	
	elsif (doc_p.nm_tabela = 'TITULO_RECEBER_LIQ' and doc_p.nm_atributo = 'VL_JUROS') then
		select	a.nr_titulo,
			a.nr_seq_conta_banco,
			0 cd_centro_custo,
			a.dt_recebimento,
			'' cd_conta_contabil,
			a.nr_seq_retorno,
			a.nr_seq_ret_item,
			'' cd_conta_deb_pls,
			'' cd_conta_rec_pls,
			(null)::numeric  cd_historico_pls,
			a.nr_seq_movto_trans_fin,
			b.ds_observacao_titulo,
			(null)::numeric  nr_seq_produto,
			a.nr_sequencia nr_seq_baixa,
			null nr_seq_nota_credito,
			b.ie_origem_titulo,
			a.cd_tipo_recebimento,
			a.nr_seq_cobranca,
			a.nr_bordero
		into STRICT	nr_titulo_w,
			nr_seq_conta_banco_w,
			cd_centro_custo_w,
			dt_contabil_tit_w,
			cd_conta_contabil_w,
			nr_seq_retorno_w,
			nr_seq_ret_item_w,
			cd_conta_deb_pls_w,
			cd_conta_rec_pls_w,
			cd_historico_pls_w,
			nr_seq_movto_trans_fin_w,
			ds_observacao_titulo_w,
			nr_seq_produto_w,
			nr_seq_baixa_w,
			nr_seq_nota_credito_w,
			ie_origem_tit_rec_w,
			cd_tipo_recebimento_w,
			nr_seq_cobr_escrit_w,
			nr_bordero_rec_w
		from	titulo_receber_liq	a,
			titulo_receber		b
		where	doc_p.nr_documento 	= a.nr_titulo
		and	doc_p.nr_seq_doc_compl 	= a.nr_sequencia
		and	a.nr_titulo		= b.nr_titulo
		and	((ie_permite_estab_dif_w <> 'N') or (b.cd_estabelecimento = doc_p.cd_estabelecimento));

	elsif (doc_p.nm_tabela = 'TITULO_RECEBER_LIQ' and doc_p.nm_atributo = 'VL_MULTA') then
		select	a.nr_titulo,
			a.nr_seq_conta_banco,
			0 cd_centro_custo,
			a.dt_recebimento,
			'' cd_conta_contabil,
			a.nr_seq_retorno,
			a.nr_seq_ret_item,
			'' cd_conta_deb_pls,
			'' cd_conta_rec_pls,
			(null)::numeric  cd_historico_pls,
			a.nr_seq_movto_trans_fin,
			b.ds_observacao_titulo,
			(null)::numeric  nr_seq_produto,
			a.nr_sequencia nr_seq_baixa,
			null nr_seq_nota_credito,
			b.ie_origem_titulo,
			a.cd_tipo_recebimento,
			a.nr_seq_cobranca,
			a.nr_bordero
		into STRICT	nr_titulo_w,
			nr_seq_conta_banco_w,
			cd_centro_custo_w,
			dt_contabil_tit_w,
			cd_conta_contabil_w,
			nr_seq_retorno_w,
			nr_seq_ret_item_w,
			cd_conta_deb_pls_w,
			cd_conta_rec_pls_w,
			cd_historico_pls_w,
			nr_seq_movto_trans_fin_w,
			ds_observacao_titulo_w,
			nr_seq_produto_w,
			nr_seq_baixa_w,
			nr_seq_nota_credito_w,
			ie_origem_tit_rec_w,
			cd_tipo_recebimento_w,
			nr_seq_cobr_escrit_w,
			nr_bordero_rec_w
		from	titulo_receber_liq	a,
			titulo_receber		b
		where	doc_p.nr_documento 	= a.nr_titulo
		and	doc_p.nr_seq_doc_compl 	= a.nr_sequencia
		and	a.nr_titulo		= b.nr_titulo
		and	((ie_permite_estab_dif_w <> 'N') or (b.cd_estabelecimento = doc_p.cd_estabelecimento));

	elsif (doc_p.nm_tabela = 'TITULO_RECEBER_LIQ' and doc_p.nm_atributo = 'VL_DESPESA_BANCARIA') then

		select	a.nr_titulo,
			a.nr_seq_conta_banco,
			0 cd_centro_custo,
			a.dt_recebimento,
			'' cd_conta_contabil,
			a.nr_seq_retorno,
			a.nr_seq_ret_item,
			'' cd_conta_deb_pls,
			'' cd_conta_rec_pls,
			(null)::numeric  cd_historico_pls,
			a.nr_seq_movto_trans_fin,
			b.ds_observacao_titulo,
			(null)::numeric  nr_seq_produto,
			a.nr_sequencia nr_seq_baixa,
			null nr_seq_nota_credito,
			b.ie_origem_titulo,
			a.cd_tipo_recebimento,
			a.nr_seq_cobranca,
			a.nr_bordero
		into STRICT	nr_titulo_w,
			nr_seq_conta_banco_w,
			cd_centro_custo_w,
			dt_contabil_tit_w,
			cd_conta_contabil_w,
			nr_seq_retorno_w,
			nr_seq_ret_item_w,
			cd_conta_deb_pls_w,
			cd_conta_rec_pls_w,
			cd_historico_pls_w,
			nr_seq_movto_trans_fin_w,
			ds_observacao_titulo_w,
			nr_seq_produto_w,
			nr_seq_baixa_w,
			nr_seq_nota_credito_w,
			ie_origem_tit_rec_w,
			cd_tipo_recebimento_w,
			nr_seq_cobr_escrit_w,
			nr_bordero_rec_w
		from	titulo_receber_liq	a,
			titulo_receber		b
		where	doc_p.nr_documento 	= a.nr_titulo
		and	doc_p.nr_seq_doc_compl 	= a.nr_sequencia
		and	a.nr_titulo		= b.nr_titulo
		and	((ie_permite_estab_dif_w <> 'N') or (b.cd_estabelecimento = doc_p.cd_estabelecimento));
	
	elsif (doc_p.nm_tabela = 'TITULO_RECEBER_LIQ_CTB_CAMB_V' and doc_p.nm_atributo in ('VL_CAMBIAL_ATIVO', 'VL_CAMBIAL_PASSIVO')) then
		select	a.nr_titulo,
			a.nr_seq_conta_banco,
			0 cd_centro_custo,
			a.dt_recebimento,
			'' cd_conta_contabil,
			a.nr_seq_retorno,
			a.nr_seq_ret_item,
			'' cd_conta_deb_pls,
			'' cd_conta_rec_pls,
			(null)::numeric  cd_historico_pls,
			a.nr_seq_movto_trans_fin,
			b.ds_observacao_titulo,
			(null)::numeric  nr_seq_produto,
			(null)::numeric  nr_seq_baixa,
			null nr_seq_nota_credito,
			b.ie_origem_titulo,
			null cd_tipo_recebimento,
			null nr_seq_cobranca,
			a.nr_bordero
		into STRICT	nr_titulo_w,
			nr_seq_conta_banco_w,
			cd_centro_custo_w,
			dt_contabil_tit_w,
			cd_conta_contabil_w,
			nr_seq_retorno_w,
			nr_seq_ret_item_w,
			cd_conta_deb_pls_w,
			cd_conta_rec_pls_w,
			cd_historico_pls_w,
			nr_seq_movto_trans_fin_w,
			ds_observacao_titulo_w,
			nr_seq_produto_w,
			nr_seq_baixa_w,
			nr_seq_nota_credito_w,
			ie_origem_tit_rec_w,
			cd_tipo_recebimento_w,
			nr_seq_cobr_escrit_w,
			nr_bordero_rec_w
		from	titulo_receber			b,
			titulo_receber_liq_ctb_camb_v	a
		where   doc_p.nr_documento	= a.nr_titulo
		and     doc_p.nr_seq_doc_compl	= a.nr_seq_baixa
		and	(a.nr_seq_trans_fin IS NOT NULL AND a.nr_seq_trans_fin::text <> '')
		and	a.nr_titulo		= b.nr_titulo
		and	((ie_permite_estab_dif_w <> 'N') or (b.cd_estabelecimento = doc_p.cd_estabelecimento));

	elsif (doc_p.nm_tabela = 'TITULO_RECEBER' and doc_p.nm_atributo = 'VL_GLOSA' and ie_cc_glosa_w = 'N') then
		select	a.nr_titulo,
			a.nr_seq_conta_banco,
			0 cd_centro_custo,
			a.dt_recebimento,
			'' cd_conta_contabil,
			a.nr_seq_retorno,
			a.nr_seq_ret_item,
			'' cd_conta_deb_pls,
			'' cd_conta_rec_pls,
			(null)::numeric  cd_historico_pls,
			a.nr_seq_movto_trans_fin,
			b.ds_observacao_titulo,
			(null)::numeric  nr_seq_produto,
			a.nr_sequencia nr_seq_baixa,
			null nr_seq_nota_credito,
			b.ie_origem_titulo,
			a.cd_tipo_recebimento,
			a.nr_seq_cobranca,
			a.nr_bordero
		into STRICT	nr_titulo_w,
			nr_seq_conta_banco_w,
			cd_centro_custo_w,
			dt_contabil_tit_w,
			cd_conta_contabil_w,
			nr_seq_retorno_w,
			nr_seq_ret_item_w,
			cd_conta_deb_pls_w,
			cd_conta_rec_pls_w,
			cd_historico_pls_w,
			nr_seq_movto_trans_fin_w,
			ds_observacao_titulo_w,
			nr_seq_produto_w,
			nr_seq_baixa_w,
			nr_seq_nota_credito_w,
			ie_origem_tit_rec_w,
			cd_tipo_recebimento_w,
			nr_seq_cobr_escrit_w,
			nr_bordero_rec_w
		from	titulo_receber_liq	a,
			titulo_receber		b
		where	doc_p.nr_documento 	= a.nr_titulo
		and	doc_p.nr_seq_doc_compl 	= a.nr_sequencia
		and	a.nr_titulo		= b.nr_titulo
		and	((ie_permite_estab_dif_w <> 'N') or (b.cd_estabelecimento = doc_p.cd_estabelecimento))
		and	coalesce(b.nr_seq_mensalidade::text, '') = '';

	elsif (doc_p.nm_tabela = 'TITULO_REC_LIQ_CC' and doc_p.nm_atributo = 'VL_GLOSA' and ie_cc_glosa_w = 'S') then
		select	a.nr_titulo,
			a.nr_seq_conta_banco,
			x.cd_centro_custo,
			a.dt_recebimento,
			x.cd_conta_contabil,
			a.nr_seq_retorno,
			a.nr_seq_ret_item,
			'' cd_conta_deb_pls,
			'' cd_conta_rec_pls,
			(null)::numeric  cd_historico_pls,
			a.nr_seq_movto_trans_fin,
			b.ds_observacao_titulo,
			x.nr_seq_produto,
			a.nr_sequencia nr_seq_baixa,
			null nr_seq_nota_credito,
			b.ie_origem_titulo,
			a.cd_tipo_recebimento,
			a.nr_seq_cobranca,
			a.nr_bordero
		into STRICT	nr_titulo_w,
			nr_seq_conta_banco_w,
			cd_centro_custo_w,
			dt_contabil_tit_w,
			cd_conta_contabil_w,
			nr_seq_retorno_w,
			nr_seq_ret_item_w,
			cd_conta_deb_pls_w,
			cd_conta_rec_pls_w,
			cd_historico_pls_w,
			nr_seq_movto_trans_fin_w,
			ds_observacao_titulo_w,
			nr_seq_produto_w,
			nr_seq_baixa_w,
			nr_seq_nota_credito_w,
			ie_origem_tit_rec_w,
			cd_tipo_recebimento_w,
			nr_seq_cobr_escrit_w,
			nr_bordero_rec_w
		from	titulo_rec_liq_cc	x,
			titulo_receber_liq	a,
			titulo_receber		b
		where	doc_p.nr_documento	= a.nr_titulo
		and	doc_p.nr_seq_doc_compl	= x.nr_seq_baixa
		and	doc_p.nr_doc_analitico	= x.nr_sequencia
		and	a.nr_sequencia		= x.nr_seq_baixa
		and	a.nr_titulo		= x.nr_titulo
		and	a.nr_titulo		= b.nr_titulo
		and	((ie_permite_estab_dif_w <> 'N') or (b.cd_estabelecimento = doc_p.cd_estabelecimento))
		and	coalesce(ie_lib_caixa, 'S')	= 'S'
		and	coalesce(b.nr_seq_mensalidade::text, '') = '';

	elsif (doc_p.nm_tabela = 'TITULO_RECEBER_LIQ' and doc_p.nm_atributo = 'VL_REC_MAIOR') then

		select	a.nr_titulo,
			a.nr_seq_conta_banco,
			0 cd_centro_custo,
			a.dt_recebimento,
			'' cd_conta_contabil,
			a.nr_seq_retorno,
			a.nr_seq_ret_item,
			'' cd_conta_deb_pls,
			'' cd_conta_rec_pls,
			(null)::numeric  cd_historico_pls,
			a.nr_seq_movto_trans_fin,
			b.ds_observacao_titulo,
			(null)::numeric  nr_seq_produto,
			a.nr_sequencia nr_seq_baixa,
			null nr_seq_nota_credito,
			b.ie_origem_titulo,
			a.cd_tipo_recebimento,
			a.nr_seq_cobranca,
			a.nr_bordero
		into STRICT	nr_titulo_w,
			nr_seq_conta_banco_w,
			cd_centro_custo_w,
			dt_contabil_tit_w,
			cd_conta_contabil_w,
			nr_seq_retorno_w,
			nr_seq_ret_item_w,
			cd_conta_deb_pls_w,
			cd_conta_rec_pls_w,
			cd_historico_pls_w,
			nr_seq_movto_trans_fin_w,
			ds_observacao_titulo_w,
			nr_seq_produto_w,
			nr_seq_baixa_w,
			nr_seq_nota_credito_w,
			ie_origem_tit_rec_w,
			cd_tipo_recebimento_w,
			nr_seq_cobr_escrit_w,
			nr_bordero_rec_w
		from	titulo_receber b,
			titulo_receber_liq a
		where	doc_p.nr_documento	= a.nr_titulo
		and	doc_p.nr_seq_doc_compl	= a.nr_sequencia
		and	a.nr_titulo		= b.nr_titulo
		and	((ie_permite_estab_dif_w <> 'N') or (b.cd_estabelecimento = doc_p.cd_estabelecimento));

	elsif (doc_p.nm_tabela = 'TITULO_RECEBER_LIQ' and doc_p.nm_atributo = 'VL_PERDAS') then
		select	a.nr_titulo,
			a.nr_seq_conta_banco,
			0 cd_centro_custo,
			a.dt_recebimento,
			'' cd_conta_contabil,
			a.nr_seq_retorno,
			a.nr_seq_ret_item,
			'' cd_conta_deb_pls,
			'' cd_conta_rec_pls,
			(null)::numeric  cd_historico_pls,
			a.nr_seq_movto_trans_fin,
			b.ds_observacao_titulo,
			(null)::numeric  nr_seq_produto,
			a.nr_sequencia nr_seq_baixa,
			null nr_seq_nota_credito,
			b.ie_origem_titulo,
			a.cd_tipo_recebimento,
			a.nr_seq_cobranca,
			a.nr_bordero
		into STRICT	nr_titulo_w,
			nr_seq_conta_banco_w,
			cd_centro_custo_w,
			dt_contabil_tit_w,
			cd_conta_contabil_w,
			nr_seq_retorno_w,
			nr_seq_ret_item_w,
			cd_conta_deb_pls_w,
			cd_conta_rec_pls_w,
			cd_historico_pls_w,
			nr_seq_movto_trans_fin_w,
			ds_observacao_titulo_w,
			nr_seq_produto_w,
			nr_seq_baixa_w,
			nr_seq_nota_credito_w,
			ie_origem_tit_rec_w,
			cd_tipo_recebimento_w,
			nr_seq_cobr_escrit_w,
			nr_bordero_rec_w
		from	titulo_receber_liq	a,
			titulo_receber		b
		where	doc_p.nr_documento	= a.nr_titulo
		and	doc_p.nr_seq_doc_compl	= a.nr_sequencia
		and	a.nr_titulo		= b.nr_titulo
		and	((ie_permite_estab_dif_w <> 'N') or (b.cd_estabelecimento = doc_p.cd_estabelecimento))
		and	not exists (	SELECT	1
				from	titulo_rec_liq_cc x
				where	x.nr_titulo		= a.nr_titulo
				and	x.nr_seq_baixa		= a.nr_sequencia
				and	coalesce(x.vl_perdas,0) <> 0);
		
	elsif (doc_p.nm_tabela = 'TITULO_RECEBER_NC' and doc_p.nm_atributo = 'VL_NOTA_CREDITO') then
		select	a.nr_titulo,
			a.nr_seq_conta_banco,
			0 cd_centro_custo,
			a.dt_recebimento,
			'' cd_conta_contabil,
			a.nr_seq_retorno,
			a.nr_seq_ret_item,
			'' cd_conta_deb_pls,
			'' cd_conta_rec_pls,
			(null)::numeric  cd_historico_pls,
			a.nr_seq_movto_trans_fin,
			b.ds_observacao_titulo,
			(null)::numeric  nr_seq_produto,
			a.nr_sequencia nr_seq_baixa,
			c.nr_seq_nota_credito,
			b.ie_origem_titulo,
			a.cd_tipo_recebimento,
			a.nr_seq_cobranca,
			a.nr_bordero
		into STRICT	nr_titulo_w,
			nr_seq_conta_banco_w,
			cd_centro_custo_w,
			dt_contabil_tit_w,
			cd_conta_contabil_w,
			nr_seq_retorno_w,
			nr_seq_ret_item_w,
			cd_conta_deb_pls_w,
			cd_conta_rec_pls_w,
			cd_historico_pls_w,
			nr_seq_movto_trans_fin_w,
			ds_observacao_titulo_w,
			nr_seq_produto_w,
			nr_seq_baixa_w,
			nr_seq_nota_credito_w,
			ie_origem_tit_rec_w,
			cd_tipo_recebimento_w,
			nr_seq_cobr_escrit_w,
			nr_bordero_rec_w
		from	titulo_receber_liq	a,
			titulo_receber_nc	c,
			titulo_receber		b
		where	doc_p.nr_documento	= a.nr_titulo
		and	doc_p.nr_seq_doc_compl	= a.nr_sequencia
		and	doc_p.nr_doc_analitico 	= c.nr_sequencia
		and	a.nr_titulo		= c.nr_titulo_rec
		and	a.nr_sequencia		= c.nr_seq_liq
		and	a.nr_titulo		= b.nr_titulo
		and	coalesce(ie_lib_caixa, 'S')	= 'S'
		and	((ie_permite_estab_dif_w <> 'N') or (b.cd_estabelecimento = doc_p.cd_estabelecimento));
	
	elsif (doc_p.nm_tabela = 'TITULO_RECEBER_TRIB_BAIXA' and doc_p.nm_atributo = 'VL_TRIB_TIT_REC') then
		select	a.nr_titulo,
			a.nr_seq_conta_banco,
			0 cd_centro_custo,
			a.dt_recebimento,
			'' cd_conta_contabil,
			a.nr_seq_retorno,
			a.nr_seq_ret_item,
			'' cd_conta_deb_pls,
			'' cd_conta_rec_pls,
			(null)::numeric  cd_historico_pls,
			a.nr_seq_movto_trans_fin,
			b.ds_observacao_titulo,
			(null)::numeric  nr_seq_produto,
			a.nr_sequencia nr_seq_baixa,
			null nr_seq_nota_credito,
			b.ie_origem_titulo,
			a.cd_tipo_recebimento,
			a.nr_seq_cobranca,
			a.nr_bordero
		into STRICT	nr_titulo_w,
			nr_seq_conta_banco_w,
			cd_centro_custo_w,
			dt_contabil_tit_w,
			cd_conta_contabil_w,
			nr_seq_retorno_w,
			nr_seq_ret_item_w,
			cd_conta_deb_pls_w,
			cd_conta_rec_pls_w,
			cd_historico_pls_w,
			nr_seq_movto_trans_fin_w,
			ds_observacao_titulo_w,
			nr_seq_produto_w,
			nr_seq_baixa_w,
			nr_seq_nota_credito_w,
			ie_origem_tit_rec_w,
			cd_tipo_recebimento_w,
			nr_seq_cobr_escrit_w,
			nr_bordero_rec_w
		from	titulo_receber_liq		a,
			titulo_receber_trib_baixa	c,
			titulo_receber			b
		where	doc_p.nr_documento	= b.nr_titulo
		and	doc_p.nr_seq_doc_compl 	= a.nr_sequencia
		and	doc_p.nr_doc_analitico	= c.nr_sequencia
		and	a.nr_sequencia		= c.nr_seq_tit_liq
		and	a.nr_titulo		= c.nr_titulo
		and	a.nr_titulo		= b.nr_titulo
		and	((ie_permite_estab_dif_w <> 'N') or (b.cd_estabelecimento = doc_p.cd_estabelecimento))
		and	coalesce(a.ie_lib_caixa, 'S')	= 'S';
	
	elsif (doc_p.nm_tabela = 'PLS_TITULO_REC_LIQ_MENS' and doc_p.nm_atributo = 'VL_REC_PLS_MENS') then
		select	b.nr_titulo,
			a.nr_seq_conta_banco,
			c.cd_centro_custo,
			c.dt_contabil,
			'' cd_conta_contabil,
			0 nr_seq_retorno,
			0 nr_seq_ret_item,
			c.cd_conta_debito cd_conta_deb_pls,
			c.cd_conta_credito cd_conta_rec_pls,
			c.cd_historico cd_historico_pls,
			0 NR_SEQ_MOVTO_TRANS_FIN,
			b.ds_observacao_titulo,
			(null)::numeric  nr_seq_produto,
			a.nr_sequencia,
			null nr_seq_nota_credito,
			b.ie_origem_titulo,
			a.cd_tipo_recebimento,
			a.nr_seq_cobranca,
			a.nr_bordero
		into STRICT	nr_titulo_w,
			nr_seq_conta_banco_w,
			cd_centro_custo_w,
			dt_contabil_tit_w,
			cd_conta_contabil_w,
			nr_seq_retorno_w,
			nr_seq_ret_item_w,
			cd_conta_deb_pls_w,
			cd_conta_rec_pls_w,
			cd_historico_pls_w,
			nr_seq_movto_trans_fin_w,
			ds_observacao_titulo_w,
			nr_seq_produto_w,
			nr_seq_baixa_w,
			nr_seq_nota_credito_w,
			ie_origem_tit_rec_w,
			cd_tipo_recebimento_w,
			nr_seq_cobr_escrit_w,
			nr_bordero_rec_w
		from	pls_titulo_rec_liq_mens		c,
			titulo_receber			b,
			titulo_receber_liq		a
		where	doc_p.nr_documento		= b.nr_titulo
		and	doc_p.nr_seq_doc_compl		= a.nr_sequencia
		and	doc_p.nr_doc_analitico		= c.nr_sequencia
		and	a.nr_titulo			= b.nr_titulo
		and	a.nr_titulo			= c.nr_titulo
		and	a.nr_sequencia			= c.nr_seq_baixa;
	
	elsif (doc_p.nm_tabela = 'TITULO_REC_LIQ_CC' and doc_p.nm_atributo = 'VL_PERDAS') then
		select	a.nr_titulo,
			a.nr_seq_conta_banco,
			coalesce(c.cd_centro_custo,0),
			a.dt_recebimento,
			coalesce(c.cd_conta_contabil,''),
			a.nr_seq_retorno,
			a.nr_seq_ret_item,
			'' cd_conta_deb_pls,
			'' cd_conta_rec_pls,
			(null)::numeric  cd_historico_pls,
			a.nr_seq_movto_trans_fin,
			b.ds_observacao_titulo,
			coalesce(c.nr_seq_produto,(NULL)::numeric ),
			a.nr_sequencia nr_seq_baixa,
			null nr_seq_nota_credito,
			b.ie_origem_titulo,
			a.cd_tipo_recebimento,
			a.nr_seq_cobranca,
			a.nr_bordero
		into STRICT	nr_titulo_w,
			nr_seq_conta_banco_w,
			cd_centro_custo_w,
			dt_contabil_tit_w,
			cd_conta_contabil_w,
			nr_seq_retorno_w,
			nr_seq_ret_item_w,
			cd_conta_deb_pls_w,
			cd_conta_rec_pls_w,
			cd_historico_pls_w,
			nr_seq_movto_trans_fin_w,
			ds_observacao_titulo_w,
			nr_seq_produto_w,
			nr_seq_baixa_w,
			nr_seq_nota_credito_w,
			ie_origem_tit_rec_w,
			cd_tipo_recebimento_w,
			nr_seq_cobr_escrit_w,
			nr_bordero_rec_w
		from	titulo_rec_liq_cc c,
			titulo_receber b,
			titulo_receber_liq a
		where	doc_p.nr_documento 	= c.nr_titulo
		and	doc_p.nr_seq_doc_compl 	= c.nr_seq_baixa
		and 	doc_p.nr_doc_analitico	= c.nr_sequencia
		and	a.nr_titulo		= b.nr_titulo
		and	a.nr_titulo		= c.nr_titulo
		and	a.nr_sequencia		= c.nr_seq_baixa
		and	((ie_permite_estab_dif_w <> 'N') or (b.cd_estabelecimento	= doc_p.cd_estabelecimento))
		and	coalesce(ie_lib_caixa, 'S') = 'S';
	end if;
	exception when no_data_found then
	/* Salva a inconsistencia: "Nao foi possivel identificar o movimento de origem." */

	select 	obter_desc_expressao(950251)
	into STRICT	doc_p.ds_inconsistencia
	;
	return;
	end;

	/* Informacoes presentes no doc_p */

	dados_contab_w.dt_movimento             := doc_p.dt_competencia;
	dados_contab_w.cd_tipo_lote_contabil    := doc_p.cd_tipo_lote_contabil;
	dados_contab_w.cd_estabelecimento       := doc_p.cd_estabelecimento;
	dados_contab_w.vl_movimento		:= doc_p.vl_movimento;
	dados_contab_w.nm_tabela		:= doc_p.nm_tabela;
	dados_contab_w.nr_documento		:= doc_p.nr_documento;
	dados_contab_w.nr_seq_doc_compl		:= doc_p.nr_seq_doc_compl;
	dados_contab_w.nr_doc_analitico		:= doc_p.nr_doc_analitico;
	dados_contab_w.nr_seq_info_ctb		:= doc_p.nr_seq_info;

	/* Numero da transacao financeira */

	dados_contab_w.nr_seq_trans_fin		:= doc_p.nr_seq_trans_financ;
	
	/* Sequencia de agrupamento */

	nm_agrupador_w := coalesce(trim(both obter_agrupador_contabil(39)), 'NR_TITULO');
	dados_contab_w.nr_seq_agrupamento	:= nr_titulo_w; -- Valor padrao
	if (nm_agrupador_w = 'NR_TITULO') then
		dados_contab_w.nr_seq_agrupamento	:= nr_titulo_w;
	end if;

	dt_contabil_w	:= dt_contabil_tit_w;
	ie_tipo_conta_glosa_w	:= 'G';

	if (doc_p.nm_atributo = 'VL_GLOSA') then
		ie_tipo_conta_glosa_w	:= 'G';
		
		if (ie_dt_contab_glosa_w = 'F') then
			select	max(dt_fechamento)
			into STRICT	dt_contabil_w
			from	convenio_retorno
			where	nr_sequencia	= nr_seq_retorno_w;
		end if;
	end if;

	/* Obtem informacoes a partir do titulo, utilizadas no complemento historico e na contabilizacao*/

	select	max(a.cd_cgc),
		max(nr_interno_conta),
		max(nr_seq_protocolo),
		max(somente_numero(a.nr_nota_fiscal)),
		max(a.cd_pessoa_fisica),
		max(a.cd_estabelecimento),
		max(a.nr_seq_negociacao_origem)
	into STRICT	cd_cgc_w,
		nr_interno_conta_w,
		nr_seq_protocolo_w,
		nr_nota_fiscal_w,
		cd_pessoa_fisica_w,
		cd_estab_titulo_w,
		nr_seq_negociacao_w
	from	titulo_receber a
	where	nr_titulo	= nr_titulo_w;

	begin
		ds_devedor_w	:= substr(obter_nome_pf_pj(cd_pessoa_fisica_w, cd_cgc_w),1,80);
	exception
	when others then
		ds_devedor_w	:= null;
	end;

	if (coalesce(nr_interno_conta_w,0) > 0) then
		select	max(cd_cgc),
			max(b.cd_convenio)
		into STRICT	cd_cgc_w,
			cd_convenio_w
		from	convenio b,
			Conta_paciente a
		where	a.nr_interno_conta	= nr_interno_conta_w
		and	a.cd_convenio_parametro	= b.cd_convenio;
	elsif (coalesce(nr_seq_protocolo_w,0) > 0) then
		select	max(cd_cgc),
			max(b.cd_convenio)
		into STRICT	cd_cgc_w,
			cd_convenio_w
		from	convenio b,
			Protocolo_convenio a
		where	a.nr_seq_protocolo	= nr_seq_protocolo_w
		and	a.cd_convenio		= b.cd_convenio;
	end if;

	dados_contab_w.cd_cnpj		:= cd_cgc_w;
	dados_contab_w.cd_pessoa_fisica	:= cd_pessoa_fisica_w;

	/* Obtem informacoes referentes a glosa. Utilizado no complemento historico, e na chamada a contabiliza_trans_financ*/

	if (coalesce(nr_seq_ret_item_w,0) <> 0) then
		select	count(1)
		into STRICT	qt_glosa_terceiro_w
		from	trans_financ_contab	b,
			transacao_financeira	a
		where	a.nr_sequencia		= b.nr_seq_trans_financ
		and	b.ie_regra_conta	= 'CVT'
		and	a.nr_sequencia		= doc_p.nr_seq_trans_financ  LIMIT 1;
		
		if (qt_glosa_terceiro_w > 0) then
			select	count(1)
			into STRICT	qt_glosa_terceiro_w
			from	procedimento_repasse d,
				procedimento_paciente c,
				convenio_retorno_glosa b,
				convenio_retorno_item a
			where	a.nr_sequencia		= nr_seq_ret_item_w
			and	a.nr_sequencia		= b.nr_seq_ret_item
			and	b.nr_seq_propaci_partic	= c.nr_sequencia
			and	c.nr_sequencia		= d.nr_seq_procedimento  LIMIT 1;
			
			if (qt_glosa_terceiro_w > 0) then
				ie_tipo_conta_glosa_w	:= 'GT';
			end if;
		end if;

		select	max(nr_seq_receb)
		into STRICT	nr_seq_receb_w
		from	convenio_ret_receb
		where	nr_seq_retorno	= nr_seq_retorno_w;
		
		ds_recebimentos_w	:= substr(obter_retorno_receb_dados(nr_seq_retorno_w, 1),1,100);
	end if;

	select	max(a.nr_seq_movto_pend)
	into STRICT	nr_seq_movto_bco_pend_w
	from	movto_banco_pend_baixa a
	where	a.nr_titulo	= nr_titulo_w
	and	a.nr_seq_baixa	= nr_seq_baixa_w;
	
	if (coalesce(nr_seq_movto_bco_pend_w::text, '') = '') then
		if (coalesce(nr_bordero_rec_w,0) <> 0) then
			select	max(a.nr_seq_movto_pend)
			into STRICT	nr_seq_movto_bco_pend_w
			from	movto_banco_pend_baixa a
			where	a.nr_bordero_rec	= nr_bordero_rec_w;
		end if;
		
		if (coalesce(nr_seq_movto_bco_pend_w::text, '') = '') then
			select	max(a.nr_seq_movto_pend)
			into STRICT	nr_seq_movto_bco_pend_w
			from	movto_banco_pend_baixa a
			where	a.nr_seq_conv_receb	= nr_seq_receb_w;
		end if;
	end if;
	begin
	nr_nfe_imp_w	:= substr(obter_dados_titulo_receber(nr_titulo_w,'NE'),1,100);
	exception when others then
	nr_nfe_imp_w 	:= null;
	end;
	/* Neste lote, so ira verificar se deve montar o complemento historico no momento da chamada a rotina obter_compl_historico, pois as mesmas
	informacoes tambem sao utilizadas para contabilizar a transacao financeira.*/
	ds_conteudo_w	:= substr(	cd_cgc_w			||'#@'||
					ds_devedor_w			||'#@'||
					cd_estab_titulo_w		||'#@'||
					ds_recebimentos_w		||'#@'||
					nr_seq_receb_w			||'#@'||
					nr_bordero_rec_w		||'#@'||
					doc_p.dt_competencia		||'#@'||
					nr_nota_fiscal_w		||'#@'||
					nr_titulo_w			||'#@'||
					ds_observacao_titulo_w		||'#@'||
					nr_seq_cobr_escrit_w		||'#@'||
					nr_seq_negociacao_w		||'#@'||
					nr_seq_movto_bco_pend_w		||'#@'||
					nr_seq_nota_credito_w		||'#@'||
					nr_nfe_imp_w,1, 4000);

	/* Contabilizacao para o atributo 'VL_REC_PLS_MENS' */

	if 	((cd_conta_rec_pls_w <> 'X' or cd_conta_deb_pls_w <> 'X') and cd_historico_pls_w <> 0) then
		/* Contabilizacao aqui ocorre apenas para o atributo VL_REC_PLS_MENS*/

		if (doc_p.nm_atributo = 'VL_REC_PLS_MENS') then
			if (trunc(clock_timestamp(), 'dd') = trunc(doc_p.dt_competencia, 'dd')) then		

				dados_contab_w.cd_historico 	:= cd_historico_pls_w;
				dados_contab_w.cd_centro_custo	:= null;

				/* Verifica se existe algum atributo cadastrado para aquele historico, levando em consideracao o tipo de lote contabil e estabelecimento/empresa */

				select  count(1)
				into STRICT    qt_atrib_hist_pad_w
				from    historico_padrao_atributo   c,
					historico_padrao            b,
					estabelecimento             a
				where   a.cd_estabelecimento    = doc_p.cd_estabelecimento
				and     a.cd_empresa            = b.cd_empresa
				and     b.cd_historico          = c.cd_historico
				and     c.cd_historico          = dados_contab_w.cd_historico
				and     c.cd_tipo_lote_contabil = doc_p.cd_tipo_lote_contabil;

				if (qt_atrib_hist_pad_w > 0) then
					begin
					ds_compl_historico_w	:= substr(obter_compl_historico(doc_p.cd_tipo_lote_contabil, dados_contab_w.cd_historico, ds_conteudo_w),1,255);
					exception
					when others then
						ds_compl_historico_w	:= null;
					end;
					dados_contab_w.ds_compl_historico := substr(ds_compl_historico_w,1,255);
				end if;

				if (cd_conta_deb_pls_w <> 'X') then
					dados_contab_w.cd_conta_deb := cd_conta_deb_pls_w;
				elsif (cd_conta_rec_pls_w <> 'X') then
					dados_contab_w.cd_conta_cred := cd_conta_rec_pls_w;
				end if;

				dados_contab_w.ie_transitorio 		:= 'N';
				dados_contab_w.ie_origem_documento 	:= 1;
				dados_contab_w.nm_atributo		:= 'VL_LANCAMENTO';
				dados_contab_w := pls_contab_onl_lote_fin_pck.contabiliza_movimento(dados_contab_w, nm_usuario_p);

				doc_p.nr_lote_contabil := dados_contab_w.nr_lote_contabil;
				if (coalesce(doc_p.nr_lote_contabil, 0) <> 0) then
					update	pls_titulo_rec_liq_mens
					set	nr_lote_contabil 	= doc_p.nr_lote_contabil
					where	nr_titulo		= doc_p.nr_documento
					and	nr_seq_baixa		= doc_p.nr_seq_doc_compl
					and	nr_sequencia		= doc_p.nr_doc_analitico;
				end if;
			end if;
		end if;
	end if;

	/* Contabilizacao para os demais atributos */

	if (doc_p.nm_atributo <> 'VL_REC_PLS_MENS') then
		select	max(nr_seq_caixa),
			max(nr_seq_caixa_od)
		into STRICT	nr_seq_caixa_w,
			nr_seq_caixa_od_w
		from	movto_trans_financ
		where	nr_sequencia	= nr_seq_movto_trans_fin_w;

		if (ie_permite_estab_dif_w <> 'PCCT') then
			cd_estab_titulo_w	:= null;
		end if;

		if (doc_p.nm_atributo = 'VL_DESCONTOS') and (ie_origem_tit_rec_w = 3) then
			
			select	max(a.ie_segmentacao)
			into STRICT	ie_segmentacao_w
			from	pls_plano a,
				pls_segurado b,
				pls_mensalidade_segurado c,
				pls_mensalidade d,
				titulo_receber e
			where	a.nr_sequencia	= b.nr_seq_plano
			and	b.nr_sequencia	= c.nr_seq_segurado
			and	d.nr_sequencia	= c.nr_seq_mensalidade
			and	d.nr_sequencia	= e.nr_seq_mensalidade
			and	e.nr_titulo	= nr_titulo_w;
			
			select	max(c.cd_conta_contabil)
			into STRICT	cd_conta_codificacao_w
			from	pls_contab_versao a,
				pls_contab_codificacao b,
				pls_contab_codific_item c
			where	a.nr_sequencia		= b.nr_seq_versao_contab
			and	b.nr_sequencia		= c.nr_seq_codificacao
			and	dt_contabil_w between a.dt_inicio_vigencia and coalesce(a.dt_fim_vigencia,dt_contabil_w)
			and	b.ie_codificacao	= 'PO'
			and	c.ie_tipo_produto	= CASE WHEN ie_segmentacao_w='4' THEN 'OD'  ELSE 'PS' END;
			
			select	count(*)
			into STRICT	qt_conta_contabil_w
			from	conta_contabil
			where	cd_conta_contabil	= cd_conta_codificacao_w;
			
			if (qt_conta_contabil_w > 0) then
				cd_conta_contabil_w	:= cd_conta_codificacao_w;
			end if;
		end if;

		CALL ctb_online_pck.definir_atrib_compl(doc_p.cd_tipo_lote_contabil);
		CALL ctb_online_pck.set_value_compl_hist('CD_CGC', cd_cgc_w);
		CALL ctb_online_pck.set_value_compl_hist('CD_ESTABELECIMENTO', cd_estab_titulo_w);
		CALL ctb_online_pck.set_value_compl_hist('DS_DEVEDOR', ds_devedor_w);
		CALL ctb_online_pck.set_value_compl_hist('DS_OBSERVACAO', ds_observacao_titulo_w);
		CALL ctb_online_pck.set_value_compl_hist('DS_RECEBIMENTOS', ds_recebimentos_w);
		CALL ctb_online_pck.set_value_compl_hist('DT_RECEBIMENTO', doc_p.dt_competencia);
		CALL ctb_online_pck.set_value_compl_hist('NR_BORDERO_REC',nr_bordero_rec_w );
		CALL ctb_online_pck.set_value_compl_hist('NR_NFE_IMP', nr_nfe_imp_w);
		CALL ctb_online_pck.set_value_compl_hist('NR_NOTA_FISCAL', nr_nota_fiscal_w);
		CALL ctb_online_pck.set_value_compl_hist('NR_SEQ_COBR_ESCRITURAL', nr_seq_cobr_escrit_w);
		CALL ctb_online_pck.set_value_compl_hist('NR_SEQ_MOVTO_BCO_PEND', nr_seq_movto_bco_pend_w);
		CALL ctb_online_pck.set_value_compl_hist('NR_SEQ_NEGOCIACAO', nr_seq_negociacao_w);
		CALL ctb_online_pck.set_value_compl_hist('NR_SEQ_NOTA_CREDITO', nr_seq_nota_credito_w);
		CALL ctb_online_pck.set_value_compl_hist('NR_SEQ_RECEB', nr_seq_receb_w);
		CALL ctb_online_pck.set_value_compl_hist('NR_TITULO', nr_titulo_w);


		dados_contab_tf_w.cd_estab_movto		:= doc_p.cd_estabelecimento;
		dados_contab_tf_w.nr_lote_contabil		:= null;
		dados_contab_tf_w.dt_transacao			:= doc_p.dt_competencia;
		dados_contab_tf_w.cd_conta_contabil		:= cd_conta_contabil_w;
		dados_contab_tf_w.cd_centro_custo		:= cd_centro_custo_w;
		dados_contab_tf_w.nr_seq_agrupamento		:= dados_contab_w.nr_seq_agrupamento;
		dados_contab_tf_w.ie_origem_documento		:= 1;
		dados_contab_tf_w.nr_seq_conta_banco		:= nr_seq_conta_banco_w;
		dados_contab_tf_w.cd_pessoa_fisica		:= cd_pessoa_fisica_w;
		dados_contab_tf_w.cd_cnpj			:= cd_cgc_w;
		dados_contab_tf_w.cd_setor			:= 0;
		dados_contab_tf_w.cd_convenio			:= cd_convenio_w;
		dados_contab_tf_w.nr_seq_caixa			:= nr_seq_caixa_w;
		dados_contab_tf_w.nr_seq_produto		:= nr_seq_produto_w;
		dados_contab_tf_w.nr_seq_caixa_od		:= nr_seq_caixa_od_w;
		dados_contab_tf_w.cd_tributo			:= null;
		dados_contab_tf_w.nr_seq_bandeira		:= null;
		dados_contab_tf_w.cd_tributo_regra		:= null;
		dados_contab_tf_w.ie_origem_tit_rec		:= ie_origem_tit_rec_w;
		dados_contab_tf_w.nr_seq_banco_od		:= null;
		dados_contab_tf_w.ie_tipo_conta_glosa		:= ie_tipo_conta_glosa_w;
		dados_contab_tf_w.nr_seq_proj_rec		:= null;
		dados_contab_tf_w.nr_repasse_terceiro		:= null;
		dados_contab_tf_w.cd_estab_inf_movto		:= null;
		dados_contab_tf_w.cd_tipo_baixa			:= null;
		dados_contab_tf_w.cd_tipo_recebimento		:= cd_tipo_recebimento_w;
		dados_contab_tf_w.nr_titulo_pagar		:= null;
		dados_contab_tf_w.nr_titulo_receber		:= nr_titulo_w;
		dados_contab_tf_w.nr_seq_nota_fiscal		:= null;
		dados_contab_tf_w.nr_seq_trans_fin		:= doc_p.nr_seq_trans_financ;
		dados_contab_tf_w.nm_tabela			:= doc_p.nm_tabela;
		dados_contab_tf_w.nm_atributo			:= doc_p.nm_atributo;
		dados_contab_tf_w.cd_moeda			:= null;
		dados_contab_tf_w.nr_seq_tab_orig		:= doc_p.nr_documento;
		dados_contab_tf_w.doc				:= doc_p;

		ctb_contab_onl_lote_fin_pck.contabiliza_trans_financ(dados_contab_tf_w, nm_usuario_p);

		doc_p 						:= dados_contab_tf_w.doc;
		if (ie_permite_estab_dif_w = 'PCCT') and (coalesce(cd_estab_titulo_w,0) <> 0) and (nr_titulo_w IS NOT NULL AND nr_titulo_w::text <> '') and (cd_conta_transitoria_w IS NOT NULL AND cd_conta_transitoria_w::text <> '') and (cd_estab_titulo_w <> doc_p.cd_estabelecimento) then


			ctb_movimento_w.nr_lote_contabil        := dados_contab_tf_w.nr_lote_contabil;
			ctb_movimento_w.dt_movimento            := dados_contab_tf_w.dt_transacao;
			ctb_movimento_w.ie_origem_documento     := dados_contab_tf_w.ie_origem_documento;
			ctb_movimento_w.nr_seq_agrupamento      := dados_contab_tf_w.nr_seq_agrupamento;
			ctb_movimento_w.vl_movimento            := doc_p.vl_movimento;
			ctb_movimento_w.cd_historico            := ctb_online_pck.get_historico_transit_estab(doc_p.cd_tipo_lote_contabil, doc_p.cd_estabelecimento);
			ctb_movimento_w.nr_documento            := nr_titulo_w;

			/*MOVIMENTO TRANSIToRIO DeBITO*/

			ctb_movimento_w.cd_estabelecimento      := doc_p.cd_estabelecimento;
			ctb_movimento_w.cd_conta_debito         := cd_conta_transitoria_w;
			ctb_movimento_w.cd_conta_credito        := null;
			ctb_movimento_w := ctb_online_pck.ctb_gerar_movto_conta_transit(ctb_movimento_w, nm_usuario_p);

			/*MOVIMENTO TRANSIToRIO CReDITO*/

			ctb_movimento_w.cd_estabelecimento      := cd_estab_titulo_w;
			ctb_movimento_w.cd_conta_credito        := cd_conta_transitoria_w;
			ctb_movimento_w.cd_conta_debito         := null;
			ctb_movimento_w := ctb_online_pck.ctb_gerar_movto_conta_transit(ctb_movimento_w, nm_usuario_p);

		end if;


		if (coalesce(doc_p.nr_lote_contabil, 0) <> 0) then
			if (doc_p.nm_tabela in (	'TITULO_RECEBER_LIQ', 'TITULO_REC_LIQ_CC',
							'TITULO_RECEBER_LIQ_CTB_CAMB_V', 'TITULO_RECEBER_NC',
							'TITULO_RECEBER_TRIB_BAIXA')) then
				update	titulo_receber_liq
				set	nr_lote_contabil	= doc_p.nr_lote_contabil
				where	nr_titulo		= doc_p.nr_documento
				and	nr_sequencia		= doc_p.nr_seq_doc_compl;

			elsif (doc_p.nm_tabela = 'TITULO_RECEBER') then
				update	titulo_receber
				set	nr_lote_contabil 	= doc_p.nr_lote_contabil
				where	nr_titulo		= doc_p.nr_documento;
			end if;

		end if;
	end if;


END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_contab_onl_lote_fin_pck.contab_baixa_mens ( doc_p INOUT ctb_documento, nm_usuario_p text) FROM PUBLIC;
