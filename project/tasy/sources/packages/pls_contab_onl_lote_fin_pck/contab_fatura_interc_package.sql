-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_contab_onl_lote_fin_pck.contab_fatura_interc ( doc_p INOUT ctb_documento, nm_usuario_p text) AS $body$
DECLARE


	dados_contab_tf_w	ctb_contab_onl_lote_fin_pck.dados_contab_tf;
	cd_historico_pls_w	historico_padrao.cd_historico%type;
	nr_seq_fatura_w		ptu_fatura.nr_sequencia%type;
	nr_fatura_w		ptu_fatura.nr_fatura%type;
	nr_titulo_pagar_w	titulo_pagar.nr_titulo%type;
	nr_seq_escrit_w		titulo_pagar_baixa.nr_seq_escrit%type;
	cd_pessoa_fisica_w	titulo_receber.cd_pessoa_fisica%type;
	cd_cgc_w		titulo_receber.cd_cgc%type;
	nr_titulo_w		titulo_receber.nr_titulo%type;
	nr_seq_agrupamento_w	titulo_receber.nr_titulo%type;
	nr_documento_w		titulo_receber.nr_titulo%type;
	cd_tipo_baixa_w		titulo_pagar_baixa.cd_tipo_baixa%type;
	cd_tipo_recebimento_w	titulo_receber_liq.cd_tipo_recebimento%type;
	nr_seq_conta_banco_w	titulo_pagar_baixa.nr_seq_conta_banco%type;
	nr_bordero_w		titulo_pagar_baixa.nr_bordero%type;
	cd_conta_contabil_w	titulo_pagar_baixa_ops.cd_conta_contabil%type;
	nr_titulo_pagar_ww	titulo_pagar.nr_titulo%type;
	nr_titulo_receber_ww	titulo_receber.nr_titulo%type;
	ie_origem_documento_w	integer;
	qt_atrib_hist_pad_w	integer;
	ds_conteudo_w		varchar(4000);
	ds_compl_historico_w	varchar(255);
	nm_agrupador_w		varchar(255);
	ds_pessoa_w		varchar(80);
	ie_receber_pagar_w	varchar(1);

	
BEGIN

	begin
	select	nr_titulo,
		ie_receber_pagar,
		cd_tipo_baixa,
		cd_tipo_recebimento,
		nr_seq_conta_banco,
		nr_bordero,
		nr_seq_escrit,
		cd_conta_contabil
	into STRICT	nr_titulo_w,
		ie_receber_pagar_w,
		cd_tipo_baixa_w,
		cd_tipo_recebimento_w,
		nr_seq_conta_banco_w,
		nr_bordero_w,
		nr_seq_escrit_w,
		cd_conta_contabil_w
	from (	SELECT	a.nr_titulo nr_titulo,
			'R' ie_receber_pagar,
			null cd_tipo_baixa,
			a.cd_tipo_recebimento cd_tipo_recebimento,
			null nr_seq_conta_banco,
			null nr_bordero,
			null nr_seq_escrit,
			null cd_conta_contabil
		from	titulo_rec_liq_cc	c,
			titulo_receber_liq	a,
			titulo_receber		b
		where	a.nr_sequencia		= c.nr_seq_baixa
		and	a.nr_titulo		= b.nr_titulo
		and	b.nr_titulo		= c.nr_titulo
		and	doc_p.nr_documento	= b.nr_titulo
		and	doc_p.nr_seq_doc_compl	= a.nr_sequencia
		and	doc_p.nr_doc_analitico 	= c.nr_sequencia
		and	doc_p.nm_tabela 	= 'TITULO_REC_LIQ_CC'
		and	doc_p.nm_atributo	= 'VL_RECEBIDO'
		group by
			a.nr_titulo,
			a.nr_seq_trans_fin,
			a.cd_tipo_recebimento
		
union all

		SELECT	a.nr_titulo nr_titulo,
			'P' ie_receber_pagar,
			a.cd_tipo_baixa cd_tipo_baixa,
			null cd_tipo_recebimento,
			a.nr_seq_conta_banco nr_seq_conta_banco,
			a.nr_bordero nr_bordero,
			a.nr_seq_escrit nr_seq_escrit,
			null cd_conta_contabil
		from	titulo_pagar		b,
			titulo_pagar_baixa	a
		where	a.nr_titulo		= b.nr_titulo
		and	coalesce(b.ie_status,'D')	= 'D'
		and	doc_p.nr_documento	= b.nr_titulo
		and	doc_p.nr_seq_doc_compl	= a.nr_sequencia
		and	doc_p.nm_tabela		= 'TITULO_PAGAR_BAIXA'
		and	doc_p.nm_atributo	= 'VL_PAGO'
		
union all

		select	a.nr_titulo nr_titulo,
			'R' ie_receber_pagar,
			null cd_tipo_baixa,
			null cd_tipo_recebimento,
			null nr_seq_conta_banco,
			null nr_bordero,
			null nr_seq_escrit,
			null cd_conta_contabil
		from	titulo_receber	a
		where	doc_p.nr_documento	= a.nr_titulo
		and	doc_p.nm_tabela		= 'TITULO_RECEBER'
		and	doc_p.nm_atributo	= 'VL_TITULO_RECEBER'
		
union all

		select	a.nr_titulo nr_titulo,
			'P' ie_receber_pagar,
			a.cd_tipo_baixa cd_tipo_baixa,
			null cd_tipo_recebimento,
			a.nr_seq_conta_banco nr_seq_conta_banco,
			a.nr_bordero nr_bordero,
			a.nr_seq_escrit nr_seq_escrit,
			c.cd_conta_contabil cd_conta_contabil
		from	titulo_pagar_baixa_ops	c,
			titulo_pagar		b,
			titulo_pagar_baixa	a
		where	a.nr_titulo		= b.nr_titulo
		and	a.nr_sequencia		= c.nr_seq_baixa
		and	b.nr_titulo		= c.nr_titulo
		and	doc_p.nr_documento	= b.nr_titulo
		and	doc_p.nr_seq_doc_compl	= a.nr_Sequencia
		and	doc_p.nr_doc_analitico 	= c.nr_sequencia
		and	doc_p.nm_tabela		= 'TITULO_PAGAR_BAIXA_OPS'
		and	doc_p.nm_atributo	in ( 'VL_EVENTO_OPS', 'VL_PAGAMENTO_OPS', 'VL_INTERCAMBIO', 'VL_REEMBOLSO', 'VL_COPARTICIPACAO')) alias2;
	exception when no_data_found then
	/* Salva a inconsistencia: "Nao foi possivel identificar o movimento de origem." */

	select 	obter_desc_expressao(950251)
	into STRICT	doc_p.ds_inconsistencia
	;
	return;
	end;

	/* Sequencia de agrupamento*/

	nm_agrupador_w	:= coalesce(trim(both obter_agrupador_contabil(doc_p.cd_tipo_lote_contabil)),'NR_TITULO_PAGAR');

	if (nm_agrupador_w = 'NR_TITULO_PAGAR') then
		if (ie_receber_pagar_w = 'P') then
			nr_seq_agrupamento_w	:= nr_titulo_w;
		end if;
	elsif (nm_agrupador_w = 'NR_TITULO_RECEBER') then
		if (ie_receber_pagar_w = 'R') then
			nr_seq_agrupamento_w	:= nr_titulo_w;
		end if;
	elsif (nm_agrupador_w = 'NR_FATURA') then
		if (ie_receber_pagar_w = 'P') then
			select	max(nr_fatura)
			into STRICT	nr_fatura_w
			from	ptu_fatura	x
			where	x.nr_titulo	= nr_titulo_w;
			
			nr_seq_agrupamento_w	:= somente_numero(nr_fatura_w);
		end if;
	end if;
	if (coalesce(nr_seq_agrupamento_w, 0) = 0) then
		nr_seq_agrupamento_w	:= nr_titulo_w;
	end if;
	
	/* Informacoes do documento para contabilizar a transacao financeira */

	nr_documento_w		:= nr_titulo_w;
	if (ie_receber_pagar_w = 'P') then
		ie_origem_documento_w	:= 2;
	elsif (ie_receber_pagar_w = 'R') then
		ie_origem_documento_w	:= 3;
	end if;

	/* So deve passar uma das informacoes, salva apenas o numero correto na variavel, permitindo passar as duas variaveis na chamada posterior*/

	select 	CASE WHEN ie_receber_pagar_w='P' THEN  nr_titulo_w  ELSE null END ,
		CASE WHEN ie_receber_pagar_w='R' THEN  nr_titulo_w  ELSE null END
	into STRICT	nr_titulo_pagar_ww,
		nr_titulo_receber_ww
	;

	CALL ctb_online_pck.definir_atrib_compl(doc_p.cd_tipo_lote_contabil);
	
	/* Obtem os atributos e realiza a montagem do complemento historico */

	if (ie_receber_pagar_w = 'R') then
		nr_seq_fatura_w	:= null;
		nr_titulo_pagar_w := null;

		select	a.cd_pessoa_fisica,
			a.cd_cgc
		into STRICT	cd_pessoa_fisica_w,
			cd_cgc_w
		from	titulo_receber a
		where	a.nr_titulo	= nr_titulo_w;
		
		begin
		ds_pessoa_w	:= substr(obter_nome_pf_pj(cd_pessoa_fisica_w, cd_cgc_w),1,80);
		exception
		when others then
			ds_pessoa_w	:= null;
		end;
	elsif (ie_receber_pagar_w = 'P') then
		
		select	a.cd_pessoa_fisica,
			a.cd_cgc
		into STRICT	cd_pessoa_fisica_w,
			cd_cgc_w
		from	titulo_pagar a
		where	a.nr_titulo	= nr_titulo_w;
		
		begin
		ds_pessoa_w	:= substr(obter_nome_pf_pj(cd_pessoa_fisica_w, cd_cgc_w), 1, 80);
		exception
		when others then
			ds_pessoa_w	:= null;
		end;
		
		select	max(nr_sequencia)
		into STRICT	nr_seq_fatura_w
		from	ptu_fatura
		where	nr_titulo	= nr_titulo_w;
		
		nr_titulo_pagar_w	:= nr_titulo_w;
	end if;

	CALL ctb_online_pck.set_value_compl_hist('DS_PESSOA_TITULO_PAGAR', ds_pessoa_w);
	CALL ctb_online_pck.set_value_compl_hist('NR_BORDERO', nr_bordero_w);
	CALL ctb_online_pck.set_value_compl_hist('NR_FATURA', nr_seq_fatura_w);
	CALL ctb_online_pck.set_value_compl_hist('NR_SEQ_ESCRIT', nr_seq_escrit_w);
	CALL ctb_online_pck.set_value_compl_hist('NR_TITULO_PAGAR', nr_titulo_pagar_w);

	dados_contab_tf_w.cd_estab_movto		:= doc_p.cd_estabelecimento;
	dados_contab_tf_w.nr_lote_contabil		:= null;
	dados_contab_tf_w.dt_transacao			:= doc_p.dt_competencia;
	dados_contab_tf_w.cd_conta_contabil		:= cd_conta_contabil_w;
	dados_contab_tf_w.cd_centro_custo		:= null;
	dados_contab_tf_w.nr_seq_agrupamento		:= nr_seq_agrupamento_w;
	dados_contab_tf_w.ie_origem_documento		:= ie_origem_documento_w;
	dados_contab_tf_w.nr_seq_conta_banco		:= nr_seq_conta_banco_w;
	dados_contab_tf_w.cd_pessoa_fisica		:= cd_pessoa_fisica_w;
	dados_contab_tf_w.cd_cnpj			:= cd_cgc_w;
	dados_contab_tf_w.cd_setor			:= null;
	dados_contab_tf_w.cd_convenio			:= null;
	dados_contab_tf_w.nr_seq_caixa			:= null;
	dados_contab_tf_w.nr_seq_produto		:= null;
	dados_contab_tf_w.nr_seq_caixa_od		:= null;
	dados_contab_tf_w.cd_tributo			:= null;
	dados_contab_tf_w.nr_seq_bandeira		:= null;
	dados_contab_tf_w.cd_tributo_regra		:= null;
	dados_contab_tf_w.ie_origem_tit_rec		:= null;
	dados_contab_tf_w.nr_seq_banco_od		:= null;
	dados_contab_tf_w.ie_tipo_conta_glosa		:= null;
	dados_contab_tf_w.nr_seq_proj_rec		:= null;
	dados_contab_tf_w.nr_repasse_terceiro		:= null;
	dados_contab_tf_w.cd_estab_inf_movto		:= null;
	dados_contab_tf_w.cd_tipo_baixa			:= cd_tipo_baixa_w;
	dados_contab_tf_w.cd_tipo_recebimento		:= cd_tipo_recebimento_w;
	dados_contab_tf_w.nr_titulo_pagar		:= nr_titulo_pagar_ww;
	dados_contab_tf_w.nr_titulo_receber		:= nr_titulo_receber_ww;
	dados_contab_tf_w.nr_seq_nota_fiscal		:= null;
	dados_contab_tf_w.nr_seq_trans_fin		:= doc_p.nr_seq_trans_financ;
	dados_contab_tf_w.nm_tabela			:= doc_p.nm_tabela;
	dados_contab_tf_w.nm_atributo			:= doc_p.nm_atributo;
	dados_contab_tf_w.cd_moeda			:= null;
	dados_contab_tf_w.nr_seq_tab_orig		:= doc_p.nr_documento;
	dados_contab_tf_w.doc				:= doc_p;
	
	ctb_contab_onl_lote_fin_pck.contabiliza_trans_financ(dados_contab_tf_w, nm_usuario_p);

	doc_p 						:= dados_contab_tf_w.doc;

	/* Update nos movimentos de origem */

	if (coalesce(doc_p.nr_lote_contabil, 0) <> 0) then
		if (doc_p.nm_tabela = 'TITULO_REC_LIQ_CC') then
			update	titulo_receber_liq
			set	nr_lote_contabil = doc_p.nr_lote_contabil
			where	nr_sequencia	 = doc_p.nr_seq_doc_compl
			and	nr_titulo	 = doc_p.nr_documento;
		elsif (doc_p.nm_tabela = 'TITULO_PAGAR_BAIXA') then
			update	titulo_pagar_baixa
			set	nr_lote_contabil = doc_p.nr_lote_contabil
			where	nr_sequencia	 = doc_p.nr_seq_doc_compl
			and	nr_titulo	 = doc_p.nr_documento;
		elsif (doc_p.nm_tabela = 'TITULO_RECEBER') then
			update	titulo_receber
			set	nr_lote_contabil = doc_p.nr_lote_contabil
			where	nr_titulo	 = doc_p.nr_documento;
		elsif (doc_p.nm_tabela = 'TITULO_PAGAR_BAIXA_OPS') then
			update	titulo_pagar_baixa_ops
			set	nr_lote_contabil = doc_p.nr_lote_contabil
			where	nr_sequencia	 = doc_p.nr_doc_analitico;
		end if;
	end if;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_contab_onl_lote_fin_pck.contab_fatura_interc ( doc_p INOUT ctb_documento, nm_usuario_p text) FROM PUBLIC;
