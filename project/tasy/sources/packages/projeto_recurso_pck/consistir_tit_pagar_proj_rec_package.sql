-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



	--Cons>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>> Verifica se deve ser consistido a entrada de titulo a pagar <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<--		

	/*
	Objetivo: Consistir a criacao de um titulo a pagar caso o projeto recurso nao tenha saldo suficiente para suportar esse titulo.
	Parametros: 
	nr_seq_proj_rec_p = Numero de sequencia do titulo a pagar
	vl_saldo_titulo_p = Valor de saldo do titulo a pagar
	nm_usuario_p = Nome do usuario.
	cd_estabelecimento_p = Codigo do estabelecimento logado pelo usuario.
	*/



CREATE OR REPLACE PROCEDURE projeto_recurso_pck.consistir_tit_pagar_proj_rec ( nr_seq_proj_rec_p bigint, vl_saldo_titulo_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, ie_atualizacao_saldo_p text default null) AS $body$
DECLARE

	
	vl_saldo_proj_rec_w	projeto_recurso_saldo.vl_saldo%type;
	ie_ignora_saldo	varchar(1);
		
	
BEGIN
		obter_param_usuario(851, 251, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_ignora_saldo);
		
		if (coalesce(ie_ignora_saldo,'N') = 'N') and (nr_seq_proj_rec_p > 0) then
			if (ie_atualizacao_saldo_p = 'S') then
				vl_saldo_proj_rec_w := vl_saldo_titulo_p + projeto_recurso_pck.obter_vl_saldo_proj_rec(nr_seq_proj_rec_p, nm_usuario_p, cd_estabelecimento_p);
			else
				vl_saldo_proj_rec_w := projeto_recurso_pck.obter_vl_saldo_proj_rec(nr_seq_proj_rec_p, nm_usuario_p, cd_estabelecimento_p);
			end if;
			
			if ((vl_saldo_proj_rec_w - vl_saldo_titulo_p) < 0) then
				CALL wheb_mensagem_pck.exibir_mensagem_abort(551245,
					'VL_PROJ_REC_W='|| campo_mascara_virgula_casas(projeto_recurso_pck.obter_vl_proj_rec(nr_seq_proj_rec_p),4) ||						
					';VL_TOTAL_REAL_PROJ_REC_W='|| campo_mascara_virgula_casas(projeto_recurso_pck.obter_vl_realizado(nr_seq_proj_rec_p, nm_usuario_p, cd_estabelecimento_p),4) ||
					';VL_TOTAL_COMP_PROJ_REC_W='|| campo_mascara_virgula_casas(projeto_recurso_pck.obter_vl_comprometido(nr_seq_proj_rec_p, nm_usuario_p, cd_estabelecimento_p),4) ||
					';VL_SALDO_PROJ_REC_W='|| campo_mascara_virgula_casas(vl_saldo_proj_rec_w,4) ||
					';VL_TIT_PAGAR_W='|| campo_mascara_virgula_casas(vl_saldo_titulo_p,4));					
				/* O projeto recurso nao possui saldo suficiente para atender esse titulo.
				Valor do projeto: #@VL_PROJ_REC_W#@
				Total realizado: #@VL_TOTAL_REAL_PROJ_REC_W#@
				Total comprometido: #@VL_TOTAL_COMP_PROJ_REC_W#@
				Saldo do projeto: #@VL_SALDO_PROJ_REC_W#@
				Valor deste titulo: #@VL_TIT_PAGAR_W#@.*/
				
			end if;		
		end if;
				
	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE projeto_recurso_pck.consistir_tit_pagar_proj_rec ( nr_seq_proj_rec_p bigint, vl_saldo_titulo_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, ie_atualizacao_saldo_p text default null) FROM PUBLIC;
