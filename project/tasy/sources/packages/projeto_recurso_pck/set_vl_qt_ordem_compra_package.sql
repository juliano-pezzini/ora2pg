-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

	
	--SV>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>> Insere valores  variaveis da ordem de compra <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<--



CREATE OR REPLACE PROCEDURE projeto_recurso_pck.set_vl_qt_ordem_compra ( nr_seq_proj_rec_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE

						
	/* Variavel para retornar a quantidade total de ordens de compra do projeto recurso.*/


	qt_total_ordem_proj_rec		bigint;		
	
	/* Projeto Recurso */
		
	vl_comprometido_proj_rec_w	projeto_recurso_saldo.vl_comprometido%type;

	/* Serve para identificar se o valor comprometido deve ser diminuido do saldo do projeto*/


	ie_considera_vl_compr_saldo_w	parametro_compras.ie_considera_vl_compr_saldo%type;
	
	/* Ordem de Compra */


	nr_ordem_compra_w		ordem_compra.nr_ordem_compra%type;
	
	/* Ordem de Compra */
			
	c02 CURSOR FOR
		SELECT  a.nr_ordem_compra
		from    ordem_compra a
		where   (a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
		and     coalesce(a.nr_seq_motivo_cancel::text, '') = ''
		and		projeto_recurso_pck.obter_ie_comprometido_ordem(nr_seq_proj_rec_p, a.nr_ordem_compra) > 0
		and     exists (SELECT  1
				from    ordem_compra_item b
				where   a.nr_ordem_compra = b.nr_ordem_compra
				and     b.nr_seq_proj_rec = nr_seq_proj_rec_p);
										
		
	
BEGIN
	
	qt_total_ordem_proj_rec := 0;
	vl_comprometido_proj_rec_w := 0;
		
	select 	coalesce(max(ie_considera_vl_compr_saldo),'N')
	into STRICT	ie_considera_vl_compr_saldo_w
	from   	parametro_compras
	where  	cd_estabelecimento = cd_estabelecimento_p;
	
	/*Considera valor comprometido?*/


	if (ie_considera_vl_compr_saldo_w = 'S') then	
	
		/* Ordem de Compra */
	
		open C02;
		loop
		fetch C02 into	
			nr_ordem_compra_w;
		EXIT WHEN NOT FOUND; /* apply on C02 */
			begin
			qt_total_ordem_proj_rec := qt_total_ordem_proj_rec + 1;
			vl_comprometido_proj_rec_w := vl_comprometido_proj_rec_w + projeto_recurso_pck.obter_vl_comprometido_ordem(nr_seq_proj_rec_p,nr_ordem_compra_w);
			end;
		end loop;
		close C02;
	end if;
	
	current_setting('projeto_recurso_pck.ordem_compra_wr')::ordem_compra_ty.qt_transacao := qt_total_ordem_proj_rec;
	current_setting('projeto_recurso_pck.ordem_compra_wr')::ordem_compra_ty.vl_transacao := vl_comprometido_proj_rec_w;
	
	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE projeto_recurso_pck.set_vl_qt_ordem_compra ( nr_seq_proj_rec_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;
