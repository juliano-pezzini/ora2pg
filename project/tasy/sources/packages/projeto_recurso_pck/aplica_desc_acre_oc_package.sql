-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

	
	--VT>>>>>>>>>>>>>>>>>>>> Obter valor total liquido de um item aplicando os descontos e acrescimos da Ordem de Compra <<<<<<<<<<<<<<<<<<<<<<<<<<<<<--

	/*
	Objetivo:Retornar o valor total liquido do item aplicando os descontos e acrescimos da ordem de compra.
	Parametros: 
	nr_ordem_compra_p = Numero de sequencia da ordem de compra
	vl_liq_item_p = Lavor liquido do item da ordem de compra(pode ser obtido atravez da function obter_vl_liq_oci)
	*/



CREATE OR REPLACE FUNCTION projeto_recurso_pck.aplica_desc_acre_oc ( nr_ordem_compra_p bigint, vl_liq_item_p bigint) RETURNS bigint AS $body$
DECLARE

					
	pr_desconto_w			ordem_compra.pr_desconto%type;
	vl_desconto_w			double precision;
	vl_retorno_w			double precision;
	vl_frete_w			ordem_compra.vl_frete%type;
	vl_despesa_acessoria_w		ordem_compra.vl_despesa_acessoria%type;
	vl_seguro_w			ordem_compra.vl_seguro%type;
	vl_desconto_oc_w		ordem_compra.vl_desconto%type;
	ie_frete_w			ordem_compra.ie_frete%type;
	vl_soma_itens_w			double precision;
	vl_despesa_doc_w		ordem_compra.vl_despesa_doc%type;
	
	
BEGIN
	
	pr_desconto_w			:= 0;	
	vl_desconto_w			:= 0;
	vl_retorno_w			:= 0;
	vl_frete_w			:= 0;
	vl_despesa_acessoria_w		:= 0;
	vl_seguro_w			:= 0;
	vl_desconto_oc_w	        := 0;
	ie_frete_w		        := 0;
	vl_soma_itens_w		        := 0;
	vl_despesa_doc_w	        := 0;
	
	select	coalesce(max(pr_desconto),0),
		coalesce(max(ie_frete),'C'),
		coalesce(max(vl_frete),0),
		coalesce(max(vl_despesa_acessoria),0),
		coalesce(max(vl_despesa_doc),0),
		coalesce(max(vl_desconto),0),
		coalesce(max(vl_seguro),0)
	into STRICT	pr_desconto_w,
		ie_frete_w,
		vl_frete_w,
		vl_despesa_acessoria_w,
		vl_despesa_doc_w,
		vl_desconto_oc_w,
		vl_seguro_w
	from	ordem_compra
	where	nr_ordem_compra	= nr_ordem_compra_p;
	
	select	coalesce(sum(Obter_Valor_Liquido_Oci(nr_ordem_compra, nr_item_oci)),0)
	into STRICT	vl_soma_itens_w
	from	ordem_compra_item
	where	nr_ordem_compra = nr_ordem_compra_p
	and	coalesce(dt_reprovacao::text, '') = '';

	
	if (pr_desconto_w > 0) then
		vl_desconto_w	:= (vl_liq_item_p * pr_desconto_w) / 100;
	end if;
	
	vl_retorno_w	:= (vl_liq_item_p - vl_desconto_w) - (dividir_sem_round(vl_desconto_oc_w, vl_soma_itens_w) * vl_liq_item_p);
	
	if (vl_despesa_acessoria_w > 0) then
		vl_retorno_w	:= (vl_retorno_w + (dividir_sem_round(vl_despesa_acessoria_w, vl_soma_itens_w) * vl_liq_item_p));
	end if;

	if (vl_despesa_doc_w > 0) then
		vl_retorno_w	:= (vl_retorno_w + (dividir_sem_round(vl_despesa_doc_w, vl_soma_itens_w) * vl_liq_item_p));
	end if;
	
	if (ie_frete_w	= 'F') then
		vl_retorno_w	:= (vl_retorno_w + (dividir_sem_round(vl_frete_w, vl_soma_itens_w) * vl_liq_item_p));	
	end if;
	
	if (vl_seguro_w > 0) then
		vl_retorno_w	:= (vl_retorno_w + (dividir_sem_round(vl_seguro_w, vl_soma_itens_w) * vl_liq_item_p));
	end if;
	
	return vl_retorno_w;
	
	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION projeto_recurso_pck.aplica_desc_acre_oc ( nr_ordem_compra_p bigint, vl_liq_item_p bigint) FROM PUBLIC;
