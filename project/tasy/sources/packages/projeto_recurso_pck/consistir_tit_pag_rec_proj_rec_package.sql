-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


	
	--Cons>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>> Verifica se deve ser consistindo o estorno do titulo pagar/receber <<<<<<<<<<<<<<<<<<<<<<<<<--

	/*
	Objetivo: Verificar se o titulo a ser estornado esta vinculado a um projeto recurso e se o mesmo esta encerrado
	Parametros : NR_TITULO_P : Numero do titulo
			IE_PAGAR_RECEBER_P: Definir se e titulo a pagar (P) ou titulo a receber (R)
	*/



CREATE OR REPLACE PROCEDURE projeto_recurso_pck.consistir_tit_pag_rec_proj_rec ( nr_titulo_p bigint, ie_pagar_receber_p text ) AS $body$
DECLARE

	
	nr_seq_proj_rec_w		titulo_pagar.nr_seq_proj_rec%type;
	dt_fim_exec_w			projeto_recurso.dt_fim_exec%type;
	ds_projeto_w			projeto_recurso.ds_projeto%type;
	
	
BEGIN
	
	if ( coalesce(nr_titulo_p,0) <> 0 ) then
	
		if (ie_pagar_receber_p = 'P') then
		
			select 	max(a.nr_seq_proj_rec)
			into STRICT	nr_seq_proj_rec_w
			from	titulo_pagar a
			where	a.nr_titulo = nr_titulo_p;
			
			if (coalesce(nr_seq_proj_rec_w,0) <> 0) then
			
				select	max(a.dt_fim_exec),
						substr(max(a.ds_projeto),1,80)
				into STRICT	dt_fim_exec_w,
						ds_projeto_w
				from	projeto_recurso a
				where	a.nr_sequencia = nr_seq_proj_rec_w;
				
				if ((dt_fim_exec_w IS NOT NULL AND dt_fim_exec_w::text <> '')
					and (trunc(dt_fim_exec_w,'dd') < trunc(clock_timestamp(),'dd'))) then
					CALL wheb_mensagem_pck.exibir_mensagem_abort(783648, 'nr_seq_projeto_w='||nr_seq_proj_rec_w||';ds_projeto_w='||ds_projeto_w);
				end if;
			
			end if;

		elsif (ie_pagar_receber_p = 'R') then

			select 	max(a.nr_seq_proj_rec)
			into STRICT	nr_seq_proj_rec_w
			from	titulo_receber a
			where	a.nr_titulo = nr_titulo_p;	

			if (coalesce(nr_seq_proj_rec_w,0) <> 0) then

				select	max(a.dt_fim_exec),
						substr(max(a.ds_projeto),1,80)
				into STRICT	dt_fim_exec_w,
						ds_projeto_w
				from	projeto_recurso a
				where	a.nr_sequencia = nr_seq_proj_rec_w;
				
				if ((dt_fim_exec_w IS NOT NULL AND dt_fim_exec_w::text <> '')
					and (trunc(dt_fim_exec_w,'dd') < trunc(clock_timestamp(),'dd'))) then
					CALL wheb_mensagem_pck.exibir_mensagem_abort(783648, 'nr_seq_projeto_w='||nr_seq_proj_rec_w||';ds_projeto_w='||ds_projeto_w);
				end if;
			
			end if;	
		
		end if;
	
	end if;

	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE projeto_recurso_pck.consistir_tit_pag_rec_proj_rec ( nr_titulo_p bigint, ie_pagar_receber_p text ) FROM PUBLIC;
