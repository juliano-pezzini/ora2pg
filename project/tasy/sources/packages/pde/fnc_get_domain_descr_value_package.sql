-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pde.fnc_get_domain_descr_value (NM_TABELA_P text, NM_ATRIBUTO_P text, IE_DOMINIO_P bigint, CD_VALOR_TASY_P text) RETURNS varchar AS $body$
DECLARE

    CD_DOMINIO_W     TABELA_ATRIBUTO.CD_DOMINIO%TYPE;
    CD_EXP_VALORES_W ONTOLOGIA_TABELA_ATRIBUTO.CD_EXP_VALORES%TYPE;
    DS_VALUE_W       varchar(255);

BEGIN
    IF (coalesce(IE_DOMINIO_P, 0) = 1) THEN
      SELECT MAX(A.CD_DOMINIO)
        INTO STRICT CD_DOMINIO_W
        FROM TABELA_ATRIBUTO A
       WHERE A.NM_TABELA = NM_TABELA_P
         AND A.NM_ATRIBUTO = NM_ATRIBUTO_P;

      DS_VALUE_W := OBTER_DESCRICAO_DOMINIO(CD_DOMINIO_W, CD_VALOR_TASY_P);
    ELSIF (coalesce(IE_DOMINIO_P, 0) = 2) THEN
      SELECT MAX(OTA.CD_EXP_VALORES)
        INTO STRICT CD_EXP_VALORES_W
        FROM RES_CADASTRO_ONTOLOGIA_PHI PHI
        JOIN ONTOLOGIA_TABELA_ATRIBUTO OTA ON (OTA.NM_TABELA =
                                              PHI.NM_TABELA AND
                                              OTA.NM_ATRIBUTO =
                                              PHI.NM_ATRIBUTO)
       WHERE PHI.NM_TABELA = NM_TABELA_P
         AND PHI.NM_ATRIBUTO = NM_ATRIBUTO_P
         AND PHI.CD_VALOR_TASY = CD_VALOR_TASY_P
         AND (OTA.CD_EXP_VALORES IS NOT NULL AND OTA.CD_EXP_VALORES::text <> '');

      IF (coalesce(CD_EXP_VALORES_W, 0) > 0) THEN
        DS_VALUE_W := OBTER_DESC_EXPRESSAO(CD_EXP_VALORES_W);

        IF (trim(both DS_VALUE_W) = 'S,N') THEN
          IF (trim(both CD_VALOR_TASY_P) = 'S') THEN
            DS_VALUE_W := OBTER_DESC_EXPRESSAO(327113);
          ELSIF (trim(both CD_VALOR_TASY_P) = 'N') THEN
            DS_VALUE_W := OBTER_DESC_EXPRESSAO(327114);
          END IF;
        ELSE
          DS_VALUE_W := FNC_VALOR_EXPRESSAO(DS_VALUE_W, CD_VALOR_TASY_P);
        END IF;
      END IF;
    END IF;

    RETURN coalesce(DS_VALUE_W, CD_VALOR_TASY_P);
  EXCEPTION
    WHEN OTHERS THEN
      BEGIN
        CALL PDE.GRAVA_LOG_ERRO('FNC.GET.DOMAIN.DESCR.VALUE.ERROR',
                           'NM_TABELA_P: ' || NM_TABELA_P ||
                           ', NM_ATRIBUTO_P: ' || NM_ATRIBUTO_P ||
                           ', IE_DOMINIO_P: ' || IE_DOMINIO_P ||
                           ', CD_VALOR_TASY_P: ' || CD_VALOR_TASY_P,
                           SQLSTATE,
                           SQLERRM);
        RETURN CD_VALOR_TASY_P;
      END;
  END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pde.fnc_get_domain_descr_value (NM_TABELA_P text, NM_ATRIBUTO_P text, IE_DOMINIO_P bigint, CD_VALOR_TASY_P text) FROM PUBLIC;
