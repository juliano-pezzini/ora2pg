-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pde.prc_patient_finder (IDENTIFIER_P text, TYPE_IN_P CHAR, TYPE_OUT_P CHAR, PATIENT_P INOUT text) AS $body$
DECLARE

    /* TYPE_IN_P / TYPE_OUT_P:
      PF - PESSOA FISICA
      AT - ATENDIMENTO
      PR - PRESCRICAO
      SP - SEQUENCIA PRESCRICAO
    */
BEGIN
    IF TYPE_IN_P = 'PF' AND TYPE_OUT_P = 'AT' THEN
      PATIENT_P := OBTER_ATENDIMENTO_PACIENTE(IDENTIFIER_P,
                                              coalesce(WHEB_USUARIO_PCK.GET_CD_ESTABELECIMENTO,
                                                  1));
    ELSIF TYPE_IN_P = 'AT' AND TYPE_OUT_P = 'PF' THEN
      PATIENT_P := OBTER_PESSOA_ATENDIMENTO(IDENTIFIER_P, 'C');
    ELSIF TYPE_IN_P = 'PR' AND TYPE_OUT_P = 'PF' THEN
      SELECT MAX(CD_PESSOA_FISICA)
        INTO STRICT PATIENT_P
        FROM PRESCR_MEDICA
       WHERE CD_ESTABELECIMENTO =
             coalesce(WHEB_USUARIO_PCK.GET_CD_ESTABELECIMENTO, 1)
         AND NR_PRESCRICAO = (IDENTIFIER_P)::numeric;
    ELSIF TYPE_IN_P = 'PR' AND TYPE_OUT_P = 'AT' THEN
      SELECT MAX(NR_ATENDIMENTO)
        INTO STRICT PATIENT_P
        FROM PRESCR_MEDICA
       WHERE CD_ESTABELECIMENTO =
             coalesce(WHEB_USUARIO_PCK.GET_CD_ESTABELECIMENTO, 1)
         AND NR_PRESCRICAO = (IDENTIFIER_P)::numeric;
    END IF;
  END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pde.prc_patient_finder (IDENTIFIER_P text, TYPE_IN_P CHAR, TYPE_OUT_P CHAR, PATIENT_P INOUT text) FROM PUBLIC;
