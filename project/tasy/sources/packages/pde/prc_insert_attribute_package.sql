-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pde.prc_insert_attribute (NR_SEQ_PDE_MAIN_P bigint, NR_SEQ_PARENT_P bigint, VL_GROUP_DOMAIN_P text, NR_SEQ_ONTOL_TAB_P bigint, NR_SEQ_ONTOL_TAB_ATT_P bigint, NR_SEQ_ONTOL_ATT_GROUP_P bigint, NM_TABLE_P text, NM_ATTRIBUTE_P text, CD_ONTOLOGY_P text, CD_ONTOLOGY2_P text, CD_ONTOLOGY3_P text, CD_ONTOLOGY4_P text, CD_ONTOLOGY5_P text, CD_ONTOLOGY6_P text, CD_ONTOLOGY7_P text, NR_SEQ_RES_CAD_ONT_P bigint, NM_USER_P text, NR_NEW_SEQUENCE_P INOUT bigint) AS $body$
DECLARE

    NM_TABLE_W               PDE_ATTRIBUTE.NM_TABELA%TYPE;
    NM_ATTRIBUTE_W           PDE_ATTRIBUTE.NM_ATRIBUTO%TYPE;
    CD_EXP_TABLE_GROUP_W     PDE_ATTRIBUTE.CD_EXP_TABELA_GRUPO%TYPE;
    CD_EXP_TABLE_W           PDE_ATTRIBUTE.CD_EXP_TABELA%TYPE;
    CD_EXP_ATTRIBUTE_GROUP_W PDE_ATTRIBUTE.CD_EXP_ATRIBUTO_GRUPO%TYPE;
    CD_EXP_ATTRIBUTE_W       PDE_ATTRIBUTE.CD_EXP_ATRIBUTO%TYPE;
    IE_DOMAIN_W              PDE_ATTRIBUTE.IE_DOMINIO%TYPE := 0;
    NM_TABLE_FK_W            PDE_ATTRIBUTE.NM_TABELA_FK%TYPE;
    VALID_ATTRIB_W           PDE_ATTRIBUTE.NR_SEQUENCIA%TYPE;
    NM_TABELA_SUP_W          ONTOLOGIA_TABELA.NM_TABELA_SUP%TYPE;
    NM_FK_TABELA_SUP_W       ONTOLOGIA_TABELA.NM_FK_TABELA_SUP%TYPE;

  X RECORD;

BEGIN
    IF (VL_GROUP_DOMAIN_P IS NOT NULL AND VL_GROUP_DOMAIN_P::text <> '') THEN
      SELECT CD_EXP_VALOR_DOMINIO
        INTO STRICT CD_EXP_TABLE_GROUP_W
        FROM VALOR_DOMINIO_V D
       WHERE D.CD_DOMINIO = 9781
         AND D.VL_DOMINIO = VL_GROUP_DOMAIN_P;
    END IF;

    IF (NR_SEQ_ONTOL_TAB_P IS NOT NULL AND NR_SEQ_ONTOL_TAB_P::text <> '') THEN
      SELECT NM_TABELA, CD_EXP_CADASTRO
        INTO STRICT NM_TABLE_W, CD_EXP_TABLE_W
        FROM ONTOLOGIA_TABELA
       WHERE NR_SEQUENCIA = NR_SEQ_ONTOL_TAB_P;
    END IF;

    IF (NR_SEQ_ONTOL_TAB_ATT_P IS NOT NULL AND NR_SEQ_ONTOL_TAB_ATT_P::text <> '') THEN
      SELECT NM_ATRIBUTO, CD_EXP_DESC
        INTO STRICT NM_ATTRIBUTE_W, CD_EXP_ATTRIBUTE_W
        FROM ONTOLOGIA_TABELA_ATRIBUTO
       WHERE NR_SEQUENCIA = NR_SEQ_ONTOL_TAB_ATT_P;

      IE_DOMAIN_W := pde.fnc_get_domain_type(NM_TABLE_W, NM_ATTRIBUTE_W);
    END IF;

    IF (NR_SEQ_ONTOL_ATT_GROUP_P IS NOT NULL AND NR_SEQ_ONTOL_ATT_GROUP_P::text <> '') THEN
      SELECT CD_EXP_ATRIBUTO_GRUPO
        INTO STRICT CD_EXP_ATTRIBUTE_GROUP_W
        FROM ONTOLOGIA_TAB_ATRIB_GRUPO
       WHERE NR_SEQUENCIA = NR_SEQ_ONTOL_ATT_GROUP_P;
    END IF;

    SELECT nextval('pde_attribute_seq') INTO STRICT NR_NEW_SEQUENCE_P;

    IF (NM_TABLE_P IS NOT NULL AND NM_TABLE_P::text <> '') AND (NM_ATTRIBUTE_P IS NOT NULL AND NM_ATTRIBUTE_P::text <> '') THEN
      NM_TABLE_W     := NM_TABLE_P;
      NM_ATTRIBUTE_W := NM_ATTRIBUTE_P;
      SELECT CD_EXP_DESC
        INTO STRICT CD_EXP_ATTRIBUTE_W
        FROM TABELA_ATRIBUTO
       WHERE NM_TABELA = NM_TABLE_P
         AND NM_ATRIBUTO = NM_ATTRIBUTE_P;
    END IF;

    --INSERT MANDATORY ATTRIBUTES
    IF (NM_TABLE_W IS NOT NULL AND NM_TABLE_W::text <> '') AND
       NM_ATTRIBUTE_W NOT IN ('NR_ATENDIMENTO', 'CD_PESSOA_FISICA',
        'NR_PRESCRICAO', 'NR_SEQ_PRESCR') THEN
      CALL pde.prc_insert_atrib_obrig(NR_SEQ_PDE_MAIN_P,
                             VL_GROUP_DOMAIN_P,
                             CD_EXP_TABLE_GROUP_W,
                             CD_EXP_TABLE_W,
                             NM_TABLE_W,
                             NM_ATTRIBUTE_W,
                             NM_USER_P,
                             NR_SEQ_PARENT_P);
    END IF;

    VALID_ATTRIB_W := NULL;

    IF (NM_TABLE_W IS NOT NULL AND NM_TABLE_W::text <> '') AND
       NM_ATTRIBUTE_W IN ('NR_ATENDIMENTO', 'CD_PESSOA_FISICA',
        'NR_PRESCRICAO', 'NR_SEQ_PRESCR') THEN
    
      SELECT MAX(NR_SEQUENCIA)
        INTO STRICT VALID_ATTRIB_W
        FROM PDE_ATTRIBUTE
       WHERE NM_ATRIBUTO = NM_ATTRIBUTE_W
         AND NM_TABELA = NM_TABLE_W;
    END IF;

    IF (NM_TABLE_W IS NOT NULL AND NM_TABLE_W::text <> '') THEN
      SELECT NM_TABELA_SUP, NM_FK_TABELA_SUP
        INTO STRICT NM_TABELA_SUP_W, NM_FK_TABELA_SUP_W
        FROM ONTOLOGIA_TABELA
       WHERE NM_TABELA = NM_TABLE_W;
    END IF;

    IF coalesce(VALID_ATTRIB_W::text, '') = '' THEN
      INSERT INTO PDE_ATTRIBUTE(NR_SEQUENCIA,
         NR_SEQUENCIA_SUP,
         NR_SEQ_PDE_MAIN,
         IE_GRUPO,
         NR_SEQ_ATRIB_GRUPO,
         NM_TABELA,
         NM_ATRIBUTO,
         CD_ONTOLOGIA,
         CD_ONTOLOGIA2,
         CD_ONTOLOGIA3,
         CD_ONTOLOGIA4,
         CD_ONTOLOGIA5,
         CD_ONTOLOGIA6,
         CD_ONTOLOGIA7,
         CD_EXP_TABELA_GRUPO,
         CD_EXP_ATRIBUTO_GRUPO,
         CD_EXP_TABELA,
         CD_EXP_ATRIBUTO,
         IE_SITUACAO,
         IE_DOMINIO,
         IE_ENVIAR,
         NM_TABELA_FK,
         NM_FK_TABELA_FK,
         NR_SEQ_RES_CAD_ONT,
         NM_USUARIO_NREC,
         DT_ATUALIZACAO_NREC,
         NM_USUARIO,
         DT_ATUALIZACAO)
      VALUES (NR_NEW_SEQUENCE_P,
         NR_SEQ_PARENT_P,
         NR_SEQ_PDE_MAIN_P,
         VL_GROUP_DOMAIN_P,
         NR_SEQ_ONTOL_ATT_GROUP_P,
         NM_TABLE_W,
         NM_ATTRIBUTE_W,
         CD_ONTOLOGY_P,
         CD_ONTOLOGY2_P,
         CD_ONTOLOGY3_P,
         CD_ONTOLOGY4_P,
         CD_ONTOLOGY5_P,
         CD_ONTOLOGY6_P,
         CD_ONTOLOGY7_P,
         CD_EXP_TABLE_GROUP_W,
         CD_EXP_ATTRIBUTE_GROUP_W,
         CD_EXP_TABLE_W,
         CD_EXP_ATTRIBUTE_W,
         'A',
         IE_DOMAIN_W,
         'S',
         NM_TABELA_SUP_W,
         NM_FK_TABELA_SUP_W,
         NR_SEQ_RES_CAD_ONT_P,
         NM_USER_P,
         clock_timestamp(),
         NM_USER_P,
         clock_timestamp());
    ELSE
      UPDATE PDE_ATTRIBUTE PA
         SET PA.IE_ENVIAR      = 'S',
             PA.DT_ATUALIZACAO = clock_timestamp(),
             PA.NM_USUARIO     = NM_USER_P
       WHERE PA.NR_SEQUENCIA = VALID_ATTRIB_W;
    END IF;

    FOR X IN (SELECT DISTINCT PA.NR_SEQ_PDE_MAIN
                FROM PDE_ATTRIBUTE PA
               WHERE PA.NM_TABELA = NM_TABLE_W) LOOP
      UPDATE PDE_MAIN PM
         SET PM.IE_STATUS = 'P'
       WHERE PM.NR_SEQUENCIA = X.NR_SEQ_PDE_MAIN;
    END LOOP;
  EXCEPTION
    WHEN OTHERS THEN
      BEGIN
        CALL PDE.GRAVA_LOG_ERRO('INSERT.ATTRIBUTE.ERROR',
                           'NR_SEQ_PDE_MAIN_P: ' || NR_SEQ_PDE_MAIN_P ||
                           ', NR_SEQ_PARENT_P: ' || NR_SEQ_PARENT_P ||
                           ', VL_GROUP_DOMAIN_P: ' || VL_GROUP_DOMAIN_P ||
                           ', NR_SEQ_ONTOL_TAB_P: ' || NR_SEQ_ONTOL_TAB_P ||
                           ', NR_SEQ_ONTOL_TAB_ATT_P: ' ||
                           NR_SEQ_ONTOL_TAB_ATT_P ||
                           ', NR_SEQ_ONTOL_ATT_GROUP_P: ' ||
                           NR_SEQ_ONTOL_ATT_GROUP_P || ', NM_TABLE_P: ' ||
                           NM_TABLE_P || ', NM_ATTRIBUTE_P: ' ||
                           NM_ATTRIBUTE_P || ', CD_ONTOLOGY_P: ' ||
                           CD_ONTOLOGY_P || ', CD_ONTOLOGY2_P: ' ||
                           CD_ONTOLOGY2_P || ', CD_ONTOLOGY3_P: ' ||
                           CD_ONTOLOGY3_P || ', CD_ONTOLOGY4_P: ' ||
                           CD_ONTOLOGY4_P || ', CD_ONTOLOGY5_P: ' ||
                           CD_ONTOLOGY5_P || ', CD_ONTOLOGY6_P: ' ||
                           CD_ONTOLOGY6_P || ', CD_ONTOLOGY7_P: ' ||
                           CD_ONTOLOGY7_P || ', NR_SEQ_RES_CAD_ONT_P: ' ||
                           NR_SEQ_RES_CAD_ONT_P || ', NM_USER_P: ' ||
                           NM_USER_P,
                           SQLSTATE,
                           SQLERRM);

        UPDATE PDE_MAIN PM
           SET PM.IE_STATUS = 'E'
         WHERE PM.NR_SEQUENCIA = NR_SEQ_PDE_MAIN_P;
        COMMIT;
      END;
  END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pde.prc_insert_attribute (NR_SEQ_PDE_MAIN_P bigint, NR_SEQ_PARENT_P bigint, VL_GROUP_DOMAIN_P text, NR_SEQ_ONTOL_TAB_P bigint, NR_SEQ_ONTOL_TAB_ATT_P bigint, NR_SEQ_ONTOL_ATT_GROUP_P bigint, NM_TABLE_P text, NM_ATTRIBUTE_P text, CD_ONTOLOGY_P text, CD_ONTOLOGY2_P text, CD_ONTOLOGY3_P text, CD_ONTOLOGY4_P text, CD_ONTOLOGY5_P text, CD_ONTOLOGY6_P text, CD_ONTOLOGY7_P text, NR_SEQ_RES_CAD_ONT_P bigint, NM_USER_P text, NR_NEW_SEQUENCE_P INOUT bigint) FROM PUBLIC;
