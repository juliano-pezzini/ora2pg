-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pde.save_attribute (NR_SEQ_PDE_ATTRIBUTE_P bigint, NR_SEQ_PDE_MAIN_P bigint, IE_TYPE_P text, NR_SEQ_PARENT_P bigint, VL_GROUP_DOMAIN_P text, NR_SEQ_ONTOL_TAB_P bigint, NR_SEQ_ONTOL_TAB_ATT_P bigint, NR_SEQ_ONTOL_ATT_GROUP_P bigint, NM_USER_P text, NR_NEW_SEQUENCE_P INOUT bigint) AS $body$
DECLARE


    NM_TABLE_W               PDE_ATTRIBUTE.NM_TABELA%TYPE;
    CD_ONTOLOGY_W            PDE_ATTRIBUTE.CD_ONTOLOGIA%TYPE;
    CD_ONTOLOGY2_W           PDE_ATTRIBUTE.CD_ONTOLOGIA2%TYPE;
    CD_ONTOLOGY3_W           PDE_ATTRIBUTE.CD_ONTOLOGIA3%TYPE;
    CD_ONTOLOGY4_W           PDE_ATTRIBUTE.CD_ONTOLOGIA4%TYPE;
    CD_ONTOLOGY5_W           PDE_ATTRIBUTE.CD_ONTOLOGIA5%TYPE;
    CD_ONTOLOGY6_W           PDE_ATTRIBUTE.CD_ONTOLOGIA6%TYPE;
    CD_ONTOLOGY7_W           PDE_ATTRIBUTE.CD_ONTOLOGIA7%TYPE;
    CD_EXP_ATTRIBUTE_GROUP_W PDE_ATTRIBUTE.CD_EXP_ATRIBUTO_GRUPO%TYPE;
    CD_EXP_TABLE_W           PDE_ATTRIBUTE.CD_EXP_TABELA%TYPE;
    CD_EXP_ATTRIBUTE_W       PDE_ATTRIBUTE.CD_EXP_ATRIBUTO%TYPE;
    NR_SEQ_PDE_ATT_CHILD_W   PDE_ATTRIBUTE.NR_SEQUENCIA%TYPE;
    NR_SEQ_RES_CAD_ONT_W     PDE_ATTRIBUTE.NR_SEQ_RES_CAD_ONT%TYPE;

    CUR_ATT_GROUP CURSOR FOR
      SELECT OTA.NR_SEQUENCIA           NR_SEQ_TAB_ATTRIBUTE,
             ONTPHI.CD_VALOR_ONTOLOGIA  CD_ONTOLOGY,
             ONTPHI.CD_VALOR_ONTOLOGIA2 CD_ONTOLOGY2,
             ONTPHI.CD_VALOR_ONTOLOGIA3 CD_ONTOLOGY3,
             ONTPHI.CD_VALOR_ONTOLOGIA4 CD_ONTOLOGY4,
             ONTPHI.CD_VALOR_ONTOLOGIA5 CD_ONTOLOGY5,
             ONTPHI.CD_VALOR_ONTOLOGIA6 CD_ONTOLOGY6,
             ONTPHI.CD_VALOR_ONTOLOGIA7 CD_ONTOLOGY7,
             ONTPHI.NR_SEQUENCIA        NR_SEQ_RES_CAD_ONT
        FROM ONTOLOGIA_TABELA_ATRIBUTO OTA
       INNER JOIN RES_CADASTRO_ONTOLOGIA_PHI ONTPHI ON OTA.NM_TABELA =
                                                       ONTPHI.NM_TABELA
                                                   AND OTA.NM_ATRIBUTO =
                                                       ONTPHI.NM_ATRIBUTO
       WHERE NR_SEQ_ONTOLO_TAB_ATRIB_GRUPO = NR_SEQ_ONTOL_ATT_GROUP_P;

    ROW_ATT_GROUP CUR_ATT_GROUP%ROWTYPE;

BEGIN
    IF (NR_SEQ_ONTOL_TAB_P IS NOT NULL AND NR_SEQ_ONTOL_TAB_P::text <> '') THEN
      SELECT NM_TABELA, CD_EXP_CADASTRO
        INTO STRICT NM_TABLE_W, CD_EXP_TABLE_W
        FROM ONTOLOGIA_TABELA
       WHERE NR_SEQUENCIA = NR_SEQ_ONTOL_TAB_P;
    END IF;

    IF (NR_SEQ_ONTOL_TAB_ATT_P IS NOT NULL AND NR_SEQ_ONTOL_TAB_ATT_P::text <> '') THEN
      SELECT CD_EXP_DESC
        INTO STRICT CD_EXP_ATTRIBUTE_W
        FROM ONTOLOGIA_TABELA_ATRIBUTO
       WHERE NR_SEQUENCIA = NR_SEQ_ONTOL_TAB_ATT_P;
    END IF;

    IF (NR_SEQ_ONTOL_ATT_GROUP_P IS NOT NULL AND NR_SEQ_ONTOL_ATT_GROUP_P::text <> '') THEN
      SELECT CD_EXP_ATRIBUTO_GRUPO
        INTO STRICT CD_EXP_ATTRIBUTE_GROUP_W
        FROM ONTOLOGIA_TAB_ATRIB_GRUPO
       WHERE NR_SEQUENCIA = NR_SEQ_ONTOL_ATT_GROUP_P;
    END IF;

    IF IE_TYPE_P = 'GROUP' THEN
      SELECT * FROM pde.prc_get_ontology_code(NULL, VL_GROUP_DOMAIN_P, IE_TYPE_P, CD_ONTOLOGY_W, CD_ONTOLOGY2_W, CD_ONTOLOGY3_W, CD_ONTOLOGY4_W, CD_ONTOLOGY5_W, CD_ONTOLOGY6_W, CD_ONTOLOGY7_W, NR_SEQ_RES_CAD_ONT_W) INTO STRICT CD_ONTOLOGY_W, CD_ONTOLOGY2_W, CD_ONTOLOGY3_W, CD_ONTOLOGY4_W, CD_ONTOLOGY5_W, CD_ONTOLOGY6_W, CD_ONTOLOGY7_W, NR_SEQ_RES_CAD_ONT_W;

      NR_NEW_SEQUENCE_P := pde.prc_insert_attribute(NR_SEQ_PDE_MAIN_P, NR_SEQ_PARENT_P, VL_GROUP_DOMAIN_P, NR_SEQ_ONTOL_TAB_P, NULL, NR_SEQ_ONTOL_ATT_GROUP_P, NULL, NULL, CD_ONTOLOGY_W, CD_ONTOLOGY2_W, CD_ONTOLOGY3_W, CD_ONTOLOGY4_W, CD_ONTOLOGY5_W, CD_ONTOLOGY6_W, CD_ONTOLOGY7_W, NR_SEQ_RES_CAD_ONT_W, NM_USER_P, NR_NEW_SEQUENCE_P);
    ELSIF IE_TYPE_P = 'TABLE' THEN
      SELECT * FROM pde.prc_get_ontology_code(NR_SEQ_ONTOL_TAB_P, VL_GROUP_DOMAIN_P, IE_TYPE_P, CD_ONTOLOGY_W, CD_ONTOLOGY2_W, CD_ONTOLOGY3_W, CD_ONTOLOGY4_W, CD_ONTOLOGY5_W, CD_ONTOLOGY6_W, CD_ONTOLOGY7_W, NR_SEQ_RES_CAD_ONT_W) INTO STRICT CD_ONTOLOGY_W, CD_ONTOLOGY2_W, CD_ONTOLOGY3_W, CD_ONTOLOGY4_W, CD_ONTOLOGY5_W, CD_ONTOLOGY6_W, CD_ONTOLOGY7_W, NR_SEQ_RES_CAD_ONT_W;

      NR_NEW_SEQUENCE_P := pde.prc_insert_attribute(NR_SEQ_PDE_MAIN_P, NR_SEQ_PARENT_P, VL_GROUP_DOMAIN_P, NR_SEQ_ONTOL_TAB_P, NULL, NR_SEQ_ONTOL_ATT_GROUP_P, NULL, NULL, CD_ONTOLOGY_W, CD_ONTOLOGY2_W, CD_ONTOLOGY3_W, CD_ONTOLOGY4_W, CD_ONTOLOGY5_W, CD_ONTOLOGY6_W, CD_ONTOLOGY7_W, NR_SEQ_RES_CAD_ONT_W, NM_USER_P, NR_NEW_SEQUENCE_P);
    ELSIF IE_TYPE_P = 'ATTRIBUTE_GROUP' THEN
      SELECT * FROM pde.prc_get_ontology_code(TO_CHAR(NR_SEQ_ONTOL_ATT_GROUP_P), VL_GROUP_DOMAIN_P, IE_TYPE_P, CD_ONTOLOGY_W, CD_ONTOLOGY2_W, CD_ONTOLOGY3_W, CD_ONTOLOGY4_W, CD_ONTOLOGY5_W, CD_ONTOLOGY6_W, CD_ONTOLOGY7_W, NR_SEQ_RES_CAD_ONT_W) INTO STRICT CD_ONTOLOGY_W, CD_ONTOLOGY2_W, CD_ONTOLOGY3_W, CD_ONTOLOGY4_W, CD_ONTOLOGY5_W, CD_ONTOLOGY6_W, CD_ONTOLOGY7_W, NR_SEQ_RES_CAD_ONT_W;

      NR_NEW_SEQUENCE_P := pde.prc_insert_attribute(NR_SEQ_PDE_MAIN_P, NR_SEQ_PARENT_P, VL_GROUP_DOMAIN_P, NR_SEQ_ONTOL_TAB_P, NULL, NR_SEQ_ONTOL_ATT_GROUP_P, NULL, NULL, CD_ONTOLOGY_W, CD_ONTOLOGY2_W, CD_ONTOLOGY3_W, CD_ONTOLOGY4_W, CD_ONTOLOGY5_W, CD_ONTOLOGY6_W, CD_ONTOLOGY7_W, NR_SEQ_RES_CAD_ONT_W, NM_USER_P, NR_NEW_SEQUENCE_P);

      OPEN CUR_ATT_GROUP;
      LOOP
        FETCH CUR_ATT_GROUP
          INTO ROW_ATT_GROUP;
        EXIT WHEN NOT FOUND; /* apply on CUR_ATT_GROUP */
        NR_SEQ_PDE_ATT_CHILD_W := pde.prc_insert_attribute(NR_SEQ_PDE_MAIN_P, NR_NEW_SEQUENCE_P, VL_GROUP_DOMAIN_P, NR_SEQ_ONTOL_TAB_P, ROW_ATT_GROUP.NR_SEQ_TAB_ATTRIBUTE, NR_SEQ_ONTOL_ATT_GROUP_P, NULL, NULL, ROW_ATT_GROUP.CD_ONTOLOGY, ROW_ATT_GROUP.CD_ONTOLOGY2, ROW_ATT_GROUP.CD_ONTOLOGY3, ROW_ATT_GROUP.CD_ONTOLOGY4, ROW_ATT_GROUP.CD_ONTOLOGY5, ROW_ATT_GROUP.CD_ONTOLOGY6, ROW_ATT_GROUP.CD_ONTOLOGY7, ROW_ATT_GROUP.NR_SEQ_RES_CAD_ONT, NM_USER_P, NR_SEQ_PDE_ATT_CHILD_W);
      END LOOP;

      CLOSE CUR_ATT_GROUP;
    ELSE
      SELECT * FROM pde.prc_get_ontology_code(TO_CHAR(NR_SEQ_ONTOL_TAB_ATT_P), VL_GROUP_DOMAIN_P, 'ATTRIBUTE', CD_ONTOLOGY_W, CD_ONTOLOGY2_W, CD_ONTOLOGY3_W, CD_ONTOLOGY4_W, CD_ONTOLOGY5_W, CD_ONTOLOGY6_W, CD_ONTOLOGY7_W, NR_SEQ_RES_CAD_ONT_W) INTO STRICT CD_ONTOLOGY_W, CD_ONTOLOGY2_W, CD_ONTOLOGY3_W, CD_ONTOLOGY4_W, CD_ONTOLOGY5_W, CD_ONTOLOGY6_W, CD_ONTOLOGY7_W, NR_SEQ_RES_CAD_ONT_W;

      NR_NEW_SEQUENCE_P := pde.prc_insert_attribute(NR_SEQ_PDE_MAIN_P, NR_SEQ_PARENT_P, VL_GROUP_DOMAIN_P, NR_SEQ_ONTOL_TAB_P, NR_SEQ_ONTOL_TAB_ATT_P, NR_SEQ_ONTOL_ATT_GROUP_P, NULL, NULL, CD_ONTOLOGY_W, CD_ONTOLOGY2_W, CD_ONTOLOGY3_W, CD_ONTOLOGY4_W, CD_ONTOLOGY5_W, CD_ONTOLOGY6_W, CD_ONTOLOGY7_W, NR_SEQ_RES_CAD_ONT_W, NM_USER_P, NR_NEW_SEQUENCE_P);
    END IF;

  EXCEPTION
    WHEN OTHERS THEN
      CALL PDE.GRAVA_LOG_ERRO('SAVE.ATTRIBUTE.ERROR',
                         'NR_SEQ_PDE_ATTRIBUTE_P: ' ||
                         NR_SEQ_PDE_ATTRIBUTE_P || ', NR_SEQ_PDE_MAIN_P: ' ||
                         NR_SEQ_PDE_MAIN_P || ', IE_TYPE_P: ' || IE_TYPE_P ||
                         ', NR_SEQ_PARENT_P: ' || NR_SEQ_PARENT_P ||
                         ', VL_GROUP_DOMAIN_P: ' || VL_GROUP_DOMAIN_P ||
                         ', NR_SEQ_ONTOL_TAB_P: ' || NR_SEQ_ONTOL_TAB_P ||
                         ', NR_SEQ_ONTOL_TAB_ATT_P: ' ||
                         NR_SEQ_ONTOL_TAB_ATT_P ||
                         ', NR_SEQ_ONTOL_ATT_GROUP_P: ' ||
                         NR_SEQ_ONTOL_ATT_GROUP_P || ', NM_USER_P: ' ||
                         NM_USER_P,
                         SQLSTATE,
                         SQLERRM);
  END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pde.save_attribute (NR_SEQ_PDE_ATTRIBUTE_P bigint, NR_SEQ_PDE_MAIN_P bigint, IE_TYPE_P text, NR_SEQ_PARENT_P bigint, VL_GROUP_DOMAIN_P text, NR_SEQ_ONTOL_TAB_P bigint, NR_SEQ_ONTOL_TAB_ATT_P bigint, NR_SEQ_ONTOL_ATT_GROUP_P bigint, NM_USER_P text, NR_NEW_SEQUENCE_P INOUT bigint) FROM PUBLIC;
