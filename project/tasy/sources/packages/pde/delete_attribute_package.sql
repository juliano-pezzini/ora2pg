-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pde.delete_attribute (NR_SEQ_PDE_ATTRIBUTE_P bigint) AS $body$
DECLARE

    NR_SEQ_GROUP_W       PDE_ATTRIBUTE.NR_SEQUENCIA%TYPE;
    NR_SEQ_TABLE_W       PDE_ATTRIBUTE.NR_SEQUENCIA%TYPE;
    QT_ATTRIBUTE_FOUND_W bigint;
    QT_TABLE_FOUND_W     bigint;
    NR_SEQUENCIA_W       PDE_ATTRIBUTE.NR_SEQUENCIA%TYPE;
    VALID_TABLE_W        PDE_ATTRIBUTE.NM_TABELA%TYPE;
    VALID_PDE_MAIN_W     PDE_ATTRIBUTE.NR_SEQ_PDE_MAIN%TYPE;
    VALID_QT_ATRIB_W     bigint;

    CUR_ATT_GROUP_CHILDREN CURSOR FOR
      SELECT NR_SEQUENCIA NR_SEQ_ATTRIBUTE
        FROM PDE_ATTRIBUTE
       WHERE NR_SEQUENCIA_SUP = NR_SEQ_PDE_ATTRIBUTE_P;

    ROW_ATT_GROUP_CHILD CUR_ATT_GROUP_CHILDREN%ROWTYPE;

  X RECORD;

BEGIN
    --VALIDAR TABELA E PDE_MAIN REFERENTES
    SELECT DISTINCT MAX(NR_SEQ_PDE_MAIN), MAX(NM_TABELA)
      INTO STRICT VALID_PDE_MAIN_W, VALID_TABLE_W
      FROM PDE_ATTRIBUTE
     WHERE NR_SEQUENCIA = NR_SEQ_PDE_ATTRIBUTE_P;

    SELECT MAX(GRP.NR_SEQUENCIA) NR_SEQ_GROUP,
           MAX(TBL.NR_SEQUENCIA) NR_SEQ_TABLE
      INTO STRICT NR_SEQ_GROUP_W, NR_SEQ_TABLE_W
      FROM PDE_ATTRIBUTE ATT
      LEFT JOIN PDE_ATTRIBUTE TBL ON ATT.NR_SEQUENCIA_SUP =
                                     TBL.NR_SEQUENCIA
      LEFT JOIN PDE_ATTRIBUTE GRP ON GRP.NR_SEQUENCIA =
                                     TBL.NR_SEQUENCIA_SUP
     WHERE ATT.NR_SEQUENCIA = NR_SEQ_PDE_ATTRIBUTE_P;

    OPEN CUR_ATT_GROUP_CHILDREN;
    LOOP
      FETCH CUR_ATT_GROUP_CHILDREN
        INTO ROW_ATT_GROUP_CHILD;
      EXIT WHEN NOT FOUND; /* apply on CUR_ATT_GROUP_CHILDREN */
      --VERIFICAR SE O ATRIBUTO A SER DELETADO E UM ATRIBUTO OBRIGATORIO.
      SELECT MAX(NR_SEQUENCIA)
        INTO STRICT NR_SEQUENCIA_W
        FROM PDE_ATTRIBUTE
       WHERE NR_SEQUENCIA = ROW_ATT_GROUP_CHILD.NR_SEQ_ATTRIBUTE
         AND NM_ATRIBUTO IN ('NR_ATENDIMENTO', 'CD_PESSOA_FISICA',
              'NR_PRESCRICAO', 'NR_SEQ_PRESCR')
         AND IE_ENVIAR = 'S';
      --CASO NAO, UPDATE DO IE_ENVIAR PARA NAO
      IF (NR_SEQUENCIA_W IS NOT NULL AND NR_SEQUENCIA_W::text <> '') THEN
        UPDATE PDE_ATTRIBUTE
           SET IE_ENVIAR = 'N'
         WHERE NR_SEQUENCIA = NR_SEQUENCIA_W;
      ELSE
        DELETE FROM PDE_ATTRIBUTE
         WHERE NR_SEQUENCIA = ROW_ATT_GROUP_CHILD.NR_SEQ_ATTRIBUTE;
      END IF;
    END LOOP;

    CLOSE CUR_ATT_GROUP_CHILDREN;

    --VERIFICAR SE O ATRIBUTO A SER DELETADO E UM ATRIBUTO OBRIGATORIO.
    SELECT MAX(NR_SEQUENCIA)
      INTO STRICT NR_SEQUENCIA_W
      FROM PDE_ATTRIBUTE
     WHERE NR_SEQUENCIA = NR_SEQ_PDE_ATTRIBUTE_P
       AND NM_ATRIBUTO IN ('NR_ATENDIMENTO', 'CD_PESSOA_FISICA',
            'NR_PRESCRICAO', 'NR_SEQ_PRESCR')
       AND IE_ENVIAR = 'S';
    --FACA UM UPDATE DO IE_ENVIAR PARA N
    IF (NR_SEQUENCIA_W IS NOT NULL AND NR_SEQUENCIA_W::text <> '') THEN
      UPDATE PDE_ATTRIBUTE
         SET IE_ENVIAR = 'N'
       WHERE NR_SEQUENCIA = NR_SEQUENCIA_W;
    ELSE
      DELETE FROM PDE_ATTRIBUTE
       WHERE NR_SEQUENCIA = NR_SEQ_PDE_ATTRIBUTE_P;
    END IF;

    SELECT COUNT(1)
      INTO STRICT QT_ATTRIBUTE_FOUND_W
      FROM PDE_ATTRIBUTE
     WHERE NR_SEQUENCIA_SUP = NR_SEQ_TABLE_W;

    IF QT_ATTRIBUTE_FOUND_W = 0 THEN
      DELETE FROM PDE_ATTRIBUTE WHERE NR_SEQUENCIA = NR_SEQ_TABLE_W;
    END IF;

    SELECT COUNT(1)
      INTO STRICT QT_TABLE_FOUND_W
      FROM PDE_ATTRIBUTE
     WHERE NR_SEQUENCIA_SUP = NR_SEQ_GROUP_W;

    IF QT_TABLE_FOUND_W = 0 THEN
      DELETE FROM PDE_ATTRIBUTE WHERE NR_SEQUENCIA = NR_SEQ_GROUP_W;
    END IF;

    SELECT COUNT(1)
      INTO STRICT VALID_QT_ATRIB_W
      FROM PDE_ATTRIBUTE
     WHERE NM_TABELA = VALID_TABLE_W
       AND (NM_ATRIBUTO IS NOT NULL AND NM_ATRIBUTO::text <> '')
       AND IE_ENVIAR = 'S';

    IF VALID_QT_ATRIB_W = 0 THEN
      DELETE FROM PDE_ATTRIBUTE
       WHERE NR_SEQ_PDE_MAIN = VALID_PDE_MAIN_W
         AND NM_TABELA = VALID_TABLE_W;

      CALL pde.drop_invalid_triggers();
    END IF;

    FOR X IN (SELECT DISTINCT PA.NR_SEQ_PDE_MAIN
                FROM PDE_ATTRIBUTE PA
               WHERE PA.NM_TABELA = VALID_TABLE_W) LOOP
      UPDATE PDE_MAIN PM
         SET PM.IE_STATUS = 'P'
       WHERE PM.NR_SEQUENCIA = X.NR_SEQ_PDE_MAIN;
    END LOOP;

  EXCEPTION
    WHEN OTHERS THEN
      CALL PDE.GRAVA_LOG_ERRO('DELETE.ATTRIBUTE.ERROR',
                         'NR_SEQ_PDE_ATTRIBUTE_P: ' ||
                         NR_SEQ_PDE_ATTRIBUTE_P,
                         SQLSTATE,
                         SQLERRM);
  END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pde.delete_attribute (NR_SEQ_PDE_ATTRIBUTE_P bigint) FROM PUBLIC;
