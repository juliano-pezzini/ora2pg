-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pde.clean_stage () AS $body$
DECLARE

    LIST_ID_W varchar(32767) := '';

  X RECORD;

BEGIN
    FOR X IN (SELECT PL.NR_SEQUENCIA
                FROM PDE_LOG PL
               WHERE (PL.DT_ENVIO IS NOT NULL AND PL.DT_ENVIO::text <> '')
                 AND (PL.DT_JSON IS NOT NULL AND PL.DT_JSON::text <> '')
                 AND TRUNC(PL.DT_ENVIO) <= TRUNC(clock_timestamp() - interval '7 days')) LOOP
      IF ((trim(both LIST_ID_W) IS NOT NULL AND (trim(both LIST_ID_W))::text <> '')) THEN
        LIST_ID_W := LIST_ID_W || ',';
      END IF;

      LIST_ID_W := LIST_ID_W || X.NR_SEQUENCIA;
    END LOOP;

    IF ((trim(both LIST_ID_W) IS NOT NULL AND (trim(both LIST_ID_W))::text <> '')) THEN
      DELETE FROM PDE_STAGE_LOG PSL
       WHERE PSL.NR_SEQ_LOG IN (SELECT V.NR_REGISTRO
                FROM TABLE(LISTA_PCK.OBTER_LISTA(LIST_ID_W)) V);

      DELETE FROM PDE_LOG PL
       WHERE PL.NR_SEQUENCIA IN (SELECT V.NR_REGISTRO
                FROM TABLE(LISTA_PCK.OBTER_LISTA(LIST_ID_W)) V);

      DELETE FROM PDE_STAGE PS
       WHERE PS.NR_SEQUENCIA NOT IN (SELECT DISTINCT PSL.NR_SEQ_STAGE FROM PDE_STAGE_LOG PSL);

      COMMIT;
    END IF;
  EXCEPTION
    WHEN OTHERS THEN
      CALL PDE.GRAVA_LOG_ERRO('CLEAN.STAGE.ERROR',
                         'LIST_ID_W: ' || LIST_ID_W,
                         SQLSTATE,
                         SQLERRM);
  END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pde.clean_stage () FROM PUBLIC;
