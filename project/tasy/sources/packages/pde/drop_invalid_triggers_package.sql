-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pde.drop_invalid_triggers () AS $body$
DECLARE


  D RECORD;

BEGIN
    FOR D IN (SELECT 'DROP TRIGGER ' || UT.TRIGGER_NAME DROP_COMMAND
                FROM USER_TRIGGERS UT
               WHERE UT.TRIGGER_NAME LIKE 'TRG_%_DYN_PDE'
                 AND UT.TRIGGERING_EVENT = 'INSERT OR UPDATE'
                 AND UT.TRIGGER_TYPE LIKE '%AFTER%'
                 AND UT.STATUS = 'ENABLED'
                 AND UT.TABLE_NAME NOT IN (SELECT DISTINCT PA.NM_TABELA FROM PDE_ATTRIBUTE PA)
                 AND NOT EXISTS (SELECT 1
                        FROM OBJETO_SISTEMA OS
                       WHERE UPPER(OS.IE_TIPO_OBJETO) = 'TRIGGER'
                         AND OS.NM_OBJETO = UT.TRIGGER_NAME  LIMIT 1)) LOOP
      BEGIN
        CALL EXEC_SQL_DINAMICO('PDE.dropTrigger', D.DROP_COMMAND);
      EXCEPTION
        WHEN OTHERS THEN
          CALL PDE.GRAVA_LOG_ERRO('DROP.TRIGGERS.ERROR',
                             D.DROP_COMMAND,
                             SQLSTATE,
                             SQLERRM);
      END;
    END LOOP;
  END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pde.drop_invalid_triggers () FROM PUBLIC;
