-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION new_icu_notifications_pck.get_overdue_list (nm_usuario_p text) RETURNS SETOF T_ALERTS_TABLE AS $body$
DECLARE


t_alert_w				t_alert;
cd_pessoa_fisica_w  	varchar(10);
qt_items_w      		bigint := 0;
ie_medico_w      		varchar(1);
cd_perfil_w				perfil.cd_perfil%type;
cd_estabelecimento_w 	estabelecimento.cd_estabelecimento%type;
cd_setor_atendimento_w 	setor_atendimento.cd_setor_atendimento%type;

cEncounter CURSOR FOR
	SELECT a.nr_atendimento,
			 a.cd_pessoa_fisica
	from	atendimento_paciente a
	where   coalesce(a.dt_alta::text, '') = ''
	and		ie_medico_w = 'S' and (a.cd_medico_resp = cd_pessoa_fisica_w)

union all

SELECT x.nr_atendimento,
       x.cd_pessoa_fisica
from (
  select a.nr_atendimento,
         a.cd_pessoa_fisica,
         max(b.nr_sequencia) nr_sequencia
    from	atendimento_paciente a,
          atend_enfermagem_resp b
    where b.nr_atendimento	= a.nr_atendimento
    and coalesce(a.dt_alta::text, '') = ''
    and ie_medico_w = 'N'
   group by a.nr_atendimento, 
            a.cd_pessoa_fisica
) x,
atend_enfermagem_resp y
where x.nr_sequencia	= y.nr_sequencia 
and y.cd_pessoa_fisica = cd_pessoa_fisica_w;

BEGIN

	if (coalesce(new_icu_notifications_pck.get_visualiza_alertas(nm_usuario_p, 'AOI'), 'X') <> 'S') then
		return;
	end if;

	cd_pessoa_fisica_w := obter_codigo_usuario(nm_usuario_p);
	ie_medico_w := obter_se_usuario_medico(nm_usuario_p);
	cd_perfil_w	:= obter_perfil_ativo;
	cd_estabelecimento_w := obter_estabelecimento_ativo;

	for c_encounter_w in cEncounter
	loop

		cd_setor_atendimento_w := Obter_Setor_Atendimento(c_encounter_w.nr_atendimento);

		qt_items_w := new_icu_notifications_pck.get_overdue_items(nm_usuario_p, cd_perfil_w, cd_estabelecimento_w, c_encounter_w.nr_atendimento);

		if (coalesce(qt_items_w, 0) > 0) then
			t_alert_w.ds_titulo := wheb_mensagem_pck.get_texto(1166585,'NM_PACIENTE_P='||obter_nome_paciente(c_encounter_w.nr_atendimento)||';DS_TOTAL_P='||qt_items_w);
			RETURN NEXT t_alert_w;
		end if;
	end loop;

return;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION new_icu_notifications_pck.get_overdue_list (nm_usuario_p text) FROM PUBLIC;
