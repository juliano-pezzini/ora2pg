-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION new_icu_notifications_pck.get_reminders_list ( nm_usuario_p text, cd_perfil_p bigint, cd_estabelecimento_p bigint, nr_atendimento_p bigint ) RETURNS SETOF T_OBJECT_CENTRAL_NOTICES AS $body$
DECLARE


  t_objeto_row_w    t_central_notices;
  cd_pessoa_fisica_w  varchar(10);
  qt_pendencias_w    bigint;
  ds_conteudo_w    varchar(4000);
  ie_medico_w      varchar(1);
  nr_atendimento_w  atendimento_paciente.nr_atendimento%type;

  c01 CURSOR FOR
  SELECT  a.nr_atendimento
  from   atendimento_paciente a
  where   a.nr_atendimento = nr_atendimento_w
  or    ((ie_medico_w = 'S' and (a.cd_medico_resp = cd_pessoa_fisica_w or obter_se_medico_assistente(a.nr_atendimento, cd_pessoa_fisica_w, nm_usuario_p, 36) = 'S'))
  or (ie_medico_w = 'N' and obter_enfermeiro_resp(a.nr_atendimento,'C') = cd_pessoa_fisica_w))
  and   coalesce(a.dt_alta::text, '') = '';


BEGIN

    nr_atendimento_w := 0;

    if (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') then
      nr_atendimento_w := nr_atendimento_p;
    end if;

    cd_pessoa_fisica_w   := obter_codigo_usuario(nm_usuario_p);
    ie_medico_w     := obter_se_usuario_medico(nm_usuario_p);

    for c01_w in c01
    loop

      ds_conteudo_w := '';
      qt_pendencias_w  := new_icu_notifications_pck.get_overdue_items(nm_usuario_p, cd_perfil_p, cd_estabelecimento_p, c01_w.nr_atendimento);
      if (qt_pendencias_w > 0 ) then
        ds_conteudo_w := wheb_mensagem_pck.get_texto(1119579,'DS_TOTAL_P='||'('||qt_pendencias_w||')');
      end if;

      qt_pendencias_w := 0;
      qt_pendencias_w := new_icu_notifications_pck.get_approval_items(c01_w.nr_atendimento);
      if (qt_pendencias_w > 0) then
        if (coalesce(ds_conteudo_w, 'XPTO') <> 'XPTO') then
          ds_conteudo_w := ds_conteudo_w || chr(13) || wheb_mensagem_pck.get_texto(1119580,'DS_TOTAL_P='||'('||qt_pendencias_w||')');
        else
          ds_conteudo_w := wheb_mensagem_pck.get_texto(1119580,'DS_TOTAL_P='||'('||qt_pendencias_w||')');
        end if;
      end if;

      qt_pendencias_w := 0;
      qt_pendencias_w := new_icu_notifications_pck.get_pending_cosign_adm(c01_w.nr_atendimento);
      if (qt_pendencias_w > 0) then
        if (coalesce(ds_conteudo_w, 'XPTO') <> 'XPTO') then
          ds_conteudo_w := ds_conteudo_w || chr(13) || wheb_mensagem_pck.get_texto(1119582,'DS_TOTAL_P='||'('||qt_pendencias_w||')');
        else
          ds_conteudo_w := wheb_mensagem_pck.get_texto(1119582,'DS_TOTAL_P='||'('||qt_pendencias_w||')');
        end if;
      end if;

      qt_pendencias_w := 0;
      qt_pendencias_w := new_icu_notifications_pck.get_pending_verif_items(cd_pessoa_fisica_w, c01_w.nr_atendimento);
      if (qt_pendencias_w > 0) then
        if (coalesce(ds_conteudo_w, 'XPTO') <> 'XPTO') then
          ds_conteudo_w := ds_conteudo_w || chr(13) || wheb_mensagem_pck.get_texto(1119583,'DS_TOTAL_P='||'('||qt_pendencias_w||')');
        else
          ds_conteudo_w := wheb_mensagem_pck.get_texto(1119583,'DS_TOTAL_P='||'('||qt_pendencias_w||')');
        end if;
      end if;

      if (coalesce(ds_conteudo_w, 'XPTO') <> 'XPTO') then
        t_objeto_row_w.ds_titulo       := obter_nome_paciente(c01_w.nr_atendimento);
        t_objeto_row_w.ds_conteudo       := ds_conteudo_w;
        t_objeto_row_w.dt_criacao       := clock_timestamp();
        t_objeto_row_w.nm_usuarios_destino  := nm_usuario_p;
        RETURN NEXT t_objeto_row_w;
      end if;

    end loop;
    return;

  END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION new_icu_notifications_pck.get_reminders_list ( nm_usuario_p text, cd_perfil_p bigint, cd_estabelecimento_p bigint, nr_atendimento_p bigint ) FROM PUBLIC;
