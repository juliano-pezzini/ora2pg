-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION new_icu_notifications_pck.get_approval_details (nm_usuario_p text) RETURNS SETOF T_ALERT_DETAILS_TABLE AS $body$
DECLARE


nr_atendimento_w 	atendimento_paciente.nr_atendimento%type;
t_alert_details_w	t_alert_details;
cd_pessoa_fisica_w 	pessoa_fisica.cd_pessoa_fisica%type;
ie_medico_w 		varchar(1);
cd_perfil_w			perfil.cd_perfil%type;

cEncounter CURSOR FOR
	SELECT  nr_atendimento,
			obter_nome_paciente(nr_atendimento) as nm_paciente,
			cd_pessoa_fisica
	from	atendimento_paciente
	where   coalesce(dt_alta::text, '') = ''
	and (ie_medico_w = 'S' and (cd_medico_resp = cd_pessoa_fisica_w)
	or (ie_medico_w = 'N' and obter_enfermeiro_resp(nr_atendimento,'C') = cd_pessoa_fisica_w));


cApprovalItems CURSOR FOR
	SELECT  dt_inicio as dt_evento,
			obter_desc_material(cd_material) as descricao
	from    cpoe_material
	where   nr_atendimento = nr_atendimento_w
	and     (dt_liberacao_aux IS NOT NULL AND dt_liberacao_aux::text <> '')
	and     coalesce(dt_liberacao::text, '') = ''
	and     ((CASE WHEN coalesce(dt_lib_suspensao::text, '') = '' THEN  coalesce(dt_fim_cih, dt_fim)  ELSE coalesce(dt_suspensao, dt_fim) END  >= clock_timestamp())
	or (CASE WHEN coalesce(dt_lib_suspensao::text, '') = '' THEN  coalesce(dt_fim_cih, dt_fim)  ELSE coalesce(dt_suspensao, dt_fim) coalesce(END::text, '') = ''))
	and     ((cd_medico = cd_pessoa_fisica_w) or (cpoe_verifica_regra_aprovacao(cd_perfil_w, nm_usuario_p, 'AX') = 'S'))
	
union all

	SELECT  dt_inicio as dt_evento,
			cpoe_obter_desc_dieta_simp(nr_sequencia) as descricao
	from    cpoe_dieta
	where   nr_atendimento = nr_atendimento_w
	and     (dt_liberacao_aux IS NOT NULL AND dt_liberacao_aux::text <> '')
	and     coalesce(dt_liberacao::text, '') = ''
	and    	((CASE WHEN coalesce(dt_lib_suspensao::text, '') = '' THEN  dt_fim  ELSE coalesce(dt_suspensao,dt_fim) END  >= clock_timestamp())
	or (CASE WHEN coalesce(dt_lib_suspensao::text, '') = '' THEN  dt_fim  ELSE coalesce(dt_suspensao,dt_fim) coalesce(END::text, '') = ''))
	and     ((cd_medico = cd_pessoa_fisica_w) or (cpoe_verifica_regra_aprovacao(cd_perfil_w, nm_usuario_p, 'AX') = 'S'))
	
union all

	select  dt_inicio as dt_evento,
			obter_desc_expressao(290567) as descricao
	from    cpoe_gasoterapia
	where   nr_atendimento = nr_atendimento_w
	and     (dt_liberacao_aux IS NOT NULL AND dt_liberacao_aux::text <> '')
	and     coalesce(dt_liberacao::text, '') = ''
	and    	((CASE WHEN coalesce(dt_lib_suspensao::text, '') = '' THEN  dt_fim  ELSE coalesce(dt_suspensao,dt_fim) END  >= clock_timestamp())
	or (CASE WHEN coalesce(dt_lib_suspensao::text, '') = '' THEN  dt_fim  ELSE coalesce(dt_suspensao,dt_fim) coalesce(END::text, '') = ''))
	and     ((cd_medico = cd_pessoa_fisica_w) or (cpoe_verifica_regra_aprovacao(cd_perfil_w, nm_usuario_p, 'AX') = 'S'))
	
union all

	select  dt_inicio as dt_evento,
			obter_desc_proc_interno(nr_seq_proc_interno) as descricao
	from    cpoe_procedimento
	where   nr_atendimento = nr_atendimento_w
	and     (dt_liberacao_aux IS NOT NULL AND dt_liberacao_aux::text <> '')
	and     coalesce(dt_liberacao::text, '') = ''
	and    	((CASE WHEN coalesce(dt_lib_suspensao::text, '') = '' THEN  dt_fim  ELSE coalesce(dt_suspensao,dt_fim) END  >= clock_timestamp())
	or (CASE WHEN coalesce(dt_lib_suspensao::text, '') = '' THEN  dt_fim  ELSE coalesce(dt_suspensao,dt_fim) coalesce(END::text, '') = ''))
	and     ((cd_medico = cd_pessoa_fisica_w) or (cpoe_verifica_regra_aprovacao(cd_perfil_w, nm_usuario_p, 'AX') = 'S'))
	
union all

	select  dt_inicio as dt_evento,
			obter_desc_recomendacao(cd_recomendacao) as descricao
	from    cpoe_recomendacao
	where   nr_atendimento = nr_atendimento_w
	and     (dt_liberacao_aux IS NOT NULL AND dt_liberacao_aux::text <> '')
	and     coalesce(dt_liberacao::text, '') = ''
	and    	((CASE WHEN coalesce(dt_lib_suspensao::text, '') = '' THEN  dt_fim  ELSE coalesce(dt_suspensao,dt_fim) END  >= clock_timestamp())
	or (CASE WHEN coalesce(dt_lib_suspensao::text, '') = '' THEN  dt_fim  ELSE coalesce(dt_suspensao,dt_fim) coalesce(END::text, '') = ''))
	and     ((cd_medico = cd_pessoa_fisica_w) or (cpoe_verifica_regra_aprovacao(cd_perfil_w, nm_usuario_p, 'AX') = 'S'))
	
union all

	select  dt_inicio as dt_evento,
			Obter_Desc_Hemocomponente(nr_seq_derivado) as descricao
	from    cpoe_hemoterapia
	where   nr_atendimento = nr_atendimento_w
	and     (dt_liberacao_aux IS NOT NULL AND dt_liberacao_aux::text <> '')
	and     coalesce(dt_liberacao::text, '') = ''
	and    	((CASE WHEN coalesce(dt_lib_suspensao::text, '') = '' THEN  dt_fim  ELSE coalesce(dt_suspensao,dt_fim) END  >= clock_timestamp())
	or (CASE WHEN coalesce(dt_lib_suspensao::text, '') = '' THEN  dt_fim  ELSE coalesce(dt_suspensao,dt_fim) coalesce(END::text, '') = ''))
	and     ((cd_medico = cd_pessoa_fisica_w) or (cpoe_verifica_regra_aprovacao(cd_perfil_w, nm_usuario_p, 'AX') = 'S'))
	
union all

	select  dt_inicio as dt_evento,
			CPOE_Obter_desc_dialise(ie_tipo_dialise, nr_seq_protocolo,null,null,null,null,'N',null,null,null,null,null,null,null,null,null,null,null) as descricao
	from    cpoe_dialise
	where   nr_atendimento = nr_atendimento_w
	and     (dt_liberacao_aux IS NOT NULL AND dt_liberacao_aux::text <> '')
	and     coalesce(dt_liberacao::text, '') = ''
	and    	((CASE WHEN coalesce(dt_lib_suspensao::text, '') = '' THEN  dt_fim  ELSE coalesce(dt_suspensao,dt_fim) END  >= clock_timestamp())
	or (CASE WHEN coalesce(dt_lib_suspensao::text, '') = '' THEN  dt_fim  ELSE coalesce(dt_suspensao,dt_fim) coalesce(END::text, '') = ''))
	and     ((cd_medico = cd_pessoa_fisica_w) or (cpoe_verifica_regra_aprovacao(cd_perfil_w, nm_usuario_p, 'AX') = 'S'))
	
union all

	select  dt_inicio as dt_evento,
			obter_desc_proc_interno(nr_seq_proc_interno) as descricao
	from    cpoe_anatomia_patologica
	where   nr_atendimento = nr_atendimento_w
	and     (dt_liberacao_aux IS NOT NULL AND dt_liberacao_aux::text <> '')
	and     coalesce(dt_liberacao::text, '') = ''
	and    	((CASE WHEN coalesce(dt_lib_suspensao::text, '') = '' THEN  dt_fim  ELSE coalesce(dt_suspensao,dt_fim) END  >= clock_timestamp())
	or (CASE WHEN coalesce(dt_lib_suspensao::text, '') = '' THEN  dt_fim  ELSE coalesce(dt_suspensao,dt_fim) coalesce(END::text, '') = ''))
	and     ((cd_medico = cd_pessoa_fisica_w) or (cpoe_verifica_regra_aprovacao(cd_perfil_w, nm_usuario_p, 'AX') = 'S'));
BEGIN

	cd_pessoa_fisica_w := obter_codigo_usuario(nm_usuario_p);
	cd_perfil_w	:= obter_perfil_ativo;
	ie_medico_w := obter_se_usuario_medico(nm_usuario_p);

	for c_encounter_w in cEncounter
	loop

		nr_atendimento_w := c_encounter_w.nr_atendimento;

		for c_approval_item_w in cApprovalItems
		loop

			t_alert_details_w.nr_atendimento	:= nr_atendimento_w;
			t_alert_details_w.dt_evento 		:= c_approval_item_w.dt_evento;
			t_alert_details_w.nm_paciente 		:= c_encounter_w.nm_paciente;
			t_alert_details_w.ds_evento			:= c_approval_item_w.descricao;
			t_alert_details_w.ie_funcao			:= 'CPOE';

			RETURN NEXT t_alert_details_w;

		end loop;

	end loop;

	return;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION new_icu_notifications_pck.get_approval_details (nm_usuario_p text) FROM PUBLIC;
