-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION new_icu_notifications_pck.integration_not_users (nr_atendimento_p bigint) RETURNS SETOF T_OBJECT_USERS_INTEGRATION_NOT AS $body$
DECLARE


    t_objeto_row_w  users_integration_not;
    string_retorno_w varchar(2000) := '';
    last_date_notification timestamp := new_icu_notifications_pck.integration_not_get_date(nr_atendimento_p);

    c01 CURSOR FOR
    SELECT
    row_number() OVER () AS num,
    nm_usuario
    from (
    SELECT
    distinct u.nm_usuario
    from integration_notifications g
    inner join usuario u on u.cd_pessoa_fisica = g.cd_person
    where g.nr_encounter = nr_atendimento_p
    and g.ie_type_record = 'SV'
    and g.ds_mensagem = 'SVI'
    and g.ie_viewed = 'N'
    and g.dt_atualizacao = last_date_notification) alias0;

    total_w bigint := 0;
    num_page_w bigint := 0;
    page_max_w bigint := 0;
    page_last_w bigint := 0;


BEGIN

    select
    count(*) into STRICT total_w
    from integration_notifications g
    where g.nr_encounter = nr_atendimento_p
    and g.ie_type_record = 'SV'
    and g.ds_mensagem = 'SVI'
    and g.ie_viewed = 'N'
    and g.dt_atualizacao = last_date_notification;

    num_page_w := 100;
    total_w := ceil(total_w / num_page_w);

    <<loop_fim>> for i in 1..total_w loop
      page_max_w := i * num_page_w;
      page_last_w := (i-1) * num_page_w;

      for c01_w in c01
      loop
        if (c01_w.num IS NOT NULL AND c01_w.num::text <> '') and (c01_w.num > page_last_w and c01_w.num <= page_max_w) then
           string_retorno_w := string_retorno_w || ';' || c01_w.nm_usuario;
        end if;
      end loop;

      t_objeto_row_w.ds_titulo := string_retorno_w;
      RETURN NEXT t_objeto_row_w;
      string_retorno_w := '';

    end loop;
    return;

  END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION new_icu_notifications_pck.integration_not_users (nr_atendimento_p bigint) FROM PUBLIC;
