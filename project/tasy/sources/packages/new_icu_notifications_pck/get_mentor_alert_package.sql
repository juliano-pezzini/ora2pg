-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION new_icu_notifications_pck.get_mentor_alert ( cd_pessoa_fisica_p text, nr_atendimento_p bigint) RETURNS varchar AS $body$
DECLARE


  ds_return_w                varchar(4000) := null;
  hr_retroactive_pending_w   bigint     := Wheb_assist_pck.obterParametroFuncao(355, 2);
  dt_retroactive_w           timestamp           := null;


  content_mentor CURSOR FOR
    SELECT  a.nr_sequencia,
                substr((pep_obter_info_pend_mentor(a.nr_seq_pend_pac_acao,'R')),1,255) DS_REGRA,
                c.ds_acao,
                pkg_date_formaters.to_varchar(a.dt_atualizacao, 'shortDate', wheb_usuario_pck.get_cd_estabelecimento, wheb_usuario_pck.get_nm_usuario) dt_atualizacao
    from  gqa_pend_pac_acao_dest a,
                gqa_pendencia_pac b,
                gqa_pend_pac_acao c
    where  b.nr_sequencia          = c.nr_seq_pend_pac
        and    a.nr_seq_pend_pac_acao  = c.nr_sequencia
        and    coalesce(c.dt_encerramento::text, '') = ''
        and    coalesce(a.dt_encerramento::text, '') = ''
        and    b.cd_pessoa_fisica      = cd_pessoa_fisica_p
        and    ((coalesce(dt_retroactive_w::text, '') = '') or (a.dt_atualizacao_nrec >= dt_retroactive_w))

union

        SELECT  a.nr_sequencia,
                substr((pep_obter_info_pend_mentor(a.nr_seq_pend_pac_acao,'R')),1,255) DS_REGRA,
                c.ds_acao,
                pkg_date_formaters.to_varchar(a.dt_atualizacao, 'shortDate', wheb_usuario_pck.get_cd_estabelecimento, wheb_usuario_pck.get_nm_usuario) dt_atualizacao
    from  gqa_pend_pac_acao_dest a,
                gqa_pendencia_pac b,
                gqa_pend_pac_acao c
    where   b.nr_sequencia          = c.nr_seq_pend_pac
        and     a.nr_seq_pend_pac_acao  = c.nr_sequencia
        and     coalesce(c.dt_encerramento::text, '') = ''
        and     coalesce(a.dt_encerramento::text, '') = ''
        and     b.nr_atendimento        = nr_atendimento_p
        and     ((coalesce(dt_retroactive_w::text, '') = '') or (a.dt_atualizacao_nrec >= dt_retroactive_w))
        order by 1;


BEGIN

    if (hr_retroactive_pending_w > 0) then
      dt_retroactive_w := clock_timestamp() - (hr_retroactive_pending_w/24);
    end if;

    for c_content_mentor in content_mentor loop
    begin
      if (coalesce(ds_return_w::text, '') = '') then
        ds_return_w   := substr(c_content_mentor.dt_atualizacao|| ' - '|| c_content_mentor.DS_REGRA || ' - ' ||c_content_mentor.ds_acao,1,4000);
      else
        ds_return_w   := substr(ds_return_w ||chr(10)|| c_content_mentor.dt_atualizacao|| ' - '|| c_content_mentor.DS_REGRA || ' - ' ||c_content_mentor.ds_acao,1,4000);
      end if;
    end;
    end loop;

    return ds_return_w;

  END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION new_icu_notifications_pck.get_mentor_alert ( cd_pessoa_fisica_p text, nr_atendimento_p bigint) FROM PUBLIC;
