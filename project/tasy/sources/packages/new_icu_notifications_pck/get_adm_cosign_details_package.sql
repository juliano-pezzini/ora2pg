-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION new_icu_notifications_pck.get_adm_cosign_details (nm_usuario_p text) RETURNS SETOF T_ALERT_DETAILS_TABLE AS $body$
DECLARE


nr_atendimento_w 	atendimento_paciente.nr_atendimento%type;
t_alert_details_w	t_alert_details;
cd_pessoa_fisica_w 	pessoa_fisica.cd_pessoa_fisica%type;
ie_medico_w 		varchar(1);

cEncounter CURSOR FOR
	SELECT  nr_atendimento,
			obter_nome_paciente(nr_atendimento) as nm_paciente,
			cd_pessoa_fisica
	from	atendimento_paciente
	where   coalesce(dt_alta::text, '') = ''
	and (ie_medico_w = 'S' and (cd_medico_resp = cd_pessoa_fisica_w)
	or (ie_medico_w = 'N' and obter_enfermeiro_resp(nr_atendimento,'C') = cd_pessoa_fisica_w));


cAdminItems CURSOR FOR
	SELECT  dt_horario as dt_evento,
			obter_desc_material(cd_material) as descricao
	from	prescr_mat_hor
    where   nr_prescricao in (SELECT b.nr_prescricao from prescr_medica b where b.nr_atendimento = nr_atendimento_w)
    and     obter_status_prim_check(dt_primeira_checagem, dt_fim_horario, dt_suspensao, dt_recusa) = 'S'
    and     coalesce(dt_suspensao::text, '') = ''
    and     coalesce(dt_fim_horario::text, '') = ''
    and     (dt_lib_horario IS NOT NULL AND dt_lib_horario::text <> '');
BEGIN

	cd_pessoa_fisica_w := obter_codigo_usuario(nm_usuario_p);
	ie_medico_w := obter_se_usuario_medico(nm_usuario_p);

	for c_encounter_w in cEncounter
	loop

		nr_atendimento_w := c_encounter_w.nr_atendimento;

		for c_administration_item_w in cAdminItems
		loop

			t_alert_details_w.nr_atendimento	:= nr_atendimento_w;
			t_alert_details_w.dt_evento 		:= c_administration_item_w.dt_evento;
			t_alert_details_w.nm_paciente 		:= c_encounter_w.nm_paciente;
			t_alert_details_w.ds_evento			:= c_administration_item_w.descricao;
			t_alert_details_w.ie_funcao			:= 'ADEP';

			RETURN NEXT t_alert_details_w;

		end loop;

	end loop;

return;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION new_icu_notifications_pck.get_adm_cosign_details (nm_usuario_p text) FROM PUBLIC;
