-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION new_icu_notifications_pck.get_new_integration_not () RETURNS SETOF T_OBJECT_CENTRAL_NOTICES AS $body$
DECLARE


    t_objeto_row_w    t_central_notices;

    c01 CURSOR FOR
    SELECT
    distinct g.nr_encounter as nr_atendimento
    from integration_notifications g
    where g.ie_type_record = 'SV'
    and g.ds_mensagem = 'SVI'
    and g.ie_viewed = 'N'
    and g.dt_atualizacao >= (clock_timestamp() - interval '1 days')
    group by g.nr_encounter;


  b01_w RECORD;

BEGIN

    for c01_w in c01
    loop
      for b01_w in (
      SELECT ds_titulo from
      table(SELECT new_icu_notifications_pck.integration_not_users(c01_w.nr_atendimento) ))
      loop
        t_objeto_row_w.ds_titulo            := obter_valor_dominio(9898,'SVI');
        t_objeto_row_w.dt_criacao           := new_icu_notifications_pck.integration_not_get_date(c01_w.nr_atendimento);
        t_objeto_row_w.nm_usuarios_destino  := b01_w.ds_titulo;
        t_objeto_row_w.ds_conteudo          := obter_desc_expressao(311730) || ': ' || obter_nome_paciente(c01_w.nr_atendimento) || ' - ' || obter_desc_expressao(326147) || c01_w.nr_atendimento;
        RETURN NEXT t_objeto_row_w;
      end loop;
    end loop;
    return;

  END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION new_icu_notifications_pck.get_new_integration_not () FROM PUBLIC;
