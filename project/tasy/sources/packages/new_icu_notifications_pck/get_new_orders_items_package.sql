-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION new_icu_notifications_pck.get_new_orders_items (nr_atendimento_p bigint) RETURNS bigint AS $body$
DECLARE


  qt_pending_ack_w  bigint := 0;


BEGIN

    select  sum(qt_pendente)
    into STRICT  qt_pending_ack_w
    from  (
        SELECT  count(*) qt_pendente
        from    cpoe_material a
        left join cpoe_inf_adic b on a.nr_sequencia = b.nr_seq_mat_cpoe and a.nr_atendimento = b.nr_atendimento
        where  a.nr_atendimento = nr_atendimento_p
        and    (a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
        and    ((CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  coalesce(a.dt_fim_cih,a.dt_fim)  ELSE coalesce(a.dt_suspensao,a.dt_fim) END  >= clock_timestamp())
        or (CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  coalesce(a.dt_fim_cih,a.dt_fim)  ELSE coalesce(a.dt_suspensao,a.dt_fim) coalesce(END::text, '') = ''))
        and    coalesce(b.nm_user_ack::text, '') = ''
        
union all

        SELECT  count(*) qt_pendente
        from    cpoe_dieta a
        left join cpoe_inf_adic b on a.nr_sequencia = b.nr_seq_diet_cpoe and a.nr_atendimento = b.nr_atendimento
        where  a.nr_atendimento = nr_atendimento_p
        and    (a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
        and    ((CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) END  >= clock_timestamp())
        or (CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) coalesce(END::text, '') = ''))
        and    coalesce(b.nm_user_ack::text, '') = ''
        
union all

        select  count(*) qt_pendente
        from  cpoe_recomendacao a
        left join cpoe_inf_adic b on a.nr_sequencia = b.nr_seq_rec_cpoe and a.nr_atendimento = b.nr_atendimento
        where  a.nr_atendimento = nr_atendimento_p
        and     (a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
        and    ((CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) END  >= clock_timestamp())
        or (CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) coalesce(END::text, '') = ''))
        and    coalesce(b.nm_user_ack::text, '') = ''
        
union all

        select  count(*) qt_pendente
        from    cpoe_gasoterapia a
        left join cpoe_inf_adic b on a.nr_sequencia = b.nr_seq_gaso_cpoe and a.nr_atendimento = b.nr_atendimento
        where  a.nr_atendimento = nr_atendimento_p
        and     (a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
        and    ((CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) END  >= clock_timestamp())
        or (CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) coalesce(END::text, '') = ''))
        and    coalesce(b.nm_user_ack::text, '') = ''
        
union all

        select  count(*) qt_pendente
        from    cpoe_procedimento a
        left join cpoe_inf_adic b on a.nr_sequencia = b.nr_seq_exam_cpoe and a.nr_atendimento = b.nr_atendimento
        where  a.nr_atendimento = nr_atendimento_p
        and     (a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
        and    ((CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) END  >= clock_timestamp())
        or (CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) coalesce(END::text, '') = ''))
        and    coalesce(b.nm_user_ack::text, '') = ''
        
union all

        select  count(*) qt_pendente
        from    cpoe_dialise a
        left join cpoe_inf_adic b on a.nr_sequencia = b.nr_seq_dial_cpoe and a.nr_atendimento = b.nr_atendimento
        where  a.nr_atendimento = nr_atendimento_p
        and     (a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
        and    ((CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) END  >= clock_timestamp())
        or (CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) coalesce(END::text, '') = ''))
        and    coalesce(b.nm_user_ack::text, '') = '') alias75;

    return qt_pending_ack_w;

  END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION new_icu_notifications_pck.get_new_orders_items (nr_atendimento_p bigint) FROM PUBLIC;
