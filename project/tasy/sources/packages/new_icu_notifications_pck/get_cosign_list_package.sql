-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION new_icu_notifications_pck.get_cosign_list (nm_usuario_p text) RETURNS SETOF T_ALERTS_TABLE AS $body$
DECLARE


t_alert_w			t_alert;
cd_pessoa_fisica_w  varchar(10);
qt_items_w      	bigint := 0;
ie_medico_w      	varchar(1);

cEncounter CURSOR FOR
	SELECT  a.nr_atendimento,
			a.cd_pessoa_fisica
	from	atendimento_paciente a
	where   coalesce(a.dt_alta::text, '') = ''
	and (ie_medico_w = 'S' and (a.cd_medico_resp = cd_pessoa_fisica_w)
	or (ie_medico_w = 'N' and obter_enfermeiro_resp(a.nr_atendimento,'C') = cd_pessoa_fisica_w));

BEGIN

	if (coalesce(new_icu_notifications_pck.get_visualiza_alertas(nm_usuario_p, 'ACO'), 'X') <> 'S') then
		return;
	end if;

	cd_pessoa_fisica_w := obter_codigo_usuario(nm_usuario_p);
	ie_medico_w := obter_se_usuario_medico(nm_usuario_p);

	for c_encounter_w in cEncounter
	loop

		qt_items_w := new_icu_notifications_pck.get_cosign_items(c_encounter_w.nr_atendimento, nm_usuario_p);

		if (coalesce(qt_items_w, 0) > 0) then
			t_alert_w.ds_titulo := wheb_mensagem_pck.get_texto(1166585,'NM_PACIENTE_P='||obter_nome_paciente(c_encounter_w.nr_atendimento)||';DS_TOTAL_P='||qt_items_w);
			RETURN NEXT t_alert_w;
		end if;
	end loop;

return;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION new_icu_notifications_pck.get_cosign_list (nm_usuario_p text) FROM PUBLIC;
