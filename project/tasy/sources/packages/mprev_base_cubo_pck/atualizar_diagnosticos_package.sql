-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE mprev_base_cubo_pck.atualizar_diagnosticos ( nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE


/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade:	Atualizar a base do cubo para diagnosticos das contas.
	Tabela mprev_diagnostico_cubo_ops
-------------------------------------------------------------------------------------------------------------------

Locais de chamada direta: 
[X]  Objetos do dicionario [ ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatorios [ ] Outros:
-------------------------------------------------------------------------------------------------------------------

Pontos de atencao:

Alteracoes:
------------------------------------------------------------------------------------------------------------------

jjung 01/04/2014 - Criacao da rotina
------------------------------------------------------------------------------------------------------------------

++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */


c_diagnostico CURSOR FOR
	SELECT	b.nr_seq_conta_cubo_ops,
		a.cd_doenca
	from	mprev_conta_cubo_ref b,
		pls_diagnostico_conta a
	where	a.nr_seq_conta = b.nr_seq_conta
	and	(a.cd_doenca IS NOT NULL AND a.cd_doenca::text <> '');
	
table_diagnostico_w	mprev_base_cubo_pck.table_diagnostico;


BEGIN

open c_diagnostico;
loop
	fetch c_diagnostico
	bulk collect into table_diagnostico_w.nr_seq_conta_cubo, table_diagnostico_w.cd_doenca
	limit current_setting('mprev_base_cubo_pck.qt_reg_commit_w')::integer;
	
	exit when table_diagnostico_w.nr_seq_conta_cubo.count = 0;
	
	forall i in table_diagnostico_w.nr_seq_conta_cubo.first .. table_diagnostico_w.nr_seq_conta_cubo.last
		insert into mprev_diagnostico_cubo_ops(nr_sequencia, nm_usuario, dt_atualizacao,
			nr_seq_conta_cubo, cd_doenca)
		values (nextval('mprev_diagnostico_cubo_ops_seq'), nm_usuario_p, clock_timestamp(),
			table_diagnostico_w.nr_seq_conta_cubo(i), table_diagnostico_w.cd_doenca(i));			
	commit;
end loop;
close c_diagnostico;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE mprev_base_cubo_pck.atualizar_diagnosticos ( nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;
