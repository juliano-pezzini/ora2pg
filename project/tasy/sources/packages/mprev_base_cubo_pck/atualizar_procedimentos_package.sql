-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE mprev_base_cubo_pck.atualizar_procedimentos ( nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE


/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade:	Atualizar a base do cubo para os procedimentos realizados.s
	Tabela mprev_conta_proc_cubo_ops
-------------------------------------------------------------------------------------------------------------------

Locais de chamada direta: 
[X]  Objetos do dicionario [ ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatorios [ ] Outros:
-------------------------------------------------------------------------------------------------------------------

Pontos de atencao:

Alteracoes:
------------------------------------------------------------------------------------------------------------------

jjung 01/04/2014 - Criacao da rotina
------------------------------------------------------------------------------------------------------------------

++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */


c_procedimento CURSOR FOR
	SELECT	b.nr_seq_conta_cubo_ops,
		a.cd_procedimento,
		a.ie_origem_proced,
		a.dt_procedimento,
		a.qt_procedimento,
		a.ds_procedimento
	from	mprev_conta_cubo_ref	b,
		pls_conta_proc_v	a
	where	a.nr_seq_conta	= b.nr_seq_conta
	and	(a.cd_procedimento IS NOT NULL AND a.cd_procedimento::text <> '');

table_procedimento_w	mprev_base_cubo_pck.table_procedimento;


BEGIN

open c_procedimento;
loop
	fetch c_procedimento
	bulk collect into table_procedimento_w.nr_seq_conta_cubo_ops, table_procedimento_w.cd_procedimento,
			  table_procedimento_w.ie_origem_proced, table_procedimento_w.dt_procedimento,
			  table_procedimento_w.qt_procedimento, table_procedimento_w.ds_procedimento
	limit current_setting('mprev_base_cubo_pck.qt_reg_commit_w')::integer;
	
	exit when table_procedimento_w.nr_seq_conta_cubo_ops.count = 0;
	
	forall i in table_procedimento_w.nr_seq_conta_cubo_ops.first .. table_procedimento_w.nr_seq_conta_cubo_ops.last		
		insert into mprev_conta_proc_cubo_ops(nr_sequencia, nm_usuario, dt_atualizacao,
			nr_seq_conta_cubo_ops, cd_procedimento, ie_origem_proced,
			dt_procedimento, qt_procedimento, ds_procedimento)
		values (nextval('mprev_conta_proc_cubo_ops_seq'), nm_usuario_p, clock_timestamp(),
			table_procedimento_w.nr_seq_conta_cubo_ops(i), table_procedimento_w.cd_procedimento(i), table_procedimento_w.ie_origem_proced(i),
			table_procedimento_w.dt_procedimento(i), table_procedimento_w.qt_procedimento(i), table_procedimento_w.ds_procedimento(i));
	commit;
end loop;
close c_procedimento;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE mprev_base_cubo_pck.atualizar_procedimentos ( nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;
