-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_mens_processo_pck.suspender_reajuste_fx_etaria ( nr_seq_lote_p pls_lote_mensalidade.nr_sequencia%type, nr_seq_mensalidade_p pls_mensalidade.nr_sequencia%type, dt_mesano_referencia_p pls_lote_mensalidade.dt_mesano_referencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE


qt_reaj_fx_etaria_w		integer;
nr_seq_seg_preco_w		pls_segurado_preco.nr_sequencia%type;

C01 CURSOR(	nr_seq_lote_pc		pls_lote_mensalidade.nr_sequencia%type,
		nr_seq_mensalidade_pc	pls_mensalidade.nr_sequencia%type) FOR
	SELECT	b.nr_sequencia nr_seq_mensalidade_seg,
		b.nr_seq_segurado,
		b.dt_mesano_referencia,
		b.nr_seq_segurado_preco,
		b.nr_seq_plano,
		c.ie_regulamentacao,
		d.nr_sequencia nr_seq_regra_susp_reaj_fx,
		trunc(d.dt_inicio_susp_aplicado,'mm') dt_inicio_susp_aplicado,
		fim_mes(d.dt_fim_susp_aplicado) dt_fim_susp_aplicado
	from	pls_mensalidade	a,
		pls_mensalidade_segurado b,
		pls_plano	c,
		pls_susp_reaj_fx_etaria d
	where	a.nr_sequencia	= b.nr_seq_mensalidade
	and	c.nr_sequencia	= b.nr_seq_plano
	and	a.nr_seq_lote	= nr_seq_lote_pc
	and	d.nr_sequencia	= b.nr_seq_regra_susp_reaj_fx
	and	d.ie_susp_reaj_aplicado = 'S'
	and	((a.nr_sequencia = nr_seq_mensalidade_pc) or (coalesce(nr_seq_mensalidade_pc::text, '') = ''))
	order by b.dt_mesano_referencia;

BEGIN

for r_c01_w in C01(nr_seq_lote_p, nr_seq_mensalidade_p) loop
	begin
	select	count(1)
	into STRICT	qt_reaj_fx_etaria_w
	from	pls_mensalidade_seg_item a,
		pls_mensalidade_segurado b,
		pls_mensalidade c
	where	b.nr_sequencia = a.nr_seq_mensalidade_seg
	and	c.nr_sequencia = b.nr_seq_mensalidade
	and	b.nr_seq_segurado = r_c01_w.nr_seq_segurado
	and	b.nr_seq_plano	= r_c01_w.nr_seq_plano
	and	coalesce(c.ie_cancelamento::text, '') = ''
	and	a.ie_tipo_item = '5'
	and	b.dt_mesano_referencia between r_c01_w.dt_inicio_susp_aplicado and r_c01_w.dt_fim_susp_aplicado
	and	coalesce(a.nr_seq_item_estorno::text, '') = ''
	and	not exists (	SELECT	1
				from	pls_mensalidade_seg_item x
				where	x.nr_seq_item_estorno = a.nr_sequencia)
	and	not exists (	select	1 --Somente se ainda nao gerou preco pre no mes
				from	pls_mensalidade_seg_item x,
					pls_mensalidade_segurado y,
					pls_mensalidade z
				where	y.nr_sequencia	= x.nr_seq_mensalidade_seg
				and	z.nr_sequencia	= y.nr_seq_mensalidade
				and	y.nr_seq_segurado = r_c01_w.nr_seq_segurado
				and	coalesce(z.ie_cancelamento::text, '') = ''
				and	y.dt_mesano_referencia = r_c01_w.dt_mesano_referencia
				and	x.ie_tipo_item = '1');

	if (qt_reaj_fx_etaria_w > 0) then
		CALL pls_preco_beneficiario_pck.suspender_faixa_etaria_benef(r_c01_w.nr_seq_segurado,r_C01_w.dt_mesano_referencia,r_C01_w.dt_mesano_referencia,r_c01_w.nr_seq_regra_susp_reaj_fx,nr_seq_lote_p,nm_usuario_p,cd_estabelecimento_p);
		
		nr_seq_seg_preco_w	:= pls_mens_beneficiario_pck.get_segurado_preco(r_c01_w.nr_seq_segurado, r_c01_w.dt_mesano_referencia, r_c01_w.ie_regulamentacao);
		
		if (nr_seq_seg_preco_w <> r_c01_w.nr_seq_segurado_preco) then
			update	pls_mensalidade_segurado
			set	nr_seq_segurado_preco	= nr_seq_seg_preco_w
			where	nr_sequencia		= r_c01_w.nr_seq_mensalidade_seg;
		end if;
	end if;
	end;
end loop;
commit;
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_mens_processo_pck.suspender_reajuste_fx_etaria ( nr_seq_lote_p pls_lote_mensalidade.nr_sequencia%type, nr_seq_mensalidade_p pls_mensalidade.nr_sequencia%type, dt_mesano_referencia_p pls_lote_mensalidade.dt_mesano_referencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;
