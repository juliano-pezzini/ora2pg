-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_mens_processo_pck.tratar_valor_minimo_fatura ( nr_seq_mensalidade_p pls_mensalidade.nr_sequencia%type, vl_minimo_p pls_regra_mens_contrato.vl_minimo%type) AS $body$
DECLARE


vl_total_preco_pre_w	pls_mensalidade_seg_item.vl_item%type;
vl_diferenca_w		pls_mensalidade_seg_item.vl_item%type;
vl_preco_individual_w	pls_mensalidade_seg_item.vl_item%type;
nr_seq_ultima_seq_w	pls_mensalidade_seg_item.nr_sequencia%type;
qt_segurado_w		integer;

nr_indice_w		integer;
tb_nr_seq_preco_pre_w	pls_util_cta_pck.t_number_table;

C01 CURSOR(	nr_seq_mensalidade_pc	pls_mensalidade.nr_sequencia%type) FOR
	SELECT	a.nr_sequencia
	from	pls_mensalidade_seg_item a,
		pls_mensalidade_segurado b
	where	b.nr_sequencia		= a.nr_seq_mensalidade_seg
	and	b.nr_seq_mensalidade	= nr_seq_mensalidade_pc
	and	a.ie_tipo_item	= '1';

BEGIN

select	sum(a.vl_item),
	count(b.nr_sequencia)
into STRICT	vl_total_preco_pre_w,
	qt_segurado_w
from	pls_mensalidade_seg_item	a,
	pls_mensalidade_segurado	b
where	b.nr_sequencia		= a.nr_seq_mensalidade_seg
and	a.ie_tipo_item		= '1'
and	b.nr_seq_mensalidade	= nr_seq_mensalidade_p;

if (vl_total_preco_pre_w < vl_minimo_p) then
	vl_preco_individual_w	:= trunc(vl_minimo_p / qt_segurado_w,2);
	
	nr_indice_w	:= 0;
	tb_nr_seq_preco_pre_w.delete;
	for r_c01_w in C01(nr_seq_mensalidade_p) loop
		begin
		tb_nr_seq_preco_pre_w(nr_indice_w)	:= r_c01_w.nr_sequencia;
		nr_seq_ultima_seq_w	:= r_c01_w.nr_sequencia;
		nr_indice_w	:= nr_indice_w + 1;
		end;
	end loop;
	
	if (tb_nr_seq_preco_pre_w.count > 0) then
		forall i in tb_nr_seq_preco_pre_w.first..tb_nr_seq_preco_pre_w.last
			update	pls_mensalidade_seg_item
			set	vl_item	= vl_preco_individual_w
			where	nr_sequencia	= tb_nr_seq_preco_pre_w(i);
		commit;
		
		vl_diferenca_w	:= vl_minimo_p - (vl_preco_individual_w * qt_segurado_w);
		if (vl_diferenca_w > 0) then
			update	pls_mensalidade_seg_item
			set	vl_item	= vl_item + vl_diferenca_w
			where	nr_sequencia	= nr_seq_ultima_seq_w;
		end if;
	end if;
end if;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_mens_processo_pck.tratar_valor_minimo_fatura ( nr_seq_mensalidade_p pls_mensalidade.nr_sequencia%type, vl_minimo_p pls_regra_mens_contrato.vl_minimo%type) FROM PUBLIC;
