-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pls_indicadores_idss_pck.pls_indic_soma_contabil ( ie_tipo_valor_contabil_p text, cd_conta_contabil_p text, dt_referencia_p timestamp, cd_empresa_p bigint) RETURNS bigint AS $body$
DECLARE


	nr_seq_mes_ref_w	ctb_mes_ref.nr_sequencia%type;

	
BEGIN

	select	max(a.nr_sequencia)
	into STRICT	nr_seq_mes_ref_w
	from	ctb_mes_ref a
	where	pkg_date_utils.start_of(a.dt_referencia,'MONTH') = current_setting('pls_indicadores_idss_pck.dt_ref_inicio_mes_w')::timestamp
	and	a.cd_empresa = cd_empresa_p;

	if (nr_seq_mes_ref_w IS NOT NULL AND nr_seq_mes_ref_w::text <> '') then

		if (ie_tipo_valor_contabil_p = 'S') then
			select	coalesce(sum(b.vl_saldo),0)
			into STRICT	current_setting('pls_indicadores_idss_pck.vl_retorno_w')::bigint
			from	ctb_balancete_v b
			where	b.nr_seq_mes_ref 	= nr_seq_mes_ref_w
			and	b.cd_conta_contabil	= cd_conta_contabil_p
			and	ie_normal_encerramento	<> 'E';
		elsif (ie_tipo_valor_contabil_p = 'C') then
			select	coalesce(sum(b.vl_credito),0)
			into STRICT	current_setting('pls_indicadores_idss_pck.vl_retorno_w')::bigint
			from	ctb_balancete_v b
			where	b.nr_seq_mes_ref 	= nr_seq_mes_ref_w
			and	b.cd_conta_contabil	= cd_conta_contabil_p
			and	ie_normal_encerramento	<> 'E';
		elsif (ie_tipo_valor_contabil_p = 'D') then
			select	coalesce(sum(b.vl_debito),0)
			into STRICT	current_setting('pls_indicadores_idss_pck.vl_retorno_w')::bigint
			from	ctb_balancete_v b
			where	b.nr_seq_mes_ref 	= nr_seq_mes_ref_w
			and	b.cd_conta_contabil	= cd_conta_contabil_p
			and	ie_normal_encerramento	<> 'E';
		elsif (ie_tipo_valor_contabil_p = 'M') then
			select	coalesce(sum(b.vl_movimento),0)
			into STRICT	current_setting('pls_indicadores_idss_pck.vl_retorno_w')::bigint
			from	ctb_balancete_v b
			where	b.nr_seq_mes_ref 	= nr_seq_mes_ref_w
			and	b.cd_conta_contabil	= cd_conta_contabil_p
			and	ie_normal_encerramento	<> 'E';
		end if;

	else
		PERFORM set_config('pls_indicadores_idss_pck.vl_retorno_w', 0, false);
	end if;

	return coalesce(current_setting('pls_indicadores_idss_pck.vl_retorno_w')::bigint,0);
	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pls_indicadores_idss_pck.pls_indic_soma_contabil ( ie_tipo_valor_contabil_p text, cd_conta_contabil_p text, dt_referencia_p timestamp, cd_empresa_p bigint) FROM PUBLIC;
