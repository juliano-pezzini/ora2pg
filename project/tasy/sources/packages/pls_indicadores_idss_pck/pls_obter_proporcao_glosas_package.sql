-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_indicadores_idss_pck.pls_obter_proporcao_glosas ( cd_grupo_p text, cd_indicador_p text, dt_referencia_p timestamp, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE

	
	qt_prest_conta_w	bigint;
	qt_prest_glosa_w	bigint;
	vl_contas_w		pls_conta.vl_cobrado%type;
	vl_glosa_w		pls_conta.vl_glosa%type;
	
	
BEGIN

	select	sum(c.vl_glosa) vl_glosa,
		count(distinct c.nr_seq_prestador_exec) qt_prest_glosa
	into STRICT	vl_glosa_w,
		qt_prest_glosa_w
	from	pls_protocolo_conta p,
		pls_conta c
	where	p.nr_sequencia = c.nr_seq_protocolo
	and	pkg_date_utils.start_of(p.dt_mes_competencia, 'MONTH') = pkg_date_utils.start_of(dt_referencia_p, 'MONTH')
	and	c.vl_glosa > 0;

	select	sum(c.vl_cobrado) vl_contas,
		count(distinct c.nr_seq_prestador_exec) qt_prest_conta
	into STRICT	vl_contas_w,
		qt_prest_conta_w
	from	pls_protocolo_conta p,
		pls_conta c
	where	p.nr_sequencia = c.nr_seq_protocolo
	and	pkg_date_utils.start_of(p.dt_mes_competencia, 'MONTH') = pkg_date_utils.start_of(dt_referencia_p, 'MONTH');

	PERFORM set_config('pls_indicadores_idss_pck.vl_total_w', 0.75 * dividir(vl_glosa_w,vl_contas_w) + 0.25 * dividir(qt_prest_glosa_w, qt_prest_conta_w), false);
	
	insert into pls_indic_dados(	nr_sequencia,
					dt_atualizacao,
					nm_usuario,
					dt_atualizacao_nrec,
					nm_usuario_nrec,
					cd_grupo,
					cd_indicador,
					dt_competencia,
					vl_indicador)
			values (nextval('pls_indic_dados_seq'),
					clock_timestamp(),
					nm_usuario_p,
					clock_timestamp(),
					nm_usuario_p,
					cd_grupo_p,
					cd_indicador_p,
					dt_referencia_p,
					current_setting('pls_indicadores_idss_pck.vl_total_w')::bigint);

	commit;

	PERFORM set_config('pls_indicadores_idss_pck.vl_div_w', 0, false);
	PERFORM set_config('pls_indicadores_idss_pck.vl_total_w', 0, false);

	END;		

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_indicadores_idss_pck.pls_obter_proporcao_glosas ( cd_grupo_p text, cd_indicador_p text, dt_referencia_p timestamp, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;
