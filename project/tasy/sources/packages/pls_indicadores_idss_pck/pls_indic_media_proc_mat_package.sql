-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pls_indicadores_idss_pck.pls_indic_media_proc_mat ( dt_referencia_p timestamp, cd_tipo_segmentacao_p text, nr_idade_minima_p bigint, nr_idade_maxima_p bigint) RETURNS bigint AS $body$
BEGIN
	if (cd_tipo_segmentacao_P = 'A') then /*Ambulatorial*/
		select	count(p.ie_situacao)
		into STRICT	current_setting('pls_indicadores_idss_pck.vl_num_media_w')::pls_conta_proc.vl_liberado%type
		from	pls_segurado s,
			pls_plano p
		where	p.nr_sequencia = s.nr_seq_plano
		and	pls_obter_dados_segurado(s.nr_sequencia, 'CS') = 'A'
		and	p.ie_segmentacao in (1,5,6,7,8,11,12)
		and	pls_obter_dados_segurado(s.nr_sequencia, 'ID') between coalesce(nr_idade_minima_p, 0) and coalesce(nr_idade_maxima_p, 999)
		and	coalesce(s.dt_rescisao, dt_referencia_p) >= dt_referencia_p
		and	(s.dt_liberacao IS NOT NULL AND s.dt_liberacao::text <> '')
		and	s.dt_contratacao <= dt_referencia_p;

		select 	count(p.ie_situacao)
		into STRICT	current_setting('pls_indicadores_idss_pck.vl_den_media_w')::pls_conta_proc.vl_liberado%type
		from	pls_plano p
		where	p.ie_segmentacao in (1,5,6,7,8,11,12);
	end if;

	if (cd_tipo_segmentacao_P = 'O') then /*Ondontologia*/
		select	count(p.ie_situacao)
		into STRICT	current_setting('pls_indicadores_idss_pck.vl_num_media_w')::pls_conta_proc.vl_liberado%type
		from	pls_segurado s,
			pls_plano p
		where	p.nr_sequencia = s.nr_seq_plano
		and	pls_obter_dados_segurado(s.nr_sequencia, 'CS') = 'A'
		and	p.ie_segmentacao in (4,9,10,11,12)
		and	pls_obter_dados_segurado(s.nr_sequencia, 'ID') between coalesce(nr_idade_minima_p, 0) and coalesce(nr_idade_maxima_p, 999)
		and	coalesce(s.dt_rescisao, dt_referencia_p) >= dt_referencia_p
		and	(s.dt_liberacao IS NOT NULL AND s.dt_liberacao::text <> '')
		and	s.dt_contratacao <= dt_referencia_p;

		select 	count(p.ie_situacao)
		into STRICT	current_setting('pls_indicadores_idss_pck.vl_den_media_w')::pls_conta_proc.vl_liberado%type
		from	pls_plano p
		where	p.ie_segmentacao in (4,9,10,11,12)
		and	pkg_date_utils.start_of(p.dt_atualizacao,'MONTH') = current_setting('pls_indicadores_idss_pck.dt_ref_inicio_mes_w')::timestamp;
	end if;

	PERFORM set_config('pls_indicadores_idss_pck.vl_retorno_media_w', dividir(current_setting('pls_indicadores_idss_pck.vl_num_media_w')::pls_conta_proc.vl_liberado%type, current_setting('pls_indicadores_idss_pck.vl_den_media_w')::pls_conta_proc.vl_liberado%type), false);

	return coalesce(current_setting('pls_indicadores_idss_pck.vl_retorno_media_w')::bigint,0);
	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pls_indicadores_idss_pck.pls_indic_media_proc_mat ( dt_referencia_p timestamp, cd_tipo_segmentacao_p text, nr_idade_minima_p bigint, nr_idade_maxima_p bigint) FROM PUBLIC;
