-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


	/*---------------------------------------------------------------------------------------------------------------------------------------------------*/

CREATE OR REPLACE FUNCTION pls_indicadores_idss_pck.pls_indic_soma_num_den ( cd_grupo_p text, cd_indicador_p text, dt_referencia_p timestamp, cd_estabelecimento_p bigint, cd_tipo_calculo_p text, cd_tipo_segmentacao_p text, ds_procedimento_p text) RETURNS bigint AS $body$
DECLARE


	c_seq_grupo_indc CURSOR FOR
		SELECT	a.nr_sequencia
		from	pls_indic_regra a
		where	dt_ref_inicio_mes_w between coalesce(pkg_date_utils.start_of(a.dt_inicio_vigencia,'MONTH'),dt_ref_inicio_mes_w) and coalesce(pkg_date_utils.start_of(a.dt_fim_vigencia,'MONTH'),dt_ref_inicio_mes_w)
		and	a.cd_grupo = cd_grupo_p
		and (a.cd_indicador = cd_indicador_p or coalesce(cd_indicador_p::text, '') = '');

	c_tipo_saldo CURSOR FOR
		SELECT	a.ie_tipo_valor_contabil,
			a.cd_conta_contabil,
			a.ie_tipo_regra,
			a.nr_seq_regra,
			a.cd_procedimento,
			a.cd_material,
			a.nr_idade_minima,
			a.nr_idade_maxima
		from	pls_indic_regra_item a
		where	a.nr_seq_regra = current_setting('pls_indicadores_idss_pck.nr_seq_grupo_indc_w')::pls_indic_regra.nr_sequencia%type;

	
BEGIN

	open c_seq_grupo_indc;
	loop
	fetch c_seq_grupo_indc into
		current_setting('pls_indicadores_idss_pck.nr_seq_grupo_indc_w')::pls_indic_regra.nr_sequencia%type;
	EXIT WHEN NOT FOUND; /* apply on c_seq_grupo_indc */
		begin
		PERFORM set_config('pls_indicadores_idss_pck.vl_soma_num_w', 0, false);
		PERFORM set_config('pls_indicadores_idss_pck.vl_soma_den_w', 0, false);
		open c_tipo_saldo;
		loop
		fetch 	c_tipo_saldo into
			current_setting('pls_indicadores_idss_pck.ie_tipo_valor_contabil_w')::pls_indic_regra_item.ie_tipo_valor_contabil%type,
			current_setting('pls_indicadores_idss_pck.cd_conta_contabil_w')::pls_indic_regra_item.cd_conta_contabil%type,
			current_setting('pls_indicadores_idss_pck.ie_tipo_regra_w')::pls_indic_regra_item.ie_tipo_regra%type,
			current_setting('pls_indicadores_idss_pck.nr_seq_regra_w')::pls_indic_regra_item.nr_seq_regra%type,
			current_setting('pls_indicadores_idss_pck.cd_procedimento_w')::pls_indic_regra_item.cd_procedimento%type,
			current_setting('pls_indicadores_idss_pck.cd_material_w')::pls_indic_regra_item.cd_material%type,
			current_setting('pls_indicadores_idss_pck.nr_idade_minima_w')::pls_indic_regra_item.nr_idade_minima%type,
			current_setting('pls_indicadores_idss_pck.nr_idade_maxima_w')::pls_indic_regra_item.nr_idade_maxima%type;
		EXIT WHEN NOT FOUND; /* apply on c_tipo_saldo */
			begin
			if (current_setting('pls_indicadores_idss_pck.cd_conta_contabil_w')::pls_indic_regra_item.cd_conta_contabil%(type IS NOT NULL AND type::text <> '')) then
				if (current_setting('pls_indicadores_idss_pck.ie_tipo_regra_w')::pls_indic_regra_item.ie_tipo_regra%type = 'N') then
					PERFORM set_config('pls_indicadores_idss_pck.vl_soma_num_w', current_setting('pls_indicadores_idss_pck.vl_soma_num_w')::bigint + pls_indicadores_idss_pck.pls_indic_soma_contabil(current_setting('pls_indicadores_idss_pck.ie_tipo_valor_contabil_w')::pls_indic_regra_item.ie_tipo_valor_contabil%type, current_setting('pls_indicadores_idss_pck.cd_conta_contabil_w')::pls_indic_regra_item.cd_conta_contabil%type, dt_referencia_p, cd_estabelecimento_p), false);
				elsif (current_setting('pls_indicadores_idss_pck.ie_tipo_regra_w')::pls_indic_regra_item.ie_tipo_regra%type = 'D') then
					PERFORM set_config('pls_indicadores_idss_pck.vl_soma_den_w', current_setting('pls_indicadores_idss_pck.vl_soma_den_w')::bigint + pls_indicadores_idss_pck.pls_indic_soma_contabil(current_setting('pls_indicadores_idss_pck.ie_tipo_valor_contabil_w')::pls_indic_regra_item.ie_tipo_valor_contabil%type, current_setting('pls_indicadores_idss_pck.cd_conta_contabil_w')::pls_indic_regra_item.cd_conta_contabil%type, dt_referencia_p, cd_estabelecimento_p), false);
				end if;
			elsif	((coalesce(current_setting('pls_indicadores_idss_pck.cd_procedimento_w')::pls_indic_regra_item.cd_procedimento%type, 0) <> 0) or (coalesce(current_setting('pls_indicadores_idss_pck.cd_material_w')::pls_indic_regra_item.cd_material%type, 0) <> 0)) then
				if (current_setting('pls_indicadores_idss_pck.ie_tipo_regra_w')::pls_indic_regra_item.ie_tipo_regra%type = 'N') then
					if (ds_procedimento_p = 'HG') then
						PERFORM set_config('pls_indicadores_idss_pck.vl_soma_num_w', current_setting('pls_indicadores_idss_pck.vl_soma_num_w')::bigint + pls_indicadores_idss_pck.pls_indic_soma_idqs6(current_setting('pls_indicadores_idss_pck.nr_seq_regra_w')::pls_indic_regra_item.nr_seq_regra%type, current_setting('pls_indicadores_idss_pck.cd_procedimento_w')::pls_indic_regra_item.cd_procedimento%type, current_setting('pls_indicadores_idss_pck.cd_material_w')::pls_indic_regra_item.cd_material%type, dt_referencia_p, ds_procedimento_p), false);
					else
						PERFORM set_config('pls_indicadores_idss_pck.vl_soma_num_w', current_setting('pls_indicadores_idss_pck.vl_soma_num_w')::bigint + pls_indicadores_idss_pck.pls_indic_soma_proc_mat(current_setting('pls_indicadores_idss_pck.ie_tipo_regra_w')::pls_indic_regra_item.ie_tipo_regra%type, current_setting('pls_indicadores_idss_pck.nr_seq_regra_w')::pls_indic_regra_item.nr_seq_regra%type, current_setting('pls_indicadores_idss_pck.cd_procedimento_w')::pls_indic_regra_item.cd_procedimento%type, current_setting('pls_indicadores_idss_pck.cd_material_w')::pls_indic_regra_item.cd_material%type, dt_referencia_p, ds_procedimento_p), false);
					end if;
				elsif (current_setting('pls_indicadores_idss_pck.ie_tipo_regra_w')::pls_indic_regra_item.ie_tipo_regra%type = 'D') then
					if (cd_tipo_calculo_p = 'QT_TOTAL') then
						PERFORM set_config('pls_indicadores_idss_pck.vl_soma_den_w', current_setting('pls_indicadores_idss_pck.vl_soma_den_w')::bigint + pls_indicadores_idss_pck.pls_indic_soma_proc_mat(current_setting('pls_indicadores_idss_pck.ie_tipo_regra_w')::pls_indic_regra_item.ie_tipo_regra%type, current_setting('pls_indicadores_idss_pck.nr_seq_regra_w')::pls_indic_regra_item.nr_seq_regra%type, current_setting('pls_indicadores_idss_pck.cd_procedimento_w')::pls_indic_regra_item.cd_procedimento%type, current_setting('pls_indicadores_idss_pck.cd_material_w')::pls_indic_regra_item.cd_material%type, dt_referencia_p, ds_procedimento_p), false);
					elsif (cd_tipo_calculo_p = 'QT_MEDIA') then
						PERFORM set_config('pls_indicadores_idss_pck.vl_soma_den_w', current_setting('pls_indicadores_idss_pck.vl_soma_den_w')::bigint + pls_indicadores_idss_pck.pls_indic_media_proc_mat(dt_referencia_p, cd_tipo_segmentacao_p, current_setting('pls_indicadores_idss_pck.nr_idade_minima_w')::pls_indic_regra_item.nr_idade_minima%type, current_setting('pls_indicadores_idss_pck.nr_idade_maxima_w')::pls_indic_regra_item.nr_idade_maxima%type), false);
					end if;
				end if;
			end if;
			end;
		end loop;
		close c_tipo_saldo;
		end;

		PERFORM set_config('pls_indicadores_idss_pck.vl_div_w', current_setting('pls_indicadores_idss_pck.vl_div_w')::bigint + dividir(current_setting('pls_indicadores_idss_pck.vl_soma_num_w')::bigint, current_setting('pls_indicadores_idss_pck.vl_soma_den_w')::bigint), false);
	end loop;
	close c_seq_grupo_indc;

	return	current_setting('pls_indicadores_idss_pck.vl_div_w')::bigint;

	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pls_indicadores_idss_pck.pls_indic_soma_num_den ( cd_grupo_p text, cd_indicador_p text, dt_referencia_p timestamp, cd_estabelecimento_p bigint, cd_tipo_calculo_p text, cd_tipo_segmentacao_p text, ds_procedimento_p text) FROM PUBLIC;
