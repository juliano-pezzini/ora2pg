-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_pp_filtro_ocor_fin_pck.insere_item_ocor_fin ( nr_id_transacao_p pls_pp_rp_ofin_selecao.nr_id_transacao%type, nr_seq_lote_p pls_pp_lote.nr_sequencia%type, nr_seq_regra_periodo_p pls_pp_lote.nr_seq_regra_periodo%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE

					
tb_seq_prestador_w	pls_util_cta_pck.t_number_table;
tb_seq_evento_w		pls_util_cta_pck.t_number_table;

-- todos os filtros bons que foram processados no lote
c_filtro CURSOR(	nr_seq_lote_pc		pls_pp_lote.nr_sequencia%type,
			nr_seq_regra_periodo_pc	pls_pp_lote.nr_seq_regra_periodo%type) FOR
	SELECT	a.nr_sequencia nr_seq_filtro
	from	pls_pp_rp_cta_filtro a
	where	a.nr_seq_regra_periodo = nr_seq_regra_periodo_pc
	and	a.ie_tipo_filtro = 'O'
	and	a.ie_excecao = 'N'
	and	a.ie_situacao = 'A'
	
union all

	SELECT	a.nr_sequencia nr_seq_filtro
	from	pls_pp_rp_cta_filtro a
	where	a.nr_seq_lote = nr_seq_lote_pc
	and	a.ie_tipo_filtro = 'O'
	and	a.ie_excecao = 'N'
	and	a.ie_situacao = 'A';
	
-- todos os prestadores/eventos selecionados por filtros do cursor c_filtro
-- que não estejam na tabela temporária
c_item CURSOR(	nr_id_transacao_pc	pls_pp_rp_ofin_selecao.nr_id_transacao%type,
		nr_seq_lote_pc		pls_pp_lote.nr_sequencia%type,
		nr_seq_filtro_pc	pls_pp_rp_ofin_selecao.nr_seq_filtro%type) FOR
	SELECT	distinct a.nr_seq_prestador,
		a.nr_seq_evento
	from	pls_pp_rp_ofin_selecao a
	where	a.nr_id_transacao = nr_id_transacao_pc
	and	a.nr_seq_filtro = nr_seq_filtro_pc
	and	a.ie_valido = 'S'
	and	not exists (	SELECT	1
				from	pls_pp_lote_prest_event b
				where	b.nr_seq_lote = nr_seq_lote_pc
				and	b.nr_seq_prestador = a.nr_seq_prestador
				and	b.nr_seq_evento = a.nr_seq_evento);

BEGIN
-- abre o cursor com todos os filtros bons
-- só devem ser selecionados registros onde o filtro bom fez a seleção
for r_c_filtro_w in c_filtro(nr_seq_lote_p, nr_seq_regra_periodo_p) loop

	-- busca tudo o que foi gravado no processo anterior e grava na tabela pls_pp_item_lote
	-- essa tabela conterá todos os itens que fazem parte do lote, sendo produção ou qualquer ocorrência financeira
	open c_item(nr_id_transacao_p, nr_seq_lote_p, r_c_filtro_w.nr_seq_filtro);
	loop
		fetch c_item bulk collect into tb_seq_prestador_w, tb_seq_evento_w
		limit pls_util_pck.qt_registro_transacao_w;
		exit when tb_seq_prestador_w.count = 0;
		
		forall i in tb_seq_prestador_w.first..tb_seq_prestador_w.last
			insert 	into pls_pp_lote_prest_event(
				nr_sequencia, nr_seq_lote, nr_seq_prestador,
				nr_seq_evento
			) values (
				nextval('pls_pp_lote_prest_event_seq'), nr_seq_lote_p, tb_seq_prestador_w(i),
				tb_seq_evento_w(i)
			);
		commit;
	end loop;
	close c_item;

end loop;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_pp_filtro_ocor_fin_pck.insere_item_ocor_fin ( nr_id_transacao_p pls_pp_rp_ofin_selecao.nr_id_transacao%type, nr_seq_lote_p pls_pp_lote.nr_sequencia%type, nr_seq_regra_periodo_p pls_pp_lote.nr_seq_regra_periodo%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;
