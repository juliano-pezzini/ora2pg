-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE wheb_sms.verifica_resposta_sms ( NM_USUARIO_P text, ID_SMS_P bigint default null) AS $body$
DECLARE

	parametros_sms_w		LT_PARAMETROS_SMS;
	ie_forma_w				varchar(1);
	ds_retorno_sms_w		text;
	xml_w			        xml;
	dt_teste_w				timestamp;
	lista_retorno_xml 		t_list_of_xml;


	item					lt_mensagem_sms;
	lista					lt_mensagens_sms;


	
BEGIN
		CALL wheb_sms.armazena_configuracoes_sms(NM_USUARIO_P);
		parametros_sms_w := LT_PARAMETROS_SMS(	null, null, null, null,null,
												null,null,null,null,null,
												null,null,null,null,null,
												null,null,null,null);


		parametros_sms_w.DS_OPERACAO			:= 'RETORNO';
		parametros_sms_w.ID_SMS					:= ID_SMS_P;
		parametros_sms_w.NM_USUARIO				:= current_setting('wheb_sms.nm_usuario_sms_w')::varchar(255);
		parametros_sms_w.DS_SENHA				:= current_setting('wheb_sms.ds_senha_usuario_sms_w')::varchar(255);
		parametros_sms_w.DS_URL_SMS			:= current_setting('wheb_sms.ds_url_sms_w')::varchar(255);
		parametros_sms_w.IP_SERVIDOR_PROXY		:= current_setting('wheb_sms.ip_servidor_proxy_w')::varchar(255);
		parametros_sms_w.CD_EMPRESA				:= current_setting('wheb_sms.cd_empresa_w')::bigint;
		parametros_sms_w.NM_USUARIO_PROXY		:= current_setting('wheb_sms.nm_usuario_proxy_w')::varchar(255);
		parametros_sms_w.DS_SENHA_PROXY			:= current_setting('wheb_sms.ds_senha_proxy_w')::varchar(255);
		parametros_sms_w.ie_consistir_destinatario := OBTER_VALOR_PARAM_USUARIO(0,214,coalesce(wheb_usuario_pck.get_cd_perfil,0),nm_usuario_p,coalesce(wheb_usuario_pck.get_cd_estabelecimento,1));

		ie_forma_w	 		:= obter_valor_param_usuario(0,202,coalesce(wheb_usuario_pck.get_cd_perfil,0),NM_USUARIO_P, coalesce(wheb_usuario_pck.get_cd_estabelecimento,1));
		
		if (coalesce(ie_forma_w, 'B') = 'T') THEN
	
			CALL tie_sms.retorno_sms_tie(nm_usuario_p, current_setting('wheb_sms.nm_usuario_sms_w')::varchar(255), current_setting('wheb_sms.ds_senha_usuario_sms_w')::varchar(255), current_setting('wheb_sms.ds_url_sms_w')::varchar(255), current_setting('wheb_sms.cd_empresa_w')::bigint);

	 	elsif (coalesce(ie_forma_w, 'B') = 'B') then
			begin
			if (current_setting('wheb_sms.cd_empresa_w')::bigint = 1 ) then
				comunika_conectar(current_setting('wheb_sms.nm_usuario_sms_w')::varchar(255),current_setting('wheb_sms.ds_senha_usuario_sms_w')::varchar(255),0);
				comunika_retorno_sms;
			elsif ( current_setting('wheb_sms.cd_empresa_w')::bigint = 2) then
				tww_retorno_sms(current_setting('wheb_sms.nm_usuario_sms_w')::varchar(255),current_setting('wheb_sms.ds_senha_usuario_sms_w')::varchar(255),current_setting('wheb_sms.nm_usuario_proxy_w')::varchar(255),current_setting('wheb_sms.ds_senha_proxy_w')::varchar(255),current_setting('wheb_sms.ip_servidor_proxy_w')::varchar(255));
			elsif ( current_setting('wheb_sms.cd_empresa_w')::bigint = 3) then
				tww_2_02_retorno_sms(current_setting('wheb_sms.nm_usuario_sms_w')::varchar(255),current_setting('wheb_sms.ds_senha_usuario_sms_w')::varchar(255),current_setting('wheb_sms.nm_usuario_proxy_w')::varchar(255),current_setting('wheb_sms.ds_senha_proxy_w')::varchar(255),current_setting('wheb_sms.ip_servidor_proxy_w')::varchar(255));
			elsif ( current_setting('wheb_sms.cd_empresa_w')::bigint = 9) then
				tww_padrao_retorno_sms(current_setting('wheb_sms.nm_usuario_sms_w')::varchar(255),current_setting('wheb_sms.ds_senha_usuario_sms_w')::varchar(255),current_setting('wheb_sms.ds_url_sms_w')::varchar(255),current_setting('wheb_sms.nm_usuario_proxy_w')::varchar(255),current_setting('wheb_sms.ds_senha_proxy_w')::varchar(255),current_setting('wheb_sms.ip_servidor_proxy_w')::varchar(255));
			elsif ( current_setting('wheb_sms.cd_empresa_w')::bigint = 4) then
				human_retorno_sms(current_setting('wheb_sms.nm_usuario_sms_w')::varchar(255),current_setting('wheb_sms.ds_senha_usuario_sms_w')::varchar(255),current_setting('wheb_sms.nm_usuario_proxy_w')::varchar(255),current_setting('wheb_sms.ds_senha_proxy_w')::varchar(255),current_setting('wheb_sms.ip_servidor_proxy_w')::varchar(255));
			elsif ( current_setting('wheb_sms.cd_empresa_w')::bigint = 5) then
				CALL Wheb_mensagem_pck.exibir_mensagem_abort(248883); --Operacao nao implementada para a Spring Wireless
			elsif ( current_setting('wheb_sms.cd_empresa_w')::bigint = 8) then
				if (coalesce(ID_SMS_P::text, '') = '') then
					CALL Wheb_mensagem_pck.exibir_mensagem_abort(297286); -- Para utilizacao deste recurso eh necessario informar o ID do sms
				end if;

				digital_retorno_sms(
						id_sms_p,
						current_setting('wheb_sms.nm_usuario_sms_w')::varchar(255),
						current_setting('wheb_sms.ds_senha_usuario_sms_w')::varchar(255),
						current_setting('wheb_sms.nm_usuario_proxy_w')::varchar(255),
						current_setting('wheb_sms.ds_senha_proxy_w')::varchar(255),
						current_setting('wheb_sms.ip_servidor_proxy_w')::varchar(255));
			end if;
			end;
		else
			begin
				lista_retorno_xml := wheb_sms.obter_retorno_operacao_sms(nm_usuario_p, parametros_sms_w);

				for i in 1 .. lista_retorno_xml.count loop
					lista := wheb_sms.obter_lista_msgs_retorno_sms(lista_retorno_xml(i));

					for j in 1 .. lista.mensagens.count loop
						item := lista.mensagens(j);
						CALL wheb_sms.grava_retorno_sms(item.nr_celular, item.ds_mensagem, item.dt_resposta);
					end loop;
				end loop;
			end;
		end if;
	end;


$body$
LANGUAGE PLPGSQL
;
-- REVOKE ALL ON PROCEDURE wheb_sms.verifica_resposta_sms ( NM_USUARIO_P text, ID_SMS_P bigint default null) FROM PUBLIC;
