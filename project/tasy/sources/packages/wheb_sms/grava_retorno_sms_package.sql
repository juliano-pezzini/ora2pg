-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE wheb_sms.grava_retorno_sms (nr_celular_p text, ds_resposta_p text, dt_resposta_p text) AS $body$
DECLARE

	dt_resposta_w timestamp := to_date(dt_resposta_p,'dd/mm/yyyy hh24:mi:ss');
	
  rec RECORD;

BEGIN

		FOR rec in (select * from table(wheb_sms.get_patient_by_mobile(nr_celular_p, ds_resposta_p, dt_resposta_w)))
		loop
			insert into log_retorno_sms(
				nr_sequencia,
				nr_celular,
				ds_resposta,
				dt_resposta,
				ie_processado,
				cd_pessoa_fisica,
				nr_seq_ageint,
				nr_seq_agenda_pac,
				nr_seq_agenda_cons,
				dt_agendamento
			)values (
				nextval('log_retorno_sms_seq'),
				trim(both nr_celular_p),
				ds_resposta_p,
				dt_resposta_w,
				'N',
				rec.cd_pessoa_fisica,
				rec.agenda_int_seq,
				CASE WHEN rec.ds_type='IP' THEN  rec.agend_seq  ELSE null END ,
				CASE WHEN rec.ds_type='C' THEN  rec.agend_seq WHEN rec.ds_type='IC' THEN  rec.agend_seq  ELSE null END ,
				rec.dt_agenda
			);

			commit;
		end loop;
	end;


$body$
LANGUAGE PLPGSQL
;
-- REVOKE ALL ON PROCEDURE wheb_sms.grava_retorno_sms (nr_celular_p text, ds_resposta_p text, dt_resposta_p text) FROM PUBLIC;
