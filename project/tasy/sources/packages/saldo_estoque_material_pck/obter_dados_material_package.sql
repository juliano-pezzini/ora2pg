-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION saldo_estoque_material_pck.obter_dados_material ( cd_estabelecimento_p bigint, dt_mesano_referencia_p timestamp, dt_inicio_movimento_p text, dt_fim_movimento_p text) RETURNS SETOF T_SALDO_ESTOQUE_MATERIAL AS $body$
DECLARE

 
t_saldo_estoque_mat_row_w		t_saldo_estoque_material_row;
cd_material_w			material.cd_material%type;
ds_material_w			material.ds_material%type;
cd_unidade_medida_estoque_w	material.cd_unidade_medida_estoque%type;
cd_tiss_w				brasindice_preco.cd_tiss%type;
cd_tuss_w			brasindice_preco.cd_tuss%type;
vl_custo_medio_w			saldo_estoque.vl_custo_medio%type;
cd_laboratorio_w			material_brasindice.cd_laboratorio%type;
ds_fabricante_w			mat_fabricante.ds_fabricante%type;
cd_apresentacao_w		material_brasindice.cd_apresentacao%type;
cd_grupo_material_w		grupo_material.cd_grupo_material%type;
cd_subgrupo_material_w		subgrupo_material.cd_subgrupo_material%type;
cd_classe_material_w		classe_material.cd_classe_material%type;
nr_seq_tuss_mat_item_w		tuss_material_item.nr_sequencia%type;
ds_material_tuss_w			tuss_material_item.ds_material%type;
dt_mesano_referencia_w		saldo_estoque.dt_mesano_referencia%type;
cd_estabelecimento_w		estabelecimento.cd_estabelecimento%type;
ie_restringe_data_w			varchar(1);
dt_inicio_movimento_w		timestamp;
dt_fim_movimento_w		timestamp;
ds_laboratorio_w			brasindice_laboratorio.ds_laboratorio%type;

C01 CURSOR FOR 
SELECT	e.cd_material, 
	e.ds_material, 
	e.cd_grupo_material, 
	e.cd_subgrupo_material, 
	e.cd_classe_material, 
	substr(obter_dados_material_estab(e.cd_material,cd_estabelecimento_w,'UME'),1,30) cd_unidade_medida_estoque, 
	avg(s.vl_custo_medio) vl_custo_medio, 
	substr(obter_lab_brasindice(cd_estabelecimento_w,e.cd_material, null,'C'),1,60) cd_lab_brasindice, 
	substr(obter_desc_mat_fabricante(e.cd_material),1,100) ds_fabricante, 
	SUBSTR((SELECT DS_LABORATORIO FROM BRASINDICE_LABORATORIO WHERE CD_LABORATORIO = SUBSTR(obter_lab_brasindice(cd_estabelecimento_w,e.cd_material, NULL,'C'),1,60)),1,60) ds_laboratorio 
from	estrutura_material_v e, 
	saldo_estoque s 
where	e.cd_material = s.cd_material 
and	s.dt_mesano_referencia = dt_mesano_referencia_w 
and	s.cd_estabelecimento = cd_estabelecimento_w 
and (ie_restringe_data_w = 'N' or 
		exists (	select	1 
			from	movimento_estoque m 
			where	m.cd_material = e.cd_material 
			and	m.cd_estabelecimento = cd_estabelecimento_w 
			and	m.dt_movimento_estoque between dt_inicio_movimento_w and dt_fim_movimento_w)) 
group by e.cd_material, 
	e.ds_material, 
	e.cd_grupo_material, 
	e.cd_subgrupo_material, 
	e.cd_classe_material, 
	substr(obter_dados_material_estab(e.cd_material,cd_estabelecimento_w,'UME'),1,30), 
	s.vl_custo_medio, 
	substr(obter_lab_brasindice(cd_estabelecimento_w,e.cd_material, null,'C'),1,60), 
	substr(obter_desc_mat_fabricante(e.cd_material),1,100) 
order by e.ds_material;


BEGIN 
 
/* Realizado este tratamento para correto funcionamento ao utilizar a function pelo gerenciador de relatórios, 
que passará '0' caso o usuário não selecione data válida.*/
 
begin 
dt_inicio_movimento_w	:=	inicio_dia(dt_inicio_movimento_p);
dt_fim_movimento_w	:=	fim_dia(dt_fim_movimento_p);
 
if (dt_inicio_movimento_w IS NOT NULL AND dt_inicio_movimento_w::text <> '') and (dt_fim_movimento_w IS NOT NULL AND dt_fim_movimento_w::text <> '') then 
	ie_restringe_data_w	:=	'S';
else 
	ie_restringe_data_w	:=	'N';
end if;
exception 
when others then 
	ie_restringe_data_w	:=	'N';
end;
 
dt_mesano_referencia_w	:= trunc(dt_mesano_referencia_p, 'mm');
cd_estabelecimento_w	:= cd_estabelecimento_p;
	 
if (coalesce(cd_estabelecimento_w, 0) = 0) then 
	cd_estabelecimento_w	:= wheb_usuario_pck.get_cd_estabelecimento;
end if;
 
open C01;
loop 
fetch C01 into 
	cd_material_w, 
	ds_material_w, 
	cd_grupo_material_w, 
	cd_subgrupo_material_w, 
	cd_classe_material_w, 
	cd_unidade_medida_estoque_w, 
	vl_custo_medio_w, 
	cd_laboratorio_w, 
	ds_fabricante_w, 
	ds_laboratorio_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
	 
	begin 
		select	b.cd_apresentacao 
		into STRICT	cd_apresentacao_w 
		from	material_brasindice b 
		where	b.cd_material = cd_material_w;
	exception 
	when others then 
		cd_apresentacao_w := null;	
	end;
 
	begin 
		select	p.cd_tiss 
		into STRICT	cd_tiss_w 
		from	material_brasindice b, 
			brasindice_preco p 
		where	b.cd_laboratorio = p.cd_laboratorio 
		and	b.cd_medicamento = p.cd_medicamento 
		and	b.cd_apresentacao = p.cd_apresentacao 
		and	b.cd_material = cd_material_w  
		order by p.dt_inicio_vigencia desc LIMIT 1;
	exception 
	when others then 
		cd_tiss_w := null;	
	end;
	 
	define_material_tuss(cd_estabelecimento_w, 
		cd_material_w, 
		null, 
		null, 
		null, 
		null, 
		dt_mesano_referencia_w, 
		null, 
		null, 
		null, 
		null, 
		cd_tuss_w, 
		nr_seq_tuss_mat_item_w, 
		ds_material_tuss_w, 
		null);
		 
	SELECT 	coalesce(MAX(obter_tuss_brasindice(cd_apresentacao, cd_laboratorio, cd_medicamento)),0) 
	into STRICT	cd_tuss_w 
	FROM  	material_brasindice 
	WHERE 	CD_MATERIAL = cd_material_w;
	 
	if (cd_tuss_w = 0) then 
		SELECT 	coalesce(MAX(OBTER_TUSS_SIMPRO_PRECO(nr_sequencia,clock_timestamp())),0) 
		into STRICT	cd_tuss_w 
		FROM  	material_simpro 
		WHERE 	CD_MATERIAL = cd_material_w;
	end if;
	 
	if (cd_tuss_w = 0) then 
		SELECT 	coalesce(MAX(cd_material_tuss),0) 
		into STRICT	cd_tuss_w 
		FROM  	material_tuss 
		WHERE 	CD_MATERIAL = cd_material_w;
	end if;
	 
	SELECT 	coalesce(MAX(tiss_obter_cod_brasindice(cd_apresentacao, cd_laboratorio, cd_medicamento)),0) 
	into STRICT	cd_tiss_w 
	FROM  	material_brasindice 
	WHERE 	CD_MATERIAL = cd_material_w;
	 
	if (cd_tiss_w = 0) then 
		SELECT 	coalesce(MAX(lpad(cd_simpro,10,0)),0) 
		into STRICT	cd_tiss_w 
		FROM  	material_simpro 
		WHERE 	CD_MATERIAL = cd_material_w;
	end if;
	 
	t_saldo_estoque_mat_row_w.cd_material		:= cd_material_w;
	t_saldo_estoque_mat_row_w.ds_material		:= ds_material_w;
	t_saldo_estoque_mat_row_w.cd_grupo_material		:= cd_grupo_material_w;
	t_saldo_estoque_mat_row_w.cd_subgrupo_material	:= cd_subgrupo_material_w;
	t_saldo_estoque_mat_row_w.cd_classe_material		:= cd_classe_material_w;
	t_saldo_estoque_mat_row_w.cd_unidade_medida_estoque	:= cd_unidade_medida_estoque_w;
	t_saldo_estoque_mat_row_w.vl_custo_medio		:= vl_custo_medio_w;
	t_saldo_estoque_mat_row_w.cd_laboratorio		:= cd_laboratorio_w;
	t_saldo_estoque_mat_row_w.ds_fabricante		:= ds_fabricante_w;
	t_saldo_estoque_mat_row_w.cd_apresentacao		:= cd_apresentacao_w;
	t_saldo_estoque_mat_row_w.cd_tiss			:= cd_tiss_w;
	t_saldo_estoque_mat_row_w.cd_tuss			:= cd_tuss_w;
	t_saldo_estoque_mat_row_w.ds_material_tuss		:= ds_material_tuss_w;
	t_saldo_estoque_mat_row_w.nr_seq_tuss_mat_item	:= nr_seq_tuss_mat_item_w;
	t_saldo_estoque_mat_row_w.ds_laboratorio		:= ds_laboratorio_w;
	 
	RETURN NEXT t_saldo_estoque_mat_row_w;
 
	end;
end loop;
close C01;
 
end;


$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION saldo_estoque_material_pck.obter_dados_material ( cd_estabelecimento_p bigint, dt_mesano_referencia_p timestamp, dt_inicio_movimento_p text, dt_fim_movimento_p text) FROM PUBLIC;
