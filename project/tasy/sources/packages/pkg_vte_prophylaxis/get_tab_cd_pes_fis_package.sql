-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

  --
CREATE OR REPLACE FUNCTION pkg_vte_prophylaxis.get_tab_cd_pes_fis (P_START_DATE timestamp, P_END_DATE timestamp, P_YEAR bigint, P_QUARTER bigint, P_ESTAB bigint, P_SETOR bigint) RETURNS SETOF T_TAB_CD_PES_FIS AS $body$
DECLARE


  V_START_DATE timestamp;
  V_END_DATE   timestamp;
  NM_USUARIO_W USUARIO.NM_USUARIO%TYPE;

  C_CD_PES_FIS CURSOR FOR
    SELECT DISTINCT CD_PESSOA_FISICA
      FROM (SELECT S.CD_ESTABELECIMENTO,
                   U.CD_SETOR_ATENDIMENTO,
                   A.CD_PESSOA_FISICA,
                   U.NR_ATENDIMENTO,
                   LEAST(V_END_DATE + 1, clock_timestamp()) DT_FIM,
                   MIN(U.DT_ENTRADA_UNIDADE) DT_ENTRADA_SETOR,
                   PKG_ATEND_PAC_UNID.GET_MAX_EXIT_UNIT(U.NR_ATENDIMENTO,
                                                        U.DT_ENTRADA_UNIDADE,
                                                        U.CD_SETOR_ATENDIMENTO) DT_SAIDA_SETOR
              FROM ATENDIMENTO_PACIENTE A,
                   ATEND_PACIENTE_UNIDADE U,
                   SETOR_ATENDIMENTO S
             WHERE A.NR_ATENDIMENTO = U.NR_ATENDIMENTO
               AND S.CD_SETOR_ATENDIMENTO = U.CD_SETOR_ATENDIMENTO
               AND S.CD_CLASSIF_SETOR = '4'
               AND U.IE_PASSAGEM_SETOR NOT IN ('S', 'L')
               AND EXISTS (SELECT 1 FROM USUARIO_SETOR US WHERE US.NM_USUARIO_PARAM = NM_USUARIO_W AND US.CD_SETOR_ATENDIMENTO = S.CD_SETOR_ATENDIMENTO)
               AND CASE WHEN coalesce(P_ESTAB, 0)=0 THEN  0  ELSE S.CD_ESTABELECIMENTO END  = coalesce(P_ESTAB, 0)
               AND CASE WHEN coalesce(P_SETOR, 0)=0 THEN  0  ELSE U.CD_SETOR_ATENDIMENTO END  = coalesce(P_SETOR, 0)
               AND A.DT_ENTRADA <= PKG_ATEND_PAC_UNID.GET_SYS_DT(A.CD_ESTABELECIMENTO, LEAST(FIM_DIA(V_END_DATE), clock_timestamp()))
               AND (coalesce(A.DT_ALTA::text, '') = '' OR
                    A.DT_ALTA >= PKG_ATEND_PAC_UNID.GET_SYS_DT(A.CD_ESTABELECIMENTO, V_START_DATE))
               AND U.DT_ENTRADA_UNIDADE <= PKG_ATEND_PAC_UNID.GET_SYS_DT(S.CD_ESTABELECIMENTO, LEAST(FIM_DIA(V_END_DATE), clock_timestamp()))
               AND coalesce(PKG_ATEND_PAC_UNID.GET_MAX_EXIT_UNIT(U.NR_ATENDIMENTO,
                                                            U.DT_ENTRADA_UNIDADE,
                                                            U.CD_SETOR_ATENDIMENTO),
                       PKG_ATEND_PAC_UNID.GET_SYS_DT(S.CD_ESTABELECIMENTO, V_START_DATE)) >=
                   PKG_ATEND_PAC_UNID.GET_SYS_DT(S.CD_ESTABELECIMENTO, V_START_DATE)
               GROUP BY U.NR_ATENDIMENTO,
                        A.CD_PESSOA_FISICA,
                        S.CD_ESTABELECIMENTO,
                        U.CD_SETOR_ATENDIMENTO,
                        PKG_ATEND_PAC_UNID.GET_MAX_EXIT_UNIT(U.NR_ATENDIMENTO,
                                                             U.DT_ENTRADA_UNIDADE,
                                                             U.CD_SETOR_ATENDIMENTO)) alias26
     WHERE coalesce(DT_SAIDA_SETOR, DT_FIM) - DT_ENTRADA_SETOR >= 1;
  TYPE T_CD_PES_FIS IS TABLE OF C_CD_PES_FIS%ROWTYPE;
  R_CD_PES_FIS T_CD_PES_FIS;

  
BEGIN
  
    NM_USUARIO_W := WHEB_USUARIO_PCK.GET_NM_USUARIO;

    IF (P_YEAR IS NOT NULL AND P_YEAR::text <> '') AND (P_QUARTER IS NOT NULL AND P_QUARTER::text <> '') THEN
    
      SELECT GREATEST(INI, coalesce(P_START_DATE, INI)) INI,
             LEAST(FIM, coalesce(P_END_DATE, FIM)) FIM
        INTO STRICT V_START_DATE,
             V_END_DATE
        FROM (SELECT TO_DATE(LPAD((P_QUARTER * 3) - 2, 2, '0') || P_YEAR, 'MMYYYY') INI,
                     LAST_DAY(TO_DATE(LPAD((P_QUARTER * 3), 2, '0') || P_YEAR, 'MMYYYY')) FIM
                ) alias13
       WHERE INI <= coalesce(P_END_DATE, INI)
         AND FIM >= coalesce(P_START_DATE, FIM);

      OPEN C_CD_PES_FIS;
      LOOP
        FETCH C_CD_PES_FIS BULK COLLECT INTO R_CD_PES_FIS LIMIT 1000;

          BEGIN
            FOR i IN R_CD_PES_FIS.FIRST..R_CD_PES_FIS.LAST LOOP
              RETURN NEXT R_CD_PES_FIS[i].CD_PESSOA_FISICA;
            END LOOP;
          EXCEPTION WHEN no_data_found THEN
            NULL;
          END;

        EXIT WHEN NOT FOUND; /* apply on C_CD_PES_FIS */
     
      END LOOP;
      CLOSE C_CD_PES_FIS;
  
    END IF;

    RETURN;
  END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pkg_vte_prophylaxis.get_tab_cd_pes_fis (P_START_DATE timestamp, P_END_DATE timestamp, P_YEAR bigint, P_QUARTER bigint, P_ESTAB bigint, P_SETOR bigint) FROM PUBLIC;
