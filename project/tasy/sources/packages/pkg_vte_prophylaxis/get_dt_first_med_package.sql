-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

  --
CREATE OR REPLACE FUNCTION pkg_vte_prophylaxis.get_dt_first_med (NR_ATEND bigint, DT_ENTRADA_SETOR timestamp, DT_SAIDA_SETOR timestamp) RETURNS timestamp AS $body$
DECLARE


    dt_treat_w  timestamp;


BEGIN

    SELECT MIN(pme.dt_prescricao)
      INTO STRICT dt_treat_w
      FROM prescr_medica pme
     INNER JOIN prescr_material pma
        ON pma.nr_prescricao = pme.nr_prescricao
     INNER JOIN material m
        ON m.cd_material = pma.cd_material
       AND m.ie_situacao = 'A'
     INNER JOIN classe_material cm
        ON cm.cd_classe_material = m.cd_classe_material
       AND cm.ie_situacao = 'A'
       AND cm.ie_classe_material_rel IN (27, 28, 29, 30, 31, 32)
       AND(cm.ie_classe_material_rel <> 27 OR (cm.ie_classe_material_rel = 27 AND (pma.qt_dose >= 500 or
               exists (SELECT 1 
                         from via_aplicacao v 
                        where pma.ie_via_aplicacao = v.ie_via_aplicacao 
                          and v.ie_situacao = 'A' 
                          and v.ie_tipo_rel in (1, 2, 3, 4)))))
     WHERE pme.nr_atendimento = NR_ATEND
       AND pme.dt_prescricao BETWEEN DT_ENTRADA_SETOR AND DT_SAIDA_SETOR;

    RETURN dt_treat_w;

  END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pkg_vte_prophylaxis.get_dt_first_med (NR_ATEND bigint, DT_ENTRADA_SETOR timestamp, DT_SAIDA_SETOR timestamp) FROM PUBLIC;
