-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_cartao_integracao_pck.capturar_pagamento (nr_sequencia_p pls_solic_pagto_cartao_cr.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE

        c01 CURSOR FOR
            SELECT prpcr.nr_pagamento,
                   pspcr.ie_situacao
              from pls_ret_pagto_cartao_cr   prpcr,
                   pls_solic_pagto_cartao_cr pspcr
             where prpcr.nr_seq_solic_pagto_cartao = pspcr.nr_sequencia
               and pspcr.nr_sequencia = nr_sequencia_p
               and (nr_pagamento IS NOT NULL AND nr_pagamento::text <> '');

        reg_integracao_w gerar_int_padrao.reg_integracao;
        achou_w          boolean := false;

BEGIN
        for pagamento in c01 loop
            achou_w := true;
            if not pls_cartao_integracao_pck.atualiza_situacao(nr_seq_solict_pagto_p => nr_sequencia_p,
                                     ie_situacao_p         => pagamento.ie_situacao,
                                     ie_situacao_novo_p    => '2',
                                     nm_usuario_p          => nm_usuario_p) then
                CALL wheb_mensagem_pck.exibir_mensagem_abort(1030330); -- 'Nao foi possivel atualizar a situacao da solicitacao.'
            end if;
            -- gerar integracao cielo

            reg_integracao_p     => reg_integracao_w := gerar_int_padrao.gravar_integracao(ie_evento_p          => current_setting('pls_cartao_integracao_pck.ie_evento_capturar_transacao')::valor_dominio.vl_dominio%type, nr_seq_documento_p   => nr_sequencia_p, nm_usuario_p         => nm_usuario_p, reg_integracao_p     => reg_integracao_w, ds_parametros_adic_p => 'PaymentId=' || pagamento.nr_pagamento);
        end loop;

        if not achou_w then
            CALL wheb_mensagem_pck.exibir_mensagem_abort(1030332); -- 'Nao foi possivel localizar esta solicitacao de pagamento.'
        end if;

    end;

    /*
    funcao  para atualizar a situacao da solicitacao de pagamento
    %param ie_situacao_p  situacao da solicitacao de nr_pagamento
    %param ie_situacao_novo_p  nova situacao da dolicitacao de pagamento
    %param nr_seq_solict_pagto_p sequencia da solicitacao de pagamento
    %param nm_usuario_p Nome do usuario que realizou a  atualizacao da sitaucao da  solicitacao
    */



$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_cartao_integracao_pck.capturar_pagamento (nr_sequencia_p pls_solic_pagto_cartao_cr.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;
