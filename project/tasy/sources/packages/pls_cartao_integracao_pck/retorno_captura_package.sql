-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_cartao_integracao_pck.retorno_captura (nr_sequencia_p intpd_fila_transmissao.nr_sequencia%type) AS $body$
DECLARE

        c02 CURSOR(nr_sequencia_p bigint) FOR
            SELECT ie_situacao from pls_solic_pagto_cartao_cr pspcr where pspcr.nr_sequencia = nr_sequencia_p;

        ds_log_w              text;
        nm_usuario_w          usuario.nm_usuario%type;
        nr_seq_documento_w    intpd_fila_transmissao.nr_seq_documento%type;
        ie_status_http_w      intpd_fila_transmissao.ie_status_http%type;
        ie_evento_w           intpd_fila_transmissao.ie_evento%type;
        erro_w                cielo_error_tab;
        ret_pagto_cartao_cr_w pls_ret_pagto_cartao_cr%rowtype;
        retorno_w             philips_json;
        ie_situacao_w         pls_solic_pagto_cartao_cr.ie_situacao%type;

BEGIN
        select ift.ds_message_response,
               ift.nm_usuario,
               ift.nr_seq_documento,
               ift.ie_status_http,
               ift.ie_evento
          into STRICT ds_log_w,
               nm_usuario_w,
               nr_seq_documento_w,
               ie_status_http_w,
               ie_evento_w
          from intpd_fila_transmissao ift
         where ift.nr_sequencia = nr_sequencia_p;

        case
            when ie_status_http_w in (200, 201) then
                retorno_w := philips_json(ds_log_w);
            when ie_status_http_w = 400 then
                erro_w := pls_cartao_integracao_pck.cielo_error(ds_log_w);
                for i in 1 .. erro_w.count loop
                    ret_pagto_cartao_cr_w.ds_mensagem_retorno := erro_w[i].message;
                    ret_pagto_cartao_cr_w.cd_retorno          := erro_w[i].code;
                end loop;
                ret_pagto_cartao_cr_w.nr_seq_solic_pagto_cartao := (nr_seq_documento_w)::numeric;

            when ie_status_http_w = 404 then
                ret_pagto_cartao_cr_w.ds_mensagem_retorno       := 'Not found';
                ret_pagto_cartao_cr_w.cd_retorno                := '404';
                ret_pagto_cartao_cr_w.nr_seq_solic_pagto_cartao := (nr_seq_documento_w)::numeric;
            else
                ret_pagto_cartao_cr_w.ds_mensagem_retorno       := 'Unknown status: ' || ie_status_http_w;
                ret_pagto_cartao_cr_w.cd_retorno                := ie_status_http_w;
                ret_pagto_cartao_cr_w.nr_seq_solic_pagto_cartao := (nr_seq_documento_w)::numeric;
        end case;
        ret_pagto_cartao_cr_w.ie_evento := ie_evento_w;

        select nextval('pls_ret_pagto_cartao_cr_seq') into STRICT ret_pagto_cartao_cr_w.nr_sequencia;

        ret_pagto_cartao_cr_w.nr_seq_solic_pagto_cartao := (nr_seq_documento_w)::numeric;
        ret_pagto_cartao_cr_w.dt_atualizacao_nrec       := clock_timestamp();
        ret_pagto_cartao_cr_w.nm_usuario_nrec           := nm_usuario_w;
        ret_pagto_cartao_cr_w.dt_atualizacao            := clock_timestamp();
        ret_pagto_cartao_cr_w.nm_usuario                := nm_usuario_w;
        ret_pagto_cartao_cr_w.dt_processamento          := clock_timestamp();
        open c02(ret_pagto_cartao_cr_w.nr_seq_solic_pagto_cartao);
        fetch c02
            into ie_situacao_w;
        close c02;
        insert into pls_ret_pagto_cartao_cr values (ret_pagto_cartao_cr_w.*);

        if not pls_cartao_integracao_pck.atualiza_situacao(nr_seq_solict_pagto_p => ret_pagto_cartao_cr_w.nr_seq_solic_pagto_cartao,
                                 ie_situacao_p         => ie_situacao_w,
                                 ie_situacao_novo_p    => '3',
                                 nm_usuario_p          => nm_usuario_w) then
            null;
        end if;

        update intpd_fila_transmissao set ie_status = 'S' where nr_sequencia = nr_sequencia_p;

    exception
        when others then
            update intpd_fila_transmissao set ie_status = 'E' where nr_sequencia = nr_sequencia_p;
    end;

    /*
    Procedimento para realizar o reenvio da solicitacao de pagamento
    %param nr_seq_pagamento_p numero do pagamento que sera reenviado
    %param nm_usuario_p nome do usuario que fez a solicitocao do pagamento
    */



$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_cartao_integracao_pck.retorno_captura (nr_sequencia_p intpd_fila_transmissao.nr_sequencia%type) FROM PUBLIC;
