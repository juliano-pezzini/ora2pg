-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_cartao_integracao_pck.bifrost_ret_pagto_cartao_cr (nr_seq_solic_pagto_cartao_p pls_ret_pagto_cartao_cr.nr_seq_solic_pagto_cartao%type, ds_sigla_moeda_p moeda.ds_sigla_moeda%type, ds_sg_pais_p pais.sg_pais%type, nr_nsu_p pls_ret_pagto_cartao_cr.nr_nsu%type, cd_autorizacao_p pls_ret_pagto_cartao_cr.cd_autorizacao%type, ds_tid_p pls_ret_pagto_cartao_cr.ds_tid%type, nr_pagamento_p pls_ret_pagto_cartao_cr.nr_pagamento%type, ie_status_p pls_ret_pagto_cartao_cr.ie_status%type, cd_retorno_p pls_ret_pagto_cartao_cr.cd_retorno%type, ds_mensagem_retorno_p pls_ret_pagto_cartao_cr.ds_mensagem_retorno%type, vl_solicitacao_p pls_ret_pagto_cartao_cr.vl_solicitacao%type) AS $body$
DECLARE

        c_01 CURSOR(ds_sigla_moeda_pc moeda.ds_sigla_moeda%type) FOR
            SELECT cd_moeda from moeda where ds_sigla_moeda = ds_sigla_moeda_pc;

        c_02 CURSOR(sg_pais_pc pais.sg_pais%type) FOR
            SELECT nr_sequencia from pais where sg_pais = sg_pais_pc;

        ret_pagto_cartao_cr_w pls_ret_pagto_cartao_cr%rowtype;
        ds_log_w              text;
        nm_usuario_w          usuario.nm_usuario%type;
        customer_w            philips_json;
        links_w               philips_json_list;
        erro_w                cielo_error_tab;
        nr_parte_retorno_w    pls_ret_pagto_cartao_cr.nr_parte_retorno%type := 0;

BEGIN
    
        select nextval('pls_ret_pagto_cartao_cr_seq') into STRICT ret_pagto_cartao_cr_w.nr_sequencia;

        open c_01(ds_sigla_moeda_p);
        fetch c_01
            into ret_pagto_cartao_cr_w.cd_moeda;
        close c_01;

        open c_02(ds_sg_pais_p);
        fetch c_02
            into ret_pagto_cartao_cr_w.nr_seq_pais;
        close c_02;

        nm_usuario_w := 'Webservice';

        ret_pagto_cartao_cr_w.ie_comercio_eletronico    := null;
        ret_pagto_cartao_cr_w.dt_atualizacao_nrec       := clock_timestamp();
        ret_pagto_cartao_cr_w.nm_usuario_nrec           := nm_usuario_w;
        ret_pagto_cartao_cr_w.dt_atualizacao            := clock_timestamp();
        ret_pagto_cartao_cr_w.nm_usuario                := nm_usuario_w;
        ret_pagto_cartao_cr_w.dt_processamento          := clock_timestamp();
        ret_pagto_cartao_cr_w.nr_seq_solic_pagto_cartao := nr_seq_solic_pagto_cartao_p;
        ret_pagto_cartao_cr_w.ds_tid                    := ds_tid_p;
        ret_pagto_cartao_cr_w.nr_nsu                    := nr_nsu_p;
        ret_pagto_cartao_cr_w.cd_autorizacao            := cd_autorizacao_p;
        ret_pagto_cartao_cr_w.nr_pagamento              := nr_pagamento_p;
        ret_pagto_cartao_cr_w.ie_status                 := ie_status_p;
        ret_pagto_cartao_cr_w.cd_retorno                := cd_retorno_p;
        ret_pagto_cartao_cr_w.nr_parte_retorno          := 1;
        ret_pagto_cartao_cr_w.ds_mensagem_retorno       := ds_mensagem_retorno_p;
        ret_pagto_cartao_cr_w.vl_solicitacao            := vl_solicitacao_p;

        insert into pls_ret_pagto_cartao_cr values (ret_pagto_cartao_cr_w.*);

        -- atualizar a situacao  da solicitacao

        if (cd_retorno_p = '4') and (not pls_cartao_integracao_pck.atualiza_situacao(nr_seq_solict_pagto_p => ret_pagto_cartao_cr_w.nr_seq_solic_pagto_cartao,
                                                           ie_situacao_p         => 0,
                                                           ie_situacao_novo_p    => '1',
                                                           nm_usuario_p          => nm_usuario_w)) then
            CALL wheb_mensagem_pck.exibir_mensagem_abort(1030340); -- 'Situacao da solicitacao foi modificado antes do recebimento to retorno.'
        end if;
    end;


$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_cartao_integracao_pck.bifrost_ret_pagto_cartao_cr (nr_seq_solic_pagto_cartao_p pls_ret_pagto_cartao_cr.nr_seq_solic_pagto_cartao%type, ds_sigla_moeda_p moeda.ds_sigla_moeda%type, ds_sg_pais_p pais.sg_pais%type, nr_nsu_p pls_ret_pagto_cartao_cr.nr_nsu%type, cd_autorizacao_p pls_ret_pagto_cartao_cr.cd_autorizacao%type, ds_tid_p pls_ret_pagto_cartao_cr.ds_tid%type, nr_pagamento_p pls_ret_pagto_cartao_cr.nr_pagamento%type, ie_status_p pls_ret_pagto_cartao_cr.ie_status%type, cd_retorno_p pls_ret_pagto_cartao_cr.cd_retorno%type, ds_mensagem_retorno_p pls_ret_pagto_cartao_cr.ds_mensagem_retorno%type, vl_solicitacao_p pls_ret_pagto_cartao_cr.vl_solicitacao%type) FROM PUBLIC;
