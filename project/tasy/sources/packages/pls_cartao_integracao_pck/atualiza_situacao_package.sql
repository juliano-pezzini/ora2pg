-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pls_cartao_integracao_pck.atualiza_situacao (nr_seq_solict_pagto_p pls_solic_pagto_cartao_cr.nr_sequencia%type, ie_situacao_p pls_solic_pagto_cartao_cr.ie_situacao%type, ie_situacao_novo_p pls_solic_pagto_cartao_cr.ie_situacao%type, nm_usuario_p usuario.nm_usuario%type) RETURNS boolean AS $body$
DECLARE


        dt_atualizacao_w              timestamp := clock_timestamp();
        nr_seq_pagador_fin_w          pls_contrato_pagador_fin.nr_sequencia%type;
        nr_titulo_w                   pls_solic_pagto_cartao_cr.nr_titulo%type;
        qt_parcela_w                  pls_solic_pagto_cartao_cr.qt_parcela%type;
        nr_seq_pls_ret_pagto_w        pls_ret_pagto_cartao_cr.nr_sequencia%type;
        cd_autorizacao_w              pls_ret_pagto_cartao_cr.cd_autorizacao%type;
        vl_solicitacao_w              pls_ret_pagto_cartao_cr.vl_solicitacao%type;
        nr_seq_bandeira_w             pls_contrato_pagador_fin.nr_seq_bandeira%type;
        cd_pessoa_fisica_w            pls_contrato_pagador.cd_pessoa_fisica%type;
        cd_cgc_w                      pls_contrato_pagador.cd_cgc%type;
        cd_estabelecimento_w          pls_contrato.cd_estabelecimento%type;
        nr_seq_forma_pagto_w          forma_pagto_cartao_cr.nr_sequencia%type;
        nr_nsu_w                      pls_ret_pagto_cartao_cr.nr_nsu%type;
        ds_mensagem_retorno_w         pls_ret_pagto_cartao_cr.ds_mensagem_retorno%type;
        ie_tipo_cartao_w              pls_ret_pagto_cartao_cr.ie_tipo_cartao%type;
        cd_tipo_recebimento_debito_w  pls_parametros.cd_tipo_recebimento_debito%type;
        cd_tipo_recebimento_credito_w pls_parametros.cd_tipo_recebimento_credito%type;
        cd_tipo_recebimento_w         tipo_recebimento.cd_tipo_recebimento%type := null;

BEGIN
    
        update pls_solic_pagto_cartao_cr
           set ie_situacao    = ie_situacao_novo_p,
               nm_usuario     = nm_usuario_p,
               dt_atualizacao = clock_timestamp()
         where nr_sequencia = nr_seq_solict_pagto_p
           and ie_situacao = ie_situacao_p;

        if (ie_situacao_novo_p = '1') then
            select dt_atualizacao,
                   nr_seq_pagador_fin,
                   nr_titulo,
                   qt_parcela
              into STRICT dt_atualizacao_w,
                   nr_seq_pagador_fin_w,
                   nr_titulo_w,
                   qt_parcela_w
              from pls_solic_pagto_cartao_cr
             where nr_sequencia = nr_seq_solict_pagto_p;

            select max(nr_sequencia),
                   max(cd_autorizacao),
                   max(vl_solicitacao),
                   max(nr_nsu),
                   max(nr_seq_bandeira),
                   max(ie_tipo_cartao)
              into STRICT nr_seq_pls_ret_pagto_w,
                   cd_autorizacao_w,
                   vl_solicitacao_w,
                   nr_nsu_w,
                   nr_seq_bandeira_w,
                   ie_tipo_cartao_w
              from pls_ret_pagto_cartao_cr
             where nr_seq_solic_pagto_cartao = nr_seq_solict_pagto_p
               and cd_retorno = '4';

            select coalesce(nr_seq_bandeira_w, b.nr_seq_bandeira),
                   a.cd_pessoa_fisica,
                   a.cd_cgc,
                   (select x.cd_estabelecimento from pls_contrato x where x.nr_sequencia = a.nr_seq_contrato) cd_estabelecimento
              into STRICT nr_seq_bandeira_w,
                   cd_pessoa_fisica_w,
                   cd_cgc_w,
                   cd_estabelecimento_w
              from pls_contrato_pagador     a,
                   pls_contrato_pagador_fin b
             where b.nr_seq_pagador = a.nr_sequencia
               and b.nr_sequencia = nr_seq_pagador_fin_w;

            select max(c.nr_sequencia) nr_seq_forma_pagto
              into STRICT nr_seq_forma_pagto_w
              from bandeira_cartao_cr    a,
                   forma_pagto_tef       b,
                   forma_pagto_cartao_cr c
             where a.nr_sequencia = b.nr_seq_bandeira
               and c.nr_sequencia = b.nr_seq_forma_pagto
               and b.ie_tipo_cartao = ie_tipo_cartao_w
               and a.nr_sequencia = nr_seq_bandeira_w;

            select max(cd_tipo_recebimento_credito),
                   max(cd_tipo_recebimento_debito)
              into STRICT cd_tipo_recebimento_credito_w,
                   cd_tipo_recebimento_debito_w
              from pls_parametros
             where cd_estabelecimento = cd_estabelecimento_w;

            if (ie_tipo_cartao_w = 'C') then
                cd_tipo_recebimento_w := cd_tipo_recebimento_credito_w;
            elsif (ie_tipo_cartao_w = 'D') then
                cd_tipo_recebimento_w := cd_tipo_recebimento_debito_w;
            end if;

            if (coalesce(nr_seq_forma_pagto_w::text, '') = '') then
                select max(c.nr_sequencia) nr_seq_forma_pagto
                  into STRICT nr_seq_forma_pagto_w
                  from bandeira_cartao_cr    a,
                       forma_pagto_tef       b,
                       forma_pagto_cartao_cr c
                 where a.nr_sequencia = b.nr_seq_bandeira
                   and c.nr_sequencia = b.nr_seq_forma_pagto
                   and b.ie_tipo_cartao = 'A'
                   and a.nr_sequencia = nr_seq_bandeira_w;
            end if;

            if (nr_seq_pls_ret_pagto_w IS NOT NULL AND nr_seq_pls_ret_pagto_w::text <> '') then
                begin
                    CALL baixa_titulo_cartao_integracao(substr(nr_titulo_w, 1, 255),
                                                   nm_usuario_p,
                                                   cd_tipo_recebimento_w, --cd_tipo_recebimento_p    
                                                   nr_seq_pls_ret_pagto_w, --nr_seq_pls_ret_pagto_p
                                                   /*dados do cartao - campos obrigatorios*/


                                                   cd_estabelecimento_w, --cd_estabelecimento_p
                                                   dt_atualizacao_w, --dt_transacao_p
                                                   ie_tipo_cartao_w, --ie_tipo_cartao_p
                                                   cd_autorizacao_w, --nr_autorizacao_p
                                                   nr_seq_bandeira_w, --nr_seq_bandeira_p
                                                   vl_solicitacao_w, --vl_transacao_p
                                                   nr_seq_forma_pagto_w, --nr_seq_forma_pagto_p
                                                   /*dados do cartao - campos mutuamente exclusivos*/


                                                   cd_cgc_w, --cd_cgc_p
                                                   cd_pessoa_fisica_w, --cd_pessoa_fisica_p
                                                   /*dados do cartao - campos opcionais*/


                                                   substr(nr_nsu_w, 1, 100), --ds_comprovante_p
                                                   'Titulo: ' || nr_titulo_w, --ds_observacao_p
                                                   null, --dt_importacao_p
                                                   null, --nr_cartao_p
                                                   qt_parcela_w, --qt_parcela_p
                                                   null, --vl_desconto_operadora_p
                                                   /*esses campos aqui em baixo do cartao sao da integracao com tef, acredito que nao sejam utilizados..*/


                                                   null,
                                                   null,
                                                   null,
                                                   null,
                                                   null,
                                                   null,
                                                   null,
                                                   null);
                exception
                    when others then
                        ds_mensagem_retorno_w := ' ' || wheb_mensagem_pck.get_texto(1112564) || nr_titulo_w || ' Oracle: ' ||
                                                 SQLSTATE || ' : ' || sqlerrm;
                end;
            end if;
        end if;

        update pls_ret_pagto_cartao_cr
           set ds_mensagem_retorno = coalesce(ds_mensagem_retorno_w, ds_mensagem_retorno)
         where nr_seq_solic_pagto_cartao = nr_seq_solict_pagto_p
           and cd_retorno = '4';

        return FOUND;
    end;


$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pls_cartao_integracao_pck.atualiza_situacao (nr_seq_solict_pagto_p pls_solic_pagto_cartao_cr.nr_sequencia%type, ie_situacao_p pls_solic_pagto_cartao_cr.ie_situacao%type, ie_situacao_novo_p pls_solic_pagto_cartao_cr.ie_situacao%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;
