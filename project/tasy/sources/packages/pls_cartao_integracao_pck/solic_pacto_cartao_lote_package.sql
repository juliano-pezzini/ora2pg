-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_cartao_integracao_pck.solic_pacto_cartao_lote (nr_seq_lote_p pls_lote_mensalidade.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE

        c_01 CURSOR FOR
            SELECT tr.nr_titulo,
                   pm.nr_seq_pagador_fin,
                   substr(obter_nome_fantasia_estab(tr.cd_estabelecimento), 1, 13) ds_curta_fatura
              from pls_mensalidade pm,
                   titulo_receber  tr
             where pm.nr_seq_lote = nr_seq_lote_p
               and pm.nr_seq_forma_cobranca = 5
               and tr.nr_seq_mensalidade = pm.nr_sequencia
               and not exists (SELECT 1 from pls_solic_pagto_cartao_cr c where c.nr_titulo = tr.nr_titulo);

BEGIN
    
        for mensalidade_w in c_01 loop
            CALL pls_cartao_integracao_pck.solic_pacto_cartao(nr_seq_pagador_fin_p => mensalidade_w.nr_seq_pagador_fin,
                               nr_titulo_p          => mensalidade_w.nr_titulo,
                               qt_parcela_p         => 1,
                               ds_curta_fatura_p    => mensalidade_w.ds_curta_fatura,
                               nm_usuario_p         => nm_usuario_p);
        end loop;
    end;

    /*
    Procedimento para cancelar a solicitacao de pagamento
    %param nr_sequencia_p Sequencia da solicitacao de pagamento
    %param nm_usuario_p nome do usuario que solicitou a captura do pagamento
    */


$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_cartao_integracao_pck.solic_pacto_cartao_lote (nr_seq_lote_p pls_lote_mensalidade.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;
