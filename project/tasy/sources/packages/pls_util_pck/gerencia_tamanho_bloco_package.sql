-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_util_pck.gerencia_tamanho_bloco ( ie_tipo_p text) AS $body$
BEGIN

-- se for para aumentar
if (ie_tipo_p = 'AUMENTAR') then

	-- o valor estiver null
	-- caso tenha valor não precisa executar novamente, pois já passou aqui uma vez
	if (current_setting('pls_util_pck.vl_param_session_gp')::coalesce(integer::text, '') = '') then

		-- Verifica o parametro Oracle db_file_multiblock_read_count. O mesmo deve ter 128 ou mais para execução desta rotina por conta do
		-- select de vários registros e os diversos inserts\updates que serão feitos.
		begin
			EXECUTE	'select to_number(max(value)) ' ||
						'from	v$parameter ' ||
						'where  name = ''db_file_multiblock_read_count'' '
		into STRICT	current_setting('pls_util_pck.vl_param_session_gp')::integer;
		exception
		when others then
			-- ganha 1000 pra não entrar nos if's e não alterar nada.
			PERFORM set_config('pls_util_pck.vl_param_session_gp', 1000, false);
		end;

		-- Se tiver menos que esse valor então manda para 128 e no fim da rotina será retornado ao original caso foi alterado.
		if (current_setting('pls_util_pck.vl_param_session_gp')::integer < 128) then

			-- Trata a exceção, se não der para alterar deixa como está,
			begin
				EXECUTE 'alter session set db_file_multiblock_read_count=128';
			exception
			when others then
				null;
			end;
		end if;
	end if;
else
	-- se o parametro teve que ser alterado então volta como tava.
	if (current_setting('pls_util_pck.vl_param_session_gp')::integer < 128 and current_setting('pls_util_pck.vl_param_session_gp')::(integer IS NOT NULL AND integer::text <> '')) then

		-- Trata a exceção, se não der para alterar deixa como está,
		begin
			EXECUTE 'alter session set db_file_multiblock_read_count=' || current_setting('pls_util_pck.vl_param_session_gp')::integer;
		exception
		when others then
			null;
		end;
	end if;

end if;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_util_pck.gerencia_tamanho_bloco ( ie_tipo_p text) FROM PUBLIC;
