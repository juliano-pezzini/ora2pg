-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE ptu_moviment_benf_a100_v18_pck.processar_arquivo ( nr_seq_lote_p bigint, cd_unimed_destino_p ptu_mov_benef_destino.cd_unimed_destino%type, arq_texto_p utl_file.file_type) AS $body$
DECLARE

	
	ds_conteudo_w			varchar(4000);
	ptu_mov_benef_lote_w		ptu_mov_benef_lote%rowtype;
	ptu_mov_benef_contagem_w	ptu_mov_benef_contagem%rowtype;
	ptu_mov_benef_trailer_w		ptu_mov_benef_trailer%rowtype;
	ds_reservado_w			char(1);
	nr_versao_transacao_w		varchar(10);
	nr_seq_intercabio_w		bigint;
	tp_registro_w			bigint;
	nr_sequencia_w			bigint;
	cd_tipo_registro_w		varchar(3);
	cd_unimed_destino_w		varchar(10);
	cd_unimed_origem_w		varchar(10);
	dt_geracao_w			timestamp;
	ie_tipo_mov_w			varchar(1);
	dt_mov_inicio_w			timestamp;
	dt_mov_fim_w			timestamp;
	cd_filial_w			bigint;
	nm_empr_comp_w			varchar(40);
	nm_empr_abrev_w			varchar(30);
	cd_cgc_cpf_w			varchar(14);
	cd_cnpj_w			varchar(14);
	nr_insc_estadual_w		bigint;
	ds_endereco_w			varchar(40);
	ds_complemento_w		varchar(20);
	ds_bairro_w			varchar(30);
	cd_cep_w			varchar(8);
	nr_ddd_w			bigint;
	dt_inclusao_w			timestamp;
	dt_exclusao_w			timestamp;
	cd_empresa_origem_w		bigint;
	cd_municipio_ibge_w		varchar(7);
	nr_telefone_w			bigint;
	nr_fax_w			bigint;
	nr_endereco_empresa_w		varchar(6);
	cd_plano_origem_w		varchar(6);
	ds_plano_origem_w		varchar(40);
	cd_plano_intercambio_w		varchar(3);
	dt_inclusao_plano_w		timestamp;
	dt_exclusao_plano_w		timestamp;
	ie_natureza_w			bigint;
	ie_abrangencia_w		bigint;
	nr_ind_reembolso		bigint;
	cd_ope_ans_w			varchar(10);
	cd_prod_ans_w			varchar(20);
	ie_plano_w			varchar(1);
	cd_unimed_w			varchar(10);
	cd_usuario_plano_w		varchar(13);
	cd_familia_w			bigint;
	nm_benef_abreviado_w		varchar(25);
	cd_plano_intercambio_benef_w	varchar(3);
	dt_nascimento_w			timestamp;
	ie_sexo_w			varchar(1);
	cd_cgc_cpf_benef_w		varchar(15);
	nr_rg_w				varchar(15);
	sg_uf_rg_w			varchar(2);
	ie_estado_civil_w		varchar(1);
	dt_inclusao_benef_w		timestamp;
	dt_exclusao_benef_w		timestamp;
	ie_repasse_w			varchar(1);
	cd_dependencia_w		bigint;
	ie_recem_nascido_w		varchar(1);
	nr_matricula_w			varchar(20);
	dt_validade_carteira_w		timestamp;
	cd_local_atendimento_w		bigint;
	cd_lotacao_w			varchar(8);
	ds_lotacao_w			varchar(30);
	dt_fim_repasse_w		timestamp;
	dt_inclusao_plano_dest_w	timestamp;
	cd_plano_origem_benef_w		varchar(6);
	nr_vigencia_origem_w		bigint;
	cd_titular_plano_w		varchar(13);
	nm_beneficiario_w		varchar(120);
	nr_cartao_nac_sus_w		varchar(20);
	nm_mae_benef_w			varchar(255);
	nr_pis_pasep_w			varchar(11);
	cd_segmentacao_ptu_w		varchar(2);
	qt_total_r102_w			varchar(4);
	qt_total_r102_aux_w		bigint := 0;
	qt_total_r103_w			varchar(4);
	qt_total_r103_aux_w		bigint := 0;
	qt_total_r104_w			varchar(7);
	qt_total_inclusao_w		varchar(7);
	qt_exclusos_benef_w		varchar(7);
	qt_total_alteracoes_w		bigint;
	qt_total_transferencia_w	bigint;
	qt_total_r105_w			varchar(7);
	qt_total_r106_w			varchar(7);
	qt_total_r107_w			varchar(7);
	qt_total_r108_w			varchar(7);
	dt_postagem_w			timestamp;
	nr_protocolo_w			bigint;
	nr_seq_plano_w			bigint;
	nr_seq_segurado_w		bigint;
	nr_seq_empresa_w		bigint;
	nr_seq_benef_w			bigint;
	nr_ind_reembolso_w		bigint;
	ds_hash_w			varchar(32);
	ie_contrato_local_w		ptu_intercambio_empresa.ie_contrato_local%type;
	cd_caepf_w			ptu_intercambio_empresa.cd_caepf%type;
	dt_comp_risco_w			ptu_intercambio_benef.dt_comp_risco%type;
	ie_exclusao_rn412_w		ptu_intercambio_benef.ie_exclusao_rn412%type;
	nr_contrato_w			varchar(15);
	nm_social_w			varchar(70);
	nm_social_abreviado_w		varchar(25);
	cd_motivo_exclusao_w		varchar(2);
	tp_genero_social_w		varchar(1);
	
	C01 CURSOR FOR /*R101 - Header*/
	SELECT	coalesce(nr_sequencia,0)	nr_seq_intercambio,
		1			tp_registro,
		1			nr_sequencia,
		'101'			cd_tipo_registro,
		coalesce(cd_unimed_destino,0) cd_unimed_destino,
		coalesce(cd_unimed_origem,0)	cd_unimed_origem,
		dt_geracao		dt_geracao,
		coalesce(ie_tipo_mov,' ')	ie_tipo_mov,
		dt_mov_inicio		dt_mov_inicio,
		dt_mov_fim		dt_mov_fim,
		coalesce(nr_versao_transacao,0)	nr_versao_transacao
	from	ptu_intercambio
	where	nr_sequencia = ptu_moviment_benf_a100_v18_pck.get_cd_intercambio();
	
	C02 CURSOR FOR
	SELECT	 distinct 
		2			tp_registro,
		2			nr_sequencia,
		'102'			cd_tipo_registro,
		coalesce(a.cd_filial,0)		cd_filial,
		coalesce(a.ds_razao_social,' ')	nm_empr_comp,
		coalesce(a.nm_empr_abrev,' ')	nm_empr_abrev,
		coalesce(a.cd_cgc_cpf,0)		cd_cgc_cpf,
		a.nr_insc_estadual	nr_insc_estadual,
		coalesce(a.ds_endereco,' ')	ds_endereco,
		coalesce(a.ds_complemento,' ')	ds_complemento,
		coalesce(a.ds_bairro,' ')		ds_bairro,
		coalesce(a.cd_cep,0)		cd_cep,		
		coalesce(a.nr_ddd,0)		nr_ddd,
		--a.dt_inclusao		dt_inclusao,
		--a.dt_exclusao		dt_exclusao,
		coalesce(a.cd_empresa_origem,0)	cd_empresa_origem,
		coalesce(a.cd_municipio_ibge,0)	cd_municipio_ibge,
		a.nr_telefone		nr_telefone,
		a.nr_fax		nr_fax,
		coalesce(a.nr_endereco,'S/N') nr_endereco_empresa,
		coalesce(a.ie_contrato_local, '1')	ie_contrato_local,
		coalesce(a.cd_caepf,0) cd_caepf
	from	ptu_intercambio_empresa	a
	where	a.nr_seq_intercambio = ptu_moviment_benf_a100_v18_pck.get_cd_intercambio();
	
	C03 CURSOR FOR  --plano empresa
	SELECT	distinct
		3			tp_registro,
		3			nr_sequencia,
		'103'			cd_tipo_registro,
		coalesce(b.cd_filial,0)	cd_filial,
		coalesce(lpad(a.cd_plano_origem,6,'0') ,0) cd_plano_origem,
		coalesce(a.ds_plano_origem,0)	ds_plano_origem,
		coalesce(a.cd_plano_intercambio,0)	cd_plano_intercambio,
		--a.dt_inclusao		dt_inclusao_plano,
		--a.dt_exclusao		dt_exclusao_plano,
		coalesce(a.ie_natureza,0)		ie_natureza,
		coalesce(a.ie_abrangencia,0)	ie_abrangencia,
		coalesce(a.nr_ind_reembolso,0)	nr_ind_reembolso,
		coalesce(a.cd_ope_ans,0)		cd_ope_ans,
		coalesce(a.ie_plano,' ')		ie_plano,
		coalesce(a.nr_seq_plano,0)	nr_seq_plano
	from	ptu_intercambio_empresa	b,
		ptu_intercambio_plano	a
	where	a.nr_seq_empresa	= b.nr_sequencia
	and	b.nr_seq_intercambio = get_cd_intercambio
	and	b.cd_cgc_cpf = cd_cgc_cpf_w
	and (coalesce(b.cd_filial::text, '') = '' or b.cd_filial = cd_filial_w)
	and (coalesce(b.cd_empresa_origem::text, '') = '' or b.cd_empresa_origem = cd_empresa_origem_w);
	
	C04 CURSOR FOR  -- beneficiarios empresa
	SELECT	4			tp_registro,
		4			nr_sequencia,
		'104'			cd_tipo_registro,
		coalesce(b.cd_filial,0)	cd_filial,
		coalesce(a.cd_unimed,0)		cd_unimed,
		coalesce(a.cd_usuario_plano,0)	cd_usuario_plano,
		coalesce(a.cd_familia,0)		cd_familia,
		coalesce(a.nm_benef_abreviado,' ')	nm_benef_abreviado,
		coalesce(a.cd_plano_intercambio,0)	cd_plano_intercambio_benef,
		a.dt_nascimento			dt_nascimento,
		coalesce(a.ie_sexo,' ')		ie_sexo,
		coalesce(a.cd_cgc_cpf,0)	cd_cgc_cpf_benef,	--checar
		coalesce(a.nr_rg,' ')		nr_rg,
		coalesce(a.sg_uf_rg,' ')		sg_uf_rg,
		coalesce(a.ie_estado_civil,' ')	ie_estado_civil,
		a.dt_inclusao		dt_inclusao_benef,
		a.dt_exclusao		dt_exclusao_benef,
		coalesce(a.ie_repasse,' ')	ie_repasse,
		coalesce(a.cd_dependencia,0)	cd_dependencia,
		coalesce(a.ie_recem_nascido,' ')	ie_recem_nascido,
		coalesce(trim(both a.nr_matricula),0)	nr_matricula,
		a.dt_validade_carteira	dt_validade_carteira,
		coalesce(a.cd_local_atendimento,0)	cd_local_atendimento,
		coalesce(a.cd_lotacao,0)	cd_lotacao,
		coalesce(a.ds_lotacao,' ')		ds_lotacao,
		a.dt_fim_repasse	dt_fim_repasse,
		a.dt_inclusao_plano_dest dt_inclusao_plano_dest,
		coalesce(a.cd_plano_origem,0)	cd_plano_origem_benef,
		coalesce(a.nr_vigencia_origem,0)	nr_vigencia_origem,
		coalesce(a.cd_titular_plano,0)	cd_titular_plano,
		coalesce(a.nm_beneficiario,' ')	nm_beneficiario,
		coalesce(a.nr_cartao_nac_sus,' ')	nr_cartao_nac_sus,
		coalesce(elimina_acentuacao(a.nm_mae_benef),' ') nm_mae_benef,
		coalesce(a.nr_pis_pasep,0)		nr_pis_pasep,
		coalesce(a.cd_segmentacao_ptu,0)	cd_segmentacao_ptu,
		coalesce(a.nr_seq_segurado,0)	nr_seq_segurado,
		coalesce(a.nr_sequencia,0)		nr_seq_benef,
		a.dt_comp_risco		dt_comp_risco,
		ie_exclusao_rn412	ie_exclusao_rn412,
		( SELECT	coalesce(y.nr_contrato,x.nr_seq_intercambio)
				FROM pls_segurado x
LEFT OUTER JOIN pls_contrato y ON (x.nr_seq_contrato = y.nr_sequencia)
WHERE x.nr_sequencia	= a.nr_seq_segurado ) nr_contrato,
		coalesce(a.nm_social,' ') 		nm_social,
		coalesce(a.nm_social_abreviado,' ') 	nm_social_abreviado,
		coalesce(a.cd_motivo_exclusao,'0')	cd_motivo_exclusao,
		coalesce(ie_tipo_genero_social,' ')	tp_genero_social
	from	ptu_intercambio_empresa	b,
		ptu_intercambio_benef	a
	where	a.nr_seq_empresa	= b.nr_sequencia
	and	b.nr_seq_intercambio = get_cd_intercambio
	and	b.cd_cgc_cpf = cd_cgc_cpf_w
	and (coalesce(b.cd_filial::text, '') = '' or b.cd_filial = cd_filial_w)
	and (coalesce(b.cd_empresa_origem::text, '') = '' or b.cd_empresa_origem = cd_empresa_origem_w);
	
	C05 CURSOR(nr_seq_benef_pc	ptu_intercambio_benef.nr_sequencia%type) FOR  -- carência beneficiarios 
	SELECT	coalesce(b.cd_tipo_cobertura,0)  cd_tipo_cobertura,
		b.dt_fim_carencia  dt_fim_carencia
	from	ptu_beneficiario_carencia b
	where	b.nr_seq_beneficiario  = nr_seq_benef_pc;
	
	C06 CURSOR(nr_seq_benef_pc	ptu_intercambio_benef.nr_sequencia%type) FOR  -- beneficiario plano agregado
	SELECT	coalesce(a.cd_tipo_produto,0)	cd_tipo_produto,
		coalesce(a.ds_produto,' ')		ds_produto
	from	ptu_benef_plano_agregado a
	where	a.nr_seq_beneficiario = nr_seq_benef_pc;
	
	C07 CURSOR(nr_seq_benef_pc	ptu_intercambio_benef.nr_sequencia%type) FOR  -- beneficiário complemento
	SELECT	coalesce(a.ds_endereco,' ')	ds_endereco_benef,
		coalesce(a.ds_bairro,' ')	ds_bairro_benef,
		coalesce(a.cd_cep,0)		cd_cep_benef,
		coalesce(a.nm_municipio,' ')	nm_municipio,
		coalesce(a.sg_uf,0)		sg_uf_benef,
		coalesce(a.nr_ddd,0)		nr_ddd_benef,
		coalesce(a.nr_ramal,0)	nr_ramal,
		coalesce(a.nr_fone,0)	nr_fone,
		coalesce(a.nr_endereco,0)	nr_endereco
	from	ptu_beneficiario_compl	a
	where	a.nr_seq_beneficiario = nr_seq_benef_pc;
	
	C08 CURSOR(nr_seq_benef_pc	ptu_intercambio_benef.nr_sequencia%type) FOR  -- beneficiário pré-existência
	SELECT	coalesce(a.cd_cid,0)		cd_cid,
		a.dt_fim_carencia	dt_fim_carencia_preex
	from	ptu_benef_preexistencia a
	where	a.nr_seq_beneficiario = nr_seq_benef_pc;
	
	
BEGIN
	PERFORM set_config('ptu_moviment_benf_a100_v18_pck.nr_sequencial_arq_w', 0, false);
	ds_reservado_w		:= '';
	
	open C01;
	loop
	fetch C01 into
		nr_seq_intercabio_w,
		tp_registro_w,
		nr_sequencia_w,
		cd_tipo_registro_w,
		cd_unimed_destino_w,
		cd_unimed_origem_w,
		dt_geracao_w,
		ie_tipo_mov_w,
		dt_mov_inicio_w,
		dt_mov_fim_w,
		nr_versao_transacao_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		ds_conteudo_w := '';
		/*R101 - Header*/

		ds_conteudo_w	:= lpad(cd_unimed_destino_w,4,0) || lpad(cd_unimed_origem_w,4,0) || to_char(dt_geracao_w,'YYYYMMDD') ||
				   lpad(ie_tipo_mov_w,1,0) || to_char(dt_mov_inicio_w,'YYYYMMDD') || to_char(dt_mov_fim_w,'YYYYMMDD') ||
				   '18';
		CALL CALL CALL CALL CALL CALL ptu_moviment_benf_a100_v18_pck.incluir_linha_arq('101',ds_conteudo_w,arq_texto_p);
		open C02;
		loop
		fetch C02 into
				tp_registro_w,
				nr_sequencia_w,
				cd_tipo_registro_w,
				cd_filial_w,
				nm_empr_comp_w,
				nm_empr_abrev_w,
				cd_cgc_cpf_w,
				nr_insc_estadual_w,
				ds_endereco_w,
				ds_complemento_w,
				ds_bairro_w,
				cd_cep_w,
				nr_ddd_w,
				--dt_inclusao_w,
				--dt_exclusao_w,
				cd_empresa_origem_w,
				cd_municipio_ibge_w,
				nr_telefone_w,
				nr_fax_w,
				nr_endereco_empresa_w,
				ie_contrato_local_w,
				cd_caepf_w;
		EXIT WHEN NOT FOUND; /* apply on C02 */
			begin
			--'102' - empresa contratante			
			select 	min(a.dt_inclusao),
				max(a.dt_exclusao)
			into STRICT	dt_inclusao_w,
				dt_exclusao_w
			from	ptu_intercambio_empresa	a
			where	a.nr_seq_intercambio = nr_seq_intercabio_w
			and (coalesce(cd_filial::text, '') = '' or cd_filial = cd_filial_w)
			and	a.cd_cgc_cpf = cd_cgc_cpf_w;
			
			select	CASE WHEN cd_caepf_w='0' THEN cd_cgc_cpf_w  ELSE '0' END  --Se CAEPF estiver informado, precisa enviar zeros no CNPJ
			into STRICT	cd_cnpj_w
			;
			
			ds_conteudo_w	:= lpad(ds_reservado_w,4,' ') || lpad(cd_filial_w,3,0) || rpad(nm_empr_comp_w,40,' ') ||
					rpad(ds_reservado_w,18,' ') || lpad(ds_reservado_w,1,' ') || lpad(cd_cnpj_w,15,'0') ||
					lpad(nr_insc_estadual_w,20,'0') || rpad(ds_endereco_w,40,' ') || rpad(ds_complemento_w,20,' ') ||
					rpad(ds_bairro_w,30,' ') || rpad(cd_cep_w,8,' ') || rpad(ds_reservado_w,30,' ') ||
					rpad(ds_reservado_w,2,' ') || lpad(nr_ddd_w,4,0) || lpad(ds_reservado_w,8,' ') ||
					lpad(ds_reservado_w,8,' ') || coalesce(to_char(dt_inclusao_w,'YYYYMMDD'),'        ')|| coalesce(to_char(dt_exclusao_w,'YYYYMMDD'),'        ') ||
					lpad(cd_empresa_origem_w,10,0) || lpad(cd_municipio_ibge_w,7,0) || lpad(nr_telefone_w,9,'0') ||
					lpad(nr_fax_w,9,'0') || lpad(nr_endereco_empresa_w,6,'0') || rpad(nm_empr_abrev_w,30,' ') || ie_contrato_local_w || lpad(cd_caepf_w,14,'0');
			CALL CALL CALL CALL CALL CALL ptu_moviment_benf_a100_v18_pck.incluir_linha_arq('102',ds_conteudo_w,arq_texto_p);
			qt_total_r102_aux_w := qt_total_r102_aux_w + 1;
			
			open C03;
			loop
			fetch C03 into
					tp_registro_w,
					nr_sequencia_w,
					cd_tipo_registro_w,
					cd_filial_w,
					cd_plano_origem_w,
					ds_plano_origem_w,
					cd_plano_intercambio_w,
					--dt_inclusao_plano_w,
					--dt_exclusao_plano_w,
					ie_natureza_w,
					ie_abrangencia_w,
					nr_ind_reembolso_w,
					cd_ope_ans_w,
					--cd_prod_ans_w,
					ie_plano_w,
					nr_seq_plano_w;		
			EXIT WHEN NOT FOUND; /* apply on C03 */
				begin
				
				select	coalesce(max(a.cd_prod_ans),0)
				into STRICT	cd_prod_ans_w				
				from	ptu_intercambio_empresa	b,
					ptu_intercambio_plano	a
				where	a.nr_seq_empresa	= b.nr_sequencia
				and	b.nr_seq_intercambio = nr_seq_intercabio_w
				and	b.cd_cgc_cpf = cd_cgc_cpf_w
				and (coalesce(b.cd_filial::text, '') = '' or b.cd_filial = cd_filial_w)
				and	a.nr_seq_plano = nr_seq_plano_w;
				
				select 	min(b.dt_inclusao),
					max(b.dt_exclusao)
				into STRICT	dt_inclusao_plano_w,
					dt_exclusao_plano_w
				from	ptu_intercambio_empresa	a,
					ptu_intercambio_plano	b
				where	b.nr_seq_empresa	= a.nr_sequencia				
				and	a.nr_seq_intercambio = nr_seq_intercabio_w
				and	a.cd_cgc_cpf = cd_cgc_cpf_w
				and (coalesce(cd_filial::text, '') = '' or cd_filial = cd_filial_w)
				and	b.nr_seq_plano = nr_seq_plano_w;
				
				
				/*R103 - Plano da Empresa Contratante*/

				ds_conteudo_w	:= 	lpad(cd_plano_origem_w,6,' ') || rpad(ds_plano_origem_w,40,' ') || lpad(ds_reservado_w,2,' ') ||
							coalesce(to_char(dt_inclusao_plano_w,'YYYYMMDD'),'        ') || coalesce(to_char(dt_exclusao_plano_w,'YYYYMMDD'),'        ') || lpad(ie_natureza_w,1,' ') ||
							lpad(ie_abrangencia_w,1,' ') || lpad(nr_ind_reembolso_w,5,0) || lpad(cd_ope_ans_w,10,'0') ||
							rpad(cd_prod_ans_w,20,' ') || lpad(ie_plano_w,1,' ') || rpad(cd_plano_intercambio_w,3,' ');
				CALL CALL CALL CALL CALL CALL ptu_moviment_benf_a100_v18_pck.incluir_linha_arq('103',ds_conteudo_w,arq_texto_p);
				qt_total_r103_aux_w := qt_total_r103_aux_w + 1;
				end;
				end loop;
				close C03;
				
				open C04;
				loop
				fetch C04 into
					tp_registro_w,
					nr_sequencia_w,
					cd_tipo_registro_w,
					cd_filial_w,
					cd_unimed_w,
					cd_usuario_plano_w,
					cd_familia_w,
					nm_benef_abreviado_w,
					cd_plano_intercambio_benef_w,
					dt_nascimento_w,
					ie_sexo_w,
					cd_cgc_cpf_benef_w,	--checar
					nr_rg_w,
					sg_uf_rg_w,
					ie_estado_civil_w,
					dt_inclusao_benef_w,
					dt_exclusao_benef_w,
					ie_repasse_w,
					cd_dependencia_w,
					ie_recem_nascido_w,
					nr_matricula_w,
					dt_validade_carteira_w,
					cd_local_atendimento_w,
					cd_lotacao_w,
					ds_lotacao_w,
					dt_fim_repasse_w,
					dt_inclusao_plano_dest_w,
					cd_plano_origem_benef_w,
					nr_vigencia_origem_w,
					cd_titular_plano_w,
					nm_beneficiario_w,
					nr_cartao_nac_sus_w,
					nm_mae_benef_w,
					nr_pis_pasep_w,
					cd_segmentacao_ptu_w,
					nr_seq_segurado_w,
					nr_seq_benef_w,
					dt_comp_risco_w,
					ie_exclusao_rn412_w,
					nr_contrato_w,
					nm_social_w,
					nm_social_abreviado_w,
					cd_motivo_exclusao_w,
					tp_genero_social_w;
				EXIT WHEN NOT FOUND; /* apply on C04 */
					begin
					
					/*R104 - Beneficiário*/

					ds_conteudo_w	:= lpad(cd_unimed_w,4,0) || lpad(ds_reservado_w,3,' ') || lpad(cd_usuario_plano_w,13,' ') ||
							lpad(cd_familia_w,6,0) || rpad(nm_benef_abreviado_w,25,' ') || lpad(ds_reservado_w,2,' ') || 
							to_char(dt_nascimento_w,'YYYYMMDD') || lpad(ie_sexo_w,1,' ') || lpad(cd_cgc_cpf_benef_w,15,'0') || 
							lpad(nr_rg_w,15,'0') || lpad(sg_uf_rg_w,2,' ') || lpad(ie_estado_civil_w,1,' ') || 
							to_char(dt_inclusao_benef_w,'YYYYMMDD') || coalesce(to_char(dt_exclusao_benef_w,'YYYYMMDD'),'        ') || lpad(ie_repasse_w,1,' ') ||
							lpad(cd_dependencia_w,2,0) || lpad(ie_recem_nascido_w,1,' ') || lpad(nr_matricula_w,20,'0') ||
							to_char(dt_validade_carteira_w,'YYYYMMDD') || lpad(cd_local_atendimento_w,4,0) || lpad(cd_lotacao_w,8,'0') ||
							lpad(ds_lotacao_w,30,' ') || lpad(ds_reservado_w,64,' ') || lpad(ds_reservado_w,8,' ') ||
							coalesce(to_char(dt_fim_repasse_w,'YYYYMMDD'),'        ') || coalesce(to_char(dt_inclusao_plano_dest_w,'YYYYMMDD'),'        ') || 
							lpad(ds_reservado_w,2,' ') || lpad(cd_plano_origem_benef_w,6,0) || lpad(nr_vigencia_origem_w,4,0) || 
							lpad(cd_titular_plano_w,13,0) || rpad(nm_beneficiario_w,120,' ') || lpad(nr_cartao_nac_sus_w,15,0) || 
							rpad(nm_mae_benef_w,70,' ') || 	lpad(nr_pis_pasep_w,11,'0') || rpad(cd_plano_intercambio_benef_w,3,' ') || 
							lpad(cd_segmentacao_ptu_w,2,0) || coalesce(to_char(dt_comp_risco_w,'YYYYMMDD'),'        ') || coalesce(ie_exclusao_rn412_w, ' ') ||
							rpad(nr_contrato_w,15,' ') || rpad(nm_social_w,70,' ') || rpad(nm_social_abreviado_w,25,' ')|| rpad(tp_genero_social_w,1,' ') || rpad(cd_motivo_exclusao_w,2,'0');
					CALL CALL CALL CALL CALL CALL ptu_moviment_benf_a100_v18_pck.incluir_linha_arq('104',ds_conteudo_w,arq_texto_p);
					
					
					--R105 - Carência do Beneficiário
					for r_c05_w in C05(nr_seq_benef_w) loop
						begin
						ds_conteudo_w	:= lpad(r_c05_w.cd_tipo_cobertura,3,0) || to_char(r_c05_w.dt_fim_carencia,'YYYYMMDD');
						CALL CALL CALL CALL CALL CALL ptu_moviment_benf_a100_v18_pck.incluir_linha_arq('105',ds_conteudo_w,arq_texto_p);
						end;
					end loop;
					
					--R106 - Módulos opcionais do Beneficiário (Produtos agregados)
					for r_c06_w in C06(nr_seq_benef_w) loop
						begin
						ds_conteudo_w	:= rpad(r_c06_w.cd_tipo_produto,2,' ') || rpad(ptu_somente_caracter_permitido(r_c06_w.ds_produto,'ANS'),20,' ');
						CALL CALL CALL CALL CALL CALL ptu_moviment_benf_a100_v18_pck.incluir_linha_arq('106',ds_conteudo_w,arq_texto_p);
						end;
					end loop;
					
					--R107 - Complemento Cadastral do Beneficiário
					for r_c07_w in C07(nr_seq_benef_w) loop
						begin
						ds_conteudo_w := rpad(r_c07_w.ds_endereco_benef,40,' ') || rpad(r_c07_w.ds_bairro_benef,30,' ') || lpad(r_c07_w.cd_cep_benef,8,'0') ||
								rpad(r_c07_w.nm_municipio,30,' ') || rpad(r_c07_w.sg_uf_benef,2,' ') || lpad(r_c07_w.nr_ddd_benef,4,0) ||
								lpad(ds_reservado_w,8,' ') || lpad(r_c07_w.nr_ramal,4,'0') || lpad(r_c07_w.nr_fone,9,'0') ||
								lpad(r_c07_w.nr_endereco,6,'0');
						CALL CALL CALL CALL CALL CALL ptu_moviment_benf_a100_v18_pck.incluir_linha_arq('107',ds_conteudo_w,arq_texto_p);
						end;
					end loop;
					
					--R108 - Preexistências do Beneficiário
					for r_c08_w in C08(nr_seq_benef_w) loop
						begin
						ds_conteudo_w	:= rpad(r_c08_w.cd_cid,4,' ') || to_char(r_c08_w.dt_fim_carencia_preex,'YYYYMMDD');
						CALL CALL CALL CALL CALL CALL ptu_moviment_benf_a100_v18_pck.incluir_linha_arq('108',ds_conteudo_w,arq_texto_p);	
						end;
					end loop;
					
				end;
				end loop;
				close C04;
			
			end;
			end loop;
			close C02;
			
			/*R109 - Trailer*/

			qt_total_r102_w := coalesce(substr(qt_total_r102_aux_w,1,4),0);	
			qt_total_r103_w	:= coalesce(substr(qt_total_r103_aux_w,1,4),0);		
			qt_total_r104_w	:= coalesce(substr(obter_quantidade_registro_ptu(nr_seq_intercabio_w,'104'),1,7),0);	
			qt_total_inclusao_w := coalesce(substr(obter_quantidade_registro_ptu(nr_seq_intercabio_w,'QT_INCLUSAO'),1,7),0);	
			qt_exclusos_benef_w := coalesce(substr(obter_quantidade_registro_ptu(nr_seq_intercabio_w,'QT_EXCLUSAO'),1,7),0);	
			qt_total_r105_w := coalesce(substr(obter_quantidade_registro_ptu(nr_seq_intercabio_w,'105'),1,7),0);
			qt_total_r106_w := coalesce(substr(obter_quantidade_registro_ptu(nr_seq_intercabio_w,'106'),1,7),0);	
			qt_total_r107_w := coalesce(substr(obter_quantidade_registro_ptu(nr_seq_intercabio_w,'107'),1,7),0);	
			qt_total_r108_w := coalesce(substr(obter_quantidade_registro_ptu(nr_seq_intercabio_w,'108'),1,7),0);	
			qt_total_alteracoes_w := 0;	
			qt_total_transferencia_w := 0;			
			
			ds_conteudo_w	:= lpad(qt_total_r102_w,4,0) || lpad(qt_total_r103_w,4,0) || lpad(qt_total_r104_w,7,0) ||
					   lpad(qt_total_inclusao_w,7,0) || lpad(qt_exclusos_benef_w,7,0) || lpad(qt_total_alteracoes_w,7,0) ||
					   lpad(qt_total_transferencia_w,7,0) || lpad(qt_total_r105_w,7,0) || lpad(qt_total_r106_w,7,0) ||
					   lpad(qt_total_r107_w,7,0) || lpad(qt_total_r108_w,7,0);
			CALL CALL CALL CALL CALL CALL ptu_moviment_benf_a100_v18_pck.incluir_linha_arq('109',ds_conteudo_w,arq_texto_p);
			
			qt_total_r102_aux_w := 0;
			qt_total_r103_aux_w := 0;
				
		end;
		end loop;
		close C01;

	current_setting('ptu_moviment_benf_a100_v18_pck.ds_arquivo_w')::text := pls_hash_ptu_pck.obter_hash_txt(current_setting('ptu_moviment_benf_a100_v18_pck.ds_arquivo_w')::text);
	ds_conteudo_w		:=	lpad(ds_hash_w,32,' ');
	CALL CALL CALL CALL CALL CALL ptu_moviment_benf_a100_v18_pck.incluir_linha_arq('998',ds_conteudo_w,arq_texto_p);
	
	update 	ptu_intercambio
	set 	ds_hash_a100	= ds_hash_w,
		nm_arquivo 	= get_nome_arquivo
	where 	nr_sequencia 	= ptu_moviment_benf_a100_v18_pck.get_cd_intercambio();
	commit;
	end;
	

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ptu_moviment_benf_a100_v18_pck.processar_arquivo ( nr_seq_lote_p bigint, cd_unimed_destino_p ptu_mov_benef_destino.cd_unimed_destino%type, arq_texto_p utl_file.file_type) FROM PUBLIC;
