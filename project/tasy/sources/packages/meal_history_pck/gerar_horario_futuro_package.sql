-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION meal_history_pck.gerar_horario_futuro ( ds_horario_p text, dt_ult_horario_p timestamp, dt_inicio_p timestamp, dt_fim_p timestamp, dt_lib_suspensao_p timestamp, nr_seq_item_cpoe_p bigint) RETURNS SETOF T_TIMES AS $body$
   --generate future times
DECLARE


	t_times_row_r			t_times_row;
	qt_dia_adic_w			bigint := 0;
	ds_horarios_padrao_rec_w	varchar(4000)	:= ds_horario_p;
	k				integer;
	ds_hora_rec_w			varchar(2000);
	ie_urgencia_w			varchar(10)	:= 'N';
	qt_dia_prim_hor_w		bigint	:= 0;
	dt_ult_horario_w		timestamp	:= trunc(dt_ult_horario_p);
	dt_horario_w			timestamp;


	
BEGIN

	if (ds_horarios_padrao_rec_w IS NOT NULL AND ds_horarios_padrao_rec_w::text <> '') then


		while dt_ult_horario_w	<= current_setting('meal_history_pck.dt_end_w')::timestamp loop
			begin
			ds_horarios_padrao_rec_w	:= ds_horario_p;

			while 	(ds_horarios_padrao_rec_w IS NOT NULL AND ds_horarios_padrao_rec_w::text <> '') loop
				begin

				k	:=	position(' ' in ds_horarios_padrao_rec_w);

				if (k > 1) and ((substr(ds_horarios_padrao_rec_w, 1, k -1) IS NOT NULL AND (substr(ds_horarios_padrao_rec_w, 1, k -1))::text <> '')) then
					ds_hora_rec_w			:= substr(ds_horarios_padrao_rec_w, 1, k-1);
					ds_hora_rec_w			:= replace(ds_hora_rec_w, ' ','');
					ds_horarios_padrao_rec_w	:= substr(ds_horarios_padrao_rec_w, k + 1, 2000); --
				elsif (ds_horarios_padrao_rec_w IS NOT NULL AND ds_horarios_padrao_rec_w::text <> '') then
					ds_hora_rec_w			:= replace(ds_horarios_padrao_rec_w,' ','');
					ds_horarios_padrao_rec_w	:= '';
				end if;


				if (position('A' in ds_hora_rec_w) > 0) and (qt_dia_adic_w = 0) and (ie_urgencia_w = 'N') and (qt_dia_prim_hor_w = 0) then
					qt_dia_adic_w	:= 1;
				elsif (position('AA' in ds_hora_rec_w) > 0) and (ie_urgencia_w = 'N') and (qt_dia_prim_hor_w = 0) then
					qt_dia_adic_w	:= qt_dia_adic_w + 1;
				end if;


				ds_hora_rec_w	:= replace(ds_hora_rec_w,'A','');
				ds_hora_rec_w	:= replace(ds_hora_rec_w,'A','');

				dt_horario_w	:= to_date(to_char( dt_ult_horario_w + qt_dia_adic_w,'dd/mm/yyyy')||' '||replace(ds_hora_rec_w,'A','')||':00','dd/mm/yyyy hh24:mi:ss');

				if (dt_horario_w	> clock_timestamp()) and (dt_horario_w	>= dt_inicio_p) and (coalesce(dt_fim_p::text, '') = '' or dt_horario_w <= dt_fim_p) and (coalesce(dt_lib_suspensao_p::text, '') = '' or dt_horario_w <= dt_lib_suspensao_p) then

					t_times_row_r.nr_seq_item_cpoe	:= nr_seq_item_cpoe_p;
					t_times_row_r.dt_horario		:= dt_horario_w;
					t_times_row_r.ie_future		:= 'S';

					RETURN NEXT t_times_row_r;
				end if;

				end;
			end loop;
			dt_ult_horario_w	:= dt_ult_horario_w + 1;

			end;
		end loop;

	end if;

	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION meal_history_pck.gerar_horario_futuro ( ds_horario_p text, dt_ult_horario_p timestamp, dt_inicio_p timestamp, dt_fim_p timestamp, dt_lib_suspensao_p timestamp, nr_seq_item_cpoe_p bigint) FROM PUBLIC;
