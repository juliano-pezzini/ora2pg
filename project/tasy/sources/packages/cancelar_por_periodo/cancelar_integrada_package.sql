-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE cancelar_por_periodo.cancelar_integrada (nr_sequencia_p bigint, ie_tipo_agenda_p text, nm_usuario_p text) AS $body$
DECLARE


nr_seq_agenda_int_w agenda_integrada_item.nr_seq_agenda_int%type;
ie_cancelar_integrada_w varchar(1) := 'S';
nr_seq_status_canc_w integer;

c01 CURSOR FOR
  SELECT nr_seq_agenda_exame,
    nr_seq_agenda_cons
  from agenda_integrada_item
  where nr_seq_agenda_int = nr_seq_agenda_int_w
  and ((nr_seq_agenda_exame IS NOT NULL AND nr_seq_agenda_exame::text <> '')
  or (nr_seq_agenda_cons IS NOT NULL AND nr_seq_agenda_cons::text <> ''));

BEGIN
  if ie_tipo_agenda_p = 'E' then

    select max(nr_seq_agenda_int)
    into STRICT nr_seq_agenda_int_w
    from agenda_integrada_item
    where nr_seq_agenda_exame = nr_sequencia_p;

  elsif ie_tipo_agenda_p in ('S', 'C') then

    select max(nr_seq_agenda_int)
    into STRICT nr_seq_agenda_int_w
    from agenda_integrada_item
    where nr_seq_agenda_cons = nr_sequencia_p;

  end if;

  if (nr_seq_agenda_int_w IS NOT NULL AND nr_seq_agenda_int_w::text <> '') then

    for c_01 in c01 loop

      if (c_01.nr_seq_agenda_exame IS NOT NULL AND c_01.nr_seq_agenda_exame::text <> '') then
        select CASE WHEN count(1)=0 THEN  'S'  ELSE 'N' END
        into STRICT ie_cancelar_integrada_w
        from agenda_paciente
        where nr_sequencia = c_01.nr_seq_agenda_exame
        and ie_status_agenda <> 'C';

        if ie_cancelar_integrada_w = 'N' then
          exit;
        end if;

      elsif (c_01.nr_seq_agenda_cons IS NOT NULL AND c_01.nr_seq_agenda_cons::text <> '') then
        select CASE WHEN count(1)=0 THEN  'S'  ELSE 'N' END
        into STRICT ie_cancelar_integrada_w
        from agenda_consulta
        where nr_sequencia = c_01.nr_seq_agenda_cons
        and ie_status_agenda <> 'C';

        if ie_cancelar_integrada_w = 'N' then
          exit;
        end if;
      end if;

    end loop;

    if ie_cancelar_integrada_w = 'S' then

      select	max(nr_sequencia)
      into STRICT nr_seq_status_canc_w
      from  agenda_integrada_status
      where  ie_situacao = 'A'
      and ie_status_tasy = 'CA';

      update	agenda_integrada
      set	nr_seq_status = nr_seq_status_canc_w,
        dt_fim_Agendamento = clock_timestamp()
      where	nr_sequencia = nr_seq_agenda_int_w;

      CALL Ageint_gravar_log(wheb_mensagem_pck.get_texto(791208), 'S', nr_seq_agenda_int_w, nm_usuario_p);

      CALL Limpar_Marcacao_Ageint(nr_seq_agenda_int_w, nm_usuario_p);

    end if;
  end if;
end;


$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cancelar_por_periodo.cancelar_integrada (nr_sequencia_p bigint, ie_tipo_agenda_p text, nm_usuario_p text) FROM PUBLIC;
