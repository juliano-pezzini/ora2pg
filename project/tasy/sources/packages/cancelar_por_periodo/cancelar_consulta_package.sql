-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE cancelar_por_periodo.cancelar_consulta (dt_inicial_p timestamp, dt_final_p timestamp, hr_inicial_p timestamp, hr_final_p timestamp, cd_agenda_p bigint, cd_dia_semana_p bigint, cd_motivo_p bigint, cd_pessoa_fisica_p text, ie_lista_espera_p text, ie_reabilitacao_p text) AS $body$
DECLARE



dt_inicial_w timestamp;
dt_final_w timestamp;
hr_inicial_w timestamp;
hr_final_w timestamp;

dt_agenda_padrao_w varchar(20);
ie_dia_semana_agen_w smallint;
dt_formatada_w varchar(255);
ie_permissao_w varchar(1);
qt_registros_w integer;
contador integer := 0;

ds_avisos_w text;
ds_avisos_temp_w varchar(4000);

cd_estabelecimento_w integer;
nm_pessoa_fisica_w varchar(255);
cd_perfil_w integer;

ie_todos_pac_espera_w varchar(1);
ie_aviso_agen_pendente_w varchar(1);
ie_remover_lista_espera_w varchar(1);
ie_cancelar_com_atend_w varchar(1);
ie_cancelar_futuros_w  varchar(1);

C01 CURSOR FOR
  SELECT dt_agenda,
    nr_atendimento,
    cd_agenda,
    nr_seq_lista_espera,
    nr_sequencia,
    nr_seq_lista_reab,
    cd_pessoa_fisica,
    cd_agendamento_externo,
    substr(obter_se_pac_age_futura(nr_sequencia),1,1) ie_agenda_futura
  from agenda_consulta
  where ie_status_agenda not in ('L', 'B', 'F', 'I', 'A', 'O', 'E', 'C')
  and cd_agenda = cd_agenda_p
  and ((cd_pessoa_fisica IS NOT NULL AND cd_pessoa_fisica::text <> '') or (nm_paciente IS NOT NULL AND nm_paciente::text <> ''))
  and dt_agenda between dt_inicial_w and dt_final_w
  order by dt_agenda;


BEGIN
  CALL cancelar_por_periodo.validar_data_hora(dt_inicial_p, dt_final_p, hr_inicial_p, hr_final_p);

  cd_estabelecimento_w := obter_estabelecimento_ativo;
  nm_pessoa_fisica_w := obter_usuario_ativo;
  cd_perfil_w := obter_perfil_ativo;

  Obter_Param_Usuario(821, 143, cd_perfil_w, nm_pessoa_fisica_w, cd_estabelecimento_w, ie_cancelar_com_atend_w);
  Obter_Param_Usuario(821, 414, cd_perfil_w, nm_pessoa_fisica_w, cd_estabelecimento_w, ie_todos_pac_espera_w);
  Obter_Param_Usuario(821, 264, cd_perfil_w, nm_pessoa_fisica_w, cd_estabelecimento_w, ie_aviso_agen_pendente_w);
  Obter_Param_Usuario(821, 24, cd_perfil_w, nm_pessoa_fisica_w, cd_estabelecimento_w, ie_remover_lista_espera_w);
  Obter_Param_Usuario(821, 186, cd_perfil_w, nm_pessoa_fisica_w, cd_estabelecimento_w, ie_cancelar_futuros_w);

  select obter_agenda_regra_permissao(cd_pessoa_fisica_p, cd_agenda_p, 'C', cd_perfil_w)
  into STRICT ie_permissao_w
;

  dt_agenda_padrao_w := 'vazio';
  dt_inicial_w := trunc(coalesce(dt_inicial_p, clock_timestamp()));
  dt_final_w := fim_dia(coalesce(dt_final_p, to_date('9999', 'yyyy')));

  for c_01 in C01 loop

    if to_char(c_01.dt_agenda, 'dd/mm/yyyy') <> dt_agenda_padrao_w then

      dt_agenda_padrao_w := to_char(c_01.dt_agenda, 'dd/mm/yyyy');
      hr_inicial_w := to_date(dt_agenda_padrao_w || to_char(hr_inicial_p, 'HH24:mi') , 'dd/mm/yyyy HH24:mi');
      hr_final_w  := to_date(dt_agenda_padrao_w || to_char(hr_final_p, 'HH24:mi') , 'dd/mm/yyyy HH24:mi');
      ie_dia_semana_agen_w := Obter_Cod_Dia_Semana(c_01.dt_agenda);
    end if;

    if (c_01.dt_agenda between hr_inicial_w and hr_final_w) and (coalesce(cd_dia_semana_p::text, '') = '' or ie_dia_semana_agen_w = cd_dia_semana_p or (cd_dia_semana_p = 9 and ie_dia_semana_agen_w not in (1,7))) then

        dt_formatada_w := pkg_date_formaters.to_varchar(c_01.dt_agenda, 'short', cd_estabelecimento_w, nm_pessoa_fisica_w);

        if ie_cancelar_com_atend_w <> 'S' and (c_01.nr_atendimento IS NOT NULL AND c_01.nr_atendimento::text <> '') then

          PERFORM set_config('cancelar_por_periodo.ds_texto_retorno_w', current_setting('cancelar_por_periodo.ds_texto_retorno_w')::text || dt_formatada_w || ' - ' || ' bloqueio parametro 143. procurara expressao depois' || chr(10), false);

        elsif obter_agenda_regra_permissao(cd_pessoa_fisica_p,c_01.cd_agenda, 'C', cd_perfil_w) = 'N' then

          PERFORM set_config('cancelar_por_periodo.ds_texto_retorno_w', current_setting('cancelar_por_periodo.ds_texto_retorno_w')::text || dt_formatada_w || ' - ' || wheb_mensagem_pck.get_texto(191162, null) || chr(10), false);

        else
          if ie_lista_espera_p = 'S' and (c_01.nr_seq_lista_espera IS NOT NULL AND c_01.nr_seq_lista_espera::text <> '') then
            CALL Cancelar_agenda_lista_espera(c_01.nr_seq_lista_espera, nm_pessoa_fisica_w, 'C');
          end if;
          ds_avisos_temp_w := '';
          if ie_todos_pac_espera_w <> 'N' and Obter_Se_Pac_Espera_Agenda(c_01.cd_agenda) = 'S' then
            ds_avisos_temp_w := ' - ' || wheb_mensagem_pck.get_texto(198131, null) || chr(10);
          end if;
          if ie_aviso_agen_pendente_w = 'S' and obter_se_existe_agenda_pac(cd_pessoa_fisica_p, c_01.dt_agenda) > 0 then
            ds_avisos_temp_w := ds_avisos_temp_w || ' - ' || wheb_mensagem_pck.get_texto(89353, null) || chr(10);
          end if;
          if ie_remover_lista_espera_w = 'S' then

            select count(*)
            into STRICT qt_registros_w
            from agenda_lista_espera
            where nr_seq_agecons = c_01.nr_sequencia;

            if qt_registros_w > 0 then
              CALL deletar_agenda_lista_espera(c_01.nr_sequencia);
            end if;
          end if;
          CALL alterar_status_agenda_cons(cd_estabelecimento_w, c_01.cd_agenda, c_01.nr_sequencia, 'C', cd_motivo_p, null, 'N', nm_pessoa_fisica_w, null);
          contador := contador + 1;
          current_setting('cancelar_por_periodo.info_integracao_status_w')::info_integracao_status_table[contador].nr_sequencia := c_01.nr_sequencia;
          current_setting('cancelar_por_periodo.info_integracao_status_w')::info_integracao_status_table[contador].cd_agendamento_externo := c_01.cd_agendamento_externo;
          current_setting('cancelar_por_periodo.info_integracao_status_w')::info_integracao_status_table[contador].cd_pessoa_fisica := c_01.cd_pessoa_fisica;
          if ie_reabilitacao_p = 'S' and (c_01.nr_seq_lista_reab IS NOT NULL AND c_01.nr_seq_lista_reab::text <> '') then
            CALL Alter_Status_Lista_Reab('A', c_01.nr_seq_lista_reab, c_01.nr_sequencia, 'C', 'N', nm_pessoa_fisica_w);
          end if;
          if ie_cancelar_futuros_w = 'S' and c_01.ie_agenda_futura = 'S' then
            CALL Cancelar_AgeCons_Futura(c_01.cd_agenda, c_01.dt_agenda, c_01.cd_pessoa_fisica, cd_motivo_p, null, nm_pessoa_fisica_w, null);
          end if;
          if (ds_avisos_temp_w IS NOT NULL AND ds_avisos_temp_w::text <> '') then
            ds_avisos_w := ds_avisos_w || dt_formatada_w || chr(10) || ds_avisos_temp_w;
          end if;
          CALL cancelar_por_periodo.cancelar_integrada(c_01.nr_sequencia, 'C', nm_pessoa_fisica_w);
        end if;

      end if;

  end loop;

  if (ds_avisos_w IS NOT NULL AND ds_avisos_w::text <> '') then
    PERFORM set_config('cancelar_por_periodo.ds_texto_retorno_w', current_setting('cancelar_por_periodo.ds_texto_retorno_w')::text || chr(10) || 'Avisos:' || chr(10) || ds_avisos_w, false);
  end if;
end;


$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cancelar_por_periodo.cancelar_consulta (dt_inicial_p timestamp, dt_final_p timestamp, hr_inicial_p timestamp, hr_final_p timestamp, cd_agenda_p bigint, cd_dia_semana_p bigint, cd_motivo_p bigint, cd_pessoa_fisica_p text, ie_lista_espera_p text, ie_reabilitacao_p text) FROM PUBLIC;
