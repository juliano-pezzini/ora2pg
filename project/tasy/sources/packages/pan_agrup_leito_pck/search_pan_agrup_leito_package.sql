-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pan_agrup_leito_pck.search_pan_agrup_leito ( cd_setor_atendimento_p bigint, ie_meus_pacientes_p text, cd_setor_avan_p text, cd_departamento_p bigint, ie_paramseven_p text, ie_sem_acomodacao_p text, ie_departamento_medico_p text, cd_estabelecimento_p bigint, ie_todos_setores_p text, nm_usuario_p text) RETURNS SETOF PAN_AGRUP_LEITO_T AS $body$
DECLARE

				
		
	get_values_r		get_pan_agrup_leito_row;

	cd_departamento_w			integer;
	ds_departamento_w			varchar(255);
	cd_setor_atendimento_w		integer;
	ds_setor_atendimento_w		varchar(255);
	ie_pronto_atendimento_w		varchar(1);
	cd_classif_setor_w			varchar(10);
	ie_sem_acomodacao_w			varchar(1);
	ie_emprestado_w				varchar(1);

	c01 CURSOR FOR
		SELECT distinct
				cd_departamento, 
				ds_departamento, 
				cd_setor_atendimento, 
				ds_setor_atendimento, 
				ie_pronto_atendimento, 
				cd_classif_setor, 
				ie_sem_acomodacao, 
				ie_emprestado
		from w_pan_agrup_leito
		where ie_concluido = 'S'
		and cd_departamento	= cd_departamento_p
		and	obter_se_usuario_setor(nm_usuario_p, cd_setor_atendimento) = 'S'
		and ((coalesce(ie_paramseven_p::text, '') = '') or Obter_Se_Contido(cd_classif_setor,ie_paramseven_p) = 'S')
		and	coalesce(ie_meus_pacientes_p,'N') = 'N'
		and coalesce(ie_todos_setores_p,'N') = 'N'
		and	coalesce(ie_departamento_medico_p,'N') = 'N'
		and	ie_sem_acomodacao = ie_sem_acomodacao_p
		and cd_estabelecimento = cd_estabelecimento_p
		and ((coalesce(cd_setor_avan_p::text, '') = '' and (coalesce(cd_setor_atendimento_p::text, '') = '' or cd_setor_atendimento = cd_setor_atendimento_p)) 
			or ((cd_setor_atendimento in (WITH RECURSIVE cte AS (
SELECT regexp_substr(cd_setor_avan_p,'[^,]+',1,level)  (regexp_substr(cd_setor_avan_p,'[^,]+',1,level) IS NOT NULL AND (regexp_substr(cd_setor_avan_p,'[^,]+',1,level))::text <> '')  UNION ALL
SELECT regexp_substr(cd_setor_avan_p,'[^,]+',1,level) JOIN cte c ON ()

) SELECT * FROM cte;
)) or cd_setor_atendimento = cd_setor_atendimento_p))
		
union

		select distinct 
				null cd_departamento, 
				null ds_departamento, 
				cd_setor_atendimento, 
				ds_setor_atendimento, 
				ie_pronto_atendimento, 
				cd_classif_setor, 
				ie_sem_acomodacao, 
				ie_emprestado
		from w_pan_agrup_leito
		where ie_concluido = 'S'
		and coalesce(cd_departamento_p::text, '') = ''
		and	ie_sem_acomodacao = ie_sem_acomodacao_p
		and	coalesce(ie_meus_pacientes_p,'N') = 'N'
		and coalesce(ie_todos_setores_p,'N') = 'N'
		and	coalesce(ie_departamento_medico_p,'N') = 'N'
		and	obter_se_usuario_setor(nm_usuario_p, cd_setor_atendimento) = 'S'
		and ((coalesce(ie_paramseven_p::text, '') = '') or Obter_Se_Contido(cd_classif_setor,ie_paramseven_p) = 'S')
		and cd_estabelecimento = cd_estabelecimento_p
		and ((coalesce(cd_setor_avan_p::text, '') = '' and cd_setor_atendimento = cd_setor_atendimento_p)
			or ((cd_setor_atendimento in (WITH RECURSIVE cte AS (
select regexp_substr(cd_setor_avan_p,'[^,]+',1,level)  (regexp_substr(cd_setor_avan_p,'[^,]+',1,level) IS NOT NULL AND (regexp_substr(cd_setor_avan_p,'[^,]+',1,level))::text <> '')  UNION ALL
select regexp_substr(cd_setor_avan_p,'[^,]+',1,level) JOIN cte c ON ()

) SELECT * FROM cte;
)) or cd_setor_atendimento = cd_setor_atendimento_p))
		
union

		select distinct 
				null cd_departamento, 
				null ds_departamento, 
				cd_setor_atendimento, 
				ds_setor_atendimento, 
				ie_pronto_atendimento, 
				cd_classif_setor, 
				ie_sem_acomodacao, 
				ie_emprestado
		from w_pan_agrup_leito
		where ie_concluido = 'S'
		and coalesce(cd_departamento_p::text, '') = ''
		and	obter_se_usuario_setor(nm_usuario_p, cd_setor_atendimento) = 'S'
		and ((coalesce(ie_paramseven_p::text, '') = '') or Obter_Se_Contido(cd_classif_setor,ie_paramseven_p) = 'S')
		and	ie_sem_acomodacao = ie_sem_acomodacao_p
		and	coalesce(ie_meus_pacientes_p,'N') = 'S'
		and coalesce(ie_todos_setores_p,'N') = 'N'
		and	coalesce(ie_departamento_medico_p,'N') = 'N'
		and cd_estabelecimento = cd_estabelecimento_p
		and ((coalesce(cd_setor_avan_p::text, '') = '' and (coalesce(cd_setor_atendimento_p::text, '') = '' or cd_setor_atendimento = cd_setor_atendimento_p)) 
			or ((cd_setor_atendimento in (WITH RECURSIVE cte AS (
select regexp_substr(cd_setor_avan_p,'[^,]+',1,level)  (regexp_substr(cd_setor_avan_p,'[^,]+',1,level) IS NOT NULL AND (regexp_substr(cd_setor_avan_p,'[^,]+',1,level))::text <> '')  UNION ALL
select regexp_substr(cd_setor_avan_p,'[^,]+',1,level) JOIN cte c ON ()

) SELECT * FROM cte;
)) or cd_setor_atendimento = cd_setor_atendimento_p))
		
union

		select distinct 
				cd_departamento, 
				ds_departamento, 
				cd_setor_atendimento, 
				ds_setor_atendimento, 
				ie_pronto_atendimento, 
				cd_classif_setor, 
				ie_sem_acomodacao, 
				ie_emprestado
		from w_pan_agrup_leito
		where ie_concluido = 'S'
		and cd_departamento	= cd_departamento_p
		and	obter_se_usuario_setor(nm_usuario_p, cd_setor_atendimento) = 'S'
		and ((coalesce(ie_paramseven_p::text, '') = '') or Obter_Se_Contido(cd_classif_setor,ie_paramseven_p) = 'S')
		and	ie_sem_acomodacao = ie_sem_acomodacao_p
		and	coalesce(ie_meus_pacientes_p,'N') = 'S'
		and coalesce(ie_todos_setores_p,'N') = 'N'
		and	coalesce(ie_departamento_medico_p,'N') = 'N'
		and cd_estabelecimento = cd_estabelecimento_p
		and ((coalesce(cd_setor_avan_p::text, '') = '' and (coalesce(cd_setor_atendimento_p::text, '') = '' or cd_setor_atendimento = cd_setor_atendimento_p)) 
			or ((cd_setor_atendimento in (WITH RECURSIVE cte AS (
select regexp_substr(cd_setor_avan_p,'[^,]+',1,level)  (regexp_substr(cd_setor_avan_p,'[^,]+',1,level) IS NOT NULL AND (regexp_substr(cd_setor_avan_p,'[^,]+',1,level))::text <> '')  UNION ALL
select regexp_substr(cd_setor_avan_p,'[^,]+',1,level) JOIN cte c ON ()

) SELECT * FROM cte;
)) or cd_setor_atendimento = cd_setor_atendimento_p))
		
union

		select distinct 
				null cd_departamento, 
				null ds_departamento, 
				cd_setor_atendimento, 
				ds_setor_atendimento, 
				ie_pronto_atendimento, 
				cd_classif_setor, 
				ie_sem_acomodacao, 
				ie_emprestado
		from w_pan_agrup_leito
		where ie_concluido = 'S'
		and (cd_setor_atendimento IS NOT NULL AND cd_setor_atendimento::text <> '')
		and	obter_se_usuario_setor(nm_usuario_p, cd_setor_atendimento) = 'S'
		and ((coalesce(ie_paramseven_p::text, '') = '') or Obter_Se_Contido(cd_classif_setor,ie_paramseven_p) = 'S')
		and	ie_sem_acomodacao = ie_sem_acomodacao_p
		and	coalesce(ie_meus_pacientes_p,'N') = 'N'
		and ((coalesce(ie_todos_setores_p,'N') = 'S') or (coalesce(ie_departamento_medico_p,'N') = 'S'))
		and cd_estabelecimento = cd_estabelecimento_p
		and (coalesce(cd_setor_avan_p::text, '') = '' or (cd_setor_atendimento in (WITH RECURSIVE cte AS (
select regexp_substr(cd_setor_avan_p,'[^,]+',1,level)  (regexp_substr(cd_setor_avan_p,'[^,]+',1,level) IS NOT NULL AND (regexp_substr(cd_setor_avan_p,'[^,]+',1,level))::text <> '')  UNION ALL
select regexp_substr(cd_setor_avan_p,'[^,]+',1,level) JOIN cte c ON ()

) SELECT * FROM cte;
)))
		order by ie_emprestado,ds_departamento,ds_setor_atendimento;

	
BEGIN


		open c01;
		loop
		fetch c01 into	
			cd_departamento_w,
			ds_departamento_w,
			cd_setor_atendimento_w,
			ds_setor_atendimento_w,
			ie_pronto_atendimento_w,
			cd_classif_setor_w,
			ie_sem_acomodacao_w,
			ie_emprestado_w;
		EXIT WHEN NOT FOUND; /* apply on c01 */
			begin
			get_values_r.cd_departamento := cd_departamento_w;
			get_values_r.ds_departamento := ds_departamento_w;
			get_values_r.cd_setor_atendimento := cd_setor_atendimento_w;
			get_values_r.ds_setor_atendimento := ds_setor_atendimento_w;
			get_values_r.ie_pronto_atendimento :=	ie_pronto_atendimento_w;
			get_values_r.cd_classif_setor := cd_classif_setor_w;
			get_values_r.ie_sem_acomodacao := ie_sem_acomodacao_w;
			get_values_r.ie_emprestado := ie_emprestado_w;				
			RETURN NEXT get_values_r;	
			
			end;
		end loop;
		close c01;


	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pan_agrup_leito_pck.search_pan_agrup_leito ( cd_setor_atendimento_p bigint, ie_meus_pacientes_p text, cd_setor_avan_p text, cd_departamento_p bigint, ie_paramseven_p text, ie_sem_acomodacao_p text, ie_departamento_medico_p text, cd_estabelecimento_p bigint, ie_todos_setores_p text, nm_usuario_p text) FROM PUBLIC;
