-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION alto_custo_hiv_pck.get_codigo_eapb_anterior ( nr_atendimento_p bigint) RETURNS varchar AS $body$
DECLARE


	ds_retorno_w      varchar(255);

	
BEGIN
	
		begin

		select  cd_eapb_anterior
		into STRICT    ds_retorno_w
		from (
			SELECT  c.cd_entidade_administradora cd_eapb_anterior
			from    atendimento_paciente a,
					atend_categoria_convenio b,
					convenio_plano c
			where   a.nr_atendimento = b.nr_atendimento
			and     b.cd_plano_convenio = c.cd_plano
			and     b.cd_convenio = c.cd_convenio
			and     a.nr_atendimento = nr_atendimento_p
			and     trunc(b.dt_final_vigencia) < trunc(clock_timestamp())
			order by b.dt_final_vigencia desc) alias3 LIMIT 1;

		exception
			when no_data_found then
			ds_retorno_w := '';
		end;

		return elimina_caracteres_especiais(ds_retorno_w);

	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION alto_custo_hiv_pck.get_codigo_eapb_anterior ( nr_atendimento_p bigint) FROM PUBLIC;
