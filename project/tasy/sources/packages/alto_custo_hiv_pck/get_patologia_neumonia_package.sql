-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION alto_custo_hiv_pck.get_patologia_neumonia (cd_pessoa_fisica_p text, ie_doenca_cronica_p text) RETURNS varchar AS $body$
DECLARE


    ds_retorno_w varchar(1) := '0';
    qt_diagnosticos_w cid_doenca.qt_idade_min%type;

  
BEGIN
    select count(nr_atendimento)
    into STRICT qt_diagnosticos_w 
    from (SELECT a.nr_atendimento
      from paciente_antec_clinico a,
        cid_doenca b
      where b.cd_doenca_cid      = a.cd_doenca
      and a.cd_pessoa_fisica     = cd_pessoa_fisica_p
      and b.ie_doenca_cronica_mx = ie_doenca_cronica_p
      and (a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
      and coalesce(a.dt_inativacao::text, '') = ''
      and (a.dt_inicio IS NOT NULL AND a.dt_inicio::text <> '')
      and (a.dt_fim IS NOT NULL AND a.dt_fim::text <> '')
      and a.dt_inicio between clock_timestamp() - interval '365 days' and clock_timestamp()
      
union

      SELECT a.nr_atendimento
      from diagnostico_doenca a,
        cid_doenca b,
        atendimento_paciente c
      where b.cd_doenca_cid      = a.cd_doenca
      and c.nr_atendimento       = a.nr_atendimento
      and c.cd_pessoa_fisica     = cd_pessoa_fisica_p
      and b.ie_doenca_cronica_mx = ie_doenca_cronica_p
      and (a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
      and coalesce(a.dt_inativacao::text, '') = ''
      and (a.dt_inicio IS NOT NULL AND a.dt_inicio::text <> '')
      and (a.dt_fim IS NOT NULL AND a.dt_fim::text <> '')
      and a.dt_cid between clock_timestamp() - interval '365 days' and clock_timestamp()
      ) alias13;

      if qt_diagnosticos_w > 1 then
        ds_retorno_w := '1';
      end if;

      return ds_retorno_w;
  END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION alto_custo_hiv_pck.get_patologia_neumonia (cd_pessoa_fisica_p text, ie_doenca_cronica_p text) FROM PUBLIC;
