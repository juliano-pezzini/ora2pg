-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION ish_patient_pck.get_addresses_change ( nr_seq_fila_p bigint, ie_tipo_p text) RETURNS SETOF T_ADDRESSES_CHANGE AS $body$
DECLARE


nr_seq_documento_w		intpd_fila_transmissao.nr_seq_documento%type;
ie_conversao_w			intpd_eventos_sistema.ie_conversao%type;
nr_seq_sistema_w		intpd_eventos_sistema.nr_seq_sistema%type;
nr_seq_projeto_xml_w		intpd_eventos_sistema.nr_seq_projeto_xml%type;
nr_seq_regra_w			intpd_eventos_sistema.nr_seq_regra_conv%type;
nr_seq_tipo_compl_adic_w	compl_pessoa_fisica.nr_seq_tipo_compl_adic%type;
r_addresses_change_w		r_addresses_change;
cd_cep_w 			pessoa_juridica.cd_cep%type;
reg_integracao_w		gerar_int_padrao.reg_integracao_conv;
pessoa_fisica_empregador_w  pessoa_fisica_empregador%rowtype;
nr_sequencia_w  compl_pessoa_fisica.nr_sequencia%type;

c01 CURSOR FOR
SELECT	cd_pessoa_fisica,
	nr_sequencia,
	nr_telefone,
	nr_ramal,
	ds_fax,
	nr_ddd_fax,
	nr_seq_pais,
	sg_estado,
	cd_cep,
	ds_municipio,
	ds_bairro,
	ds_endereco,
	ds_compl_end nr_endereco,
	ds_complemento,
	ds_email,
	ds_fonetica,
	cd_cgc cd_empresa_refer,
	ie_tipo_complemento,
	nr_telefone_celular,
	ds_fone_adic,
    obter_comunity_code(cd_cep) nr_comunity_code
from	compl_pessoa_fisica
where	cd_pessoa_fisica = nr_seq_documento_w
and	coalesce(ie_tipo_complemento, '0') <> '2'; -- OS 1954141 - H950 - Change of patient address handling in IS-H integration;

c01_w	c01%rowtype;


BEGIN
select	a.nr_seq_documento,
	coalesce(b.ie_conversao,'I'),
	b.nr_seq_sistema,
	b.nr_seq_projeto_xml,
	b.nr_seq_regra_conv
into STRICT	nr_seq_documento_w,
	ie_conversao_w,
	nr_seq_sistema_w,
	nr_seq_projeto_xml_w,
	nr_seq_regra_w
from	intpd_fila_transmissao a,
	intpd_eventos_sistema b
where	a.nr_seq_evento_sistema = b.nr_sequencia
and	a.nr_sequencia = nr_seq_fila_p;

intpd_reg_integracao_inicio(nr_seq_fila_p, 'E', reg_integracao_w);

if (ie_tipo_p = 'I') then
	open c01;
	loop
	fetch c01 into
		c01_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin
		r_addresses_change_w		:=	null;
		reg_integracao_w.nm_tabela 	:=	'COMPL_PESSOA_FISICA';
		reg_integracao_w.ds_chave	:=	'CD_PESSOA_FISICA=' || c01_w.cd_pessoa_fisica || ';NR_SEQUENCIA=' || c01_w.nr_sequencia || ';';
		reg_integracao_w.ie_valida_chave	:= 'S';
		
		reg_integracao_w.nm_elemento	:=	'IAddresses';
		reg_integracao_w.ie_somente_alterados		:= 'N';
		intpd_processar_atrib_envio(reg_integracao_w, 'NR_SEQUENCIA', 'addrno', 'N', c01_w.nr_sequencia, 'N', r_addresses_change_w.addrno);		
		reg_integracao_w.ie_somente_alterados		:= 'S';
		intpd_processar_atrib_envio(reg_integracao_w, 'NR_SEQ_PAIS','country', 'N', c01_w.nr_seq_pais, 'S', r_addresses_change_w.country);
		intpd_processar_atrib_envio(reg_integracao_w, 'NR_SEQ_PAIS','countryx', 'S', c01_w.nr_seq_pais, 'N', r_addresses_change_w.countryx);
		r_addresses_change_w.countryiso	:=	null;

		/*
		not found in change process
		begin
		select	substr(nm_pais,1,15)
		into	r_addresses_change_w.countrytext
		from	pais
		where	nr_sequencia = c01_w.nr_seq_pais;
		exception
		when others then
			r_addresses_change_w.countrytext	:=	null;
		end;
		*/


		intpd_processar_atrib_envio(reg_integracao_w, 'SG_ESTADO','region', 'N', c01_w.sg_estado, 'S', r_addresses_change_w.region);
		intpd_processar_atrib_envio(reg_integracao_w, 'SG_ESTADO','regionx', 'S', c01_w.sg_estado, 'N', r_addresses_change_w.regionx);
		
		r_addresses_change_w.GeogrAreaX	:=	'X';

		/*
		not found in change process
		r_addresses_change_w.regiontext	:=	substr(obter_valor_dominio(50, c01_w.sg_estado), 1, 20);
		*/


		intpd_processar_atrib_envio(reg_integracao_w, 'CD_CEP','pcd', 'N', c01_w.cd_cep, 'N', r_addresses_change_w.pcd);
		intpd_processar_atrib_envio(reg_integracao_w, 'CD_CEP','pcdx', 'S', c01_w.cd_cep, 'N', r_addresses_change_w.pcdx);
		intpd_processar_atrib_envio(reg_integracao_w, 'DS_MUNICIPIO','city', 'N', c01_w.ds_municipio, 'N', r_addresses_change_w.city);
		intpd_processar_atrib_envio(reg_integracao_w, 'DS_MUNICIPIO','cityx', 'S', c01_w.ds_municipio, 'N', r_addresses_change_w.cityx);
		intpd_processar_atrib_envio(reg_integracao_w, 'DS_BAIRRO','district', 'N', c01_w.ds_bairro, 'N', r_addresses_change_w.district);
		intpd_processar_atrib_envio(reg_integracao_w, 'DS_BAIRRO','districtx', 'S', c01_w.ds_bairro, 'N', r_addresses_change_w.districtx);
		intpd_processar_atrib_envio(reg_integracao_w, 'DS_FONETICA','stdstreet', 'N', c01_w.ds_fonetica, 'N', r_addresses_change_w.stdstreet);
		--intpd_processar_atrib_envio(reg_integracao_w, 'DS_FONETICA','stdstreetx', 'S', c01_w.ds_fonetica, 'N', r_addresses_change_w.stdstreetx);

		intpd_processar_atrib_envio(reg_integracao_w, 'DS_COMPLEMENTO','strsup', 'N', c01_w.ds_complemento, 'N', r_addresses_change_w.strsup);
		intpd_processar_atrib_envio(reg_integracao_w, 'DS_COMPLEMENTO','strsupx', 'S', c01_w.ds_complemento, 'N', r_addresses_change_w.strsupx);		

	--	r_addresses_change_w.stdcity	:=

	--	r_addresses_change_w.stddistrict	:=

	--	r_addresses_change_w.strno		:=	substr(c01_w.ds_endereco, 1, 40);

	--	r_addresses_change_w.strnox	:=	'X';

	--	r_addresses_change_w.stdstrsup	:=

	--	r_addresses_change_w.geograrea	:=

	--	r_addresses_change_w.geograreatex	:=

	--	r_addresses_change_w.poboxpcd	:=	substr(c01_w.cd_cep, 1, 10);

	--	r_addresses_change_w.poboxpcdx	:=	'X';

	--	r_addresses_change_w.pobox	:=

	--	r_addresses_change_w.pobcountry	:=	substr(intpd_conv('PAIS', 'NR_SEQUENCIA', c01_w.nr_seq_pais, nr_seq_regra_w, ie_conversao_w, 'E'),1,3);

	--	r_addresses_change_w.pobcountryx := 'X';

	--	r_addresses_change_w.pobcountryiso	:= substr(intpd_conv('PAIS', 'NR_SEQUENCIA', c01_w.nr_seq_pais, nr_seq_regra_w, ie_conversao_w, 'E'),1,3);

	--	r_addresses_change_w.pobcountrytxt	:=

	--	r_addresses_change_w.poboxcity	:=	substr(c01_w.ds_municipio, 1, 40);

	--	r_addresses_change_w.poboxcityx	:= 'X';


	--	r_addresses_change_w.phonesx := 'X';

	--	r_addresses_change_w.stdpoboxcity	:=


		begin
		select 	p.cd_cep
		into STRICT 	cd_cep_w
		from 	pessoa_juridica p
		where 	p.cd_cgc = c01_w.cd_empresa_refer;
		exception
		when others then
			begin
			  cd_cep_w :=	null;
			end;
		end;

		intpd_processar_atrib_envio(reg_integracao_w, 'CD_CEP','companypcd', 'N', cd_cep_w, 'N', r_addresses_change_w.companypcd);
		intpd_processar_atrib_envio(reg_integracao_w, 'CD_CEP','companypcdx', 'S', cd_cep_w, 'N', r_addresses_change_w.companypcdx);

		/*
		not found in change process
		r_addresses_change_w.phoneno	:=	substr(c01_w.nr_telefone, 1, 30);
		r_addresses_change_w.extension	:=	substr(c01_w.nr_ramal, 1, 10);
		*/


	--	r_addresses_change_w.otherphones	:=

	
		intpd_processar_atrib_envio(reg_integracao_w, 'DS_FONE_ADIC','phoneno', 'N', c01_w.ds_fone_adic, 'N', r_addresses_change_w.phoneno);
		intpd_processar_atrib_envio(reg_integracao_w, 'DS_FONE_ADIC','phonenox', 'S', c01_w.ds_fone_adic, 'N', r_addresses_change_w.phonenox);
		intpd_processar_atrib_envio(reg_integracao_w, 'DS_FONE_ADIC','phonesx', 'S', c01_w.ds_fone_adic, 'N', r_addresses_change_w.phonesx);
	
		intpd_processar_atrib_envio(reg_integracao_w, 'DS_FAX','faxno', 'N', c01_w.ds_fax, 'N', r_addresses_change_w.faxno);
		intpd_processar_atrib_envio(reg_integracao_w, 'DS_FAX','faxnox', 'S', c01_w.ds_fax, 'N', r_addresses_change_w.faxnox);
		intpd_processar_atrib_envio(reg_integracao_w, 'NR_DDD_FAX','faxextension', 'N', c01_w.nr_ddd_fax, 'N', r_addresses_change_w.faxextension);
		intpd_processar_atrib_envio(reg_integracao_w, 'NR_DDD_FAX','faxextensionx', 'S', c01_w.nr_ddd_fax, 'N', r_addresses_change_w.faxextensionx);
	--	r_addresses_change_w.telexno	:=


		/*
		ds_complemento_w :=	substr(
			replace(c03_w.building,';','.') || ';' ||
			replace(c03_w.floor,';','.') || ';' ||
			replace(c03_w.unit,';','.') || ';' ||
			replace(c03_w.houseno,';','.'),1,40);
		*/


		--r_addresses_change_w.building	:=	null;

		--r_addresses_change_w.buildingx	:=	'X';

		--r_addresses_change_w.floor		:=	null;

		--r_addresses_change_w.floorx		:=	'X';

		--r_addresses_change_w.unit		:=	null;

		--r_addresses_change_w.unitx		:=	'X';


		/*
		not found in change process
		r_addresses_change_w.addrstring	:=	substr(c01_w.ds_endereco, 1, 50);
		*/


		intpd_processar_atrib_envio(reg_integracao_w, 'DS_EMAIL','email', 'N', c01_w.ds_email, 'N', r_addresses_change_w.email);
		intpd_processar_atrib_envio(reg_integracao_w, 'DS_EMAIL','emailx', 'S', c01_w.ds_email, 'N', r_addresses_change_w.emailx);

		intpd_processar_atrib_envio(reg_integracao_w, 'DS_COMPL_END','houseno', 'N', c01_w.nr_endereco, 'N', r_addresses_change_w.houseno);
		intpd_processar_atrib_envio(reg_integracao_w, 'DS_COMPL_END','housenox', 'S', c01_w.nr_endereco, 'N', r_addresses_change_w.housenox);
       	intpd_processar_atrib_envio(reg_integracao_w, 'NR_COMUNITY_CODE','stdcomunitycode', 'N', c01_w.nr_comunity_code, 'N', r_addresses_change_w.stdcomunitycode);

		if (c01_w.ie_tipo_complemento > 1) then
			intpd_processar_atrib_envio(reg_integracao_w, 'DS_ENDERECO','strno', 'N', c01_w.ds_endereco, 'N', r_addresses_change_w.strno);
			intpd_processar_atrib_envio(reg_integracao_w, 'DS_ENDERECO','strnox', 'S', c01_w.ds_endereco, 'N', r_addresses_change_w.strnox);		
		else
			intpd_processar_atrib_envio(reg_integracao_w, 'DS_ENDERECO','streetlong', 'N', c01_w.ds_endereco, 'N', r_addresses_change_w.streetlong);
			intpd_processar_atrib_envio(reg_integracao_w, 'DS_ENDERECO','streetlongx', 'S', c01_w.ds_endereco, 'N', r_addresses_change_w.streetlongx);		
		end if;

		reg_integracao_w.ds_chave	:=	null;
		RETURN NEXT r_addresses_change_w;
		end;
	end loop;
	close c01;

	begin
	select	*
	into STRICT    pessoa_fisica_empregador_w
	from    pessoa_fisica_empregador
	where   nr_sequencia =	(SELECT	max(nr_sequencia)
				from	pessoa_fisica_empregador
				where	cd_pessoa_fisica = nr_seq_documento_w
				and	coalesce(dt_fim_trabalho::text, '') = '');

	reg_integracao_w.nm_tabela 		:=	'PESSOA_FISICA_EMPREGADOR';
	reg_integracao_w.nm_elemento	:=	'IAddresses';
	reg_integracao_w.ie_valida_chave	:= 'N';
	r_addresses_change_w		:=	null;

	reg_integracao_w.ie_somente_alterados		:= 'N';
	intpd_processar_atrib_envio(reg_integracao_w, 'NR_SEQUENCIA','addrno', 'N', 99, 'N', r_addresses_change_w.addrno);
	reg_integracao_w.ie_somente_alterados		:= 'S';

	intpd_processar_atrib_envio(reg_integracao_w, 'CD_CEP_EMPREG','pcd', 'N', pessoa_fisica_empregador_w.cd_cep_empreg, 'N', r_addresses_change_w.pcd);
	intpd_processar_atrib_envio(reg_integracao_w, 'CD_CEP_EMPREG','pcdx', 'S', pessoa_fisica_empregador_w.cd_cep_empreg, 'N', r_addresses_change_w.pcdx);

	intpd_processar_atrib_envio(reg_integracao_w, 'DS_MUNICIPIO_EMPREG','city', 'N', pessoa_fisica_empregador_w.ds_municipio_empreg, 'N', r_addresses_change_w.city);
	intpd_processar_atrib_envio(reg_integracao_w, 'DS_MUNICIPIO_EMPREG','cityx', 'S', pessoa_fisica_empregador_w.ds_municipio_empreg, 'N', r_addresses_change_w.cityx);

	intpd_processar_atrib_envio(reg_integracao_w, 'NR_TELEFONE','phoneno', 'N', pessoa_fisica_empregador_w.nr_telefone, 'N', r_addresses_change_w.phoneno);
	intpd_processar_atrib_envio(reg_integracao_w, 'NR_TELEFONE','phonenox', 'S', pessoa_fisica_empregador_w.nr_telefone, 'N', r_addresses_change_w.phonenox);
	intpd_processar_atrib_envio(reg_integracao_w, 'NR_TELEFONE','phonesx', 'S', pessoa_fisica_empregador_w.nr_telefone, 'N', r_addresses_change_w.phonesx);

	intpd_processar_atrib_envio(reg_integracao_w, 'NR_ENDERECO_EMPREG','houseno', 'N', pessoa_fisica_empregador_w.nr_endereco_empreg, 'N', r_addresses_change_w.houseno);
	intpd_processar_atrib_envio(reg_integracao_w, 'NR_ENDERECO_EMPREG','housenox', 'S', pessoa_fisica_empregador_w.nr_endereco_empreg, 'N', r_addresses_change_w.housenox);
	intpd_processar_atrib_envio(reg_integracao_w, 'DS_ENDERECO_EMPREG','streetlong', 'N', pessoa_fisica_empregador_w.ds_endereco_empreg, 'N', r_addresses_change_w.streetlong);
	intpd_processar_atrib_envio(reg_integracao_w, 'DS_ENDERECO_EMPREG','streetlongx', 'S', pessoa_fisica_empregador_w.ds_endereco_empreg, 'N', r_addresses_change_w.streetlongx);
	RETURN NEXT r_addresses_change_w;
	exception
	when others then
		pessoa_fisica_empregador_w  := null;
	end;
end if;

CALL intpd_gravar_log_fila(reg_integracao_w);
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION ish_patient_pck.get_addresses_change ( nr_seq_fila_p bigint, ie_tipo_p text) FROM PUBLIC;
