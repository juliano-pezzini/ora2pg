-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE cpoe_gerar_registro_json_pck.cpoe_gerar_registro_anat_json ( nr_atendimento_p bigint, dt_referencia_p timestamp, nm_usuario_p text, nr_prescricao_p bigint default null) AS $body$
DECLARE


current_setting('cpoe_gerar_registro_json_pck.ds_registro_w')::text					text;
ds_json_proc_w					text;
ds_procedimento_w				varchar(1000);
ds_procedimento_ww				varchar(1000);
current_setting('cpoe_gerar_registro_json_pck.dt_inicio_w')::cpoe_dieta.dt_inicio%type						cpoe_procedimento.dt_inicio%type;
current_setting('cpoe_gerar_registro_json_pck.hr_prim_horario_w')::varchar(5)				varchar(20);
count_cpoe_procedimento_w 		bigint;
current_setting('cpoe_gerar_registro_json_pck.ds_prescritor_w')::varchar(255)					varchar(255);
current_setting('cpoe_gerar_registro_json_pck.dt_prescrito_w')::varchar(255)					varchar(255);
current_setting('cpoe_gerar_registro_json_pck.ds_previous_prescriber_w')::varchar(255)		varchar(255);
current_setting('cpoe_gerar_registro_json_pck.dt_previous_prescriber_w')::varchar(255)		varchar(255);
current_setting('cpoe_gerar_registro_json_pck.ds_conselho_w')::varchar(255)					varchar(255);
current_setting('cpoe_gerar_registro_json_pck.ds_prescritor_grid_w')::varchar(255)			varchar(255);	
current_setting('cpoe_gerar_registro_json_pck.ds_prescritor_reval_w')::varchar(255)			varchar(255);
current_setting('cpoe_gerar_registro_json_pck.nm_usuario_descontinuacao_w')::varchar(255)		varchar(255);	
current_setting('cpoe_gerar_registro_json_pck.dt_inicio_grid_w')::timestamp				timestamp;
current_setting('cpoe_gerar_registro_json_pck.dt_liberacao_w')::prescr_medica.dt_liberacao%type 					prescr_medica.dt_liberacao%type;
current_setting('cpoe_gerar_registro_json_pck.dt_liberacao_enfermagem_w')::prescr_medica.dt_liberacao%type		prescr_medica.dt_liberacao%type;
current_setting('cpoe_gerar_registro_json_pck.dt_liberacao_farmacia_w')::prescr_medica.dt_liberacao_farmacia%type			prescr_medica.dt_liberacao_farmacia%type;		
current_setting('cpoe_gerar_registro_json_pck.ie_momento_lote_w')::regra_disp_lote_farm.ie_momento_lote%type				regra_disp_lote_farm.ie_momento_lote%type;
current_setting('cpoe_gerar_registro_json_pck.nm_usuario_lib_enfermagem_w')::varchar(255)		varchar(255);
current_setting('cpoe_gerar_registro_json_pck.nm_usuario_lib_farmacia_w')::varchar(255)		varchar(255);

nr_seq_proc_interno_w			cpoe_procedimento.nr_seq_proc_interno%type;
nr_seq_proc_cpoe_w				cpoe_procedimento.nr_sequencia%type;
qt_procedimento_w				cpoe_procedimento.qt_procedimento%type;
cd_material_exame_w				prescr_procedimento.cd_material_exame%type;	
current_setting('cpoe_gerar_registro_json_pck.ie_urgencia_w')::varchar(1)					cpoe_procedimento.ie_urgencia%type;
current_setting('cpoe_gerar_registro_json_pck.ds_observacao_w')::prescr_gasoterapia.ds_observacao%type					cpoe_procedimento.ds_observacao%type;
current_setting('cpoe_gerar_registro_json_pck.nm_usuario_w')::prescr_gasoterapia.nm_usuario%type					cpoe_procedimento.nm_usuario%type;
current_setting('cpoe_gerar_registro_json_pck.nm_usuario_nrec_w')::prescr_gasoterapia_evento.nm_usuario_nrec%type				cpoe_procedimento.nm_usuario_nrec%type;
current_setting('cpoe_gerar_registro_json_pck.dt_atualizacao_w')::prescr_gasoterapia.dt_atualizacao%type				cpoe_procedimento.dt_atualizacao%type;
current_setting('cpoe_gerar_registro_json_pck.dt_atualizacao_nrec_w')::prescr_gasoterapia_evento.dt_atualizacao_nrec%type 			cpoe_procedimento.dt_atualizacao%type;
current_setting('cpoe_gerar_registro_json_pck.dt_suspensao_item_w')::prescr_gasoterapia.dt_suspensao%type				cpoe_procedimento.dt_suspensao%type;
current_setting('cpoe_gerar_registro_json_pck.dt_lib_suspensao_item_w')::cpoe_gasoterapia.dt_lib_suspensao%type			cpoe_procedimento.dt_lib_suspensao%type;
current_setting('cpoe_gerar_registro_json_pck.nm_usuario_susp_w')::cpoe_dieta.nm_usuario_susp%type				cpoe_procedimento.nm_usuario_susp%type;

current_setting('cpoe_gerar_registro_json_pck.dt_fim_w')::cpoe_dieta.dt_fim%type						cpoe_procedimento.dt_fim%type;
current_setting('cpoe_gerar_registro_json_pck.ie_duracao_w')::cpoe_dieta.ie_duracao%type					cpoe_procedimento.ie_duracao%type;
ds_dado_clinico_w				cpoe_procedimento.ds_dado_clinico%type;
current_setting('cpoe_gerar_registro_json_pck.ie_administracao_w')::cpoe_dieta.ie_administracao%type				cpoe_procedimento.ie_administracao%type;
current_setting('cpoe_gerar_registro_json_pck.ie_evento_unico_w')::cpoe_dieta.ie_evento_unico%type				cpoe_procedimento.ie_evento_unico%type;
current_setting('cpoe_gerar_registro_json_pck.ie_motivo_prescricao_w')::cpoe_gasoterapia.ie_motivo_prescricao%type			cpoe_procedimento.ie_motivo_prescricao%type;

current_setting('cpoe_gerar_registro_json_pck.dt_prev_execucao_w')::prescr_gasoterapia.dt_prev_execucao%type				cpoe_anatomia_patologica.dt_prev_execucao%type;
cd_pessoa_coleta_w				cpoe_anatomia_patologica.cd_pessoa_coleta%type;
nr_seq_proc_int_cirur_w			cpoe_anatomia_patologica.nr_seq_proc_int_cirur%type;
dt_coleta_w						cpoe_anatomia_patologica.dt_coleta%type;
qt_peca_ap_w					cpoe_anatomia_patologica.qt_peca_ap%type;
nr_seq_amostra_princ_w			cpoe_anatomia_patologica.nr_seq_amostra_princ%type;
ds_qualidade_peca_ap_w			cpoe_anatomia_patologica.ds_qualidade_peca_ap%type;
ie_forma_exame_w				cpoe_anatomia_patologica.ie_forma_exame%type;
ds_diag_provavel_ap_w			cpoe_anatomia_patologica.ds_diag_provavel_ap%type;
ds_exame_anterior_ap_w			cpoe_anatomia_patologica.ds_exame_anterior_ap%type;
ds_localizacao_lesao_w			cpoe_anatomia_patologica.ds_localizacao_lesao%type;
ds_tempo_doenca_w				cpoe_anatomia_patologica.ds_tempo_doenca%type;
current_setting('cpoe_gerar_registro_json_pck.cd_setor_atendimento_w')::cpoe_gasoterapia.cd_setor_atendimento%type			cpoe_anatomia_patologica.cd_setor_atendimento%type;
cd_cgc_laboratorio_w			cpoe_anatomia_patologica.cd_cgc_laboratorio%type;
qt_frasco_env_w					cpoe_anatomia_patologica.qt_frasco_env%type;
ie_amostra_w					cpoe_anatomia_patologica.ie_amostra%type;
ie_suspenso_w					cpoe_anatomia_patologica.ie_suspenso%type;
current_setting('cpoe_gerar_registro_json_pck.nr_seq_assinatura_w')::cpoe_gasoterapia.nr_seq_assinatura%type				cpoe_anatomia_patologica.nr_seq_assinatura%type;
current_setting('cpoe_gerar_registro_json_pck.dt_assinatura_digital_w')::tasy_assinatura_digital.dt_assinatura%type			tasy_assinatura_digital.dt_assinatura%type;
nr_prescricao_ww				prescr_medica.nr_prescricao%type;
nr_seq_prescr_proc_ww			prescr_procedimento.nr_sequencia%type;
ie_tipo_proced_ww				prescr_procedimento.ie_tipo_proced%type;

current_setting('cpoe_gerar_registro_json_pck.cd_estabelecimento_w')::estabelecimento.cd_estabelecimento%type			estabelecimento.cd_estabelecimento%type;
current_setting('cpoe_gerar_registro_json_pck.nr_seq_cpoe_order_unit_w')::cpoe_order_unit.nr_sequencia%type        cpoe_order_unit.nr_sequencia%type;

current_setting('cpoe_gerar_registro_json_pck.c01')::CURSOR CURSOR FOR  -- Anatomia Patologica
SELECT  distinct a.nr_seq_proc_interno,
	a.nr_sequencia,
	a.qt_procedimento,
	a.cd_material_exame,
	a.ie_urgencia,
	a.dt_inicio,
	a.hr_prim_horario,
	a.ds_observacao,
	a.dt_liberacao,
	a.ie_motivo_prescricao,
	a.dt_suspensao,
	a.dt_lib_suspensao,
	a.nm_usuario,
	a.nm_usuario_nrec,
	a.dt_atualizacao,
	a.dt_atualizacao_nrec,
	a.ds_dado_clinico,
	a.dt_prev_execucao,
	a.cd_pessoa_coleta,
	a.nr_seq_proc_int_cirur,
	a.dt_coleta,
	a.qt_peca_ap,
	a.nr_seq_amostra_princ,
	a.ds_qualidade_peca_ap,
	a.ie_forma_exame,
	a.ds_diag_provavel_ap,
	a.ds_exame_anterior_ap,
	a.ds_localizacao_lesao,
	a.ds_tempo_doenca,
	a.cd_setor_atendimento,
	a.cd_cgc_laboratorio,
	a.qt_frasco_env,
	a.ie_amostra,
	a.ie_suspenso,
	a.nr_seq_assinatura,
	a.nr_seq_cpoe_order_unit
from	cpoe_anatomia_patologica a,
	prescr_procedimento b,
	prescr_proc_hor c,
	prescr_medica d
where	a.nr_atendimento = nr_atendimento_p
and	a.dt_inicio > dt_hora_formatada_w - 2
and	(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
and	a.nr_sequencia = b.nr_seq_proc_cpoe
and	b.nr_prescricao = c.nr_prescricao
and	b.nr_sequencia = c.nr_seq_procedimento
and	b.nr_prescricao = d.nr_prescricao
and	coalesce(b.nr_seq_origem::text, '') = ''
and	(b.nr_seq_proc_interno IS NOT NULL AND b.nr_seq_proc_interno::text <> '')
and	coalesce(b.nr_seq_solic_sangue::text, '') = ''
and	((coalesce(nr_prescricao_p,0) = 0)  or (d.nr_prescricao = nr_prescricao_p))
and ((obter_se_exibe_proced(b.nr_prescricao,a.nr_sequencia,ie_tipo_proced,'AP') = 'S') or (obter_se_exibe_proced(b.nr_prescricao,a.nr_sequencia,ie_tipo_proced,'APH') = 'S') or (obter_se_exibe_proced(b.nr_prescricao,a.nr_sequencia,ie_tipo_proced,'APC') = 'S'))
and	(((obter_se_acm_sn_agora_especial(b.ie_acm, b.ie_se_necessario, 'N', 'N') = 'N') and (c.dt_horario between dt_hora_formatada_w	and	dt_hora_fim_formatada_w or b.nr_prescricao = nr_prescricao_p)) or
	((obter_se_acm_sn_agora_especial(b.ie_acm, b.ie_se_necessario, 'N', 'N') = 'S') and (obter_se_prescr_vig_adep(d.dt_prescricao, d.dt_validade_prescr, dt_hora_formatada_w, dt_hora_fim_formatada_w) = 'S')))
order by a.nr_sequencia;


BEGIN

open current_setting('cpoe_gerar_registro_json_pck.c01')::CURSOR;
loop
fetch current_setting('cpoe_gerar_registro_json_pck.c01')::into CURSOR
	nr_seq_proc_interno_w,
	nr_seq_proc_cpoe_w,
	qt_procedimento_w,
	cd_material_exame_w,
	current_setting('cpoe_gerar_registro_json_pck.ie_urgencia_w')::varchar(1),
	current_setting('cpoe_gerar_registro_json_pck.dt_inicio_w')::cpoe_dieta.dt_inicio%type,
	current_setting('cpoe_gerar_registro_json_pck.hr_prim_horario_w')::varchar(5),
	current_setting('cpoe_gerar_registro_json_pck.ds_observacao_w')::prescr_gasoterapia.ds_observacao%type,
	current_setting('cpoe_gerar_registro_json_pck.dt_liberacao_w')::prescr_medica.dt_liberacao%type,
	current_setting('cpoe_gerar_registro_json_pck.ie_motivo_prescricao_w')::cpoe_gasoterapia.ie_motivo_prescricao%type,
	current_setting('cpoe_gerar_registro_json_pck.dt_suspensao_item_w')::prescr_gasoterapia.dt_suspensao%type,
	current_setting('cpoe_gerar_registro_json_pck.dt_lib_suspensao_item_w')::cpoe_gasoterapia.dt_lib_suspensao%type,
	current_setting('cpoe_gerar_registro_json_pck.nm_usuario_w')::prescr_gasoterapia.nm_usuario%type,
	current_setting('cpoe_gerar_registro_json_pck.nm_usuario_nrec_w')::prescr_gasoterapia_evento.nm_usuario_nrec%type,
	current_setting('cpoe_gerar_registro_json_pck.dt_atualizacao_w')::prescr_gasoterapia.dt_atualizacao%type,
	current_setting('cpoe_gerar_registro_json_pck.dt_atualizacao_nrec_w')::prescr_gasoterapia_evento.dt_atualizacao_nrec%type,
	ds_dado_clinico_w,
	current_setting('cpoe_gerar_registro_json_pck.dt_prev_execucao_w')::prescr_gasoterapia.dt_prev_execucao%type,
	cd_pessoa_coleta_w,
	nr_seq_proc_int_cirur_w,
	dt_coleta_w,
	qt_peca_ap_w,
	nr_seq_amostra_princ_w,
	ds_qualidade_peca_ap_w,
	ie_forma_exame_w,
	ds_diag_provavel_ap_w,
	ds_exame_anterior_ap_w,
	ds_localizacao_lesao_w,
	ds_tempo_doenca_w,
	current_setting('cpoe_gerar_registro_json_pck.cd_setor_atendimento_w')::cpoe_gasoterapia.cd_setor_atendimento%type,
	cd_cgc_laboratorio_w,
	qt_frasco_env_w,
	ie_amostra_w,
	ie_suspenso_w,
	current_setting('cpoe_gerar_registro_json_pck.nr_seq_assinatura_w')::cpoe_gasoterapia.nr_seq_assinatura%type,
	current_setting('cpoe_gerar_registro_json_pck.nr_seq_cpoe_order_unit_w')::cpoe_order_unit.nr_sequencia%type;
EXIT WHEN NOT FOUND; /* apply on current_setting('cpoe_gerar_registro_json_pck.c01')::CURSOR */

	ds_procedimento_w := substr(obter_desc_proc_interno(nr_seq_proc_interno_w),1,255);
	ds_procedimento_ww := ds_procedimento_w;

	PERFORM set_config('cpoe_gerar_registro_json_pck.dt_suspensao_item_w', cpoe_gerar_registro_json_pck.regra_data_susp(current_setting('cpoe_gerar_registro_json_pck.dt_suspensao_item_w')::prescr_gasoterapia.dt_suspensao%type), false);
	PERFORM set_config('cpoe_gerar_registro_json_pck.dt_lib_suspensao_item_w', cpoe_gerar_registro_json_pck.regra_data_susp(current_setting('cpoe_gerar_registro_json_pck.dt_lib_suspensao_item_w')::cpoe_gasoterapia.dt_lib_suspensao%type), false);

	PERFORM set_config('cpoe_gerar_registro_json_pck.cd_estabelecimento_w', obter_estabelecimento_setor(current_setting('cpoe_gerar_registro_json_pck.cd_setor_atendimento_w')::cpoe_gasoterapia.cd_setor_atendimento%type), false);
	PERFORM set_config('cpoe_gerar_registro_json_pck.ie_momento_lote_w', cpoe_obter_momento_lote(current_setting('cpoe_gerar_registro_json_pck.ie_motivo_prescricao_w')::cpoe_gasoterapia.ie_motivo_prescricao%type, current_setting('cpoe_gerar_registro_json_pck.cd_setor_atendimento_w')::cpoe_gasoterapia.cd_setor_atendimento%type, current_setting('cpoe_gerar_registro_json_pck.cd_estabelecimento_w')::estabelecimento.cd_estabelecimento%type, 'N'), false);

	select count(*)
	into STRICT   count_cpoe_procedimento_w
	from   cpoe_anatomia_patologica
	where  nr_sequencia = nr_seq_proc_cpoe_w;

	PERFORM set_config('cpoe_gerar_registro_json_pck.dt_fim_w', '', false);
	PERFORM set_config('cpoe_gerar_registro_json_pck.ie_duracao_w', '', false);
	PERFORM set_config('cpoe_gerar_registro_json_pck.ie_administracao_w', 'P', false);

	if (count_cpoe_procedimento_w > 0) then
		begin
		SELECT	dt_fim,
				ie_duracao,
				ie_administracao,
				ie_evento_unico,
				dt_liberacao,
				REPLACE(cpoe_obter_desc_grid_proc(substr(cpoe_obter_desc_proc_interno(nr_seq_proc_interno),1,255),
				NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, 
				NULL, NULL, NULL, NULL, NULL, dt_lib_suspensao,dt_suspensao, ie_administracao),'"','@#'),
				obter_nome_medico(obter_pf_usuario(nm_usuario_nrec,'C'),'PMS') ds_prescritor,
				cpoe_obter_tempo_prescrito(coalesce(dt_atualizacao_nrec, dt_inicio)) dt_prescrito,
				cpoe_get_prior_prescriber(nr_seq_cpoe_anterior, 'CPOE_ANATOMIA_PATOLOGICA', 'N'),
				cpoe_get_prior_prescriber(nr_seq_cpoe_anterior, 'CPOE_ANATOMIA_PATOLOGICA', 'D'),
				cpoe_obter_data_hora_form(dt_inicio,hr_prim_horario) dt_inicio_grid,
				substr(obter_dados_pf(obter_pf_usuario(nm_usuario_nrec,'C'),'COPR'),1,255) ds_conselho,
				obter_nome_pf(obter_pf_usuario(nm_usuario_nrec,'C')) ds_prescritor_grid,
				dt_liberacao_enf dt_liberacao_enfermagem,
				dt_liberacao_farm dt_liberacao_farmacia,
				nm_usuario_lib_enf nm_usuario_lib_enfermagem,
				cpoe_obter_dado_prescr(nr_sequencia,'P','UF', cd_pessoa_fisica, nr_atendimento) nm_usuario_lib_farmacia,
				CASE WHEN coalesce(cpoe_gerar_registro_json_pck.regra_data_susp(dt_suspensao)::text, '') = '' THEN  NULL  ELSE nm_usuario_susp END ,
				CASE WHEN coalesce(cpoe_gerar_registro_json_pck.regra_data_susp(dt_suspensao)::text, '') = '' THEN  NULL  ELSE cpoe_obter_info_suspensao(nr_sequencia,'P','N') END  nm_usuario_descontinuacao,
				obter_data_assinatura_digital(nr_seq_assinatura),
				obter_pf_usuario(coalesce(nm_usuario, nm_usuario_nrec),'N') ds_prescritor_reval
		INTO STRICT	current_setting('cpoe_gerar_registro_json_pck.dt_fim_w')::cpoe_dieta.dt_fim%type,
				current_setting('cpoe_gerar_registro_json_pck.ie_duracao_w')::cpoe_dieta.ie_duracao%type,
				current_setting('cpoe_gerar_registro_json_pck.ie_administracao_w')::cpoe_dieta.ie_administracao%type,
				current_setting('cpoe_gerar_registro_json_pck.ie_evento_unico_w')::cpoe_dieta.ie_evento_unico%type,
				current_setting('cpoe_gerar_registro_json_pck.dt_liberacao_w')::prescr_medica.dt_liberacao%type,
				ds_procedimento_w,
				current_setting('cpoe_gerar_registro_json_pck.ds_prescritor_w')::varchar(255),
				current_setting('cpoe_gerar_registro_json_pck.dt_prescrito_w')::varchar(255),
				current_setting('cpoe_gerar_registro_json_pck.ds_previous_prescriber_w')::varchar(255),
				current_setting('cpoe_gerar_registro_json_pck.dt_previous_prescriber_w')::varchar(255),
				current_setting('cpoe_gerar_registro_json_pck.dt_inicio_grid_w')::timestamp,
				current_setting('cpoe_gerar_registro_json_pck.ds_conselho_w')::varchar(255),
				current_setting('cpoe_gerar_registro_json_pck.ds_prescritor_grid_w')::varchar(255),
				current_setting('cpoe_gerar_registro_json_pck.dt_liberacao_enfermagem_w')::prescr_medica.dt_liberacao%type,		
				current_setting('cpoe_gerar_registro_json_pck.dt_liberacao_farmacia_w')::prescr_medica.dt_liberacao_farmacia%type,
				current_setting('cpoe_gerar_registro_json_pck.nm_usuario_lib_enfermagem_w')::varchar(255),
				current_setting('cpoe_gerar_registro_json_pck.nm_usuario_lib_farmacia_w')::varchar(255),
				current_setting('cpoe_gerar_registro_json_pck.nm_usuario_susp_w')::cpoe_dieta.nm_usuario_susp%type,
				current_setting('cpoe_gerar_registro_json_pck.nm_usuario_descontinuacao_w')::varchar(255),
				current_setting('cpoe_gerar_registro_json_pck.dt_assinatura_digital_w')::tasy_assinatura_digital.dt_assinatura%type,
				current_setting('cpoe_gerar_registro_json_pck.ds_prescritor_reval_w')::varchar(255)
		FROM	cpoe_anatomia_patologica
		WHERE	nr_sequencia = nr_seq_proc_cpoe_w;
		end;
	end if;

	 if (current_setting('cpoe_gerar_registro_json_pck.dt_lib_suspensao_item_w')::cpoe_gasoterapia.dt_lib_suspensao%coalesce(type::text, '') = '') then
		PERFORM set_config('cpoe_gerar_registro_json_pck.dt_suspensao_item_w', null, false);
	end if;

	ds_json_proc_w := ds_json_proc_w || '{' ||    	
													format_array_json('CD_MATERIAL_EXAME',cd_material_exame_w,1)    ||
													format_array_json('DS_PROCEDIMENTO',ds_procedimento_w,1)        ||
													format_array_json('DS_ITEM',ds_procedimento_ww,1)        ||
													format_array_json('DS_OBSERVACAO',cpoe_gerar_registro_json_pck.remove_aspas(current_setting('cpoe_gerar_registro_json_pck.ds_observacao_w')::prescr_gasoterapia.ds_observacao%type),1)            ||
													format_array_json('DT_ATUALIZACAO', current_setting('cpoe_gerar_registro_json_pck.dt_atualizacao_w')::prescr_gasoterapia.dt_atualizacao%type,1)         ||
													format_array_json('DT_ATUALIZACAO_NREC', current_setting('cpoe_gerar_registro_json_pck.dt_atualizacao_nrec_w')::prescr_gasoterapia_evento.dt_atualizacao_nrec%type,1) ||
													format_array_json('DT_PREV_EXECUCAO', to_char(current_setting('cpoe_gerar_registro_json_pck.dt_prev_execucao_w')::prescr_gasoterapia.dt_prev_execucao%type, 'dd/mm/yyyy hh24:mi:ss'),1) ||
													format_array_json('DT_LIBERACAO', to_char(current_setting('cpoe_gerar_registro_json_pck.dt_liberacao_w')::prescr_medica.dt_liberacao%type, 'dd/mm/yyyy hh24:mi:ss'),1) ||
													format_array_json('DT_LIBERACAO_ENFERMAGEM', to_char(current_setting('cpoe_gerar_registro_json_pck.dt_liberacao_enfermagem_w')::prescr_medica.dt_liberacao%type, 'dd/mm/yyyy hh24:mi:ss'),1) ||
													format_array_json('DT_LIBERACAO_FARMACIA', to_char(current_setting('cpoe_gerar_registro_json_pck.dt_liberacao_farmacia_w')::prescr_medica.dt_liberacao_farmacia%type, 'dd/mm/yyyy hh24:mi:ss'),1) ||
													format_array_json('NM_USUARIO_LIB_ENFERMAGEM', current_setting('cpoe_gerar_registro_json_pck.nm_usuario_lib_enfermagem_w')::varchar(255),1) ||
													format_array_json('NM_USUARIO_LIB_FARMACIA', current_setting('cpoe_gerar_registro_json_pck.nm_usuario_lib_farmacia_w')::varchar(255),1) ||
													format_array_json('IE_MOMENTO_LOTE', current_setting('cpoe_gerar_registro_json_pck.ie_momento_lote_w')::regra_disp_lote_farm.ie_momento_lote%type,1) ||
													format_array_json('DT_FIM', to_char(current_setting('cpoe_gerar_registro_json_pck.dt_fim_w')::cpoe_dieta.dt_fim%type, 'dd/mm/yyyy hh24:mi:ss'),1) ||
													format_array_json('DT_INICIO',to_char(current_setting('cpoe_gerar_registro_json_pck.dt_inicio_w')::cpoe_dieta.dt_inicio%type, 'dd/mm/yyyy hh24:mi:ss'),1)                    ||
													format_array_json('DT_INICIO_GRID', to_char(current_setting('cpoe_gerar_registro_json_pck.dt_inicio_grid_w')::timestamp, 'dd/mm/yyyy hh24:mi:ss'),1) ||
													format_array_json('DT_SUSPENSAO', to_char(current_setting('cpoe_gerar_registro_json_pck.dt_suspensao_item_w')::prescr_gasoterapia.dt_suspensao%type, 'dd/mm/yyyy hh24:mi:ss'),1) ||
													format_array_json('DT_LIB_SUSPENSAO', to_char(current_setting('cpoe_gerar_registro_json_pck.dt_lib_suspensao_item_w')::cpoe_gasoterapia.dt_lib_suspensao%type, 'dd/mm/yyyy hh24:mi:ss'),1) ||
													format_array_json('DT_COLETA', to_char(dt_coleta_w, 'dd/mm/yyyy hh24:mi:ss'),1) ||
													format_array_json('DT_DESCONTINUACAO', to_char(current_setting('cpoe_gerar_registro_json_pck.dt_suspensao_item_w')::prescr_gasoterapia.dt_suspensao%type, 'dd/mm/yyyy hh24:mi:ss'),1) ||
													format_array_json('NM_USUARIO_SUSP', current_setting('cpoe_gerar_registro_json_pck.nm_usuario_susp_w')::cpoe_dieta.nm_usuario_susp%type,1) ||
													format_array_json('NM_USUARIO_DESCONTINUACAO', current_setting('cpoe_gerar_registro_json_pck.nm_usuario_descontinuacao_w')::varchar(255),1) ||
													format_array_json('HR_PRIM_HORARIO',current_setting('cpoe_gerar_registro_json_pck.hr_prim_horario_w')::varchar(5),1)        ||
													format_array_json('IE_DURACAO', current_setting('cpoe_gerar_registro_json_pck.ie_duracao_w')::cpoe_dieta.ie_duracao%type,1)                 ||
													format_array_json('QT_PECA_AP', qt_peca_ap_w,1)                 ||
													format_array_json('IE_ADMINISTRACAO', current_setting('cpoe_gerar_registro_json_pck.ie_administracao_w')::cpoe_dieta.ie_administracao%type,1)		||
													format_array_json('IE_EVENTO_UNICO', current_setting('cpoe_gerar_registro_json_pck.ie_evento_unico_w')::cpoe_dieta.ie_evento_unico%type,1) 		||
													format_array_json('DS_LOCALIZACAO_LESAO', ds_localizacao_lesao_w,1) 		||
													format_array_json('IE_SUSPENSO',ie_suspenso_w,1)                ||
													format_array_json('IE_URGENCIA',current_setting('cpoe_gerar_registro_json_pck.ie_urgencia_w')::varchar(1),1)                ||
													format_array_json('DS_TEMPO_DOENCA',ds_tempo_doenca_w,1)                ||
													format_array_json('CD_SETOR_ATENDIMENTO',current_setting('cpoe_gerar_registro_json_pck.cd_setor_atendimento_w')::cpoe_gasoterapia.cd_setor_atendimento%type,1)                ||
													format_array_json('CD_CGC_LABORATORIO',cd_cgc_laboratorio_w,1)                ||
													format_array_json('DS_EXAME_ANTERIOR_AP',ds_exame_anterior_ap_w,1)                ||
													format_array_json('DS_DIAG_PROVAVEL_AP',ds_diag_provavel_ap_w,1)                ||
													format_array_json('NR_SEQ_PROC_INTERNO',nr_seq_proc_interno_w,1)||
													format_array_json('NM_USUARIO', current_setting('cpoe_gerar_registro_json_pck.nm_usuario_w')::prescr_gasoterapia.nm_usuario%type,1)                 ||
													format_array_json('IE_AMOSTRA', ie_amostra_w,1)                 ||
													format_array_json('QT_FRASCO_ENV', qt_frasco_env_w,1)                 ||
													format_array_json('IE_FORMA_EXAME', ie_forma_exame_w,1)                 ||
													format_array_json('IE_TIPO', substr(Obter_tipo_proc_interno(nr_seq_proc_interno_w),1,255),1)                 ||
													format_array_json('NM_USUARIO_NREC', current_setting('cpoe_gerar_registro_json_pck.nm_usuario_nrec_w')::prescr_gasoterapia_evento.nm_usuario_nrec%type,1)       ||
													format_array_json('DS_QUALIDADE_PECA_AP', ds_qualidade_peca_ap_w,1)       ||
													format_array_json('NR_SEQ_AMOSTRA_PRINC', nr_seq_amostra_princ_w,1)       ||
													format_array_json('QT_PROCEDIMENTO',qt_procedimento_w,1)        ||
													format_array_json('NR_SEQ_PROC_CPOE',nr_seq_proc_cpoe_w,1)      ||
													format_array_json('NR_ATENDIMENTO', nr_atendimento_p,1) 		||
													format_array_json('DS_DADO_CLINICO',cpoe_gerar_registro_json_pck.remove_aspas(ds_dado_clinico_w),1)        ||
													format_array_json('DS_PRESCRITOR_DETALHE', cpoe_gerar_registro_json_pck.remove_aspas(current_setting('cpoe_gerar_registro_json_pck.ds_prescritor_w')::varchar(255)),1)	||
													format_array_json('DT_PRESCRITA_DETALHE', current_setting('cpoe_gerar_registro_json_pck.dt_prescrito_w')::varchar(255),1)		||
													format_array_json('DS_PREVIOUS_PRESCRIBER', cpoe_gerar_registro_json_pck.remove_aspas(current_setting('cpoe_gerar_registro_json_pck.ds_previous_prescriber_w')::varchar(255)),1) ||
													format_array_json('DT_PREVIOUS_PRESCRIBER', current_setting('cpoe_gerar_registro_json_pck.dt_previous_prescriber_w')::varchar(255),1) ||
													format_array_json('CD_PESSOA_COLETA', cd_pessoa_coleta_w,1)		||
													format_array_json('NR_SEQ_PROC_INT_CIRUR', nr_seq_proc_int_cirur_w,1)		||
													format_array_json('DS_CONSELHO', cpoe_gerar_registro_json_pck.remove_aspas(current_setting('cpoe_gerar_registro_json_pck.ds_conselho_w')::varchar(255)),1)				||	
													format_array_json('DS_PRESCRITOR', cpoe_gerar_registro_json_pck.remove_aspas(current_setting('cpoe_gerar_registro_json_pck.ds_prescritor_grid_w')::varchar(255)),1) ||
													format_array_json('DS_PRESCRITOR_REVAL', cpoe_gerar_registro_json_pck.remove_aspas(current_setting('cpoe_gerar_registro_json_pck.ds_prescritor_reval_w')::varchar(255)),1) ||
													format_array_json('NR_SEQ_VISAO', 70212, 1) ||
													format_array_json('NR_SEQ_ASSINATURA', current_setting('cpoe_gerar_registro_json_pck.nr_seq_assinatura_w')::cpoe_gasoterapia.nr_seq_assinatura%type, 1)	||
													format_array_json('DT_ASSINATURA_DIGITAL', to_char(current_setting('cpoe_gerar_registro_json_pck.dt_assinatura_digital_w')::tasy_assinatura_digital.dt_assinatura%type, 'dd/mm/yyyy hh24:mi:ss'), 1) ||
													format_array_json('NR_SEQ_CPOE_ORDER_UNIT', current_setting('cpoe_gerar_registro_json_pck.nr_seq_cpoe_order_unit_w')::cpoe_order_unit.nr_sequencia%type, 1);

	ds_json_proc_w := substr(ds_json_proc_w,1,length(ds_json_proc_w)-2) || '},';
end loop;
close current_setting('cpoe_gerar_registro_json_pck.c01')::CURSOR;

if (ds_json_proc_w IS NOT NULL AND ds_json_proc_w::text <> '') then
	begin
	PERFORM set_config('cpoe_gerar_registro_json_pck.ds_registro_w', format_json('DS_ANATOMIA_PATOLOGICA', ds_json_proc_w), false);


	CALL cpoe_gerar_registro_json_pck.cpoe_salvar_json( 	nr_atendimento_p,
						dt_referencia_p,
						nm_usuario_p,
						'AP',
						current_setting('cpoe_gerar_registro_json_pck.ds_registro_w')::text);

	end;
end if;

commit;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_gerar_registro_json_pck.cpoe_gerar_registro_anat_json ( nr_atendimento_p bigint, dt_referencia_p timestamp, nm_usuario_p text, nr_prescricao_p bigint default null) FROM PUBLIC;
