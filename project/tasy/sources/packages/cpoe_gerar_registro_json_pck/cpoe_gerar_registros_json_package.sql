-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE cpoe_gerar_registro_json_pck.cpoe_gerar_registros_json (nr_atendimento_p bigint, dt_referencia_p timestamp, nm_usuario_p text, nr_prescricao_p bigint default null) AS $body$
BEGIN

if (coalesce(philips_param_pck.get_nr_seq_idioma::text, '') = '') then
	CALL philips_param_pck.set_nr_seq_idioma(obter_nr_seq_idioma(nm_usuario_p));
end if;

EXECUTE 'ALTER SESSION SET NLS_LANGUAGE=''BRAZILIAN PORTUGUESE''';
EXECUTE 'ALTER SESSION SET NLS_TERRITORY = ''BRAZIL''';

if (philips_param_pck.get_nr_seq_idioma = 2) then -- Espanhol (MX)
	EXECUTE 'ALTER SESSION SET NLS_NUMERIC_CHARACTERS=''.,''';
else
EXECUTE 'ALTER SESSION SET NLS_NUMERIC_CHARACTERS='',.''';
end if;

EXECUTE 'ALTER SESSION SET NLS_DATE_FORMAT = ''DD/MM/YYYY HH24:MI:SS''';

delete 	from CPOE_JSON_ITEM
where 	nr_atendimento = nr_atendimento_p
and		dt_referencia = trunc(dt_referencia_p);

PERFORM set_config('cpoe_gerar_registro_json_pck.dt_hora_formatada_w', to_date(to_char( dt_referencia_p, 'dd/mm/yyyy') ||' ' || '08:00','dd/mm/yyyy hh24:mi'), false);
PERFORM set_config('cpoe_gerar_registro_json_pck.dt_hora_fim_formatada_w', ((to_date(to_char(dt_referencia_p, 'dd/mm/yyyy') ||' 08:00', 'dd/mm/yyyy hh24:mi')  + 1) - 1/86400), false);

begin
	CALL cpoe_gerar_registro_json_pck.cpoe_gerar_registro_med_json(nr_atendimento_p, dt_referencia_p, nm_usuario_p, nr_prescricao_p);
exception
when others then
	CALL gravar_log_cpoe(substr('CPOE_GERAR_REGISTRO_MED_JSON '|| dt_referencia_p|| ' ERRO: ' ||to_char(sqlerrm),1,2000), nr_atendimento_p);
end;

begin
	CALL cpoe_gerar_registro_json_pck.cpoe_gerar_registro_mat_json(nr_atendimento_p, dt_referencia_p, nm_usuario_p, nr_prescricao_p);
exception
when others then
	CALL gravar_log_cpoe(substr('CPOE_GERAR_REGISTRO_MAT_JSON '|| dt_referencia_p || ' ERRO: ' ||to_char(sqlerrm),1,2000), nr_atendimento_p);
end;

begin
	CALL cpoe_gerar_registro_json_pck.cpoe_gerar_registro_anat_json(nr_atendimento_p, dt_referencia_p, nm_usuario_p, nr_prescricao_p);
exception
when others then
	CALL gravar_log_cpoe(substr('CPOE_GERAR_REGISTRO_ANAT_JSON '|| dt_referencia_p || ' ERRO: ' ||to_char(sqlerrm),1,2000), nr_atendimento_p);
end;

begin
	CALL cpoe_gerar_registro_json_pck.cpoe_gerar_registro_proc_json(nr_atendimento_p, dt_referencia_p, nm_usuario_p, nr_prescricao_p);
exception
when others then
	CALL gravar_log_cpoe(substr('CPOE_GERAR_REGISTRO_PROC_JSON '|| dt_referencia_p || ' ERRO: ' ||to_char(sqlerrm),1,2000), nr_atendimento_p);
end;

begin	

	CALL cpoe_gerar_registro_json_pck.cpoe_gerar_registro_rec_json(nr_atendimento_p, dt_referencia_p, nm_usuario_p, nr_prescricao_p);
exception
when others then
	CALL gravar_log_cpoe(substr('CPOE_GERAR_REGISTRO_REC_JSON '|| dt_referencia_p || ' ERRO: ' ||to_char(sqlerrm),1,2000), nr_atendimento_p);
end;

begin
	cpoe_gerar_registro_gas_json(nr_atendimento_p, dt_referencia_p, nm_usuario_p, nr_prescricao_p);
exception
when others then
	CALL gravar_log_cpoe(substr('CPOE_GERAR_REGISTRO_GAS_JSON '|| dt_referencia_p || ' ERRO: ' ||to_char(sqlerrm),1,2000), nr_atendimento_p);	
end;	

begin	
	cpoe_gerar_registro_dieta_json(nr_atendimento_p, nm_usuario_p,dt_referencia_p, nr_prescricao_p);
exception
when others then
	CALL gravar_log_cpoe(substr('CPOE_GERAR_REGISTRO_DIETA_JSON '|| dt_referencia_p || ' ERRO: ' ||to_char(sqlerrm),1,2000), nr_atendimento_p);
end;	

begin
	CALL cpoe_gerar_registro_json_pck.cpoe_gerar_registro_hemo_json(nr_atendimento_p, nm_usuario_p,dt_referencia_p, nr_prescricao_p);
exception
when others then
	CALL gravar_log_cpoe(substr('CPOE_GERAR_REGISTRO_HEMO_JSON '|| dt_referencia_p || ' ERRO: ' ||to_char(sqlerrm),1,2000), nr_atendimento_p);
end;	

begin
	CALL cpoe_gerar_registro_json_pck.cpoe_gerar_registro_dial_json(nr_atendimento_p, nm_usuario_p,dt_referencia_p, nr_prescricao_p);
exception
when others then
	CALL gravar_log_cpoe(substr('CPOE_GERAR_REGISTRO_DIAL_JSON '|| dt_referencia_p || ' ERRO: ' ||to_char(sqlerrm),1,2000), nr_atendimento_p);
end;	

begin
	CALL cpoe_gerar_registro_json_pck.cpoe_gerar_registro_sae_json(nr_atendimento_p, dt_referencia_p, nm_usuario_p, nr_prescricao_p);
exception
when others then
	CALL gravar_log_cpoe(substr('CPOE_GERAR_REGISTRO_SAE_JSON '|| dt_referencia_p ||' ERRO: ' ||to_char(sqlerrm),1,2000), nr_atendimento_p);
end;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_gerar_registro_json_pck.cpoe_gerar_registros_json (nr_atendimento_p bigint, dt_referencia_p timestamp, nm_usuario_p text, nr_prescricao_p bigint default null) FROM PUBLIC;
