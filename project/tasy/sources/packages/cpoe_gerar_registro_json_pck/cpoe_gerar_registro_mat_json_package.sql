-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE cpoe_gerar_registro_json_pck.cpoe_gerar_registro_mat_json ( nr_atendimento_p bigint, dt_referencia_p timestamp, nm_usuario_p text, nr_prescricao_p bigint default null) AS $body$
DECLARE


	current_setting('cpoe_gerar_registro_json_pck.ds_registro_w')::text					text;
	current_setting('cpoe_gerar_registro_json_pck.ds_json_mat_w')::text					text;
	ds_node_horarios_w				text;
	current_setting('cpoe_gerar_registro_json_pck.ds_item_w')::varchar(1000)						varchar(1000);
	current_setting('cpoe_gerar_registro_json_pck.ds_item_ww')::varchar(1000)						varchar(1000);
	ds_intervalo_w					varchar(255);
	current_setting('cpoe_gerar_registro_json_pck.dt_horario_w')::prescr_mat_hor.dt_horario%type					varchar(20);
	current_setting('cpoe_gerar_registro_json_pck.dt_fim_horario_w')::varchar(20)				varchar(20);
	current_setting('cpoe_gerar_registro_json_pck.dt_suspensao_w')::varchar(20)					varchar(20);
	current_setting('cpoe_gerar_registro_json_pck.ds_hora_w')::varchar(255)						varchar(255);
	current_setting('cpoe_gerar_registro_json_pck.nr_hora_w')::integer						bigint;
	current_setting('cpoe_gerar_registro_json_pck.count_cpoe_material_w')::integer 			bigint;
	seq_w                   		double precision;
	current_setting('cpoe_gerar_registro_json_pck.ds_conselho_w')::varchar(255)					varchar(255);
	current_setting('cpoe_gerar_registro_json_pck.ds_prescritor_grid_w')::varchar(255)			varchar(255);
	current_setting('cpoe_gerar_registro_json_pck.ds_prescritor_reval_w')::varchar(255)			varchar(255);
	current_setting('cpoe_gerar_registro_json_pck.nm_usuario_descontinuacao_w')::varchar(255)		varchar(255);
	current_setting('cpoe_gerar_registro_json_pck.dt_inicio_grid_w')::timestamp				timestamp;

	nr_prescricao_w					prescr_medica.nr_prescricao%type;
	current_setting('cpoe_gerar_registro_json_pck.dt_liberacao_w')::prescr_medica.dt_liberacao%type 					prescr_medica.dt_liberacao%type;
	current_setting('cpoe_gerar_registro_json_pck.dt_liberacao_enfermagem_w')::prescr_medica.dt_liberacao%type		prescr_medica.dt_liberacao%type;
	current_setting('cpoe_gerar_registro_json_pck.dt_liberacao_farmacia_w')::prescr_medica.dt_liberacao_farmacia%type			prescr_medica.dt_liberacao_farmacia%type;		
	current_setting('cpoe_gerar_registro_json_pck.ie_momento_lote_w')::regra_disp_lote_farm.ie_momento_lote%type				regra_disp_lote_farm.ie_momento_lote%type;
	current_setting('cpoe_gerar_registro_json_pck.nm_usuario_lib_enfermagem_w')::varchar(255)		varchar(255);
	current_setting('cpoe_gerar_registro_json_pck.nm_usuario_lib_farmacia_w')::varchar(255)		varchar(255);

	current_setting('cpoe_gerar_registro_json_pck.cd_material_w')::cpoe_material.cd_material%type					prescr_material.cd_material%type;
	nr_seq_material_w   			prescr_material.NR_SEQUENCIA%type;
	current_setting('cpoe_gerar_registro_json_pck.cd_intervalo_w')::prescr_gasoterapia.cd_intervalo%type					prescr_material.cd_intervalo%type;
	current_setting('cpoe_gerar_registro_json_pck.nr_seq_mat_cpoe_w')::cpoe_material.nr_sequencia%type				prescr_material.nr_seq_mat_cpoe%type;
	current_setting('cpoe_gerar_registro_json_pck.ds_horarios_w')::prescr_gasoterapia.ds_horarios%type					prescr_material.ds_horarios%type;
	current_setting('cpoe_gerar_registro_json_pck.hr_prim_horario_w')::varchar(5)				prescr_material.hr_prim_horario%type;
	current_setting('cpoe_gerar_registro_json_pck.ie_urgencia_w')::varchar(1)					cpoe_material.ie_urgencia%type;
	current_setting('cpoe_gerar_registro_json_pck.qt_dose_w')::cpoe_material.qt_dose%type						prescr_material.qt_dose%type;
	current_setting('cpoe_gerar_registro_json_pck.cd_unidade_medida_w')::cpoe_material.cd_unidade_medida%type				prescr_material.cd_unidade_medida%type;		
	current_setting('cpoe_gerar_registro_json_pck.ds_justificativa_w')::cpoe_material.ds_justificativa%type				prescr_material.ds_justificativa%type;
	current_setting('cpoe_gerar_registro_json_pck.nm_usuario_w')::prescr_gasoterapia.nm_usuario%type					prescr_material.nm_usuario%type;
	current_setting('cpoe_gerar_registro_json_pck.nm_usuario_nrec_w')::prescr_gasoterapia_evento.nm_usuario_nrec%type				prescr_material.nm_usuario_nrec%type;
	current_setting('cpoe_gerar_registro_json_pck.dt_atualizacao_w')::prescr_gasoterapia.dt_atualizacao%type				prescr_material.dt_atualizacao%type;
	current_setting('cpoe_gerar_registro_json_pck.dt_atualizacao_nrec_w')::prescr_gasoterapia_evento.dt_atualizacao_nrec%type 			prescr_material.dt_atualizacao%type;
	current_setting('cpoe_gerar_registro_json_pck.dt_suspensao_item_w')::prescr_gasoterapia.dt_suspensao%type				prescr_material.dt_suspensao%type;

	current_setting('cpoe_gerar_registro_json_pck.ds_prescritor_w')::varchar(255)					varchar(255);
	current_setting('cpoe_gerar_registro_json_pck.dt_prescrito_w')::varchar(255)					varchar(255);
	current_setting('cpoe_gerar_registro_json_pck.ds_previous_prescriber_w')::varchar(255)		varchar(255);
	current_setting('cpoe_gerar_registro_json_pck.dt_previous_prescriber_w')::varchar(255)		varchar(255);

	ie_agrupador_w					prescr_material.ie_agrupador%type;

	current_setting('cpoe_gerar_registro_json_pck.dt_horario_ww')::prescr_gasoterapia_hor.dt_horario%type					prescr_mat_hor.dt_horario%type;
	current_setting('cpoe_gerar_registro_json_pck.dt_horario_fim_w')::cpoe_dieta.dt_fim%type				prescr_mat_hor.dt_horario%type;

	qt_dose_correcao_w      		cpoe_material.qt_dose_correcao1%type;
	current_setting('cpoe_gerar_registro_json_pck.dt_fim_w')::cpoe_dieta.dt_fim%type						cpoe_material.dt_fim%type;
	current_setting('cpoe_gerar_registro_json_pck.dt_inicio_w')::cpoe_dieta.dt_inicio%type						cpoe_material.dt_inicio%type;
	current_setting('cpoe_gerar_registro_json_pck.ie_duracao_w')::cpoe_dieta.ie_duracao%type					cpoe_material.ie_duracao%type;
	current_setting('cpoe_gerar_registro_json_pck.nm_usuario_susp_w')::cpoe_dieta.nm_usuario_susp%type				cpoe_material.nm_usuario_susp%type;
	dt_lip_suspensao_item_w			cpoe_material.dt_lib_suspensao%type;
	current_setting('cpoe_gerar_registro_json_pck.ie_motivo_prescricao_w')::cpoe_gasoterapia.ie_motivo_prescricao%type			cpoe_material.ie_motivo_prescricao%type;
	current_setting('cpoe_gerar_registro_json_pck.cd_setor_atendimento_w')::cpoe_gasoterapia.cd_setor_atendimento%type			cpoe_material.cd_setor_atendimento%type;
	current_setting('cpoe_gerar_registro_json_pck.ie_oncologia_w')::cpoe_material.ie_oncologia%type					cpoe_material.ie_oncologia%type;

	current_setting('cpoe_gerar_registro_json_pck.cd_estabelecimento_w')::estabelecimento.cd_estabelecimento%type			estabelecimento.cd_estabelecimento%type;

	ie_depart_lib_setor_w			varchar(1);
	ie_prescritor_aux_w				varchar(1);
	ie_tipo_item_w					varchar(10);
	cd_medico_w						cpoe_material.cd_medico%type;
	ie_order_on_behalf_w			varchar(1);
	current_setting('cpoe_gerar_registro_json_pck.dt_ciencia_medico_w')::varchar(255)				cpoe_material.dt_ciencia_medico%type;
	ie_exige_ciencia_w				cpoe_material.ie_exige_ciencia%type;
	dt_liberacao_aux_w				cpoe_material.dt_liberacao%type;
	cd_departamento_w				cpoe_material.cd_departamento%type;
	ie_material_w					cpoe_material.ie_material%type;

	current_setting('cpoe_gerar_registro_json_pck.nr_seq_assinatura_w')::cpoe_gasoterapia.nr_seq_assinatura%type				cpoe_material.nr_seq_assinatura%type;
	current_setting('cpoe_gerar_registro_json_pck.dt_assinatura_digital_w')::tasy_assinatura_digital.dt_assinatura%type			tasy_assinatura_digital.dt_assinatura%type;
	current_setting('cpoe_gerar_registro_json_pck.nr_seq_cpoe_order_unit_w')::cpoe_order_unit.nr_sequencia%type        cpoe_order_unit.nr_sequencia%type;

	current_setting('cpoe_gerar_registro_json_pck.c01')::CURSOR CURSOR FOR  --Materials
	SELECT	distinct a.cd_material,
		a.cd_intervalo,
		a.nr_sequencia,
		a.ds_horarios,
		a.ie_urgencia,
		a.hr_prim_horario,
		a.dt_inicio,
		a.qt_dose,
		a.cd_unidade_medida,
		a.ds_justificativa,
		a.dt_liberacao,
		a.ie_motivo_prescricao,
		a.cd_setor_atendimento, 
		a.ie_oncologia,
		a.dt_suspensao,  
		a.dt_lib_suspensao, 
		a.nm_usuario,
		a.nm_usuario_nrec,
		a.dt_atualizacao,
		a.dt_atualizacao_nrec,
		a.ie_prescritor_aux,
		obter_se_depart_lib_setor(obter_departamento_setor(a.cd_departamento)),
		cpoe_obter_tipo_item('CPOE_PROCEDIMENTO',a.nr_sequencia),
		a.cd_medico,
		get_ordered_on_behalf(a.nr_sequencia,'P'),
		a.dt_ciencia_medico,
		a.ie_exige_ciencia,
		a.dt_liberacao_aux,
		a.cd_departamento,
		coalesce(a.ie_material,'N'),
		a.nr_seq_assinatura,
		a.nr_seq_cpoe_order_unit
	from	cpoe_material a,
		prescr_material b,
		prescr_mat_hor c,
		prescr_medica d
	where	a.nr_atendimento = nr_atendimento_p
	and	a.dt_prox_geracao > current_setting('cpoe_gerar_registro_json_pck.dt_hora_formatada_w')::timestamp - 1
	and	(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
	and	a.nr_sequencia = b.nr_seq_mat_cpoe
	and	b.nr_prescricao = c.nr_prescricao
	and	b.nr_sequencia = c.nr_seq_material
	and	b.nr_prescricao = d.nr_prescricao
	and	b.ie_agrupador = 2 
	and	upper(b.ie_origem_inf) <> 'K' 
	and	coalesce(b.nr_seq_kit::text, '') = ''
	and coalesce(a.nr_seq_procedimento::text, '') = ''
	and ((coalesce(nr_prescricao_p,0) = 0)  or (b.nr_prescricao = nr_prescricao_p))
	AND	(((cpoe_reg_valido_ativacao(CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,dt_fim) END , a.dt_inicio, current_setting('cpoe_gerar_registro_json_pck.dt_hora_formatada_w')::timestamp, NULL, a.cd_perfil_ativo, a.ie_retrogrado, a.dt_liberacao , 'N', a.ie_futuro, a.dt_liberacao_fut) = 'S') and (current_setting('cpoe_gerar_registro_json_pck.dt_hora_formatada_w')::timestamp > a.dt_inicio)) or (c.dt_horario between current_setting('cpoe_gerar_registro_json_pck.dt_hora_formatada_w')::timestamp	and	current_setting('cpoe_gerar_registro_json_pck.dt_hora_fim_formatada_w')::timestamp))
	order by a.nr_sequencia;

	current_setting('cpoe_gerar_registro_json_pck.c02')::CURSOR CURSOR FOR  --search schedules of the materials
		SELECT	to_char(a.dt_horario,'dd/mm/yyyy hh24:mi'),
				coalesce(to_char(a.dt_fim_horario,'dd/mm/yyyy hh24:mi'),'null'),
				coalesce(to_char(a.dt_suspensao,'dd/mm/yyyy hh24:mi'),'null'),
				a.dt_horario
		from	prescr_mat_hor a,
				prescr_material b
		where	a.nr_prescricao = b.nr_prescricao
		and     a.nr_seq_material = b.nr_sequencia
		and		b.nr_seq_mat_cpoe = current_setting('cpoe_gerar_registro_json_pck.nr_seq_mat_cpoe_w')::cpoe_material.nr_sequencia%type
		and		a.dt_horario between current_setting('cpoe_gerar_registro_json_pck.dt_hora_formatada_w')::timestamp	and	current_setting('cpoe_gerar_registro_json_pck.dt_hora_fim_formatada_w')::timestamp
		order by a.dt_horario;

	
BEGIN

	open current_setting('cpoe_gerar_registro_json_pck.c01')::CURSOR;
	loop
	fetch current_setting('cpoe_gerar_registro_json_pck.c01')::into CURSOR
		current_setting('cpoe_gerar_registro_json_pck.cd_material_w')::cpoe_material.cd_material%type,
		current_setting('cpoe_gerar_registro_json_pck.cd_intervalo_w')::prescr_gasoterapia.cd_intervalo%type,
		current_setting('cpoe_gerar_registro_json_pck.nr_seq_mat_cpoe_w')::cpoe_material.nr_sequencia%type,
		current_setting('cpoe_gerar_registro_json_pck.ds_horarios_w')::prescr_gasoterapia.ds_horarios%type,
		current_setting('cpoe_gerar_registro_json_pck.ie_urgencia_w')::varchar(1),
		current_setting('cpoe_gerar_registro_json_pck.hr_prim_horario_w')::varchar(5),
		current_setting('cpoe_gerar_registro_json_pck.dt_inicio_grid_w')::timestamp,
		current_setting('cpoe_gerar_registro_json_pck.qt_dose_w')::cpoe_material.qt_dose%type,
		current_setting('cpoe_gerar_registro_json_pck.cd_unidade_medida_w')::cpoe_material.cd_unidade_medida%type,			
		current_setting('cpoe_gerar_registro_json_pck.ds_justificativa_w')::cpoe_material.ds_justificativa%type,
		current_setting('cpoe_gerar_registro_json_pck.dt_liberacao_w')::prescr_medica.dt_liberacao%type,
		current_setting('cpoe_gerar_registro_json_pck.ie_motivo_prescricao_w')::cpoe_gasoterapia.ie_motivo_prescricao%type,
		current_setting('cpoe_gerar_registro_json_pck.cd_setor_atendimento_w')::cpoe_gasoterapia.cd_setor_atendimento%type,
		current_setting('cpoe_gerar_registro_json_pck.ie_oncologia_w')::cpoe_material.ie_oncologia%type,
		current_setting('cpoe_gerar_registro_json_pck.dt_suspensao_item_w')::prescr_gasoterapia.dt_suspensao%type,
		dt_lip_suspensao_item_w,
		current_setting('cpoe_gerar_registro_json_pck.nm_usuario_w')::prescr_gasoterapia.nm_usuario%type,
		current_setting('cpoe_gerar_registro_json_pck.nm_usuario_nrec_w')::prescr_gasoterapia_evento.nm_usuario_nrec%type,
		current_setting('cpoe_gerar_registro_json_pck.dt_atualizacao_w')::prescr_gasoterapia.dt_atualizacao%type,
		current_setting('cpoe_gerar_registro_json_pck.dt_atualizacao_nrec_w')::prescr_gasoterapia_evento.dt_atualizacao_nrec%type,
		ie_depart_lib_setor_w,
		ie_prescritor_aux_w,
		ie_tipo_item_w,
		cd_medico_w,
		ie_order_on_behalf_w,
		current_setting('cpoe_gerar_registro_json_pck.dt_ciencia_medico_w')::varchar(255),
		ie_exige_ciencia_w,
		dt_liberacao_aux_w,
		cd_departamento_w,
		ie_material_w,
		current_setting('cpoe_gerar_registro_json_pck.nr_seq_assinatura_w')::cpoe_gasoterapia.nr_seq_assinatura%type,
		current_setting('cpoe_gerar_registro_json_pck.nr_seq_cpoe_order_unit_w')::cpoe_order_unit.nr_sequencia%type;
	EXIT WHEN NOT FOUND; /* apply on current_setting('cpoe_gerar_registro_json_pck.c01')::CURSOR */

		PERFORM set_config('cpoe_gerar_registro_json_pck.cd_estabelecimento_w', obter_estabelecimento_setor(current_setting('cpoe_gerar_registro_json_pck.cd_setor_atendimento_w')::cpoe_gasoterapia.cd_setor_atendimento%type), false);
		PERFORM set_config('cpoe_gerar_registro_json_pck.ie_momento_lote_w', cpoe_obter_momento_lote(current_setting('cpoe_gerar_registro_json_pck.ie_motivo_prescricao_w')::cpoe_gasoterapia.ie_motivo_prescricao%type, current_setting('cpoe_gerar_registro_json_pck.cd_setor_atendimento_w')::cpoe_gasoterapia.cd_setor_atendimento%type, current_setting('cpoe_gerar_registro_json_pck.cd_estabelecimento_w')::estabelecimento.cd_estabelecimento%type, current_setting('cpoe_gerar_registro_json_pck.ie_oncologia_w')::cpoe_material.ie_oncologia%type, 'CPOE_MATERIAL', current_setting('cpoe_gerar_registro_json_pck.nr_seq_mat_cpoe_w')::cpoe_material.nr_sequencia%type, null, null, 'S'), false);
		PERFORM set_config('cpoe_gerar_registro_json_pck.dt_inicio_grid_w', cpoe_obter_data_hora_form(current_setting('cpoe_gerar_registro_json_pck.dt_inicio_grid_w')::timestamp, current_setting('cpoe_gerar_registro_json_pck.hr_prim_horario_w')::varchar(5)), false);
		PERFORM set_config('cpoe_gerar_registro_json_pck.dt_suspensao_item_w', cpoe_gerar_registro_json_pck.regra_data_susp(current_setting('cpoe_gerar_registro_json_pck.dt_suspensao_item_w')::prescr_gasoterapia.dt_suspensao%type), false);
		dt_lip_suspensao_item_w := cpoe_gerar_registro_json_pck.regra_data_susp(dt_lip_suspensao_item_w);
		PERFORM set_config('cpoe_gerar_registro_json_pck.ds_item_w', substr(obter_desc_material(current_setting('cpoe_gerar_registro_json_pck.cd_material_w')::cpoe_material.cd_material%type),1,150), false);
		PERFORM set_config('cpoe_gerar_registro_json_pck.ds_item_ww', current_setting('cpoe_gerar_registro_json_pck.ds_item_w')::varchar(1000), false);

		CALL cpoe_gerar_registro_json_pck.cpoe_limpar_valores_horas();

		select count(*)
		into STRICT   current_setting('cpoe_gerar_registro_json_pck.count_cpoe_material_w')::integer
		from   cpoe_material
		where  nr_sequencia = current_setting('cpoe_gerar_registro_json_pck.nr_seq_mat_cpoe_w')::cpoe_material.nr_sequencia%type;

		PERFORM set_config('cpoe_gerar_registro_json_pck.dt_fim_w', '', false);
		PERFORM set_config('cpoe_gerar_registro_json_pck.dt_inicio_w', current_setting('cpoe_gerar_registro_json_pck.dt_inicio_grid_w')::timestamp, false);
		PERFORM set_config('cpoe_gerar_registro_json_pck.ie_duracao_w', '', false);

		if (current_setting('cpoe_gerar_registro_json_pck.count_cpoe_material_w')::integer > 0) then
			begin
			select	dt_fim,
					dt_inicio,
					ie_duracao,
					ie_urgencia,
					replace(CPOE_obter_desc_info_material(cd_material,cd_mat_comp1,qt_dose_comp1,cd_unid_med_dose_comp1,cd_mat_comp2,qt_dose_comp2,cd_unid_med_dose_comp2,cd_mat_comp3,qt_dose_comp3,cd_unid_med_dose_comp3,
					cd_mat_dil,qt_dose_dil,cd_unid_med_dose_dil,cd_mat_red,qt_dose_red,cd_unid_med_dose_red,dt_liberacao,qt_dose,cd_unidade_medida,ie_via_aplicacao,cd_intervalo, cpoe_gerar_registro_json_pck.regra_data_susp(dt_lib_suspensao),
					cpoe_gerar_registro_json_pck.regra_data_susp(dt_suspensao),ie_administracao,nr_seq_ataque,nr_seq_procedimento,nr_seq_adicional,nr_seq_hemoterapia,ds_dose_diferenciada,ds_dose_diferenciada_dil,ds_dose_diferenciada_red,ds_dose_diferenciada_comp1,
					ds_dose_diferenciada_comp2,ds_dose_diferenciada_comp3,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,'N',null,null,null,null,
					null,null,null,null,null,null,null,null,null,null,'S','N',null,obter_horarios_regra(ds_horarios)),'"','@#'),
					dt_liberacao_enf dt_liberacao_enfermagem,
					dt_liberacao_farm dt_liberacao_farmacia,
					nm_usuario_lib_enf nm_usuario_lib_enfermagem,
					nm_usuario_lib_farm nm_usuario_lib_farmacia,
					obter_initcap(obter_nome_medico(obter_pf_usuario(nm_usuario_nrec,'C'),'PMS')),
					cpoe_obter_tempo_prescrito(coalesce(dt_atualizacao_nrec, dt_atualizacao)),
					cpoe_get_prior_prescriber(nr_seq_cpoe_anterior, 'CPOE_MATERIAL', 'N'),
					cpoe_get_prior_prescriber(nr_seq_cpoe_anterior, 'CPOE_MATERIAL', 'D'),
					substr(obter_dados_pf(obter_pf_usuario(nm_usuario_nrec,'C'),'COPR'),1,255) ds_conselho,
					obter_nome_pf(obter_pf_usuario(nm_usuario_nrec,'C')) ds_prescritor_grid,
					CASE WHEN coalesce(cpoe_gerar_registro_json_pck.regra_data_susp(dt_suspensao)::text, '') = '' THEN  null  ELSE nm_usuario_susp END ,
					CASE WHEN coalesce(cpoe_gerar_registro_json_pck.regra_data_susp(dt_suspensao)::text, '') = '' THEN  null  ELSE cpoe_obter_info_suspensao(nr_sequencia,'M','N') END  nm_usuario_descontinuacao,
					obter_data_assinatura_digital(nr_seq_assinatura),
					obter_pf_usuario(coalesce(nm_usuario, nm_usuario_nrec),'N') ds_prescritor_reval
			into STRICT	current_setting('cpoe_gerar_registro_json_pck.dt_fim_w')::cpoe_dieta.dt_fim%type,
					current_setting('cpoe_gerar_registro_json_pck.dt_inicio_w')::cpoe_dieta.dt_inicio%type,
					current_setting('cpoe_gerar_registro_json_pck.ie_duracao_w')::cpoe_dieta.ie_duracao%type,
					current_setting('cpoe_gerar_registro_json_pck.ie_urgencia_w')::varchar(1),
					current_setting('cpoe_gerar_registro_json_pck.ds_item_w')::varchar(1000),
					current_setting('cpoe_gerar_registro_json_pck.dt_liberacao_enfermagem_w')::prescr_medica.dt_liberacao%type,
					current_setting('cpoe_gerar_registro_json_pck.dt_liberacao_farmacia_w')::prescr_medica.dt_liberacao_farmacia%type,
					current_setting('cpoe_gerar_registro_json_pck.nm_usuario_lib_enfermagem_w')::varchar(255),
					current_setting('cpoe_gerar_registro_json_pck.nm_usuario_lib_farmacia_w')::varchar(255),
					current_setting('cpoe_gerar_registro_json_pck.ds_prescritor_w')::varchar(255),
					current_setting('cpoe_gerar_registro_json_pck.dt_prescrito_w')::varchar(255),
					current_setting('cpoe_gerar_registro_json_pck.ds_previous_prescriber_w')::varchar(255),
					current_setting('cpoe_gerar_registro_json_pck.dt_previous_prescriber_w')::varchar(255),
					current_setting('cpoe_gerar_registro_json_pck.ds_conselho_w')::varchar(255),
					current_setting('cpoe_gerar_registro_json_pck.ds_prescritor_grid_w')::varchar(255),
					current_setting('cpoe_gerar_registro_json_pck.nm_usuario_susp_w')::cpoe_dieta.nm_usuario_susp%type,
					current_setting('cpoe_gerar_registro_json_pck.nm_usuario_descontinuacao_w')::varchar(255),
					current_setting('cpoe_gerar_registro_json_pck.dt_assinatura_digital_w')::tasy_assinatura_digital.dt_assinatura%type,
					current_setting('cpoe_gerar_registro_json_pck.ds_prescritor_reval_w')::varchar(255)
			from	cpoe_material
			where	nr_sequencia = current_setting('cpoe_gerar_registro_json_pck.nr_seq_mat_cpoe_w')::cpoe_material.nr_sequencia%type;

			select	max(dt_fim_horario)
			into STRICT	current_setting('cpoe_gerar_registro_json_pck.dt_horario_fim_w')::cpoe_dieta.dt_fim%type
			from (SELECT	max(dt_horario) dt_fim_horario
					from	prescr_medica a,
							prescr_mat_hor b,
							prescr_material c,
							cpoe_material d
					where	a.nr_atendimento	= nr_atendimento_p
					and		a.nr_prescricao		= b.nr_prescricao
					and		b.nr_prescricao 	= c.nr_prescricao
					and		b.nr_seq_material	= c.nr_sequencia
					and		b.dt_horario between current_setting('cpoe_gerar_registro_json_pck.dt_hora_formatada_w')::timestamp	and	current_setting('cpoe_gerar_registro_json_pck.dt_hora_fim_formatada_w')::timestamp
					and 	c.nr_seq_mat_cpoe 	= d.nr_sequencia
					and		d.dt_fim			< b.dt_horario
					and		(d.dt_fim IS NOT NULL AND d.dt_fim::text <> '')
					and     (coalesce(a.dt_liberacao_medico, a.dt_liberacao) IS NOT NULL AND (coalesce(a.dt_liberacao_medico, a.dt_liberacao))::text <> '')
					and     c.ie_agrupador 		= 2
					and		d.nr_sequencia 		= current_setting('cpoe_gerar_registro_json_pck.nr_seq_mat_cpoe_w')::cpoe_material.nr_sequencia%type
					
union	all

					PERFORM	max(dt_fim) dt_fim_horario
					from	cpoe_material
					where	nr_atendimento	= nr_atendimento_p
					and		nr_sequencia	= current_setting('cpoe_gerar_registro_json_pck.nr_seq_mat_cpoe_w')::cpoe_material.nr_sequencia%type
					and		(dt_fim IS NOT NULL AND dt_fim::text <> '')) alias14;
			end;
		end if;

		open current_setting('cpoe_gerar_registro_json_pck.c02')::CURSOR;
			loop
			fetch current_setting('cpoe_gerar_registro_json_pck.c02')::into CURSOR
				current_setting('cpoe_gerar_registro_json_pck.dt_horario_w')::prescr_mat_hor.dt_horario%type,
				current_setting('cpoe_gerar_registro_json_pck.dt_fim_horario_w')::varchar(20),
				current_setting('cpoe_gerar_registro_json_pck.dt_suspensao_w')::varchar(20),
				current_setting('cpoe_gerar_registro_json_pck.dt_horario_ww')::prescr_gasoterapia_hor.dt_horario%type;
			EXIT WHEN NOT FOUND; /* apply on current_setting('cpoe_gerar_registro_json_pck.c02')::CURSOR */

				PERFORM set_config('cpoe_gerar_registro_json_pck.nr_hora_w', to_char(current_setting('cpoe_gerar_registro_json_pck.dt_horario_ww')::prescr_gasoterapia_hor.dt_horario%type,'hh24'), false);
				PERFORM set_config('cpoe_gerar_registro_json_pck.ds_hora_w', 'P', false);

				if (current_setting('cpoe_gerar_registro_json_pck.dt_fim_horario_w')::varchar(20) <> 'null') then
					PERFORM set_config('cpoe_gerar_registro_json_pck.ds_hora_w', 'S', false);
				end if;	

				if (current_setting('cpoe_gerar_registro_json_pck.dt_suspensao_w')::varchar(20)	<> 'null') then
					PERFORM set_config('cpoe_gerar_registro_json_pck.ds_hora_w', 'N', false);
				end if;

				CALL cpoe_gerar_registro_json_pck.cpoe_seta_status_horario(current_setting('cpoe_gerar_registro_json_pck.nr_hora_w')::integer, current_setting('cpoe_gerar_registro_json_pck.ds_hora_w')::varchar(255));

				if (current_setting('cpoe_gerar_registro_json_pck.dt_horario_fim_w')::cpoe_dieta.dt_fim%(type IS NOT NULL AND type::text <> '') and (current_setting('cpoe_gerar_registro_json_pck.dt_horario_fim_w')::cpoe_dieta.dt_fim%type between current_setting('cpoe_gerar_registro_json_pck.dt_hora_formatada_w')::timestamp	and	current_setting('cpoe_gerar_registro_json_pck.dt_hora_fim_formatada_w')::timestamp)) then
					begin
					CALL cpoe_gerar_registro_json_pck.cpoe_seta_status_fim_validade(current_setting('cpoe_gerar_registro_json_pck.dt_horario_fim_w')::cpoe_dieta.dt_fim%type);
					end;
				end if;

			end loop;
		close current_setting('cpoe_gerar_registro_json_pck.c02')::CURSOR;

			if (current_setting('cpoe_gerar_registro_json_pck.dt_inicio_w')::cpoe_dieta.dt_inicio%(type IS NOT NULL AND type::text <> '') and (current_setting('cpoe_gerar_registro_json_pck.dt_inicio_w')::cpoe_dieta.dt_inicio%type between current_setting('cpoe_gerar_registro_json_pck.dt_hora_formatada_w')::timestamp	and	current_setting('cpoe_gerar_registro_json_pck.dt_hora_fim_formatada_w')::timestamp)) then
				begin
				CALL cpoe_gerar_registro_json_pck.cpoe_seta_status_ini_validade(current_setting('cpoe_gerar_registro_json_pck.dt_inicio_w')::cpoe_dieta.dt_inicio%type);
				end;
			end if;

			if (coalesce(dt_lip_suspensao_item_w::text, '') = '') then
				PERFORM set_config('cpoe_gerar_registro_json_pck.dt_suspensao_item_w', null, false);
			end if;

			PERFORM set_config('cpoe_gerar_registro_json_pck.ds_json_mat_w', current_setting('cpoe_gerar_registro_json_pck.ds_json_mat_w')::text || '{' ||
							format_array_json('CD_MATERIAL',current_setting('cpoe_gerar_registro_json_pck.cd_material_w')::cpoe_material.cd_material%type,1)  ||
							format_array_json('DS_MATERIAL',current_setting('cpoe_gerar_registro_json_pck.ds_item_w')::varchar(1000),1)  ||
							format_array_json('DS_ITEM',current_setting('cpoe_gerar_registro_json_pck.ds_item_w')::varchar(1000),1)  ||
							format_array_json('CD_INTERVALO',current_setting('cpoe_gerar_registro_json_pck.cd_intervalo_w')::prescr_gasoterapia.cd_intervalo%type,1)  ||
							format_array_json('NR_ATENDIMENTO', nr_atendimento_p,1) ||
							format_array_json('NR_SEQ_MAT_MED', current_setting('cpoe_gerar_registro_json_pck.nr_seq_mat_cpoe_w')::cpoe_material.nr_sequencia%type,1) ||
							format_array_json('NR_SEQ_MAT_CPOE', current_setting('cpoe_gerar_registro_json_pck.nr_seq_mat_cpoe_w')::cpoe_material.nr_sequencia%type,1) ||
							format_array_json('DS_HORARIOS', current_setting('cpoe_gerar_registro_json_pck.ds_horarios_w')::prescr_gasoterapia.ds_horarios%type,1) ||
							format_array_json('IE_URGENCIA', current_setting('cpoe_gerar_registro_json_pck.ie_urgencia_w')::varchar(1),1) ||
							format_array_json('HR_PRIM_HORARIO', current_setting('cpoe_gerar_registro_json_pck.hr_prim_horario_w')::varchar(5),1) ||
							format_array_json('QT_DOSE', current_setting('cpoe_gerar_registro_json_pck.qt_dose_w')::cpoe_material.qt_dose%type,1) ||
							format_array_json('CD_UNIDADE_MEDIDA', current_setting('cpoe_gerar_registro_json_pck.cd_unidade_medida_w')::cpoe_material.cd_unidade_medida%type,1) ||
							format_array_json('DS_JUSTIFICATIVA', cpoe_gerar_registro_json_pck.remove_aspas(current_setting('cpoe_gerar_registro_json_pck.ds_justificativa_w')::cpoe_material.ds_justificativa%type),1) ||
							format_array_json('NM_USUARIO', current_setting('cpoe_gerar_registro_json_pck.nm_usuario_w')::prescr_gasoterapia.nm_usuario%type,1) ||
							format_array_json('NM_USUARIO_NREC', current_setting('cpoe_gerar_registro_json_pck.nm_usuario_nrec_w')::prescr_gasoterapia_evento.nm_usuario_nrec%type,1) ||
							format_array_json('DT_ATUALIZACAO', current_setting('cpoe_gerar_registro_json_pck.dt_atualizacao_w')::prescr_gasoterapia.dt_atualizacao%type,1) ||
							format_array_json('DT_ATUALIZACAO_NREC', current_setting('cpoe_gerar_registro_json_pck.dt_atualizacao_nrec_w')::prescr_gasoterapia_evento.dt_atualizacao_nrec%type,1) ||
							format_array_json('DT_LIBERACAO', to_char(current_setting('cpoe_gerar_registro_json_pck.dt_liberacao_w')::prescr_medica.dt_liberacao%type, 'dd/mm/yyyy hh24:mi:ss'),1) ||
							format_array_json('DT_LIBERACAO_ENFERMAGEM', to_char(current_setting('cpoe_gerar_registro_json_pck.dt_liberacao_enfermagem_w')::prescr_medica.dt_liberacao%type, 'dd/mm/yyyy hh24:mi:ss'),1) ||
							format_array_json('DT_LIBERACAO_FARMACIA', to_char(current_setting('cpoe_gerar_registro_json_pck.dt_liberacao_farmacia_w')::prescr_medica.dt_liberacao_farmacia%type, 'dd/mm/yyyy hh24:mi:ss'),1) ||
							format_array_json('NM_USUARIO_LIB_ENFERMAGEM', current_setting('cpoe_gerar_registro_json_pck.nm_usuario_lib_enfermagem_w')::varchar(255),1) ||
							format_array_json('NM_USUARIO_LIB_FARMACIA', current_setting('cpoe_gerar_registro_json_pck.nm_usuario_lib_farmacia_w')::varchar(255),1) ||
							format_array_json('IE_MOMENTO_LOTE', current_setting('cpoe_gerar_registro_json_pck.ie_momento_lote_w')::regra_disp_lote_farm.ie_momento_lote%type,1) ||
							format_array_json('DS_PRESCRITOR_DETALHE', cpoe_gerar_registro_json_pck.remove_aspas(current_setting('cpoe_gerar_registro_json_pck.ds_prescritor_w')::varchar(255)),1) ||
							format_array_json('DT_PRESCRITA_DETALHE', current_setting('cpoe_gerar_registro_json_pck.dt_prescrito_w')::varchar(255),1) ||
							format_array_json('DS_PREVIOUS_PRESCRIBER', cpoe_gerar_registro_json_pck.remove_aspas(current_setting('cpoe_gerar_registro_json_pck.ds_previous_prescriber_w')::varchar(255)),1) ||
							format_array_json('DT_PREVIOUS_PRESCRIBER', current_setting('cpoe_gerar_registro_json_pck.dt_previous_prescriber_w')::varchar(255),1) ||
							format_array_json('DS_PRESCRITOR', cpoe_gerar_registro_json_pck.remove_aspas(current_setting('cpoe_gerar_registro_json_pck.ds_prescritor_grid_w')::varchar(255)),1) ||
							format_array_json('DS_PRESCRITOR_REVAL', cpoe_gerar_registro_json_pck.remove_aspas(current_setting('cpoe_gerar_registro_json_pck.ds_prescritor_reval_w')::varchar(255)),1) ||
							format_array_json('DS_CONSELHO', cpoe_gerar_registro_json_pck.remove_aspas(current_setting('cpoe_gerar_registro_json_pck.ds_conselho_w')::varchar(255)),1) ||
							format_array_json('DT_FIM', to_char(current_setting('cpoe_gerar_registro_json_pck.dt_fim_w')::cpoe_dieta.dt_fim%type, 'dd/mm/yyyy hh24:mi:ss'),1) ||
							format_array_json('DT_INICIO', to_char(current_setting('cpoe_gerar_registro_json_pck.dt_inicio_w')::cpoe_dieta.dt_inicio%type, 'dd/mm/yyyy hh24:mi:ss'),1) ||
							format_array_json('DT_INICIO_GRID', to_char(current_setting('cpoe_gerar_registro_json_pck.dt_inicio_grid_w')::timestamp, 'dd/mm/yyyy hh24:mi:ss'),1) ||
							format_array_json('DT_SUSPENSAO', to_char(current_setting('cpoe_gerar_registro_json_pck.dt_suspensao_item_w')::prescr_gasoterapia.dt_suspensao%type, 'dd/mm/yyyy hh24:mi:ss'),1) ||
							format_array_json('DT_LIB_SUSPENSAO', to_char(dt_lip_suspensao_item_w, 'dd/mm/yyyy hh24:mi:ss'),1) ||
							format_array_json('DT_DESCONTINUACAO', to_char(current_setting('cpoe_gerar_registro_json_pck.dt_suspensao_item_w')::prescr_gasoterapia.dt_suspensao%type, 'dd/mm/yyyy hh24:mi:ss'),1) ||
							format_array_json('NM_USUARIO_SUSP', current_setting('cpoe_gerar_registro_json_pck.nm_usuario_susp_w')::cpoe_dieta.nm_usuario_susp%type,1) ||
							format_array_json('NM_USUARIO_DESCONTINUACAO', current_setting('cpoe_gerar_registro_json_pck.nm_usuario_descontinuacao_w')::varchar(255),1) ||
							format_array_json('IE_DURACAO', current_setting('cpoe_gerar_registro_json_pck.ie_duracao_w')::cpoe_dieta.ie_duracao%type,1) ||
							format_array_json('NR_SEQ_VISAO', 26138,1) ||

							format_array_json('IE_TIPO_ITEM',ie_tipo_item_w,1)				||
							format_array_json('CD_MEDICO',cd_medico_w,1)					||
							format_array_json('IE_ORDER_ON_BEHALF',ie_order_on_behalf_w,1)	||
							format_array_json('DT_CIENCIA_MEDICO',current_setting('cpoe_gerar_registro_json_pck.dt_ciencia_medico_w')::varchar(255),1)	||
							format_array_json('IE_PRESCRITOR_AUX', ie_prescritor_aux_w,1)	||
							format_array_json('DT_LIBERACAO_AUX', dt_liberacao_aux_w,1)		||
							format_array_json('IE_EXIGE_CIENCIA',ie_exige_ciencia_w,1)		||
							format_array_json('IE_DEPART_LIB_SETOR',ie_depart_lib_setor_w,1)||
							format_array_json('CD_DEPARTAMENTO',cd_departamento_w,1)		||

							format_array_json('DS_HORA_00',current_setting('cpoe_gerar_registro_json_pck.ds_hora_00_w')::varchar(50),1)	||
							format_array_json('DS_HORA_01',current_setting('cpoe_gerar_registro_json_pck.ds_hora_01_w')::varchar(50),1)  ||
							format_array_json('DS_HORA_02',current_setting('cpoe_gerar_registro_json_pck.ds_hora_02_w')::varchar(50),1)  ||
							format_array_json('DS_HORA_03',current_setting('cpoe_gerar_registro_json_pck.ds_hora_03_w')::varchar(50),1)  ||
							format_array_json('DS_HORA_04',current_setting('cpoe_gerar_registro_json_pck.ds_hora_04_w')::varchar(50),1)  ||
							format_array_json('DS_HORA_05',current_setting('cpoe_gerar_registro_json_pck.ds_hora_05_w')::varchar(50),1)  ||
							format_array_json('DS_HORA_06',current_setting('cpoe_gerar_registro_json_pck.ds_hora_06_w')::varchar(50),1)  ||
							format_array_json('DS_HORA_07',current_setting('cpoe_gerar_registro_json_pck.ds_hora_07_w')::varchar(50),1)  ||
							format_array_json('DS_HORA_08',current_setting('cpoe_gerar_registro_json_pck.ds_hora_08_w')::varchar(50),1)  ||
							format_array_json('DS_HORA_09',current_setting('cpoe_gerar_registro_json_pck.ds_hora_09_w')::varchar(50),1)  ||
							format_array_json('DS_HORA_10',current_setting('cpoe_gerar_registro_json_pck.ds_hora_10_w')::varchar(50),1)  ||
							format_array_json('DS_HORA_11',current_setting('cpoe_gerar_registro_json_pck.ds_hora_11_w')::varchar(50),1)  ||
							format_array_json('DS_HORA_12',current_setting('cpoe_gerar_registro_json_pck.ds_hora_12_w')::varchar(50),1)  ||
							format_array_json('DS_HORA_13',current_setting('cpoe_gerar_registro_json_pck.ds_hora_13_w')::varchar(50),1)  ||
							format_array_json('DS_HORA_14',current_setting('cpoe_gerar_registro_json_pck.ds_hora_14_w')::varchar(50),1)  ||
							format_array_json('DS_HORA_15',current_setting('cpoe_gerar_registro_json_pck.ds_hora_15_w')::varchar(50),1)  ||
							format_array_json('DS_HORA_16',current_setting('cpoe_gerar_registro_json_pck.ds_hora_16_w')::varchar(50),1)  ||
							format_array_json('DS_HORA_17',current_setting('cpoe_gerar_registro_json_pck.ds_hora_17_w')::varchar(50),1)  ||
							format_array_json('DS_HORA_18',current_setting('cpoe_gerar_registro_json_pck.ds_hora_18_w')::varchar(50),1)  ||
							format_array_json('DS_HORA_19',current_setting('cpoe_gerar_registro_json_pck.ds_hora_19_w')::varchar(50),1)  ||
							format_array_json('DS_HORA_20',current_setting('cpoe_gerar_registro_json_pck.ds_hora_20_w')::varchar(50),1)  ||
							format_array_json('DS_HORA_21',current_setting('cpoe_gerar_registro_json_pck.ds_hora_21_w')::varchar(50),1)  ||
							format_array_json('DS_HORA_22',current_setting('cpoe_gerar_registro_json_pck.ds_hora_22_w')::varchar(50),1)  ||
							format_array_json('DS_HORA_23',current_setting('cpoe_gerar_registro_json_pck.ds_hora_23_w')::varchar(50),1)  ||
							format_array_json('IE_MATERIAL',ie_material_w,1)||
							format_array_json('NR_SEQ_ASSINATURA',current_setting('cpoe_gerar_registro_json_pck.nr_seq_assinatura_w')::cpoe_gasoterapia.nr_seq_assinatura%type,1)	||
							format_array_json('DT_ASSINATURA_DIGITAL',to_char(current_setting('cpoe_gerar_registro_json_pck.dt_assinatura_digital_w')::tasy_assinatura_digital.dt_assinatura%type,'dd/mm/yyyy hh24:mi:ss'),1) ||
							format_array_json('NR_SEQ_CPOE_ORDER_UNIT',current_setting('cpoe_gerar_registro_json_pck.nr_seq_cpoe_order_unit_w')::cpoe_order_unit.nr_sequencia%type,1), false);

			PERFORM set_config('cpoe_gerar_registro_json_pck.ds_json_mat_w', substr(current_setting('cpoe_gerar_registro_json_pck.ds_json_mat_w')::text,1,length(current_setting('cpoe_gerar_registro_json_pck.ds_json_mat_w')::text)-2) || '},', false);

		end loop;
		close current_setting('cpoe_gerar_registro_json_pck.c01')::CURSOR;

		if (current_setting('cpoe_gerar_registro_json_pck.ds_json_mat_w')::(text IS NOT NULL AND text::text <> '')) then
			begin
			PERFORM set_config('cpoe_gerar_registro_json_pck.ds_registro_w', format_json('DS_DRUG', current_setting('cpoe_gerar_registro_json_pck.ds_json_mat_w')::text), false);


			CALL cpoe_gerar_registro_json_pck.cpoe_salvar_json( 			nr_atendimento_p,
										dt_referencia_p,
										nm_usuario_p,
										'MA',
										current_setting('cpoe_gerar_registro_json_pck.ds_registro_w')::text);						


			end;
		end if;

	commit;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_gerar_registro_json_pck.cpoe_gerar_registro_mat_json ( nr_atendimento_p bigint, dt_referencia_p timestamp, nm_usuario_p text, nr_prescricao_p bigint default null) FROM PUBLIC;
