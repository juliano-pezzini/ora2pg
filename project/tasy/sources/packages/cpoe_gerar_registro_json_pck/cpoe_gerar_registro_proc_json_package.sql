-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE cpoe_gerar_registro_json_pck.cpoe_gerar_registro_proc_json (nr_atendimento_p bigint, dt_referencia_p timestamp, nm_usuario_p text, nr_prescricao_p bigint default null) AS $body$
DECLARE


current_setting('cpoe_gerar_registro_json_pck.ds_registro_w')::text					text;
ds_json_proc_w					text;
current_setting('cpoe_gerar_registro_json_pck.ds_json_materiais_w')::text				text;
ds_node_horarios_w				text;
ds_procedimento_ww				varchar(1000);
ds_procedimento_w				varchar(1000);
current_setting('cpoe_gerar_registro_json_pck.ds_intervalo_w')::varchar(255)					varchar(255);
current_setting('cpoe_gerar_registro_json_pck.dt_horario_w')::prescr_mat_hor.dt_horario%type					varchar(20);
current_setting('cpoe_gerar_registro_json_pck.dt_fim_horario_w')::varchar(20)				varchar(20);
current_setting('cpoe_gerar_registro_json_pck.dt_suspensao_w')::varchar(20)					varchar(20);
current_setting('cpoe_gerar_registro_json_pck.ds_hora_w')::varchar(255)						varchar(255);
current_setting('cpoe_gerar_registro_json_pck.nr_hora_w')::integer						bigint;
current_setting('cpoe_gerar_registro_json_pck.seq_w')::integer							integer;
count_cpoe_procedimento_w 		bigint;
current_setting('cpoe_gerar_registro_json_pck.ds_prescritor_w')::varchar(255)					varchar(255);
current_setting('cpoe_gerar_registro_json_pck.ds_prescritor_reval_w')::varchar(255)			varchar(255);
current_setting('cpoe_gerar_registro_json_pck.dt_prescrito_w')::varchar(255)					varchar(255);
current_setting('cpoe_gerar_registro_json_pck.ds_previous_prescriber_w')::varchar(255)		varchar(255);
current_setting('cpoe_gerar_registro_json_pck.dt_previous_prescriber_w')::varchar(255)		varchar(255);
current_setting('cpoe_gerar_registro_json_pck.ds_conselho_w')::varchar(255)					varchar(255);
current_setting('cpoe_gerar_registro_json_pck.ds_prescritor_grid_w')::varchar(255)			varchar(255);	
current_setting('cpoe_gerar_registro_json_pck.nm_usuario_descontinuacao_w')::varchar(255)		varchar(255);	
current_setting('cpoe_gerar_registro_json_pck.dt_inicio_grid_w')::timestamp				timestamp;

current_setting('cpoe_gerar_registro_json_pck.nr_prescricao_w')::prescr_material.nr_prescricao%type					prescr_medica.nr_prescricao%type;
current_setting('cpoe_gerar_registro_json_pck.dt_liberacao_enfermagem_w')::prescr_medica.dt_liberacao%type		prescr_medica.dt_liberacao%type;
current_setting('cpoe_gerar_registro_json_pck.dt_liberacao_farmacia_w')::prescr_medica.dt_liberacao_farmacia%type			prescr_medica.dt_liberacao_farmacia%type;		
current_setting('cpoe_gerar_registro_json_pck.nm_usuario_lib_enfermagem_w')::varchar(255)		varchar(255);
current_setting('cpoe_gerar_registro_json_pck.nm_usuario_lib_farmacia_w')::varchar(255)		varchar(255);
ds_special_approval_w			varchar(255);				
dt_special_approval_w			varchar(255);
current_setting('cpoe_gerar_registro_json_pck.ds_ciencia_detalhe_w')::varchar(255)			varchar(255);
current_setting('cpoe_gerar_registro_json_pck.dt_ciencia_detalhe_w')::varchar(255)			varchar(255);
ds_dias_semana_w				varchar(2000);

nr_seq_mat_w					prescr_material.nr_sequencia%type;
current_setting('cpoe_gerar_registro_json_pck.cd_mat_dil_w')::prescr_material.cd_material%type					prescr_material.cd_material%type;
current_setting('cpoe_gerar_registro_json_pck.qt_dose_dil_w')::prescr_material.qt_dose%type					prescr_material.qt_dose%type;
current_setting('cpoe_gerar_registro_json_pck.cd_unid_med_dose_dil_w')::cpoe_material.cd_unid_med_dose_dil%type			prescr_material.cd_unidade_medida_dose%type;

current_setting('cpoe_gerar_registro_json_pck.nm_usuario_susp_w')::cpoe_dieta.nm_usuario_susp%type				cpoe_procedimento.nm_usuario_susp%type;

nr_seq_proc_cpoe_w				cpoe_procedimento.nr_sequencia%type;
cd_mat_proc_w					cpoe_procedimento.cd_mat_proc1%type;
ie_via_mat_proc_w				cpoe_procedimento.ie_via_mat_proc1%type;
current_setting('cpoe_gerar_registro_json_pck.qt_dose_mat_w')::cpoe_gasoterapia.qt_dose_mat1%type					cpoe_procedimento.qt_dose_mat1%type;
cd_unid_medida_dose_mat_w		cpoe_procedimento.cd_unid_medida_dose_mat1%type;
cd_interv_proc_w				cpoe_procedimento.cd_interv_proc1%type;
dt_inicio_proc_w				cpoe_procedimento.dt_inicio_proc1%type;
hr_prim_hor_proc_w				cpoe_procedimento.hr_prim_hor_proc1%type;
ds_hor_proc_w					cpoe_procedimento.ds_hor_proc1%type;
ie_dur_proc_w					cpoe_procedimento.ie_dur_proc1%type;
dt_fim_proc_w					cpoe_procedimento.dt_fim_proc1%type;
ds_obser_proc_w					cpoe_procedimento.ds_obser_proc1%type;
current_setting('cpoe_gerar_registro_json_pck.dt_fim_w')::cpoe_dieta.dt_fim%type						cpoe_procedimento.dt_fim%type;
current_setting('cpoe_gerar_registro_json_pck.ie_duracao_w')::cpoe_dieta.ie_duracao%type					cpoe_procedimento.ie_duracao%type;
current_setting('cpoe_gerar_registro_json_pck.ie_administracao_w')::cpoe_dieta.ie_administracao%type				cpoe_procedimento.ie_administracao%type;
current_setting('cpoe_gerar_registro_json_pck.ie_evento_unico_w')::cpoe_dieta.ie_evento_unico%type				cpoe_procedimento.ie_evento_unico%type;
current_setting('cpoe_gerar_registro_json_pck.dt_horario_ww')::prescr_gasoterapia_hor.dt_horario%type					prescr_proc_hor.dt_horario%type;
current_setting('cpoe_gerar_registro_json_pck.dt_horario_fim_w')::cpoe_dieta.dt_fim%type				prescr_proc_hor.dt_horario%type;

current_setting('cpoe_gerar_registro_json_pck.ie_momento_lote_w')::regra_disp_lote_farm.ie_momento_lote%type				regra_disp_lote_farm.ie_momento_lote%type;
current_setting('cpoe_gerar_registro_json_pck.cd_estabelecimento_w')::estabelecimento.cd_estabelecimento%type			estabelecimento.cd_estabelecimento%type;

ie_segunda_w					cpoe_procedimento.ie_segunda%type;
ie_terca_w						cpoe_procedimento.ie_terca%type;
ie_quarta_w						cpoe_procedimento.ie_quarta%type;
ie_quinta_w						cpoe_procedimento.ie_quinta%type;
ie_sexta_w						cpoe_procedimento.ie_sexta%type;
ie_sabado_w						cpoe_procedimento.ie_sabado%type;
ie_domingo_w					cpoe_procedimento.ie_domingo%type;

current_setting('cpoe_gerar_registro_json_pck.dt_assinatura_digital_w')::tasy_assinatura_digital.dt_assinatura%type			tasy_assinatura_digital.dt_assinatura%type;
current_setting('cpoe_gerar_registro_json_pck.nr_seq_cpoe_order_unit_w')::cpoe_order_unit.nr_sequencia%type        cpoe_order_unit.nr_sequencia%type;

current_setting('cpoe_gerar_registro_json_pck.c01')::CURSOR CURSOR FOR  -- Procedimentos
	SELECT	distinct a.nr_seq_proc_interno nr_seq_proc_interno_w,
			a.nr_sequencia nr_seq_proc_cpoe_w,
			a.qt_procedimento qt_procedimento_w,
			a.nr_seq_topografia nr_seq_topografia_w,
			a.ie_lado ie_lado_w,
			a.cd_material_exame cd_material_exame_w,
			a.ds_material_especial ds_material_especial_w,
			a.nr_seq_prot_glic nr_seq_prot_glic_w,
			a.ds_justificativa current_setting('cpoe_gerar_registro_json_pck.ds_justificativa_w')::cpoe_material.ds_justificativa%type,
			a.cd_intervalo current_setting('cpoe_gerar_registro_json_pck.cd_intervalo_w')::prescr_gasoterapia.cd_intervalo%type,
			a.ie_se_necessario current_setting('cpoe_gerar_registro_json_pck.ie_se_necessario_w')::varchar(1),
			a.ie_acm current_setting('cpoe_gerar_registro_json_pck.ie_acm_w')::varchar(1),
			a.ie_urgencia current_setting('cpoe_gerar_registro_json_pck.ie_urgencia_w')::varchar(1),
			a.dt_inicio current_setting('cpoe_gerar_registro_json_pck.dt_inicio_w')::cpoe_dieta.dt_inicio%type,
			a.hr_prim_horario current_setting('cpoe_gerar_registro_json_pck.hr_prim_horario_w')::varchar(5),
			a.ds_horarios current_setting('cpoe_gerar_registro_json_pck.ds_horarios_w')::prescr_gasoterapia.ds_horarios%type,
			a.ds_observacao current_setting('cpoe_gerar_registro_json_pck.ds_observacao_w')::prescr_gasoterapia.ds_observacao%type,
			a.dt_liberacao current_setting('cpoe_gerar_registro_json_pck.dt_liberacao_w')::prescr_medica.dt_liberacao%type,
			a.ie_motivo_prescricao current_setting('cpoe_gerar_registro_json_pck.ie_motivo_prescricao_w')::cpoe_gasoterapia.ie_motivo_prescricao%type,
			a.cd_setor_atendimento current_setting('cpoe_gerar_registro_json_pck.cd_setor_atendimento_w')::cpoe_gasoterapia.cd_setor_atendimento%type, 
			a.cd_setor_liberacao cd_setor_liberacao_w,
			a.ie_oncologia current_setting('cpoe_gerar_registro_json_pck.ie_oncologia_w')::cpoe_material.ie_oncologia%type,
			a.dt_suspensao current_setting('cpoe_gerar_registro_json_pck.dt_suspensao_item_w')::prescr_gasoterapia.dt_suspensao%type,
			a.dt_lib_suspensao current_setting('cpoe_gerar_registro_json_pck.dt_lib_suspensao_item_w')::cpoe_gasoterapia.dt_lib_suspensao%type,
			a.nm_usuario current_setting('cpoe_gerar_registro_json_pck.nm_usuario_w')::prescr_gasoterapia.nm_usuario%type,
			a.nm_usuario_nrec current_setting('cpoe_gerar_registro_json_pck.nm_usuario_nrec_w')::prescr_gasoterapia_evento.nm_usuario_nrec%type,
			a.dt_atualizacao current_setting('cpoe_gerar_registro_json_pck.dt_atualizacao_w')::prescr_gasoterapia.dt_atualizacao%type,
			a.dt_atualizacao_nrec current_setting('cpoe_gerar_registro_json_pck.dt_atualizacao_nrec_w')::prescr_gasoterapia_evento.dt_atualizacao_nrec%type,
			a.nr_seq_condicao nr_seq_condicao_w,
			a.ds_dado_clinico ds_dado_clinico_w,
			a.nr_ocorrencia current_setting('cpoe_gerar_registro_json_pck.nr_ocorrencia_w')::cpoe_gasoterapia.nr_ocorrencia%type,
			a.ie_prescritor_aux ie_prescritor_aux_w,
			obter_se_depart_lib_setor(obter_departamento_setor(a.cd_departamento)) ie_depart_lib_setor_w,
			cpoe_obter_tipo_item('CPOE_PROCEDIMENTO',a.nr_sequencia) ie_tipo_item_w,
			a.cd_medico cd_medico_w,
			get_ordered_on_behalf(a.nr_sequencia,'P') ie_order_on_behalf_w,
			a.dt_ciencia_medico current_setting('cpoe_gerar_registro_json_pck.dt_ciencia_medico_w')::varchar(255),
			a.ie_exige_ciencia ie_exige_ciencia_w,
			a.dt_liberacao_aux dt_liberacao_aux_w,
			a.cd_departamento cd_departamento_w,
			a.cd_setor_entrega cd_setor_entrega_w,
			a.cd_medico_exec cd_medico_exec_w,
			a.ie_segunda ie_segunda_w,
			a.ie_terca ie_terca_w,
			a.ie_quarta ie_quarta_w,
			a.ie_quinta ie_quinta_w,
			a.ie_sexta ie_sexta_w,
			a.ie_sabado ie_sabado_w,
			a.ie_domingo ie_domingo_w,
			a.nr_seq_assinatura current_setting('cpoe_gerar_registro_json_pck.nr_seq_assinatura_w')::cpoe_gasoterapia.nr_seq_assinatura%type,
			a.nr_seq_cpoe_order_unit current_setting('cpoe_gerar_registro_json_pck.nr_seq_cpoe_order_unit_w')::cpoe_order_unit.nr_sequencia%type
	from	cpoe_procedimento a,
		prescr_procedimento b,
		prescr_proc_hor c,
		prescr_medica d
	where	a.nr_atendimento	= nr_atendimento_p
	and	a.dt_prox_geracao > current_setting('cpoe_gerar_registro_json_pck.dt_hora_formatada_w')::timestamp - 1
	and	(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
	and	a.nr_sequencia = b.nr_seq_proc_cpoe
	and	b.nr_prescricao = d.nr_prescricao
	and	b.nr_prescricao = c.nr_prescricao
	and	b.nr_sequencia = c.nr_seq_procedimento
	and	coalesce(b.nr_seq_origem::text, '') = ''
	and	(b.nr_seq_proc_interno IS NOT NULL AND b.nr_seq_proc_interno::text <> '')
	and	coalesce(b.nr_seq_solic_sangue::text, '') = ''
	and ((coalesce(nr_prescricao_p,0) = 0)  or (b.nr_prescricao = nr_prescricao_p))
	and	(((cpoe_reg_valido_ativacao(CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) END  ,a.dt_inicio, current_setting('cpoe_gerar_registro_json_pck.dt_hora_formatada_w')::timestamp, NULL, a.cd_perfil_ativo, a.ie_retrogrado, a.dt_liberacao, 'N', a.ie_futuro, a.dt_liberacao_fut) = 'S') and (current_setting('cpoe_gerar_registro_json_pck.dt_hora_formatada_w')::timestamp > b.dt_inicio)) or
		((((Obter_se_acm_sn_agora_especial(b.ie_acm, b.ie_se_necessario, 'N', 'N') = 'N') and (c.dt_horario between current_setting('cpoe_gerar_registro_json_pck.dt_hora_formatada_w')::timestamp	and	current_setting('cpoe_gerar_registro_json_pck.dt_hora_fim_formatada_w')::timestamp or b.nr_prescricao = nr_prescricao_p)) or
		((Obter_se_acm_sn_agora_especial(b.ie_acm, b.ie_se_necessario, 'N', 'N') = 'S') and (obter_se_prescr_vig_adep(d.dt_prescricao, d.dt_validade_prescr, current_setting('cpoe_gerar_registro_json_pck.dt_hora_formatada_w')::timestamp, current_setting('cpoe_gerar_registro_json_pck.dt_hora_fim_formatada_w')::timestamp) = 'S')))))
	order by	a.nr_sequencia;			

current_setting('cpoe_gerar_registro_json_pck.c02')::CURSOR CURSOR FOR
	SELECT	coalesce(to_char(a.dt_horario,'dd/mm/yyyy hh24:mi'),'null'),
			coalesce(to_char(a.dt_fim_horario,'dd/mm/yyyy hh24:mi'),'null'),
			coalesce(to_char(a.dt_suspensao,'dd/mm/yyyy hh24:mi'),'null'),
			a.dt_horario
	from	prescr_proc_hor a,
			prescr_procedimento b
	where	a.nr_prescricao = b.nr_prescricao
	and		a.nr_seq_procedimento = b.nr_sequencia
	and		b.nr_seq_proc_cpoe = nr_seq_proc_cpoe_w
	and		a.dt_horario between current_setting('cpoe_gerar_registro_json_pck.dt_hora_formatada_w')::timestamp	and	current_setting('cpoe_gerar_registro_json_pck.dt_hora_fim_formatada_w')::timestamp
	order by	a.dt_horario;

current_setting('cpoe_gerar_registro_json_pck.c03')::CURSOR CURSOR FOR
	SELECT	distinct m.cd_material,
			m.ie_via_aplicacao,
			m.qt_dose,
			m.cd_unidade_medida_dose,
			m.cd_intervalo,
			m.hr_prim_horario,
			m.ds_horarios,
			m.ds_observacao,
			m.nr_prescricao,
			m.nr_sequencia
	from	prescr_material m,
			prescr_procedimento n,
			prescr_proc_hor o
	where	m.nr_prescricao = n.nr_prescricao
	and 	m.nr_sequencia_proc = n.nr_sequencia
	and		n.nr_seq_proc_cpoe = nr_seq_proc_cpoe_w
	and		o.nr_seq_procedimento = n.nr_sequencia
	and		o.nr_prescricao = n.nr_prescricao
	and		o.dt_horario between current_setting('cpoe_gerar_registro_json_pck.dt_hora_formatada_w')::timestamp	and	current_setting('cpoe_gerar_registro_json_pck.dt_hora_fim_formatada_w')::timestamp
	and		m.ie_agrupador = 5
	and obter_tipo_material(m.cd_material, 'C') in ('0','2','3','6','9');

BEGIN

for c01_proc_w in current_setting('cpoe_gerar_registro_json_pck.c01')::loop CURSOR

	nr_seq_proc_cpoe_w := c01_proc_w.nr_seq_proc_cpoe_w;
	ds_procedimento_w := substr(obter_desc_proc_interno(c01_proc_w.nr_seq_proc_interno_w),1,255);
	ds_procedimento_ww := ds_procedimento_w;

	c01_proc_w.dt_suspensao_item_w := cpoe_gerar_registro_json_pck.regra_data_susp(c01_proc_w.dt_suspensao_item_w);
	c01_proc_w.dt_lib_suspensao_item_w := cpoe_gerar_registro_json_pck.regra_data_susp(c01_proc_w.dt_lib_suspensao_item_w);

	PERFORM set_config('cpoe_gerar_registro_json_pck.cd_estabelecimento_w', obter_estabelecimento_setor(c01_proc_w.cd_setor_atendimento_w), false);
	PERFORM set_config('cpoe_gerar_registro_json_pck.ie_momento_lote_w', cpoe_obter_momento_lote(c01_proc_w.ie_motivo_prescricao_w, coalesce(c01_proc_w.cd_setor_liberacao_w, c01_proc_w.cd_setor_atendimento_w), current_setting('cpoe_gerar_registro_json_pck.cd_estabelecimento_w')::estabelecimento.cd_estabelecimento%type, c01_proc_w.ie_oncologia_w, 'CPOE_PROCEDIMENTO', nr_seq_proc_cpoe_w, null, null, null), false);

	CALL cpoe_gerar_registro_json_pck.cpoe_limpar_valores_horas();

	ie_segunda_w := c01_proc_w.ie_segunda_w;
	ie_terca_w := c01_proc_w.ie_terca_w;
	ie_quarta_w := c01_proc_w.ie_quarta_w;
	ie_quinta_w := c01_proc_w.ie_quinta_w;
	ie_sexta_w := c01_proc_w.ie_sexta_w;
	ie_sabado_w := c01_proc_w.ie_sabado_w;
	ie_domingo_w := c01_proc_w.ie_domingo_w;

	select count(*)
	into STRICT   count_cpoe_procedimento_w
	from   cpoe_procedimento
	where  nr_sequencia = c01_proc_w.nr_seq_proc_cpoe_w;

	PERFORM set_config('cpoe_gerar_registro_json_pck.dt_fim_w', '', false);
	PERFORM set_config('cpoe_gerar_registro_json_pck.ie_duracao_w', '', false);
	PERFORM set_config('cpoe_gerar_registro_json_pck.ie_administracao_w', 'P', false);
	PERFORM set_config('cpoe_gerar_registro_json_pck.ds_json_materiais_w', '', false);

	if (c01_proc_w.ie_se_necessario_w = 'S') then
		PERFORM set_config('cpoe_gerar_registro_json_pck.ie_administracao_w', 'N', false);
	elsif (c01_proc_w.ie_acm_w = 'S') then
		PERFORM set_config('cpoe_gerar_registro_json_pck.ie_administracao_w', 'C', false);
	end if;

	if (count_cpoe_procedimento_w > 0) then
		begin
		select	dt_fim,
				ie_duracao,
				ie_administracao,
				ie_evento_unico,
				dt_liberacao,
				replace(cpoe_obter_desc_grid_proc(substr(cpoe_obter_desc_proc_interno(nr_seq_proc_interno),1,255),cd_intervalo,qt_procedimento,cd_mat_proc1,qt_dose_mat1,cd_unid_medida_dose_mat1,ie_assoc_adep1,cd_mat_proc2,qt_dose_mat2,
				cd_unid_medida_dose_mat2,ie_assoc_adep2,cd_mat_proc3,qt_dose_mat3,cd_unid_medida_dose_mat3,ie_assoc_adep3,cd_mat_proc4,qt_dose_mat4,cd_unid_medida_dose_mat4,ie_assoc_adep4,cd_mat_proc5,qt_dose_mat5,cd_unid_medida_dose_mat5,
				ie_assoc_adep5,cpoe_gerar_registro_json_pck.regra_data_susp(dt_lib_suspensao),cpoe_gerar_registro_json_pck.regra_data_susp(dt_suspensao),ie_administracao, null, null,cd_mat_proc6, qt_dose_mat6, cd_unid_medida_dose_mat6,
				ie_assoc_adep6, cd_mat_proc7, qt_dose_mat7, cd_unid_medida_dose_mat7, ie_assoc_adep7, null, null,  null, null,  null, null,  null, null,  null,
				null,  null, null,  null, null,  null, null,  null, null,  null, null,  null, null,  null, null,  null,  null, null,  null, null,  null, null,  null, null,  null, null,  null,  null, null,  null, null,  null, null,
				null,null,'S', 'N',  null, obter_horarios_regra(ds_horarios)),'"','@#'),
				substr(coalesce(obter_desc_intervalo_prescr(cd_intervalo), obter_desc_intervalo(cd_intervalo)),1,80) ds_intervalo,
				obter_nome_medico(obter_pf_usuario(nm_usuario_nrec,'C'),'PMS') ds_prescritor,
				cpoe_obter_tempo_prescrito(coalesce(dt_atualizacao_nrec, dt_inicio)) dt_prescrito,
				cpoe_get_prior_prescriber(nr_seq_cpoe_anterior, 'CPOE_PROCEDIMENTO', 'N'),
				cpoe_get_prior_prescriber(nr_seq_cpoe_anterior, 'CPOE_PROCEDIMENTO', 'D'),
				cpoe_get_approval_time(dt_special_approval),
				obter_nome_medico(obter_pf_usuario(nm_usuario_approval, 'C'),'PMS'),
				obter_nome_medico(obter_pf_usuario(nm_usuario_ciencia,'C'),'PMS'),
				cpoe_get_approval_time(dt_ciencia_medico),
				cpoe_obter_data_hora_form(dt_inicio,hr_prim_horario) dt_inicio_grid,
				substr(obter_dados_pf(obter_pf_usuario(nm_usuario_nrec,'C'),'COPR'),1,255) ds_conselho,
				obter_nome_pf(obter_pf_usuario(nm_usuario_nrec,'C')) ds_prescritor_grid,
				dt_liberacao_enf dt_liberacao_enfermagem,
				dt_liberacao_farm dt_liberacao_farmacia,
				nm_usuario_lib_enf nm_usuario_lib_enfermagem,
				nm_usuario_lib_farm nm_usuario_lib_farmacia,
				CASE WHEN coalesce(cpoe_gerar_registro_json_pck.regra_data_susp(dt_suspensao)::text, '') = '' THEN  null  ELSE nm_usuario_susp END ,
				CASE WHEN coalesce(cpoe_gerar_registro_json_pck.regra_data_susp(dt_suspensao)::text, '') = '' THEN  null  ELSE cpoe_obter_info_suspensao(nr_sequencia,'P','N') END  nm_usuario_descontinuacao,
				cpoe_gerar_registro_json_pck.remove_aspas(cpoe_obter_dias_semana(nr_sequencia, 'P')),
				obter_data_assinatura_digital(nr_seq_assinatura),
				obter_pf_usuario(coalesce(nm_usuario, nm_usuario_nrec),'N') ds_prescritor_reval
		into STRICT	current_setting('cpoe_gerar_registro_json_pck.dt_fim_w')::cpoe_dieta.dt_fim%type,
				current_setting('cpoe_gerar_registro_json_pck.ie_duracao_w')::cpoe_dieta.ie_duracao%type,
				current_setting('cpoe_gerar_registro_json_pck.ie_administracao_w')::cpoe_dieta.ie_administracao%type,
				current_setting('cpoe_gerar_registro_json_pck.ie_evento_unico_w')::cpoe_dieta.ie_evento_unico%type,
				c01_proc_w.dt_liberacao_w,
				ds_procedimento_w,
				current_setting('cpoe_gerar_registro_json_pck.ds_intervalo_w')::varchar(255),
				current_setting('cpoe_gerar_registro_json_pck.ds_prescritor_w')::varchar(255),
				current_setting('cpoe_gerar_registro_json_pck.dt_prescrito_w')::varchar(255),
				current_setting('cpoe_gerar_registro_json_pck.ds_previous_prescriber_w')::varchar(255),
				current_setting('cpoe_gerar_registro_json_pck.dt_previous_prescriber_w')::varchar(255),
				ds_special_approval_w,
				dt_special_approval_w,
				current_setting('cpoe_gerar_registro_json_pck.ds_ciencia_detalhe_w')::varchar(255),
				current_setting('cpoe_gerar_registro_json_pck.dt_ciencia_detalhe_w')::varchar(255),
				current_setting('cpoe_gerar_registro_json_pck.dt_inicio_grid_w')::timestamp,
				current_setting('cpoe_gerar_registro_json_pck.ds_conselho_w')::varchar(255),
				current_setting('cpoe_gerar_registro_json_pck.ds_prescritor_grid_w')::varchar(255),
				current_setting('cpoe_gerar_registro_json_pck.dt_liberacao_enfermagem_w')::prescr_medica.dt_liberacao%type,
				current_setting('cpoe_gerar_registro_json_pck.dt_liberacao_farmacia_w')::prescr_medica.dt_liberacao_farmacia%type,
				current_setting('cpoe_gerar_registro_json_pck.nm_usuario_lib_enfermagem_w')::varchar(255),					
				current_setting('cpoe_gerar_registro_json_pck.nm_usuario_lib_farmacia_w')::varchar(255),
				current_setting('cpoe_gerar_registro_json_pck.nm_usuario_susp_w')::cpoe_dieta.nm_usuario_susp%type,
				current_setting('cpoe_gerar_registro_json_pck.nm_usuario_descontinuacao_w')::varchar(255),
				ds_dias_semana_w,
				current_setting('cpoe_gerar_registro_json_pck.dt_assinatura_digital_w')::tasy_assinatura_digital.dt_assinatura%type,
				current_setting('cpoe_gerar_registro_json_pck.ds_prescritor_reval_w')::varchar(255)
		from	cpoe_procedimento
		where	nr_sequencia = c01_proc_w.nr_seq_proc_cpoe_w;

		select	max(dt_fim_horario)
		into STRICT	current_setting('cpoe_gerar_registro_json_pck.dt_horario_fim_w')::cpoe_dieta.dt_fim%type
		from (SELECT	max(dt_horario) dt_fim_horario
				from	prescr_medica a,
						prescr_proc_hor b,
						prescr_procedimento c,
						cpoe_procedimento d
				where	a.nr_atendimento	= nr_atendimento_p
				and		a.nr_prescricao		= b.nr_prescricao
				and		a.nr_prescricao 	= c.nr_prescricao
				and		b.nr_seq_procedimento	= c.nr_sequencia
				and		(coalesce(a.dt_liberacao_medico, a.dt_liberacao) IS NOT NULL AND (coalesce(a.dt_liberacao_medico, a.dt_liberacao))::text <> '')
				and		b.dt_horario between current_setting('cpoe_gerar_registro_json_pck.dt_hora_formatada_w')::timestamp	and	current_setting('cpoe_gerar_registro_json_pck.dt_hora_fim_formatada_w')::timestamp
				and 	c.nr_seq_proc_cpoe 	= d.nr_sequencia
				and		d.dt_fim			< b.dt_horario
				and		(d.dt_fim IS NOT NULL AND d.dt_fim::text <> '')
				and		d.nr_sequencia 		= c01_proc_w.nr_seq_proc_cpoe_w
				
union	all

				PERFORM	max(dt_fim) dt_fim_horario
				from	cpoe_procedimento
				where	nr_atendimento	= nr_atendimento_p
				and		nr_sequencia	= c01_proc_w.nr_seq_proc_cpoe_w
				and		(dt_fim IS NOT NULL AND dt_fim::text <> '')) alias12;
		end;
	end if;

	open current_setting('cpoe_gerar_registro_json_pck.c02')::CURSOR;
		loop
		fetch current_setting('cpoe_gerar_registro_json_pck.c02')::into CURSOR
			current_setting('cpoe_gerar_registro_json_pck.dt_horario_w')::prescr_mat_hor.dt_horario%type,
			current_setting('cpoe_gerar_registro_json_pck.dt_fim_horario_w')::varchar(20),
			current_setting('cpoe_gerar_registro_json_pck.dt_suspensao_w')::varchar(20),
			current_setting('cpoe_gerar_registro_json_pck.dt_horario_ww')::prescr_gasoterapia_hor.dt_horario%type;
		EXIT WHEN NOT FOUND; /* apply on current_setting('cpoe_gerar_registro_json_pck.c02')::CURSOR */

			PERFORM set_config('cpoe_gerar_registro_json_pck.nr_hora_w', to_char(current_setting('cpoe_gerar_registro_json_pck.dt_horario_ww')::prescr_gasoterapia_hor.dt_horario%type,'hh24'), false);
			PERFORM set_config('cpoe_gerar_registro_json_pck.ds_hora_w', 'P', false);

			if (current_setting('cpoe_gerar_registro_json_pck.dt_fim_horario_w')::varchar(20) <> 'null') then
				PERFORM set_config('cpoe_gerar_registro_json_pck.ds_hora_w', 'S', false);
			end if;	

			if (current_setting('cpoe_gerar_registro_json_pck.dt_suspensao_w')::varchar(20)	<> 'null')  then
				PERFORM set_config('cpoe_gerar_registro_json_pck.ds_hora_w', 'N', false);
			end if;

			CALL cpoe_gerar_registro_json_pck.cpoe_seta_status_horario(current_setting('cpoe_gerar_registro_json_pck.nr_hora_w')::integer, current_setting('cpoe_gerar_registro_json_pck.ds_hora_w')::varchar(255));

			if (current_setting('cpoe_gerar_registro_json_pck.dt_horario_fim_w')::cpoe_dieta.dt_fim%(type IS NOT NULL AND type::text <> '') and (current_setting('cpoe_gerar_registro_json_pck.dt_horario_fim_w')::cpoe_dieta.dt_fim%type between current_setting('cpoe_gerar_registro_json_pck.dt_hora_formatada_w')::timestamp	and	current_setting('cpoe_gerar_registro_json_pck.dt_hora_fim_formatada_w')::timestamp)) then
				begin
				CALL cpoe_gerar_registro_json_pck.cpoe_seta_status_fim_validade(current_setting('cpoe_gerar_registro_json_pck.dt_horario_fim_w')::cpoe_dieta.dt_fim%type);
				end;
			end if;

		end loop;
	close current_setting('cpoe_gerar_registro_json_pck.c02')::CURSOR;

	if (current_setting('cpoe_gerar_registro_json_pck.dt_inicio_grid_w')::(timestamp IS NOT NULL AND timestamp::text <> '') and (current_setting('cpoe_gerar_registro_json_pck.dt_inicio_grid_w')::timestamp between current_setting('cpoe_gerar_registro_json_pck.dt_hora_formatada_w')::timestamp	and	current_setting('cpoe_gerar_registro_json_pck.dt_hora_fim_formatada_w')::timestamp)) then
			begin
			CALL cpoe_gerar_registro_json_pck.cpoe_seta_status_ini_validade(current_setting('cpoe_gerar_registro_json_pck.dt_inicio_grid_w')::timestamp);
			end;
		end if;
	PERFORM set_config('cpoe_gerar_registro_json_pck.seq_w', 1, false);
	open current_setting('cpoe_gerar_registro_json_pck.c03')::CURSOR;
		loop
		fetch current_setting('cpoe_gerar_registro_json_pck.c03')::into CURSOR
			cd_mat_proc_w,
			ie_via_mat_proc_w,
			current_setting('cpoe_gerar_registro_json_pck.qt_dose_mat_w')::cpoe_gasoterapia.qt_dose_mat1%type,
			cd_unid_medida_dose_mat_w,
			cd_interv_proc_w,
			hr_prim_hor_proc_w,
			ds_hor_proc_w,
			ds_obser_proc_w,
			current_setting('cpoe_gerar_registro_json_pck.nr_prescricao_w')::prescr_material.nr_prescricao%type,
			nr_seq_mat_w;
		EXIT WHEN NOT FOUND; /* apply on current_setting('cpoe_gerar_registro_json_pck.c03')::CURSOR */

			PERFORM set_config('cpoe_gerar_registro_json_pck.ds_json_materiais_w', current_setting('cpoe_gerar_registro_json_pck.ds_json_materiais_w')::text || '{' ||  	format_array_json('CD_MAT_PROC'||current_setting('cpoe_gerar_registro_json_pck.seq_w')::integer, cd_mat_proc_w,1)                ||
																	format_array_json('CD_UNID_MEDIDA_DOSE_MAT'||current_setting('cpoe_gerar_registro_json_pck.seq_w')::integer, cd_unid_medida_dose_mat_w,1)		||
																	format_array_json('CD_INTERV_PROC'||current_setting('cpoe_gerar_registro_json_pck.seq_w')::integer, cd_interv_proc_w,1)		    ||
																	format_array_json('DS_HOR_PROC'||current_setting('cpoe_gerar_registro_json_pck.seq_w')::integer, ds_hor_proc_w,1)		        ||
																	format_array_json('DT_FIM_PROC'||current_setting('cpoe_gerar_registro_json_pck.seq_w')::integer, null,1) 	                    ||
																	format_array_json('DT_INICIO_PROC'||current_setting('cpoe_gerar_registro_json_pck.seq_w')::integer, null,1)		                ||
																	format_array_json('HR_PRIM_HOR_PROC'||current_setting('cpoe_gerar_registro_json_pck.seq_w')::integer, hr_prim_hor_proc_w,1)		||
																	format_array_json('IE_VIA_MAT_PROC'||current_setting('cpoe_gerar_registro_json_pck.seq_w')::integer, ie_via_mat_proc_w,1)		||
																	format_array_json('IE_DUR_PROC'||current_setting('cpoe_gerar_registro_json_pck.seq_w')::integer, null,1) 	                    ||
																	format_array_json('QT_DOSE_MAT'||current_setting('cpoe_gerar_registro_json_pck.seq_w')::integer, current_setting('cpoe_gerar_registro_json_pck.qt_dose_mat_w')::cpoe_gasoterapia.qt_dose_mat1%type,1)                ||
																	format_array_json('DS_OBSER_PROC'||current_setting('cpoe_gerar_registro_json_pck.seq_w')::integer, cpoe_gerar_registro_json_pck.remove_aspas(ds_obser_proc_w),1), false);

			select	max(d.cd_material),
					max(d.qt_dose),
					max(d.cd_unidade_medida_dose)
			into STRICT	current_setting('cpoe_gerar_registro_json_pck.cd_mat_dil_w')::prescr_material.cd_material%type,
					current_setting('cpoe_gerar_registro_json_pck.qt_dose_dil_w')::prescr_material.qt_dose%type,
					current_setting('cpoe_gerar_registro_json_pck.cd_unid_med_dose_dil_w')::cpoe_material.cd_unid_med_dose_dil%type
			from	prescr_material d
			where	d.nr_prescricao = current_setting('cpoe_gerar_registro_json_pck.nr_prescricao_w')::prescr_material.nr_prescricao%type
			and		d.nr_sequencia_diluicao = nr_seq_mat_w
			and		d.ie_agrupador = 3;

			PERFORM set_config('cpoe_gerar_registro_json_pck.ds_json_materiais_w', current_setting('cpoe_gerar_registro_json_pck.ds_json_materiais_w')::text ||	format_array_json('CD_MAT_DIL'||current_setting('cpoe_gerar_registro_json_pck.seq_w')::integer, current_setting('cpoe_gerar_registro_json_pck.cd_mat_dil_w')::prescr_material.cd_material%type,1)						||
															format_array_json('QT_DOSE_DIL'||current_setting('cpoe_gerar_registro_json_pck.seq_w')::integer, current_setting('cpoe_gerar_registro_json_pck.qt_dose_dil_w')::prescr_material.qt_dose%type,1)					||
															format_array_json('CD_UNID_MEDIDA_DOSE_DIL'||current_setting('cpoe_gerar_registro_json_pck.seq_w')::integer, current_setting('cpoe_gerar_registro_json_pck.cd_unid_med_dose_dil_w')::cpoe_material.cd_unid_med_dose_dil%type,1), false);

			PERFORM set_config('cpoe_gerar_registro_json_pck.ds_json_materiais_w', substr(current_setting('cpoe_gerar_registro_json_pck.ds_json_materiais_w')::text,1,length(current_setting('cpoe_gerar_registro_json_pck.ds_json_materiais_w')::text) - 2) || '},', false);
			PERFORM set_config('cpoe_gerar_registro_json_pck.seq_w', current_setting('cpoe_gerar_registro_json_pck.seq_w')::integer + 1, false);
			if (current_setting('cpoe_gerar_registro_json_pck.seq_w')::integer = 8) then
				exit;
			end if;

		end loop;
	close current_setting('cpoe_gerar_registro_json_pck.c03')::CURSOR;

	if (coalesce(c01_proc_w.dt_lib_suspensao_item_w::text, '') = '') then
		c01_proc_w.dt_suspensao_item_w := null;
	end if;

		ds_json_proc_w := ds_json_proc_w || '{' ||    	
														format_array_json('CD_INTERVALO',c01_proc_w.cd_intervalo_w,1)              ||
														format_array_json('CD_MATERIAL_EXAME',c01_proc_w.cd_material_exame_w,1)    ||
														format_array_json('DS_PROCEDIMENTO',ds_procedimento_w,1)        ||
														format_array_json('DS_ITEM',ds_procedimento_ww,1)        ||
														format_array_json('DS_HORARIOS',c01_proc_w.ds_horarios_w,1)                ||
														format_array_json('DS_OBSERVACAO',cpoe_gerar_registro_json_pck.remove_aspas(c01_proc_w.ds_observacao_w),1)            ||
														format_array_json('DS_INTERVALO',cpoe_gerar_registro_json_pck.remove_aspas(current_setting('cpoe_gerar_registro_json_pck.ds_intervalo_w')::varchar(255)),1)              ||
														format_array_json('DS_MATERIAL_ESPECIAL',cpoe_gerar_registro_json_pck.remove_aspas(c01_proc_w.ds_material_especial_w),1)  ||
														format_array_json('DS_JUSTIFICATIVA',cpoe_gerar_registro_json_pck.remove_aspas(c01_proc_w.ds_justificativa_w),1)      ||
														format_array_json('DT_ATUALIZACAO', c01_proc_w.dt_atualizacao_w,1)         ||
														format_array_json('DT_ATUALIZACAO_NREC', c01_proc_w.dt_atualizacao_nrec_w,1) ||
														format_array_json('DT_LIBERACAO', to_char(c01_proc_w.dt_liberacao_w, 'dd/mm/yyyy hh24:mi:ss'),1) ||
														format_array_json('DT_LIBERACAO_ENFERMAGEM', to_char(current_setting('cpoe_gerar_registro_json_pck.dt_liberacao_enfermagem_w')::prescr_medica.dt_liberacao%type, 'dd/mm/yyyy hh24:mi:ss'),1) ||
														format_array_json('DT_LIBERACAO_FARMACIA', to_char(current_setting('cpoe_gerar_registro_json_pck.dt_liberacao_farmacia_w')::prescr_medica.dt_liberacao_farmacia%type, 'dd/mm/yyyy hh24:mi:ss'),1) ||
														format_array_json('NM_USUARIO_LIB_ENFERMAGEM', current_setting('cpoe_gerar_registro_json_pck.nm_usuario_lib_enfermagem_w')::varchar(255),1) ||
														format_array_json('NM_USUARIO_LIB_FARMACIA', current_setting('cpoe_gerar_registro_json_pck.nm_usuario_lib_farmacia_w')::varchar(255),1) ||
														format_array_json('IE_MOMENTO_LOTE', current_setting('cpoe_gerar_registro_json_pck.ie_momento_lote_w')::regra_disp_lote_farm.ie_momento_lote%type,1) ||
														format_array_json('DT_FIM', to_char(current_setting('cpoe_gerar_registro_json_pck.dt_fim_w')::cpoe_dieta.dt_fim%type, 'dd/mm/yyyy hh24:mi:ss'),1) ||
														format_array_json('DT_INICIO',to_char(c01_proc_w.dt_inicio_w, 'dd/mm/yyyy hh24:mi:ss'),1)                    ||
														format_array_json('DT_INICIO_GRID', to_char(current_setting('cpoe_gerar_registro_json_pck.dt_inicio_grid_w')::timestamp, 'dd/mm/yyyy hh24:mi:ss'),1) ||
														format_array_json('DT_SUSPENSAO', to_char(c01_proc_w.dt_suspensao_item_w, 'dd/mm/yyyy hh24:mi:ss'),1) ||
														format_array_json('DT_LIB_SUSPENSAO', to_char(c01_proc_w.dt_lib_suspensao_item_w, 'dd/mm/yyyy hh24:mi:ss'),1) ||
														format_array_json('DT_DESCONTINUACAO', to_char(c01_proc_w.dt_suspensao_item_w, 'dd/mm/yyyy hh24:mi:ss'),1) ||
														format_array_json('NM_USUARIO_SUSP', current_setting('cpoe_gerar_registro_json_pck.nm_usuario_susp_w')::cpoe_dieta.nm_usuario_susp%type,1) ||
														format_array_json('NM_USUARIO_DESCONTINUACAO', current_setting('cpoe_gerar_registro_json_pck.nm_usuario_descontinuacao_w')::varchar(255),1) ||
														format_array_json('HR_PRIM_HORARIO',c01_proc_w.hr_prim_horario_w,1)        ||
														format_array_json('IE_SE_NECESSARIO',c01_proc_w.ie_se_necessario_w,1)      ||
														format_array_json('IE_LADO',c01_proc_w.ie_lado_w,1)                        ||
														format_array_json('IE_DURACAO', current_setting('cpoe_gerar_registro_json_pck.ie_duracao_w')::cpoe_dieta.ie_duracao%type,1)                 ||
														format_array_json('IE_ACM',c01_proc_w.ie_acm_w,1)                          ||
														format_array_json('IE_ADMINISTRACAO', current_setting('cpoe_gerar_registro_json_pck.ie_administracao_w')::cpoe_dieta.ie_administracao%type,1)		||
														format_array_json('IE_EVENTO_UNICO', current_setting('cpoe_gerar_registro_json_pck.ie_evento_unico_w')::cpoe_dieta.ie_evento_unico%type,1) 		||
														format_array_json('IE_URGENCIA',c01_proc_w.ie_urgencia_w,1)                ||
														format_array_json('NR_SEQ_PROC_INTERNO',c01_proc_w.nr_seq_proc_interno_w,1)||
														format_array_json('NR_SEQ_TOPOGRAFIA',c01_proc_w.nr_seq_topografia_w,1)    ||
														format_array_json('NR_SEQ_PROT_GLIC',c01_proc_w.nr_seq_prot_glic_w,1)      ||
														format_array_json('NM_USUARIO', c01_proc_w.nm_usuario_w,1)                 ||
														format_array_json('NM_USUARIO_NREC', c01_proc_w.nm_usuario_nrec_w,1)       ||
														format_array_json('QT_PROCEDIMENTO',c01_proc_w.qt_procedimento_w,1)        ||
														format_array_json('NR_OCORRENCIA',c01_proc_w.nr_ocorrencia_w,1)            ||
														format_array_json('NR_SEQ_PROC_CPOE',c01_proc_w.nr_seq_proc_cpoe_w,1)      ||
														format_array_json('NR_ATENDIMENTO', nr_atendimento_p,1) 		||
														format_array_json('NR_SEQ_CONDICAO',c01_proc_w.nr_seq_condicao_w,1)        ||
														format_array_json('DS_DADO_CLINICO',cpoe_gerar_registro_json_pck.remove_aspas(c01_proc_w.ds_dado_clinico_w),1)        ||
														format_array_json('DS_PRESCRITOR_DETALHE', cpoe_gerar_registro_json_pck.remove_aspas(current_setting('cpoe_gerar_registro_json_pck.ds_prescritor_w')::varchar(255)),1)	||
														format_array_json('DT_PRESCRITA_DETALHE', current_setting('cpoe_gerar_registro_json_pck.dt_prescrito_w')::varchar(255),1)		||
														format_array_json('DS_PREVIOUS_PRESCRIBER', cpoe_gerar_registro_json_pck.remove_aspas(current_setting('cpoe_gerar_registro_json_pck.ds_previous_prescriber_w')::varchar(255)),1) ||
														format_array_json('DT_PREVIOUS_PRESCRIBER', current_setting('cpoe_gerar_registro_json_pck.dt_previous_prescriber_w')::varchar(255),1) ||
														format_array_json('DS_SPECIAL_APPROVAL', cpoe_gerar_registro_json_pck.remove_aspas(ds_special_approval_w),1) ||
														format_array_json('DT_SPECIAL_APPROVAL', dt_special_approval_w,1) ||
														format_array_json('DS_CIENCIA_DETALHE', cpoe_gerar_registro_json_pck.remove_aspas(current_setting('cpoe_gerar_registro_json_pck.ds_ciencia_detalhe_w')::varchar(255)),1) ||
														format_array_json('DT_CIENCIA_DETALHE', current_setting('cpoe_gerar_registro_json_pck.dt_ciencia_detalhe_w')::varchar(255),1) ||
														format_array_json('DS_CONSELHO', cpoe_gerar_registro_json_pck.remove_aspas(current_setting('cpoe_gerar_registro_json_pck.ds_conselho_w')::varchar(255)),1)				||	
														format_array_json('DS_PRESCRITOR', cpoe_gerar_registro_json_pck.remove_aspas(current_setting('cpoe_gerar_registro_json_pck.ds_prescritor_grid_w')::varchar(255)),1) ||
														format_array_json('DS_PRESCRITOR_REVAL', cpoe_gerar_registro_json_pck.remove_aspas(current_setting('cpoe_gerar_registro_json_pck.ds_prescritor_reval_w')::varchar(255)),1) ||
														format_array_json('NR_SEQ_VISAO', 21647,1) ||

														format_array_json('DS_MATERIAIS',obter_array_json('DS_MATERIAIS', current_setting('cpoe_gerar_registro_json_pck.ds_json_materiais_w')::text),2) ||

														format_array_json('IE_TIPO_ITEM',c01_proc_w.ie_tipo_item_w,1)				||
														format_array_json('CD_MEDICO',c01_proc_w.cd_medico_w,1)						||
														format_array_json('IE_ORDER_ON_BEHALF',c01_proc_w.ie_order_on_behalf_w,1)	||
														format_array_json('DT_CIENCIA_MEDICO',c01_proc_w.dt_ciencia_medico_w,1)		||
														format_array_json('IE_PRESCRITOR_AUX', c01_proc_w.ie_prescritor_aux_w,1)	||
														format_array_json('DT_LIBERACAO_AUX', c01_proc_w.dt_liberacao_aux_w,1)		||
														format_array_json('IE_EXIGE_CIENCIA',c01_proc_w.ie_exige_ciencia_w,1)		||
														format_array_json('IE_DEPART_LIB_SETOR',c01_proc_w.ie_depart_lib_setor_w,1)	||
														format_array_json('CD_DEPARTAMENTO',c01_proc_w.cd_departamento_w,1)	||

														format_array_json('DS_HORA_00',current_setting('cpoe_gerar_registro_json_pck.ds_hora_00_w')::varchar(50),1)	||
														format_array_json('DS_HORA_01',current_setting('cpoe_gerar_registro_json_pck.ds_hora_01_w')::varchar(50),1)  ||
														format_array_json('DS_HORA_02',current_setting('cpoe_gerar_registro_json_pck.ds_hora_02_w')::varchar(50),1)  ||
														format_array_json('DS_HORA_03',current_setting('cpoe_gerar_registro_json_pck.ds_hora_03_w')::varchar(50),1)  ||
														format_array_json('DS_HORA_04',current_setting('cpoe_gerar_registro_json_pck.ds_hora_04_w')::varchar(50),1)  ||
														format_array_json('DS_HORA_05',current_setting('cpoe_gerar_registro_json_pck.ds_hora_05_w')::varchar(50),1)  ||
														format_array_json('DS_HORA_06',current_setting('cpoe_gerar_registro_json_pck.ds_hora_06_w')::varchar(50),1)  ||
														format_array_json('DS_HORA_07',current_setting('cpoe_gerar_registro_json_pck.ds_hora_07_w')::varchar(50),1)  ||
														format_array_json('DS_HORA_08',current_setting('cpoe_gerar_registro_json_pck.ds_hora_08_w')::varchar(50),1)  ||
														format_array_json('DS_HORA_09',current_setting('cpoe_gerar_registro_json_pck.ds_hora_09_w')::varchar(50),1)  ||
														format_array_json('DS_HORA_10',current_setting('cpoe_gerar_registro_json_pck.ds_hora_10_w')::varchar(50),1)  ||
														format_array_json('DS_HORA_11',current_setting('cpoe_gerar_registro_json_pck.ds_hora_11_w')::varchar(50),1)  ||
														format_array_json('DS_HORA_12',current_setting('cpoe_gerar_registro_json_pck.ds_hora_12_w')::varchar(50),1)  ||
														format_array_json('DS_HORA_13',current_setting('cpoe_gerar_registro_json_pck.ds_hora_13_w')::varchar(50),1)  ||
														format_array_json('DS_HORA_14',current_setting('cpoe_gerar_registro_json_pck.ds_hora_14_w')::varchar(50),1)  ||
														format_array_json('DS_HORA_15',current_setting('cpoe_gerar_registro_json_pck.ds_hora_15_w')::varchar(50),1)  ||
														format_array_json('DS_HORA_16',current_setting('cpoe_gerar_registro_json_pck.ds_hora_16_w')::varchar(50),1)  ||
														format_array_json('DS_HORA_17',current_setting('cpoe_gerar_registro_json_pck.ds_hora_17_w')::varchar(50),1)  ||
														format_array_json('DS_HORA_18',current_setting('cpoe_gerar_registro_json_pck.ds_hora_18_w')::varchar(50),1)  ||
														format_array_json('DS_HORA_19',current_setting('cpoe_gerar_registro_json_pck.ds_hora_19_w')::varchar(50),1)  ||
														format_array_json('DS_HORA_20',current_setting('cpoe_gerar_registro_json_pck.ds_hora_20_w')::varchar(50),1)  ||
														format_array_json('DS_HORA_21',current_setting('cpoe_gerar_registro_json_pck.ds_hora_21_w')::varchar(50),1)  ||
														format_array_json('DS_HORA_23',current_setting('cpoe_gerar_registro_json_pck.ds_hora_23_w')::varchar(50),1)  ||
														format_array_json('DS_HORA_22',current_setting('cpoe_gerar_registro_json_pck.ds_hora_22_w')::varchar(50),1)  ||
														format_array_json('CD_SETOR_ENTREGA', c01_proc_w.cd_setor_entrega_w, 1)  ||
														format_array_json('CD_MEDICO_EXEC', c01_proc_w.cd_medico_exec_w, 1) ||
														format_array_json('CD_SETOR_ATENDIMENTO', c01_proc_w.cd_setor_atendimento_w, 1) ||
														format_array_json('DS_DIAS_SEMANA', ds_dias_semana_w, 1) ||
														format_array_json('IE_SEGUNDA', ie_segunda_w, 1) ||
														format_array_json('IE_TERCA', ie_terca_w, 1) ||
														format_array_json('IE_QUARTA', ie_quarta_w, 1) ||
														format_array_json('IE_QUINTA', ie_quinta_w, 1) ||
														format_array_json('IE_SEXTA', ie_sexta_w, 1) ||
														format_array_json('IE_SABADO', ie_sabado_w, 1) ||
														format_array_json('IE_DOMINGO', ie_domingo_w, 1) ||
														format_array_json('NR_SEQ_ASSINATURA', c01_proc_w.nr_seq_assinatura_w, 1)||
														format_array_json('DT_ASSINATURA_DIGITAL', to_char(current_setting('cpoe_gerar_registro_json_pck.dt_assinatura_digital_w')::tasy_assinatura_digital.dt_assinatura%type, 'dd/mm/yyyy hh24:mi:ss'), 1) ||
														format_array_json('NR_SEQ_CPOE_ORDER_UNIT', c01_proc_w.nr_seq_cpoe_order_unit_w, 1);

		ds_json_proc_w := substr(ds_json_proc_w,1,length(ds_json_proc_w)-2) || '},';

	end loop;

	if (ds_json_proc_w IS NOT NULL AND ds_json_proc_w::text <> '') then
		begin
		PERFORM set_config('cpoe_gerar_registro_json_pck.ds_registro_w', format_json('DS_PROCEDIMENTO', ds_json_proc_w), false);


		CALL cpoe_gerar_registro_json_pck.cpoe_salvar_json( 	nr_atendimento_p,
							dt_referencia_p,
							nm_usuario_p,
							'P',
							current_setting('cpoe_gerar_registro_json_pck.ds_registro_w')::text);

		end;
	end if;

commit;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_gerar_registro_json_pck.cpoe_gerar_registro_proc_json (nr_atendimento_p bigint, dt_referencia_p timestamp, nm_usuario_p text, nr_prescricao_p bigint default null) FROM PUBLIC;
