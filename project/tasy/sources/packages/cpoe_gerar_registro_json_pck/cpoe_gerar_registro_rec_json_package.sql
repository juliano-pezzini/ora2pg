-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE cpoe_gerar_registro_json_pck.cpoe_gerar_registro_rec_json ( nr_atendimento_p bigint, dt_referencia_p timestamp, nm_usuario_p text, nr_prescricao_p bigint default null) AS $body$
DECLARE


current_setting('cpoe_gerar_registro_json_pck.ds_registro_w')::text				text;
ds_json_rec_w				text;
ds_node_horarios_w			text;
current_setting('cpoe_gerar_registro_json_pck.ds_item_w')::varchar(1000)					varchar(1000);
ds_item_ww					varchar(1000);
current_setting('cpoe_gerar_registro_json_pck.ds_intervalo_w')::varchar(255)				varchar(255);
current_setting('cpoe_gerar_registro_json_pck.dt_horario_w')::prescr_mat_hor.dt_horario%type				varchar(20);
current_setting('cpoe_gerar_registro_json_pck.dt_fim_horario_w')::varchar(20)			varchar(20);
current_setting('cpoe_gerar_registro_json_pck.dt_suspensao_w')::varchar(20)				varchar(20);
current_setting('cpoe_gerar_registro_json_pck.ds_hora_w')::varchar(255)					varchar(255);
current_setting('cpoe_gerar_registro_json_pck.nr_hora_w')::integer					bigint;
count_cpoe_recomendacao_w 	bigint;
current_setting('cpoe_gerar_registro_json_pck.nm_usuario_descontinuacao_w')::varchar(255)	varchar(255);
current_setting('cpoe_gerar_registro_json_pck.ds_prescritor_w')::varchar(255)				varchar(255);
current_setting('cpoe_gerar_registro_json_pck.dt_prescrito_w')::varchar(255)				varchar(255);
current_setting('cpoe_gerar_registro_json_pck.ds_previous_prescriber_w')::varchar(255)	varchar(255);
current_setting('cpoe_gerar_registro_json_pck.dt_previous_prescriber_w')::varchar(255)	varchar(255);
current_setting('cpoe_gerar_registro_json_pck.ds_conselho_w')::varchar(255)				varchar(255);
current_setting('cpoe_gerar_registro_json_pck.ds_prescritor_grid_w')::varchar(255)		varchar(255);
current_setting('cpoe_gerar_registro_json_pck.ds_prescritor_reval_w')::varchar(255)		varchar(255);
current_setting('cpoe_gerar_registro_json_pck.dt_inicio_grid_w')::timestamp			timestamp;

nr_prescricao_w				prescr_medica.nr_prescricao%type;
current_setting('cpoe_gerar_registro_json_pck.dt_liberacao_w')::prescr_medica.dt_liberacao%type 				prescr_medica.dt_liberacao%type;
current_setting('cpoe_gerar_registro_json_pck.dt_liberacao_enfermagem_w')::prescr_medica.dt_liberacao%type		prescr_medica.dt_liberacao%type;
current_setting('cpoe_gerar_registro_json_pck.dt_liberacao_farmacia_w')::prescr_medica.dt_liberacao_farmacia%type			prescr_medica.dt_liberacao_farmacia%type;		
current_setting('cpoe_gerar_registro_json_pck.ie_momento_lote_w')::regra_disp_lote_farm.ie_momento_lote%type				regra_disp_lote_farm.ie_momento_lote%type;
current_setting('cpoe_gerar_registro_json_pck.nm_usuario_lib_enfermagem_w')::varchar(255)		varchar(255);
current_setting('cpoe_gerar_registro_json_pck.nm_usuario_lib_farmacia_w')::varchar(255)		varchar(255);

nr_seq_rec_w				cpoe_recomendacao.nr_sequencia%type;
cd_recomendacao_w			cpoe_recomendacao.cd_recomendacao%type;
current_setting('cpoe_gerar_registro_json_pck.cd_intervalo_w')::prescr_gasoterapia.cd_intervalo%type				cpoe_recomendacao.cd_intervalo%type;
nr_seq_rec_cpoe_w			prescr_recomendacao.nr_seq_rec_cpoe%type;
ds_recomendacao_w			cpoe_recomendacao.ds_recomendacao%type;
ds_recomendacao_ww			cpoe_recomendacao.ds_recomendacao%type;
current_setting('cpoe_gerar_registro_json_pck.ds_horarios_w')::prescr_gasoterapia.ds_horarios%type				cpoe_recomendacao.ds_horarios%type;
current_setting('cpoe_gerar_registro_json_pck.ie_acm_w')::varchar(1)					cpoe_recomendacao.ie_acm%type;
current_setting('cpoe_gerar_registro_json_pck.hr_prim_horario_w')::varchar(5)			cpoe_recomendacao.hr_prim_horario%type;
current_setting('cpoe_gerar_registro_json_pck.ie_urgencia_w')::varchar(1)				cpoe_recomendacao.ie_urgencia%type;
current_setting('cpoe_gerar_registro_json_pck.ie_se_necessario_w')::varchar(1)			cpoe_recomendacao.ie_se_necessario%type;
nr_seq_topografia_w			cpoe_recomendacao.nr_seq_topografia%type;
current_setting('cpoe_gerar_registro_json_pck.dt_suspensao_item_w')::prescr_gasoterapia.dt_suspensao%type			cpoe_recomendacao.dt_suspensao%type;
current_setting('cpoe_gerar_registro_json_pck.dt_lib_suspensao_item_w')::cpoe_gasoterapia.dt_lib_suspensao%type		cpoe_recomendacao.dt_lib_suspensao%type;

current_setting('cpoe_gerar_registro_json_pck.dt_horario_ww')::prescr_gasoterapia_hor.dt_horario%type				prescr_rec_hor.dt_horario%type;
current_setting('cpoe_gerar_registro_json_pck.dt_horario_fim_w')::cpoe_dieta.dt_fim%type			prescr_rec_hor.dt_horario%type;

current_setting('cpoe_gerar_registro_json_pck.nr_ocorrencia_w')::cpoe_gasoterapia.nr_ocorrencia%type             cpoe_recomendacao.nr_ocorrencia%type;
current_setting('cpoe_gerar_registro_json_pck.dt_fim_w')::cpoe_dieta.dt_fim%type					cpoe_recomendacao.dt_fim%type;
current_setting('cpoe_gerar_registro_json_pck.dt_inicio_w')::cpoe_dieta.dt_inicio%type					cpoe_recomendacao.dt_inicio%type;
current_setting('cpoe_gerar_registro_json_pck.ie_duracao_w')::cpoe_dieta.ie_duracao%type				cpoe_recomendacao.ie_duracao%type;
current_setting('cpoe_gerar_registro_json_pck.ie_administracao_w')::cpoe_dieta.ie_administracao%type			cpoe_recomendacao.ie_administracao%type;
current_setting('cpoe_gerar_registro_json_pck.ie_evento_unico_w')::cpoe_dieta.ie_evento_unico%type			cpoe_recomendacao.ie_evento_unico%type;
current_setting('cpoe_gerar_registro_json_pck.nm_usuario_susp_w')::cpoe_dieta.nm_usuario_susp%type			cpoe_recomendacao.nm_usuario_susp%type;

current_setting('cpoe_gerar_registro_json_pck.nm_usuario_w')::prescr_gasoterapia.nm_usuario%type				cpoe_recomendacao.nm_usuario%type;
current_setting('cpoe_gerar_registro_json_pck.nm_usuario_nrec_w')::prescr_gasoterapia_evento.nm_usuario_nrec%type			prescr_rec_hor.nm_usuario_nrec%type;
current_setting('cpoe_gerar_registro_json_pck.dt_atualizacao_w')::prescr_gasoterapia.dt_atualizacao%type			cpoe_recomendacao.dt_atualizacao%type;
current_setting('cpoe_gerar_registro_json_pck.dt_atualizacao_nrec_w')::prescr_gasoterapia_evento.dt_atualizacao_nrec%type 		prescr_rec_hor.dt_atualizacao_nrec%type;

current_setting('cpoe_gerar_registro_json_pck.ie_motivo_prescricao_w')::cpoe_gasoterapia.ie_motivo_prescricao%type		cpoe_recomendacao.ie_motivo_prescricao%type;
current_setting('cpoe_gerar_registro_json_pck.cd_setor_atendimento_w')::cpoe_gasoterapia.cd_setor_atendimento%type		cpoe_recomendacao.cd_setor_atendimento%type;
current_setting('cpoe_gerar_registro_json_pck.cd_estabelecimento_w')::estabelecimento.cd_estabelecimento%type		prescr_medica.cd_estabelecimento%type;
current_setting('cpoe_gerar_registro_json_pck.ie_oncologia_w')::cpoe_material.ie_oncologia%type				cpoe_recomendacao.ie_oncologia%type;
current_setting('cpoe_gerar_registro_json_pck.nr_seq_assinatura_w')::cpoe_gasoterapia.nr_seq_assinatura%type			cpoe_recomendacao.nr_seq_assinatura%type;
current_setting('cpoe_gerar_registro_json_pck.dt_assinatura_digital_w')::tasy_assinatura_digital.dt_assinatura%type		tasy_assinatura_digital.dt_assinatura%type;
current_setting('cpoe_gerar_registro_json_pck.nr_seq_cpoe_order_unit_w')::cpoe_order_unit.nr_sequencia%type        cpoe_order_unit.nr_sequencia%type;


current_setting('cpoe_gerar_registro_json_pck.c01')::CURSOR CURSOR FOR  -- Recomendacao
	SELECT	distinct a.cd_recomendacao,
		a.cd_intervalo,
		a.nr_sequencia,
		a.ds_recomendacao,
		a.ds_horarios,
		a.ie_acm,
		a.hr_prim_horario,
		a.ie_urgencia,
		a.ie_se_necessario,
		a.nr_seq_topografia,
		a.dt_liberacao,
		a.ie_motivo_prescricao,
		a.cd_setor_atendimento,
		a.ie_oncologia,
		a.dt_suspensao, 
		a.dt_lib_suspensao,
		a.nm_usuario,
		a.nm_usuario_nrec,
		a.dt_atualizacao,
		a.dt_atualizacao_nrec,
		a.nr_ocorrencia,
		a.nr_seq_assinatura,
		a.nr_seq_cpoe_order_unit
	from	cpoe_recomendacao a,
		prescr_recomendacao b,
		prescr_rec_hor c,
		prescr_medica d
	where	a.nr_atendimento = nr_atendimento_p
	and	a.dt_prox_geracao > current_setting('cpoe_gerar_registro_json_pck.dt_hora_formatada_w')::timestamp - 1
	and	(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
	and	a.nr_sequencia = b.nr_seq_rec_cpoe
	and	b.nr_prescricao = c.nr_prescricao
	and	b.nr_sequencia = c.nr_seq_recomendacao
	and	b.nr_prescricao = d.nr_prescricao
	and ((coalesce(nr_prescricao_p,0) = 0)  or (b.nr_prescricao = nr_prescricao_p))
	and	(((cpoe_reg_valido_ativacao(CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) END , a.dt_inicio, current_setting('cpoe_gerar_registro_json_pck.dt_hora_formatada_w')::timestamp, NULL, a.cd_perfil_ativo, ie_retrogrado, a.dt_liberacao, 'N', ie_futuro, dt_liberacao_fut) = 'S') and (current_setting('cpoe_gerar_registro_json_pck.dt_hora_formatada_w')::timestamp > a.dt_inicio)) or 
		((((Obter_se_acm_sn_agora_especial(b.ie_acm, b.ie_se_necessario, 'N', 'N') = 'N') and (c.dt_horario between current_setting('cpoe_gerar_registro_json_pck.dt_hora_formatada_w')::timestamp	and	current_setting('cpoe_gerar_registro_json_pck.dt_hora_fim_formatada_w')::timestamp or b.nr_prescricao = nr_prescricao_p)) or
		((Obter_se_acm_sn_agora_especial(b.ie_acm, b.ie_se_necessario, 'N', 'N') = 'S') and (obter_se_prescr_vig_adep(d.dt_prescricao, d.dt_validade_prescr, current_setting('cpoe_gerar_registro_json_pck.dt_hora_formatada_w')::timestamp, current_setting('cpoe_gerar_registro_json_pck.dt_hora_fim_formatada_w')::timestamp) = 'S')))))
	order by a.nr_sequencia;

current_setting('cpoe_gerar_registro_json_pck.c02')::CURSOR CURSOR FOR
	SELECT	coalesce(to_char(a.dt_horario,'dd/mm/yyyy hh24:mi'),'null'),
			coalesce(to_char(a.dt_fim_horario,'dd/mm/yyyy hh24:mi'),'null'),
			coalesce(to_char(a.dt_suspensao,'dd/mm/yyyy hh24:mi'),'null'),
			dt_horario
	from	prescr_rec_hor a,
			prescr_recomendacao b
	where	a.nr_prescricao = b.nr_prescricao
	and		a.nr_seq_recomendacao = b.nr_sequencia
	and		b.nr_seq_rec_cpoe = nr_seq_rec_cpoe_w
	and		a.dt_horario between current_setting('cpoe_gerar_registro_json_pck.dt_hora_formatada_w')::timestamp	and	current_setting('cpoe_gerar_registro_json_pck.dt_hora_fim_formatada_w')::timestamp
	order by	a.dt_horario;


BEGIN

open current_setting('cpoe_gerar_registro_json_pck.c01')::CURSOR;
loop
fetch current_setting('cpoe_gerar_registro_json_pck.c01')::into CURSOR
	cd_recomendacao_w,
	current_setting('cpoe_gerar_registro_json_pck.cd_intervalo_w')::prescr_gasoterapia.cd_intervalo%type,
	nr_seq_rec_cpoe_w,
	ds_recomendacao_w,
	current_setting('cpoe_gerar_registro_json_pck.ds_horarios_w')::prescr_gasoterapia.ds_horarios%type,
	current_setting('cpoe_gerar_registro_json_pck.ie_acm_w')::varchar(1),
	current_setting('cpoe_gerar_registro_json_pck.hr_prim_horario_w')::varchar(5),
	current_setting('cpoe_gerar_registro_json_pck.ie_urgencia_w')::varchar(1),
	current_setting('cpoe_gerar_registro_json_pck.ie_se_necessario_w')::varchar(1),
	nr_seq_topografia_w,		
	current_setting('cpoe_gerar_registro_json_pck.dt_liberacao_w')::prescr_medica.dt_liberacao%type,
	current_setting('cpoe_gerar_registro_json_pck.ie_motivo_prescricao_w')::cpoe_gasoterapia.ie_motivo_prescricao%type,
	current_setting('cpoe_gerar_registro_json_pck.cd_setor_atendimento_w')::cpoe_gasoterapia.cd_setor_atendimento%type,
	current_setting('cpoe_gerar_registro_json_pck.ie_oncologia_w')::cpoe_material.ie_oncologia%type,
	current_setting('cpoe_gerar_registro_json_pck.dt_suspensao_item_w')::prescr_gasoterapia.dt_suspensao%type,
	current_setting('cpoe_gerar_registro_json_pck.dt_lib_suspensao_item_w')::cpoe_gasoterapia.dt_lib_suspensao%type,
	current_setting('cpoe_gerar_registro_json_pck.nm_usuario_w')::prescr_gasoterapia.nm_usuario%type,
	current_setting('cpoe_gerar_registro_json_pck.nm_usuario_nrec_w')::prescr_gasoterapia_evento.nm_usuario_nrec%type,
	current_setting('cpoe_gerar_registro_json_pck.dt_atualizacao_w')::prescr_gasoterapia.dt_atualizacao%type,
	current_setting('cpoe_gerar_registro_json_pck.dt_atualizacao_nrec_w')::prescr_gasoterapia_evento.dt_atualizacao_nrec%type,
	current_setting('cpoe_gerar_registro_json_pck.nr_ocorrencia_w')::cpoe_gasoterapia.nr_ocorrencia%type,
	current_setting('cpoe_gerar_registro_json_pck.nr_seq_assinatura_w')::cpoe_gasoterapia.nr_seq_assinatura%type,
	current_setting('cpoe_gerar_registro_json_pck.nr_seq_cpoe_order_unit_w')::cpoe_order_unit.nr_sequencia%type;
EXIT WHEN NOT FOUND; /* apply on current_setting('cpoe_gerar_registro_json_pck.c01')::CURSOR */

	PERFORM set_config('cpoe_gerar_registro_json_pck.cd_estabelecimento_w', obter_estabelecimento_setor(current_setting('cpoe_gerar_registro_json_pck.cd_setor_atendimento_w')::cpoe_gasoterapia.cd_setor_atendimento%type), false);
	PERFORM set_config('cpoe_gerar_registro_json_pck.ie_momento_lote_w', cpoe_obter_momento_lote(current_setting('cpoe_gerar_registro_json_pck.ie_motivo_prescricao_w')::cpoe_gasoterapia.ie_motivo_prescricao%type, current_setting('cpoe_gerar_registro_json_pck.cd_setor_atendimento_w')::cpoe_gasoterapia.cd_setor_atendimento%type, current_setting('cpoe_gerar_registro_json_pck.cd_estabelecimento_w')::estabelecimento.cd_estabelecimento%type, current_setting('cpoe_gerar_registro_json_pck.ie_oncologia_w')::cpoe_material.ie_oncologia%type, 'CPOE_RECOMENDACAO', nr_seq_rec_cpoe_w, null, null, null), false);
	PERFORM set_config('cpoe_gerar_registro_json_pck.dt_suspensao_item_w', cpoe_gerar_registro_json_pck.regra_data_susp(current_setting('cpoe_gerar_registro_json_pck.dt_suspensao_item_w')::prescr_gasoterapia.dt_suspensao%type), false);
	PERFORM set_config('cpoe_gerar_registro_json_pck.dt_lib_suspensao_item_w', cpoe_gerar_registro_json_pck.regra_data_susp(current_setting('cpoe_gerar_registro_json_pck.dt_lib_suspensao_item_w')::cpoe_gasoterapia.dt_lib_suspensao%type), false);
	PERFORM set_config('cpoe_gerar_registro_json_pck.ds_item_w', substr(obter_desc_recomendacao(cd_recomendacao_w),1,255), false);
	ds_recomendacao_ww := current_setting('cpoe_gerar_registro_json_pck.ds_item_w')::varchar(1000);
	CALL cpoe_gerar_registro_json_pck.cpoe_limpar_valores_horas();

	select count(*)
	into STRICT   count_cpoe_recomendacao_w
	from   cpoe_recomendacao
	where  nr_sequencia = nr_seq_rec_cpoe_w;

	PERFORM set_config('cpoe_gerar_registro_json_pck.dt_fim_w', '', false);
	PERFORM set_config('cpoe_gerar_registro_json_pck.dt_inicio_w', current_setting('cpoe_gerar_registro_json_pck.dt_inicio_grid_w')::timestamp, false);
	PERFORM set_config('cpoe_gerar_registro_json_pck.ie_duracao_w', '', false);
	PERFORM set_config('cpoe_gerar_registro_json_pck.ie_evento_unico_w', '', false);
	PERFORM set_config('cpoe_gerar_registro_json_pck.ie_administracao_w', 'P', false);

	if (current_setting('cpoe_gerar_registro_json_pck.ie_se_necessario_w')::varchar(1) = 'S') then
		PERFORM set_config('cpoe_gerar_registro_json_pck.ie_administracao_w', 'N', false);
	elsif (current_setting('cpoe_gerar_registro_json_pck.ie_acm_w')::varchar(1) = 'S') then
		PERFORM set_config('cpoe_gerar_registro_json_pck.ie_administracao_w', 'C', false);
	end if;

	if (count_cpoe_recomendacao_w > 0) then
		begin

			select	dt_fim,
				dt_inicio,
				ie_duracao,
				replace(cpoe_obter_desc_grid_recom(
				substr(cpoe_obter_desc_recomendacao(cd_recomendacao,dt_liberacao),1,255),
				substr(obter_desc_intervalo_prescr(cd_intervalo),1,255),
				cpoe_gerar_registro_json_pck.regra_data_susp(dt_lib_suspensao),cpoe_gerar_registro_json_pck.regra_data_susp(dt_suspensao), ie_administracao,null,null,null,obter_horarios_regra(ds_horarios)),'"','@#'),
				ie_administracao,
				ie_evento_unico,
				dt_liberacao,
				substr(obter_desc_intervalo_prescr(cd_intervalo),1,255) ds_intervalo,
				obter_nome_medico(obter_pf_usuario(nm_usuario_nrec,'C'),'PMS') ds_prescritor,
				cpoe_obter_tempo_prescrito(coalesce(dt_atualizacao_nrec, dt_inicio)) dt_prescrito,
				cpoe_get_prior_prescriber(nr_seq_cpoe_anterior, 'CPOE_RECOMENDACAO', 'N'),
				cpoe_get_prior_prescriber(nr_seq_cpoe_anterior, 'CPOE_RECOMENDACAO', 'D'),
				cpoe_obter_data_hora_form(dt_inicio,hr_prim_horario) dt_inicio_grid,
				substr(obter_dados_pf(obter_pf_usuario(nm_usuario_nrec,'C'),'COPR'),1,255) ds_conselho,
				obter_nome_pf(obter_pf_usuario(nm_usuario_nrec,'C')) ds_prescritor_grid,
				dt_liberacao_enf dt_liberacao_enfermagem,
				dt_liberacao_farm dt_liberacao_farmacia,
				nm_usuario_lib_enf nm_usuario_lib_enfermagem,
				nm_usuario_lib_farm nm_usuario_lib_farmacia,
				CASE WHEN coalesce(cpoe_gerar_registro_json_pck.regra_data_susp(dt_suspensao)::text, '') = '' THEN  null  ELSE nm_usuario_susp END ,
				CASE WHEN coalesce(cpoe_gerar_registro_json_pck.regra_data_susp(dt_suspensao)::text, '') = '' THEN  null  ELSE cpoe_obter_info_suspensao(nr_sequencia,'P','N') END  nm_usuario_descontinuacao,
				obter_data_assinatura_digital(nr_seq_assinatura),
				obter_pf_usuario(coalesce(nm_usuario, nm_usuario_nrec),'N') ds_prescritor_reval
			into STRICT	current_setting('cpoe_gerar_registro_json_pck.dt_fim_w')::cpoe_dieta.dt_fim%type,
				current_setting('cpoe_gerar_registro_json_pck.dt_inicio_w')::cpoe_dieta.dt_inicio%type,
				current_setting('cpoe_gerar_registro_json_pck.ie_duracao_w')::cpoe_dieta.ie_duracao%type,
				current_setting('cpoe_gerar_registro_json_pck.ds_item_w')::varchar(1000),
				current_setting('cpoe_gerar_registro_json_pck.ie_administracao_w')::cpoe_dieta.ie_administracao%type,
				current_setting('cpoe_gerar_registro_json_pck.ie_evento_unico_w')::cpoe_dieta.ie_evento_unico%type,
				current_setting('cpoe_gerar_registro_json_pck.dt_liberacao_w')::prescr_medica.dt_liberacao%type,
				current_setting('cpoe_gerar_registro_json_pck.ds_intervalo_w')::varchar(255),
				current_setting('cpoe_gerar_registro_json_pck.ds_prescritor_w')::varchar(255),
				current_setting('cpoe_gerar_registro_json_pck.dt_prescrito_w')::varchar(255),
				current_setting('cpoe_gerar_registro_json_pck.ds_previous_prescriber_w')::varchar(255),
				current_setting('cpoe_gerar_registro_json_pck.dt_previous_prescriber_w')::varchar(255),
				current_setting('cpoe_gerar_registro_json_pck.dt_inicio_grid_w')::timestamp,
				current_setting('cpoe_gerar_registro_json_pck.ds_conselho_w')::varchar(255),
				current_setting('cpoe_gerar_registro_json_pck.ds_prescritor_grid_w')::varchar(255),
				current_setting('cpoe_gerar_registro_json_pck.dt_liberacao_enfermagem_w')::prescr_medica.dt_liberacao%type,
				current_setting('cpoe_gerar_registro_json_pck.dt_liberacao_farmacia_w')::prescr_medica.dt_liberacao_farmacia%type,
				current_setting('cpoe_gerar_registro_json_pck.nm_usuario_lib_enfermagem_w')::varchar(255),					
				current_setting('cpoe_gerar_registro_json_pck.nm_usuario_lib_farmacia_w')::varchar(255),
				current_setting('cpoe_gerar_registro_json_pck.nm_usuario_susp_w')::cpoe_dieta.nm_usuario_susp%type,
				current_setting('cpoe_gerar_registro_json_pck.nm_usuario_descontinuacao_w')::varchar(255),
				current_setting('cpoe_gerar_registro_json_pck.dt_assinatura_digital_w')::tasy_assinatura_digital.dt_assinatura%type,
				current_setting('cpoe_gerar_registro_json_pck.ds_prescritor_reval_w')::varchar(255)
			from	cpoe_recomendacao
			where	nr_sequencia = nr_seq_rec_cpoe_w;

			select	max(dt_fim_horario)
			into STRICT	current_setting('cpoe_gerar_registro_json_pck.dt_horario_fim_w')::cpoe_dieta.dt_fim%type
			from (SELECT	max(dt_horario) dt_fim_horario
					from	prescr_recomendacao a,
							prescr_medica b,
							prescr_rec_hor c,
							cpoe_recomendacao d
					where	c.nr_prescricao = b.nr_prescricao
					and		c.nr_seq_recomendacao = a.nr_sequencia
					and		a.nr_prescricao 	= b.nr_prescricao
					and		b.nr_atendimento 	= nr_atendimento_p
					and		c.dt_horario between current_setting('cpoe_gerar_registro_json_pck.dt_hora_formatada_w')::timestamp	and	current_setting('cpoe_gerar_registro_json_pck.dt_hora_fim_formatada_w')::timestamp
					and		(coalesce(b.dt_liberacao_medico, b.dt_liberacao) IS NOT NULL AND (coalesce(b.dt_liberacao_medico, b.dt_liberacao))::text <> '')
					and 	a.nr_seq_rec_cpoe 	= d.nr_sequencia
					and		d.dt_fim			< c.dt_horario
					and		(d.dt_fim IS NOT NULL AND d.dt_fim::text <> '')
					and		d.nr_sequencia 		= nr_seq_rec_cpoe_w
					
union	all

					PERFORM	max(dt_fim) dt_fim_horario
					from	cpoe_recomendacao
					where	nr_atendimento	= nr_atendimento_p
					and		nr_sequencia	= nr_seq_rec_cpoe_w
					and		(dt_fim IS NOT NULL AND dt_fim::text <> '')) alias12;
		end;

	end if;

		open current_setting('cpoe_gerar_registro_json_pck.c02')::CURSOR;
		loop
		fetch current_setting('cpoe_gerar_registro_json_pck.c02')::into CURSOR
			current_setting('cpoe_gerar_registro_json_pck.dt_horario_w')::prescr_mat_hor.dt_horario%type,
			current_setting('cpoe_gerar_registro_json_pck.dt_fim_horario_w')::varchar(20),
			current_setting('cpoe_gerar_registro_json_pck.dt_suspensao_w')::varchar(20),
			current_setting('cpoe_gerar_registro_json_pck.dt_horario_ww')::prescr_gasoterapia_hor.dt_horario%type;
		EXIT WHEN NOT FOUND; /* apply on current_setting('cpoe_gerar_registro_json_pck.c02')::CURSOR */

			PERFORM set_config('cpoe_gerar_registro_json_pck.nr_hora_w', to_char(current_setting('cpoe_gerar_registro_json_pck.dt_horario_ww')::prescr_gasoterapia_hor.dt_horario%type,'hh24'), false);
			PERFORM set_config('cpoe_gerar_registro_json_pck.ds_hora_w', 'P', false);

			if (current_setting('cpoe_gerar_registro_json_pck.dt_fim_horario_w')::varchar(20) <> 'null') then
				PERFORM set_config('cpoe_gerar_registro_json_pck.ds_hora_w', 'S', false);
			end if;	

			if (current_setting('cpoe_gerar_registro_json_pck.dt_suspensao_w')::varchar(20)	<> 'null') then
				PERFORM set_config('cpoe_gerar_registro_json_pck.ds_hora_w', 'N', false);
			end if;

			CALL cpoe_gerar_registro_json_pck.cpoe_seta_status_horario(current_setting('cpoe_gerar_registro_json_pck.nr_hora_w')::integer, current_setting('cpoe_gerar_registro_json_pck.ds_hora_w')::varchar(255));

			if (current_setting('cpoe_gerar_registro_json_pck.dt_horario_fim_w')::cpoe_dieta.dt_fim%(type IS NOT NULL AND type::text <> '') and (current_setting('cpoe_gerar_registro_json_pck.dt_horario_fim_w')::cpoe_dieta.dt_fim%type between current_setting('cpoe_gerar_registro_json_pck.dt_hora_formatada_w')::timestamp	and	current_setting('cpoe_gerar_registro_json_pck.dt_hora_fim_formatada_w')::timestamp)) then
				begin
				CALL cpoe_gerar_registro_json_pck.cpoe_seta_status_fim_validade(current_setting('cpoe_gerar_registro_json_pck.dt_horario_fim_w')::cpoe_dieta.dt_fim%type);
				end;
			end if;

		end loop;
		close current_setting('cpoe_gerar_registro_json_pck.c02')::CURSOR;


		if (current_setting('cpoe_gerar_registro_json_pck.dt_inicio_w')::cpoe_dieta.dt_inicio%(type IS NOT NULL AND type::text <> '') and (current_setting('cpoe_gerar_registro_json_pck.dt_inicio_w')::cpoe_dieta.dt_inicio%type between current_setting('cpoe_gerar_registro_json_pck.dt_hora_formatada_w')::timestamp	and	current_setting('cpoe_gerar_registro_json_pck.dt_hora_fim_formatada_w')::timestamp)) then
			begin
			CALL cpoe_gerar_registro_json_pck.cpoe_seta_status_ini_validade(current_setting('cpoe_gerar_registro_json_pck.dt_inicio_w')::cpoe_dieta.dt_inicio%type);
			end;
		end if;


		begin
		if (current_setting('cpoe_gerar_registro_json_pck.dt_lib_suspensao_item_w')::cpoe_gasoterapia.dt_lib_suspensao%coalesce(type::text, '') = '') then
			PERFORM set_config('cpoe_gerar_registro_json_pck.dt_suspensao_item_w', null, false);
		end if;

			ds_json_rec_w := ds_json_rec_w || '{' ||
							format_array_json('CD_RECOMENDACAO',cd_recomendacao_w,1)  ||
							format_array_json('CD_INTERVALO',current_setting('cpoe_gerar_registro_json_pck.cd_intervalo_w')::prescr_gasoterapia.cd_intervalo%type,1)  ||
							format_array_json('DS_RECOMENDACAO', cpoe_gerar_registro_json_pck.remove_aspas(ds_recomendacao_w),1) ||
							format_array_json('DS_ITEM', cpoe_gerar_registro_json_pck.remove_aspas(ds_recomendacao_ww),1) ||
							format_array_json('DS_HORARIOS', current_setting('cpoe_gerar_registro_json_pck.ds_horarios_w')::prescr_gasoterapia.ds_horarios%type,1) ||
							format_array_json('DS_INTERVALO_GRID',cpoe_gerar_registro_json_pck.remove_aspas(current_setting('cpoe_gerar_registro_json_pck.ds_intervalo_w')::varchar(255)),1)   ||
							format_array_json('DS_RECOMENDACAO_GRID',current_setting('cpoe_gerar_registro_json_pck.ds_item_w')::varchar(1000),1)  ||							
							format_array_json('DT_LIBERACAO', to_char(current_setting('cpoe_gerar_registro_json_pck.dt_liberacao_w')::prescr_medica.dt_liberacao%type, 'dd/mm/yyyy hh24:mi:ss'),1) ||							
							format_array_json('DT_LIBERACAO_ENFERMAGEM', to_char(current_setting('cpoe_gerar_registro_json_pck.dt_liberacao_enfermagem_w')::prescr_medica.dt_liberacao%type, 'dd/mm/yyyy hh24:mi:ss'),1) ||
							format_array_json('DT_LIBERACAO_FARMACIA', to_char(current_setting('cpoe_gerar_registro_json_pck.dt_liberacao_farmacia_w')::prescr_medica.dt_liberacao_farmacia%type, 'dd/mm/yyyy hh24:mi:ss'),1) ||
							format_array_json('NM_USUARIO_LIB_ENFERMAGEM', current_setting('cpoe_gerar_registro_json_pck.nm_usuario_lib_enfermagem_w')::varchar(255),1) ||
							format_array_json('NM_USUARIO_LIB_FARMACIA', current_setting('cpoe_gerar_registro_json_pck.nm_usuario_lib_farmacia_w')::varchar(255),1) ||
							format_array_json('IE_MOMENTO_LOTE', current_setting('cpoe_gerar_registro_json_pck.ie_momento_lote_w')::regra_disp_lote_farm.ie_momento_lote%type,1) ||
							format_array_json('DT_ATUALIZACAO', current_setting('cpoe_gerar_registro_json_pck.dt_atualizacao_w')::prescr_gasoterapia.dt_atualizacao%type,1) ||
							format_array_json('DT_FIM', to_char(current_setting('cpoe_gerar_registro_json_pck.dt_fim_w')::cpoe_dieta.dt_fim%type, 'dd/mm/yyyy hh24:mi:ss'),1) ||
							format_array_json('DT_INICIO', to_char(current_setting('cpoe_gerar_registro_json_pck.dt_inicio_w')::cpoe_dieta.dt_inicio%type, 'dd/mm/yyyy hh24:mi:ss'),1) ||
							format_array_json('DT_INICIO_GRID', to_char(current_setting('cpoe_gerar_registro_json_pck.dt_inicio_grid_w')::timestamp, 'dd/mm/yyyy hh24:mi:ss'),1) ||
							format_array_json('DT_SUSPENSAO', to_char(current_setting('cpoe_gerar_registro_json_pck.dt_suspensao_item_w')::prescr_gasoterapia.dt_suspensao%type, 'dd/mm/yyyy hh24:mi:ss'),1) ||
							format_array_json('DT_LIB_SUSPENSAO', to_char(current_setting('cpoe_gerar_registro_json_pck.dt_lib_suspensao_item_w')::cpoe_gasoterapia.dt_lib_suspensao%type, 'dd/mm/yyyy hh24:mi:ss'),1) ||
							format_array_json('DT_DESCONTINUACAO', to_char(current_setting('cpoe_gerar_registro_json_pck.dt_suspensao_item_w')::prescr_gasoterapia.dt_suspensao%type, 'dd/mm/yyyy hh24:mi:ss'),1) ||
							format_array_json('NM_USUARIO_SUSP', current_setting('cpoe_gerar_registro_json_pck.nm_usuario_susp_w')::cpoe_dieta.nm_usuario_susp%type,1) ||
							format_array_json('NM_USUARIO_DESCONTINUCACAO', current_setting('cpoe_gerar_registro_json_pck.nm_usuario_descontinuacao_w')::varchar(255),1) ||
							format_array_json('DT_ATUALIZACAO_NREC', current_setting('cpoe_gerar_registro_json_pck.dt_atualizacao_nrec_w')::prescr_gasoterapia_evento.dt_atualizacao_nrec%type,1) ||
							format_array_json('HR_PRIM_HORARIO', current_setting('cpoe_gerar_registro_json_pck.hr_prim_horario_w')::varchar(5),1) ||
							format_array_json('IE_ACM', current_setting('cpoe_gerar_registro_json_pck.ie_acm_w')::varchar(1),1) ||
							format_array_json('IE_SE_NECESSARIO', current_setting('cpoe_gerar_registro_json_pck.ie_se_necessario_w')::varchar(1),1) ||
							format_array_json('IE_ADMINISTRACAO', current_setting('cpoe_gerar_registro_json_pck.ie_administracao_w')::cpoe_dieta.ie_administracao%type,1) ||
							format_array_json('IE_EVENTO_UNICO', current_setting('cpoe_gerar_registro_json_pck.ie_evento_unico_w')::cpoe_dieta.ie_evento_unico%type,1) ||
							format_array_json('IE_URGENCIA', current_setting('cpoe_gerar_registro_json_pck.ie_urgencia_w')::varchar(1),1) ||
							format_array_json('IE_DURACAO', current_setting('cpoe_gerar_registro_json_pck.ie_duracao_w')::cpoe_dieta.ie_duracao%type,1) ||
							format_array_json('NR_ATENDIMENTO', nr_atendimento_p,1) ||
							format_array_json('NR_SEQ_REC_CPOE', nr_seq_rec_cpoe_w,1) ||
							format_array_json('NM_USUARIO', current_setting('cpoe_gerar_registro_json_pck.nm_usuario_w')::prescr_gasoterapia.nm_usuario%type,1) ||
							format_array_json('NM_USUARIO_NREC', current_setting('cpoe_gerar_registro_json_pck.nm_usuario_nrec_w')::prescr_gasoterapia_evento.nm_usuario_nrec%type,1) ||
							format_array_json('NR_SEQ_TOPOGRAFIA', nr_seq_topografia_w,1) ||
							format_array_json('NR_OCORRENCIA', current_setting('cpoe_gerar_registro_json_pck.nr_ocorrencia_w')::cpoe_gasoterapia.nr_ocorrencia%type,1) ||
							format_array_json('DS_PRESCRITOR_DETALHE', cpoe_gerar_registro_json_pck.remove_aspas(current_setting('cpoe_gerar_registro_json_pck.ds_prescritor_w')::varchar(255)),1) ||
							format_array_json('DT_PRESCRITA_DETALHE', current_setting('cpoe_gerar_registro_json_pck.dt_prescrito_w')::varchar(255),1) ||
							format_array_json('DS_PREVIOUS_PRESCRIBER', cpoe_gerar_registro_json_pck.remove_aspas(current_setting('cpoe_gerar_registro_json_pck.ds_previous_prescriber_w')::varchar(255)),1) ||
							format_array_json('DT_PREVIOUS_PRESCRIBER', current_setting('cpoe_gerar_registro_json_pck.dt_previous_prescriber_w')::varchar(255),1) ||
							format_array_json('DS_CONSELHO', cpoe_gerar_registro_json_pck.remove_aspas(current_setting('cpoe_gerar_registro_json_pck.ds_conselho_w')::varchar(255)),1) ||	
							format_array_json('DS_PRESCRITOR', cpoe_gerar_registro_json_pck.remove_aspas(current_setting('cpoe_gerar_registro_json_pck.ds_prescritor_grid_w')::varchar(255)),1) ||
							format_array_json('DS_PRESCRITOR_REVAL', cpoe_gerar_registro_json_pck.remove_aspas(current_setting('cpoe_gerar_registro_json_pck.ds_prescritor_reval_w')::varchar(255)),1) ||
							format_array_json('NR_SEQ_VISAO', 21651,1) ||
							format_array_json('DS_HORA_00',current_setting('cpoe_gerar_registro_json_pck.ds_hora_00_w')::varchar(50),1)	||
							format_array_json('DS_HORA_01',current_setting('cpoe_gerar_registro_json_pck.ds_hora_01_w')::varchar(50),1)  ||
							format_array_json('DS_HORA_02',current_setting('cpoe_gerar_registro_json_pck.ds_hora_02_w')::varchar(50),1)  ||
							format_array_json('DS_HORA_03',current_setting('cpoe_gerar_registro_json_pck.ds_hora_03_w')::varchar(50),1)  ||
							format_array_json('DS_HORA_04',current_setting('cpoe_gerar_registro_json_pck.ds_hora_04_w')::varchar(50),1)  ||
							format_array_json('DS_HORA_05',current_setting('cpoe_gerar_registro_json_pck.ds_hora_05_w')::varchar(50),1)  ||
							format_array_json('DS_HORA_06',current_setting('cpoe_gerar_registro_json_pck.ds_hora_06_w')::varchar(50),1)  ||
							format_array_json('DS_HORA_07',current_setting('cpoe_gerar_registro_json_pck.ds_hora_07_w')::varchar(50),1)  ||
							format_array_json('DS_HORA_08',current_setting('cpoe_gerar_registro_json_pck.ds_hora_08_w')::varchar(50),1)  ||
							format_array_json('DS_HORA_09',current_setting('cpoe_gerar_registro_json_pck.ds_hora_09_w')::varchar(50),1)  ||
							format_array_json('DS_HORA_10',current_setting('cpoe_gerar_registro_json_pck.ds_hora_10_w')::varchar(50),1)  ||
							format_array_json('DS_HORA_11',current_setting('cpoe_gerar_registro_json_pck.ds_hora_11_w')::varchar(50),1)  ||
							format_array_json('DS_HORA_12',current_setting('cpoe_gerar_registro_json_pck.ds_hora_12_w')::varchar(50),1)  ||
							format_array_json('DS_HORA_13',current_setting('cpoe_gerar_registro_json_pck.ds_hora_13_w')::varchar(50),1)  ||
							format_array_json('DS_HORA_14',current_setting('cpoe_gerar_registro_json_pck.ds_hora_14_w')::varchar(50),1)  ||
							format_array_json('DS_HORA_15',current_setting('cpoe_gerar_registro_json_pck.ds_hora_15_w')::varchar(50),1)  ||
							format_array_json('DS_HORA_16',current_setting('cpoe_gerar_registro_json_pck.ds_hora_16_w')::varchar(50),1)  ||
							format_array_json('DS_HORA_17',current_setting('cpoe_gerar_registro_json_pck.ds_hora_17_w')::varchar(50),1)  ||
							format_array_json('DS_HORA_18',current_setting('cpoe_gerar_registro_json_pck.ds_hora_18_w')::varchar(50),1)  ||
							format_array_json('DS_HORA_19',current_setting('cpoe_gerar_registro_json_pck.ds_hora_19_w')::varchar(50),1)  ||
							format_array_json('DS_HORA_20',current_setting('cpoe_gerar_registro_json_pck.ds_hora_20_w')::varchar(50),1)  ||
							format_array_json('DS_HORA_21',current_setting('cpoe_gerar_registro_json_pck.ds_hora_21_w')::varchar(50),1)  ||
							format_array_json('DS_HORA_22',current_setting('cpoe_gerar_registro_json_pck.ds_hora_22_w')::varchar(50),1)  ||
							format_array_json('DS_HORA_23',current_setting('cpoe_gerar_registro_json_pck.ds_hora_23_w')::varchar(50),1)	||
							format_array_json('NR_SEQ_ASSINATURA',current_setting('cpoe_gerar_registro_json_pck.nr_seq_assinatura_w')::cpoe_gasoterapia.nr_seq_assinatura%type,1) ||
							format_array_json('DT_ASSINATURA_DIGITAL',to_char(current_setting('cpoe_gerar_registro_json_pck.dt_assinatura_digital_w')::tasy_assinatura_digital.dt_assinatura%type,'dd/mm/yyyy hh24:mi:ss'),1) ||
							format_array_json('NR_SEQ_CPOE_ORDER_UNIT',current_setting('cpoe_gerar_registro_json_pck.nr_seq_cpoe_order_unit_w')::cpoe_order_unit.nr_sequencia%type, 1);

						ds_json_rec_w := substr(ds_json_rec_w,1,length(ds_json_rec_w)-2) || '},';
		exception
		when others then
			CALL gravar_log_tasy(10007, ' REC_JSON_ZUADO: '
				|| ' nr_atendimento_p :' || nr_atendimento_p
				|| ' dt_referencia_p: ' || dt_referencia_p
				|| ' stack : ' || dbms_utility.format_call_stack
				|| ' erro: ' ||to_char(sqlerrm),
				nm_usuario_p);		
		end;

	end loop;
	close current_setting('cpoe_gerar_registro_json_pck.c01')::CURSOR;


	if (ds_json_rec_w IS NOT NULL AND ds_json_rec_w::text <> '') then
		begin	

		PERFORM set_config('cpoe_gerar_registro_json_pck.ds_registro_w', format_json('DS_RECOMENDACAO', ds_json_rec_w), false);

		CALL cpoe_gerar_registro_json_pck.cpoe_salvar_json( 	nr_atendimento_p,
							dt_referencia_p,
							nm_usuario_p,
							'R',
							current_setting('cpoe_gerar_registro_json_pck.ds_registro_w')::text);
		end;

	end if;

commit;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_gerar_registro_json_pck.cpoe_gerar_registro_rec_json ( nr_atendimento_p bigint, dt_referencia_p timestamp, nm_usuario_p text, nr_prescricao_p bigint default null) FROM PUBLIC;
