-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE cpoe_gerar_registro_json_pck.cpoe_gerar_registro_dial_json ( nr_atendimento_p bigint, nm_usuario_p text, dt_referencia_p timestamp, nr_prescricao_p bigint default null) AS $body$
DECLARE


current_setting('cpoe_gerar_registro_json_pck.ds_registro_w')::text				text;
ds_json_dialise_w			text;
ds_json_dialise_aux_w		text;
ds_json_solucao_w			text;
ds_json_components_w		text;

count_cpoe_dialise_w	 	bigint;
current_setting('cpoe_gerar_registro_json_pck.seq_w')::integer						integer;
seq_mat_w					integer;

current_setting('cpoe_gerar_registro_json_pck.ds_item_w')::varchar(1000)					varchar(500);
current_setting('cpoe_gerar_registro_json_pck.ds_item_ww')::varchar(1000)					varchar(500);
ds_tipo_peritoneal_w		varchar(255);
ds_tipo_hemodialise_w		varchar(255);
current_setting('cpoe_gerar_registro_json_pck.ds_prescritor_grid_w')::varchar(255)		varchar(255);
current_setting('cpoe_gerar_registro_json_pck.ds_prescritor_reval_w')::varchar(255)		varchar(255);
current_setting('cpoe_gerar_registro_json_pck.dt_prescrito_w')::varchar(255)				varchar(255);
current_setting('cpoe_gerar_registro_json_pck.ds_conselho_w')::varchar(255)				varchar(255);
current_setting('cpoe_gerar_registro_json_pck.ds_prescritor_w')::varchar(255)				varchar(255);
current_setting('cpoe_gerar_registro_json_pck.ds_previous_prescriber_w')::varchar(255)	varchar(255);
current_setting('cpoe_gerar_registro_json_pck.dt_previous_prescriber_w')::varchar(255)	varchar(255);
qt_hora_min_sessao_w		varchar(255);
qt_hora_min_duracao_w		varchar(255);
qt_hora_min_perm_w			varchar(255);
current_setting('cpoe_gerar_registro_json_pck.ds_hora_w')::varchar(255)					varchar(255);
current_setting('cpoe_gerar_registro_json_pck.nr_hora_w')::integer					bigint;
current_setting('cpoe_gerar_registro_json_pck.nm_usuario_descontinuacao_w')::varchar(255)	varchar(255);
ds_dias_semana_w			varchar(2000);

current_setting('cpoe_gerar_registro_json_pck.dt_inicio_grid_w')::timestamp			timestamp;

nr_seq_dialise_w			hd_prescricao.nr_sequencia%type;
ie_categoria_w				hd_prescricao.ie_categoria%type;
ie_tipo_hemodialise_w		hd_prescricao.ie_tipo_hemodialise%type;
qt_fluxo_sangue_w			hd_prescricao.qt_fluxo_sangue%type;
qt_sessao_sem_w				hd_prescricao.qt_sessao_sem%type;
qt_hora_sessao_w			hd_prescricao.qt_hora_sessao%type;
qt_min_sessao_w				hd_prescricao.qt_min_sessao%type;
nr_seq_mod_dialisador_w		hd_prescricao.nr_seq_mod_dialisador%type;
ie_cateter_w				hd_prescricao.ie_cateter%type;
qt_peso_pos_w				hd_prescricao.qt_peso_pos%type;
qt_peso_atual_w				hd_prescricao.qt_peso_atual%type;
qt_peso_ideal_w				hd_prescricao.qt_peso_ideal%type;
ie_ultrafiltracao_w			hd_prescricao.ie_ultrafiltracao%type;
qt_ultrafiltracao_w			hd_prescricao.qt_ultrafiltracao%type;
qt_ultrafiltracao_total_w	hd_prescricao.qt_ultrafiltracao_total%type;
nr_seq_diametro_agulha_w	hd_prescricao.nr_seq_diametro_agulha%type;
nr_seq_tipo_agulha_w		hd_prescricao.nr_seq_tipo_agulha%type;
nr_seq_tipo_agulha_art_w	hd_prescricao.nr_seq_tipo_agulha_art%type;
nr_seq_ultra_w				hd_prescricao.nr_seq_ultra%type;
nr_seq_perfil_sodio_w		hd_prescricao.nr_seq_perfil_sodio%type;
qt_zero_um_w				hd_prescricao.qt_zero_um%type;
qt_um_dois_w				hd_prescricao.qt_um_dois%type;
qt_dois_tres_w				hd_prescricao.qt_dois_tres%type;
qt_tres_quatro_w			hd_prescricao.qt_tres_quatro%type;
qt_seto_oito_w				hd_prescricao.qt_seto_oito%type;
qt_cinco_seis_w				hd_prescricao.qt_cinco_seis%type;	
nr_seq_perfil_bic_w			hd_prescricao.nr_seq_perfil_bic%type;	
qt_zero_um_bic_w			hd_prescricao.qt_zero_um_bic%type;
qt_um_dois_bic_w			hd_prescricao.qt_um_dois_bic%type;
qt_dois_tres_bic_w			hd_prescricao.qt_dois_tres_bic%type;
qt_tres_quatro_bic_w		hd_prescricao.qt_tres_quatro_bic%type;
qt_quatro_cinco_bic_w		hd_prescricao.qt_quatro_cinco_bic%type;
qt_cinco_seis_bic_w			hd_prescricao.qt_cinco_seis_bic%type;		
qt_sodio_w					hd_prescricao.qt_sodio%type;
qt_calcio_w					hd_prescricao.qt_calcio%type;
qt_bicarbonato_w			hd_prescricao.qt_bicarbonato%type;
ie_ligar_prime_w			hd_prescricao.ie_ligar_prime%type;
qt_volume_prime_w			hd_prescricao.qt_volume_prime%type;
current_setting('cpoe_gerar_registro_json_pck.ds_observacao_w')::prescr_gasoterapia.ds_observacao%type				hd_prescricao.ds_observacao%type;
dt_inicio_dialise_w			hd_prescricao.dt_inicio_dialise%type;
ie_tipo_peritoneal_w		hd_prescricao.ie_tipo_peritoneal%type;
nr_ciclos_w					hd_prescricao.nr_ciclos%type;
qt_volume_ciclo_w			hd_prescricao.qt_volume_ciclo%type;
qt_hora_duracao_w			hd_prescricao.qt_hora_duracao%type;
qt_min_duracao_w			hd_prescricao.qt_min_duracao%type;
dt_fim_dialise_w			hd_prescricao.dt_fim_dialise%type;
nr_seq_maq_cicladora_w		hd_prescricao.nr_seq_maq_cicladora%type;
nr_serie_w					hd_prescricao.nr_serie%type;
qt_volume_total_w			hd_prescricao.qt_volume_total%type;
qt_minimo_volume_w			hd_prescricao.qt_minimo_volume%type;
ie_perm_inteligente_w		hd_prescricao.ie_perm_inteligente%type;
ie_apagar_visor_w			hd_prescricao.ie_apagar_visor%type;
ie_volume_alarme_w			hd_prescricao.ie_volume_alarme%type;
ie_modo_dialise_w			hd_prescricao.ie_modo_dialise%type;
qt_tempo_min_drenagem_w		hd_prescricao.qt_tempo_min_drenagem%type;
qt_limite_uf_negativo_w		hd_prescricao.qt_limite_uf_negativo%type;
qt_limite_uf_positivo_w		hd_prescricao.qt_limite_uf_positivo%type;
ie_ausente_w				hd_prescricao.ie_ausente%type;
current_setting('cpoe_gerar_registro_json_pck.dt_atualizacao_w')::prescr_gasoterapia.dt_atualizacao%type			hd_prescricao.dt_atualizacao%type;
current_setting('cpoe_gerar_registro_json_pck.nm_usuario_w')::prescr_gasoterapia.nm_usuario%type				hd_prescricao.nm_usuario%type;
current_setting('cpoe_gerar_registro_json_pck.dt_atualizacao_nrec_w')::prescr_gasoterapia_evento.dt_atualizacao_nrec%type		hd_prescricao.dt_atualizacao_nrec%type;
current_setting('cpoe_gerar_registro_json_pck.nm_usuario_nrec_w')::prescr_gasoterapia_evento.nm_usuario_nrec%type			hd_prescricao.nm_usuario_nrec%type;	
current_setting('cpoe_gerar_registro_json_pck.nr_prescricao_w')::prescr_material.nr_prescricao%type				prescr_medica.nr_prescricao%type;
current_setting('cpoe_gerar_registro_json_pck.dt_liberacao_w')::prescr_medica.dt_liberacao%type				prescr_medica.dt_liberacao%type;
current_setting('cpoe_gerar_registro_json_pck.dt_liberacao_enfermagem_w')::prescr_medica.dt_liberacao%type	prescr_medica.dt_liberacao%type;
current_setting('cpoe_gerar_registro_json_pck.dt_liberacao_farmacia_w')::prescr_medica.dt_liberacao_farmacia%type		prescr_medica.dt_liberacao_farmacia%type;		
current_setting('cpoe_gerar_registro_json_pck.ie_momento_lote_w')::regra_disp_lote_farm.ie_momento_lote%type			regra_disp_lote_farm.ie_momento_lote%type;
current_setting('cpoe_gerar_registro_json_pck.nm_usuario_lib_enfermagem_w')::varchar(255)	varchar(255);
current_setting('cpoe_gerar_registro_json_pck.nm_usuario_lib_farmacia_w')::varchar(255)	varchar(255);	
current_setting('cpoe_gerar_registro_json_pck.dt_suspensao_item_w')::prescr_gasoterapia.dt_suspensao%type			prescr_solucao.dt_suspensao%type;
current_setting('cpoe_gerar_registro_json_pck.ie_bomba_infusao_w')::cpoe_material.ie_bomba_infusao%type			prescr_solucao.ie_bomba_infusao%type;
current_setting('cpoe_gerar_registro_json_pck.ie_tipo_solucao_w')::cpoe_material.ie_tipo_solucao%type			prescr_solucao.ie_tipo_solucao%type;
nr_seq_protocolo_w			prescr_solucao.nr_seq_protocolo%type;
current_setting('cpoe_gerar_registro_json_pck.qt_solucao_total_w')::cpoe_material.qt_solucao_total%type			prescr_solucao.qt_solucao_total%type;
current_setting('cpoe_gerar_registro_json_pck.qt_dosagem_w')::cpoe_material.qt_dosagem%type				prescr_solucao.qt_dosagem%type;
ie_unid_vel_inf_w			prescr_solucao.ie_unid_vel_inf%type;
current_setting('cpoe_gerar_registro_json_pck.qt_dose_ataque_w')::cpoe_material.qt_dose_ataque%type			prescr_solucao.qt_dose_ataque%type;
qt_temp_solucao_w			prescr_solucao.qt_temp_solucao%type;
current_setting('cpoe_gerar_registro_json_pck.nr_seq_solucao_w')::prescr_solucao.nr_seq_solucao%type			prescr_solucao.nr_seq_solucao%type;
current_setting('cpoe_gerar_registro_json_pck.ds_orientacao_w')::prescr_solucao.ds_orientacao%type				prescr_solucao.ds_orientacao%type;
hr_inicio_capd_w			prescr_solucao.hr_inicio_capd%type;
hr_fim_capd_w				prescr_solucao.hr_fim_capd%type;
pr_concentracao_w			prescr_solucao.pr_concentracao%type;
qt_hora_permanencia_w		prescr_solucao.qt_hora_permanencia%type;
qt_tempo_permanencia_w		prescr_solucao.qt_tempo_permanencia%type;
ie_lavar_linhas_w			prescr_solucao.ie_lavar_linhas%type;
ie_tidal_w					prescr_solucao.ie_tidal%type;
ie_ultima_bolsa_w			prescr_solucao.ie_ultima_bolsa%type;
current_setting('cpoe_gerar_registro_json_pck.ie_acm_w')::varchar(1)					prescr_solucao.ie_acm%type;
nr_seq_fabric_w				prescr_solucao.nr_seq_fabric%type;
qt_tempo_infusao_w			prescr_solucao.qt_tempo_infusao%type;
qt_tempo_perm_hor_w			prescr_solucao.qt_tempo_perm_hor%type;
qt_tempo_drenagem_w			prescr_solucao.qt_tempo_drenagem%type;
current_setting('cpoe_gerar_registro_json_pck.ds_horarios_w')::prescr_gasoterapia.ds_horarios%type				prescr_solucao.ds_horarios%type;
current_setting('cpoe_gerar_registro_json_pck.nr_etapas_w')::cpoe_material.nr_etapas%type					prescr_solucao.nr_etapas%type;
current_setting('cpoe_gerar_registro_json_pck.qt_volume_w')::cpoe_material.qt_volume%type					prescr_solucao.qt_volume%type;

current_setting('cpoe_gerar_registro_json_pck.cd_material_w')::cpoe_material.cd_material%type				prescr_material.cd_material%type;
cd_unid_med_w				prescr_material.cd_unidade_medida_dose%type;
current_setting('cpoe_gerar_registro_json_pck.qt_dose_w')::cpoe_material.qt_dose%type					prescr_material.qt_dose%type;

current_setting('cpoe_gerar_registro_json_pck.dt_horario_w')::prescr_mat_hor.dt_horario%type				hd_prescricao.dt_inicio_dialise%type;
current_setting('cpoe_gerar_registro_json_pck.dt_suspensao_w')::varchar(20)				prescr_solucao.dt_suspensao%type;
ie_status_w					prescr_solucao.ie_status%type;

nr_seq_dialise_cpoe_w		cpoe_dialise.nr_sequencia%type;
ie_tipo_dialise_w			cpoe_dialise.ie_tipo_dialise%type;
ie_hemodialise_w			cpoe_dialise.ie_hemodialise%type;
current_setting('cpoe_gerar_registro_json_pck.ie_duracao_w')::cpoe_dieta.ie_duracao%type				cpoe_dialise.ie_duracao%type;
current_setting('cpoe_gerar_registro_json_pck.nm_usuario_susp_w')::cpoe_dieta.nm_usuario_susp%type			cpoe_dialise.nm_usuario%type;
current_setting('cpoe_gerar_registro_json_pck.dt_lib_suspensao_item_w')::cpoe_gasoterapia.dt_lib_suspensao%type		cpoe_dialise.dt_lib_suspensao%type;
qt_pre_reposicao_w			cpoe_dialise.qt_pre_reposicao%type;
qt_pos_reposicao_w			cpoe_dialise.qt_pos_reposicao%type;

ie_segunda_w				cpoe_dialise.ie_segunda%type;
ie_terca_w					cpoe_dialise.ie_terca%type;
ie_quarta_w					cpoe_dialise.ie_quarta%type;
ie_quinta_w					cpoe_dialise.ie_quinta%type;
ie_sexta_w					cpoe_dialise.ie_sexta%type;
ie_sabado_w					cpoe_dialise.ie_sabado%type;
ie_domingo_w				cpoe_dialise.ie_domingo%type;

current_setting('cpoe_gerar_registro_json_pck.nr_seq_assinatura_w')::cpoe_gasoterapia.nr_seq_assinatura%type			cpoe_dialise.nr_seq_assinatura%type;
current_setting('cpoe_gerar_registro_json_pck.dt_assinatura_digital_w')::tasy_assinatura_digital.dt_assinatura%type		tasy_assinatura_digital.dt_assinatura%type;
current_setting('cpoe_gerar_registro_json_pck.nr_seq_cpoe_order_unit_w')::cpoe_order_unit.nr_sequencia%type        cpoe_order_unit.nr_sequencia%type;

current_setting('cpoe_gerar_registro_json_pck.c01')::CURSOR CURSOR FOR
	SELECT	distinct a.ie_categoria,
		a.ie_tipo_hemodialise,
		a.qt_fluxo_sangue,
		a.qt_sessao_sem,
		a.qt_hora_min_sessao,
		a.nr_seq_mod_dialisador,
		a.ie_cateter,
		a.qt_pre_reposicao,
		a.qt_pos_reposicao,
		a.qt_peso_pos,
		a.qt_peso_atual,
		a.qt_peso_ideal,
		a.ie_ultrafiltracao,
		a.qt_ultrafiltracao,
		a.qt_ultrafiltracao_total,
		a.nr_seq_diametro_agulha,
		a.nr_seq_tipo_agulha,
		a.nr_seq_tipo_agulha_art,
		a.nr_seq_ultra,
		a.nr_seq_perfil_sodio,
		a.qt_zero_um,
		a.qt_um_dois,
		a.qt_dois_tres,
		a.qt_tres_quatro,
		a.qt_quatro_cinco,
		a.qt_cinco_seis,
		a.nr_seq_perfil_bic,
		a.qt_zero_um_bic,
		a.qt_um_dois_bic,
		a.qt_dois_tres_bic,
		a.qt_tres_quatro_bic,
		a.qt_quatro_cinco_bic,
		a.qt_cinco_seis_bic,
		a.qt_sodio,
		a.qt_calcio,
		a.qt_bicarbonato,
		a.ie_ligar_prime,
		a.qt_volume_prime,
		a.ds_observacao,
		a.ie_tipo_dialise,
		a.ie_tipo_peritoneal,--Perit
		a.nr_ciclos,
		a.qt_volume_ciclo,
		a.qt_hora_min_duracao,
		a.dt_inicio,
		a.dt_fim,
		a.nr_seq_maq_cicladora,
		a.nr_serie,
		a.qt_volume_total_di,
		a.qt_minimo_volume,
		a.ie_perm_inteligente,
		a.ie_apagar_visor,
		a.ie_volume_alarme,
		a.ie_modo_dialise,
		a.qt_tempo_min_drenagem,
		a.qt_limite_uf_negativo,
		a.qt_limite_uf_positivo,
		a.ie_ausente,
		a.dt_atualizacao,
		a.nm_usuario,
		a.dt_atualizacao_nrec,
		a.nm_usuario_nrec,
		a.dt_liberacao,
		a.dt_suspensao,
		a.dt_lib_suspensao,
		a.nr_sequencia,
		a.ie_hemodialise,
		a.ie_duracao,
		a.ie_segunda,
		a.ie_terca,
		a.ie_quarta,	
		a.ie_quinta,	
		a.ie_sexta,	
		a.ie_sabado,	
		a.ie_domingo,
		a.nr_seq_assinatura,
		a.nr_seq_cpoe_order_unit
	from	cpoe_dialise a,
		hd_prescricao b,
		prescr_solucao e,
		prescr_medica  d
	where	a.nr_atendimento = nr_atendimento_p
	and	a.dt_prox_geracao > dt_hora_formatada_w - 1
	and	(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
	and a.nr_sequencia = coalesce(b.nr_seq_dialise_cpoe, e.nr_seq_dialise_cpoe)
	and	b.nr_sequencia = e.nr_seq_dialise
	and	b.nr_prescricao = e.nr_prescricao
	and	b.nr_prescricao = d.nr_prescricao
	and coalesce(a.ie_tipo_dialise,'DI') in ('DI','DP')
	and	((coalesce(nr_prescricao_p,0) = 0) or (d.nr_prescricao = nr_prescricao_p))
	and d.dt_prescricao between dt_hora_formatada_w and dt_hora_fim_formatada_w;

current_setting('cpoe_gerar_registro_json_pck.c02')::CURSOR CURSOR FOR
	SELECT	c.ie_bomba_infusao,
			c.ie_tipo_solucao,
			c.nr_seq_protocolo,
			c.qt_solucao_total,
			c.qt_dosagem,
			c.ie_unid_vel_inf,
			c.qt_dose_ataque,
			c.qt_temp_solucao,
			c.nr_seq_solucao,
			c.ds_orientacao,
			c.hr_inicio_capd,
			c.hr_fim_capd,
			c.pr_concentracao,
			c.qt_hora_permanencia,
			c.qt_tempo_permanencia,
			c.ie_lavar_linhas,
			c.ie_tidal,
			c.ie_ultima_bolsa,
			c.ie_acm,
			c.nr_seq_fabric,
			c.qt_tempo_infusao,
			c.qt_tempo_perm_hor,
			c.qt_tempo_drenagem,
			c.ds_horarios,
			c.nr_etapas,
			c.qt_volume,
			c.nr_prescricao,
			row_number() OVER () AS rownum
	from	hd_prescricao a,
			prescr_medica b,
			prescr_solucao c,
			cpoe_dialise d
	where	a.nr_prescricao		= b.nr_prescricao
	and		c.nr_seq_dialise	= a.nr_sequencia
	and		c.nr_prescricao		= a.nr_prescricao
	and		c.nr_prescricao     = b.nr_prescricao
	and		d.nr_sequencia 		= coalesce(a.nr_seq_dialise_cpoe,c.nr_seq_dialise_cpoe)
	and		b.nr_atendimento	= d.nr_atendimento
	and		d.nr_sequencia	= nr_seq_dialise_cpoe_w
	and		(d.dt_liberacao IS NOT NULL AND d.dt_liberacao::text <> '')
	and		coalesce(d.ie_tipo_dialise,'DI') in ('DI','DP')
	and		b.dt_prescricao	between dt_hora_formatada_w	and	dt_hora_fim_formatada_w
	order by	c.nr_seq_solucao LIMIT 5;

current_setting('cpoe_gerar_registro_json_pck.c03')::CURSOR CURSOR FOR
SELECT	cd_material,
		cd_unidade_medida_dose,
		qt_dose,
		row_number() OVER () AS rownum
from	prescr_material
where	ie_agrupador		= 13
and		nr_sequencia_solucao	= current_setting('cpoe_gerar_registro_json_pck.nr_seq_solucao_w')::prescr_solucao.nr_seq_solucao%type
and		nr_prescricao		= current_setting('cpoe_gerar_registro_json_pck.nr_prescricao_w')::prescr_material.nr_prescricao%type 
order by	nr_sequencia LIMIT 7;

current_setting('cpoe_gerar_registro_json_pck.c04')::CURSOR CURSOR FOR
	SELECT	c.dt_inicio_dialise dt_horario,
			b.dt_suspensao,
			b.ie_status
	from	prescr_medica a,
			prescr_solucao b,
			hd_prescricao c, 
			cpoe_dialise d
	where 	a.nr_atendimento = nr_atendimento_p
	and 	c.nr_seq_dialise_cpoe  = nr_seq_dialise_cpoe_w
	and		a.nr_prescricao = b.nr_prescricao 
	and		b.nr_prescricao = c.nr_prescricao 
	and		b.nr_seq_dialise = c.nr_sequencia 
	and		c.dt_inicio_dialise between dt_hora_formatada_w	and	dt_hora_fim_formatada_w
	and 	d.nr_atendimento = a.nr_atendimento
	and 	d.nr_sequencia = c.nr_seq_dialise_cpoe
	order by 
			b.dt_status;


BEGIN

open current_setting('cpoe_gerar_registro_json_pck.c01')::CURSOR;
loop
fetch current_setting('cpoe_gerar_registro_json_pck.c01')::into CURSOR
	ie_categoria_w,
	ie_tipo_hemodialise_w,
	qt_fluxo_sangue_w,
	qt_sessao_sem_w,
	qt_hora_min_sessao_w,
	nr_seq_mod_dialisador_w,
	ie_cateter_w,
	qt_pre_reposicao_w,
	qt_pos_reposicao_w,
	qt_peso_pos_w,
	qt_peso_atual_w,
	qt_peso_ideal_w,
	ie_ultrafiltracao_w,
	qt_ultrafiltracao_w,
	qt_ultrafiltracao_total_w,
	nr_seq_diametro_agulha_w,
	nr_seq_tipo_agulha_w,
	nr_seq_tipo_agulha_art_w,
	nr_seq_ultra_w,
	nr_seq_perfil_sodio_w,
	qt_zero_um_w,
	qt_um_dois_w,
	qt_dois_tres_w,
	qt_tres_quatro_w,
	qt_seto_oito_w,
	qt_cinco_seis_w,
	nr_seq_perfil_bic_w,
	qt_zero_um_bic_w,
	qt_um_dois_bic_w,
	qt_dois_tres_bic_w,
	qt_tres_quatro_bic_w,
	qt_quatro_cinco_bic_w,
	qt_cinco_seis_bic_w,
	qt_sodio_w,
	qt_calcio_w,
	qt_bicarbonato_w,
	ie_ligar_prime_w,
	qt_volume_prime_w,
	current_setting('cpoe_gerar_registro_json_pck.ds_observacao_w')::prescr_gasoterapia.ds_observacao%type,
	ie_tipo_dialise_w,
	ie_tipo_peritoneal_w, -- Perit
	nr_ciclos_w,
	qt_volume_ciclo_w,
	qt_hora_min_duracao_w,
	dt_inicio_dialise_w,
	dt_fim_dialise_w,
	nr_seq_maq_cicladora_w,
	nr_serie_w,
	qt_volume_total_w,
	qt_minimo_volume_w,
	ie_perm_inteligente_w,
	ie_apagar_visor_w,
	ie_volume_alarme_w,
	ie_modo_dialise_w,
	qt_tempo_min_drenagem_w,
	qt_limite_uf_negativo_w,
	qt_limite_uf_positivo_w,
	ie_ausente_w,
	current_setting('cpoe_gerar_registro_json_pck.dt_atualizacao_w')::prescr_gasoterapia.dt_atualizacao%type,
	current_setting('cpoe_gerar_registro_json_pck.nm_usuario_w')::prescr_gasoterapia.nm_usuario%type,
	current_setting('cpoe_gerar_registro_json_pck.dt_atualizacao_nrec_w')::prescr_gasoterapia_evento.dt_atualizacao_nrec%type,
	current_setting('cpoe_gerar_registro_json_pck.nm_usuario_nrec_w')::prescr_gasoterapia_evento.nm_usuario_nrec%type,
	current_setting('cpoe_gerar_registro_json_pck.dt_liberacao_w')::prescr_medica.dt_liberacao%type,
	current_setting('cpoe_gerar_registro_json_pck.dt_suspensao_item_w')::prescr_gasoterapia.dt_suspensao%type,
	current_setting('cpoe_gerar_registro_json_pck.dt_lib_suspensao_item_w')::cpoe_gasoterapia.dt_lib_suspensao%type,
	nr_seq_dialise_cpoe_w,
	ie_hemodialise_w,
	current_setting('cpoe_gerar_registro_json_pck.ie_duracao_w')::cpoe_dieta.ie_duracao%type,
	ie_segunda_w,
	ie_terca_w,
	ie_quarta_w,	
	ie_quinta_w,	
	ie_sexta_w,	
	ie_sabado_w,	
	ie_domingo_w,
	current_setting('cpoe_gerar_registro_json_pck.nr_seq_assinatura_w')::cpoe_gasoterapia.nr_seq_assinatura%type,
	current_setting('cpoe_gerar_registro_json_pck.nr_seq_cpoe_order_unit_w')::cpoe_order_unit.nr_sequencia%type;
EXIT WHEN NOT FOUND; /* apply on current_setting('cpoe_gerar_registro_json_pck.c01')::CURSOR */
	CALL cpoe_gerar_registro_json_pck.cpoe_limpar_valores_horas();

	PERFORM set_config('cpoe_gerar_registro_json_pck.dt_suspensao_item_w', cpoe_gerar_registro_json_pck.regra_data_susp(current_setting('cpoe_gerar_registro_json_pck.dt_suspensao_item_w')::prescr_gasoterapia.dt_suspensao%type), false);
	PERFORM set_config('cpoe_gerar_registro_json_pck.dt_lib_suspensao_item_w', cpoe_gerar_registro_json_pck.regra_data_susp(current_setting('cpoe_gerar_registro_json_pck.dt_lib_suspensao_item_w')::cpoe_gasoterapia.dt_lib_suspensao%type), false);
	ds_tipo_hemodialise_w := substr(obter_valor_dominio(1934,ie_tipo_hemodialise_w),1,255);

	open current_setting('cpoe_gerar_registro_json_pck.c04')::CURSOR;
		loop
		fetch current_setting('cpoe_gerar_registro_json_pck.c04')::into CURSOR
			current_setting('cpoe_gerar_registro_json_pck.dt_horario_w')::prescr_mat_hor.dt_horario%type,
			current_setting('cpoe_gerar_registro_json_pck.dt_suspensao_w')::varchar(20),
			ie_status_w;
		EXIT WHEN NOT FOUND; /* apply on current_setting('cpoe_gerar_registro_json_pck.c04')::CURSOR */

			PERFORM set_config('cpoe_gerar_registro_json_pck.nr_hora_w', to_char(current_setting('cpoe_gerar_registro_json_pck.dt_horario_w')::prescr_mat_hor.dt_horario%type,'hh24'), false);
			PERFORM set_config('cpoe_gerar_registro_json_pck.ds_hora_w', 'P', false);

			if (ie_status_w = 'T') then
				PERFORM set_config('cpoe_gerar_registro_json_pck.ds_hora_w', 'S', false);
			end if;	

			if (current_setting('cpoe_gerar_registro_json_pck.dt_suspensao_w')::(varchar(20) IS NOT NULL AND (varchar(20))::text <> '')) then
				PERFORM set_config('cpoe_gerar_registro_json_pck.ds_hora_w', 'N', false);
			end if;

			CALL cpoe_gerar_registro_json_pck.cpoe_seta_status_horario(current_setting('cpoe_gerar_registro_json_pck.nr_hora_w')::integer, current_setting('cpoe_gerar_registro_json_pck.ds_hora_w')::varchar(255));

		end loop;
	close current_setting('cpoe_gerar_registro_json_pck.c04')::CURSOR;

	select count(*)
	into STRICT   count_cpoe_dialise_w
	from   cpoe_dialise
	where  nr_sequencia = nr_seq_dialise_cpoe_w;

	if (ie_tipo_dialise_w = 'DI') then
		PERFORM set_config('cpoe_gerar_registro_json_pck.ds_item_w', ds_tipo_hemodialise_w, false);
	else
		PERFORM set_config('cpoe_gerar_registro_json_pck.ds_item_w', ds_tipo_peritoneal_w, false);
	end if;

	ds_json_solucao_w := '';
	ds_json_dialise_aux_w := '';

	if (count_cpoe_dialise_w > 0) then
		begin
		select	replace(CPOE_Obter_desc_dialise( ie_tipo_dialise, nr_seq_protocolo, cpoe_gerar_registro_json_pck.regra_data_susp(dt_lib_suspensao), cpoe_gerar_registro_json_pck.regra_data_susp(dt_suspensao), qt_fluxo_sangue, qt_hora_min_sessao, 'S',
		ie_hemodialise, ie_tipo_peritoneal, qt_volume_ciclo, qt_hora_min_duracao, ie_categoria,null,null,null,'N',null,obter_horarios_regra(ds_horarios)),'"','@#'),
			dt_liberacao,
			obter_nome_medico(obter_pf_usuario(nm_usuario_nrec,'C'),'PMS') ds_prescritor,
			cpoe_obter_tempo_prescrito(coalesce(dt_atualizacao_nrec, dt_inicio)) dt_prescrito,
			cpoe_get_prior_prescriber(nr_seq_cpoe_anterior, 'CPOE_DIALISE', 'N'),
			cpoe_get_prior_prescriber(nr_seq_cpoe_anterior, 'CPOE_DIALISE', 'D'),
			cpoe_obter_data_hora_form(dt_inicio,TO_CHAR(dt_inicio,'hh24:mi:ss')) dt_inicio_grid,				
			substr(obter_dados_pf(obter_pf_usuario(nm_usuario_nrec,'C'),'COPR'),1,255) ds_conselho,
			obter_nome_pf(obter_pf_usuario(nm_usuario_nrec,'C')) ds_prescritor_grid,
			dt_liberacao_enf dt_liberacao_enfermagem,
			dt_liberacao_farm dt_liberacao_farmacia,
			nm_usuario_lib_enf nm_usuario_lib_enfermagem,
			nm_usuario_lib_farm nm_usuario_lib_farmacia,
			CASE WHEN coalesce(cpoe_gerar_registro_json_pck.regra_data_susp(dt_suspensao)::text, '') = '' THEN  null  ELSE nm_usuario_susp END ,
			CASE WHEN coalesce(cpoe_gerar_registro_json_pck.regra_data_susp(dt_suspensao)::text, '') = '' THEN  null  ELSE cpoe_obter_info_suspensao(nr_sequencia,'P','N') END  nm_usuario_descontinuacao,
			cpoe_obter_momento_lote(ie_motivo_prescricao, cd_setor_atendimento, obter_estabelecimento_setor(cd_setor_atendimento), 'N', 'CPOE_DIALISE', nr_sequencia, null, null, null) ie_momento_lote,
			cpoe_obter_desc_dialise_simp(ie_tipo_dialise, ie_hemodialise, ie_tipo_peritoneal) ds_item,
			substr(obter_valor_dominio(2154,ie_tipo_peritoneal),1,255),
			cpoe_gerar_registro_json_pck.remove_aspas(cpoe_obter_dias_semana(nr_sequencia, 'DI')),
			obter_data_assinatura_digital(nr_seq_assinatura),
			obter_pf_usuario(coalesce(nm_usuario, nm_usuario_nrec),'N') ds_prescritor_reval
		into STRICT	current_setting('cpoe_gerar_registro_json_pck.ds_item_w')::varchar(1000),
			current_setting('cpoe_gerar_registro_json_pck.dt_liberacao_w')::prescr_medica.dt_liberacao%type,
			current_setting('cpoe_gerar_registro_json_pck.ds_prescritor_w')::varchar(255),
			current_setting('cpoe_gerar_registro_json_pck.dt_prescrito_w')::varchar(255),
			current_setting('cpoe_gerar_registro_json_pck.ds_previous_prescriber_w')::varchar(255),
			current_setting('cpoe_gerar_registro_json_pck.dt_previous_prescriber_w')::varchar(255),
			current_setting('cpoe_gerar_registro_json_pck.dt_inicio_grid_w')::timestamp,
			current_setting('cpoe_gerar_registro_json_pck.ds_conselho_w')::varchar(255),
			current_setting('cpoe_gerar_registro_json_pck.ds_prescritor_grid_w')::varchar(255),
			current_setting('cpoe_gerar_registro_json_pck.dt_liberacao_enfermagem_w')::prescr_medica.dt_liberacao%type,
			current_setting('cpoe_gerar_registro_json_pck.dt_liberacao_farmacia_w')::prescr_medica.dt_liberacao_farmacia%type,
			current_setting('cpoe_gerar_registro_json_pck.nm_usuario_lib_enfermagem_w')::varchar(255),					
			current_setting('cpoe_gerar_registro_json_pck.nm_usuario_lib_farmacia_w')::varchar(255),
			current_setting('cpoe_gerar_registro_json_pck.nm_usuario_susp_w')::cpoe_dieta.nm_usuario_susp%type,
			current_setting('cpoe_gerar_registro_json_pck.nm_usuario_descontinuacao_w')::varchar(255),
			current_setting('cpoe_gerar_registro_json_pck.ie_momento_lote_w')::regra_disp_lote_farm.ie_momento_lote%type,
			current_setting('cpoe_gerar_registro_json_pck.ds_item_ww')::varchar(1000),
			ds_tipo_peritoneal_w,
			ds_dias_semana_w,
			current_setting('cpoe_gerar_registro_json_pck.dt_assinatura_digital_w')::tasy_assinatura_digital.dt_assinatura%type,
			current_setting('cpoe_gerar_registro_json_pck.ds_prescritor_reval_w')::varchar(255)
		from	cpoe_dialise
		where	nr_sequencia = nr_seq_dialise_cpoe_w;

		end;
	end if;

	open current_setting('cpoe_gerar_registro_json_pck.c02')::CURSOR;
	loop
	fetch current_setting('cpoe_gerar_registro_json_pck.c02')::into CURSOR	
			current_setting('cpoe_gerar_registro_json_pck.ie_bomba_infusao_w')::cpoe_material.ie_bomba_infusao%type,
			current_setting('cpoe_gerar_registro_json_pck.ie_tipo_solucao_w')::cpoe_material.ie_tipo_solucao%type,
			nr_seq_protocolo_w,
			current_setting('cpoe_gerar_registro_json_pck.qt_solucao_total_w')::cpoe_material.qt_solucao_total%type,
			current_setting('cpoe_gerar_registro_json_pck.qt_dosagem_w')::cpoe_material.qt_dosagem%type,
			ie_unid_vel_inf_w,
			current_setting('cpoe_gerar_registro_json_pck.qt_dose_ataque_w')::cpoe_material.qt_dose_ataque%type,
			qt_temp_solucao_w,
			current_setting('cpoe_gerar_registro_json_pck.nr_seq_solucao_w')::prescr_solucao.nr_seq_solucao%type,
			current_setting('cpoe_gerar_registro_json_pck.ds_orientacao_w')::prescr_solucao.ds_orientacao%type,
			hr_inicio_capd_w,
			hr_fim_capd_w,
			pr_concentracao_w,
			qt_hora_permanencia_w,
			qt_tempo_permanencia_w,
			ie_lavar_linhas_w,
			ie_tidal_w,
			ie_ultima_bolsa_w,
			current_setting('cpoe_gerar_registro_json_pck.ie_acm_w')::varchar(1),
			nr_seq_fabric_w,
			qt_tempo_infusao_w,
			qt_tempo_perm_hor_w,
			qt_tempo_drenagem_w,
			current_setting('cpoe_gerar_registro_json_pck.ds_horarios_w')::prescr_gasoterapia.ds_horarios%type,
			current_setting('cpoe_gerar_registro_json_pck.nr_etapas_w')::cpoe_material.nr_etapas%type,
			current_setting('cpoe_gerar_registro_json_pck.qt_volume_w')::cpoe_material.qt_volume%type,
			current_setting('cpoe_gerar_registro_json_pck.nr_prescricao_w')::prescr_material.nr_prescricao%type,
			current_setting('cpoe_gerar_registro_json_pck.seq_w')::integer;
	EXIT WHEN NOT FOUND; /* apply on current_setting('cpoe_gerar_registro_json_pck.c02')::CURSOR */
		begin

			qt_hora_min_perm_w := obter_horas_minutos(qt_tempo_permanencia_w + (qt_hora_permanencia_w * 60));
			ds_json_components_w := '';

			open current_setting('cpoe_gerar_registro_json_pck.c03')::CURSOR;
			loop
			fetch current_setting('cpoe_gerar_registro_json_pck.c03')::into CURSOR	
				current_setting('cpoe_gerar_registro_json_pck.cd_material_w')::cpoe_material.cd_material%type,
				cd_unid_med_w,
				current_setting('cpoe_gerar_registro_json_pck.qt_dose_w')::cpoe_material.qt_dose%type,
				seq_mat_w;
			EXIT WHEN NOT FOUND; /* apply on current_setting('cpoe_gerar_registro_json_pck.c03')::CURSOR */
				begin

					ds_json_components_w := ds_json_components_w || '{' ||  	format_array_json('CD_MAT_SOLUC'||seq_mat_w, current_setting('cpoe_gerar_registro_json_pck.cd_material_w')::cpoe_material.cd_material%type,1)		||
																				format_array_json('QT_DOSE_SOLUC'||seq_mat_w, current_setting('cpoe_gerar_registro_json_pck.qt_dose_w')::cpoe_material.qt_dose%type,1)			||
																				format_array_json('CD_UNID_MED_DOSE_SOL'||seq_mat_w, cd_unid_med_w,1);

					ds_json_components_w := substr(ds_json_components_w,1,length(ds_json_components_w)-2) || '},';

					if (seq_mat_w = 7) then
						exit;
					end if;

				end;
			end loop;
			close current_setting('cpoe_gerar_registro_json_pck.c03')::CURSOR;

			ds_json_solucao_w := ds_json_solucao_w || '{' ||  	format_array_json('IE_TIPO_SOLUCAO'||current_setting('cpoe_gerar_registro_json_pck.seq_w')::integer, current_setting('cpoe_gerar_registro_json_pck.ie_tipo_solucao_w')::cpoe_material.ie_tipo_solucao%type,1)        ||
																format_array_json('NR_SEQ_PROTOCOLO'||current_setting('cpoe_gerar_registro_json_pck.seq_w')::integer, nr_seq_protocolo_w,1)		||
																format_array_json('IE_BOMBA_INFUSAO'||current_setting('cpoe_gerar_registro_json_pck.seq_w')::integer, current_setting('cpoe_gerar_registro_json_pck.ie_bomba_infusao_w')::cpoe_material.ie_bomba_infusao%type,1)	    ||
																format_array_json('QT_SOLUCAO_TOTAL'||current_setting('cpoe_gerar_registro_json_pck.seq_w')::integer, current_setting('cpoe_gerar_registro_json_pck.qt_solucao_total_w')::cpoe_material.qt_solucao_total%type,1)	    ||
																format_array_json('QT_DOSAGEM'||current_setting('cpoe_gerar_registro_json_pck.seq_w')::integer, current_setting('cpoe_gerar_registro_json_pck.qt_dosagem_w')::cpoe_material.qt_dosagem%type,1) 	                ||
																format_array_json('IE_UNID_VEL_INF'||current_setting('cpoe_gerar_registro_json_pck.seq_w')::integer, ie_unid_vel_inf_w,1)	    ||
																format_array_json('QT_TEMP_SOLUCAO'||current_setting('cpoe_gerar_registro_json_pck.seq_w')::integer, qt_temp_solucao_w,1)		||
																format_array_json('QT_DOSE_ATAQUE'||current_setting('cpoe_gerar_registro_json_pck.seq_w')::integer, current_setting('cpoe_gerar_registro_json_pck.qt_dose_ataque_w')::cpoe_material.qt_dose_ataque%type,1)			||
																format_array_json('NR_ETAPAS'||current_setting('cpoe_gerar_registro_json_pck.seq_w')::integer, current_setting('cpoe_gerar_registro_json_pck.nr_etapas_w')::cpoe_material.nr_etapas%type,1) 				    ||
																format_array_json('QT_VOLUME_SOL'||current_setting('cpoe_gerar_registro_json_pck.seq_w')::integer, current_setting('cpoe_gerar_registro_json_pck.qt_volume_w')::cpoe_material.qt_volume%type,1)                ||
																format_array_json('PR_CONCENTRACAO'||current_setting('cpoe_gerar_registro_json_pck.seq_w')::integer, pr_concentracao_w,1)		||
																format_array_json('QT_TEMPO_INFUSAO'||current_setting('cpoe_gerar_registro_json_pck.seq_w')::integer, qt_tempo_infusao_w,1)		||
																format_array_json('QT_TEMPO_PERMANENCIA'||current_setting('cpoe_gerar_registro_json_pck.seq_w')::integer, qt_hora_min_perm_w,1)	||
																format_array_json('QT_TEMPO_DRENAGEM'||current_setting('cpoe_gerar_registro_json_pck.seq_w')::integer, qt_tempo_drenagem_w,1)	||
																format_array_json('IE_LAVAR_LINHAS'||current_setting('cpoe_gerar_registro_json_pck.seq_w')::integer, ie_lavar_linhas_w,1)		||
																format_array_json('IE_TIDAL'||current_setting('cpoe_gerar_registro_json_pck.seq_w')::integer, ie_tidal_w,1)						||
																format_array_json('IE_ULTIMA_BOLSA'||current_setting('cpoe_gerar_registro_json_pck.seq_w')::integer, ie_ultima_bolsa_w,1)		||
																format_array_json('DS_COMPONENTES', obter_array_json('DS_COMPONENTES', ds_json_components_w),2);

			ds_json_solucao_w := substr(ds_json_solucao_w,1,length(ds_json_solucao_w)-2) || '},';
			if (current_setting('cpoe_gerar_registro_json_pck.seq_w')::integer = 5) then
				exit;
			end if;
		end;
	end loop;
	close current_setting('cpoe_gerar_registro_json_pck.c02')::CURSOR;

	if (ie_tipo_dialise_w = 'DI') then
		ds_json_dialise_aux_w :=	ds_json_dialise_aux_w || '{'||
									format_array_json('IE_HEMODIALISE',ie_hemodialise_w,1)					||
									format_array_json('IE_CATEGORIA',ie_categoria_w,1)			||
									format_array_json('IE_TIPO_HEMODIALISE',ie_tipo_hemodialise_w,1)	||
									format_array_json('QT_FLUXO_SANGUE',qt_fluxo_sangue_w,1)			||
									format_array_json('QT_SESSAO_SEM',qt_sessao_sem_w,1)		||
									format_array_json('QT_HORA_MIN_SESSAO',qt_hora_min_sessao_w,1) 		||
									format_array_json('NR_SEQ_MOD_DIALISADOR',nr_seq_mod_dialisador_w,1)	||
									format_array_json('IE_CATETER',ie_cateter_w,1)				||
									format_array_json('QT_PRE_REPOSICAO',qt_pre_reposicao_w,1)				||
									format_array_json('QT_POS_REPOSICAO',qt_pos_reposicao_w,1)				||
									format_array_json('NR_SEQ_DIAMETRO_AGULHA',nr_seq_diametro_agulha_w,1)	||
									format_array_json('NR_SEQ_TIPO_AGULHA',nr_seq_tipo_agulha_w,1)			||
									format_array_json('NR_SEQ_TIPO_AGULHA_ART',nr_seq_tipo_agulha_art_w,1)	||
									format_array_json('QT_PESO_POS',qt_peso_pos_w,1)			||
									format_array_json('QT_PESO_ATUAL',qt_peso_atual_w,1)		||
									format_array_json('QT_PESO_IDEAL',qt_peso_ideal_w,1)		||
									format_array_json('IE_ULTRAFILTRACAO',ie_ultrafiltracao_w,1)		||
									format_array_json('QT_ULTRAFILTRACAO',qt_ultrafiltracao_w,1)		||
									format_array_json('QT_ULTRAFILTRACAO_TOTAL',qt_ultrafiltracao_total_w,1)		||
									format_array_json('NR_SEQ_ULTRA',nr_seq_ultra_w,1)			||
									format_array_json('NR_SEQ_PERFIL_SODIO',nr_seq_perfil_sodio_w,1)	||
									format_array_json('QT_ZERO_UM',qt_zero_um_w,1)				||
									format_array_json('QT_UM_DOIS',qt_um_dois_w,1)				||
									format_array_json('QT_DOIS_TRES',qt_dois_tres_w,1)			||
									format_array_json('QT_TRES_QUATRO',qt_tres_quatro_w,1)		||
									format_array_json('QT_QUATRO_CINCO',qt_seto_oito_w,1)		||
									format_array_json('QT_CINCO_SEIS',qt_cinco_seis_w,1)		||
									format_array_json('NR_SEQ_PERFIL_BIC',nr_seq_perfil_bic_w,1)	||
									format_array_json('QT_ZERO_UM_BIC',qt_zero_um_bic_w,1)				||
									format_array_json('QT_UM_DOIS_BIC',qt_um_dois_bic_w,1)				||
									format_array_json('QT_DOIS_TRES_BIC',qt_dois_tres_bic_w,1)			||
									format_array_json('QT_TRES_QUATRO_BIC',qt_tres_quatro_bic_w,1)		||
									format_array_json('QT_QUATRO_CINCO_BIC',qt_quatro_cinco_bic_w,1)		||
									format_array_json('QT_CINCO_SEIS_BIC',qt_cinco_seis_bic_w,1)||										
									format_array_json('QT_SODIO',qt_sodio_w,1)					||
									format_array_json('QT_CALCIO',qt_calcio_w,1)				||
									format_array_json('QT_BICARBONATO',qt_bicarbonato_w,1)		||
									format_array_json('IE_LIGAR_PRIME',ie_ligar_prime_w,1)		||
									format_array_json('QT_VOLUME_PRIME',qt_volume_prime_w,1)	||
									format_array_json('DS_ORIENTACAO',cpoe_gerar_registro_json_pck.remove_aspas(current_setting('cpoe_gerar_registro_json_pck.ds_observacao_w')::prescr_gasoterapia.ds_observacao%type),1);

	elsif (ie_tipo_dialise_w = 'DP') then
		ds_json_dialise_aux_w :=	ds_json_dialise_aux_w || '{'||
									format_array_json('IE_TIPO_PERITONEAL',ie_tipo_peritoneal_w,1)		||
									format_array_json('NR_CICLOS',nr_ciclos_w,1)				||
									format_array_json('QT_VOLUME_CICLO',qt_volume_ciclo_w,1)	||
									format_array_json('QT_HORA_MIN_DURACAO',qt_hora_min_duracao_w,1)	||
									format_array_json('QT_VOLUME_TOTAL_DI',qt_volume_total_w,1)			||
									format_array_json('QT_HORA_MIN_SESSAO',qt_hora_min_sessao_w,1)		||
									format_array_json('NR_SEQ_MAQ_CICLADORA',nr_seq_maq_cicladora_w,1) 	||
									format_array_json('NR_SERIE',nr_serie_w,1)					||
									format_array_json('QT_MINIMO_VOLUME',qt_minimo_volume_w,1)	||
									format_array_json('IE_VOLUME_ALARME',ie_volume_alarme_w,1)	||
									format_array_json('IE_PERM_INTELIGENTE',ie_perm_inteligente_w,1)	||
									format_array_json('IE_APAGAR_VISOR',ie_apagar_visor_w,1)			||
									format_array_json('IE_MODO_DIALISE',ie_modo_dialise_w,1)			||
									format_array_json('QT_TEMPO_MIN_DRENAGEM',qt_tempo_min_drenagem_w,1)  	||
									format_array_json('QT_LIMITE_UF_NEGATIVO',qt_limite_uf_negativo_w,1)	||
									format_array_json('QT_LIMITE_UF_POSITIVO',qt_limite_uf_positivo_w,1)	||
									format_array_json('IE_AUSENTE',ie_ausente_w,1);
	end if;

	if (ds_json_dialise_aux_w IS NOT NULL AND ds_json_dialise_aux_w::text <> '') then
		if (current_setting('cpoe_gerar_registro_json_pck.dt_lib_suspensao_item_w')::cpoe_gasoterapia.dt_lib_suspensao%coalesce(type::text, '') = '')  then
			PERFORM set_config('cpoe_gerar_registro_json_pck.dt_suspensao_item_w', null, false);
		end if;

			ds_json_dialise_w := 	ds_json_dialise_w ||	ds_json_dialise_aux_w 						||
									format_array_json('NR_SEQUENCIA',nr_seq_dialise_cpoe_w,1)			||
									format_array_json('NR_SEQ_DIALISE_CPOE',nr_seq_dialise_cpoe_w,1)			||
									format_array_json('NR_ATENDIMENTO', nr_atendimento_p,1) 			||
									format_array_json('NM_USUARIO', current_setting('cpoe_gerar_registro_json_pck.nm_usuario_w')::prescr_gasoterapia.nm_usuario%type,1) 					||
									format_array_json('NM_USUARIO_NREC', current_setting('cpoe_gerar_registro_json_pck.nm_usuario_nrec_w')::prescr_gasoterapia_evento.nm_usuario_nrec%type,1) 			||
									format_array_json('DT_ATUALIZACAO', current_setting('cpoe_gerar_registro_json_pck.dt_atualizacao_w')::prescr_gasoterapia.dt_atualizacao%type,1) 			||
									format_array_json('DT_ATUALIZACAO_NREC', current_setting('cpoe_gerar_registro_json_pck.dt_atualizacao_nrec_w')::prescr_gasoterapia_evento.dt_atualizacao_nrec%type,1) 	||
									format_array_json('DT_LIBERACAO', to_char(current_setting('cpoe_gerar_registro_json_pck.dt_liberacao_w')::prescr_medica.dt_liberacao%type, 'dd/mm/yyyy hh24:mi:ss'),1) 	||
									format_array_json('DT_LIBERACAO_ENFERMAGEM', to_char(current_setting('cpoe_gerar_registro_json_pck.dt_liberacao_enfermagem_w')::prescr_medica.dt_liberacao%type, 'dd/mm/yyyy hh24:mi:ss'),1) ||
									format_array_json('DT_LIBERACAO_FARMACIA', to_char(current_setting('cpoe_gerar_registro_json_pck.dt_liberacao_farmacia_w')::prescr_medica.dt_liberacao_farmacia%type, 'dd/mm/yyyy hh24:mi:ss'),1) ||
									format_array_json('NM_USUARIO_LIB_ENFERMAGEM', current_setting('cpoe_gerar_registro_json_pck.nm_usuario_lib_enfermagem_w')::varchar(255),1) ||
									format_array_json('NM_USUARIO_LIB_FARMACIA', current_setting('cpoe_gerar_registro_json_pck.nm_usuario_lib_farmacia_w')::varchar(255),1) ||
									format_array_json('IE_MOMENTO_LOTE', current_setting('cpoe_gerar_registro_json_pck.ie_momento_lote_w')::regra_disp_lote_farm.ie_momento_lote%type,1) ||
									format_array_json('DT_SUSPENSAO', to_char(current_setting('cpoe_gerar_registro_json_pck.dt_suspensao_item_w')::prescr_gasoterapia.dt_suspensao%type, 'dd/mm/yyyy hh24:mi:ss'),1) ||
									format_array_json('DT_LIB_SUSPENSAO', to_char(current_setting('cpoe_gerar_registro_json_pck.dt_lib_suspensao_item_w')::cpoe_gasoterapia.dt_lib_suspensao%type, 'dd/mm/yyyy hh24:mi:ss'),1) ||
									format_array_json('DT_DESCONTINUACAO', to_char(current_setting('cpoe_gerar_registro_json_pck.dt_suspensao_item_w')::prescr_gasoterapia.dt_suspensao%type, 'dd/mm/yyyy hh24:mi:ss'),1) ||
									format_array_json('NM_USUARIO_SUSP', current_setting('cpoe_gerar_registro_json_pck.nm_usuario_susp_w')::cpoe_dieta.nm_usuario_susp%type,1) ||
									format_array_json('NM_USUARIO_DESCONTINUACAO', current_setting('cpoe_gerar_registro_json_pck.nm_usuario_descontinuacao_w')::varchar(255),1) ||
									format_array_json('DT_INICIO_GRID', to_char(current_setting('cpoe_gerar_registro_json_pck.dt_inicio_grid_w')::timestamp, 'dd/mm/yyyy hh24:mi:ss'),1) ||
									format_array_json('DT_INICIO', to_char(dt_inicio_dialise_w, 'dd/mm/yyyy hh24:mi:ss'),1) ||
									format_array_json('IE_DURACAO', current_setting('cpoe_gerar_registro_json_pck.ie_duracao_w')::cpoe_dieta.ie_duracao%type,1) ||
									format_array_json('DS_PRESCRITOR_DETALHE', cpoe_gerar_registro_json_pck.remove_aspas(current_setting('cpoe_gerar_registro_json_pck.ds_prescritor_w')::varchar(255)),1) 		||
									format_array_json('DT_PRESCRITA_DETALHE', current_setting('cpoe_gerar_registro_json_pck.dt_prescrito_w')::varchar(255),1) 		||
									format_array_json('DS_PREVIOUS_PRESCRIBER', cpoe_gerar_registro_json_pck.remove_aspas(current_setting('cpoe_gerar_registro_json_pck.ds_previous_prescriber_w')::varchar(255)),1) ||
									format_array_json('DT_PREVIOUS_PRESCRIBER', current_setting('cpoe_gerar_registro_json_pck.dt_previous_prescriber_w')::varchar(255),1) ||
									format_array_json('DS_CONSELHO', cpoe_gerar_registro_json_pck.remove_aspas(current_setting('cpoe_gerar_registro_json_pck.ds_conselho_w')::varchar(255)),1) 					||	
									format_array_json('DS_PRESCRITOR', cpoe_gerar_registro_json_pck.remove_aspas(current_setting('cpoe_gerar_registro_json_pck.ds_prescritor_grid_w')::varchar(255)),1)          ||
									format_array_json('DS_PRESCRITOR_REVAL', cpoe_gerar_registro_json_pck.remove_aspas(current_setting('cpoe_gerar_registro_json_pck.ds_prescritor_reval_w')::varchar(255)),1) ||
									format_array_json('DS_DIALYSIS',current_setting('cpoe_gerar_registro_json_pck.ds_item_w')::varchar(1000),1)  						||
									format_array_json('DS_ITEM',current_setting('cpoe_gerar_registro_json_pck.ds_item_ww')::varchar(1000),1)  						||
									format_array_json('DS_SOLUCOES',obter_array_json('DS_SOLUCOES', ds_json_solucao_w),2) ||
									format_array_json('IE_TIPO_DIALISE',ie_tipo_dialise_w,1)		    ||
									format_array_json('NR_SEQ_VISAO', 25368,1) ||
									format_array_json('DS_HORA_00',current_setting('cpoe_gerar_registro_json_pck.ds_hora_00_w')::varchar(50),1)			            ||
									format_array_json('DS_HORA_01',current_setting('cpoe_gerar_registro_json_pck.ds_hora_01_w')::varchar(50),1)  		            ||
									format_array_json('DS_HORA_02',current_setting('cpoe_gerar_registro_json_pck.ds_hora_02_w')::varchar(50),1)  		            ||
									format_array_json('DS_HORA_03',current_setting('cpoe_gerar_registro_json_pck.ds_hora_03_w')::varchar(50),1)  		            ||
									format_array_json('DS_HORA_04',current_setting('cpoe_gerar_registro_json_pck.ds_hora_04_w')::varchar(50),1)  		            ||
									format_array_json('DS_HORA_05',current_setting('cpoe_gerar_registro_json_pck.ds_hora_05_w')::varchar(50),1)  		            ||
									format_array_json('DS_HORA_06',current_setting('cpoe_gerar_registro_json_pck.ds_hora_06_w')::varchar(50),1)  		            ||
									format_array_json('DS_HORA_07',current_setting('cpoe_gerar_registro_json_pck.ds_hora_07_w')::varchar(50),1)  		            ||
									format_array_json('DS_HORA_08',current_setting('cpoe_gerar_registro_json_pck.ds_hora_08_w')::varchar(50),1)  		            ||
									format_array_json('DS_HORA_09',current_setting('cpoe_gerar_registro_json_pck.ds_hora_09_w')::varchar(50),1)  		            ||
									format_array_json('DS_HORA_10',current_setting('cpoe_gerar_registro_json_pck.ds_hora_10_w')::varchar(50),1)  		            ||
									format_array_json('DS_HORA_11',current_setting('cpoe_gerar_registro_json_pck.ds_hora_11_w')::varchar(50),1)  		            ||
									format_array_json('DS_HORA_12',current_setting('cpoe_gerar_registro_json_pck.ds_hora_12_w')::varchar(50),1)  		            ||
									format_array_json('DS_HORA_13',current_setting('cpoe_gerar_registro_json_pck.ds_hora_13_w')::varchar(50),1)  		            ||
									format_array_json('DS_HORA_14',current_setting('cpoe_gerar_registro_json_pck.ds_hora_14_w')::varchar(50),1)  		            ||
									format_array_json('DS_HORA_15',current_setting('cpoe_gerar_registro_json_pck.ds_hora_15_w')::varchar(50),1)  		            ||
									format_array_json('DS_HORA_16',current_setting('cpoe_gerar_registro_json_pck.ds_hora_16_w')::varchar(50),1)  		            ||
									format_array_json('DS_HORA_17',current_setting('cpoe_gerar_registro_json_pck.ds_hora_17_w')::varchar(50),1) 		 	            ||
									format_array_json('DS_HORA_18',current_setting('cpoe_gerar_registro_json_pck.ds_hora_18_w')::varchar(50),1) 		 	            ||
									format_array_json('DS_HORA_19',current_setting('cpoe_gerar_registro_json_pck.ds_hora_19_w')::varchar(50),1) 		 	            ||
									format_array_json('DS_HORA_20',current_setting('cpoe_gerar_registro_json_pck.ds_hora_20_w')::varchar(50),1) 			            ||
									format_array_json('DS_HORA_21',current_setting('cpoe_gerar_registro_json_pck.ds_hora_21_w')::varchar(50),1)  		            ||
									format_array_json('DS_HORA_22',current_setting('cpoe_gerar_registro_json_pck.ds_hora_22_w')::varchar(50),1)  		            ||
									format_array_json('DS_HORA_23',current_setting('cpoe_gerar_registro_json_pck.ds_hora_23_w')::varchar(50),1) 						||
									format_array_json('DS_DIAS_SEMANA', ds_dias_semana_w, 1) ||
									format_array_json('IE_SEGUNDA', ie_segunda_w, 1) ||
									format_array_json('IE_TERCA', ie_terca_w, 1) ||
									format_array_json('IE_QUARTA', ie_quarta_w, 1) ||
									format_array_json('IE_QUINTA', ie_quinta_w, 1) ||
									format_array_json('IE_SEXTA', ie_sexta_w, 1) ||
									format_array_json('IE_SABADO', ie_sabado_w, 1) ||
									format_array_json('IE_DOMINGO', ie_domingo_w, 1) ||
									format_array_json('NR_SEQ_ASSINATURA', current_setting('cpoe_gerar_registro_json_pck.nr_seq_assinatura_w')::cpoe_gasoterapia.nr_seq_assinatura%type, 1) ||
									format_array_json('DT_ASSINATURA_DIGITAL', to_char(current_setting('cpoe_gerar_registro_json_pck.dt_assinatura_digital_w')::tasy_assinatura_digital.dt_assinatura%type, 'dd/mm/yyyy hh24:mi:ss'), 1) ||
									format_array_json('NR_SEQ_CPOE_ORDER_UNIT',current_setting('cpoe_gerar_registro_json_pck.nr_seq_cpoe_order_unit_w')::cpoe_order_unit.nr_sequencia%type, 1);

			ds_json_dialise_w := substr(ds_json_dialise_w,1,length(ds_json_dialise_w)-2) || '},';
			end if;

	end loop;
	close current_setting('cpoe_gerar_registro_json_pck.c01')::CURSOR;

	if (ds_json_dialise_w IS NOT NULL AND ds_json_dialise_w::text <> '') then
		begin
		PERFORM set_config('cpoe_gerar_registro_json_pck.ds_registro_w', format_json('DS_DIALISE', ds_json_dialise_w), false);

		CALL cpoe_gerar_registro_json_pck.cpoe_salvar_json( 	nr_atendimento_p,
							dt_referencia_p,
							nm_usuario_p,
							'DI',
							current_setting('cpoe_gerar_registro_json_pck.ds_registro_w')::text);
		end;
	end if;

commit;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_gerar_registro_json_pck.cpoe_gerar_registro_dial_json ( nr_atendimento_p bigint, nm_usuario_p text, dt_referencia_p timestamp, nr_prescricao_p bigint default null) FROM PUBLIC;
