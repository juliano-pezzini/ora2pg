-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE param_recalcular_repasse_pck.inicializar ( cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE

					 
	ie_repasse_estorno_ww		parametro_faturamento.ie_repasse_estorno%type;
	ie_repasse_zerado_ww		parametro_faturamento.ie_repasse_zerado%type;
	ie_regra_estab_atend_ww		parametro_repasse.ie_regra_estab_atend%type;
	ie_estornar_rep_desdob_ww	parametro_repasse.ie_estornar_rep_desdob%type;
	ie_data_lib_prod_ww		parametro_repasse.ie_data_lib_prod%type;
	ie_terc_estab_ww		parametro_repasse.ie_terc_estab%type;
	ie_libera_repasse_estornado_ww	parametro_repasse.ie_libera_repasse_estornado%type;
	ie_repasse_audit_ww		parametro_repasse.ie_repasse_item_audit%type;
	ie_gerar_repasse_sh_diaria_ww	parametro_repasse.ie_custo_oper_proc%type;
	ie_auditar_repasse_ww		parametro_repasse.ie_auditar_repasse%type;
	ie_data_liberacao_ww		varchar(255);
	ie_contabilizado_ww		varchar(255);
	ie_considera_fim_mes_ww		varchar(255);
	ie_estab_w			varchar(255)	:= 'N';
	cont_ww				bigint;
	qt_repasse_adic_ww	bigint;
	
	
BEGIN 
		if (cd_estabelecimento_p IS NOT NULL AND cd_estabelecimento_p::text <> '') then 
			if (current_setting('param_recalcular_repasse_pck.parametros_w')::coalesce(vetor_parametros.first::text, '') = '') then 
				PERFORM set_config('param_recalcular_repasse_pck.nr_indice_w', current_setting('param_recalcular_repasse_pck.nr_indice_w')::bigint + 1, false);
				 
				select	coalesce(max(ie_repasse_estorno),'N'), 
					coalesce(max(ie_repasse_zerado), 'N') 
				into STRICT	ie_repasse_estorno_ww, 
					ie_repasse_zerado_ww 
				from 	parametro_faturamento 
				where	cd_estabelecimento	= cd_estabelecimento_p;
				 
				ie_data_liberacao_ww	:= obter_valor_param_usuario(87, 89, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p);
				obter_param_usuario(89, 59, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_contabilizado_ww);
				Obter_Param_Usuario(89, 165, obter_perfil_ativo, obter_usuario_ativo,obter_estabelecimento_ativo,ie_considera_fim_mes_ww);
 
				select 	coalesce(max(ie_estornar_rep_desdob),'N'), 
					coalesce(max(ie_data_lib_prod),'N'), 
					coalesce(max(ie_terc_estab), 'L'), 
					coalesce(max(ie_libera_repasse_estornado),'N'), 
					coalesce(max(ie_repasse_item_audit),'S'), 
					coalesce(max(ie_custo_oper_proc),'S'), 
					coalesce(max(ie_auditar_repasse),'N'), 
					coalesce(max(ie_regra_estab_atend),'N') 
				into STRICT	ie_estornar_rep_desdob_ww, 
					ie_data_lib_prod_ww, 
					ie_terc_estab_ww, 
					ie_libera_repasse_estornado_ww, 
					ie_repasse_audit_ww, 
					ie_gerar_repasse_sh_diaria_ww, 
					ie_auditar_repasse_ww, 
					ie_regra_estab_atend_ww 
				from	parametro_repasse 
				where	cd_estabelecimento	= cd_estabelecimento_p;
 
				select	count(1) 
				into STRICT	cont_ww 
				from	proc_crit_repasse_dia LIMIT 1;
				 
				select 	count(1) 
				into STRICT	qt_repasse_adic_ww 
				from 	proc_crit_repasse_adic LIMIT 1;
				 
				current_setting('param_recalcular_repasse_pck.parametros_w')::vetor_parametros(current_setting('param_recalcular_repasse_pck.nr_indice_w')::bigint).cd_estabelecimento		:= cd_estabelecimento_p;
				current_setting('param_recalcular_repasse_pck.parametros_w')::vetor_parametros(current_setting('param_recalcular_repasse_pck.nr_indice_w')::bigint).ie_repasse_estorno		:= ie_repasse_estorno_ww;
				current_setting('param_recalcular_repasse_pck.parametros_w')::vetor_parametros(current_setting('param_recalcular_repasse_pck.nr_indice_w')::bigint).ie_repasse_zerado		:= ie_repasse_zerado_ww;
				current_setting('param_recalcular_repasse_pck.parametros_w')::vetor_parametros(current_setting('param_recalcular_repasse_pck.nr_indice_w')::bigint).ie_estornar_rep_desdob	:= ie_estornar_rep_desdob_ww;
				current_setting('param_recalcular_repasse_pck.parametros_w')::vetor_parametros(current_setting('param_recalcular_repasse_pck.nr_indice_w')::bigint).ie_data_lib_prod		:= ie_data_lib_prod_ww;
				current_setting('param_recalcular_repasse_pck.parametros_w')::vetor_parametros(current_setting('param_recalcular_repasse_pck.nr_indice_w')::bigint).ie_terc_estab			:= ie_terc_estab_ww;
				current_setting('param_recalcular_repasse_pck.parametros_w')::vetor_parametros(current_setting('param_recalcular_repasse_pck.nr_indice_w')::bigint).ie_libera_repasse_estornado	:= ie_libera_repasse_estornado_ww;
				current_setting('param_recalcular_repasse_pck.parametros_w')::vetor_parametros(current_setting('param_recalcular_repasse_pck.nr_indice_w')::bigint).ie_repasse_item_audit		:= ie_repasse_audit_ww;
				current_setting('param_recalcular_repasse_pck.parametros_w')::vetor_parametros(current_setting('param_recalcular_repasse_pck.nr_indice_w')::bigint).ie_custo_oper_proc		:= ie_gerar_repasse_sh_diaria_ww;
				current_setting('param_recalcular_repasse_pck.parametros_w')::vetor_parametros(current_setting('param_recalcular_repasse_pck.nr_indice_w')::bigint).ie_auditar_repasse		:= ie_auditar_repasse_ww;
				current_setting('param_recalcular_repasse_pck.parametros_w')::vetor_parametros(current_setting('param_recalcular_repasse_pck.nr_indice_w')::bigint).ie_data_liberacao		:= ie_data_liberacao_ww;
				current_setting('param_recalcular_repasse_pck.parametros_w')::vetor_parametros(current_setting('param_recalcular_repasse_pck.nr_indice_w')::bigint).ie_contabilizado		:= ie_contabilizado_ww;
				current_setting('param_recalcular_repasse_pck.parametros_w')::vetor_parametros(current_setting('param_recalcular_repasse_pck.nr_indice_w')::bigint).ie_considera_fim_mes		:= ie_considera_fim_mes_ww;
				current_setting('param_recalcular_repasse_pck.parametros_w')::vetor_parametros(current_setting('param_recalcular_repasse_pck.nr_indice_w')::bigint).ie_regra_estab_atend		:= ie_regra_estab_atend_ww;
				current_setting('param_recalcular_repasse_pck.parametros_w')::vetor_parametros(current_setting('param_recalcular_repasse_pck.nr_indice_w')::bigint).cont						:= cont_ww;
				current_setting('param_recalcular_repasse_pck.parametros_w')::vetor_parametros(current_setting('param_recalcular_repasse_pck.nr_indice_w')::bigint).qt_repasse_adic			:= qt_repasse_adic_ww;
				 
				PERFORM set_config('param_recalcular_repasse_pck.ie_repasse_estorno_w', ie_repasse_estorno_ww, false);
				PERFORM set_config('param_recalcular_repasse_pck.ie_repasse_zerado_w', ie_repasse_zerado_ww, false);
				PERFORM set_config('param_recalcular_repasse_pck.ie_estornar_rep_desdob_w', ie_estornar_rep_desdob_ww, false);
				PERFORM set_config('param_recalcular_repasse_pck.ie_data_lib_prod_w', ie_data_lib_prod_ww, false);
				PERFORM set_config('param_recalcular_repasse_pck.ie_terc_estab_w', ie_terc_estab_ww, false);
				PERFORM set_config('param_recalcular_repasse_pck.ie_libera_repasse_estornado_w', ie_libera_repasse_estornado_ww, false);
				PERFORM set_config('param_recalcular_repasse_pck.ie_repasse_audit_w', ie_repasse_audit_ww, false);
				PERFORM set_config('param_recalcular_repasse_pck.ie_gerar_repasse_sh_diaria_w', ie_gerar_repasse_sh_diaria_ww, false);
				PERFORM set_config('param_recalcular_repasse_pck.ie_auditar_repasse_w', ie_auditar_repasse_ww, false);
				PERFORM set_config('param_recalcular_repasse_pck.ie_data_liberacao_w', ie_data_liberacao_ww, false);
				PERFORM set_config('param_recalcular_repasse_pck.ie_contabilizado_w', ie_contabilizado_ww, false);
				PERFORM set_config('param_recalcular_repasse_pck.ie_considera_fim_mes_w', ie_considera_fim_mes_ww, false);
				PERFORM set_config('param_recalcular_repasse_pck.ie_regra_estab_atend_w', ie_regra_estab_atend_ww, false);
				PERFORM set_config('param_recalcular_repasse_pck.cont_w', cont_ww, false);
				PERFORM set_config('param_recalcular_repasse_pck.qt_repasse_adic_w', qt_repasse_adic_ww, false);
			else 
				 
				for i in current_setting('param_recalcular_repasse_pck.parametros_w')::vetor_parametros.first..parametros_w.last loop 
					begin 
					if (current_setting('param_recalcular_repasse_pck.parametros_w')::vetor_parametros[i].cd_estabelecimento = cd_estabelecimento_p) then 
						PERFORM set_config('param_recalcular_repasse_pck.ie_repasse_estorno_w', current_setting('param_recalcular_repasse_pck.parametros_w')::vetor_parametros[i].ie_repasse_estorno, false);
						PERFORM set_config('param_recalcular_repasse_pck.ie_repasse_zerado_w', current_setting('param_recalcular_repasse_pck.parametros_w')::vetor_parametros[i].ie_repasse_zerado, false);
						PERFORM set_config('param_recalcular_repasse_pck.ie_estornar_rep_desdob_w', current_setting('param_recalcular_repasse_pck.parametros_w')::vetor_parametros[i].ie_estornar_rep_desdob, false);
						PERFORM set_config('param_recalcular_repasse_pck.ie_data_lib_prod_w', current_setting('param_recalcular_repasse_pck.parametros_w')::vetor_parametros[i].ie_data_lib_prod, false);
						PERFORM set_config('param_recalcular_repasse_pck.ie_terc_estab_w', current_setting('param_recalcular_repasse_pck.parametros_w')::vetor_parametros[i].ie_terc_estab, false);
						PERFORM set_config('param_recalcular_repasse_pck.ie_libera_repasse_estornado_w', current_setting('param_recalcular_repasse_pck.parametros_w')::vetor_parametros[i].ie_libera_repasse_estornado, false);
						PERFORM set_config('param_recalcular_repasse_pck.ie_repasse_audit_w', current_setting('param_recalcular_repasse_pck.parametros_w')::vetor_parametros[i].ie_repasse_item_audit, false);
						PERFORM set_config('param_recalcular_repasse_pck.ie_gerar_repasse_sh_diaria_w', current_setting('param_recalcular_repasse_pck.parametros_w')::vetor_parametros[i].ie_custo_oper_proc, false);
						PERFORM set_config('param_recalcular_repasse_pck.ie_auditar_repasse_w', current_setting('param_recalcular_repasse_pck.parametros_w')::vetor_parametros[i].ie_auditar_repasse, false);
						PERFORM set_config('param_recalcular_repasse_pck.ie_data_liberacao_w', current_setting('param_recalcular_repasse_pck.parametros_w')::vetor_parametros[i].ie_data_liberacao, false);
						PERFORM set_config('param_recalcular_repasse_pck.ie_contabilizado_w', current_setting('param_recalcular_repasse_pck.parametros_w')::vetor_parametros[i].ie_contabilizado, false);
						PERFORM set_config('param_recalcular_repasse_pck.ie_considera_fim_mes_w', current_setting('param_recalcular_repasse_pck.parametros_w')::vetor_parametros[i].ie_considera_fim_mes, false);
						PERFORM set_config('param_recalcular_repasse_pck.ie_regra_estab_atend_w', current_setting('param_recalcular_repasse_pck.parametros_w')::vetor_parametros[i].ie_regra_estab_atend, false);
						PERFORM set_config('param_recalcular_repasse_pck.cont_w', current_setting('param_recalcular_repasse_pck.parametros_w')::vetor_parametros[i].cont, false);
						PERFORM set_config('param_recalcular_repasse_pck.qt_repasse_adic_w', current_setting('param_recalcular_repasse_pck.parametros_w')::vetor_parametros[i].qt_repasse_adic, false);
 
						ie_estab_w	:= 'S';
					elsif (ie_estab_w = 'N') then 
						ie_estab_w	:= 'N';
					end if;
 
					if (ie_estab_w ='N') then 
						PERFORM set_config('param_recalcular_repasse_pck.nr_indice_w', current_setting('param_recalcular_repasse_pck.nr_indice_w')::bigint + 1, false);
				 
						select	coalesce(max(ie_repasse_estorno),'N'), 
							coalesce(max(ie_repasse_zerado), 'N') 
						into STRICT	ie_repasse_estorno_ww, 
							ie_repasse_zerado_ww 
						from 	parametro_faturamento 
						where	cd_estabelecimento	= cd_estabelecimento_p;
						 
						ie_data_liberacao_ww	:= obter_valor_param_usuario(87, 89, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p);
						obter_param_usuario(89, 59, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_contabilizado_ww);
						Obter_Param_Usuario(89, 165, obter_perfil_ativo, obter_usuario_ativo,obter_estabelecimento_ativo,ie_considera_fim_mes_ww);
 
						select 	coalesce(max(ie_estornar_rep_desdob),'N'), 
							coalesce(max(ie_data_lib_prod),'N'), 
							coalesce(max(ie_terc_estab), 'L'), 
							coalesce(max(ie_libera_repasse_estornado),'N'), 
							coalesce(max(ie_repasse_item_audit),'S'), 
							coalesce(max(ie_custo_oper_proc),'S'), 
							coalesce(max(ie_auditar_repasse),'N'), 
							coalesce(max(ie_regra_estab_atend),'N') 
						into STRICT	ie_estornar_rep_desdob_ww, 
							ie_data_lib_prod_ww, 
							ie_terc_estab_ww, 
							ie_libera_repasse_estornado_ww, 
							ie_repasse_audit_ww, 
							ie_gerar_repasse_sh_diaria_ww, 
							ie_auditar_repasse_ww, 
							ie_regra_estab_atend_ww 
						from	parametro_repasse 
						where	cd_estabelecimento	= cd_estabelecimento_p;
						 
						select	count(1) 
						into STRICT	cont_ww 
						from	proc_crit_repasse_dia LIMIT 1;
						 
						select 	count(1) 
						into STRICT	qt_repasse_adic_ww 
						from 	proc_crit_repasse_adic LIMIT 1;
						 
						current_setting('param_recalcular_repasse_pck.parametros_w')::vetor_parametros(current_setting('param_recalcular_repasse_pck.nr_indice_w')::bigint).cd_estabelecimento		:= cd_estabelecimento_p;
						current_setting('param_recalcular_repasse_pck.parametros_w')::vetor_parametros(current_setting('param_recalcular_repasse_pck.nr_indice_w')::bigint).ie_repasse_estorno		:= ie_repasse_estorno_ww;
						current_setting('param_recalcular_repasse_pck.parametros_w')::vetor_parametros(current_setting('param_recalcular_repasse_pck.nr_indice_w')::bigint).ie_repasse_zerado		:= ie_repasse_zerado_ww;
						current_setting('param_recalcular_repasse_pck.parametros_w')::vetor_parametros(current_setting('param_recalcular_repasse_pck.nr_indice_w')::bigint).ie_estornar_rep_desdob	:= ie_estornar_rep_desdob_ww;
						current_setting('param_recalcular_repasse_pck.parametros_w')::vetor_parametros(current_setting('param_recalcular_repasse_pck.nr_indice_w')::bigint).ie_data_lib_prod		:= ie_data_lib_prod_ww;
						current_setting('param_recalcular_repasse_pck.parametros_w')::vetor_parametros(current_setting('param_recalcular_repasse_pck.nr_indice_w')::bigint).ie_terc_estab			:= ie_terc_estab_ww;
						current_setting('param_recalcular_repasse_pck.parametros_w')::vetor_parametros(current_setting('param_recalcular_repasse_pck.nr_indice_w')::bigint).ie_libera_repasse_estornado	:= ie_libera_repasse_estornado_ww;
						current_setting('param_recalcular_repasse_pck.parametros_w')::vetor_parametros(current_setting('param_recalcular_repasse_pck.nr_indice_w')::bigint).ie_repasse_item_audit		:= ie_repasse_audit_ww;
						current_setting('param_recalcular_repasse_pck.parametros_w')::vetor_parametros(current_setting('param_recalcular_repasse_pck.nr_indice_w')::bigint).ie_custo_oper_proc		:= ie_gerar_repasse_sh_diaria_ww;
						current_setting('param_recalcular_repasse_pck.parametros_w')::vetor_parametros(current_setting('param_recalcular_repasse_pck.nr_indice_w')::bigint).ie_auditar_repasse		:= ie_auditar_repasse_ww;
						current_setting('param_recalcular_repasse_pck.parametros_w')::vetor_parametros(current_setting('param_recalcular_repasse_pck.nr_indice_w')::bigint).ie_data_liberacao		:= ie_data_liberacao_ww;
						current_setting('param_recalcular_repasse_pck.parametros_w')::vetor_parametros(current_setting('param_recalcular_repasse_pck.nr_indice_w')::bigint).ie_contabilizado		:= ie_contabilizado_ww;
						current_setting('param_recalcular_repasse_pck.parametros_w')::vetor_parametros(current_setting('param_recalcular_repasse_pck.nr_indice_w')::bigint).ie_considera_fim_mes		:= ie_considera_fim_mes_ww;
						current_setting('param_recalcular_repasse_pck.parametros_w')::vetor_parametros(current_setting('param_recalcular_repasse_pck.nr_indice_w')::bigint).ie_regra_estab_atend		:= ie_regra_estab_atend_ww;
						current_setting('param_recalcular_repasse_pck.parametros_w')::vetor_parametros(current_setting('param_recalcular_repasse_pck.nr_indice_w')::bigint).cont						:= cont_ww;
						current_setting('param_recalcular_repasse_pck.parametros_w')::vetor_parametros(current_setting('param_recalcular_repasse_pck.nr_indice_w')::bigint).qt_repasse_adic			:= qt_repasse_adic_ww;
						 
						PERFORM set_config('param_recalcular_repasse_pck.ie_repasse_estorno_w', ie_repasse_estorno_ww, false);
						PERFORM set_config('param_recalcular_repasse_pck.ie_repasse_zerado_w', ie_repasse_zerado_ww, false);
						PERFORM set_config('param_recalcular_repasse_pck.ie_estornar_rep_desdob_w', ie_estornar_rep_desdob_ww, false);
						PERFORM set_config('param_recalcular_repasse_pck.ie_data_lib_prod_w', ie_data_lib_prod_ww, false);
						PERFORM set_config('param_recalcular_repasse_pck.ie_terc_estab_w', ie_terc_estab_ww, false);
						PERFORM set_config('param_recalcular_repasse_pck.ie_libera_repasse_estornado_w', ie_libera_repasse_estornado_ww, false);
						PERFORM set_config('param_recalcular_repasse_pck.ie_repasse_audit_w', ie_repasse_audit_ww, false);
						PERFORM set_config('param_recalcular_repasse_pck.ie_gerar_repasse_sh_diaria_w', ie_gerar_repasse_sh_diaria_ww, false);
						PERFORM set_config('param_recalcular_repasse_pck.ie_auditar_repasse_w', ie_auditar_repasse_ww, false);
						PERFORM set_config('param_recalcular_repasse_pck.ie_data_liberacao_w', ie_data_liberacao_ww, false);
						PERFORM set_config('param_recalcular_repasse_pck.ie_contabilizado_w', ie_contabilizado_ww, false);
						PERFORM set_config('param_recalcular_repasse_pck.ie_considera_fim_mes_w', ie_considera_fim_mes_ww, false);
						PERFORM set_config('param_recalcular_repasse_pck.ie_regra_estab_atend_w', ie_regra_estab_atend_ww, false);
						PERFORM set_config('param_recalcular_repasse_pck.cont_w', cont_ww, false);
						PERFORM set_config('param_recalcular_repasse_pck.qt_repasse_adic_w', qt_repasse_adic_ww, false);
					end if;
					end;
				end loop;
			end if;
		else 
			PERFORM set_config('param_recalcular_repasse_pck.ie_repasse_estorno_w', null, false);
			PERFORM set_config('param_recalcular_repasse_pck.ie_repasse_zerado_w', null, false);
			PERFORM set_config('param_recalcular_repasse_pck.ie_estornar_rep_desdob_w', null, false);
			PERFORM set_config('param_recalcular_repasse_pck.ie_data_lib_prod_w', null, false);
			PERFORM set_config('param_recalcular_repasse_pck.ie_terc_estab_w', null, false);
			PERFORM set_config('param_recalcular_repasse_pck.ie_libera_repasse_estornado_w', null, false);
			PERFORM set_config('param_recalcular_repasse_pck.ie_repasse_audit_w', null, false);
			PERFORM set_config('param_recalcular_repasse_pck.ie_gerar_repasse_sh_diaria_w', null, false);
			PERFORM set_config('param_recalcular_repasse_pck.ie_auditar_repasse_w', null, false);
			PERFORM set_config('param_recalcular_repasse_pck.ie_data_liberacao_w', null, false);
			PERFORM set_config('param_recalcular_repasse_pck.ie_contabilizado_w', null, false);
			PERFORM set_config('param_recalcular_repasse_pck.ie_considera_fim_mes_w', null, false);
			PERFORM set_config('param_recalcular_repasse_pck.ie_regra_estab_atend_w', null, false);
			PERFORM set_config('param_recalcular_repasse_pck.cont_w', null, false);
			PERFORM set_config('param_recalcular_repasse_pck.qt_repasse_adic_w', null, false);
		end if;
	end;
	

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE param_recalcular_repasse_pck.inicializar ( cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;
