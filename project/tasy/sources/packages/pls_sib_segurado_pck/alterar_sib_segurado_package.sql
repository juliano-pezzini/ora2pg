-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_sib_segurado_pck.alterar_sib_segurado ( nr_seq_movimento_p pls_sib_movimento.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE

pls_sib_movimento_w	pls_sib_movimento%rowtype;
nr_seq_sib_segurado_w	pls_sib_segurado.nr_sequencia%type;

BEGIN
if (nr_seq_movimento_p IS NOT NULL AND nr_seq_movimento_p::text <> '') then
	select	*
	into STRICT	pls_sib_movimento_w
	from	pls_sib_movimento
	where	nr_sequencia	= nr_seq_movimento_p;
	
	select	max(nr_sequencia)
	into STRICT	nr_seq_sib_segurado_w
	from	pls_sib_segurado
	where	nr_seq_segurado	= pls_sib_movimento_w.nr_seq_segurado;

	if (nr_seq_sib_segurado_w IS NOT NULL AND nr_seq_sib_segurado_w::text <> '') then
		if (pls_sib_movimento_w.ie_tipo_movimento = 3) then --Mudança contratual
			update	pls_sib_segurado
			set	dt_atualizacao			= clock_timestamp(),
				nm_usuario			= nm_usuario_p,
				nr_plano_ans			= pls_sib_movimento_w.nr_plano_ans,
				nr_plano_operadora		= pls_sib_movimento_w.nr_plano_operadora,
				nr_plano_portabilidade		= pls_sib_movimento_w.nr_plano_portabilidade,
				ie_cpt				= pls_sib_movimento_w.ie_cpt,
				ie_itens_excluidos_cobertura	= pls_sib_movimento_w.ie_itens_excluidos_cobertura,
				nr_cnpj				= pls_sib_movimento_w.nr_cnpj,
				nr_cei				= pls_sib_movimento_w.nr_cei,
				cd_caepf      			= pls_sib_movimento_w.cd_caepf,
				cd_relacao_dependencia		= pls_sib_movimento_w.cd_relacao_dependencia,
				cd_beneficiario_titular		= pls_sib_movimento_w.cd_beneficiario_titular,
				dt_contratacao			= pls_sib_movimento_w.dt_contratacao
			where	nr_sequencia = nr_seq_sib_segurado_w;
		elsif (pls_sib_movimento_w.ie_tipo_movimento = 4) then --Cancelamento
			update	pls_sib_segurado
			set	dt_atualizacao			= clock_timestamp(),
				nm_usuario			= nm_usuario_p,
				dt_cancelamento			= pls_sib_movimento_w.dt_cancelamento,
				cd_motivo_cancelamento		= pls_sib_movimento_w.cd_motivo_cancelamento,
				dt_reativacao			 = NULL
			where	nr_sequencia = nr_seq_sib_segurado_w;
		elsif (pls_sib_movimento_w.ie_tipo_movimento = 5) then --Reinclusão
			update	pls_sib_segurado
			set	dt_atualizacao			= clock_timestamp(),
				nm_usuario			= nm_usuario_p,
				dt_reativacao			= pls_sib_movimento_w.dt_reativacao,
				dt_cancelamento			 = NULL,
				cd_motivo_cancelamento		 = NULL
			where	nr_sequencia = nr_seq_sib_segurado_w;
		else
			update	pls_sib_segurado
			set	dt_atualizacao			= clock_timestamp(),
				nm_usuario			= nm_usuario_p,
				nm_beneficiario			= coalesce(pls_sib_movimento_w.nm_beneficiario,nm_beneficiario),
				dt_nascimento			= coalesce(pls_sib_movimento_w.dt_nascimento,dt_nascimento),
				cd_sexo				= coalesce(pls_sib_movimento_w.cd_sexo,cd_sexo),
				nr_cpf				= coalesce(pls_sib_movimento_w.nr_cpf,nr_cpf),
				nr_pis_pasep			= coalesce(pls_sib_movimento_w.nr_pis_pasep,nr_pis_pasep),
				nm_mae				= coalesce(pls_sib_movimento_w.nm_mae,nm_mae),
				nr_dn				= coalesce(pls_sib_movimento_w.nr_dn,nr_dn),
				nr_cns				= coalesce(pls_sib_movimento_w.nr_cns,nr_cns),
				cd_beneficiario			= coalesce(pls_sib_movimento_w.cd_beneficiario,cd_beneficiario),
				cd_beneficiario_titular		= CASE WHEN pls_sib_movimento_w.cd_relacao_dependencia=1 THEN null  ELSE coalesce(pls_sib_movimento_w.cd_beneficiario_titular,cd_beneficiario_titular) END , --Se estiver alterando para titular, deve limpar o código do titular anterior
				dt_contratacao			= coalesce(pls_sib_movimento_w.dt_contratacao,dt_contratacao),
				nr_plano_ans			= coalesce(pls_sib_movimento_w.nr_plano_ans,nr_plano_ans),
				nr_plano_operadora		= coalesce(pls_sib_movimento_w.nr_plano_operadora,nr_plano_operadora),
				nr_plano_portabilidade		= coalesce(pls_sib_movimento_w.nr_plano_portabilidade,nr_plano_portabilidade),
				ie_cpt				= coalesce(pls_sib_movimento_w.ie_cpt,ie_cpt),
				ie_itens_excluidos_cobertura	= coalesce(pls_sib_movimento_w.ie_itens_excluidos_cobertura,ie_itens_excluidos_cobertura),
				nr_cnpj				= coalesce(pls_sib_movimento_w.nr_cnpj,nr_cnpj),
				nr_cei				= coalesce(pls_sib_movimento_w.nr_cei,nr_cei),
				cd_caepf			= coalesce(pls_sib_movimento_w.cd_caepf,cd_caepf),
				cd_relacao_dependencia		= coalesce(pls_sib_movimento_w.cd_relacao_dependencia,cd_relacao_dependencia),
				ie_tipo_endereco		= coalesce(pls_sib_movimento_w.ie_tipo_endereco,ie_tipo_endereco),
				ds_logradouro			= coalesce(pls_sib_movimento_w.ds_logradouro,ds_logradouro),
				nr_logradouro			= coalesce(pls_sib_movimento_w.nr_logradouro,nr_logradouro),
				ds_complemento			= coalesce(pls_sib_movimento_w.ds_complemento,ds_complemento),
				ds_bairro			= coalesce(pls_sib_movimento_w.ds_bairro,ds_bairro),
				cd_municipio_ibge		= coalesce(pls_sib_movimento_w.cd_municipio_ibge,cd_municipio_ibge),
				cd_cep				= coalesce(pls_sib_movimento_w.cd_cep,cd_cep),
				ie_reside_exterior		= coalesce(pls_sib_movimento_w.ie_reside_exterior,ie_reside_exterior),
				cd_municipio_ibge_resid		= coalesce(pls_sib_movimento_w.cd_municipio_ibge_resid,cd_municipio_ibge_resid),
				dt_cancelamento			= coalesce(pls_sib_movimento_w.dt_cancelamento,dt_cancelamento),
				cd_motivo_cancelamento		= coalesce(pls_sib_movimento_w.cd_motivo_cancelamento,cd_motivo_cancelamento),
				dt_reativacao			= coalesce(pls_sib_movimento_w.dt_reativacao,dt_reativacao)
			where	nr_sequencia = nr_seq_sib_segurado_w;
		end if;
	end if;
	
	commit;
end if;
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_sib_segurado_pck.alterar_sib_segurado ( nr_seq_movimento_p pls_sib_movimento.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;
