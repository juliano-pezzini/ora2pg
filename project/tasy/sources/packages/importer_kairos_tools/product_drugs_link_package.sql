-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


/**
 * DRP
*/
CREATE OR REPLACE PROCEDURE importer_kairos_tools.product_drugs_link ( cd_composto_p COMPOSTO_MATGLOBAL.CD_COMPOSTO%type, cd_mat_global_p MATERIAL_GLOBAL.CD_MATERIAL_GLO%type ) AS $body$
DECLARE


cd_material_glo_w		MATERIAL_GLOBAL.CD_MATERIAL_GLO%type;
cd_composto_w 			COMPOSTO_MATGLOBAL.CD_COMPOSTO%type;
nr_seq_existing_link_w		COMP_MATERIAL_GLOBAL.NR_SEQUENCIA%type;

cProducts CURSOR FOR
SELECT 	a.CD_MATERIAL_GLO
FROM	MATERIAL_GLOBAL a
WHERE	CD_INTERNO = cd_mat_global_p;


BEGIN
	cd_composto_w 		:= coalesce(importer_kairos_tools.get_conversion_value('COMPOSTO_MATGLOBAL', 'CD_COMPOSTO', cd_composto_p), cd_composto_p);

	OPEN cProducts;
		 loop
		 	FETCH 	cProducts
		 	INTO cd_material_glo_w;
			
			SELECT 	MAX(a.nr_sequencia)
			INTO STRICT 	nr_seq_existing_link_w
			FROM 	COMP_MATERIAL_GLOBAL a
			WHERE	a.CD_COMPOSTO 		= cd_composto_w
			AND 	a.CD_MATERIAL_GLO 	= cd_material_glo_w;

			IF (coalesce(nr_seq_existing_link_w::text, '') = '') THEN
				INSERT INTO COMP_MATERIAL_GLOBAL(
					NR_SEQUENCIA,
					CD_COMPOSTO,
					CD_MATERIAL_GLO,
					IE_SITUACAO,
					DT_ATUALIZACAO,
					DT_ATUALIZACAO_NREC,
					NM_USUARIO,
					NM_USUARIO_NREC
				) VALUES (
					nextval('comp_material_global_seq'),
					cd_composto_w,
					cd_material_glo_w,
					'A',
					current_setting('importer_kairos_tools.dt_atual_s')::W_KAIROS.DT_IMPORTACAO%type,
					current_setting('importer_kairos_tools.dt_atual_s')::W_KAIROS.DT_IMPORTACAO%type,
					current_setting('importer_kairos_tools.nm_usuario_s')::W_KAIROS.NM_USUARIO%type,
					current_setting('importer_kairos_tools.nm_usuario_s')::W_KAIROS.NM_USUARIO%type
				);
			END IF;

		 	EXIT WHEN NOT FOUND; /* apply on cProducts */
		 end loop;
	CLOSE cProducts;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE importer_kairos_tools.product_drugs_link ( cd_composto_p COMPOSTO_MATGLOBAL.CD_COMPOSTO%type, cd_mat_global_p MATERIAL_GLOBAL.CD_MATERIAL_GLO%type ) FROM PUBLIC;
