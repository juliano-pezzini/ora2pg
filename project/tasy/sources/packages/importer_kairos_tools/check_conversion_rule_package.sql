-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE importer_kairos_tools.check_conversion_rule ( nm_table_p CONVERSAO_MEIO_EXTERNO.NM_TABELA%type, nm_attribute_p CONVERSAO_MEIO_EXTERNO.NM_ATRIBUTO%type, ds_conversion_rule_p REGRA_CONV_MEIO_EXT.DS_REGRA%type DEFAULT 'Kairos price table importation', cd_external_p CONVERSAO_MEIO_EXTERNO.CD_EXTERNO%type DEFAULT NULL, cd_internal_p CONVERSAO_MEIO_EXTERNO.CD_INTERNO%type DEFAULT NULL) AS $body$
DECLARE


nr_seq_rule_w 			REGRA_CONV_MEIO_EXT.NR_SEQUENCIA%type;
cd_internal_w			CONVERSAO_MEIO_EXTERNO.CD_INTERNO%type;


BEGIN
	SELECT 	MAX(a.NR_SEQUENCIA)
	INTO STRICT	nr_seq_rule_w
	FROM 	REGRA_CONV_MEIO_EXT a
	WHERE 	a.DS_REGRA 	= ds_conversion_rule_p
	AND	a.IE_SITUACAO 	= 'A';

	IF (coalesce(nr_seq_rule_w::text, '') = '') THEN
		SELECT 	nextval('regra_conv_meio_ext_seq')
		INTO STRICT 	nr_seq_rule_w
		;

		INSERT INTO REGRA_CONV_MEIO_EXT(
			NR_SEQUENCIA,
			DS_REGRA,
			IE_SITUACAO,
			NM_USUARIO,
			NM_USUARIO_NREC,
			DT_ATUALIZACAO,
			DT_ATUALIZACAO_NREC
		) VALUES (
			nr_seq_rule_w,
			ds_conversion_rule_p,
			'A',
			current_setting('importer_kairos_tools.nm_usuario_s')::W_KAIROS.NM_USUARIO%type,
			current_setting('importer_kairos_tools.nm_usuario_s')::W_KAIROS.NM_USUARIO%type,
			current_setting('importer_kairos_tools.dt_atual_s')::W_KAIROS.DT_IMPORTACAO%type,
			current_setting('importer_kairos_tools.dt_atual_s')::W_KAIROS.DT_IMPORTACAO%type
		);
	END IF;

	cd_internal_w := importer_kairos_tools.get_conversion_value(nm_table_p, nm_attribute_p, cd_external_p);

	IF (coalesce(cd_internal_w::text, '') = '') THEN
		INSERT INTO CONVERSAO_MEIO_EXTERNO(
			NR_SEQUENCIA,
			NR_SEQ_REGRA,
			NM_TABELA,
			NM_ATRIBUTO,
			CD_EXTERNO,
			CD_INTERNO,
			IE_ENVIO_RECEB,
			NM_USUARIO,
			DT_ATUALIZACAO
		) VALUES (
			nextval('conversao_meio_externo_seq'),
			nr_seq_rule_w,
			nm_table_p,
			nm_attribute_p,
			cd_external_p,
			cd_internal_p,
			'R',
			current_setting('importer_kairos_tools.nm_usuario_s')::W_KAIROS.NM_USUARIO%type,
			current_setting('importer_kairos_tools.dt_atual_s')::W_KAIROS.DT_IMPORTACAO%type
		);
	END IF;
	COMMIT;
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE importer_kairos_tools.check_conversion_rule ( nm_table_p CONVERSAO_MEIO_EXTERNO.NM_TABELA%type, nm_attribute_p CONVERSAO_MEIO_EXTERNO.NM_ATRIBUTO%type, ds_conversion_rule_p REGRA_CONV_MEIO_EXT.DS_REGRA%type DEFAULT 'Kairos price table importation', cd_external_p CONVERSAO_MEIO_EXTERNO.CD_EXTERNO%type DEFAULT NULL, cd_internal_p CONVERSAO_MEIO_EXTERNO.CD_INTERNO%type DEFAULT NULL) FROM PUBLIC;
