-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


/**
 * BASPRO
*/
CREATE OR REPLACE PROCEDURE importer_kairos_tools.save_product ( cd_product_p MATERIAL_GLOBAL.CD_MATERIAL_GLO%type, ds_product_p MATERIAL_GLOBAL.DS_MATERIAL_GLO%type, cd_laboratory_p LABORATORIO_MATGLOBAL.CD_LABORATORIO%type, cd_sell_type_p TIPO_VENDA_MATGLOBAL.CD_TIPO_VENDA%type, ie_importado_p MATERIAL_GLOBAL.IE_IMPORTADO%type, ie_situation_p MATERIAL_GLOBAL.IE_SITUACAO%type ) AS $body$
DECLARE


cd_product_w 			MATERIAL_GLOBAL.CD_MATERIAL_GLO%type;
cd_sell_type_w		TIPO_VENDA_MATGLOBAL.CD_TIPO_VENDA%type;


BEGIN
	cd_sell_type_w	:= coalesce(importer_kairos_tools.get_conversion_value('TIPO_VENDA_MATGLOBAL', 'CD_TIPO_VENDA', cd_sell_type_p), cd_sell_type_p);

	SELECT 	MAX(a.CD_MATERIAL_GLO)
	INTO STRICT 	cd_product_w
	FROM 	MATERIAL_GLOBAL a
	WHERE	CD_INTERNO = cd_product_p;

	IF (cd_product_w IS NOT NULL AND cd_product_w::text <> '') THEN
		UPDATE 	MATERIAL_GLOBAL
		SET 	CD_TIPO_VENDA 	= cd_sell_type_w
		WHERE 	CD_MATERIAL_GLO = cd_product_w;
		COMMIT;
	ELSIF (coalesce(cd_product_w::text, '') = '') THEN
		CALL importer_kairos_tools.validate_cd_product(cd_product_p, ds_product_p, cd_laboratory_p, cd_sell_type_w, ie_importado_p, ie_situation_p);
	END IF;
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE importer_kairos_tools.save_product ( cd_product_p MATERIAL_GLOBAL.CD_MATERIAL_GLO%type, ds_product_p MATERIAL_GLOBAL.DS_MATERIAL_GLO%type, cd_laboratory_p LABORATORIO_MATGLOBAL.CD_LABORATORIO%type, cd_sell_type_p TIPO_VENDA_MATGLOBAL.CD_TIPO_VENDA%type, ie_importado_p MATERIAL_GLOBAL.IE_IMPORTADO%type, ie_situation_p MATERIAL_GLOBAL.IE_SITUACAO%type ) FROM PUBLIC;
