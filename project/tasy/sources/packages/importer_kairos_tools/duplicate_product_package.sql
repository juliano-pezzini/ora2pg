-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE importer_kairos_tools.duplicate_product ( cd_internal_p MATERIAL_GLOBAL.CD_INTERNO%type ) AS $body$
DECLARE

cd_material_glo_w	MATERIAL_GLOBAL.CD_MATERIAL_GLO%type;
cd_material_glo_new_w	MATERIAL_GLOBAL.CD_MATERIAL_GLO%type;

BEGIN
	SELECT 	MAX(a.CD_MATERIAL_GLO)
	INTO STRICT 	cd_material_glo_w
	FROM	MATERIAL_GLOBAL a
	WHERE	a.CD_INTERNO = cd_internal_p;

	SELECT MAX(CD_MATERIAL_GLO + 1)
	KEEP(DENSE_RANK LAST ORDER BY (REGEXP_REPLACE(a.CD_MATERIAL_GLO, '[^[:digit:]]', ''))::numeric ) LAST_SEQUENCE
	INTO STRICT 	cd_material_glo_new_w
	FROM	MATERIAL_GLOBAL a;

	INSERT INTO MATERIAL_GLOBAL(
		CD_MATERIAL_GLO,
		DS_MATERIAL_GLO,
		CD_INTERNO,
		CD_ESTABELECIMENTO,
		CD_LABORATORIO,
		CD_TIPO_VENDA,
		IE_IMPORTADO,
		IE_SITUACAO,
		DT_ATUALIZACAO,
		DT_ATUALIZACAO_NREC,
		NM_USUARIO,
		NM_USUARIO_NREC
	)
	SELECT 	cd_material_glo_new_w,
		a.DS_MATERIAL_GLO,
		cd_internal_p,
		a.CD_ESTABELECIMENTO,
		a.CD_LABORATORIO,
		a.CD_TIPO_VENDA,
		a.IE_IMPORTADO,
		a.IE_SITUACAO,
		current_setting('importer_kairos_tools.dt_atual_s')::W_KAIROS.DT_IMPORTACAO%type,
		current_setting('importer_kairos_tools.dt_atual_s')::W_KAIROS.DT_IMPORTACAO%type,
		current_setting('importer_kairos_tools.nm_usuario_s')::W_KAIROS.NM_USUARIO%type,
		current_setting('importer_kairos_tools.nm_usuario_s')::W_KAIROS.NM_USUARIO%type
	FROM	MATERIAL_GLOBAL a
	WHERE	CD_MATERIAL_GLO = cd_material_glo_w;
	COMMIT;
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE importer_kairos_tools.duplicate_product ( cd_internal_p MATERIAL_GLOBAL.CD_INTERNO%type ) FROM PUBLIC;
