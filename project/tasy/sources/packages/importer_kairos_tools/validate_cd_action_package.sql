-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE importer_kairos_tools.validate_cd_action ( cd_action_p ACAO_MATGLOBAL.CD_ACAO%type, ds_action_p ACAO_MATGLOBAL.DS_ACAO%type, ie_situation_p ACAO_MATGLOBAL.IE_SITUACAO%type DEFAULT 'A') AS $body$
DECLARE

cd_action_w 		ACAO_MATGLOBAL.CD_ACAO%type;
cd_action_new_w 	ACAO_MATGLOBAL.CD_ACAO%type;

BEGIN
	SELECT  MAX(a.CD_ACAO)
	INTO STRICT    cd_action_w
	FROM    ACAO_MATGLOBAL a
	WHERE   a.CD_ACAO = cd_action_p;

	IF (coalesce(cd_action_w::text, '') = '') THEN
		CALL CALL importer_kairos_tools.insert_action(cd_action_p, ds_action_p, ie_situation_p);
	ELSE
		SELECT 	MAX(a.CD_ACAO + 1)
		KEEP(DENSE_RANK LAST ORDER BY (REGEXP_REPLACE(a.CD_ACAO, '[^[:digit:]]', ''))::numeric ) LAST_SEQUENCE
		INTO STRICT    cd_action_new_w
		FROM    ACAO_MATGLOBAL a;

		CALL CALL importer_kairos_tools.insert_action(cd_action_new_w, ds_action_p, ie_situation_p);

		CALL importer_kairos_tools.check_conversion_rule(
			nm_table_p	=> 'ACAO_MATGLOBAL',
			nm_attribute_p	=> 'CD_ACAO',
			cd_external_p	=> cd_action_p,
			cd_internal_p	=> cd_action_new_w
		);
	END IF;
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE importer_kairos_tools.validate_cd_action ( cd_action_p ACAO_MATGLOBAL.CD_ACAO%type, ds_action_p ACAO_MATGLOBAL.DS_ACAO%type, ie_situation_p ACAO_MATGLOBAL.IE_SITUACAO%type DEFAULT 'A') FROM PUBLIC;
