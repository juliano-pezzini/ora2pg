-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE importer_kairos_tools.validate_cd_laboratory ( cd_laboratory_p LABORATORIO_MATGLOBAL.CD_LABORATORIO%type, ds_laboratory_p LABORATORIO_MATGLOBAL.DS_LABORATORIO%type, ie_situation_p LABORATORIO_MATGLOBAL.IE_SITUACAO%type DEFAULT 'A') AS $body$
DECLARE


cd_laboratory_w 		LABORATORIO_MATGLOBAL.CD_LABORATORIO%type;
cd_laboratory_new_w 		LABORATORIO_MATGLOBAL.CD_LABORATORIO%type;


BEGIN
	SELECT  MAX(a.CD_LABORATORIO)
	INTO STRICT    cd_laboratory_w
	FROM    LABORATORIO_MATGLOBAL a
	WHERE   a.CD_LABORATORIO = cd_laboratory_p;

	IF (coalesce(cd_laboratory_w::text, '') = '') THEN
		CALL CALL importer_kairos_tools.insert_laboratory(cd_laboratory_p, ds_laboratory_p, ie_situation_p);
	ELSE
		SELECT MAX(a.CD_LABORATORIO + 1)
		KEEP(DENSE_RANK LAST ORDER BY (REGEXP_REPLACE(a.CD_LABORATORIO, '[^[:digit:]]', ''))::numeric ) LAST_SEQUENCE
		INTO STRICT    cd_laboratory_new_w
		FROM    LABORATORIO_MATGLOBAL a;

		CALL CALL importer_kairos_tools.insert_laboratory(cd_laboratory_new_w, ds_laboratory_p, ie_situation_p);

		CALL importer_kairos_tools.check_conversion_rule(
				nm_table_p 	=> 'LABORATORIO_MATGLOBAL',
				nm_attribute_p 	=> 'CD_LABORATORIO',
				cd_external_p 	=> cd_laboratory_p,
				cd_internal_p 	=> cd_laboratory_new_w
		);
	END IF;
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE importer_kairos_tools.validate_cd_laboratory ( cd_laboratory_p LABORATORIO_MATGLOBAL.CD_LABORATORIO%type, ds_laboratory_p LABORATORIO_MATGLOBAL.DS_LABORATORIO%type, ie_situation_p LABORATORIO_MATGLOBAL.IE_SITUACAO%type DEFAULT 'A') FROM PUBLIC;
