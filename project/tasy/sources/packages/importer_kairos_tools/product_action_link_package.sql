-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


/**
 * ATP
*/
CREATE OR REPLACE PROCEDURE importer_kairos_tools.product_action_link ( cd_action_p ACAO_MATGLOBAL.CD_ACAO%type, cd_mat_global_p MATERIAL_GLOBAL.CD_MATERIAL_GLO%type, cd_link_priority_p text ) AS $body$
DECLARE


cd_material_glo_w		MATERIAL_GLOBAL.CD_MATERIAL_GLO%type;
cd_action_w 			ACAO_MATGLOBAL.CD_ACAO%type;


cProducts CURSOR FOR
SELECT 	a.CD_MATERIAL_GLO, a.CD_ACAO
FROM	MATERIAL_GLOBAL a
WHERE	CD_INTERNO = cd_mat_global_p;

BEGIN
	cd_action_w 	:= coalesce(importer_kairos_tools.get_conversion_value('ACAO_MATGLOBAL', 'CD_ACAO', cd_action_p), cd_action_p);

	FOR r_product IN cProducts
  	LOOP
  		IF (cd_link_priority_p = '1' OR coalesce(r_product.cd_acao::text, '') = '') THEN
  			UPDATE 	MATERIAL_GLOBAL
  			SET 	CD_ACAO = cd_action_w
  			WHERE 	CD_MATERIAL_GLO = r_product.cd_material_glo;
  		END IF;
  	END LOOP;
  	COMMIT;
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE importer_kairos_tools.product_action_link ( cd_action_p ACAO_MATGLOBAL.CD_ACAO%type, cd_mat_global_p MATERIAL_GLOBAL.CD_MATERIAL_GLO%type, cd_link_priority_p text ) FROM PUBLIC;
