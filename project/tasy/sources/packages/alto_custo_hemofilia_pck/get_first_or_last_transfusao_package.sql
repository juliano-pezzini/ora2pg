-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION alto_custo_hemofilia_pck.get_first_or_last_transfusao ( cd_pessoa_fisica_p pessoa_fisica.cd_pessoa_fisica%type, option_p text ) RETURNS bigint AS $body$
DECLARE

    ds_retorno_w  paciente_transfusao.nr_sequencia%type;

BEGIN
    select  case
              when option_p = current_setting('alto_custo_hemofilia_pck.option_first_w')::varchar(1)
                then min(p.nr_sequencia)
              when option_p = current_setting('alto_custo_hemofilia_pck.option_last_w')::varchar(1)
                then max(p.nr_sequencia)
              else
                null
            end
    into STRICT    ds_retorno_w
    from    paciente_transfusao p
    where   p.cd_pessoa_fisica = cd_pessoa_fisica_p
    and     trunc(p.dt_transfusao) >= alto_custo_pck.get_data_inicio_emissao_guia
    and     trunc(p.dt_transfusao) <= alto_custo_pck.get_data_corte
    and     (p.dt_liberacao IS NOT NULL AND p.dt_liberacao::text <> '')
    and     p.ie_situacao = 'A';

    return ds_retorno_w;
  END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION alto_custo_hemofilia_pck.get_first_or_last_transfusao ( cd_pessoa_fisica_p pessoa_fisica.cd_pessoa_fisica%type, option_p text ) FROM PUBLIC;
