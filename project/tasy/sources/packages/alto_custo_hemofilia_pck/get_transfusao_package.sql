-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION alto_custo_hemofilia_pck.get_transfusao (nr_seq_transfusao_p san_producao.nr_seq_transfusao%type) RETURNS varchar AS $body$
DECLARE

    ds_retorno_w    san_derivado.ie_tipo_derivado%type;

BEGIN
      select  max(ie_tipo_derivado) 
      into STRICT    ds_retorno_w
      from (
                SELECT  e.ie_tipo_derivado
                FROM san_derivado e, san_tipo_doacao c, pessoa_fisica b, san_doacao a, san_producao d
LEFT OUTER JOIN san_derivado_reintegrado g ON (d.nr_sequencia = g.nr_seq_producao)
LEFT OUTER JOIN san_producao_lib_venc h ON (d.nr_sequencia = h.nr_seq_producao)
LEFT OUTER JOIN san_emprestimo i ON (d.nr_seq_emp_saida = i.nr_sequencia)
WHERE d.nr_seq_transfusao = nr_seq_transfusao_p and coalesce(d.nr_seq_emp_ent::text, '') = '' and a.nr_sequencia = d.nr_seq_doacao and b.cd_pessoa_fisica = a.cd_pessoa_fisica and c.nr_sequencia = a.nr_seq_tipo and e.nr_sequencia = d.nr_seq_derivado    and (
                          i.dt_emprestimo < g.dt_reintegracao
                          or coalesce(g.dt_reintegracao::text, '') = ''
                        )
                 
union

                SELECT  e.ie_tipo_derivado
                FROM san_derivado e, san_entidade b, san_emprestimo a, san_producao d
LEFT OUTER JOIN san_producao_lib_venc h ON (d.nr_sequencia = h.nr_seq_producao)
WHERE d.nr_seq_transfusao = nr_seq_transfusao_p and a.nr_sequencia = d.nr_seq_emp_ent and b.nr_sequencia = a.nr_seq_entidade and e.nr_sequencia = d.nr_seq_derivado  
union

                select  e.ie_tipo_derivado
                FROM san_derivado e, san_agrupamento a, san_producao d
LEFT OUTER JOIN san_producao_lib_venc h ON (d.nr_sequencia = h.nr_seq_producao)
WHERE d.nr_seq_transfusao = nr_seq_transfusao_p and a.nr_sequencia = d.nr_seq_agrupamento and e.nr_sequencia = d.nr_seq_derivado  ) alias4;

    return ds_retorno_w;
  END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION alto_custo_hemofilia_pck.get_transfusao (nr_seq_transfusao_p san_producao.nr_seq_transfusao%type) FROM PUBLIC;
