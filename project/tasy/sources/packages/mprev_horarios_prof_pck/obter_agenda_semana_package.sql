-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION mprev_horarios_prof_pck.obter_agenda_semana (cd_agenda_p bigint, dt_mes_p timestamp, ie_numero_semana_p bigint) RETURNS SETOF T_HORARIO_PROF_DATA AS $body$
DECLARE


	i			bigint;
	linha_w			t_horario_prof_row;
	dt_inicio_semana_w	timestamp;
	ds_segunda_w		varchar(50);
	ds_terca_w		varchar(50);
	ds_quarta_w		varchar(50);
	ds_quinta_w		varchar(50);
	ds_sexta_w		varchar(50);
	ds_sabado_w		varchar(50);
	ds_domingo_w		varchar(50);
	ie_dia_inicio_semana_w	integer;
	ds_bloqueio_w			varchar(50);
	ds_bloqueio_seg_w		varchar(50);
	ds_bloqueio_ter_w		varchar(50);
	ds_bloqueio_qua_w		varchar(50);
	ds_bloqueio_qui_w		varchar(50);
	ds_bloqueio_sex_w		varchar(50);
	ds_bloqueio_sab_w		varchar(50);
	ds_bloqueio_dom_w		varchar(50);
	ie_presenca_seg_w	varchar(2)	:= null;
	ie_presenca_ter_w	varchar(2)	:= null;
	ie_presenca_qua_w	varchar(2)	:= null;
	ie_presenca_qui_w	varchar(2)	:= null;
	ie_presenca_sex_w	varchar(2)	:= null;
	ie_presenca_sab_w	varchar(2)	:= null;
	ie_presenca_dom_w	varchar(2)	:= null;
	ds_presente_w		varchar(255)	:= null;
	ie_motivo_bloqueio_w	varchar(3)	:= null;
	dia_inicio_bloqueio_w	smallint;
	dt_horario_w		timestamp;

	C01 CURSOR(cd_agenda_pc		bigint,
		dt_inicio_semana_pc	timestamp) FOR
		SELECT	a.horario,
			max(a.ie_segunda) ie_segunda,
			max(a.ie_terca) ie_terca,
			max(a.ie_quarta) ie_quarta,
			max(a.ie_quinta) ie_quinta,
			max(a.ie_sexta) ie_sexta,
			max(a.ie_sabado) ie_sabado,
			max(a.ie_domingo) ie_domingo
		from	table(mprev_horarios_prof_pck.obter_horarios_semana(cd_agenda_pc,dt_inicio_semana_pc)) a
		group by horario
		order by
			horario;

	
BEGIN

	dt_inicio_semana_w	:= trunc(dt_mes_p,'month');
	for i in 2.. ie_numero_semana_p loop
		if (dt_inicio_semana_w + 7 > last_day(dt_inicio_semana_w)) then
			dt_inicio_semana_w	:= last_day(dt_inicio_semana_w);
		else
			dt_inicio_semana_w	:= dt_inicio_semana_w + 7;
		end if;
	end loop;
	dt_inicio_semana_w	:= obter_inicio_semana(dt_inicio_semana_w);
	for r_C01 in C01(cd_agenda_p,dt_inicio_semana_w) loop
		-- Verificar para cada dia do horário se há ausência/bloqueio registrada
		for	qt_dia_w in 0.. 6 loop
			ds_presente_w	:= null;

			ds_bloqueio_w	:= null;
			if (length(r_C01.horario) > 3) then
				dt_horario_w	:= to_date(to_char(dt_inicio_semana_w + qt_dia_w,'dd/mm/yyyy') || ' ' ||
								r_C01.horario,'dd/mm/yyyy hh24:mi');

				begin
				select	substr(obter_valor_dominio(1007,a.ie_motivo_bloqueio),1,50)
				into STRICT	ds_bloqueio_w
				from	agenda_bloqueio a
				where	a.cd_agenda	= cd_agenda_p
				and	dt_horario_w between a.dt_inicial and fim_dia(a.dt_final)
				and (pkg_date_utils.get_weekday(dt_horario_w) = ie_dia_semana or coalesce(ie_dia_semana::text, '') = '')
				and (coalesce(a.hr_inicio_bloqueio::text, '') = '' or dt_horario_w >=
						to_date(to_char(a.dt_inicial,'dd/mm/yyyy') || ' ' ||
						to_char(a.hr_inicio_bloqueio,'hh24:mi'),'dd/mm/yyyy hh24:mi'))
				and (coalesce(a.hr_final_bloqueio::text, '') = '' or dt_horario_w <=
						to_date(to_char(a.dt_final,'dd/mm/yyyy') || ' ' ||
						to_char(a.hr_final_bloqueio,'hh24:mi'),'dd/mm/yyyy hh24:mi'));
				exception
					when others then
					ds_bloqueio_w	:= null;
				end;
			end if;

			ds_bloqueio_dom_w	:= null;
			ds_bloqueio_seg_w	:= null;
			ds_bloqueio_ter_w	:= null;
			ds_bloqueio_qua_w	:= null;
			ds_bloqueio_qui_w	:= null;
			ds_bloqueio_sex_w	:= null;
			ds_bloqueio_sab_w	:= null;

			if (ds_bloqueio_w IS NOT NULL AND ds_bloqueio_w::text <> '') then
				if (qt_dia_w = 0) then
					ds_bloqueio_dom_w	:= ds_bloqueio_w;
				elsif (qt_dia_w = 1) then
					ds_bloqueio_seg_w	:= ds_bloqueio_w;
				elsif (qt_dia_w = 2) then
					ds_bloqueio_ter_w	:= ds_bloqueio_w;
				elsif (qt_dia_w = 3) then
					ds_bloqueio_qua_w	:= ds_bloqueio_w;
				elsif (qt_dia_w = 4) then
					ds_bloqueio_qui_w	:= ds_bloqueio_w;
				elsif (qt_dia_w = 5) then
					ds_bloqueio_sex_w	:= ds_bloqueio_w;
				elsif (qt_dia_w = 6) then
					ds_bloqueio_sab_w	:= ds_bloqueio_w;
				end if;
			end if;

			if (qt_dia_w = 0) then
				if (ds_bloqueio_dom_w IS NOT NULL AND ds_bloqueio_dom_w::text <> '') then
					ds_domingo_w	:= ds_bloqueio_dom_w;
					ie_presenca_dom_w	:= 'A';
				else
					ds_domingo_w	:= r_C01.ie_domingo;
					if (length(r_C01.horario) > 3) and (ds_domingo_w IS NOT NULL AND ds_domingo_w::text <> '') then
						ie_presenca_dom_w	:= 'P';
					end if;
				end if;
			elsif (qt_dia_w = 1) then
				if (ds_bloqueio_seg_w IS NOT NULL AND ds_bloqueio_seg_w::text <> '') then
					ds_segunda_w		:= ds_bloqueio_seg_w;
					ie_presenca_seg_w	:= 'A';
				else
					ds_segunda_w	:= r_C01.ie_segunda;
					if (length(r_C01.horario) > 3) and (ds_segunda_w IS NOT NULL AND ds_segunda_w::text <> '') then
						ie_presenca_seg_w	:= 'P';
					end if;
				end if;
			elsif (qt_dia_w = 2) then
				if (ds_bloqueio_ter_w IS NOT NULL AND ds_bloqueio_ter_w::text <> '') then
					ds_terca_w		:= ds_bloqueio_ter_w;
					ie_presenca_ter_w	:= 'A';
				else
					ds_terca_w		:= r_C01.ie_terca;
					if (length(r_C01.horario) > 3) and (ds_terca_w IS NOT NULL AND ds_terca_w::text <> '') then
						ie_presenca_ter_w	:= 'P';
					end if;
				end if;
			elsif (qt_dia_w = 3) then
				if (ds_bloqueio_qua_w IS NOT NULL AND ds_bloqueio_qua_w::text <> '') then
					ds_quarta_w		:= ds_bloqueio_qua_w;
					ie_presenca_qua_w	:= 'A';
				else
					ds_quarta_w		:= r_C01.ie_quarta;
					if (length(r_C01.horario) > 3) and (ds_quarta_w IS NOT NULL AND ds_quarta_w::text <> '') then
						ie_presenca_qua_w	:= 'P';
					end if;
				end if;
			elsif (qt_dia_w = 4) then
				if (ds_bloqueio_qui_w IS NOT NULL AND ds_bloqueio_qui_w::text <> '') then
					ds_quinta_w	:= ds_bloqueio_qui_w;
					ie_presenca_qui_w	:= 'A';
				else
					ds_quinta_w	:= r_C01.ie_quinta;
					if (length(r_C01.horario) > 3) and (ds_quinta_w IS NOT NULL AND ds_quinta_w::text <> '') then
						ie_presenca_qui_w	:= 'P';
					end if;
				end if;
			elsif (qt_dia_w = 5) then
				if (ds_bloqueio_sex_w IS NOT NULL AND ds_bloqueio_sex_w::text <> '') then
					ds_sexta_w	:= ds_bloqueio_sex_w;
					ie_presenca_sex_w	:= 'A';
				else
					ds_sexta_w	:= r_C01.ie_sexta;
					if (length(r_C01.horario) > 3) and (ds_sexta_w IS NOT NULL AND ds_sexta_w::text <> '') then
						ie_presenca_sex_w	:= 'P';
					end if;
				end if;
			elsif (qt_dia_w = 6) then
				if (ds_bloqueio_sab_w IS NOT NULL AND ds_bloqueio_sab_w::text <> '') then
					ds_sabado_w	:= ds_bloqueio_sab_w;
					ie_presenca_sab_w	:= 'A';
				else
					ds_sabado_w	:= r_C01.ie_sabado;
					if (length(r_C01.horario) > 3) and (ds_sabado_w IS NOT NULL AND ds_sabado_w::text <> '') then
						ie_presenca_sab_w	:= 'P';
					end if;
				end if;
			end if;
		end loop;
		/* A partir da entrada ou fim do intervalo está presente */

		if (ds_segunda_w in ('EN','FI')) then
			ie_presenca_seg_w	:= 'P';
		end if;
		if (ds_terca_w in ('EN','FI')) then
			ie_presenca_ter_w	:= 'P';
		end if;
		if (ds_quarta_w in ('EN','FI')) then
			ie_presenca_qua_w	:= 'P';
		end if;
		if (ds_quinta_w in ('EN','FI')) then
			ie_presenca_qui_w	:= 'P';
		end if;
		if (ds_sexta_w in ('EN','FI')) then
			ie_presenca_sex_w	:= 'P';
		end if;
		if (ds_sabado_w in ('EN','FI')) then
			ie_presenca_sab_w	:= 'P';
		end if;
		if (ds_domingo_w in ('EN','FI')) then
			ie_presenca_dom_w	:= 'P';
		end if;

		linha_w.horario 	:= r_C01.horario;
		linha_w.ie_segunda 	:= ds_segunda_w;
		linha_w.ie_presenca_seg	:= ie_presenca_seg_w;
		linha_w.ie_terca 	:= ds_terca_w;
		linha_w.ie_presenca_ter	:= ie_presenca_ter_w;
		linha_w.ie_quarta 	:= ds_quarta_w;
		linha_w.ie_presenca_qua	:= ie_presenca_qua_w;
		linha_w.ie_quinta 	:= ds_quinta_w;
		linha_w.ie_presenca_qui	:= ie_presenca_qui_w;
		linha_w.ie_sexta 	:= ds_sexta_w;
		linha_w.ie_presenca_sex	:= ie_presenca_sex_w;
		linha_w.ie_sabado 	:= ds_sabado_w;
		linha_w.ie_presenca_sab	:= ie_presenca_sab_w;
		linha_w.ie_domingo 	:= ds_domingo_w;
		linha_w.ie_presenca_dom	:= ie_presenca_dom_w;
		RETURN NEXT linha_w;

		/* A partir da saída ou início do intervalo não está mais presente */

		if	((ds_segunda_w in ('II','SA')) or (ie_presenca_seg_w = 'A')) then
			ie_presenca_seg_w	:= null;
		end if;
		if	((ds_terca_w in ('II','SA')) or (ie_presenca_ter_w = 'A')) then
			ie_presenca_ter_w	:= null;
		end if;
		if	((ds_quarta_w in ('II','SA')) or (ie_presenca_qua_w = 'A')) then
			ie_presenca_qua_w	:= null;
		end if;
		if	((ds_quinta_w in ('II','SA')) or (ie_presenca_qui_w = 'A')) then
			ie_presenca_qui_w	:= null;
		end if;
		if	((ds_sexta_w in ('II','SA')) or (ie_presenca_sex_w = 'A')) then
			ie_presenca_sex_w	:= null;
		end if;
		if	((ds_sabado_w in ('II','SA')) or (ie_presenca_sab_w = 'A')) then
			ie_presenca_sab_w	:= null;
		end if;
		if	((ds_domingo_w in ('II','SA')) or (ie_presenca_dom_w = 'A')) then
			ie_presenca_dom_w	:= null;
		end if;
	end loop;

	return;

	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION mprev_horarios_prof_pck.obter_agenda_semana (cd_agenda_p bigint, dt_mes_p timestamp, ie_numero_semana_p bigint) FROM PUBLIC;
