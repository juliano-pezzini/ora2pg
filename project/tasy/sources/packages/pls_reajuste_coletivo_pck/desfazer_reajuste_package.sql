-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_reajuste_coletivo_pck.desfazer_reajuste ( nr_seq_reajuste_p pls_reajuste.nr_sequencia%type, ie_excluir_lote_reajuste_p text, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) AS $body$
DECLARE


C01 CURSOR FOR
	SELECT	nr_sequencia nr_seq_reajuste
	from	pls_reajuste
	where	nr_seq_lote_referencia = nr_seq_reajuste_p;

BEGIN

CALL CALL CALL pls_reajuste_coletivo_pck.carregar_filtros_lote(nr_seq_reajuste_p);

update	pls_prog_reaj_coletivo
set	nr_seq_reajuste  = NULL,
	ie_status	= 'L',
	dt_atualizacao	= clock_timestamp(),
	nm_usuario	= nm_usuario_p
where	nr_seq_reajuste in (	SELECT	nr_sequencia
				from	pls_reajuste
				where	nr_seq_lote_referencia = nr_seq_reajuste_p);

delete from pls_reajuste_consistencia
where	nr_seq_reajuste = nr_seq_reajuste_p;

delete from pls_reajuste_apropriacao
where	nr_seq_reajuste in (	SELECT	nr_sequencia
				from	pls_reajuste
				where	nr_seq_lote_referencia = nr_seq_reajuste_p);

delete from pls_reajuste_cobr_retro
where	nr_seq_reajuste in (	SELECT	nr_sequencia
				from	pls_reajuste
				where	nr_seq_lote_referencia = nr_seq_reajuste_p);

delete from pls_reajuste_inscricao a
where	a.nr_seq_lote in (	SELECT	x.nr_sequencia
				from	pls_lote_reaj_inscricao x,
					pls_reajuste y
				where	y.nr_sequencia = x.nr_seq_reajuste
				and	y.nr_seq_lote_referencia = nr_seq_reajuste_p);

delete from pls_reajuste_pos_estab a
where	a.nr_seq_lote in (	SELECT	x.nr_sequencia
				from	pls_lote_reaj_pos_estab x,
					pls_reajuste y
				where	y.nr_sequencia = x.nr_seq_reajuste
				and	y.nr_seq_lote_referencia = nr_seq_reajuste_p);

delete from pls_reajuste_copartic a
where	a.nr_seq_lote in (	SELECT	x.nr_sequencia
				from	pls_lote_reaj_copartic x,
					pls_reajuste y
				where	y.nr_sequencia = x.nr_seq_reajuste
				and	y.nr_seq_lote_referencia = nr_seq_reajuste_p);

delete from pls_reajuste_via_cart a
where	a.nr_seq_lote in (	SELECT	x.nr_sequencia
				from	pls_lote_reaj_via_cart x,
					pls_reajuste y
				where	y.nr_sequencia = x.nr_seq_reajuste
				and	y.nr_seq_lote_referencia = nr_seq_reajuste_p);

delete from pls_lote_reaj_pos_estab
where	nr_seq_reajuste in (	SELECT	nr_sequencia
				from	pls_reajuste
				where	nr_seq_lote_referencia = nr_seq_reajuste_p);

delete from pls_lote_reaj_inscricao
where	nr_seq_reajuste in (	SELECT	nr_sequencia
				from	pls_reajuste
				where	nr_seq_lote_referencia = nr_seq_reajuste_p);

delete from pls_lote_reaj_copartic
where	nr_seq_reajuste in (	SELECT	nr_sequencia
				from	pls_reajuste
				where	nr_seq_lote_referencia = nr_seq_reajuste_p);

delete from pls_lote_reaj_via_cart
where	nr_seq_reajuste in (	SELECT	nr_sequencia
				from	pls_reajuste
				where	nr_seq_lote_referencia = nr_seq_reajuste_p);

delete from pls_reajuste_preco
where	nr_seq_reajuste in (	SELECT	nr_sequencia
				from	pls_reajuste
				where	nr_seq_lote_referencia = nr_seq_reajuste_p);

delete from pls_reajuste_tabela
where	nr_seq_reajuste in (	SELECT	nr_sequencia
				from	pls_reajuste
				where	nr_seq_lote_referencia = nr_seq_reajuste_p);

if (current_setting('pls_reajuste_coletivo_pck.pls_reajuste_w')::pls_reajuste%rowtype.ie_tipo_lote = 'D') then
	for r_c01_w in c01 loop
		begin
		update	pls_reajuste
		set	nr_seq_lote_deflator  = NULL
		where	nr_sequencia in (SELECT	nr_sequencia
					from	pls_reajuste
					where	nr_seq_lote_deflator = r_c01_w.nr_seq_reajuste);
		end;
	end loop; --C01
	
	update	pls_reajuste
	set	nr_seq_lote_deflator  = NULL
	where	nr_sequencia in (SELECT	nr_sequencia
				from	pls_reajuste
				where	nr_seq_lote_deflator = nr_seq_reajuste_p);
end if;

delete from pls_reajuste
where	nr_seq_lote_referencia = nr_seq_reajuste_p;

if (current_setting('pls_reajuste_coletivo_pck.pls_reajuste_w')::pls_reajuste%rowtype.ie_tipo_lote = 'D') then
	delete from pls_reajuste
	where	nr_sequencia = nr_seq_reajuste_p;
else
	update	pls_reajuste
	set	ie_status	= '1',
		nm_usuario	= nm_usuario_p,
		dt_atualizacao	= clock_timestamp(),
		dt_fim_geracao	 = NULL,
		dt_inicio_geracao  = NULL
	where	nr_sequencia	= nr_seq_reajuste_p;
end if;

commit;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_reajuste_coletivo_pck.desfazer_reajuste ( nr_seq_reajuste_p pls_reajuste.nr_sequencia%type, ie_excluir_lote_reajuste_p text, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) FROM PUBLIC;
