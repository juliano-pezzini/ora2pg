-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_reajuste_coletivo_pck.alimentar_vetor_reaj_tabela ( nr_seq_tabela_p pls_tabela_preco.nr_sequencia%type, nr_seq_reajuste_p pls_reajuste.nr_sequencia%type, nr_seq_contrato_p pls_contrato.nr_sequencia%type, nr_seq_intercambio_p pls_intercambio.nr_sequencia%type, nr_seq_plano_p pls_plano.nr_sequencia%type, dt_contrato_p timestamp, nr_seq_segurado_p pls_segurado.nr_sequencia%type, nr_seq_titular_p pls_segurado.nr_seq_titular%type, cd_pessoa_fisica_p pessoa_fisica.cd_pessoa_fisica%type) AS $body$
DECLARE


nr_seq_processo_w		processo_judicial_liminar.nr_sequencia%type;
tx_reajuste_liminar_w		pls_reajuste.tx_reajuste%type;
qt_reaj_tabela_w		bigint;


BEGIN

select	count(1)
into STRICT	qt_reaj_tabela_w
from	pls_reajuste_tabela	a,
	pls_reajuste		b
where	a.nr_seq_reajuste	= b.nr_sequencia
and	a.nr_seq_tabela		= nr_seq_tabela_p
and	b.dt_reajuste		= current_setting('pls_reajuste_coletivo_pck.pls_reajuste_w')::pls_reajuste%rowtype.dt_reajuste
and	coalesce(b.nr_seq_lote_deflator::text, '') = ''
and	not exists (	SELECT	1
			from	pls_reajuste_tabela x,
				pls_reajuste z
			where	z.nr_sequencia	= x.nr_seq_reajuste
			and	z.nr_seq_lote_deflator = b.nr_sequencia
			and	x.nr_seq_tabela	= nr_seq_tabela_p
			and	z.dt_reajuste	= current_setting('pls_reajuste_coletivo_pck.pls_reajuste_w')::pls_reajuste%rowtype.dt_reajuste
			and	b.tx_reajuste_correto = 0);

if	((pls_reajuste_coletivo_pck.verifica_tabela_vetor(nr_seq_tabela_p) = 'N') and (qt_reaj_tabela_w = 0) and
	((current_setting('pls_reajuste_coletivo_pck.pls_reajuste_w')::pls_reajuste%coalesce(rowtype.nr_seq_plano::text, '') = '') or (current_setting('pls_reajuste_coletivo_pck.pls_reajuste_w')::pls_reajuste%rowtype.nr_seq_plano = nr_seq_plano_p))) then
	if ((nr_seq_segurado_p IS NOT NULL AND nr_seq_segurado_p::text <> '') or (nr_seq_contrato_p IS NOT NULL AND nr_seq_contrato_p::text <> '')) then
		pls_obter_processo_reaj(nr_seq_contrato_p, nr_seq_segurado_p, nr_seq_titular_p, cd_pessoa_fisica_p, current_setting('pls_reajuste_coletivo_pck.pls_reajuste_w')::pls_reajuste%rowtype.dt_reajuste, nr_seq_processo_w, tx_reajuste_liminar_w);
	else
		nr_seq_processo_w	:= null;
		tx_reajuste_liminar_w	:= null;
	end if;
	
	tb_nr_seq_tabela_w(nr_indice_reaj_tabela_w)	:= nr_seq_tabela_p;
	tb_nr_seq_reajuste_w(nr_indice_reaj_tabela_w)	:= nr_seq_reajuste_p;
	tb_nr_seq_plano_w(nr_indice_reaj_tabela_w)	:= nr_seq_plano_p;
	tb_dt_contrato_w(nr_indice_reaj_tabela_w)	:= dt_contrato_p;
	
	if (current_setting('pls_reajuste_coletivo_pck.ie_data_preco_reajuste_w')::pls_parametros.ie_data_preco_reajuste%type = 'A') then
		tb_dt_inicio_vigencia_w(nr_indice_reaj_tabela_w) := coalesce(current_setting('pls_reajuste_coletivo_pck.pls_reajuste_w')::pls_reajuste%rowtype.dt_aplicacao_reajuste, current_setting('pls_reajuste_coletivo_pck.pls_reajuste_w')::pls_reajuste%rowtype.dt_reajuste);
	else
		tb_dt_inicio_vigencia_w(nr_indice_reaj_tabela_w) := current_setting('pls_reajuste_coletivo_pck.pls_reajuste_w')::pls_reajuste%rowtype.dt_reajuste;
	end if;
	
	if (coalesce(nr_seq_reaj_coletivo_p::text, '') = '') then
		tb_tx_reajuste_w(nr_indice_reaj_tabela_w)	:= coalesce(tx_reajuste_liminar_w, current_setting('pls_reajuste_coletivo_pck.pls_reajuste_w')::pls_reajuste%rowtype.tx_reajuste);
	else
		tb_tx_reajuste_w(nr_indice_reaj_tabela_w)	:= coalesce(tx_reajuste_liminar_w, current_setting('pls_reajuste_coletivo_pck.pls_prog_reaj_coletivo_w')::pls_prog_reaj_coletivo%rowtype.tx_reajuste_programado);
	end if;
	tb_nr_seq_processo_w(nr_indice_reaj_tabela_w)	:= nr_seq_processo_w;
	
	nr_indice_reaj_tabela_w	:= nr_indice_reaj_tabela_w + 1;
end if;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_reajuste_coletivo_pck.alimentar_vetor_reaj_tabela ( nr_seq_tabela_p pls_tabela_preco.nr_sequencia%type, nr_seq_reajuste_p pls_reajuste.nr_sequencia%type, nr_seq_contrato_p pls_contrato.nr_sequencia%type, nr_seq_intercambio_p pls_intercambio.nr_sequencia%type, nr_seq_plano_p pls_plano.nr_sequencia%type, dt_contrato_p timestamp, nr_seq_segurado_p pls_segurado.nr_sequencia%type, nr_seq_titular_p pls_segurado.nr_seq_titular%type, cd_pessoa_fisica_p pessoa_fisica.cd_pessoa_fisica%type) FROM PUBLIC;
