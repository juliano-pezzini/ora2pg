-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE ctb_contr_patrimonio_bolivia.ajuste_fat_com_ganho_perda ( nr_lote_contabil_p MOVIMENTO_CONTABIL.NR_LOTE_CONTABIL%type ) AS $body$
DECLARE


	vl_mercado_w			PAT_BEM.VL_MERCADO%type;
	vl_movimento_w			PAT_BEM_MOVIMENTO.VL_MOVIMENTO%type;
	vl_debito_fiscal_w		PAT_VALOR_BEM.VL_DEBITO_FISCAL%type;
	cd_conta_contabil_w		PAT_BEM.CD_CONTA_CONTABIL%type;
	cd_conta_baixa_w		PAT_TIPO_HISTORICO.CD_CONTA_BAIXA%type;
	cd_conta_lucro_venda_w		PAT_TIPO_HISTORICO.CD_CONTA_LUCRO_VENDA%type;
	cd_conta_debito_fiscal_w	PAT_TIPO_HISTORICO.CD_CONTA_DEBITO_FISCAL%type;
	cd_conta_perdas_venda_w		PAT_TIPO_HISTORICO.CD_CONTA_PERDAS_VENDA%type;
	vl_calculated_w			bigint;

	c010 CURSOR FOR
		SELECT 	a.DS_COMPL_HISTORICO cd_bem,
			a.NR_SEQ_AGRUPAMENTO nr_seq_bem
		FROM 	W_MOVIMENTO_CONTABIL a
		WHERE 	a.NR_LOTE_CONTABIL = nr_lote_contabil_p;

BEGIN
	FOR movimento IN c010 LOOP
		SELECT  a.VL_MERCADO,
			e.VL_MOVIMENTO,
			b.VL_DEBITO_FISCAL,
			a.CD_CONTA_CONTABIL,
			d.CD_CONTA_BAIXA,
			d.CD_CONTA_LUCRO_VENDA,
			d.CD_CONTA_DEBITO_FISCAL,
			d.CD_CONTA_PERDAS_VENDA
		INTO STRICT 	vl_mercado_w,
			vl_movimento_w,
			vl_debito_fiscal_w,
			cd_conta_contabil_w,
			cd_conta_baixa_w,
			cd_conta_lucro_venda_w,
			cd_conta_debito_fiscal_w,
			cd_conta_perdas_venda_w
		FROM pat_bem a
LEFT OUTER JOIN pat_valor_bem b ON (a.NR_SEQUENCIA = b.NR_SEQ_BEM)
LEFT OUTER JOIN pat_historico_bem c ON (a.NR_SEQUENCIA = c.NR_SEQ_BEM)
LEFT OUTER JOIN pat_bem_movimento e ON (a.NR_SEQUENCIA = e.NR_SEQ_BEM)
LEFT OUTER JOIN pat_tipo_historico d ON (c.NR_SEQ_TIPO = d.NR_SEQUENCIA)
WHERE a.CD_BEM	= movimento.cd_bem AND a.NR_SEQUENCIA	= movimento.nr_seq_bem  GROUP BY a.VL_MERCADO,
			 e.VL_MOVIMENTO,
			 b.VL_DEBITO_FISCAL,
			 a.CD_CONTA_CONTABIL,
			 d.CD_CONTA_BAIXA,
			 d.CD_CONTA_LUCRO_VENDA,
			 d.CD_CONTA_DEBITO_FISCAL,
			 d.CD_CONTA_PERDAS_VENDA LIMIT 1;

		vl_calculated_w := ctb_contr_patrimonio_bolivia.obter_ganhos_venda_ativo(vl_movimento_w, vl_debito_fiscal_w, vl_mercado_w);

		IF (vl_calculated_w > 0) THEN
			CALL ctb_contr_patrimonio_bolivia.contabilizar_ganho(
				cd_conta_baixa_p		=> cd_conta_baixa_w,
				cd_conta_contabil_p		=> cd_conta_contabil_w,
				cd_conta_lucro_venda_p		=> cd_conta_lucro_venda_w,
				cd_conta_debito_fiscal_p	=> cd_conta_debito_fiscal_w,
				vl_movimento_p			=> vl_movimento_w,
				vl_mercado_p			=> vl_mercado_w,
				vl_calulated_p			=> vl_calculated_w,
				vl_debito_fiscal_p		=> vl_debito_fiscal_w
			);
		ELSIF (vl_calculated_w < 0) THEN
			CALL ctb_contr_patrimonio_bolivia.contabilizar_perda(
				cd_conta_baixa_p		=> cd_conta_baixa_w,
				cd_conta_contabil_p		=> cd_conta_contabil_w,
				cd_conta_perdas_venda_p		=> cd_conta_perdas_venda_w,
				cd_conta_debito_fiscal_p	=> cd_conta_debito_fiscal_w,
				vl_movimento_p			=> vl_movimento_w,
				vl_mercado_p			=> vl_mercado_w,
				vl_calulated_p			=> vl_calculated_w,
				vl_debito_fiscal_p		=> vl_debito_fiscal_w
			);
		END IF;
	END LOOP;
    END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ctb_contr_patrimonio_bolivia.ajuste_fat_com_ganho_perda ( nr_lote_contabil_p MOVIMENTO_CONTABIL.NR_LOTE_CONTABIL%type ) FROM PUBLIC;
