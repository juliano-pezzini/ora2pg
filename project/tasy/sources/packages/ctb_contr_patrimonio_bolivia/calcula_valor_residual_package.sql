-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE ctb_contr_patrimonio_bolivia.calcula_valor_residual ( dt_inicio_periodo_p MEMORIA_CALCULO_AITB.DT_INICIO_PERIODO%type, dt_fim_periodo_p MEMORIA_CALCULO_AITB.DT_FIM_PERIODO%type, nr_seq_bem_p MEMORIA_CALCULO_AITB.NR_SEQ_BEM%type, nm_usuario_p text ) AS $body$
DECLARE

	cd_moeda_correcao_w		PAT_CONTA_CONTABIL.CD_MOEDA_CORRECAO%type;
	vl_ufv_inicial_w		COTACAO_MOEDA.VL_COTACAO%type;
	vl_ufv_final_w			COTACAO_MOEDA.VL_COTACAO%type;
	vl_aitb_periodo_w		MEMORIA_CALCULO_AITB.VL_AITB_PERIODO%type;
	vl_atualizado_bem_w		MEMORIA_CALCULO_AITB.VL_ATUALIZADO_BEM%type;
	vl_depreciacao_atual_w		MEMORIA_CALCULO_AITB.VL_DEPRECIACAO_ATUAL%type;
	vl_depreciacao_acumulada_w	MEMORIA_CALCULO_AITB.VL_DEPRECIACAO_ACUMULADA%type;
	vl_residual_bem_w		MEMORIA_CALCULO_AITB.VL_RESIDUAL_BEM%type;
	vl_origem_w			PAT_VALOR_BEM.VL_ORIGEM%type;
	vl_tx_deprec_w			PAT_VALOR_BEM.TX_DEPRECIACAO%type;
	vl_depreciacao_liquida_w	MEMORIA_CALCULO_AITB.VL_DEPRECIACAO_LIQUIDA%type;
	tb_calculo_w			arr_caculo_t;
	dt_atualizacao_w		timestamp :=  clock_timestamp();
	nr_seq_calculo_exist_periodo_w	MEMORIA_CALCULO_AITB.NR_SEQUENCIA%type;
	nr_seq_calculo_existe_w		MEMORIA_CALCULO_AITB.NR_SEQUENCIA%type;
	dt_inicio_periodo_w		memoria_calculo_aitb.dt_inicio_periodo%type;
	dt_inicio_uso_w			memoria_calculo_aitb.dt_inicio_periodo%type;


BEGIN
	BEGIN
		SELECT	MAX(b.CD_MOEDA_CORRECAO),
			max(a.dt_inicio_uso)
		INTO STRICT	cd_moeda_correcao_w,
			dt_inicio_uso_w
		FROM	PAT_BEM a,
			PAT_CONTA_CONTABIL b
		WHERE	a.nr_seq_regra_conta	= b.nr_sequencia
		AND	a.NR_SEQUENCIA		= nr_seq_bem_p;
	EXCEPTION
		WHEN no_data_found THEN cd_moeda_correcao_w := null;
	END;

	IF (cd_moeda_correcao_w IS NOT NULL AND cd_moeda_correcao_w::text <> '') THEN
	
		select	max(a.nr_sequencia)
		into STRICT	nr_seq_calculo_existe_w
		from 	memoria_calculo_aitb a
		where 	a.nr_seq_bem = nr_seq_bem_p;
		
		if (coalesce(nr_seq_calculo_existe_w::text, '') = '') then
			dt_inicio_periodo_w	:= dt_inicio_uso_w;
		else
			dt_inicio_periodo_w	:= establishment_timezone_utils.startOfMonth(dt_fim_periodo_p) - 1;
		end if;
		
		BEGIN
			SELECT MIN(a.VL_COTACAO)
			INTO STRICT   vl_ufv_inicial_w
			FROM   COTACAO_MOEDA a
			WHERE  a.DT_COTACAO BETWEEN dt_inicio_periodo_w AND dt_fim_periodo_p
			AND    a.CD_MOEDA = cd_moeda_correcao_w;
		EXCEPTION
			WHEN no_data_found THEN vl_ufv_inicial_w := 0;
		END;

		BEGIN
			SELECT	MAX(a.VL_COTACAO)
			INTO STRICT	vl_ufv_final_w
			FROM	COTACAO_MOEDA a
			WHERE	a.DT_COTACAO BETWEEN dt_inicio_periodo_w and dt_fim_periodo_p
			AND	a.CD_MOEDA = cd_moeda_correcao_w;
		EXCEPTION
			WHEN no_data_found THEN vl_ufv_final_w := 0;
		END;

		IF (vl_ufv_inicial_w IS NOT NULL AND vl_ufv_inicial_w::text <> '') AND (vl_ufv_final_w IS NOT NULL AND vl_ufv_final_w::text <> '') THEN
			BEGIN
				SELECT	MAX(b.VL_ORIGEM)
				INTO STRICT	vl_origem_w
				FROM	PAT_BEM a,
					PAT_VALOR_BEM b
				WHERE	a.NR_SEQUENCIA = b.NR_SEQ_BEM
				AND	a.NR_SEQUENCIA = nr_seq_bem_p;
			EXCEPTION
				WHEN no_data_found THEN vl_origem_w := 0;
			END;

			BEGIN
				SELECT	PHILIPS_PATRIMONIO_PCK.OBTER_TAXA_DEPRECIACAO(nr_seq_bem_p, FIM_MES(dt_fim_periodo_p),0,'C') tx_deprec
				INTO STRICT 	vl_tx_deprec_w
				;
			END;

			select	max(a.nr_sequencia)
			into STRICT	nr_seq_calculo_exist_periodo_w
			from 	memoria_calculo_aitb a
			where 	a.nr_seq_bem = nr_seq_bem_p
			and 	a.dt_inicio_periodo = dt_inicio_periodo_p
			and 	a.dt_fim_periodo = dt_fim_periodo_p;

			if (nr_seq_calculo_exist_periodo_w IS NOT NULL AND nr_seq_calculo_exist_periodo_w::text <> '') then
				delete	from memoria_calculo_aitb
				where	nr_seq_bem = nr_seq_bem_p
				and	dt_inicio_periodo = dt_inicio_periodo_p
				and	dt_fim_periodo = dt_fim_periodo_p;
			end if;

			tb_calculo_w               := ctb_contr_patrimonio_bolivia.calculo_aitb(vl_ufv_inicial_w, vl_ufv_final_w, vl_origem_w);
			vl_aitb_periodo_w          := tb_calculo_w(1);
			vl_atualizado_bem_w        := tb_calculo_w(2);
			vl_depreciacao_atual_w     := ctb_contr_patrimonio_bolivia.calcula_depreciacao_atual(vl_atualizado_bem_w, vl_tx_deprec_w);
			vl_depreciacao_acumulada_w := ctb_contr_patrimonio_bolivia.calcula_depreciacao_acumulada(vl_ufv_inicial_w, vl_ufv_final_w, vl_depreciacao_atual_w);
			vl_residual_bem_w          := vl_origem_w - vl_depreciacao_acumulada_w;
			vl_depreciacao_liquida_w   := ctb_contr_patrimonio_bolivia.calcula_depreciacao_liquida(vl_ufv_inicial_w, vl_ufv_final_w, vl_depreciacao_atual_w,vl_depreciacao_acumulada_w);

			INSERT INTO MEMORIA_CALCULO_AITB(
				NR_SEQUENCIA,
				DT_INICIO_PERIODO,
				DT_FIM_PERIODO,
				VL_UFV_INICIO,
				VL_UFV_FIM,
				VL_AITB_PERIODO,
				VL_ATUALIZADO_BEM,
				VL_ANTERIOR_BEM,
				VL_DEPRECIACAO_ATUAL,
				VL_DEPRECIACAO_ACUMULADA,
				VL_RESIDUAL_BEM,
				NR_SEQ_BEM,
				CD_MOEDA,
				NM_USUARIO,
				NM_USUARIO_NREC,
				DT_ATUALIZACAO,
				DT_ATUALIZACAO_NREC,
				VL_DEPRECIACAO_LIQUIDA
			) VALUES (
				nextval('memoria_calculo_aitb_seq'),
				dt_inicio_periodo_w,
				dt_fim_periodo_p,
				coalesce(vl_ufv_inicial_w,0),
				coalesce(vl_ufv_final_w,0),
				coalesce(vl_aitb_periodo_w,0),
				coalesce(vl_atualizado_bem_w,0),
				coalesce(vl_origem_w,0),
				coalesce(vl_depreciacao_atual_w,0),
				coalesce(vl_depreciacao_acumulada_w,0),
				coalesce(vl_residual_bem_w,0),
				nr_seq_bem_p,
				cd_moeda_correcao_w,
				nm_usuario_p,
				nm_usuario_p,
				dt_atualizacao_w,
				dt_atualizacao_w,
				coalesce(vl_depreciacao_liquida_w,0)
			);
		END IF;
	END IF;
    END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ctb_contr_patrimonio_bolivia.calcula_valor_residual ( dt_inicio_periodo_p MEMORIA_CALCULO_AITB.DT_INICIO_PERIODO%type, dt_fim_periodo_p MEMORIA_CALCULO_AITB.DT_FIM_PERIODO%type, nr_seq_bem_p MEMORIA_CALCULO_AITB.NR_SEQ_BEM%type, nm_usuario_p text ) FROM PUBLIC;
