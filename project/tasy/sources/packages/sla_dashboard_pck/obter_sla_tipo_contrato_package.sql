-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION sla_dashboard_pck.obter_sla_tipo_contrato (ie_tipo_sla_p bigint,mes_ref_p bigint, ano_ref_p bigint) RETURNS SETOF T_SLA_TIPO_CONTRATO_TB AS $body$
DECLARE

    t_sla_tipo_contrato_tb_w t_sla_tipo_contrato_tb;
    sql_w varchar(32000);
BEGIN
    sql_w := 'select  z.*,
			case
			-- SWP SLA with penalty

			when ie_tipo_sla = 1 then
			obter_meta_bsc_sla(2627, z.dt_referencia) --ajustar cadastro da regra do bsc
			-- SWC SLA with contract

			when ie_tipo_sla = 2 then
			obter_meta_bsc_sla(2628, z.dt_referencia) --ajustar cadastro da regra do bsc
			-- ALLDEF ALL Defects

			when ie_tipo_sla = 3 then
			obter_meta_bsc_sla(2637, z.dt_referencia) --ajustar cadastro da regra do bsc
			end
			qt_target,
			round(100-(dividir(qt_nao_atingiu, qt_localizacao)*100),2) qt_atingiu
		from (
		select  ie_tipo_sla,
			count(nr_seq_loc) qt_localizacao,
			sum(qt_loc_nao_atingiu) qt_nao_atingiu,
			dt_referencia
		from (
			select  v.*,
				case    
				when perc_ating_loc < (   select  nvl((100 - max(x.pr_desvio)), 100)
							  from    man_sla x,
								  man_sla_loc y
							  where   x.nr_sequencia = y.nr_seq_sla
							  and     y.nr_seq_local = v.nr_seq_loc 
				
				) then
				1
				else
				0
				end
				qt_loc_nao_atingiu
			from    (
			select  :ie_tipo_sla_p ie_tipo_sla,
			
				t.*,
				to_date(''01/''||:mes_ref_p||''/''||:ano_ref_p, ''dd/mm/yyyy'') dt_referencia
			from    (
				select  a.ds_localizacao,
					to_number(a.nr_seq_localizacao) nr_seq_loc,
					sum(qt_sla_calc) qt_sla_rec,
					sum(qt_sla_estouro) qt_sla_estouro,
					round((1-sum(qt_sla_estouro) / sum(qt_sla_calc))*100,2) perc_ating_loc    
				from    table(sla_dashboard_pck.obter_sla_detalhe(:ie_tipo_sla_p,:mes_ref_p,:ano_ref_p)) a
				group by a.ds_localizacao, to_number(a.nr_seq_localizacao)
			) t
			) v
		) w
		group by ie_tipo_sla,dt_referencia
		)z'
;

    EXECUTE sql_w 
    BULK COLLECT INTO STRICT t_sla_tipo_contrato_tb_w 
    USING   ie_tipo_sla_p,
            mes_ref_p, 
            ano_ref_p, 
            ie_tipo_sla_p,
            mes_ref_p, 
            ano_ref_p
;
    for i in 1 .. t_sla_tipo_contrato_tb_w.count loop

        RETURN NEXT  t_sla_tipo_contrato_tb_w(i );

    end loop;
    return;
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION sla_dashboard_pck.obter_sla_tipo_contrato (ie_tipo_sla_p bigint,mes_ref_p bigint, ano_ref_p bigint) FROM PUBLIC;
