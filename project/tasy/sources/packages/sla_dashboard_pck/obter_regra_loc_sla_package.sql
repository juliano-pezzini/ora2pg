-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION sla_dashboard_pck.obter_regra_loc_sla ( nr_seq_localizacao_p bigint, cd_funcao_p bigint) RETURNS varchar AS $body$
DECLARE

				
nr_seq_loc_proj_w	bigint;
nr_seq_loc_status_w	man_loc_status_funcao.nr_sequencia%type;


BEGIN

if (nr_seq_localizacao_p = 41)	then
	return 'S';
else
	if (nr_seq_localizacao_p IS NOT NULL AND nr_seq_localizacao_p::text <> '') then --Caso nao tenha funcao ou localizacao na OS deve ser considerada SLA
		select	max(nr_sequencia)
		into STRICT	nr_seq_loc_proj_w
		from	man_localizacao_status
		where	nr_seq_localizacao = nr_seq_localizacao_p
		and	clock_timestamp()	between	dt_inicio and coalesce(dt_fim, fim_mes(clock_timestamp()));
		
		if (nr_seq_loc_proj_w IS NOT NULL AND nr_seq_loc_proj_w::text <> '') then
		
			select	max(nr_sequencia)
			into STRICT	nr_seq_loc_status_w
			from	man_loc_status_funcao
			where	nr_seq_loc_status = nr_seq_loc_proj_w;
			
			if (coalesce(nr_seq_loc_status_w::text, '') = '') or (coalesce(cd_funcao_p::text, '') = '') then -- Caso existir regra para localizacao e nao existir regra especifica por funcao a OS nao deve ser considerada SLA
				return 'S';
			elsif (nr_seq_loc_status_w IS NOT NULL AND nr_seq_loc_status_w::text <> '') then
				select	max(nr_sequencia)
				into STRICT	nr_seq_loc_status_w
				from	man_loc_status_funcao
				where	nr_seq_loc_status = nr_seq_loc_proj_w
				and	cd_funcao = cd_funcao_p
				and	coalesce(dt_liberacao, clock_timestamp() + interval '1 days') < clock_timestamp();
				
				if (nr_seq_loc_status_w IS NOT NULL AND nr_seq_loc_status_w::text <> '') then --Caso tiver registro da funcao com data de liberacao inferior a data atual passa a contar SLA
					return 'N';
				else
					return 'S'; --Caso tiver registro da funcao e a data de liberacao superior a data atual nao conta SLA
				end if;
			end if;
		else
			return 'N'; --Se nao tiver localizacao na regra sera considerado SLA
		end if;
	else
		return 'N';--Caso nao for informado a localizacao ou funcao na OS a OS sera considerada SLA
	end if;
end if;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION sla_dashboard_pck.obter_regra_loc_sla ( nr_seq_localizacao_p bigint, cd_funcao_p bigint) FROM PUBLIC;
