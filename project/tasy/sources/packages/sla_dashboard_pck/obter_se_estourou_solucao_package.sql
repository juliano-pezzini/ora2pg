-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION sla_dashboard_pck.obter_se_estourou_solucao ( nr_seq_ordem_serv_p man_sla_monitor.nr_seq_ordem_servico%type, cd_estabelecimento_p bigint ) RETURNS varchar AS $body$
DECLARE


dt_ordem_w		man_ordem_serv_sla.dt_ordem%type;
ie_tempo_termino_w	man_ordem_serv_sla.ie_tempo_termino%type;
ie_tipo_sla_termino_w	man_ordem_serv_sla.ie_tipo_sla_termino%type;
qt_min_termino_w	man_ordem_serv_sla.qt_min_termino%type;
qt_solucao_cor_w	bigint;
qt_solucao_com_w	bigint;
ie_estourou_w		varchar(1) := 'N';

BEGIN
select	max(dt_inicio_sla),
	max(ie_tempo_termino),
	max(ie_tipo_sla_termino),
	max(qt_min_termino)
into STRICT	dt_ordem_w,
	ie_tempo_termino_w,
	ie_tipo_sla_termino_w,
	qt_min_termino_w
from	man_ordem_serv_sla
where	nr_seq_ordem = nr_seq_ordem_serv_p;


if (ie_tempo_termino_w = 'COR') then
	select  sum(qt_minutos_estagio)
	into STRICT	qt_solucao_cor_w
	FROM (
		SELECT man_obter_tempo_estagio(a.nr_sequencia,a.nr_seq_ordem,'M') qt_minutos_estagio
		from    man_estagio_processo b,
			Man_ordem_serv_estagio a
		where   a.nr_seq_ordem      	= nr_seq_ordem_serv_p
		and b.nr_sequencia      	= a.nr_seq_estagio
		and b.ie_aguarda_cliente 	= 'N') alias3;
		
	if (qt_solucao_cor_w > qt_min_termino_w) then
		ie_estourou_w := 'S';
	else
		ie_estourou_w := 'N';
	end if;
elsif (ie_tempo_termino_w = 'COM') then
	select sum(man_obter_tempo_com (cd_estabelecimento_p, mose.dt_atualizacao, coalesce(
                          (
                            select min(a.dt_atualizacao)
                            from man_ordem_serv_estagio a
                            where a.nr_seq_ordem = mos1.nr_sequencia
                            and a.dt_atualizacao > mose.dt_atualizacao
                          )
                          , trunc(clock_timestamp())), 'MC')) qt_minutos_sla
	into STRICT	qt_solucao_com_w
        from	man_ordem_servico mos1,
                man_ordem_serv_estagio mose,
                man_estagio_processo meo
        where	mos1.nr_sequencia      	= mose.nr_seq_ordem
        and	mos1.nr_sequencia       = nr_seq_ordem_serv_p
        and	meo.nr_sequencia      	= mose.nr_seq_estagio
        and	meo.ie_aguarda_cliente 	= 'N';
	
	if (qt_solucao_com_w > qt_min_termino_w) then
		ie_estourou_w := 'S';
	else
		ie_estourou_w := 'N';
	end if;
end if;

return ie_estourou_w;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION sla_dashboard_pck.obter_se_estourou_solucao ( nr_seq_ordem_serv_p man_sla_monitor.nr_seq_ordem_servico%type, cd_estabelecimento_p bigint ) FROM PUBLIC;
