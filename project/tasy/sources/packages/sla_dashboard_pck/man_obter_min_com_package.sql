-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION sla_dashboard_pck.man_obter_min_com ( cd_estabelecimento_p bigint, dt_inicio_p timestamp, dt_fim_p timestamp) RETURNS bigint AS $body$
DECLARE


qt_min_w		numeric(22);
qt_min_tot_w	bigint;
dt_inicio_w	timestamp;
dt_fim_w		timestamp;
dt_ini_com_w	timestamp;
dt_fim_com_w	timestamp;
dt_ref_w		timestamp;



BEGIN

qt_min_tot_w	:= 0;
dt_inicio_w	:= dt_inicio_p;
dt_ref_w		:= dt_inicio_p;
dt_fim_w		:= dt_fim_p;

if	trunc(dt_inicio_p,'dd') <> trunc(dt_fim_p,'dd') then
	begin
	While(trunc(dt_ref_w,'dd') <= dt_fim_p) LOOP
	
		if (pkg_date_utils.IS_BUSINESS_DAY(dt_ref_w) = 0) then
			qt_min_w		:= 0;
		elsif (obter_se_feriado(cd_estabelecimento_p, dt_ref_w) > 0) then --Sera alterado pois sera necessario pegar o calendario da localizacao, so ira pegar esse caso nao existir um calendario para a localizacao
			qt_min_w		:= 0;
		else
			dt_ini_com_w		:= trunc(dt_ref_w,'dd') + 8/24;
			dt_fim_com_w		:= trunc(dt_ref_w,'dd') + 18/24;
			if (dt_inicio_w < dt_ini_com_w) then
				dt_inicio_w	:= dt_ini_com_w;
			end if;
			
			if (dt_fim_w > dt_fim_com_w) then
				dt_fim_w	:= dt_fim_com_w;
			end if;
			
			if (dt_fim_w < dt_inicio_w) then
				qt_min_w	:= 0;
			else
				qt_min_w	:= (dt_fim_w - dt_inicio_w) * 1440;
			end if;
		end if;
		qt_min_tot_w			:= qt_min_tot_w + qt_min_w;
		dt_ref_w			:= dt_ref_w + 1;
		if (trunc(dt_inicio_p,'dd') <> trunc(dt_ref_w,'dd')) then
			dt_fim_w		:= trunc(dt_ref_w,'dd') + 86399/86400;
		end if;
		
		if (dt_fim_w > dt_fim_p) then
			dt_fim_w		:= dt_fim_p;
		end if;
	END LOOP;
	end;
else	/*Se as datas sao no mesmo dia, apenas contabiliza os minutos*/

	begin
	if (pkg_date_utils.IS_BUSINESS_DAY(dt_ref_w) = 0) then
		qt_min_w		:= 0;
	elsif (obter_se_feriado(cd_estabelecimento_p, dt_ref_w) > 0) then
		qt_min_w		:= 0;
	else
		dt_ini_com_w		:= trunc(dt_ref_w,'dd') + 8/24;
		dt_fim_com_w		:= trunc(dt_ref_w,'dd') + 18/24;
		if (dt_inicio_w < dt_ini_com_w) then
			dt_inicio_w	:= dt_ini_com_w;
		end if;
		
		if (dt_fim_w > dt_fim_com_w) then
			dt_fim_w	:= dt_fim_com_w;
		end if;

		if (dt_fim_w < dt_inicio_w) then
			qt_min_w	:= 0;
		else
			qt_min_w	:= (dt_fim_w - dt_inicio_w) * 1440;
		end if;
	qt_min_tot_w			:= qt_min_tot_w + qt_min_w;
	end if;
	end;
end if;

Return qt_min_tot_w;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION sla_dashboard_pck.man_obter_min_com ( cd_estabelecimento_p bigint, dt_inicio_p timestamp, dt_fim_p timestamp) FROM PUBLIC;
