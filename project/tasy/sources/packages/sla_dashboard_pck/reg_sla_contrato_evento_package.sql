-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION sla_dashboard_pck.reg_sla_contrato_evento (dt_month_p timestamp) RETURNS SETOF T_SLA_GERAL AS $body$
DECLARE


t_sla_geral_row_w	t_sla_geral_row;
dt_referencia_w		timestamp;

c01 CURSOR FOR  --Forma ate  o  mes de  julho
SELECT dt_referencia generate_date,
		CASE WHEN ie_tipo_sla='SWP' THEN  1 WHEN ie_tipo_sla='SWC' THEN  2 WHEN ie_tipo_sla='ALLDEF' THEN  3 END  ie_type,
		ds_tipo_sla ds_type,
		qt_recebido,
		qt_atendido,
		percent_atingido sla_achievement,
		percent_meta qt_meta
	from	table(sla_dashboard_pck.reg_sla_geral_cliente_new(dt_month_p,'SWP'))
	
union

	SELECT dt_referencia generate_date,
		CASE WHEN ie_tipo_sla='SWP' THEN  1 WHEN ie_tipo_sla='SWC' THEN  2 WHEN ie_tipo_sla='ALLDEF' THEN  3 END  ie_type,
		ds_tipo_sla ds_type,
		qt_recebido,
		qt_atendido,
		percent_atingido sla_achievement,
		percent_meta qt_meta
	from	table(sla_dashboard_pck.reg_sla_geral_cliente_new(dt_month_p,'SWC'))
where	1=1
order by	ds_type desc;

c02 CURSOR FOR  --Forma apos  de  julho
SELECT CASE WHEN 1=1 THEN 'SLA with penalty' WHEN 1=2 THEN 'SLA with contract' WHEN 1=3 THEN  'All defects' END  DS_TYPE,
	CASE WHEN to_char(dt_month_p, 'MM/YYYY')='08/2021' THEN  OBTER_ating_KPI_BSC(2627, dt_month_p) WHEN to_char(dt_month_p, 'MM/YYYY')='09/2021' THEN	OBTER_ating_KPI_BSC(2627, dt_month_p) WHEN to_char(dt_month_p, 'MM/YYYY')='10/2021' THEN  OBTER_ating_KPI_BSC(2627, dt_month_p) WHEN to_char(dt_month_p, 'MM/YYYY')='11/2021' THEN  	OBTER_ating_KPI_BSC(2627, dt_month_p) WHEN to_char(dt_month_p, 'MM/YYYY')='12/2021' THEN  OBTER_ating_KPI_BSC(2627, dt_month_p)  ELSE qt_atingiu END  SLA_ACHIEVEMENT,
	qt_target QT_META,
	ie_tipo_sla IE_TYPE,
	qt_localizacao QT_RECEBIDO,
	(qt_localizacao - qt_nao_atingiu) QT_ATENDIDO,
	dt_month_p GENERATE_DATE
from    table(sla_dashboard_pck.obter_sla_tipo_contrato(1,to_char(dt_month_p, 'MM'),to_char(dt_month_p, 'YYYY'))) a

union

SELECT 	CASE WHEN 2=1 THEN 'SLA with penalty' WHEN 2=2 THEN 'SLA with contract' WHEN 2=3 THEN  'All defects' END  DS_TYPE,
	CASE WHEN to_char(dt_month_p, 'MM/YYYY')='08/2021' THEN  OBTER_ating_KPI_BSC(2628, dt_month_p) WHEN to_char(dt_month_p, 'MM/YYYY')='09/2021' THEN  	OBTER_ating_KPI_BSC(2628, dt_month_p) WHEN to_char(dt_month_p, 'MM/YYYY')='10/2021' THEN  OBTER_ating_KPI_BSC(2628, dt_month_p) WHEN to_char(dt_month_p, 'MM/YYYY')='11/2021' THEN  	OBTER_ating_KPI_BSC(2628, dt_month_p) WHEN to_char(dt_month_p, 'MM/YYYY')='12/2021' THEN  OBTER_ating_KPI_BSC(2628, dt_month_p)  ELSE qt_atingiu END  SLA_ACHIEVEMENT,
	qt_target QT_META,
	ie_tipo_sla IE_TYPE,
	qt_localizacao QT_RECEBIDO,
	(qt_localizacao - qt_nao_atingiu) QT_ATENDIDO,
	dt_month_p GENERATE_DATE
from    table(sla_dashboard_pck.obter_sla_tipo_contrato(2,to_char(dt_month_p, 'MM'),to_char(dt_month_p, 'YYYY'))) a
order by	IE_TYPE asc;

c01_w	c01%rowtype;
c02_w	c02%rowtype;


BEGIN

dt_referencia_w	:= trunc(dt_month_p,'month');

if (trunc(dt_referencia_w, 'mm') <= trunc(to_date('01/07/2021','dd/mm/yyyy'),'MM')) then
	
	open C01;
	loop
	fetch C01 into
		c01_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
	
	
		t_sla_geral_row_w.ds_tipo_sla		:=	c01_w.ds_type;	
		t_sla_geral_row_w.dt_referencia		:=	c01_w.generate_date;
		t_sla_geral_row_w.ie_tipo_sla		:=	c01_w.ie_type;
		t_sla_geral_row_w.qt_recebido		:=	c01_w.qt_recebido;
		t_sla_geral_row_w.qt_atendido		:=	c01_w.qt_atendido;
		t_sla_geral_row_w.percent_meta		:=	c01_w.qt_meta;
		t_sla_geral_row_w.percent_atingido	:=	c01_w.sla_achievement;

		RETURN NEXT t_sla_geral_row_w;
	end loop;
	close C01;
	
else
	open C02;
	loop
	fetch C02 into
		c02_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */

		t_sla_geral_row_w.ds_tipo_sla		:=	c02_w.ds_type;	
		t_sla_geral_row_w.dt_referencia		:=	c02_w.generate_date;
		t_sla_geral_row_w.ie_tipo_sla		:=	c02_w.ie_type;
		t_sla_geral_row_w.qt_recebido		:=	c02_w.qt_recebido;
		t_sla_geral_row_w.qt_atendido		:=	c02_w.qt_atendido;
		t_sla_geral_row_w.percent_meta		:=	c02_w.qt_meta;
		t_sla_geral_row_w.percent_atingido	:=	c02_w.sla_achievement;

		RETURN NEXT t_sla_geral_row_w;
	end loop;
	close C02;

end if;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION sla_dashboard_pck.reg_sla_contrato_evento (dt_month_p timestamp) FROM PUBLIC;
