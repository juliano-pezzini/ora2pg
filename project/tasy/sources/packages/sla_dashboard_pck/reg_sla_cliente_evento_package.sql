-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION sla_dashboard_pck.reg_sla_cliente_evento (ie_tipo_evento_p bigint, dt_month_p timestamp) RETURNS SETOF T_SLA_LOCALIZACAO_TB AS $body$
DECLARE


t_sla_localizacao_tb_w	t_sla_localizacao;
dt_referencia_w		timestamp;

c01 CURSOR FOR  --Forma ate  o  mes de  julho
SELECT NR_SEQUENCIA,
  CUSTOMER,
  sum(OPENED_DEFECTS) OPENED_DEFECTS,
  sum(SLA_CALC) SLA_CALC,
  sum(RECLASSIFIED_DEFECTS) RECLASSIFIED_DEFECTS,
  sum(RESPONSE_BREACHED) RESPONSE_BREACHED,
  sum(RESOLUTION_BREACHED) RESOLUTION_BREACHED,
  (100 - dividir(sum(SLA_CALC), (sum(RESPONSE_BREACHED) + sum(RESOLUTION_BREACHED))))  SLA_ACHIEVEMENT,
  QT_META,
  GENERATE_DATE,
  null SLA_DETAIL,
  CD_CNPJ
  from (
	SELECT  nr_seq_localizacao NR_SEQUENCIA,
	ds_localizacao CUSTOMER,
	qt_sla OPENED_DEFECTS,
	qt_sla_calculo SLA_CALC,
	null RECLASSIFIED_DEFECTS,
	qt_atraso_resposta RESPONSE_BREACHED,
	qt_atraso_solucao RESOLUTION_BREACHED,
	pr_atingido SLA_ACHIEVEMENT,
	qt_target QT_META,
	dt_referencia GENERATE_DATE,
	ds_sla_detail SLA_DETAIL,
	cd_cnpj
	from  table(sla_dashboard_pck.registros_sla_localizacao_new(dt_month_p,CASE WHEN ie_tipo_evento_p=1 THEN  'SWP' WHEN ie_tipo_evento_p=2 THEN  'SWC' WHEN ie_tipo_evento_p=3 THEN  'ALLDEF' END )) a ) alias13
group by CUSTOMER, NR_SEQUENCIA, QT_META, GENERATE_DATE, CD_CNPJ;

c02 CURSOR FOR  --Forma apos  de  julho
SELECT  ds_localizacao,
        qt_sla_rec,
        qt_sla_estouro,
        qt_perc_atingimento,
        CASE WHEN ie_tipo_evento_p=3 THEN obter_meta_bsc_sla(2637, dt_month_p)  ELSE qt_desvio END  qt_desvio,
        nr_seq_loc,
        cd_cnpj
from    table(sla_dashboard_pck.obter_sla_loc_evento(ie_tipo_evento_p,to_char(dt_month_p, 'MM'),to_char(dt_month_p, 'YYYY'))) a;

c01_w	c01%rowtype;
c02_w	c02%rowtype;


BEGIN

dt_referencia_w	:= trunc(dt_month_p,'month');

if (trunc(dt_referencia_w, 'mm') <= trunc(to_date('01/07/2021','dd/mm/yyyy'),'MM')) then
	
	open C01;
	loop
	fetch C01 into
		c01_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
	
		t_sla_localizacao_tb_w.ie_tipo_sla		:= 	ie_tipo_evento_p;
		t_sla_localizacao_tb_w.ds_localizacao		:= 	c01_w.customer;
		t_sla_localizacao_tb_w.nr_seq_loc		:=	c01_w.nr_sequencia;
		t_sla_localizacao_tb_w.qt_sla_rec		:=	c01_w.sla_calc;
		t_sla_localizacao_tb_w.qt_sla_estouro		:=	(c01_w.response_breached + c01_w.resolution_breached);
		t_sla_localizacao_tb_w.qt_perc_atingimento	:=	c01_w.sla_achievement;
		t_sla_localizacao_tb_w.qt_desvio		:=	c01_w.qt_meta;
		t_sla_localizacao_tb_w.cd_cnpj			:=	c01_w.cd_cnpj;

		RETURN NEXT t_sla_localizacao_tb_w;
	end loop;
	close C01;
	
else
	open C02;
	loop
	fetch C02 into
		c02_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */

		t_sla_localizacao_tb_w.ie_tipo_sla		:= 	ie_tipo_evento_p;
		t_sla_localizacao_tb_w.ds_localizacao		:= 	c02_w.ds_localizacao;
		t_sla_localizacao_tb_w.nr_seq_loc		:=	c02_w.nr_seq_loc;
		t_sla_localizacao_tb_w.qt_sla_rec		:=	c02_w.qt_sla_rec;
		t_sla_localizacao_tb_w.qt_sla_estouro		:=	c02_w.qt_sla_estouro;
		t_sla_localizacao_tb_w.qt_perc_atingimento	:=	c02_w.qt_perc_atingimento;
		t_sla_localizacao_tb_w.qt_desvio		:=	c02_w.qt_desvio;
		t_sla_localizacao_tb_w.cd_cnpj			:=	c02_w.cd_cnpj;

		RETURN NEXT t_sla_localizacao_tb_w;
	end loop;
	close C02;

end if;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION sla_dashboard_pck.reg_sla_cliente_evento (ie_tipo_evento_p bigint, dt_month_p timestamp) FROM PUBLIC;
