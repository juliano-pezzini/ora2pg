-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION sla_dashboard_pck.obter_min_com_loc_tz ( dt_inicio_p timestamp, dt_fim_p timestamp, nr_seq_localizacao_p bigint) RETURNS bigint AS $body$
DECLARE


qt_min_w		numeric(22);
qt_min_tot_w	bigint;
dt_inicio_w	timestamp;
dt_fim_w		timestamp;
dt_ini_com_w	timestamp;
dt_fim_com_w	timestamp;
dt_ref_w		timestamp;
hr_inicio_comercial_w	smallint;
hr_fim_comercial_w	smallint;
nm_timezone_database_w	varchar(50);


BEGIN

select	max(nm_timezone_database)
into STRICT	nm_timezone_database_w
from	man_localizacao_horario
where	nr_seq_localizacao = nr_seq_localizacao_p;

qt_min_tot_w	:= 0;
dt_inicio_w	:= sla_dashboard_pck.obter_datetime_tz(dt_inicio_p, nm_timezone_database_w);
dt_ref_w	:= sla_dashboard_pck.obter_datetime_tz(dt_inicio_p, nm_timezone_database_w); --11/08/2020 20:18:10
dt_fim_w	:= sla_dashboard_pck.obter_datetime_tz(dt_fim_p, nm_timezone_database_w); --12/08/2020 08:13:50

select	coalesce(substr(max(hr_inicial),1,2),8),
	coalesce(substr(max(hr_final),1,2),18)
into STRICT	hr_inicio_comercial_w,
        hr_fim_comercial_w	
from	man_localizacao_horario
where	nr_seq_localizacao = nr_seq_localizacao_p;
					--12/08/2020 08:13:50

if	trunc(dt_inicio_p,'dd') <> trunc(dt_fim_p,'dd') then
	begin		--11/08/2020 20:18:10		--12/08/2020 08:13:50
	While(trunc(dt_ref_w,'dd') <= dt_fim_p) LOOP
							--11/08/2020 20:18:10

		if (sla_dashboard_pck.obter_se_dia_util_localizacao(dt_ref_w, nr_seq_localizacao_p) = 'N') then
			qt_min_w		:= 0;
		else	--11/08/2020 08:00:10				--11/08/2020 20:18:10
			dt_ini_com_w		:= trunc(dt_ref_w,'dd') + hr_inicio_comercial_w/24;
			----11/08/2020 18:00:10	

			dt_fim_com_w		:= trunc(dt_ref_w,'dd') + hr_fim_comercial_w/24;
			--11/08/2020 20:18:10

			if (dt_inicio_w < dt_ini_com_w) then
				dt_inicio_w	:= dt_ini_com_w;
			end if;
				--12/08/2020 08:13:50

			if (dt_fim_w > dt_fim_com_w) then
				dt_fim_w	:= dt_fim_com_w; ----11/08/2020 18:00:10	
			end if;
				--12/08/2020 08:13:50

			if (dt_fim_w < dt_inicio_w) then
				qt_min_w	:= 0;
			else			--12/08/2020 08:13:50	
				qt_min_w	:= (dt_fim_w - dt_inicio_w) * 1440;
			end if;
		end if;
		qt_min_tot_w			:= qt_min_tot_w + qt_min_w;
		dt_ref_w			:= dt_ref_w + 1; --11/08/2020 20:18:10
		if (trunc(dt_inicio_p,'dd') <> trunc(dt_ref_w,'dd')) then -- 11/08/2020 20:18:10
			dt_fim_w		:= trunc(dt_ref_w,'dd') + 86399/86400; -- 11/08/2020 20:18:10
		end if;
		
		if (dt_fim_w > dt_fim_p) then
			dt_fim_w		:= dt_fim_p;
		end if;
	END LOOP;
	end;
else	/*Se as datas sao no mesmo dia, apenas contabiliza os minutos*/

	begin
	if (sla_dashboard_pck.obter_se_dia_util_localizacao(dt_ref_w, nr_seq_localizacao_p) = 'N') then
		qt_min_w		:= 0;
	else
		dt_ini_com_w		:= trunc(dt_ref_w,'dd') + hr_inicio_comercial_w/24;
		dt_fim_com_w		:= trunc(dt_ref_w,'dd') + hr_fim_comercial_w/24;
		if (dt_inicio_w < dt_ini_com_w) then
			dt_inicio_w	:= dt_ini_com_w;
		end if;
		
		if (dt_fim_w > dt_fim_com_w) then
			dt_fim_w	:= dt_fim_com_w;
		end if;

		if (dt_fim_w < dt_inicio_w) then
			qt_min_w	:= 0;
		else
			qt_min_w	:= (dt_fim_w - dt_inicio_w) * 1440;
		end if;
	qt_min_tot_w			:= qt_min_tot_w + qt_min_w;
	end if;
	end;
end if;

return qt_min_tot_w;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION sla_dashboard_pck.obter_min_com_loc_tz ( dt_inicio_p timestamp, dt_fim_p timestamp, nr_seq_localizacao_p bigint) FROM PUBLIC;
