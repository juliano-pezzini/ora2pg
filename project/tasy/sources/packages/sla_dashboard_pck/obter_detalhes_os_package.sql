-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE sla_dashboard_pck.obter_detalhes_os (nr_sequencia_p bigint) AS $body$
DECLARE


		man_ordem_situacao_sla_w	man_ordem_situacao_sla%rowtype;
		
BEGIN

		begin
		select	*
		into STRICT	man_ordem_situacao_sla_w
		from	man_ordem_situacao_sla a
		where	nr_seq_ordem_serv		= nr_sequencia_p
		and	nr_sequencia	=
			(SELECT	max(x.nr_sequencia)
			from	man_ordem_situacao_sla x
			where	x.nr_seq_ordem_serv		= a.nr_seq_ordem_serv
			and	trunc(x.dt_situacao,'month')	= dt_referencia_p)  LIMIT 1;
		exception
		when others then
			man_ordem_situacao_sla_w.nr_seq_ordem_serv := null;
		end;

		t_detalhe_sla_row_w := null;

		if (man_ordem_situacao_sla_w.nr_seq_ordem_serv IS NOT NULL AND man_ordem_situacao_sla_w.nr_seq_ordem_serv::text <> '') then

			t_detalhe_sla_row_w.nr_seq_ordem_serv	:= man_ordem_situacao_sla_w.nr_seq_ordem_serv;
			t_detalhe_sla_row_w.ds_localizacao	:= obter_desc_man_localizacao(man_ordem_situacao_sla_w.nr_seq_localizacao);
			t_detalhe_sla_row_w.nr_seq_ger_des_resp	:= man_ordem_situacao_sla_w.nr_seq_ger_des_resp;
			t_detalhe_sla_row_w.nr_seq_ger_des_solu	:= man_ordem_situacao_sla_w.nr_seq_ger_des_solu;
			t_detalhe_sla_row_w.nr_seq_gerencia_des	:= man_ordem_situacao_sla_w.nr_seq_gerencia_des;
			t_detalhe_sla_row_w.dt_estouro_resposta	:= man_ordem_situacao_sla_w.dt_estouro_resposta;
			t_detalhe_sla_row_w.dt_estouro_solucao	:= man_ordem_situacao_sla_w.dt_estouro_solucao;

			select	substr(a.ds_dano_breve,1,255),
				obter_valor_dominio(1149,a.ie_classificacao),
				obter_valor_dominio(1149,a.ie_classificacao_cliente),
				obter_valor_dominio(1046,a.ie_prioridade),
				obter_valor_dominio(1046,a.ie_prioridade_cliente),
				substr(obter_desc_expressao(b.cd_exp_estagio,b.ds_estagio),1,255),
				a.dt_ordem_servico
			into STRICT	t_detalhe_sla_row_w.ds_dano_breve,
				t_detalhe_sla_row_w.ds_classificacao,
				t_detalhe_sla_row_w.ds_classificacao_cliente,
				t_detalhe_sla_row_w.ds_prioridade,
				t_detalhe_sla_row_w.ds_prioridade_cliente,
				t_detalhe_sla_row_w.ds_estagio_atual,
				t_detalhe_sla_row_w.dt_ordem_servico
			FROM man_ordem_servico a
LEFT OUTER JOIN man_estagio_processo b ON (a.nr_seq_estagio = b.nr_sequencia)
WHERE a.nr_sequencia		= man_ordem_situacao_sla_w.nr_seq_ordem_serv;

			select	max(ds_grupo)
			into STRICT	t_detalhe_sla_row_w.ds_grupo_desenv
			from	grupo_desenvolvimento
			where	nr_sequencia	= man_ordem_situacao_sla_w.nr_seq_grupo_des;

			select	max(ds_grupo)
			into STRICT	t_detalhe_sla_row_w.ds_grupo_des_resp
			from	grupo_desenvolvimento
			where	nr_sequencia	= man_ordem_situacao_sla_w.nr_seq_grupo_des_resp;

			select	max(ds_grupo)
			into STRICT	t_detalhe_sla_row_w.ds_grupo_des_solu
			from	grupo_desenvolvimento
			where	nr_sequencia	= man_ordem_situacao_sla_w.nr_seq_grupo_des_solu;

			select	CASE WHEN man_ordem_situacao_sla_w.ie_resposta_os='E' THEN 'S'  ELSE 'N' END ,
				CASE WHEN man_ordem_situacao_sla_w.ie_solucao_os='E' THEN 'S'  ELSE 'N' END
			into STRICT	t_detalhe_sla_row_w.ie_resposta_os,
				t_detalhe_sla_row_w.ie_solucao_os
			;

			select	max(ds_titulo)
			into STRICT	t_detalhe_sla_row_w.ds_sla
			from	man_sla
			where	nr_sequencia	=
				(SELECT	max(x.nr_seq_sla)
				from	man_ordem_situacao_sla x
				where	x.nr_seq_ordem_serv	=  man_ordem_situacao_sla_w.nr_seq_ordem_serv);

			t_detalhe_sla_row_w.ie_sla			:= man_ordem_situacao_sla_w.ie_sla;
			t_detalhe_sla_row_w.qt_dif_min_resposta		:= man_ordem_situacao_sla_w.qt_dif_min_resposta;
			t_detalhe_sla_row_w.qt_dif_min_solucao		:= man_ordem_situacao_sla_w.qt_dif_min_solucao;
		end if;

		END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE sla_dashboard_pck.obter_detalhes_os (nr_sequencia_p bigint) FROM PUBLIC;
