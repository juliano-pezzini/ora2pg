-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE sla_dashboard_pck.obter_all_def () AS $body$
BEGIN
		Select b.ds_tipo_sla,
		dt_referencia_w,
		b.ie_tipo_sla,
		sum(b.qt_sla) qt_sla,
		sum(b.qt_sla_calculo) qt_sla_calculo,
		sum(b.qt_atraso_resposta) qt_atraso_resposta,
		sum(b.qt_atraso_solucao) qt_atraso_solucao,
		(100-(dividir((sum(b.qt_atraso_resposta) + sum(b.qt_atraso_solucao)), (sum(b.qt_sla_calculo))) * 100)) pr_atingido,
		b.qt_target qt_target
	into STRICT	t_sla_dashboard_row_w.ds_tipo_sla,
		t_sla_dashboard_row_w.dt_referencia,
		t_sla_dashboard_row_w.ie_tipo_sla,
		t_sla_dashboard_row_w.qt_sla,
		t_sla_dashboard_row_w.qt_sla_calculo,
		t_sla_dashboard_row_w.qt_atraso_resposta,
		t_sla_dashboard_row_w.qt_atraso_solucao,
		t_sla_dashboard_row_w.pr_atingido,
		t_sla_dashboard_row_w.qt_target
	from (
		SELECT  'All defects' ds_tipo_sla,
		'ALLDEF' ie_tipo_sla,
		sum(CASE WHEN ie_indicador=1 THEN 1  ELSE 0 END ) qt_sla,
		sum(CASE WHEN ie_indicador=1 THEN 1  ELSE 0 END  * sla_dashboard_pck.obter_mult_sla_all_def(a.sla_detail)) qt_sla_calculo,
		sum(sla_dashboard_pck.obter_se_estouro_sla_def(a.ie_indicador,3,a.sla_detail)) qt_atraso_resposta,
		sum(sla_dashboard_pck.obter_se_estouro_sla_def(a.ie_indicador,4,a.sla_detail)) qt_atraso_solucao,
		(100-(dividir((sum(sla_dashboard_pck.obter_se_estouro_sla_def(a.ie_indicador,3,a.sla_detail)) + sum(sla_dashboard_pck.obter_se_estouro_sla_def(a.ie_indicador,4,a.sla_detail))), (sum(CASE WHEN a.ie_indicador=1 THEN 1  ELSE 0 END ) * sla_dashboard_pck.obter_mult_sla_all_def(a.sla_detail))) * 100)) pr_atingido,
		sla_dashboard_pck.obter_meta_sla(dt_referencia_w,'ALLDEF') qt_target
		from  sla_information_alldef_v a
		where   extract_date between dt_referencia_w and dt_referencia_fim_w
		group by  sla_detail ) b
	group by qt_target, b.ds_tipo_sla, b.ie_tipo_sla;

	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE sla_dashboard_pck.obter_all_def () FROM PUBLIC;
