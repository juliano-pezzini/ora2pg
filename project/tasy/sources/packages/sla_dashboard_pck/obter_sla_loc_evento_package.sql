-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION sla_dashboard_pck.obter_sla_loc_evento (ie_tipo_sla_p bigint,mes_ref_p bigint, ano_ref_p bigint) RETURNS SETOF T_SLA_LOCALIZACAO_TB AS $body$
DECLARE

    t_sla_localizacao_tb_w t_sla_localizacao_tb;
    sql_w varchar(32000);
BEGIN
    sql_w := 	'select	:ie_tipo_sla_p ie_tipo_sla,
			t.ds_localizacao,
			t.nr_seq_loc,
			t.qt_sla_rec,
			t.qt_sla_estouro,
			t.qt_perc_atingimento,
			(   select  nvl((100 - max(x.pr_desvio)), 100)
			from    man_sla x,
				man_sla_loc y
			where   x.nr_sequencia = y.nr_seq_sla
			and     y.nr_seq_local = t.nr_seq_loc
			
			) desvio,
			t.cd_cnpj
		from    (
		select  a.ds_localizacao,
			to_number(a.nr_seq_localizacao) nr_seq_loc,
			sum(qt_sla_calc) qt_sla_rec,
			sum(qt_sla_estouro) qt_sla_estouro,
			round((1-sum(qt_sla_estouro) / sum(qt_sla_calc))*100,2) qt_perc_atingimento,
			a.cd_cnpj
		from    table(sla_dashboard_pck.obter_sla_detalhe(:ie_tipo_sla_p,:mes_ref_p,:ano_ref_p)) a
		group by a.ds_localizacao, to_number(a.nr_seq_localizacao), a.cd_cnpj
		) t'
;

    EXECUTE sql_w 
    BULK COLLECT INTO STRICT t_sla_localizacao_tb_w 
    USING   ie_tipo_sla_p,
            ie_tipo_sla_p,
            mes_ref_p, 
            ano_ref_p
;
    for i in 1 .. t_sla_localizacao_tb_w.count loop

        RETURN NEXT  t_sla_localizacao_tb_w(i );

    end loop;
    return;
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION sla_dashboard_pck.obter_sla_loc_evento (ie_tipo_sla_p bigint,mes_ref_p bigint, ano_ref_p bigint) FROM PUBLIC;
