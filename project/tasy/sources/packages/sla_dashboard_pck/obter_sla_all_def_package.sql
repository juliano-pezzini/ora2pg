-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION sla_dashboard_pck.obter_sla_all_def (ie_tipo_sla_p bigint,mes_ref_p bigint, ano_ref_p bigint) RETURNS SETOF T_SLA_ALL_DEF_TB AS $body$
DECLARE

            t_sla_all_def_tb_w t_sla_all_def_tb;
            sql_w varchar(32000);

BEGIN
            sql_w := 	'select sum(qt_sla_calc_total) qt_os_calc,
				sum(qt_estouro_resp_total) qt_estouro_resp,
				sum(qt_estouro_sol_total) qt_estouro_sol,
				sum(qt_total_os_total) qt_total_estouro,
				round((1-sum(qt_total_estouro) / sum(qt_sla_calc_total))*100,2) qt_atingiu,
				qt_meta
			from   (
				select b.*,
				obter_meta_bsc_sla(2637, b.dt_referencia) qt_meta,
				qt_estouro_sol_total + qt_estouro_resp_total qt_total_estouro
				from (
					select  sum(qt_sla_calc) qt_sla_calc_total,
						sum(qt_estouro_resp) qt_estouro_resp_total,
						sum(qt_estouro_sol) qt_estouro_sol_total,
						count(nr_seq_ordem) qt_total_os_total,
						to_date(''01/''||:mes_ref_p||''/''||:ano_ref_p, ''dd/mm/yyyy'') dt_referencia
					from (
						select * 
						from table(sla_dashboard_pck.obter_sla_detalhe(:ie_tipo_sla_p,:mes_ref_p,:ano_ref_p))
						) a
				    ) b
				) c
				group by qt_meta '
     
;

            EXECUTE sql_w 
            BULK COLLECT INTO STRICT t_sla_all_def_tb_w 
            USING   mes_ref_p, 
                    ano_ref_p,
		    ie_tipo_sla_p,
                    mes_ref_p, 
                    ano_ref_p;
		
            for i in 1 .. t_sla_all_def_tb_w.count loop
            
                RETURN NEXT  t_sla_all_def_tb_w(i );

            end loop;
            return;
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION sla_dashboard_pck.obter_sla_all_def (ie_tipo_sla_p bigint,mes_ref_p bigint, ano_ref_p bigint) FROM PUBLIC;
