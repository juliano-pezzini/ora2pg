-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION sla_dashboard_pck.reg_sla_geral_cliente_ref (dt_referencia_p timestamp) RETURNS SETOF T_REG_GERAL_CLIENTE_REF AS $body$
DECLARE


t_reg_geral_cliente_ref_row_w	t_reg_geral_cliente_ref_row;
dt_referencia_w		timestamp;

c01 CURSOR FOR  --Forma do mes Janeiro e Fev
SELECT dt_referencia,
	ie_tipo_sla,
	ds_tipo_sla,
	qt_recebido,
	qt_atendido,
	percent_atingido,
	percent_meta
from	table(sla_dashboard_pck.reg_sla_geral_ref(dt_referencia_p,'SWP'))

union

SELECT dt_referencia,
	ie_tipo_sla,
	ds_tipo_sla,
	qt_recebido,
	qt_atendido,
	percent_atingido,
	percent_meta
from	table(sla_dashboard_pck.reg_sla_geral_ref(dt_referencia_p,'SWC'));

c02 CURSOR FOR  --Forma do mes Marco ate Agosto
SELECT 	dt_referencia,
	ie_tipo_sla,
	ds_tipo_sla,
	qt_recebido,
	qt_atendido,
	percent_atingido,
	percent_meta
from	table(sla_dashboard_pck.registros_sla_geral_cliente(dt_referencia_p,'SWP'))

union

SELECT dt_referencia,
	ie_tipo_sla,
	ds_tipo_sla,
	qt_recebido,
	qt_atendido,
	percent_atingido,
	percent_meta
from	table(sla_dashboard_pck.registros_sla_geral_cliente(dt_referencia_p,'SWC'));

c01_w	c01%rowtype;
c02_w	c02%rowtype;


BEGIN

dt_referencia_w	:= trunc(dt_referencia_p,'month');

if (trunc(dt_referencia_w, 'mm') > trunc(to_date('01/08/2020','dd/mm/yyyy'),'MM')) then
	
	open C01;
	loop
	fetch C01 into
		c01_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */

		t_reg_geral_cliente_ref_row_w.ds_tipo_sla			:= c01_w.ds_tipo_sla;
		t_reg_geral_cliente_ref_row_w.dt_referencia			:= dt_referencia_w;
		t_reg_geral_cliente_ref_row_w.ie_tipo_sla			:= c01_w.ie_tipo_sla;
		t_reg_geral_cliente_ref_row_w.qt_recebido			:= c01_w.qt_recebido;
		t_reg_geral_cliente_ref_row_w.qt_atendido			:= c01_w.qt_atendido;
		t_reg_geral_cliente_ref_row_w.percent_meta			:= c01_w.percent_meta;
		t_reg_geral_cliente_ref_row_w.percent_atingido		:= c01_w.percent_atingido;

		RETURN NEXT t_reg_geral_cliente_ref_row_w;
	end loop;
	close C01;
	
else

	open C02;
	loop
	fetch C02 into
		c02_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */

		t_reg_geral_cliente_ref_row_w.ds_tipo_sla			:= c02_w.ds_tipo_sla;
		t_reg_geral_cliente_ref_row_w.dt_referencia			:= dt_referencia_w;
		t_reg_geral_cliente_ref_row_w.ie_tipo_sla			:= c02_w.ie_tipo_sla;
		t_reg_geral_cliente_ref_row_w.qt_recebido			:= c02_w.qt_recebido;
		t_reg_geral_cliente_ref_row_w.qt_atendido			:= c02_w.qt_atendido;
		t_reg_geral_cliente_ref_row_w.percent_meta			:= c02_w.percent_meta;
		t_reg_geral_cliente_ref_row_w.percent_atingido			:= c02_w.percent_atingido;

		RETURN NEXT t_reg_geral_cliente_ref_row_w;
	end loop;
	close C02;

end if;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION sla_dashboard_pck.reg_sla_geral_cliente_ref (dt_referencia_p timestamp) FROM PUBLIC;
