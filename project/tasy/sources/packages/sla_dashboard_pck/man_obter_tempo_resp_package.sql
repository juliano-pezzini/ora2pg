-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE sla_dashboard_pck.man_obter_tempo_resp ( nr_seq_ordem_serv_p man_ordem_servico.nr_sequencia%type, nm_usuario_p text, cd_estabelecimento_p bigint, dt_evento_retroativo_p timestamp default null) AS $body$
DECLARE


dt_inicio_sla_w		man_ordem_serv_sla.dt_ordem%type;
ie_tempo_w		man_ordem_serv_sla.ie_tempo%type;
ie_tipo_sla_w		man_ordem_serv_sla.ie_tipo_sla%type;
qt_min_inicio_w		man_ordem_serv_sla.qt_min_inicio%type;
ie_desenv_w		varchar(1) := 'N';
ie_suporte_w		varchar(1) := 'N';
dt_min_resp_w		timestamp := clock_timestamp();
nr_seq_grupo_sup_w	man_ordem_servico.nr_seq_grupo_sup%type;
nr_seq_grupo_des_w	man_ordem_servico.nr_seq_grupo_des%type;
qt_min_total_res_w	bigint;
ie_classificacao_w	man_ordem_serv_sla.ie_classificacao%type;
ie_prioridade_w		man_ordem_serv_sla.ie_prioridade%type;
qt_min_termino_w	man_ordem_serv_sla.qt_min_termino%type;
qt_desvio_inic_w	man_ordem_serv_sla.qt_desvio_inic%type;
qt_estagio_desenv_w	bigint;
nr_seq_sla_regra_w	man_ordem_serv_sla.nr_seq_sla_regra%type;
nr_seq_estagio_w	man_ordem_servico.nr_seq_estagio%type;
ie_setor_desenv_w	varchar(1) := 'S';
ie_tempo_termino_w	man_ordem_serv_sla.ie_tempo_termino%type;
ie_tipo_sla_termino_w	man_ordem_serv_sla.ie_tipo_sla_termino%type;
ie_ambiente_w		man_ordem_servico.ie_ambiente%type;


BEGIN

select	max(dt_inicio_sla),
	max(ie_tempo),
	max(ie_tipo_sla),
	max(qt_min_inicio),
	max(qt_min_termino),
	max(ie_classificacao),
	max(ie_prioridade),
	max(nr_seq_sla_regra),
	max(qt_desvio_inic),
	max(ie_tipo_sla_termino),
	max(ie_tempo_termino)
into STRICT	dt_inicio_sla_w,
	ie_tempo_w,
	ie_tipo_sla_w,
	qt_min_inicio_w,
	qt_min_termino_w,
	ie_classificacao_w,
	ie_prioridade_w,
	nr_seq_sla_regra_w,
	qt_desvio_inic_w,
	ie_tipo_sla_termino_w,
	ie_tempo_termino_w
from	man_ordem_serv_sla
where	nr_seq_ordem = nr_seq_ordem_serv_p;

dt_min_resp_w := sla_dashboard_pck.obter_dt_primeiro_atend(nr_seq_ordem_serv_p);

if (qt_desvio_inic_w = 0) then

	if (ie_tempo_w = 'COR') then
		qt_min_total_res_w := ((dt_min_resp_w - dt_inicio_sla_w) * 1440);
	elsif (ie_tempo_w = 'COM') then
		qt_min_total_res_w := sla_dashboard_pck.man_obter_min_com(cd_estabelecimento_p, dt_inicio_sla_w, dt_min_resp_w);
	end if;
	
	if ( qt_min_total_res_w > qt_min_inicio_w) then
				
		select  max(nr_seq_grupo_des),
			max(nr_seq_grupo_sup),
			max(nr_seq_estagio),
			max(ie_ambiente)
		into STRICT	nr_seq_grupo_des_w,
			nr_seq_grupo_sup_w,
			nr_seq_estagio_w,
			ie_ambiente_w
		from	man_ordem_servico
		where	nr_sequencia = nr_seq_ordem_serv_p;
		
		select 	sla_dashboard_pck.man_obter_estagio_desenv_sla(nr_seq_estagio_w)
		into STRICT	ie_setor_desenv_w
		;
		
		if (ie_setor_desenv_w = 'S') then
		    nr_seq_grupo_sup_w := null;
		else
		    nr_seq_grupo_des_w := null;
		end if;
		
		update	man_ordem_serv_sla
		set	qt_desvio_inic = 1 
		where	nr_seq_ordem = nr_seq_ordem_serv_p;
	
		CALL sla_dashboard_pck.man_incluir_os_evento(nr_seq_ordem_serv_p, nm_usuario_p, cd_estabelecimento_p, nr_seq_grupo_des_w,'8', 'S', ie_classificacao_w, ie_prioridade_w,
						qt_min_inicio_w, qt_min_termino_w, sla_dashboard_pck.obter_tempo_abertura(dt_inicio_sla_w), nr_seq_sla_regra_w, nr_seq_grupo_sup_w,
						dt_evento_retroativo_p, ie_tipo_sla_w, ie_tipo_sla_termino_w, ie_tempo_w, ie_tempo_termino_w, ie_ambiente_w);
	end if;
	commit;
end if;


END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE sla_dashboard_pck.man_obter_tempo_resp ( nr_seq_ordem_serv_p man_ordem_servico.nr_sequencia%type, nm_usuario_p text, cd_estabelecimento_p bigint, dt_evento_retroativo_p timestamp default null) FROM PUBLIC;
