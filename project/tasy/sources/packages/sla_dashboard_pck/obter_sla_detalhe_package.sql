-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION sla_dashboard_pck.obter_sla_detalhe (ie_tipo_sla_p bigint,mes_ref_p bigint, ano_ref_p bigint) RETURNS SETOF T_SLA_DETALHE_TB AS $body$
DECLARE

            t_sla_detalhe_tb_w t_sla_detalhe_tb;
            sql_w varchar(32000);

BEGIN
            sql_w := 
            
		'select	v.nr_seq_ordem,
			v.nr_seq_localizacao,
			v.ds_localizacao,
			v.ds_tipo_contrato,
			v.qt_estouro_resp,
			v.qt_estouro_sol,
			v.ie_estouro_resposta,
			v.ie_estouro_solucao,
			v.qt_min_resp_rest_ext,
			v.qt_min_sol_rest_ext,
			v.qt_min_resp_rest,
			v.qt_min_sol_rest,
			v.ds_contrato_sla,
			v.qt_min_inicio,
			v.qt_min_termino,
			v.dono_estouro_resp,
			v.dono_estouro_sol,
			v.qt_sla_calc,
			v.nr_seq_gerencia_resp,
			v.nr_seq_gerencia_sol,
			qt_estouro_sol+ qt_estouro_resp qt_sla_estouro,
			v.dt_estouro_resp,
			v.dt_estouro_sol,
			v.cd_cnpj,
			v.ds_tipo_tempo
                from    (
				select	t.nr_seq_ordem,
					t.nr_seq_localizacao,
					t.ds_localizacao,
					sla_dashboard_pck.obter_tipo_contrato_evento(:ie_tipo_sla_p, t.ie_tipo_sla, t.ie_tipo_sla_termino)ds_tipo_contrato,
					decode(t.ie_estouro_resposta, ''Y'',1,0) qt_estouro_resp,
					decode(t.ie_estouro_solucao, ''Y'',1,0) qt_estouro_sol,
					decode(:ie_tipo_sla_p, ie_tipo_sla, ie_estouro_resposta, ''N/A'' ) ie_estouro_resposta,
					decode(:ie_tipo_sla_p, ie_tipo_sla_termino, ie_estouro_solucao, ''N/A'' ) ie_estouro_solucao,
					sla_dashboard_pck.obter_se_tempo_contrato(:ie_tipo_sla_p,  t.ie_tipo_sla, qt_min_resp_rest) qt_min_resp_rest_ext,
					sla_dashboard_pck.obter_se_tempo_contrato(:ie_tipo_sla_p,  t.ie_tipo_sla_termino, qt_min_sol_rest) qt_min_sol_rest_ext,
					t.qt_min_resp_rest,
					t.qt_min_sol_rest,
					ds_contrato_sla,
					t.qt_min_inicio,
					t.qt_min_termino,
					sla_dashboard_pck.man_obter_dono_estouro_sla(ie_estouro_resposta, ie_dono_estouro_resp, t.nr_seq_grupo_sup_resp, t.nr_seq_grupo_des_resp) DONO_ESTOURO_RESP,
					sla_dashboard_pck.man_obter_dono_estouro_sla(ie_estouro_solucao, ie_dono_estouro_sol, t.nr_seq_grupo_sup_sol, t.nr_seq_grupo_des_sol) DONO_ESTOURO_SOL,
					sla_dashboard_pck.obter_mult_sla_evento(t.ie_tipo_sla, t.ie_tipo_sla_termino) qt_sla_calc,
					sla_dashboard_pck.man_obter_gerencia_estouro_sla(ie_estouro_resposta, ie_dono_estouro_resp, t.nr_seq_grupo_sup_resp, t.nr_seq_grupo_des_resp) nr_seq_gerencia_resp,
					sla_dashboard_pck.man_obter_gerencia_estouro_sla(ie_estouro_solucao, ie_dono_estouro_sol, t.nr_seq_grupo_sup_sol, t.nr_seq_grupo_des_sol) nr_seq_gerencia_sol,
					t.dt_estouro_resp,
					t.dt_estouro_sol,
					t.cd_cnpj,
					sla_dashboard_pck.obter_tipo_tempo_evento(:ie_tipo_sla_p, t.ie_tipo_sla, t.ie_tipo_sla_termino, t.ie_tempo, t.ie_tempo_termino) ds_tipo_tempo
                    from (
                        select  distinct x.nr_seq_ordem,
                                b.ds_localizacao,
                                b.nr_sequencia nr_seq_localizacao,
                                nvl(ie_tipo_sla,3) ie_tipo_sla,
                                nvl(ie_tipo_sla_termino,3) ie_tipo_sla_termino,
                                (
                                    select  distinct y.ds_titulo
                                    from    man_sla_regra x,
                                            man_sla y
                                    where   1=1
                                    and     y.nr_sequencia = x.nr_seq_sla
                                    and     x.nr_sequencia = nvl(nvl(resp.nr_seq_regra_sla,sol.nr_seq_regra_sla) ,x.nr_seq_regra_sla)
                                )
                                ds_contrato_sla,
                                (
                                    select  nvl((100 - y.pr_desvio), 100)
                                    from    man_sla_regra x,
                                            man_sla y
                                    where   1=1
                                    and     y.nr_sequencia = x.nr_seq_sla
                                    and     x.nr_sequencia = nvl(nvl(resp.nr_seq_regra_sla,sol.nr_seq_regra_sla) ,x.nr_seq_regra_sla)
                                )
                                qt_target,
                                round(sla_dashboard_pck.obter_min_resp_eve(x.nr_seq_ordem, nvl(nvl(resp.qt_min_inicio,sol.qt_min_inicio),x.qt_min_inicio))) qt_min_resp_rest,
                                round(sla_dashboard_pck.obter_min_solucao_evento(x.nr_seq_ordem,  nvl(nvl(resp.qt_min_termino,sol.qt_min_termino),x.qt_min_termino) ,  nvl(nvl(resp.ie_tempo_termino,sol.ie_tempo_termino),x.ie_tempo_termino) ,  nvl(nvl(resp.ie_tempo,sol.ie_tempo),x.ie_tempo))) qt_min_sol_rest,
                                nvl(nvl(resp.nr_seq_regra_sla,sol.nr_seq_regra_sla) ,x.nr_seq_regra_sla) nr_seq_regra_sla,
                                nvl(nvl(resp.qt_min_inicio,sol.qt_min_inicio),x.qt_min_inicio) qt_min_inicio,
                                nvl(nvl(resp.qt_min_termino,sol.qt_min_termino),x.qt_min_termino) qt_min_termino,
                                nvl(resp.ie_estouro_resposta,''N'') ie_estouro_resposta,
                                nvl(sol.ie_estouro_solucao,''N'') ie_estouro_solucao,
                                resp.nr_seq_grupo_sup nr_seq_grupo_sup_resp,
                                resp.nr_seq_grupo_des nr_seq_grupo_des_resp,
                                sol.nr_seq_grupo_sup nr_seq_grupo_sup_sol,
                                sol.nr_seq_grupo_des nr_seq_grupo_des_sol,
                                resp.ie_dono_estouro_resp,
                                sol.ie_dono_estouro_sol,
                                resp.dt_estouro_resp,
                                sol.dt_estouro_sol,
                                b.cd_cnpj,
                                x.ie_tempo,
                                x.ie_tempo_termino
                        from    man_sla_evento x,
                                (   
                                    select  y.nr_seq_ordem,
                                            max(y.nr_sequencia) nr_sequencia,
                                            max(y.nr_seq_regra_sla) nr_seq_regra_sla,
                                            max(y.qt_min_inicio) qt_min_inicio,
                                            max(y.qt_min_termino) qt_min_termino,
                                            max(''Y'') ie_estouro_resposta,
                                            max(nvl(y.nr_seq_grupo_desenv_just, y.nr_seq_grupo_desenv)) nr_seq_grupo_des,
                                            max(nvl(y.nr_seq_grupo_sup_just, y.nr_seq_grupo_sup)) nr_seq_grupo_sup,
                                            min(y.dt_atualizacao) dt_estouro_resp,
                                            max(y.ie_tempo) ie_tempo,
                                            max(y.ie_tempo_termino) ie_tempo_termino,
                                            max(nvl(y.ie_dono_estouro,(
                                                select  max(x1.ie_dono_estouro)
                                                from    (
                                                    select  a.dt_atualizacao,
                                                            nvl((   select min(x.dt_atualizacao)
                                                                from    man_ordem_serv_estagio x
                                                                where   x.nr_sequencia > a.nr_sequencia
                                                                and     x.nr_seq_ordem = a.nr_seq_ordem
                                                            ),fim_ano(sysdate))
                                                            dt_fim_estagio,
                                                            nvl(nvl(decode(b.ie_suporte,''S'',''SUP''), nvl(decode(b.ie_desenv,''S'',''DES''),decode(b.ie_tecnologia,''S'',''TEC'')) ), decode(b.ie_infra,''S'',''DES'')) ie_dono_estouro
                                                    from    man_ordem_serv_estagio a,
                                                            man_estagio_processo b
                                                    where   a.nr_seq_estagio = b.nr_sequencia
                                                    and     b.ie_aguarda_cliente = ''N''
                                                    and     a.nr_seq_ordem = y.nr_seq_ordem
                                                ) x1
                                                where   y.dt_atualizacao between x1.dt_atualizacao and x1.dt_fim_estagio                            
                                            )))
                                            ie_dono_estouro_resp                            
                                    from    man_sla_evento y
                                    where   1=1   
                                    and     ie_tipo_evento = 8 -- estouro resposta
                                    and     dt_atualizacao between to_date(''01/''||:mes_ref_p||''/''||:ano_ref_p, ''dd/mm/yyyy'') and fim_mes(to_date(''01/''||:mes_ref_p||''/''||:ano_ref_p, ''dd/mm/yyyy''))
                                    and     y.ie_tipo_sla = :ie_tipo_sla_p
                                    
                                    -- nao existe alteracao de prioridade ou classificacao depois do estouro

                                    and     not exists (    select  1
                                                            from    man_sla_evento z
                                                            where   z.nr_seq_ordem = y.nr_seq_ordem
                                                            and     ie_tipo_evento in (10, 7)
                                                            and z.nr_sequencia > y.nr_sequencia
							    and z.dt_atualizacao between to_date(''01/''||:mes_ref_p||''/''||:ano_ref_p, ''dd/mm/yyyy'') and fim_mes(to_date(''01/''||:mes_ref_p||''/''||:ano_ref_p, ''dd/mm/yyyy''))
                                                        )
                                    and not exists (    select  1 
                                                            from    man_ordem_serv_sla_abonada x
                                                            where   x.NR_SEQ_ORDEM_SERVICO = y.nr_seq_ordem
                                                            and x.ie_tipo_abono in (''A'',''R'')) --Abono de SLA total  ou resposta
                                    group by y.nr_seq_ordem
                                ) resp,
                                (   
                                    select  y.nr_seq_ordem,
                                            max(y.nr_sequencia) nr_sequencia,
                                            max(y.nr_seq_regra_sla) nr_seq_regra_sla,
                                            max(y.qt_min_inicio) qt_min_inicio,
                                            max(y.qt_min_termino) qt_min_termino,
                                            max(''Y'') ie_estouro_solucao,
                                            max(nvl(y.nr_seq_grupo_desenv_just, y.nr_seq_grupo_desenv)) nr_seq_grupo_des,
                                            max(nvl(y.nr_seq_grupo_sup_just, y.nr_seq_grupo_sup)) nr_seq_grupo_sup,
                                            min(y.dt_atualizacao) dt_estouro_sol,
                                            max(y.ie_tempo) ie_tempo,
                                            max(y.ie_tempo_termino) ie_tempo_termino,
                                            max(nvl(y.ie_dono_estouro,(
                                                select  max(x1.ie_dono_estouro)
                                                from    (
                                                    select  a.dt_atualizacao,
                                                            nvl((   select min(x.dt_atualizacao)
                                                                from    man_ordem_serv_estagio x
                                                                where   x.nr_sequencia > a.nr_sequencia
                                                                and     x.nr_seq_ordem = a.nr_seq_ordem
                                                                ),
                                                                fim_ano(sysdate)
                                                            )
                                                            dt_fim_estagio,
                                                            nvl(nvl(decode(b.ie_suporte,''S'',''SUP''), nvl(decode(b.ie_desenv,''S'',''DES''),decode(b.ie_tecnologia,''S'',''TEC'')) ), decode(b.ie_infra,''S'',''DES'')) ie_dono_estouro 
                                                    from    man_ordem_serv_estagio a,
                                                            man_estagio_processo b
                                                    where   a.nr_seq_estagio = b.nr_sequencia
                                                    and     b.ie_aguarda_cliente = ''N''
                                                    and     a.nr_seq_ordem = y.nr_seq_ordem
                                                ) x1
                                                where   y.dt_atualizacao between x1.dt_atualizacao and x1.dt_fim_estagio                            
                                            )))
                                            ie_dono_estouro_sol
                                    from    man_sla_evento y
                                    where   1=1   
                                    and     ie_tipo_evento = 9 -- estouro solucao
                                    and     y.dt_atualizacao between to_date(''01/''||:mes_ref_p||''/''||:ano_ref_p, ''dd/mm/yyyy'') and fim_mes(to_date(''01/''||:mes_ref_p||''/''||:ano_ref_p, ''dd/mm/yyyy''))
                                    and     y.ie_tipo_sla_termino = :ie_tipo_sla_p
                                    
                                    -- nao existe alteracao de prioridade ou classificacao depois do estouro

                                    and     not exists (    select  1
                                                            from    man_sla_evento z
                                                            where   z.nr_seq_ordem = y.nr_seq_ordem
                                                            and     ie_tipo_evento in (10, 7) -- 
                                                            and z.nr_sequencia > y.nr_sequencia
							    and	z.dt_atualizacao between to_date(''01/''||:mes_ref_p||''/''||:ano_ref_p, ''dd/mm/yyyy'') and fim_mes(to_date(''01/''||:mes_ref_p||''/''||:ano_ref_p, ''dd/mm/yyyy''))
                                                        )
                                    and not exists (    select  1 
                                                            from    man_ordem_serv_sla_abonada x
                                                            where   x.NR_SEQ_ORDEM_SERVICO = y.nr_seq_ordem
                                                            and x.ie_tipo_abono in (''A'',''S''))  --Abono de SLA total  ou solucao
                                    group by y.nr_seq_ordem
                                ) sol,
                                man_ordem_servico a,
                                man_localizacao b
                        where   1=1
                        and     x.nr_seq_ordem = a.nr_sequencia
                        and     x.nr_seq_ordem = resp.nr_seq_ordem (+)
                        and     x.nr_seq_ordem = sol.nr_seq_ordem (+)
                        and     a.nr_seq_localizacao = b.nr_sequencia
                        and     x.dt_atualizacao between to_date(''01/''||:mes_ref_p||''/''||:ano_ref_p, ''dd/mm/yyyy'') and fim_mes(to_date(''01/''||:mes_ref_p||''/''||:ano_ref_p, ''dd/mm/yyyy''))
			and     x.nr_sequencia = ( select  max(e.nr_sequencia)
                                                   from    man_sla_evento e
                                                   where   e.nr_seq_ordem = a.nr_sequencia
                                                   and     e.ie_tipo_evento in ( 1, 3, 10, 13 )
                                                   and     e.dt_atualizacao between to_date(''01/''||:mes_ref_p||''/''||:ano_ref_p, ''dd/mm/yyyy'') and fim_mes(to_date(''01/''||:mes_ref_p||''/''||:ano_ref_p, ''dd/mm/yyyy''))
                                                   and  (ie_tipo_sla = :ie_tipo_sla_p or ie_tipo_sla_termino = :ie_tipo_sla_p))
                        and not exists ( select  1
                                         from    man_sla_evento z
                                         where   z.nr_seq_ordem = x.nr_seq_ordem
                                         and     ie_tipo_evento in  (7)
					 and     not exists ( select 1
                                                             from  man_sla_evento j
                                                             where j.nr_seq_ordem = z.nr_seq_ordem
                                                             and   j.ie_tipo_evento = 3
                                                             and   j.nr_sequencia > z.nr_sequencia
                                                             and   j.dt_atualizacao between to_date(''01/''||:mes_ref_p||''/''||:ano_ref_p, ''dd/mm/yyyy'') and fim_mes(to_date(''01/''||:mes_ref_p||''/''||:ano_ref_p, ''dd/mm/yyyy'')))
                                         and     z.dt_atualizacao between to_date(''01/''||:mes_ref_p||''/''||:ano_ref_p, ''dd/mm/yyyy'') and fim_mes(to_date(''01/''||:mes_ref_p||''/''||:ano_ref_p, ''dd/mm/yyyy'')) )
			and not exists ( select  1
                                         from    man_sla_evento z
                                         where   z.nr_seq_ordem = x.nr_seq_ordem
                                         and     ie_tipo_evento in (10,14)
                                         and     z.ie_tipo_sla <> :ie_tipo_sla_p
					 and     not exists ( select 1
                                                             from  man_sla_evento h
                                                             where h.nr_seq_ordem = z.nr_seq_ordem
                                                             and   ie_tipo_evento in (10,14)
                                                             and   h.ie_tipo_sla = :ie_tipo_sla_p
                                                             and   h.nr_sequencia > z.nr_sequencia
                                                             and   h.dt_atualizacao between to_date(''01/''||:mes_ref_p||''/''||:ano_ref_p, ''dd/mm/yyyy'') and fim_mes(to_date(''01/''||:mes_ref_p||''/''||:ano_ref_p, ''dd/mm/yyyy'')))
                                         and     z.dt_atualizacao between to_date(''01/''||:mes_ref_p||''/''||:ano_ref_p, ''dd/mm/yyyy'') and fim_mes(to_date(''01/''||:mes_ref_p||''/''||:ano_ref_p, ''dd/mm/yyyy'')))
                        and  (ie_tipo_sla = :ie_tipo_sla_p or ie_tipo_sla_termino = :ie_tipo_sla_p)
                    ) t   
                )v'
;

            EXECUTE sql_w 
            BULK COLLECT INTO STRICT t_sla_detalhe_tb_w 
            USING   ie_tipo_sla_p,
                    ie_tipo_sla_p,
                    ie_tipo_sla_p,
                    ie_tipo_sla_p,
                    ie_tipo_sla_p,
                    ie_tipo_sla_p,
                    mes_ref_p,
                    ano_ref_p, 
                    mes_ref_p, 
                    ano_ref_p,
                    ie_tipo_sla_p,
                    mes_ref_p,
                    ano_ref_p, 
                    mes_ref_p, 
                    ano_ref_p,
                    mes_ref_p, 
                    ano_ref_p, 
                    mes_ref_p, 
                    ano_ref_p,
                    ie_tipo_sla_p,
                    mes_ref_p, 
                    ano_ref_p, 
                    mes_ref_p, 
                    ano_ref_p,
                    mes_ref_p,
                    ano_ref_p, 
                    mes_ref_p, 
                    ano_ref_p,
                    mes_ref_p, 
                    ano_ref_p, 
                    mes_ref_p, 
                    ano_ref_p,
                    ie_tipo_sla_p,
                    ie_tipo_sla_p,
                    mes_ref_p,
                    ano_ref_p, 
                    mes_ref_p, 
                    ano_ref_p,
                    mes_ref_p,
                    ano_ref_p, 
                    mes_ref_p, 
                    ano_ref_p,
                    ie_tipo_sla_p,
                    ie_tipo_sla_p,
                    mes_ref_p,
                    ano_ref_p,
                    mes_ref_p,
                    ano_ref_p,
                    mes_ref_p,
                    ano_ref_p,
                    mes_ref_p,
                    ano_ref_p,
                    ie_tipo_sla_p,
                    ie_tipo_sla_p
;
            for i in 1 .. t_sla_detalhe_tb_w.count loop

                RETURN NEXT  t_sla_detalhe_tb_w(i );

            end loop;
            return;
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION sla_dashboard_pck.obter_sla_detalhe (ie_tipo_sla_p bigint,mes_ref_p bigint, ano_ref_p bigint) FROM PUBLIC;
