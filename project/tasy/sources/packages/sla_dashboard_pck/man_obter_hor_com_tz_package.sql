-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION sla_dashboard_pck.man_obter_hor_com_tz ( cd_estabelecimento_p bigint, dt_inicio_p timestamp, qt_min_p bigint, nr_seq_localizacao_p bigint) RETURNS timestamp AS $body$
DECLARE


qt_min_w	numeric(22);
qt_min_dia_w	numeric(22);
dt_ini_com_w	timestamp;
dt_fim_com_w	timestamp;
dt_ref_w	timestamp;
dt_ret_w	timestamp;
hr_inicio_comercial_w	bigint;
hr_fim_comercial_w	bigint;
nm_timezone_database_w	varchar(50);
dt_inicio_loc_w		timestamp;

BEGIN

if (nr_seq_localizacao_p IS NOT NULL AND nr_seq_localizacao_p::text <> '') then
	select	max(nm_timezone_database)
	into STRICT	nm_timezone_database_w
	from	man_localizacao_horario
	where	nr_seq_localizacao = nr_seq_localizacao_p;
end if;

if (coalesce(nm_timezone_database_w,'X') <> 'X') then

	dt_inicio_loc_w := sla_dashboard_pck.obter_datetime_tz( dt_inicio_p, nm_timezone_database_w);
	dt_ret_w	:= dt_inicio_loc_w + (qt_min_p / 1440);
	qt_min_w	:= qt_min_p;
	dt_ref_w	:= dt_inicio_loc_w;
	
	select	coalesce(substr(max(hr_inicial),1,2),8),
		coalesce(substr(max(hr_final),1,2),18)
	into STRICT	hr_inicio_comercial_w,
		hr_fim_comercial_w	
	from	man_localizacao_horario
	where	nr_seq_localizacao = nr_seq_localizacao_p;
	
	
	while(qt_min_w > 0) loop
		if (obter_cod_dia_semana(dt_ref_w) in (7,1)) then
			dt_ref_w := dt_ref_w + 1;
		elsif (sla_dashboard_pck.obter_se_dia_util_localizacao(dt_inicio_loc_w, nr_seq_localizacao_p) = 'N') then
			dt_ref_w := dt_ref_w + 1;
		else
			begin
			dt_ini_com_w := trunc(dt_ref_w,'dd') + hr_inicio_comercial_w/24;
			dt_fim_com_w := trunc(dt_ref_w,'dd') + hr_fim_comercial_w/24;
	
			if (dt_ref_w < dt_ini_com_w) then
				dt_ref_w := dt_ini_com_w;
			elsif (dt_ref_w > dt_fim_com_w) then
				dt_ref_w := trunc(dt_ref_w + 1,'dd') + hr_inicio_comercial_w/24;
				dt_fim_com_w := trunc(dt_ref_w,'dd') + hr_fim_comercial_w/24;
			end if;
			
			qt_min_dia_w := (dt_fim_com_w - dt_ref_w) * 1440;
			
			if (qt_min_w <= qt_min_dia_w) then
				begin
				dt_ret_w := dt_ref_w + (qt_min_w / 1440);	
				qt_min_w := 0;
				end;
			else
				qt_min_w := qt_min_w - qt_min_dia_w;
				dt_ref_w := trunc(dt_ref_w + 1,'dd') + hr_inicio_comercial_w/24;
			end if;
			end;
		end if;
	end loop;
	
else
	dt_ret_w := man_obter_hor_com(cd_estabelecimento_p, dt_inicio_p, qt_min_p);
end if;

return dt_ret_w;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION sla_dashboard_pck.man_obter_hor_com_tz ( cd_estabelecimento_p bigint, dt_inicio_p timestamp, qt_min_p bigint, nr_seq_localizacao_p bigint) FROM PUBLIC;
