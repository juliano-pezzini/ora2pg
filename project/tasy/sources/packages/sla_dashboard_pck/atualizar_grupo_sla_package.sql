-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE sla_dashboard_pck.atualizar_grupo_sla ( nr_seq_ordem_serv_p bigint, ie_tipo_evento_p text, nr_seq_grupo_desenv_just_p bigint, nr_seq_grupo_sup_just_p bigint, dt_justificativa_p timestamp) AS $body$
DECLARE


dt_atualizacao_w	man_sla_evento.dt_atualizacao%type;
nm_usuario_w		man_sla_evento.nm_usuario%type;
nr_seq_ordem_serv_w	man_sla_evento.nr_seq_ordem%type := nr_seq_ordem_serv_p;
grupo_desenv_w		man_sla_evento.nr_seq_grupo_desenv_just%type := nr_seq_grupo_desenv_just_p;
grupo_sup_w 		man_sla_evento.nr_seq_grupo_sup_just%type := nr_seq_grupo_sup_just_p;
ie_dono_w		man_sla_evento.ie_dono_estouro%type;
dt_justificativa_w	man_sla_justificativa.dt_justificativa%type := dt_justificativa_p;

ie_tipo_evento_w	varchar(4000) := ie_tipo_evento_p;
mes_ref_w		varchar(2) := ie_tipo_evento_p;
ano_ref_w		varchar(4) := ie_tipo_evento_p;

/*
ie_tipo_evento_p:
'R' = Resposta
'S' = Solucao
'A' = Resposta e Solucao
*/



BEGIN

dt_atualizacao_w	:= clock_timestamp();
nm_usuario_w		:= wheb_usuario_pck.get_nm_usuario;
ie_dono_w		:= null;
mes_ref_w		:= to_char(dt_justificativa_w, 'MM');
ano_ref_w		:= to_char(dt_justificativa_w, 'YYYY');

if (ie_tipo_evento_p = 'R') then
	ie_tipo_evento_w := '8';
elsif (ie_tipo_evento_p = 'S') then
	ie_tipo_evento_w := '9';
elsif (ie_tipo_evento_p = 'A') then
	ie_tipo_evento_w := '8,9';
end if;

if (grupo_desenv_w IS NOT NULL AND grupo_desenv_w::text <> '') then
	select	coalesce(max(gw.ie_area_gerencia),'DES')
	into STRICT 	ie_dono_w
	from 	grupo_desenvolvimento gd
	join	gerencia_wheb gw on gd.nr_seq_gerencia = gw.nr_sequencia
	where 	gd.nr_sequencia = grupo_desenv_w;
elsif (grupo_sup_w IS NOT NULL AND grupo_sup_w::text <> '') then
	select	coalesce(max(gw.ie_area_gerencia),'SUP')
	into STRICT 	ie_dono_w
	from	grupo_suporte gs
	join	gerencia_wheb gw on gs.nr_seq_gerencia_sup = gw.nr_sequencia
	where	gs.nr_sequencia = grupo_sup_w;
end if;

update 	man_sla_evento
set 	ie_dono_estouro = ie_dono_w,
	nr_seq_grupo_desenv_just = grupo_desenv_w,
	nr_seq_grupo_sup_just = grupo_sup_w
where 	nr_seq_ordem = nr_seq_ordem_serv_w
and 	ie_tipo_evento in (WITH RECURSIVE cte AS (
	SELECT regexp_substr(ie_tipo_evento_w,'[^ ,]+', 1, level)
				
				level <= length(ie_tipo_evento_w) - length(replace(ie_tipo_evento_w, ',', '')) + 1  UNION ALL
	SELECT regexp_substr(ie_tipo_evento_w,'[^ ,]+', 1, level)
				
				level <= length(ie_tipo_evento_w) - length(replace(ie_tipo_evento_w, ',', '')) + 1 JOIN cte c ON ()

) SELECT * FROM cte;
)
and	dt_atualizacao between to_date('01/'||mes_ref_w||'/'||ano_ref_w, 'dd/mm/yyyy') and fim_mes(to_date('01/'||mes_ref_w||'/'||ano_ref_w, 'dd/mm/yyyy'));

commit;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE sla_dashboard_pck.atualizar_grupo_sla ( nr_seq_ordem_serv_p bigint, ie_tipo_evento_p text, nr_seq_grupo_desenv_just_p bigint, nr_seq_grupo_sup_just_p bigint, dt_justificativa_p timestamp) FROM PUBLIC;
