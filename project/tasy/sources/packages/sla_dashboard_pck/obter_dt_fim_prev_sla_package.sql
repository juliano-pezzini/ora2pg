-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION sla_dashboard_pck.obter_dt_fim_prev_sla ( nr_seq_ordem_serv_p man_ordem_servico.nr_sequencia%type) RETURNS timestamp AS $body$
DECLARE


dt_referencia_w			timestamp;
dt_fim_previsto_w		timestamp;
qt_min_estagio_w		bigint;
qt_min_termino_w		man_ordem_serv_sla.qt_min_termino%type;
qt_min_to_add_w			bigint;
ie_tempo_termino_w		man_ordem_serv_sla.ie_tempo_termino%type;

flow_deviation_exception	exception;


BEGIN
begin

	/* Get the end date that is stored in the MAN_SLA_EVENTO table */


	select	min(mse.dt_atualizacao)
	into STRICT	dt_fim_previsto_w
	from	man_ordem_servico mos,
		man_sla_evento mse
	where	mos.nr_sequencia = mse.nr_seq_ordem
	and	mse.nr_seq_ordem = nr_seq_ordem_serv_p
	and	mse.ie_tipo_evento = 9
	and	mos.ie_classificacao = mse.ie_classificacao
	and	mos.ie_prioridade = mse.ie_prioridade;

	select	moss.dt_inicio_sla,
		coalesce(moss.ie_tempo_termino, moss.ie_tempo),
		moss.qt_min_termino
	into STRICT	dt_referencia_w,
		ie_tempo_termino_w,
		qt_min_termino_w
	from	man_ordem_servico mos,
		man_ordem_serv_sla moss
	where	mos.nr_sequencia = moss.nr_seq_ordem
	and	mos.nr_sequencia = nr_seq_ordem_serv_p;
	
	select	coalesce(sum(man_obter_tempo_estagio(mose.nr_sequencia, mose.nr_seq_ordem, CASE WHEN ie_tempo_termino_w='COR' THEN 'M' WHEN ie_tempo_termino_w='COM' THEN 'MC' END )), 0) qt_minutos_estagio
	into STRICT	qt_min_estagio_w
	from	man_estagio_processo mep,
		man_ordem_serv_estagio mose
	where	mose.nr_seq_ordem = nr_seq_ordem_serv_p
	and	mep.nr_sequencia = mose.nr_seq_estagio
	and	mose.dt_atualizacao between dt_referencia_w and coalesce(dt_fim_previsto_w, clock_timestamp())
	and	mep.ie_aguarda_cliente = 'S';
	
	qt_min_to_add_w := qt_min_estagio_w + qt_min_termino_w;
	
	if (ie_tempo_termino_w = 'COM') then
		dt_fim_previsto_w := phi_obter_hor_com(wheb_usuario_pck.get_cd_estabelecimento, dt_referencia_w, qt_min_to_add_w);
	elsif (ie_tempo_termino_w = 'COR') then
		dt_fim_previsto_w := dt_referencia_w + (1/1440 * qt_min_to_add_w);
	end if;

	/* Return */


	raise flow_deviation_exception;

exception
when flow_deviation_exception then
	null;
when others then
	null;
end;

return dt_fim_previsto_w;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION sla_dashboard_pck.obter_dt_fim_prev_sla ( nr_seq_ordem_serv_p man_ordem_servico.nr_sequencia%type) FROM PUBLIC;
