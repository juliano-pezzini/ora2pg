-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE sla_dashboard_pck.man_incluir_os_evento (nr_seq_ordem_serv_p man_ordem_servico.nr_sequencia%type, nm_usuario_p text, cd_estabelecimento_p bigint, nr_seq_grupo_desenv_p man_sla_evento.nr_seq_grupo_trabalho%type, ie_tipo_evento_p man_sla_evento.ie_tipo_evento%type, ie_commit_p text, ie_classificacao_p man_sla_evento.ie_classificacao%type, ie_prioridade_p man_sla_evento.ie_prioridade%type, qt_min_inicio_p man_sla_evento.qt_min_inicio%type, qt_min_termino_p man_sla_evento.qt_min_termino%type, qt_min_ordem_servico_p bigint, nr_seq_regra_sla_p bigint, nr_seq_grupo_sup_p man_sla_evento.nr_seq_grupo_trabalho%type, dt_evento_retroativa_p timestamp default null,	--Foi adicionado esse parametro para ajustes de datas retroativas
 ie_tipo_sla_p man_ordem_serv_sla.ie_tipo_sla%type DEFAULT NULL, ie_tipo_sla_termino_p man_ordem_serv_sla.ie_tipo_sla_termino%type DEFAULT NULL, ie_tempo_p man_ordem_serv_sla.ie_tempo%type DEFAULT NULL, ie_tempo_termino_p man_ordem_serv_sla.ie_tempo_termino%type DEFAULT NULL, ie_ambiente_p man_ordem_servico.ie_ambiente%type DEFAULT NULL) AS $body$
DECLARE

				
nr_seq_w	bigint;
ie_dono_estouro_w	varchar(3);


BEGIN
	--begin

		if (sla_dashboard_pck.obter_se_os_externa(nr_seq_regra_sla_p) > 0) or (sla_dashboard_pck.obter_regra_alldef(sla_dashboard_pck.obter_nr_seq_regra_alldef(), ie_classificacao_p, ie_prioridade_p) = nr_seq_regra_sla_p) or (nr_seq_regra_sla_p in (1968,1969,1970,1971,1973)) then
			
			if (ie_tipo_evento_p = '8') or (ie_tipo_evento_p = '9') then
				if (nr_seq_grupo_sup_p IS NOT NULL AND nr_seq_grupo_sup_p::text <> '') then
					ie_dono_estouro_w := 'SUP';
				elsif (nr_seq_grupo_desenv_p IS NOT NULL AND nr_seq_grupo_desenv_p::text <> '') then
					ie_dono_estouro_w := 'DES';
				end if;
			end if;
			
			insert into man_sla_evento(
				nr_sequencia,
				nr_seq_ordem,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				ie_tipo_evento,
				nr_seq_grupo_desenv,
				ie_classificacao,
				ie_prioridade,
				qt_min_inicio,
				qt_min_termino,
				qt_min_ordem_servico,
				nr_seq_regra_sla,
				nr_seq_grupo_sup,
				ie_tempo,
				ie_tempo_termino,
				ie_tipo_sla,
				ie_tipo_sla_termino,
				ie_ambiente,
				ie_dono_estouro
				)
			values ( nextval('man_sla_evento_seq'),
				nr_seq_ordem_serv_p,
				coalesce(dt_evento_retroativa_p, clock_timestamp()),
				nm_usuario_p,
				coalesce(dt_evento_retroativa_p, clock_timestamp()),
				nm_usuario_p,
				ie_tipo_evento_p,
				nr_seq_grupo_desenv_p,
				ie_classificacao_p,
				ie_prioridade_p,
				qt_min_inicio_p,
				qt_min_termino_p,
				qt_min_ordem_servico_p,
				nr_seq_regra_sla_p,
				nr_seq_grupo_sup_p,
				ie_tempo_p,
				ie_tempo_termino_p,
				ie_tipo_sla_p,
				ie_tipo_sla_termino_p,
				ie_ambiente_p,
				ie_dono_estouro_w
				);
		
			if (ie_commit_p = 'S') then
				commit;
			end if;
		end if;
	
	--exception

	--when others then

	--	null;

	--end;

end;


$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE sla_dashboard_pck.man_incluir_os_evento (nr_seq_ordem_serv_p man_ordem_servico.nr_sequencia%type, nm_usuario_p text, cd_estabelecimento_p bigint, nr_seq_grupo_desenv_p man_sla_evento.nr_seq_grupo_trabalho%type, ie_tipo_evento_p man_sla_evento.ie_tipo_evento%type, ie_commit_p text, ie_classificacao_p man_sla_evento.ie_classificacao%type, ie_prioridade_p man_sla_evento.ie_prioridade%type, qt_min_inicio_p man_sla_evento.qt_min_inicio%type, qt_min_termino_p man_sla_evento.qt_min_termino%type, qt_min_ordem_servico_p bigint, nr_seq_regra_sla_p bigint, nr_seq_grupo_sup_p man_sla_evento.nr_seq_grupo_trabalho%type, dt_evento_retroativa_p timestamp default null, ie_tipo_sla_p man_ordem_serv_sla.ie_tipo_sla%type DEFAULT NULL, ie_tipo_sla_termino_p man_ordem_serv_sla.ie_tipo_sla_termino%type DEFAULT NULL, ie_tempo_p man_ordem_serv_sla.ie_tempo%type DEFAULT NULL, ie_tempo_termino_p man_ordem_serv_sla.ie_tempo_termino%type DEFAULT NULL, ie_ambiente_p man_ordem_servico.ie_ambiente%type DEFAULT NULL) FROM PUBLIC;
