-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

  
  /*----------------------------------------------------------------------------------------------------------------------------
    Finalidade: Retornar a sequencia da regra cadastrada na funçao "HDM - Cadatros gerais" aba "Regra geraçao agenda integrada"
    */
  


CREATE OR REPLACE FUNCTION hdm_agendamento_ageint_pkg.obter_regra_gera_ageint (nr_seq_captacao_p mprev_captacao.nr_sequencia%type, nr_seq_partic_ciclo_item_p mprev_partic_ciclo_item.nr_sequencia%type) RETURNS bigint AS $body$
DECLARE


		nr_seq_regra_w hdm_regra_gerar_agenda.nr_sequencia%type;

		
BEGIN

		select max(a.nr_sequencia)
		into STRICT    nr_seq_regra_w
		from	hdm_regra_gerar_agenda a,
				hdm_regra_ger_agenda_perf b
		where	a.nr_sequencia 	= b.nr_seq_gerar_agenda
		and	a.ie_situacao = 'A'
		and	b.cd_perfil 	= Obter_Perfil_Ativo
		and	((a.ie_captacao = 'S' and (nr_seq_captacao_p IS NOT NULL AND nr_seq_captacao_p::text <> ''))
				or (a.ie_acomp_plano = 'S' and (nr_seq_partic_ciclo_item_p IS NOT NULL AND nr_seq_partic_ciclo_item_p::text <> '')));

		if (coalesce(nr_seq_regra_w::text, '') = '') then
				select	max(a.nr_sequencia)
				into STRICT    nr_seq_regra_w
				from	hdm_regra_gerar_agenda a
				where	a.ie_situacao = 'A'
				and (SELECT	count(*)
						from	hdm_regra_ger_agenda_perf b
						where	a.nr_sequencia 	= b.nr_seq_gerar_agenda
						and	(b.cd_perfil IS NOT NULL AND b.cd_perfil::text <> '')) = 0
				and	((a.ie_captacao = 'S' and (nr_seq_captacao_p IS NOT NULL AND nr_seq_captacao_p::text <> ''))
				or (a.ie_acomp_plano = 'S' and (nr_seq_partic_ciclo_item_p IS NOT NULL AND nr_seq_partic_ciclo_item_p::text <> '')));
		end if;

		return	nr_seq_regra_w;

	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION hdm_agendamento_ageint_pkg.obter_regra_gera_ageint (nr_seq_captacao_p mprev_captacao.nr_sequencia%type, nr_seq_partic_ciclo_item_p mprev_partic_ciclo_item.nr_sequencia%type) FROM PUBLIC;
