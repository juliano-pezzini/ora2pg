-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION qt_prescricao_md_pck.combinar_prescricao (a qt_prescricao_pck.prescricao, b qt_prescricao_pck.prescricao) RETURNS QT_PRESCRICAO_PCK.PRESCRICAO AS $body$
DECLARE

        type dicionario_medicamento is table of qt_prescricao_pck.medicamento index by integer;
        medicamentos_w qt_prescricao_pck.medicamento_vetor;
        dicionario dicionario_medicamento;
        medicamento_w qt_prescricao_pck.medicamento;
        medicamento_existente_w qt_prescricao_pck.medicamento;
        medicamento_combinado_w qt_prescricao_pck.medicamento;
        retorno_w qt_prescricao_pck.prescricao;
        indice_w bigint;
        indice_retorno_w bigint;

BEGIN
        -- combinar todos os lotes de prescricao
        indice_w := a.medicamentos.first;
        while(indice_w IS NOT NULL AND indice_w::text <> '') loop
            medicamentos_w(medicamentos_w.count) := a.medicamentos(indice_w);
            indice_w := a.medicamentos.next(indice_w);
        end loop;

        indice_w := b.medicamentos.first;
        while(indice_w IS NOT NULL AND indice_w::text <> '') loop
            medicamentos_w(medicamentos_w.count) := b.medicamentos(indice_w);
            indice_w := b.medicamentos.next(indice_w);
        end loop;

        indice_w := medicamentos_w.first;
        while(indice_w IS NOT NULL AND indice_w::text <> '') loop
            medicamento_w := medicamentos_w(indice_w);

            if dicionario.exists(medicamento_w.codigo) then
                -- se ja existe um lote deste medicamento, entao deve-se combinar os lotes
                medicamento_existente_w := dicionario(medicamento_w.codigo);

                medicamento_combinado_w.codigo := medicamento_w.codigo;
                medicamento_combinado_w.nome := medicamento_w.nome;
                medicamento_combinado_w.dose := medicamento_w.dose;
                medicamento_combinado_w.unidade_medida := medicamento_w.unidade_medida;
                medicamento_combinado_w.quantidade := medicamento_w.quantidade + medicamento_existente_w.quantidade;

                dicionario(medicamento_w.codigo) := medicamento_combinado_w;
            else
                -- senao existir, basta adicionar ao dicionario
                dicionario(medicamento_w.codigo) := medicamento_w;
            end if;

            indice_w := medicamentos_w.next(indice_w);
        end loop;

        indice_w := dicionario.first;
        indice_retorno_w := 1;
        while(indice_w IS NOT NULL AND indice_w::text <> '') loop
            medicamento_w := dicionario(indice_w);
            retorno_w.medicamentos(indice_retorno_w) := medicamento_w;

            indice_w := dicionario.next(indice_w);
            indice_retorno_w := indice_retorno_w + 1;
        end loop;

        retorno_w.perda := a.perda + b.perda;

        return retorno_w;
    end;


$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION qt_prescricao_md_pck.combinar_prescricao (a qt_prescricao_pck.prescricao, b qt_prescricao_pck.prescricao) FROM PUBLIC;
