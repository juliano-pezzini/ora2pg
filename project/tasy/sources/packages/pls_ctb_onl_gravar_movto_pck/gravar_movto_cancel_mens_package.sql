-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_ctb_onl_gravar_movto_pck.gravar_movto_cancel_mens ( nr_seq_mensalidade_p bigint, dt_cancelamento_p timestamp, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE


	dt_movimento_w 		timestamp;
	vl_contabil_w 		pls_mensalidade_seg_item.vl_item%type;

	c_itens_mens CURSOR FOR
	SELECT	distinct coalesce(a.vl_item,0) vl_contabil,
		coalesce(a.vl_antecipacao, 0) vl_antecipacao,
		h.nr_seq_info nr_seq_info_ctb,
		h.nm_tabela,
		h.nm_atributo,
		h.cd_tipo_lote_contabil,
		f.nr_sequencia nr_documento,
		d.nr_sequencia nr_seq_doc_compl,
		a.nr_sequencia nr_doc_analitico,
		count(case ie_situacao_ctb when 'P' then 1 end) qt_pendente
	from	pls_mensalidade_seg_item	a,
		pls_mensalidade_segurado	b,
		pls_segurado			c,
		pls_mensalidade			d,
		pls_lote_mensalidade		f,
		pls_plano			g,
		ctb_documento			h
	where	b.nr_sequencia	= a.nr_seq_mensalidade_seg
	and	c.nr_sequencia	= b.nr_seq_segurado
	and	d.nr_sequencia	= b.nr_seq_mensalidade
	and	g.nr_sequencia	= b.nr_seq_plano
	and	f.nr_sequencia	= d.nr_seq_lote
	and	h.nr_documento	= f.nr_sequencia
	and	h.nr_seq_doc_compl = d.nr_sequencia
	and	h.nr_doc_analitico = a.nr_sequencia
	and	h.nm_tabela = 'PLS_MENSALIDADE_SEG_ITEM'
	and	h.nm_atributo in ('VL_COPARTICIPACAO', 'VL_POS_ESTABELECIDO', 'VL_ITEM', 'VL_NOTA', 'VL_NOTA_REV', 'VL_CONTA_CO', 'VL_ANTECIPACAO')
	and	h.cd_tipo_lote_contabil in (49,50)
	and	coalesce(h.ds_origem, 'ESTORNO') <> 'ESTORNO'
	and	coalesce(d.nr_seq_cancel_rec_mens::text, '') = ''
	and	a.ie_tipo_item not in ('43')
	and	d.nr_sequencia = nr_seq_mensalidade_p
	group by a.vl_item,
		a.vl_antecipacao,
		a.vl_ato_cooperado,
		a.vl_ato_auxiliar,
		a.vl_ato_nao_cooperado,
		h.nr_seq_info,
		h.nm_tabela,
		h.nm_atributo,
		h.cd_tipo_lote_contabil,
		f.nr_Sequencia,
		d.nr_sequencia,
		a.nr_sequencia,
		a.ie_tipo_item,
		b.dt_mesano_referencia,
		a.nr_seq_conta;

	vet_itens_mens c_itens_mens%rowtype;

	
BEGIN

	open c_itens_mens;
	loop
	fetch c_itens_mens into
		vet_itens_mens;
	EXIT WHEN NOT FOUND; /* apply on c_itens_mens */
		begin
		dt_movimento_w := dt_cancelamento_p;

		if (dt_movimento_w < clock_timestamp()) then
			dt_movimento_w := clock_timestamp();
		end if;

		if (vet_itens_mens.nm_atributo = 'VL_ANTECIPACAO') then
			vl_contabil_w := vet_itens_mens.vl_antecipacao;
		else
			vl_contabil_w := vet_itens_mens.vl_contabil;
		end if;

		if (coalesce(vl_contabil_w, 0) <> 0) then
			if (vet_itens_mens.qt_pendente > 0) then
				delete 	FROM ctb_documento
				where	nr_documento = vet_itens_mens.nr_documento
				and	nr_seq_doc_compl = vet_itens_mens.nr_seq_doc_compl
				and	nr_doc_analitico = vet_itens_mens.nr_doc_analitico
				and 	nm_tabela = vet_itens_mens.nm_tabela
				and	nm_atributo = vet_itens_mens.nm_atributo
				and	cd_tipo_lote_contabil = vet_itens_mens.cd_tipo_lote_contabil
				and	ie_situacao_ctb = 'P';
			else
				CALL ctb_concil_financeira_pck.ctb_gravar_documento(	cd_estabelecimento_p,
										dt_movimento_w,
										vet_itens_mens.cd_tipo_lote_contabil,
										null,
										vet_itens_mens.nr_seq_info_ctb,
										vet_itens_mens.nr_documento,
										vet_itens_mens.nr_seq_doc_compl,
										vet_itens_mens.nr_doc_analitico,
										vl_contabil_w * -1, --Inverte o valor pois e estorno
										vet_itens_mens.nm_tabela,
										vet_itens_mens.nm_atributo,
										nm_usuario_p,
										'P',
										'ESTORNO');
			end if;
		end if;

		end;
	end loop;
	close c_itens_mens;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_ctb_onl_gravar_movto_pck.gravar_movto_cancel_mens ( nr_seq_mensalidade_p bigint, dt_cancelamento_p timestamp, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;
