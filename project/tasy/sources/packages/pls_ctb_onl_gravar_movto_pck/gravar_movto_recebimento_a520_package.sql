-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_ctb_onl_gravar_movto_pck.gravar_movto_recebimento_a520 ( nr_seq_lote_p bigint, nm_usuario_p text) AS $body$
DECLARE


	cd_estabelecimento_w		estabelecimento.cd_estabelecimento%type;
	ie_tipo_lote_w			ptu_lote_aviso.ie_tipo_lote%type;
	vl_contabil_w			ptu_aviso_material.vl_total%type;
	nm_atributo_w			ctb_documento.nm_atributo%type;
	nr_seq_atualizacao_w		pls_atualizacao_contabil.nr_sequencia%type := 0;
	qt_movimento_w			bigint := 0;
	ie_tipo_movimento_w		varchar(1);
	dt_movimento_w			timestamp;

	c_aviso CURSOR FOR
	SELECT	x.vl_contabil vl_contabil,
		x.nm_tabela,
		87 nr_seq_info_ctb,
		aa.nr_sequencia nr_seq_arquivo,
		x.nr_doc_analitico
	from (SELECT	b.vl_total vl_contabil,
			'PTU_AVISO_PROCEDIMENTO' nm_tabela,
			b.nr_seq_aviso_conta,
			b.nr_sequencia nr_doc_analitico
		from	ptu_aviso_procedimento	b
		
union all

		select	b.vl_total vl_contabil,
			'PTU_AVISO_MATERIAL' nm_tabela,
			b.nr_seq_aviso_conta,
			b.nr_sequencia nr_doc_analitico
		from	ptu_aviso_material	b) x,
		ptu_aviso_protocolo	ap,
		ptu_aviso_conta		ac,
		ptu_aviso_arquivo	aa,
		ptu_lote_aviso		l
	where	ap.nr_sequencia			= ac.nr_seq_aviso_protocolo
	and	ac.nr_sequencia			= x.nr_seq_aviso_conta
	and	ap.nr_seq_arquivo		= aa.nr_sequencia
	and	aa.nr_seq_lote			= l.nr_sequencia
	and	l.nr_sequencia			= nr_seq_lote_p
	and	ie_tipo_lote_w			= 'R';
	vet_aviso c_aviso%rowtype;

	
BEGIN

	-- Obtem as informacoes referentes a ptu_lote_aviso, utilizadas para gravar o movimento
	begin
	select	b.cd_estabelecimento,
		b.ie_tipo_lote,
		coalesce(b.dt_referencia_inicio,b.dt_importacao)
	into STRICT	cd_estabelecimento_w,
		ie_tipo_lote_w,
		dt_movimento_w
	from	ptu_lote_aviso b
	where	b.nr_sequencia = nr_seq_lote_p;
	exception when others then
	cd_estabelecimento_w	:= wheb_usuario_pck.get_cd_estabelecimento;
	ie_tipo_lote_w		:= 'X';
	dt_movimento_w		:= null;
	end;

	pls_gerar_atualizacao_contabil(		trunc(dt_movimento_w, 'month'),
						nm_usuario_p,
						cd_estabelecimento_w,
						57,
						'G',
						qt_movimento_w,
						nr_seq_atualizacao_w);

	open c_aviso;
	loop
	fetch c_aviso into
		vet_aviso;
	EXIT WHEN NOT FOUND; /* apply on c_aviso */
		begin

		if (coalesce(vet_aviso.vl_contabil, 0) <> 0) then

			-- Se existir registro na tabela ptu_aviso_glosa_bx_dados para este arquivo, o tipo e 'G'. Caso contrario sera 'N'
			select 	coalesce((	select	'G'
					from	ptu_aviso_glosa_bx		g,
						ptu_aviso_glosa_bx_dados	d
					where	g.nr_sequencia		= d.nr_seq_glosa_baixa
					and	g.nr_seq_arquivo	= vet_aviso.nr_seq_arquivo), 'N')
			into STRICT	ie_tipo_movimento_w
			;

			if (ie_tipo_movimento_w = 'N') then
				vl_contabil_w := vet_aviso.vl_contabil;
				nm_atributo_w := 'VL_TOTAL';
			elsif (ie_tipo_movimento_w = 'G') then
				vl_contabil_w := vet_aviso.vl_contabil * -1;
				nm_atributo_w := 'VL_GLOSA';
			end if;

			ctb_pls_atualizar_aviso_cobr(	nr_seq_lote_p,
							vet_aviso.nr_seq_arquivo,
							null,
							null,
							null,
							null,
							null,
							null,
							null,
							nr_seq_atualizacao_w,
							nm_usuario_p,
							cd_estabelecimento_w,
							qt_movimento_w);

			CALL ctb_concil_financeira_pck.ctb_gravar_documento(	cd_estabelecimento_w,
									pkg_date_utils.start_of(clock_timestamp(), 'DAY'),
									57,
									null,
									vet_aviso.nr_seq_info_ctb,
									nr_seq_lote_p,
									vet_aviso.nr_seq_arquivo,
									vet_aviso.nr_doc_analitico,
									vl_contabil_w,
									vet_aviso.nm_tabela,
									nm_atributo_w,
									nm_usuario_p);

		end if;

		end;
	end loop;
	close c_aviso;

	pls_gerar_atualizacao_contabil(		trunc(dt_movimento_w, 'month'),
						nm_usuario_p,
						cd_estabelecimento_w,
						57,
						'A',
						qt_movimento_w,
						nr_seq_atualizacao_w);
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_ctb_onl_gravar_movto_pck.gravar_movto_recebimento_a520 ( nr_seq_lote_p bigint, nm_usuario_p text) FROM PUBLIC;
