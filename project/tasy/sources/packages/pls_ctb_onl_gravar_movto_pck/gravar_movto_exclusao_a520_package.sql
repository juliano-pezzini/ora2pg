-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_ctb_onl_gravar_movto_pck.gravar_movto_exclusao_a520 ( nr_seq_arquivo_p bigint) AS $body$
DECLARE


	ctb_doc_w			ctb_documento%rowtype;
	cd_estabelecimento_w		estabelecimento.cd_estabelecimento%type;
	ie_tipo_lote_w			ptu_lote_aviso.ie_tipo_lote%type;
	vl_contabil_w			ptu_aviso_material.vl_total%type;
	nm_atributo_w			ctb_documento.nm_atributo%type;
	nr_seq_lote_w			ptu_lote_aviso.nr_sequencia%type;
	nm_usuario_w			usuario.nm_usuario%type;
	ie_tipo_movimento_w		varchar(1);
	dt_movimento_w			timestamp;

	c_aviso CURSOR FOR
	SELECT	CASE WHEN ie_tipo_movimento_w='N' THEN  x.vl_contabil  ELSE x.vl_contabil * -1 END  vl_contabil,
		x.nm_tabela,
		CASE WHEN ie_tipo_movimento_w='N' THEN  'VL_TOTAL'  ELSE 'VL_GLOSA' END  nm_atributo,
		87 nr_seq_info_ctb,
		aa.nr_sequencia nr_seq_arquivo,
		x.nr_doc_analitico,
		d.cd_tipo_lote_contabil,
		count(case d.ie_situacao_ctb when 'P' then 1 end) qt_pendente
	from (SELECT	b.vl_total vl_contabil,
			'PTU_AVISO_PROCEDIMENTO' nm_tabela,
			b.nr_seq_aviso_conta,
			b.nr_sequencia nr_doc_analitico
		from	ptu_aviso_procedimento	b
		
union all

		select	b.vl_total vl_contabil,
			'PTU_AVISO_MATERIAL' nm_tabela,
			b.nr_seq_aviso_conta,
			b.nr_sequencia nr_doc_analitico
		from	ptu_aviso_material	b) x,
		ptu_aviso_protocolo	ap,
		ptu_aviso_conta		ac,
		ptu_aviso_arquivo	aa,
		ptu_lote_aviso		l,
		ctb_documento		d
	where	ap.nr_sequencia			= ac.nr_seq_aviso_protocolo
	and	ac.nr_sequencia			= x.nr_seq_aviso_conta
	and	ap.nr_seq_arquivo		= aa.nr_sequencia
	and	aa.nr_seq_lote			= l.nr_sequencia
	and	d.nr_documento			= nr_seq_lote_w
	and	d.nr_seq_doc_compl		= aa.nr_sequencia
	and	d.nr_doc_analitico		= x.nr_doc_analitico
	and	d.nm_tabela			in ('PTU_AVISO_PROCEDIMENTO', 'PTU_AVISO_MATERIAL')
	and	d.cd_tipo_lote_contabil 	= 57
	and	aa.nr_sequencia			= nr_seq_arquivo_p
	and	ie_tipo_lote_w			= 'R'
	group by x.vl_contabil,
		x.nm_tabela,
		aa.nr_sequencia,
		x.nr_doc_analitico,
		d.cd_tipo_lote_contabil;
	vet_aviso c_aviso%rowtype;

	
BEGIN

	/* Se for passado outro parametro que nao o arquivo, finaliza imediatamente a execucao. 
	Essa situacao ocorre pois a procedure que chama esta pode ter recebido outro parametro de exclusao,
	nao aplicavel para a contabilidade instantanea */
	if (coalesce(nr_seq_arquivo_p::text, '') = '') then
		return;
	end if;
	begin
	nm_usuario_w 	:= wheb_usuario_pck.get_nm_usuario();
	exception when others then
	nm_usuario_w 	:= null;
	end;
	-- Obtem as informacoes referentes a ptu_lote_aviso, utilizadas para gravar o movimento
	begin
	select	b.cd_estabelecimento,
		b.ie_tipo_lote,
		coalesce(b.dt_referencia_inicio,b.dt_importacao),
		b.nr_sequencia
	into STRICT	cd_estabelecimento_w,
		ie_tipo_lote_w,
		dt_movimento_w,
		nr_seq_lote_w
	from	ptu_lote_aviso b,
		ptu_aviso_arquivo a
	where	a.nr_seq_lote	= b.nr_sequencia
	and	a.nr_sequencia 	= nr_seq_arquivo_p;
	exception when others then
	cd_estabelecimento_w	:= wheb_usuario_pck.get_cd_estabelecimento;
	ie_tipo_lote_w		:= 'X';
	dt_movimento_w		:= null;
	nr_seq_lote_w		:= null;
	end;

	-- Se existir registro na tabela ptu_aviso_glosa_bx_dados para este arquivo, o tipo e 'G'. Caso contrario sera 'N'
	select 	coalesce((	select	'G'
			from	ptu_aviso_glosa_bx		g,
				ptu_aviso_glosa_bx_dados	d
			where	g.nr_sequencia		= d.nr_seq_glosa_baixa
			and	g.nr_seq_arquivo	= nr_seq_arquivo_p), 'N')
	into STRICT	ie_tipo_movimento_w
	;

	open c_aviso;
	loop
	fetch c_aviso into
		vet_aviso;
	EXIT WHEN NOT FOUND; /* apply on c_aviso */
		begin

		if (vet_aviso.qt_pendente > 0) then
			delete 	FROM ctb_documento
			where	nr_documento			= nr_seq_lote_w
			and	nr_seq_doc_compl 		= nr_seq_arquivo_p
			and	nr_doc_analitico 		= vet_aviso.nr_doc_analitico
			and 	nm_tabela 			= vet_aviso.nm_tabela
			and	nm_atributo 			= vet_aviso.nm_atributo
			and	cd_tipo_lote_contabil 		= vet_aviso.cd_tipo_lote_contabil
			and	nr_seq_info 			= vet_aviso.nr_seq_info_ctb
			and	ie_situacao_ctb 		= 'P'
			and	coalesce(ds_origem, 'X')		<> 'ESTORNO';
		else
			if (coalesce(vet_aviso.vl_contabil, 0) <> 0) then
				CALL ctb_concil_financeira_pck.ctb_gravar_documento(	cd_estabelecimento_w,
										pkg_date_utils.start_of(clock_timestamp(), 'DAY'),
										57,
										null,
										vet_aviso.nr_seq_info_ctb,
										nr_seq_lote_w,
										nr_seq_arquivo_p,
										vet_aviso.nr_doc_analitico,
										vet_aviso.vl_contabil -1, --Inverte o valor por ser um estorno
										vet_aviso.nm_tabela,
										vet_aviso.nm_atributo,
										nm_usuario_w,
										'P',
										'ESTORNO');

				select 	*
				into STRICT	ctb_doc_w
				from   	ctb_documento a
				where 	nr_sequencia = (SELECT max(nr_sequencia)
							from	ctb_documento
							where	a.nr_documento 		= nr_seq_lote_w
							and	a.nr_seq_doc_compl	= nr_seq_arquivo_p
							and	a.nr_doc_analitico	= vet_aviso.nr_doc_analitico
							and	a.cd_tipo_lote_contabil = 57
							and	coalesce(a.ds_origem, 'X')	= 'ESTORNO');

				CALL pls_contab_onl_lote_fin_pck.contabiliza_documento(ctb_doc_w, nm_usuario_w);
			end if;
		end if;

		end;
	end loop;
	close c_aviso;
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_ctb_onl_gravar_movto_pck.gravar_movto_exclusao_a520 ( nr_seq_arquivo_p bigint) FROM PUBLIC;
