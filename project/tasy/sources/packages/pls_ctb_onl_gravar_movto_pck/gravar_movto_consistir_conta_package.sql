-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_ctb_onl_gravar_movto_pck.gravar_movto_consistir_conta ( nr_seq_conta_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE


	ie_consiste_recalculo_w		pls_parametro_contabil.ie_consiste_recalculo%type;
	ie_status_prov_pagto_w		pls_parametro_contabil.ie_status_prov_pagto%type;
	nr_seq_protocolo_w		pls_protocolo_conta.nr_sequencia%type;
	dt_mes_competencia_w		timestamp;
	
	c_itens_prov_prod CURSOR FOR
		SELECT	p.nr_sequencia,
			'PLS_CONTA_PROC' nm_tabela,
			CASE WHEN a.ie_tipo_protocolo='F' THEN  coalesce(p.vl_liberado, 0)  ELSE coalesce(p.vl_provisao,0) END  vl_provisao,
			a.ie_tipo_protocolo
		from	pls_conta_proc		p,
			pls_conta		b,
			pls_protocolo_conta	a
		where	p.nr_seq_conta 		= b.nr_sequencia
		and	a.nr_sequencia		= b.nr_seq_protocolo
		and	p.nr_seq_conta		= nr_seq_conta_p
		and	a.cd_estabelecimento 	= cd_estabelecimento_p
		and	a.ie_tipo_protocolo	in ('C', 'F')
		and (ie_status_prov_pagto_w	= 'NC' or a.ie_tipo_protocolo = 'F')
		and	b.ie_status		not in ('C', 'U')
		and	a.ie_situacao		not in ('RE', 'I')
		and	p.ie_status 		not in ('D', 'M')
		and	((ie_consiste_recalculo_w <> 'S')
		or ('P' not in (	SELECT	coalesce(max(x.ie_tipo_relacao),'X')
					from	pls_prestador	x
					where	x.nr_sequencia	= b.nr_seq_prestador_exec)))
		
union all

		select	p.nr_sequencia,
			'PLS_CONTA_MAT' nm_tabela,
			CASE WHEN a.ie_tipo_protocolo='F' THEN  coalesce(p.vl_liberado, 0)  ELSE coalesce(p.vl_provisao, 0) END  vl_provisao,
			a.ie_tipo_protocolo
		from	pls_conta_mat		p,
			pls_conta		b,
			pls_protocolo_conta	a
		where	b.nr_sequencia		= p.nr_seq_conta
		and	a.nr_sequencia		= b.nr_seq_protocolo
		and	p.nr_seq_conta		= nr_seq_conta_p
		and	a.cd_estabelecimento	= cd_estabelecimento_p
		and	a.ie_tipo_protocolo	in ('C', 'F')
		and (ie_status_prov_pagto_w	= 'NC' or a.ie_tipo_protocolo = 'F')
		and	b.ie_status		not in ('C', 'U')
		and	a.ie_situacao 		not in ('RE','I')
		and	p.ie_status 		not in ('D','M')
		and	((ie_consiste_recalculo_w <> 'S')
		or ('P' not in (	select	coalesce(max(x.ie_tipo_relacao),'X')
					from	pls_prestador	x
					where	x.nr_sequencia	= b.nr_seq_prestador_exec)));
		
	vet_itens_prov_prod	c_itens_prov_prod%rowtype;

	
BEGIN

	select	max(a.dt_mes_competencia),
		max(a.nr_sequencia)
	into STRICT	dt_mes_competencia_w,
		nr_seq_protocolo_w
	from	pls_protocolo_conta	a,
		pls_conta		b
	where	a.nr_sequencia	= b.nr_seq_protocolo
	and	b.nr_sequencia	= nr_seq_conta_p;

	select	coalesce(max(ie_status_prov_pagto),'NC'),
		max(coalesce(ie_consiste_recalculo,'N'))
	into STRICT	ie_status_prov_pagto_w,
		ie_consiste_recalculo_w
	from	pls_parametro_contabil
	where	cd_estabelecimento	= cd_estabelecimento_p;

	/* A atualizacao das contas contabeis de provisao de producao medica ja era feita na pls_consistir_conta */

	if (ie_status_prov_pagto_w = 'NC') then
		open c_itens_prov_prod;
			loop
		fetch c_itens_prov_prod into	
			vet_itens_prov_prod;
		EXIT WHEN NOT FOUND; /* apply on c_itens_prov_prod */
			begin
			if (vet_itens_prov_prod.vl_provisao > 0) then
				CALL ctb_concil_financeira_pck.ctb_gravar_documento(cd_estabelecimento_p,
										pkg_date_utils.start_of(clock_timestamp(), 'DAY'),
										40,
										null,
										36,
										nr_seq_protocolo_w,
										nr_seq_conta_p,
										vet_itens_prov_prod.nr_sequencia,
										vet_itens_prov_prod.vl_provisao,
										vet_itens_prov_prod.nm_tabela,
										'VL_PROVISAO',
										nm_usuario_p);
			end if;
			end;
		end loop;
		close c_itens_prov_prod;
	end if;	
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_ctb_onl_gravar_movto_pck.gravar_movto_consistir_conta ( nr_seq_conta_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;
