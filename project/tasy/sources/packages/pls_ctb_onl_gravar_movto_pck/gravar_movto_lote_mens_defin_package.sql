-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_ctb_onl_gravar_movto_pck.gravar_movto_lote_mens_defin ( nr_seq_lote_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE


	dt_movimento_w 		timestamp;
	nm_atributo_w		ctb_documento.nm_atributo%type;
	nr_seq_info_ctb_w	ctb_documento.nr_seq_info%type;
	vl_contabil_w		ctb_documento.vl_movimento%type;

	c_itens_mens CURSOR FOR
	SELECT	coalesce(a.vl_item,0) vl_contabil,
		coalesce(a.vl_antecipacao,0) vl_antecipacao,
		pls_obter_data_contab_ppcng(d.ie_cancelamento,d.dt_cancelamento,b.dt_inicio_cobertura,f.dt_mesano_referencia,a.nr_seq_item_cancel) dt_inicio_cobertura,
		coalesce(a.dt_inicio_cobertura,b.dt_inicio_cobertura) dt_inicio_cobertura_aprop,
		c.dt_rescisao dt_rescisao,
		'PLS_MENSALIDADE_SEG_ITEM' nm_tabela,
		f.nr_sequencia nr_documento,
		d.nr_sequencia nr_seq_doc_compl,
		a.nr_sequencia nr_doc_analitico,
		b.dt_mesano_referencia dt_mesano_referencia,
		a.ie_tipo_item,
		coalesce(f.ie_mensalidade_mes_anterior,'N') ie_mensalidade_mes_anterior,
		f.dt_mesano_referencia dt_referencia_lote,
		(SELECT count(1)
		from	pls_regra_pro_rata_dia x
		where	x.ie_tipo_item_mensalidade	= a.ie_tipo_item) qt_regra_pro_rata
	from	pls_mensalidade_seg_item	a,
		pls_mensalidade_segurado	b,
		pls_segurado			c,
		pls_mensalidade			d,
		pls_lote_mensalidade		f,
		pls_plano			g
	where	b.nr_sequencia	= a.nr_seq_mensalidade_seg
	and	c.nr_sequencia	= b.nr_seq_segurado
	and	d.nr_sequencia	= b.nr_seq_mensalidade
	and	g.nr_sequencia	= b.nr_seq_plano
	and	f.nr_sequencia	= d.nr_seq_lote
	and	coalesce(d.nr_seq_cancel_rec_mens::text, '') = ''
	and	a.ie_tipo_item not in ('43')
	and	f.nr_sequencia = nr_seq_lote_p;

	vet_itens_mens c_itens_mens%rowtype;
	
BEGIN

	open c_itens_mens;
	loop
	fetch c_itens_mens into
		vet_itens_mens;
	EXIT WHEN NOT FOUND; /* apply on c_itens_mens */
		begin

		/* Provisao da PPCNG*/

		dt_movimento_w := vet_itens_mens.dt_inicio_cobertura;
		if (trunc(vet_itens_mens.dt_mesano_referencia,'month') < trunc(clock_timestamp(),'month')) then
			dt_movimento_w := trunc(clock_timestamp(),'month');
		end if;

		if (coalesce(dt_movimento_w::text, '') = '') then
			dt_movimento_w := trunc(clock_timestamp(), 'month');
		end if;

		nm_atributo_w 	:= 	case 	vet_itens_mens.ie_tipo_item
				 	when	'3' then 'VL_COPARTICIPACAO'
				 	when	'6' then 'VL_POS_ESTABELECIDO'
				 	else   'VL_ITEM'
					end;

		nr_seq_info_ctb_w := 	case	vet_itens_mens.ie_tipo_item
					when	'3' then 57
					when	'6' then 58
					else	56
					end;

		if (coalesce(vet_itens_mens.vl_contabil, 0) <> 0) then
			CALL ctb_concil_financeira_pck.ctb_gravar_documento(	cd_estabelecimento_p,
									trunc(dt_movimento_w),
									49,
									null,
									nr_seq_info_ctb_w,
									vet_itens_mens.nr_documento,
									vet_itens_mens.nr_seq_doc_compl,
									vet_itens_mens.nr_doc_analitico,
									vet_itens_mens.vl_contabil,
									vet_itens_mens.nm_tabela,
									nm_atributo_w,
									nm_usuario_p);
		end if;
		
		dt_movimento_w := null;

		/* Apropriacao da PPCNG */

		vl_contabil_w := vet_itens_mens.vl_contabil;
		dt_movimento_w := vet_itens_mens.dt_inicio_cobertura_aprop;
		if (vet_itens_mens.dt_rescisao IS NOT NULL AND vet_itens_mens.dt_rescisao::text <> '') then
			dt_movimento_w := vet_itens_mens.dt_rescisao;
		end if;

		if (coalesce(dt_movimento_w::text, '') = '') then
			dt_movimento_w := trunc(clock_timestamp(), 'month');
		end if;

		nm_atributo_w 	:= 	case 	vet_itens_mens.ie_tipo_item
				 	when	'3' then 'VL_COPARTICIPACAO'
				 	when	'6' then 'VL_POS_ESTABELECIDO'
					when	'13' then 'VL_CONTA_CO'
				 	else   'VL_ITEM'
					end;

		nr_seq_info_ctb_w := 	case	vet_itens_mens.ie_tipo_item
					when	'3' then 57
					when	'6' then 58
					else	56
					end;
			
		if (coalesce(vet_itens_mens.vl_contabil, 0) <> 0 and coalesce(vet_itens_mens.ie_tipo_item, 1) not in (18, 42)) then
			CALL ctb_concil_financeira_pck.ctb_gravar_documento(	cd_estabelecimento_p,
									dt_movimento_w,
									50,
									null,
									nr_seq_info_ctb_w,
									vet_itens_mens.nr_documento,
									vet_itens_mens.nr_seq_doc_compl,
									vet_itens_mens.nr_doc_analitico,
									vl_contabil_w,
									vet_itens_mens.nm_tabela,
									nm_atributo_w,
									nm_usuario_p);
		end if;

		if (coalesce(vet_itens_mens.vl_antecipacao, 0) <> 0 and coalesce(vet_itens_mens.qt_regra_pro_rata, 0) = 1) then
			CALL ctb_concil_financeira_pck.ctb_gravar_documento(	cd_estabelecimento_p,
									dt_movimento_w,
									50,
									null,
									56,
									vet_itens_mens.nr_documento,
									vet_itens_mens.nr_seq_doc_compl,
									vet_itens_mens.nr_doc_analitico,
									vet_itens_mens.vl_antecipacao,
									vet_itens_mens.nm_tabela,
									'VL_ANTECIPACAO',
									nm_usuario_p);
		end if;
		end;
	end loop;
	close c_itens_mens;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_ctb_onl_gravar_movto_pck.gravar_movto_lote_mens_defin ( nr_seq_lote_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;
