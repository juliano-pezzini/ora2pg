-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_ctb_onl_gravar_movto_pck.gravar_movto_gerar_nf_mens ( nr_seq_lote_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE

						
	dt_movimento_w 		timestamp;
	vl_contabil_w		pls_mensalidade_seg_item.vl_item%type;
	ie_contab_nf_mens_w	pls_parametro_contabil.ie_contab_nf_mens%type;
	
	c_itens_mens CURSOR FOR
	SELECT	coalesce(a.vl_item,0) vl_contabil,
		pls_obter_data_contab_ppcng(d.ie_cancelamento,d.dt_cancelamento,b.dt_inicio_cobertura,f.dt_mesano_referencia,a.nr_seq_item_cancel) dt_inicio_cobertura,
		pls_obter_data_contab_ppcng(d.ie_cancelamento,d.dt_cancelamento,f.dt_geracao_nf,f.dt_mesano_referencia,a.nr_seq_item_cancel) dt_nota,
		56 nr_seq_info_ctb,
		f.nr_sequencia nr_documento,
		d.nr_sequencia nr_seq_doc_compl,
		a.nr_sequencia nr_doc_analitico,
		b.dt_mesano_referencia dt_mesano_referencia
	from	pls_mensalidade_seg_item	a,
		pls_mensalidade_segurado	b,
		pls_segurado			c,
		pls_mensalidade			d,
		pls_lote_mensalidade		f,
		pls_plano			g
	where	b.nr_sequencia	= a.nr_seq_mensalidade_seg
	and	c.nr_sequencia	= b.nr_seq_segurado
	and	d.nr_sequencia	= b.nr_seq_mensalidade
	and	g.nr_sequencia	= b.nr_seq_plano
	and	f.nr_sequencia	= d.nr_seq_lote
	and	coalesce(d.nr_seq_cancel_rec_mens::text, '') = ''
	and	a.ie_tipo_item not in ('3','6','20','43')
	and	f.nr_sequencia = nr_seq_lote_p;

	vet_itens_mens c_itens_mens%rowtype;

	c_tipo_movimento CURSOR FOR
	SELECT	'VL_NOTA' nm_atributo,
		'PLS_MENSALIDADE_SEG_ITEM' nm_tabela
	
	where	coalesce(vet_itens_mens.vl_contabil, 0) <> 0
	and	ie_contab_nf_mens_w in ('S', 'SR')
	
union all

	SELECT	'VL_NOTA_REV' nm_atributo,
		'PLS_MENSALIDADE_SEG_ITEM' nm_tabela
	
	where	coalesce(vet_itens_mens.vl_contabil, 0) <> 0
	and	ie_contab_nf_mens_w = 'SR';

	vet_tipo_movimento c_tipo_movimento%rowtype;
	
BEGIN

	select	coalesce(ie_contab_nf_mens,'N')
	into STRICT	ie_contab_nf_mens_w
	from	pls_parametro_contabil
	where	cd_estabelecimento	= cd_estabelecimento_p;

	open c_itens_mens;
	loop
	fetch c_itens_mens into
		vet_itens_mens;
	EXIT WHEN NOT FOUND; /* apply on c_itens_mens */
		begin
		open c_tipo_movimento;
		loop
		fetch c_tipo_movimento into
			vet_tipo_movimento;
		EXIT WHEN NOT FOUND; /* apply on c_tipo_movimento */
			begin

			if (vet_tipo_movimento.nm_atributo = 'VL_NOTA') then
				vl_contabil_w 	:= vet_itens_mens.vl_contabil;
				dt_movimento_w 	:= vet_itens_mens.dt_nota;
			elsif (vet_tipo_movimento.nm_atributo = 'VL_NOTA_REV') then
				vl_contabil_w 	:= vet_itens_mens.vl_contabil;
				dt_movimento_w 	:= vet_itens_mens.dt_inicio_cobertura;
			end if;

			if (trunc(vet_itens_mens.dt_mesano_referencia,'month') < trunc(clock_timestamp(),'month')) then
				dt_movimento_w := trunc(clock_timestamp(),'month');
			end if;

			if (coalesce(dt_movimento_w::text, '') = '') then
				begin
				dt_movimento_w := trunc(clock_timestamp(), 'month');
				end;
			end if;

			if (coalesce(vl_contabil_w, 0) <> 0) then
				CALL ctb_concil_financeira_pck.ctb_gravar_documento(	cd_estabelecimento_p,
										dt_movimento_w,
										49,
										null,
										vet_itens_mens.nr_seq_info_ctb,
										vet_itens_mens.nr_documento,
										vet_itens_mens.nr_seq_doc_compl,
										vet_itens_mens.nr_doc_analitico,
										vl_contabil_w,
										vet_tipo_movimento.nm_tabela,
										vet_tipo_movimento.nm_atributo,
										nm_usuario_p);
			end if;
			end;
		end loop;
		close c_tipo_movimento;
		end;
	end loop;
	close c_itens_mens;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_ctb_onl_gravar_movto_pck.gravar_movto_gerar_nf_mens ( nr_seq_lote_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;
