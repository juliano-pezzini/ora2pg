-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE tws_notificacao_hpms_pck.tws_notif_atualizar_cadastro ( ie_aplicacao_p pls_notificacao_hist_tws.ie_aplicacao%type, nr_seq_segurado_p pls_segurado.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE

					
qt_notificacao_w 	integer := 0;
nr_seq_regra_w		bigint;
ds_titulo_w		varchar(40);
ds_texto_w		varchar(255);



BEGIN

select  count(1)
into STRICT	qt_notificacao_w
from    pls_notificacao_tws a
where   a.ie_aplicacao = 2
and     a.dt_notificacao >= to_date(clock_timestamp() - interval '30 days')
and (a.nr_seq_segurado = nr_seq_segurado_p or  coalesce(a.nr_seq_segurado::text, '') = '')
and	a.ie_tipo_processo = 'AC';

if ( qt_notificacao_w = 0 ) then

	nr_seq_regra_w := pls_obter_atualizacao_cad_web(nr_seq_segurado_p);
	
	if ( (nr_seq_regra_w IS NOT NULL AND nr_seq_regra_w::text <> '') and nr_seq_regra_w > 0) then
	
		ds_titulo_w := wsuite_util_pck.get_wsuite_expression(873909, cd_estabelecimento_p);
		ds_texto_w  := wsuite_util_pck.get_wsuite_expression(964117, cd_estabelecimento_p);
	
		CALL tws_notificacao_hpms_pck.tws_gerar_notificacao_web( 'AC', ie_aplicacao_p, ds_titulo_w,ds_texto_w, null, null, nr_seq_segurado_p, null, nm_usuario_p);		
		commit;
	end if;
end if;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE tws_notificacao_hpms_pck.tws_notif_atualizar_cadastro ( ie_aplicacao_p pls_notificacao_hist_tws.ie_aplicacao%type, nr_seq_segurado_p pls_segurado.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;
