-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_consistir_diops_pck.pls_consist_interc_event ( nr_seq_periodo_p bigint, cd_estabelecimento_p bigint) AS $body$
DECLARE


	cd_conta_contabil_w			conta_contabil.cd_conta_contabil%type;	
	ds_conta_w				diops_fin_mov_ativo.ds_conta%type;	
	ds_acao_usuario_w			diops_periodo_inconsist.ds_acao_usuario%type;	
	nm_operadora_macro_w			varchar(255);
	vl_saldo_w				diops_fin_interc_eventual.vl_saldo%type;
	vl_idade_saldos_w			ctb_saldo.vl_saldo%type;
	vl_saldo_final_eventual_w		ctb_saldo.vl_saldo%type;		
	vl_saldo_intercambio_w			ctb_saldo.vl_saldo%type;
	
	c_contas CURSOR FOR
		SELECT	coalesce(sum(i.vl_saldo),0) vl_saldo,
			c.cd_conta_contabil,
			i.cd_ans
		from	diops_fin_interc_eventual	i,
			diops_conta_intercambio		c
		where	i.cd_ans		= c.cd_ans
		and	i.ie_intercambio 	= c.ie_intercambio
		and	i.nr_seq_periodo	= nr_seq_periodo_p
		and	c.nr_seq_transacao	= current_setting('pls_consistir_diops_pck.nr_seq_transacao_w')::diops_transacao.nr_sequencia%type
		group by c.cd_conta_contabil,
			i.cd_ans;

	c_contas_w	 c_contas%rowtype;
	
	
BEGIN
	
	delete	
	from 	diops_periodo_inconsist a
	where	a.nr_seq_periodo	= nr_seq_periodo_p
	and	a.nr_seq_inconsistencia	in (67,68,69,71);
	
	commit;
	
	PERFORM set_config('pls_consistir_diops_pck.nr_quadro_w', 32, false);
	PERFORM set_config('pls_consistir_diops_pck.ds_quadro_macro_w', wheb_mensagem_pck.get_texto(934360), false);
	
	select 	coalesce(sum(a.vl_saldo),0)
	into STRICT	vl_saldo_intercambio_w
	from	diops_fin_interc_eventual a
	where	a.ie_intercambio in ('R','F')
	and	a.nr_seq_periodo = nr_seq_periodo_p;

	select	coalesce(sum(a.vl_saldo_final),0)
	into STRICT	vl_saldo_final_eventual_w
	from	diops_fin_mov_ativo a
	where	a.ds_conta in ('124119022','124129022', '124119021', '124129021')
	and	a.nr_seq_periodo = nr_seq_periodo_p;

	if (vl_saldo_intercambio_w <> vl_saldo_final_eventual_w) then
		CALL pls_consistir_diops_pck.pls_gravar_consistencia(nr_seq_periodo_p, cd_estabelecimento_p, 67);
	end if;

	select 	coalesce(sum(a.vl_saldo),0)
	into STRICT	vl_saldo_intercambio_w
	from	diops_fin_interc_eventual a
	where	a.ie_intercambio = 'P'
	and	a.nr_seq_periodo = nr_seq_periodo_p;

	select	coalesce(sum(a.vl_saldo_final),0)
	into STRICT	vl_saldo_final_eventual_w
	from	diops_fin_mov_passivo a
	where	a.ds_conta in ('211119033','211129033')
	and	a.nr_seq_periodo = nr_seq_periodo_p;
	
	if (vl_saldo_intercambio_w <> vl_saldo_final_eventual_w) then
		CALL pls_consistir_diops_pck.pls_gravar_consistencia(nr_seq_periodo_p, cd_estabelecimento_p, 68);
	end if;
	
	open c_contas;
	loop
	fetch c_contas into
		c_contas_w;
	EXIT WHEN NOT FOUND; /* apply on c_contas */
		begin
		
		select	coalesce(sum(v.vl_saldo),0)
		into STRICT	vl_saldo_w
		from	ctb_balancete_v	v,
			ctb_mes_ref	r
		where	v.nr_seq_mes_ref	= r.nr_sequencia
		and	v.cd_conta_contabil	= c_contas_w.cd_conta_contabil
		and	trunc(r.dt_referencia,'month') = trunc(current_setting('pls_consistir_diops_pck.dt_periodo_final_w')::diops_periodo.dt_periodo_final%type,'month')
		and	v.ie_normal_encerramento = 'N';	
		
		if (c_contas_w.vl_saldo <> vl_saldo_w) then
			PERFORM set_config('pls_consistir_diops_pck.cd_conta_macro_w', c_contas_w.cd_conta_contabil, false);
			PERFORM set_config('pls_consistir_diops_pck.ds_operadora_macro_w', substr(diops_obter_dados_pj(c_contas_w.cd_ans,'N'),1,255), false);
			CALL pls_consistir_diops_pck.pls_gravar_consistencia(nr_seq_periodo_p, cd_estabelecimento_p, 69);
		end if;
		
		select sum(CASE WHEN  a.ie_idade_saldo_ativo=1 THEN a.vl_individual WHEN  a.ie_idade_saldo_ativo=2 THEN a.vl_coletivo_pre WHEN  a.ie_idade_saldo_ativo=3 THEN a.vl_coletivo_pos WHEN  a.ie_idade_saldo_ativo=4 THEN a.vl_taxa_adm WHEN  a.ie_idade_saldo_ativo=5 THEN a.vl_credito_operadoras WHEN  a.ie_idade_saldo_ativo=6 THEN a.vl_outros_creditos WHEN  a.ie_idade_saldo_ativo=7 THEN a.vl_individual_pos WHEN  a.ie_idade_saldo_ativo=8 THEN a.vl_conv_receber WHEN  a.ie_idade_saldo_ativo=9 THEN a.vl_part_benefes WHEN  a.ie_idade_saldo_ativo=10 THEN a.vl_outros_creditos_sem_plano END ) vl_diops
		into STRICT	vl_idade_saldos_w
		from  	w_diops_fin_idadesaldo_ati a
		where	nr_seq_transacao = current_setting('pls_consistir_diops_pck.nr_seq_transacao_w')::diops_transacao.nr_sequencia%type
		and	nr_seq_periodo	 = nr_seq_periodo_p
		and	cd_conta_contabil = c_contas_w.cd_conta_contabil;
		
		if (c_contas_w.vl_saldo <> vl_idade_saldos_w) then
			PERFORM set_config('pls_consistir_diops_pck.cd_conta_macro_w', c_contas_w.cd_conta_contabil, false);
			PERFORM set_config('pls_consistir_diops_pck.ds_operadora_macro_w', substr(diops_obter_dados_pj(c_contas_w.cd_ans,'N'),1,255), false);			
			CALL pls_consistir_diops_pck.pls_gravar_consistencia(nr_seq_periodo_p, cd_estabelecimento_p, 71);
		end if;
		
		end;
	end loop;
	close c_contas;

	PERFORM set_config('pls_consistir_diops_pck.nr_quadro_w', 0, false);
	
	commit;
	
	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_consistir_diops_pck.pls_consist_interc_event ( nr_seq_periodo_p bigint, cd_estabelecimento_p bigint) FROM PUBLIC;
