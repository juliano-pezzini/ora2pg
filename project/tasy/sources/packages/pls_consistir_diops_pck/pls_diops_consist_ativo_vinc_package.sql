-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_consistir_diops_pck.pls_diops_consist_ativo_vinc ( nr_seq_periodo_p bigint, cd_estabelecimento_p bigint) AS $body$
DECLARE

	c_ativo_imob CURSOR FOR
		SELECT	nr_rgi
		from	w_diops_fin_ativo_imob
		where	nr_seq_periodo = nr_seq_periodo_p;
	
	vet_ativo_imob_w			c_ativo_imob%rowtype;
	
	c_ativo_invest CURSOR FOR
		SELECT	qt_investimento,
			pls_consistir_diops_pck.pls_diops_obter_se_carac_esp(ds_emissor) ie_consiste_carac_esp
		from	w_diops_fin_ativo_invest
		where	nr_seq_periodo = nr_seq_periodo_p
		and 1 = 2;
	
	vet_ativo_invest_w		c_ativo_invest%rowtype;
	vl_ativo_imob_w			w_diops_fin_ativo_imob.vl_contabil%type;
	vl_contabil_w			w_diops_fin_ativo_invest.vl_contabil%type;
	vl_saldo_ativo_w		diops_fin_mov_ativo.vl_saldo_final%type;
	vl_saldo_fin_mov_ativo_w	diops_fin_mov_ativo.vl_saldo_final%type;
	
	
BEGIN
	
	delete	
	from 	diops_periodo_inconsist a
	where	a.nr_seq_periodo	= nr_seq_periodo_p
	and	a.nr_seq_inconsistencia	in (47,48,65,66);
	
	commit;
	
	PERFORM set_config('pls_consistir_diops_pck.nr_quadro_w', 18, false);
	PERFORM set_config('pls_consistir_diops_pck.ds_quadro_macro_w', wheb_mensagem_pck.get_texto(918166), false);
	
	open c_ativo_imob;
	loop
	fetch c_ativo_imob into	
		vet_ativo_imob_w;
	EXIT WHEN NOT FOUND; /* apply on c_ativo_imob */
		begin
			
		if (coalesce(vet_ativo_imob_w.nr_rgi::text, '') = '') then
			PERFORM set_config('pls_consistir_diops_pck.ds_campo_macro_w', wheb_mensagem_pck.get_texto(918165), false);
			CALL pls_consistir_diops_pck.pls_gravar_consistencia(nr_seq_periodo_p, cd_estabelecimento_p, 47);
		end if;
		
		end;
	end loop;
	close c_ativo_imob;
	
	open c_ativo_invest;
	loop
	fetch c_ativo_invest into	
		vet_ativo_invest_w;
	EXIT WHEN NOT FOUND; /* apply on c_ativo_invest */
		begin
		
		if (coalesce(vet_ativo_invest_w.qt_investimento::text, '') = '') then
			PERFORM set_config('pls_consistir_diops_pck.ds_campo_macro_w', wheb_mensagem_pck.get_texto(918160), false);
			CALL pls_consistir_diops_pck.pls_gravar_consistencia(nr_seq_periodo_p, cd_estabelecimento_p, 47);
		end if;
		
		if (vet_ativo_invest_w.ie_consiste_carac_esp = 'S') then
			PERFORM set_config('pls_consistir_diops_pck.ds_campo_macro_w', wheb_mensagem_pck.get_texto(918161), false);
			CALL pls_consistir_diops_pck.pls_gravar_consistencia(nr_seq_periodo_p, cd_estabelecimento_p, 48);
		end if;
		
		end;
	end loop;
	close c_ativo_invest;

	select 	coalesce(sum(w.vl_contabil),0)
	into STRICT	vl_contabil_w
	from	w_diops_fin_ativo_invest w
	where	w.nr_seq_periodo = nr_seq_periodo_p;
	
	select 	coalesce(sum(vl_contabil),0)
	into STRICT	vl_ativo_imob_w
	from 	w_diops_fin_ativo_imob
	where	(vl_contabil IS NOT NULL AND vl_contabil::text <> '')
	and	nr_seq_periodo = nr_seq_periodo_p;
	
	if (vl_ativo_imob_w <> 0) then
		select 	coalesce(max(vl_saldo_final),0)
		into STRICT	vl_saldo_fin_mov_ativo_w
		from 	diops_fin_mov_ativo
		where   ds_conta =  '1331'
		and	nr_seq_periodo = nr_seq_periodo_p;
	
		if (vl_saldo_fin_mov_ativo_w = 0) then
			-- Requirement 9.2
			CALL pls_consistir_diops_pck.pls_gravar_consistencia(nr_seq_periodo_p, cd_estabelecimento_p, 66);
		end if;
	end if;

	PERFORM set_config('pls_consistir_diops_pck.nr_quadro_w', 0, false);
	
	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_consistir_diops_pck.pls_diops_consist_ativo_vinc ( nr_seq_periodo_p bigint, cd_estabelecimento_p bigint) FROM PUBLIC;
