-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_consistir_diops_pck.pls_diops_consist_contratos ( nr_seq_periodo_p bigint, cd_estabelecimento_p bigint) AS $body$
DECLARE

	
	dt_primeiro_mes_w			diops_periodo.dt_periodo_inicial%type;
	dt_terceiro_mes_w			diops_periodo.dt_periodo_inicial%type;
	vl_emit_col_adesao_w			diops_movto_agrup_contrat.vl_movimento%type;
	vl_emit_col_empres_w			diops_movto_agrup_contrat.vl_movimento%type;
	vl_contr_col_adesao_w			diops_movto_agrup_contrat.vl_movimento%type;
	vl_contr_col_empres_w			diops_movto_agrup_contrat.vl_movimento%type;
	
	/*	'1' - Contrapr emitida CA
		'2' - Contrapr emitida CE
		'3' - Eventos avisados CA
		'4' -  Eventos avisados CE */
		
	c_contas_contabeis CURSOR FOR
		SELECT	'1' ie_tipo_valor,
			coalesce(sum(vl_movimento),0) vl_movimento
		from	ctb_balancete_v
		where	trunc(dt_referencia,'month')	between dt_primeiro_mes_w and dt_terceiro_mes_w
		and	cd_classif_sem_ponto		in ('31111103','31111104','31111203','31111204')
		and	ie_normal_encerramento = 'N'
		
union all

		SELECT	'2' ie_tipo_valor,
			coalesce(sum(vl_movimento),0) vl_movimento
		from	ctb_balancete_v
		where	trunc(dt_referencia,'month')	between dt_primeiro_mes_w and dt_terceiro_mes_w
		and	cd_classif_sem_ponto		in ('31111105','31111106','31111205','31111206')
		and	ie_normal_encerramento = 'N'
		
union all

		select	'3' ie_tipo_valor,
			coalesce(sum(vl_movimento),0) vl_movimento
		from	ctb_balancete_v
		where	trunc(dt_referencia,'month')	between dt_primeiro_mes_w and dt_terceiro_mes_w
		and	cd_classif_sem_ponto		in ('41111103','41111104','41111203','41111204')
		and	ie_normal_encerramento = 'N'
		
union all

		select	'4' ie_tipo_valor,
			coalesce(sum(vl_movimento),0) vl_movimento
		from	ctb_balancete_v
		where	trunc(dt_referencia,'month')	between dt_primeiro_mes_w and dt_terceiro_mes_w
		and	cd_classif_sem_ponto		in ('41111105','41111106','41111205','41111206')
		and	ie_normal_encerramento = 'N';
	
	vet_contas_contabeis		c_contas_contabeis%rowtype;
	
	
BEGIN
	
	delete	
	from 	diops_periodo_inconsist a
	where	a.nr_seq_periodo	= nr_seq_periodo_p
	and	a.nr_seq_inconsistencia	= 76;
	
	commit;
	
	PERFORM set_config('pls_consistir_diops_pck.nr_quadro_w', 36, false);
	
	select	a.dt_periodo_inicial,
		a.dt_periodo_final
	into STRICT	dt_primeiro_mes_w,
		dt_terceiro_mes_w
	from	diops_periodo		a
	where	a.nr_sequencia		= nr_seq_periodo_p;
	
	open c_contas_contabeis;	
	loop
	fetch c_contas_contabeis into	
		vet_contas_contabeis;
	EXIT WHEN NOT FOUND; /* apply on c_contas_contabeis */
		begin
		
		select	coalesce(sum(CASE WHEN cd_tipo_contratacao=1 THEN CASE WHEN ie_mensalidade_conta='M' THEN vl_movimento  ELSE 0 END   ELSE 0 END ),0) vl_contr_col_adesao,
			coalesce(sum(CASE WHEN cd_tipo_contratacao=2 THEN CASE WHEN ie_mensalidade_conta='M' THEN vl_movimento  ELSE 0 END   ELSE 0 END ),0) vl_contr_col_empres,
			coalesce(sum(CASE WHEN cd_tipo_contratacao=1 THEN CASE WHEN ie_mensalidade_conta='C' THEN vl_movimento  ELSE 0 END   ELSE 0 END ),0) vl_emit_col_adesao,
			coalesce(sum(CASE WHEN cd_tipo_contratacao=2 THEN CASE WHEN ie_mensalidade_conta='C' THEN vl_movimento  ELSE 0 END   ELSE 0 END ),0) vl_emit_col_empres
		into STRICT	vl_contr_col_adesao_w,
			vl_contr_col_empres_w,
			vl_emit_col_adesao_w,
			vl_emit_col_empres_w
		from	diops_movto_agrup_contrat
		where	nr_seq_periodo	= nr_seq_periodo_p;
		
		if (vet_contas_contabeis.ie_tipo_valor = '1' and vl_contr_col_adesao_w <> vet_contas_contabeis.vl_movimento) then
			PERFORM set_config('pls_consistir_diops_pck.ds_item_w', 'Contrapr emitida CA', false);
			PERFORM set_config('pls_consistir_diops_pck.nr_contas_macro_w', '31111103, 31111104, 31111203 e 31111204', false);
			CALL pls_consistir_diops_pck.pls_gravar_consistencia(nr_seq_periodo_p, cd_estabelecimento_p, 76);
		end if;
		
		if (vet_contas_contabeis.ie_tipo_valor = '2' and vl_contr_col_empres_w <> vet_contas_contabeis.vl_movimento) then
			PERFORM set_config('pls_consistir_diops_pck.ds_item_w', 'Contrapr emitida CE', false);
			PERFORM set_config('pls_consistir_diops_pck.nr_contas_macro_w', '31111105, 31111106, 31111205 e 31111206', false);
			CALL pls_consistir_diops_pck.pls_gravar_consistencia(nr_seq_periodo_p, cd_estabelecimento_p, 76);
		end if;
		
		if (vet_contas_contabeis.ie_tipo_valor = '3' and vl_emit_col_adesao_w <> vet_contas_contabeis.vl_movimento) then
			PERFORM set_config('pls_consistir_diops_pck.ds_item_w', 'Eventos avisados CA', false);
			PERFORM set_config('pls_consistir_diops_pck.nr_contas_macro_w', '41111103, 41111104, 41111203 e 41111204', false);
			CALL pls_consistir_diops_pck.pls_gravar_consistencia(nr_seq_periodo_p, cd_estabelecimento_p, 76);
		end if;
		
		if (vet_contas_contabeis.ie_tipo_valor = '4' and vl_emit_col_empres_w <> vet_contas_contabeis.vl_movimento) then
			PERFORM set_config('pls_consistir_diops_pck.ds_item_w', 'Eventos avisados CE', false);
			PERFORM set_config('pls_consistir_diops_pck.nr_contas_macro_w', '41111105, 41111106, 41111205 e 41111206', false);
			CALL pls_consistir_diops_pck.pls_gravar_consistencia(nr_seq_periodo_p, cd_estabelecimento_p, 76);
		end if;
		end;
	end loop;
	close c_contas_contabeis;

	PERFORM set_config('pls_consistir_diops_pck.nr_quadro_w', 0, false);
	
	commit;
	
	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_consistir_diops_pck.pls_diops_consist_contratos ( nr_seq_periodo_p bigint, cd_estabelecimento_p bigint) FROM PUBLIC;
