-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_consistir_diops_pck.pls_diops_consist_corresp_cedi ( nr_seq_periodo_p bigint, cd_estabelecimento_p bigint) AS $body$
DECLARE

	dt_primeiro_mes_w		diops_periodo.dt_periodo_inicial%type;
	dt_segundo_mes_w		diops_periodo.dt_periodo_inicial%type;
	dt_terceiro_mes_w		diops_periodo.dt_periodo_inicial%type;
	vl_mes_n_w			diops_movto_corresp_cedida.vl_mes_n%type;
	vl_mes_n1_w			diops_movto_corresp_cedida.vl_mes_n%type;
	vl_mes_n2_w			diops_movto_corresp_cedida.vl_mes_n%type;

	c_corresp_cedida_pos CURSOR FOR
		SELECT 	1 ie_tipo_conta,
			coalesce(sum(vl_movimento),0) vl_movimento
		from 	ctb_balancete_v
		where	trunc(dt_referencia, 'month') 	= 	dt_primeiro_mes_w
		and	substr(cd_classif_sem_ponto,0,6) 	in ('311711', '311721')
		and	substr(cd_classif_sem_ponto,8,2)	in ('13','23','33','43','53','63')
		and	ie_normal_encerramento = 'N'
		
union all

		SELECT 	2 ie_tipo_conta,
			coalesce(sum(vl_movimento),0) vl_movimento
		from 	ctb_balancete_v
		where	trunc(dt_referencia, 'month') 	= 	dt_segundo_mes_w
		and	substr(cd_classif_sem_ponto,0,6) 	in ('311711', '311721')
		and	substr(cd_classif_sem_ponto,8,2)	in ('13','23','33','43','53','63')
		and	ie_normal_encerramento = 'N'
		
union all

		select 	3 ie_tipo_conta,
			coalesce(sum(vl_movimento),0) vl_movimento
		from 	ctb_balancete_v
		where	trunc(dt_referencia, 'month') 	= 	dt_terceiro_mes_w
		and	substr(cd_classif_sem_ponto,0,6) 	in ('311711', '311721')
		and	substr(cd_classif_sem_ponto,8,2)	in ('13','23','33','43','53','63')
		and	ie_normal_encerramento = 'N';

	vet_corresp_cedida_pos		c_corresp_cedida_pos%rowtype;

	c_baixa_glosa_reconhecida CURSOR FOR
		SELECT 	1 ie_tipo_conta,
			coalesce(sum(vl_movimento),0) vl_movimento
		from	ctb_balancete_v
		where	trunc(dt_referencia, 'month')	=	dt_primeiro_mes_w
		and	substr(cd_classif_sem_ponto,0,6)	in ('311711', '311721')
		and	substr(cd_classif_sem_ponto,8,2) 	in ('15','25','35','45','55','65')
		and	ie_normal_encerramento = 'N'
		
union all

		SELECT 	2 ie_tipo_conta,
			coalesce(sum(vl_movimento),0) vl_movimento
		from	ctb_balancete_v
		where	trunc(dt_referencia, 'month')	=	dt_segundo_mes_w
		and	substr(cd_classif_sem_ponto,0,6)	in ('311711', '311721')
		and	substr(cd_classif_sem_ponto,8,2) 	in ('15','25','35','45','55','65')
		and	ie_normal_encerramento = 'N'
		
union all

		select 	3 ie_tipo_conta,
			coalesce(sum(vl_movimento),0) vl_movimento
		from	ctb_balancete_v
		where	trunc(dt_referencia, 'month')	=	dt_terceiro_mes_w
		and	substr(cd_classif_sem_ponto,0,6)	in ('311711', '311721')
		and	substr(cd_classif_sem_ponto,8,2) 	in ('15','25','35','45','55','65')
		and	ie_normal_encerramento = 'N';

	vet_baixa_glosa_reconhecida		c_baixa_glosa_reconhecida%rowtype;

	c_outras_recup_reconhecidas CURSOR FOR
		SELECT	1 ie_tipo_conta,
			coalesce(sum(vl_movimento),0) vl_movimento
		from	ctb_balancete_v
		where	trunc(dt_referencia, 'month')	=	dt_primeiro_mes_w
		and	substr(cd_classif_sem_ponto,0,6)	in ('311711', '311721')
		and	substr(cd_classif_sem_ponto,8,2)	in ('14','24','34','44','54','64')
		and	ie_normal_encerramento = 'N'
		
union all

		SELECT	2 ie_tipo_conta,
			coalesce(sum(vl_movimento),0) vl_movimento
		from	ctb_balancete_v
		where	trunc(dt_referencia, 'month')	=	dt_segundo_mes_w
		and	substr(cd_classif_sem_ponto,0,6)	in ('311711', '311721')
		and	substr(cd_classif_sem_ponto,8,2)	in ('14','24','34','44','54','64')
		and	ie_normal_encerramento = 'N'
		
union all

		select	3 ie_tipo_conta,
			coalesce(sum(vl_movimento),0) vl_movimento
		from	ctb_balancete_v
		where	trunc(dt_referencia, 'month')	=	dt_terceiro_mes_w
		and	substr(cd_classif_sem_ponto,0,6)	in ('311711', '311721')
		and	substr(cd_classif_sem_ponto,8,2)	in ('14','24','34','44','54','64')
		and	ie_normal_encerramento = 'N';

	vet_outras_recup_reconhecidas		c_outras_recup_reconhecidas%rowtype;


	
BEGIN

		delete	
		from 	diops_periodo_inconsist a
		where	a.nr_seq_periodo	= nr_seq_periodo_p
		and	a.nr_seq_inconsistencia	= 105;

		commit;

		select	max(trunc(a.dt_periodo_inicial,'month')),
			max(add_months(trunc(a.dt_periodo_inicial,'month'),1)),
			max(add_months(trunc(a.dt_periodo_inicial,'month'),2)),
			max(b.vl_mes_n2),
			max(b.vl_mes_n1),
			max(b.vl_mes_n)
		into STRICT	dt_primeiro_mes_w,
			dt_segundo_mes_w,
			dt_terceiro_mes_w,
			vl_mes_n2_w,
			vl_mes_n1_w,
			vl_mes_n_w
		from	diops_periodo			a,
			diops_movto_corresp_cedida 	b
		where	a.nr_sequencia		= nr_seq_periodo_p
		and	b.nr_seq_periodo 	= a.nr_sequencia;

		open c_corresp_cedida_pos;
			loop
			fetch c_corresp_cedida_pos into	
				vet_corresp_cedida_pos;
			EXIT WHEN NOT FOUND; /* apply on c_corresp_cedida_pos */
				begin
				PERFORM set_config('pls_consistir_diops_pck.ds_item_w', wheb_mensagem_pck.get_texto('1059387'), false);
				PERFORM set_config('pls_consistir_diops_pck.nr_contas_macro_w', '311711013, 311711023, 311711033, 311711043, 311711053, 311711063, 311721013, 311721023, 311721033, 311721043, 311721053 e 311721063', false);
			
				if (vet_corresp_cedida_pos.ie_tipo_conta = 1 and vl_mes_n2_w <> vet_corresp_cedida_pos.vl_movimento) then
					PERFORM set_config('pls_consistir_diops_pck.ds_periodo_w', to_char(dt_primeiro_mes_w,'mm/yyyy'), false);
					CALL pls_consistir_diops_pck.pls_gravar_consistencia(nr_seq_periodo_p, cd_estabelecimento_p, 105);
				end if;
				
				if (vet_corresp_cedida_pos.ie_tipo_conta = 2 and vl_mes_n1_w <> vet_corresp_cedida_pos.vl_movimento) then
					PERFORM set_config('pls_consistir_diops_pck.ds_periodo_w', to_char(dt_segundo_mes_w,'mm/yyyy'), false);
					CALL pls_consistir_diops_pck.pls_gravar_consistencia(nr_seq_periodo_p, cd_estabelecimento_p, 105);
				end if;
				
				if (vet_corresp_cedida_pos.ie_tipo_conta = 3 and vl_mes_n_w <> vet_corresp_cedida_pos.vl_movimento) then
					PERFORM set_config('pls_consistir_diops_pck.ds_periodo_w', to_char(dt_terceiro_mes_w,'mm/yyyy'), false);
					CALL pls_consistir_diops_pck.pls_gravar_consistencia(nr_seq_periodo_p, cd_estabelecimento_p, 105);
				end if;
				
				end;
			end loop;
		close c_corresp_cedida_pos;

		open c_baixa_glosa_reconhecida;
			loop
			fetch c_baixa_glosa_reconhecida into	
				vet_baixa_glosa_reconhecida;
			EXIT WHEN NOT FOUND; /* apply on c_baixa_glosa_reconhecida */
				begin
									
				PERFORM set_config('pls_consistir_diops_pck.ds_item_w', wheb_mensagem_pck.get_texto('1059388'), false);
				PERFORM set_config('pls_consistir_diops_pck.nr_contas_macro_w', '311711015, 311711025, 311711035, 311711045, 311711055, 311711065, 311721015, 311721025, 311721035, 311721045, 311721055 e 311721065', false);
			
				if (vet_baixa_glosa_reconhecida.ie_tipo_conta = 1 and vl_mes_n2_w <> vet_baixa_glosa_reconhecida.vl_movimento) then
					PERFORM set_config('pls_consistir_diops_pck.ds_periodo_w', to_char(dt_primeiro_mes_w,'mm/yyyy'), false);
					CALL pls_consistir_diops_pck.pls_gravar_consistencia(nr_seq_periodo_p, cd_estabelecimento_p, 105);
				end if;
				
				if (vet_baixa_glosa_reconhecida.ie_tipo_conta = 2 and vl_mes_n1_w <> vet_baixa_glosa_reconhecida.vl_movimento) then
					PERFORM set_config('pls_consistir_diops_pck.ds_periodo_w', to_char(dt_segundo_mes_w,'mm/yyyy'), false);
					CALL pls_consistir_diops_pck.pls_gravar_consistencia(nr_seq_periodo_p, cd_estabelecimento_p, 105);
				end if;
				
				if (vet_baixa_glosa_reconhecida.ie_tipo_conta = 3 and vl_mes_n_w <> vet_baixa_glosa_reconhecida.vl_movimento) then
					PERFORM set_config('pls_consistir_diops_pck.ds_periodo_w', to_char(dt_terceiro_mes_w,'mm/yyyy'), false);
					CALL pls_consistir_diops_pck.pls_gravar_consistencia(nr_seq_periodo_p, cd_estabelecimento_p, 105);
				end if;
				
				end;
			end loop;
		close c_baixa_glosa_reconhecida;

		open c_outras_recup_reconhecidas;
			loop
			fetch c_outras_recup_reconhecidas into	
				vet_outras_recup_reconhecidas;
			EXIT WHEN NOT FOUND; /* apply on c_outras_recup_reconhecidas */
				begin
				
				PERFORM set_config('pls_consistir_diops_pck.ds_item_w', wheb_mensagem_pck.get_texto('1059389'), false);
				PERFORM set_config('pls_consistir_diops_pck.nr_contas_macro_w', '311711015, 311711025, 311711035, 311711045, 311711055, 311711065, 311721015, 311721025, 311721035, 311721045, 311721055 e 311721065', false);
			
				if (vet_outras_recup_reconhecidas.ie_tipo_conta = 1 and vl_mes_n2_w <> vet_outras_recup_reconhecidas.vl_movimento) then
					PERFORM set_config('pls_consistir_diops_pck.ds_periodo_w', to_char(dt_primeiro_mes_w,'mm/yyyy'), false);
					CALL pls_consistir_diops_pck.pls_gravar_consistencia(nr_seq_periodo_p, cd_estabelecimento_p, 105);
				end if;
				
				if (vet_outras_recup_reconhecidas.ie_tipo_conta = 2 and vl_mes_n1_w <> vet_outras_recup_reconhecidas.vl_movimento) then
					PERFORM set_config('pls_consistir_diops_pck.ds_periodo_w', to_char(dt_segundo_mes_w,'mm/yyyy'), false);
					CALL pls_consistir_diops_pck.pls_gravar_consistencia(nr_seq_periodo_p, cd_estabelecimento_p, 105);
				end if;
				
				if (vet_outras_recup_reconhecidas.ie_tipo_conta = 3 and vl_mes_n_w <> vet_outras_recup_reconhecidas.vl_movimento) then
					PERFORM set_config('pls_consistir_diops_pck.ds_periodo_w', to_char(dt_terceiro_mes_w,'mm/yyyy'), false);
					CALL pls_consistir_diops_pck.pls_gravar_consistencia(nr_seq_periodo_p, cd_estabelecimento_p, 105);
				end if;
				
				end;
			end loop;
		close c_outras_recup_reconhecidas;

	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_consistir_diops_pck.pls_diops_consist_corresp_cedi ( nr_seq_periodo_p bigint, cd_estabelecimento_p bigint) FROM PUBLIC;
