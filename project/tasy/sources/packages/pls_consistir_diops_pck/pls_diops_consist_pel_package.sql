-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_consistir_diops_pck.pls_diops_consist_pel ( nr_seq_periodo_p bigint, cd_estabelecimento_p bigint) AS $body$
DECLARE

	
	ie_tipo_movto_w				bigint;
	dt_primeiro_mes_w			diops_periodo.dt_periodo_inicial%type;
	dt_segundo_mes_w			diops_periodo.dt_periodo_inicial%type;
	dt_terceiro_mes_w			diops_periodo.dt_periodo_inicial%type;
	vl_mes_n2_w				diops_movto_pel.vl_mes_n%type;
	vl_mes_n1_w				diops_movto_pel.vl_mes_n%type;
	vl_mes_n_w				diops_movto_pel.vl_mes_n%type;
	
	ie_tipo_movimento CURSOR FOR
		SELECT 	8 ie_tipo_movto
		
		
union all

		SELECT	23 ie_tipo_movto
		
		
union all

		select 	42 ie_tipo_movto
		
		
union all

		select	57 ie_tipo_movto
		;
	
	c_contas_avisos CURSOR FOR
		SELECT	x.ie_tipo_conta ie_tipo_conta,
		       	coalesce(sum(x.vl_movimento), 0) vl_movimento
		from (SELECT	1 ie_tipo_conta,
				coalesce(sum(vl_movimento),0) vl_movimento
			from	ctb_balancete_v
			where	trunc(dt_referencia,'month')	= dt_primeiro_mes_w
			and	substr(cd_classif_sem_ponto,0,6) 	in ('411211','411221', '411311', '411321', '411511', '411521')
			and	substr(cd_classif_sem_ponto,8,2)	in ('11','21','31','41','51','61','81')
			and	current_setting('pls_consistir_diops_pck.ie_2019_ou_posterior_w')::varchar(2) 		= 'S'
			and	ie_normal_encerramento = 'N'
			
union all

			select	2 ie_tipo_conta,
				coalesce(sum(vl_movimento),0) vl_movimento
			from	ctb_balancete_v
			where	trunc(dt_referencia,'month')	= dt_segundo_mes_w
			and	substr(cd_classif_sem_ponto,0,6) 	in ('411211','411221', '411311', '411321', '411511', '411521')
			and	substr(cd_classif_sem_ponto,8,2)	in ('11','21','31','41','51','61','81')
			and	current_setting('pls_consistir_diops_pck.ie_2019_ou_posterior_w')::varchar(2)		= 'S'
			and	ie_normal_encerramento = 'N'
			
union all

			select	3 ie_tipo_conta,
				coalesce(sum(vl_movimento),0) vl_movimento
			from	ctb_balancete_v
			where	trunc(dt_referencia,'month')	= dt_terceiro_mes_w
			and	substr(cd_classif_sem_ponto,0,6) 	in ('411211','411221', '411311', '411321', '411511', '411521')
			and	substr(cd_classif_sem_ponto,8,2)	in ('11','21','31','41','51','61','81')
			and	current_setting('pls_consistir_diops_pck.ie_2019_ou_posterior_w')::varchar(2)		= 'S'
			and	ie_normal_encerramento = 'N'
			
union all

			select	1 ie_tipo_conta,
				coalesce(sum(vl_movimento),0) vl_movimento
			from	ctb_balancete_v
			where	trunc(dt_referencia,'month')	= dt_primeiro_mes_w
			and     substr(cd_classif_sem_ponto,0,6) 	in ('411721','411711')
			and	substr(cd_classif_sem_ponto,8,2)	in ('11','21','31','41','51','61','17','27','37','47','57','67')
			and	current_setting('pls_consistir_diops_pck.ie_2019_ou_posterior_w')::varchar(2)		= 'S'
			and	ie_normal_encerramento = 'N'
			
union all

			select	2 ie_tipo_conta,
				coalesce(sum(vl_movimento),0) vl_movimento
			from	ctb_balancete_v
			where	trunc(dt_referencia,'month')	= dt_segundo_mes_w
			and     substr(cd_classif_sem_ponto,0,6) 	in ('411721','411711')
			and	substr(cd_classif_sem_ponto,8,2)	in ('11','21','31','41','51','61','17','27','37','47','57','67')
			and	current_setting('pls_consistir_diops_pck.ie_2019_ou_posterior_w')::varchar(2)		= 'S'
			and	ie_normal_encerramento = 'N'
			
union all

			select	3 ie_tipo_conta,
				coalesce(sum(vl_movimento),0) vl_movimento
			from	ctb_balancete_v
			where	trunc(dt_referencia,'month')	= dt_terceiro_mes_w
			and     substr(cd_classif_sem_ponto,0,6) 	in ('411721','411711')
			and	substr(cd_classif_sem_ponto,8,2)	in ('11','21','31','41','51','61','17','27','37','47','57','67')
			and	current_setting('pls_consistir_diops_pck.ie_2019_ou_posterior_w')::varchar(2)		= 'S'
			and	ie_normal_encerramento = 'N'
			
union all

			select	1 ie_tipo_conta,
				coalesce(sum(vl_movimento),0) vl_movimento
			from	ctb_balancete_v
			where	trunc(dt_referencia,'month')	= dt_primeiro_mes_w
			and     substr(cd_classif_sem_ponto,0,6) 	in ('411111','411121', '411411', '411421', '411911', '411921')
			and	substr(cd_classif_sem_ponto,8,2)	in ('11','21','31','41','51','61','17','27','37','47','57','67','81')
			and	current_setting('pls_consistir_diops_pck.ie_2019_ou_posterior_w')::varchar(2)		= 'S'
			and	ie_normal_encerramento = 'N'
			
union all

			select	2 ie_tipo_conta,
				coalesce(sum(vl_movimento),0) vl_movimento
			from	ctb_balancete_v
			where	trunc(dt_referencia,'month')	= dt_segundo_mes_w
			and     substr(cd_classif_sem_ponto,0,6) 	in ('411111','411121', '411411', '411421', '411911', '411921')
			and	substr(cd_classif_sem_ponto,8,2)	in ('11','21','31','41','51','61','17','27','37','47','57','67','81')
			and	current_setting('pls_consistir_diops_pck.ie_2019_ou_posterior_w')::varchar(2)		= 'S'
			and	ie_normal_encerramento = 'N'
			
union all

			select	3 ie_tipo_conta,
				coalesce(sum(vl_movimento),0) vl_movimento
			from	ctb_balancete_v
			where	trunc(dt_referencia,'month')	= dt_terceiro_mes_w
			and     substr(cd_classif_sem_ponto,0,6) 	in ('411111','411121', '411411', '411421', '411911', '411921')
			and	substr(cd_classif_sem_ponto,8,2)	in ('11','21','31','41','51','61','17','27','37','47','57','67','81')
			and	current_setting('pls_consistir_diops_pck.ie_2019_ou_posterior_w')::varchar(2)		= 'S'
			and	ie_normal_encerramento = 'N'
			
union all

			select	1 ie_tipo_conta,
				coalesce(sum(vl_movimento),0) vl_movimento
			from	ctb_balancete_v
			where	trunc(dt_referencia,'month')	= dt_primeiro_mes_w
			and	substr(cd_classif_sem_ponto,0,6) 	in ('411111','411121')
			and	substr(cd_classif_sem_ponto,8,2)	in ('11','21','31','41','51','61','99')
			and	current_setting('pls_consistir_diops_pck.ie_2019_ou_posterior_w')::varchar(2)		= 'N'
			and	ie_normal_encerramento = 'N'
			
union all

			select	2 ie_tipo_conta,
				coalesce(sum(vl_movimento),0) vl_movimento
			from	ctb_balancete_v
			where	trunc(dt_referencia,'month')	= dt_segundo_mes_w
			and	substr(cd_classif_sem_ponto,0,6) 	in ('411111','411121')
			and	substr(cd_classif_sem_ponto,8,2)	in ('11','21','31','41','51','61','99')
			and	current_setting('pls_consistir_diops_pck.ie_2019_ou_posterior_w')::varchar(2)		= 'N'
			and	ie_normal_encerramento = 'N'
			
union all

			select	3 ie_tipo_conta,
				coalesce(sum(vl_movimento),0) vl_movimento
			from	ctb_balancete_v
			where	trunc(dt_referencia,'month')	= dt_terceiro_mes_w
			and	substr(cd_classif_sem_ponto,0,6) 	in ('411111','411121')
			and	substr(cd_classif_sem_ponto,8,2)	in ('11','21','31','41','51','61','99')
			and	current_setting('pls_consistir_diops_pck.ie_2019_ou_posterior_w')::varchar(2)		= 'N'
			and	ie_normal_encerramento = 'N') x
		group by x.ie_tipo_conta;
			
	vet_contas_avisos		c_contas_avisos%rowtype;
	
	c_contas_baixas CURSOR FOR
		SELECT 	x.ie_tipo_conta ie_tipo_conta,
			coalesce(sum(x.vl_movimento),0) vl_movimento
		from (	SELECT	1 ie_tipo_conta,
				coalesce(sum(vl_movimento),0) vl_movimento
			from	ctb_balancete_v
			where	trunc(dt_referencia,'month')	= dt_primeiro_mes_w
			and	substr(cd_classif_sem_ponto,0,6) 	in ('411111','411121','411211','411221','411311','411321','411411','411421','411511','411521','411911','411921')
			and	substr(cd_classif_sem_ponto,8,2)	in ('12','22','32','42','52','62','82')
			and	current_setting('pls_consistir_diops_pck.ie_2019_ou_posterior_w')::varchar(2) 		= 'S'
			and	ie_normal_encerramento = 'N'
			
union all

			select	2 ie_tipo_conta,
				coalesce(sum(vl_movimento),0) vl_movimento
			from	ctb_balancete_v
			where	trunc(dt_referencia,'month')	= dt_segundo_mes_w
			and	substr(cd_classif_sem_ponto,0,6) 	in ('411111','411121','411211','411221','411311','411321','411411','411421','411511','411521','411911','411921')
			and	substr(cd_classif_sem_ponto,8,2)	in ('12','22','32','42','52','62','82')
			and	current_setting('pls_consistir_diops_pck.ie_2019_ou_posterior_w')::varchar(2) 		= 'S'
			and	ie_normal_encerramento = 'N'
			
union all

			select	3 ie_tipo_conta,
				coalesce(sum(vl_movimento),0) vl_movimento
			from	ctb_balancete_v
			where	trunc(dt_referencia,'month')	= dt_terceiro_mes_w
			and	substr(cd_classif_sem_ponto,0,6) 	in ('411111','411121','411211','411221','411311','411321','411411','411421','411511','411521','411911','411921')
			and	substr(cd_classif_sem_ponto,8,2)	in ('12','22','32','42','52','62','82')
			and	current_setting('pls_consistir_diops_pck.ie_2019_ou_posterior_w')::varchar(2) 		= 'S'
			and	ie_normal_encerramento = 'N'
			
union all

			select	1 ie_tipo_conta,
				coalesce(sum(vl_movimento),0) vl_movimento
			from	ctb_balancete_v
			where	trunc(dt_referencia,'month')	= dt_primeiro_mes_w
			and	substr(cd_classif_sem_ponto,0,6) 	in ('411711','411721')
			and	substr(cd_classif_sem_ponto,8,2)	in ('12','22','32','42','52','62')
			and	current_setting('pls_consistir_diops_pck.ie_2019_ou_posterior_w')::varchar(2) 		= 'S'
			and	ie_normal_encerramento = 'N'
			
union all

			select	2 ie_tipo_conta,
				coalesce(sum(vl_movimento),0) vl_movimento
			from	ctb_balancete_v
			where	trunc(dt_referencia,'month')	= dt_segundo_mes_w
			and	substr(cd_classif_sem_ponto,0,6) 	in ('411711','411721')
			and	substr(cd_classif_sem_ponto,8,2)	in ('12','22','32','42','52','62')
			and	current_setting('pls_consistir_diops_pck.ie_2019_ou_posterior_w')::varchar(2) 		= 'S'
			and	ie_normal_encerramento = 'N'
			
union all

			select	3 ie_tipo_conta,
				coalesce(sum(vl_movimento),0) vl_movimento
			from	ctb_balancete_v
			where	trunc(dt_referencia,'month')	= dt_terceiro_mes_w
			and	substr(cd_classif_sem_ponto,0,6) 	in ('411711','411721')
			and	substr(cd_classif_sem_ponto,8,2)	in ('12','22','32','42','52','62')
			and	current_setting('pls_consistir_diops_pck.ie_2019_ou_posterior_w')::varchar(2) 		= 'S'
			and	ie_normal_encerramento = 'N'
			
union all

			select	1 ie_tipo_conta,
				coalesce(sum(vl_movimento),0) vl_movimento
				from	ctb_balancete_v
			where	trunc(dt_referencia,'month')	= dt_primeiro_mes_w
			and	substr(cd_classif_sem_ponto,0,6) 	in ('411111','411121')
			and	substr(cd_classif_sem_ponto,8,2)	in ('12','22','32','42','52','62')
			and	current_setting('pls_consistir_diops_pck.ie_2019_ou_posterior_w')::varchar(2) 		= 'N'
			and	ie_normal_encerramento = 'N'
			
union all

			select	2 ie_tipo_conta,
				coalesce(sum(vl_movimento),0) vl_movimento
			from	ctb_balancete_v
			where	trunc(dt_referencia,'month')	= dt_segundo_mes_w
			and	substr(cd_classif_sem_ponto,0,6) 	in ('411111','411121')
			and	substr(cd_classif_sem_ponto,8,2)	in ('12','22','32','42','52','62')
			and	current_setting('pls_consistir_diops_pck.ie_2019_ou_posterior_w')::varchar(2) 		= 'N'
			and	ie_normal_encerramento = 'N'
			
union all

			select	3 ie_tipo_conta,
				coalesce(sum(vl_movimento),0) vl_movimento
			from	ctb_balancete_v
			where	trunc(dt_referencia,'month')	= dt_terceiro_mes_w
			and	substr(cd_classif_sem_ponto,0,6) 	in ('411111','411121')
			and	substr(cd_classif_sem_ponto,8,2)	in ('12','22','32','42','52','62')
			and	current_setting('pls_consistir_diops_pck.ie_2019_ou_posterior_w')::varchar(2) 		= 'N'
			and	ie_normal_encerramento = 'N') x
		group by x.ie_tipo_conta;
	
	vet_contas_baixas		c_contas_baixas%rowtype;
	
	c_contas_outras CURSOR FOR
		SELECT	1 ie_tipo_conta,
			coalesce(sum(vl_movimento),0) vl_movimento
		from	ctb_balancete_v
		where	trunc(dt_referencia,'month')	= dt_primeiro_mes_w
		and	substr(cd_classif_sem_ponto,0,6) 	in ('411111','411121','411211','411221','411311','411321','411411','411421','411511','411521','411711','411721','411911','411921')
		and	substr(cd_classif_sem_ponto,8,2)	in ('13','23','33','43','53','63','19','29','39','49','59','69')
		and	current_setting('pls_consistir_diops_pck.ie_2019_ou_posterior_w')::varchar(2) 		= 'S'
		and	ie_normal_encerramento = 'N'
		
union all

		SELECT	2 ie_tipo_conta,
			coalesce(sum(vl_movimento),0) vl_movimento
		from	ctb_balancete_v
		where	trunc(dt_referencia,'month')	= dt_segundo_mes_w
		and	substr(cd_classif_sem_ponto,0,6) 	in ('411111','411121','411211','411221','411311','411321','411411','411421','411511','411521','411711','411721','411911','411921')
		and	substr(cd_classif_sem_ponto,8,2)	in ('13','23','33','43','53','63','19','29','39','49','59','69')
		and	current_setting('pls_consistir_diops_pck.ie_2019_ou_posterior_w')::varchar(2) 		= 'S'
		and	ie_normal_encerramento = 'N'
		
union all

		select	3 ie_tipo_conta,
			coalesce(sum(vl_movimento),0) vl_movimento
		from	ctb_balancete_v
		where	trunc(dt_referencia,'month')	= dt_terceiro_mes_w
		and	substr(cd_classif_sem_ponto,0,6) 	in ('411111','411121','411211','411221','411311','411321','411411','411421','411511','411521','411711','411721','411911','411921')
		and	substr(cd_classif_sem_ponto,8,2)	in ('13','23','33','43','53','63','19','29','39','49','59','69')
		and	current_setting('pls_consistir_diops_pck.ie_2019_ou_posterior_w')::varchar(2) 		= 'S'
		and	ie_normal_encerramento = 'N'
		
union all

		select	1 ie_tipo_conta,
			coalesce(sum(vl_movimento),0) vl_movimento
		from	ctb_balancete_v
		where	trunc(dt_referencia,'month')	= dt_primeiro_mes_w
		and	substr(cd_classif_sem_ponto,0,6) 	in ('411111','411121')
		and	substr(cd_classif_sem_ponto,8,2)	in ('13','19','23','29','33','39','43','49','53','59','63','69')
		and	current_setting('pls_consistir_diops_pck.ie_2019_ou_posterior_w')::varchar(2) 		= 'N'
		and	ie_normal_encerramento = 'N'
		
union all

		select	2 ie_tipo_conta,
			coalesce(sum(vl_movimento),0) vl_movimento
		from	ctb_balancete_v
		where	trunc(dt_referencia,'month')	= dt_segundo_mes_w
		and	substr(cd_classif_sem_ponto,0,6) 	in ('411111','411121')
		and	substr(cd_classif_sem_ponto,8,2)	in ('13','19','23','29','33','39','43','49','53','59','63','69')
		and	current_setting('pls_consistir_diops_pck.ie_2019_ou_posterior_w')::varchar(2) 		= 'N'
		and	ie_normal_encerramento = 'N'
		
union all

		select	3 ie_tipo_conta,
			coalesce(sum(vl_movimento),0) vl_movimento
		from	ctb_balancete_v
		where	trunc(dt_referencia,'month')	= dt_terceiro_mes_w
		and	substr(cd_classif_sem_ponto,0,6) 	in ('411111','411121')
		and	substr(cd_classif_sem_ponto,8,2)	in ('13','19','23','29','33','39','43','49','53','59','63','69')
		and	current_setting('pls_consistir_diops_pck.ie_2019_ou_posterior_w')::varchar(2) 		= 'N'
		and	ie_normal_encerramento = 'N';
	
	vet_contas_outras		c_contas_outras%rowtype;

	c_contas_peona CURSOR FOR
		SELECT	1 ie_tipo_conta,
			coalesce(sum(vl_movimento),0) vl_movimento
		from	ctb_balancete_v
		where	trunc(dt_referencia,'month')	= dt_primeiro_mes_w
		and	substr(cd_classif_sem_ponto,0,6) 	in ('211111','211121','231111','231121')
		and	substr(cd_classif_sem_ponto,8,2)	in ('41')
		and	current_setting('pls_consistir_diops_pck.ie_2019_ou_posterior_w')::varchar(2) 		= 'S'
		and	ie_normal_encerramento = 'N'
		
union all

		SELECT	2 ie_tipo_conta,
			coalesce(sum(vl_movimento),0) vl_movimento
		from	ctb_balancete_v
		where	trunc(dt_referencia,'month')	= dt_segundo_mes_w
		and	substr(cd_classif_sem_ponto,0,6) 	in ('211111','211121','231111','231121')
		and	substr(cd_classif_sem_ponto,8,2)	in ('41')
		and	current_setting('pls_consistir_diops_pck.ie_2019_ou_posterior_w')::varchar(2) 		= 'S'
		and	ie_normal_encerramento = 'N'
		
union all

		select	3 ie_tipo_conta,
			coalesce(sum(vl_movimento),0) vl_movimento
		from	ctb_balancete_v
		where	trunc(dt_referencia,'month')	= dt_terceiro_mes_w
		and	substr(cd_classif_sem_ponto,0,6) 	in ('211111','211121','231111','231121')
		and	substr(cd_classif_sem_ponto,8,2)	in ('41')
		and	current_setting('pls_consistir_diops_pck.ie_2019_ou_posterior_w')::varchar(2) 		= 'S'
		and	ie_normal_encerramento = 'N';
	
	vet_contas_peona	c_contas_peona%rowtype;
	
	
	
BEGIN
	
	delete	
	from 	diops_periodo_inconsist a
	where	a.nr_seq_periodo	= nr_seq_periodo_p
	and	a.nr_seq_inconsistencia	in (73,74,75,115);
	
	commit;
	
	/* Added only once for the next inconsistencies, if needed to include a new consistency for a different board in this procedure, handle the nr_quadro variable correctly so as not to create new defects */

	PERFORM set_config('pls_consistir_diops_pck.nr_quadro_w', 34, false);
	
	open ie_tipo_movimento;
	loop
	fetch ie_tipo_movimento into	
		ie_tipo_movto_w;
	EXIT WHEN NOT FOUND; /* apply on ie_tipo_movimento */
		begin
		
		select	max(trunc(a.dt_periodo_inicial,'month')),
			max(add_months(trunc(a.dt_periodo_inicial,'month'),1)),
			max(add_months(trunc(a.dt_periodo_inicial,'month'),2)),
			max(b.vl_mes_n2),
			max(b.vl_mes_n1),
			max(b.vl_mes_n)
		into STRICT	dt_primeiro_mes_w,
			dt_segundo_mes_w,
			dt_terceiro_mes_w,
			vl_mes_n2_w,
			vl_mes_n1_w,
			vl_mes_n_w
		from	diops_periodo		a,
			diops_movto_pel 	b
		where	a.nr_sequencia		= nr_seq_periodo_p
		and	b.nr_seq_periodo 	= a.nr_sequencia
		and	b.nr_seq_tipo_movto 	= ie_tipo_movto_w;
		
		if (ie_tipo_movto_w = 8) then
		
			open c_contas_avisos;
			loop
			fetch c_contas_avisos into	
				vet_contas_avisos;
			EXIT WHEN NOT FOUND; /* apply on c_contas_avisos */
				begin
				if (current_setting('pls_consistir_diops_pck.ie_2019_ou_posterior_w')::varchar(2) = 'N') then
					PERFORM set_config('pls_consistir_diops_pck.nr_contas_macro_w', '411111011, 411111021, 411111031, 411111041, 411111051, 411111061, 411111099, 411121011, 
					411121021, 411121031, 411121041, 411121051, 411121061 e 411121099', false);
				elsif (current_setting('pls_consistir_diops_pck.dt_periodo_inicial_w')::diops_periodo.dt_periodo_inicial%type >= PKG_DATE_UTILS.get_Date(2019, 1, 1, 0)) and (current_setting('pls_consistir_diops_pck.dt_periodo_inicial_w')::diops_periodo.dt_periodo_inicial%type < PKG_DATE_UTILS.get_Date(2022, 1, 1, 0)) then
					PERFORM set_config('pls_consistir_diops_pck.nr_contas_macro_w', '411111011, 411111021, 411111031, 411111041, 411111051, 411111061, 411111017, 411111027, 
					411111037,411111047, 411111057, 411111067, 411111081, 411121011, 411121021, 411121031, 411121041, 411121051, 
					411121061, 411121017, 411121027, 411121037, 411121047, 411121057, 411121067, 411121081, 411211011, 411211021, 
					411211031, 411211041, 411211051, 411211061, 411211081, 411221011, 411221021, 411221031, 411221041, 411221051, 
					411221061, 411221081, 411311011, 411311021, 411311031, 411311041, 411311051, 411311061, 411311081, 411321011, 
					411321021, 411321031, 411321041, 411321051, 411321061, 411321081, 411411011, 411411021, 411411031, 411411041, 
					411411051, 411411061, 411411017, 411411027, 411411037, 411411047, 411411057, 411411067, 411411081, 411421011, 
					411421021, 411421031, 411421041, 411421051, 411421061, 411421017, 411421027, 411421037, 411421047, 411421057, 
					411421067, 411421081, 411511011, 411511021, 411511031, 411511041, 411511051, 411511061, 411511081, 411521011, 
					411521021, 411521031, 411521041, 411521051, 411521061, 411521081, 411711011, 411711021, 411711031, 411711041, 
					411711051, 411711061, 411711017, 411711027, 411711037, 411711047, 411711057, 411711067, 411721011, 411721021, 
					411721031, 411721041, 411721051, 411721061, 411721017, 411721027, 411721037, 411721047, 411721057, 411721067, 
					411911011, 411911021, 411911031, 411911041, 411911051, 411911061, 411911017, 411911027, 411911037, 411911047, 
					411911057, 411911067, 411911081, 411921011, 411921021, 411921031, 411921041, 411921051, 411921061, 411921017, 
					411921027, 411921037, 411921047, 411921057, 411921067 e 411921081', false);

                    else 
                        PERFORM set_config('pls_consistir_diops_pck.nr_contas_macro_w', '411111011, 411111021, 411111031, 411111041, 411111051, 411111061, 411111017, 411111027, 
					411111037,411111047, 411111057, 411111067, 411111081, 411121011, 411121021, 411121031, 411121041, 411121051, 
					411121061, 411121017, 411121027, 411121037, 411121047, 411121057, 411121067, 411121081, 411211011, 411211021, 
					411211031, 411211041, 411211051, 411211061, 411211081, 411221011, 411221021, 411221031, 411221041, 411221051, 
					411221061, 411221081, 411311011, 411311021, 411311031, 411311041, 411311051, 411311061, 411311081, 411321011, 
					411321021, 411321031, 411321041, 411321051, 411321061, 411321081, 411411011, 411411021, 411411031, 411411041, 
					411411051, 411411061, 411411017, 411411027, 411411037, 411411047, 411411057, 411411067, 411411081, 411421011, 
					411421021, 411421031, 411421041, 411421051, 411421061, 411421017, 411421027, 411421037, 411421047, 411421057, 
					411421067, 411421081, 411511011, 411511021, 411511031, 411511041, 411511051, 411511061, 411511081, 411521011, 
					411521021, 411521031, 411521041, 411521051, 411521061, 411521081, 411711011, 411711021, 411711031, 411711041, 
					411711051, 411711061, 411711017, 411711027, 411711037, 411711047, 411711057, 411711067, 411721011, 411721021, 
					411721031, 411721041, 411721051, 411721061, 411721017, 411721027, 411721037, 411721047, 411721057, 411721067, 
					411911011, 411911021, 411911031, 411911041, 411911051, 411911061, 411911017, 411911027, 411911037, 411911047, 
					411911057, 411911067, 411911081, 411921011, 411921021, 411921031, 411921041, 411921051, 411921061, 411921017, 
					411921027, 411921037, 411921047, 411921057, 411921067, 411921081, 411611011, 411611021, 411611031, 411611041, 
					411611051, 411611061, 411611017, 411611027, 411611037, 411611047, 411611057, 411611067, 411621011, 411621021, 
					411621031, 411621041, 411621051, 411621061, 411621017, 411621027, 411621037, 411621047, 411621057 e 411621067', false);
				end if;
				
				if (vet_contas_avisos.ie_tipo_conta = 1 and vl_mes_n2_w <> vet_contas_avisos.vl_movimento) then
					PERFORM set_config('pls_consistir_diops_pck.ds_periodo_w', to_char(dt_primeiro_mes_w,'mm/yyyy'), false);
					CALL pls_consistir_diops_pck.pls_gravar_consistencia(nr_seq_periodo_p, cd_estabelecimento_p, 73);
				end if;
				
				if (vet_contas_avisos.ie_tipo_conta = 2 and vl_mes_n1_w <> vet_contas_avisos.vl_movimento) then
					PERFORM set_config('pls_consistir_diops_pck.ds_periodo_w', to_char(dt_segundo_mes_w,'mm/yyyy'), false);
					CALL pls_consistir_diops_pck.pls_gravar_consistencia(nr_seq_periodo_p, cd_estabelecimento_p, 73);
				end if;
				
				if (vet_contas_avisos.ie_tipo_conta = 3 and vl_mes_n_w <> vet_contas_avisos.vl_movimento) then
					PERFORM set_config('pls_consistir_diops_pck.ds_periodo_w', to_char(dt_terceiro_mes_w,'mm/yyyy'), false);
					CALL pls_consistir_diops_pck.pls_gravar_consistencia(nr_seq_periodo_p, cd_estabelecimento_p, 73);
				end if;
				
				end;
			end loop;
			close c_contas_avisos;
		
		end if;
		
		if (ie_tipo_movto_w = 23) then
			
			open c_contas_baixas;
			loop
			fetch c_contas_baixas into	
				vet_contas_baixas;
			EXIT WHEN NOT FOUND; /* apply on c_contas_baixas */
				begin
				if (current_setting('pls_consistir_diops_pck.ie_2019_ou_posterior_w')::varchar(2) = 'N') then
					PERFORM set_config('pls_consistir_diops_pck.nr_contas_macro_w', '411111012, 411111022, 411111032, 411111042, 411111052, 411111062, 411121012, 411121022, 
					411121032, 411121042, 411121052, 411121062', false);
				elsif (current_setting('pls_consistir_diops_pck.dt_periodo_inicial_w')::diops_periodo.dt_periodo_inicial%type >= PKG_DATE_UTILS.get_Date(2019, 1, 1, 0)) and (current_setting('pls_consistir_diops_pck.dt_periodo_inicial_w')::diops_periodo.dt_periodo_inicial%type < PKG_DATE_UTILS.get_Date(2022, 1, 1, 0)) then
					PERFORM set_config('pls_consistir_diops_pck.nr_contas_macro_w', '411111012, 411111022, 411111032, 411111042, 411111052, 411111062, 411111082, 411121012, 
					411121022, 411121032, 411121042, 411121052, 411121062, 411121082, 411211012, 411211022, 411211032, 411211042, 
					411211052, 411211062, 411211082, 411221012, 411221022, 411221032, 411221042, 411221052, 411221062, 411221082, 
					411311012, 411311022, 411311032, 411311042, 411311052, 411311062, 411311082, 411321012, 411321022, 411321032, 
					411321042, 411321052, 411321062, 411321082, 411411012, 411411022, 411411032, 411411042, 411411052, 411411062, 
					411411082, 411421012, 411421022, 411421032, 411421042, 411421052, 411421062, 411421082, 411511012, 411511022, 
					411511032, 411511042, 411511052, 411511062, 411511082, 411521012, 411521022, 411521032, 411521042, 411521052, 
					411521062, 411521082, 411711012, 411711022, 411711032, 411711042, 411711052, 411711062, 411721012, 411721022, 
					411721032, 411721042, 411721052, 411721062, 411911012, 411911022, 411911032, 411911042, 411911052, 411911062, 
					411911082, 411921012, 411921022, 411921032, 411921042, 411921052, 411921062 e 411921082', false);
				else
					PERFORM set_config('pls_consistir_diops_pck.nr_contas_macro_w', '411111012, 411111022, 411111032, 411111042, 411111052, 411111062, 411111082, 411121012, 
					411121022, 411121032, 411121042, 411121052, 411121062, 411121082, 411211012, 411211022, 411211032, 411211042, 
					411211052, 411211062, 411211082, 411221012, 411221022, 411221032, 411221042, 411221052, 411221062, 411221082, 
					411311012, 411311022, 411311032, 411311042, 411311052, 411311062, 411311082, 411321012, 411321022, 411321032, 
					411321042, 411321052, 411321062, 411321082, 411411012, 411411022, 411411032, 411411042, 411411052, 411411062, 
					411411082, 411421012, 411421022, 411421032, 411421042, 411421052, 411421062, 411421082, 411511012, 411511022, 
					411511032, 411511042, 411511052, 411511062, 411511082, 411521012, 411521022, 411521032, 411521042, 411521052, 
					411521062, 411521082, 411711012, 411711022, 411711032, 411711042, 411711052, 411711062, 411721012, 411721022, 
					411721032, 411721042, 411721052, 411721062, 411911012, 411911022, 411911032, 411911042, 411911052, 411911062, 
					411911082, 411921012, 411921022, 411921032, 411921042, 411921052, 411921062, 411921082, 411611012, 411611022, 
					411611032, 411611042, 411611052, 411611062, 411621012, 411621022, 411621032, 411621042, 411621052 e 411621062', false);
				end if;
				if (vet_contas_baixas.ie_tipo_conta = 1 and vl_mes_n2_w <> vet_contas_baixas.vl_movimento and ie_tipo_movto_w = 23) then
					PERFORM set_config('pls_consistir_diops_pck.ds_periodo_w', to_char(dt_primeiro_mes_w,'mm/yyyy'), false);
					CALL pls_consistir_diops_pck.pls_gravar_consistencia(nr_seq_periodo_p, cd_estabelecimento_p, 74);
				end if;
				
				if (vet_contas_baixas.ie_tipo_conta = 2 and vl_mes_n1_w <> vet_contas_baixas.vl_movimento and ie_tipo_movto_w = 23) then
					PERFORM set_config('pls_consistir_diops_pck.ds_periodo_w', to_char(dt_segundo_mes_w,'mm/yyyy'), false);
					CALL pls_consistir_diops_pck.pls_gravar_consistencia(nr_seq_periodo_p, cd_estabelecimento_p, 74);
				end if;
				
				if (vet_contas_baixas.ie_tipo_conta = 3 and vl_mes_n_w <> vet_contas_baixas.vl_movimento and ie_tipo_movto_w = 23) then
					PERFORM set_config('pls_consistir_diops_pck.ds_periodo_w', to_char(dt_terceiro_mes_w,'mm/yyyy'), false);
					CALL pls_consistir_diops_pck.pls_gravar_consistencia(nr_seq_periodo_p, cd_estabelecimento_p, 74);
				end if;
				
				end;
			end loop;
			close c_contas_baixas;
			
		end if;

		if (ie_tipo_movto_w = 42) then
		
			open c_contas_outras;
			loop
			fetch c_contas_outras into	
				vet_contas_outras;
			EXIT WHEN NOT FOUND; /* apply on c_contas_outras */
				begin
				if (current_setting('pls_consistir_diops_pck.ie_2019_ou_posterior_w')::varchar(2) = 'N') then
					PERFORM set_config('pls_consistir_diops_pck.nr_contas_macro_w', '411111013, 411111019, 411111023, 411111029, 411111033, 411111039, 411111043, 411111049, 
					411111053, 411111059, 411111063, 411111069, 411121013, 411121019, 411121023, 411121029, 411121033, 411121039, 
					411121043, 411121049, 411121053, 411121059, 411121063 e 411121069', false);
				elsif (current_setting('pls_consistir_diops_pck.dt_periodo_inicial_w')::diops_periodo.dt_periodo_inicial%type >= PKG_DATE_UTILS.get_Date(2019, 1, 1, 0)) and (current_setting('pls_consistir_diops_pck.dt_periodo_inicial_w')::diops_periodo.dt_periodo_inicial%type < PKG_DATE_UTILS.get_Date(2022, 1, 1, 0)) then
					PERFORM set_config('pls_consistir_diops_pck.nr_contas_macro_w', '411111013, 411111023, 411111033, 411111043, 411111053, 411111063, 411111019, 411111029, 
					411111039, 411111049, 411111059, 411111069, 411121013, 411121023, 411121033, 411121043, 411121053, 411121063, 
					411121019, 411121029, 411121039, 411121049, 411121059, 411121069, 411211013, 411211023, 411211033, 411211043, 
					411211053, 411211063, 411211019, 411211029, 411211039, 411211049, 411211059, 411211069, 411221013, 411221023, 
					411221033, 411221043, 411221053, 411221063, 411221019, 411221029, 411221039, 411221049, 411221059, 411221069, 
					411311013, 411311023, 411311033, 411311043, 411311053, 411311063, 411311019, 411311029, 411311039, 411311049, 
					411311059, 411311069, 411321013, 411321023, 411321033, 411321043, 411321053, 411321063, 411321019, 411321029, 
					411321039, 411321049, 411321059, 411321069, 411411013, 411411023, 411411033, 411411043, 411411053, 411411063, 
					411411019, 411411029, 411411039, 411411049, 411411059, 411411069, 411421013, 411421023, 411421033, 411421043, 
					411421053, 411421063, 411421019, 411421029, 411421039, 411421049, 411421059, 411421069, 411511013, 411511023, 
					411511033, 411511043, 411511053, 411511063, 411511019, 411511029, 411511039, 411511049, 411511059, 411511069, 
					411521013, 411521023, 411521033, 411521043, 411521053, 411521063, 411521019, 411521029, 411521039, 411521049, 
					411521059, 411521069, 411711013, 411711023, 411711033, 411711043, 411711053, 411711063, 411711019, 411711029, 
					411711039, 411711049, 411711059, 411711069, 411721013, 411721023, 411721033, 411721043, 411721053, 411721063, 
					411721019, 411721029, 411721039, 411721049, 411721059, 411721069, 411911013, 411911023, 411911033, 411911043, 
					411911053, 411911063, 411911019, 411911029, 411911039, 411911049, 411911059, 411911069, 411921013, 411921023, 
					411921033, 411921043, 411921053, 411921063, 411921019, 411921029, 411921039, 411921049, 411921059 e 411921069', false);
			        else
					PERFORM set_config('pls_consistir_diops_pck.nr_contas_macro_w', '411111013, 411111023, 411111033, 411111043, 411111053, 411111063, 411111019, 411111029, 
					411111039, 411111049, 411111059, 411111069, 411121013, 411121023, 411121033, 411121043, 411121053, 411121063, 
					411121019, 411121029, 411121039, 411121049, 411121059, 411121069, 411211013, 411211023, 411211033, 411211043, 
					411211053, 411211063, 411211019, 411211029, 411211039, 411211049, 411211059, 411211069, 411221013, 411221023, 
					411221033, 411221043, 411221053, 411221063, 411221019, 411221029, 411221039, 411221049, 411221059, 411221069, 
					411311013, 411311023, 411311033, 411311043, 411311053, 411311063, 411311019, 411311029, 411311039, 411311049, 
					411311059, 411311069, 411321013, 411321023, 411321033, 411321043, 411321053, 411321063, 411321019, 411321029, 
					411321039, 411321049, 411321059, 411321069, 411411013, 411411023, 411411033, 411411043, 411411053, 411411063, 
					411411019, 411411029, 411411039, 411411049, 411411059, 411411069, 411421013, 411421023, 411421033, 411421043, 
					411421053, 411421063, 411421019, 411421029, 411421039, 411421049, 411421059, 411421069, 411511013, 411511023, 
					411511033, 411511043, 411511053, 411511063, 411511019, 411511029, 411511039, 411511049, 411511059, 411511069, 
					411521013, 411521023, 411521033, 411521043, 411521053, 411521063, 411521019, 411521029, 411521039, 411521049, 
					411521059, 411521069, 411711013, 411711023, 411711033, 411711043, 411711053, 411711063, 411711019, 411711029, 
					411711039, 411711049, 411711059, 411711069, 411721013, 411721023, 411721033, 411721043, 411721053, 411721063, 
					411721019, 411721029, 411721039, 411721049, 411721059, 411721069, 411911013, 411911023, 411911033, 411911043, 
					411911053, 411911063, 411911019, 411911029, 411911039, 411911049, 411911059, 411911069, 411921013, 411921023, 
					411921033, 411921043, 411921053, 411921063, 411921019, 411921029, 411921039, 411921049, 411921059, 411921069, 
				        411611013, 411611023, 411611033, 411611043, 411611053, 411611063, 411611019, 411611029, 411611039, 411611049, 
				        411611059, 411611069, 411621013, 411621023, 411621033, 411621043, 411621053, 411621063, 411621019, 411621029, 
				        411621039, 411621049, 411621059 e 411621069', false);
				end if;

				if (vet_contas_outras.ie_tipo_conta = 1 and vl_mes_n2_w <> vet_contas_outras.vl_movimento and ie_tipo_movto_w = 42) then
					PERFORM set_config('pls_consistir_diops_pck.ds_periodo_w', to_char(dt_primeiro_mes_w,'mm/yyyy'), false);
					CALL pls_consistir_diops_pck.pls_gravar_consistencia(nr_seq_periodo_p, cd_estabelecimento_p, 75);
				end if;
				
				if (vet_contas_outras.ie_tipo_conta = 2 and vl_mes_n1_w <> vet_contas_outras.vl_movimento and ie_tipo_movto_w = 42) then
					PERFORM set_config('pls_consistir_diops_pck.ds_periodo_w', to_char(dt_segundo_mes_w,'mm/yyyy'), false);
					CALL pls_consistir_diops_pck.pls_gravar_consistencia(nr_seq_periodo_p, cd_estabelecimento_p, 75);
				end if;
				
				if (vet_contas_outras.ie_tipo_conta = 3 and vl_mes_n_w <> vet_contas_outras.vl_movimento and ie_tipo_movto_w = 42) then
					PERFORM set_config('pls_consistir_diops_pck.ds_periodo_w', to_char(dt_terceiro_mes_w,'mm/yyyy'), false);
					CALL pls_consistir_diops_pck.pls_gravar_consistencia(nr_seq_periodo_p, cd_estabelecimento_p, 75);
				end if;
				
				end;
			end loop;
			close c_contas_outras;
			
		end if;

		
		if (ie_tipo_movto_w = 57) then
		
			open c_contas_peona;
			loop
			fetch c_contas_peona into	
				vet_contas_peona;
			EXIT WHEN NOT FOUND; /* apply on c_contas_peona */
				begin
				PERFORM set_config('pls_consistir_diops_pck.nr_contas_macro_w', '211111041, 211121041, 231111041 e 231121041', false);
				if (vet_contas_peona.ie_tipo_conta = 1 and vl_mes_n2_w <> vet_contas_peona.vl_movimento and ie_tipo_movto_w = 57) then
					PERFORM set_config('pls_consistir_diops_pck.ds_periodo_w', to_char(dt_primeiro_mes_w,'mm/yyyy'), false);
					CALL pls_consistir_diops_pck.pls_gravar_consistencia(nr_seq_periodo_p, cd_estabelecimento_p, 115);
				end if;
				
				if (vet_contas_peona.ie_tipo_conta = 2 and vl_mes_n1_w <> vet_contas_peona.vl_movimento and ie_tipo_movto_w = 57) then
					PERFORM set_config('pls_consistir_diops_pck.ds_periodo_w', to_char(dt_segundo_mes_w,'mm/yyyy'), false);
					CALL pls_consistir_diops_pck.pls_gravar_consistencia(nr_seq_periodo_p, cd_estabelecimento_p, 115);
				end if;
				
				if (vet_contas_peona.ie_tipo_conta = 3 and vl_mes_n_w <> vet_contas_peona.vl_movimento and ie_tipo_movto_w = 57) then
					PERFORM set_config('pls_consistir_diops_pck.ds_periodo_w', to_char(dt_terceiro_mes_w,'mm/yyyy'), false);
					CALL pls_consistir_diops_pck.pls_gravar_consistencia(nr_seq_periodo_p, cd_estabelecimento_p, 115);
				end if;
				
				end;
			end loop;
			close c_contas_peona;
			
		end if;

		end;
	end loop;
	close ie_tipo_movimento;
	
	PERFORM set_config('pls_consistir_diops_pck.nr_quadro_w', 0, false);
	
	commit;

	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_consistir_diops_pck.pls_diops_consist_pel ( nr_seq_periodo_p bigint, cd_estabelecimento_p bigint) FROM PUBLIC;
