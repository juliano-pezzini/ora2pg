-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_pp_gerar_titulo_pck.enviar_titulo_camara_comp ( nr_seq_lote_camara_comp_p pls_lote_camara_comp.nr_sequencia%type, nr_seq_pp_lote_p pls_pp_lote.nr_sequencia%type, nr_seq_pgto_lote_p pls_lote_pagamento.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE


-- Obter os titulos a pagar

c01 CURSOR(	nr_seq_pp_lote_pc		pls_pp_lote.nr_sequencia%type,
		nr_seq_pgto_lote_pc		pls_lote_pagamento.nr_sequencia%type) FOR
	-- Titulos a pagar da funcao OPS - Pagamentos de Prestadores

	SELECT	v.nr_titulo_pagar
	from	pls_pp_prestador v
	where	v.nr_seq_lote	= nr_seq_pp_lote_pc
	and	coalesce(nr_seq_pgto_lote_pc::text, '') = ''
	and	(v.nr_titulo_pagar IS NOT NULL AND v.nr_titulo_pagar::text <> '')
	
union all

	-- Titulos a pagar da funcao OPS - Pagamentos de Producao Medica

	SELECT	v.nr_titulo nr_titulo_pagar
	from	pls_pag_prest_vencimento v,
		pls_pagamento_prestador	p
	where	p.nr_sequencia	= v.nr_seq_pag_prestador
	and	p.nr_seq_lote	= nr_seq_pgto_lote_pc
	and	coalesce(nr_seq_pp_lote_pc::text, '') = ''
	and	(v.nr_titulo IS NOT NULL AND v.nr_titulo::text <> '');

BEGIN
-- Verificar se tem lote de camara de compensacao selecionado

if (nr_seq_lote_camara_comp_p IS NOT NULL AND nr_seq_lote_camara_comp_p::text <> '') and
	((nr_seq_pp_lote_p IS NOT NULL AND nr_seq_pp_lote_p::text <> '') or (nr_seq_pgto_lote_p IS NOT NULL AND nr_seq_pgto_lote_p::text <> '')) then
	
	for r_c01_w in c01( nr_seq_pp_lote_p, nr_seq_pgto_lote_p ) loop
		
		-- Incluir os titulos ao lote de camara de compensacao

		if (r_c01_w.nr_titulo_pagar IS NOT NULL AND r_c01_w.nr_titulo_pagar::text <> '') then
			CALL pls_vincular_tit_lote_camara( nr_seq_lote_camara_comp_p, r_c01_w.nr_titulo_pagar, null, nm_usuario_p);
		end if;
	
	end loop;
end if;

commit;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_pp_gerar_titulo_pck.enviar_titulo_camara_comp ( nr_seq_lote_camara_comp_p pls_lote_camara_comp.nr_sequencia%type, nr_seq_pp_lote_p pls_pp_lote.nr_sequencia%type, nr_seq_pgto_lote_p pls_lote_pagamento.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;
