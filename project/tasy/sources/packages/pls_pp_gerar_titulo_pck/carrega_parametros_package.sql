-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

-- controle para decidir quando o select para obtencao dos valores dos parametros deve ser executado novamente




CREATE OR REPLACE PROCEDURE pls_pp_gerar_titulo_pck.carrega_parametros ( cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) AS $body$
BEGIN

-- se a data da ultima solicitacao nao estiver registrada ou 

-- se ja se passou 67 segundos deste a ultima solicitacao ou

-- se a origem for diferente da ultima solicitada ou

-- se o estabelecimento anterior for diferente do ultimo solicitado

-- executa o comando para preencher os valores dos parametros

if	((current_setting('pls_pp_gerar_titulo_pck.dt_solicitacao_ult_w')::coalesce(timestamp::text, '') = '') or
	(current_setting('pls_pp_gerar_titulo_pck.dt_solicitacao_ult_w')::timestamp <= (clock_timestamp() - interval '67 seconds')) or (coalesce(current_setting('pls_pp_gerar_titulo_pck.cd_estabelecimento_ult_w')::estabelecimento.cd_estabelecimento%type, -1) != coalesce(cd_estabelecimento_p, -2))) then

	PERFORM set_config('pls_pp_gerar_titulo_pck.cd_estabelecimento_ult_w', cd_estabelecimento_p, false);
	PERFORM set_config('pls_pp_gerar_titulo_pck.dt_solicitacao_ult_w', clock_timestamp(), false);

	if (coalesce(cd_estabelecimento_p::text, '') = '') then

		select	coalesce(max(ie_forma_retencao_inss_ir), 'ME'),
			max(nr_seq_classe),
			max(nr_seq_classe_tp),
			max(nr_seq_trans_fin_baixa),			
			max(nr_seq_trans_fin_baixa_rec_pro),
			max(nr_seq_tipo_prest_rec_prop),
			coalesce(max(ie_processo_tit_rec_prop),'L'),
			coalesce(max(ie_gerar_tit_sem_nf),'S')
		into STRICT	current_setting('pls_pp_gerar_titulo_pck.ie_forma_retencao_inss_ir_w')::pls_parametro_pagamento.ie_forma_retencao_inss_ir%type,
			current_setting('pls_pp_gerar_titulo_pck.nr_seq_classe_pgto_neg_w')::pls_parametro_pagamento.nr_seq_classe%type,
			current_setting('pls_pp_gerar_titulo_pck.nr_seq_classe_tp_w')::pls_parametro_pagamento.nr_seq_classe_tp%type,
			current_setting('pls_pp_gerar_titulo_pck.nr_seq_trans_fin_baixa_w')::pls_parametro_pagamento.nr_seq_trans_fin_baixa%type,
			current_setting('pls_pp_gerar_titulo_pck.nr_seq_trans_fin_baixa_rp_w')::pls_parametro_pagamento.nr_seq_trans_fin_baixa_rec_pro%type,
			current_setting('pls_pp_gerar_titulo_pck.nr_seq_tipo_prest_rec_prop_w')::pls_parametro_pagamento.nr_seq_tipo_prest_rec_prop%type,
			current_setting('pls_pp_gerar_titulo_pck.ie_processo_tit_rec_prop_w')::pls_parametro_pagamento.ie_processo_tit_rec_prop%type,
			current_setting('pls_pp_gerar_titulo_pck.ie_gerar_tit_sem_nf_w')::pls_parametro_pagamento.ie_gerar_tit_sem_nf%type
		from	pls_parametro_pagamento;

		select	max(nr_seq_trans_fin_baixa_conta),
			max(cd_conta_financ_conta)
		into STRICT	current_setting('pls_pp_gerar_titulo_pck.nr_seq_trans_fin_baixa_conta_w')::pls_parametros.nr_seq_trans_fin_baixa_conta%type,
			current_setting('pls_pp_gerar_titulo_pck.cd_conta_financ_w')::pls_parametros.cd_conta_financ_conta%type
		from	pls_parametros;

		select 	max(cd_tipo_taxa_juro),
			max(cd_tipo_taxa_multa),
			max(cd_tipo_portador),
			max(cd_portador),
			max(pr_juro_padrao),
			max(pr_multa_padrao),
			coalesce(max(pr_juro_pj), 0),
			coalesce(max(pr_multa_pj), 0),
			max(cd_moeda_padrao)
		into STRICT	current_setting('pls_pp_gerar_titulo_pck.cd_tipo_taxa_juro_w')::parametro_contas_receber.cd_tipo_taxa_juro%type,
			current_setting('pls_pp_gerar_titulo_pck.cd_tipo_taxa_multa_w')::parametro_contas_receber.cd_tipo_taxa_multa%type,
			current_setting('pls_pp_gerar_titulo_pck.cd_tipo_portador_w')::parametro_contas_receber.cd_tipo_portador%type,
			current_setting('pls_pp_gerar_titulo_pck.cd_portador_w')::parametro_contas_receber.cd_portador%type,
			current_setting('pls_pp_gerar_titulo_pck.tx_juros_cr_w')::parametro_contas_receber.pr_juro_padrao%type,
			current_setting('pls_pp_gerar_titulo_pck.tx_multa_cr_w')::parametro_contas_receber.pr_multa_padrao%type,
			current_setting('pls_pp_gerar_titulo_pck.tx_juros_pj_cr_w')::parametro_contas_receber.pr_juro_pj%type,
			current_setting('pls_pp_gerar_titulo_pck.tx_multa_pj_cr_w')::parametro_contas_receber.pr_multa_pj%type,
			current_setting('pls_pp_gerar_titulo_pck.cd_moeda_padrao_receber_w')::parametro_contas_receber.cd_moeda_padrao%type
		from 	parametro_contas_receber;

		select	coalesce(max(ie_trib_saldo_tit_nf),'N'),
			max(cd_moeda_padrao),
			coalesce(max(ie_conta_contab_tit_trib),'T'),
			coalesce(max(ie_conta_financ_tit_trib),'T'),
			max(cd_tipo_taxa_juro),
			max(cd_tipo_taxa_multa),
			max(pr_juro_padrao),
			max(pr_multa_padrao)
		into STRICT	current_setting('pls_pp_gerar_titulo_pck.ie_trib_saldo_tit_nf_w')::parametros_contas_pagar.ie_trib_saldo_tit_nf%type,
			current_setting('pls_pp_gerar_titulo_pck.cd_moeda_padrao_pagar_w')::parametros_contas_pagar.cd_moeda_padrao%type,
			current_setting('pls_pp_gerar_titulo_pck.ie_conta_contab_tit_trib_w')::parametros_contas_pagar.ie_conta_contab_tit_trib%type,
			current_setting('pls_pp_gerar_titulo_pck.ie_conta_financ_tit_trib_w')::parametros_contas_pagar.ie_conta_financ_tit_trib%type,
			current_setting('pls_pp_gerar_titulo_pck.cd_tipo_taxa_juro_pag_w')::parametros_contas_pagar.cd_tipo_taxa_juro%type,
			current_setting('pls_pp_gerar_titulo_pck.cd_tipo_taxa_multa_pag_w')::parametros_contas_pagar.cd_tipo_taxa_multa%type,
			current_setting('pls_pp_gerar_titulo_pck.pr_juro_padrao_pag_w')::parametros_contas_pagar.pr_juro_padrao%type,
			current_setting('pls_pp_gerar_titulo_pck.pr_multa_padrao_pag_w')::parametros_contas_pagar.pr_multa_padrao%type
		from	parametros_contas_pagar;

		select	max(coalesce(ie_data_lote_prod_med,'C'))
		into STRICT	current_setting('pls_pp_gerar_titulo_pck.ie_data_lote_prod_med_w')::pls_parametro_contabil.ie_data_lote_prod_med%type
		from	pls_parametro_contabil;
	else
	
		select	coalesce(max(ie_forma_retencao_inss_ir), 'ME'),
			max(nr_seq_classe),
			max(nr_seq_classe_tp),
			max(nr_seq_trans_fin_baixa),
			max(nr_seq_trans_fin_baixa_rec_pro),
			max(nr_seq_tipo_prest_rec_prop),
			coalesce(max(ie_processo_tit_rec_prop),'L'),
			coalesce(max(ie_gerar_tit_sem_nf),'S')
		into STRICT	current_setting('pls_pp_gerar_titulo_pck.ie_forma_retencao_inss_ir_w')::pls_parametro_pagamento.ie_forma_retencao_inss_ir%type,
			current_setting('pls_pp_gerar_titulo_pck.nr_seq_classe_pgto_neg_w')::pls_parametro_pagamento.nr_seq_classe%type,
			current_setting('pls_pp_gerar_titulo_pck.nr_seq_classe_tp_w')::pls_parametro_pagamento.nr_seq_classe_tp%type,
			current_setting('pls_pp_gerar_titulo_pck.nr_seq_trans_fin_baixa_w')::pls_parametro_pagamento.nr_seq_trans_fin_baixa%type,
			current_setting('pls_pp_gerar_titulo_pck.nr_seq_trans_fin_baixa_rp_w')::pls_parametro_pagamento.nr_seq_trans_fin_baixa_rec_pro%type,
			current_setting('pls_pp_gerar_titulo_pck.nr_seq_tipo_prest_rec_prop_w')::pls_parametro_pagamento.nr_seq_tipo_prest_rec_prop%type,
			current_setting('pls_pp_gerar_titulo_pck.ie_processo_tit_rec_prop_w')::pls_parametro_pagamento.ie_processo_tit_rec_prop%type,
			current_setting('pls_pp_gerar_titulo_pck.ie_gerar_tit_sem_nf_w')::pls_parametro_pagamento.ie_gerar_tit_sem_nf%type
		from	pls_parametro_pagamento
		where	cd_estabelecimento = cd_estabelecimento_p;

		select	max(nr_seq_trans_fin_baixa_conta),
			max(cd_conta_financ_conta)
		into STRICT	current_setting('pls_pp_gerar_titulo_pck.nr_seq_trans_fin_baixa_conta_w')::pls_parametros.nr_seq_trans_fin_baixa_conta%type,
			current_setting('pls_pp_gerar_titulo_pck.cd_conta_financ_w')::pls_parametros.cd_conta_financ_conta%type
		from	pls_parametros
		where	cd_estabelecimento = cd_estabelecimento_p;

		select 	max(cd_tipo_taxa_juro),
			max(cd_tipo_taxa_multa),
			max(cd_tipo_portador),
			max(cd_portador),
			max(pr_juro_padrao),
			max(pr_multa_padrao),
			max(pr_juro_pj),
			max(pr_multa_pj),
			max(cd_moeda_padrao)
		into STRICT	current_setting('pls_pp_gerar_titulo_pck.cd_tipo_taxa_juro_w')::parametro_contas_receber.cd_tipo_taxa_juro%type,
			current_setting('pls_pp_gerar_titulo_pck.cd_tipo_taxa_multa_w')::parametro_contas_receber.cd_tipo_taxa_multa%type,
			current_setting('pls_pp_gerar_titulo_pck.cd_tipo_portador_w')::parametro_contas_receber.cd_tipo_portador%type,
			current_setting('pls_pp_gerar_titulo_pck.cd_portador_w')::parametro_contas_receber.cd_portador%type,
			current_setting('pls_pp_gerar_titulo_pck.tx_juros_cr_w')::parametro_contas_receber.pr_juro_padrao%type,
			current_setting('pls_pp_gerar_titulo_pck.tx_multa_cr_w')::parametro_contas_receber.pr_multa_padrao%type,
			current_setting('pls_pp_gerar_titulo_pck.tx_juros_pj_cr_w')::parametro_contas_receber.pr_juro_pj%type,
			current_setting('pls_pp_gerar_titulo_pck.tx_multa_pj_cr_w')::parametro_contas_receber.pr_multa_pj%type,
			current_setting('pls_pp_gerar_titulo_pck.cd_moeda_padrao_receber_w')::parametro_contas_receber.cd_moeda_padrao%type
		from 	parametro_contas_receber
		where 	cd_estabelecimento = cd_estabelecimento_p;

		select	coalesce(max(ie_trib_saldo_tit_nf),'N'),
			max(cd_moeda_padrao),
			coalesce(max(ie_conta_contab_tit_trib),'T'),
			coalesce(max(ie_conta_financ_tit_trib),'T'),
			max(cd_tipo_taxa_juro),
			max(cd_tipo_taxa_multa),
			max(pr_juro_padrao),
			max(pr_multa_padrao)
		into STRICT	current_setting('pls_pp_gerar_titulo_pck.ie_trib_saldo_tit_nf_w')::parametros_contas_pagar.ie_trib_saldo_tit_nf%type,
			current_setting('pls_pp_gerar_titulo_pck.cd_moeda_padrao_pagar_w')::parametros_contas_pagar.cd_moeda_padrao%type,
			current_setting('pls_pp_gerar_titulo_pck.ie_conta_contab_tit_trib_w')::parametros_contas_pagar.ie_conta_contab_tit_trib%type,
			current_setting('pls_pp_gerar_titulo_pck.ie_conta_financ_tit_trib_w')::parametros_contas_pagar.ie_conta_financ_tit_trib%type,
			current_setting('pls_pp_gerar_titulo_pck.cd_tipo_taxa_juro_pag_w')::parametros_contas_pagar.cd_tipo_taxa_juro%type,
			current_setting('pls_pp_gerar_titulo_pck.cd_tipo_taxa_multa_pag_w')::parametros_contas_pagar.cd_tipo_taxa_multa%type,
			current_setting('pls_pp_gerar_titulo_pck.pr_juro_padrao_pag_w')::parametros_contas_pagar.pr_juro_padrao%type,
			current_setting('pls_pp_gerar_titulo_pck.pr_multa_padrao_pag_w')::parametros_contas_pagar.pr_multa_padrao%type
		from	parametros_contas_pagar
		where	cd_estabelecimento = cd_estabelecimento_p;

		select	max(coalesce(ie_data_lote_prod_med,'C'))
		into STRICT	current_setting('pls_pp_gerar_titulo_pck.ie_data_lote_prod_med_w')::pls_parametro_contabil.ie_data_lote_prod_med%type
		from	pls_parametro_contabil
		where	cd_estabelecimento = cd_estabelecimento_p;
	end if;
end if;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_pp_gerar_titulo_pck.carrega_parametros ( cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) FROM PUBLIC;
