-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_pp_gerar_titulo_pck.gerar_tributo_titulo_pagar ( nr_seq_lote_p pls_pp_lote.nr_sequencia%type, nr_seq_pp_prest_p pls_pp_prestador.nr_sequencia%type, nr_titulo_pagar_p titulo_pagar.nr_titulo%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE


nr_seq_titulo_imp_w	titulo_pagar_imposto.nr_sequencia%type;

c01 CURSOR(	nr_seq_lote_pc		pls_pp_lote.nr_sequencia%type,
		nr_seq_pp_prest_pc	pls_pp_prestador.nr_sequencia%type) FOR
	SELECT	d.nr_sequencia,
		max(d.cd_tributo) cd_tributo,
		max(d.dt_pgto_tributo) dt_pgto_tributo,
		max(d.nr_seq_trans_reg) nr_seq_trans_reg,
		max(d.nr_seq_trans_baixa) nr_seq_trans_baixa,
		max(d.cd_beneficiario) cd_beneficiario,
		max(d.vl_base_calculo) vl_base_calculo,
		max(d.vl_tributo) vl_tributo,
		max(d.pr_aliquota) pr_aliquota,
		max(d.vl_nao_retido) vl_nao_retido,
		max(d.vl_base_nao_retido) vl_base_nao_retido,
		max(d.vl_trib_adic) vl_trib_adic,
		max(d.vl_base_adic) vl_base_adic,
		max(d.cd_variacao) cd_variacao,
		max(d.ie_periodicidade) ie_periodicidade,
		max(d.ie_tipo_tributo) ie_tipo_tributo,
		max(d.ie_tipo_prestador) ie_tipo_prestador,
		max(d.cd_cond_pagto) cd_cond_pagto,
		max(d.cd_darf) cd_darf,
		max(d.ie_vencimento) ie_vencimento,
		max(d.ie_gerar_titulo_pagar) ie_gerar_titulo_pagar
	from	pls_pp_prest_event_prest a,
		pls_pp_it_prest_event_val b,
		pls_pp_base_atual_trib c,
		pls_pp_valor_trib_pessoa d
	where	a.nr_seq_pp_prest = nr_seq_pp_prest_pc
	and	b.nr_seq_prest_even_val = a.nr_seq_pp_prest_even_val
	and	c.nr_seq_item_lote = b.nr_seq_item_lote
	and	c.nr_seq_lote = nr_seq_lote_pc
	and	d.nr_sequencia = c.nr_seq_trib_pessoa
	group by d.nr_sequencia;

BEGIN

--nr_seq_pls_venc_trib, nr_seq_trib_cp jls verificar estes campos

for r_c01_w in c01(	nr_seq_lote_p, nr_seq_pp_prest_p) loop

	insert into titulo_pagar_imposto(
		nr_sequencia, nr_titulo, cd_tributo,
		ie_pago_prev, dt_atualizacao, nm_usuario,
		dt_imposto, vl_base_calculo, vl_imposto,
		pr_imposto, nr_seq_trans_reg, nr_seq_trans_baixa,
		cd_beneficiario, cd_cond_pagto, vl_nao_retido, 
		ie_vencimento, vl_base_nao_retido, vl_trib_adic, 
		vl_base_adic, nm_usuario_nrec, dt_atualizacao_nrec, 
		cd_variacao, ie_periodicidade, cd_darf
	) values (
		nextval('titulo_pagar_imposto_seq'), nr_titulo_pagar_p, r_c01_w.cd_tributo,
		'V', clock_timestamp(), nm_usuario_p,
		r_c01_w.dt_pgto_tributo, r_c01_w.vl_base_calculo, r_c01_w.vl_tributo,
		r_c01_w.pr_aliquota, r_c01_w.nr_seq_trans_reg, r_c01_w.nr_seq_trans_baixa,
		r_c01_w.cd_beneficiario, r_c01_w.cd_cond_pagto, r_c01_w.vl_nao_retido,
		r_c01_w.ie_vencimento, r_c01_w.vl_base_nao_retido, r_c01_w.vl_trib_adic,
		r_c01_w.vl_base_adic, nm_usuario_p, clock_timestamp(),
		r_c01_w.cd_variacao, r_c01_w.ie_periodicidade, r_c01_w.cd_darf
	) returning nr_sequencia into nr_seq_titulo_imp_w;

	-- se o valor do tributo for maior de zero precisa verificar se ha necessidade de gerar um titulo a pagar para o tributo

	if (r_c01_w.vl_tributo > 0) and (r_c01_w.ie_gerar_titulo_pagar = 'S') then

		-- se for pessoa fisica gera apenas para IR ou INSS

		if (r_c01_w.ie_tipo_prestador = 'PJ') or (r_c01_w.ie_tipo_prestador = 'PF' and r_c01_w.ie_tipo_tributo in ('INSS', 'IR', 'O')) then -- Tipo tributo "INSS", "IR" ou "Outros" no caso de "Imposto de Renda - Juros Capital Proprio" igual UB

			-- gera o titulo a pagar do tributo

			CALL gerar_titulo_tributo(nr_seq_titulo_imp_w, nm_usuario_p);
			
			-- atualiza com o numero do titulo gerado

			update pls_pp_valor_trib_pessoa p
			set    p.nr_titulo_pagar    = (SELECT max(t.nr_titulo) from titulo_pagar t where t.nr_seq_tributo = nr_seq_titulo_imp_w)
			where  p.nr_sequencia	    = r_c01_w.nr_sequencia
			and    coalesce(p.nr_titulo_pagar::text, '') = '';
									
		end if;
	end if;

	commit;
end loop;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_pp_gerar_titulo_pck.gerar_tributo_titulo_pagar ( nr_seq_lote_p pls_pp_lote.nr_sequencia%type, nr_seq_pp_prest_p pls_pp_prestador.nr_sequencia%type, nr_titulo_pagar_p titulo_pagar.nr_titulo%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;
