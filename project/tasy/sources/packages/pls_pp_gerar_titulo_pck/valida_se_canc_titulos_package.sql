-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_pp_gerar_titulo_pck.valida_se_canc_titulos ( nr_seq_lote_p pls_pp_lote.nr_sequencia%type) AS $body$
DECLARE


ds_mensagem_w		varchar(200);
dt_mes_competencia_w	pls_pp_lote.dt_mes_competencia%type;
nr_lote_contabil_w	lote_contabil.nr_lote_contabil%type;


BEGIN

select	max(dt_mes_competencia)
into STRICT	dt_mes_competencia_w
from	pls_pp_lote
where	nr_sequencia = nr_seq_lote_p;

select	max(coalesce(nr_lote_contabil,0))
into STRICT	nr_lote_contabil_w
from	lote_contabil
where	cd_tipo_lote_contabil	= 41 -- OPS - Desp Pagamento de producao medica
and	establishment_timezone_utils.startOfmonth(dt_referencia) = establishment_timezone_utils.startOfmonth(dt_mes_competencia_w)
and	(dt_geracao_lote IS NOT NULL AND dt_geracao_lote::text <> '')
and	coalesce(ie_status_origem, 'M') <> 'SO'
and	cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento;

if (nr_lote_contabil_w > 0) then
	-- Nao e possivel executar essa acao, pois ja existe um lote contabil gerado para essa competencia. (Lote contabil: #@NR_LOTE_CONTABIL#@ - Tipo: 41 (OPS - Desp Pagamento de producao medica))

	CALL wheb_mensagem_pck.exibir_mensagem_abort(1190796,'NR_LOTE_CONTABIL=' || nr_lote_contabil_w);
end if;

-- retorna os titulos que ja entraram em um bordero

ds_mensagem_w := pls_pp_gerar_titulo_pck.obter_titulo_pagar_bordero(nr_seq_lote_p, null);

-- caso exista algum para o processo

if (ds_mensagem_w IS NOT NULL AND ds_mensagem_w::text <> '') then

	-- Existem titulos neste lote de pagamento que ja estao em algum bordero, nao e possivel cancelar os titulos.

	-- #@DS_MENSAGEM#@

	CALL wheb_mensagem_pck.exibir_mensagem_abort(457966,'DS_MENSAGEM=' || ds_mensagem_w);
end if;

-- retorna os titulos que ja entraram em algum pagamento escritural

ds_mensagem_w := pls_pp_gerar_titulo_pck.obter_titulo_pagar_escritural(nr_seq_lote_p, null);

if (ds_mensagem_w IS NOT NULL AND ds_mensagem_w::text <> '') then

	-- Existem titulos neste lote de pagamento que ja estao em algum pagamento escritural, nao e possivel cancelar os titulos.

	-- #@DS_MENSAGEM#@

	CALL wheb_mensagem_pck.exibir_mensagem_abort(457968,'DS_MENSAGEM=' || ds_mensagem_w);
end if;

CALL pls_pp_gerar_titulo_pck.verifica_titulo_pag_escrit(nr_seq_lote_p);

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_pp_gerar_titulo_pck.valida_se_canc_titulos ( nr_seq_lote_p pls_pp_lote.nr_sequencia%type) FROM PUBLIC;
