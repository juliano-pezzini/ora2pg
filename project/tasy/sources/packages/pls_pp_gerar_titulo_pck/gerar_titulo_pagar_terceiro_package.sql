-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_pp_gerar_titulo_pck.gerar_titulo_pagar_terceiro ( nr_seq_lote_p pls_pp_lote.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE


tb_nr_seq_item_w	pls_util_cta_pck.t_number_table;
tb_cd_pessoa_fisica_w	pls_util_cta_pck.t_varchar2_table_20;
tb_cd_cgc_w		pls_util_cta_pck.t_varchar2_table_20;
tb_vl_item_w		pls_util_cta_pck.t_number_table;
tb_dt_movimento_w	pls_util_cta_pck.t_date_table;
tb_nr_classe_tit_pag_w	pls_util_cta_pck.t_number_table;
tb_nr_trans_fin_baixa_w	pls_util_cta_pck.t_number_table;
tb_nr_trans_fin_cont_w	pls_util_cta_pck.t_number_table;
tb_nr_titulo_pagar_w	pls_util_cta_pck.t_number_table;
tb_nr_seq_regra_w	pls_util_cta_pck.t_number_table;
tb_obs_titulo_w		pls_util_cta_pck.t_varchar2_table_255;
cd_estab_financeiro_w	estabelecimento.cd_estab_financeiro%type;

c01 CURSOR(	nr_seq_lote_pc		pls_pp_lote.nr_sequencia%type,
		dt_mes_comp_lote_pc	timestamp) FOR
	SELECT	a.nr_sequencia nr_seq_item,
		b.cd_pf_titulo_pagar,
		b.cd_pj_titulo_pagar,
		abs(a.vl_item) vl_item,
		pls_pp_gerar_titulo_pck.obter_data_venc_tit_terceiro(	to_char(b.qt_dia_venc),
									dt_mes_comp_lote_pc,
									c.dt_venc_titulo) dt_vencimento,
		b.nr_seq_classe_tit_pagar,
		b.nr_seq_trans_fin_baixa,
		b.nr_seq_trans_fin_contab,
		substr(wheb_mensagem_pck.get_texto(1110213, 'NR_SEQ_LOTE=' || nr_seq_lote_pc || ';' ||
								'NR_SEQ_LANC_PROGRAMADO=' || b.nr_sequencia || ';' || 
								'NR_SEQ_PRESTADOR=' || c.nr_seq_prestador) || 
								pls_util_pck.enter_w || wheb_mensagem_pck.get_texto(817948) || 
								wheb_mensagem_pck.get_texto(1110211) || '.', 1, 255) ds_observacao
	from	pls_pp_item_lote a,
		pls_pp_lanc_programado b,
		pls_pp_prestador c
	where	a.nr_seq_lote = nr_seq_lote_pc
	and	a.ie_tipo_item = '2'
	and	b.nr_sequencia = a.nr_seq_lanc_prog
	and	b.ie_titulo_pagar = 'S'
	and	c.nr_seq_lote = a.nr_seq_lote
	and	c.nr_seq_prestador = a.nr_seq_prestador;

BEGIN
select	max(coalesce(cd_estab_financeiro, cd_estabelecimento))
into STRICT	cd_estab_financeiro_w
from	estabelecimento
where	cd_estabelecimento	= cd_estabelecimento_p;

-- retorna todo os itens do pagamento que foram gerados por uma regra que o checkbox ie_titulo_pagar estiver checado

open c01(nr_seq_lote_p, pls_pp_lote_pagamento_pck.dt_mes_comp_lote_w);
loop
	fetch c01 bulk collect into 	tb_nr_seq_item_w, tb_cd_pessoa_fisica_w, tb_cd_cgc_w,
					tb_vl_item_w, tb_dt_movimento_w, tb_nr_classe_tit_pag_w, 
					tb_nr_trans_fin_baixa_w, tb_nr_trans_fin_cont_w, tb_obs_titulo_w
	limit pls_util_pck.qt_registro_transacao_w;
	exit when tb_nr_seq_item_w.count = 0;

	-- insere os titulos a pagar

	forall i in tb_vl_item_w.first..tb_vl_item_w.last
		insert into titulo_pagar(
				nr_titulo, nm_usuario, dt_atualizacao,
				cd_estabelecimento, vl_titulo, vl_saldo_titulo,
				dt_emissao, dt_contabil, dt_vencimento_original,
				dt_vencimento_atual, vl_saldo_juros, vl_saldo_multa,
				cd_moeda, cd_tipo_taxa_juro, cd_tipo_taxa_multa,
				tx_juros, tx_multa, ie_origem_titulo,
				ie_tipo_titulo, ie_situacao, cd_pessoa_fisica,
				cd_cgc, ie_pls, nr_lote_contabil,
				ds_observacao_titulo, nr_seq_classe, nr_seq_trans_fin_baixa,
				nr_seq_trans_fin_contab, cd_estab_financeiro
			) values (
				nextval('titulo_pagar_seq'), nm_usuario_p, clock_timestamp(),
				cd_estabelecimento_p, tb_vl_item_w(i), tb_vl_item_w(i),
				trunc(clock_timestamp(),'dd'), tb_dt_movimento_w(i), tb_dt_movimento_w(i),
				tb_dt_movimento_w(i), 0, 0,
				current_setting('pls_pp_gerar_titulo_pck.cd_moeda_padrao_pagar_w')::parametros_contas_pagar.cd_moeda_padrao%type, current_setting('pls_pp_gerar_titulo_pck.cd_tipo_taxa_juro_pag_w')::parametros_contas_pagar.cd_tipo_taxa_juro%type, current_setting('pls_pp_gerar_titulo_pck.cd_tipo_taxa_multa_pag_w')::parametros_contas_pagar.cd_tipo_taxa_multa%type,
				current_setting('pls_pp_gerar_titulo_pck.pr_juro_padrao_pag_w')::parametros_contas_pagar.pr_juro_padrao%type, current_setting('pls_pp_gerar_titulo_pck.pr_multa_padrao_pag_w')::parametros_contas_pagar.pr_multa_padrao%type, '25', -- OPS - Ocorrencia financeira
				'23', 'A', tb_cd_pessoa_fisica_w(i), -- Fatura 
				tb_cd_cgc_w(i), 'S', 0,
				tb_obs_titulo_w(i), tb_nr_classe_tit_pag_w(i), tb_nr_trans_fin_baixa_w(i), 
				tb_nr_trans_fin_cont_w(i), cd_estab_financeiro_w
			) returning nr_titulo bulk collect into tb_nr_titulo_pagar_w;
	commit;

	-- percorre todos os titulos inseridos

	for i in tb_nr_titulo_pagar_w.first..tb_nr_titulo_pagar_w.last loop

		CALL atualizar_inclusao_tit_pagar(	tb_nr_titulo_pagar_w(i), nm_usuario_p);
	end loop;

	-- salva o titulo que foi gerado no seu registro original

	forall i in tb_nr_seq_item_w.first..tb_nr_seq_item_w.last
		update	pls_pp_item_lote
		set	nr_tit_pagar_terceiro = tb_nr_titulo_pagar_w(i)
		where	nr_seq_lote = nr_seq_lote_p
		and	nr_sequencia = tb_nr_seq_item_w(i);
	commit;
end loop;
close c01;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_pp_gerar_titulo_pck.gerar_titulo_pagar_terceiro ( nr_seq_lote_p pls_pp_lote.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;
