-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



--vetor
CREATE OR REPLACE FUNCTION pls_fiscal_dados_dmed_pck.obter_valor_tributo_item_aprop ( vl_tributo_p bigint, nr_seq_item_mens_p pls_mensalidade_seg_item.nr_sequencia%type, nr_seq_item_mens_aprop_p pls_mens_seg_item_aprop.nr_sequencia%type) RETURNS bigint AS $body$
DECLARE


tx_percentual_aprop_item_w		double precision;
vl_tributo_item_apropriacao_w		double precision	:= 0;
vl_total_trib_item_aprop_w		double precision	:= 0;
qt_item_aprop_w				bigint	:= 0;

C01 CURSOR FOR
	SELECT	a.vl_apropriacao,
		a.nr_sequencia nr_seq_item_mens_aprop,
		(SELECT	count(1)
		from	pls_mens_seg_item_aprop x
		where	x.nr_seq_item = a.nr_seq_item) qt_item_aprop,
		(select	max(x.vl_item)
		from	pls_mensalidade_seg_item x
		where	x.nr_sequencia = a.nr_seq_item) vl_item
	from	pls_mens_seg_item_aprop a
	where	a.nr_seq_item = nr_seq_item_mens_p
	order by
		a.vl_apropriacao asc;

BEGIN

for r_c01_w in c01 loop
	begin
	qt_item_aprop_w	:= qt_item_aprop_w + 1;
	tx_percentual_aprop_item_w	:= r_c01_w.vl_apropriacao/r_c01_w.vl_item;
	vl_tributo_item_apropriacao_w	:= vl_tributo_p*tx_percentual_aprop_item_w;
	vl_total_trib_item_aprop_w	:= vl_total_trib_item_aprop_w + vl_tributo_item_apropriacao_w;
	
	if (qt_item_aprop_w = r_c01_w.qt_item_aprop) then
		if (vl_tributo_p <> vl_total_trib_item_aprop_w) then
			vl_tributo_item_apropriacao_w	:= vl_tributo_item_apropriacao_w + (vl_tributo_p - vl_total_trib_item_aprop_w);
		end if;
	end if;

	if (nr_seq_item_mens_aprop_p = r_c01_w.nr_seq_item_mens_aprop) then
		return vl_tributo_item_apropriacao_w;
	end if;
	end;
end loop;

return vl_tributo_item_apropriacao_w;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pls_fiscal_dados_dmed_pck.obter_valor_tributo_item_aprop ( vl_tributo_p bigint, nr_seq_item_mens_p pls_mensalidade_seg_item.nr_sequencia%type, nr_seq_item_mens_aprop_p pls_mens_seg_item_aprop.nr_sequencia%type) FROM PUBLIC;
