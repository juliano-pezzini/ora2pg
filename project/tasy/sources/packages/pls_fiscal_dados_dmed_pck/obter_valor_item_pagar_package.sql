-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pls_fiscal_dados_dmed_pck.obter_valor_item_pagar ( vl_item_p bigint, nr_seq_classif_ops_p bigint, nr_titulo_p bigint, cd_pessoa_reembolso_p bigint, cd_cgc_reembolso_p bigint) RETURNS bigint AS $body$
DECLARE


vl_total_item_baixa_w	double precision;


BEGIN

PERFORM set_config('pls_fiscal_dados_dmed_pck.vl_item_rateio_w', vl_item_p*current_setting('pls_fiscal_dados_dmed_pck.pr_baixa_w')::double, false);

if (current_setting('pls_fiscal_dados_dmed_pck.ie_ultima_baixa_w')::varchar(1) = 'S') then
	if (nr_seq_classif_ops_p IS NOT NULL AND nr_seq_classif_ops_p::text <> '') then
		select	sum(vl_item)
		into STRICT	vl_total_item_baixa_w
		from	fis_dados_dmed
		where	nr_titulo_pag = nr_titulo_p
		and	nr_seq_classif_ops = nr_seq_classif_ops_p;
	else
		select	sum(vl_item)
		into STRICT	vl_total_item_baixa_w
		from	fis_dados_dmed
		where	nr_titulo_pag = nr_titulo_p
		and	((cd_pessoa_reembolso = cd_pessoa_reembolso_p) or (cd_cgc_reembolso = cd_cgc_reembolso_p));
	end if;
		
	if	(vl_item_p <> (vl_total_item_baixa_w + current_setting('pls_fiscal_dados_dmed_pck.vl_item_rateio_w')::pls_mensalidade_seg_item.vl_item%type)) then
		PERFORM set_config('pls_fiscal_dados_dmed_pck.vl_item_rateio_w', current_setting('pls_fiscal_dados_dmed_pck.vl_item_rateio_w')::pls_mensalidade_seg_item.vl_item%type + (vl_item_p - (vl_total_item_baixa_w + current_setting('pls_fiscal_dados_dmed_pck.vl_item_rateio_w')::pls_mensalidade_seg_item.vl_item%type)), false);
	end if;
else
	if (current_setting('pls_fiscal_dados_dmed_pck.qt_total_itens_w')::bigint = current_setting('pls_fiscal_dados_dmed_pck.qt_item_w')::bigint) then
		if	(current_setting('pls_fiscal_dados_dmed_pck.vl_recebido_w')::titulo_receber_liq.vl_recebido%type <> (current_setting('pls_fiscal_dados_dmed_pck.vl_total_itens_w')::pls_mensalidade_seg_item.vl_item%type + current_setting('pls_fiscal_dados_dmed_pck.vl_item_rateio_w')::pls_mensalidade_seg_item.vl_item%type)) then
			PERFORM set_config('pls_fiscal_dados_dmed_pck.vl_item_rateio_w', current_setting('pls_fiscal_dados_dmed_pck.vl_item_rateio_w')::pls_mensalidade_seg_item.vl_item%type + (current_setting('pls_fiscal_dados_dmed_pck.vl_recebido_w')::titulo_receber_liq.vl_recebido%type - (current_setting('pls_fiscal_dados_dmed_pck.vl_total_itens_w')::pls_mensalidade_seg_item.vl_item%type + current_setting('pls_fiscal_dados_dmed_pck.vl_item_rateio_w')::pls_mensalidade_seg_item.vl_item%type)), false);
		end if;
	end if;
end if;

PERFORM set_config('pls_fiscal_dados_dmed_pck.vl_total_itens_w', current_setting('pls_fiscal_dados_dmed_pck.vl_total_itens_w')::pls_mensalidade_seg_item.vl_item%type + current_setting('pls_fiscal_dados_dmed_pck.vl_item_rateio_w')::pls_mensalidade_seg_item.vl_item%type, false);

PERFORM set_config('pls_fiscal_dados_dmed_pck.pr_item_w', (100/current_setting('pls_fiscal_dados_dmed_pck.vl_recebido_w')::titulo_receber_liq.vl_recebido%type) * current_setting('pls_fiscal_dados_dmed_pck.vl_item_rateio_w')::pls_mensalidade_seg_item.vl_item%type, false);

return current_setting('pls_fiscal_dados_dmed_pck.vl_item_rateio_w')::pls_mensalidade_seg_item.vl_item%type;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_fiscal_dados_dmed_pck.obter_valor_item_pagar ( vl_item_p bigint, nr_seq_classif_ops_p bigint, nr_titulo_p bigint, cd_pessoa_reembolso_p bigint, cd_cgc_reembolso_p bigint) FROM PUBLIC;
