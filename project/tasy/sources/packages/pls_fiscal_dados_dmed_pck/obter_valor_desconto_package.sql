-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pls_fiscal_dados_dmed_pck.obter_valor_desconto () RETURNS bigint AS $body$
DECLARE


vl_desconto_w		titulo_receber_liq.vl_descontos%type;
pr_item_desconto_w	double precision;


BEGIN

vl_desconto_w		:= 0;

if (current_setting('pls_fiscal_dados_dmed_pck.vl_recebido_desconto_w')::titulo_receber_liq.vl_descontos%type <> 0) then
	PERFORM set_config('pls_fiscal_dados_dmed_pck.vl_item_rateio_w', (current_setting('pls_fiscal_dados_dmed_pck.vl_item_rateio_w')::pls_mensalidade_seg_item.vl_item%type + current_setting('pls_fiscal_dados_dmed_pck.vl_juros_negociacao_item_w')::double + current_setting('pls_fiscal_dados_dmed_pck.vl_multa_negociacao_item_w')::double + current_setting('pls_fiscal_dados_dmed_pck.vl_taxa_negociacao_item_w')::double) - current_setting('pls_fiscal_dados_dmed_pck.vl_desconto_negociacao_item_w')::double, false);
	pr_item_desconto_w	:= (100/current_setting('pls_fiscal_dados_dmed_pck.vl_recebido_w')::titulo_receber_liq.vl_recebido%type) * current_setting('pls_fiscal_dados_dmed_pck.vl_item_rateio_w')::pls_mensalidade_seg_item.vl_item%type;
	
	if (coalesce(current_setting('pls_fiscal_dados_dmed_pck.vl_item_rateio_w')::pls_mensalidade_seg_item.vl_item%type, 0) <> 0) then
		vl_desconto_w	:= (pr_item_desconto_w/100) * current_setting('pls_fiscal_dados_dmed_pck.vl_recebido_desconto_w')::titulo_receber_liq.vl_descontos%type;
		
		if	((vl_desconto_w = 0) and (current_setting('pls_fiscal_dados_dmed_pck.vl_item_rateio_w')::pls_mensalidade_seg_item.vl_item%type > 0)) then
			vl_desconto_w := current_setting('pls_fiscal_dados_dmed_pck.vl_item_rateio_w')::pls_mensalidade_seg_item.vl_item%type;
		end if;

		if (current_setting('pls_fiscal_dados_dmed_pck.qt_total_itens_w')::bigint = current_setting('pls_fiscal_dados_dmed_pck.qt_item_w')::bigint) then
			if (current_setting('pls_fiscal_dados_dmed_pck.qt_outros_titulos_w')::bigint = 0) then
				if	((current_setting('pls_fiscal_dados_dmed_pck.vl_total_desconto_w')::titulo_receber_liq.vl_descontos%type + vl_desconto_w) <> current_setting('pls_fiscal_dados_dmed_pck.vl_recebido_desconto_w')::titulo_receber_liq.vl_descontos%type) then
					vl_desconto_w := vl_desconto_w + (current_setting('pls_fiscal_dados_dmed_pck.vl_recebido_desconto_w')::titulo_receber_liq.vl_descontos%type - (current_setting('pls_fiscal_dados_dmed_pck.vl_total_desconto_w')::titulo_receber_liq.vl_descontos%type + vl_desconto_w));
				end if;
			else
				if	((current_setting('pls_fiscal_dados_dmed_pck.vl_total_desconto_w')::titulo_receber_liq.vl_descontos%type + current_setting('pls_fiscal_dados_dmed_pck.vl_dif_desconto_baixa_tit_w')::double + vl_desconto_w) <> current_setting('pls_fiscal_dados_dmed_pck.vl_recebido_desconto_w')::titulo_receber_liq.vl_descontos%type) then
					vl_desconto_w := vl_desconto_w + (current_setting('pls_fiscal_dados_dmed_pck.vl_recebido_desconto_w')::titulo_receber_liq.vl_descontos%type - (current_setting('pls_fiscal_dados_dmed_pck.vl_total_desconto_w')::titulo_receber_liq.vl_descontos%type + current_setting('pls_fiscal_dados_dmed_pck.vl_dif_desconto_baixa_tit_w')::double + vl_desconto_w));
				end if;
			end if;
		elsif	(((current_setting('pls_fiscal_dados_dmed_pck.vl_total_desconto_w')::titulo_receber_liq.vl_descontos%type + vl_desconto_w) > current_setting('pls_fiscal_dados_dmed_pck.vl_recebido_desconto_w')::titulo_receber_liq.vl_descontos%type) and (current_setting('pls_fiscal_dados_dmed_pck.vl_item_rateio_w')::pls_mensalidade_seg_item.vl_item%type > 0)) then
			vl_desconto_w := 0;
		end if;
	end if;
end if;

PERFORM set_config('pls_fiscal_dados_dmed_pck.vl_total_desconto_w', current_setting('pls_fiscal_dados_dmed_pck.vl_total_desconto_w')::titulo_receber_liq.vl_descontos%type + vl_desconto_w, false);

return vl_desconto_w;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pls_fiscal_dados_dmed_pck.obter_valor_desconto () FROM PUBLIC;
