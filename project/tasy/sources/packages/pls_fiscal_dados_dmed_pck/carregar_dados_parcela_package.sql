-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_fiscal_dados_dmed_pck.carregar_dados_parcela () AS $body$
DECLARE


vl_taxa_negociacao_parcela_w	double precision;
vl_total_tx_neg_parc_w		double precision;
vl_desconto_neg_parcela_w	double precision;
vl_total_desconto_neg_parc_w	double precision;
vl_total_item_parcela_w		double precision;
vl_total_itens_parcela_w	double precision;
vl_juros_parcela_w		double precision;
vl_multa_parcela_w		double precision;
vl_total_juros_parcela_w	double precision;
vl_total_multa_parcela_w	double precision;
qt_parcela_w			bigint;
nr_seq_negociacao_titulo_w	bigint;
nr_seq_parcela_cr_titulo_w	bigint;
vl_juros_neg_ant_w		double precision;
vl_multa_neg_ant_w		double precision;
vl_total_juros_neg_ant_w	double precision;
vl_total_multa_neg_ant_w	double precision;
vl_total_taxa_neg_ant_w		double precision;
vl_total_desconto_neg_ant_w	double precision;
vl_juros_negociacao_baixado_w	double precision;
vl_multa_negociacao_baixado_w	double precision;
vl_juros_ant_parcela_w		double precision;
vl_multa_ant_parcela_w		double precision;
vl_taxa_neg_ant_parcela_w	double precision;
vl_desconto_neg_ant_parcela_w	double precision;
vl_total_multa_ant_parcela_w	double precision;
vl_total_juros_ant_parcela_w	double precision;
vl_total_tx_neg_ant_parcela_w	double precision;
vl_total_des_neg_ant_parcela_w	double precision;
vl_tudo_w			double precision;
vl_taxa_neg_ant_w		double precision;
vl_desconto_neg_ant_w		double precision;
vl_taxa_negociacao_baixado_w	double precision;
vl_desconto_negoc_baixado_w	double precision;
vl_total_parcelas_w		negociacao_cr_parcela.vl_parcela%type;
pr_parcela_w			double precision;

c01 CURSOR FOR
	SELECT	a.nr_sequencia,
		a.vl_parcela,
		b.vl_negociado,
		b.tx_negociacao,
		b.vl_desconto,
		b.vl_juros,
		b.vl_multa
	from	negociacao_cr_parcela a,
		negociacao_cr b
	where	b.nr_sequencia = a.nr_seq_negociacao
	and	a.nr_seq_negociacao = nr_seq_negociacao_p
	and	a.vl_parcela > 0
	order by
		a.nr_parcela asc;

c02 CURSOR FOR
	SELECT	b.nr_titulo,
		b.dt_pagamento_previsto,
		b.nr_seq_negociacao_origem
	from	titulo_rec_negociado a,
		titulo_receber b
	where	b.nr_titulo = a.nr_titulo
	and	a.nr_seq_negociacao = nr_seq_negociacao_p
	and	b.ie_origem_titulo = '4';
BEGIN

vl_total_itens_parcela_w	:= 0;
vl_total_tx_neg_parc_w		:= 0;
vl_total_desconto_neg_parc_w	:= 0;
vl_total_item_parcela_w		:= 0;
vl_desconto_neg_parcela_w	:= 0;
vl_taxa_negociacao_parcela_w	:= 0;
vl_total_multa_parcela_w	:= 0;
vl_total_juros_parcela_w	:= 0;
vl_juros_parcela_w		:= 0;
vl_multa_parcela_w		:= 0;
vl_juros_neg_ant_w		:= 0;
vl_multa_neg_ant_w		:= 0;
vl_total_juros_neg_ant_w	:= 0;
vl_total_multa_neg_ant_w	:= 0;
vl_juros_ant_parcela_w		:= 0;
vl_multa_ant_parcela_w		:= 0;
vl_total_multa_ant_parcela_w	:= 0;
vl_total_juros_ant_parcela_w	:= 0;
vl_taxa_neg_ant_w		:= 0;
vl_desconto_neg_ant_w		:= 0;
vl_taxa_negociacao_baixado_w	:= 0;
vl_desconto_negoc_baixado_w	:= 0;
vl_total_tx_neg_ant_parcela_w	:= 0;
vl_total_des_neg_ant_parcela_w	:= 0;
vl_total_taxa_neg_ant_w		:= 0;
vl_total_desconto_neg_ant_w	:= 0;

select	count(1),
	sum(vl_parcela)
into STRICT	qt_parcela_w,
	vl_total_parcelas_w
from	negociacao_cr_parcela
where	nr_seq_negociacao = nr_seq_negociacao_p
and	vl_parcela > 0;

for r_c02_w in c02 loop
	begin
	if (r_c02_w.nr_seq_negociacao_origem IS NOT NULL AND r_c02_w.nr_seq_negociacao_origem::text <> '') then
		select	coalesce(sum(a.vl_juros_negociacao_ant),0) + coalesce(sum(a.vl_juros_negociacao),0),
			coalesce(sum(a.vl_multa_negociacao_ant),0) + coalesce(sum(a.vl_multa_negociacao),0),
			coalesce(sum(a.vl_taxa_negociacao_ant),0) + coalesce(sum(a.vl_taxa_negociacao),0),
			coalesce(sum(a.vl_desconto_negociacao_ant),0) + coalesce(sum(a.vl_desconto_negociacao),0)
		into STRICT	vl_juros_neg_ant_w,
			vl_multa_neg_ant_w,
			vl_taxa_neg_ant_w,
			vl_desconto_neg_ant_w
		from	pls_negociacao_mens_fiscal a,
			negociacao_cr_parcela b
		where	b.nr_sequencia = a.nr_seq_parcela
		and	b.nr_seq_negociacao = r_c02_w.nr_seq_negociacao_origem;
	else
		obter_negociacao_parcela(r_c02_w.nr_titulo, r_c02_w.dt_pagamento_previsto, nr_seq_negociacao_titulo_w, nr_seq_parcela_cr_titulo_w);
		
		if (nr_seq_parcela_cr_titulo_w IS NOT NULL AND nr_seq_parcela_cr_titulo_w::text <> '') then
			select	coalesce(sum(vl_juros_negociacao),0) + coalesce(sum(vl_juros_negociacao_ant),0),
				coalesce(sum(vl_multa_negociacao),0) + coalesce(sum(vl_multa_negociacao_ant),0),
				coalesce(sum(vl_taxa_negociacao),0) + coalesce(sum(vl_taxa_negociacao_ant),0),
				coalesce(sum(vl_desconto_negociacao),0) + coalesce(sum(vl_desconto_negociacao_ant),0)
			into STRICT	vl_juros_neg_ant_w,
				vl_multa_neg_ant_w,
				vl_taxa_neg_ant_w,
				vl_desconto_neg_ant_w
			from	pls_negociacao_mens_fiscal
			where	nr_seq_parcela = nr_seq_parcela_cr_titulo_w;
		end if;
	end if;
	
	select	coalesce(sum(a.vl_juros_negociacao),0),
		coalesce(sum(a.vl_multa_negociacao),0),
		coalesce(sum(a.vl_taxa_negociacao),0),
		coalesce(sum(a.vl_desconto_negociacao),0)
	into STRICT	vl_juros_negociacao_baixado_w,
		vl_multa_negociacao_baixado_w,
		vl_taxa_negociacao_baixado_w,
		vl_desconto_negoc_baixado_w
	from	fis_dados_dmed a,
		titulo_receber_liq b
	where	b.nr_titulo = a.nr_titulo_rec
	and	b.nr_sequencia = a.nr_seq_baixa_rec
	and	coalesce(b.nr_seq_negociacao_cr::text, '') = ''
	and	b.nr_titulo = r_c02_w.nr_titulo;
	
	vl_total_juros_neg_ant_w	:= vl_total_juros_neg_ant_w + (vl_juros_neg_ant_w - vl_juros_negociacao_baixado_w);
	vl_total_multa_neg_ant_w	:= vl_total_multa_neg_ant_w + (vl_multa_neg_ant_w - vl_multa_negociacao_baixado_w);
	vl_total_taxa_neg_ant_w		:= vl_total_taxa_neg_ant_w + (vl_taxa_neg_ant_w - vl_taxa_negociacao_baixado_w);
	vl_total_desconto_neg_ant_w	:= vl_total_desconto_neg_ant_w + (vl_desconto_neg_ant_w - vl_desconto_negoc_baixado_w);
	end;
end loop;

for r_c01_w in c01 loop
	begin
	qt_parcela_vetor_w		:= qt_parcela_vetor_w + 1;
	pr_parcela_w			:= r_c01_w.vl_parcela/vl_total_parcelas_w;
	vl_total_item_parcela_w		:= (r_c01_w.vl_negociado*pr_parcela_w);
	vl_taxa_negociacao_parcela_w	:= (r_c01_w.tx_negociacao*pr_parcela_w);
	vl_desconto_neg_parcela_w	:= (r_c01_w.vl_desconto*pr_parcela_w);
	vl_juros_parcela_w		:= (r_c01_w.vl_juros*pr_parcela_w);
	vl_multa_parcela_w		:= (r_c01_w.vl_multa*pr_parcela_w);
	vl_juros_ant_parcela_w		:= (vl_total_juros_neg_ant_w*pr_parcela_w);
	vl_multa_ant_parcela_w		:= (vl_total_multa_neg_ant_w*pr_parcela_w);
	vl_taxa_neg_ant_parcela_w	:= (vl_total_taxa_neg_ant_w*pr_parcela_w);
	vl_desconto_neg_ant_parcela_w	:= (vl_total_desconto_neg_ant_w*pr_parcela_w);

	vl_total_item_parcela_w		:= (vl_total_item_parcela_w - ((vl_juros_ant_parcela_w + vl_multa_ant_parcela_w + vl_taxa_neg_ant_parcela_w) - vl_desconto_neg_ant_parcela_w));

	if (qt_parcela_vetor_w = qt_parcela_w) then
		if	(vl_total_juros_neg_ant_w <> (vl_total_juros_ant_parcela_w + vl_juros_ant_parcela_w)) then
			vl_juros_ant_parcela_w	:= vl_juros_ant_parcela_w + (vl_total_juros_neg_ant_w - (vl_total_juros_ant_parcela_w + vl_juros_ant_parcela_w));
		end if;
		
		if	(vl_total_multa_neg_ant_w <> (vl_total_multa_ant_parcela_w + vl_multa_ant_parcela_w)) then
			vl_multa_ant_parcela_w	:= vl_multa_ant_parcela_w + (vl_total_multa_neg_ant_w - (vl_total_multa_ant_parcela_w + vl_multa_ant_parcela_w));
		end if;
	
		if	(vl_total_taxa_neg_ant_w <> (vl_total_tx_neg_ant_parcela_w + vl_taxa_neg_ant_parcela_w)) then
			vl_taxa_neg_ant_parcela_w := vl_taxa_neg_ant_parcela_w + (vl_total_taxa_neg_ant_w - (vl_total_tx_neg_ant_parcela_w + vl_taxa_neg_ant_parcela_w));
		end if;
		
		if	(vl_total_desconto_neg_ant_w <> (vl_total_des_neg_ant_parcela_w + vl_desconto_neg_ant_parcela_w)) then
			vl_desconto_neg_ant_parcela_w	:= vl_desconto_neg_ant_parcela_w + (vl_total_desconto_neg_ant_w - (vl_total_des_neg_ant_parcela_w + vl_desconto_neg_ant_parcela_w));
		end if;
	
		if	((r_c01_w.vl_negociado - ((vl_total_juros_neg_ant_w + vl_total_multa_neg_ant_w + vl_total_taxa_neg_ant_w) - vl_total_desconto_neg_ant_w)) <> (vl_total_itens_parcela_w + vl_total_item_parcela_w)) then
			vl_total_item_parcela_w	:= vl_total_item_parcela_w + ((r_c01_w.vl_negociado - ((vl_total_juros_neg_ant_w + vl_total_multa_neg_ant_w + vl_total_taxa_neg_ant_w) - vl_total_desconto_neg_ant_w)) - (vl_total_itens_parcela_w + vl_total_item_parcela_w));
		end if;
	
		if	(r_c01_w.tx_negociacao <> (vl_total_tx_neg_parc_w + vl_taxa_negociacao_parcela_w)) then
			vl_taxa_negociacao_parcela_w	:= vl_taxa_negociacao_parcela_w + (r_c01_w.tx_negociacao - (vl_total_tx_neg_parc_w + vl_taxa_negociacao_parcela_w));
		end if;
		
		if	(r_c01_w.vl_desconto <> (vl_total_desconto_neg_parc_w + vl_desconto_neg_parcela_w)) then
			vl_desconto_neg_parcela_w	:= vl_desconto_neg_parcela_w + (r_c01_w.vl_desconto - (vl_total_desconto_neg_parc_w + vl_desconto_neg_parcela_w));
		end if;
		
		if	(r_c01_w.vl_juros <> (vl_total_juros_parcela_w + vl_juros_parcela_w)) then
			vl_juros_parcela_w	:= vl_juros_parcela_w + (r_c01_w.vl_juros - (vl_total_juros_parcela_w + vl_juros_parcela_w));
		end if;
		
		if	(r_c01_w.vl_multa <> (vl_total_multa_parcela_w + vl_multa_parcela_w)) then
			vl_multa_parcela_w	:= vl_multa_parcela_w + (r_c01_w.vl_multa - (vl_total_multa_parcela_w + vl_multa_parcela_w));
		end if;
	else
		vl_tudo_w	:= (((vl_total_item_parcela_w + vl_taxa_negociacao_parcela_w + vl_juros_parcela_w + vl_multa_parcela_w + vl_juros_ant_parcela_w + vl_multa_ant_parcela_w + vl_taxa_neg_ant_parcela_w) - vl_desconto_neg_parcela_w) - vl_desconto_neg_ant_parcela_w);

		if (r_c01_w.vl_parcela <> vl_tudo_w) then
			if (vl_taxa_negociacao_parcela_w > 0) then
				vl_taxa_negociacao_parcela_w	:= vl_taxa_negociacao_parcela_w + (r_c01_w.vl_parcela - vl_tudo_w);
			elsif (vl_desconto_neg_parcela_w > 0) then
				vl_desconto_neg_parcela_w	:= vl_desconto_neg_parcela_w + (r_c01_w.vl_parcela - vl_tudo_w);
			elsif (vl_juros_parcela_w > 0) then
				vl_juros_parcela_w		:= vl_juros_parcela_w + (r_c01_w.vl_parcela - vl_tudo_w);
			elsif (vl_multa_parcela_w > 0) then
				vl_multa_parcela_w		:= vl_multa_parcela_w + (r_c01_w.vl_parcela - vl_tudo_w);
			elsif (vl_juros_ant_parcela_w > 0) then
				vl_juros_ant_parcela_w		:= vl_juros_ant_parcela_w + (r_c01_w.vl_parcela - vl_tudo_w);
			elsif (vl_multa_ant_parcela_w > 0) then
				vl_multa_ant_parcela_w		:= vl_multa_ant_parcela_w + (r_c01_w.vl_parcela - vl_tudo_w);
			elsif (vl_taxa_neg_ant_parcela_w > 0) then
				vl_taxa_neg_ant_parcela_w	:= vl_taxa_neg_ant_parcela_w + (r_c01_w.vl_parcela - vl_tudo_w);
			elsif (vl_desconto_neg_ant_parcela_w > 0) then
				vl_desconto_neg_ant_parcela_w	:= vl_desconto_neg_ant_parcela_w + (r_c01_w.vl_parcela - vl_tudo_w);
			else
				vl_total_item_parcela_w		:= vl_total_item_parcela_w + (r_c01_w.vl_parcela - vl_tudo_w);
			end if;
		end if;
	end if;

	vl_total_itens_parcela_w	:= vl_total_itens_parcela_w + vl_total_item_parcela_w;
	vl_total_tx_neg_parc_w		:= vl_total_tx_neg_parc_w + vl_taxa_negociacao_parcela_w;
	vl_total_desconto_neg_parc_w	:= vl_total_desconto_neg_parc_w + vl_desconto_neg_parcela_w;
	vl_total_multa_parcela_w	:= vl_total_multa_parcela_w + vl_multa_parcela_w;
	vl_total_juros_parcela_w	:= vl_total_juros_parcela_w + vl_juros_parcela_w;
	vl_total_multa_ant_parcela_w	:= vl_total_multa_ant_parcela_w + vl_multa_ant_parcela_w;
	vl_total_juros_ant_parcela_w	:= vl_total_juros_ant_parcela_w + vl_juros_ant_parcela_w;
	vl_total_tx_neg_ant_parcela_w	:= vl_total_tx_neg_ant_parcela_w + vl_taxa_neg_ant_parcela_w;
	vl_total_des_neg_ant_parcela_w	:= vl_total_des_neg_ant_parcela_w + vl_desconto_neg_ant_parcela_w;

	tb_vl_taxa_neg_ant_parcela_w(qt_parcela_vetor_w)	:= vl_taxa_neg_ant_parcela_w;
	tb_vl_desc_neg_ant_parcela_w(qt_parcela_vetor_w)	:= vl_desconto_neg_ant_parcela_w;
	tb_vl_juros_ant_parcela_w(qt_parcela_vetor_w)		:= vl_juros_ant_parcela_w;
	tb_vl_multa_ant_parcela_w(qt_parcela_vetor_w)		:= vl_multa_ant_parcela_w;
	tb_vl_juros_parcela_w(qt_parcela_vetor_w)		:= vl_juros_parcela_w;
	tb_vl_multa_parcela_w(qt_parcela_vetor_w)		:= vl_multa_parcela_w;
	tb_vl_desconto_neg_parc_w(qt_parcela_vetor_w)		:= vl_desconto_neg_parcela_w;
	tb_vl_taxa_negociacao_parc_w(qt_parcela_vetor_w)	:= vl_taxa_negociacao_parcela_w;
	tb_vl_total_itens_parc_w(qt_parcela_vetor_w)		:= vl_total_item_parcela_w;
	tb_nr_seq_parcela_w(qt_parcela_vetor_w)			:= r_c01_w.nr_sequencia;
	tb_vl_parcela_w(qt_parcela_vetor_w)			:= r_c01_w.vl_parcela;
	tb_pr_parcela_w(qt_parcela_vetor_w)			:= pr_parcela_w;
	end;
end loop;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_fiscal_dados_dmed_pck.carregar_dados_parcela () FROM PUBLIC;
