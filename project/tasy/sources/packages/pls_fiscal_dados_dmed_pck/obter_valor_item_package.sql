-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pls_fiscal_dados_dmed_pck.obter_valor_item ( vl_item_p pls_mensalidade_seg_item.vl_item%type, nr_seq_item_p pls_mensalidade_seg_item.nr_sequencia%type, nr_seq_item_mens_aprop_p pls_mens_seg_item_aprop.nr_sequencia%type, nr_titulo_p titulo_receber.nr_titulo%type) RETURNS bigint AS $body$
DECLARE


vl_total_item_w		pls_mensalidade_seg_item.vl_item%type;


BEGIN

PERFORM set_config('pls_fiscal_dados_dmed_pck.qt_item_w', current_setting('pls_fiscal_dados_dmed_pck.qt_item_w')::bigint + 1, false);

if (current_setting('pls_fiscal_dados_dmed_pck.ie_baixa_rec_maior_w')::varchar(1) = 'S') then
	vl_total_item_w	:= 0;
else
	if (nr_seq_item_mens_aprop_p IS NOT NULL AND nr_seq_item_mens_aprop_p::text <> '') then
		select	coalesce(sum(vl_item), 0)
		into STRICT	vl_total_item_w
		from	fis_dados_dmed
		where	nr_seq_item_mens_aprop = nr_seq_item_mens_aprop_p
		and	nr_seq_item_mens = nr_seq_item_p
		and	nr_titulo_rec = nr_titulo_p;
	else
		select	coalesce(sum(vl_item), 0)
		into STRICT	vl_total_item_w
		from	fis_dados_dmed
		where	nr_seq_item_mens = nr_seq_item_p
		and	nr_titulo_rec = nr_titulo_p;
	end if;
end if;

PERFORM set_config('pls_fiscal_dados_dmed_pck.vl_item_rateio_w', vl_item_p * current_setting('pls_fiscal_dados_dmed_pck.pr_baixa_w')::double, false);

if (current_setting('pls_fiscal_dados_dmed_pck.ie_baixa_rec_maior_w')::varchar(1) = 'N') then
	if (current_setting('pls_fiscal_dados_dmed_pck.ie_ultima_baixa_w')::varchar(1) = 'S') then
		if	((vl_total_item_w + current_setting('pls_fiscal_dados_dmed_pck.vl_item_rateio_w')::pls_mensalidade_seg_item.vl_item%type) <> vl_item_p) then
			PERFORM set_config('pls_fiscal_dados_dmed_pck.vl_item_rateio_w', current_setting('pls_fiscal_dados_dmed_pck.vl_item_rateio_w')::pls_mensalidade_seg_item.vl_item%type + (vl_item_p - (vl_total_item_w + current_setting('pls_fiscal_dados_dmed_pck.vl_item_rateio_w')::pls_mensalidade_seg_item.vl_item%type)), false);
		end if;
	else
		if (current_setting('pls_fiscal_dados_dmed_pck.qt_total_itens_w')::bigint = current_setting('pls_fiscal_dados_dmed_pck.qt_item_w')::bigint) then
			if (current_setting('pls_fiscal_dados_dmed_pck.qt_outros_titulos_w')::bigint = 0) then
				if	(current_setting('pls_fiscal_dados_dmed_pck.vl_recebido_w')::titulo_receber_liq.vl_recebido%type <> (current_setting('pls_fiscal_dados_dmed_pck.vl_total_itens_w')::pls_mensalidade_seg_item.vl_item%type + current_setting('pls_fiscal_dados_dmed_pck.vl_item_rateio_w')::pls_mensalidade_seg_item.vl_item%type)) then
					PERFORM set_config('pls_fiscal_dados_dmed_pck.vl_item_rateio_w', current_setting('pls_fiscal_dados_dmed_pck.vl_item_rateio_w')::pls_mensalidade_seg_item.vl_item%type + (current_setting('pls_fiscal_dados_dmed_pck.vl_recebido_w')::titulo_receber_liq.vl_recebido%type - (current_setting('pls_fiscal_dados_dmed_pck.vl_total_itens_w')::pls_mensalidade_seg_item.vl_item%type + current_setting('pls_fiscal_dados_dmed_pck.vl_item_rateio_w')::pls_mensalidade_seg_item.vl_item%type)), false);
				end if;
			else
				if	(current_setting('pls_fiscal_dados_dmed_pck.vl_recebido_w')::titulo_receber_liq.vl_recebido%type <> (current_setting('pls_fiscal_dados_dmed_pck.vl_total_itens_w')::pls_mensalidade_seg_item.vl_item%type + current_setting('pls_fiscal_dados_dmed_pck.vl_diferenca_baixa_outro_tit_w')::double + current_setting('pls_fiscal_dados_dmed_pck.vl_item_rateio_w')::pls_mensalidade_seg_item.vl_item%type)) then
					PERFORM set_config('pls_fiscal_dados_dmed_pck.vl_item_rateio_w', current_setting('pls_fiscal_dados_dmed_pck.vl_item_rateio_w')::pls_mensalidade_seg_item.vl_item%type + (current_setting('pls_fiscal_dados_dmed_pck.vl_recebido_w')::titulo_receber_liq.vl_recebido%type - (current_setting('pls_fiscal_dados_dmed_pck.vl_total_itens_w')::pls_mensalidade_seg_item.vl_item%type + current_setting('pls_fiscal_dados_dmed_pck.vl_diferenca_baixa_outro_tit_w')::double + current_setting('pls_fiscal_dados_dmed_pck.vl_item_rateio_w')::pls_mensalidade_seg_item.vl_item%type)), false);
				end if;
			end if;
		elsif	((((vl_total_item_w + current_setting('pls_fiscal_dados_dmed_pck.vl_item_rateio_w')::pls_mensalidade_seg_item.vl_item%type) > vl_item_p) or ((current_setting('pls_fiscal_dados_dmed_pck.vl_total_itens_w')::pls_mensalidade_seg_item.vl_item%type + current_setting('pls_fiscal_dados_dmed_pck.vl_item_rateio_w')::pls_mensalidade_seg_item.vl_item%type) > current_setting('pls_fiscal_dados_dmed_pck.vl_recebido_w')::titulo_receber_liq.vl_recebido%type)) and (vl_item_p > 0)) then
			PERFORM set_config('pls_fiscal_dados_dmed_pck.vl_item_rateio_w', 0, false);
		end if;
	end if;
end if;

PERFORM set_config('pls_fiscal_dados_dmed_pck.vl_total_itens_w', current_setting('pls_fiscal_dados_dmed_pck.vl_total_itens_w')::pls_mensalidade_seg_item.vl_item%type + current_setting('pls_fiscal_dados_dmed_pck.vl_item_rateio_w')::pls_mensalidade_seg_item.vl_item%type, false);

PERFORM set_config('pls_fiscal_dados_dmed_pck.pr_item_w', (100/current_setting('pls_fiscal_dados_dmed_pck.vl_recebido_w')::titulo_receber_liq.vl_recebido%type) * current_setting('pls_fiscal_dados_dmed_pck.vl_item_rateio_w')::pls_mensalidade_seg_item.vl_item%type, false);

if (current_setting('pls_fiscal_dados_dmed_pck.ie_baixa_rec_maior_w')::varchar(1) = 'S') then
	return 0;
else
	return current_setting('pls_fiscal_dados_dmed_pck.vl_item_rateio_w')::pls_mensalidade_seg_item.vl_item%type;
end if;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pls_fiscal_dados_dmed_pck.obter_valor_item ( vl_item_p pls_mensalidade_seg_item.vl_item%type, nr_seq_item_p pls_mensalidade_seg_item.nr_sequencia%type, nr_seq_item_mens_aprop_p pls_mens_seg_item_aprop.nr_sequencia%type, nr_titulo_p titulo_receber.nr_titulo%type) FROM PUBLIC;
