-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION wheb_exportar_hl7_pck.obtem_valor (ar_result_query_sup_p myArray, nm_atributo_w text, ie_tipo_atributo_w text, ds_mascara_p text) RETURNS varchar AS $body$
DECLARE

	ds_valor_w		text			:= '';
	ds_valor_aux_w		text			:= '';
	ds_mascara_aux_w	varchar(20);
	ds_mascara_w 		varchar(60);
	atributo_w		varchar(32000)		:= '';
	nr_seq_atrib_segm_ant_w	bigint		:= 0;
	
BEGIN
	ds_mascara_w := ds_mascara_p;
	/*Verifica o valor do atributo nos parametro do projeto*/

	ds_valor_w := wheb_exportar_hl7_pck.obter_valor_parametro(nm_atributo_w,current_setting('wheb_exportar_hl7_pck.ar_parametros_w')::myArray);
	ds_valor_aux_w := null;
	if ( coalesce(ds_valor_w::text, '') = '') then
		/*Verifica o valor do atributo na query superior*/

		ds_valor_aux_w := wheb_exportar_hl7_pck.obter_valor_parametro(nm_atributo_w,ar_result_query_sup_p);
		if ( coalesce(ds_valor_aux_w::text, '') = '' ) then
			/*Verifica o valor do atributo no array com todas as colunas*/

			ds_valor_aux_w := wheb_exportar_hl7_pck.obter_valor_parametro(nm_atributo_w,current_setting('wheb_exportar_hl7_pck.ar_result_todos_sql_p')::myArray);
		end if;
		if (ds_valor_aux_w IS NOT NULL AND ds_valor_aux_w::text <> '') then
			ds_valor_w := ds_valor_aux_w;
		end if;
	end if;

	if (ds_valor_w IS NOT NULL AND ds_valor_w::text <> '') then
		if ( ie_tipo_atributo_w = 'DATE' ) then
			if (ds_mascara_w IS NOT NULL AND ds_mascara_w::text <> '') then
			begin
			    if ( position('HH' in upper(ds_mascara_w)) > 0 ) then
				ds_mascara_w := replace(ds_mascara_w,'hh','hh24');
				ds_mascara_w := replace(ds_mascara_w,'HH','hh24');
				ds_mascara_w := replace(ds_mascara_w,':MM',':mi');
				ds_mascara_w := replace(ds_mascara_w,':mm',':mi');
				ds_mascara_w := replace(ds_mascara_w,'SS','ss');
			    end if;
			    if (substr(nm_atributo_w,1,3) = 'HR_') then
				ds_valor_w := to_char(to_date(ds_valor_w,'hh24:mi:ss'),ds_mascara_w);
			    else
				ds_valor_w := to_char(to_date(ds_valor_w,'dd/mm/yyyy hh24:mi:ss'),ds_mascara_w);
			    end if;
			exception
			when OTHERS then
				ds_mascara_w := ds_mascara_w;
			end;
			end if;
		elsif ( ie_tipo_atributo_w = 'NUMBER' ) then
			if (ds_mascara_w IS NOT NULL AND ds_mascara_w::text <> '') then
				ds_mascara_aux_w := substr(ds_mascara_w,position('.' in ds_mascara_w)+1,length(ds_mascara_w));
				ds_mascara_w := '999999990.';
				for contador_w in 1..length(ds_mascara_aux_w) loop
					ds_mascara_w := ds_mascara_w || '9';
				end loop;
				ds_valor_w := to_char((ds_valor_w)::numeric ,ds_mascara_w);
			end if;
		end if;
	end if;

	ds_valor_w := ds_valor_w;
	PERFORM set_config('wheb_exportar_hl7_pck.qt_controle_chr_w', 0, false);

	while( position(chr(13) in ds_valor_w) > 0 ) and ( current_setting('wheb_exportar_hl7_pck.qt_controle_chr_w')::bigint < 100 ) loop
		ds_valor_w := replace(ds_valor_w,chr(13),'');
		PERFORM set_config('wheb_exportar_hl7_pck.qt_controle_chr_w', current_setting('wheb_exportar_hl7_pck.qt_controle_chr_w')::bigint + 1, false);
	end loop;
	
	PERFORM set_config('wheb_exportar_hl7_pck.qt_controle_chr_w', 0, false);

	while( position(chr(10) in ds_valor_w) > 0 ) and ( current_setting('wheb_exportar_hl7_pck.qt_controle_chr_w')::bigint < 100 ) loop
		ds_valor_w := replace(ds_valor_w,chr(10),'');
		PERFORM set_config('wheb_exportar_hl7_pck.qt_controle_chr_w', current_setting('wheb_exportar_hl7_pck.qt_controle_chr_w')::bigint + 1, false);
	end loop;
	return ds_valor_w;
	end;

	 /*
	  nr_seq_mensagem_p in NUMBER - identificador da mensagem (pode ser vista no Gerenciador de HL7)
	  nr_seq_log_p in NUMBER - identificador para a tabela de log
	  ds_parametros_p in VARCHAR2 - parametros a serem utilizados no sql.
	  Passagem de parametros no seguinte formato Ex: nm_para_1=valor_param_1;nm_param_2=valor_param_2
	  
	  Ponto de entrada para a geração do HL7.
	  Irá gerar a mensagem corresponte com o indentificador de log definido na tabela log_integracao_hl7.
	  */
$body$
LANGUAGE PLPGSQL
 STABLE;
-- REVOKE ALL ON FUNCTION wheb_exportar_hl7_pck.obtem_valor (ar_result_query_sup_p myArray, nm_atributo_w text, ie_tipo_atributo_w text, ds_mascara_p text) FROM PUBLIC;
