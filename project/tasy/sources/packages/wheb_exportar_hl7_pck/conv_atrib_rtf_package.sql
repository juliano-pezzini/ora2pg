-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE wheb_exportar_hl7_pck.conv_atrib_rtf (ds_sql_consulta_p text,ar_result_query_sup_p myArray,ie_tipo_conversao_p text) AS $body$
DECLARE

	nr_sequencia_w 		bigint;
	contador_w		bigint;
	ds_parametros_sql_w	varchar(32000);
	ds_valor_w		varchar(2000);
	ar_nm_param_sql_rtf_w	myArray;
	ds_rtf_string_aux_w	text;
	ds_aux_w		varchar(10);
	
BEGIN
		PERFORM set_config('wheb_exportar_hl7_pck.ds_rtf_string_w', null, false);
		
		ar_nm_param_sql_rtf_w := wheb_exportar_hl7_pck.armazena_parametros_sql(ds_sql_consulta_p, ar_nm_param_sql_rtf_w);
		
		for contador_w in 1..ar_nm_param_sql_rtf_w.count loop
			ds_valor_w := wheb_exportar_hl7_pck.obtem_valor(ar_result_query_sup_p,ar_nm_param_sql_rtf_w[contador_w].nm,null,null);
			if (ds_parametros_sql_w IS NOT NULL AND ds_parametros_sql_w::text <> '') then
				ds_parametros_sql_w := ds_parametros_sql_w || current_setting('wheb_exportar_hl7_pck.ds_sep_bv_w')::varchar(100);
			end if;
			ds_parametros_sql_w := ds_parametros_sql_w || ds_valor_w;
		end loop;
		if (ie_tipo_conversao_p = '1') then
			converte_rtf_string(ds_sql_consulta_p,ds_parametros_sql_w,'HL7',nr_sequencia_w);
		elsif (ie_tipo_conversao_p = '2') then
			converte_rtf_html(ds_sql_consulta_p,ds_parametros_sql_w,'HL7',nr_sequencia_w);
		end if;
		
		select 	ds_texto_clob
		into STRICT	ds_rtf_string_aux_w
		from	tasy_conversao_rtf
		where	nr_sequencia = nr_sequencia_w;
		
		for i in 1..length(ds_rtf_string_aux_w) loop
			begin
				ds_aux_w := substr(ds_rtf_string_aux_w,i,1);
				
				if (ds_aux_w = current_setting('wheb_exportar_hl7_pck.ds_sep_comp_w')::varchar(1)) or (ds_aux_w = current_setting('wheb_exportar_hl7_pck.ds_repeticao_w')::varchar(1)) or (ds_aux_w = current_setting('wheb_exportar_hl7_pck.ds_separador_w')::varchar(1)) or (ds_aux_w = current_setting('wheb_exportar_hl7_pck.ds_subcomp_w')::varchar(1)) then
					ds_aux_w := current_setting('wheb_exportar_hl7_pck.ds_escape_w')::varchar(1) || ds_aux_w;
				elsif (ds_aux_w = chr(13)) then
					ds_aux_w := '';
				elsif ((ds_aux_w = chr(10)) and (position('NAOCONVERTEQUEBRA' in current_setting('wheb_exportar_hl7_pck.ds_regra_w')::varchar(255)) = 0)) then
					ds_aux_w := '\.br\';
				end if;
				PERFORM set_config('wheb_exportar_hl7_pck.ds_rtf_string_w', current_setting('wheb_exportar_hl7_pck.ds_rtf_string_w')::text || ds_aux_w, false);
			end;
		end loop;
		
	end;
	
	 /*
	  Atributos são quem armazenam as informações no HL7.
	  Não podem agrupar elemento qualquer.  
	  Pode operar como orquestrador de repetição.
	  */
$body$
LANGUAGE PLPGSQL
;
-- REVOKE ALL ON PROCEDURE wheb_exportar_hl7_pck.conv_atrib_rtf (ds_sql_consulta_p text,ar_result_query_sup_p myArray,ie_tipo_conversao_p text) FROM PUBLIC;
