-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_pp_lote_retencao_pck.ajuste_estorno_carta ( nr_seq_lote_p pls_pp_lr_lote.nr_sequencia%type) AS $body$
DECLARE


-- Carta de retenção com valor negativo
c01 CURSOR(	nr_seq_lote_pc	pls_pp_lr_lote.nr_sequencia%type) FOR
	SELECT	p.nr_sequencia,
		(SELECT sum(c.vl_base)
		from	pls_pp_lr_base_trib c
		where	p.nr_sequencia	= c.nr_seq_trib_pessoa
		and	c.ie_origem	= 'CR'
		and	c.vl_base	< 0) vl_carta_negativa, -- Buscar carta negativa
		(select sum(c.vl_base)
		from	pls_pp_lr_base_trib c
		where	p.nr_sequencia	= c.nr_seq_trib_pessoa
		and	c.ie_origem	= 'CR'
		and	c.vl_base	> 0) vl_carta_positiva  -- Buscar carta positiva
	from	pls_pp_lr_trib_pessoa p,
		tributo t
	where	t.cd_tributo		= p.cd_tributo
	and	p.nr_seq_lote_ret	= nr_seq_lote_pc
	and	t.ie_tipo_tributo 	= 'INSS'; -- Somente INSS
BEGIN
for r_c01_w in c01( nr_seq_lote_p ) loop
	-- Se existe carta e estorno da carta
	if (r_c01_w.vl_carta_negativa != 0) and -- Estorno carta
		(r_c01_w.vl_carta_positiva != 0) and -- Carta
		(abs(r_c01_w.vl_carta_negativa) <= abs(r_c01_w.vl_carta_positiva)) then -- Estorno tem que ser menor ou igual	
		update	pls_pp_lr_trib_pessoa
		set	vl_base_calculo		= coalesce(vl_base_calculo,0) + abs(r_c01_w.vl_carta_negativa), -- Adciona diferença na base de calculo
			vl_base_pgto		= coalesce(vl_base_pgto,0) + abs(r_c01_w.vl_carta_negativa), -- Adciona diferença na base de calculo
			vl_base_acumulada	= abs(r_c01_w.vl_carta_positiva) - abs(r_c01_w.vl_carta_negativa) -- Estorna valor da carta
		where	nr_sequencia		= r_c01_w.nr_sequencia;
	end if;
end loop;
commit;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_pp_lote_retencao_pck.ajuste_estorno_carta ( nr_seq_lote_p pls_pp_lr_lote.nr_sequencia%type) FROM PUBLIC;
