-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_pp_lote_retencao_pck.alimenta_lr_trib_pessoa ( nr_contador_p INOUT integer, vl_base_pgto_p INOUT pls_pp_lr_trib_pessoa.vl_base_pgto%type, vl_base_acum_p INOUT pls_pp_lr_trib_pessoa.vl_base_acumulada%type, vl_trib_pago_p INOUT pls_pp_lr_trib_pessoa.vl_tributo_pago%type, tb_nr_seq_base_trib_p INOUT pls_util_cta_pck.t_number_table, cd_pessoa_fisica_p pls_pp_lr_trib_pessoa.cd_pessoa_fisica%type, cd_tributo_p pls_pp_lr_trib_pessoa.cd_tributo%type, ie_tipo_contrat_p pls_pp_lr_trib_pessoa.ie_tipo_contratacao%type, nr_seq_tipo_prest_p pls_pp_lr_trib_pessoa.nr_seq_tipo_prestador%type, vl_base_adic_w pls_pp_lr_base_trib.vl_base_adic%type, vl_trib_adic_w pls_pp_lr_base_trib.vl_trib_adic%type, vl_base_nao_retido_w pls_pp_lr_base_trib.vl_base_nao_retido%type, vl_nao_retido_w pls_pp_lr_base_trib.vl_nao_retido%type, nr_seq_lote_p pls_pp_lr_lote.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE


nr_seq_lr_trib_pess_w	pls_pp_lr_trib_pessoa.nr_sequencia%type;


BEGIN

if (tb_nr_seq_base_trib_p.count > 0) then
	-- insere o registro agrupado e retorna a sequencia do mesmo
	insert into pls_pp_lr_trib_pessoa(
		nr_sequencia, dt_atualizacao_nrec, dt_atualizacao,
		nm_usuario_nrec, nm_usuario, cd_pessoa_fisica,
		cd_tributo, ie_tipo_contratacao, nr_seq_lote_ret,
		nr_seq_tipo_prestador, pr_aliquota, vl_base_calculo,
		vl_base_total, vl_tributo_pago, vl_base_pgto, 
		vl_base_acumulada, vl_tributo, vl_diferenca_base,
		vl_diferenca_trib, vl_base_adic, vl_trib_adic,
		vl_base_nao_retido, vl_nao_retido, ie_natureza
	) values (
		nextval('pls_pp_lr_trib_pessoa_seq'), clock_timestamp(), clock_timestamp(),
		nm_usuario_p, nm_usuario_p, cd_pessoa_fisica_p,
		cd_tributo_p, ie_tipo_contrat_p, nr_seq_lote_p,
		nr_seq_tipo_prest_p, 0, 0,
		vl_base_pgto_p + vl_base_acum_p, vl_trib_pago_p, vl_base_pgto_p, 
		vl_base_acum_p, 0, 0,
		0, coalesce(vl_base_adic_w, 0), coalesce(vl_trib_adic_w, 0),
		coalesce(vl_base_nao_retido_w, 0), coalesce(vl_nao_retido_w, 0), 'S'
	) returning nr_sequencia into nr_seq_lr_trib_pess_w;
	commit;

	-- faz o vínculo do registro inserido com os registros que o originou
	forall i in tb_nr_seq_base_trib_p.first..tb_nr_seq_base_trib_p.last
		update	pls_pp_lr_base_trib
		set	nr_seq_trib_pessoa = nr_seq_lr_trib_pess_w
		where	nr_sequencia = tb_nr_seq_base_trib_p(i);
	commit;

end if;
-- limpa os parâmetros
nr_contador_p := 0;
vl_base_pgto_p := 0;
vl_base_acum_p := 0;
vl_trib_pago_p := 0;
tb_nr_seq_base_trib_p.delete;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_pp_lote_retencao_pck.alimenta_lr_trib_pessoa ( nr_contador_p INOUT integer, vl_base_pgto_p INOUT pls_pp_lr_trib_pessoa.vl_base_pgto%type, vl_base_acum_p INOUT pls_pp_lr_trib_pessoa.vl_base_acumulada%type, vl_trib_pago_p INOUT pls_pp_lr_trib_pessoa.vl_tributo_pago%type, tb_nr_seq_base_trib_p INOUT pls_util_cta_pck.t_number_table, cd_pessoa_fisica_p pls_pp_lr_trib_pessoa.cd_pessoa_fisica%type, cd_tributo_p pls_pp_lr_trib_pessoa.cd_tributo%type, ie_tipo_contrat_p pls_pp_lr_trib_pessoa.ie_tipo_contratacao%type, nr_seq_tipo_prest_p pls_pp_lr_trib_pessoa.nr_seq_tipo_prestador%type, vl_base_adic_w pls_pp_lr_base_trib.vl_base_adic%type, vl_trib_adic_w pls_pp_lr_base_trib.vl_trib_adic%type, vl_base_nao_retido_w pls_pp_lr_base_trib.vl_base_nao_retido%type, vl_nao_retido_w pls_pp_lr_base_trib.vl_nao_retido%type, nr_seq_lote_p pls_pp_lr_lote.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;
