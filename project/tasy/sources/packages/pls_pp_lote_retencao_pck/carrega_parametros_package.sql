-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

-- controle para decidir quando o select para obtenção dos valores dos parâmetros deve ser executado novamente
-- Parâmetros
CREATE OR REPLACE PROCEDURE pls_pp_lote_retencao_pck.carrega_parametros ( nr_seq_lote_p pls_pp_lr_lote.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) AS $body$
BEGIN

-- se a data da última solicitação não estiver registrada ou 
-- se já se passou 67 segundos deste a última solicitação ou
-- se a origem for diferente da última solicitada ou
-- se o estabelecimento anterior for diferente do último solicitado
-- executa o comando para preencher os valores dos parâmetros
if	((current_setting('pls_pp_lote_retencao_pck.dt_solicitacao_ult_w')::coalesce(timestamp::text, '') = '') or
	(current_setting('pls_pp_lote_retencao_pck.dt_solicitacao_ult_w')::timestamp <= (clock_timestamp() - interval '67 seconds')) or (coalesce(current_setting('pls_pp_lote_retencao_pck.cd_estabelecimento_ult_w')::estabelecimento.cd_estabelecimento%type, -1) != coalesce(cd_estabelecimento_p, -2))) then

	if (nr_seq_lote_p IS NOT NULL AND nr_seq_lote_p::text <> '') then
	
		select	max(a.dt_mes_competencia),
			trunc(max(a.dt_mes_competencia), 'month'),
			last_day(max(a.dt_mes_competencia))
		into STRICT	current_setting('pls_pp_lote_retencao_pck.dt_mes_competencia_lote_w')::pls_pp_lr_lote.dt_mes_competencia%type,
			current_setting('pls_pp_lote_retencao_pck.dt_mes_comp_lote_inicio_w')::timestamp,
			current_setting('pls_pp_lote_retencao_pck.dt_mes_comp_lote_fim_w')::timestamp
		from	pls_pp_lr_lote a
		where	a.nr_sequencia = nr_seq_lote_p;
	end if;
	
	PERFORM set_config('pls_pp_lote_retencao_pck.cd_estabelecimento_ult_w', cd_estabelecimento_p, false);
	PERFORM set_config('pls_pp_lote_retencao_pck.dt_solicitacao_ult_w', clock_timestamp(), false);

	if (cd_estabelecimento_p IS NOT NULL AND cd_estabelecimento_p::text <> '') then

		select	coalesce(max(ie_data_tributos),'R')
		into STRICT	current_setting('pls_pp_lote_retencao_pck.ie_data_tributos_w')::pls_parametro_pagamento.ie_data_tributos%type
		from	pls_parametro_pagamento
		where	cd_estabelecimento = cd_estabelecimento_p;
	else

		select	coalesce(max(ie_data_tributos),'R')
		into STRICT	current_setting('pls_pp_lote_retencao_pck.ie_data_tributos_w')::pls_parametro_pagamento.ie_data_tributos%type
		from	pls_parametro_pagamento;
	end if;
end if;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_pp_lote_retencao_pck.carrega_parametros ( nr_seq_lote_p pls_pp_lr_lote.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) FROM PUBLIC;
