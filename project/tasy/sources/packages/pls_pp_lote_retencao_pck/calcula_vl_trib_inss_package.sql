-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pls_pp_lote_retencao_pck.calcula_vl_trib_inss ( ie_acumulativo_p tributo_conta_pagar.ie_acumulativo%type, cd_tributo_p tributo.cd_tributo%type, vl_teto_base_p tributo_conta_pagar.vl_teto_base_calculo%type, vl_minimo_base_p tributo_conta_pagar.vl_minimo%type, vl_minimo_tributo_p tributo_conta_pagar.vl_minimo_tributo%type, vl_tributo_pago_p pls_pp_valor_trib_pessoa.vl_tributo_pago%type, vl_base_acumulada_p pls_pp_valor_trib_pessoa.vl_base_acumulada%type, dt_competencia_p timestamp, vl_base_total_p pls_pp_valor_trib_pessoa.vl_base_total%type, pr_aliquota_p INOUT tributo_conta_pagar.pr_aliquota%type, vl_base_calculo_p INOUT pls_pp_valor_trib_pessoa.vl_base_calculo%type, vl_trib_nao_retido_p INOUT pls_pp_valor_trib_pessoa.vl_nao_retido%type, vl_trib_adic_p INOUT pls_pp_valor_trib_pessoa.vl_trib_adic%type, vl_base_nao_retido_p INOUT pls_pp_valor_trib_pessoa.vl_base_nao_retido%type, vl_base_adic_p INOUT pls_pp_valor_trib_pessoa.vl_base_adic%type, vl_base_total_out_p out pls_pp_valor_trib_pessoa.vl_base_total%type, vl_base_acum_out_p out pls_pp_valor_trib_pessoa.vl_base_acumulada%type, vl_reducao_p out regra_calculo_irpf.vl_reducao%type, nr_seq_regra_irpf_p out regra_calculo_irpf.nr_sequencia%type) AS $body$
DECLARE


/* 
ESTA ROTINA POSSUI OS TRATAMENTOS PARA O LOTE DE FECHAMENTO DO MÊS, QUALQUER ALTERAÇÃO NESTA FAVOR VERIFICAR SE NÃO É 
NECESSÁRIO FAZER O MESMO TRATAMENTO NA ROTINA UTILIZADA NOS LOTES DE PAGAMENTO (PLS_PP_TRIBUTACAO_PCK.CALCULA_VL_TRIB_INSS)

vl_base_acumulada_p = foi decidido que iremos passar no vl_base_anterior_p a soma dos valores retidos em outra empresa e o valor acumulado
			pois caso passamos no vl_base_retido_outro_p esta base é retornada na base utilizada para o cálculo do tributo mesmo que
			não tenha sido utilizada 
*/
vl_minimo_tributo_w	tributo_conta_pagar.vl_minimo_tributo%type;
vl_tributo_w		pls_pp_valor_trib_pessoa.vl_tributo%type;
vl_irrelevante_w	double precision;
nr_seq_regra_irpf_w	regra_calculo_irpf.nr_sequencia%type;
vl_trib_nao_retido_w	pls_pp_valor_trib_pessoa.vl_nao_retido%type;
vl_trib_adic_w		pls_pp_valor_trib_pessoa.vl_trib_adic%type;
vl_base_nao_retido_w	pls_pp_valor_trib_pessoa.vl_base_nao_retido%type;
vl_base_adic_w		pls_pp_valor_trib_pessoa.vl_base_adic%type;


BEGIN
-- inicializa a variável
vl_irrelevante_w := 0;

-- caso o campo esteja nulo ou venha zero, então assume 0.01, isto pois existe um tratamento na obter_valores_tributo
-- que só irá gerar tributo da diferença entre o valor retido em outras empresas e o valor atual quando esse valor for maior que zero
if (coalesce(vl_minimo_tributo_p, 0) = 0) then

	vl_minimo_tributo_w := 0.01;
else
	vl_minimo_tributo_w := vl_minimo_tributo_p;
end if;

obter_valores_tributo(	ie_acumulativo_p, -- vem do cadastro do tributo indicando se o mesmo é acumulativo
			pr_aliquota_p, -- in out entra a aliquota atual sai a nova (utilizado para o IRPF quando troca de aliquota por algum motivo)
			vl_minimo_base_p,
			vl_minimo_tributo_w, -- tratado para que seja no minimo 0.01 pois existe tratamento dentro da rotina
			vl_trib_nao_retido_p, -- vl_soma_trib_nao_retido_p nos testes feitos não encontrei utilidade para INSS porém decidimos manter para testes
			vl_trib_adic_p, -- vl_soma_trib_adic_p este campo fica salvo os valores de tributo que não foram 'pagos' em um outro processo por não ter atingido o valor minímo
			vl_base_nao_retido_p, -- vl_soma_base_nao_retido_p nos testes feitos não encontrei utilidade para INSS porém decidimos manter para testes
			vl_base_adic_p, -- vl_soma_base_adic_p para IR este campo traz a informação de base anterior, para INSS não temos certeza porém mantemos o valor
			vl_base_calculo_p, -- in out entra o valor de base atual e sai o valor que foi utilizado para chegar no valor do tributo
			vl_tributo_w, -- valor do tributo calculado
			vl_trib_nao_retido_w, -- vl_trib_nao_retido_p salvamos estes dados apenas por causa da view dos tributos
			vl_trib_adic_w, -- vl_trib_adic_p salvamos estes dados apenas por causa da view dos tributos
			vl_base_nao_retido_w, -- vl_base_nao_retido_p salvamos estes dados apenas por causa da view dos tributos
			vl_base_adic_w, -- vl_base_adic_p salvamos estes dados apenas por causa da view dos tributos
			vl_teto_base_p, -- vl teto do tributo
			vl_tributo_pago_p, -- tributo pago no sistema para a competência até o momento
			'N', -- ie_irpf_p, como estamos cálculando INSS então é passado fixo
			vl_base_acumulada_p, -- ver comentário no início desta função
			vl_irrelevante_w, -- vl_reducao_p nos testes feitos não encontrei utilidade para INSS
			vl_irrelevante_w, -- vl_desc_dependente_p não existe desconto por dependente para INSS
			0, -- qt_dependente_p não existe desconto por dependente para INSS
			0, -- vl_base_pago_p nos testes feitos não encontrei utilidade para INSS
			0, -- vl_base_pago_adic_base_p nos testes feitos não encontrei utilidade para INSS
			0, -- vl_base_retido_outro_p decidido que os valores retido em outro de INSS serão passados como base acumulado
			0, -- vl_outras_red_irpf_p nos testes feitos não encontrei utilidade para INSS
			dt_competencia_p,
			nr_seq_regra_irpf_w, -- out sequencia da regra de IRPF
			cd_tributo_p);

vl_trib_nao_retido_p := vl_trib_nao_retido_w;
vl_trib_adic_p := vl_trib_adic_w;
vl_base_nao_retido_p := vl_base_nao_retido_w;
vl_base_adic_p := vl_base_adic_w;

-- estes campos foram criados pois existe diferença nos valores salvos nos mesmos dependendo do tipo de tributo
-- para INSS o valor salvo na base total sempre será a base atual + base acumulada já na base acumulada sempre será a própria
vl_base_total_out_p := vl_base_total_p;
vl_base_acum_out_p := vl_base_acumulada_p;

-- estes campos são especifícos para IRPF, aqui apenas alimentamos para salvar na tabela
vl_reducao_p := 0;
nr_seq_regra_irpf_p := null;

return;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pls_pp_lote_retencao_pck.calcula_vl_trib_inss ( ie_acumulativo_p tributo_conta_pagar.ie_acumulativo%type, cd_tributo_p tributo.cd_tributo%type, vl_teto_base_p tributo_conta_pagar.vl_teto_base_calculo%type, vl_minimo_base_p tributo_conta_pagar.vl_minimo%type, vl_minimo_tributo_p tributo_conta_pagar.vl_minimo_tributo%type, vl_tributo_pago_p pls_pp_valor_trib_pessoa.vl_tributo_pago%type, vl_base_acumulada_p pls_pp_valor_trib_pessoa.vl_base_acumulada%type, dt_competencia_p timestamp, vl_base_total_p pls_pp_valor_trib_pessoa.vl_base_total%type, pr_aliquota_p INOUT tributo_conta_pagar.pr_aliquota%type, vl_base_calculo_p INOUT pls_pp_valor_trib_pessoa.vl_base_calculo%type, vl_trib_nao_retido_p INOUT pls_pp_valor_trib_pessoa.vl_nao_retido%type, vl_trib_adic_p INOUT pls_pp_valor_trib_pessoa.vl_trib_adic%type, vl_base_nao_retido_p INOUT pls_pp_valor_trib_pessoa.vl_base_nao_retido%type, vl_base_adic_p INOUT pls_pp_valor_trib_pessoa.vl_base_adic%type, vl_base_total_out_p out pls_pp_valor_trib_pessoa.vl_base_total%type, vl_base_acum_out_p out pls_pp_valor_trib_pessoa.vl_base_acumulada%type, vl_reducao_p out regra_calculo_irpf.vl_reducao%type, nr_seq_regra_irpf_p out regra_calculo_irpf.nr_sequencia%type) FROM PUBLIC;
