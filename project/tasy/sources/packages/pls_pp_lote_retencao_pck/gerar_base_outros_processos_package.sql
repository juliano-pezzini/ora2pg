-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_pp_lote_retencao_pck.gerar_base_outros_processos ( nr_seq_lote_p pls_pp_lr_lote.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
BEGIN
-- abre o cursor dos tributos de INSS e IR
for r_c_trib_w in current_setting('pls_pp_lote_retencao_pck.c_tributo')::loop CURSOR

	-- busca cartas de retenção de INSS
	pls_pp_lote_retencao_pck.gerar_base_acum_outra_fonte(	nr_seq_lote_p, r_c_trib_w.cd_tributo, cd_estabelecimento_p,
					nm_usuario_p);
	
	-- só busca os valores de outros processos caso o checkbox "Considerar todos processos para apuração do piso" esteja marcado
	if (r_c_trib_w.ie_apuracao_piso = 'S') then

		-- aqui busca quando o imposto for na geração do título
		if (r_c_trib_w.ie_baixa_titulo = 'N') then

			CALL pls_pp_lote_retencao_pck.gerar_base_acum_tit_pg_imp(	nr_seq_lote_p, r_c_trib_w.cd_tributo, r_c_trib_w.ie_restringe_estab,
							r_c_trib_w.ie_vencimento, cd_estabelecimento_p, nm_usuario_p);
		-- aqui quando for na baixa do mesmo
		else

			CALL pls_pp_lote_retencao_pck.gerar_base_acum_tit_pg_baixa(	nr_seq_lote_p, r_c_trib_w.cd_tributo, r_c_trib_w.ie_restringe_estab,
							cd_estabelecimento_p, nm_usuario_p);
		end if;

		-- verifica se a geração do tributo na NF é no vencimento ou no corpo da nota, quando for item trata como corpo pois
		-- os valores do tributo estarão nas mesmas tabelas
		if (r_c_trib_w.ie_corpo_item = 'V') then

			CALL pls_pp_lote_retencao_pck.gerar_base_acum_nf_venc_trib(	nr_seq_lote_p, r_c_trib_w.cd_tributo, r_c_trib_w.ie_restringe_estab,
							cd_estabelecimento_p, nm_usuario_p);

		else

			CALL pls_pp_lote_retencao_pck.gerar_base_acum_nf_corpo_trib(	nr_seq_lote_p, r_c_trib_w.cd_tributo, r_c_trib_w.ie_restringe_estab,
							cd_estabelecimento_p, nm_usuario_p);
		end if;

		-- verifica os valores de repasse terceiros
		CALL pls_pp_lote_retencao_pck.gerar_base_acum_repasse_terc(	nr_seq_lote_p, r_c_trib_w.cd_tributo, r_c_trib_w.ie_restringe_estab,
						r_c_trib_w.ie_vencimento, r_c_trib_w.ie_repasse_titulo, cd_estabelecimento_p, 
						nm_usuario_p);
	end if;
end loop;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_pp_lote_retencao_pck.gerar_base_outros_processos ( nr_seq_lote_p pls_pp_lr_lote.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;
