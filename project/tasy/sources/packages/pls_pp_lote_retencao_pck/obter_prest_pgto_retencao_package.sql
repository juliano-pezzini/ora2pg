-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pls_pp_lote_retencao_pck.obter_prest_pgto_retencao ( nr_seq_lote_pgto_p pls_pp_lr_lote.nr_sequencia%type, nr_seq_trib_pess_p pls_pp_lr_trib_pessoa.nr_sequencia%type, cd_pessoa_fisica_p pessoa_fisica.cd_pessoa_fisica%type, nr_seq_evento_p pls_evento.nr_sequencia%type) RETURNS bigint AS $body$
DECLARE


nr_seq_prestador_w	pls_prestador.nr_sequencia%type;


BEGIN
-- precisa ser passado ao menos o evento para que seja encontrado um prestador
if (nr_seq_evento_p IS NOT NULL AND nr_seq_evento_p::text <> '') then

	-- primeiro verificamos se existe um prestador já no lote de pagamento que tenha originado o registro da retenção
	-- e que tenha uma regra cadastrada para o evento e prestador no lote de pagamento
	select	max(a.nr_seq_prestador)
	into STRICT	nr_seq_prestador_w
	from	pls_pp_lr_base_trib a,
		pls_pp_item_lote b
	where	a.nr_seq_trib_pessoa = nr_seq_trib_pess_p
	and	b.nr_seq_prestador = a.nr_seq_prestador
	and	b.nr_seq_lote = nr_seq_lote_pgto_p
	and 	exists (	SELECT	1
			from	pls_pp_lote_prest_event x
			where	x.nr_seq_lote = b.nr_seq_lote
			and	x.nr_seq_prestador = a.nr_seq_prestador
			and	x.nr_seq_evento = nr_seq_evento_p);
	
	-- se não encontrou então verificamos apenas se existe uma regra para um dos prestadores que tenham
	-- gerado o registro no lote de fechamento
	if (coalesce(nr_seq_prestador_w::text, '') = '') then

		select	max(a.nr_seq_prestador)
		into STRICT	nr_seq_prestador_w
		from	pls_pp_lr_base_trib a,
			pls_pp_lote_prest_event b
		where	a.nr_seq_trib_pessoa = nr_seq_trib_pess_p
		and	b.nr_seq_prestador = a.nr_seq_prestador
		and	b.nr_seq_lote = nr_seq_lote_pgto_p
		and	b.nr_seq_evento = nr_seq_evento_p;

		-- se ainda não encontrou então verifica se existe uma regra para algum dos prestadores da
		-- pessoa fisica que gerou o registro no lote de fechamento
		if (coalesce(nr_seq_prestador_w::text, '') = '') then

			select	max(b.nr_seq_prestador)
			into STRICT	nr_seq_prestador_w
			from	pls_pp_prestador_tmp a,
				pls_pp_lote_prest_event b
			where	a.ie_tipo_prestador = 'PF'
			and	a.cd_pessoa_fisica = cd_pessoa_fisica_p
			and	b.nr_seq_prestador = a.nr_seq_prestador
			and	b.nr_seq_lote = nr_seq_lote_pgto_p
			and	b.nr_seq_evento = nr_seq_evento_p;
		end if;
	end if;
end if;

return nr_seq_prestador_w;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pls_pp_lote_retencao_pck.obter_prest_pgto_retencao ( nr_seq_lote_pgto_p pls_pp_lr_lote.nr_sequencia%type, nr_seq_trib_pess_p pls_pp_lr_trib_pessoa.nr_sequencia%type, cd_pessoa_fisica_p pessoa_fisica.cd_pessoa_fisica%type, nr_seq_evento_p pls_evento.nr_sequencia%type) FROM PUBLIC;
