-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pls_pp_lote_retencao_pck.obter_lotes_pgto_abertos_comp ( dt_comp_lote_p timestamp) RETURNS varchar AS $body$
DECLARE


ds_retorno_w	varchar(250);

c01 CURSOR(	dt_comp_lote_pc	timestamp) FOR
	SELECT	to_char(lp.nr_sequencia) nr_seq_lote_pgto
	from	pls_pp_lote lp
	where	lp.dt_mes_competencia = dt_comp_lote_pc
	and	coalesce(lp.dt_fechamento::text, '') = ''
	--and	lp.dt_geracao_titulo is null
	and	exists (SELECT	1
			from	pls_pp_valor_trib_pessoa_v tp
			where	tp.nr_seq_lote	= lp.nr_sequencia
			and	(tp.cd_pessoa_fisica IS NOT NULL AND tp.cd_pessoa_fisica::text <> '')
			and	tp.ie_tipo_tributo in ('INSS','IR'))
	order by lp.nr_sequencia;

BEGIN
for r_c01_w in c01(dt_comp_lote_p) loop
	
	ds_retorno_w := pls_util_pck.concatena_string(	ds_retorno_w, r_c01_w.nr_seq_lote_pgto, ', ', 250);
end loop;

return ds_retorno_w;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pls_pp_lote_retencao_pck.obter_lotes_pgto_abertos_comp ( dt_comp_lote_p timestamp) FROM PUBLIC;
