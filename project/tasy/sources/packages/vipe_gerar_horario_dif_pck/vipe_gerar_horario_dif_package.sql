-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE vipe_gerar_horario_dif_pck.vipe_gerar_horario_dif ( ds_dose_diferenciada_p text, ds_horarios_entrada_p text, nr_prescricoes_p text, cd_intervalo_p text, hr_prim_horario_p text, nr_prescricao_p bigint, cd_item_p bigint, qt_dose_total_mod_item_p INOUT bigint, ds_horarios_p INOUT text, ds_mensagem_p INOUT text, qt_operacao_p INOUT bigint) AS $body$
DECLARE


	ds_consiste_dose_dif_w		varchar(1)	:= 'N';
	ie_operacao_w			varchar(1)	:= 'X';
	ie_dose_diferenciada_w		varchar(1)	:= 'N';
	ds_texto_w			varchar(255)	:= '';
	ds_mensagem_w			varchar(255)	:= '';
	ds_horarios_w			varchar(255)	:= '';
	ds_horarios_ordenados_w		varchar(255)	:= '';
	ds_horarios2_w			varchar(255)	:= '';
	ds_horarios_rec_w		varchar(255)	:= '';
	ds_horarios_retorno_w		varchar(255)	:= '';
	ds_horarios_entrada_w		varchar(255)	:= '';
	nr_max_prescricao_w		bigint	:= 0;
	qt_intervalos_w			bigint	:= 0;
	nr_intervalos_w			bigint	:= 0;
	nr_intervalo_retorno_w		bigint;
	qt_dose_total_mod_item_w	bigint	:= 0;
	nr_prescricao_w			bigint	:= 0;
	qt_operacao_w			intervalo_prescricao.qt_operacao%type := 0;
	vl_k_w				bigint	:= 0;
	qt_dose_w			real	:= 0;
	cd_dose_numerico_w		bigint	:= 0;
	qt_dose_total_w			real	:= 0;
	nr_horas_validade_w		integer;
	dt_inicio_prescr_w		timestamp;
	hr_prim_horario_w		timestamp;

	
BEGIN

	if (ds_dose_diferenciada_p IS NOT NULL AND ds_dose_diferenciada_p::text <> '') then
		begin

		ds_consiste_dose_dif_w	:= substr(consiste_dose_diferenciada(ds_dose_diferenciada_p),1,1);

		if (ds_consiste_dose_dif_w = 'N') then
			begin
			CALL Wheb_mensagem_pck.exibir_mensagem_abort(22361);
			end;
		end if;

		nr_max_prescricao_w	:= Obter_Max_NrPrescricao(nr_prescricoes_p);

		if (nr_prescricao_p > 0) then
			nr_prescricao_w	:= nr_prescricao_p;
		else
			nr_prescricao_w	:= nr_max_prescricao_w;
		end if;

		select	a.ds_horarios,
			a.ie_operacao,
			a.qt_operacao,
			a.ie_dose_diferenciada,
			substr(reordenar_horarios(obter_data_medic_dose_dif(nr_prescricao_w,hr_prim_horario_p),a.ds_horarios),1,255) ds_horarios_ordenados
		into STRICT	ds_horarios_w,
			ie_operacao_w,
			qt_operacao_w,
			ie_dose_diferenciada_w,
			ds_horarios_ordenados_w
		from   	intervalo_prescricao a
		where  	a.ie_situacao = 'A'
		and	a.cd_intervalo = cd_intervalo_p
		order by	a.ds_intervalo;

		-- Guarda os hor√°rios
		if	(ie_operacao_w = 'V' AND ds_horarios_ordenados_w IS NOT NULL AND ds_horarios_ordenados_w::text <> '') then
			CALL vipe_gerar_horario_dif_pck.vipe_gerar_horarios_doses(ds_horarios_ordenados_w, ' ', 'H');
		elsif (ds_horarios_w IS NOT NULL AND ds_horarios_w::text <> '') then
			CALL vipe_gerar_horario_dif_pck.vipe_gerar_horarios_doses(ds_horarios_w, ' ', 'H');
		end if;

		-- Guarda as doses
		CALL vipe_gerar_horario_dif_pck.vipe_gerar_horarios_doses(ds_dose_diferenciada_p, '-', 'D');

		for i in 0..vetor_dose_w.count - 1 loop
			begin

			vl_k_w	:= vl_k_w + 1;

			cd_dose_numerico_w	:= Campo_numerico(current_setting('vipe_gerar_horario_dif_pck.vetor_dose_w')::vetor_dose[i].dose_w);

			if (current_setting('vipe_gerar_horario_dif_pck.vetor_dose_w')::vetor_dose[i].dose_w = '1/2') then
				qt_dose_w	:= 0.5;
			elsif (cd_dose_numerico_w <> 0) then
				qt_dose_w	:= cd_dose_numerico_w;
			else
				qt_dose_w	:= 0;
			end if;

			qt_intervalos_w	:= qt_intervalos_w + 1;

			if (qt_dose_w <> 0) then
				begin
				qt_dose_total_w	:= qt_dose_total_w + qt_dose_w;
				nr_intervalos_w	:= nr_intervalos_w + 1;

				if (current_setting('vipe_gerar_horario_dif_pck.vetor_w')::vetor.count >= current_setting('vipe_gerar_horario_dif_pck.vetor_dose_w')::vetor_dose.count) then
					ds_horarios_rec_w	:= ds_horarios_rec_w || current_setting('vipe_gerar_horario_dif_pck.vetor_dose_w')::vetor_dose[i].dose_w || ' ';
				end if;
				end;
			end if;
			end;
		end loop;

		select	max(dt_inicio_prescr)
		into STRICT	dt_inicio_prescr_w
		from	prescr_medica
		where	nr_prescricao in (nr_prescricoes_p);

		select	coalesce(max(nr_horas_validade),0)
		into STRICT	nr_horas_validade_w
		from 	prescr_medica
		where 	nr_prescricao in (nr_prescricoes_p);

		select	to_date(('30/12/1899 ' || hr_prim_horario_p || ':00'), 'dd/mm/yyyy hh24:mi:ss')
		into STRICT	hr_prim_horario_w
		;

		if	((ie_operacao_w = 'X' AND vl_k_w = qt_operacao_w) or
			 (ie_operacao_w <> 'X' AND nr_intervalos_w > 0)) and
			((ie_operacao_w <> 'F' AND ie_operacao_w <> 'V') or (qt_operacao_w = qt_intervalos_w)) then
			begin
			-- Definir_horarios
			ds_horarios_entrada_w	:= ds_horarios_entrada_p;
			Calcular_Horario_Prescricao(nr_prescricao_w, cd_intervalo_p, dt_inicio_prescr_w, hr_prim_horario_w, nr_horas_validade_w, cd_item_p, '', '', nr_intervalo_retorno_w, ds_horarios_entrada_w, ds_horarios2_w, 'N', ds_dose_diferenciada_p);
			ds_horarios_retorno_w	:= ds_horarios_entrada_w || ds_horarios2_w;

			if	(ie_dose_diferenciada_w <> 'O' AND ie_dose_diferenciada_w <> 'P')then
				if	((ds_horarios_rec_w <> '') and
					 ((ie_operacao_w = 'F') or (ie_operacao_w = 'V') or (ie_operacao_w = 'X')))then
					if	(ie_operacao_w = 'V' AND ds_horarios_ordenados_w <> '')then
						ds_horarios_rec_w	:= tratar_validade_horarios_rep(nr_prescricao_w,ds_horarios_rec_w,hr_prim_horario_p);
					else
						ds_horarios_retorno_w	:= ds_horarios_rec_w;
					end if;
				end if;
			end if;
			end;
		elsif	((((ie_operacao_w = 'F') or (ie_operacao_w = 'V')) and (ie_dose_diferenciada_w <> 'S')) or
			 (ie_dose_diferenciada_w = 'S' AND ie_operacao_w = 'X')) then

			ds_mensagem_w	:= obter_texto_tasy(294418, wheb_usuario_pck.get_nr_seq_idioma);
		else
			begin
			-- Definir_horarios
			Calcular_Horario_Prescricao(nr_prescricao_w, cd_intervalo_p, dt_inicio_prescr_w, hr_prim_horario_w, nr_horas_validade_w, cd_item_p, '', '', nr_intervalo_retorno_w, ds_horarios_entrada_w, ds_horarios2_w, 'N', ds_dose_diferenciada_p);
			ds_horarios_retorno_w	:= ds_horarios_entrada_w || ds_horarios2_w;
			end;
		end if;

		qt_dose_total_mod_item_w	:= qt_dose_total_mod_item_p;

		ds_horarios_p			:= ds_horarios_retorno_w;
		ds_mensagem_p			:= ds_mensagem_w;
		qt_operacao_p			:= qt_operacao_w;
		qt_dose_total_mod_item_p	:= qt_dose_total_mod_item_w + qt_dose_total_w;

		-- Limpando o vetor das doses
		for i in 0..vetor_dose_w.count - 1 loop
			begin
			current_setting('vipe_gerar_horario_dif_pck.vetor_dose_w')::vetor_dose.delete(i);
			end;
		end loop;

		-- Limpando o vetor dos horarios
		for i in 0..vetor_w.count - 1 loop
			begin
			current_setting('vipe_gerar_horario_dif_pck.vetor_w')::vetor.delete(i);
			end;
		end loop;

		end;
	end if;

	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE vipe_gerar_horario_dif_pck.vipe_gerar_horario_dif ( ds_dose_diferenciada_p text, ds_horarios_entrada_p text, nr_prescricoes_p text, cd_intervalo_p text, hr_prim_horario_p text, nr_prescricao_p bigint, cd_item_p bigint, qt_dose_total_mod_item_p INOUT bigint, ds_horarios_p INOUT text, ds_mensagem_p INOUT text, qt_operacao_p INOUT bigint) FROM PUBLIC;
