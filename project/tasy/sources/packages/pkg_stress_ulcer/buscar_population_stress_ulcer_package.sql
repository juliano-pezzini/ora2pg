-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

  --
CREATE OR REPLACE FUNCTION pkg_stress_ulcer.buscar_population_stress_ulcer ( setor bigint, estabelecimento bigint, trimestre bigint ) RETURNS SETOF TABLE_ANALIT_TYPE AS $body$
DECLARE


C_POPULATION CURSOR FOR
         SELECT 'Number of Patient Stays*' label,
                coalesce(pr, 0) pr,
                coalesce(seg, 0) seg,
                coalesce(ter, 0) ter,
                coalesce(qua, 0) qua,
                coalesce(alleicu, 0) alleicu
           FROM (
                 SELECT (
                         SELECT SUM(qt_pacientes)
                           FROM w_stress_ulcer_population a
                          WHERE a.cd_estabelecimento = estabelecimento
                            AND a.cd_setor_atendimento = setor
                            AND a.nr_trimestre = CASE
                                                     WHEN trimestre = 4
                                                     THEN 1 
                                                     WHEN trimestre < 4
                                                     THEN trimestre + 1
                                                 END
                        ) PR,
                        (
                         SELECT SUM(qt_pacientes)
                           FROM w_stress_ulcer_population a
                          WHERE a.cd_estabelecimento = estabelecimento
                            AND a.cd_setor_atendimento = setor
                            AND a.nr_trimestre = CASE 
                                                     WHEN trimestre > 2
                                                     THEN trimestre - 2
                                                     ELSE trimestre + 2
                                                 END
                        ) SEG,
                        (
                         SELECT SUM(qt_pacientes)
                           FROM w_stress_ulcer_population a
                          WHERE a.cd_estabelecimento = estabelecimento
                            AND a.cd_setor_atendimento = setor
                            AND a.nr_trimestre = CASE 
                                                     WHEN trimestre > 1
                                                     THEN trimestre - 1
                                                     ELSE 4
                                                 END
                        ) TER,
                        (
                         SELECT SUM(qt_pacientes)
                           FROM w_stress_ulcer_population a
                          WHERE a.cd_estabelecimento = estabelecimento
                            AND a.cd_setor_atendimento = setor
                            AND a.nr_trimestre = trimestre
                        ) QUA,
                        (
                         SELECT SUM(qt_pacientes)
                           FROM w_stress_ulcer_population a
                          WHERE a.nr_trimestre = trimestre
                        ) ALLEICU
                   
              ) a
          
UNION ALL

         SELECT 'Number of Patient Days' descricao,
                coalesce(pr, 0) pr,
                coalesce(seg, 0) seg,
                coalesce(ter, 0) ter,
                coalesce(qua, 0) qua,
                coalesce(alleicu, 0) alleicu
           FROM (
                 SELECT (
                         SELECT SUM(qt_dias_pacientes)
                           FROM w_stress_ulcer_population a
                          WHERE a.cd_estabelecimento = estabelecimento
                            AND a.cd_setor_atendimento = setor
                            AND a.nr_trimestre = CASE 
                                                     WHEN trimestre = 4
                                                     THEN 1 
                                                     WHEN trimestre < 4
                                                     THEN trimestre + 1
                                                 END
                        ) PR,
                        (
                         SELECT SUM(qt_dias_pacientes)
                           FROM w_stress_ulcer_population a
                          WHERE a.cd_estabelecimento = estabelecimento
                            AND a.cd_setor_atendimento = setor
                            AND a.nr_trimestre = CASE 
                                                     WHEN trimestre > 2
                                                     THEN trimestre - 2
                                                     ELSE trimestre + 2
                                                 END
                        ) SEG,
                        (
                         SELECT SUM(qt_dias_pacientes)
                           FROM w_stress_ulcer_population a
                          WHERE a.cd_estabelecimento = estabelecimento
                            AND a.cd_setor_atendimento = setor
                            AND a.nr_trimestre = CASE 
                                                     WHEN trimestre > 1
                                                     THEN trimestre - 1
                                                     ELSE 4
                                                 END
                        ) TER,
                        (
                         SELECT SUM(qt_dias_pacientes)
                           FROM w_stress_ulcer_population a
                          WHERE a.cd_estabelecimento = estabelecimento
                            AND a.cd_setor_atendimento = setor
                            AND a.nr_trimestre = trimestre
                        ) QUA,
                        (
                         SELECT SUM(qt_dias_pacientes)
                           FROM w_stress_ulcer_population a
                          WHERE a.nr_trimestre = trimestre
                        ) ALLEICU
                   
              ) a
          
UNION ALL

         SELECT 'Number of Ventilated Patients' descricao,
                coalesce(pr, 0) pr,
                coalesce(seg, 0) seg,
                coalesce(ter, 0) ter,
                coalesce(qua, 0) qua,
                coalesce(alleicu, 0) alleicu
           FROM (
                 SELECT (
                         SELECT SUM(qt_pacientes_ventilados)
                           FROM w_stress_ulcer_population a
                          WHERE a.cd_estabelecimento = estabelecimento
                            AND a.cd_setor_atendimento = setor
                            AND a.nr_trimestre = CASE 
                                                     WHEN trimestre = 4
                                                     THEN 1 
                                                     WHEN trimestre < 4
                                                     THEN trimestre + 1
                                                 END
                        ) PR,
                        (
                         SELECT SUM(qt_pacientes_ventilados)
                           FROM w_stress_ulcer_population a
                          WHERE a.cd_estabelecimento = estabelecimento
                            AND a.cd_setor_atendimento = setor
                            AND a.nr_trimestre = CASE 
                                                     WHEN trimestre > 2
                                                     THEN trimestre - 2
                                                     ELSE trimestre + 2
                                                 END
                        ) SEG,
                        (
                         SELECT SUM(qt_pacientes_ventilados)
                           FROM w_stress_ulcer_population a
                          WHERE a.cd_estabelecimento = estabelecimento
                            AND a.cd_setor_atendimento = setor
                            AND a.nr_trimestre = CASE 
                                                     WHEN trimestre > 1
                                                     THEN trimestre - 1
                                                     ELSE 4
                                                 END
                        ) TER,
                        (
                         SELECT SUM(qt_pacientes_ventilados)
                           FROM w_stress_ulcer_population a
                          WHERE a.cd_estabelecimento = estabelecimento
                            AND a.cd_setor_atendimento = setor
                            AND a.nr_trimestre = trimestre
                        ) QUA,
                        (
                         SELECT SUM(qt_pacientes_ventilados)
                           FROM w_stress_ulcer_population a
                          WHERE a.nr_trimestre = trimestre
                        ) ALLEICU
                   
              ) a;


TYPE T_POPULATION IS TABLE OF C_POPULATION%ROWTYPE;
R_POPULATION T_POPULATION;

BEGIN
  OPEN C_POPULATION;
  LOOP
    FETCH C_POPULATION BULK COLLECT INTO R_POPULATION LIMIT 1000;

      BEGIN
        FOR i IN R_POPULATION.FIRST..R_POPULATION.LAST LOOP
          RETURN NEXT R_POPULATION(i);
        END LOOP;
      EXCEPTION WHEN OTHERS THEN
        NULL;
      END;

    EXIT WHEN NOT FOUND; /* apply on C_POPULATION */

  END LOOP;
  CLOSE C_POPULATION;

  RETURN;
END;
  --
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pkg_stress_ulcer.buscar_population_stress_ulcer ( setor bigint, estabelecimento bigint, trimestre bigint ) FROM PUBLIC;
