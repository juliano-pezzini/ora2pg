-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pfcs_pck_emergency_department.waiting_room (cd_establishment_p bigint, nm_user_p text) AS $body$
DECLARE

		pfcs_panel_detail_seq_w pfcs_panel_detail.nr_sequencia%type;
		pfcs_detail_queue_seq_w pfcs_detail_queue.nr_sequencia%type;
		pfcs_panel_seq_w		pfcs_panel.nr_sequencia%type;
		qt_sla_rule_w			pfcs_general_rule.qt_time_ed_stage%type;
		cd_calc_method_w		pfcs_general_rule.ie_ed_calc_method%type;
		qt_waiting_room_total   integer := 0;

		qt_wait_time_total		double precision := 0;
		qt_wait_time_max		double precision := 0;
		qt_wait_time_count		integer := 0;

    dt_execution_w          timestamp:= to_date(to_char(clock_timestamp(), 'dd-mm-yyyy hh24:mi'), 'dd-mm-yyyy hh24:mi');
    dt_last_month_w			timestamp := dt_execution_w - 30;
		dt_last_hour_w			timestamp := dt_execution_w - (1 / 24);
		dt_last_day_w			timestamp := dt_execution_w - 1;
		qt_total_1hr_w			integer := 0;
		qt_total_24hr_w			integer := 0;
		qt_consolidated_time_w	integer := 0;
		qt_waiting_time_w		integer := 0;
		qt_sla_1hr_w			integer := 0;
		qt_sla_24hr_w			integer := 0;
		qt_array_index_w		integer := 0;

		c01 CURSOR FOR
			SELECT  tsk.id_task			nr_queue,
				tsk.ds_reason_display	ds_reason,
				tsk.cd_reason			cd_reason,
				tsk.dt_authored_on		dt_creation,
				tsk.si_status,
				tsk.si_intent,
				tsk.dt_last_modified
			   from pfcs_task tsk
			  where upper(tsk.si_status) not in (pfcs_pck_constants.si_status_cancelled, pfcs_pck_constants.si_status_failed)
			    and tsk.dt_authored_on >= dt_last_month_w
				and tsk.cd_task_code = PFCS_PCK_CONSTANTS.CD_TASK_ED_QUEUE
			    and cd_establishment = cd_establishment_p;

	
BEGIN
		select max(ie_ed_calc_method) into STRICT cd_calc_method_w from pfcs_general_rule;

		<<c01_loop>>
		for c01_w in c01 loop
			
			qt_sla_rule_w := pfcs_pck_emergency_department.get_acceptable_duration(current_setting('pfcs_pck_emergency_department.cd_stage_waiting_room')::smallint,c01_w.cd_reason);

			select nextval('pfcs_panel_detail_seq') into STRICT pfcs_panel_detail_seq_w;
			select nextval('pfcs_detail_queue_seq') into STRICT pfcs_detail_queue_seq_w;

			if (upper(c01_w.si_status) in (pfcs_pck_constants.si_status_draft,
							pfcs_pck_constants.si_status_requested,
							pfcs_pck_constants.si_status_received,
							pfcs_pck_constants.si_status_accepted,
							pfcs_pck_constants.si_status_ready) and
			    upper(c01_w.si_intent) in (pfcs_pck_constants.si_intent_plan,
							pfcs_pck_constants.si_intent_order)) then
				qt_waiting_time_w := (dt_execution_w - c01_w.dt_creation) * 1440;

				qt_wait_time_total := qt_wait_time_total + qt_waiting_time_w;
				qt_wait_time_count := qt_wait_time_count + 1;
				if qt_waiting_time_w > qt_wait_time_max then
					qt_wait_time_max := qt_waiting_time_w;
				end if;
				
				if (c01_w.dt_creation between dt_last_hour_w and dt_execution_w) then
					qt_total_1hr_w := qt_total_1hr_w + 1;
					if ((qt_waiting_time_w) <= qt_sla_rule_w) then
						qt_sla_1hr_w := qt_sla_1hr_w + 1;
                   			end if;
				end if;

				if (c01_w.dt_creation between dt_last_day_w and dt_execution_w) then
					qt_total_24hr_w := qt_total_24hr_w + 1;
					if ((qt_waiting_time_w) <= qt_sla_rule_w) then
						qt_sla_24hr_w := qt_sla_24hr_w + 1;
					end if;
				end if;
				
				qt_waiting_room_total := qt_waiting_room_total + 1;
				
				insert into pfcs_panel_detail(nr_sequencia,
					 nm_usuario,
					 dt_atualizacao,
					 nm_usuario_nrec,
					 dt_atualizacao_nrec,
					 ie_situation,
					 nr_seq_indicator,
					 nr_seq_operational_level)
				values (pfcs_panel_detail_seq_w,
					 nm_user_p,
					 dt_execution_w,
					 nm_user_p,
					 clock_timestamp(),
					 pfcs_pck_constants.ie_temporary,
					 pfcs_pck_indicators.nr_ed_waiting_time,
					 cd_establishment_p);

				insert into pfcs_detail_queue(nr_sequencia,
					 ds_waiting_number,
					 ds_queue,
					 id_queue,
					 dt_waiting_number,
					 nr_seq_detail,
					 dt_atualizacao,
					 nm_usuario,
					 dt_atualizacao_nrec,
					 nm_usuario_nrec)
				values (pfcs_detail_queue_seq_w,
					 c01_w.nr_queue,
					 c01_w.ds_reason,
					 c01_w.cd_reason,
					 c01_w.dt_creation,
					 pfcs_panel_detail_seq_w,
					 clock_timestamp(),
					 nm_user_p,
					 clock_timestamp(),
					 nm_user_p);
					
            end if;

			if (upper(c01_w.si_status) in (pfcs_pck_constants.si_status_completed) and (c01_w.dt_last_modified IS NOT NULL AND c01_w.dt_last_modified::text <> '')) then
				qt_waiting_time_w := (c01_w.dt_last_modified - c01_w.dt_creation) * 1440;
				
				if (c01_w.dt_creation between dt_last_hour_w and dt_execution_w) then
					qt_total_1hr_w := qt_total_1hr_w + 1;
					if ((qt_waiting_time_w) <= qt_sla_rule_w) then
						qt_sla_1hr_w := qt_sla_1hr_w + 1;
					end if;
				end if;

				if (c01_w.dt_creation between dt_last_day_w and dt_execution_w) then
					qt_total_24hr_w := qt_total_24hr_w + 1;
					if ((qt_waiting_time_w) <= qt_sla_rule_w) then
						qt_sla_24hr_w := qt_sla_24hr_w + 1;
					end if;
				end if;
			end if;

		end loop c01_loop;

		if (cd_calc_method_w = current_setting('pfcs_pck_emergency_department.cd_calc_time_avg')::pfcs_general_rule.ie_ed_calc_method%type) then
			qt_consolidated_time_w := dividir(qt_wait_time_total,qt_wait_time_count);
		elsif (cd_calc_method_w = current_setting('pfcs_pck_emergency_department.cd_calc_time_max')::pfcs_general_rule.ie_ed_calc_method%type) then
			qt_consolidated_time_w := qt_wait_time_max;
		end if;

		 := pfcs_pck.pfcs_generate_results(	
			vl_indicator_p 				=> qt_consolidated_time_w, nr_seq_indicator_p			=> PFCS_PCK_INDICATORS.NR_ED_WAITING_TIME, vl_indicator_collab_p		=> PFCS_PCK_INDICATORS.NR_ED_SLA_WAITING_1HR, vl_indicator_help_p			=> PFCS_PCK_INDICATORS.NR_ED_SLA_WAITING_24HR, nr_seq_operational_level_p	=> cd_establishment_p, nm_usuario_p            	=> nm_user_p, nr_seq_panel_p          	=> pfcs_panel_seq_w);

		CALL pfcs_pck.pfcs_update_detail(
			nr_seq_indicator_p         => PFCS_PCK_INDICATORS.NR_ED_WAITING_TIME,
			nr_seq_panel_p             => pfcs_panel_seq_w,
			nr_seq_operational_level_p => cd_establishment_p,
			nm_usuario_p               => nm_user_p);

		CALL pfcs_pck.pfcs_activate_records(
			nr_seq_indicator_p         => PFCS_PCK_INDICATORS.NR_ED_WAITING_TIME,
			nr_seq_operational_level_p => cd_establishment_p,
			nm_usuario_p               => nm_user_p);
			
		----- SLA 1HR ------
		 := pfcs_pck.pfcs_generate_results(	
			vl_indicator_p 				=> qt_total_1hr_w, vl_indicator_help_p			=> qt_sla_1hr_w, nr_seq_indicator_p			=> PFCS_PCK_INDICATORS.NR_ED_SLA_WAITING_1HR, nr_seq_operational_level_p	=> cd_establishment_p, nm_usuario_p            	=> nm_user_p, nr_seq_panel_p          	=> pfcs_panel_seq_w);

		CALL pfcs_pck.pfcs_update_detail(
			nr_seq_indicator_p         => PFCS_PCK_INDICATORS.NR_ED_SLA_WAITING_1HR,
			nr_seq_panel_p             => pfcs_panel_seq_w,
			nr_seq_operational_level_p => cd_establishment_p,
			nm_usuario_p               => nm_user_p);

		CALL pfcs_pck.pfcs_activate_records(
			nr_seq_indicator_p         => PFCS_PCK_INDICATORS.NR_ED_SLA_WAITING_1HR,
			nr_seq_operational_level_p => cd_establishment_p,
			nm_usuario_p               => nm_user_p);
			
		----- SLA 24HR ------
		 := pfcs_pck.pfcs_generate_results(	
			vl_indicator_p 				=> qt_total_24hr_w, vl_indicator_help_p			=> qt_sla_24hr_w, nr_seq_indicator_p			=> PFCS_PCK_INDICATORS.NR_ED_SLA_WAITING_24HR, nr_seq_operational_level_p	=> cd_establishment_p, nm_usuario_p            	=> nm_user_p, nr_seq_panel_p          	=> pfcs_panel_seq_w);

		CALL pfcs_pck.pfcs_update_detail(
			nr_seq_indicator_p         => PFCS_PCK_INDICATORS.NR_ED_SLA_WAITING_24HR,
			nr_seq_panel_p             => pfcs_panel_seq_w,
			nr_seq_operational_level_p => cd_establishment_p,
			nm_usuario_p               => nm_user_p);

		CALL pfcs_pck.pfcs_activate_records(
			nr_seq_indicator_p         => PFCS_PCK_INDICATORS.NR_ED_SLA_WAITING_24HR,
			nr_seq_operational_level_p => cd_establishment_p,
			nm_usuario_p               => nm_user_p);

		---- TOTAL PATIENTS IN WAITING ROOM ---
		 := pfcs_pck.pfcs_generate_results(	
			vl_indicator_p 				=> qt_waiting_room_total, nr_seq_indicator_p			=> PFCS_PCK_INDICATORS.NR_ED_WAITING_PATIENTS, nr_seq_operational_level_p	=> cd_establishment_p, nm_usuario_p            	=> nm_user_p, nr_seq_panel_p          	=> pfcs_panel_seq_w);

		CALL pfcs_pck.pfcs_update_detail(
			nr_seq_indicator_p         => PFCS_PCK_INDICATORS.NR_ED_WAITING_PATIENTS,
			nr_seq_panel_p             => pfcs_panel_seq_w,
			nr_seq_operational_level_p => cd_establishment_p,
			nm_usuario_p               => nm_user_p);

		CALL pfcs_pck.pfcs_activate_records(
			nr_seq_indicator_p         => PFCS_PCK_INDICATORS.NR_ED_WAITING_PATIENTS,
			nr_seq_operational_level_p => cd_establishment_p,
			nm_usuario_p               => nm_user_p);
	
    END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pfcs_pck_emergency_department.waiting_room (cd_establishment_p bigint, nm_user_p text) FROM PUBLIC;
