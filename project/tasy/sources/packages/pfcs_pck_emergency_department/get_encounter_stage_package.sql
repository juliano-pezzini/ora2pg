-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pfcs_pck_emergency_department.get_encounter_stage (nr_seq_encounter_p bigint) RETURNS bigint AS $body$
DECLARE

		ds_status_w						pfcs_encounter.si_status%type;
		ds_classif_w					pfcs_encounter.si_classif%type;
		cd_medication_w					pfcs_medication_request.cd_medication%type;
		cd_service_request_category_w	pfcs_service_request.cd_category%type;
		ds_stage_w						integer;

	
BEGIN
		select	upper(enc.si_status),
				upper(enc.si_classif),
				upper(med.cd_medication),
				upper(ser.cd_category)
		  into STRICT	ds_status_w,
				ds_classif_w,
				cd_medication_w,
				cd_service_request_category_w
		  from	pfcs_encounter enc
		left join pfcs_medication_request med on	med.nr_seq_encounter = enc.nr_sequencia and
													upper(med.si_status) in (PFCS_PCK_CONSTANTS.SI_STATUS_ACTIVE,PFCS_PCK_CONSTANTS.SI_STATUS_ON_HOLD)
		left join pfcs_service_request ser on		ser.nr_seq_encounter = enc.nr_sequencia and
													ser.cd_category = PFCS_PCK_CONSTANTS.CD_LABORATORY_PROCEDURE
		  where	enc.nr_sequencia = nr_seq_encounter_p  LIMIT 1;

		case
			when(ds_status_w in (PFCS_PCK_CONSTANTS.SI_STATUS_ARRIVED, PFCS_PCK_CONSTANTS.SI_STATUS_PLANNED)) then
				ds_stage_w := current_setting('pfcs_pck_emergency_department.cd_stage_triage')::smallint;
			when(ds_status_w = PFCS_PCK_CONSTANTS.SI_STATUS_TRIAGED) then
				ds_stage_w := current_setting('pfcs_pck_emergency_department.cd_stage_doctor_consultation')::smallint;
			when(ds_status_w = PFCS_PCK_CONSTANTS.SI_STATUS_IN_PROGRESS AND ds_classif_w = PFCS_PCK_CONSTANTS.SI_CLASSIF_OBSENC) then
				ds_stage_w := current_setting('pfcs_pck_emergency_department.cd_stage_observation')::smallint;
			when(ds_status_w = PFCS_PCK_CONSTANTS.SI_STATUS_IN_PROGRESS AND (cd_medication_w IS NOT NULL AND cd_medication_w::text <> '')) then
				ds_stage_w := current_setting('pfcs_pck_emergency_department.cd_stage_medication')::smallint;
			when(ds_status_w = PFCS_PCK_CONSTANTS.SI_STATUS_IN_PROGRESS AND (cd_service_request_category_w IS NOT NULL AND cd_service_request_category_w::text <> '')) then
				ds_stage_w := current_setting('pfcs_pck_emergency_department.cd_stage_laboratory')::smallint;
			else
				ds_stage_w := 0;
		end case;

		return ds_stage_w;

	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pfcs_pck_emergency_department.get_encounter_stage (nr_seq_encounter_p bigint) FROM PUBLIC;
