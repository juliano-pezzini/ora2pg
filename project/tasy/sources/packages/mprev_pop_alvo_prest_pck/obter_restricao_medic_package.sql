-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


	-->>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>OBTER restricoes MEDICAMENTO<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<--
CREATE OR REPLACE FUNCTION mprev_pop_alvo_prest_pck.obter_restricao_medic (dados_regra_p mprev_pop_alvo_prest_pck.regra_medic) RETURNS varchar AS $body$
DECLARE


	ds_retorno_w		varchar(4000)	:= null;
	ds_retorno_guia_w	varchar(4000)	:= null;

	
BEGIN
	--Medicamento
	if (dados_regra_p.cd_material IS NOT NULL AND dados_regra_p.cd_material::text <> '') then
		-- Aqui monta o select com as restricoes
		ds_retorno_w :=	ds_retorno_w || current_setting('mprev_pop_alvo_prest_pck.enter_w')::pls_util_pck.enter_w%type ||
				'and	medic.med_cd_material = :cd_material ';
		-- Aqui adiciona o valor da bild variable
		current_setting('mprev_pop_alvo_prest_pck.bind_sql_w')::sql_pck.t_dado_bind := sql_pck.bind_variable(':cd_material', dados_regra_p.cd_material, current_setting('mprev_pop_alvo_prest_pck.bind_sql_w')::sql_pck.t_dado_bind);
	end if;
	
	--Unidade de medida
	if (dados_regra_p.cd_unidade_medida IS NOT NULL AND dados_regra_p.cd_unidade_medida::text <> '') then
		
		ds_retorno_w :=	ds_retorno_w || current_setting('mprev_pop_alvo_prest_pck.enter_w')::pls_util_pck.enter_w%type ||
					'and	medic.cd_unid_medida = :cd_unidade_medida ';
		
		current_setting('mprev_pop_alvo_prest_pck.bind_sql_w')::sql_pck.t_dado_bind := sql_pck.bind_variable(':cd_unidade_medida', dados_regra_p.cd_unidade_medida, current_setting('mprev_pop_alvo_prest_pck.bind_sql_w')::sql_pck.t_dado_bind);
	end if;
	
	--Dose
	if (dados_regra_p.QT_DOSE_INICIAL IS NOT NULL AND dados_regra_p.QT_DOSE_INICIAL::text <> '') and (dados_regra_p.QT_DOSE_FINAL IS NOT NULL AND dados_regra_p.QT_DOSE_FINAL::text <> '') then
		
		ds_retorno_w :=	ds_retorno_w || current_setting('mprev_pop_alvo_prest_pck.enter_w')::pls_util_pck.enter_w%type ||
					'and	medic.qt_dose between :qt_dose_inicial and :qt_dose_final ';
		
		current_setting('mprev_pop_alvo_prest_pck.bind_sql_w')::sql_pck.t_dado_bind := sql_pck.bind_variable(':qt_dose_inicial', dados_regra_p.qt_dose_inicial, current_setting('mprev_pop_alvo_prest_pck.bind_sql_w')::sql_pck.t_dado_bind);
		current_setting('mprev_pop_alvo_prest_pck.bind_sql_w')::sql_pck.t_dado_bind := sql_pck.bind_variable(':qt_dose_final', dados_regra_p.qt_dose_final, current_setting('mprev_pop_alvo_prest_pck.bind_sql_w')::sql_pck.t_dado_bind);
	end if;	

	return	ds_retorno_w;

	END;	

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION mprev_pop_alvo_prest_pck.obter_restricao_medic (dados_regra_p mprev_pop_alvo_prest_pck.regra_medic) FROM PUBLIC;
