-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


	-->>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>GERAR PESSOAS NA POPULACAO ALVO<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<--
CREATE OR REPLACE PROCEDURE mprev_pop_alvo_prest_pck.gravar_pessoas_populacao ( nr_seq_populacao_alvo_p bigint, nm_usuario_p text, ds_select_comp_p text) AS $body$
DECLARE



	tb_pessoas_pop_alvo_w	mprev_pop_alvo_prest_pck.table_pessoas_pop_alvo;
	nr_seq_controle_w	mprev_pessoa_cubo_ops_w.nr_seq_controle%type;
	cursor_w		sql_pck.t_cursor;
	qt_reg_w		bigint;
	
BEGIN

	select	max(nr_seq_controle)
	into STRICT	nr_seq_controle_w
	from 	mprev_pessoa_cubo_ops_w
	where 	nm_usuario = nm_usuario_p
	and 	nr_seq_pop_alvo = nr_seq_populacao_alvo_p;
	
	current_setting('mprev_pop_alvo_prest_pck.bind_sql_w')::sql_pck.t_dado_bind := sql_pck.bind_variable(':nr_seq_controle_pc', nr_seq_controle_w, current_setting('mprev_pop_alvo_prest_pck.bind_sql_w')::sql_pck.t_dado_bind);
	current_setting('mprev_pop_alvo_prest_pck.bind_sql_w')::sql_pck.t_dado_bind := sql_pck.bind_variable(':nr_seq_populacao_alvo_pc', nr_seq_populacao_alvo_p, current_setting('mprev_pop_alvo_prest_pck.bind_sql_w')::sql_pck.t_dado_bind);
	
	current_setting('mprev_pop_alvo_prest_pck.bind_sql_w')::sql_pck.t_dado_bind := sql_pck.executa_sql_cursor(ds_select_comp_p, current_setting('mprev_pop_alvo_prest_pck.bind_sql_w')::sql_pck.t_dado_bind);

	loop
	
	
	
		CALL CALL mprev_pop_alvo_prest_pck.limpar_tipo_tabelas('tb_pessoas_pop_alvo_w');
		
		fetch	cursor_w bulk collect
		into	tb_pessoas_pop_alvo_w.cd_pessoa_fisica, tb_pessoas_pop_alvo_w.qt_idade_anos, tb_pessoas_pop_alvo_w.ie_partic_programa,
			tb_pessoas_pop_alvo_w.ie_grupo_controle, tb_pessoas_pop_alvo_w.nm_pessoa, tb_pessoas_pop_alvo_w.ie_sexo
		limit	current_setting('mprev_pop_alvo_prest_pck.qt_reg_commit_w')::integer;

		exit when tb_pessoas_pop_alvo_w.cd_pessoa_fisica.count = 0;

		forall i in tb_pessoas_pop_alvo_w.cd_pessoa_fisica.first .. tb_pessoas_pop_alvo_w.cd_pessoa_fisica.last
				
				
			insert into mprev_pop_alvo_pessoa(nr_sequencia, dt_atualizacao, nm_usuario,
				dt_atualizacao_nrec, nm_usuario_nrec, nr_seq_populacao_alvo,
				cd_pessoa_fisica, qt_idade_anos, ie_partic_programa,
				ie_grupo_controle, nm_pessoa, ie_selecionada,
				ie_sexo, ie_sel_temp, nm_pessoa_pesquisa, cd_municipio_ibge, sg_estado)
			values (nextval('mprev_pop_alvo_pessoa_seq'), clock_timestamp(), nm_usuario_p,
				clock_timestamp(), nm_usuario_p, nr_seq_populacao_alvo_p, tb_pessoas_pop_alvo_w.cd_pessoa_fisica(i),
				tb_pessoas_pop_alvo_w.qt_idade_anos(i), tb_pessoas_pop_alvo_w.ie_partic_programa(i), tb_pessoas_pop_alvo_w.ie_grupo_controle(i),
				tb_pessoas_pop_alvo_w.nm_pessoa(i), 'N', tb_pessoas_pop_alvo_w.ie_sexo(i),
				'N', upper(elimina_acentuacao(tb_pessoas_pop_alvo_w.nm_pessoa(i))), obter_cod_ibge_compl_pf(tb_pessoas_pop_alvo_w.cd_pessoa_fisica(i), '1'),
        obter_sg_estado_compl_pf(tb_pessoas_pop_alvo_w.cd_pessoa_fisica(i), '1'));
		commit;
	end loop;
	close cursor_w;
	
	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE mprev_pop_alvo_prest_pck.gravar_pessoas_populacao ( nr_seq_populacao_alvo_p bigint, nm_usuario_p text, ds_select_comp_p text) FROM PUBLIC;
