-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


	-->>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>OBTER restricoes TRATAMENTO<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<--
CREATE OR REPLACE FUNCTION mprev_pop_alvo_prest_pck.obter_restricao_trat (dados_regra_p mprev_pop_alvo_prest_pck.regra_trat) RETURNS varchar AS $body$
DECLARE


	ds_retorno_w		varchar(4000)	:= null;
	ds_retorno_guia_w	varchar(4000)	:= null;

	
BEGIN
	
	--IE_TIPO_TRATAMENTO
	if (dados_regra_p.IE_TIPO_TRATAMENTO = 1) then --Quimioterapia
		ds_retorno_w :=	' select	pessoa.nr_sequencia 			' || current_setting('mprev_pop_alvo_prest_pck.enter_w')::pls_util_pck.enter_w%type ||
						' from		mprev_pessoa_cubo_ops pessoa, 	' || current_setting('mprev_pop_alvo_prest_pck.enter_w')::pls_util_pck.enter_w%type ||
						' 			paciente_setor trat 			' || current_setting('mprev_pop_alvo_prest_pck.enter_w')::pls_util_pck.enter_w%type ||
						' where		pessoa.cd_pessoa_fisica = trat.cd_pessoa_fisica	' || current_setting('mprev_pop_alvo_prest_pck.enter_w')::pls_util_pck.enter_w%type ||
						' and		trat.dt_atualizacao_nrec >= :dt_referencia_pc ';

		current_setting('mprev_pop_alvo_prest_pck.bind_sql_w')::sql_pck.t_dado_bind := sql_pck.bind_variable(':dt_referencia_pc', current_setting('mprev_pop_alvo_prest_pck.dt_referencia_w')::timestamp, current_setting('mprev_pop_alvo_prest_pck.bind_sql_w')::sql_pck.t_dado_bind);
		
	elsif (dados_regra_p.IE_TIPO_TRATAMENTO = 2) then -- radioterapia
		ds_retorno_w :=	' select	pessoa.nr_sequencia 			' || current_setting('mprev_pop_alvo_prest_pck.enter_w')::pls_util_pck.enter_w%type ||
						' from		mprev_pessoa_cubo_ops pessoa, 	' || current_setting('mprev_pop_alvo_prest_pck.enter_w')::pls_util_pck.enter_w%type ||
						' 			rxt_tumor trat 					' || current_setting('mprev_pop_alvo_prest_pck.enter_w')::pls_util_pck.enter_w%type ||
						' where		pessoa.cd_pessoa_fisica = trat.cd_pessoa_fisica	' || current_setting('mprev_pop_alvo_prest_pck.enter_w')::pls_util_pck.enter_w%type ||
						' and		trat.dt_atualizacao_nrec >= :dt_referencia_pc ';

		current_setting('mprev_pop_alvo_prest_pck.bind_sql_w')::sql_pck.t_dado_bind := sql_pck.bind_variable(':dt_referencia_pc', current_setting('mprev_pop_alvo_prest_pck.dt_referencia_w')::timestamp, current_setting('mprev_pop_alvo_prest_pck.bind_sql_w')::sql_pck.t_dado_bind);
	end if;

	return	ds_retorno_w;

	END;	

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION mprev_pop_alvo_prest_pck.obter_restricao_trat (dados_regra_p mprev_pop_alvo_prest_pck.regra_trat) FROM PUBLIC;
