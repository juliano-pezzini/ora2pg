-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_programacao_reajuste_pck.atualizar_registros ( ie_descarregar_vetores_p text) AS $body$
DECLARE

C01 CURSOR(	nr_seq_equipe_pc	pls_equipe_reajuste.nr_sequencia%type) FOR
	SELECT	cd_pessoa_fisica
	from	pls_equipe_reaj_pessoa
	where	nr_seq_equipe	= nr_seq_equipe_pc
	and	(cd_pessoa_fisica IS NOT NULL AND cd_pessoa_fisica::text <> '')
	and	clock_timestamp()	between coalesce(dt_inicio_vigencia,clock_timestamp()) and coalesce(dt_fim_vigencia,clock_timestamp());
BEGIN
if	((indice_w >= pls_util_pck.qt_registro_transacao_w) or (ie_descarregar_vetores_p = 'S')) then
	if (tb_nr_seq_prog_w.count > 0) then
		forall i in tb_nr_seq_prog_w.first..tb_nr_seq_prog_w.last
			update	pls_prog_reaj_coletivo
			set	dt_inicio_analise	= tb_dt_inicio_analise_w(i),
				dt_fim_analise		= tb_dt_fim_analise_w(i),
				tx_sinistralidade_ideal	= tb_tx_sinistralidade_ideal_w(i),
				tx_sinistralidade	= tb_tx_sinistralidade_w(i),
				vl_receita		= tb_vl_receita_w(i),
				vl_despesas		= tb_vl_custo_w(i),
				tx_sinistralidade_grupo	= tb_tx_sinistralidade_grupo_w(i),
				vl_receita_grupo	= tb_vl_receita_grupo_w(i),
				vl_despesas_grupo	= tb_vl_custo_grupo_w(i),
				qt_vidas		= tb_qt_vidas_w(i),
				ie_exibir_portal	= 'N',
				dt_reajuste		= current_setting('pls_programacao_reajuste_pck.pls_programacao_lote_w')::pls_prog_reaj_colet_lote%rowtype.dt_mes_reajuste,
				dt_reajuste_contrato	= current_setting('pls_programacao_reajuste_pck.pls_programacao_lote_w')::pls_prog_reaj_colet_lote%rowtype.dt_mes_reajuste,
				ie_status		= 'N',
				nr_seq_grupo_relac	= tb_nr_seq_grupo_relac_w(i)
			where	nr_sequencia		= tb_nr_seq_prog_w(i);
		commit;
		
		for i in tb_nr_seq_prog_w.first..tb_nr_seq_prog_w.last loop
			begin
			if ((tb_nr_seq_equipe_w(i) IS NOT NULL AND (tb_nr_seq_equipe_w(i))::text <> '')) then
				for r_c01_w in C01(tb_nr_seq_equipe_w(i)) loop
					begin
					insert	into	pls_prog_reaj_equipe(	nr_sequencia, nr_seq_programacao, nr_seq_equipe, cd_pessoa_fisica,
							dt_atualizacao, nm_usuario, dt_atualizacao_nrec,
							nm_usuario_nrec)
						values (	nextval('pls_prog_reaj_equipe_seq'), tb_nr_seq_prog_w(i), tb_nr_seq_equipe_w(i), r_c01_w.cd_pessoa_fisica,
							clock_timestamp(), nm_usuario_p, clock_timestamp(),
							nm_usuario_p);
					end;
				end loop; --C01
			end if;
			end;
		end loop;
	end if;
	
	CALL CALL CALL CALL pls_programacao_reajuste_pck.limpar_vetor();
end if;
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_programacao_reajuste_pck.atualizar_registros ( ie_descarregar_vetores_p text) FROM PUBLIC;
