-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_programacao_reajuste_pck.atualizar_tipo_reajuste ( nr_seq_programacao_p pls_prog_reaj_coletivo.nr_sequencia%type, nr_seq_tipo_reajuste_p pls_tipo_reajuste.nr_sequencia%type, tx_reajuste_p bigint, ie_coparticipacao_p text, ie_taxa_inscricao_p text, ie_via_carteira_p text, ie_valor_manutencao_p text, tx_reajuste_proposto_p bigint, tx_coparticipacao_p bigint, tx_coparticipacao_max_p bigint, tx_inscricao_p bigint, tx_via_carteira_p bigint, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) AS $body$
DECLARE


ds_historico_w			varchar(4000);
ie_coparticipacao_w		varchar(1);
ie_taxa_inscricao_w		varchar(1);
ie_via_carteira_w		varchar(1);
ie_valor_manutencao_w		varchar(1);
tx_reajuste_copartic_w		pls_prog_reaj_coletivo.tx_reajuste_copartic%type;
tx_reajuste_copartic_max_w	pls_prog_reaj_coletivo.tx_reajuste_copartic_max%type;
tx_reajuste_inscricao_w		pls_prog_reaj_coletivo.tx_reajuste_inscricao%type;
tx_reajuste_via_cart_w		pls_prog_reaj_coletivo.tx_reajuste_via_cart%type;


BEGIN
if (nr_seq_programacao_p IS NOT NULL AND nr_seq_programacao_p::text <> '') and (nr_seq_tipo_reajuste_p IS NOT NULL AND nr_seq_tipo_reajuste_p::text <> '') then
	select	CASE WHEN ie_coparticipacao_p='M' THEN  ie_reajustar_copartic  ELSE ie_coparticipacao_p END ,
		CASE WHEN ie_taxa_inscricao_p='M' THEN  ie_reajustar_tx_inscricao  ELSE ie_taxa_inscricao_p END ,
		CASE WHEN ie_via_carteira_p='M' THEN  ie_reajustar_via_cart  ELSE ie_via_carteira_p END ,
		CASE WHEN ie_valor_manutencao_p='M' THEN  ie_reajustar_vl_manutencao  ELSE ie_valor_manutencao_p END ,
		CASE WHEN ie_coparticipacao_p='S' THEN  CASE WHEN coalesce(tx_coparticipacao_p,0)=0 THEN  null  ELSE tx_coparticipacao_p END   ELSE CASE WHEN ie_coparticipacao_p='N' THEN  null  ELSE tx_reajuste_copartic END  END ,
		CASE WHEN ie_coparticipacao_p='S' THEN  CASE WHEN coalesce(tx_coparticipacao_max_p,0)=0 THEN  null  ELSE tx_coparticipacao_max_p END   ELSE CASE WHEN ie_coparticipacao_p='N' THEN  null  ELSE tx_reajuste_copartic_max END  END ,
		CASE WHEN ie_taxa_inscricao_p='S' THEN  CASE WHEN coalesce(tx_inscricao_p,0)=0 THEN  null  ELSE tx_inscricao_p END   ELSE CASE WHEN ie_taxa_inscricao_p='N' THEN  null  ELSE tx_reajuste_inscricao END  END ,
		CASE WHEN ie_via_carteira_p='S' THEN  CASE WHEN coalesce(tx_via_carteira_p,0)=0 THEN  null  ELSE tx_via_carteira_p END   ELSE CASE WHEN ie_via_carteira_p='N' THEN  null  ELSE tx_reajuste_via_cart END  END
	into STRICT	ie_coparticipacao_w,
		ie_taxa_inscricao_w,
		ie_via_carteira_w,
		ie_valor_manutencao_w,
		tx_reajuste_copartic_w,
		tx_reajuste_copartic_max_w,
		tx_reajuste_inscricao_w,
		tx_reajuste_via_cart_w
	from	pls_prog_reaj_coletivo
	where	nr_sequencia = nr_seq_programacao_p;
	
	update	pls_prog_reaj_coletivo
	set	nr_seq_tipo_reajuste	= nr_seq_tipo_reajuste_p,
		tx_reajuste_programado	= tx_reajuste_p,
		ie_reajustar_copartic	= ie_coparticipacao_w,
		ie_reajustar_tx_inscricao = ie_taxa_inscricao_w,
		ie_reajustar_via_cart	= ie_via_carteira_w,
		ie_reajustar_vl_manutencao = ie_valor_manutencao_w,
		tx_reajuste_proposto = tx_reajuste_proposto_p,
		tx_reajuste_copartic = tx_reajuste_copartic_w,
		tx_reajuste_copartic_max = tx_reajuste_copartic_max_w,
		tx_reajuste_inscricao = tx_reajuste_inscricao_w,
		tx_reajuste_via_cart = tx_reajuste_via_cart_w
	where	nr_sequencia = nr_seq_programacao_p;

	select	wheb_mensagem_pck.get_texto(1127860,'DS_TIPO_REAJUSTE=' || pls_obter_dados_tipo_reaj(nr_seq_tipo_reajuste_p,'N') || ';TX_REAJUSTE=' || coalesce(tx_reajuste_p,0)) || chr(10)||
		wheb_mensagem_pck.get_texto(1127811)|| ': ' || CASE WHEN ie_coparticipacao_w='S' THEN wheb_mensagem_pck.get_texto(1127812) ||		 CASE WHEN coalesce(tx_reajuste_copartic_w,0)=0 THEN null  ELSE ' ' ||tx_reajuste_copartic_w||wheb_mensagem_pck.get_texto(1151834) END ||		 CASE WHEN coalesce(tx_reajuste_copartic_max_w,0)=0 THEN  null  ELSE ' '||tx_reajuste_copartic_max_w||wheb_mensagem_pck.get_texto(1151834)||' '||lower(wheb_mensagem_pck.get_texto(1151835)) END   ELSE wheb_mensagem_pck.get_texto(1127813) END  || chr(10)||
		wheb_mensagem_pck.get_texto(1127814)|| ': ' || CASE WHEN ie_taxa_inscricao_w='S' THEN wheb_mensagem_pck.get_texto(1127812) ||		 CASE WHEN coalesce(tx_reajuste_inscricao_w,0)=0 THEN null  ELSE ' '||tx_reajuste_inscricao_w||wheb_mensagem_pck.get_texto(1151839) END   ELSE wheb_mensagem_pck.get_texto(1127813) END  || chr(10)||
		wheb_mensagem_pck.get_texto(1127815)|| ': ' || CASE WHEN ie_via_carteira_w='S' THEN wheb_mensagem_pck.get_texto(1127812) ||		 CASE WHEN coalesce(tx_reajuste_via_cart_w,0)=0 THEN null  ELSE ' '||tx_reajuste_via_cart_w||wheb_mensagem_pck.get_texto(1152060) END   ELSE wheb_mensagem_pck.get_texto(1127813) END  || chr(10)||
		wheb_mensagem_pck.get_texto(1127816)|| ': ' || CASE WHEN ie_valor_manutencao_w='S' THEN wheb_mensagem_pck.get_texto(1127812)  ELSE wheb_mensagem_pck.get_texto(1127813) END  || chr(10) ||
		CASE WHEN coalesce(tx_reajuste_proposto_p, 0)=0 THEN  null  ELSE wheb_mensagem_pck.get_texto(1127861,'TX_REAJUSTE_PROPOSTO=' || tx_reajuste_proposto_p) END 
	into STRICT	ds_historico_w
	;
	
	CALL pls_programacao_reajuste_pck.gravar_historico_sistema(nr_seq_programacao_p,ds_historico_w,nm_usuario_p,cd_estabelecimento_p);
	commit;
end if;
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_programacao_reajuste_pck.atualizar_tipo_reajuste ( nr_seq_programacao_p pls_prog_reaj_coletivo.nr_sequencia%type, nr_seq_tipo_reajuste_p pls_tipo_reajuste.nr_sequencia%type, tx_reajuste_p bigint, ie_coparticipacao_p text, ie_taxa_inscricao_p text, ie_via_carteira_p text, ie_valor_manutencao_p text, tx_reajuste_proposto_p bigint, tx_coparticipacao_p bigint, tx_coparticipacao_max_p bigint, tx_inscricao_p bigint, tx_via_carteira_p bigint, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) FROM PUBLIC;
