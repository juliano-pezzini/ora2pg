-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_programacao_reajuste_pck.alterar_extrato_portal ( nr_seq_programacao_p pls_prog_reaj_coletivo.nr_sequencia%type, ie_portal_p pls_prog_reaj_coletivo.ie_exibir_portal%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) AS $body$
DECLARE


ds_historico_w			varchar(255);
qt_programacao_futura_w		bigint;
ie_inativar_extratos_ant_w	pls_parametros.ie_inativar_extratos_ant%type;
dt_mes_reajuste_w		pls_prog_reaj_colet_lote.dt_mes_reajuste%type;
ie_portal_w			pls_prog_reaj_coletivo.ie_exibir_portal%type;
nr_seq_contrato_w		pls_prog_reaj_coletivo.nr_seq_contrato%type;

C01 CURSOR(	nr_seq_programacao_pc	pls_prog_reaj_coletivo.nr_sequencia%type,
		nr_seq_contrato_pc	pls_contrato.nr_sequencia%type) FOR
	SELECT	nr_sequencia	nr_seq_programacao
	from	pls_prog_reaj_coletivo
	where	nr_sequencia <> nr_seq_programacao_pc
	and	nr_seq_contrato = nr_seq_contrato_pc
	and	coalesce(ie_exibir_portal, 'N') = 'S';

BEGIN

select	a.ie_exibir_portal,
	a.nr_seq_contrato,
	(select	x.dt_mes_reajuste
	from	pls_prog_reaj_colet_lote x
	where	x.nr_sequencia = a.nr_seq_lote) dt_mes_reajuste
into STRICT	ie_portal_w,
	nr_seq_contrato_w,
	dt_mes_reajuste_w
from	pls_prog_reaj_coletivo a
where	a.nr_sequencia	= nr_seq_programacao_p;

if (ie_portal_w <> ie_portal_p) then
	if (ie_portal_p = 'S') then
		select	coalesce(max(ie_inativar_extratos_ant), 'N')
		into STRICT	ie_inativar_extratos_ant_w
		from	pls_parametros
		where	cd_estabelecimento = cd_estabelecimento_p;
		
		if (ie_inativar_extratos_ant_w = 'S') then
			select	count(1)
			into STRICT	qt_programacao_futura_w
			from	pls_prog_reaj_coletivo a,
				pls_prog_reaj_colet_lote b
			where	b.nr_sequencia = a.nr_seq_lote
			and	a.nr_seq_contrato = nr_seq_contrato_w
			and	b.dt_mes_reajuste > dt_mes_reajuste_w;
			
			if (qt_programacao_futura_w = 0) then
				for r_c01_w in c01(	nr_seq_programacao_p,
							nr_seq_contrato_w) loop
					begin
					update	pls_prog_reaj_coletivo
					set	ie_exibir_portal	= 'N'
					where	nr_sequencia		= r_c01_w.nr_seq_programacao;
					
					CALL pls_programacao_reajuste_pck.gravar_historico_sistema(nr_seq_programacao_p,wheb_mensagem_pck.get_texto(1127857,'DS_MES=' || to_char(dt_mes_reajuste_w,'mm/yyyy')),
								nm_usuario_p,cd_estabelecimento_p);
					end;
				end loop;
			end if;
		end if;
	end if;
	
	update	pls_prog_reaj_coletivo
	set	ie_exibir_portal	= ie_portal_p,
		dt_liberacao_extrato	= CASE WHEN ie_portal_p='S' THEN clock_timestamp()  ELSE null END ,
		nm_usuario		= nm_usuario_p,
		dt_atualizacao		= clock_timestamp()
	where	nr_sequencia		= nr_seq_programacao_p;
	
	if (ie_portal_p = 'S') then
		ds_historico_w	:= wheb_mensagem_pck.get_texto(1127858);
	else
		ds_historico_w	:= wheb_mensagem_pck.get_texto(1127859);
	end if;
	
	CALL pls_programacao_reajuste_pck.gravar_historico_sistema(nr_seq_programacao_p,ds_historico_w,nm_usuario_p,cd_estabelecimento_p);
	
	commit;
end if;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_programacao_reajuste_pck.alterar_extrato_portal ( nr_seq_programacao_p pls_prog_reaj_coletivo.nr_sequencia%type, ie_portal_p pls_prog_reaj_coletivo.ie_exibir_portal%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) FROM PUBLIC;
