-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_programacao_reajuste_pck.desfazer_liberacao ( nr_seq_programacao_p pls_prog_reaj_coletivo.nr_sequencia%type, nm_usuario_p pls_prog_reaj_coletivo.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) AS $body$
DECLARE


qt_aporte_w	bigint;
					
C01 CURSOR FOR
	SELECT	a.nr_titulo
	from	titulo_receber a,
		pls_prog_reaj_aporte_venc b,
		pls_prog_reaj_aporte c
	where	c.nr_sequencia = b.nr_seq_aporte
	and	b.nr_sequencia = a.nr_seq_aporte_venc
	and	c.nr_seq_programacao = nr_seq_programacao_p;
		
BEGIN

select	count(1)
into STRICT	qt_aporte_w
from	pls_prog_reaj_aporte
where	nr_seq_programacao = nr_seq_programacao_p;

if (qt_aporte_w > 0) then
	for r_c01_w in c01 loop
		begin
		CALL cancelar_titulo_receber(r_c01_w.nr_titulo, nm_usuario_p, 'N', clock_timestamp());
		end;
	end loop;

	update	pls_segurado_mensalidade
	set	ie_situacao = 'I',
		nm_usuario = nm_usuario_p,
		dt_atualizacao = clock_timestamp(),
		ds_observacao = wheb_mensagem_pck.get_texto(1180220)
	where	nr_seq_aporte in (	SELECT	nr_sequencia
					from	pls_prog_reaj_aporte
					where	nr_seq_programacao = nr_seq_programacao_p);
end if;

CALL pls_programacao_reajuste_pck.alterar_status_program_reaj(nr_seq_programacao_p, 'N', 'DL', nm_usuario_p, cd_estabelecimento_p);

commit;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_programacao_reajuste_pck.desfazer_liberacao ( nr_seq_programacao_p pls_prog_reaj_coletivo.nr_sequencia%type, nm_usuario_p pls_prog_reaj_coletivo.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) FROM PUBLIC;
