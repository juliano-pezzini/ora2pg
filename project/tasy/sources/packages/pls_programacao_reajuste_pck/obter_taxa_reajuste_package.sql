-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pls_programacao_reajuste_pck.obter_taxa_reajuste ( nr_seq_tipo_reajuste_p pls_tipo_reajuste.nr_sequencia%type, nr_seq_contrato_p pls_contrato.nr_sequencia%type, dt_referencia_p timestamp) RETURNS bigint AS $body$
DECLARE

nr_seq_indice_reajuste_w	pls_tipo_reajuste_regra.nr_seq_indice_reajuste%type;
ie_indice_contrato_w		pls_tipo_reajuste_regra.ie_indice_contrato%type;
vl_cotacao_w			cotacao_moeda.vl_cotacao%type := 0;

BEGIN
select	max(nr_seq_indice_reajuste),
	max(ie_indice_contrato)
into STRICT	nr_seq_indice_reajuste_w,
	ie_indice_contrato_w
from	pls_tipo_reajuste_regra
where	nr_seq_regra	= nr_seq_tipo_reajuste_p;

if (ie_indice_contrato_w = 'S') then
	select	coalesce(nr_seq_indice_reajuste,nr_seq_indice_reajuste_w)
	into STRICT	nr_seq_indice_reajuste_w
	from	pls_contrato
	where	nr_sequencia	= nr_seq_contrato_p;
end if;

if (coalesce(nr_seq_indice_reajuste_w,0) <> 0) then
	select	max(b.vl_cotacao)
	into STRICT	vl_cotacao_w
	from	moeda		a,
		cotacao_moeda	b
	where	a.cd_moeda	= nr_seq_indice_reajuste_w
	and	a.cd_moeda	= b.cd_moeda
	and	trunc(b.dt_cotacao, 'month')	= trunc(dt_referencia_p, 'month');
	
	if (coalesce(vl_cotacao_w,0) = 0) then
		begin
		select	max(b.vl_cotacao)
		into STRICT	vl_cotacao_w
		from	moeda		a,
			cotacao_moeda	b
		where	a.cd_moeda	= nr_seq_indice_reajuste_w
		and	a.cd_moeda	= b.cd_moeda
		and	b.dt_cotacao = (SELECT	max(x.dt_cotacao)
					from	cotacao_moeda x
					where	x.cd_moeda	= a.cd_moeda
					and	trunc(x.dt_cotacao, 'month')	< trunc(dt_referencia_p, 'month'));
		exception
		when others then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(293638);
			--Verifique se o indice foi informado no cadastro de moedas. (Shift + F11 -> Aplicacao Principal -> Cadastros Gerais -> Moedas).

		end;
	end if;
end if;

return vl_cotacao_w;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pls_programacao_reajuste_pck.obter_taxa_reajuste ( nr_seq_tipo_reajuste_p pls_tipo_reajuste.nr_sequencia%type, nr_seq_contrato_p pls_contrato.nr_sequencia%type, dt_referencia_p timestamp) FROM PUBLIC;
