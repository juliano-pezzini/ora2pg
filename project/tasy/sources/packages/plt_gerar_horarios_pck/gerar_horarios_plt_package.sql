-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE plt_gerar_horarios_pck.gerar_horarios_plt ( cd_estabelecimento_p bigint, cd_setor_usuario_p bigint, cd_perfil_p bigint, nm_usuario_p text, nr_atendimento_p bigint, dt_inicial_p timestamp, dt_final_p timestamp, ie_prescr_usuario_p text, ie_exibir_sae_p text, ie_sol_continuas_p text, ie_sol_vigentes_p text, ie_edicao_p text, ie_estendidos_p bigint, dt_referencia_p timestamp, ie_exibir_hor_suspensos_p text, dt_plano_p text, cd_pessoa_fisica_p text, nr_seq_modelo_p integer) AS $body$
DECLARE

				
	i							integer		:= 0;
	j							integer		:= 0;
	k							integer		:= 0;

	nr_seq_wadep_w				bigint;
	nr_sequencia_w				bigint;
	current_setting('plt_gerar_horarios_pck.nr_prescricoes_w')::varchar(4000)			varchar(255);
	ie_funcao_prescritor_w		varchar(5);
	qt_virgula_w				numeric(20);
	qt_virgula_ww				numeric(20);	
	nr_prescr_w					bigint;
	ds_funcoes_prescr_w			varchar(250);
	ie_valida_w					varchar(1);
	cont_w						bigint;
	ie_curta_duracao_w			varchar(1);
	cd_setor_atendimento_w		bigint;
	nr_prescricao_liberar_w		bigint;
	nr_prescricao_estendida_w	bigint;
	
	c01 CURSOR FOR
	SELECT	coalesce(ie_dieta_oral,'S'),
		coalesce(ie_suplemento_oral,'S'),
		coalesce(ie_solucao,'S'),
		coalesce(ie_medicamento,'S'),
		coalesce(ie_material,'R'),
		coalesce(ie_procedimento,'S'),
		coalesce(ie_coleta,'S'),
		coalesce(ie_ccg,'S'),
		coalesce(ie_cig,'S'),
		coalesce(ie_recomendacao,'S'),
		coalesce(ie_sae,'S'),
		coalesce(ie_ivc,'N'),
		coalesce(ie_oxigenio,'N'),
		coalesce(ie_hemoterapia,'N'),
		coalesce(ie_sup_nutricional,'N'),
		coalesce(ie_npt_adulta,'N'),
		coalesce(ie_npt_neonatal,'N'),
		coalesce(ie_dialise,'N'),
		coalesce(ie_leite_deriv,'N'),
		coalesce(ie_npt_pediatrica,'N')
	from	adep_regra_inclusao
	where	cd_estabelecimento				= cd_estabelecimento_p
	and	coalesce(cd_setor_atendimento,current_setting('plt_gerar_horarios_pck.cd_setor_usuario_w')::setor_atendimento.cd_setor_atendimento%type)	= current_setting('plt_gerar_horarios_pck.cd_setor_usuario_w')::setor_atendimento.cd_setor_atendimento%type
	and	coalesce(cd_perfil,current_setting('plt_gerar_horarios_pck.cd_perfil_w')::perfil.cd_perfil%type)			= current_setting('plt_gerar_horarios_pck.cd_perfil_w')::perfil.cd_perfil%type
	order by
		coalesce(cd_setor_atendimento,99999) desc,
		coalesce(cd_perfil,99999) desc,
		nr_sequencia;	
	
	c02 CURSOR FOR
	SELECT	dt_horario
	from	w_rep_horarios_t
	where	nm_usuario = nm_usuario_p
	and	(dt_horario IS NOT NULL AND dt_horario::text <> '')
	group by
		dt_horario
	order by
		dt_horario;

	c03 CURSOR FOR
	SELECT	nr_sequencia,
		nr_prescricoes
	from	w_rep_t
	where	nm_usuario = nm_usuario_p
	and	(nr_prescricoes IS NOT NULL AND nr_prescricoes::text <> '');
		
	
BEGIN
	CALL CALL plt_gerar_horarios_pck.set_parametros_funcao(	cd_estabelecimento_p,
				cd_perfil_p, 
				nm_usuario_p);
	select	max(cd_pessoa_fisica)
	into STRICT	current_setting('plt_gerar_horarios_pck.cd_pessoa_usuario_w')::pessoa_fisica.cd_pessoa_fisica%type
	from	usuario
	where	nm_usuario	= nm_usuario_p;
	
	PERFORM set_config('plt_gerar_horarios_pck.cd_especialidade_w', obter_especialidade_medico2(current_setting('plt_gerar_horarios_pck.cd_pessoa_usuario_w')::pessoa_fisica.cd_pessoa_fisica%type), false);
	
	select	count(*)
	into STRICT	cont_w
	from	w_rep_t
	where	nm_usuario = nm_usuario_p;
	
	if (coalesce(nr_atendimento_p,0) > 0) then
		cd_setor_atendimento_w := obter_setor_atendimento(nr_atendimento_p);
	end if;
	
	if (cont_w > 0) then
		
		select	coalesce(max(ie_atualizar_dieta),'S'),
				coalesce(max(ie_atualizar_jejum),'S'),
				coalesce(max(ie_atualizar_supl),'S'),
				coalesce(max(ie_atualizar_sne),'S'),
				coalesce(max(ie_atualizar_npt_adulta),'S'),
				coalesce(max(ie_atualizar_npt_neo),'S'),
				coalesce(max(ie_atualizar_npt_ped),'S'),
				coalesce(max(ie_atualizar_leite),'S'),
				coalesce(max(ie_atualizar_solucao),'S'),
				coalesce(max(ie_atualizar_medic),'S'),
				coalesce(max(ie_atualizar_material),'S'),
				coalesce(max(ie_atualizar_proced),'S'),
				coalesce(max(ie_atualizar_lab),'S'),
				coalesce(max(ie_atualizar_ccg),'S'),
				coalesce(max(ie_atualizar_cig),'S'),
				coalesce(max(ie_atualizar_ivc),'S'),
				coalesce(max(ie_atualizar_gas),'S'),
				coalesce(max(ie_atualizar_hemoterap),'S'),
				coalesce(max(ie_atualizar_rec),'S'),
				coalesce(max(ie_atualizar_dialise),'S')
		into STRICT	current_setting('plt_gerar_horarios_pck.ie_atualizar_dieta_w')::char(1),
				current_setting('plt_gerar_horarios_pck.ie_atualizar_jejum_w')::char(1),
				current_setting('plt_gerar_horarios_pck.ie_atualizar_supl_w')::char(1),
				current_setting('plt_gerar_horarios_pck.ie_atualizar_sne_w')::char(1),
				current_setting('plt_gerar_horarios_pck.ie_atualizar_npt_adulta_w')::char(1),
				current_setting('plt_gerar_horarios_pck.ie_atualizar_npt_neo_w')::char(1),
				current_setting('plt_gerar_horarios_pck.ie_atualizar_npt_ped_w')::char(1),
				current_setting('plt_gerar_horarios_pck.ie_atualizar_leite_w')::char(1),
				current_setting('plt_gerar_horarios_pck.ie_atualizar_solucao_w')::char(1),
				current_setting('plt_gerar_horarios_pck.ie_atualizar_medic_w')::char(1),
				current_setting('plt_gerar_horarios_pck.ie_atualizar_material_w')::char(1),
				current_setting('plt_gerar_horarios_pck.ie_atualizar_proced_w')::char(1),
				current_setting('plt_gerar_horarios_pck.ie_atualizar_lab_w')::char(1),
				current_setting('plt_gerar_horarios_pck.ie_atualizar_ccg_w')::char(1),
				current_setting('plt_gerar_horarios_pck.ie_atualizar_cig_w')::char(1),
				current_setting('plt_gerar_horarios_pck.ie_atualizar_ivc_w')::char(1),
				current_setting('plt_gerar_horarios_pck.ie_atualizar_gas_w')::char(1),
				current_setting('plt_gerar_horarios_pck.ie_atualizar_hemoterap_w')::char(1),
				current_setting('plt_gerar_horarios_pck.ie_atualizar_rec_w')::char(1),
				current_setting('plt_gerar_horarios_pck.ie_atualizar_dialise_w')::char(1)
		from	plt_controle
		where	cd_pessoa_fisica	= cd_pessoa_fisica_p
		and	coalesce(nr_atendimento,coalesce(nr_atendimento_p,0))	= coalesce(nr_atendimento_p,0)
		and	nm_usuario		= nm_usuario_p;		
	end if;

	PERFORM set_config('plt_gerar_horarios_pck.ie_atualizar_dieta_w', 'S', false);
	PERFORM set_config('plt_gerar_horarios_pck.ie_atualizar_jejum_w', 'S', false);
	PERFORM set_config('plt_gerar_horarios_pck.ie_atualizar_supl_w', 'S', false);
	PERFORM set_config('plt_gerar_horarios_pck.ie_atualizar_sne_w', 'S', false);
	PERFORM set_config('plt_gerar_horarios_pck.ie_atualizar_npt_adulta_w', 'S', false);
	PERFORM set_config('plt_gerar_horarios_pck.ie_atualizar_npt_neo_w', 'S', false);
	PERFORM set_config('plt_gerar_horarios_pck.ie_atualizar_npt_ped_w', 'S', false);
	PERFORM set_config('plt_gerar_horarios_pck.ie_atualizar_leite_w', 'S', false);
	PERFORM set_config('plt_gerar_horarios_pck.ie_atualizar_solucao_w', 'S', false);
	PERFORM set_config('plt_gerar_horarios_pck.ie_atualizar_medic_w', 'S', false);
	PERFORM set_config('plt_gerar_horarios_pck.ie_atualizar_material_w', 'S', false);
	PERFORM set_config('plt_gerar_horarios_pck.ie_atualizar_proced_w', 'S', false);
	PERFORM set_config('plt_gerar_horarios_pck.ie_atualizar_lab_w', 'S', false);
	PERFORM set_config('plt_gerar_horarios_pck.ie_atualizar_ccg_w', 'S', false);
	PERFORM set_config('plt_gerar_horarios_pck.ie_atualizar_cig_w', 'S', false);
	PERFORM set_config('plt_gerar_horarios_pck.ie_atualizar_ivc_w', 'S', false);
	PERFORM set_config('plt_gerar_horarios_pck.ie_atualizar_gas_w', 'S', false);
	PERFORM set_config('plt_gerar_horarios_pck.ie_atualizar_hemoterap_w', 'S', false);
	PERFORM set_config('plt_gerar_horarios_pck.ie_atualizar_rec_w', 'S', false);
	PERFORM set_config('plt_gerar_horarios_pck.ie_atualizar_dialise_w', 'S', false);

	PERFORM set_config('plt_gerar_horarios_pck.ie_tipo_item_atualizar_2w', null, false);
	if (current_setting('plt_gerar_horarios_pck.ie_atualizar_dieta_w')::char(1) = 'S') then
		PERFORM set_config('plt_gerar_horarios_pck.ie_tipo_item_atualizar_2w', 'D', false);
	end if;
	
	if (current_setting('plt_gerar_horarios_pck.ie_atualizar_jejum_w')::char(1) = 'S') then
		if (current_setting('plt_gerar_horarios_pck.ie_tipo_item_atualizar_2w')::coalesce(varchar(255)::text, '') = '') then
			PERFORM set_config('plt_gerar_horarios_pck.ie_tipo_item_atualizar_2w', 'J', false);
		else
			PERFORM set_config('plt_gerar_horarios_pck.ie_tipo_item_atualizar_2w', current_setting('plt_gerar_horarios_pck.ie_tipo_item_atualizar_2w')::varchar(255) || ',J', false);
		end if;
	end if;

	if (current_setting('plt_gerar_horarios_pck.ie_atualizar_supl_w')::char(1) = 'S') then
		if (current_setting('plt_gerar_horarios_pck.ie_tipo_item_atualizar_2w')::coalesce(varchar(255)::text, '') = '') then
			PERFORM set_config('plt_gerar_horarios_pck.ie_tipo_item_atualizar_2w', 'S', false);
		else
			PERFORM set_config('plt_gerar_horarios_pck.ie_tipo_item_atualizar_2w', current_setting('plt_gerar_horarios_pck.ie_tipo_item_atualizar_2w')::varchar(255) || ',S', false);
		end if;
	end if;
	
	if (current_setting('plt_gerar_horarios_pck.ie_atualizar_sne_w')::char(1) = 'S') then
		if (current_setting('plt_gerar_horarios_pck.ie_tipo_item_atualizar_2w')::coalesce(varchar(255)::text, '') = '') then
			PERFORM set_config('plt_gerar_horarios_pck.ie_tipo_item_atualizar_2w', 'SNE', false);
		else
			PERFORM set_config('plt_gerar_horarios_pck.ie_tipo_item_atualizar_2w', current_setting('plt_gerar_horarios_pck.ie_tipo_item_atualizar_2w')::varchar(255) || ',SNE', false);
		end if;
	end if;
	
	if (current_setting('plt_gerar_horarios_pck.ie_atualizar_npt_adulta_w')::char(1) = 'S') then
		if (current_setting('plt_gerar_horarios_pck.ie_tipo_item_atualizar_2w')::coalesce(varchar(255)::text, '') = '') then
			PERFORM set_config('plt_gerar_horarios_pck.ie_tipo_item_atualizar_2w', 'NPA', false);
		else
			PERFORM set_config('plt_gerar_horarios_pck.ie_tipo_item_atualizar_2w', current_setting('plt_gerar_horarios_pck.ie_tipo_item_atualizar_2w')::varchar(255) || ',NPA', false);
		end if;
	end if;
	
	if (current_setting('plt_gerar_horarios_pck.ie_atualizar_npt_neo_w')::char(1) = 'S') then
		if (current_setting('plt_gerar_horarios_pck.ie_tipo_item_atualizar_2w')::coalesce(varchar(255)::text, '') = '') then
			PERFORM set_config('plt_gerar_horarios_pck.ie_tipo_item_atualizar_2w', 'NPO', false);
		else
			PERFORM set_config('plt_gerar_horarios_pck.ie_tipo_item_atualizar_2w', current_setting('plt_gerar_horarios_pck.ie_tipo_item_atualizar_2w')::varchar(255) || ',NPO', false);
		end if;
	end if;
	
	if (current_setting('plt_gerar_horarios_pck.ie_atualizar_npt_ped_w')::char(1) = 'S') then
		if (current_setting('plt_gerar_horarios_pck.ie_tipo_item_atualizar_2w')::coalesce(varchar(255)::text, '') = '') then
			PERFORM set_config('plt_gerar_horarios_pck.ie_tipo_item_atualizar_2w', 'NPP', false);
		else
			PERFORM set_config('plt_gerar_horarios_pck.ie_tipo_item_atualizar_2w', current_setting('plt_gerar_horarios_pck.ie_tipo_item_atualizar_2w')::varchar(255) || ',NPP', false);
		end if;
	end if;
	
	if (current_setting('plt_gerar_horarios_pck.ie_atualizar_leite_w')::char(1) = 'S') then
		if (current_setting('plt_gerar_horarios_pck.ie_tipo_item_atualizar_2w')::coalesce(varchar(255)::text, '') = '') then
			PERFORM set_config('plt_gerar_horarios_pck.ie_tipo_item_atualizar_2w', 'LD', false);
		else
			PERFORM set_config('plt_gerar_horarios_pck.ie_tipo_item_atualizar_2w', current_setting('plt_gerar_horarios_pck.ie_tipo_item_atualizar_2w')::varchar(255) || ',LD', false);
		end if;
	end if;
	
	if (current_setting('plt_gerar_horarios_pck.ie_atualizar_solucao_w')::char(1) = 'S') then
		if (current_setting('plt_gerar_horarios_pck.ie_tipo_item_atualizar_2w')::coalesce(varchar(255)::text, '') = '') then
			PERFORM set_config('plt_gerar_horarios_pck.ie_tipo_item_atualizar_2w', 'SOL', false);
		else
			PERFORM set_config('plt_gerar_horarios_pck.ie_tipo_item_atualizar_2w', current_setting('plt_gerar_horarios_pck.ie_tipo_item_atualizar_2w')::varchar(255) || ',SOL', false);
		end if;
	end if;
	
	if (current_setting('plt_gerar_horarios_pck.ie_atualizar_medic_w')::char(1) = 'S') then
		if (current_setting('plt_gerar_horarios_pck.ie_tipo_item_atualizar_2w')::coalesce(varchar(255)::text, '') = '') then
			PERFORM set_config('plt_gerar_horarios_pck.ie_tipo_item_atualizar_2w', 'M', false);
		else
			PERFORM set_config('plt_gerar_horarios_pck.ie_tipo_item_atualizar_2w', current_setting('plt_gerar_horarios_pck.ie_tipo_item_atualizar_2w')::varchar(255) || ',M', false);
		end if;
	end if;
	
	if (current_setting('plt_gerar_horarios_pck.ie_atualizar_material_w')::char(1) = 'S') then
		if (current_setting('plt_gerar_horarios_pck.ie_tipo_item_atualizar_2w')::coalesce(varchar(255)::text, '') = '') then
			PERFORM set_config('plt_gerar_horarios_pck.ie_tipo_item_atualizar_2w', 'MAT', false);
		else
			PERFORM set_config('plt_gerar_horarios_pck.ie_tipo_item_atualizar_2w', current_setting('plt_gerar_horarios_pck.ie_tipo_item_atualizar_2w')::varchar(255) || ',MAT', false);
		end if;
	end if;
	
	if (current_setting('plt_gerar_horarios_pck.ie_atualizar_proced_w')::char(1) = 'S') then
		if (current_setting('plt_gerar_horarios_pck.ie_tipo_item_atualizar_2w')::coalesce(varchar(255)::text, '') = '') then
			PERFORM set_config('plt_gerar_horarios_pck.ie_tipo_item_atualizar_2w', 'P', false);
		else
			PERFORM set_config('plt_gerar_horarios_pck.ie_tipo_item_atualizar_2w', current_setting('plt_gerar_horarios_pck.ie_tipo_item_atualizar_2w')::varchar(255) || ',P', false);
		end if;
	end if;
	
	if (current_setting('plt_gerar_horarios_pck.ie_atualizar_lab_w')::char(1) = 'S') then
		if (current_setting('plt_gerar_horarios_pck.ie_tipo_item_atualizar_2w')::coalesce(varchar(255)::text, '') = '') then
			PERFORM set_config('plt_gerar_horarios_pck.ie_tipo_item_atualizar_2w', 'L', false);
		else
			PERFORM set_config('plt_gerar_horarios_pck.ie_tipo_item_atualizar_2w', current_setting('plt_gerar_horarios_pck.ie_tipo_item_atualizar_2w')::varchar(255) || ',L', false);
		end if;
	end if;
	
	if (current_setting('plt_gerar_horarios_pck.ie_atualizar_ccg_w')::char(1) = 'S') then
		if (current_setting('plt_gerar_horarios_pck.ie_tipo_item_atualizar_2w')::coalesce(varchar(255)::text, '') = '') then
			PERFORM set_config('plt_gerar_horarios_pck.ie_tipo_item_atualizar_2w', 'G', false);
		else
			PERFORM set_config('plt_gerar_horarios_pck.ie_tipo_item_atualizar_2w', current_setting('plt_gerar_horarios_pck.ie_tipo_item_atualizar_2w')::varchar(255) || ',G', false);
		end if;
	end if;
	
	if (current_setting('plt_gerar_horarios_pck.ie_atualizar_cig_w')::char(1) = 'S') then
		if (current_setting('plt_gerar_horarios_pck.ie_tipo_item_atualizar_2w')::coalesce(varchar(255)::text, '') = '') then
			PERFORM set_config('plt_gerar_horarios_pck.ie_tipo_item_atualizar_2w', 'C', false);
		else
			PERFORM set_config('plt_gerar_horarios_pck.ie_tipo_item_atualizar_2w', current_setting('plt_gerar_horarios_pck.ie_tipo_item_atualizar_2w')::varchar(255) || ',C', false);
		end if;
	end if;
	
	if (current_setting('plt_gerar_horarios_pck.ie_atualizar_ivc_w')::char(1) = 'S') then
		if (current_setting('plt_gerar_horarios_pck.ie_tipo_item_atualizar_2w')::coalesce(varchar(255)::text, '') = '') then
			PERFORM set_config('plt_gerar_horarios_pck.ie_tipo_item_atualizar_2w', 'IVC', false);
		else
			PERFORM set_config('plt_gerar_horarios_pck.ie_tipo_item_atualizar_2w', current_setting('plt_gerar_horarios_pck.ie_tipo_item_atualizar_2w')::varchar(255) || ',IVC', false);
		end if;
	end if;
	
	if (current_setting('plt_gerar_horarios_pck.ie_atualizar_gas_w')::char(1) = 'S') then
		if (current_setting('plt_gerar_horarios_pck.ie_tipo_item_atualizar_2w')::coalesce(varchar(255)::text, '') = '') then
			PERFORM set_config('plt_gerar_horarios_pck.ie_tipo_item_atualizar_2w', 'O', false);
		else
			PERFORM set_config('plt_gerar_horarios_pck.ie_tipo_item_atualizar_2w', current_setting('plt_gerar_horarios_pck.ie_tipo_item_atualizar_2w')::varchar(255) || ',O', false);
		end if;
	end if;
	
	if (current_setting('plt_gerar_horarios_pck.ie_atualizar_hemoterap_w')::char(1) = 'S') then
		if (current_setting('plt_gerar_horarios_pck.ie_tipo_item_atualizar_2w')::coalesce(varchar(255)::text, '') = '') then
			PERFORM set_config('plt_gerar_horarios_pck.ie_tipo_item_atualizar_2w', 'HM', false);
		else
			PERFORM set_config('plt_gerar_horarios_pck.ie_tipo_item_atualizar_2w', current_setting('plt_gerar_horarios_pck.ie_tipo_item_atualizar_2w')::varchar(255) || ',HM', false);
		end if;
	end if;
	
	if (current_setting('plt_gerar_horarios_pck.ie_atualizar_rec_w')::char(1) = 'S') then
		if (current_setting('plt_gerar_horarios_pck.ie_tipo_item_atualizar_2w')::coalesce(varchar(255)::text, '') = '') then
			PERFORM set_config('plt_gerar_horarios_pck.ie_tipo_item_atualizar_2w', 'R', false);
		else
			PERFORM set_config('plt_gerar_horarios_pck.ie_tipo_item_atualizar_2w', current_setting('plt_gerar_horarios_pck.ie_tipo_item_atualizar_2w')::varchar(255) || ',R', false);
		end if;
	end if;
	
	if (current_setting('plt_gerar_horarios_pck.ie_atualizar_dialise_w')::char(1) = 'S') then
		if (current_setting('plt_gerar_horarios_pck.ie_tipo_item_atualizar_2w')::coalesce(varchar(255)::text, '') = '') then
			PERFORM set_config('plt_gerar_horarios_pck.ie_tipo_item_atualizar_2w', 'DI', false);
		else
			PERFORM set_config('plt_gerar_horarios_pck.ie_tipo_item_atualizar_2w', current_setting('plt_gerar_horarios_pck.ie_tipo_item_atualizar_2w')::varchar(255) || ',DI', false);
		end if;
	end if;	

	if (current_setting('plt_gerar_horarios_pck.ie_atualizar_medic_w')::char(1) = 'N') then
		delete from w_rep_t
		where	nm_usuario = nm_usuario_p
		and	ie_tipo_item	<> 'M';
		CALL exec_sql_dinamico(nm_usuario_p, 'truncate table w_rep_horarios_t');
	else
		CALL exec_sql_dinamico(nm_usuario_p, 'truncate table w_rep_t');
		CALL exec_sql_dinamico(nm_usuario_p, 'truncate table w_rep_horarios_t');
	end if;	

	PERFORM set_config('plt_gerar_horarios_pck.cd_setor_usuario_w', coalesce(cd_setor_usuario_p,0), false);
	PERFORM set_config('plt_gerar_horarios_pck.cd_perfil_w', coalesce(cd_perfil_p,0), false);
	

	if (get_ie_regra_inclusao = 'S') then
		open c01;
		loop
		fetch c01 into	current_setting('plt_gerar_horarios_pck.ie_regra_incl_dieta_oral_w')::char(1),
				current_setting('plt_gerar_horarios_pck.ie_regra_incl_supl_oral_w')::char(1),
				current_setting('plt_gerar_horarios_pck.ie_regra_incl_solucao_w')::char(1),
				current_setting('plt_gerar_horarios_pck.ie_regra_incl_medicamento_w')::char(1),
				current_setting('plt_gerar_horarios_pck.ie_regra_incl_material_w')::char(1),
				current_setting('plt_gerar_horarios_pck.ie_regra_incl_procedimento_w')::char(1),
				current_setting('plt_gerar_horarios_pck.ie_regra_incl_coleta_w')::char(1),
				current_setting('plt_gerar_horarios_pck.ie_regra_incl_ccg_w')::char(1),
				current_setting('plt_gerar_horarios_pck.ie_regra_incl_cig_w')::char(1),
				current_setting('plt_gerar_horarios_pck.ie_regra_incl_recomendacao_w')::char(1),
				current_setting('plt_gerar_horarios_pck.ie_regra_incl_intervencao_w')::char(1),
				current_setting('plt_gerar_horarios_pck.ie_regra_incl_ivc_w')::char(1),
				current_setting('plt_gerar_horarios_pck.ie_regra_incl_gas_w')::char(1),
				current_setting('plt_gerar_horarios_pck.ie_regra_incl_hemoterapia_w')::char(1),
				current_setting('plt_gerar_horarios_pck.ie_regra_incl_sne_w')::char(1),
				current_setting('plt_gerar_horarios_pck.ie_regra_incl_npt_adulta_w')::char(1),
				current_setting('plt_gerar_horarios_pck.ie_regra_incl_npt_neonatal_w')::char(1),
				current_setting('plt_gerar_horarios_pck.ie_regra_incl_dialise_w')::char(1),
				current_setting('plt_gerar_horarios_pck.ie_regra_incl_leite_w')::char(1),
				current_setting('plt_gerar_horarios_pck.ie_regra_incl_npt_pediatrica_w')::char(1);
		EXIT WHEN NOT FOUND; /* apply on c01 */
			begin
			PERFORM set_config('plt_gerar_horarios_pck.ie_regra_incl_dieta_oral_w', current_setting('plt_gerar_horarios_pck.ie_regra_incl_dieta_oral_w')::char(1), false);
			PERFORM set_config('plt_gerar_horarios_pck.ie_regra_incl_supl_oral_w', current_setting('plt_gerar_horarios_pck.ie_regra_incl_supl_oral_w')::char(1), false);
			PERFORM set_config('plt_gerar_horarios_pck.ie_regra_incl_solucao_w', current_setting('plt_gerar_horarios_pck.ie_regra_incl_solucao_w')::char(1), false);
			PERFORM set_config('plt_gerar_horarios_pck.ie_regra_incl_medicamento_w', current_setting('plt_gerar_horarios_pck.ie_regra_incl_medicamento_w')::char(1), false);
			PERFORM set_config('plt_gerar_horarios_pck.ie_regra_incl_material_w', current_setting('plt_gerar_horarios_pck.ie_regra_incl_material_w')::char(1), false);
			PERFORM set_config('plt_gerar_horarios_pck.ie_regra_incl_procedimento_w', current_setting('plt_gerar_horarios_pck.ie_regra_incl_procedimento_w')::char(1), false);
			PERFORM set_config('plt_gerar_horarios_pck.ie_regra_incl_coleta_w', current_setting('plt_gerar_horarios_pck.ie_regra_incl_coleta_w')::char(1), false);
			PERFORM set_config('plt_gerar_horarios_pck.ie_regra_incl_ccg_w', current_setting('plt_gerar_horarios_pck.ie_regra_incl_ccg_w')::char(1), false);
			PERFORM set_config('plt_gerar_horarios_pck.ie_regra_incl_cig_w', current_setting('plt_gerar_horarios_pck.ie_regra_incl_cig_w')::char(1), false);
			PERFORM set_config('plt_gerar_horarios_pck.ie_regra_incl_recomendacao_w', current_setting('plt_gerar_horarios_pck.ie_regra_incl_recomendacao_w')::char(1), false);
			PERFORM set_config('plt_gerar_horarios_pck.ie_regra_incl_intervencao_w', current_setting('plt_gerar_horarios_pck.ie_regra_incl_intervencao_w')::char(1), false);
			PERFORM set_config('plt_gerar_horarios_pck.ie_regra_incl_ivc_w', current_setting('plt_gerar_horarios_pck.ie_regra_incl_ivc_w')::char(1), false);
			PERFORM set_config('plt_gerar_horarios_pck.ie_regra_incl_gas_w', current_setting('plt_gerar_horarios_pck.ie_regra_incl_gas_w')::char(1), false);
			PERFORM set_config('plt_gerar_horarios_pck.ie_regra_incl_hemoterapia_w', current_setting('plt_gerar_horarios_pck.ie_regra_incl_hemoterapia_w')::char(1), false);
			PERFORM set_config('plt_gerar_horarios_pck.ie_regra_incl_jejum_w', current_setting('plt_gerar_horarios_pck.ie_regra_incl_dieta_oral_w')::char(1), false);
			PERFORM set_config('plt_gerar_horarios_pck.ie_regra_incl_sne_w', current_setting('plt_gerar_horarios_pck.ie_regra_incl_sne_w')::char(1), false);
			PERFORM set_config('plt_gerar_horarios_pck.ie_regra_incl_npt_adulta_w', current_setting('plt_gerar_horarios_pck.ie_regra_incl_npt_adulta_w')::char(1), false);
			PERFORM set_config('plt_gerar_horarios_pck.ie_regra_incl_npt_neonatal_w', current_setting('plt_gerar_horarios_pck.ie_regra_incl_npt_neonatal_w')::char(1), false);
			PERFORM set_config('plt_gerar_horarios_pck.ie_regra_incl_dialise_w', current_setting('plt_gerar_horarios_pck.ie_regra_incl_dialise_w')::char(1), false);
			PERFORM set_config('plt_gerar_horarios_pck.ie_regra_incl_leite_w', current_setting('plt_gerar_horarios_pck.ie_regra_incl_leite_w')::char(1), false);
			PERFORM set_config('plt_gerar_horarios_pck.ie_regra_incl_npt_pediatrica_w', current_setting('plt_gerar_horarios_pck.ie_regra_incl_npt_pediatrica_w')::char(1), false);
			end;
		end loop;
		close c01;				
	else
		PERFORM set_config('plt_gerar_horarios_pck.ie_regra_incl_dieta_oral_w', 'S', false);
		PERFORM set_config('plt_gerar_horarios_pck.ie_regra_incl_supl_oral_w', 'S', false);
		PERFORM set_config('plt_gerar_horarios_pck.ie_regra_incl_solucao_w', 'S', false);
		PERFORM set_config('plt_gerar_horarios_pck.ie_regra_incl_medicamento_w', 'S', false);
		PERFORM set_config('plt_gerar_horarios_pck.ie_regra_incl_material_w', 'S', false);
		PERFORM set_config('plt_gerar_horarios_pck.ie_regra_incl_procedimento_w', 'S', false);
		PERFORM set_config('plt_gerar_horarios_pck.ie_regra_incl_coleta_w', 'S', false);
		PERFORM set_config('plt_gerar_horarios_pck.ie_regra_incl_ccg_w', 'S', false);
		PERFORM set_config('plt_gerar_horarios_pck.ie_regra_incl_cig_w', 'S', false);
		PERFORM set_config('plt_gerar_horarios_pck.ie_regra_incl_recomendacao_w', 'S', false);
		PERFORM set_config('plt_gerar_horarios_pck.ie_regra_incl_intervencao_w', 'S', false);
		PERFORM set_config('plt_gerar_horarios_pck.ie_regra_incl_ivc_w', 'S', false);
		PERFORM set_config('plt_gerar_horarios_pck.ie_regra_incl_gas_w', 'S', false);
		PERFORM set_config('plt_gerar_horarios_pck.ie_regra_incl_hemoterapia_w', 'S', false);
		PERFORM set_config('plt_gerar_horarios_pck.ie_regra_incl_jejum_w', 'S', false);
		PERFORM set_config('plt_gerar_horarios_pck.ie_regra_incl_sne_w', 'S', false);
		PERFORM set_config('plt_gerar_horarios_pck.ie_regra_incl_npt_adulta_w', 'S', false);
		PERFORM set_config('plt_gerar_horarios_pck.ie_regra_incl_npt_pediatrica_w', 'S', false);
		PERFORM set_config('plt_gerar_horarios_pck.ie_regra_incl_npt_neonatal_w', 'S', false);
		PERFORM set_config('plt_gerar_horarios_pck.ie_regra_incl_dialise_w', 'S', false);
		PERFORM set_config('plt_gerar_horarios_pck.ie_regra_incl_leite_w', 'S', false);
	end if;
	
	if (nr_seq_modelo_p	> 0) then
		
		select	coalesce(max(ie_hemodialise),'S')
		into STRICT	current_setting('plt_gerar_horarios_pck.ie_dialise_modelo_w')::varchar(1)
		from	adep_modelo_visualizacao
		where	nr_sequencia = nr_seq_modelo_p;

		if (current_setting('plt_gerar_horarios_pck.ie_regra_incl_dieta_oral_w')::char(1)	<> 'N') then
			PERFORM set_config('plt_gerar_horarios_pck.ie_regra_incl_dieta_oral_w', ADEP_obter_se_item_modelo('D',nr_seq_modelo_p,'N'), false);
		end if;
		if (current_setting('plt_gerar_horarios_pck.ie_regra_incl_supl_oral_w')::char(1)	<> 'N') then
			PERFORM set_config('plt_gerar_horarios_pck.ie_regra_incl_supl_oral_w', ADEP_obter_se_item_modelo('S',nr_seq_modelo_p,'N'), false);
		end if;		
		if (current_setting('plt_gerar_horarios_pck.ie_regra_incl_solucao_w')::char(1)	<> 'N') then
			PERFORM set_config('plt_gerar_horarios_pck.ie_regra_incl_solucao_w', ADEP_obter_se_item_modelo('SOL',nr_seq_modelo_p,'N'), false);
		end if;		
		if (current_setting('plt_gerar_horarios_pck.ie_regra_incl_medicamento_w')::char(1)	<> 'N') then
			PERFORM set_config('plt_gerar_horarios_pck.ie_regra_incl_medicamento_w', ADEP_obter_se_item_modelo('M',nr_seq_modelo_p,'N'), false);
		end if;		
		if (current_setting('plt_gerar_horarios_pck.ie_regra_incl_material_w')::char(1)	<> 'N') then
			PERFORM set_config('plt_gerar_horarios_pck.ie_regra_incl_material_w', ADEP_obter_se_item_modelo('MAT',nr_seq_modelo_p,'N'), false);
		end if;		
		if (current_setting('plt_gerar_horarios_pck.ie_regra_incl_coleta_w')::char(1)	<> 'N') then
			PERFORM set_config('plt_gerar_horarios_pck.ie_regra_incl_coleta_w', ADEP_obter_se_item_modelo('L',nr_seq_modelo_p,'N'), false);
		end if;		
		if (current_setting('plt_gerar_horarios_pck.ie_regra_incl_ccg_w')::char(1)	<> 'N') then
			PERFORM set_config('plt_gerar_horarios_pck.ie_regra_incl_ccg_w', ADEP_obter_se_item_modelo('G',nr_seq_modelo_p,'N'), false);
		end if;		
		if (current_setting('plt_gerar_horarios_pck.ie_regra_incl_cig_w')::char(1)	<> 'N') then
			PERFORM set_config('plt_gerar_horarios_pck.ie_regra_incl_cig_w', ADEP_obter_se_item_modelo('C',nr_seq_modelo_p,'N'), false);
		end if;		
		if (current_setting('plt_gerar_horarios_pck.ie_regra_incl_recomendacao_w')::char(1)	<> 'N') then
			PERFORM set_config('plt_gerar_horarios_pck.ie_regra_incl_recomendacao_w', ADEP_obter_se_item_modelo('R',nr_seq_modelo_p,'N'), false);
		end if;		
		if (current_setting('plt_gerar_horarios_pck.ie_regra_incl_intervencao_w')::char(1)	<> 'N') then
			PERFORM set_config('plt_gerar_horarios_pck.ie_regra_incl_intervencao_w', ADEP_obter_se_item_modelo('E',nr_seq_modelo_p,'N'), false);
		end if;		
		if (current_setting('plt_gerar_horarios_pck.ie_regra_incl_ivc_w')::char(1)	<> 'N') then
			PERFORM set_config('plt_gerar_horarios_pck.ie_regra_incl_ivc_w', ADEP_obter_se_item_modelo('I',nr_seq_modelo_p,'N'), false);
		end if;		
		if (current_setting('plt_gerar_horarios_pck.ie_regra_incl_gas_w')::char(1)	<> 'N') then
			PERFORM set_config('plt_gerar_horarios_pck.ie_regra_incl_gas_w', ADEP_obter_se_item_modelo('O',nr_seq_modelo_p,'N'), false);
		end if;		
		if (current_setting('plt_gerar_horarios_pck.ie_regra_incl_hemoterapia_w')::char(1)	<> 'N') then
			PERFORM set_config('plt_gerar_horarios_pck.ie_regra_incl_hemoterapia_w', ADEP_obter_se_item_modelo('HM',nr_seq_modelo_p,'N'), false);
		end if;		
		if (current_setting('plt_gerar_horarios_pck.ie_regra_incl_jejum_w')::char(1)	<> 'N') then
			PERFORM set_config('plt_gerar_horarios_pck.ie_regra_incl_jejum_w', ADEP_obter_se_item_modelo('J',nr_seq_modelo_p,'N'), false);
		end if;		
		if (current_setting('plt_gerar_horarios_pck.ie_regra_incl_sne_w')::char(1)	<> 'N') then
			PERFORM set_config('plt_gerar_horarios_pck.ie_regra_incl_sne_w', ADEP_obter_se_item_modelo('SNE',nr_seq_modelo_p,'N'), false);
		end if;		
		if (current_setting('plt_gerar_horarios_pck.ie_regra_incl_npt_adulta_w')::char(1)	<> 'N') then
			PERFORM set_config('plt_gerar_horarios_pck.ie_regra_incl_npt_adulta_w', ADEP_obter_se_item_modelo('NAN',nr_seq_modelo_p,'N'), false);
		end if;	
		if (current_setting('plt_gerar_horarios_pck.ie_regra_incl_npt_pediatrica_w')::char(1)	<> 'N') then
			PERFORM set_config('plt_gerar_horarios_pck.ie_regra_incl_npt_pediatrica_w', ADEP_obter_se_item_modelo('NPP',nr_seq_modelo_p,'N'), false);
		end if;	
		if (current_setting('plt_gerar_horarios_pck.ie_regra_incl_npt_neonatal_w')::char(1)	<> 'N') then
			PERFORM set_config('plt_gerar_horarios_pck.ie_regra_incl_npt_neonatal_w', ADEP_obter_se_item_modelo('NPN',nr_seq_modelo_p,'N'), false);
		end if;	
		if (current_setting('plt_gerar_horarios_pck.ie_regra_incl_leite_w')::char(1)	<> 'N') then
			PERFORM set_config('plt_gerar_horarios_pck.ie_regra_incl_leite_w', ADEP_obter_se_item_modelo('LD',nr_seq_modelo_p,'N'), false);
		end if;
	end if;
	
	if (coalesce(nr_atendimento_p::text, '') = '') then
		PERFORM set_config('plt_gerar_horarios_pck.cd_pessoa_fisica_w', cd_pessoa_fisica_p, false);
		
		select	coalesce(min(nr_prescricao),0),
			coalesce(max(nr_prescricao),0)
		into STRICT	current_setting('plt_gerar_horarios_pck.nr_prescr_inicial_w')::bigint,
			current_setting('plt_gerar_horarios_pck.nr_prescr_final_w')::bigint
		from	prescr_medica
		where	cd_pessoa_fisica	= current_setting('plt_gerar_horarios_pck.cd_pessoa_fisica_w')::varchar(10)
		and	coalesce(dt_validade_prescr,dt_inicio_prescr)	between dt_inicial_p and (dt_inicial_p + 3)
		and	((((coalesce(dt_liberacao_medico,dt_liberacao) IS NOT NULL AND (coalesce(dt_liberacao_medico,dt_liberacao))::text <> '')) and (ie_prescr_usuario_p	= 'N')) or (nm_usuario_original	= nm_usuario_p) or
			 ((cd_medico	= current_setting('plt_gerar_horarios_pck.cd_pessoa_usuario_w')::pessoa_fisica.cd_pessoa_fisica%type) and
			  ((ie_emergencia	= 'S') or (ie_cartao_emergencia	= 'S') or (ie_prescritor_aux = 'S'))))
		and	(((ie_edicao_p = 'S') and (plt_obter_se_liberado(dt_liberacao_medico,dt_liberacao,dt_liberacao_farmacia) = 'N')) or (ie_edicao_p = 'N'));
		--and	nvl(ie_hemodialise, 'N') <> 'R';

			
		select	coalesce(min(nr_sequencia),0),
			coalesce(max(nr_sequencia),0)
		into STRICT	current_setting('plt_gerar_horarios_pck.nr_prescr_inicial_sae_w')::bigint,
			current_setting('plt_gerar_horarios_pck.nr_prescr_final_sae_w')::bigint
		from	pe_prescricao
		where	cd_pessoa_fisica	= current_setting('plt_gerar_horarios_pck.cd_pessoa_fisica_w')::varchar(10)
		and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
		and	dt_validade_prescr	between dt_inicial_p and (dt_inicial_p + 3);
		
		
		
		select	coalesce(min(a.nr_prescricao),0),
			coalesce(max(a.nr_prescricao),0)
		into STRICT	current_setting('plt_gerar_horarios_pck.nr_prescr_inicial_sol_w')::bigint,
			current_setting('plt_gerar_horarios_pck.nr_prescr_final_sol_w')::bigint	
		from	prescr_solucao x,
			prescr_medica a
		where	x.nr_prescricao = a.nr_prescricao
		and	a.cd_pessoa_fisica = current_setting('plt_gerar_horarios_pck.cd_pessoa_fisica_w')::varchar(10)
		
		and	coalesce(x.nr_seq_dialise::text, '') = ''
		and	coalesce(x.ie_hemodialise, 'N') = 'N'


		and	((ie_sol_vigentes_p	= 'N') or (obter_se_prescr_vig_adep(a.dt_inicio_prescr,a.dt_validade_prescr,dt_inicial_p,dt_final_p) = 'S') or (exists (	SELECT	1
					from	prescr_mat_hor b
					where	b.nr_prescricao = x.nr_prescricao
					and	b.nr_seq_solucao = x.nr_seq_solucao
					and	b.dt_horario between dt_inicial_p and dt_final_p)))
		and	((ie_sol_continuas_p = 'S') or (obter_se_sol_continua(a.nr_prescricao,x.nr_seq_solucao,x.ds_solucao, dt_inicial_p) = 'N'))	
		and	plt_obter_se_item_periodo(	null,				null,			get_ie_plano_por_setor,		dt_plano_p,		null,
							dt_inicial_p,			dt_final_p,		ie_prescr_usuario_p,		nm_usuario_p,		ie_estendidos_p,
							dt_referencia_p,		ie_edicao_p,		ie_exibir_hor_suspensos_p,	x.dt_suspensao,		'SOL',
							x.nr_seq_solucao,		a.nr_prescricao,	'O') = 'S';		
		
	else
		PERFORM set_config('plt_gerar_horarios_pck.cd_pessoa_fisica_w', obter_pessoa_atendimento(nr_atendimento_p,'C'), false);

		select	coalesce(min(nr_prescricao),0),
			coalesce(max(nr_prescricao),0)
		into STRICT	current_setting('plt_gerar_horarios_pck.nr_prescr_inicial_w')::bigint,
			current_setting('plt_gerar_horarios_pck.nr_prescr_final_w')::bigint
		from	prescr_medica
		where	nr_atendimento	= nr_atendimento_p	
		and	coalesce(dt_validade_prescr,dt_inicio_prescr)	between dt_inicial_p and (dt_inicial_p + 3)
		and	((((coalesce(dt_liberacao_medico,dt_liberacao) IS NOT NULL AND (coalesce(dt_liberacao_medico,dt_liberacao))::text <> '')) and (ie_prescr_usuario_p	= 'N')) or (nm_usuario_original	= nm_usuario_p) or
			 ((cd_medico	= current_setting('plt_gerar_horarios_pck.cd_pessoa_usuario_w')::pessoa_fisica.cd_pessoa_fisica%type) and
			  ((ie_emergencia	= 'S') or (ie_cartao_emergencia	= 'S') or (ie_prescritor_aux = 'S'))))
		and	(((ie_edicao_p = 'S') and (plt_obter_se_liberado(dt_liberacao_medico,dt_liberacao,dt_liberacao_farmacia) = 'N')) or (ie_edicao_p = 'N'));
		--and	nvl(ie_hemodialise, 'N') <> 'R';

			
		select	coalesce(min(nr_sequencia),0),
			coalesce(max(nr_sequencia),0)
		into STRICT	current_setting('plt_gerar_horarios_pck.nr_prescr_inicial_sae_w')::bigint,
			current_setting('plt_gerar_horarios_pck.nr_prescr_final_sae_w')::bigint
		from	pe_prescricao
		where	nr_atendimento	= nr_atendimento_p
		and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
		and	dt_validade_prescr	between dt_inicial_p and (dt_inicial_p + 3);
		
		select	coalesce(min(a.nr_prescricao),0),
			coalesce(max(a.nr_prescricao),0)
		into STRICT	current_setting('plt_gerar_horarios_pck.nr_prescr_inicial_sol_w')::bigint,
			current_setting('plt_gerar_horarios_pck.nr_prescr_final_sol_w')::bigint	
		from	prescr_solucao x,
			prescr_medica a
		where	x.nr_prescricao = a.nr_prescricao
		and	a.nr_atendimento = nr_atendimento_p
		and	coalesce(x.nr_seq_dialise::text, '') = ''
		
		and	coalesce(x.ie_hemodialise, 'N') = 'N'


		and	((ie_sol_vigentes_p	= 'N') or (obter_se_prescr_vig_adep(a.dt_inicio_prescr,a.dt_validade_prescr,dt_inicial_p,dt_final_p) = 'S') or (exists (	SELECT	1
					from	prescr_mat_hor b
					where	b.nr_prescricao = x.nr_prescricao
					and	b.nr_seq_solucao = x.nr_seq_solucao
					and	b.dt_horario between dt_inicial_p and dt_final_p)))
		and	((ie_sol_continuas_p = 'S') or (obter_se_sol_continua(a.nr_prescricao,x.nr_seq_solucao,x.ds_solucao, dt_inicial_p) = 'N'))	
		and	plt_obter_se_item_periodo(	null,				null,			get_ie_plano_por_setor,		dt_plano_p,		null,
							dt_inicial_p,			dt_final_p,		ie_prescr_usuario_p,		nm_usuario_p,		ie_estendidos_p,
							dt_referencia_p,		ie_edicao_p,		ie_exibir_hor_suspensos_p,	x.dt_suspensao,		'SOL',
							x.nr_seq_solucao,		a.nr_prescricao,	'O') = 'S';		
		
	end if;	
		
	if (current_setting('plt_gerar_horarios_pck.nr_prescr_inicial_w')::bigint	> 0) and (current_setting('plt_gerar_horarios_pck.nr_prescr_final_w')::bigint	> 0) then

		if (current_setting('plt_gerar_horarios_pck.ie_regra_incl_dieta_oral_w')::char(1) <> 'N')	then
			begin
			CALL CALL plt_gerar_horarios_pck.plt_obter_horarios_dieta_oral(
					cd_estabelecimento_p,
					cd_setor_usuario_p,
					cd_perfil_p,
					nm_usuario_p,
					nr_atendimento_p,
					dt_inicial_p,
					dt_final_p,
					dt_inicial_p,
					ie_prescr_usuario_p,
					ie_edicao_p,
					ie_estendidos_p,
					dt_referencia_p,
					ie_exibir_hor_suspensos_p,
					dt_plano_p);
			end;
		end if;
		
		CALL CALL plt_gerar_horarios_pck.plt_obter_horarios_ordem_med(
				cd_estabelecimento_p,
				cd_setor_usuario_p,
				cd_perfil_p,
				nm_usuario_p,
				nr_atendimento_p,
				dt_inicial_p,
				dt_final_p,					
				dt_inicial_p,					
				ie_exibir_hor_suspensos_p);
				
		if (current_setting('plt_gerar_horarios_pck.ie_regra_incl_dialise_w')::char(1) <> 'N')	then
			begin
			CALL plt_gerar_horarios_pck.plt_obter_horarios_dialise(
					cd_estabelecimento_p,
					cd_setor_usuario_p,
					cd_perfil_p,
					nm_usuario_p,
					nr_atendimento_p,
					dt_inicial_p,
					dt_final_p,
					dt_inicial_p,
					ie_edicao_p,
					ie_exibir_hor_suspensos_p,
					dt_plano_p,
					ie_prescr_usuario_p,
					ie_estendidos_p,
					dt_referencia_p);
			end;
		end if;
		if (current_setting('plt_gerar_horarios_pck.ie_regra_incl_supl_oral_w')::char(1) <> 'N')	then
			begin
			CALL CALL plt_gerar_horarios_pck.plt_obter_horarios_supl_oral(
					cd_estabelecimento_p,
					cd_setor_usuario_p,
					cd_perfil_p,
					nm_usuario_p,
					nr_atendimento_p,
					dt_inicial_p,
					dt_final_p,
					dt_inicial_p,
					ie_prescr_usuario_p,
					ie_edicao_p,
					ie_estendidos_p,
					dt_referencia_p,
					ie_exibir_hor_suspensos_p,
					dt_plano_p);
			end;
		end if;
		if (current_setting('plt_gerar_horarios_pck.ie_regra_incl_leite_w')::char(1) <> 'N') then
			begin
			CALL plt_gerar_horarios_pck.plt_obter_horarios_leite(
					cd_estabelecimento_p,
					cd_setor_usuario_p,
					cd_perfil_p,
					nm_usuario_p,
					nr_atendimento_p,
					dt_inicial_p,
					dt_final_p,
					dt_inicial_p,
					ie_prescr_usuario_p,
					ie_edicao_p,
					ie_estendidos_p,
					dt_referencia_p,
					ie_exibir_hor_suspensos_p,
					dt_plano_p);
			end;
		end if;
		if (current_setting('plt_gerar_horarios_pck.ie_regra_incl_medicamento_w')::char(1) <> 'N') then
			begin
			CALL CALL plt_gerar_horarios_pck.plt_obter_horarios_medic(
					cd_estabelecimento_p,
					cd_setor_usuario_p,
					cd_perfil_p,
					nm_usuario_p,
					nr_atendimento_p,
					dt_inicial_p,
					dt_final_p,
					dt_inicial_p,
					ie_prescr_usuario_p,
					ie_edicao_p,
					ie_estendidos_p,
					dt_referencia_p,
					ie_exibir_hor_suspensos_p,
					dt_plano_p);
			end;
		end if;
		if (current_setting('plt_gerar_horarios_pck.ie_regra_incl_material_w')::char(1) <> 'N') then
			begin
			CALL CALL plt_gerar_horarios_pck.plt_obter_horarios_material(
					cd_estabelecimento_p,
					cd_setor_usuario_p,
					cd_perfil_p,
					nm_usuario_p,
					nr_atendimento_p,
					dt_inicial_p,
					dt_final_p,
					dt_inicial_p,
					ie_prescr_usuario_p,
					ie_edicao_p,
					ie_estendidos_p,
					dt_referencia_p,
					ie_exibir_hor_suspensos_p,
					dt_plano_p);
			end;
		end if;
		if (current_setting('plt_gerar_horarios_pck.ie_regra_incl_procedimento_w')::char(1) <> 'N') then
			begin
			CALL CALL plt_gerar_horarios_pck.plt_obter_horarios_proced(
					cd_estabelecimento_p,
					cd_setor_usuario_p,
					cd_perfil_p,
					nm_usuario_p,
					nr_atendimento_p,
					dt_inicial_p,
					dt_final_p,
					dt_inicial_p,
					ie_prescr_usuario_p,
					ie_edicao_p,
					ie_estendidos_p,
					dt_referencia_p,
					ie_exibir_hor_suspensos_p,
					dt_plano_p,
					nr_seq_modelo_p);
			CALL CALL plt_gerar_horarios_pck.plt_obter_horarios_assoc_proc(
					cd_estabelecimento_p,
					cd_setor_usuario_p,
					cd_perfil_p,
					nm_usuario_p,
					nr_atendimento_p,
					dt_inicial_p,
					dt_final_p,
					dt_inicial_p,
					ie_prescr_usuario_p,
					ie_edicao_p,
					ie_estendidos_p,
					dt_referencia_p,
					ie_exibir_hor_suspensos_p,
					dt_plano_p);
			end;
		end if;	
		if (current_setting('plt_gerar_horarios_pck.ie_regra_incl_coleta_w')::char(1) <> 'N')	then
			begin
			CALL CALL plt_gerar_horarios_pck.plt_obter_horarios_coleta(
					nm_usuario_p,
					nr_atendimento_p,
					dt_inicial_p,
					dt_final_p,
					dt_inicial_p,
					ie_prescr_usuario_p,
					ie_edicao_p,
					ie_estendidos_p,
					dt_referencia_p,
					ie_exibir_hor_suspensos_p,
					dt_plano_p);
			end;
		end if;
		if (current_setting('plt_gerar_horarios_pck.ie_regra_incl_cig_w')::char(1) <> 'N') then
			begin
			CALL CALL plt_gerar_horarios_pck.plt_obter_horarios_cig(
					cd_estabelecimento_p,
					cd_setor_usuario_p,
					cd_perfil_p,
					nm_usuario_p,
					nr_atendimento_p,
					dt_inicial_p,
					dt_final_p,
					dt_inicial_p,
					ie_prescr_usuario_p,
					ie_edicao_p,
					ie_estendidos_p,
					dt_referencia_p,
					ie_exibir_hor_suspensos_p,
					dt_plano_p);
			end;
		end if;
		if (current_setting('plt_gerar_horarios_pck.ie_regra_incl_ccg_w')::char(1) <> 'N') then
			begin
			CALL CALL plt_gerar_horarios_pck.plt_obter_horarios_ccg(
					cd_estabelecimento_p,
					cd_setor_usuario_p,
					cd_perfil_p,
					nm_usuario_p,
					nr_atendimento_p,
					dt_inicial_p,
					dt_final_p,
					dt_inicial_p,
					ie_prescr_usuario_p,
					ie_edicao_p,
					ie_estendidos_p,
					dt_referencia_p,
					ie_exibir_hor_suspensos_p,
					dt_plano_p);
			end;
		end if;
/*					
		plt_gerar_horarios_pck.plt_obter_horarios_assoc_glic(
				cd_estabelecimento_p,
				cd_setor_usuario_p,
				cd_perfil_p,
				nm_usuario_p,
				nr_atendimento_p,
				dt_inicial_p,
				dt_final_p,
				dt_inicial_p,
				ie_prescr_usuario_p,
				ie_edicao_p,
				ie_estendidos_p,
				dt_referencia_p);*/

		if (current_setting('plt_gerar_horarios_pck.ie_regra_incl_ivc_w')::char(1) <> 'N') then
			begin		
			CALL CALL plt_gerar_horarios_pck.plt_obter_horarios_ivc(
					cd_estabelecimento_p,
					cd_setor_usuario_p,
					cd_perfil_p,
					nm_usuario_p,
					nr_atendimento_p,
					dt_inicial_p,
					dt_final_p,
					dt_inicial_p,
					ie_prescr_usuario_p,
					ie_edicao_p,
					ie_estendidos_p,
					dt_referencia_p,
					ie_exibir_hor_suspensos_p,
					dt_plano_p);
			end;
		end if;
		if (current_setting('plt_gerar_horarios_pck.ie_regra_incl_recomendacao_w')::char(1) <> 'N') then
			begin
			CALL CALL plt_gerar_horarios_pck.plt_obter_horarios_rec(
					cd_estabelecimento_p,
					cd_setor_usuario_p,
					cd_perfil_p,
					nm_usuario_p,
					nr_atendimento_p,
					dt_inicial_p,
					dt_final_p,
					dt_inicial_p,
					ie_prescr_usuario_p,
					ie_edicao_p,
					ie_estendidos_p,
					dt_referencia_p,
					ie_exibir_hor_suspensos_p,
					dt_plano_p);
			end;
		end if;
		if (current_setting('plt_gerar_horarios_pck.ie_regra_incl_gas_w')::char(1) <> 'N') then
			begin
			CALL plt_gerar_horarios_pck.plt_obter_horarios_gas(
					nm_usuario_p,
					nr_atendimento_p,
					dt_inicial_p,
					dt_final_p,
					dt_inicial_p,
					ie_prescr_usuario_p,
					ie_edicao_p,
					ie_estendidos_p,
					dt_referencia_p,
					ie_exibir_hor_suspensos_p,
					dt_plano_p);		
			end;
		end if;
		if (current_setting('plt_gerar_horarios_pck.ie_regra_incl_hemoterapia_w')::char(1) <> 'N') then
			begin
			CALL CALL plt_gerar_horarios_pck.plt_obter_horarios_hemoterap(
					cd_estabelecimento_p,
					cd_setor_usuario_p,
					cd_perfil_p,
					nm_usuario_p,
					nr_atendimento_p,
					dt_inicial_p,
					dt_final_p,
					dt_inicial_p,
					ie_prescr_usuario_p,
					ie_edicao_p,
					ie_estendidos_p,
					dt_referencia_p,
					ie_exibir_hor_suspensos_p,
					dt_plano_p);
			end;
		end if;
		if (current_setting('plt_gerar_horarios_pck.ie_regra_incl_jejum_w')::char(1) <> 'N') then
			begin
			CALL CALL plt_gerar_horarios_pck.plt_obter_horarios_jejum(
					cd_estabelecimento_p,
					cd_setor_usuario_p,
					cd_perfil_p,
					nm_usuario_p,
					nr_atendimento_p,
					dt_inicial_p,
					dt_final_p,
					dt_inicial_p,
					ie_prescr_usuario_p,
					ie_edicao_p,
					ie_estendidos_p,
					dt_referencia_p,
					ie_exibir_hor_suspensos_p,
					dt_plano_p);
			end;
		end if;
		if (current_setting('plt_gerar_horarios_pck.ie_regra_incl_sne_w')::char(1) <> 'N') then
			begin
			CALL CALL plt_gerar_horarios_pck.plt_obter_horarios_sne(
					cd_estabelecimento_p,
					cd_setor_usuario_p,
					cd_perfil_p,
					nm_usuario_p,
					nr_atendimento_p,
					dt_inicial_p,
					dt_final_p,
					dt_inicial_p,
					ie_prescr_usuario_p,
					ie_edicao_p,
					ie_estendidos_p,
					dt_referencia_p,
					ie_exibir_hor_suspensos_p,
					dt_plano_p);
			end;
		end if;
		if (current_setting('plt_gerar_horarios_pck.ie_regra_incl_npt_adulta_w')::char(1) <> 'N') then
			begin
			CALL plt_gerar_horarios_pck.plt_obter_horarios_npt_adulta(
				cd_estabelecimento_p,
				cd_setor_usuario_p,
				cd_perfil_p,
				nm_usuario_p,
				nr_atendimento_p,
				dt_inicial_p,
				dt_final_p,
				dt_inicial_p,
				ie_prescr_usuario_p,
				ie_edicao_p,
				ie_estendidos_p,
				dt_referencia_p,
				ie_exibir_hor_suspensos_p,
				dt_plano_p);
			end;
		end if;
		
		
	end if;	

	if (current_setting('plt_gerar_horarios_pck.nr_prescr_inicial_sol_w')::bigint	> 0) and (current_setting('plt_gerar_horarios_pck.nr_prescr_final_sol_w')::bigint		> 0) and (current_setting('plt_gerar_horarios_pck.ie_regra_incl_solucao_w')::char(1) <> 'N') then
		begin
			CALL CALL plt_gerar_horarios_pck.plt_obter_horarios_solucao(
					cd_estabelecimento_p,
					cd_setor_usuario_p,
					cd_perfil_p,
					nm_usuario_p,
					nr_atendimento_p,
					dt_inicial_p,
					dt_final_p,
					dt_inicial_p,
					get_ie_formato_solucoes,
					ie_prescr_usuario_p,
					ie_sol_vigentes_p,
					ie_edicao_p,
					ie_estendidos_p,
					dt_referencia_p,
					ie_exibir_hor_suspensos_p,
					dt_plano_p);		
		end;
	
		
	end if;	
	
	if (ie_exibir_sae_p 		= 'S') and (current_setting('plt_gerar_horarios_pck.nr_prescr_inicial_sae_w')::bigint	> 0) and (current_setting('plt_gerar_horarios_pck.nr_prescr_final_sae_w')::bigint		> 0) and (current_setting('plt_gerar_horarios_pck.ie_regra_incl_intervencao_w')::char(1) <> 'N')  then
		begin
		CALL CALL plt_gerar_horarios_pck.plt_obter_horarios_interv(
				cd_estabelecimento_p,
				cd_setor_usuario_p,
				cd_perfil_p,
				nm_usuario_p,
				nr_atendimento_p,
				dt_inicial_p,
				dt_final_p,
				dt_inicial_p,
				ie_prescr_usuario_p,
				ie_exibir_hor_suspensos_p,
				dt_plano_p);
		end;
	end if;				
	
	PERFORM set_config('plt_gerar_horarios_pck.dt_horario_inicio_sinc_w', null, false);
	PERFORM set_config('plt_gerar_horarios_pck.dt_horario_fim_sinc_w', null, false);
	
	open c02;
	loop
	fetch c02 into current_setting('plt_gerar_horarios_pck.dt_horario_w')::timestamp;
	EXIT WHEN NOT FOUND; /* apply on c02 */
		begin
		if (i < 60) then
			begin
			if (current_setting('plt_gerar_horarios_pck.dt_horario_inicio_sinc_w')::coalesce(timestamp::text, '') = '') then
				PERFORM set_config('plt_gerar_horarios_pck.dt_horario_inicio_sinc_w', current_setting('plt_gerar_horarios_pck.dt_horario_w')::timestamp, false);
			end if;
			PERFORM set_config('plt_gerar_horarios_pck.dt_horario_fim_sinc_w', current_setting('plt_gerar_horarios_pck.dt_horario_w')::timestamp + 1/1440, false);
		
			i			:= i + 1;
			current_setting('plt_gerar_horarios_pck.vetor_w')::vetor[i].horario_w	:= to_char(current_setting('plt_gerar_horarios_pck.dt_horario_w')::timestamp,'dd/mm/yyyy hh24:mi:ss');
			end;
		end if;
		end;
	end loop;
	close c02;

	j	:= i;
	while(j < 60) loop
		begin
		j			:= j + 1;
		current_setting('plt_gerar_horarios_pck.vetor_w')::vetor[j].horario_w	:= null;
		end;
	end loop;

	select	nextval('w_rep_t_seq')
	into STRICT	nr_seq_wadep_w
	;

	insert into w_rep_t(
		nr_sequencia,
		nm_usuario,
		ie_tipo_item,
		hora1, 	hora2,	hora3,	hora4,	hora5,	hora6,	hora7,	hora8,	hora9,	hora10,
		hora11, hora12, hora13, hora14, hora15, hora16, hora17, hora18, hora19, hora20,
		hora21, hora22, hora23, hora24, hora25, hora26, hora27, hora28, hora29, hora30,
		hora31, hora32, hora33, hora34, hora35, hora36, hora37, hora38, hora39, hora40,
		hora41,	hora42,	hora43,	hora44,	hora45,	hora46,	hora47,	hora48,	hora49,	hora50,
		hora51,	hora52, hora53, hora54, hora55, hora56, hora57, hora58, hora59, hora60)
	values (
		nr_seq_wadep_w,
		nm_usuario_p,
		'H',
		current_setting('plt_gerar_horarios_pck.vetor_w')::vetor[1].horario_w,
		current_setting('plt_gerar_horarios_pck.vetor_w')::vetor[2].horario_w,
		current_setting('plt_gerar_horarios_pck.vetor_w')::vetor[3].horario_w,
		current_setting('plt_gerar_horarios_pck.vetor_w')::vetor[4].horario_w,
		current_setting('plt_gerar_horarios_pck.vetor_w')::vetor[5].horario_w,
		current_setting('plt_gerar_horarios_pck.vetor_w')::vetor[6].horario_w,
		current_setting('plt_gerar_horarios_pck.vetor_w')::vetor[7].horario_w,
		current_setting('plt_gerar_horarios_pck.vetor_w')::vetor[8].horario_w,
		current_setting('plt_gerar_horarios_pck.vetor_w')::vetor[9].horario_w,
		current_setting('plt_gerar_horarios_pck.vetor_w')::vetor[10].horario_w,
		current_setting('plt_gerar_horarios_pck.vetor_w')::vetor[11].horario_w,
		current_setting('plt_gerar_horarios_pck.vetor_w')::vetor[12].horario_w,
		current_setting('plt_gerar_horarios_pck.vetor_w')::vetor[13].horario_w,
		current_setting('plt_gerar_horarios_pck.vetor_w')::vetor[14].horario_w,
		current_setting('plt_gerar_horarios_pck.vetor_w')::vetor[15].horario_w,
		current_setting('plt_gerar_horarios_pck.vetor_w')::vetor[16].horario_w,
		current_setting('plt_gerar_horarios_pck.vetor_w')::vetor[17].horario_w,
		current_setting('plt_gerar_horarios_pck.vetor_w')::vetor[18].horario_w,
		current_setting('plt_gerar_horarios_pck.vetor_w')::vetor[19].horario_w,
		current_setting('plt_gerar_horarios_pck.vetor_w')::vetor[20].horario_w,
		current_setting('plt_gerar_horarios_pck.vetor_w')::vetor[21].horario_w,
		current_setting('plt_gerar_horarios_pck.vetor_w')::vetor[22].horario_w,
		current_setting('plt_gerar_horarios_pck.vetor_w')::vetor[23].horario_w,
		current_setting('plt_gerar_horarios_pck.vetor_w')::vetor[24].horario_w,
		current_setting('plt_gerar_horarios_pck.vetor_w')::vetor[25].horario_w,
		current_setting('plt_gerar_horarios_pck.vetor_w')::vetor[26].horario_w,
		current_setting('plt_gerar_horarios_pck.vetor_w')::vetor[27].horario_w,
		current_setting('plt_gerar_horarios_pck.vetor_w')::vetor[28].horario_w,
		current_setting('plt_gerar_horarios_pck.vetor_w')::vetor[29].horario_w,
		current_setting('plt_gerar_horarios_pck.vetor_w')::vetor[30].horario_w,
		current_setting('plt_gerar_horarios_pck.vetor_w')::vetor[31].horario_w,
		current_setting('plt_gerar_horarios_pck.vetor_w')::vetor[32].horario_w,
		current_setting('plt_gerar_horarios_pck.vetor_w')::vetor[33].horario_w,
		current_setting('plt_gerar_horarios_pck.vetor_w')::vetor[34].horario_w,
		current_setting('plt_gerar_horarios_pck.vetor_w')::vetor[35].horario_w,
		current_setting('plt_gerar_horarios_pck.vetor_w')::vetor[36].horario_w,
		current_setting('plt_gerar_horarios_pck.vetor_w')::vetor[37].horario_w,
		current_setting('plt_gerar_horarios_pck.vetor_w')::vetor[38].horario_w,
		current_setting('plt_gerar_horarios_pck.vetor_w')::vetor[39].horario_w,
		current_setting('plt_gerar_horarios_pck.vetor_w')::vetor[40].horario_w,
		current_setting('plt_gerar_horarios_pck.vetor_w')::vetor[41].horario_w,
		current_setting('plt_gerar_horarios_pck.vetor_w')::vetor[42].horario_w,
		current_setting('plt_gerar_horarios_pck.vetor_w')::vetor[43].horario_w,
		current_setting('plt_gerar_horarios_pck.vetor_w')::vetor[44].horario_w,
		current_setting('plt_gerar_horarios_pck.vetor_w')::vetor[45].horario_w,
		current_setting('plt_gerar_horarios_pck.vetor_w')::vetor[46].horario_w,
		current_setting('plt_gerar_horarios_pck.vetor_w')::vetor[47].horario_w,
		current_setting('plt_gerar_horarios_pck.vetor_w')::vetor[48].horario_w,
		current_setting('plt_gerar_horarios_pck.vetor_w')::vetor[49].horario_w,
		current_setting('plt_gerar_horarios_pck.vetor_w')::vetor[50].horario_w,
		current_setting('plt_gerar_horarios_pck.vetor_w')::vetor[51].horario_w,
		current_setting('plt_gerar_horarios_pck.vetor_w')::vetor[52].horario_w,
		current_setting('plt_gerar_horarios_pck.vetor_w')::vetor[53].horario_w,
		current_setting('plt_gerar_horarios_pck.vetor_w')::vetor[54].horario_w,
		current_setting('plt_gerar_horarios_pck.vetor_w')::vetor[55].horario_w,
		current_setting('plt_gerar_horarios_pck.vetor_w')::vetor[56].horario_w,
		current_setting('plt_gerar_horarios_pck.vetor_w')::vetor[57].horario_w,
		current_setting('plt_gerar_horarios_pck.vetor_w')::vetor[58].horario_w,
		current_setting('plt_gerar_horarios_pck.vetor_w')::vetor[59].horario_w,
		current_setting('plt_gerar_horarios_pck.vetor_w')::vetor[60].horario_w);
	
	if (current_setting('plt_gerar_horarios_pck.nr_prescr_inicial_w')::bigint	> 0) and (current_setting('plt_gerar_horarios_pck.nr_prescr_final_w')::bigint	> 0) then
		
		if (current_setting('plt_gerar_horarios_pck.ie_regra_incl_dieta_oral_w')::char(1) <> 'N')	then
			begin
			CALL CALL plt_gerar_horarios_pck.plt_obter_dieta_oral(
					cd_estabelecimento_p,
					cd_setor_usuario_p,
					cd_perfil_p,
					nm_usuario_p,
					nr_atendimento_p,
					dt_inicial_p,
					dt_final_p,
					dt_inicial_p,
					get_ie_horarios_dietas_orais,
					ie_prescr_usuario_p,
					get_nr_seq_regra,
					ie_edicao_p,
					ie_estendidos_p,
					dt_referencia_p,
					ie_exibir_hor_suspensos_p,
					dt_plano_p);
			end;
		end if;
		if (current_setting('plt_gerar_horarios_pck.ie_regra_incl_dialise_w')::char(1) <> 'N')	then
			begin
			CALL plt_gerar_horarios_pck.plt_obter_dialise(
					cd_estabelecimento_p,
					cd_setor_usuario_p,
					cd_perfil_p,
					nm_usuario_p,
					nr_atendimento_p,
					dt_inicial_p,
					dt_final_p,
					dt_inicial_p,
					ie_edicao_p,
					ie_exibir_hor_suspensos_p,
					dt_plano_p,
					ie_prescr_usuario_p,
					ie_estendidos_p,
					dt_referencia_p);
			end;
		end if;
		if (current_setting('plt_gerar_horarios_pck.ie_regra_incl_supl_oral_w')::char(1) <> 'N')	then
			begin
			CALL CALL plt_gerar_horarios_pck.plt_obter_supl_oral(
					nm_usuario_p,
					nr_atendimento_p,
					dt_inicial_p,
					dt_final_p,
					dt_inicial_p,
					get_ie_agrupar_acm_sn,
					ie_prescr_usuario_p,
					get_nr_seq_regra,
					ie_edicao_p,
					ie_estendidos_p,
					dt_referencia_p,
					ie_exibir_hor_suspensos_p,
					dt_plano_p);
			end;
		end if;
		if (current_setting('plt_gerar_horarios_pck.ie_regra_incl_leite_w')::char(1) <> 'N') then
			begin
			CALL plt_gerar_horarios_pck.plt_obter_leite(
					nm_usuario_p,
					nr_atendimento_p,
					dt_inicial_p,
					dt_final_p,
					dt_inicial_p,
					get_ie_agrupar_acm_sn,
					ie_prescr_usuario_p,
					get_nr_seq_regra,
					ie_edicao_p,
					ie_estendidos_p,
					dt_referencia_p,
					ie_exibir_hor_suspensos_p,
					dt_plano_p);
			end;
		end if;
		if (current_setting('plt_gerar_horarios_pck.ie_regra_incl_medicamento_w')::char(1) <> 'N') and (current_setting('plt_gerar_horarios_pck.ie_atualizar_medic_w')::char(1) <> 'N') then
			begin
			CALL CALL plt_gerar_horarios_pck.plt_obter_medic(
					cd_estabelecimento_p,
					cd_setor_usuario_p,
					nm_usuario_p,
					nr_atendimento_p,
					dt_inicial_p,
					dt_final_p,
					dt_inicial_p,
					get_ie_agrupar_acm_sn,
					ie_prescr_usuario_p,
					get_nr_seq_regra,
					ie_edicao_p,
					ie_estendidos_p,
					dt_referencia_p,
					ie_exibir_hor_suspensos_p,
					dt_plano_p);
			end;
		end if;		
		if (current_setting('plt_gerar_horarios_pck.ie_regra_incl_material_w')::char(1) <> 'N') then
			begin		
			CALL CALL plt_gerar_horarios_pck.plt_obter_material(
					cd_estabelecimento_p,
					cd_setor_usuario_p,
					cd_perfil_p,
					nm_usuario_p,
					nr_atendimento_p,
					dt_inicial_p,
					dt_final_p,
					dt_inicial_p,
					get_ie_agrupar_acm_sn,
					ie_prescr_usuario_p,
					get_nr_seq_regra,
					ie_edicao_p,
					ie_estendidos_p,
					dt_referencia_p,
					ie_exibir_hor_suspensos_p,
					dt_plano_p);
			end;
		end if;
		if (current_setting('plt_gerar_horarios_pck.ie_regra_incl_procedimento_w')::char(1) <> 'N') then
			begin
			CALL CALL plt_gerar_horarios_pck.plt_obter_proced(
					nm_usuario_p,
					nr_atendimento_p,
					dt_inicial_p,
					dt_final_p,
					dt_inicial_p,
					get_ie_agrupar_acm_sn,
					get_ie_agrupar_associados,
					ie_prescr_usuario_p,
					get_nr_seq_regra,
					ie_edicao_p,
					ie_estendidos_p,
					dt_referencia_p,
					ie_exibir_hor_suspensos_p,
					dt_plano_p,
					nr_seq_modelo_p);

			CALL CALL plt_gerar_horarios_pck.plt_obter_assoc_proc(
					cd_estabelecimento_p,
					cd_setor_usuario_p,
					cd_perfil_p,
					nm_usuario_p,
					nr_atendimento_p,
					dt_inicial_p,
					dt_final_p,
					dt_inicial_p,
					get_ie_agrupar_acm_sn,
					ie_prescr_usuario_p,
					get_nr_seq_regra,
					ie_edicao_p,
					ie_estendidos_p,
					dt_referencia_p,
					ie_exibir_hor_suspensos_p,
					dt_plano_p);
			end;
		end if;
		if (current_setting('plt_gerar_horarios_pck.ie_regra_incl_coleta_w')::char(1) <> 'N')	then
			begin
			CALL CALL plt_gerar_horarios_pck.plt_obter_coleta(
					cd_estabelecimento_p,
					cd_setor_usuario_p,
					cd_perfil_p,
					nm_usuario_p,
					nr_atendimento_p,
					dt_inicial_p,
					dt_final_p,
					dt_inicial_p,
					get_ie_agrupar_acm_sn,
					ie_prescr_usuario_p,
					get_nr_seq_regra,
					ie_edicao_p,
					ie_estendidos_p,
					dt_referencia_p,
					ie_exibir_hor_suspensos_p,
					dt_plano_p);
			end;
		end if;
		if (current_setting('plt_gerar_horarios_pck.ie_regra_incl_cig_w')::char(1) <> 'N') then
			begin
			CALL CALL plt_gerar_horarios_pck.plt_obter_cig(
					cd_estabelecimento_p,
					cd_setor_usuario_p,
					cd_perfil_p,
					nm_usuario_p,
					nr_atendimento_p,
					dt_inicial_p,
					dt_final_p,
					dt_inicial_p,
					get_ie_agrupar_acm_sn,
					ie_prescr_usuario_p,
					get_nr_seq_regra,
					ie_edicao_p,
					ie_estendidos_p,
					dt_referencia_p,
					ie_exibir_hor_suspensos_p,
					dt_plano_p);
			end;
		end if;
		if (current_setting('plt_gerar_horarios_pck.ie_regra_incl_ccg_w')::char(1) <> 'N') then
			begin
			CALL CALL plt_gerar_horarios_pck.plt_obter_ccg(
					cd_estabelecimento_p,
					cd_setor_usuario_p,
					cd_perfil_p,
					nm_usuario_p,
					nr_atendimento_p,
					dt_inicial_p,
					dt_final_p,
					dt_inicial_p,
					get_ie_agrupar_acm_sn,
					ie_prescr_usuario_p,
					get_nr_seq_regra,
					ie_edicao_p,
					ie_estendidos_p,
					dt_referencia_p,
					ie_exibir_hor_suspensos_p,
					dt_plano_p);
			end;
		end if;
/*						
		plt_gerar_horarios_pck.plt_obter_assoc_glic(
				cd_estabelecimento_p,
				cd_setor_usuario_p,
				cd_perfil_p,
				nm_usuario_p,
				nr_atendimento_p,
				dt_inicial_p,
				dt_final_p,
				dt_inicial_p,
				get_ie_agrupar_acm_sn,
				ie_prescr_usuario_p,
				get_nr_seq_regra,
				ie_edicao_p,
				ie_estendidos_p,
				dt_referencia_p);*/

		if (current_setting('plt_gerar_horarios_pck.ie_regra_incl_ivc_w')::char(1) <> 'N') then
			begin			
			CALL CALL plt_gerar_horarios_pck.plt_obter_ivc(
					cd_estabelecimento_p,
					cd_setor_usuario_p,
					cd_perfil_p,
					nm_usuario_p,
					nr_atendimento_p,
					dt_inicial_p,
					dt_final_p,
					dt_inicial_p,
					get_ie_agrupar_acm_sn,
					ie_prescr_usuario_p,
					get_nr_seq_regra,
					ie_edicao_p,
					ie_estendidos_p,
					dt_referencia_p,
					ie_exibir_hor_suspensos_p,
					dt_plano_p);
			end;
		end if;
		if (current_setting('plt_gerar_horarios_pck.ie_regra_incl_gas_w')::char(1) <> 'N') then
			begin
			CALL CALL plt_gerar_horarios_pck.plt_obter_gas(
					cd_estabelecimento_p,
					cd_setor_usuario_p,
					cd_perfil_p,
					nm_usuario_p,
					nr_atendimento_p,
					dt_inicial_p,
					dt_final_p,
					dt_inicial_p,
					get_ie_agrupar_acm_sn,
					ie_prescr_usuario_p,
					get_nr_seq_regra,
					ie_edicao_p,
					ie_estendidos_p,
					dt_referencia_p,
					ie_exibir_hor_suspensos_p,
					dt_plano_p);
			end;
		end if;
		if (current_setting('plt_gerar_horarios_pck.ie_regra_incl_recomendacao_w')::char(1) <> 'N') then
			begin
			CALL CALL plt_gerar_horarios_pck.plt_obter_rec(
				nm_usuario_p,
				nr_atendimento_p,
				dt_inicial_p,
				dt_final_p,
				dt_inicial_p,
				get_ie_agrupar_acm_sn,
				ie_prescr_usuario_p,
				get_nr_seq_regra,
				ie_edicao_p,
				ie_estendidos_p,
				dt_referencia_p,
				ie_exibir_hor_suspensos_p,
				dt_plano_p);
			end;
		end if;
		if (current_setting('plt_gerar_horarios_pck.ie_regra_incl_hemoterapia_w')::char(1) <> 'N') then
			begin
			CALL CALL plt_gerar_horarios_pck.plt_obter_hemoterap(
					cd_estabelecimento_p,
					cd_setor_usuario_p,
					cd_perfil_p,
					nm_usuario_p,
					nr_atendimento_p,
					dt_inicial_p,
					dt_final_p,
					dt_inicial_p,
					ie_prescr_usuario_p,
					get_nr_seq_regra,
					ie_edicao_p,
					ie_estendidos_p,
					dt_referencia_p,
					ie_exibir_hor_suspensos_p,
					dt_plano_p);
			end;
		end if;
		if (current_setting('plt_gerar_horarios_pck.ie_regra_incl_jejum_w')::char(1) <> 'N') then
			begin
			CALL CALL plt_gerar_horarios_pck.plt_obter_jejum(
					cd_estabelecimento_p,
					cd_setor_usuario_p,
					cd_perfil_p,
					nm_usuario_p,
					nr_atendimento_p,
					dt_inicial_p,
					dt_final_p,
					dt_inicial_p,
					ie_prescr_usuario_p,
					get_nr_seq_regra,
					ie_edicao_p,
					ie_estendidos_p,
					dt_referencia_p,
					ie_exibir_hor_suspensos_p,
					dt_plano_p);
			end;
		end if;
		if (current_setting('plt_gerar_horarios_pck.ie_regra_incl_sne_w')::char(1) <> 'N') then
			begin
			CALL CALL plt_gerar_horarios_pck.plt_obter_sne(
					nm_usuario_p,
					nr_atendimento_p,
					dt_inicial_p,
					dt_final_p,
					dt_inicial_p,
					ie_prescr_usuario_p,
					get_nr_seq_regra,
					ie_sol_continuas_p,
					ie_edicao_p,
					ie_estendidos_p,
					dt_referencia_p,
					ie_exibir_hor_suspensos_p,
					dt_plano_p);
			end;
		end if;
		if (current_setting('plt_gerar_horarios_pck.ie_regra_incl_npt_neonatal_w')::char(1) <> 'N') then
			begin
			CALL CALL plt_gerar_horarios_pck.plt_obter_npt_neonatal(
					nm_usuario_p,
					nr_atendimento_p,
					dt_inicial_p,
					dt_final_p,
					dt_inicial_p,
					ie_prescr_usuario_p,
					get_nr_seq_regra,
					ie_edicao_p,
					ie_estendidos_p,
					dt_referencia_p,
					ie_exibir_hor_suspensos_p,
					dt_plano_p);
			end;
		end if;
		if (current_setting('plt_gerar_horarios_pck.ie_regra_incl_npt_adulta_w')::char(1) <> 'N') then
			begin			
			CALL CALL plt_gerar_horarios_pck.plt_obter_npt_adulta(
					nm_usuario_p,
					nr_atendimento_p,
					dt_inicial_p,
					dt_final_p,
					dt_inicial_p,
					ie_prescr_usuario_p,
					get_nr_seq_regra,
					ie_edicao_p,
					ie_estendidos_p,
					dt_referencia_p,
					ie_exibir_hor_suspensos_p,
					dt_plano_p);
			end;
		end if;
		
		if (current_setting('plt_gerar_horarios_pck.ie_regra_incl_npt_pediatrica_w')::char(1) <> 'N') then
			Begin
			CALL plt_gerar_horarios_pck.plt_obter_npt_pediatrica(
					nm_usuario_p,
					nr_atendimento_p,
					dt_inicial_p,
					dt_final_p,
					dt_inicial_p,
					ie_prescr_usuario_p,
					get_nr_seq_regra,
					ie_edicao_p,
					ie_estendidos_p,
					dt_referencia_p,
					ie_exibir_hor_suspensos_p,
					dt_plano_p);
			end;
		end if;

		CALL CALL plt_gerar_horarios_pck.plt_obter_ordem_med(
				cd_estabelecimento_p,
				cd_setor_usuario_p,
				cd_perfil_p,
				nm_usuario_p,
				nr_atendimento_p,
				dt_inicial_p,
				dt_final_p,					
				dt_inicial_p,					
				ie_exibir_hor_suspensos_p);
		if (current_setting('plt_gerar_horarios_pck.ie_regra_incl_dieta_oral_w')::char(1) <> 'N')	then
			begin
			CALL CALL plt_gerar_horarios_pck.plt_sincronizar_dieta_oral(
					nm_usuario_p,
					nr_atendimento_p,
					dt_inicial_p,
					dt_final_p,
					dt_inicial_p,
					get_ie_horarios_dietas_orais,
					ie_prescr_usuario_p,
					ie_edicao_p,
					ie_estendidos_p,
					dt_referencia_p,
					ie_exibir_hor_suspensos_p,
					dt_plano_p);
			end;
		end if;
		if (current_setting('plt_gerar_horarios_pck.ie_regra_incl_dialise_w')::char(1) <> 'N')	then
			begin
			CALL plt_gerar_horarios_pck.plt_sincronizar_dialise(
					cd_estabelecimento_p,
					cd_setor_usuario_p,
					cd_perfil_p,
					nm_usuario_p,
					nr_atendimento_p,
					dt_inicial_p,
					dt_final_p,
					dt_inicial_p,
					ie_edicao_p,
					ie_exibir_hor_suspensos_p,
					dt_plano_p,
					ie_prescr_usuario_p,
					ie_estendidos_p,
					dt_referencia_p);
			end;
		end if;
		if (current_setting('plt_gerar_horarios_pck.ie_regra_incl_supl_oral_w')::char(1) <> 'N')	then
			begin
			CALL CALL plt_gerar_horarios_pck.plt_sincronizar_supl_oral(
					cd_estabelecimento_p,
					cd_setor_usuario_p,
					cd_perfil_p,
					nm_usuario_p,
					nr_atendimento_p, 					
					dt_inicial_p,
					get_ie_agrupar_acm_sn,
					ie_prescr_usuario_p,
					ie_edicao_p,
					ie_estendidos_p,
					dt_referencia_p,
					ie_exibir_hor_suspensos_p,
					dt_plano_p);
			end;
		end if;
		if (current_setting('plt_gerar_horarios_pck.ie_regra_incl_leite_w')::char(1) <> 'N') then
			begin
			CALL plt_gerar_horarios_pck.plt_sincronizar_leite(
					cd_estabelecimento_p,
					cd_setor_usuario_p,
					cd_perfil_p,
					nm_usuario_p,
					nr_atendimento_p, 					
					dt_inicial_p,
					get_ie_agrupar_acm_sn,
					ie_prescr_usuario_p,
					ie_edicao_p,
					ie_estendidos_p,
					dt_referencia_p,
					ie_exibir_hor_suspensos_p,
					dt_plano_p);
			end;
		end if;
		
		CALL CALL plt_gerar_horarios_pck.plt_sincronizar_ordem_med(
				cd_estabelecimento_p,
				cd_setor_usuario_p,
				cd_perfil_p,
				nm_usuario_p,
				nr_atendimento_p,
				dt_inicial_p,
				dt_final_p,					
				dt_inicial_p,					
				ie_exibir_hor_suspensos_p);
		if (current_setting('plt_gerar_horarios_pck.ie_regra_incl_medicamento_w')::char(1) <> 'N') and (current_setting('plt_gerar_horarios_pck.ie_atualizar_medic_w')::char(1) <> 'N') then
			begin
			CALL CALL plt_gerar_horarios_pck.plt_sincronizar_medic(
					nm_usuario_p,
					nr_atendimento_p,
					dt_inicial_p,
					ie_prescr_usuario_p,
					ie_edicao_p,
					ie_estendidos_p,
					dt_referencia_p,
					ie_exibir_hor_suspensos_p,
					dt_plano_p);
			end;
		end if;		
		if (current_setting('plt_gerar_horarios_pck.ie_regra_incl_material_w')::char(1) <> 'N') then
			begin		
			CALL CALL plt_gerar_horarios_pck.plt_sincronizar_material(
					nm_usuario_p,
					nr_atendimento_p,
					dt_inicial_p,
					ie_prescr_usuario_p,
					ie_edicao_p,
					ie_estendidos_p,
					dt_referencia_p,
					ie_exibir_hor_suspensos_p,
					dt_plano_p);
			end;
		end if;
		if (current_setting('plt_gerar_horarios_pck.ie_regra_incl_procedimento_w')::char(1) <> 'N') then
			begin
			CALL CALL plt_gerar_horarios_pck.plt_sincronizar_proced(
					cd_estabelecimento_p,
					cd_setor_usuario_p,
					nm_usuario_p,
					nr_atendimento_p,
					dt_inicial_p,
					ie_prescr_usuario_p,
					ie_edicao_p,
					ie_estendidos_p,
					dt_referencia_p,
					ie_exibir_hor_suspensos_p,
					dt_plano_p,
					nr_seq_modelo_p);
							
			CALL CALL plt_gerar_horarios_pck.plt_sincronizar_assoc_proc(
					nm_usuario_p,
					nr_atendimento_p,
					dt_inicial_p,
					ie_prescr_usuario_p,
					ie_edicao_p,
					ie_estendidos_p,
					dt_referencia_p,
					ie_exibir_hor_suspensos_p,
					dt_plano_p);
			end;
		end if;
		if (current_setting('plt_gerar_horarios_pck.ie_regra_incl_coleta_w')::char(1) <> 'N')	then
			begin
			CALL CALL plt_gerar_horarios_pck.plt_sincronizar_coleta(
					nm_usuario_p,
					nr_atendimento_p,
					dt_inicial_p,
					ie_prescr_usuario_p,
					ie_edicao_p,
					ie_estendidos_p,
					dt_referencia_p,
					ie_exibir_hor_suspensos_p,
					dt_plano_p);
			end;
		end if;
		if (current_setting('plt_gerar_horarios_pck.ie_regra_incl_cig_w')::char(1) <> 'N') then
			begin
			CALL CALL plt_gerar_horarios_pck.plt_sincronizar_cig(
					nm_usuario_p,
					nr_atendimento_p,
					dt_inicial_p,
					ie_prescr_usuario_p,
					ie_edicao_p,
					ie_estendidos_p,
					dt_referencia_p,
					ie_exibir_hor_suspensos_p,
					dt_plano_p);
			end;
		end if;
		if (current_setting('plt_gerar_horarios_pck.ie_regra_incl_ccg_w')::char(1) <> 'N') then
			begin
			CALL CALL plt_gerar_horarios_pck.plt_sincronizar_ccg(
					nm_usuario_p,
					nr_atendimento_p,
					dt_inicial_p,
					ie_prescr_usuario_p,
					ie_edicao_p,
					ie_estendidos_p,
					dt_referencia_p,
					ie_exibir_hor_suspensos_p,
					dt_plano_p);
			end;
		end if;
/*						
		plt_gerar_horarios_pck.plt_sincronizar_assoc_glic(
				nm_usuario_p,
				nr_atendimento_p,
				dt_inicial_p,
				ie_prescr_usuario_p,
				ie_edicao_p,
				ie_estendidos_p,
				dt_referencia_p);*/

		if (current_setting('plt_gerar_horarios_pck.ie_regra_incl_ivc_w')::char(1) <> 'N') then
			begin		
			CALL CALL plt_gerar_horarios_pck.plt_sincronizar_ivc(
					nm_usuario_p,
					nr_atendimento_p,
					dt_inicial_p,
					ie_prescr_usuario_p,
					ie_edicao_p,
					ie_estendidos_p,
					dt_referencia_p,
					ie_exibir_hor_suspensos_p,
					dt_plano_p);
			end;
		end if;
		if (current_setting('plt_gerar_horarios_pck.ie_regra_incl_recomendacao_w')::char(1) <> 'N') then
			begin
			CALL CALL plt_gerar_horarios_pck.plt_sincronizar_rec(
					cd_estabelecimento_p,
					cd_setor_usuario_p,
					cd_perfil_p,
					nm_usuario_p,
					nr_atendimento_p,
					dt_inicial_p,
					ie_prescr_usuario_p,
					ie_edicao_p,
					ie_estendidos_p,
					dt_referencia_p,
					ie_exibir_hor_suspensos_p,
					dt_plano_p);
			end;
		end if;
		if (current_setting('plt_gerar_horarios_pck.ie_regra_incl_gas_w')::char(1) <> 'N') then
			begin
			CALL plt_gerar_horarios_pck.plt_sincronizar_gas(
					nm_usuario_p,
					nr_atendimento_p,
					dt_inicial_p,
					ie_prescr_usuario_p,
					ie_edicao_p,
					ie_estendidos_p,
					dt_referencia_p,
					ie_exibir_hor_suspensos_p,
					dt_plano_p);
			end;
		end if;
		if (current_setting('plt_gerar_horarios_pck.ie_regra_incl_hemoterapia_w')::char(1) <> 'N') then
			begin
			CALL CALL plt_gerar_horarios_pck.plt_sincronizar_hemoterap(
					nm_usuario_p,
					nr_atendimento_p,
					dt_inicial_p,
					ie_prescr_usuario_p,
					ie_edicao_p,
					ie_estendidos_p,
					dt_referencia_p,
					ie_exibir_hor_suspensos_p,
					dt_plano_p);
			end;
		end if;
		if (current_setting('plt_gerar_horarios_pck.ie_regra_incl_jejum_w')::char(1) <> 'N') then
			begin
			CALL CALL plt_gerar_horarios_pck.plt_sincronizar_jejum(
					nm_usuario_p,
					nr_atendimento_p,
					dt_inicial_p,
					ie_prescr_usuario_p,
					ie_edicao_p,
					ie_estendidos_p,
					dt_referencia_p,
					ie_exibir_hor_suspensos_p,
					dt_plano_p);
			end;
		end if;
		if (current_setting('plt_gerar_horarios_pck.ie_regra_incl_sne_w')::char(1) <> 'N') then
			begin
			CALL CALL plt_gerar_horarios_pck.plt_sincronizar_sne(
					nm_usuario_p,
					nr_atendimento_p,
					dt_inicial_p,
					ie_prescr_usuario_p,
					ie_edicao_p,
					ie_estendidos_p,
					dt_referencia_p,
					ie_exibir_hor_suspensos_p,
					dt_plano_p);
			end;
		end if;
		if (current_setting('plt_gerar_horarios_pck.ie_regra_incl_npt_adulta_w')::char(1) <> 'N') then
			begin
			CALL plt_gerar_horarios_pck.plt_sincronizar_npt_adul(
					nm_usuario_p,
					nr_atendimento_p,
					dt_inicial_p,
					ie_prescr_usuario_p,
					ie_edicao_p,
					ie_estendidos_p,
					dt_referencia_p,
					ie_exibir_hor_suspensos_p,
					dt_plano_p);
			end;
		end if;
	end if;	

	if (current_setting('plt_gerar_horarios_pck.nr_prescr_inicial_sol_w')::bigint	> 0) and (current_setting('plt_gerar_horarios_pck.nr_prescr_final_sol_w')::bigint		> 0) then
		
		if (current_setting('plt_gerar_horarios_pck.ie_regra_incl_solucao_w')::char(1) <> 'N') then
			begin
			CALL CALL plt_gerar_horarios_pck.plt_obter_solucao(
					cd_estabelecimento_p,
					nm_usuario_p,
					nr_atendimento_p,
					dt_inicial_p,
					dt_final_p,
					ie_prescr_usuario_p,
					get_nr_seq_regra,
					ie_sol_continuas_p,
					ie_sol_vigentes_p,
					ie_edicao_p,
					ie_estendidos_p,
					dt_referencia_p,
					ie_exibir_hor_suspensos_p,
					dt_plano_p);		
			CALL CALL plt_gerar_horarios_pck.plt_sincronizar_solucao(
					nm_usuario_p,
					nr_atendimento_p,
					dt_inicial_p,
					dt_final_p,
					dt_inicial_p,
					get_ie_formato_solucoes,
					ie_prescr_usuario_p,
					ie_sol_continuas_p,
					ie_sol_vigentes_p,
					ie_edicao_p,
					ie_estendidos_p,
					dt_referencia_p,
					ie_exibir_hor_suspensos_p,
					dt_plano_p);	
			end;
		end if;
		
	end if;	
	
	if (current_setting('plt_gerar_horarios_pck.nr_prescr_inicial_sae_w')::bigint	> 0) and (current_setting('plt_gerar_horarios_pck.nr_prescr_final_sae_w')::bigint		> 0) and (ie_exibir_sae_p 		= 'S') and (current_setting('plt_gerar_horarios_pck.ie_regra_incl_intervencao_w')::char(1) <> 'N')	then
		begin
		CALL CALL plt_gerar_horarios_pck.plt_obter_interv(
				cd_estabelecimento_p,
				cd_setor_usuario_p,
				cd_perfil_p,
				nm_usuario_p,
				nr_atendimento_p,
				dt_inicial_p,
				dt_final_p,
				dt_inicial_p,
				get_ie_agrupar_acm_sn,
				ie_prescr_usuario_p,
				get_nr_seq_regra,
				ie_exibir_hor_suspensos_p,
				dt_plano_p);
		CALL CALL plt_gerar_horarios_pck.plt_sincronizar_interv(
				nm_usuario_p,
				nr_atendimento_p,
				dt_inicial_p,
				ie_prescr_usuario_p,
				ie_exibir_hor_suspensos_p,
				dt_plano_p);	
		end;			

	end if;	

	update	w_rep_t
	set	nr_prescricoes = plt_obter_prescricoes(nr_atendimento_p, ie_tipo_item, cd_item, nr_seq_proc_interno, cd_intervalo, qt_item, dt_inicial_p, nm_usuario_p,current_setting('plt_gerar_horarios_pck.cd_pessoa_fisica_w')::varchar(10),nr_seq_prot_glic,hr_prim_horario)
	where	nm_usuario = nm_usuario_p
	and		coalesce(dt_atualizacao,clock_timestamp()) between(clock_timestamp() - interval '1 days') and (clock_timestamp() + interval '1 days')
	and	coalesce(nr_prescricoes::text, '') = '';

	commit;
	
	
	update	w_rep_t
	set		ie_prescricao_alta 		= obter_se_prescr_alta_adep(nr_prescricoes),
			ie_hemodialise 		  	= obter_se_prescricao_hemo(nr_atendimento_p,current_setting('plt_gerar_horarios_pck.cd_pessoa_fisica_w')::varchar(10),nr_prescricoes)
	where	nm_usuario				= nm_usuario_p
	and		coalesce(dt_atualizacao,clock_timestamp()) between(clock_timestamp() - interval '1 days') and (clock_timestamp() + interval '1 days');
	
	
	if (current_setting('plt_gerar_horarios_pck.ie_dialise_modelo_w')::varchar(1)	= 'N') then
		delete	FROM w_rep_t
		where	ie_hemodialise	= 'S'
		and		nm_usuario	= nm_usuario_p;
	end if;
	
	update	w_rep_t
	set	dt_extensao	 = NULL
	where	nm_usuario	= nm_usuario_p
	and	coalesce(ie_quimio,'N')	= 'S';	
	

	if (get_ie_fonte_alto_risco	=	'M')  then
		
		update  w_rep_t
		set	ds_item			=	upper(ds_item)
		where	ie_alto_risco		=	'S'
		and	nm_usuario		=	nm_usuario_p
		and	ie_tipo_item		in ('M','SOL');		
		
	end if;

	CALL plt_gerar_ordem_apresent(get_nr_regra_ordem);

	PERFORM set_config('plt_gerar_horarios_pck.ds_funcoes_w', null, false);
	if (get_ds_funcoes IS NOT NULL AND get_ds_funcoes::text <> '') then
		--Buscar os registros em tela na REP - PT

		open C03;
		loop
		fetch C03 into	
			nr_sequencia_w,
			current_setting('plt_gerar_horarios_pck.nr_prescricoes_w')::varchar(4000);
		EXIT WHEN NOT FOUND; /* apply on C03 */
			begin
			ie_valida_w	:= 'N';
			--Separar as prescricoes agrupadas

			while current_setting('plt_gerar_horarios_pck.nr_prescricoes_w')::(varchar(4000) IS NOT NULL AND (varchar(4000))::text <> '') loop
				begin
				if (position(',' in current_setting('plt_gerar_horarios_pck.nr_prescricoes_w')::varchar(4000)) > 0) then
					qt_virgula_w				:= position(',' in current_setting('plt_gerar_horarios_pck.nr_prescricoes_w')::varchar(4000));
					nr_prescr_w				:= (substr(current_setting('plt_gerar_horarios_pck.nr_prescricoes_w')::varchar(4000),1,qt_virgula_w-1))::numeric;
					PERFORM set_config('plt_gerar_horarios_pck.nr_prescricoes_w', substr(current_setting('plt_gerar_horarios_pck.nr_prescricoes_w')::varchar(4000),qt_virgula_w+1,255), false);					
				else
					nr_prescr_w				:= (current_setting('plt_gerar_horarios_pck.nr_prescricoes_w')::varchar(4000))::numeric;
					PERFORM set_config('plt_gerar_horarios_pck.nr_prescricoes_w', '', false);
				end if;
				ds_funcoes_prescr_w := plt_gerar_horarios_pck.get_ds_funcoes();
				--Separar as funcoes do parametro

				while (ds_funcoes_prescr_w IS NOT NULL AND ds_funcoes_prescr_w::text <> '') loop
					begin
					if (position(',' in ds_funcoes_prescr_w) > 0) then
						qt_virgula_ww				:= position(',' in ds_funcoes_prescr_w);
						ie_funcao_prescritor_w			:= substr(ds_funcoes_prescr_w,1,qt_virgula_ww-1);
						ds_funcoes_prescr_w			:= substr(ds_funcoes_prescr_w,qt_virgula_ww+1,255);					
					else
						ie_funcao_prescritor_w			:= ds_funcoes_prescr_w;
						ds_funcoes_prescr_w			:= '';
					end if;
					
					--Verificar se a prescricao confere com a funcao do parametro

					select	coalesce(max('S'),'N')
					into STRICT	ie_valida_w
					from	prescr_medica
					where	nr_prescricao		= nr_prescr_w
					and	ie_funcao_prescritor 	= ie_funcao_prescritor_w;
					
					--Caso uma das prescricoes agrupadas corresponde a alguma funcao informada no parametro, a proxima prescricao nao precisa ser verificada

					if (ie_valida_w	= 'S') then
						exit;
					end if;
					end;
				end loop;
				
				if (ie_valida_w	= 'S') then
					exit;
				end if;
				end;
			end loop;
			
			--Caso o item nao possua prescricao com alguma funcao informada no parametro, ele e deletado

			if (ie_valida_w	= 'N') then
				delete	FROM w_rep_t
				where	nr_sequencia	= nr_sequencia_w;
			end if;
			end;
		end loop;
		close C03;
	
	end if;

	if (coalesce(nr_atendimento_p,0)	= 0) then
		PERFORM set_config('plt_gerar_horarios_pck.nr_prescricao_incluir_w', PLT_obter_prescr_nao_liberada(null,'I',cd_estabelecimento_p,nm_usuario_p,dt_referencia_p,cd_pessoa_fisica_p,cd_perfil_p, cd_setor_atendimento_w), false);
	else	
		PERFORM set_config('plt_gerar_horarios_pck.nr_prescricao_incluir_w', PLT_obter_prescr_nao_liberada(nr_atendimento_p,'I',cd_estabelecimento_p,nm_usuario_p,dt_referencia_p,cd_pessoa_fisica_p,cd_perfil_p, cd_setor_atendimento_w), false);
	end if;
	
	if	((get_ie_gerar_titulos = 'N') or (get_ie_gerar_titulos = 'T')) and (current_setting('plt_gerar_horarios_pck.nr_prescricao_incluir_w')::bigint	> 0) then	

		select coalesce(max(ie_prescr_emergencia),'N')
		into STRICT	current_setting('plt_gerar_horarios_pck.ie_retrogrado_ww')::varchar(1)
		from	prescr_medica
		where	nr_prescricao = current_setting('plt_gerar_horarios_pck.nr_prescricao_incluir_w')::bigint;
		
		select coalesce(max('S'),'N')
		into STRICT	current_setting('plt_gerar_horarios_pck.ie_existe_rep_w')::varchar(1)
		from	w_rep_t_v;
		
		if (current_setting('plt_gerar_horarios_pck.ie_existe_rep_w')::varchar(1)	<> 'S') and (current_setting('plt_gerar_horarios_pck.ie_retrogrado_ww')::varchar(1)	= 'S') then
			CALL plt_gerar_titulos(nm_usuario_p, current_setting('plt_gerar_horarios_pck.cd_estabelecimento_w')::estabelecimento.cd_estabelecimento%type, cd_setor_usuario_p, current_setting('plt_gerar_horarios_pck.cd_perfil_w')::perfil.cd_perfil%type, get_nr_seq_regra);
		end if;
	end if;
	
	if (get_ie_gerar_titulos = 'S') or (get_ie_gerar_titulos = 'T') then
		CALL plt_gerar_titulos(nm_usuario_p, current_setting('plt_gerar_horarios_pck.cd_estabelecimento_w')::estabelecimento.cd_estabelecimento%type, cd_setor_usuario_p, current_setting('plt_gerar_horarios_pck.cd_perfil_w')::perfil.cd_perfil%type, get_nr_seq_regra);
	end if;

	select	max(ie_curta_duracao)
	into STRICT	ie_curta_duracao_w
	from	w_rep_t
	where	nm_usuario	= nm_usuario_p
	and		coalesce(dt_atualizacao,clock_timestamp()) between(clock_timestamp() - interval '1 days') and (clock_timestamp() + interval '1 days')
	and		ie_curta_duracao	= 'L';
	
	if (coalesce(ie_curta_duracao_w::text, '') = '') then
		select	coalesce(max(ie_curta_duracao),'N')
		into STRICT	ie_curta_duracao_w
		from	w_rep_t
		where	nm_usuario	= nm_usuario_p
		and		coalesce(dt_atualizacao,clock_timestamp()) between(clock_timestamp() - interval '1 days') and (clock_timestamp() + interval '1 days')
		and		ie_curta_duracao	= 'S';
	end if;

	PERFORM set_config('plt_gerar_horarios_pck.nr_prescricao_max_w', coalesce(PLT_obter_max_nrprescricao,1), false);
	
	if (coalesce(nr_atendimento_p,0) = 0) then
		nr_prescricao_liberar_w   := PLT_obter_prescr_nao_liberada(null,'L',cd_estabelecimento_p,nm_usuario_p,dt_referencia_p,cd_pessoa_fisica_p,cd_perfil_p, cd_setor_atendimento_w);
		nr_prescricao_estendida_w := PLT_obter_prescr_nao_liberada(null,'E',cd_estabelecimento_p,nm_usuario_p,dt_referencia_p,cd_pessoa_fisica_p,cd_perfil_p, cd_setor_atendimento_w);
	else
		nr_prescricao_liberar_w   := PLT_obter_prescr_nao_liberada(nr_atendimento_p,'L',cd_estabelecimento_p,nm_usuario_p,dt_referencia_p,cd_pessoa_fisica_p,cd_perfil_p, cd_setor_atendimento_w);
		nr_prescricao_estendida_w := PLT_obter_prescr_nao_liberada(nr_atendimento_p,'E',cd_estabelecimento_p,nm_usuario_p,dt_referencia_p,cd_pessoa_fisica_p,cd_perfil_p, cd_setor_atendimento_w);
	end if;
	
	update	w_rep_t
	set 	nr_prescricao_max 		= current_setting('plt_gerar_horarios_pck.nr_prescricao_max_w')::bigint,
			nr_prescricao_liberar   = nr_prescricao_liberar_w,
			nr_prescricao_incluir   = current_setting('plt_gerar_horarios_pck.nr_prescricao_incluir_w')::bigint,
			nr_prescricao_estendida = nr_prescricao_estendida_w,
			ie_curta_duracao		= ie_curta_duracao_w
	where	nm_usuario = nm_usuario_p
	and		coalesce(dt_atualizacao,clock_timestamp()) between(clock_timestamp() - interval '1 days') and (clock_timestamp() + interval '1 days');	
	commit;
	end;
	

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE plt_gerar_horarios_pck.gerar_horarios_plt ( cd_estabelecimento_p bigint, cd_setor_usuario_p bigint, cd_perfil_p bigint, nm_usuario_p text, nr_atendimento_p bigint, dt_inicial_p timestamp, dt_final_p timestamp, ie_prescr_usuario_p text, ie_exibir_sae_p text, ie_sol_continuas_p text, ie_sol_vigentes_p text, ie_edicao_p text, ie_estendidos_p bigint, dt_referencia_p timestamp, ie_exibir_hor_suspensos_p text, dt_plano_p text, cd_pessoa_fisica_p text, nr_seq_modelo_p integer) FROM PUBLIC;
