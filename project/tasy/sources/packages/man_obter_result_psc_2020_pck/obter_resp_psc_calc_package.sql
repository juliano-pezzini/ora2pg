-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION man_obter_result_psc_2020_pck.obter_resp_psc_calc ( nm_usuario_p text, dt_inicio_p timestamp, dt_fim_p timestamp, ie_produto_p text, ie_migracao_p text, cd_gerente_p bigint, sg_estado_p text, nr_seq_canal_p bigint) RETURNS SETOF T_PERGUNTAS_RESPOSTAS_ROW AS $body$
DECLARE


t_avaliacao_row_w	t_avaliacao_row;

nps_adm_w		bigint;
nps_ti_w		bigint;
nps_total_w		bigint;
qt_promotores_adm_w	bigint;
qt_detratores_adm_w	bigint;
qt_respondentes_adm_w	bigint;
qt_promotores_ti_w	bigint;
qt_detratores_ti_w	bigint;
qt_respondentes_ti_w	bigint;


  reg RECORD;

BEGIN

	for reg in (
		SELECT	a.ds_cliente,
			a.dt_avaliacao,
			a.questao_1 q_1,
			a.questao_2 q_2,
			a.questao_3 q_3,
			a.questao_4 q_4,
			a.questao_5 q_5,
			a.questao_6 q_6,
			a.questao_7 q_7,
			a.questao_8 q_8,
			a.questao_9 q_9,
			a.questao_10 q_10,
			a.questao_11 q_11,
			a.questao_12 q_12,
			a.questao_13 q_13,
			a.questao_14 q_14,
			a.questao_15 q_15,
			a.questao_16 q_16,
			a.questao_17 q_17,
			a.questao_18 q_18,
			a.questao_19 q_19,
			a.questao_20 q_20,
			a.questao_21 q_21,
			a.questao_22 q_22,
			a.questao_23 q_23,
			a.questao_24 q_24,
			a.questao_25 q_25,
			a.questao_26 q_26,
			a.questao_27 q_27,
			a.questao_28 q_28,
			a.questao_29 q_29,
			a.questao_30 q_30,
			a.questao_31 q_31,
			a.questao_32 q_32,
			a.questao_33 q_33,
			a.questao_34 q_34,
			a.questao_35 q_35,
			a.questao_36 q_36,
			a.questao_37 q_37,
			a.questao_38 q_38,
			a.questao_39 q_39,
			a.questao_40 q_40,
			a.questao_41 q_41,
			a.questao_42 q_42,
			a.questao_43 q_43,
			a.questao_44 q_44,
			a.questao_45 q_45,
			a.questao_46 q_46,
			a.questao_47 q_47,
			a.questao_48 q_48,
			a.questao_49 q_49,
			a.questao_50 q_50,
			a.questao_51 q_51,
			a.questao_52 q_52,
			a.questao_53 q_53,
			a.questao_54 q_54,
			a.questao_55 q_55,
			a.questao_56 q_56,
			a.questao_57 q_57,
			a.questao_58 q_58,
			a.questao_59 q_59
		from	table(man_obter_result_psc_2020_pck.obter_respostas_psc(nm_usuario_p, dt_inicio_p, dt_fim_p, ie_produto_p, ie_migracao_p, cd_gerente_p, sg_estado_p, nr_seq_canal_p)) a
	) loop
		begin
			t_avaliacao_row_w.ds_cliente	:= reg.ds_cliente;
			t_avaliacao_row_w.dt_avaliacao	:= reg.dt_avaliacao;
			t_avaliacao_row_w.questao_1	    := reg.q_1;
			t_avaliacao_row_w.questao_2	    := reg.q_2;
			t_avaliacao_row_w.questao_3	    := reg.q_3;
			t_avaliacao_row_w.questao_4	    := reg.q_4;
			t_avaliacao_row_w.questao_5	    := reg.q_5;
			t_avaliacao_row_w.questao_6	    := reg.q_6;
			t_avaliacao_row_w.questao_7	    := reg.q_7;
			t_avaliacao_row_w.questao_8	    := reg.q_8;
			t_avaliacao_row_w.questao_9	    := reg.q_9;
			t_avaliacao_row_w.questao_10	:= reg.q_10;
			t_avaliacao_row_w.questao_11	:= reg.q_11;
			t_avaliacao_row_w.questao_12	:= reg.q_12;
			t_avaliacao_row_w.questao_13	:= reg.q_13;
			t_avaliacao_row_w.questao_14	:= reg.q_14;
			t_avaliacao_row_w.questao_15	:= reg.q_15;
			t_avaliacao_row_w.questao_16	:= reg.q_16;
			t_avaliacao_row_w.questao_17	:= reg.q_17;
			t_avaliacao_row_w.questao_18	:= reg.q_18;
			t_avaliacao_row_w.questao_19	:= reg.q_19;
			t_avaliacao_row_w.questao_20	:= reg.q_20;
			t_avaliacao_row_w.questao_21	:= reg.q_21;
			t_avaliacao_row_w.questao_22	:= reg.q_22;
			t_avaliacao_row_w.questao_23	:= reg.q_23;
			t_avaliacao_row_w.questao_24	:= reg.q_24;
			t_avaliacao_row_w.questao_25	:= reg.q_25;
			t_avaliacao_row_w.questao_26	:= reg.q_26;
			t_avaliacao_row_w.questao_27	:= reg.q_27;
			t_avaliacao_row_w.questao_28	:= reg.q_28;
			t_avaliacao_row_w.questao_29	:= reg.q_29;
			t_avaliacao_row_w.questao_30	:= reg.q_30;
			t_avaliacao_row_w.questao_31	:= reg.q_31;
			t_avaliacao_row_w.questao_32	:= reg.q_32;
			t_avaliacao_row_w.questao_33	:= reg.q_33;
			t_avaliacao_row_w.questao_34	:= reg.q_34;
			t_avaliacao_row_w.questao_35	:= reg.q_35;
			t_avaliacao_row_w.questao_36	:= reg.q_36;
			t_avaliacao_row_w.questao_37	:= reg.q_37;
			t_avaliacao_row_w.questao_38	:= reg.q_38;
			t_avaliacao_row_w.questao_39	:= reg.q_39;
			t_avaliacao_row_w.questao_40	:= reg.q_40;
			t_avaliacao_row_w.questao_41	:= reg.q_41;
			t_avaliacao_row_w.questao_42	:= reg.q_42;
			t_avaliacao_row_w.questao_43	:= reg.q_43;
			t_avaliacao_row_w.questao_44	:= reg.q_44;
			t_avaliacao_row_w.questao_45	:= reg.q_45;
			t_avaliacao_row_w.questao_46	:= reg.q_46;
			t_avaliacao_row_w.questao_47	:= reg.q_47;
			t_avaliacao_row_w.questao_48	:= reg.q_48;
			t_avaliacao_row_w.questao_49	:= reg.q_49;
			t_avaliacao_row_w.questao_50	:= reg.q_50;
			t_avaliacao_row_w.questao_51	:= reg.q_51;
			t_avaliacao_row_w.questao_52	:= reg.q_52;
			t_avaliacao_row_w.questao_53	:= reg.q_53;
			t_avaliacao_row_w.questao_54	:= reg.q_54;
			t_avaliacao_row_w.questao_55	:= reg.q_55;
			t_avaliacao_row_w.questao_56	:= reg.q_56;
			t_avaliacao_row_w.questao_57	:= reg.q_57;
			t_avaliacao_row_w.questao_58	:= reg.q_58;
			t_avaliacao_row_w.questao_59	:= reg.q_59;
			RETURN NEXT t_avaliacao_row_w;
		end;
	end loop;

	/* Adiciona uma linha em branco para a tabela */

	t_avaliacao_row_w.ds_cliente	:= '';
	t_avaliacao_row_w.dt_avaliacao	:= null;
	t_avaliacao_row_w.questao_1	    := '';
	t_avaliacao_row_w.questao_2	    := '';
	t_avaliacao_row_w.questao_3	    := '';
	t_avaliacao_row_w.questao_4	    := '';
	t_avaliacao_row_w.questao_5	    := '';
	t_avaliacao_row_w.questao_6	    := '';
	t_avaliacao_row_w.questao_7	    := '';
	t_avaliacao_row_w.questao_8	    := '';
	t_avaliacao_row_w.questao_9	    := '';
	t_avaliacao_row_w.questao_10	:= '';
	t_avaliacao_row_w.questao_11	:= '';
	t_avaliacao_row_w.questao_12	:= '';
	t_avaliacao_row_w.questao_13	:= '';
	t_avaliacao_row_w.questao_14	:= '';
	t_avaliacao_row_w.questao_15	:= '';
	t_avaliacao_row_w.questao_16	:= '';
	t_avaliacao_row_w.questao_17	:= '';
	t_avaliacao_row_w.questao_18	:= '';
	t_avaliacao_row_w.questao_19	:= '';
	t_avaliacao_row_w.questao_20	:= '';
	t_avaliacao_row_w.questao_21	:= '';
	t_avaliacao_row_w.questao_22	:= '';
	t_avaliacao_row_w.questao_23	:= '';
	t_avaliacao_row_w.questao_24	:= '';
	t_avaliacao_row_w.questao_25	:= '';
	t_avaliacao_row_w.questao_26	:= '';
	t_avaliacao_row_w.questao_27	:= '';
	t_avaliacao_row_w.questao_28	:= '';
	t_avaliacao_row_w.questao_29	:= '';
	t_avaliacao_row_w.questao_30	:= '';
	t_avaliacao_row_w.questao_31	:= '';
	t_avaliacao_row_w.questao_32	:= '';
	t_avaliacao_row_w.questao_33	:= '';
	t_avaliacao_row_w.questao_34	:= '';
	t_avaliacao_row_w.questao_35	:= '';
	t_avaliacao_row_w.questao_36	:= '';
	t_avaliacao_row_w.questao_37	:= '';
	t_avaliacao_row_w.questao_38	:= '';
	t_avaliacao_row_w.questao_39	:= '';
	t_avaliacao_row_w.questao_40	:= '';
	t_avaliacao_row_w.questao_41	:= '';
	t_avaliacao_row_w.questao_42	:= '';
	t_avaliacao_row_w.questao_43	:= '';
	t_avaliacao_row_w.questao_44	:= '';
	t_avaliacao_row_w.questao_45	:= '';
	t_avaliacao_row_w.questao_46	:= '';
	t_avaliacao_row_w.questao_47	:= '';
	t_avaliacao_row_w.questao_48	:= '';
	t_avaliacao_row_w.questao_49	:= '';
	t_avaliacao_row_w.questao_50	:= '';
	t_avaliacao_row_w.questao_51	:= '';
	t_avaliacao_row_w.questao_52	:= '';
	t_avaliacao_row_w.questao_53	:= '';
	t_avaliacao_row_w.questao_54	:= '';
	t_avaliacao_row_w.questao_55	:= '';
	t_avaliacao_row_w.questao_56	:= '';
	t_avaliacao_row_w.questao_57	:= '';
	t_avaliacao_row_w.questao_58	:= '';
	t_avaliacao_row_w.questao_59	:= '';
	RETURN NEXT t_avaliacao_row_w;

	t_avaliacao_row_w.questao_1	:= 'NPS Administracao';
	t_avaliacao_row_w.questao_2	:= 'NPS TI';
	t_avaliacao_row_w.questao_3	:= 'NPS Total';
	RETURN NEXT t_avaliacao_row_w;

	/* Calculos de NPS */

	/* Calculo do NPS da Administracao */

	select (dividir(count(case when a.questao_8 >= 9 then 1 end) - count(case when a.questao_8 <= 6 then 1 end), count(a.questao_8)) * 100),
		count(case when a.questao_8 >= 9 then 1 end),
		count(case when a.questao_8 <= 6 then 1 end),
		count(a.questao_8)
	into STRICT	nps_adm_w,
		qt_promotores_adm_w,
		qt_detratores_adm_w,
		qt_respondentes_adm_w
	from	table(man_obter_result_psc_2020_pck.obter_respostas_psc(nm_usuario_p, dt_inicio_p, dt_fim_p, ie_produto_p, ie_migracao_p, cd_gerente_p, sg_estado_p, nr_seq_canal_p)) a
	where	lower(a.questao_8) not like '%em uma escala de 1 %'
	and	a.questao_8 not like 'N/A'
	and	a.questao_8 not like 'NR';

	/* Calculo do NPS da TI */

	select (dividir(count(case when a.questao_30 >= 9 then 1 end) - count(case when a.questao_30 <= 6 then 1 end), count(a.questao_30)) * 100),
		count(case when a.questao_30 >= 9 then 1 end),
		count(case when a.questao_30 <= 6 then 1 end),
		count(a.questao_30)
	into STRICT	nps_ti_w,
		qt_promotores_ti_w,
		qt_detratores_ti_w,
		qt_respondentes_ti_w
	from	table(man_obter_result_psc_2020_pck.obter_respostas_psc(nm_usuario_p, dt_inicio_p, dt_fim_p, ie_produto_p, ie_migracao_p, cd_gerente_p, sg_estado_p, nr_seq_canal_p)) a
	where	lower(a.questao_8) not like '%em uma escala de 1 %'
	and	a.questao_30 not like 'N/A'
	and	a.questao_30 not like 'NR';

	/* Calculo do NPS Total */

	select	dividir(((qt_promotores_adm_w + qt_promotores_ti_w) - (qt_detratores_adm_w + qt_detratores_ti_w)), (qt_respondentes_adm_w + qt_respondentes_ti_w)) * 100
	into STRICT	nps_total_w
	;

	t_avaliacao_row_w.questao_1	:= coalesce(nps_adm_w, 0);
	t_avaliacao_row_w.questao_2	:= coalesce(nps_ti_w, 0);
	t_avaliacao_row_w.questao_3	:= coalesce(nps_total_w, 0);
	RETURN NEXT t_avaliacao_row_w;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION man_obter_result_psc_2020_pck.obter_resp_psc_calc ( nm_usuario_p text, dt_inicio_p timestamp, dt_fim_p timestamp, ie_produto_p text, ie_migracao_p text, cd_gerente_p bigint, sg_estado_p text, nr_seq_canal_p bigint) FROM PUBLIC;
