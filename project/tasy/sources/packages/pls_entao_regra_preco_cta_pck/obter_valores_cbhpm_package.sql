-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_entao_regra_preco_cta_pck.obter_valores_cbhpm ( ie_destino_regra_p text, nr_seq_cbhpm_edicao_p pls_cp_cta_eproc.nr_seq_cbhpm_edicao%type, vl_tx_honorarios_p pls_cp_cta_eproc.vl_ch_honorarios%type, vl_tx_custo_oper_p pls_cp_cta_eproc.vl_ch_custo_oper%type, vl_filme_p pls_cp_cta_eproc.vl_filme%type, tx_ajuste_ch_honor_p pls_cp_cta_eproc.tx_ajuste_ch_honor%type, tx_ajuste_custo_oper_p pls_cp_cta_eproc.tx_ajuste_custo_oper%type, tx_ajuste_filme_p pls_cp_cta_eproc.tx_ajuste_filme%type, tx_ajuste_partic_p pls_cp_cta_eproc.tx_ajuste_partic%type, dt_proced_referencia_p pls_conta_proc.dt_procedimento_referencia%type, cd_procedimento_p pls_conta_proc.cd_procedimento%type, ie_origem_proc_p pls_conta_proc.ie_origem_proced%type, vl_moeda_filme_p pls_cp_cta_eproc.cd_moeda_filme%type, cd_especialidade_p grupo_proc.cd_especialidade%type, cd_grupo_proc_p procedimento.cd_grupo_proc%type, cd_area_proced_p especialidade_proc.cd_area_procedimento%type, nr_seq_conta_proc_p pls_conta_proc.nr_sequencia%type, nr_seq_prestador_exec_p pls_conta.nr_seq_prestador_exec%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type, ie_ch_padrao_anest_p pls_cp_cta_eproc.ie_ch_padrao_anestesista%type, vl_moeda_anest_p pls_cp_cta_eproc.cd_moeda_filme%type, vl_procedimento_p INOUT bigint, vl_custo_operacional_p INOUT bigint, vl_medico_p INOUT bigint, vl_filme_cbhpm_p INOUT bigint, nr_auxiliar_p INOUT preco_tuss.nr_auxiliares_cbhpm%type, vl_auxiliares_p INOUT bigint, cd_porte_anestesico_p INOUT preco_tuss.nr_porte_anest_amb%type, vl_anestesista_p INOUT bigint) AS $body$
DECLARE


dt_inicio_vig_edicao_w	cbhpm_edicao.dt_vigencia%type;
qt_uco_cbhpm_w 		cbhpm_preco.qt_uco%type;
vl_medico_cbhpm_w	pls_conta_proc.vl_medico%type;
qt_filme_cbhpm_w	cbhpm_preco.qt_filme%type;
nr_porte_anest_cbhpm_w	cbhpm_preco.nr_porte_anest%type;
nr_auxiliar_cbhpm_w	cbhpm_preco.nr_auxiliar%type;
vl_auxiliares_w		pls_conta_proc.vl_auxiliares%type;
vl_anestesista_w	pls_conta_proc.vl_anestesista%type;
vl_porte_anest_cbhpm_w	cbhpm_porte.vl_porte%type;
vl_procedimento_w	pls_conta_proc.vl_procedimento%type;
vl_filme_cbhpm_w	preco_tuss.vl_filme%type;
vl_medico_w		pls_conta_proc.vl_medico%type;
vl_custo_operacional_w	pls_conta_proc.vl_custo_operacional%type;


BEGIN
-- pega a data da edição CBHPM, se não encontrar retorna a data do procedimento
select	coalesce(max(dt_vigencia), dt_proced_referencia_p)
into STRICT	dt_inicio_vig_edicao_w
from	cbhpm_edicao
where	nr_sequencia = nr_seq_cbhpm_edicao_p;

-- obtém os valores da tabela CBHPM
SELECT * FROM pls_entao_regra_preco_cta_pck.obter_preco_cbhpm(	cd_procedimento_p, ie_origem_proc_p, dt_proced_referencia_p, dt_inicio_vig_edicao_w, nr_seq_prestador_exec_p, cd_estabelecimento_p, cd_grupo_proc_p, cd_especialidade_p, cd_area_proced_p, vl_medico_cbhpm_w, qt_uco_cbhpm_w, nr_porte_anest_cbhpm_w, nr_auxiliar_cbhpm_w, qt_filme_cbhpm_w, vl_porte_anest_cbhpm_w) INTO STRICT vl_medico_cbhpm_w, qt_uco_cbhpm_w, nr_porte_anest_cbhpm_w, nr_auxiliar_cbhpm_w, qt_filme_cbhpm_w, vl_porte_anest_cbhpm_w;

CALL pls_entao_regra_preco_cta_pck.gerencia_log_proc(	'Valores obtidos na tabela de preços CBHPM.',
			nr_seq_conta_proc_p,
			null,
			null,
			null,
			null,
			vl_medico_cbhpm_w,
			null,
			ie_destino_regra_p,
			nm_usuario_p);

-- aplica as taxas pertinentes a CBHPM
SELECT * FROM pls_entao_regra_preco_cta_pck.aplica_taxas_cbhpm(	qt_uco_cbhpm_w, vl_tx_custo_oper_p, vl_medico_cbhpm_w, vl_tx_honorarios_p, qt_filme_cbhpm_w, vl_filme_p, vl_moeda_filme_p, tx_ajuste_filme_p, tx_ajuste_custo_oper_p, tx_ajuste_ch_honor_p, vl_custo_operacional_w, vl_medico_w, vl_filme_cbhpm_w, nr_porte_anest_cbhpm_w, nr_auxiliar_cbhpm_w) INTO STRICT vl_custo_operacional_w, vl_medico_w, vl_filme_cbhpm_w, nr_porte_anest_cbhpm_w, nr_auxiliar_cbhpm_w;

CALL pls_entao_regra_preco_cta_pck.gerencia_log_proc(	'Realizado cálculo de CO e Filme, aplicado taxas e cotação de moedas.',
			nr_seq_conta_proc_p,
			null,
			null,
			vl_custo_operacional_w,
			vl_filme_cbhpm_w,
			vl_medico_w,
			null,
			ie_destino_regra_p,
			nm_usuario_p);

-- obtém o valor dos auxiliares
vl_auxiliares_w := pls_entao_regra_preco_cta_pck.obter_valor_aux_cbhpm( 	vl_medico_w, nr_auxiliar_cbhpm_w);

-- obtém o valor do anestesista
vl_anestesista_w := pls_entao_regra_preco_cta_pck.obter_valor_anest_cbhpm(	ie_ch_padrao_anest_p, vl_moeda_anest_p, vl_porte_anest_cbhpm_w,
						tx_ajuste_partic_p, vl_tx_honorarios_p);

-- calcula o valor do procedimento
vl_procedimento_w := pls_entao_regra_preco_cta_pck.obter_valor_proced( 	vl_custo_operacional_w, vl_anestesista_w, vl_medico_w,
						vl_filme_cbhpm_w, vl_auxiliares_w);

CALL pls_entao_regra_preco_cta_pck.gerencia_log_proc(	'Obtidos valores dos auxiliares e anestesista. Realizado cálculo do valor do procedimento.',
			nr_seq_conta_proc_p,
			vl_anestesista_w,
			vl_auxiliares_w,
			vl_custo_operacional_w,
			vl_filme_cbhpm_w,
			vl_medico_w,
			vl_procedimento_w,
			ie_destino_regra_p,
			nm_usuario_p);

-- alimenta os parametros out
vl_custo_operacional_p := vl_custo_operacional_w;
vl_medico_p := vl_medico_w;
vl_filme_cbhpm_p := vl_filme_cbhpm_w;
nr_auxiliar_p := nr_auxiliar_cbhpm_w;
vl_auxiliares_p := vl_auxiliares_w;
cd_porte_anestesico_p := nr_porte_anest_cbhpm_w;
vl_procedimento_p := vl_procedimento_w;
vl_anestesista_p := vl_anestesista_w;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_entao_regra_preco_cta_pck.obter_valores_cbhpm ( ie_destino_regra_p text, nr_seq_cbhpm_edicao_p pls_cp_cta_eproc.nr_seq_cbhpm_edicao%type, vl_tx_honorarios_p pls_cp_cta_eproc.vl_ch_honorarios%type, vl_tx_custo_oper_p pls_cp_cta_eproc.vl_ch_custo_oper%type, vl_filme_p pls_cp_cta_eproc.vl_filme%type, tx_ajuste_ch_honor_p pls_cp_cta_eproc.tx_ajuste_ch_honor%type, tx_ajuste_custo_oper_p pls_cp_cta_eproc.tx_ajuste_custo_oper%type, tx_ajuste_filme_p pls_cp_cta_eproc.tx_ajuste_filme%type, tx_ajuste_partic_p pls_cp_cta_eproc.tx_ajuste_partic%type, dt_proced_referencia_p pls_conta_proc.dt_procedimento_referencia%type, cd_procedimento_p pls_conta_proc.cd_procedimento%type, ie_origem_proc_p pls_conta_proc.ie_origem_proced%type, vl_moeda_filme_p pls_cp_cta_eproc.cd_moeda_filme%type, cd_especialidade_p grupo_proc.cd_especialidade%type, cd_grupo_proc_p procedimento.cd_grupo_proc%type, cd_area_proced_p especialidade_proc.cd_area_procedimento%type, nr_seq_conta_proc_p pls_conta_proc.nr_sequencia%type, nr_seq_prestador_exec_p pls_conta.nr_seq_prestador_exec%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type, ie_ch_padrao_anest_p pls_cp_cta_eproc.ie_ch_padrao_anestesista%type, vl_moeda_anest_p pls_cp_cta_eproc.cd_moeda_filme%type, vl_procedimento_p INOUT bigint, vl_custo_operacional_p INOUT bigint, vl_medico_p INOUT bigint, vl_filme_cbhpm_p INOUT bigint, nr_auxiliar_p INOUT preco_tuss.nr_auxiliares_cbhpm%type, vl_auxiliares_p INOUT bigint, cd_porte_anestesico_p INOUT preco_tuss.nr_porte_anest_amb%type, vl_anestesista_p INOUT bigint) FROM PUBLIC;
