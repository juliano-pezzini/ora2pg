-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

-- controle para decidir quando o select para obtenção dos valores dos parâmetros deve ser executado novamente
-- parâmetros ops
-- parâmetros faturamento
-- tabelas de log
-- materiais
-- procedimento
-- serviço
-- participante
CREATE OR REPLACE PROCEDURE pls_entao_regra_preco_cta_pck.carrega_parametros ( cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) AS $body$
BEGIN

-- se a data da última solicitação não estiver registrada ou 
-- se já se passou 67 segundos deste a última solicitação ou
-- se a origem for diferente da última solicitada ou
-- se o estabelecimento anterior for diferente do último solicitado
-- executa o comando para preencher os valores dos parâmetros
if	((current_setting('pls_entao_regra_preco_cta_pck.dt_solicitacao_ult_w')::coalesce(timestamp::text, '') = '') or
	(current_setting('pls_entao_regra_preco_cta_pck.dt_solicitacao_ult_w')::timestamp <= (clock_timestamp() - interval '67 seconds')) or (coalesce(current_setting('pls_entao_regra_preco_cta_pck.cd_estabelecimento_ult_w')::estabelecimento.cd_estabelecimento%type, -1) != coalesce(cd_estabelecimento_p, -2))) then

	-- se tiver estabelecimento filtra por estabelecimento
	-- caso contrário pega o registro máximo da tabela
	if (cd_estabelecimento_p IS NOT NULL AND cd_estabelecimento_p::text <> '') then
				
		select	coalesce(max(ie_exige_lib_bras),'N'),
			coalesce(max(ie_fora_linha_simpro),'S'),
			coalesce(max(ie_porte_amb_tuss),'A')
		into STRICT	current_setting('pls_entao_regra_preco_cta_pck.ie_exige_lib_w')::pls_parametros.ie_exige_lib_bras%type,
			current_setting('pls_entao_regra_preco_cta_pck.ie_fora_linha_w')::pls_parametros.ie_fora_linha_simpro%type,
			current_setting('pls_entao_regra_preco_cta_pck.ie_porte_amb_tuss_w')::pls_parametros.ie_porte_amb_tuss%type
		from	pls_parametros
		where	cd_estabelecimento = cd_estabelecimento_p;

		select	coalesce(max(ie_data_vig_cbhpm), 'N'),
			coalesce(max(ie_despreza_casa_cbhpm), 'N'),
			coalesce(max(ie_preco_cbhpm_data), 'N')
		into STRICT	current_setting('pls_entao_regra_preco_cta_pck.ie_data_vig_cbhpm_w')::parametro_faturamento.ie_data_vig_cbhpm%type,
			current_setting('pls_entao_regra_preco_cta_pck.ie_despreza_casa_cbhpm_w')::parametro_faturamento.ie_despreza_casa_cbhpm%type,
			current_setting('pls_entao_regra_preco_cta_pck.ie_preco_cbhpm_data_w')::parametro_faturamento.ie_preco_cbhpm_data%type
		from	parametro_faturamento
		where	cd_estabelecimento = cd_estabelecimento_p;
	else

		select	coalesce(max(ie_exige_lib_bras),'N'),
			coalesce(max(ie_fora_linha_simpro),'S'),
			coalesce(max(ie_porte_amb_tuss),'A')
		into STRICT	current_setting('pls_entao_regra_preco_cta_pck.ie_exige_lib_w')::pls_parametros.ie_exige_lib_bras%type,
			current_setting('pls_entao_regra_preco_cta_pck.ie_fora_linha_w')::pls_parametros.ie_fora_linha_simpro%type,
			current_setting('pls_entao_regra_preco_cta_pck.ie_porte_amb_tuss_w')::pls_parametros.ie_porte_amb_tuss%type
		from	pls_parametros;
		
		select	coalesce(max(ie_data_vig_cbhpm), 'N'),
			coalesce(max(ie_despreza_casa_cbhpm), 'N'),
			coalesce(max(ie_preco_cbhpm_data), 'N')
		into STRICT	current_setting('pls_entao_regra_preco_cta_pck.ie_data_vig_cbhpm_w')::parametro_faturamento.ie_data_vig_cbhpm%type,
			current_setting('pls_entao_regra_preco_cta_pck.ie_despreza_casa_cbhpm_w')::parametro_faturamento.ie_despreza_casa_cbhpm%type,
			current_setting('pls_entao_regra_preco_cta_pck.ie_preco_cbhpm_data_w')::parametro_faturamento.ie_preco_cbhpm_data%type
		from	parametro_faturamento;
	end if;
	
	PERFORM set_config('pls_entao_regra_preco_cta_pck.cd_estabelecimento_ult_w', cd_estabelecimento_p, false);
	PERFORM set_config('pls_entao_regra_preco_cta_pck.dt_solicitacao_ult_w', clock_timestamp(), false);
end if;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_entao_regra_preco_cta_pck.carrega_parametros ( cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) FROM PUBLIC;
