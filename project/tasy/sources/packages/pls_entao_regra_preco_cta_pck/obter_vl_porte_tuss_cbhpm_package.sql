-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pls_entao_regra_preco_cta_pck.obter_vl_porte_tuss_cbhpm ( cd_porte_p preco_tuss.cd_porte_cbhpm%type, nr_seq_edicao_tuss_p pls_edicao_preco_tuss.nr_sequencia%type, dt_referencia_p pls_conta_proc.dt_procedimento_referencia%type) RETURNS bigint AS $body$
DECLARE


dt_vigencia_edicao_w	pls_edicao_preco_tuss.dt_vigencia%type;
vl_porte_w		tuss_porte.vl_porte%type;

C01 CURSOR(	cd_porte_pc		tuss_porte.cd_porte%type,
		dt_referencia_pc	tuss_porte.dt_vigencia%type,
		dt_vigencia_pc		tuss_porte.dt_vigencia%type) FOR
	SELECT	vl_porte
	from	tuss_porte
	where	cd_porte = cd_porte_pc
	and	dt_vigencia <= dt_referencia_pc
	and	dt_vigencia <= dt_vigencia_pc
	order by dt_vigencia desc;
BEGIN
-- inicia como zero
vl_porte_w := 0;

-- se tem código do porte vai atras do valor
if (cd_porte_p IS NOT NULL AND cd_porte_p::text <> '') then
	if (coalesce(nr_seq_edicao_tuss_p::text, '') = '') then

		-- se não tem edição passa a data de referência como parametro, tanto na data ref quanto na dt vigencia
		for r_c01_w in C01(	cd_porte_p, dt_referencia_p, dt_referencia_p) loop
		
			-- retorna os registros mais atuais primeiro, e o primeiro é o correto
			vl_porte_w := r_c01_w.vl_porte;
			
			-- sai do for e fecha o cursor
			exit;
		end loop;
	else
		-- tenta encontrar a data de vigência da edição, caso não encontre ou por algum motivo
		-- seja nula, retorna a data passada de parâmetro
		select	coalesce(max(dt_vigencia), dt_referencia_p)
		into STRICT	dt_vigencia_edicao_w
		from	pls_edicao_preco_tuss
		where	nr_sequencia = nr_seq_edicao_tuss_p;
		
		for r_c01_w in C01(	cd_porte_p, dt_referencia_p, dt_vigencia_edicao_w) loop
			
			-- retorna os registros mais atuais primeiro, e o primeiro é o correto
			vl_porte_w := r_c01_w.vl_porte;
			
			-- sai do for e fecha o cursor
			exit;
		end loop;
	end if;
end if;

return vl_porte_w;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pls_entao_regra_preco_cta_pck.obter_vl_porte_tuss_cbhpm ( cd_porte_p preco_tuss.cd_porte_cbhpm%type, nr_seq_edicao_tuss_p pls_edicao_preco_tuss.nr_sequencia%type, dt_referencia_p pls_conta_proc.dt_procedimento_referencia%type) FROM PUBLIC;
