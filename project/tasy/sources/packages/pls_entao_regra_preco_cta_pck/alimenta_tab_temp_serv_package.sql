-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_entao_regra_preco_cta_pck.alimenta_tab_temp_serv ( ie_destino_regra_p text, nr_seq_lote_conta_p pls_protocolo_conta.nr_seq_lote%type, nr_seq_protocolo_p pls_protocolo_conta.nr_sequencia%type, nr_seq_lote_processo_p pls_cta_lote_processo.nr_sequencia%type, nr_seq_conta_p pls_conta.nr_sequencia%type, nr_seq_conta_proc_p pls_conta_proc.nr_sequencia%type, nr_seq_conta_mat_p pls_conta_mat.nr_sequencia%type, nr_seq_analise_p pls_analise_conta.nr_sequencia%type, cd_acao_analise_p pls_acao_analise.cd_acao%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE


valor_bind_w		sql_pck.t_dado_bind;
cursor_w		sql_pck.t_cursor;
ds_select_w		varchar(32000);
ds_restricao_w		varchar(20000);
ds_campo_regra_w 	varchar(500);

tb_nr_seq_conta_proc_w	pls_util_cta_pck.t_number_table;
tb_cd_procedimento_w	pls_util_cta_pck.t_number_table;
tb_ie_origem_proc_w	pls_util_cta_pck.t_number_table;
tb_dt_proced_refer_w	pls_util_cta_pck.t_date_table;
tb_nr_seq_filtro_w	pls_util_cta_pck.t_number_table;


BEGIN
-- limpa a tabela temporária
EXECUTE 'truncate table pls_cp_cta_proc_tmp';

valor_bind_w := pls_entao_regra_preco_cta_pck.obter_restricao_padrao(	nr_seq_lote_conta_p, nr_seq_protocolo_p, nr_seq_lote_processo_p, nr_seq_conta_p, nr_seq_conta_proc_p, nr_seq_conta_mat_p, nr_seq_analise_p, cd_acao_analise_p, cd_estabelecimento_p, valor_bind_w);
						
-- coparticipação tem campo diferente
if (ie_destino_regra_p = 'C') then
	ds_campo_regra_w := ',' || pls_util_pck.enter_w ||
			    '	' || pls_entao_regra_preco_cta_pck.obter_alias_tabela('e_proc') || '.nr_seq_cp_comb_filtro_cop nr_seq_regra_filtro';
else
	ds_campo_regra_w := ',' || pls_util_pck.enter_w ||
			    '	' || pls_entao_regra_preco_cta_pck.obter_alias_tabela('e_proc') || '.nr_seq_cp_comb_filtro nr_seq_regra_filtro';
end if;

begin
	-- feito join com a pls_cp_cta_eproc para evitar de fazer uma consulta campo_regra is not null e degradar a performance
	ds_select_w := 'select	' || pls_entao_regra_preco_cta_pck.obter_alias_tabela('procedimento') || '.nr_sequencia nr_seq_conta_proc, ' || pls_util_pck.enter_w ||
			'	' || pls_entao_regra_preco_cta_pck.obter_alias_tabela('procedimento') || '.cd_procedimento, ' || pls_util_pck.enter_w ||
			'	' || pls_entao_regra_preco_cta_pck.obter_alias_tabela('procedimento') || '.ie_origem_proced, ' || pls_util_pck.enter_w ||
			'	' || pls_entao_regra_preco_cta_pck.obter_alias_tabela('procedimento') || '.dt_procedimento_referencia ' || pls_util_pck.enter_w ||
			ds_campo_regra_w || pls_util_pck.enter_w ||
			'from	pls_protocolo_conta ' || pls_entao_regra_preco_cta_pck.obter_alias_tabela('protocolo') || ',' || pls_util_pck.enter_w ||
			'	pls_conta ' || pls_entao_regra_preco_cta_pck.obter_alias_tabela('conta') || ',' || pls_util_pck.enter_w ||
			'	pls_conta_proc ' || pls_entao_regra_preco_cta_pck.obter_alias_tabela('procedimento') || ',' || pls_util_pck.enter_w ||
			'	pls_conta_proc_regra ' || pls_entao_regra_preco_cta_pck.obter_alias_tabela('e_proc') || pls_util_pck.enter_w ||
			'where	' || pls_entao_regra_preco_cta_pck.obter_alias_tabela('conta') || '.nr_seq_protocolo = ' || pls_entao_regra_preco_cta_pck.obter_alias_tabela('protocolo') || '.nr_sequencia ' || pls_util_pck.enter_w ||
			'and	' || pls_entao_regra_preco_cta_pck.obter_alias_tabela('procedimento') || '.nr_seq_conta = ' || pls_entao_regra_preco_cta_pck.obter_alias_tabela('conta') || '.nr_sequencia ' || pls_util_pck.enter_w ||
			'and	' || pls_entao_regra_preco_cta_pck.obter_alias_tabela('e_proc') || '.nr_sequencia = ' || pls_entao_regra_preco_cta_pck.obter_alias_tabela('procedimento') || '.nr_sequencia ' || pls_util_pck.enter_w ||
			ds_restricao_w;
			
	-- executa o comando sql com os respectivos binds
	valor_bind_w := sql_pck.executa_sql_cursor(	ds_select_w, valor_bind_w);
	
	loop
		-- alimentao a tabela temporária com os dados que serão utilizados para calcular o valor do material
		fetch cursor_w bulk collect into	tb_nr_seq_conta_proc_w, tb_cd_procedimento_w, tb_ie_origem_proc_w,
							tb_dt_proced_refer_w, tb_nr_seq_filtro_w
		limit pls_util_pck.qt_registro_transacao_w;
		exit when tb_nr_seq_conta_proc_w.count = 0;
		
		forall i in tb_nr_seq_conta_proc_w.first..tb_nr_seq_conta_proc_w.last
			insert into pls_cp_cta_proc_tmp(
				nr_seq_conta_proc, cd_procedimento, ie_origem_proced,
				dt_procedimento_referencia, nr_seq_cp_comb_filtro
			) values (
				tb_nr_seq_conta_proc_w(i), tb_cd_procedimento_w(i), tb_ie_origem_proc_w(i),
				tb_dt_proced_refer_w(i), tb_nr_seq_filtro_w(i)
			);
		commit;
	end loop;

	close cursor_w;
exception
when others then
	-- se deu algo e o cursor está aberto fecha ele
	if (cursor_w%isopen) then
		close cursor_w;
	end if;
	-- Tratar erro gerado no sql dinâmico, será inserido registro no log e abortado 
	-- o processo exibindo mensagem de erro.
	CALL pls_filtro_regra_preco_cta_pck.trata_erro_sql_dinamico( null, ds_select_w, null,
								nm_usuario_p, 'S');
end;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_entao_regra_preco_cta_pck.alimenta_tab_temp_serv ( ie_destino_regra_p text, nr_seq_lote_conta_p pls_protocolo_conta.nr_seq_lote%type, nr_seq_protocolo_p pls_protocolo_conta.nr_sequencia%type, nr_seq_lote_processo_p pls_cta_lote_processo.nr_sequencia%type, nr_seq_conta_p pls_conta.nr_sequencia%type, nr_seq_conta_proc_p pls_conta_proc.nr_sequencia%type, nr_seq_conta_mat_p pls_conta_mat.nr_sequencia%type, nr_seq_analise_p pls_analise_conta.nr_sequencia%type, cd_acao_analise_p pls_acao_analise.cd_acao%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;
