-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pls_entao_regra_preco_cta_pck.obter_medico ( cd_medico_p pls_conta.cd_medico_executor%type, ie_tipo_guia_p pls_conta.ie_tipo_guia%type, nr_seq_conta_proc_p pls_conta_proc.nr_sequencia%type) RETURNS bigint AS $body$
DECLARE


cd_medico_w	pls_conta.cd_medico_executor%type;


BEGIN
-- se existe médico informado na conta e não é guia de internação, então o médico da conta é o correto
if (cd_medico_p IS NOT NULL AND cd_medico_p::text <> '') and (ie_tipo_guia_p != '5') then
	
	cd_medico_w := cd_medico_p;
-- se for guia de internação ou não tiver o médico informado na conta, busca dos participantes
else
	
	-- Esse campo é utilizado para restringir as regras de preço elegíveis para o procedimento, apesar de poderem 
	-- existir mais de um participante, ficou definido que para aplicação das regras de preço será buscado o max.
	select	max(cd_medico)
	into STRICT	cd_medico_w
	from	pls_proc_participante
	where	nr_seq_conta_proc = nr_seq_conta_proc_p;
end if;

return cd_medico_w;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pls_entao_regra_preco_cta_pck.obter_medico ( cd_medico_p pls_conta.cd_medico_executor%type, ie_tipo_guia_p pls_conta.ie_tipo_guia%type, nr_seq_conta_proc_p pls_conta_proc.nr_sequencia%type) FROM PUBLIC;
