-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_entao_regra_preco_cta_pck.alimenta_tab_temp_material ( ie_destino_regra_p text, nr_seq_lote_conta_p pls_protocolo_conta.nr_seq_lote%type, nr_seq_protocolo_p pls_protocolo_conta.nr_sequencia%type, nr_seq_lote_processo_p pls_cta_lote_processo.nr_sequencia%type, nr_seq_conta_p pls_conta.nr_sequencia%type, nr_seq_conta_proc_p pls_conta_proc.nr_sequencia%type, nr_seq_conta_mat_p pls_conta_mat.nr_sequencia%type, nr_seq_analise_p pls_analise_conta.nr_sequencia%type, cd_acao_analise_p pls_acao_analise.cd_acao%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE


valor_bind_w		sql_pck.t_dado_bind;
cursor_w		sql_pck.t_cursor;
ds_select_w		varchar(32000);
ds_restricao_w		varchar(20000);
ds_campo_regra_w 	varchar(500);
					
tb_nr_seq_material_w		pls_util_cta_pck.t_number_table;
tb_nr_seq_conta_mat_w		pls_util_cta_pck.t_number_table;
tb_dt_atend_mat_w		pls_util_cta_pck.t_date_table;
tb_nr_seq_prest_fornec_w	pls_util_cta_pck.t_number_table;
tb_vl_material_imp_w		pls_util_cta_pck.t_number_table;
tb_qt_material_imp_w		pls_util_cta_pck.t_number_table;
tb_ie_status_mat_w		pls_util_cta_pck.t_varchar2_table_10;
tb_ie_cobranca_prevista_w	pls_util_cta_pck.t_varchar2_table_10;
tb_ie_cobr_prev_inf_w		pls_util_cta_pck.t_varchar2_table_255;
tb_nr_seq_conta_w		pls_util_cta_pck.t_number_table;
tb_nr_seq_guia_w		pls_util_cta_pck.t_number_table;
tb_nr_seq_prest_exec_w		pls_util_cta_pck.t_number_table;
tb_ie_status_conta_w		pls_util_cta_pck.t_varchar2_table_10;
tb_cd_versao_tiss_w		pls_util_cta_pck.t_varchar2_table_20;
tb_nr_seq_regra_filtro_w	pls_util_cta_pck.t_number_table;
tb_nr_seq_segurado_w		pls_util_cta_pck.t_number_table;


BEGIN
-- limpa a tabela temporária
EXECUTE 'truncate table pls_cp_cta_mat_tmp';

valor_bind_w := pls_entao_regra_preco_cta_pck.obter_restricao_padrao(	nr_seq_lote_conta_p, nr_seq_protocolo_p, nr_seq_lote_processo_p, nr_seq_conta_p, nr_seq_conta_proc_p, nr_seq_conta_mat_p, nr_seq_analise_p, cd_acao_analise_p, cd_estabelecimento_p, valor_bind_w);
						
-- coparticipação tem campo diferente
if (ie_destino_regra_p = 'C') then
	ds_campo_regra_w := ',' || pls_util_pck.enter_w ||
			    '	' || pls_entao_regra_preco_cta_pck.obter_alias_tabela('e_mat') || '.nr_seq_cp_comb_filtro_cop nr_seq_regra_filtro';
else
	ds_campo_regra_w := ',' || pls_util_pck.enter_w ||
			    '	' || pls_entao_regra_preco_cta_pck.obter_alias_tabela('e_mat') || '.nr_seq_cp_comb_filtro nr_seq_regra_filtro';
end if;

begin
	-- feito join com a pls_cp_cta_emat para evitar de fazer uma consulta campo_regra is not null e degradar a performance
	ds_select_w := 'select	' || pls_entao_regra_preco_cta_pck.obter_alias_tabela('material') || '.nr_sequencia nr_seq_conta_mat,' || pls_util_pck.enter_w ||
			'	' || pls_entao_regra_preco_cta_pck.obter_alias_tabela('material') || '.nr_seq_material,' || pls_util_pck.enter_w ||
			'	' || pls_entao_regra_preco_cta_pck.obter_alias_tabela('material') || '.dt_atendimento_referencia,' || pls_util_pck.enter_w ||
			'	' || pls_entao_regra_preco_cta_pck.obter_alias_tabela('material') || '.nr_seq_prest_fornec,' || pls_util_pck.enter_w ||
			'	' || pls_entao_regra_preco_cta_pck.obter_alias_tabela('material') || '.vl_material_imp,' || pls_util_pck.enter_w ||
			'	' || pls_entao_regra_preco_cta_pck.obter_alias_tabela('material') || '.qt_material_imp,' || pls_util_pck.enter_w ||
			'	' || pls_entao_regra_preco_cta_pck.obter_alias_tabela('material') || '.ie_status ie_status_mat,' || pls_util_pck.enter_w ||
			'	' || pls_entao_regra_preco_cta_pck.obter_alias_tabela('material') || '.ie_cobranca_prevista,' || pls_util_pck.enter_w ||
			'	' || pls_entao_regra_preco_cta_pck.obter_alias_tabela('material') || '.ie_cobranca_prevista_inf,' || pls_util_pck.enter_w ||
			'	' || pls_entao_regra_preco_cta_pck.obter_alias_tabela('conta') || '.nr_seq_prestador_exec,' || pls_util_pck.enter_w ||
			'	' || pls_entao_regra_preco_cta_pck.obter_alias_tabela('conta') || '.nr_sequencia nr_seq_conta,' || pls_util_pck.enter_w ||
			'	' || pls_entao_regra_preco_cta_pck.obter_alias_tabela('conta') || '.nr_seq_guia,' || pls_util_pck.enter_w ||
			'	' || pls_entao_regra_preco_cta_pck.obter_alias_tabela('conta') || '.ie_status ie_status_conta,' || pls_util_pck.enter_w ||
			'	' || pls_entao_regra_preco_cta_pck.obter_alias_tabela('conta') || '.nr_seq_segurado,' || pls_util_pck.enter_w ||
			'	' || pls_entao_regra_preco_cta_pck.obter_alias_tabela('protocolo') || '.cd_versao_tiss' || pls_util_pck.enter_w ||
			ds_campo_regra_w || pls_util_pck.enter_w ||
			'from	pls_protocolo_conta ' || pls_entao_regra_preco_cta_pck.obter_alias_tabela('protocolo') || ',' || pls_util_pck.enter_w ||
			'	pls_conta ' || pls_entao_regra_preco_cta_pck.obter_alias_tabela('conta') || ',' || pls_util_pck.enter_w ||
			'	pls_conta_mat ' || pls_entao_regra_preco_cta_pck.obter_alias_tabela('material') || ',' || pls_util_pck.enter_w ||
			'	pls_conta_mat_regra ' || pls_entao_regra_preco_cta_pck.obter_alias_tabela('e_mat') || pls_util_pck.enter_w ||
			'where	' || pls_entao_regra_preco_cta_pck.obter_alias_tabela('conta') || '.nr_seq_protocolo = ' || pls_entao_regra_preco_cta_pck.obter_alias_tabela('protocolo') || '.nr_sequencia' || pls_util_pck.enter_w ||
			'and	' || pls_entao_regra_preco_cta_pck.obter_alias_tabela('material') || '.nr_seq_conta = ' || pls_entao_regra_preco_cta_pck.obter_alias_tabela('conta') || '.nr_sequencia' || pls_util_pck.enter_w ||
			'and	' || pls_entao_regra_preco_cta_pck.obter_alias_tabela('e_mat') || '.nr_sequencia = ' || pls_entao_regra_preco_cta_pck.obter_alias_tabela('material') || '.nr_sequencia' || pls_util_pck.enter_w ||
			ds_restricao_w;
			
	-- executa o comando sql com os respectivos binds
	valor_bind_w := sql_pck.executa_sql_cursor(	ds_select_w, valor_bind_w);

	loop
		-- alimentao a tabela temporária com os dados que serão utilizados para calcular o valor do material
		fetch cursor_w bulk collect into	tb_nr_seq_conta_mat_w, tb_nr_seq_material_w, tb_dt_atend_mat_w,
							tb_nr_seq_prest_fornec_w, tb_vl_material_imp_w, tb_qt_material_imp_w,
							tb_ie_status_mat_w, tb_ie_cobranca_prevista_w, tb_ie_cobr_prev_inf_w,
							tb_nr_seq_prest_exec_w, tb_nr_seq_conta_w, tb_nr_seq_guia_w,
							tb_ie_status_conta_w, tb_nr_seq_segurado_w, tb_cd_versao_tiss_w,
							tb_nr_seq_regra_filtro_w
		limit pls_util_pck.qt_registro_transacao_w;
		exit when tb_nr_seq_conta_mat_w.count = 0;

		forall i in tb_nr_seq_conta_mat_w.first..tb_nr_seq_conta_mat_w.last
			insert into pls_cp_cta_mat_tmp(
				nr_seq_conta_mat, nr_seq_material, dt_atendimento,
				nr_seq_prest_fornec, vl_material_imp, qt_material_imp,
				ie_status_mat, ie_cobranca_prevista, ie_cobranca_prevista_inf,
				nr_seq_prestador_exec, nr_seq_conta, nr_seq_guia,
				ie_status_conta, nr_seq_segurado, cd_versao_tiss,
				nr_seq_regra_filtro
			) values (
				tb_nr_seq_conta_mat_w(i), tb_nr_seq_material_w(i), tb_dt_atend_mat_w(i),
				tb_nr_seq_prest_fornec_w(i), tb_vl_material_imp_w(i), tb_qt_material_imp_w(i),
				tb_ie_status_mat_w(i), tb_ie_cobranca_prevista_w(i), tb_ie_cobr_prev_inf_w(i),
				tb_nr_seq_prest_exec_w(i), tb_nr_seq_conta_w(i), tb_nr_seq_guia_w(i),
				tb_ie_status_conta_w(i), tb_nr_seq_segurado_w(i), tb_cd_versao_tiss_w(i), 
				tb_nr_seq_regra_filtro_w(i)
			);
		commit;
	end loop;

	close cursor_w;
exception
when others then
	-- se deu algo e o cursor está aberto fecha ele
	if (cursor_w%isopen) then
		close cursor_w;
	end if;
	-- Tratar erro gerado no sql dinâmico, será inserido registro no log e abortado 
	-- o processo exibindo mensagem de erro.
	CALL pls_filtro_regra_preco_cta_pck.trata_erro_sql_dinamico( null, ds_select_w, null,
								nm_usuario_p, 'S');
end;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_entao_regra_preco_cta_pck.alimenta_tab_temp_material ( ie_destino_regra_p text, nr_seq_lote_conta_p pls_protocolo_conta.nr_seq_lote%type, nr_seq_protocolo_p pls_protocolo_conta.nr_sequencia%type, nr_seq_lote_processo_p pls_cta_lote_processo.nr_sequencia%type, nr_seq_conta_p pls_conta.nr_sequencia%type, nr_seq_conta_proc_p pls_conta_proc.nr_sequencia%type, nr_seq_conta_mat_p pls_conta_mat.nr_sequencia%type, nr_seq_analise_p pls_analise_conta.nr_sequencia%type, cd_acao_analise_p pls_acao_analise.cd_acao%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;
