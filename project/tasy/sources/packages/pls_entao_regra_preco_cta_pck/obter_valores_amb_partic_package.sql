-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_entao_regra_preco_cta_pck.obter_valores_amb_partic ( ie_destino_regra_p text, cd_edicao_amb_p pls_cp_cta_epartic.cd_edicao_amb%type, vl_tx_honorarios_p pls_cp_cta_epartic.vl_ch_honorarios%type, tx_ajuste_ch_honor_p pls_cp_cta_epartic.tx_ajuste_ch_honor%type, dt_proced_referencia_p pls_conta_proc.dt_procedimento_referencia%type, cd_procedimento_p pls_conta_proc.cd_procedimento%type, ie_ch_padrao_anest_p pls_cp_cta_epartic.ie_ch_padrao_anestesista%type, vl_moeda_anestesista_p pls_cp_cta_epartic.cd_moeda_anestesista%type, tx_ajuste_partic_p pls_cp_cta_epartic.tx_ajuste_partic%type, nr_seq_proc_partic_p pls_proc_participante.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, vl_negociado_p INOUT pls_proc_participante.vl_negociado%type, vl_medico_out_p INOUT pls_proc_participante.vl_medico%type, vl_anestesista_out_p INOUT pls_proc_participante.vl_anestesista%type, vl_auxiliares_out_p INOUT pls_proc_participante.vl_auxiliares%type) AS $body$
DECLARE


val_tab_amb_w	tipo_val_tab_amb := tipo_val_tab_amb(null, null, null, null, null, null, null, null, null);


BEGIN

-- obtem os valores AMB
val_tab_amb_w := pls_obter_val_tab_amb(	cd_edicao_amb_p, dt_proced_referencia_p, cd_procedimento_p,
					null);

CALL pls_entao_regra_preco_cta_pck.gerencia_log_partic(	'Valores obtidos na tabela de preços AMB.',
			nr_seq_proc_partic_p,
			val_tab_amb_w.vl_anestesista,
			val_tab_amb_w.vl_auxiliares_amb,
			val_tab_amb_w.vl_medico,
			val_tab_amb_w.vl_procedimento,
			ie_destino_regra_p,
			nm_usuario_p);

-- aplica as taxas/moedas pertinentes ao calculo AMB
val_tab_amb_w.vl_medico := pls_entao_regra_preco_cta_pck.aplica_taxas_amb_partic(	vl_tx_honorarios_p, tx_ajuste_ch_honor_p, val_tab_amb_w.vl_medico);

CALL pls_entao_regra_preco_cta_pck.gerencia_log_partic(	'Valores após aplicar cotação de moeda e/ou taxas.',
			nr_seq_proc_partic_p,
			val_tab_amb_w.vl_anestesista,
			val_tab_amb_w.vl_auxiliares_amb,
			val_tab_amb_w.vl_medico,
			val_tab_amb_w.vl_procedimento,
			ie_destino_regra_p,
			nm_usuario_p);

-- obtém o valor correto do anestesista quando AMB
val_tab_amb_w.vl_anestesista := pls_entao_regra_preco_cta_pck.obter_valor_anest_amb(	cd_edicao_amb_p, val_tab_amb_w.nr_porte_anestesico,
							dt_proced_referencia_p, val_tab_amb_w.vl_anestesista,
							ie_ch_padrao_anest_p, vl_moeda_anestesista_p,
							tx_ajuste_partic_p, vl_tx_honorarios_p);

CALL pls_entao_regra_preco_cta_pck.gerencia_log_partic(	'Obtido valor do anestesista de acordo com o porte anestésico e aplicado as taxas pertinentes.',
			nr_seq_proc_partic_p,
			val_tab_amb_w.vl_anestesista,
			val_tab_amb_w.vl_auxiliares_amb,
			val_tab_amb_w.vl_medico,
			val_tab_amb_w.vl_procedimento,
			ie_destino_regra_p,
			nm_usuario_p);

-- faz o calculo do valor do procedimento, basicamente é somado todos os valores que compoem o mesmo
-- colocado em uma function própria para facilitar a manutenção da package
val_tab_amb_w.vl_procedimento := pls_entao_regra_preco_cta_pck.obter_valor_proced(	null, val_tab_amb_w.vl_anestesista,
							val_tab_amb_w.vl_medico, null,
							val_tab_amb_w.vl_auxiliares_amb);

CALL pls_entao_regra_preco_cta_pck.gerencia_log_partic(	'Realizado o cálculo do valor do procedimento.',
			nr_seq_proc_partic_p,
			val_tab_amb_w.vl_anestesista,
			val_tab_amb_w.vl_auxiliares_amb,
			val_tab_amb_w.vl_medico,
			val_tab_amb_w.vl_procedimento,
			ie_destino_regra_p,
			nm_usuario_p);

-- alimenta os parametros out, feito desta maneira para facilitar a manutenção da rotina
vl_negociado_p := val_tab_amb_w.vl_procedimento;
vl_medico_out_p := val_tab_amb_w.vl_medico;
vl_anestesista_out_p := val_tab_amb_w.vl_anestesista;
vl_auxiliares_out_p := val_tab_amb_w.vl_auxiliares_amb;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_entao_regra_preco_cta_pck.obter_valores_amb_partic ( ie_destino_regra_p text, cd_edicao_amb_p pls_cp_cta_epartic.cd_edicao_amb%type, vl_tx_honorarios_p pls_cp_cta_epartic.vl_ch_honorarios%type, tx_ajuste_ch_honor_p pls_cp_cta_epartic.tx_ajuste_ch_honor%type, dt_proced_referencia_p pls_conta_proc.dt_procedimento_referencia%type, cd_procedimento_p pls_conta_proc.cd_procedimento%type, ie_ch_padrao_anest_p pls_cp_cta_epartic.ie_ch_padrao_anestesista%type, vl_moeda_anestesista_p pls_cp_cta_epartic.cd_moeda_anestesista%type, tx_ajuste_partic_p pls_cp_cta_epartic.tx_ajuste_partic%type, nr_seq_proc_partic_p pls_proc_participante.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, vl_negociado_p INOUT pls_proc_participante.vl_negociado%type, vl_medico_out_p INOUT pls_proc_participante.vl_medico%type, vl_anestesista_out_p INOUT pls_proc_participante.vl_anestesista%type, vl_auxiliares_out_p INOUT pls_proc_participante.vl_auxiliares%type) FROM PUBLIC;
