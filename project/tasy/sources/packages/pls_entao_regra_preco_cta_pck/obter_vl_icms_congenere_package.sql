-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pls_entao_regra_preco_cta_pck.obter_vl_icms_congenere ( nr_seq_congenere_p pls_segurado.nr_seq_congenere%type, dt_atend_material_p pls_conta_mat.dt_atendimento%type) RETURNS bigint AS $body$
DECLARE


vl_perc_icms_w		pls_regra_icms.vl_perc_icms%type;
uf_operadora_w		pessoa_juridica.sg_estado%type;


BEGIN

vl_perc_icms_w := null;

-- busca o estado da operadora
if (nr_seq_congenere_p IS NOT NULL AND nr_seq_congenere_p::text <> '') then

	select	max(b.sg_estado)
	into STRICT	uf_operadora_w
	from	pls_congenere a,
		pessoa_juridica b
	where	a.nr_sequencia = nr_seq_congenere_p
	and	a.cd_cgc = b.cd_cgc;

	-- se encontrou o estado ent√£o busca o percentual
	if (uf_operadora_w IS NOT NULL AND uf_operadora_w::text <> '') then

		select	max(a.vl_perc_icms)
		into STRICT	vl_perc_icms_w
		from 	pls_regra_icms a
		where	dt_atend_material_p between a.dt_inicio_vigencia and a.dt_fim_vigencia_ref
		and exists (	SELECT 	1
				from	pls_regra_icms_uf b
				where	b.nr_seq_regra_icms = a.nr_sequencia
				and	b.sg_estado = uf_operadora_w);
	end if;
end if;

return vl_perc_icms_w;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pls_entao_regra_preco_cta_pck.obter_vl_icms_congenere ( nr_seq_congenere_p pls_segurado.nr_seq_congenere%type, dt_atend_material_p pls_conta_mat.dt_atendimento%type) FROM PUBLIC;
