-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_entao_regra_preco_cta_pck.obter_valores_tuss ( ie_destino_regra_p text, ie_calculo_tuss_p edicao_amb.ie_calculo_tuss%type, dt_proced_referencia_p pls_conta_proc.dt_procedimento_referencia%type, cd_procedimento_p pls_conta_proc.cd_procedimento%type, nr_seq_edicao_tuss_p pls_cp_cta_eproc.nr_seq_edicao_tuss%type, cd_edicao_amb_p pls_cp_cta_eproc.cd_edicao_amb%type, vl_filme_p pls_cp_cta_eproc.vl_filme%type, vl_tx_custo_oper_p pls_cp_cta_eproc.vl_ch_custo_oper%type, vl_tx_honorarios_p pls_cp_cta_eproc.vl_ch_honorarios%type, vl_moeda_filme_p cotacao_moeda.vl_cotacao%type, tx_ajuste_custo_oper_p pls_cp_cta_eproc.tx_ajuste_custo_oper%type, tx_ajuste_ch_honor_p pls_cp_cta_eproc.tx_ajuste_ch_honor%type, tx_ajuste_filme_p pls_cp_cta_eproc.tx_ajuste_filme%type, ie_ch_padrao_anest_p pls_cp_cta_eproc.ie_ch_padrao_anestesista%type, vl_moeda_anest_p cotacao_moeda.vl_cotacao%type, tx_ajuste_partic_p pls_cp_cta_eproc.tx_ajuste_partic%type, nr_seq_conta_proc_p pls_conta_proc.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, vl_procedimento_p INOUT bigint, vl_custo_operacional_p INOUT bigint, vl_medico_p INOUT bigint, vl_filme_out_p INOUT bigint, nr_auxiliar_p INOUT preco_tuss.nr_auxiliares_cbhpm%type, vl_auxiliares_p INOUT bigint, cd_porte_anestesico_p INOUT preco_tuss.nr_porte_anest_amb%type, vl_anestesista_p INOUT bigint) AS $body$
DECLARE


vl_medico_w		pls_conta_proc.vl_medico%type;
qt_uco_w		preco_tuss.qt_uco%type;
nr_porte_anest_w	preco_tuss.nr_porte_anest_cbhpm%type;
nr_auxiliar_w		preco_tuss.nr_auxiliares_cbhpm%type;
qt_filme_w		preco_tuss.qt_filme_cbhpm%type;
qt_incidencia_w		preco_tuss.qt_incidencia_cbhpm%type;
vl_porte_anestesista_w	pls_conta_proc.vl_anestesista%type;
vl_custo_operacional_w	pls_conta_proc.vl_custo_operacional%type;
vl_anestesista_w	pls_conta_proc.vl_anestesista%type;
vl_filme_w		preco_tuss.vl_filme%type;
vl_auxiliares_w		pls_conta_proc.vl_auxiliares%type;
vl_procedimento_w	pls_conta_proc.vl_procedimento%type;


BEGIN

-- se for cálculo CBHPM
if (ie_calculo_tuss_p = 'C') then
	
	SELECT * FROM pls_entao_regra_preco_cta_pck.obter_preco_tuss_cbhpm(	dt_proced_referencia_p, cd_procedimento_p, nr_seq_edicao_tuss_p, cd_edicao_amb_p, vl_medico_w, qt_uco_w, nr_porte_anest_w, nr_auxiliar_w, qt_filme_w, qt_incidencia_w, vl_porte_anestesista_w) INTO STRICT vl_medico_w, qt_uco_w, nr_porte_anest_w, nr_auxiliar_w, qt_filme_w, qt_incidencia_w, vl_porte_anestesista_w;

	CALL pls_entao_regra_preco_cta_pck.gerencia_log_proc(	'Valores obtidos na tabela de preços TUSS com cálculo CBHPM.',
				nr_seq_conta_proc_p,
				null,
				null,
				null,
				null,
				vl_medico_w,
				null,
				ie_destino_regra_p,
				nm_usuario_p);

	-- aplica as taxas pertinentes a CBHPM
	SELECT * FROM pls_entao_regra_preco_cta_pck.aplica_taxas_cbhpm(	qt_uco_w, vl_tx_custo_oper_p, vl_medico_w, vl_tx_honorarios_p, qt_filme_w, vl_filme_p, vl_moeda_filme_p, tx_ajuste_filme_p, tx_ajuste_custo_oper_p, tx_ajuste_ch_honor_p, vl_custo_operacional_w, vl_medico_w, vl_filme_w, nr_porte_anest_w, nr_auxiliar_w) INTO STRICT vl_custo_operacional_w, vl_medico_w, vl_filme_w, nr_porte_anest_w, nr_auxiliar_w;

	CALL pls_entao_regra_preco_cta_pck.gerencia_log_proc(	'Realizado cálculo de CO e Filme, aplicado taxas e cotação de moedas.',
				nr_seq_conta_proc_p,
				null,
				null,
				vl_custo_operacional_w,
				vl_filme_w,
				vl_medico_w,
				null,
				ie_destino_regra_p,
				nm_usuario_p);

	-- obtém o valor dos auxiliares
	vl_auxiliares_w := pls_entao_regra_preco_cta_pck.obter_valor_aux_cbhpm( 	vl_medico_w, nr_auxiliar_w);

	-- obtém o valor do anestesista
	vl_anestesista_w := pls_entao_regra_preco_cta_pck.obter_valor_anest_cbhpm(	ie_ch_padrao_anest_p, vl_moeda_anest_p, vl_porte_anestesista_w,
							tx_ajuste_partic_p, vl_tx_honorarios_p);

	-- calcula o valor do procedimento
	vl_procedimento_w := pls_entao_regra_preco_cta_pck.obter_valor_proced( 	vl_custo_operacional_w, vl_anestesista_w, vl_medico_w,
							vl_filme_w, vl_auxiliares_w);

	CALL pls_entao_regra_preco_cta_pck.gerencia_log_proc(	'Obtidos valores dos auxiliares e anestesista. Realizado cálculo do valor do procedimento.',
				nr_seq_conta_proc_p,
				vl_anestesista_w,
				vl_auxiliares_w,
				vl_custo_operacional_w,
				vl_filme_w,
				vl_medico_w,
				vl_procedimento_w,
				ie_destino_regra_p,
				nm_usuario_p);

-- se for cálculo AMB
elsif (ie_calculo_tuss_p = 'A') then

	SELECT * FROM pls_entao_regra_preco_cta_pck.obter_preco_tuss_amb(	cd_edicao_amb_p, cd_procedimento_p, dt_proced_referencia_p, vl_procedimento_w, vl_medico_w, vl_anestesista_w, vl_auxiliares_w, vl_custo_operacional_w, qt_filme_w, nr_auxiliar_w, nr_porte_anest_w) INTO STRICT vl_procedimento_w, vl_medico_w, vl_anestesista_w, vl_auxiliares_w, vl_custo_operacional_w, qt_filme_w, nr_auxiliar_w, nr_porte_anest_w;
				
	-- o valor do filme é obtido multiplicando a qt com  a taxa da regra
	vl_filme_w := vl_filme_p * qt_filme_w;
	
	CALL pls_entao_regra_preco_cta_pck.gerencia_log_proc(	'Valores obtidos na tabela de preços TUSS com cálculo AMB.',
				nr_seq_conta_proc_p,
				vl_anestesista_w,
				vl_auxiliares_w,
				vl_custo_operacional_w,
				vl_filme_w,
				vl_medico_w,
				vl_procedimento_w,
				ie_destino_regra_p,
				nm_usuario_p);
	
	-- aplica as taxas/moedas pertinentes ao calculo AMB
	SELECT * FROM pls_entao_regra_preco_cta_pck.aplica_taxas_amb(	vl_tx_custo_oper_p, vl_tx_honorarios_p, vl_moeda_filme_p, tx_ajuste_custo_oper_p, tx_ajuste_ch_honor_p, tx_ajuste_filme_p, vl_custo_operacional_w, vl_medico_w, vl_filme_w) INTO STRICT vl_custo_operacional_w, vl_medico_w, vl_filme_w;

	CALL pls_entao_regra_preco_cta_pck.gerencia_log_proc(	'Valores após aplicar cotação de moeda e/ou taxas.',
				nr_seq_conta_proc_p,
				vl_anestesista_w,
				vl_auxiliares_w,
				vl_custo_operacional_w,
				vl_filme_w,
				vl_medico_w,
				vl_procedimento_w,
				ie_destino_regra_p,
				nm_usuario_p);

	-- obtém o valor correto do anestesista quando AMB
	vl_anestesista_w := pls_entao_regra_preco_cta_pck.obter_valor_anest_amb(	cd_edicao_amb_p, nr_porte_anest_w,
							dt_proced_referencia_p, vl_anestesista_w,
							ie_ch_padrao_anest_p, vl_moeda_anest_p,
							tx_ajuste_partic_p, vl_tx_honorarios_p);

	CALL pls_entao_regra_preco_cta_pck.gerencia_log_proc(	'Obtido valor do anestesista de acordo com o porte anestésico e aplicado as taxas pertinentes.',
				nr_seq_conta_proc_p,
				vl_anestesista_w,
				vl_auxiliares_w,
				vl_custo_operacional_w,
				vl_filme_w,
				vl_medico_w,
				vl_procedimento_w,
				ie_destino_regra_p,
				nm_usuario_p);

	-- faz o calculo do valor do procedimento, basicamente é somado todos os valores que compoem o mesmo
	-- colocado em uma function própria para facilitar a manutenção da package
	vl_procedimento_w := pls_entao_regra_preco_cta_pck.obter_valor_proced(	vl_custo_operacional_w, vl_anestesista_w,
							vl_medico_w, vl_filme_w,
							vl_auxiliares_w);

	CALL pls_entao_regra_preco_cta_pck.gerencia_log_proc(	'Realizado o cálculo do valor do procedimento.',
				nr_seq_conta_proc_p,
				vl_anestesista_w,
				vl_auxiliares_w,
				vl_custo_operacional_w,
				vl_filme_w,
				vl_medico_w,
				vl_procedimento_w,
				ie_destino_regra_p,
				nm_usuario_p);
end if;

-- alimenta os parametros out
vl_procedimento_p := vl_procedimento_w;
vl_custo_operacional_p := vl_custo_operacional_w;
vl_medico_p := vl_medico_w;
vl_filme_out_p := vl_filme_w;
nr_auxiliar_p := nr_auxiliar_w;
vl_auxiliares_p := vl_auxiliares_w;
cd_porte_anestesico_p := nr_porte_anest_w;
vl_anestesista_p := vl_anestesista_w;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_entao_regra_preco_cta_pck.obter_valores_tuss ( ie_destino_regra_p text, ie_calculo_tuss_p edicao_amb.ie_calculo_tuss%type, dt_proced_referencia_p pls_conta_proc.dt_procedimento_referencia%type, cd_procedimento_p pls_conta_proc.cd_procedimento%type, nr_seq_edicao_tuss_p pls_cp_cta_eproc.nr_seq_edicao_tuss%type, cd_edicao_amb_p pls_cp_cta_eproc.cd_edicao_amb%type, vl_filme_p pls_cp_cta_eproc.vl_filme%type, vl_tx_custo_oper_p pls_cp_cta_eproc.vl_ch_custo_oper%type, vl_tx_honorarios_p pls_cp_cta_eproc.vl_ch_honorarios%type, vl_moeda_filme_p cotacao_moeda.vl_cotacao%type, tx_ajuste_custo_oper_p pls_cp_cta_eproc.tx_ajuste_custo_oper%type, tx_ajuste_ch_honor_p pls_cp_cta_eproc.tx_ajuste_ch_honor%type, tx_ajuste_filme_p pls_cp_cta_eproc.tx_ajuste_filme%type, ie_ch_padrao_anest_p pls_cp_cta_eproc.ie_ch_padrao_anestesista%type, vl_moeda_anest_p cotacao_moeda.vl_cotacao%type, tx_ajuste_partic_p pls_cp_cta_eproc.tx_ajuste_partic%type, nr_seq_conta_proc_p pls_conta_proc.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, vl_procedimento_p INOUT bigint, vl_custo_operacional_p INOUT bigint, vl_medico_p INOUT bigint, vl_filme_out_p INOUT bigint, nr_auxiliar_p INOUT preco_tuss.nr_auxiliares_cbhpm%type, vl_auxiliares_p INOUT bigint, cd_porte_anestesico_p INOUT preco_tuss.nr_porte_anest_amb%type, vl_anestesista_p INOUT bigint) FROM PUBLIC;
