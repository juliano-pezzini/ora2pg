-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pls_entao_regra_preco_cta_pck.obter_cotacao_moeda ( cd_moeda_p cotacao_moeda.cd_moeda%type, dt_vigencia_p cotacao_moeda.dt_cotacao%type) RETURNS bigint AS $body$
DECLARE

			
vl_cotacao_w	cotacao_moeda.vl_cotacao%type;

c01 CURSOR(	cd_moeda_pc	cotacao_moeda.cd_moeda%type,
		dt_vigencia_pc	cotacao_moeda.dt_cotacao%type) FOR
	SELECT	coalesce(vl_cotacao,1) vl_cotacao
	from	cotacao_moeda
	where	cd_moeda = cd_moeda_pc
	and 	dt_cotacao <= dt_vigencia_pc
	order by dt_cotacao desc;

BEGIN
vl_cotacao_w := 0;

-- pega a cotação com a maior data de vigência
for r_c01_w in C01(	cd_moeda_p, dt_vigencia_p) loop
	
	vl_cotacao_w := r_c01_w.vl_cotacao;
	-- o primeiro valor que encontrou é o válido, então sai do for e fecha o cursor automaticamente
	exit;
end loop;

return	vl_cotacao_w;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pls_entao_regra_preco_cta_pck.obter_cotacao_moeda ( cd_moeda_p cotacao_moeda.cd_moeda%type, dt_vigencia_p cotacao_moeda.dt_cotacao%type) FROM PUBLIC;
