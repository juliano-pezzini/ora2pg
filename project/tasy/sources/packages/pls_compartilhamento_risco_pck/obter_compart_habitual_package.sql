-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pls_compartilhamento_risco_pck.obter_compart_habitual ( nr_seq_segurado_p pls_segurado.nr_sequencia%type) RETURNS SETOF T_COMPART_HABITUAL AS $body$
DECLARE


linha_w			t_compart_habitual_row;
dt_ocorrencia_w		pls_segurado_historico.dt_ocorrencia_sib%type;

current_setting('pls_compartilhamento_risco_pck.c01')::CURSOR( CURSOR(nr_seq_segurado_pc	pls_segurado.nr_sequencia%type) FOR
	SELECT	a.dt_ocorrencia_sib dt_ocorrencia,
		pls_obter_nome_congenere(b.nr_seq_congenere) ds_operadora_origem,
		a.nr_sequencia nr_seq_historico,
		b.nr_sequencia nr_seq_segurado
	from	pls_segurado_historico a,
		pls_segurado b
	where	b.nr_sequencia = nr_seq_segurado_pc
	and	b.nr_sequencia = a.nr_seq_segurado
	and	a.ie_tipo_historico = '102'
	and	a.ie_tipo_segurado = 'H'
	and	coalesce(a.ie_situacao_compartilhamento, 'A') = 'A'
	order by
		a.nr_sequencia desc;

BEGIN

for r_c01_w in current_setting('pls_compartilhamento_risco_pck.c01')::CURSOR( (nr_seq_segurado_p) loop
	begin

	begin
	select	x.dt_ocorrencia_sib
	into STRICT	dt_ocorrencia_w
	from	pls_segurado_historico x
	where	x.nr_seq_segurado = r_c01_w.nr_seq_segurado
	and	x.ie_tipo_historico = '102'
	and	x.ie_tipo_segurado = 'I'
	and	x.nr_sequencia > r_c01_w.nr_seq_historico
	and	coalesce(x.ie_situacao_compartilhamento, 'A') = 'A'
	order by 
		1 asc LIMIT 1;
	exception
	when others then
		dt_ocorrencia_w	:= null;
	end;
	
	linha_w				:= null;
	linha_w.ds_operadora_origem	:= r_c01_w.ds_operadora_origem;
	linha_w.dt_inicial		:= r_c01_w.dt_ocorrencia;

	if (dt_ocorrencia_w IS NOT NULL AND dt_ocorrencia_w::text <> '') then
		linha_w.dt_final		:= dt_ocorrencia_w - 1;
	else
		linha_w.dt_final		:= null;
	end if;

	RETURN NEXT linha_w;
	end;
end loop;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pls_compartilhamento_risco_pck.obter_compart_habitual ( nr_seq_segurado_p pls_segurado.nr_sequencia%type) FROM PUBLIC;
