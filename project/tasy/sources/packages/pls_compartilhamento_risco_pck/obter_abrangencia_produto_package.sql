-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pls_compartilhamento_risco_pck.obter_abrangencia_produto ( ie_area_abrangencia_p pls_regra_interc_eleg_item.ie_area_abrangencia%type, nr_seq_cooperativa_p pls_segurado_repasse.nr_seq_congenere%type, nr_seq_plano_p pls_plano.nr_sequencia%type) RETURNS varchar AS $body$
DECLARE


ie_produto_w		varchar(1);
cd_municipio_ibge_w 	pessoa_juridica.cd_municipio_ibge%type;	
qt_municipio_w		bigint;
qt_area_atucao_w	bigint;


BEGIN

ie_produto_w	:= 'N';

select 	count(1)
into STRICT	qt_area_atucao_w
from 	pls_plano_area
where 	nr_seq_plano = nr_seq_plano_p;

if (ie_area_abrangencia_p in (1,2)) then
	if	(ie_area_abrangencia_p = 1 AND qt_area_atucao_w = 0) then
		ie_produto_w := 'S';
	elsif	((ie_area_abrangencia_p = 1) or
		(ie_area_abrangencia_p = 2 AND qt_area_atucao_w > 0)) then
		select 	max(b.cd_municipio_ibge)
		into STRICT 	cd_municipio_ibge_w
		from 	pls_congenere a,
			pessoa_juridica b
		where 	a.cd_cgc = b.cd_cgc
		and 	a.nr_sequencia = nr_seq_cooperativa_p;
		
		if (cd_municipio_ibge_w IS NOT NULL AND cd_municipio_ibge_w::text <> '') then
			select	count(1)
			into STRICT	qt_municipio_w
			from (SELECT cd_municipio_ibge
				from	pls_plano_area
				where 	cd_municipio_ibge = cd_municipio_ibge_w
				and 	nr_seq_plano = nr_seq_plano_p
				
union all

				SELECT	d.cd_municipio_ibge
				from	sus_municipio		d,
					pls_regiao_local	b,
					pls_regiao		a,
					pls_plano_area		c
				where	d.ds_unidade_federacao	= b.sg_uf_municipio
				and	b.nr_seq_regiao		= a.nr_sequencia
				and	coalesce(b.cd_municipio_ibge::text, '') = ''
				and	a.nr_sequencia		= c.nr_seq_regiao
				and     c.nr_seq_plano 		= nr_seq_plano_p
				and	d.cd_municipio_ibge	= cd_municipio_ibge_w
				
union all

				select	b.cd_municipio_ibge
				from	pls_regiao_local	b,
					pls_regiao		a,
					pls_plano_area		c
				where	b.nr_seq_regiao		= a.nr_sequencia
				and	a.nr_sequencia		= c.nr_seq_regiao
				and     c.nr_seq_plano 		= nr_seq_plano_p
				and	b.cd_municipio_ibge	= cd_municipio_ibge_w
				
union all

				select	b.cd_municipio_ibge
				from	sus_municipio		b,
					pls_plano_area		a
				where	b.ds_unidade_federacao	= a.sg_estado
				and 	b.cd_municipio_ibge	= cd_municipio_ibge_w
				and 	a.nr_seq_plano = nr_seq_plano_p) alias3;
				
				if     	((qt_municipio_w > 0 AND ie_area_abrangencia_p = 1) or
					(qt_municipio_w = 0 AND ie_area_abrangencia_p = 2)) then
					ie_produto_w := 'S';
				end if;
		end if;
	end if;
elsif (ie_area_abrangencia_p = 0) then
	ie_produto_w := 'S';
end if;

return	ie_produto_w;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pls_compartilhamento_risco_pck.obter_abrangencia_produto ( ie_area_abrangencia_p pls_regra_interc_eleg_item.ie_area_abrangencia%type, nr_seq_cooperativa_p pls_segurado_repasse.nr_seq_congenere%type, nr_seq_plano_p pls_plano.nr_sequencia%type) FROM PUBLIC;
