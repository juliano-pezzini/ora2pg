-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pls_mensalidade_util_pck.obter_msg_reajuste_indice ( nr_seq_segurado_preco_p pls_segurado_preco.nr_sequencia%type, ie_tipo_estipulante_p pls_mensalidade_segurado.ie_tipo_estipulante%type, nr_seq_plano_p pls_mensalidade_segurado.nr_seq_plano%type ) RETURNS varchar AS $body$
DECLARE


tx_reajuste_w			pls_reajuste.tx_reajuste%type;
ds_oficio_ans_w			pls_reajuste.ds_oficio_ans%type;
nr_protocolo_ans_w		pls_reajuste.nr_protocolo_ans%type;
dt_autorizacao_ans_w		pls_reajuste.dt_autorizacao_ans%type;
dt_periodo_inicial_w		pls_reajuste.dt_periodo_inicial%type;
dt_periodo_final_w		pls_reajuste.dt_periodo_final%type;
dt_reajuste_w			pls_reajuste.dt_reajuste%type;

ds_plano_w			pls_plano.ds_plano%type;
nr_protocolo_ans_plano_w	pls_plano.nr_protocolo_ans%type;
cd_scpa_w			pls_plano.cd_scpa%type;
ds_registro_ans_w		varchar(255);

ds_mensagem_reajuste_w		pls_mensalidade_seg_item.ds_mensagem_reajuste%type;


BEGIN

if (ie_tipo_estipulante_p = 'PF') then
	begin
	select	coalesce(b.tx_reajuste_correto,b.tx_reajuste),
		b.ds_oficio_ans,
		b.nr_protocolo_ans,
		b.dt_autorizacao_ans,
		b.dt_periodo_inicial,
		b.dt_periodo_final,
		b.dt_reajuste
	into STRICT	tx_reajuste_w,
		ds_oficio_ans_w,
		nr_protocolo_ans_w,
		dt_autorizacao_ans_w,
		dt_periodo_inicial_w,
		dt_periodo_final_w,
		dt_reajuste_w
	from	pls_segurado_preco a,
		pls_reajuste b
	where	b.nr_sequencia	= a.nr_seq_lote_reajuste
	and	a.nr_sequencia	= nr_seq_segurado_preco_p;
	exception
	when others then
		tx_reajuste_w		:= null;
		ds_oficio_ans_w		:= null;
		nr_protocolo_ans_w	:= null;
		dt_autorizacao_ans_w	:= null;
		dt_periodo_inicial_w	:= null;
		dt_periodo_final_w	:= null;
		dt_reajuste_w		:= null;
	end;
else
	select	coalesce(max(c.tx_reajuste_correto),max(c.tx_reajuste)),
		max(c.dt_reajuste),
		max(c.dt_periodo_inicial),
		max(c.dt_periodo_final)
	into STRICT	tx_reajuste_w,
		dt_reajuste_w,
		dt_periodo_inicial_w,
		dt_periodo_final_w
	from	pls_segurado_preco	a,
		pls_reajuste_preco	b,
		pls_reajuste		c
	where	a.nr_seq_reajuste	= b.nr_sequencia
	and	b.nr_seq_reajuste	= c.nr_sequencia
	and	a.nr_sequencia		= nr_seq_segurado_preco_p;
end if;

select	max(ds_plano),
	max(nr_protocolo_ans),
	max(cd_scpa)
into STRICT	ds_plano_w,
	nr_protocolo_ans_plano_w,
	cd_scpa_w
from	pls_plano
where	nr_sequencia = nr_seq_plano_p;

if (coalesce(dt_periodo_inicial_w::text, '') = '') or (coalesce(dt_periodo_final_w::text, '') = '') then
	dt_periodo_inicial_w := dt_reajuste_w;
	dt_periodo_final_w := add_months(dt_reajuste_w,11);
end if;

ds_registro_ans_w	:= coalesce(nr_protocolo_ans_plano_w,cd_scpa_w);

if (ie_tipo_estipulante_p = 'PF') then
	ds_mensagem_reajuste_w	:= substr(wheb_mensagem_pck.get_texto(1036171,	'TX_REAJUSTE='||tx_reajuste_w||';'||'DS_OFICIO_ANS='||ds_oficio_ans_w||';'||'NR_PROTOCOLO_ANS='||nr_protocolo_ans_w||';'||
										'DT_AUTORIZACAO_ANS='||to_char(dt_autorizacao_ans_w,'dd/mm/yyyy')||';'||'DT_PERIODO_INICIAL='||to_char(dt_periodo_inicial_w,'mm/yyyy')||';'||
										'DT_PERIODO_FINAL='||to_char(dt_periodo_final_w,'mm/yyyy')||';'||'NR_SEQ_PLANO='||nr_seq_plano_p||';'||'DS_PLANO='||ds_plano_w||';'||
										'DS_REGISTRO_ANS='||ds_registro_ans_w||';'||'DT_PROX_REAJUSTE='||to_char(add_months(dt_reajuste_w,12),'mm/yyyy')), 1,2000);			
elsif (ie_tipo_estipulante_p = 'PJ') then
	ds_mensagem_reajuste_w	:= substr(wheb_mensagem_pck.get_texto(1036172,	'TX_REAJUSTE='||tx_reajuste_w||';'||'DT_REAJUSTE='||to_char(dt_reajuste_w,'dd/mm/yyyy')||';'||
										'DT_PERIODO_INICIAL='||to_char(dt_periodo_inicial_w,'mm/yyyy')||';'||'DT_PERIODO_FINAL='||to_char(dt_periodo_final_w,'mm/yyyy')||';'||
										'NR_SEQ_PLANO='||nr_seq_plano_p||';'||'DS_PLANO='||ds_plano_w||';'||'DS_REGISTRO_ANS='||ds_registro_ans_w||';'||
										'DT_PROX_REAJUSTE='||to_char(add_months(dt_reajuste_w,12),'mm/yyyy')), 1,2000);
end if;

return ds_mensagem_reajuste_w;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pls_mensalidade_util_pck.obter_msg_reajuste_indice ( nr_seq_segurado_preco_p pls_segurado_preco.nr_sequencia%type, ie_tipo_estipulante_p pls_mensalidade_segurado.ie_tipo_estipulante%type, nr_seq_plano_p pls_mensalidade_segurado.nr_seq_plano%type ) FROM PUBLIC;
