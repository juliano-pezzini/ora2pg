-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_mensalidade_util_pck.obter_regra_data_limite ( nr_seq_contrato_p pls_contrato.nr_sequencia%type, nr_seq_intercambio_p pls_intercambio.nr_sequencia%type, ie_tipo_estipulante_p text, dt_referencia_p timestamp, nr_seq_regra_limite_p INOUT pls_regra_mens_contrato.nr_sequencia%type, ie_agrupar_valor_lim_p INOUT pls_regra_mens_contrato.ie_agrupar_valor%type, qt_dias_vencimento_p INOUT pls_regra_mens_contrato.qt_dias_vencimento%type, ie_primeira_mensalidade_p INOUT pls_regra_mens_contrato.ie_primeira_mensalidade%type, ie_data_base_adesao_p INOUT pls_regra_mens_contrato.ie_data_base_adesao%type) AS $body$
DECLARE

nr_seq_regra_limite_w		pls_regra_mens_contrato.nr_sequencia%type;
ie_agrupar_valor_lim_w		pls_regra_mens_contrato.ie_agrupar_valor%type;
qt_dias_vencimento_w		pls_regra_mens_contrato.qt_dias_vencimento%type;
ie_primeira_mensalidade_w	pls_regra_mens_contrato.ie_primeira_mensalidade%type;
ie_data_base_adesao_w		pls_regra_mens_contrato.ie_data_base_adesao%type;


BEGIN
nr_seq_regra_limite_w	:= null;
if (nr_seq_contrato_p IS NOT NULL AND nr_seq_contrato_p::text <> '') then
	select	max(nr_sequencia),
		max(ie_agrupar_valor),
		max(qt_dias_vencimento),
		max(ie_primeira_mensalidade),
		max(ie_data_base_adesao)
	into STRICT	nr_seq_regra_limite_w,
		ie_agrupar_valor_lim_w,
		qt_dias_vencimento_w,
		ie_primeira_mensalidade_w,
		ie_data_base_adesao_w
	from	pls_regra_mens_contrato
	where	nr_seq_contrato	= nr_seq_contrato_p
	and	ie_tipo_regra	= 'L'
	and	dt_referencia_p between dt_inicio_vigencia_ref and dt_fim_vigencia_ref;
elsif (nr_seq_intercambio_p IS NOT NULL AND nr_seq_intercambio_p::text <> '') then
	select	max(nr_sequencia),
		max(ie_agrupar_valor),
		max(qt_dias_vencimento),
		max(ie_primeira_mensalidade),
		max(ie_data_base_adesao)
	into STRICT	nr_seq_regra_limite_w,
		ie_agrupar_valor_lim_w,
		qt_dias_vencimento_w,
		ie_primeira_mensalidade_w,
		ie_data_base_adesao_w
	from	pls_regra_mens_contrato
	where	nr_seq_intercambio	= nr_seq_intercambio_p
	and	ie_tipo_regra	= 'F'
	and	dt_referencia_p between dt_inicio_vigencia_ref and dt_fim_vigencia_ref;
end if;

if (coalesce(nr_seq_regra_limite_w::text, '') = '') then
	if (ie_tipo_estipulante_p = 'PF') then
		nr_seq_regra_limite_w		:= current_setting('pls_mensalidade_util_pck.nr_seq_regra_limite_pf_w')::pls_regra_mens_contrato.nr_sequencia%type;
		ie_agrupar_valor_lim_w		:= current_setting('pls_mensalidade_util_pck.ie_agrupar_valor_lim_pf_w')::pls_regra_mens_contrato.ie_agrupar_valor%type;
		qt_dias_vencimento_w		:= current_setting('pls_mensalidade_util_pck.qt_dias_vencimento_pf_w')::pls_regra_mens_contrato.qt_dias_vencimento%type;
		ie_primeira_mensalidade_w	:= current_setting('pls_mensalidade_util_pck.ie_primeira_mensalidade_pf_w')::pls_regra_mens_contrato.ie_primeira_mensalidade%type;
		ie_data_base_adesao_w		:= current_setting('pls_mensalidade_util_pck.ie_data_base_adesao_pf_w')::pls_regra_mens_contrato.ie_data_base_adesao%type;
	elsif (ie_tipo_estipulante_p = 'PJ') then
		nr_seq_regra_limite_w		:= current_setting('pls_mensalidade_util_pck.nr_seq_regra_limite_pj_w')::pls_regra_mens_contrato.nr_sequencia%type;
		ie_agrupar_valor_lim_w		:= current_setting('pls_mensalidade_util_pck.ie_agrupar_valor_lim_pj_w')::pls_regra_mens_contrato.ie_agrupar_valor%type;
		qt_dias_vencimento_w		:= current_setting('pls_mensalidade_util_pck.qt_dias_vencimento_pj_w')::pls_regra_mens_contrato.qt_dias_vencimento%type;
		ie_primeira_mensalidade_w	:= current_setting('pls_mensalidade_util_pck.ie_primeira_mensalidade_pj_w')::pls_regra_mens_contrato.ie_primeira_mensalidade%type;
		ie_data_base_adesao_w		:= current_setting('pls_mensalidade_util_pck.ie_data_base_adesao_pj_w')::pls_regra_mens_contrato.ie_data_base_adesao%type;
	end if;
	
	if (coalesce(nr_seq_regra_limite_w::text, '') = '') then
		nr_seq_regra_limite_w		:= current_setting('pls_mensalidade_util_pck.nr_seq_regra_limite_a_w')::pls_regra_mens_contrato.nr_sequencia%type;
		ie_agrupar_valor_lim_w		:= current_setting('pls_mensalidade_util_pck.ie_agrupar_valor_lim_a_w')::pls_regra_mens_contrato.ie_agrupar_valor%type;
		qt_dias_vencimento_w		:= current_setting('pls_mensalidade_util_pck.qt_dias_vencimento_a_w')::pls_regra_mens_contrato.qt_dias_vencimento%type;
		ie_primeira_mensalidade_w	:= current_setting('pls_mensalidade_util_pck.ie_primeira_mensalidade_a_w')::pls_regra_mens_contrato.ie_primeira_mensalidade%type;
		ie_data_base_adesao_w		:= current_setting('pls_mensalidade_util_pck.ie_data_base_adesao_a_w')::pls_regra_mens_contrato.ie_data_base_adesao%type;
	end if;
end if;

nr_seq_regra_limite_p		:= nr_seq_regra_limite_w;
ie_agrupar_valor_lim_p		:= coalesce(ie_agrupar_valor_lim_w,'S');
qt_dias_vencimento_p		:= coalesce(qt_dias_vencimento_w,0);
ie_primeira_mensalidade_p	:= coalesce(ie_primeira_mensalidade_w,'N');
ie_data_base_adesao_p		:= coalesce(ie_data_base_adesao_w,'A');

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_mensalidade_util_pck.obter_regra_data_limite ( nr_seq_contrato_p pls_contrato.nr_sequencia%type, nr_seq_intercambio_p pls_intercambio.nr_sequencia%type, ie_tipo_estipulante_p text, dt_referencia_p timestamp, nr_seq_regra_limite_p INOUT pls_regra_mens_contrato.nr_sequencia%type, ie_agrupar_valor_lim_p INOUT pls_regra_mens_contrato.ie_agrupar_valor%type, qt_dias_vencimento_p INOUT pls_regra_mens_contrato.qt_dias_vencimento%type, ie_primeira_mensalidade_p INOUT pls_regra_mens_contrato.ie_primeira_mensalidade%type, ie_data_base_adesao_p INOUT pls_regra_mens_contrato.ie_data_base_adesao%type) FROM PUBLIC;
