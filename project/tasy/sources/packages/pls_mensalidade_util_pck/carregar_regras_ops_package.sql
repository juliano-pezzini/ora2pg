-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_mensalidade_util_pck.carregar_regras_ops ( cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type, dt_referencia_p pls_lote_mensalidade.dt_mesano_referencia%type, nr_seq_lote_p pls_lote_mensalidade.nr_sequencia%type, nr_seq_solic_resc_fin_p pls_solic_rescisao_fin.nr_sequencia%type) AS $body$
DECLARE

				
nr_seq_regra_rescisao_w	pls_resc_fin_mens.nr_sequencia%type;
				

BEGIN

PERFORM set_config('pls_mensalidade_util_pck.qt_meses_ant_w', coalesce(obter_valor_param_usuario(1205, 5, Obter_Perfil_Ativo, nm_usuario_p, cd_estabelecimento_p), 0), false);
PERFORM set_config('pls_mensalidade_util_pck.ie_parametro_w', coalesce(obter_valor_param_usuario(1205, 43, Obter_Perfil_Ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento), 'N'), false);

if (current_setting('pls_mensalidade_util_pck.ie_parametro_w')::varchar(10) = 'S') then
	PERFORM set_config('pls_mensalidade_util_pck.ds_nm_arquivo_w', 'logGeracaoMensalidade' || to_char(clock_timestamp(),'dd-mm-yyyy_hh24_mi_ss')||'.txt', false);
	current_setting('pls_mensalidade_util_pck.ds_local_windows_w')::varchar(4000) := pls_utl_file_pck.novo_arquivo( 15, pls_mensalidade_util_pck.get_nm_arquivo(), 'S', null, current_setting('pls_mensalidade_util_pck.ds_local_windows_w')::varchar(4000));
	PERFORM set_config('pls_mensalidade_util_pck.ds_conteudo_w', 'Procedure: PLS_GERACAO_MENSALIDADE', false);
	CALL pls_utl_file_pck.escrever(current_setting('pls_mensalidade_util_pck.ds_conteudo_w')::varchar(4000));
	PERFORM set_config('pls_mensalidade_util_pck.ds_conteudo_w', '', false);
	CALL pls_utl_file_pck.escrever(current_setting('pls_mensalidade_util_pck.ds_conteudo_w')::varchar(4000));
	PERFORM set_config('pls_mensalidade_util_pck.ds_conteudo_w', '---------- '||wheb_mensagem_pck.get_texto(1166993)||'(s) ----------', false);
	CALL pls_utl_file_pck.escrever(current_setting('pls_mensalidade_util_pck.ds_conteudo_w')::varchar(4000));
	if (nr_seq_lote_p IS NOT NULL AND nr_seq_lote_p::text <> '') then
		PERFORM set_config('pls_mensalidade_util_pck.ds_conteudo_w', 'NR_SEQ_LOTE_P........: '||NR_SEQ_LOTE_P, false);
		CALL pls_utl_file_pck.escrever(current_setting('pls_mensalidade_util_pck.ds_conteudo_w')::varchar(4000));
	end if;
	PERFORM set_config('pls_mensalidade_util_pck.ds_conteudo_w', 'CD_ESTABELECIMENTO_P.: '||wheb_usuario_pck.get_cd_estabelecimento, false);
	CALL pls_utl_file_pck.escrever(current_setting('pls_mensalidade_util_pck.ds_conteudo_w')::varchar(4000));
	PERFORM set_config('pls_mensalidade_util_pck.ds_conteudo_w', 'NM_USUARIO_P.........: '||NM_USUARIO_P, false);
	CALL pls_utl_file_pck.escrever(current_setting('pls_mensalidade_util_pck.ds_conteudo_w')::varchar(4000));
	PERFORM set_config('pls_mensalidade_util_pck.ds_conteudo_w', 'Operador.............: '||User, false);
	CALL pls_utl_file_pck.escrever(current_setting('pls_mensalidade_util_pck.ds_conteudo_w')::varchar(4000));
	PERFORM set_config('pls_mensalidade_util_pck.ds_conteudo_w', wheb_mensagem_pck.get_texto(1166995)||'..............: '||USERENV('TERMINAL'), false);
	CALL pls_utl_file_pck.escrever(current_setting('pls_mensalidade_util_pck.ds_conteudo_w')::varchar(4000));
	PERFORM set_config('pls_mensalidade_util_pck.ds_conteudo_w', wheb_mensagem_pck.get_texto(1166996)||' da '||wheb_mensagem_pck.get_texto(1166998)||'...: '||to_char(clock_timestamp(), 'dd/mm/yyyy hh24:mi:ss'), false);
	CALL pls_utl_file_pck.escrever(current_setting('pls_mensalidade_util_pck.ds_conteudo_w')::varchar(4000));
	PERFORM set_config('pls_mensalidade_util_pck.ds_conteudo_w', '', false);
	CALL pls_utl_file_pck.escrever(current_setting('pls_mensalidade_util_pck.ds_conteudo_w')::varchar(4000));
	PERFORM set_config('pls_mensalidade_util_pck.ds_conteudo_w', '--------------------------------------------------------------------------------', false);
	CALL pls_utl_file_pck.escrever(current_setting('pls_mensalidade_util_pck.ds_conteudo_w')::varchar(4000));
	
end if;

--Regra geral

select	max(ie_mensalidade_mes_rescisao),
	max(ie_rescisao_proporcional)
into STRICT	current_setting('pls_mensalidade_util_pck.ie_mensalidade_mes_resc_pf_w')::pls_regra_mens_contrato.ie_mensalidade_mes_rescisao%type,
	current_setting('pls_mensalidade_util_pck.ie_rescisao_proporcional_pf_w')::pls_regra_mens_contrato.ie_rescisao_proporcional%type
from	pls_regra_mens_contrato
where	ie_tipo_regra	= 'G'
and	coalesce(nr_seq_contrato::text, '') = ''
and	coalesce(nr_seq_intercambio::text, '') = ''
and	ie_pessoa_contrato = 'PF'
and	cd_estabelecimento = cd_estabelecimento_p
and	dt_referencia_p between dt_inicio_vigencia_ref and dt_fim_vigencia_ref;

select	max(ie_mensalidade_mes_rescisao),
	max(ie_rescisao_proporcional)
into STRICT	current_setting('pls_mensalidade_util_pck.ie_mensalidade_mes_resc_pj_w')::pls_regra_mens_contrato.ie_mensalidade_mes_rescisao%type,
	current_setting('pls_mensalidade_util_pck.ie_rescisao_proporcional_pj_w')::pls_regra_mens_contrato.ie_rescisao_proporcional%type
from	pls_regra_mens_contrato
where	ie_tipo_regra	= 'G'
and	coalesce(nr_seq_contrato::text, '') = ''
and	coalesce(nr_seq_intercambio::text, '') = ''
and	ie_pessoa_contrato = 'PJ'
and	cd_estabelecimento = cd_estabelecimento_p
and	dt_referencia_p between dt_inicio_vigencia_ref and dt_fim_vigencia_ref;

select	max(ie_mensalidade_mes_rescisao),
	max(ie_rescisao_proporcional)
into STRICT	current_setting('pls_mensalidade_util_pck.ie_mensalidade_mes_resc_a_w')::pls_regra_mens_contrato.ie_mensalidade_mes_rescisao%type,
	current_setting('pls_mensalidade_util_pck.ie_rescisao_proporcional_a_w')::pls_regra_mens_contrato.ie_rescisao_proporcional%type
from	pls_regra_mens_contrato
where	ie_tipo_regra	= 'G'
and	coalesce(nr_seq_contrato::text, '') = ''
and	coalesce(nr_seq_intercambio::text, '') = ''
and	ie_pessoa_contrato = 'A'
and	cd_estabelecimento = cd_estabelecimento_p
and	dt_referencia_p between dt_inicio_vigencia_ref and dt_fim_vigencia_ref;

--Regra mensalidade futura

select	max(qt_interv_mes_mensalidade),
	max(ie_agrupar_valor)
into STRICT	current_setting('pls_mensalidade_util_pck.qt_interv_mes_mensalidade_pf_w')::pls_regra_mens_contrato.qt_interv_mes_mensalidade%type,
	current_setting('pls_mensalidade_util_pck.ie_agrupar_valor_pf_w')::pls_regra_mens_contrato.ie_agrupar_valor%type
from	pls_regra_mens_contrato
where	ie_tipo_regra	= 'F'
and	coalesce(nr_seq_contrato::text, '') = ''
and	coalesce(nr_seq_intercambio::text, '') = ''
and	ie_pessoa_contrato = 'PF'
and	cd_estabelecimento = cd_estabelecimento_p
and	dt_referencia_p between dt_inicio_vigencia_ref and dt_fim_vigencia_ref;

select	max(qt_interv_mes_mensalidade),
	max(ie_agrupar_valor)
into STRICT	current_setting('pls_mensalidade_util_pck.qt_interv_mes_mensalidade_pj_w')::pls_regra_mens_contrato.qt_interv_mes_mensalidade%type,
	current_setting('pls_mensalidade_util_pck.ie_agrupar_valor_pj_w')::pls_regra_mens_contrato.ie_agrupar_valor%type
from	pls_regra_mens_contrato
where	ie_tipo_regra	= 'F'
and	coalesce(nr_seq_contrato::text, '') = ''
and	coalesce(nr_seq_intercambio::text, '') = ''
and	ie_pessoa_contrato = 'PJ'
and	cd_estabelecimento = cd_estabelecimento_p
and	dt_referencia_p between dt_inicio_vigencia_ref and dt_fim_vigencia_ref;

select	max(qt_interv_mes_mensalidade),
	max(ie_agrupar_valor)
into STRICT	current_setting('pls_mensalidade_util_pck.qt_interv_mes_mensalidade_a_w')::pls_regra_mens_contrato.qt_interv_mes_mensalidade%type,
	current_setting('pls_mensalidade_util_pck.ie_agrupar_valor_a_w')::pls_regra_mens_contrato.ie_agrupar_valor%type
from	pls_regra_mens_contrato
where	ie_tipo_regra	= 'F'
and	coalesce(nr_seq_contrato::text, '') = ''
and	coalesce(nr_seq_intercambio::text, '') = ''
and	ie_pessoa_contrato = 'A'
and	cd_estabelecimento = cd_estabelecimento_p
and	dt_referencia_p between dt_inicio_vigencia_ref and dt_fim_vigencia_ref;

--Regra data limite

select	max(nr_sequencia),
	max(ie_agrupar_valor),
	max(qt_dias_vencimento),
	max(ie_primeira_mensalidade),
	max(ie_data_base_adesao)
into STRICT	current_setting('pls_mensalidade_util_pck.nr_seq_regra_limite_pf_w')::pls_regra_mens_contrato.nr_sequencia%type,
	current_setting('pls_mensalidade_util_pck.ie_agrupar_valor_lim_pf_w')::pls_regra_mens_contrato.ie_agrupar_valor%type,
	current_setting('pls_mensalidade_util_pck.qt_dias_vencimento_pf_w')::pls_regra_mens_contrato.qt_dias_vencimento%type,
	current_setting('pls_mensalidade_util_pck.ie_primeira_mensalidade_pf_w')::pls_regra_mens_contrato.ie_primeira_mensalidade%type,
	current_setting('pls_mensalidade_util_pck.ie_data_base_adesao_pf_w')::pls_regra_mens_contrato.ie_data_base_adesao%type
from	pls_regra_mens_contrato
where	ie_tipo_regra	= 'L'
and	coalesce(nr_seq_contrato::text, '') = ''
and	coalesce(nr_seq_intercambio::text, '') = ''
and	ie_pessoa_contrato = 'PF'
and	cd_estabelecimento = cd_estabelecimento_p
and	dt_referencia_p between dt_inicio_vigencia_ref and dt_fim_vigencia_ref;

select	max(nr_sequencia),
	max(ie_agrupar_valor),
	max(qt_dias_vencimento),
	max(ie_primeira_mensalidade),
	max(ie_data_base_adesao)
into STRICT	current_setting('pls_mensalidade_util_pck.nr_seq_regra_limite_pj_w')::pls_regra_mens_contrato.nr_sequencia%type,
	current_setting('pls_mensalidade_util_pck.ie_agrupar_valor_lim_pj_w')::pls_regra_mens_contrato.ie_agrupar_valor%type,
	current_setting('pls_mensalidade_util_pck.qt_dias_vencimento_pj_w')::pls_regra_mens_contrato.qt_dias_vencimento%type,
	current_setting('pls_mensalidade_util_pck.ie_primeira_mensalidade_pj_w')::pls_regra_mens_contrato.ie_primeira_mensalidade%type,
	current_setting('pls_mensalidade_util_pck.ie_data_base_adesao_pj_w')::pls_regra_mens_contrato.ie_data_base_adesao%type
from	pls_regra_mens_contrato
where	ie_tipo_regra	= 'L'
and	coalesce(nr_seq_contrato::text, '') = ''
and	coalesce(nr_seq_intercambio::text, '') = ''
and	ie_pessoa_contrato = 'PJ'
and	cd_estabelecimento = cd_estabelecimento_p
and	dt_referencia_p between dt_inicio_vigencia_ref and dt_fim_vigencia_ref;

select	max(nr_sequencia),
	max(ie_agrupar_valor),
	max(qt_dias_vencimento),
	max(ie_primeira_mensalidade),
	max(ie_data_base_adesao)
into STRICT	current_setting('pls_mensalidade_util_pck.nr_seq_regra_limite_a_w')::pls_regra_mens_contrato.nr_sequencia%type,
	current_setting('pls_mensalidade_util_pck.ie_agrupar_valor_lim_a_w')::pls_regra_mens_contrato.ie_agrupar_valor%type,
	current_setting('pls_mensalidade_util_pck.qt_dias_vencimento_a_w')::pls_regra_mens_contrato.qt_dias_vencimento%type,
	current_setting('pls_mensalidade_util_pck.ie_primeira_mensalidade_a_w')::pls_regra_mens_contrato.ie_primeira_mensalidade%type,
	current_setting('pls_mensalidade_util_pck.ie_data_base_adesao_a_w')::pls_regra_mens_contrato.ie_data_base_adesao%type
from	pls_regra_mens_contrato
where	ie_tipo_regra	= 'L'
and	coalesce(nr_seq_contrato::text, '') = ''
and	coalesce(nr_seq_intercambio::text, '') = ''
and	ie_pessoa_contrato = 'A'
and	cd_estabelecimento = cd_estabelecimento_p
and	dt_referencia_p between dt_inicio_vigencia_ref and dt_fim_vigencia_ref;

--Regra valor minimo

select	max(nr_sequencia),
	max(vl_minimo),
	max(vl_minimo_abat_fatura)
into STRICT	current_setting('pls_mensalidade_util_pck.nr_seq_regra_vl_minimo_pf_w')::pls_regra_mens_contrato.nr_sequencia%type,
	current_setting('pls_mensalidade_util_pck.vl_minimo_pf_w')::pls_regra_mens_contrato.vl_minimo%type,
	current_setting('pls_mensalidade_util_pck.vl_minimo_abat_fatura_pf_w')::pls_regra_mens_contrato.vl_minimo_abat_fatura%type
from	pls_regra_mens_contrato
where	ie_tipo_regra	= 'VM'
and	coalesce(nr_seq_contrato::text, '') = ''
and	coalesce(nr_seq_intercambio::text, '') = ''
and	ie_pessoa_contrato = 'PF'
and	cd_estabelecimento = cd_estabelecimento_p
and	dt_referencia_p between dt_inicio_vigencia_ref and dt_fim_vigencia_ref;

select	max(nr_sequencia),
	max(vl_minimo),
	max(vl_minimo_abat_fatura)
into STRICT	current_setting('pls_mensalidade_util_pck.nr_seq_regra_vl_minimo_pj_w')::pls_regra_mens_contrato.nr_sequencia%type,
	current_setting('pls_mensalidade_util_pck.vl_minimo_pj_w')::pls_regra_mens_contrato.vl_minimo%type,
	current_setting('pls_mensalidade_util_pck.vl_minimo_abat_fatura_pj_w')::pls_regra_mens_contrato.vl_minimo_abat_fatura%type
from	pls_regra_mens_contrato
where	ie_tipo_regra	= 'VM'
and	coalesce(nr_seq_contrato::text, '') = ''
and	coalesce(nr_seq_intercambio::text, '') = ''
and	ie_pessoa_contrato = 'PJ'
and	cd_estabelecimento = cd_estabelecimento_p
and	dt_referencia_p between dt_inicio_vigencia_ref and dt_fim_vigencia_ref;

select	max(nr_sequencia),
	max(vl_minimo),
	max(vl_minimo_abat_fatura)
into STRICT	current_setting('pls_mensalidade_util_pck.nr_seq_regra_vl_minimo_a_w')::pls_regra_mens_contrato.nr_sequencia%type,
	current_setting('pls_mensalidade_util_pck.vl_minimo_a_w')::pls_regra_mens_contrato.vl_minimo%type,
	current_setting('pls_mensalidade_util_pck.vl_minimo_abat_fatura_a_w')::pls_regra_mens_contrato.vl_minimo_abat_fatura%type
from	pls_regra_mens_contrato
where	ie_tipo_regra	= 'VM'
and	coalesce(nr_seq_contrato::text, '') = ''
and	coalesce(nr_seq_intercambio::text, '') = ''
and	ie_pessoa_contrato = 'A'
and	cd_estabelecimento = cd_estabelecimento_p
and	dt_referencia_p between dt_inicio_vigencia_ref and dt_fim_vigencia_ref;

if (nr_seq_solic_resc_fin_p IS NOT NULL AND nr_seq_solic_resc_fin_p::text <> '') then
	nr_seq_regra_rescisao_w	:= pls_obter_regra_resc_fin(nr_seq_solic_resc_fin_p, cd_estabelecimento_p);

	if (nr_seq_regra_rescisao_w IS NOT NULL AND nr_seq_regra_rescisao_w::text <> '') then
		select	coalesce(ie_adiantar_cobranca_retro, 'N')
		into STRICT	current_setting('pls_mensalidade_util_pck.ie_adiantar_cobranca_retro_w')::pls_resc_fin_mens.ie_adiantar_cobranca_retro%type
		from	pls_resc_fin_mens
		where	nr_sequencia = nr_seq_regra_rescisao_w;
	end if;
end if;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_mensalidade_util_pck.carregar_regras_ops ( cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type, dt_referencia_p pls_lote_mensalidade.dt_mesano_referencia%type, nr_seq_lote_p pls_lote_mensalidade.nr_sequencia%type, nr_seq_solic_resc_fin_p pls_solic_rescisao_fin.nr_sequencia%type) FROM PUBLIC;
