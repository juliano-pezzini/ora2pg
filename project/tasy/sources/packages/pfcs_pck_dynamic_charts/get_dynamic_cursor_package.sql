-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pfcs_pck_dynamic_charts.get_dynamic_cursor (nr_seq_card_p bigint, cd_establishment_p bigint, nr_seq_tab_p bigint) RETURNS SYS_REFCURSOR AS $body$
DECLARE

        cur_dynamic_w   REFCURSOR;
        ds_sql_w        dic_objeto.ds_sql%type;
        ie_situacao_w   pfcs_indicator.ie_situacao%type;

BEGIN
        select (   'SELECT substr(pfcs_pck_utils.get_object_column_name('''||pci.nm_first_column||''','||do.nr_sequencia||'),1,255) '  || ' DS_TITLE_1, '          ||
                ''||pfcs_pck_dynamic_charts.check_column_name(pci.nm_first_column)||''                                                                  || ' VL_COLUMN_1, '         ||
                'substr(pfcs_pck_utils.get_object_column_name('''||pci.nm_second_column||''','||do.nr_sequencia||'),1,255) '    || ' DS_TITLE_2, '          ||
                ''||pfcs_pck_dynamic_charts.check_column_name(pci.nm_second_column)||''                                                                 || ' VL_COLUMN_2, '         ||
                'substr(pfcs_pck_utils.get_object_column_name('''||pci.nm_third_column||''','||do.nr_sequencia||'),1,255) '     || ' DS_TITLE_3, '          ||
                ''||pfcs_pck_dynamic_charts.check_column_name(pci.nm_third_column)||''                                                                  || ' VL_COLUMN_3, '         ||
                'substr(pfcs_pck_utils.get_object_column_name('''||pci.nm_fourth_column||''','||do.nr_sequencia||'),1,255) '    || ' DS_TITLE_4, '          ||
                ''||pfcs_pck_dynamic_charts.check_column_name(pci.nm_fourth_column)||''                                                                 || ' VL_COLUMN_4, '         ||
                ''||chr(39)||   pfcs_pck_dynamic_cards.get_detail_parameters_list(
                                    pci.nr_seq_indicator, current_setting('pfcs_pck_dynamic_charts.cd_default_alias_w')::varchar(2)||'.', PFCS_PCK_CONSTANTS.IE_YES
                                ) ||chr(39)||''                                                                                 || ' DS_PARAMETERS_LIST, '  ||
                ''||pfcs_pck_dynamic_charts.get_component_subtitles(pc.nr_sequencia)||''                                                                || ' COMPONENT_SUBTITLES '  ||
            'FROM ( ' || do.ds_sql || ' )  ' || current_setting('pfcs_pck_dynamic_charts.cd_default_alias_w')::varchar(2) || '  WHERE 1 = 1 '
        ) ds_sql, pi.ie_situacao
        into STRICT ds_sql_w, ie_situacao_w
        from pfcs_card pc,
            pfcs_card_indicator pci,
            pfcs_indicator pi,
            dic_objeto do
        where pci.nr_seq_indicator = pi.nr_sequencia
            and pci.nr_seq_card = pc.nr_sequencia
            and (pc.cd_card_type = PFCS_PCK_CONSTANTS.CD_TYPE_TABLECHART or pc.cd_card_type = PFCS_PCK_CONSTANTS.CD_EXPANSIBLE_BN)
            and (pci.cd_type = PFCS_PCK_CONSTANTS.CD_TYPE_SIMPLE_CHART
                    or (pci.cd_type = PFCS_PCK_CONSTANTS.CD_TYPE_WITH_TABS_CHART AND pi.nr_sequencia = nr_seq_tab_p))
            and pi.nr_seq_object = do.nr_sequencia
            and pc.nr_sequencia =  nr_seq_card_p;

        if (cd_establishment_p IS NOT NULL AND cd_establishment_p::text <> '') then
            ds_sql_w := ds_sql_w || ' and a.cd_establishment = ' || cd_establishment_p;
        end if;

        if (ie_situacao_w = PFCS_PCK_CONSTANTS.IE_DEVELOPMENT) then
            ds_sql_w := ds_sql_w || ' and 1 = 2 ';
        end if;

        open cur_dynamic_w
        for EXECUTE ds_sql_w;
        return cur_dynamic_w;
    END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pfcs_pck_dynamic_charts.get_dynamic_cursor (nr_seq_card_p bigint, cd_establishment_p bigint, nr_seq_tab_p bigint) FROM PUBLIC;
