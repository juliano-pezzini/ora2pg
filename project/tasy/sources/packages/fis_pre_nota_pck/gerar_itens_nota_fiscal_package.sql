-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE fis_pre_nota_pck.gerar_itens_nota_fiscal ( cd_estabelecimento_p nota_fiscal_item.cd_estabelecimento%type, nr_nota_fiscal_p nota_fiscal_item.nr_nota_fiscal%type, cd_serie_nf_p nota_fiscal_item.cd_serie_nf%type, nr_ordem_compra_p nota_fiscal_item.nr_ordem_compra%type, nm_usuario_p nota_fiscal_item.nm_usuario%type, nr_sequencia_p nota_fiscal_item.nr_sequencia%type, vl_unitario_item_nf_p nota_fiscal_item.vl_unitario_item_nf%type, qt_item_nf_p nota_fiscal_item.qt_item_nf%type, qt_item_estoque_p nota_fiscal_item.qt_item_estoque%type, vl_total_item_nf_p nota_fiscal_item.vl_total_item_nf%type, dt_atualizacao_p nota_fiscal_item.dt_atualizacao%type, cd_material_p nota_fiscal_item.cd_material%type) AS $body$
DECLARE


        nr_sequencia_nf_w	  nota_fiscal_item.nr_sequencia_nf%type;
        vl_seguro_w			  nota_fiscal_item.vl_seguro%type	      := 0;
        vl_desconto_rateio_w  nota_fiscal_item.vl_desconto_rateio%type := 0;
        vl_desconto_w		  nota_fiscal_item.vl_desconto%type	      := 0;
        vl_liquido_w		  nota_fiscal_item.vl_liquido%type	      := 0;
        nr_item_nf_w	      nota_fiscal_item.nr_item_nf%type;


BEGIN

            vl_liquido_w   :=  vl_total_item_nf_p - vl_desconto_w;

            select (coalesce(max(nr_item_nf),0)+1)
            into STRICT   nr_item_nf_w
            from   nota_fiscal_item
            where  nr_sequencia = nr_sequencia_p;

            select nr_sequencia_nf
            into STRICT  nr_sequencia_nf_w
            from  nota_fiscal
            where nr_sequencia = nr_sequencia_p;

            insert into nota_fiscal_item(
                cd_estabelecimento,
                cd_serie_nf,
                nr_nota_fiscal,
                nr_sequencia_nf,
                nr_item_nf,
                qt_item_nf,
                vl_unitario_item_nf,
                vl_total_item_nf,
                dt_atualizacao,
                nm_usuario,
                vl_frete,
                vl_desconto,
                cd_material,
                qt_item_estoque,
                vl_desconto_rateio,
                vl_seguro,
                nr_ordem_compra,
                nr_sequencia,
                vl_liquido,
                vl_despesa_acessoria)
            values (	cd_estabelecimento_p,
                cd_serie_nf_p,
                nr_nota_fiscal_p,
                nr_sequencia_nf_w,
                nr_item_nf_w,
                qt_item_nf_p,
                vl_unitario_item_nf_p,
                vl_total_item_nf_p,
                dt_atualizacao_p,
                nm_usuario_p,
                0,
                coalesce(vl_desconto_w,0),
                cd_material_p,
                qt_item_estoque_p,
                vl_desconto_rateio_w,
                vl_seguro_w,
                nr_ordem_compra_p,
                nr_sequencia_p,
                vl_liquido_w,
                0);

            commit;

    END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE fis_pre_nota_pck.gerar_itens_nota_fiscal ( cd_estabelecimento_p nota_fiscal_item.cd_estabelecimento%type, nr_nota_fiscal_p nota_fiscal_item.nr_nota_fiscal%type, cd_serie_nf_p nota_fiscal_item.cd_serie_nf%type, nr_ordem_compra_p nota_fiscal_item.nr_ordem_compra%type, nm_usuario_p nota_fiscal_item.nm_usuario%type, nr_sequencia_p nota_fiscal_item.nr_sequencia%type, vl_unitario_item_nf_p nota_fiscal_item.vl_unitario_item_nf%type, qt_item_nf_p nota_fiscal_item.qt_item_nf%type, qt_item_estoque_p nota_fiscal_item.qt_item_estoque%type, vl_total_item_nf_p nota_fiscal_item.vl_total_item_nf%type, dt_atualizacao_p nota_fiscal_item.dt_atualizacao%type, cd_material_p nota_fiscal_item.cd_material%type) FROM PUBLIC;
