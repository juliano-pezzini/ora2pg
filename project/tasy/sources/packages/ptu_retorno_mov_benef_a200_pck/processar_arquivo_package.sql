-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE ptu_retorno_mov_benef_a200_pck.processar_arquivo ( nr_seq_retorno_p bigint, arq_texto_p utl_file.file_type) AS $body$
DECLARE


ds_conteudo_w		varchar(4000);
ds_hash_w		varchar(32);

C01 CURSOR(nr_seq_retorno_pc 	ptu_retorno_movimentacao.nr_sequencia%type) FOR
	SELECT	*
	from	ptu_retorno_movimentacao_v
	where	nr_seq_retorno = nr_seq_retorno_pc
	order by
		cd_unimed_ori,
		cd_unimed;

BEGIN
PERFORM set_config('ptu_retorno_mov_benef_a200_pck.nr_sequencial_arq_w', 0, false);

for r_C01_w in C01(nr_seq_retorno_p) loop
	ds_conteudo_w := '';

	if (r_C01_w.tp_registro = 1) then
		-- R201 - Header
		ds_conteudo_w :=	lpad(r_C01_w.cd_unimed_des,4,0) || lpad(r_C01_w.cd_unimed_ori,4,0) || to_char(r_C01_w.dt_geracao,'YYYYMMDD') ||
					lpad(r_C01_w.ie_tipo_mov,1,0) || to_char(r_C01_w.dt_mov_ini,'YYYYMMDD') || to_char(r_C01_w.dt_mov_final,'YYYYMMDD') || '06' || '  ';
		CALL CALL CALL CALL CALL CALL ptu_retorno_mov_benef_a200_pck.incluir_linha_arq('201', ds_conteudo_w, arq_texto_p);
	elsif (r_C01_w.tp_registro = 2) then
		-- R202 - Benefici√°rio
		ds_conteudo_w := 	lpad(r_C01_w.cd_unimed,4,0) || '   ' || lpad(r_C01_w.id_benef,13,' ') || lpad(r_C01_w.cd_mens_erro,4,0) ||
					lpad(r_C01_w.cd_unimed_cad,4,0) || lpad(r_C01_w.id_benef_cad,13,0);
		CALL CALL CALL CALL CALL CALL ptu_retorno_mov_benef_a200_pck.incluir_linha_arq('202', ds_conteudo_w, arq_texto_p);
	elsif (r_C01_w.tp_registro = 3) then
		-- R209 - Trailer
		ds_conteudo_w := 	lpad(r_C01_w.qt_tot_r202,7,0) || lpad(r_C01_w.qt_tot_inclusao,7,0) || lpad(r_C01_w.qt_tot_exclusao,7,0) ||
					lpad(r_C01_w.qt_tot_alteracao,7,0) || lpad(r_C01_w.qt_tot_transf_plano,7,0) || lpad(r_C01_w.qt_tot_recusado,7,0);
		CALL CALL CALL CALL CALL CALL ptu_retorno_mov_benef_a200_pck.incluir_linha_arq('209', ds_conteudo_w, arq_texto_p);
	end if;
end loop;

current_setting('ptu_retorno_mov_benef_a200_pck.ds_arquivo_w')::text := pls_hash_ptu_pck.obter_hash_txt(current_setting('ptu_retorno_mov_benef_a200_pck.ds_arquivo_w')::text);
ds_conteudo_w	:= lpad(ds_hash_w,32,' ');
CALL CALL CALL CALL CALL CALL ptu_retorno_mov_benef_a200_pck.incluir_linha_arq('998',ds_conteudo_w,arq_texto_p);

update 	ptu_retorno_movimentacao
set 	ds_hash_a200	= ds_hash_w
where 	nr_sequencia 	= nr_seq_retorno_p;
commit;

end;

/* ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------*/

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ptu_retorno_mov_benef_a200_pck.processar_arquivo ( nr_seq_retorno_p bigint, arq_texto_p utl_file.file_type) FROM PUBLIC;
