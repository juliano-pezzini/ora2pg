-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



/*  
    Remove data from TASY_TOPSQL_SQLAREA_REPORT
    Keeps only the top-n lines for SQLs report accordingly to a certain number of days (parameters)
*/
CREATE OR REPLACE PROCEDURE tasy_topsql_pkg.remove_report_data (sample_date timestamp DEFAULT TRUNC(SYSDATE)-15) AS $body$
BEGIN
    -- Remove report data that was not found in the last X days 
    DELETE FROM tasy_topsql_sqlarea_report
    WHERE sql_id in (
        SELECT sql_id
        FROM (
            SELECT sql_id, row_number() over ( order by total_elapsed_time DESC) as row_number
            FROM (
                SELECT sql_id, total_elapsed_time
                FROM tasy_topsql_sqlarea_report
                WHERE last_sample < sample_date
                ) alias2
            ) alias3
    );
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE tasy_topsql_pkg.remove_report_data (sample_date timestamp DEFAULT TRUNC(SYSDATE)-15) FROM PUBLIC;
