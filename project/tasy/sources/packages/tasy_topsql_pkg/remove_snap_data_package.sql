-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



/*  
    Cleanup routine to remove old data from TASY_TOPSQL_SQLAREA
    This procedure uses the column NUMBER_OF_SNAPSHOTS_TO_RETAIN from table TASY_TOPSQL_CONTROL_TAB
*/
CREATE OR REPLACE PROCEDURE tasy_topsql_pkg.remove_snap_data () AS $body$
DECLARE

    l_number_of_snaps_to_retain bigint;
    l_max_nobind_rows_top_keep bigint;
    l_snap_tab_size bigint;


BEGIN
    SELECT
        number_of_snapshots_to_retain,
        max_nobind_rows_top_keep
    INTO STRICT
        l_number_of_snaps_to_retain,
        l_max_nobind_rows_top_keep
    FROM
        tasy_topsql_control_tab LIMIT 1;

    BEGIN
        -- Check the size of table
        SELECT bytes/1024/1024
        INTO STRICT l_snap_tab_size
        FROM user_segments 
        WHERE segment_name = 'TASY_TOPSQL_SQLAREA';
    EXCEPTION
        WHEN no_data_found THEN
            RAISE EXCEPTION '%', 'Table "TASY_TOPSQL_SQLAREA" does not exists: ' || sqlerrm USING ERRCODE = '45013';
    END;
    
    -- If table is bigger than 1GB, truncate all data, skip DELETE command (it would be inneficient)
    IF l_snap_tab_size > 1024 THEN
        EXECUTE 'TRUNCATE TABLE tasy_topsql_sqlarea';
    ELSE
        -- Delete retain N snapshots accordingly to the configuration table attribute
        DELETE FROM tasy_topsql_sqlarea
        WHERE snap_id IN (
            SELECT snap_id
            FROM (
                SELECT snap_id, row_number() OVER (ORDER BY snap_id DESC) AS row_number 
                FROM (
                    SELECT DISTINCT snap_id AS snap_id 
                    FROM tasy_topsql_sqlarea 
                ) alias2
            ) alias3
            WHERE row_number > l_number_of_snaps_to_retain
        );
    END IF;

    BEGIN
        -- Check the size of the table
        SELECT bytes/1024/1024
        INTO STRICT l_snap_tab_size
        FROM user_segments 
        WHERE segment_name = 'TASY_TOPSQL_NOBIND_SQL';
    EXCEPTION
        WHEN no_data_found THEN
            RAISE EXCEPTION '%', 'Table "TASY_TOPSQL_NOBIND_SQL" does not exists: ' || sqlerrm USING ERRCODE = '45014';
    END;
    
    -- If table is bigger than 512MB, truncate all data, skip DELETE command (it would be inneficient)
    IF l_snap_tab_size > 512 THEN
        EXECUTE 'TRUNCATE TABLE tasy_topsql_nobind_sql';
    ELSE
        -- Delete keeps N rows accordingly to the configuration; Older data is removed first (LAST_LOAD_TIME column)
        DELETE FROM tasy_topsql_nobind_sql
        WHERE force_matching_signature IN (
            SELECT force_matching_signature
            FROM (
                SELECT force_matching_signature, row_number() OVER (ORDER BY last_load_time DESC) AS row_number
                FROM (
                    SELECT force_matching_signature, last_load_time
                    FROM tasy_topsql_nobind_sql
                ) alias2
            ) alias3
            WHERE row_number >= l_max_nobind_rows_top_keep
        );
    END IF;
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE tasy_topsql_pkg.remove_snap_data () FROM PUBLIC;
