-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


CREATE TYPE retorno_cabecalhoropape_r AS (
		nr_sequencia			pls_ame_lote_remessa.nr_sequencia%type,
		dt_lote				pls_ame_lote_remessa.dt_lote%type,
		dt_geracao_lote			pls_ame_lote_remessa.dt_geracao_lote%type,
		dt_geracao_arquivos		pls_ame_lote_remessa.dt_geracao_arquivos%type,
		dt_ref_mensalidade		pls_ame_lote_remessa.dt_ref_mensalidade%type,
		vl_total			pls_ame_lote_remessa.vl_total%type,
		nr_seq_regra_layout		pls_ame_regra_arq.nr_sequencia%type,
		ds_descricao			pls_ame_regra_arq.ds_descricao%type,
		nr_inscricao_municipal		pessoa_juridica.nr_inscricao_municipal%type,
		cd_cgc				pessoa_juridica.cd_cgc%type,
		ds_razao_social			pessoa_juridica.ds_razao_social%type,
		nm_fantasia			pessoa_juridica.nm_fantasia%type,
		ds_endereco			pessoa_juridica.ds_endereco%type,
		ds_bairro			pessoa_juridica.ds_bairro%type,
		ds_municipio			pessoa_juridica.ds_municipio%type,
		sg_estado			pessoa_juridica.sg_estado%type
	);


CREATE OR REPLACE PROCEDURE pls_gerar_arquivo_ame_pck.criar_cabecalhorodape ( nr_seq_rem_arq_w pls_ame_lote_rem_arquivo.nr_sequencia%type, nr_banda_w bigint) AS $body$
DECLARE


	type retorno_cabecalhoropape_row	is table of retorno_cabecalhoropape_r index by integer;
	retorno_cabecalhorodape_t		retorno_cabecalhoropape_row;
	
	ds_sql_w		text;
	r_sql_w			REFCURSOR;
	vl_atributo_w		varchar(2000);
	ie_separador_w		varchar(10);
	ds_linha_w		varchar(32767);
	nm_atributo_w		varchar(255)	:= '';
	qt_tamanho_aux_w	bigint;
	ds_function_w		varchar(255);
	vl_atributo_aux_w	varchar(255);
	str			varchar(1);
	ind			bigint;
	
	valor_bind_w			sql_pck.t_dado_bind;
	cursor_w			sql_pck.t_cursor;

BEGIN

	ds_sql_w := ' 
	select	e.nr_sequencia,
		e.dt_lote,
		e.dt_geracao_lote,
		e.dt_geracao_arquivos,
		e.dt_ref_mensalidade,
		e.vl_total,
		g.nr_sequencia nr_seq_regra_layout,
		g.ds_descricao,
		d.nr_inscricao_municipal,
		d.cd_cgc,
		d.ds_razao_social,
		d.nm_fantasia,
		d.ds_endereco,
		d.ds_bairro,
		d.ds_municipio,
		d.sg_estado
	from	pls_ame_lote_rem_arquivo a,
		pls_ame_lote_rem_destino b,
		pls_ame_empresa		c,
		pessoa_juridica		d,
		pls_ame_lote_remessa	e,
		pls_ame_regra_ger_arq f,
		pls_ame_regra_arq g
	where	a.nr_seq_lote_rem_dest	= b.nr_sequencia 
	and	b.nr_seq_ame_empresa	 = c.nr_sequencia
	and	c.cd_cgc		 = d.cd_cgc
	and	b.nr_seq_lote_rem	 = e.nr_sequencia
	and	a.nr_seq_regra_ger_arquivo = f.nr_sequencia
	and	f.nr_seq_regra_layout = g.nr_sequencia
	and	a.nr_sequencia		 = ' || nr_seq_rem_arq_w;

	open r_sql_w for EXECUTE ds_sql_w;
	loop
		fetch r_sql_w bulk collect into retorno_cabecalhorodape_t;
		exit when retorno_cabecalhorodape_t.count = 0;
		
		ds_linha_w := '';
		
		PERFORM set_config('pls_gerar_arquivo_ame_pck.qt_nr_linha_w', current_setting('pls_gerar_arquivo_ame_pck.qt_nr_linha_w')::bigint + 1, false);
		PERFORM set_config('pls_gerar_arquivo_ame_pck.nr_linha_w', current_setting('pls_gerar_arquivo_ame_pck.nr_linha_w')::bigint + 1, false);
		
		for y in current_setting('pls_gerar_arquivo_ame_pck.pls_ame_regra_atrib_t')::pls_ame_regra_atrib_row.first .. current_setting('pls_gerar_arquivo_ame_pck.pls_ame_regra_atrib_t')::pls_ame_regra_atrib_row.last loop
		
			vl_atributo_w := null;
		
			if (current_setting('pls_gerar_arquivo_ame_pck.pls_ame_regra_banda_t')::pls_ame_regra_banda_row[nr_banda_w].nr_sequencia = current_setting('pls_gerar_arquivo_ame_pck.pls_ame_regra_atrib_t')::pls_ame_regra_atrib_row[y].nr_seq_banda) then
				
				-- Nome do Atributo para mensagens de erro

				nm_atributo_w := obter_valor_dominio(9036, current_setting('pls_gerar_arquivo_ame_pck.pls_ame_regra_atrib_t')::pls_ame_regra_atrib_row[y].cd_atributo);
				
				-- ifs para coletar valores.

				if (current_setting('pls_gerar_arquivo_ame_pck.pls_ame_regra_atrib_t')::pls_ame_regra_atrib_row[y].cd_atributo = 1) then
					vl_atributo_w := current_setting('pls_gerar_arquivo_ame_pck.pls_ame_regra_atrib_t')::pls_ame_regra_atrib_row[y].vl_padrao;
				elsif (current_setting('pls_gerar_arquivo_ame_pck.pls_ame_regra_atrib_t')::pls_ame_regra_atrib_row[y].cd_atributo = 2) then
					vl_atributo_w := retorno_cabecalhorodape_t[1].nr_sequencia;
				elsif (current_setting('pls_gerar_arquivo_ame_pck.pls_ame_regra_atrib_t')::pls_ame_regra_atrib_row[y].cd_atributo = 3) then
					vl_atributo_w := to_char(retorno_cabecalhorodape_t[1].dt_lote, 'dd/mm/yyyy');
				elsif (current_setting('pls_gerar_arquivo_ame_pck.pls_ame_regra_atrib_t')::pls_ame_regra_atrib_row[y].cd_atributo = 4) then
					vl_atributo_w := to_char(retorno_cabecalhorodape_t[1].dt_geracao_lote, 'dd/mm/yyyy');
				elsif (current_setting('pls_gerar_arquivo_ame_pck.pls_ame_regra_atrib_t')::pls_ame_regra_atrib_row[y].cd_atributo = 6) then
					vl_atributo_w := to_char(retorno_cabecalhorodape_t[1].dt_geracao_arquivos, 'dd/mm/yyyy');
				elsif (current_setting('pls_gerar_arquivo_ame_pck.pls_ame_regra_atrib_t')::pls_ame_regra_atrib_row[y].cd_atributo = 5) then
					vl_atributo_w := to_char(retorno_cabecalhorodape_t[1].dt_ref_mensalidade, 'dd/mm/yyyy');
				elsif (current_setting('pls_gerar_arquivo_ame_pck.pls_ame_regra_atrib_t')::pls_ame_regra_atrib_row[y].cd_atributo = 7) then
					vl_atributo_w := retorno_cabecalhorodape_t[1].vl_total;
				elsif (current_setting('pls_gerar_arquivo_ame_pck.pls_ame_regra_atrib_t')::pls_ame_regra_atrib_row[y].cd_atributo = 8) then
					if (current_setting('pls_gerar_arquivo_ame_pck.pls_ame_regra_atrib_t')::pls_ame_regra_atrib_row[y].cd_tipo_atributo = 'C') then
						vl_atributo_w := retorno_cabecalhorodape_t[1].nr_seq_regra_layout;
					else
						vl_atributo_w := retorno_cabecalhorodape_t[1].ds_descricao;
					end if;
				elsif (current_setting('pls_gerar_arquivo_ame_pck.pls_ame_regra_atrib_t')::pls_ame_regra_atrib_row[y].cd_atributo = 9) then
					vl_atributo_w := retorno_cabecalhorodape_t[1].cd_cgc;
				elsif (current_setting('pls_gerar_arquivo_ame_pck.pls_ame_regra_atrib_t')::pls_ame_regra_atrib_row[y].cd_atributo = 10) then
					vl_atributo_w := retorno_cabecalhorodape_t[1].ds_razao_social;
				elsif (current_setting('pls_gerar_arquivo_ame_pck.pls_ame_regra_atrib_t')::pls_ame_regra_atrib_row[y].cd_atributo = 11) then
					vl_atributo_w := retorno_cabecalhorodape_t[1].nm_fantasia;
				elsif (current_setting('pls_gerar_arquivo_ame_pck.pls_ame_regra_atrib_t')::pls_ame_regra_atrib_row[y].cd_atributo = 12) then
					vl_atributo_w := retorno_cabecalhorodape_t[1].ds_endereco;
				elsif (current_setting('pls_gerar_arquivo_ame_pck.pls_ame_regra_atrib_t')::pls_ame_regra_atrib_row[y].cd_atributo = 13) then
					vl_atributo_w := retorno_cabecalhorodape_t[1].ds_bairro;
				elsif (current_setting('pls_gerar_arquivo_ame_pck.pls_ame_regra_atrib_t')::pls_ame_regra_atrib_row[y].cd_atributo = 14) then
					vl_atributo_w := retorno_cabecalhorodape_t[1].ds_municipio;
				elsif (current_setting('pls_gerar_arquivo_ame_pck.pls_ame_regra_atrib_t')::pls_ame_regra_atrib_row[y].cd_atributo = 15) then
					if (current_setting('pls_gerar_arquivo_ame_pck.pls_ame_regra_atrib_t')::pls_ame_regra_atrib_row[y].cd_tipo_atributo = 'C') then
						vl_atributo_w := retorno_cabecalhorodape_t[1].sg_estado;
					else
						vl_atributo_w := obter_valor_dominio(50, retorno_cabecalhorodape_t[1].sg_estado);
					end if;
				elsif (current_setting('pls_gerar_arquivo_ame_pck.pls_ame_regra_atrib_t')::pls_ame_regra_atrib_row[y].cd_atributo = 16) then
					vl_atributo_w := retorno_cabecalhorodape_t[1].nr_inscricao_municipal;
				elsif (current_setting('pls_gerar_arquivo_ame_pck.pls_ame_regra_atrib_t')::pls_ame_regra_atrib_row[y].cd_atributo = 17) then
					-- Arquivo quantidade de linhas

					vl_atributo_w := current_setting('pls_gerar_arquivo_ame_pck.qt_nr_linha_w')::bigint;
				elsif (current_setting('pls_gerar_arquivo_ame_pck.pls_ame_regra_atrib_t')::pls_ame_regra_atrib_row[y].cd_atributo = 18) then
					-- Arquivo quantidade de linhas (detalhe)

					vl_atributo_w := current_setting('pls_gerar_arquivo_ame_pck.qt_nr_linha_detalhe_w')::bigint;
				elsif (current_setting('pls_gerar_arquivo_ame_pck.pls_ame_regra_atrib_t')::pls_ame_regra_atrib_row[y].cd_atributo = 19) then
					-- Arquivo Numero da linha.

					vl_atributo_w := current_setting('pls_gerar_arquivo_ame_pck.nr_linha_w')::bigint;
				elsif (current_setting('pls_gerar_arquivo_ame_pck.pls_ame_regra_atrib_t')::pls_ame_regra_atrib_row[y].cd_atributo = 20) then
				
					ds_function_w := ' select ' || upper(current_setting('pls_gerar_arquivo_ame_pck.pls_ame_regra_atrib_t')::pls_ame_regra_atrib_row[y].ds_function) || ' from dual where rownum = 1 ';
					
					valor_bind_w := sql_pck.bind_variable(':NR_SEQ_LOTE', retorno_cabecalhorodape_t[1].nr_sequencia, valor_bind_w);
					valor_bind_w := sql_pck.executa_sql_cursor(ds_function_w, valor_bind_w);
					
					fetch	cursor_w into	vl_atributo_w;
					
				end if;
				
				-- Aplica mascara ao valor do atributo

				if (current_setting('pls_gerar_arquivo_ame_pck.pls_ame_regra_atrib_t')::pls_ame_regra_atrib_row[y].cd_atributo in (3,4,5,6)) then
					-- Datas

					if ((vl_atributo_w IS NOT NULL AND vl_atributo_w::text <> '') and current_setting('pls_gerar_arquivo_ame_pck.pls_ame_regra_atrib_t')::pls_ame_regra_atrib_row[y](.ds_mascara IS NOT NULL AND .ds_mascara::text <> '')) then
					begin
						-- Aplica a mascara

						if (vl_atributo_w IS NOT NULL AND vl_atributo_w::text <> '') then
							vl_atributo_w := to_char(to_date(vl_atributo_w), current_setting('pls_gerar_arquivo_ame_pck.pls_ame_regra_atrib_t')::pls_ame_regra_atrib_row[y].ds_mascara);
						end if;
					exception
						when others then
							CALL wheb_mensagem_pck.exibir_mensagem_abort('A ' || lower(obter_desc_expressao(292909)) || ' ''' || current_setting('pls_gerar_arquivo_ame_pck.pls_ame_regra_atrib_t')::pls_ame_regra_atrib_row[y].ds_mascara
												|| ''' ' || chr(233) || ' ' || lower(obter_desc_expressao(796824)) || ' para o campo ''' || nm_atributo_w || '''.');
					end;
					end if;
				elsif (current_setting('pls_gerar_arquivo_ame_pck.pls_ame_regra_atrib_t')::pls_ame_regra_atrib_row[y].cd_atributo in (7))then
					vl_atributo_w := replace(campo_mascara(vl_atributo_w, 2), '.', current_setting('pls_gerar_arquivo_ame_pck.pls_ame_regra_atrib_t')::pls_ame_regra_atrib_row[y].ds_mascara);
				else
					-- Demais atributos

					if ((vl_atributo_w IS NOT NULL AND vl_atributo_w::text <> '') and current_setting('pls_gerar_arquivo_ame_pck.pls_ame_regra_atrib_t')::pls_ame_regra_atrib_row[y](.ds_mascara IS NOT NULL AND .ds_mascara::text <> '')) then
						-- Inicia variaveis

		--				qt_tamanho_aux_w	:= regexp_count(pls_ame_regra_atrib_t(i).ds_mascara, '[A-Z,0-9]', 1, 'i');

						qt_tamanho_aux_w	:= length(current_setting('pls_gerar_arquivo_ame_pck.pls_ame_regra_atrib_t')::pls_ame_regra_atrib_row[y].ds_mascara) - coalesce(length(regexp_replace( current_setting('pls_gerar_arquivo_ame_pck.pls_ame_regra_atrib_t')::pls_ame_regra_atrib_row[y].ds_mascara, '[A-Z,0-9]', null)), 0 );
						vl_atributo_aux_w	:= '';
						str			:= '';
						ind			:= 1;
						
						-- Preenche com caracteres para completar o tamanho do atributo

						if (current_setting('pls_gerar_arquivo_ame_pck.pls_ame_regra_atrib_t')::pls_ame_regra_atrib_row[y](.cd_caracter_complementar IS NOT NULL AND .cd_caracter_complementar::text <> '')) then
							if (current_setting('pls_gerar_arquivo_ame_pck.pls_ame_regra_atrib_t')::pls_ame_regra_atrib_row[y].ie_posicao_complementar = 'L') then
								vl_atributo_w := lpad(vl_atributo_w, qt_tamanho_aux_w, current_setting('pls_gerar_arquivo_ame_pck.pls_ame_regra_atrib_t')::pls_ame_regra_atrib_row[y].cd_caracter_complementar);
							elsif (current_setting('pls_gerar_arquivo_ame_pck.pls_ame_regra_atrib_t')::pls_ame_regra_atrib_row[y].ie_posicao_complementar = 'R') then
								vl_atributo_w := rpad(vl_atributo_w, qt_tamanho_aux_w, current_setting('pls_gerar_arquivo_ame_pck.pls_ame_regra_atrib_t')::pls_ame_regra_atrib_row[y].cd_caracter_complementar);
							end if;
						end if;
						
						-- Aplica a mascara

						for j in 1..length(current_setting('pls_gerar_arquivo_ame_pck.pls_ame_regra_atrib_t')::pls_ame_regra_atrib_row[y].ds_mascara) loop
							str := substr(current_setting('pls_gerar_arquivo_ame_pck.pls_ame_regra_atrib_t')::pls_ame_regra_atrib_row[y].ds_mascara, j, 1);
							if (regexp_like(str, '[A-Z,0-9]')) then
								vl_atributo_aux_w := vl_atributo_aux_w || substr(vl_atributo_w, ind, 1);
								ind := ind + 1;
							else
								vl_atributo_aux_w := vl_atributo_aux_w || str;
							end if;
						end loop;
						vl_atributo_w := vl_atributo_aux_w;
					end if;
				end if;
				
				-- Maiusculas e minusculas

				if (current_setting('pls_gerar_arquivo_ame_pck.pls_ame_regra_atrib_t')::pls_ame_regra_atrib_row[y].ie_letras_valor = 'U') then
					vl_atributo_w := upper(vl_atributo_w);
				elsif (current_setting('pls_gerar_arquivo_ame_pck.pls_ame_regra_atrib_t')::pls_ame_regra_atrib_row[y].ie_letras_valor = 'L') then
					vl_atributo_w := lower(vl_atributo_w);
				end if;
				
				-- Valor inicial fixo

				if (current_setting('pls_gerar_arquivo_ame_pck.pls_ame_regra_atrib_t')::pls_ame_regra_atrib_row[y](.vl_fixo_inicio IS NOT NULL AND .vl_fixo_inicio::text <> '')) then
					vl_atributo_w := current_setting('pls_gerar_arquivo_ame_pck.pls_ame_regra_atrib_t')::pls_ame_regra_atrib_row[y].vl_fixo_inicio || vl_atributo_w;
				end if;
				
				-- Valor padrao caso nao tiver valor.

				if (coalesce(vl_atributo_w::text, '') = '') then
					begin
						vl_atributo_w := current_setting('pls_gerar_arquivo_ame_pck.pls_ame_regra_atrib_t')::pls_ame_regra_atrib_row[y].vl_padrao;
					end;
				end if;
			
				-- busca separador se tiver no atributo.

				ie_separador_w := coalesce(current_setting('pls_gerar_arquivo_ame_pck.pls_ame_regra_banda_t')::pls_ame_regra_banda_row[nr_banda_w].ie_separador, '');
					
				-- Ajusta ao tamanho do valor do atributo

				if (current_setting('pls_gerar_arquivo_ame_pck.pls_ame_regra_atrib_t')::pls_ame_regra_atrib_row[y](.qt_tamanho IS NOT NULL AND .qt_tamanho::text <> '')) then
					-- Se possui caracter e posicao, completa o valor do atributo

					if (current_setting('pls_gerar_arquivo_ame_pck.pls_ame_regra_atrib_t')::pls_ame_regra_atrib_row[y](.cd_caracter_complementar IS NOT NULL AND .cd_caracter_complementar::text <> '')) then
						if (current_setting('pls_gerar_arquivo_ame_pck.pls_ame_regra_atrib_t')::pls_ame_regra_atrib_row[y].ie_posicao_complementar = 'L') then
							vl_atributo_w := lpad(coalesce(vl_atributo_w, current_setting('pls_gerar_arquivo_ame_pck.pls_ame_regra_atrib_t')::pls_ame_regra_atrib_row[y].cd_caracter_complementar), current_setting('pls_gerar_arquivo_ame_pck.pls_ame_regra_atrib_t')::pls_ame_regra_atrib_row[y].qt_tamanho, current_setting('pls_gerar_arquivo_ame_pck.pls_ame_regra_atrib_t')::pls_ame_regra_atrib_row[y].cd_caracter_complementar);
						elsif (current_setting('pls_gerar_arquivo_ame_pck.pls_ame_regra_atrib_t')::pls_ame_regra_atrib_row[y].ie_posicao_complementar = 'R') then
							vl_atributo_w := rpad(coalesce(vl_atributo_w, current_setting('pls_gerar_arquivo_ame_pck.pls_ame_regra_atrib_t')::pls_ame_regra_atrib_row[y].cd_caracter_complementar), current_setting('pls_gerar_arquivo_ame_pck.pls_ame_regra_atrib_t')::pls_ame_regra_atrib_row[y].qt_tamanho, current_setting('pls_gerar_arquivo_ame_pck.pls_ame_regra_atrib_t')::pls_ame_regra_atrib_row[y].cd_caracter_complementar);
						end if;
					end if;
					
					vl_atributo_w := substr(vl_atributo_w, 1, current_setting('pls_gerar_arquivo_ame_pck.pls_ame_regra_atrib_t')::pls_ame_regra_atrib_row[y].qt_tamanho);
				end if;
				
				if (length(ds_linha_w) > 0) then
					ds_linha_w := ds_linha_w || ie_separador_w || vl_atributo_w;
				else
					ds_linha_w := vl_atributo_w;
				end if;
			end if;
		end loop;

		if (current_setting('pls_gerar_arquivo_ame_pck.ie_origem_w')::varchar(1) = 'H') then
			insert into pls_ame_export_arq(nr_seq_lote_rem_arquivo, ds_conteudo, nr_ordem, dt_atualizacao, nm_usuario) values (nr_seq_rem_arq_w, ds_linha_w, current_setting('pls_gerar_arquivo_ame_pck.nr_linha_w')::bigint, clock_timestamp(), current_setting('pls_gerar_arquivo_ame_pck.nm_usuario_w')::usuario.nm_usuario%type);
		elsif (current_setting('pls_gerar_arquivo_ame_pck.ie_origem_w')::varchar(1) = 'D') then
			utl_file.put_line(current_setting('pls_gerar_arquivo_ame_pck.arq_texto_w')::utl_file.file_type,ds_linha_w || chr(13));
			utl_file.fflush(current_setting('pls_gerar_arquivo_ame_pck.arq_texto_w')::utl_file.file_type);
		end if;
		end loop;
	close r_sql_w;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_arquivo_ame_pck.criar_cabecalhorodape ( nr_seq_rem_arq_w pls_ame_lote_rem_arquivo.nr_sequencia%type, nr_banda_w bigint) FROM PUBLIC;
