-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_gerar_arquivo_ame_pck.carregar_regra (nr_seq_regra_p pls_ame_regra_arq.nr_sequencia%type) AS $body$
DECLARE


pls_ame_regra_banda_w	pls_ame_regra_banda_row;
pls_ame_regra_atrib_w	pls_ame_regra_atrib_row;

-- Banda

c02 CURSOR FOR
	SELECT	a.nr_sequencia,
		a.ie_tipo_banda,
		a.ie_somente_titular,
		a.ie_soma_valor_familia,
		a.nr_ordem,
		a.ie_separador
	from	pls_ame_regra_banda	a
	where	a.nr_seq_regra = nr_seq_regra_p
	order by
		a.ie_tipo_banda;
	
-- Atributos

c03 CURSOR FOR
	SELECT	a.nr_sequencia,
		a.nr_ordem,
		a.cd_atributo,
		a.vl_padrao,
		a.cd_tipo_atributo,
		a.vl_fixo_inicio,
		a.qt_tamanho,
		a.cd_caracter_complementar,
		a.ie_posicao_complementar,
		a.ds_mascara,
		a.ie_letras_valor,
		a.ds_function,
		a.nr_seq_banda,
		a.nr_ordem_resultado,
		coalesce(a.ie_exibir_atributo, 'S') ie_exibir_atributo
	from	pls_ame_regra_atrib	a,
		pls_ame_regra_banda	b
	where	b.nr_sequencia = a.nr_seq_banda
	and	b.nr_seq_regra = nr_seq_regra_p
	order by
		a.nr_ordem;

BEGIN

select	*
into STRICT	current_setting('pls_gerar_arquivo_ame_pck.pls_ame_regra_arq_w')::pls_ame_regra_arq%rowtype
from	pls_ame_regra_arq a
where	a.nr_sequencia	= nr_seq_regra_p;

-- Carrega as bandas da regra em um vetor global

current_setting('pls_gerar_arquivo_ame_pck.pls_ame_regra_banda_t')::pls_ame_regra_banda_row.delete;
open c02;
loop
	fetch c02 bulk collect into pls_ame_regra_banda_w;
	exit when pls_ame_regra_banda_w.count = 0;
	PERFORM set_config('pls_gerar_arquivo_ame_pck.pls_ame_regra_banda_t', pls_ame_regra_banda_w, false);
end loop;
close c02;

-- Carrega os atributos da banda em um vetor global

current_setting('pls_gerar_arquivo_ame_pck.pls_ame_regra_atrib_t')::pls_ame_regra_atrib_row.delete;
open c03;
loop
	fetch c03 bulk collect into pls_ame_regra_atrib_w;
	exit when pls_ame_regra_atrib_w.count = 0;
	PERFORM set_config('pls_gerar_arquivo_ame_pck.pls_ame_regra_atrib_t', pls_ame_regra_atrib_w, false);
end loop;
close c03;

if (current_setting('pls_gerar_arquivo_ame_pck.pls_ame_regra_banda_t')::pls_ame_regra_banda_row.count = 0) then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(1057729, 'NR_SEQ_REGRA_P=' || nr_seq_regra_p);
end if;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_arquivo_ame_pck.carregar_regra (nr_seq_regra_p pls_ame_regra_arq.nr_sequencia%type) FROM PUBLIC;
