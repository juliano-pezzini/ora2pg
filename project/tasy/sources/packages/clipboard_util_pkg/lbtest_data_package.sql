-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION clipboard_util_pkg.lbtest_data ( nr_atendimento_p bigint, nr_prescricao_p bigint, field_p text, nr_seq_interno_p bigint, cd_procedimento_p bigint, nr_exam_p bigint ) RETURNS varchar AS $body$
DECLARE


        return_data_w     varchar(32000);
        test_name_w       varchar(32000);
        dt_colec_w        varchar(32000);
        test_item_w       varchar(32000);
        result_w          varchar(32000);
        result_cncl_w     varchar(32000);
        lab_test_nm       varchar(32000);
        sub_test_name_w   varchar(32000);
        cur CURSOR FOR
        SELECT
            result.dt_coleta,
            c.nm_exame,
            c.cd_exame_integracao,
            result.qt_resultado,
            clipboard_util_pkg.format_string(coalesce(c.nm_exame, 'NA'), 1) test_name_w,
            clipboard_util_pkg.format_string(coalesce(obter_desc_exame(result.nr_seq_exame), 'NA'), 2) sub_test_name_w,
            clipboard_util_pkg.format_string(coalesce(obter_desc_exame(result.nr_seq_exame), 'NA'), 2)
            || clipboard_util_pkg.format_string(coalesce(to_char(result.dt_coleta), 'NA'), 3) dt_colec_w,
            clipboard_util_pkg.format_string(coalesce(obter_desc_exame(result.nr_seq_exame), 'NA'), 2)
            || clipboard_util_pkg.format_string(coalesce(to_char(result.dt_coleta), 'NA'), 3)
            || clipboard_util_pkg.format_string(coalesce(c.cd_exame_integracao, 'NA'), 4) test_item_w,
            clipboard_util_pkg.format_string(coalesce(obter_desc_exame(result.nr_seq_exame), 'NA'), 2)
            || clipboard_util_pkg.format_string(coalesce(to_char(result.dt_coleta), 'NA'), 3)
            || clipboard_util_pkg.format_string(coalesce(c.cd_exame_integracao, 'NA'), 4)
            || clipboard_util_pkg.format_string(coalesce(to_char(coalesce(coalesce(to_char(result.qt_resultado), to_char(result.ds_resultado)), to_char(result.pr_resultado))), 'NA'), 5) result_w,
            substr(convert_long_to_varchar2('DS_RESULTADO','RESULT_LABORATORIO', 'NR_SEQUENCIA = ' || result_lab.NR_SEQUENCIA),1,4000) result_cncl_w

        FROM
            exame_laboratorio       c, 
            prescr_procedimento     b,
            prescr_medica           a, 
            exame_lab_result_item   result,
            exame_lab_resultado     lres,
            result_laboratorio      result_lab
        WHERE
            b.nr_prescricao = a.nr_prescricao
            AND b.nr_seq_exame = c.nr_seq_exame
            AND a.nr_atendimento = nr_atendimento_p
            AND b.nr_prescricao = nr_prescricao_p
            AND lres.nr_prescricao = a.nr_prescricao
            AND result_lab.nr_seq_prescricao = b.nr_sequencia
            AND result_lab.nr_prescricao = b.nr_prescricao
            AND lres.nr_prescricao = a.nr_prescricao
            AND lres.nr_seq_resultado = result.nr_seq_resultado
            AND result.nr_seq_prescr = b.nr_sequencia
             and  b.NR_SEQ_INTERNO=nr_seq_interno_p
             and  b.cd_procedimento=cd_procedimento_p
             and b.NR_SEQ_EXAME=nr_exam_p
            AND b.ie_status_atend > 30;


    
BEGIN
        FOR i IN cur LOOP
            lab_test_nm := i.nm_exame;
            IF ( field_p = 'TEST_NAME' ) THEN
                return_data_w := '';
                return_data_w := i.test_name_w
                                 || '<br/>'
                                 || i.sub_test_name_w
                                 || '<br/>';
            END IF;

            IF ( field_p = 'COL_DATE' ) THEN
                return_data_w := return_data_w
                                 || i.dt_colec_w
                                 || '<br/>';
            END IF;

            IF ( field_p = 'TEST_ITEMS' ) THEN
                return_data_w := return_data_w
                                 || i.test_item_w
                                 || '<br/>';
            END IF;

            IF ( field_p = 'TEST_RESULTS' ) THEN
                return_data_w := return_data_w || i.result_w;
            END IF;

            IF ( field_p = 'TEST_CONCL' ) THEN
                return_data_w := return_data_w
                                 || i.result_w
                                 || substr(clipboard_util_pkg.format_string(coalesce(i.result_cncl_w, 'NA'), 6),1,4000)
                                 || '<br/>';
            END IF;

        END LOOP;

        RETURN substr('<b>'
                      || lab_test_nm
                      || '</b>'
                      || '<br/>'
                      || return_data_w||'<br/>', 1, 4000);

    END;


$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION clipboard_util_pkg.lbtest_data ( nr_atendimento_p bigint, nr_prescricao_p bigint, field_p text, nr_seq_interno_p bigint, cd_procedimento_p bigint, nr_exam_p bigint ) FROM PUBLIC;
