-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION clipboard_util_pkg.get_content_trans_hist ( nr_atendimento_p bigint, nr_sequencia_p text, ie_record_type_p text, config_option_p bigint ) RETURNS varchar AS $body$
DECLARE


        ds_content_w      varchar(32000);
        onst_y_m_w        varchar(500);
        age_w             varchar(100);
        medic_hist_w      varchar(500);
        hosp_w            varchar(500);
        pessoa_fisica_w   varchar(1000);
        c01 CURSOR FOR
        SELECT
            *
        FROM
            TABLE( clipboard_util_pkg.get_clipboard_rule(ie_record_type_p) )
        WHERE
            nr_seq = config_option_p
        ORDER BY
            nr_seq_display ASC;


  i RECORD;
BEGIN
        SELECT
            cd_pessoa_fisica
        INTO STRICT pessoa_fisica_w
        FROM
            atendimento_paciente
        WHERE
            nr_atendimento = nr_atendimento_p;

        FOR i IN (WITH RECURSIVE cte AS (

            SELECT
                regexp_substr(nr_sequencia_p, '[^,]+', 1, level) AS data_w

            (regexp_substr(nr_sequencia_p, '[^,]+', 1, level) IS NOT NULL AND (regexp_substr(nr_sequencia_p, '[^,]+', 1, level))::text <> '')
          UNION ALL

            SELECT
                regexp_substr(nr_sequencia_p, '[^,]+', 1, level) AS data_w
            
            (regexp_substr(nr_sequencia_p, '[^,]+', 1, level) IS NOT NULL AND (regexp_substr(nr_sequencia_p, '[^,]+', 1, level))::text <> '')
         JOIN cte c ON ()

) SELECT * FROM cte;
) LOOP
            SELECT
                to_char(a.dt_transfusao, 'YYYY')
                || ' '
                || to_char(a.dt_transfusao, 'MM'),
                abs(round((clock_timestamp() - to_date(b.dt_nascimento)) / 365)),
                obter_desc_san_derivado(a.nr_seq_derivado),
                '('
                || obter_desc_expressao(300409)
                || ')'
            INTO STRICT
                onst_y_m_w,
                age_w,
                medic_hist_w,
                hosp_w
            FROM
                paciente_transfusao   a,
                pessoa_fisica         b
            WHERE
                a.cd_pessoa_fisica = b.cd_pessoa_fisica
                AND a.cd_pessoa_fisica = clipboard_util_pkg.get_pessao_fisica(nr_atendimento_p)
                AND a.nr_sequencia = i.data_w;

            FOR r_c01 IN c01 LOOP IF ( ie_record_type_p = 'TRANS_HIST' ) THEN
                IF ( r_c01.ie_field = 'AGE' ) THEN
                    IF (age_w IS NOT NULL AND age_w::text <> '') THEN
                        ds_content_w := ds_content_w
                                        || '</br>'
                                        || coalesce(r_c01.nm_field, r_c01.ds_expressao)
                                        || ' - '
                                        || age_w;

                    END IF;
                END IF;

                IF ( r_c01.ie_field = 'MEDI_HIST' ) THEN
                    IF (hosp_w IS NOT NULL AND hosp_w::text <> '') THEN
                        ds_content_w := ds_content_w
                                        || '</br>'
                                        || coalesce(r_c01.nm_field, r_c01.ds_expressao)
                                        || ' - '
                                        || hosp_w;

                    END IF;

                END IF;

                IF ( r_c01.ie_field = 'ONSET_Y_M' ) THEN
                    IF ( (onst_y_m_w IS NOT NULL AND onst_y_m_w::text <> '') AND position(' ' in onst_y_m_w) != 1 ) THEN
                        ds_content_w := ds_content_w
                                        || '</br>'
                                        || coalesce(r_c01.nm_field, r_c01.ds_expressao)
                                        || ' - '
                                        || onst_y_m_w;

                    END IF;
                END IF;

                IF ( r_c01.ie_field = 'OUTCOME' ) THEN
                    IF (medic_hist_w IS NOT NULL AND medic_hist_w::text <> '') THEN
                        ds_content_w := ds_content_w
                                        || '</br>'
                                        || coalesce(r_c01.nm_field, r_c01.ds_expressao)
                                        || ' - '
                                        || medic_hist_w;

                    END IF;
                END IF;

            END IF;
            END LOOP;

            ds_content_w := ds_content_w || '</br>';
        END LOOP;

        RETURN ds_content_w;
    END;


$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION clipboard_util_pkg.get_content_trans_hist ( nr_atendimento_p bigint, nr_sequencia_p text, ie_record_type_p text, config_option_p bigint ) FROM PUBLIC;
