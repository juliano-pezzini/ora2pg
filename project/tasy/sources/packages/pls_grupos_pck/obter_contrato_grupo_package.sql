-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pls_grupos_pck.obter_contrato_grupo ( nr_seq_grupo_contrato_p pls_preco_grupo_contrato.nr_sequencia%type, nr_seq_contrato_p pls_preco_contrato.nr_seq_contrato%type default null, nr_seq_intercambio_p pls_preco_contrato.nr_seq_intercambio%type default null, ie_modo_retorno_p text default 'TODOS_SE_FILTRO_NULL') RETURNS SETOF PLS_GRUPOS_PCK.T_CONTRATO_GRUPO_DATA AS $body$
DECLARE


t_contrato_grupo_row_w	t_contrato_grupo_row;

C01 CURSOR(	nr_seq_grupo_contrato_pc	pls_preco_grupo_contrato.nr_sequencia%type,
		nr_seq_contrato_pc		pls_preco_contrato.nr_seq_contrato%type,
		nr_seq_intercambio_pc		pls_preco_contrato.nr_seq_intercambio%type,
		ie_modo_retorno_pc		text) FOR
	--retorna todos os cotratos e intercambio do grupo
	SELECT 	a.nr_seq_contrato,
		a.nr_seq_intercambio
	from	pls_preco_grupo_contrato b,
		pls_preco_contrato a
	where	b.nr_sequencia 		= nr_seq_grupo_contrato_pc
	and	b.ie_situacao 		= 'A'
	and	a.nr_seq_grupo 		= b.nr_sequencia
	and	coalesce(nr_seq_contrato_pc::text, '') = ''
	and	coalesce(nr_seq_intercambio_pc::text, '') = ''
	-- só retona todos os registros se for configurado para isso
	-- isso previne situações onde se usa essa package para validação se determinado contrato existe ou não na estrutura
	and	ie_modo_retorno_pc	= 'TODOS_SE_FILTRO_NULL'
	
union all
  --retorna apenas o contrato caso passado no parametro
	SELECT 	a.nr_seq_contrato,
		a.nr_seq_intercambio
	from	pls_preco_grupo_contrato b,
		pls_preco_contrato a
	where	b.nr_sequencia 		= nr_seq_grupo_contrato_pc
	and	b.ie_situacao 		= 'A'
	and	a.nr_seq_grupo 		= b.nr_sequencia
	and	a.nr_seq_contrato 	= nr_seq_contrato_pc
	and	coalesce(nr_seq_intercambio_pc::text, '') = ''
	
union all
  --retorna apenas o intercambio caso passado no parametro
	select 	a.nr_seq_contrato,
		a.nr_seq_intercambio
	from	pls_preco_grupo_contrato b,
		pls_preco_contrato a
	where	b.nr_sequencia 		= nr_seq_grupo_contrato_pc
	and	b.ie_situacao 		= 'A'
	and	a.nr_seq_grupo 		= b.nr_sequencia
	and	a.nr_seq_intercambio 	= nr_seq_intercambio_pc
	and	coalesce(nr_seq_contrato_pc::text, '') = '';

BEGIN
--verifica se o grupo foi informado  caso contrário não retorna nada
if (nr_seq_grupo_contrato_p IS NOT NULL AND nr_seq_grupo_contrato_p::text <> '') then

	for	r_C01_w in C01(nr_seq_grupo_contrato_p, nr_seq_contrato_p, nr_seq_intercambio_p, ie_modo_retorno_p) loop
		--se o retorno for um contato alienta a informação do contrato
		if (r_C01_w.nr_seq_contrato IS NOT NULL AND r_C01_w.nr_seq_contrato::text <> '') then

			t_contrato_grupo_row_w.nr_seq_contrato 	    := r_C01_w.nr_seq_contrato;
			t_contrato_grupo_row_w.nr_seq_intercambio   := null;
			RETURN NEXT t_contrato_grupo_row_w;

		--se for interncambio alimenta a informação de intercambio
		elsif (r_C01_w.nr_seq_intercambio IS NOT NULL AND r_C01_w.nr_seq_intercambio::text <> '') then

			t_contrato_grupo_row_w.nr_seq_intercambio := r_C01_w.nr_seq_intercambio;
			t_contrato_grupo_row_w.nr_seq_contrato 	  := null;
			RETURN NEXT t_contrato_grupo_row_w;

		end if;
	end loop;
end if;
--nao retorna nada
return;
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pls_grupos_pck.obter_contrato_grupo ( nr_seq_grupo_contrato_p pls_preco_grupo_contrato.nr_sequencia%type, nr_seq_contrato_p pls_preco_contrato.nr_seq_contrato%type default null, nr_seq_intercambio_p pls_preco_contrato.nr_seq_intercambio%type default null, ie_modo_retorno_p text default 'TODOS_SE_FILTRO_NULL') FROM PUBLIC;
