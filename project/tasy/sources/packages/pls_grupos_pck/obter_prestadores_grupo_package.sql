-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pls_grupos_pck.obter_prestadores_grupo ( nr_seq_grupo_p pls_preco_grupo_prestador.nr_sequencia%type, nr_seq_prestador_p pls_prestador.nr_sequencia%type default null) RETURNS SETOF PLS_GRUPOS_PCK.T_PLS_PRECO_PRESTADOR_DATA AS $body$
DECLARE


/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade:  Retorna uma seleção com todos os prestadores que fazem parte do grupo especificado.
-------------------------------------------------------------------------------------------------------------------
Locais de chamada direta:
[ X]  Objetos do dicionário [ ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatórios [ ] Outros:
 ------------------------------------------------------------------------------------------------------------------
Pontos de atenção:


Alterações:
------------------------------------------------------------------------------------------------------------------
jjung OS 601441 11/06/2013 -	Criação da function
------------------------------------------------------------------------------------------------------------------
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
t_pls_preco_prestador_row_w	pls_grupos_pck.t_pls_preco_prestador_row;

C01 CURSOR(	nr_seq_grupo_pc		pls_preco_grupo_prestador.nr_sequencia%type)FOR
	SELECT	a.nr_seq_prestador,
		a.nr_seq_classificacao
	from	pls_preco_prestador	a
	where	a.nr_seq_grupo = nr_seq_grupo_pc;

C02 CURSOR(	nr_seq_classificacao_pc	pls_prestador.nr_seq_classificacao%type,
		nr_seq_prestador_pc	pls_prestador.nr_sequencia%type) FOR
	SELECT	a.nr_sequencia nr_seq_prestador
	from	pls_prestador a
	where	a.nr_seq_classificacao = nr_seq_classificacao_pc
	and	coalesce(nr_seq_prestador_pc::text, '') = ''
	
union all

	SELECT	a.nr_sequencia nr_seq_prestador
	from	pls_prestador a
	where	a.nr_sequencia = nr_seq_prestador_pc
	and	a.nr_seq_classificacao = nr_seq_classificacao_pc;

C03 CURSOR(	nr_seq_prestador_pc	pls_prestador.nr_sequencia%type) FOR
	SELECT	a.nr_sequencia nr_seq_prestador
	from	pls_prestador a
	where	coalesce(nr_seq_prestador_pc::text, '') = ''
	
union all

	SELECT	a.nr_sequencia nr_seq_prestador
	from	pls_prestador a
	where	a.nr_sequencia = nr_seq_prestador_pc;
BEGIN

--  Só irá trazer os prestadores do grupo informado.
if (nr_seq_grupo_p IS NOT NULL AND nr_seq_grupo_p::text <> '') then
	-- Busca todos os registros da pls_preco_prestador para o grupo informado.
	for	r_C01_w in C01(nr_seq_grupo_p) loop

		-- se tiver prestador informado já busca o prestador para a lista
		if (r_C01_w.nr_seq_prestador IS NOT NULL AND r_C01_w.nr_seq_prestador::text <> '') then

			-- se o prestador for igual ao passado de parâmetro ou não foi passado nada de parâmetro
			if	((r_C01_w.nr_seq_prestador = nr_seq_prestador_p) or (coalesce(nr_seq_prestador_p::text, '') = '')) then
				-- Grava a informação do prestador para o registro que será retornado
				t_pls_preco_prestador_row_w.nr_seq_prestador := r_C01_w.nr_seq_prestador;
				RETURN NEXT t_pls_preco_prestador_row_w;
			end if;

		-- Se tiver a classificacao informada deve ser buscado todos os prestadores que tem a classificação informada.
		elsif (r_C01_w.nr_seq_classificacao IS NOT NULL AND r_C01_w.nr_seq_classificacao::text <> '') then

			-- Busca todos os prestadores de determinada classificacao
			for	r_C02_w in C02(r_C01_w.nr_seq_classificacao, nr_seq_prestador_p) loop
				-- Grava a informação do prestador para o registro que será retornado
				t_pls_preco_prestador_row_w.nr_seq_prestador := r_C02_w.nr_seq_prestador;

				RETURN NEXT t_pls_preco_prestador_row_w;
			end loop; -- C02
		-- Se a regra estiver em branco busca todos os prestadores cadastrados.
		else
			for	r_C03_w in C03(nr_seq_prestador_p) loop
				-- Grava a informação do prestador para o registro que será retornado
				t_pls_preco_prestador_row_w.nr_seq_prestador := r_C03_w.nr_seq_prestador;

				RETURN NEXT t_pls_preco_prestador_row_w;
			end loop; -- C03
		end if;
	end loop;--C01
	-- Retorna a seleção dos registros.
	return;
end if;
-- Não retorna nada
return;
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_grupos_pck.obter_prestadores_grupo ( nr_seq_grupo_p pls_preco_grupo_prestador.nr_sequencia%type, nr_seq_prestador_p pls_prestador.nr_sequencia%type default null) FROM PUBLIC;
