-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pls_grupos_pck.obter_itens_estrut_ocor ( nr_seq_estrutura_p pls_ocorrencia_estrutura.nr_sequencia%type, cd_procedimento_p procedimento.cd_procedimento%type default null, ie_origem_proced_p procedimento.ie_origem_proced%type default null, nr_seq_material_p pls_material.nr_sequencia%type default null) RETURNS SETOF T_PLS_OCOR_ESTRUT_ITEM_DATA AS $body$
DECLARE


/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade:  Retornar os itens que estão liberados para determinada estrutura.
-------------------------------------------------------------------------------------------------------------------
Locais de chamada direta:
[ X]  Objetos do dicionário [ ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatórios [ ] Outros:
 ------------------------------------------------------------------------------------------------------------------
Pontos de atenção:

Alterações:
------------------------------------------------------------------------------------------------------------------
jjung OS 601441 11/06/2013 -	Criação da function
------------------------------------------------------------------------------------------------------------------
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
t_pls_ocor_estrut_item_row_w	pls_grupos_pck.t_pls_ocor_estrut_item_row;

-- Dados dos itens da estrutura selecionada que forem váldos
C01 CURSOR( 	nr_seq_estrutura_pc	pls_ocorrencia_estrutura.nr_sequencia%type,
		ie_origem_proced_pc	procedimento.ie_origem_proced%type,
		cd_procedimento_pc	procedimento.cd_procedimento%type,
		nr_seq_material_pc	pls_material.nr_sequencia%type) FOR
	SELECT	a.cd_procedimento,
		a.ie_origem_proced,
		a.nr_seq_material,
		a.nr_prioridade
	from	pls_ocorrencia_estrutura_v a
	where	a.nr_seq_estrutura = nr_seq_estrutura_pc
	and (a.ie_origem_proced = ie_origem_proced_pc or coalesce(ie_origem_proced_pc::text, '') = '')
	and (a.cd_procedimento = cd_procedimento_pc or coalesce(cd_procedimento_pc::text, '') = '')
	and (a.nr_seq_material = nr_seq_material_pc or coalesce(nr_seq_material_pc::text, '') = '')
	and	a.ie_estrutura = 'S';

-- Buscar a maior prioridade para o procedimento que não estiver liberado para a estrutura
C02 CURSOR(	nr_seq_estrutura_pc	pls_ocorrencia_estrutura.nr_sequencia%type,
		cd_procedimento_pc	procedimento.cd_procedimento%type,
		ie_origem_proced_pc	procedimento.ie_origem_proced%type) FOR
	SELECT	max(a.nr_prioridade) nr_prioridade
	from	pls_ocorrencia_estrutura_v a
	where	a.nr_seq_estrutura	= nr_seq_estrutura_pc
	and	a.cd_procedimento	= cd_procedimento_pc
	and	a.ie_origem_proced	= ie_origem_proced_pc
	and	a.ie_estrutura		= 'N';

-- Buscar a maior prioridade para o material que não estiver liberado para a estrutura
C03 CURSOR(	nr_seq_estrutura_pc	pls_ocorrencia_estrutura.nr_sequencia%type,
		nr_seq_material_pc	pls_material.nr_sequencia%type) FOR
	SELECT	max(a.nr_prioridade) nr_prioridade
	from	pls_ocorrencia_estrutura_v a
	where	a.nr_seq_estrutura	= nr_seq_estrutura_pc
	and	a.nr_seq_material	= nr_seq_material_pc
	and	a.ie_estrutura		= 'N';
BEGIN

-- deve ter a informação da estrutura para que seja verificado
if (nr_seq_estrutura_p IS NOT NULL AND nr_seq_estrutura_p::text <> '') then
	-- Percorre todos os itens da estrutura.
	for	r_C01_w in C01(nr_seq_estrutura_p, ie_origem_proced_p, cd_procedimento_p, nr_seq_material_p) loop
		-- Anula os dados para que não seja gravado em redundancia erroneamente
		t_pls_ocor_estrut_item_row_w.cd_procedimento := null;
		t_pls_ocor_estrut_item_row_w.ie_origem_proced := null;
		t_pls_ocor_estrut_item_row_w.nr_seq_material := null;

		-- Verificar se é um procedimento ou um material
		if (r_C01_w.cd_procedimento IS NOT NULL AND r_C01_w.cd_procedimento::text <> '') then

			-- será buscado a maior prioridade que não estiver liberada para este procedimento
			for	r_C02_w in C02(nr_seq_estrutura_p, r_C01_w.cd_procedimento, r_C01_w.ie_origem_proced) loop

				-- só será inserido o item no retorno se a prioridade do item liberado for maior do que a maior prioridade do item que não estiver liberado
				-- ou se não tiver registro como Não liberado
				if (r_C01_w.nr_prioridade > r_C02_w.nr_prioridade) or (coalesce(r_C02_w.nr_prioridade::text, '') = '') then

					-- grava os dados para que o registro seja retornado posteriormente.
					t_pls_ocor_estrut_item_row_w.cd_procedimento := r_C01_w.cd_procedimento;
					t_pls_ocor_estrut_item_row_w.ie_origem_proced := r_C01_w.ie_origem_proced;
					t_pls_ocor_estrut_item_row_w.nr_seq_material := null;

					RETURN NEXT t_pls_ocor_estrut_item_row_w;
				end if;
			end loop; --C02
		-- Se for material
		elsif (r_C01_w.nr_seq_material IS NOT NULL AND r_C01_w.nr_seq_material::text <> '') then

			-- será buscada a maior prioridade que não estiver liberado para este material
			for	r_C03_w in C03(nr_seq_estrutura_p, r_C01_w.nr_seq_material) loop

				-- Só será inserido o registro no reotorno se a prioridade do item liberado for maior do que a maior prioridade do item não liberado.
				-- ou se não tiver registro como Não liberado
				if (r_C01_w.nr_prioridade > r_C03_w.nr_prioridade) or (coalesce(r_C03_w.nr_prioridade::text, '') = '') then

					-- grava os dados para que o registro seja retornado posteriormente.
					t_pls_ocor_estrut_item_row_w.nr_seq_material := r_C01_w.nr_seq_material;
					t_pls_ocor_estrut_item_row_w.cd_procedimento := null;
					t_pls_ocor_estrut_item_row_w.ie_origem_proced := null;

					RETURN NEXT t_pls_ocor_estrut_item_row_w;
				end if;
			end loop; -- C03
		end if;
	end loop; -- C01
	-- retorna as linhas selecionadas
	return;
end if;
-- Não retorna nada;
return;
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pls_grupos_pck.obter_itens_estrut_ocor ( nr_seq_estrutura_p pls_ocorrencia_estrutura.nr_sequencia%type, cd_procedimento_p procedimento.cd_procedimento%type default null, ie_origem_proced_p procedimento.ie_origem_proced%type default null, nr_seq_material_p pls_material.nr_sequencia%type default null) FROM PUBLIC;
