-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



	/* Esta procedure gera os atributos padrões do sistema, que não são cadastrados*/

	/* Ao criar um novo atributo padrão, deve ser atentado a sua declaração no cursor 02 */

CREATE OR REPLACE PROCEDURE pcs_sup_gerar_plano_pck.gerar_atributos_padroes ( nm_usuario_p text) AS $body$
DECLARE


	nr_seq_relatorio_w				bigint;
	nm_atributo_w				varchar(255);
	cd_material_w				integer;
	cd_estabelecimento_w			integer;
	qt_consumo_dia_ant_w			double precision;
	qt_consumo_7_dias_w			double precision;
	qt_consumo_15_dias_w			double precision;
	qt_consumo_30_dias_w			double precision;
	qt_consumo_60_dias_w			double precision;
	qt_consumo_90_dias_w			double precision;
	qt_consumo_120_dias_w			double precision;
	qt_consumo_150_dias_w			double precision;
	qt_consumo_180_dias_w			double precision;
	qt_maior_media_cons_3_meses_w		double precision;
	qt_cobertura_almox_w			double precision;
	qt_saldo_almox_w				double precision;
	qt_cobertura_farmacia_w			double precision;
	qt_saldo_farmacia_w			double precision;
	qt_saldo_total_w				double precision;
	vl_estoque_w				double precision;
	vl_custo_medio_w				double precision;
	qt_compra_melhor_w			double precision;
	qt_dia_compra_w				double precision;
	qt_dia_ressup_forn_w			smallint;
	qt_dia_frequencia_w			double precision;
	qt_estoque_minimo_w			double precision;
	qt_eseg_w				double precision;
	qt_saldo_externo_w			double precision;
	qt_prevista_entrega_oc_w			double precision;
	qt_conv_compra_est_w			double precision;
	qt_dia_intervalo_w				smallint;
	vl_atributo_w				double precision;
	ie_classif_abc_w				smallint;

	/* Busca as informações do último relatório gerado */

	c01 CURSOR FOR
	SELECT	cd_material,
		cd_estabelecimento,
		qt_consumo_dia_ant,
		qt_consumo_7_dias,
		qt_consumo_15_dias,
		qt_consumo_30_dias,
		qt_consumo_60_dias,
		qt_consumo_90_dias,
		qt_consumo_120_dias,
		qt_consumo_150_dias,
		qt_consumo_180_dias,
		qt_maior_media_cons_3_meses,
		qt_cobertura_almox,
		qt_saldo_almox,
		qt_cobertura_farmacia,
		qt_saldo_farmacia,
		qt_saldo_total,
		vl_estoque,
		vl_custo_medio,
		qt_compra_melhor,
		qt_dia_compra,
		qt_dia_ressup_forn,
		qt_dia_frequencia,
		qt_estoque_minimo,
		qt_eseg,
		qt_saldo_externo,
		qt_prevista_entrega_oc
	from	segmento_compras_rel_it
	where	nr_sequencia = nr_seq_relatorio_w
	order by	cd_material;

	/* Cursor para fazer o insert com o nome do atributo e seu valor */

	c02 CURSOR FOR
	SELECT	'CDA',
		qt_consumo_dia_ant_w
	
	
union all

	SELECT	'CD07',
		qt_consumo_7_dias_w
	
	
union all

	select	'CD15',
		qt_consumo_15_dias_w
	
	
union all

	select	'CD30',
		qt_consumo_30_dias_w
	
	
union all

	select	'CD60',
		qt_consumo_60_dias_w
	
	
union all

	select	'CD90',
		qt_consumo_90_dias_w
	
	
union all

	select	'CD120',
		qt_consumo_120_dias_w
	
	
union all

	select	'CD150',
		qt_consumo_150_dias_w
	
	
union all

	select	'CD180',
		qt_consumo_180_dias_w
	
	
union all

	select	'MAIOR_CONS_3M',
		qt_maior_media_cons_3_meses_w
	
	
union all

	select	'COBERT_ALMOX',
		qt_cobertura_almox_w
	
	
union all

	select	'SALDO_ALMOX',
		qt_saldo_almox_w
	
	
union all

	select	'COBERT_FARMACIA',
		qt_cobertura_farmacia_w
	
	
union all

	select	'SALDO_FARMACIA',
		qt_saldo_farmacia_w
	
	
union all

	select	'SALDO_TOTAL',
		qt_saldo_total_w
	
	
union all

	select	'VL_ESTOQUE',
		vl_estoque_w
	
	
union all

	select	'CUSTO_MEDIO',
		vl_custo_medio_w
	
	
union all

	select	'MELHOR_COMPRA',
		qt_compra_melhor_w
	
	
union all

	select	'DIA_POLITICA',
		qt_dia_compra_w
	
	
union all

	select	'LEAD_TIME',
		qt_dia_ressup_forn_w
	
	
union all

	select	'DIA_FREQUENCIA',
		qt_dia_frequencia_w
	
	
union all

	select	'ESTOQUE_MIN',
		qt_estoque_minimo_w
	
	
union all

	select	'ESEG',
		qt_eseg_w
	
	
union all

	select	'SALDO_EXTERNO',
		qt_saldo_externo_w
	
	
union all

	select	'QT_PREV_ENT_OC',
		qt_prevista_entrega_oc_w
	
	
union all

	select	'CONV_COMPRA_EST',
		qt_conv_compra_est_w
	
	
union all

	select	'DIA_INTERVALO',
		qt_dia_intervalo_w
	
	
union all

	select	'CLASSIF_ABC',
		ie_classif_abc_w
	;

	
BEGIN

	select	max(nr_sequencia)
	into STRICT	nr_seq_relatorio_w
	from	segmento_compras_rel_it;

	open c01;
	loop
	fetch c01 into
		cd_material_w,
		cd_estabelecimento_w,
		qt_consumo_dia_ant_w,
		qt_consumo_7_dias_w,
		qt_consumo_15_dias_w,
		qt_consumo_30_dias_w,
		qt_consumo_60_dias_w,
		qt_consumo_90_dias_w,
		qt_consumo_120_dias_w,
		qt_consumo_150_dias_w,
		qt_consumo_180_dias_w,
		qt_maior_media_cons_3_meses_w,
		qt_cobertura_almox_w,
		qt_saldo_almox_w,
		qt_cobertura_farmacia_w,
		qt_saldo_farmacia_w,
		qt_saldo_total_w,
		vl_estoque_w,
		vl_custo_medio_w,
		qt_compra_melhor_w,
		qt_dia_compra_w,
		qt_dia_ressup_forn_w,
		qt_dia_frequencia_w,
		qt_estoque_minimo_w,
		qt_eseg_w,
		qt_saldo_externo_w,
		qt_prevista_entrega_oc_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin

		select	coalesce(b.qt_conv_compra_estoque,a.qt_conv_compra_estoque),
			coalesce(b.qt_dia_interv_ressup,0),
			CASE WHEN substr(obter_curva_abc_estab(b.cd_estabelecimento,a.cd_material,'N',clock_timestamp()),1,1)='A' THEN  1 WHEN substr(obter_curva_abc_estab(b.cd_estabelecimento,a.cd_material,'N',clock_timestamp()),1,1)='B' THEN  2 WHEN substr(obter_curva_abc_estab(b.cd_estabelecimento,a.cd_material,'N',clock_timestamp()),1,1)='C' THEN  3  ELSE 0 END
		into STRICT	qt_conv_compra_est_w,
			qt_dia_intervalo_w,
			ie_classif_abc_w
		from	material_estab b,
			material a
		where	a.cd_material = cd_material_w
		and	b.cd_material = a.cd_material
		and	b.cd_estabelecimento = cd_estabelecimento_w;

		open c02;
		loop
		fetch c02 into
			nm_atributo_w,
			vl_atributo_w;
		EXIT WHEN NOT FOUND; /* apply on c02 */
			begin

			CALL CALL pcs_sup_gerar_plano_pck.gravar_valor_atrib_planej(
				nm_atributo_w,
				vl_atributo_w,
				cd_material_w,
				cd_estabelecimento_w,
				nm_usuario_p);

			end;
		end loop;
		close c02;

		end;
	end loop;
	close c01;

	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pcs_sup_gerar_plano_pck.gerar_atributos_padroes ( nm_usuario_p text) FROM PUBLIC;
