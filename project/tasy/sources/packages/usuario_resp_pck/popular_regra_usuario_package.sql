-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE usuario_resp_pck.popular_regra_usuario () AS $body$
DECLARE


  r RECORD;

BEGIN
PERFORM set_config('usuario_resp_pck.i', 0, false);

if (current_setting('usuario_resp_pck.regra_prev_usu_w')::regra_prev_usu_v.count = 0) then	
	
	
	For r in (	SELECT	a.NR_SEQUENCIA,
			a.NM_USUARIO_RESP,
			a.nr_seq_prev_analise,
			(select  count(*)
			from	lote_audit_hist_item x
			where	x.NM_USUARIO_PREVISTO = a.NM_USUARIO_RESP
			and	coalesce(x.nm_usuario_resp::text, '') = '') qt_itens_pendentes
		from	regra_prev_analise_usu a
		where	a.ie_situacao = 'A') loop

		
		current_setting('usuario_resp_pck.regra_prev_usu_w')::regra_prev_usu_v(current_setting('usuario_resp_pck.i')::integer).nr_seq_prev_analise		:= r.nr_seq_prev_analise;
		current_setting('usuario_resp_pck.regra_prev_usu_w')::regra_prev_usu_v(current_setting('usuario_resp_pck.i')::integer).nr_sequencia		:= r.nr_sequencia;
		current_setting('usuario_resp_pck.regra_prev_usu_w')::regra_prev_usu_v(current_setting('usuario_resp_pck.i')::integer).nm_usuario_resp		:= r.nm_usuario_resp;		
		current_setting('usuario_resp_pck.regra_prev_usu_w')::regra_prev_usu_v(current_setting('usuario_resp_pck.i')::integer).qt_itens_pendentes		:= r.qt_itens_pendentes;
		current_setting('usuario_resp_pck.regra_prev_usu_w')::regra_prev_usu_v(current_setting('usuario_resp_pck.i')::integer).qt_pontos_itens		:= 0;
		PERFORM set_config('usuario_resp_pck.i', current_setting('usuario_resp_pck.i')::integer + 1, false);

	end loop;

end if;
end;


$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE usuario_resp_pck.popular_regra_usuario () FROM PUBLIC;
