-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE usuario_resp_pck.obter_usuario_responsavel ( cd_convenio_p bigint, cd_estabelecimento_p bigint, nr_seq_propaci_p bigint, nr_seq_matpaci_p bigint, cd_material_atend_paciente_p bigint, cd_procedimento_pac_p bigint, ie_origem_proced_pac_p bigint, nr_interno_conta_p bigint, cd_autorizacao_p text, nr_seq_protocolo_p bigint, nm_usuario_p text, nm_usuario_resp INOUT text ) AS $body$
DECLARE

nr_seq_regra_w		bigint;
ie_tipo_regra_w		varchar(2);
qt_regra_usuario_w	bigint;
cd_procedimento_w	procedimento.cd_procedimento%type;
ie_origem_proced_w	procedimento.ie_origem_proced%type;
nr_interno_conta_w	conta_paciente.nr_interno_conta%type;
nr_doc_convenio_w	conta_paciente_guia.cd_autorizacao%type;
nr_seq_protocolo_w	protocolo_convenio.nr_seq_protocolo%type;
cd_area_procedimento_w	area_procedimento.cd_area_procedimento%type;
cd_grupo_proc_w		grupo_proc.cd_grupo_proc%type;
cd_espealidade_w	especialidade_proc.cd_especialidade%type;

cd_material_w		material.cd_material%type;
cd_grupo_material_w	grupo_material.cd_grupo_material%type;
cd_subgrupo_material_w	subgrupo_material.cd_subgrupo_material%type;
cd_classe_material_w	classe_material.cd_classe_material%type;
nm_usuario_retorno_w	varchar(15);
nm_usuario_item_w	varchar(15);	
nm_usuario_gravado_w	varchar(15);	
qt_vetor_aux_w		bigint := 0;
nr_seq_guia_w		bigint;
nr_seq_zero_w		bigint;
qt_itens_pendentes_w	bigint;
nm_usuario_zero_w	varchar(15);
cd_estabelecimento_w	estabelecimento.cd_estabelecimento%type;
cd_convenio_w		convenio.cd_convenio%type;
qt_vetor_itens_w	bigint := 0;
ds_nao_informado_w	varchar(20) := substr(obter_desc_expressao(778770),1,20);
BEGIN
CALL usuario_resp_pck.popular_regras();
cd_convenio_w 		:= null;
cd_estabelecimento_w 	:= null;
if (nr_seq_propaci_p > 0) then
	begin
	select 	a.cd_procedimento,
		a.ie_origem_proced,
		a.nr_interno_conta,
		coalesce(a.nr_doc_convenio,ds_nao_informado_w) nr_doc_convenio,
		b.nr_seq_protocolo,
		e.cd_area_procedimento,
		e.cd_grupo_proc,
		e.cd_especialidade,
		b.cd_convenio_parametro,
		b.cd_estabelecimento
	into STRICT	cd_procedimento_w,
		ie_origem_proced_w,
		nr_interno_conta_w,
		nr_doc_convenio_w,
		nr_seq_protocolo_w,
		cd_area_procedimento_w,
		cd_grupo_proc_w,
		cd_espealidade_w,
		cd_convenio_w,
		cd_estabelecimento_w
	from	procedimento_paciente a,
		conta_paciente b,
		estrutura_procedimento_v e
	where	a.nr_sequencia = nr_seq_propaci_p
	and	a.nr_interno_conta = b.nr_interno_conta
	and	a.cd_procedimento = e.cd_procedimento
	and	a.ie_origem_proced = e.ie_origem_proced;
	exception
	when others then
		cd_convenio_w := null;
	end;

elsif (nr_seq_matpaci_p > 0) then
	begin
	select 	a.cd_material,
		a.nr_interno_conta,
		coalesce(a.nr_doc_convenio,ds_nao_informado_w) nr_doc_convenio,
		b.nr_seq_protocolo,
		e.cd_grupo_material,
		e.cd_subgrupo_material,
		e.cd_classe_material,
		b.cd_convenio_parametro,
		b.cd_estabelecimento
	into STRICT	cd_material_w,
		nr_interno_conta_w,
		nr_doc_convenio_w,
		nr_seq_protocolo_w,
		cd_grupo_material_w,
		cd_subgrupo_material_w,
		cd_classe_material_w,
		cd_convenio_w,
		cd_estabelecimento_w
	from	material_atend_paciente a,
		conta_paciente b,
		estrutura_material_v e
	where	a.nr_sequencia = nr_seq_matpaci_p
	and	a.nr_interno_conta = b.nr_interno_conta
	and	a.cd_material = e.cd_material;
	exception
	when others then
		cd_convenio_w := null;
	end;
end if;



if (current_setting('usuario_resp_pck.regra_prev_w')::regra_prev_v.count > 0) and (cd_convenio_w > 0) then
	
	FOR current_setting('usuario_resp_pck.i')::integer IN current_setting('usuario_resp_pck.regra_prev_w')::regra_prev_v.first .. current_setting('usuario_resp_pck.regra_prev_w')::regra_prev_v.last LOOP
		
		if (coalesce(nr_seq_regra_w::text, '') = '') and (current_setting('usuario_resp_pck.regra_prev_w')::regra_prev_v(current_setting('usuario_resp_pck.i')::integer).cd_convenio = cd_convenio_w) and (current_setting('usuario_resp_pck.regra_prev_w')::regra_prev_v(current_setting('usuario_resp_pck.i')::integer).cd_estabelecimento = cd_estabelecimento_w) then
			nr_seq_regra_w := current_setting('usuario_resp_pck.regra_prev_w')::regra_prev_v(current_setting('usuario_resp_pck.i')::integer).nr_sequencia;
			ie_tipo_regra_w := current_setting('usuario_resp_pck.regra_prev_w')::regra_prev_v(current_setting('usuario_resp_pck.i')::integer).ie_tipo_regra;
		elsif (coalesce(nr_seq_regra_w::text, '') = '')and (current_setting('usuario_resp_pck.regra_prev_w')::regra_prev_v(current_setting('usuario_resp_pck.i')::integer).cd_convenio = cd_convenio_w) and (current_setting('usuario_resp_pck.regra_prev_w')::regra_prev_v(current_setting('usuario_resp_pck.i')::integer)coalesce(.cd_estabelecimento::text, '') = '') then
			nr_seq_regra_w := current_setting('usuario_resp_pck.regra_prev_w')::regra_prev_v(current_setting('usuario_resp_pck.i')::integer).nr_sequencia;
			ie_tipo_regra_w := current_setting('usuario_resp_pck.regra_prev_w')::regra_prev_v(current_setting('usuario_resp_pck.i')::integer).ie_tipo_regra;
		elsif (coalesce(nr_seq_regra_w::text, '') = '') and (current_setting('usuario_resp_pck.regra_prev_w')::regra_prev_v(current_setting('usuario_resp_pck.i')::integer).cd_estabelecimento = cd_estabelecimento_w) and (current_setting('usuario_resp_pck.regra_prev_w')::regra_prev_v(current_setting('usuario_resp_pck.i')::integer)coalesce(.cd_convenio::text, '') = '')then
			nr_seq_regra_w := current_setting('usuario_resp_pck.regra_prev_w')::regra_prev_v(current_setting('usuario_resp_pck.i')::integer).nr_sequencia;
			ie_tipo_regra_w := current_setting('usuario_resp_pck.regra_prev_w')::regra_prev_v(current_setting('usuario_resp_pck.i')::integer).ie_tipo_regra;
		elsif (coalesce(nr_seq_regra_w::text, '') = '') and (current_setting('usuario_resp_pck.regra_prev_w')::regra_prev_v(current_setting('usuario_resp_pck.i')::integer)coalesce(.cd_estabelecimento::text, '') = '') and (current_setting('usuario_resp_pck.regra_prev_w')::regra_prev_v(current_setting('usuario_resp_pck.i')::integer)coalesce(.cd_convenio::text, '') = '')then
			nr_seq_regra_w := current_setting('usuario_resp_pck.regra_prev_w')::regra_prev_v(current_setting('usuario_resp_pck.i')::integer).nr_sequencia;
			ie_tipo_regra_w := current_setting('usuario_resp_pck.regra_prev_w')::regra_prev_v(current_setting('usuario_resp_pck.i')::integer).ie_tipo_regra;
		end if;
	end loop;
	
end if;

if (nr_seq_regra_w > 0) then
	
		
	if (current_setting('usuario_resp_pck.regra_prev_usu_w')::regra_prev_usu_v.count > 0) then
	
	
		current_setting('usuario_resp_pck.regra_prev_usu_item_w')::regra_prev_usu_v.delete;
		
		
		FOR current_setting('usuario_resp_pck.i')::integer IN current_setting('usuario_resp_pck.regra_prev_usu_w')::regra_prev_usu_v.first .. current_setting('usuario_resp_pck.regra_prev_usu_w')::regra_prev_usu_v.last LOOP
			
			if (current_setting('usuario_resp_pck.regra_prev_usu_w')::regra_prev_usu_v(current_setting('usuario_resp_pck.i')::integer).nr_seq_prev_analise = nr_seq_regra_w) then
				
				if (current_setting('usuario_resp_pck.regra_prev_item_w')::regra_prev_item_v.count > 0) then				
					
					for j in current_setting('usuario_resp_pck.regra_prev_item_w')::regra_prev_item_v.first ..regra_prev_item_w.last loop
						if (current_setting('usuario_resp_pck.regra_prev_item_w')::regra_prev_item_v[j].nr_seq_prev_analise_usu = current_setting('usuario_resp_pck.regra_prev_usu_w')::regra_prev_usu_v(current_setting('usuario_resp_pck.i')::integer).nr_sequencia) then
							
							if (nr_seq_propaci_p IS NOT NULL AND nr_seq_propaci_p::text <> '') then
							
								if (cd_procedimento_w = current_setting('usuario_resp_pck.regra_prev_item_w')::regra_prev_item_v[j].cd_procedimento) and (ie_origem_proced_w = current_setting('usuario_resp_pck.regra_prev_item_w')::regra_prev_item_v[j].ie_origem_proced) then
									current_setting('usuario_resp_pck.regra_prev_usu_w')::regra_prev_usu_v(current_setting('usuario_resp_pck.i')::integer).qt_pontos_itens :=  10;
								elsif (cd_grupo_proc_w = current_setting('usuario_resp_pck.regra_prev_item_w')::regra_prev_item_v[j].cd_grupo_proc) then
									current_setting('usuario_resp_pck.regra_prev_usu_w')::regra_prev_usu_v(current_setting('usuario_resp_pck.i')::integer).qt_pontos_itens :=  7;
								elsif (cd_espealidade_w = current_setting('usuario_resp_pck.regra_prev_item_w')::regra_prev_item_v[j].cd_especialidade) then
									current_setting('usuario_resp_pck.regra_prev_usu_w')::regra_prev_usu_v(current_setting('usuario_resp_pck.i')::integer).qt_pontos_itens :=  5;
								elsif (cd_area_procedimento_w = current_setting('usuario_resp_pck.regra_prev_item_w')::regra_prev_item_v[j].cd_area_procedimento) then
									current_setting('usuario_resp_pck.regra_prev_usu_w')::regra_prev_usu_v(current_setting('usuario_resp_pck.i')::integer).qt_pontos_itens :=  3;
								else
									current_setting('usuario_resp_pck.regra_prev_usu_w')::regra_prev_usu_v(current_setting('usuario_resp_pck.i')::integer).qt_pontos_itens :=  0;
								end if;
								
							elsif (nr_seq_matpaci_p IS NOT NULL AND nr_seq_matpaci_p::text <> '') then
							
								if (cd_material_w = current_setting('usuario_resp_pck.regra_prev_item_w')::regra_prev_item_v[j].cd_material) then
									current_setting('usuario_resp_pck.regra_prev_usu_w')::regra_prev_usu_v(current_setting('usuario_resp_pck.i')::integer).qt_pontos_itens :=  10;
								elsif (cd_classe_material_w = current_setting('usuario_resp_pck.regra_prev_item_w')::regra_prev_item_v[j].cd_classe_material) then
									current_setting('usuario_resp_pck.regra_prev_usu_w')::regra_prev_usu_v(current_setting('usuario_resp_pck.i')::integer).qt_pontos_itens :=  7;
								elsif (cd_subgrupo_material_w = current_setting('usuario_resp_pck.regra_prev_item_w')::regra_prev_item_v[j].cd_subgrupo_material) then
									current_setting('usuario_resp_pck.regra_prev_usu_w')::regra_prev_usu_v(current_setting('usuario_resp_pck.i')::integer).qt_pontos_itens :=  5;
								elsif (cd_grupo_material_w = current_setting('usuario_resp_pck.regra_prev_item_w')::regra_prev_item_v[j].cd_grupo_material) then
									current_setting('usuario_resp_pck.regra_prev_usu_w')::regra_prev_usu_v(current_setting('usuario_resp_pck.i')::integer).qt_pontos_itens :=  3;
								else	
									current_setting('usuario_resp_pck.regra_prev_usu_w')::regra_prev_usu_v(current_setting('usuario_resp_pck.i')::integer).qt_pontos_itens :=  0;
								end if;
								
							end if;
							
							if (current_setting('usuario_resp_pck.regra_prev_usu_w')::regra_prev_usu_v(current_setting('usuario_resp_pck.i')::integer).qt_pontos_itens > 0) then
								
								if (current_setting('usuario_resp_pck.regra_prev_usu_item_w')::regra_prev_usu_v.count = 0) then
									current_setting('usuario_resp_pck.regra_prev_usu_item_w')::regra_prev_usu_v(1) := current_setting('usuario_resp_pck.regra_prev_usu_w')::regra_prev_usu_v(current_setting('usuario_resp_pck.i')::integer);
								elsif (current_setting('usuario_resp_pck.regra_prev_usu_item_w')::regra_prev_usu_v[1].qt_pontos_itens < current_setting('usuario_resp_pck.regra_prev_usu_w')::regra_prev_usu_v(current_setting('usuario_resp_pck.i')::integer).qt_pontos_itens) then
									current_setting('usuario_resp_pck.regra_prev_usu_item_w')::regra_prev_usu_v(1) := current_setting('usuario_resp_pck.regra_prev_usu_w')::regra_prev_usu_v(current_setting('usuario_resp_pck.i')::integer);
								end if;
							end if;
							
						end if;
					end loop;
					
					
					
					
					
					
				end if;
			end if;
				
		end loop;
		nm_usuario_retorno_w := null;
		nm_usuario_item_w    := null;
		if	current_setting('usuario_resp_pck.regra_prev_usu_item_w')::regra_prev_usu_v.count > 0 then
		
			FOR current_setting('usuario_resp_pck.i')::integer IN current_setting('usuario_resp_pck.regra_prev_usu_w')::regra_prev_usu_v.first .. current_setting('usuario_resp_pck.regra_prev_usu_w')::regra_prev_usu_v.last LOOP
				
				if (current_setting('usuario_resp_pck.regra_prev_usu_w')::regra_prev_usu_v(current_setting('usuario_resp_pck.i')::integer).nr_seq_prev_analise = nr_seq_regra_w) and (current_setting('usuario_resp_pck.regra_prev_usu_w')::regra_prev_usu_v(current_setting('usuario_resp_pck.i')::integer).nr_sequencia = current_setting('usuario_resp_pck.regra_prev_usu_item_w')::regra_prev_usu_v[1].nr_sequencia) and (current_setting('usuario_resp_pck.regra_prev_usu_w')::regra_prev_usu_v(current_setting('usuario_resp_pck.i')::integer).qt_itens_pendentes = current_setting('usuario_resp_pck.regra_prev_usu_item_w')::regra_prev_usu_v[1].qt_itens_pendentes) and (current_setting('usuario_resp_pck.regra_prev_usu_w')::regra_prev_usu_v(current_setting('usuario_resp_pck.i')::integer).nm_usuario_resp = current_setting('usuario_resp_pck.regra_prev_usu_item_w')::regra_prev_usu_v[1].nm_usuario_resp) then
					
					
					current_setting('usuario_resp_pck.regra_prev_usu_w')::regra_prev_usu_v(current_setting('usuario_resp_pck.i')::integer).qt_itens_pendentes := current_setting('usuario_resp_pck.regra_prev_usu_w')::regra_prev_usu_v(current_setting('usuario_resp_pck.i')::integer).qt_itens_pendentes + 1;
					
					nm_usuario_item_w := current_setting('usuario_resp_pck.regra_prev_usu_item_w')::regra_prev_usu_v[1].nm_usuario_resp;
					nm_usuario_retorno_w := nm_usuario_item_w;
					
				end if;
				
			end loop;
		
		end if;
		
		
		
		qt_itens_pendentes_w := 0;
		nm_usuario_zero_w     := null;
		current_setting('usuario_resp_pck.regra_prev_usu_ww')::regra_prev_usu_v.delete;
			
		if (coalesce(nm_usuario_item_w::text, '') = '') then
		
		
			FOR current_setting('usuario_resp_pck.i')::integer IN current_setting('usuario_resp_pck.regra_prev_usu_w')::regra_prev_usu_v.first .. current_setting('usuario_resp_pck.regra_prev_usu_w')::regra_prev_usu_v.last LOOP
	
				if (current_setting('usuario_resp_pck.regra_prev_usu_w')::regra_prev_usu_v(current_setting('usuario_resp_pck.i')::integer).nr_seq_prev_analise = nr_seq_regra_w) then
				
					if (ie_tipo_regra_w = 'P') then
						begin
						select	NR_SEQUENCIA,
							NM_USUARIO_RESPONSAVEL
						into STRICT	nr_seq_guia_w,
							nm_usuario_gravado_w
						from	USUARIO_RESP_GUIA_GRG
						where   nr_seq_protocolo = nr_seq_protocolo_w;
						exception
						when others then
							nm_usuario_gravado_w := null;
							nr_seq_guia_w := null;
						end;
					elsif (ie_tipo_regra_w = 'C') then
						begin
						select	NR_SEQUENCIA,
							NM_USUARIO_RESPONSAVEL
						into STRICT	nr_seq_guia_w,
							nm_usuario_gravado_w
						from	USUARIO_RESP_GUIA_GRG
						where	nr_interno_conta = nr_interno_conta_w
						and	cd_autorizacao   = nr_doc_convenio_w;
						exception
						when others then
							nm_usuario_gravado_w := null;
							nr_seq_guia_w := null;
						end;
						
					end if;
					

			
					if (coalesce(nm_usuario_gravado_w::text, '') = '') then
						
						if (nm_usuario_zero_w is  null) then
							
							if (current_setting('usuario_resp_pck.regra_prev_usu_w')::regra_prev_usu_v(current_setting('usuario_resp_pck.i')::integer).qt_itens_pendentes = 0) then
								nm_usuario_zero_w 	:= current_setting('usuario_resp_pck.regra_prev_usu_w')::regra_prev_usu_v(current_setting('usuario_resp_pck.i')::integer).nm_usuario_resp;
								nr_seq_zero_w	     	:= current_setting('usuario_resp_pck.regra_prev_usu_w')::regra_prev_usu_v(current_setting('usuario_resp_pck.i')::integer).nr_sequencia;
							end if;
							
						end if;
							
						if (coalesce(nm_usuario_zero_w::text, '') = '') and (current_setting('usuario_resp_pck.regra_prev_usu_w')::regra_prev_usu_v(current_setting('usuario_resp_pck.i')::integer).qt_itens_pendentes > 0) then
						
							if (current_setting('usuario_resp_pck.regra_prev_usu_ww')::regra_prev_usu_v.count = 0) then
								
								current_setting('usuario_resp_pck.regra_prev_usu_ww')::regra_prev_usu_v(1) := current_setting('usuario_resp_pck.regra_prev_usu_w')::regra_prev_usu_v(current_setting('usuario_resp_pck.i')::integer);
								qt_vetor_aux_w := 1;
								
							elsif (current_setting('usuario_resp_pck.regra_prev_usu_ww')::regra_prev_usu_v[1].qt_itens_pendentes >  current_setting('usuario_resp_pck.regra_prev_usu_w')::regra_prev_usu_v(current_setting('usuario_resp_pck.i')::integer).qt_itens_pendentes) then
									current_setting('usuario_resp_pck.regra_prev_usu_ww')::regra_prev_usu_v(1) := current_setting('usuario_resp_pck.regra_prev_usu_w')::regra_prev_usu_v(current_setting('usuario_resp_pck.i')::integer);
									qt_vetor_aux_w := qt_vetor_aux_w + 1;
								
							end if;
							
						end if;
					else	
						nm_usuario_retorno_w := nm_usuario_gravado_w;
						
						FOR current_setting('usuario_resp_pck.i')::integer IN current_setting('usuario_resp_pck.regra_prev_usu_w')::regra_prev_usu_v.first .. current_setting('usuario_resp_pck.regra_prev_usu_w')::regra_prev_usu_v.last LOOP
							
							if (current_setting('usuario_resp_pck.regra_prev_usu_w')::regra_prev_usu_v(current_setting('usuario_resp_pck.i')::integer).nr_seq_prev_analise = nr_seq_regra_w) and (current_setting('usuario_resp_pck.regra_prev_usu_w')::regra_prev_usu_v(current_setting('usuario_resp_pck.i')::integer).nm_usuario_resp = nm_usuario_retorno_w) then
								current_setting('usuario_resp_pck.regra_prev_usu_w')::regra_prev_usu_v(current_setting('usuario_resp_pck.i')::integer).qt_itens_pendentes := current_setting('usuario_resp_pck.regra_prev_usu_w')::regra_prev_usu_v(current_setting('usuario_resp_pck.i')::integer).qt_itens_pendentes +  1;
							end if;
						end loop;
					end if;
			
				end if;
			end loop;
		end if;
	
		
		
		if (coalesce(nm_usuario_item_w::text, '') = '') and (coalesce(nm_usuario_gravado_w::text, '') = '') then
			
			
			if (nm_usuario_zero_w IS NOT NULL AND nm_usuario_zero_w::text <> '') then
				nm_usuario_retorno_w := nm_usuario_zero_w;
																			
				FOR current_setting('usuario_resp_pck.i')::integer IN current_setting('usuario_resp_pck.regra_prev_usu_w')::regra_prev_usu_v.first .. current_setting('usuario_resp_pck.regra_prev_usu_w')::regra_prev_usu_v.last LOOP
				
					if (current_setting('usuario_resp_pck.regra_prev_usu_w')::regra_prev_usu_v(current_setting('usuario_resp_pck.i')::integer).nr_seq_prev_analise = nr_seq_regra_w) and (current_setting('usuario_resp_pck.regra_prev_usu_w')::regra_prev_usu_v(current_setting('usuario_resp_pck.i')::integer).nr_sequencia = nr_seq_zero_w) and (current_setting('usuario_resp_pck.regra_prev_usu_w')::regra_prev_usu_v(current_setting('usuario_resp_pck.i')::integer).nm_usuario_resp = nm_usuario_zero_w) then
						
						current_setting('usuario_resp_pck.regra_prev_usu_w')::regra_prev_usu_v(current_setting('usuario_resp_pck.i')::integer).qt_itens_pendentes := current_setting('usuario_resp_pck.regra_prev_usu_w')::regra_prev_usu_v(current_setting('usuario_resp_pck.i')::integer).qt_itens_pendentes + 1;
						CALL usuario_resp_pck.inserir_usuario_resp_guia(nm_usuario_p,nr_seq_protocolo_w,nm_usuario_retorno_w,NR_INTERNO_CONTA_w,nr_seq_regra_w,nr_doc_convenio_w);
					end if;
				end loop;
			elsif (qt_vetor_aux_w > 0) then
			
				FOR current_setting('usuario_resp_pck.i')::integer IN current_setting('usuario_resp_pck.regra_prev_usu_w')::regra_prev_usu_v.first .. current_setting('usuario_resp_pck.regra_prev_usu_w')::regra_prev_usu_v.last LOOP
			
					if (current_setting('usuario_resp_pck.regra_prev_usu_w')::regra_prev_usu_v(current_setting('usuario_resp_pck.i')::integer).nr_seq_prev_analise = nr_seq_regra_w) and (current_setting('usuario_resp_pck.regra_prev_usu_w')::regra_prev_usu_v(current_setting('usuario_resp_pck.i')::integer).nr_sequencia = current_setting('usuario_resp_pck.regra_prev_usu_ww')::regra_prev_usu_v[1].nr_sequencia) and (current_setting('usuario_resp_pck.regra_prev_usu_w')::regra_prev_usu_v(current_setting('usuario_resp_pck.i')::integer).qt_itens_pendentes = current_setting('usuario_resp_pck.regra_prev_usu_ww')::regra_prev_usu_v[1].qt_itens_pendentes) and (current_setting('usuario_resp_pck.regra_prev_usu_w')::regra_prev_usu_v(current_setting('usuario_resp_pck.i')::integer).nm_usuario_resp = current_setting('usuario_resp_pck.regra_prev_usu_ww')::regra_prev_usu_v[1].nm_usuario_resp) then
					
						current_setting('usuario_resp_pck.regra_prev_usu_w')::regra_prev_usu_v(current_setting('usuario_resp_pck.i')::integer).qt_itens_pendentes := current_setting('usuario_resp_pck.regra_prev_usu_w')::regra_prev_usu_v(current_setting('usuario_resp_pck.i')::integer).qt_itens_pendentes + 1;
						nm_usuario_retorno_w := current_setting('usuario_resp_pck.regra_prev_usu_ww')::regra_prev_usu_v[1].nm_usuario_resp;
						CALL usuario_resp_pck.inserir_usuario_resp_guia(nm_usuario_p,nr_seq_protocolo_w,nm_usuario_retorno_w,NR_INTERNO_CONTA_w,nr_seq_regra_w,nr_doc_convenio_w);
					end if;
				end loop;
			end if;	
			
		end if;
	end if;
end if;

nm_usuario_resp := nm_usuario_retorno_w;
end;


$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE usuario_resp_pck.obter_usuario_responsavel ( cd_convenio_p bigint, cd_estabelecimento_p bigint, nr_seq_propaci_p bigint, nr_seq_matpaci_p bigint, cd_material_atend_paciente_p bigint, cd_procedimento_pac_p bigint, ie_origem_proced_pac_p bigint, nr_interno_conta_p bigint, cd_autorizacao_p text, nr_seq_protocolo_p bigint, nm_usuario_p text, nm_usuario_resp INOUT text ) FROM PUBLIC;
