-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE panorama_watchlist_pck.atualiza_acomp_watchlist ( nm_usuario_p pessoa_fisica.nm_usuario%TYPE, cd_profissional_p panorama_acomp_prof.cd_profissional%Type, cd_pessoa_fisica_p pessoa_fisica.cd_pessoa_fisica%TYPE, nr_sequencia_p gestao_vaga.nr_sequencia%TYPE) AS $body$
DECLARE


nr_sequencia_w          gestao_vaga.nr_sequencia%TYPE;
dt_atualizacao_w	    timestamp;
nm_usuario_w            pessoa_fisica.nm_usuario%TYPE;
cd_profissional_w       panorama_acomp_prof.cd_profissional%TYPE;
cd_pessoa_fisica_w      pessoa_fisica.cd_pessoa_fisica%TYPE;

C01 CURSOR FOR
    SELECT  nr_sequencia,
            nm_usuario,
            cd_pessoa_fisica,
            cd_profissional
    FROM    PANORAMA_ACOMP_WATCHLIST
    WHERE   cd_pessoa_fisica = cd_pessoa_fisica_p;


BEGIN

    SELECT	coalesce(MAX(cd_pessoa_fisica),0)
    INTO STRICT	cd_pessoa_fisica_w
    FROM	PANORAMA_ACOMP_WATCHLIST
    WHERE	cd_pessoa_fisica = cd_pessoa_fisica_p;

    dt_atualizacao_w	:= clock_timestamp();

    IF (cd_pessoa_fisica_w = 0) THEN
        BEGIN
            INSERT INTO PANORAMA_ACOMP_WATCHLIST(nr_sequencia,
                dt_atualizacao,
                nm_usuario,
                dt_atualizacao_nrec,
                nm_usuario_nrec,
                cd_pessoa_fisica,
                cd_profissional,
                watchlist_id,
                cd_profissional_ori)
            VALUES (nr_sequencia_p,
                dt_atualizacao_w,
                nm_usuario_p,
                dt_atualizacao_w,
                nm_usuario_p,
                cd_pessoa_fisica_p,
                cd_profissional_p,
                nr_sequencia_p,
                cd_profissional_p);
        END;
    END IF;

OPEN C01;
LOOP
FETCH C01 INTO
    nr_sequencia_w,
    nm_usuario_w,
    cd_pessoa_fisica_w,
    cd_profissional_w;
EXIT WHEN NOT FOUND; /* apply on C01 */

IF (cd_pessoa_fisica_w = cd_pessoa_fisica_p) THEN
    BEGIN
        UPDATE PANORAMA_ACOMP_WATCHLIST
        SET nm_usuario_nrec = nm_usuario_p,
        cd_profissional = cd_profissional_p,
        dt_atualizacao_nrec = dt_atualizacao_w
        WHERE watchlist_id = nr_sequencia_p;
    END;
END IF;
END LOOP;
CLOSE C01;

COMMIT;
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE panorama_watchlist_pck.atualiza_acomp_watchlist ( nm_usuario_p pessoa_fisica.nm_usuario%TYPE, cd_profissional_p panorama_acomp_prof.cd_profissional%Type, cd_pessoa_fisica_p pessoa_fisica.cd_pessoa_fisica%TYPE, nr_sequencia_p gestao_vaga.nr_sequencia%TYPE) FROM PUBLIC;
