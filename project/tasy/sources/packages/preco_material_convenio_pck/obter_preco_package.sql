-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION preco_material_convenio_pck.obter_preco (cd_material_p bigint) RETURNS SETOF T_PRECO_MATERIAL_CONVENIO AS $body$
DECLARE


t_preco_material_row_w	t_preco_material_convenio_row;
cd_convenio_w		convenio.cd_convenio%type;
ds_convenio_w		convenio.ds_convenio%type;
cd_categoria_w		categoria_convenio.cd_categoria%type;
ds_categoria_w		categoria_convenio.ds_categoria%type;
dt_vigencia_w		timestamp;
vl_material_w		double precision;
ds_origem_w		varchar(255);
ds_tabela_w		varchar(255);
cd_tab_preco_mat_w	bigint;
ie_origem_w		bigint;
nr_irrelevante_w	bigint;

c01 CURSOR FOR
SELECT	a.cd_convenio,
	a.ds_convenio,
	b.cd_categoria,
	b.ds_categoria
from	convenio a,
	categoria_convenio b
where	a.cd_convenio	= b.cd_convenio
and	b.ie_situacao = 'A'
order by ds_convenio, ds_categoria;



BEGIN

if (coalesce(cd_material_p,0) > 0) then

	open C01;
	loop
	fetch C01 into
		cd_convenio_w,
		ds_convenio_w,
		cd_categoria_w,
		ds_categoria_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin

		Define_Preco_Material(wheb_usuario_pck.get_cd_estabelecimento,
			cd_convenio_w,
			cd_categoria_w,
			clock_timestamp(),
			cd_material_p,
			0,
			0,
			0,
			null,
			0,
			null,
			null,
			null,
			null,
			null,
			null,
			null,
			null,
			null,
			vl_material_w,
			dt_vigencia_w,
			cd_tab_preco_mat_w,
			ie_origem_w,
			nr_irrelevante_w,
			nr_irrelevante_w,
			nr_irrelevante_w,
			nr_irrelevante_w,
			nr_irrelevante_w,
			nr_irrelevante_w,
			nr_irrelevante_w);

		select	max(substr(obter_valor_dominio(61,ie_origem_w),1,255))
		into STRICT	ds_origem_w
		;
		
		Select 	substr(max(ds_tab_preco_mat),1,255)
		into STRICT	ds_tabela_w
		from 	tabela_preco_material
		Where 	cd_tab_preco_mat 	= cd_tab_preco_mat_w
		and 	cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento;

		t_preco_material_row_w.cd_convenio	:= cd_convenio_w;
		t_preco_material_row_w.ds_convenio	:= ds_convenio_w;
		t_preco_material_row_w.ds_categoria	:= ds_categoria_w;
		t_preco_material_row_w.dt_vigencia	:= dt_vigencia_w;
		t_preco_material_row_w.vl_material	:= coalesce(vl_material_w,0);
		t_preco_material_row_w.ds_origem	:= ds_origem_w;
		t_preco_material_row_w.ds_tabela	:= ds_tabela_w;

		RETURN NEXT t_preco_material_row_w;

		end;
	end loop;
	close C01;

end if;

end;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION preco_material_convenio_pck.obter_preco (cd_material_p bigint) FROM PUBLIC;
