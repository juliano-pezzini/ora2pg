-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


--Prestador



CREATE OR REPLACE PROCEDURE pls_gerar_mala_direta_pck.gerar_cooperado ( nr_seq_situacao_cooperado_p bigint, nr_seq_especialidade_coop_p bigint, ie_vinc_contratual_coop_p text, nr_crm_cooperado_p text, area_atuacao_coop_p bigint, cd_municipio_cooperado_p text, ie_tipo_cooperado_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE


/*
Situacao cooperado
Especialidade cooperado
vinculos contratuais
CRM
Area atuacao
Municipio
Tipo cooperado
*/


nr_seq_cooperado_w		bigint;
cd_cgc_cooperado_w		varchar(14);
cd_pf_cooperado_w		varchar(10);
qt_registros_cooperado_w	integer;
ie_parametro_w			varchar(10);

C04 CURSOR FOR
	SELECT	nr_sequencia,
		cd_cgc,
		cd_pessoa_fisica
	from	pls_cooperado
	where	cd_estabelecimento	= cd_estabelecimento_p
	and	((nr_seq_situacao	= nr_seq_situacao_cooperado_p and (nr_seq_situacao_cooperado_p IS NOT NULL AND nr_seq_situacao_cooperado_p::text <> '')) or (coalesce(nr_seq_situacao_cooperado_p::text, '') = ''));


BEGIN
Obter_Param_Usuario(1228, 5, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_parametro_w);

open C04;
loop
fetch C04 into
	nr_seq_cooperado_w,
	cd_cgc_cooperado_w,
	cd_pf_cooperado_w;
EXIT WHEN NOT FOUND; /* apply on C04 */
	begin
	
	if (ie_tipo_cooperado_p	> 1) then
		if (ie_tipo_cooperado_p = 3) and (coalesce(cd_pf_cooperado_w::text, '') = '') then
			goto final;
		elsif (ie_tipo_cooperado_p = 2) and (coalesce(cd_cgc_cooperado_w::text, '') = '') then
			goto final;
		end if;
	end if;
	
	if (cd_pf_cooperado_w IS NOT NULL AND cd_pf_cooperado_w::text <> '') then
		if (cd_municipio_cooperado_p IS NOT NULL AND cd_municipio_cooperado_p::text <> '') then
			select	count(1)
			into STRICT	qt_registros_cooperado_w
			from	pessoa_fisica		b,
				compl_pessoa_fisica	a
			where	b.cd_pessoa_fisica	= a.cd_pessoa_fisica
			and	b.cd_pessoa_fisica	= cd_pf_cooperado_w
			and	a.cd_municipio_ibge	= cd_municipio_cooperado_p
			and	a.ie_tipo_complemento	= 1;
			
			if (qt_registros_cooperado_w = 0) then
				goto final;
			end if;
		end if;
		
		if (area_atuacao_coop_p IS NOT NULL AND area_atuacao_coop_p::text <> '') then
			select	count(1)
			into STRICT	qt_registros_cooperado_w
			from	medico_area_atuacao a,
				pessoa_fisica b
			where	a.cd_pessoa_fisica	= b.cd_pessoa_fisica
			and	b.cd_pessoa_fisica	= cd_pf_cooperado_w
			and	a.nr_seq_area_atuacao	= area_atuacao_coop_p;
			
			if (qt_registros_cooperado_w = 0) then
				goto final;
			end if;
		end if;
		
		if (nr_crm_cooperado_p IS NOT NULL AND nr_crm_cooperado_p::text <> '') then
			select	count(1)
			into STRICT	qt_registros_cooperado_w
			from	pessoa_fisica		b,
				medico			a
			where	b.cd_pessoa_fisica	= a.cd_pessoa_fisica
			and	b.cd_pessoa_fisica	= cd_pf_cooperado_w
			and	a.nr_crm		= nr_crm_cooperado_p;
			
			if (qt_registros_cooperado_w = 0) then
				goto final;
			end if;
		end if;
		
		if (ie_vinc_contratual_coop_p	= 'S') then
			select	count(1)
			into STRICT	qt_registros_cooperado_w
			from	pls_contrato_pagador	b,
				pls_contrato		a
			where	b.nr_seq_contrato	= a.nr_sequencia
			and	b.cd_pessoa_fisica	= cd_pf_cooperado_w;
			
			if (qt_registros_cooperado_w > 0) then
				goto final;
			end if;
		end if;
		
		if (nr_seq_especialidade_coop_p IS NOT NULL AND nr_seq_especialidade_coop_p::text <> '') then
			if (obter_se_especialidade_medico(cd_pf_cooperado_w, nr_seq_especialidade_coop_p) = 'N') then
				goto final;
			end if;
		end if;
		
	elsif (cd_cgc_cooperado_w IS NOT NULL AND cd_cgc_cooperado_w::text <> '') then
		
		if (cd_municipio_cooperado_p IS NOT NULL AND cd_municipio_cooperado_p::text <> '') then
			select	count(1)
			into STRICT	qt_registros_cooperado_w
			from	pessoa_juridica	
			where	cd_cgc			= cd_cgc_cooperado_w
			and	cd_municipio_ibge	= cd_municipio_cooperado_p;
			
			if (qt_registros_cooperado_w = 0) then
				goto final;
			end if;
		end if;
		
		if (ie_vinc_contratual_coop_p	= 'S') then
			select	count(1)
			into STRICT	qt_registros_cooperado_w
			from	pls_contrato_pagador	b,
				pls_contrato		a
			where	b.nr_seq_contrato	= a.nr_sequencia
			and	b.cd_cgc		= cd_cgc_cooperado_w;
			
			if (qt_registros_cooperado_w > 0) then
				goto final;
			end if;
		end if;
		
		if (nr_crm_cooperado_p IS NOT NULL AND nr_crm_cooperado_p::text <> '') then
			goto final;
		end if;
		
		if (nr_seq_especialidade_coop_p IS NOT NULL AND nr_seq_especialidade_coop_p::text <> '') then
			select	count(1)
			into STRICT	qt_registros_cooperado_w
			from	especialidade_medica c,
				pls_prestador_med_espec b,
				pls_prestador		a
			where	b.cd_especialidade	= c.cd_especialidade
			and	b.nr_seq_prestador	= a.nr_sequencia
			and	a.cd_cgc		= cd_cgc_cooperado_w
			and	c.cd_especialidade	= nr_seq_especialidade_coop_p
			and	coalesce(b.cd_pessoa_fisica::text, '') = '';
			
			if (qt_registros_cooperado_w = 0) then
				goto final;
			end if;
		end if;
	end if;
	
	CALL pls_inserir_mala_direta(cd_pf_cooperado_w, 0, '',
			'Cooperado', 0, 0,
			cd_cgc_cooperado_w, null, nm_usuario_p,
			cd_estabelecimento_p,null,0,0,ie_parametro_w, 0, null, 'N', 0, null);
	
	<<final>>
	nr_seq_cooperado_w	:= nr_seq_cooperado_w;
	end;
end loop;
close C04;
	
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_mala_direta_pck.gerar_cooperado ( nr_seq_situacao_cooperado_p bigint, nr_seq_especialidade_coop_p bigint, ie_vinc_contratual_coop_p text, nr_crm_cooperado_p text, area_atuacao_coop_p bigint, cd_municipio_cooperado_p text, ie_tipo_cooperado_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;
