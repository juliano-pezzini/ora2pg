-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


-- Obter qual data deve ser utilizada para realizacao do calculo do prazo.



CREATE OR REPLACE FUNCTION pls_taxa_intercambio_pck.obter_data_item ( ie_tipo_guia_p pls_conta.ie_tipo_guia%type, ie_tipo_conta_p pls_conta.ie_tipo_conta%type, dt_alta_p pls_conta.dt_alta%type, dt_atendimento_p pls_conta.dt_atendimento%type, dt_item_p pls_conta_proc.dt_procedimento%type, nr_seq_proc_p pls_conta_proc.nr_sequencia%type, nr_seq_mat_p pls_conta_mat.nr_sequencia%type) RETURNS timestamp AS $body$
DECLARE

dt_item_w	timestamp;


BEGIN

/*
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

**************************************************************************************************************************************************************************************
**************************************************************************************************************************************************************************************
**************************************************************************************************************************************************************************************
********* SE FOR ALTERAR ALGUMA COISA NESTA ROTINA, FAVOR VERIFICAR A pls_cta_valorizacao_pck a function obter_data_item*************************************************************
********* HOUVE DUPLICACAO DE CODIGO PARA MANTERMOS AS TAXAS DE INTERCAMBIO FUNCIONANDO NOS DOIS MODELOS ************************************************************
**************************************************************************************************************************************************************************************
**************************************************************************************************************************************************************************************
**************************************************************************************************************************************************************************************
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

*/

--Alterado o tratamento pois tanto cobranca quanto pagamento a data a ser considerada e a data da conta e nao a data do item, ponto tratado junto ao analista Leonardo

-- Quando a guia for de internacao entao deve se verificar se a conta ja tem data de alta, se tive entao esta data deve ser utilizada, caso contrario utiiliza apenas a data do adtendimento

if (ie_tipo_guia_p = 5) then

	-- Se a conta tiver data de alta utiliza esta data, caso contrario usar a do atendimento;

	if (dt_alta_p IS NOT NULL AND dt_alta_p::text <> '') then
		
		dt_item_w := dt_alta_p;
	else
		dt_item_w := dt_atendimento_p;
	end if;
else	
	-- Se nao for guia de Internacao entao utiliza apenas a data do atendimento.

	dt_item_w := dt_atendimento_p;
end if;

return dt_item_w;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pls_taxa_intercambio_pck.obter_data_item ( ie_tipo_guia_p pls_conta.ie_tipo_guia%type, ie_tipo_conta_p pls_conta.ie_tipo_conta%type, dt_alta_p pls_conta.dt_alta%type, dt_atendimento_p pls_conta.dt_atendimento%type, dt_item_p pls_conta_proc.dt_procedimento%type, nr_seq_proc_p pls_conta_proc.nr_sequencia%type, nr_seq_mat_p pls_conta_mat.nr_sequencia%type) FROM PUBLIC;
