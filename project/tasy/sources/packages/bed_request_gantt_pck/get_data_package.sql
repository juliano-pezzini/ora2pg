-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION bed_request_gantt_pck.get_data () RETURNS SETOF GANTT_TABLE AS $body$
DECLARE


    gantt_record_w gantt_record;
    nova_data_w timestamp;
    qtd_dias_w smallint := 0;
    qtd_pessoas_entrou_apu_w smallint := 0;
    qtd_pessoas_entrou_gv_w integer := 0;
    qtd_pessoas_saiu_w integer := 0;
    qtd_pessoas_total_w integer := 0;

    regra_acomodacao CURSOR FOR
        SELECT 
            trunc(coalesce(ra.dt_fim, clock_timestamp()) - ra.dt_inicio) as duration,
            ra.dt_inicio as DT_INICIO,
            coalesce(ra.dt_fim, clock_timestamp()) as DT_FIM,
            ra.cd_tipo_acomodacao as cd_tipo_acomodacao,
            ra.IE_DIA_SEMANA AS IE_DIA_SEMANA,
            ra.qt_vagas AS qt_vagas,
            ta.ds_tipo_acomodacao text
        FROM TIPO_ACOMODACAO ta
        right join REGRA_RESERVA_VAGA_ACOMOD ra on ta.cd_tipo_acomodacao = ra.cd_tipo_acomodacao
        where ta.ie_situacao = 'A' and (ra.dt_inicio IS NOT NULL AND ra.dt_inicio::text <> '');


BEGIN
        for recordx in regra_acomodacao loop
            qtd_dias_w := 0;
            qtd_pessoas_entrou_apu_w := 0;
            qtd_pessoas_entrou_gv_w := 0;
            qtd_pessoas_saiu_w := 0;
            qtd_pessoas_total_w := 0;

            for x in qtd_dias_w .. recordx.duration loop
                nova_data_w := recordx.dt_inicio  + x;

                /*get number of people who entered through the single entrance*/
                SELECT count(apu.cd_tipo_acomodacao) into STRICT qtd_pessoas_entrou_apu_w FROM ATEND_PACIENTE_UNIDADE apu 
                where apu.cd_tipo_acomodacao = recordx.cd_tipo_acomodacao
                and to_char(apu.dt_entrada_unidade, 'DD/MM/YYYY') = nova_data_w;

                /*obtain the number of people who joined through the management of vacancies*/

                SELECT count(gv.nr_sequencia) into STRICT qtd_pessoas_entrou_gv_w FROM gestao_vaga gv
                where gv.cd_tipo_acomod_desej = recordx.cd_tipo_acomodacao
                and to_char(gv.dt_prevista, 'DD/MM/YYYY') = nova_data_w;

                /*get amount of people who left*/

                SELECT count(apu.cd_tipo_acomodacao) into STRICT qtd_pessoas_saiu_w FROM ATEND_PACIENTE_UNIDADE apu
                where apu.cd_tipo_acomodacao = recordx.cd_tipo_acomodacao
                and to_char(apu.dt_saida_unidade, 'DD/MM/YYYY') = nova_data_w;

                qtd_pessoas_total_w := (qtd_pessoas_total_w + qtd_pessoas_entrou_apu_w + qtd_pessoas_entrou_gv_w) - qtd_pessoas_saiu_w;

                gantt_record_w.cd_tipo_acomodacao := recordx.cd_tipo_acomodacao;
                gantt_record_w.text               := recordx.text;
                gantt_record_w.start_date         := nova_data_w;
                gantt_record_w.duracao            := 1;
                gantt_record_w.dt_inicio          := nova_data_w;
                gantt_record_w.dt_fim             := nova_data_w;
                gantt_record_w.IE_DIA_SEMANA      := recordx.IE_DIA_SEMANA;
                gantt_record_w.qtd_total          := recordx.qt_vagas;
                gantt_record_w.qtd_ocup           := qtd_pessoas_total_w;
                gantt_record_w.progress           := round((qtd_pessoas_total_w  / recordx.qt_vagas )::numeric,2);
                gantt_record_w.porcentagem        := qtd_pessoas_total_w  || '/' ||  recordx.qt_vagas;
                gantt_record_w.porcentagem2       := coalesce(ROUND(((qtd_pessoas_total_w * 100) / recordx.qt_vagas),2),0) || '%';
                RETURN NEXT gantt_record_w;

            end loop;
        end loop;

    return;
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION bed_request_gantt_pck.get_data () FROM PUBLIC;
