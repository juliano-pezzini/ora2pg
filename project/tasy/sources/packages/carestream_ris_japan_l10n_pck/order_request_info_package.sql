-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE carestream_ris_japan_l10n_pck.order_request_info (file_name_p text) AS $body$
DECLARE


    request_classification_w   varchar(2);
    request_type_w             varchar(3);
    execution_date_w             varchar(15);
    prescription_number_w      varchar(14);
    file_name_like_w           varchar(8);
    cd_establishment_w         varchar(8);
    nm_usuario_w             varchar(255);
    message_char_w           varchar(32000);

    c08 CURSOR FOR
    SELECT
        a.nr_sequencia   nr_seq_interno,
        a.nr_prescricao  prescription_number,
        e.dt_horario scheduled_date,
        coalesce(x.cd_estabelecimento, obter_estabelecimento_ativo) cd_establishment,
        e.nr_sequencia procedimento_sequence
    from
        prescr_procedimento       a,
        proc_interno_integracao   b,
        proc_interno              c,
        procedimento              d,
        prescr_proc_hor           e,
        prescr_medica             f,
        atendimento_paciente      x
    where
        a.nr_prescricao = f.nr_prescricao
        and c.nr_sequencia = a.nr_seq_proc_interno
        and coalesce(b.nr_seq_proc_interno, a.nr_seq_proc_interno) = a.nr_seq_proc_interno
        and c.cd_procedimento = d.cd_procedimento
        and c.ie_origem_proced = d.ie_origem_proced
        and coalesce(b.cd_estabelecimento, obter_estabelecimento_ativo) = coalesce(obter_estabelecimento_ativo, 0)
        and coalesce(b.cd_tipo_procedimento, coalesce(d.cd_tipo_procedimento, 0)) = coalesce(d.cd_tipo_procedimento, 0)
        and b.nr_seq_sistema_integ = 233
        and e.nr_prescricao = a.nr_prescricao
        and e.nr_seq_procedimento = a.nr_sequencia
        and f.cd_pessoa_fisica = current_setting('carestream_ris_japan_l10n_pck.patient_id_w')::varchar(10)
        and ( ( coalesce(execution_date_w::text, '') = ''
                and e.dt_horario >= clock_timestamp() )
              or ( (execution_date_w IS NOT NULL AND execution_date_w::text <> '')
                   and trunc(e.dt_horario) = execution_date_w ) )
        and f.nr_atendimento = x.nr_atendimento
        and f.nr_prescricao = a.nr_prescricao
        and coalesce(a.nr_seq_exame::text, '') = '';



BEGIN
        PERFORM set_config('carestream_ris_japan_l10n_pck.ds_local_w', null, false);
        PERFORM set_config('carestream_ris_japan_l10n_pck.initial_position_w', 1, false);
        nm_usuario_w := 'tasy_ris';
        PERFORM set_config('carestream_ris_japan_l10n_pck.nm_interface_w', 'Japan Carestream - RIS', false);
        PERFORM set_config('carestream_ris_japan_l10n_pck.ds_message_w', 'CareStream Radiology - Order Request Info', false);
        PERFORM set_config('carestream_ris_japan_l10n_pck.log_sequence_number_w', 0, false);

        select carestream_japan_l10n_pck.get_directory_event_code(null, 'CARE_RIS_RRQ')
        into STRICT   current_setting('carestream_ris_japan_l10n_pck.cd_integartion_event_w')::philips_json
;

        select carestream_japan_l10n_pck.get_log_file_name(current_setting('carestream_ris_japan_l10n_pck.cd_integartion_event_w')::philips_json.get['control_code'].value_of(),
                  current_setting('carestream_ris_japan_l10n_pck.his_system_code')::varchar(2), current_setting('carestream_ris_japan_l10n_pck.radiology_dept_code_w')::varchar(2), 'R')
        into STRICT current_setting('carestream_ris_japan_l10n_pck.log_file_name_w')::varchar(100)
;

         file_name_like_w := 'H'||current_setting('carestream_ris_japan_l10n_pck.radiology_dept_code_w')::varchar(2)||current_setting('carestream_ris_japan_l10n_pck.his_system_code')::varchar(2)||current_setting('carestream_ris_japan_l10n_pck.cd_integartion_event_w')::philips_json.get['control_code'].value_of();


                current_setting('carestream_ris_japan_l10n_pck.ds_local_w')::varchar(32767) := carestream_japan_l10n_pck.read_file(file_name_p, file_name_like_w, current_setting('carestream_ris_japan_l10n_pck.cd_integartion_event_w')::philips_json.get['cd_event_data'].value_of(), current_setting('carestream_ris_japan_l10n_pck.ds_local_w')::varchar(32767));
                select utl_i18n.raw_to_char(current_setting('carestream_ris_japan_l10n_pck.ds_local_w')::varchar(32767))
                into STRICT message_char_w
;

                --retriving the relevant field from the inbound message
                begin
                    select
                        utl_i18n.raw_to_char(utl_raw.substr(current_setting('carestream_ris_japan_l10n_pck.ds_local_w')::varchar(32767), carestream_ris_japan_l10n_pck.update_initial_position(current_setting('carestream_ris_japan_l10n_pck.initial_position_w')::integer, 0), 2), 'JA16SJIS'), -- 1 
                        (utl_i18n.raw_to_char(utl_raw.substr(current_setting('carestream_ris_japan_l10n_pck.ds_local_w')::varchar(32767), carestream_ris_japan_l10n_pck.update_initial_position(current_setting('carestream_ris_japan_l10n_pck.initial_position_w')::integer, 43), 10), 'JA16SJIS'))::numeric ,  --44
                        utl_i18n.raw_to_char(utl_raw.substr(current_setting('carestream_ris_japan_l10n_pck.ds_local_w')::varchar(32767), carestream_ris_japan_l10n_pck.update_initial_position(current_setting('carestream_ris_japan_l10n_pck.initial_position_w')::integer, 10), 2), 'JA16SJIS'), --54
                        trim(both utl_i18n.raw_to_char(utl_raw.substr(current_setting('carestream_ris_japan_l10n_pck.ds_local_w')::varchar(32767), carestream_ris_japan_l10n_pck.update_initial_position(current_setting('carestream_ris_japan_l10n_pck.initial_position_w')::integer, 2), 3), 'JA16SJIS')), --56
                        trim(both utl_i18n.raw_to_char(utl_raw.substr(current_setting('carestream_ris_japan_l10n_pck.ds_local_w')::varchar(32767), carestream_ris_japan_l10n_pck.update_initial_position(current_setting('carestream_ris_japan_l10n_pck.initial_position_w')::integer, 3), 8), 'JA16SJIS')) --59
                    into STRICT
                        current_setting('carestream_ris_japan_l10n_pck.message_type_w')::varchar(2),
                        current_setting('carestream_ris_japan_l10n_pck.patient_mrn_w')::varchar(10),
                        request_classification_w,
                        request_type_w,
                        execution_date_w
;

                     -- processing the inbound message and updating it in tasy 
                    if ((execution_date_w IS NOT NULL AND execution_date_w::text <> '') or execution_date_w <> '') then
                        execution_date_w := to_date(execution_date_w,'YYYYMMDD');
                    end if;
                exception
                    when others then
                        CALL carestream_japan_l10n_pck.update_recieve_error_file(file_name_p, current_setting('carestream_ris_japan_l10n_pck.log_file_name_w')::varchar(100), current_setting('carestream_ris_japan_l10n_pck.message_type_w')::varchar(2));

                        PERFORM set_config('carestream_ris_japan_l10n_pck.ds_log_message_w', 'Error occured while reading the integration message for order retransimt request info'
                                            ||  chr(10)
                                            || 'Integration name : japan_carestream_ris(order_Retransmit_info)'
                                            || chr(10)
                                            || 'Message Type:'
                                            || current_setting('carestream_ris_japan_l10n_pck.message_type_w')::varchar(2)
                                            || chr(10)
                                            || 'Time of faliure : '
                                            || clock_timestamp() || chr(10)
                                            || 'Patient MRN:'
                                            || current_setting('carestream_ris_japan_l10n_pck.patient_mrn_w')::varchar(10) || chr(10)
                                            ||' -ERROR- '
                                            || SQLERRM, false);

                        record_integration_call_log(nm_usuario_w, nm_usuario_w, clock_timestamp(), current_setting('carestream_ris_japan_l10n_pck.nm_interface_w')::varchar(255), current_setting('carestream_ris_japan_l10n_pck.ds_message_w')::varchar(255),
                                                    'F', 'R', null, current_setting('carestream_ris_japan_l10n_pck.ds_log_message_w')::varchar(32767), message_char_w,
                                                    current_setting('carestream_ris_japan_l10n_pck.ds_log_message_w')::varchar(32767), file_name_p, current_setting('carestream_ris_japan_l10n_pck.log_sequence_number_w')::integration_message_log.nr_seq_int_call_log%type, current_setting('carestream_ris_japan_l10n_pck.patient_mrn_w')::varchar(10), null);

                        CALL carestream_japan_l10n_pck.save_log(current_setting('carestream_ris_japan_l10n_pck.cd_integartion_event_w')::philips_json.get['cd_event_log'].value_of(), current_setting('carestream_ris_japan_l10n_pck.log_file_name_w')::varchar(100), current_setting('carestream_ris_japan_l10n_pck.ds_log_message_w')::varchar(32767));
                        return;
                  end;


                select obter_paciente_prontuario(current_setting('carestream_ris_japan_l10n_pck.patient_mrn_w')::varchar(10), 'C')
                into STRICT current_setting('carestream_ris_japan_l10n_pck.patient_id_w')::varchar(10)
;

                PERFORM set_config('carestream_ris_japan_l10n_pck.ds_log_message_w', 'Information for order Retransmission  is successfully retrived'
                                        || chr(10)
                                        || 'Integration name : japan_carestream_ris(patient_order_req_info)'
                                        || chr(10)
                                        || 'Message Type:'
                                        || current_setting('carestream_ris_japan_l10n_pck.message_type_w')::varchar(2)
                                        || chr(10)
                                        || 'Execution Time : '
                                        || execution_date_w || chr(10)
                                        || 'Patient MRN:'
                                        || current_setting('carestream_ris_japan_l10n_pck.patient_mrn_w')::varchar(10) , false);

                record_integration_call_log(nm_usuario_w, nm_usuario_w, clock_timestamp(), current_setting('carestream_ris_japan_l10n_pck.nm_interface_w')::varchar(255), current_setting('carestream_ris_japan_l10n_pck.ds_message_w')::varchar(255),
                                        'P', 'R', null, current_setting('carestream_ris_japan_l10n_pck.ds_log_message_w')::varchar(32767), message_char_w, 
                                        null, file_name_p, current_setting('carestream_ris_japan_l10n_pck.log_sequence_number_w')::integration_message_log.nr_seq_int_call_log%type, current_setting('carestream_ris_japan_l10n_pck.patient_mrn_w')::varchar(10), null);

                for r_c08 in c08 loop
                    begin
                        CALL carestream_ris_japan_l10n_pck.patient_order_info(r_c08.prescription_number, r_c08.nr_seq_interno,  r_c08.procedimento_sequence, '3E', '1', nm_usuario_w, current_setting('carestream_ris_japan_l10n_pck.log_sequence_number_w')::integration_message_log.nr_seq_int_call_log%type, null, r_c08.cd_establishment,'N');
                    end;
                end loop;

                -- if file succcessfully read and info saved in tasy,calling function to move the file to repective ok folder from data and index folder
                CALL carestream_japan_l10n_pck.update_recieve_ok_file(file_name_p, current_setting('carestream_ris_japan_l10n_pck.log_file_name_w')::varchar(100), current_setting('carestream_ris_japan_l10n_pck.message_type_w')::varchar(2));

                PERFORM set_config('carestream_ris_japan_l10n_pck.ds_log_message_w', 'Information for order Retransmission  is successfully sent'
                                        || chr(10)
                                        || 'Integration name : japan_carestream_ris(patient_order_req_info)'
                                        || chr(10)
                                        || 'Message Type:'
                                        || current_setting('carestream_ris_japan_l10n_pck.message_type_w')::varchar(2)
                                        || chr(10)
                                        || 'Time of Success : '
                                        || clock_timestamp() || chr(10)
                                        || 'Patient MRN:'
                                        || current_setting('carestream_ris_japan_l10n_pck.patient_mrn_w')::varchar(10) , false);

            record_integration_call_log(nm_usuario_w, nm_usuario_w, clock_timestamp(), current_setting('carestream_ris_japan_l10n_pck.nm_interface_w')::varchar(255), current_setting('carestream_ris_japan_l10n_pck.ds_message_w')::varchar(255),
                                        'S', 'R', null, current_setting('carestream_ris_japan_l10n_pck.ds_log_message_w')::varchar(32767), current_setting('carestream_ris_japan_l10n_pck.ds_log_message_w')::varchar(32767), 
                                        null, file_name_p, current_setting('carestream_ris_japan_l10n_pck.log_sequence_number_w')::integration_message_log.nr_seq_int_call_log%type, current_setting('carestream_ris_japan_l10n_pck.patient_mrn_w')::varchar(10), null);

    END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE carestream_ris_japan_l10n_pck.order_request_info (file_name_p text) FROM PUBLIC;
