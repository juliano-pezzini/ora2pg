-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE carestream_ris_japan_l10n_pck.order_execution_info (file_name_p text) AS $body$
DECLARE


        ris_exam_exec_seq  ris_exam_exec_info.NR_SEQUENCIA%TYPE;
        ris_exam_proc_seq   ris_exam_exec_proc.NR_SEQUENCIA%TYPE;
        physician_exec1_w 		bigint;
        physician_exec2_w 		bigint;
        physician_exec3_w 		bigint;
        exam_technician1_w 		bigint;
        exam_technician2_w 		bigint;
        exam_technician3_w 		bigint;
        encounter_type_w 		varchar(2);
        exec_room_code_w 		varchar(2);
        his_comment_w 			varchar(512);
        exam_type_w 			smallint;
        exec_user_code_w 		bigint;
        medical_dept_w 			varchar(4);
        updated_user_id_w 		varchar(255);
        exam_exec_date_w 		timestamp;
        occurred_date_w 		timestamp;
        cancel_flag_w 			varchar(1);
        nr_part_seq_w 			integer;
        body_part_code_w 		integer;
        img_room_code_w 		varchar(2);
        comment_classif_w 		smallint;
        comment_code_w 			smallint;
        comment_count_w 		integer;
        patient_id 				varchar(10);
        processing_type_w      	varchar(1);
        processing_date_w      	timestamp;
        order_number_w         	varchar(14);
        sequence_number_w       varchar(10);
        cancelation_status_w   	varchar(1);
        discontinue_reason_w   	varchar(2);
        nm_usuario_w           	varchar(255);
        file_name_like_w       	varchar(8);
        cancel_classif_w 	    varchar(1);
        func_exam_classif_w     varchar(2);
        func_exam_code_w		varchar(3);
        func_exam_count_w       integer;
        body_parts_count_w   	integer;
        body_part_num_w  		integer;
        body_part_code 			integer;
        cd_material_classif_w	smallint;
        equipment_count_w 		integer;
        equipment_code_w       	varchar(8);
        qt_equipments_w			integer;
        equipment_std_code_w	varchar(2);
        medicine_count_w		integer;
        medicine_code_w 		varchar(8);
        used_medicine_amt_w 	integer;
        medicine_std_code_w	varchar(2);
        film_count_w			integer;
        flim_code_count_w 		integer;
        fraction_count_w 		integer;
        exposure_count_w 		integer;
        flim_code_w 		    smallint;
        physician_code_w        varchar(10);
        img_code_sec_w          varchar(4);
        img_code_ma_w           varchar(4);
        img_code_kv_w            varchar(4);
        img_code_cm_w           varchar(4);
        img_equipment_code_w    varchar(2);
        ie_status_report_w      smallint;
        cd_establishment_w      integer;
        ie_status_execucao_w    smallint;
        ie_retrogrado_w cpoe_procedimento.ie_retrogrado%type;
        ie_transmit_special_order_w varchar(1);
        message_char_w           varchar(32000);


BEGIN
        PERFORM set_config('carestream_ris_japan_l10n_pck.ds_local_w', null, false);
        PERFORM set_config('carestream_ris_japan_l10n_pck.initial_position_w', 1, false);
        PERFORM set_config('carestream_ris_japan_l10n_pck.patient_id_w', null, false);
        PERFORM set_config('carestream_ris_japan_l10n_pck.patient_mrn_w', null, false);
        nm_usuario_w     := 'carestream_ris';
        PERFORM set_config('carestream_ris_japan_l10n_pck.nm_interface_w', 'Japan Carestream - RIS', false);
        PERFORM set_config('carestream_ris_japan_l10n_pck.ds_message_w', 'CareStream RIS - Order Execution Info', false);
        updated_user_id_w := 'ris_dept';
        PERFORM set_config('carestream_ris_japan_l10n_pck.log_sequence_number_w', 0, false);

        select carestream_japan_l10n_pck.get_directory_event_code(null, 'CARE_RIS_COST')
        into STRICT   current_setting('carestream_ris_japan_l10n_pck.cd_integartion_event_w')::philips_json
;

        select carestream_japan_l10n_pck.get_log_file_name(current_setting('carestream_ris_japan_l10n_pck.cd_integartion_event_w')::philips_json.get['control_code'].value_of(),
                  current_setting('carestream_ris_japan_l10n_pck.his_system_code')::varchar(2), current_setting('carestream_ris_japan_l10n_pck.radiology_dept_code_w')::varchar(2), 'R')
        into STRICT current_setting('carestream_ris_japan_l10n_pck.log_file_name_w')::varchar(100)
;

        file_name_like_w := 'H'||current_setting('carestream_ris_japan_l10n_pck.radiology_dept_code_w')::varchar(2)||current_setting('carestream_ris_japan_l10n_pck.his_system_code')::varchar(2)||current_setting('carestream_ris_japan_l10n_pck.cd_integartion_event_w')::philips_json.get['control_code'].value_of();

        begin
            current_setting('carestream_ris_japan_l10n_pck.ds_local_w')::varchar(32767) := carestream_japan_l10n_pck.read_file(file_name_p, file_name_like_w, current_setting('carestream_ris_japan_l10n_pck.cd_integartion_event_w')::philips_json.get['cd_event_data'].value_of(), current_setting('carestream_ris_japan_l10n_pck.ds_local_w')::varchar(32767));
            select utl_i18n.raw_to_char(current_setting('carestream_ris_japan_l10n_pck.ds_local_w')::varchar(32767))
            into STRICT message_char_w
;
            --retriving the relevant field from the inbound message
            PERFORM set_config('carestream_ris_japan_l10n_pck.message_type_w', utl_i18n.raw_to_char(utl_raw.substr(current_setting('carestream_ris_japan_l10n_pck.ds_local_w')::varchar(32767), carestream_ris_japan_l10n_pck.update_initial_position(current_setting('carestream_ris_japan_l10n_pck.initial_position_w')::integer, 0), 2), 'JA16SJIS'), false);
            if (current_setting('carestream_ris_japan_l10n_pck.message_type_w')::varchar(2) not in ('2S', '2T', '2U'))then
            return;
            end if;								                        --1 MESSAGE_TYPE
            processing_type_w := (trim(both utl_i18n.raw_to_char(utl_raw.substr(current_setting('carestream_ris_japan_l10n_pck.ds_local_w')::varchar(32767), carestream_ris_japan_l10n_pck.update_initial_position(current_setting('carestream_ris_japan_l10n_pck.initial_position_w')::integer, 28), 1), 'JA16SJIS')))::numeric; 				                        --29 PROCESSING_CLASSIFICATION
            processing_date_w:= to_date(trim(both utl_i18n.raw_to_char(utl_raw.substr(current_setting('carestream_ris_japan_l10n_pck.ds_local_w')::varchar(32767), carestream_ris_japan_l10n_pck.update_initial_position(current_setting('carestream_ris_japan_l10n_pck.initial_position_w')::integer, 1), 14), 'JA16SJIS')), 'YYYYMMDDHH24MISS');  	                    --30 PROCESSING_DATE
            PERFORM set_config('carestream_ris_japan_l10n_pck.patient_mrn_w', (trim(both utl_i18n.raw_to_char(utl_raw.substr(current_setting('carestream_ris_japan_l10n_pck.ds_local_w')::varchar(32767), carestream_ris_japan_l10n_pck.update_initial_position(current_setting('carestream_ris_japan_l10n_pck.initial_position_w')::integer, 14), 10), 'JA16SJIS')))::numeric , false);  					                        --44 PATIENT_MRN                
            occurred_date_w:= to_date(trim(both utl_i18n.raw_to_char(utl_raw.substr(current_setting('carestream_ris_japan_l10n_pck.ds_local_w')::varchar(32767), carestream_ris_japan_l10n_pck.update_initial_position(current_setting('carestream_ris_japan_l10n_pck.initial_position_w')::integer, 10), 14), 'JA16SJIS')), 'YYYYMMDDHH24MISS');                         --54 OCCURED_DATE_TIME
            order_number_w := (trim(both utl_i18n.raw_to_char(utl_raw.substr(current_setting('carestream_ris_japan_l10n_pck.ds_local_w')::varchar(32767), carestream_ris_japan_l10n_pck.update_initial_position(current_setting('carestream_ris_japan_l10n_pck.initial_position_w')::integer, 29), 14), 'JA16SJIS')))::numeric;  					                        -- 83 ORDER_NUMBER
            sequence_number_w:= (trim(both utl_i18n.raw_to_char(utl_raw.substr(current_setting('carestream_ris_japan_l10n_pck.ds_local_w')::varchar(32767), carestream_ris_japan_l10n_pck.update_initial_position(current_setting('carestream_ris_japan_l10n_pck.initial_position_w')::integer, 14), 10), 'JA16SJIS')))::numeric; 				                        --97 ORDER_SEQUENCE_NUMBER
            cancel_classif_w:= trim(both utl_i18n.raw_to_char(utl_raw.substr(current_setting('carestream_ris_japan_l10n_pck.ds_local_w')::varchar(32767), carestream_ris_japan_l10n_pck.update_initial_position(current_setting('carestream_ris_japan_l10n_pck.initial_position_w')::integer, 25), 1), 'JA16SJIS'));  						                        --122 CANCEL_CLASSIFICATION
            exam_type_w := (trim(both utl_i18n.raw_to_char(utl_raw.substr(current_setting('carestream_ris_japan_l10n_pck.ds_local_w')::varchar(32767), carestream_ris_japan_l10n_pck.update_initial_position(current_setting('carestream_ris_japan_l10n_pck.initial_position_w')::integer, 7), 2), 'JA16SJIS')))::numeric; 						                        --129 EXAMINATION_TYPE
            exam_exec_date_w := to_date(trim(both utl_i18n.raw_to_char(utl_raw.substr(current_setting('carestream_ris_japan_l10n_pck.ds_local_w')::varchar(32767), carestream_ris_japan_l10n_pck.update_initial_position(current_setting('carestream_ris_japan_l10n_pck.initial_position_w')::integer, 18), 14), 'JA16SJIS')), 'YYYYMMDDHH24MISS');                        --147 EXECUTION_DATE_TIME
            physician_exec1_w := trim(both utl_i18n.raw_to_char(utl_raw.substr(current_setting('carestream_ris_japan_l10n_pck.ds_local_w')::varchar(32767), carestream_ris_japan_l10n_pck.update_initial_position(current_setting('carestream_ris_japan_l10n_pck.initial_position_w')::integer, 14), 10), 'JA16SJIS')); 					                         -- 161 EXECUTION_PHYSICIAN_1
            physician_exec2_w := trim(both utl_i18n.raw_to_char(utl_raw.substr(current_setting('carestream_ris_japan_l10n_pck.ds_local_w')::varchar(32767), carestream_ris_japan_l10n_pck.update_initial_position(current_setting('carestream_ris_japan_l10n_pck.initial_position_w')::integer, 10), 10), 'JA16SJIS')); 					                         --171 EXECUTION_PHYSICIAN_2
            physician_exec3_w := trim(both utl_i18n.raw_to_char(utl_raw.substr(current_setting('carestream_ris_japan_l10n_pck.ds_local_w')::varchar(32767), carestream_ris_japan_l10n_pck.update_initial_position(current_setting('carestream_ris_japan_l10n_pck.initial_position_w')::integer, 10), 10), 'JA16SJIS')); 					                         --181 EXECUTION_PHYSICIAN_3
            exam_technician1_w := trim(both utl_i18n.raw_to_char(utl_raw.substr(current_setting('carestream_ris_japan_l10n_pck.ds_local_w')::varchar(32767), carestream_ris_japan_l10n_pck.update_initial_position(current_setting('carestream_ris_japan_l10n_pck.initial_position_w')::integer, 10), 10), 'JA16SJIS')); 					                        -- 191 EXAM_TECHNICAIN_1
            exam_technician2_w := trim(both utl_i18n.raw_to_char(utl_raw.substr(current_setting('carestream_ris_japan_l10n_pck.ds_local_w')::varchar(32767), carestream_ris_japan_l10n_pck.update_initial_position(current_setting('carestream_ris_japan_l10n_pck.initial_position_w')::integer, 10), 10), 'JA16SJIS')); 					                        -- 201 EXAM_TECHNICAIN_2
            exam_technician3_w := trim(both utl_i18n.raw_to_char(utl_raw.substr(current_setting('carestream_ris_japan_l10n_pck.ds_local_w')::varchar(32767), carestream_ris_japan_l10n_pck.update_initial_position(current_setting('carestream_ris_japan_l10n_pck.initial_position_w')::integer, 10), 10), 'JA16SJIS')); 					                        -- 211 EXAM_TECHNICAIN_3
            exec_room_code_w := trim(both utl_i18n.raw_to_char(utl_raw.substr(current_setting('carestream_ris_japan_l10n_pck.ds_local_w')::varchar(32767), carestream_ris_japan_l10n_pck.update_initial_position(current_setting('carestream_ris_japan_l10n_pck.initial_position_w')::integer, 10), 2), 'JA16SJIS'));						                        -- 221 EXECUTION_DEPARTMENT_ROOM 
            his_comment_w := null;
            PERFORM set_config('carestream_ris_japan_l10n_pck.initial_position_w', current_setting('carestream_ris_japan_l10n_pck.initial_position_w')::integer + 2, false);

            if (processing_type_w = '3' and current_setting('carestream_ris_japan_l10n_pck.message_type_w')::varchar(2) = '2U') then
                cancel_flag_w := '1';  									-- CANCEL_FLAG
                ie_status_report_w := '9';
            else
                cancel_flag_w := '0';
                ie_status_report_w:= '8';
            end if;

            select 	nextval('ris_exam_exec_info_seq') ,
                    obter_paciente_prontuario(current_setting('carestream_ris_japan_l10n_pck.patient_mrn_w')::varchar(10), 'C'),
                    coalesce(CASE WHEN b.type_encounter_id=1 THEN  2 WHEN b.type_encounter_id=8 THEN  1 END , 1),  	--ENCOUNTER_CLASSIFICATION
                    b.encounter_doctor_id, 								--PHYSICIAN_ID
                    b.medical_department_id 							--MEDICAL_DEPARTMENT_CODE
            into STRICT 	ris_exam_exec_seq ,
                    current_setting('carestream_ris_japan_l10n_pck.patient_id_w')::varchar(10),
                    encounter_type_w,
                    physician_code_w,
                    medical_dept_w
            from
                    bft_order_v          a,
                    bft_encounter_v      b,
                    prescr_procedimento  c
                where
                    a.encounter_id = b.encounter_id
                    and a.prescription_number = c.nr_prescricao
                    and a.prescription_number = order_number_w
                    and c.nr_sequencia = sequence_number_w  LIMIT 1;

                insert into ris_exam_exec_info(
                    nr_sequencia,
                    nr_prescricao,
                    nr_seq_order,
                    cd_doctor_exec_1,
                    cd_doctor_exec_2,
                    cd_doctor_exec_3,
                    cd_doctor_id,
                    cd_technician_1,
                    cd_technician_2,
                    cd_technician_3,
                    cd_episode_classif,
                    cd_exam_room,
                    cd_exam_type,
                    cd_med_department,
                    cd_patient_id,
                    cd_update_user_id,
                    ds_comments,
                    dt_atualizacao,
                    dt_atualizacao_nrec,
                    dt_exam_exec,
                    dt_update,
                    ie_cancel,
                    nm_usuario,
                    nm_usuario_nrec,
                    nr_exam_drugs,
                    nr_exam_parts)
                values (
                    ris_exam_exec_seq,
                    order_number_w,
                    sequence_number_w,
                    physician_exec1_w,
                    physician_exec2_w,
                    physician_exec3_w,
                    physician_code_w,
                    exam_technician1_w,
                    exam_technician2_w,
                    exam_technician3_w,
                    encounter_type_w,
                    exec_room_code_w,
                    exam_type_w,
                    medical_dept_w, 
                    current_setting('carestream_ris_japan_l10n_pck.patient_id_w')::varchar(10),
                    updated_user_id_w, 
                    his_comment_w,
                    clock_timestamp(),
                    clock_timestamp(),
                    exam_exec_date_w,
                    coalesce(occurred_date_w, processing_date_w),
                    cancel_flag_w,
                    nm_usuario_w,
                    nm_usuario_w,
                    null,
                    null );

                func_exam_count_w := (trim(both utl_i18n.raw_to_char(utl_raw.substr(current_setting('carestream_ris_japan_l10n_pck.ds_local_w')::varchar(32767), carestream_ris_japan_l10n_pck.update_initial_position(current_setting('carestream_ris_japan_l10n_pck.initial_position_w')::integer, 0), 5), 'JA16SJIS')))::numeric; 		    -- 223 FUNCTION_EXAMINATION_COUNT
                PERFORM set_config('carestream_ris_japan_l10n_pck.initial_position_w', current_setting('carestream_ris_japan_l10n_pck.initial_position_w')::integer + 5, false);

                if ( func_exam_count_w > 0 ) then
                    for  j in 1..func_exam_count_w loop
                    begin
                        cd_material_classif_w := '2';
                        func_exam_classif_w := trim(both utl_i18n.raw_to_char(utl_raw.substr(current_setting('carestream_ris_japan_l10n_pck.ds_local_w')::varchar(32767), carestream_ris_japan_l10n_pck.update_initial_position(current_setting('carestream_ris_japan_l10n_pck.initial_position_w')::integer, 0), 2), 'JA16SJIS'));           -- FUNCTION_EXAM_CLASSIFICATION
                        func_exam_code_w := trim(both utl_i18n.raw_to_char(utl_raw.substr(current_setting('carestream_ris_japan_l10n_pck.ds_local_w')::varchar(32767), carestream_ris_japan_l10n_pck.update_initial_position(current_setting('carestream_ris_japan_l10n_pck.initial_position_w')::integer, 2), 3), 'JA16SJIS')); 	            -- FUNCTION_EXAM_Code
                        PERFORM set_config('carestream_ris_japan_l10n_pck.initial_position_w', current_setting('carestream_ris_japan_l10n_pck.initial_position_w')::integer + 3, false);

                         insert into ris_exam_exec_mat(
                            nr_sequencia,
                            cd_material_classif,
                            cd_material_unit,
                            cd_material_used,
                            cd_update_user_id,
                            dt_atualizacao,
                            dt_atualizacao_nrec,
                            dt_update,
                            nm_usuario,
                            nm_usuario_nrec,
                            nr_seq_ris_exam_exec_info,
                            vl_amount_used)
                        values (
                            nextval('phy_exam_exec_mat_seq'),
                            cd_material_classif_w,
                            null,
                            func_exam_code_w,
                            updated_user_id_w,
                            clock_timestamp(),
                            clock_timestamp(),
                            coalesce(occurred_date_w, exam_exec_date_w),
                            nm_usuario_w,
                            nm_usuario_w,
                            ris_exam_exec_seq,
                            1 );

                    end;
                    end loop;
                end if;


                his_comment_w := trim(both utl_i18n.raw_to_char(utl_raw.substr(current_setting('carestream_ris_japan_l10n_pck.ds_local_w')::varchar(32767), carestream_ris_japan_l10n_pck.update_initial_position(current_setting('carestream_ris_japan_l10n_pck.initial_position_w')::integer, 0), 512), 'JA16SJIS')); 				    -- DS_COMMENTS
                PERFORM set_config('carestream_ris_japan_l10n_pck.initial_position_w', current_setting('carestream_ris_japan_l10n_pck.initial_position_w')::integer + 512, false);

                update ris_exam_exec_info
                set ds_comments = his_comment_w
                where nr_sequencia = ris_exam_exec_seq;

                body_parts_count_w := (trim(both utl_i18n.raw_to_char(utl_raw.substr(current_setting('carestream_ris_japan_l10n_pck.ds_local_w')::varchar(32767), carestream_ris_japan_l10n_pck.update_initial_position(current_setting('carestream_ris_japan_l10n_pck.initial_position_w')::integer, 0), 5), 'JA16SJIS')))::numeric; 		--  BODY_PARTS_COUNT
                PERFORM set_config('carestream_ris_japan_l10n_pck.initial_position_w', current_setting('carestream_ris_japan_l10n_pck.initial_position_w')::integer + 5, false);

                if (body_parts_count_w > 0) then
                    for  j in 1..body_parts_count_w loop
                    begin
                        body_part_num_w 	:= (trim(both utl_i18n.raw_to_char(utl_raw.substr(current_setting('carestream_ris_japan_l10n_pck.ds_local_w')::varchar(32767), carestream_ris_japan_l10n_pck.update_initial_position(current_setting('carestream_ris_japan_l10n_pck.initial_position_w')::integer, 0), 5), 'JA16SJIS')))::numeric; 	    -- BODY_PART_NUMBER
                        body_part_code_w 	:= (trim(both utl_i18n.raw_to_char(utl_raw.substr(current_setting('carestream_ris_japan_l10n_pck.ds_local_w')::varchar(32767), carestream_ris_japan_l10n_pck.update_initial_position(current_setting('carestream_ris_japan_l10n_pck.initial_position_w')::integer, 5), 8), 'JA16SJIS')))::numeric; 	-- BODY_PART_CODE
                        img_room_code_w 	:= trim(both utl_i18n.raw_to_char(utl_raw.substr(current_setting('carestream_ris_japan_l10n_pck.ds_local_w')::varchar(32767), carestream_ris_japan_l10n_pck.update_initial_position(current_setting('carestream_ris_japan_l10n_pck.initial_position_w')::integer, 8), 2), 'JA16SJIS')); 		    -- PHOTOGRAPH_ROOM_CODE
                        img_equipment_code_w:= trim(both utl_i18n.raw_to_char(utl_raw.substr(current_setting('carestream_ris_japan_l10n_pck.ds_local_w')::varchar(32767), carestream_ris_japan_l10n_pck.update_initial_position(current_setting('carestream_ris_japan_l10n_pck.initial_position_w')::integer, 2), 2), 'JA16SJIS')); 		    -- PHOTOGRAPH_EQUIPMENT_CODE
                        img_code_kv_w 		:= trim(both utl_i18n.raw_to_char(utl_raw.substr(current_setting('carestream_ris_japan_l10n_pck.ds_local_w')::varchar(32767), carestream_ris_japan_l10n_pck.update_initial_position(current_setting('carestream_ris_japan_l10n_pck.initial_position_w')::integer, 2), 4), 'JA16SJIS'));			    -- PHOTOGRAPHIC_COND_KV
                        img_code_ma_w 		:= trim(both utl_i18n.raw_to_char(utl_raw.substr(current_setting('carestream_ris_japan_l10n_pck.ds_local_w')::varchar(32767), carestream_ris_japan_l10n_pck.update_initial_position(current_setting('carestream_ris_japan_l10n_pck.initial_position_w')::integer, 4), 4), 'JA16SJIS'));			    -- PHOTOGRAPHIC_COND_MA
                        img_code_sec_w		:= trim(both utl_i18n.raw_to_char(utl_raw.substr(current_setting('carestream_ris_japan_l10n_pck.ds_local_w')::varchar(32767), carestream_ris_japan_l10n_pck.update_initial_position(current_setting('carestream_ris_japan_l10n_pck.initial_position_w')::integer, 4), 4), 'JA16SJIS')); 		    -- PHOTOGRAPHIC_COND_SEC
                        img_code_cm_w 		:= trim(both utl_i18n.raw_to_char(utl_raw.substr(current_setting('carestream_ris_japan_l10n_pck.ds_local_w')::varchar(32767), carestream_ris_japan_l10n_pck.update_initial_position(current_setting('carestream_ris_japan_l10n_pck.initial_position_w')::integer, 4), 4), 'JA16SJIS')); 		    -- PHOTOGRAPHIC_COND_CM
                         PERFORM set_config('carestream_ris_japan_l10n_pck.initial_position_w', current_setting('carestream_ris_japan_l10n_pck.initial_position_w')::integer + 4, false);

                        select nextval('ris_exam_exec_proc_seq')
                        into STRICT   ris_exam_proc_seq
;

                        insert into ris_exam_exec_proc(	
                            nr_seq_ris_exam_exec_info,
                            nr_sequencia,
                            nr_part_seq,
                            cd_body_part,
                            nm_usuario_nrec,
                            nm_usuario,
                            dt_update,
                            dt_atualizacao_nrec,
                            dt_atualizacao,
                            cd_update_user_id, 
                            cd_procedure,   -- need to check
                            cd_img_cond_sec,
                            cd_img_cond_ma,
                            cd_img_cond_kv,
                            cd_img_cond_cm,
                            cd_exam_type,
                            cd_exam_room,
                            cd_equipment )
                        values (
                            ris_exam_exec_seq,
                            ris_exam_proc_seq,
                            nr_part_seq_w,
                            body_part_code_w,
                            nm_usuario_w,
                            nm_usuario_w,
                            coalesce(occurred_date_w, processing_date_w),
                            clock_timestamp(),
                            clock_timestamp(),
                            updated_user_id_w,
                            null,
                            img_code_sec_w,
                            img_code_ma_w,
                            img_code_kv_w,
                            img_code_cm_w,
                            exam_type_w,
                            img_room_code_w,
                            img_equipment_code_w );


                        -- comment code details 
                        comment_count_w    := (trim(both utl_i18n.raw_to_char(utl_raw.substr(current_setting('carestream_ris_japan_l10n_pck.ds_local_w')::varchar(32767), carestream_ris_japan_l10n_pck.update_initial_position(current_setting('carestream_ris_japan_l10n_pck.initial_position_w')::integer, 0), 5), 'JA16SJIS')))::numeric; 			-- COMMENTS_COUNT
                        PERFORM set_config('carestream_ris_japan_l10n_pck.initial_position_w', current_setting('carestream_ris_japan_l10n_pck.initial_position_w')::integer + 5, false);

                        if (comment_count_w > 0 ) then
                            for  j in 1..comment_count_w loop
                            begin
                                comment_classif_w 	:= (trim(both utl_i18n.raw_to_char(utl_raw.substr(current_setting('carestream_ris_japan_l10n_pck.ds_local_w')::varchar(32767), carestream_ris_japan_l10n_pck.update_initial_position(current_setting('carestream_ris_japan_l10n_pck.initial_position_w')::integer, 0), 2), 'JA16SJIS')))::numeric; 	-- COMMENT_CLAASIFICATION_CODE 
                                comment_code_w 		:= (trim(both utl_i18n.raw_to_char(utl_raw.substr(current_setting('carestream_ris_japan_l10n_pck.ds_local_w')::varchar(32767), carestream_ris_japan_l10n_pck.update_initial_position(current_setting('carestream_ris_japan_l10n_pck.initial_position_w')::integer, 2), 3), 'JA16SJIS')))::numeric; 	-- COMMENT_CODE
                                PERFORM set_config('carestream_ris_japan_l10n_pck.initial_position_w', current_setting('carestream_ris_japan_l10n_pck.initial_position_w')::integer + 3, false);

                                insert into ris_exam_exec_comment(
                                    nr_seq_ris_exam_exec_proc,
                                    nr_sequencia,
                                    nm_usuario_nrec,
                                    nm_usuario,
                                    dt_atualizacao_nrec,
                                    dt_atualizacao,
                                    cd_comment_code,
                                    cd_comment_classif)
                                values (
                                    ris_exam_proc_seq,
                                    nextval('ris_exam_exec_comment_seq') ,
                                    nm_usuario_w,
                                    nm_usuario_w,
                                    clock_timestamp(),
                                    clock_timestamp(),
                                    comment_code_w,
                                    comment_classif_w );
                            end;
                            end loop;
                        end if;
                       -- Position direction information -> always be 00000 for Radiology
                        PERFORM set_config('carestream_ris_japan_l10n_pck.initial_position_w', current_setting('carestream_ris_japan_l10n_pck.initial_position_w')::integer + 5, false); -- TAII_SUMM
                        --procedure flim details
                        film_count_w := (trim(both utl_i18n.raw_to_char(utl_raw.substr(current_setting('carestream_ris_japan_l10n_pck.ds_local_w')::varchar(32767), carestream_ris_japan_l10n_pck.update_initial_position(current_setting('carestream_ris_japan_l10n_pck.initial_position_w')::integer, 0), 5), 'JA16SJIS')))::numeric; 				            -- FLIM_COUNT
                        PERFORM set_config('carestream_ris_japan_l10n_pck.initial_position_w', current_setting('carestream_ris_japan_l10n_pck.initial_position_w')::integer + 5, false);

                        if (film_count_w > 0 ) then
                            for  j in 1..film_count_w loop
                            begin

                                flim_code_w 		:= (trim(both utl_i18n.raw_to_char(utl_raw.substr(current_setting('carestream_ris_japan_l10n_pck.ds_local_w')::varchar(32767), carestream_ris_japan_l10n_pck.update_initial_position(current_setting('carestream_ris_japan_l10n_pck.initial_position_w')::integer, 0), 4), 'JA16SJIS')))::numeric;    	        -- FLIM_CODE
                                flim_code_count_w 	:= (trim(both utl_i18n.raw_to_char(utl_raw.substr(current_setting('carestream_ris_japan_l10n_pck.ds_local_w')::varchar(32767), carestream_ris_japan_l10n_pck.update_initial_position(current_setting('carestream_ris_japan_l10n_pck.initial_position_w')::integer, 4), 5), 'JA16SJIS')))::numeric; 	    -- FRACTION_COUNT
                                fraction_count_w 	:=  (trim(both utl_i18n.raw_to_char(utl_raw.substr(current_setting('carestream_ris_japan_l10n_pck.ds_local_w')::varchar(32767), carestream_ris_japan_l10n_pck.update_initial_position(current_setting('carestream_ris_japan_l10n_pck.initial_position_w')::integer, 5), 5), 'JA16SJIS')))::numeric; 	    -- FRACTION_COUNT
                                exposure_count_w 	:=  (trim(both utl_i18n.raw_to_char(utl_raw.substr(current_setting('carestream_ris_japan_l10n_pck.ds_local_w')::varchar(32767), carestream_ris_japan_l10n_pck.update_initial_position(current_setting('carestream_ris_japan_l10n_pck.initial_position_w')::integer, 5), 5), 'JA16SJIS')))::numeric; 	-- IRRADIATION_COUNT
                                PERFORM set_config('carestream_ris_japan_l10n_pck.initial_position_w', current_setting('carestream_ris_japan_l10n_pck.initial_position_w')::integer + 5, false);

                                insert into  ris_exam_exec_film(
                                    nr_seq_ris_exam_exec_proc,
                                    nr_sequencia,
                                    cd_film,
                                    nr_film_count,
                                    nr_fraction_count,
                                    nr_exposure_count,
                                    nm_usuario_nrec,
                                    nm_usuario,
                                    dt_atualizacao_nrec,
                                    dt_atualizacao
                                    )
                                values (
                                    ris_exam_proc_seq,
                                    nextval('ris_exam_exec_film_seq'),
                                    flim_code_w,
                                    flim_code_count_w,
                                    fraction_count_w,
                                    exposure_count_w,
                                    nm_usuario_w,
                                    nm_usuario_w,
                                    clock_timestamp(),
                                    clock_timestamp() );
                            end;
                            end loop;
                        end if;

                    end;
                    end loop;
                end if;

            -- Photographic information -> always be 00000 for Radiology
            PERFORM set_config('carestream_ris_japan_l10n_pck.initial_position_w', current_setting('carestream_ris_japan_l10n_pck.initial_position_w')::integer + 5, false);  --SHOOT_SUMM
            --Material used inforamtion
            medicine_count_w := (trim(both utl_i18n.raw_to_char(utl_raw.substr(current_setting('carestream_ris_japan_l10n_pck.ds_local_w')::varchar(32767), carestream_ris_japan_l10n_pck.update_initial_position(current_setting('carestream_ris_japan_l10n_pck.initial_position_w')::integer, 0), 5), 'JA16SJIS')))::numeric; 				        -- EXAM_DRUNGS_COUNT
            PERFORM set_config('carestream_ris_japan_l10n_pck.initial_position_w', current_setting('carestream_ris_japan_l10n_pck.initial_position_w')::integer + 5, false);

            if ( medicine_count_w > 0 ) then

                for  j in 1..medicine_count_w loop
                begin

                    cd_material_classif_w 	:= '0';
                    medicine_code_w 		:= trim(both utl_i18n.raw_to_char(utl_raw.substr(current_setting('carestream_ris_japan_l10n_pck.ds_local_w')::varchar(32767), carestream_ris_japan_l10n_pck.update_initial_position(current_setting('carestream_ris_japan_l10n_pck.initial_position_w')::integer, 0), 8), 'JA16SJIS')); 		            -- MEDICINE_CODE
                    used_medicine_amt_w 	:= (trim(both utl_i18n.raw_to_char(utl_raw.substr(current_setting('carestream_ris_japan_l10n_pck.ds_local_w')::varchar(32767), carestream_ris_japan_l10n_pck.update_initial_position(current_setting('carestream_ris_japan_l10n_pck.initial_position_w')::integer, 8), 5), 'JA16SJIS')))::numeric; 	    -- USED_MEDICINE_AMOUNT
                    medicine_std_code_w		:= trim(both utl_i18n.raw_to_char(utl_raw.substr(current_setting('carestream_ris_japan_l10n_pck.ds_local_w')::varchar(32767), carestream_ris_japan_l10n_pck.update_initial_position(current_setting('carestream_ris_japan_l10n_pck.initial_position_w')::integer, 5), 2), 'JA16SJIS'));			-- MEDICINE_STANDARD_CODE
                    PERFORM set_config('carestream_ris_japan_l10n_pck.initial_position_w', current_setting('carestream_ris_japan_l10n_pck.initial_position_w')::integer + 2, false);

                    insert into ris_exam_exec_mat(
                        nr_sequencia,
                        cd_material_classif,
                        cd_material_unit,
                        cd_material_used,
                        cd_update_user_id,
                        dt_atualizacao,
                        dt_atualizacao_nrec,
                        dt_update,
                        nm_usuario,
                        nm_usuario_nrec,
                        nr_seq_ris_exam_exec_info,
                        vl_amount_used)
                    values (
                        nextval('phy_exam_exec_mat_seq'),
                        cd_material_classif_w,
                        medicine_std_code_w,
                        medicine_code_w,
                        updated_user_id_w,
                        clock_timestamp(),
                        clock_timestamp(),
                        coalesce(occurred_date_w, processing_date_w),
                        nm_usuario_w,
                        nm_usuario_w,
                        ris_exam_exec_seq,
                        used_medicine_amt_w	 );

                end;
                end loop;
            end if;

            -- EQUIPMENT_DETAILS
            equipment_count_w 			:= (trim(both utl_i18n.raw_to_char(utl_raw.substr(current_setting('carestream_ris_japan_l10n_pck.ds_local_w')::varchar(32767), carestream_ris_japan_l10n_pck.update_initial_position(current_setting('carestream_ris_japan_l10n_pck.initial_position_w')::integer, 0), 5), 'JA16SJIS')))::numeric; 	    -- EQUIPMENT_COUNT
            PERFORM set_config('carestream_ris_japan_l10n_pck.initial_position_w', current_setting('carestream_ris_japan_l10n_pck.initial_position_w')::integer + 5, false);		

            if ( equipment_count_w > 0 ) then
                for  j in 1..equipment_count_w loop
                begin
                    cd_material_classif_w := '1';
                    equipment_code_w 	:= trim(both utl_i18n.raw_to_char(utl_raw.substr(current_setting('carestream_ris_japan_l10n_pck.ds_local_w')::varchar(32767), carestream_ris_japan_l10n_pck.update_initial_position(current_setting('carestream_ris_japan_l10n_pck.initial_position_w')::integer, 0), 8), 'JA16SJIS')); 		        -- EQUIPMENT_CODE
                    qt_equipments_w  	:= (trim(both utl_i18n.raw_to_char(utl_raw.substr(current_setting('carestream_ris_japan_l10n_pck.ds_local_w')::varchar(32767), carestream_ris_japan_l10n_pck.update_initial_position(current_setting('carestream_ris_japan_l10n_pck.initial_position_w')::integer, 8), 5), 'JA16SJIS')))::numeric; 	        -- QUANTITY_OF_EQUIPMENTS
                    equipment_std_code_w:= trim(both utl_i18n.raw_to_char(utl_raw.substr(current_setting('carestream_ris_japan_l10n_pck.ds_local_w')::varchar(32767), carestream_ris_japan_l10n_pck.update_initial_position(current_setting('carestream_ris_japan_l10n_pck.initial_position_w')::integer, 5), 2), 'JA16SJIS'));			    -- EQUIPMENT_STANDARD_CODE
                    PERFORM set_config('carestream_ris_japan_l10n_pck.initial_position_w', current_setting('carestream_ris_japan_l10n_pck.initial_position_w')::integer + 2, false);

                    insert into  ris_exam_exec_mat(
                        nr_sequencia,
                        cd_material_classif,
                        cd_material_unit,
                        cd_material_used,
                        cd_update_user_id,
                        dt_atualizacao,
                        dt_atualizacao_nrec,
                        dt_update,
                        nm_usuario,
                        nm_usuario_nrec,
                        nr_seq_ris_exam_exec_info,
                        vl_amount_used )
                    values (
                        nextval('phy_exam_exec_mat_seq'),
                        cd_material_classif_w,
                        equipment_std_code_w,
                        equipment_code_w,
                        updated_user_id_w,
                        clock_timestamp(),
                        clock_timestamp(),
                        coalesce(occurred_date_w, processing_date_w),
                        nm_usuario_w,
                        nm_usuario_w,
                        ris_exam_exec_seq,
                        qt_equipments_w	 );

                end;
                end loop;
            end if;
        commit;
        select  coalesce(max(a.cd_estabelecimento),obter_estabelecimento_ativo)
            into STRICT    cd_establishment_w
            from    prescr_medica b,
                    atendimento_paciente a
            where   a.nr_atendimento = b.nr_atendimento
            and     b.nr_prescricao = order_number_w;

            select ie_status_execucao
            into STRICT   ie_status_execucao_w
            from prescr_procedimento
            where   nr_prescricao        	=  order_number_w
            and     nr_sequencia         	=  sequence_number_w;

        CALL carestream_japan_l10n_pck.update_exam_execution_status(order_number_w, sequence_number_w, ie_status_report_w, nm_usuario_w);

        if (ie_status_report_w = '9') then

            if (ie_status_execucao_w IN (13,14)) then
                CALL atualizar_status_prep_prescr(order_number_w , sequence_number_w, 'D' , nm_usuario_w, cd_establishment_w, clock_timestamp(),nm_usuario_w);
            elsif (ie_status_execucao_w IN (11)) then
                CALL atualizar_status_prep_prescr(order_number_w , sequence_number_w, 'SD' , nm_usuario_w, cd_establishment_w, clock_timestamp(),nm_usuario_w);
            elsif (ie_status_execucao_w IN (20)) then
                CALL desfazer_execucao_proc_ge(order_number_w, sequence_number_w, 'I', 'N', cd_establishment_w , nm_usuario_w);
            end if;

        elsif (ie_status_report_w = '8') then
            CALL atualiza_status_proced_exec(sequence_number_w, order_number_w, 0 ,nm_usuario_w);
        end if;

        select	coalesce(a.ie_retrogrado,'N')
        into STRICT    ie_retrogrado_w
        from	cpoe_procedimento a,
                prescr_procedimento b
        where	a.nr_sequencia = b.nr_seq_proc_cpoe
        and     b.nr_sequencia = sequence_number_w
        and     nr_prescricao = order_number_w;

        select  is_special_order_rule('RA','A',cd_establishment_w)
        into STRICT ie_transmit_special_order_w 
;

        if (ie_retrogrado_w = 'N' or (ie_retrogrado_w = 'S' and ie_transmit_special_order_w = 'S')) then
            select  max(nm_usuario)
            into STRICT    current_setting('carestream_ris_japan_l10n_pck.nm_interface_name_w')::varchar(255)
            from    prescr_procedimento
            where   nr_prescricao = order_number_w;

            CALL wheb_usuario_pck.set_nm_usuario(current_setting('carestream_ris_japan_l10n_pck.nm_interface_name_w')::varchar(255));
            CALL execute_bifrost_integration(272,  '{"recordId" : "' || ris_exam_exec_seq || '"' || '}');
        end if;

        exception
        when others then
            rollback;
            CALL carestream_japan_l10n_pck.update_recieve_error_file(file_name_p, current_setting('carestream_ris_japan_l10n_pck.log_file_name_w')::varchar(100), current_setting('carestream_ris_japan_l10n_pck.message_type_w')::varchar(2));
            PERFORM set_config('carestream_ris_japan_l10n_pck.ds_log_message_w', 'Error occured while updating the information for order_execution_info in tasy'
                                || chr(10)
                                || 'Integration name : japan_carestream_ris(order_execution_info)'
                                || chr(10)
                                || 'Message Type:'
                                || current_setting('carestream_ris_japan_l10n_pck.message_type_w')::varchar(2)
                                || chr(10)
                                || 'Time of faliure : '
                                || clock_timestamp() || chr(10)
                                || 'Patient MRN:'
                                || current_setting('carestream_ris_japan_l10n_pck.patient_mrn_w')::varchar(10) || chr(10)
                                ||' -ERROR- '
                                || SQLERRM, false);

            record_integration_call_log(nm_usuario_w, nm_usuario_w, clock_timestamp(), current_setting('carestream_ris_japan_l10n_pck.nm_interface_w')::varchar(255), current_setting('carestream_ris_japan_l10n_pck.ds_message_w')::varchar(255),
                                        'F', 'R', null, current_setting('carestream_ris_japan_l10n_pck.ds_log_message_w')::varchar(32767), message_char_w,
                                        current_setting('carestream_ris_japan_l10n_pck.ds_log_message_w')::varchar(32767), file_name_p, current_setting('carestream_ris_japan_l10n_pck.log_sequence_number_w')::integration_message_log.nr_seq_int_call_log%type, current_setting('carestream_ris_japan_l10n_pck.patient_mrn_w')::varchar(10), null);

            CALL carestream_japan_l10n_pck.save_log(current_setting('carestream_ris_japan_l10n_pck.cd_integartion_event_w')::philips_json.get['cd_event_log'].value_of(), current_setting('carestream_ris_japan_l10n_pck.log_file_name_w')::varchar(100), current_setting('carestream_ris_japan_l10n_pck.ds_log_message_w')::varchar(32767));
            return;
        end;

        -- if file succcessfully read and info saved in tasy,calling function to move the file to repective ok folder from data and index folder
        CALL carestream_japan_l10n_pck.update_recieve_ok_file(file_name_p, current_setting('carestream_ris_japan_l10n_pck.log_file_name_w')::varchar(100), current_setting('carestream_ris_japan_l10n_pck.message_type_w')::varchar(2));

        PERFORM set_config('carestream_ris_japan_l10n_pck.ds_log_message_w', 'Information for order execution  is successfully updated in Tasy'
                                    || chr(10)
                                    || 'Integration name : japan_carestream_ris(order_execution_info)'
                                    || chr(10)
                                    || 'Message Type: '
                                    || current_setting('carestream_ris_japan_l10n_pck.message_type_w')::varchar(2)
                                    || chr(10)
                                    || 'Time of Success : '
                                    || clock_timestamp() || chr(10)
                                    || 'Patient MRN:'
                                    || current_setting('carestream_ris_japan_l10n_pck.patient_mrn_w')::varchar(10) , false);

        record_integration_call_log(nm_usuario_w, nm_usuario_w, clock_timestamp(), current_setting('carestream_ris_japan_l10n_pck.nm_interface_w')::varchar(255), current_setting('carestream_ris_japan_l10n_pck.ds_message_w')::varchar(255),
                                    'S', 'R', null, current_setting('carestream_ris_japan_l10n_pck.ds_log_message_w')::varchar(32767), message_char_w,
                                    null, file_name_p, current_setting('carestream_ris_japan_l10n_pck.log_sequence_number_w')::integration_message_log.nr_seq_int_call_log%type, current_setting('carestream_ris_japan_l10n_pck.patient_mrn_w')::varchar(10), null);

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE carestream_ris_japan_l10n_pck.order_execution_info (file_name_p text) FROM PUBLIC;
