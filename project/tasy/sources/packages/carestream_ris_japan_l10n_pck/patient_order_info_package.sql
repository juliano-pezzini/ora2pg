-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



	/** 
   +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	Patient Order Request Information
	unique_key :- prescription number / encounter number
	message type:- 3E -> Order Request confirm information
				   3F -> Order Request cancellation information 
	+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
   **/
CREATE OR REPLACE PROCEDURE carestream_ris_japan_l10n_pck.patient_order_info ( unique_key_p bigint, sequence_number_p bigint, proc_hor_sequence_p bigint, message_type_p text, processing_type_p text, nm_usuario_p text, log_sequence_number_p text, file_name_p text, cd_establishment_p bigint, ie_retransmit_p text ) AS $body$
DECLARE


        c06 CURSOR FOR
        SELECT CASE WHEN coalesce(a.exam_department_code::text, '') = '' THEN ' '  ELSE a.exam_department_code END  department_code,
               CASE WHEN coalesce(a.ordering_provider_id_number::text, '') = '' THEN  ' '  ELSE a.ordering_provider_id_number END  prescriber_physician_id,
               coalesce(a.ordering_provider_given_name, ' ') physician_name,
               coalesce(a.ordering_provider_id_number, ' ') operator_id,
               coalesce(to_char(a.start_date_time, 'YYYYMMDD'), ' ') order_date,
               coalesce(to_char(a.start_date_time, 'HH24MISS'), ' ') order_time,
               coalesce(obter_desc_setor_atend(a.exam_department_code), ' ') requested_department_name
        from   bft_order_ris_v a
        where  a.prescription_number = unique_key_p;

        c07 CURSOR FOR
        SELECT x.count_suborder,
               CASE WHEN coalesce(x.treatment_type::text, '') = '' THEN ' '  ELSE x.treatment_type END  treatment_type,
               x.order_number
        from ( SELECT count(*) over () count_suborder,
                      obter_proc_interno_classif(a.internal_procedure_code) treatment_type,
                      (lpad(a.prescription_number, 14, '0') || lpad(a.prescription_item_sequence, 10, '0')) order_number
             from    bft_order_ris_v a
             where   a.prescription_number = unique_key_p
             and     a.prescription_item_sequence = sequence_number_p)x;

        c08 CURSOR FOR
        SELECT      CASE WHEN  coalesce(obter_final_agendamento(b.nr_sequencia)::text, '') = '' THEN  to_char((b.hr_inicio + (1/1440*15)), 'hhmiss')  ELSE to_char(obter_final_agendamento(b.nr_sequencia),'hhmiss') END  end_date,
                    to_char(b.hr_inicio, 'yyyymmdd') start_date,
                    to_char(b.hr_inicio, 'hhmiss') start_time,
                    b.nr_minuto_duracao duration_min
            from    cpoe_procedimento a, agenda_paciente b , prescr_procedimento c
            where   a.nr_sequencia = c.nr_seq_proc_cpoe
            and     a.nr_seq_agenda = b.NR_SEQUENCIA
            and     c.nr_prescricao = unique_key_p
            and     c.nr_sequencia  = sequence_number_p  LIMIT 1;

        r_c06   c06%rowtype;
        r_c07   c07%rowtype;
        r_c08   c08%rowtype;

        request_disease_w varchar(255);


BEGIN
        PERFORM set_config('carestream_ris_japan_l10n_pck.ds_line_w', null, false);
        PERFORM set_config('carestream_ris_japan_l10n_pck.data_file_name_w', null, false);
        PERFORM set_config('carestream_ris_japan_l10n_pck.file_seq_directory_w', 'CARE_RIS_ORDER', false);
        PERFORM set_config('carestream_ris_japan_l10n_pck.log_sequence_number_w', log_sequence_number_p, false);
        PERFORM set_config('carestream_ris_japan_l10n_pck.ds_message_w', 'Patient Order Information', false);
        PERFORM set_config('carestream_ris_japan_l10n_pck.interface_event_w', 931, false);

        select obter_prontuario_paciente(a.cd_pessoa_fisica)
        into STRICT current_setting('carestream_ris_japan_l10n_pck.patient_mrn_w')::varchar(10)
        from prescr_medica a
        where a.nr_prescricao = unique_key_p;

        -- retrieving the event and company name for interface  
        SELECT * FROM carestream_japan_l10n_pck.get_interface_event_details(current_setting('carestream_ris_japan_l10n_pck.interface_event_w')::integer, current_setting('carestream_ris_japan_l10n_pck.ds_message_w')::varchar(255), current_setting('carestream_ris_japan_l10n_pck.nm_interface_w')::varchar(255)) INTO STRICT current_setting('carestream_ris_japan_l10n_pck.ds_message_w')::varchar(255), current_setting('carestream_ris_japan_l10n_pck.nm_interface_w')::varchar(255);

        select carestream_japan_l10n_pck.get_directory_event_code(message_type_p)
        into STRICT    current_setting('carestream_ris_japan_l10n_pck.cd_integartion_event_w')::philips_json
;

        select carestream_japan_l10n_pck.get_log_file_name(current_setting('carestream_ris_japan_l10n_pck.cd_integartion_event_w')::philips_json.get['control_code'].value_of(), current_setting('carestream_ris_japan_l10n_pck.radiology_dept_code_w')::varchar(2), current_setting('carestream_ris_japan_l10n_pck.his_system_code')::varchar(2))
        into STRICT   current_setting('carestream_ris_japan_l10n_pck.log_file_name_w')::varchar(100)
;

        -- generating the file name for first time integration else assign the existing one while resending the same message 
        if (file_name_p IS NOT NULL AND file_name_p::text <> '') then
            PERFORM set_config('carestream_ris_japan_l10n_pck.data_file_name_w', file_name_p, false);
        else
            generate_int_serial_number(0, current_setting('carestream_ris_japan_l10n_pck.file_seq_directory_w')::varchar(15), cd_establishment_p, nm_usuario_p, current_setting('carestream_ris_japan_l10n_pck.file_sequence_w')::smallint, current_setting('carestream_ris_japan_l10n_pck.interface_event_w')::integer);
            select carestream_japan_l10n_pck.get_file_name(current_setting('carestream_ris_japan_l10n_pck.cd_integartion_event_w')::philips_json.get['control_code'].value_of(), current_setting('carestream_ris_japan_l10n_pck.radiology_dept_code_w')::varchar(2), current_setting('carestream_ris_japan_l10n_pck.his_system_code')::varchar(2), current_setting('carestream_ris_japan_l10n_pck.file_sequence_w')::smallint)
            into STRICT current_setting('carestream_ris_japan_l10n_pck.data_file_name_w')::varchar(100)
;

        end if;
        -- creating integration message
        begin
            SELECT * FROM carestream_japan_l10n_pck.carestream_header(unique_key_p, message_type_p, current_setting('carestream_ris_japan_l10n_pck.radiology_dept_code_w')::varchar(2), processing_type_p, current_setting('carestream_ris_japan_l10n_pck.ds_line_w')::varchar(32767), current_setting('carestream_ris_japan_l10n_pck.patient_id_w')::varchar(10), current_setting('carestream_ris_japan_l10n_pck.encounter_id_w')::varchar(10), proc_hor_sequence_p, sequence_number_p) INTO STRICT current_setting('carestream_ris_japan_l10n_pck.ds_line_w')::varchar(32767), current_setting('carestream_ris_japan_l10n_pck.patient_id_w')::varchar(10), current_setting('carestream_ris_japan_l10n_pck.encounter_id_w')::varchar(10);

            CALL CALL carestream_ris_japan_l10n_pck.common_header(unique_key_p, sequence_number_p, current_setting('carestream_ris_japan_l10n_pck.file_sequence_w')::smallint);
            current_setting('carestream_ris_japan_l10n_pck.ds_local_w')::varchar(32767) := carestream_japan_l10n_pck.patient_basic_info(current_setting('carestream_ris_japan_l10n_pck.encounter_id_w')::varchar(10), current_setting('carestream_ris_japan_l10n_pck.ds_local_w')::varchar(32767));
            CALL CALL carestream_ris_japan_l10n_pck.append_message(current_setting('carestream_ris_japan_l10n_pck.ds_local_w')::varchar(32767));
            current_setting('carestream_ris_japan_l10n_pck.ds_local_w')::varchar(32767) := carestream_japan_l10n_pck.patient_allergy_info(current_setting('carestream_ris_japan_l10n_pck.patient_id_w')::varchar(10), current_setting('carestream_ris_japan_l10n_pck.ds_local_w')::varchar(32767));
            CALL CALL carestream_ris_japan_l10n_pck.append_message(current_setting('carestream_ris_japan_l10n_pck.ds_local_w')::varchar(32767));
            current_setting('carestream_ris_japan_l10n_pck.ds_local_w')::varchar(32767) := carestream_japan_l10n_pck.patient_disabilities_info(current_setting('carestream_ris_japan_l10n_pck.patient_id_w')::varchar(10), current_setting('carestream_ris_japan_l10n_pck.ds_local_w')::varchar(32767));
            CALL CALL carestream_ris_japan_l10n_pck.append_message(current_setting('carestream_ris_japan_l10n_pck.ds_local_w')::varchar(32767));
            current_setting('carestream_ris_japan_l10n_pck.ds_local_w')::varchar(32767) := carestream_japan_l10n_pck.patient_physical_motility_info(current_setting('carestream_ris_japan_l10n_pck.encounter_id_w')::varchar(10), current_setting('carestream_ris_japan_l10n_pck.ds_local_w')::varchar(32767));
            CALL CALL carestream_ris_japan_l10n_pck.append_message(current_setting('carestream_ris_japan_l10n_pck.ds_local_w')::varchar(32767));
            current_setting('carestream_ris_japan_l10n_pck.ds_local_w')::varchar(32767) := carestream_japan_l10n_pck.patient_body_equipment_info(current_setting('carestream_ris_japan_l10n_pck.patient_id_w')::varchar(10), current_setting('carestream_ris_japan_l10n_pck.ds_local_w')::varchar(32767));
            CALL CALL carestream_ris_japan_l10n_pck.append_message(current_setting('carestream_ris_japan_l10n_pck.ds_local_w')::varchar(32767));
            current_setting('carestream_ris_japan_l10n_pck.ds_local_w')::varchar(32767) := carestream_japan_l10n_pck.patient_risk_info(current_setting('carestream_ris_japan_l10n_pck.patient_id_w')::varchar(10), current_setting('carestream_ris_japan_l10n_pck.ds_local_w')::varchar(32767));
            CALL CALL carestream_ris_japan_l10n_pck.append_message(current_setting('carestream_ris_japan_l10n_pck.ds_local_w')::varchar(32767));
            current_setting('carestream_ris_japan_l10n_pck.ds_local_w')::varchar(32767) := carestream_japan_l10n_pck.patient_pregnant_info(current_setting('carestream_ris_japan_l10n_pck.encounter_id_w')::varchar(10), current_setting('carestream_ris_japan_l10n_pck.ds_local_w')::varchar(32767));
            CALL CALL carestream_ris_japan_l10n_pck.append_message(current_setting('carestream_ris_japan_l10n_pck.ds_local_w')::varchar(32767));
            current_setting('carestream_ris_japan_l10n_pck.ds_local_w')::varchar(32767) := carestream_japan_l10n_pck.patient_aid_classification(current_setting('carestream_ris_japan_l10n_pck.encounter_id_w')::varchar(10), current_setting('carestream_ris_japan_l10n_pck.ds_local_w')::varchar(32767));
            CALL CALL carestream_ris_japan_l10n_pck.append_message(current_setting('carestream_ris_japan_l10n_pck.ds_local_w')::varchar(32767));
            current_setting('carestream_ris_japan_l10n_pck.ds_local_w')::varchar(32767) := carestream_japan_l10n_pck.patient_exam_result_info(unique_key_p, current_setting('carestream_ris_japan_l10n_pck.ds_local_w')::varchar(32767));
            CALL CALL carestream_ris_japan_l10n_pck.append_message(current_setting('carestream_ris_japan_l10n_pck.ds_local_w')::varchar(32767)); -- KEKKA1,KEKKA1_DATE 1....15 UNUSED
            current_setting('carestream_ris_japan_l10n_pck.ds_local_w')::varchar(32767) := carestream_japan_l10n_pck.patient_infection_info(current_setting('carestream_ris_japan_l10n_pck.patient_id_w')::varchar(10), current_setting('carestream_ris_japan_l10n_pck.ds_local_w')::varchar(32767));
            CALL CALL carestream_ris_japan_l10n_pck.append_message(current_setting('carestream_ris_japan_l10n_pck.ds_local_w')::varchar(32767));
        --extra.....add Order basic information
            open c07;
            fetch c07 into r_c07;
            CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_ris_japan_l10n_pck.append_text(' ', 15);--ORDER_NO
            CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_ris_japan_l10n_pck.append_text(' ', 107); -- SCAN_URL, FILLER10
            CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_ris_japan_l10n_pck.append_text(r_c07.treatment_type, 2); --KNS_SYBT
            CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_ris_japan_l10n_pck.append_text(r_c07.count_suborder, 2, 'L', '0');--XX_SUM
            close c07;
            --Orderer information
            open c06;
            fetch c06 into r_c06;
            if ( c06%notfound ) then
                CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_ris_japan_l10n_pck.append_text(' ', 83);--KA_CD
            else
                CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_ris_japan_l10n_pck.append_text(r_c06.department_code, 3, 'L', '0');--KA_CD
                CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_ris_japan_l10n_pck.append_text(r_c06.prescriber_physician_id, 10, 'L', '0');--DR_ID
                CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_ris_japan_l10n_pck.append_text(r_c06.physician_name, 20, 'R',' '); --DR_NAME
                CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_ris_japan_l10n_pck.append_text(r_c06.operator_id, 10,'L', '0');--OP_ID
                CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_ris_japan_l10n_pck.append_text(r_c06.order_date, 8);--IN_DATE
                CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_ris_japan_l10n_pck.append_text(r_c06.order_time, 6);--IN_TIME
                CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_ris_japan_l10n_pck.append_text(' ', 30); -- Requested place name
            end if;

            close c06;

            --Order information
            CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_ris_japan_l10n_pck.append_text(' ' , 2);  --KNS_SYBT
            CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_ris_japan_l10n_pck.append_text(' ', 1);  --IRAI_KBN
            CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_ris_japan_l10n_pck.append_text('0', 1);  --FILM
            CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_ris_japan_l10n_pck.append_text(' ', 1);  --REPORT_KBN
            select CASE WHEN coalesce(a.cd_doenca::text, '') = '' THEN ' '   ELSE obter_desc_cid_doenca(a.cd_doenca) END
            into STRICT   request_disease_w
            from   cpoe_procedimento a , prescr_procedimento b
            where  a.nr_sequencia = b.nr_seq_proc_cpoe
            and    b.NR_PRESCRICAO = unique_key_p  
            and    b.nr_sequencia = sequence_number_p;

            CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_ris_japan_l10n_pck.append_text(request_disease_w, 256);  --IRAI_BYOMEI
            CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_ris_japan_l10n_pck.append_text(' ', 256);  --KNS_PURPOSE
            CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_ris_japan_l10n_pck.append_text(' ', 1024); --ODR_COMMENT All spaces
            CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_ris_japan_l10n_pck.append_text(' ', 8);  --START_DATE
            CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_ris_japan_l10n_pck.append_text(' ', 8);  --END_DATE
            CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_ris_japan_l10n_pck.append_text(' ', 6);  --EXEC_TIME
            CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_ris_japan_l10n_pck.append_text(' ', 1);  --ORDER_MODE
            CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_ris_japan_l10n_pck.append_text(' ', 1);  --PRE_MED
            CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_ris_japan_l10n_pck.append_text(' ', 5);  --PORTABLE_KBN , PORTABLE_CD,ORD_FLG1 All spaces
            -- pre medication information
            current_setting('carestream_ris_japan_l10n_pck.ds_local_w')::varchar(32767) := carestream_japan_l10n_pck.patient_medicine_info(unique_key_p, sequence_number_p, current_setting('carestream_ris_japan_l10n_pck.ds_local_w')::varchar(32767));
            CALL CALL carestream_ris_japan_l10n_pck.append_message(current_setting('carestream_ris_japan_l10n_pck.ds_local_w')::varchar(32767));

            --Examination appointment information
            open c08;
            CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_ris_japan_l10n_pck.append_text('1', 5, 'L', '0'); --YK_SUMM 'Always 00001' for radiology
            fetch c08 into r_c08;
            if ( c08%notfound ) then
                CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_ris_japan_l10n_pck.append_text(to_char(clock_timestamp(), 'yyyyymmdd'), 8, 'L', '0'); -- YK_DATE
                CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_ris_japan_l10n_pck.append_text('1', 6, 'L', '0'); -- YK_TIME
                CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_ris_japan_l10n_pck.append_text('1', 6, 'L', '0');--YK_ED_TIME
            else
            CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_ris_japan_l10n_pck.append_text(r_c08.start_date, 8, 'L', '0'); -- YK_DATE
            CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_ris_japan_l10n_pck.append_text(r_c08.start_time, 6, 'L', '0'); -- YK_TIME
            CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_ris_japan_l10n_pck.append_text(r_c08.end_date, 6, 'L', '0');--YK_ED_TIME
            end if;
            close c08;

            --Order body part information ''information added in PRS-028''
            CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_ris_japan_l10n_pck.append_text('1', 5, 'L', '0'); --BUI_SUMM
            CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_ris_japan_l10n_pck.append_text('1', 5, 'L', '0'); --BUI_SEQ
            CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_ris_japan_l10n_pck.append_text('0', 10, 'L', '0'); --BUI_CD , BUI_IMG_CD
            CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_ris_japan_l10n_pck.append_text('0', 25, 'L', '0'); --BUI_LEFT , BUI_TOP,BUI_WIDTH,BUI_HEIGHT,BUI_SHAPE,
            CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_ris_japan_l10n_pck.append_text('0', 3); --BUI1_C_CD
            CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_ris_japan_l10n_pck.append_text(' ', 60); --BUI1_C
            CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_ris_japan_l10n_pck.append_text('0', 25, 'L', '0'); --BUI_LEFT1 , BUI_TOP,BUI_WIDTH,BUI_HEIGHT,BUI_SHAPE,
            CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_ris_japan_l10n_pck.append_text(' ', 60); --BUI1_C
            CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_ris_japan_l10n_pck.append_text('0', 25, 'L', '0'); --BUI_LEFT2 , BUI_TOP,BUI_WIDTH,BUI_HEIGHT,BUI_SHAPE,
            CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_ris_japan_l10n_pck.append_text(' ', 60); --BUI1_C
            CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_ris_japan_l10n_pck.append_text('0', 25, 'L', '0'); --BUI_LEFT3 , BUI_TOP,BUI_WIDTH,BUI_HEIGHT,BUI_SHAPE,
            CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_ris_japan_l10n_pck.append_text(' ', 256); --FREE_C
            --body parts detail information
            CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_ris_japan_l10n_pck.append_text('0', 5, 'L', '0'); --COMMENT_SUMM ignoring information added in PRS-028
            --Positiondirection information
            CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_ris_japan_l10n_pck.append_text('0', 5, 'L', '0'); --TAII_SUMM 00000 fixed
            CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_ris_japan_l10n_pck.append_text(' ', 6); -- TAII_CD, HOKO_CD space fixed
            exception
                when others then
                    PERFORM set_config('carestream_ris_japan_l10n_pck.ds_log_message_w', 'Error occured while sending the integration message for'
                                        || current_setting('carestream_ris_japan_l10n_pck.ds_message_w')::varchar(255) || chr(10)
                                        || 'Integration name - japan_carestream_ris('
                                        || current_setting('carestream_ris_japan_l10n_pck.ds_message_w')::varchar(255)
                                        || ').'
                                        || chr(10)
                                        || 'Message Type: '
                                        || message_type_p                                    
                                        || chr(10)
                                        || 'Time of faliure : '
                                        || clock_timestamp() || chr(10)
                                        || 'Prescription Id:'
                                        || unique_key_p || chr(10)
                                        || 'Order Retransmit :'
                                        || ie_retransmit_p || chr(10)
                                        ||' -ERROR- '
                                        || SQLERRM, false);

                    record_integration_call_log(nm_usuario_p, nm_usuario_p, clock_timestamp(), 'japan_carestream_ris', current_setting('carestream_ris_japan_l10n_pck.ds_message_w')::varchar(255),
                                                'F', 'E', null, current_setting('carestream_ris_japan_l10n_pck.ds_log_message_w')::varchar(32767), current_setting('carestream_ris_japan_l10n_pck.ds_line_w')::varchar(32767),
                                                current_setting('carestream_ris_japan_l10n_pck.ds_log_message_w')::varchar(32767), current_setting('carestream_ris_japan_l10n_pck.data_file_name_w')::varchar(100), current_setting('carestream_ris_japan_l10n_pck.log_sequence_number_w')::integration_message_log.nr_seq_int_call_log%type, current_setting('carestream_ris_japan_l10n_pck.patient_mrn_w')::varchar(10), current_setting('carestream_ris_japan_l10n_pck.interface_event_w')::integer);

                    CALL carestream_japan_l10n_pck.save_log(current_setting('carestream_ris_japan_l10n_pck.cd_integartion_event_w')::philips_json.get['cd_event_log'].value_of(), current_setting('carestream_ris_japan_l10n_pck.log_file_name_w')::varchar(100), current_setting('carestream_ris_japan_l10n_pck.ds_log_message_w')::varchar(32767));
                    return;
            end;

            -- it is helpful while resend the information
            PERFORM set_config('carestream_ris_japan_l10n_pck.ds_script_w', 'carestream_ris_japan_l10n_pck.patient_order_info ('
                           || unique_key_p
                           || ', '
                           || sequence_number_p
                           || ', '
                           || proc_hor_sequence_p
                           || ', '''
                           || message_type_p
                           || ''', '''
                           || processing_type_p
                           || ''', '''
                           || ':nm_exec_user' 
                           || ''' , '
                           || ':nr_seq_int_call_log'
                           || ', '''
                           || current_setting('carestream_ris_japan_l10n_pck.data_file_name_w')::varchar(100)
                           || ''' ,'
                           || cd_establishment_p
                           || ', ''S'', '
                           || ');', false);

            CALL CALL carestream_ris_japan_l10n_pck.perform_integration(unique_key_p, message_type_p, nm_usuario_p, log_sequence_number_p, current_setting('carestream_ris_japan_l10n_pck.data_file_name_w')::varchar(100),
                                current_setting('carestream_ris_japan_l10n_pck.log_file_name_w')::varchar(100), cd_establishment_p, current_setting('carestream_ris_japan_l10n_pck.file_seq_directory_w')::varchar(15), current_setting('carestream_ris_japan_l10n_pck.cd_integartion_event_w')::philips_json, current_setting('carestream_ris_japan_l10n_pck.ds_message_w')::varchar(255),
                                current_setting('carestream_ris_japan_l10n_pck.ds_script_w')::integration_call_log.ds_resend_script%type, current_setting('carestream_ris_japan_l10n_pck.nm_interface_w')::varchar(255), current_setting('carestream_ris_japan_l10n_pck.interface_event_w')::integer, current_setting('carestream_ris_japan_l10n_pck.patient_mrn_w')::varchar(10), ie_retransmit_p);

    END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE carestream_ris_japan_l10n_pck.patient_order_info ( unique_key_p bigint, sequence_number_p bigint, proc_hor_sequence_p bigint, message_type_p text, processing_type_p text, nm_usuario_p text, log_sequence_number_p text, file_name_p text, cd_establishment_p bigint, ie_retransmit_p text ) FROM PUBLIC;
