-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_apropriacao_pck.consistir_apropriacoes_regra ( regra_copartic_p pls_apropriacao_pck.dados_regra_copartic) AS $body$
DECLARE

	nr_seq_contr_interc_prod_w	bigint;
	ie_origem_regra_w		varchar(255);
	ds_pasta_w			varchar(255);
	vl_unitario_w			double precision;
	vl_liberado_w			pls_conta_proc.vl_liberado%type;
	ie_proc_mat_w			varchar(255);
	nr_seq_item_w			bigint;
	vl_fixo_total_w			pls_regra_copartic_aprop.vl_apropriacao%type;

BEGIN
	if (regra_copartic_p.nr_seq_contrato IS NOT NULL AND regra_copartic_p.nr_seq_contrato::text <> '') then
		nr_seq_contr_interc_prod_w := current_setting('pls_apropriacao_pck.pls_contrato_w')::pls_contrato%rowtype.nr_contrato;
		ie_origem_regra_w	:= 'contrato';
		ds_pasta_w		:= 'OPS - Gestao de Contratos > Contrato > Regras > Coparticipacao';
	elsif (regra_copartic_p.nr_seq_intercambio IS NOT NULL AND regra_copartic_p.nr_seq_intercambio::text <> '') then
		nr_seq_contr_interc_prod_w := regra_copartic_p.nr_seq_intercambio;
		ie_origem_regra_w	:= 'intercambio';
		ds_pasta_w		:= 'OPS - Contratos de Intercambio > Intercambio > Regras > Coparticipacao';
	elsif (regra_copartic_p.nr_seq_plano IS NOT NULL AND regra_copartic_p.nr_seq_plano::text <> '') then
		nr_seq_contr_interc_prod_w := regra_copartic_p.nr_seq_plano;
		ie_origem_regra_w	:= 'produto';
		ds_pasta_w		:= 'OPS - Cadastro de Produtos > Regras > Coparticipacao';
	end if;
	
	select	sum(vl_apropriacao)
	into STRICT	vl_fixo_total_w
	from	pls_regra_copartic_aprop
	where	nr_seq_regra		= regra_copartic_p.nr_sequencia
	and	ie_tipo_apropriacao	= '1';
	
	if (regra_copartic_p.ie_forma_cobr_internacao = 'I') then
		if (current_setting('pls_apropriacao_pck.ie_gerando_conta_proc_mat_w')::varchar(255) = 'P') then
			vl_unitario_w	:= current_setting('pls_apropriacao_pck.pls_conta_proc_w')::pls_conta_proc%rowtype.vl_unitario;
			ie_proc_mat_w	:= 'procedimento';
			nr_seq_item_w	:= current_setting('pls_apropriacao_pck.pls_conta_proc_w')::pls_conta_proc%rowtype.nr_sequencia;
		elsif (current_setting('pls_apropriacao_pck.ie_gerando_conta_proc_mat_w')::varchar(255) = 'M') then
			vl_unitario_w	:= current_setting('pls_apropriacao_pck.pls_conta_mat_w')::pls_conta_mat%rowtype.vl_unitario;
			ie_proc_mat_w	:= 'material';
			nr_seq_item_w	:= current_setting('pls_apropriacao_pck.pls_conta_mat_w')::pls_conta_mat%rowtype.nr_sequencia;
		end if;
		
		if (vl_fixo_total_w > vl_unitario_w) then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(306782,
				'NR_SEQ_REGRA_COPARTIC=' 	|| regra_copartic_p.nr_sequencia ||
				';IE_ORIGEM_REGRA=' 		|| ie_origem_regra_w ||
				';NR_SEQ_CONTR_INTERC_PROD=' 	|| nr_seq_contr_interc_prod_w ||
				';PASTA=' 			|| ds_pasta_w ||
				';IE_PROC_MAT=' 		|| ie_proc_mat_w ||
				';NR_SEQ_ITEM=' 		|| nr_seq_item_w ||
				';NR_SEQ_CONTA=' 		|| current_setting('pls_apropriacao_pck.pls_conta_w')::pls_conta%rowtype.nr_sequencia);
			
		end if;
	elsif (regra_copartic_p.ie_forma_cobr_internacao = 'C') then
		select	sum(vl_liberado)
		into STRICT	vl_liberado_w
		from (	SELECT	sum(a.vl_liberado) vl_liberado
			from	pls_conta_proc	a
			where	a.nr_seq_conta 	= current_setting('pls_apropriacao_pck.pls_conta_w')::pls_conta%rowtype.nr_sequencia
			
union all

			SELECT	sum(a.vl_liberado) vl_liberado
			from	pls_conta_mat	a
			where	a.nr_seq_conta 	= current_setting('pls_apropriacao_pck.pls_conta_w')::pls_conta%rowtype.nr_sequencia ) alias6;
		
		if (vl_fixo_total_w > vl_liberado_w) then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(323590,
				'NR_SEQ_REGRA_COPARTIC=' 	|| regra_copartic_p.nr_sequencia ||
				';IE_ORIGEM_REGRA=' 		|| ie_origem_regra_w ||
				';NR_SEQ_CONTR_INTERC_PROD=' 	|| nr_seq_contr_interc_prod_w ||
				';PASTA=' 			|| ds_pasta_w ||
				';NR_SEQ_CONTA=' 		|| current_setting('pls_apropriacao_pck.pls_conta_w')::pls_conta%rowtype.nr_sequencia);
			
		end if;
	elsif (regra_copartic_p.ie_forma_cobr_internacao = 'G') then
		select	sum(vl_liberado)
		into STRICT	vl_liberado_w
		from (	SELECT	sum(b.vl_liberado) vl_liberado
			from	pls_conta_proc	b,
				pls_conta	a
			where	a.nr_sequencia 	= b.nr_seq_conta
			and	a.cd_guia 	= current_setting('pls_apropriacao_pck.pls_conta_w')::pls_conta%rowtype.cd_guia
			
union all

			SELECT	sum(b.vl_liberado) vl_liberado
			from	pls_conta_mat	b,
				pls_conta	a
			where	a.nr_sequencia 	= b.nr_seq_conta
			and	a.cd_guia 	= current_setting('pls_apropriacao_pck.pls_conta_w')::pls_conta%rowtype.cd_guia ) alias6;
		if (vl_fixo_total_w > vl_liberado_w) then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(323592,
				'NR_SEQ_REGRA_COPARTIC=' 	|| regra_copartic_p.nr_sequencia ||
				';IE_ORIGEM_REGRA=' 		|| ie_origem_regra_w ||
				';NR_SEQ_CONTR_INTERC_PROD=' 	|| nr_seq_contr_interc_prod_w ||
				';PASTA=' 			|| ds_pasta_w ||
				';CD_GUIA=' 			|| current_setting('pls_apropriacao_pck.pls_conta_w')::pls_conta%rowtype.cd_guia);
			
		end if;
	end if;
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_apropriacao_pck.consistir_apropriacoes_regra ( regra_copartic_p pls_apropriacao_pck.dados_regra_copartic) FROM PUBLIC;
