-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_apropriacao_pck.tratar_distribuicao_aprop ( ie_opcao_p text, i_p integer, pls_regra_copartic_p pls_apropriacao_pck.dados_regra_copartic, vl_apropriado_guia_p pls_conta_proc_aprop.vl_apropriado%type, vl_cobrar_p bigint, vl_beneficiario_p bigint, vl_pend_guia_table_p INOUT bigint, vl_fixo_aprop_item_p INOUT bigint, vl_beneficiario_aprop_p INOUT bigint, vl_fixo_benef_ja_apropriado_p INOUT bigint, vl_apropriacao_p INOUT pls_regra_copartic_aprop.vl_apropriacao%type, vl_apropriacao_benef_p INOUT pls_regra_copartic_aprop.vl_apropriacao%type ) AS $body$
DECLARE




ie_vl_pendente_zero_w	varchar(1);


BEGIN

if (ie_opcao_p in ('C','G1')) then
	if (current_setting('pls_apropriacao_pck.vl_pendente_guia_table_w')::pls_util_cta_pck.t_number_table.count > 0) then
		begin
		if (coalesce(current_setting('pls_apropriacao_pck.vl_pendente_guia_table_w')::pls_util_cta_pck.t_number_table(i_p),0) > 0) and (current_setting('pls_apropriacao_pck.nr_seq_regra_aprop_ant_w')::pls_regra_copartic.nr_sequencia%type = pls_regra_copartic_p.nr_sequencia) then
			vl_pend_guia_table_p	:= current_setting('pls_apropriacao_pck.vl_pendente_guia_table_w')::pls_util_cta_pck.t_number_table(i_p);
		else
			if (current_setting('pls_apropriacao_pck.vl_pendente_guia_table_w')::pls_util_cta_pck.t_number_table(i_p) = 0) then
				vl_pend_guia_table_p := 0;
			else
				vl_pend_guia_table_p := vl_apropriacao_p;
			end if;
		end if;
		exception
		when others then
			vl_pend_guia_table_p := vl_apropriacao_p;
		end;
	elsif (vl_apropriacao_p >= current_setting('pls_apropriacao_pck.vl_fixo_aprop_conta_w')::pls_regra_copartic_aprop.vl_apropriacao%type) then
		vl_pend_guia_table_p	:= vl_apropriacao_p - current_setting('pls_apropriacao_pck.vl_fixo_aprop_conta_w')::pls_regra_copartic_aprop.vl_apropriacao%type;
	elsif (current_setting('pls_apropriacao_pck.vl_fixo_aprop_conta_w')::pls_regra_copartic_aprop.vl_apropriacao%type = vl_fixo_aprop_item_p) then
		vl_pend_guia_table_p	:= vl_apropriacao_p;
	end if;
	
	ie_vl_pendente_zero_w := 'N';
	
	if (vl_pend_guia_table_p = 0) then
		vl_apropriacao_p 	:= 0;
		vl_apropriacao_benef_p	:= 0;
		
		ie_vl_pendente_zero_w 		:= 'S';
		current_setting('pls_apropriacao_pck.vl_pendente_guia_table_w')::pls_util_cta_pck.t_number_table(i_p) 	:= 0;
	end if;
	
	if (ie_vl_pendente_zero_w = 'N') then
		if (vl_apropriacao_p = 0) or (vl_fixo_aprop_item_p >= vl_cobrar_p) then
			vl_apropriacao_p 		:= 0;
			vl_apropriacao_benef_p		:= 0;
			current_setting('pls_apropriacao_pck.vl_pendente_guia_table_w')::pls_util_cta_pck.t_number_table(i_p) 	:= vl_pend_guia_table_p;
		else
			
			if (vl_pend_guia_table_p >= vl_cobrar_p) and (vl_fixo_aprop_item_p = 0) then
				vl_apropriacao_p		:= vl_cobrar_p;
				vl_fixo_aprop_item_p		:= vl_fixo_aprop_item_p + vl_cobrar_p;
				PERFORM set_config('pls_apropriacao_pck.vl_fixo_aprop_conta_w', current_setting('pls_apropriacao_pck.vl_fixo_aprop_conta_w')::pls_regra_copartic_aprop.vl_apropriacao%type + vl_cobrar_p, false);
				
				current_setting('pls_apropriacao_pck.vl_pendente_guia_table_w')::pls_util_cta_pck.t_number_table(i_p)	:= vl_pend_guia_table_p - vl_apropriacao_p;
			else
				if (vl_fixo_aprop_item_p + vl_pend_guia_table_p > vl_cobrar_p) then
					vl_apropriacao_p	:= vl_cobrar_p - vl_fixo_aprop_item_p;
					vl_fixo_aprop_item_p	:= vl_fixo_aprop_item_p + vl_apropriacao_p;
					
					current_setting('pls_apropriacao_pck.vl_pendente_guia_table_w')::pls_util_cta_pck.t_number_table(i_p) 	:= vl_pend_guia_table_p - vl_apropriacao_p;
				else
					vl_apropriacao_p		:= vl_pend_guia_table_p;
					vl_fixo_aprop_item_p		:= vl_fixo_aprop_item_p + vl_apropriacao_p;
					current_setting('pls_apropriacao_pck.vl_pendente_guia_table_w')::pls_util_cta_pck.t_number_table(i_p)	:= 0;
				end if;
				
				PERFORM set_config('pls_apropriacao_pck.vl_fixo_aprop_conta_w', current_setting('pls_apropriacao_pck.vl_fixo_aprop_conta_w')::pls_regra_copartic_aprop.vl_apropriacao%type + vl_apropriacao_p, false);
			end if;
			
			
			
			vl_beneficiario_aprop_p		:= vl_apropriacao_p;
			vl_fixo_benef_ja_apropriado_p	:= vl_fixo_benef_ja_apropriado_p + vl_beneficiario_aprop_p;
			
			if (vl_fixo_benef_ja_apropriado_p > coalesce(vl_beneficiario_p, 0)) then
				vl_fixo_benef_ja_apropriado_p 	:= vl_fixo_benef_ja_apropriado_p - vl_beneficiario_aprop_p;
				vl_beneficiario_aprop_p 	:= coalesce(vl_beneficiario_p, 0) - vl_fixo_benef_ja_apropriado_p;
			end if;
			
			vl_apropriacao_benef_p := vl_beneficiario_aprop_p;
			
		end if;
	end if;
elsif (ie_opcao_p  = 'G2') then
	if (current_setting('pls_apropriacao_pck.vl_pendente_guia_table_w')::pls_util_cta_pck.t_number_table.count > 0) then
		begin
		if (coalesce(current_setting('pls_apropriacao_pck.vl_pendente_guia_table_w')::pls_util_cta_pck.t_number_table(i_p),0) > 0) and (current_setting('pls_apropriacao_pck.nr_seq_regra_aprop_ant_w')::pls_regra_copartic.nr_sequencia%type = pls_regra_copartic_p.nr_sequencia) then
			vl_pend_guia_table_p := current_setting('pls_apropriacao_pck.vl_pendente_guia_table_w')::pls_util_cta_pck.t_number_table(i_p);
		else
			if (current_setting('pls_apropriacao_pck.vl_pendente_guia_table_w')::pls_util_cta_pck.t_number_table(i_p) = 0) then
				vl_pend_guia_table_p := 0;
			else
				vl_pend_guia_table_p := vl_apropriacao_p;
			end if;
		end if;
		exception
		when others then
			vl_pend_guia_table_p  := vl_apropriacao_p - vl_apropriado_guia_p;
		end;
	elsif (current_setting('pls_apropriacao_pck.ie_primeira_vez_w')::varchar(1) = 'S') then
		PERFORM set_config('pls_apropriacao_pck.ie_primeira_vez_w', 'N', false);
		vl_pend_guia_table_p	:= vl_apropriacao_p - vl_apropriado_guia_p;
	elsif (vl_apropriacao_p >= current_setting('pls_apropriacao_pck.vl_fixo_aprop_conta_w')::pls_regra_copartic_aprop.vl_apropriacao%type) then
		vl_pend_guia_table_p	:= vl_apropriacao_p - current_setting('pls_apropriacao_pck.vl_fixo_aprop_conta_w')::pls_regra_copartic_aprop.vl_apropriacao%type;
	elsif (current_setting('pls_apropriacao_pck.vl_fixo_aprop_conta_w')::pls_regra_copartic_aprop.vl_apropriacao%type = vl_fixo_aprop_item_p) then
		vl_pend_guia_table_p	:= vl_apropriacao_p;
	end if;
	
	ie_vl_pendente_zero_w := 'N';
	
	if (vl_pend_guia_table_p = 0) then
		vl_apropriacao_p 	:= 0;
		vl_apropriacao_benef_p	:= 0;
		
		ie_vl_pendente_zero_w 		:= 'S';
		current_setting('pls_apropriacao_pck.vl_pendente_guia_table_w')::pls_util_cta_pck.t_number_table(i_p) 	:= 0;
	end if;
	
	if (ie_vl_pendente_zero_w = 'N') then
		if (vl_apropriado_guia_p >= vl_apropriacao_p) or (vl_fixo_aprop_item_p >= vl_cobrar_p) then
			
			vl_apropriacao_p 		:= 0;
			vl_apropriacao_benef_p		:= 0;
			current_setting('pls_apropriacao_pck.vl_pendente_guia_table_w')::pls_util_cta_pck.t_number_table(i_p) 	:= vl_pend_guia_table_p;
		else
			
			if (vl_pend_guia_table_p >= vl_cobrar_p) and (vl_fixo_aprop_item_p = 0) then
				vl_apropriacao_p 	:= vl_cobrar_p;
				vl_fixo_aprop_item_p	:= vl_fixo_aprop_item_p + vl_cobrar_p;
				PERFORM set_config('pls_apropriacao_pck.vl_fixo_aprop_conta_w', current_setting('pls_apropriacao_pck.vl_fixo_aprop_conta_w')::pls_regra_copartic_aprop.vl_apropriacao%type + vl_cobrar_p, false);
				
				current_setting('pls_apropriacao_pck.vl_pendente_guia_table_w')::pls_util_cta_pck.t_number_table(i_p) := vl_pend_guia_table_p - vl_apropriacao_p;
			else
				if (vl_fixo_aprop_item_p + vl_pend_guia_table_p > vl_cobrar_p) then
					vl_apropriacao_p 	:= vl_cobrar_p - vl_fixo_aprop_item_p;
					vl_fixo_aprop_item_p	:= vl_fixo_aprop_item_p + vl_apropriacao_p;
					
					current_setting('pls_apropriacao_pck.vl_pendente_guia_table_w')::pls_util_cta_pck.t_number_table(i_p) := vl_pend_guia_table_p - vl_apropriacao_p;
				else
					vl_apropriacao_p := vl_pend_guia_table_p;
					vl_fixo_aprop_item_p		 := vl_fixo_aprop_item_p + vl_apropriacao_p;
					current_setting('pls_apropriacao_pck.vl_pendente_guia_table_w')::pls_util_cta_pck.t_number_table(i_p) 	 := 0;
				end if;
				
				PERFORM set_config('pls_apropriacao_pck.vl_fixo_aprop_conta_w', current_setting('pls_apropriacao_pck.vl_fixo_aprop_conta_w')::pls_regra_copartic_aprop.vl_apropriacao%type + vl_apropriacao_p, false);
			end if;
			
			
			
			vl_beneficiario_aprop_p		:= vl_apropriacao_p;
			vl_fixo_benef_ja_apropriado_p	:= vl_fixo_benef_ja_apropriado_p + vl_beneficiario_aprop_p;
			
			if (vl_fixo_benef_ja_apropriado_p > coalesce(vl_beneficiario_p, 0)) then
				vl_fixo_benef_ja_apropriado_p 	:= vl_fixo_benef_ja_apropriado_p - vl_beneficiario_aprop_p;
				vl_beneficiario_aprop_p 	:= coalesce(vl_beneficiario_p, 0) - vl_fixo_benef_ja_apropriado_p;
			end if;
			
			vl_apropriacao_benef_p := vl_beneficiario_aprop_p;
			
		end if;
	end if;
end if;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_apropriacao_pck.tratar_distribuicao_aprop ( ie_opcao_p text, i_p integer, pls_regra_copartic_p pls_apropriacao_pck.dados_regra_copartic, vl_apropriado_guia_p pls_conta_proc_aprop.vl_apropriado%type, vl_cobrar_p bigint, vl_beneficiario_p bigint, vl_pend_guia_table_p INOUT bigint, vl_fixo_aprop_item_p INOUT bigint, vl_beneficiario_aprop_p INOUT bigint, vl_fixo_benef_ja_apropriado_p INOUT bigint, vl_apropriacao_p INOUT pls_regra_copartic_aprop.vl_apropriacao%type, vl_apropriacao_benef_p INOUT pls_regra_copartic_aprop.vl_apropriacao%type ) FROM PUBLIC;
