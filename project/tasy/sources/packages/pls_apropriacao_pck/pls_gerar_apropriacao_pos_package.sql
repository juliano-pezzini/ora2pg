-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_apropriacao_pck.pls_gerar_apropriacao_pos ( nr_seq_conta_proc_p pls_conta_proc.nr_sequencia%type, nr_seq_conta_mat_p pls_conta_mat.nr_sequencia%type, nr_seq_proc_rec_p pls_rec_glosa_proc.nr_sequencia%type, nr_seq_mat_rec_p pls_rec_glosa_mat.nr_sequencia%type, ie_recurso_glosa_p text, ie_primeira_p text, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE

					
nr_seq_conta_w				pls_conta.nr_sequencia%type;
				

BEGIN

	PERFORM set_config('pls_apropriacao_pck.nr_seq_proc_rec_w', nr_seq_proc_rec_p, false);
	PERFORM set_config('pls_apropriacao_pck.nr_seq_mat_rec_w', nr_seq_mat_rec_p, false);
	PERFORM set_config('pls_apropriacao_pck.ie_recurso_glosa_w', coalesce(ie_recurso_glosa_p,'N'), false);
	
	
	if (current_setting('pls_apropriacao_pck.ie_recurso_glosa_w')::varchar(10) = 'S') then
		PERFORM set_config('pls_apropriacao_pck.vl_fixo_aprop_conta_w', 0, false);
		PERFORM set_config('pls_apropriacao_pck.vl_pendente_aprop_w', 0, false);
		PERFORM set_config('pls_apropriacao_pck.nr_centro_nao_aprop_w', 0, false);
		PERFORM set_config('pls_apropriacao_pck.ie_primeira_vez_w', 'S', false);
		PERFORM set_config('pls_apropriacao_pck.nr_seq_regra_aprop_ant_w', 0, false);
		current_setting('pls_apropriacao_pck.vl_pendente_guia_table_w')::pls_util_cta_pck.t_number_table.delete;
	end if;

	if (nr_seq_conta_proc_p IS NOT NULL AND nr_seq_conta_proc_p::text <> '') then
		PERFORM set_config('pls_apropriacao_pck.ie_gerando_conta_proc_mat_w', 'P', false);
		
		select	*
		into STRICT	current_setting('pls_apropriacao_pck.pls_conta_proc_w')::pls_conta_proc%rowtype
		from	pls_conta_proc
		where	nr_sequencia = nr_seq_conta_proc_p;
		
		CALL CALL pls_apropriacao_pck.carregar_variaveis_pck(current_setting('pls_apropriacao_pck.pls_conta_proc_w')::pls_conta_proc%rowtype.nr_seq_conta, null, nm_usuario_p);
		
		nr_seq_conta_w	:= current_setting('pls_apropriacao_pck.pls_conta_proc_w')::pls_conta_proc%rowtype.nr_seq_conta;
		
	elsif (nr_seq_conta_mat_p IS NOT NULL AND nr_seq_conta_mat_p::text <> '') then
		PERFORM set_config('pls_apropriacao_pck.ie_gerando_conta_proc_mat_w', 'M', false);
		
		select	*
		into STRICT	current_setting('pls_apropriacao_pck.pls_conta_mat_w')::pls_conta_mat%rowtype
		from	pls_conta_mat
		where	nr_sequencia = nr_seq_conta_mat_p;
		
		CALL CALL pls_apropriacao_pck.carregar_variaveis_pck(current_setting('pls_apropriacao_pck.pls_conta_mat_w')::pls_conta_mat%rowtype.nr_seq_conta, null, nm_usuario_p);
		
		nr_seq_conta_w	:= current_setting('pls_apropriacao_pck.pls_conta_mat_w')::pls_conta_mat%rowtype.nr_seq_conta;
	end if;
	
	if (nr_seq_proc_rec_p IS NOT NULL AND nr_seq_proc_rec_p::text <> '') then
		PERFORM set_config('pls_apropriacao_pck.ie_gerando_rec_proc_mat_w', 'P', false);
	
		select	*
		into STRICT	current_setting('pls_apropriacao_pck.pls_rec_glosa_proc_w')::pls_rec_glosa_proc%rowtype
		from	pls_rec_glosa_proc
		where	nr_sequencia = nr_seq_proc_rec_p;
		
		CALL CALL pls_apropriacao_pck.carregar_variaveis_pck(nr_seq_conta_w, current_setting('pls_apropriacao_pck.pls_rec_glosa_proc_w')::pls_rec_glosa_proc%rowtype.nr_seq_conta_rec, nm_usuario_p);
		
	elsif (nr_seq_mat_rec_p IS NOT NULL AND nr_seq_mat_rec_p::text <> '') then
		PERFORM set_config('pls_apropriacao_pck.ie_gerando_rec_proc_mat_w', 'M', false);
		
		select	*
		into STRICT	current_setting('pls_apropriacao_pck.pls_rec_glosa_mat_w')::pls_rec_glosa_mat%rowtype
		from	pls_rec_glosa_mat
		where	nr_sequencia = nr_seq_mat_rec_p;
		
		CALL CALL pls_apropriacao_pck.carregar_variaveis_pck(nr_seq_conta_w, current_setting('pls_apropriacao_pck.pls_rec_glosa_mat_w')::pls_rec_glosa_mat%rowtype.nr_seq_conta_rec, nm_usuario_p);
	end if;
	
	if (ie_primeira_p = 'S') then
		CALL CALL pls_apropriacao_pck.iterar_regras_coparticipacao('P');
	end if;

	CALL pls_apropriacao_pck.gerar_pos_estab_aprop(nr_seq_conta_proc_p, nr_seq_conta_mat_p,current_setting('pls_apropriacao_pck.nr_seq_proc_rec_w')::pls_rec_glosa_proc.nr_sequencia%type,current_setting('pls_apropriacao_pck.nr_seq_mat_rec_w')::pls_rec_glosa_mat.nr_sequencia%type, nm_usuario_p);
	
	
	if (current_setting('pls_apropriacao_pck.ie_recurso_glosa_w')::varchar(10) = 'S') then
		CALL pls_gerar_contab_val_adic(	nr_seq_conta_w,	nr_seq_conta_proc_p, nr_seq_conta_mat_p,current_setting('pls_apropriacao_pck.nr_seq_proc_rec_w')::pls_rec_glosa_proc.nr_sequencia%type,
						current_setting('pls_apropriacao_pck.nr_seq_mat_rec_w')::pls_rec_glosa_mat.nr_sequencia%type,null,null, 'P','R', nm_usuario_p);
	end if;
	
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_apropriacao_pck.pls_gerar_apropriacao_pos ( nr_seq_conta_proc_p pls_conta_proc.nr_sequencia%type, nr_seq_conta_mat_p pls_conta_mat.nr_sequencia%type, nr_seq_proc_rec_p pls_rec_glosa_proc.nr_sequencia%type, nr_seq_mat_rec_p pls_rec_glosa_mat.nr_sequencia%type, ie_recurso_glosa_p text, ie_primeira_p text, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;
