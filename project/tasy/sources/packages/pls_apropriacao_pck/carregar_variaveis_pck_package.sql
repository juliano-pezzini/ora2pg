-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_apropriacao_pck.carregar_variaveis_pck (nr_seq_conta_p pls_conta.nr_sequencia%type, nr_seq_conta_rec_p pls_rec_glosa_conta.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE

				
nr_seq_conta_w		pls_conta.nr_sequencia%type;


BEGIN
	PERFORM set_config('pls_apropriacao_pck.nm_usuario_w', nm_usuario_p, false);
	
	if (coalesce(nr_seq_conta_p::text, '') = '') and (nr_seq_conta_rec_p IS NOT NULL AND nr_seq_conta_rec_p::text <> '') then
		select	nr_seq_conta
		into STRICT	nr_seq_conta_w
		from	pls_rec_glosa_conta
		where	nr_sequencia = nr_seq_conta_rec_p;
	else
		nr_seq_conta_w := nr_seq_conta_p;
	end if;
	
	select	*
	into STRICT	current_setting('pls_apropriacao_pck.pls_conta_w')::pls_conta%rowtype
	from	pls_conta
	where	nr_sequencia = nr_seq_conta_w;
	
	select	*
	into STRICT	current_setting('pls_apropriacao_pck.pls_protocolo_conta_w')::pls_protocolo_conta%rowtype
	from	pls_protocolo_conta
	where	nr_sequencia = current_setting('pls_apropriacao_pck.pls_conta_w')::pls_conta%rowtype.nr_seq_protocolo;
	
	if (current_setting('pls_apropriacao_pck.pls_conta_w')::pls_conta%coalesce(rowtype.nr_seq_segurado::text, '') = '') then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(306392,'NR_SEQ_CONTA=' || current_setting('pls_apropriacao_pck.pls_conta_w')::pls_conta%rowtype.nr_sequencia);
	else
		select	*
		into STRICT	current_setting('pls_apropriacao_pck.pls_segurado_w')::pls_segurado%rowtype
		from	pls_segurado
		where	nr_sequencia = current_setting('pls_apropriacao_pck.pls_conta_w')::pls_conta%rowtype.nr_seq_segurado;
		
		if (current_setting('pls_apropriacao_pck.pls_segurado_w')::pls_segurado%(rowtype.nr_seq_plano IS NOT NULL AND rowtype.nr_seq_plano::text <> '')) then
			select	*
			into STRICT	current_setting('pls_apropriacao_pck.pls_plano_w')::pls_plano%rowtype
			from	pls_plano
			where	nr_sequencia = current_setting('pls_apropriacao_pck.pls_segurado_w')::pls_segurado%rowtype.nr_seq_plano;
		end if;
	end if;
	
	select	*
	into STRICT	current_setting('pls_apropriacao_pck.pls_parametros_w')::pls_parametros%rowtype
	from	pls_parametros
	where	cd_estabelecimento = current_setting('pls_apropriacao_pck.pls_conta_w')::pls_conta%rowtype.cd_estabelecimento;
	
	if (current_setting('pls_apropriacao_pck.pls_segurado_w')::pls_segurado%(rowtype.nr_seq_contrato IS NOT NULL AND rowtype.nr_seq_contrato::text <> '')) then
		select	*
		into STRICT	current_setting('pls_apropriacao_pck.pls_contrato_w')::pls_contrato%rowtype
		from	pls_contrato
		where	nr_sequencia = current_setting('pls_apropriacao_pck.pls_segurado_w')::pls_segurado%rowtype.nr_seq_contrato;
	elsif (current_setting('pls_apropriacao_pck.pls_segurado_w')::pls_segurado%(rowtype.nr_seq_intercambio IS NOT NULL AND rowtype.nr_seq_intercambio::text <> '')) then
		select	*
		into STRICT	current_setting('pls_apropriacao_pck.pls_intercambio_w')::pls_intercambio%rowtype
		from	pls_intercambio
		where	nr_sequencia = current_setting('pls_apropriacao_pck.pls_segurado_w')::pls_segurado%rowtype.nr_seq_intercambio;
	end if;
	
	begin
	select	CASE WHEN coalesce(cd_cgc::text, '') = '' THEN 'PF'  ELSE 'PJ' END
	into STRICT	current_setting('pls_apropriacao_pck.ie_tipo_prestador_atend_w')::varchar(2)
	from	pls_prestador
	where	nr_sequencia	= current_setting('pls_apropriacao_pck.pls_protocolo_conta_w')::pls_protocolo_conta%rowtype.nr_seq_prestador;
	exception
	when others then
		PERFORM set_config('pls_apropriacao_pck.ie_tipo_prestador_atend_w', null, false);
	end;
	
	begin
	select	CASE WHEN coalesce(cd_cgc::text, '') = '' THEN 'PF'  ELSE 'PJ' END
	into STRICT	current_setting('pls_apropriacao_pck.ie_tipo_prestador_exec_w')::varchar(2)
	from	pls_prestador
	where	nr_sequencia	= current_setting('pls_apropriacao_pck.pls_conta_w')::pls_conta%rowtype.nr_seq_prestador_exec;
	exception
	when others then
		PERFORM set_config('pls_apropriacao_pck.ie_tipo_prestador_exec_w', null, false);
	end;
	
	if (nr_seq_conta_rec_p IS NOT NULL AND nr_seq_conta_rec_p::text <> '') then
		
		select	*
		into STRICT	current_setting('pls_apropriacao_pck.pls_rec_glosa_conta_w')::pls_rec_glosa_conta%rowtype
		from	pls_rec_glosa_conta
		where	nr_sequencia = nr_seq_conta_rec_p;
	
	end if;
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_apropriacao_pck.carregar_variaveis_pck (nr_seq_conta_p pls_conta.nr_sequencia%type, nr_seq_conta_rec_p pls_rec_glosa_conta.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;
