-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_apropriacao_pck.valida_regra_copartic_rec ( nr_seq_conta_proc_p pls_conta_proc.nr_sequencia%type, nr_seq_conta_mat_p pls_conta_mat.nr_sequencia%type, nr_seq_regra_copartic_p pls_regra_copartic.nr_sequencia%type, vl_copartic_rec_p INOUT pls_conta_coparticipacao.vl_coparticipacao%type, ie_retorno_p INOUT text, nr_seq_centro_apropriacao_p pls_centro_apropriacao.nr_sequencia%type, ie_tipo_aprop_w pls_regra_copartic_aprop.ie_tipo_apropriacao%type) AS $body$
DECLARE

					
nr_seq_centro_apropriacao_w	pls_centro_apropriacao.nr_sequencia%type;			
ie_tipo_apropriacao_w		pls_regra_copartic_aprop.ie_tipo_apropriacao%type;	
vl_coparticipacao_w		pls_conta_coparticipacao.vl_coparticipacao%type := 0;
vl_copartic_rec_w		pls_conta_coparticipacao.vl_coparticipacao%type;
vl_maximo_copartic_w		pls_regra_copartic.vl_maximo_copartic%type;
nr_seq_regra_copartic_aprop_w	pls_regra_copartic_aprop.nr_sequencia%type;
vl_apropriacao_w		pls_regra_copartic_aprop.vl_apropriacao%type;
qt_liberado_org_w		pls_conta_mat.qt_material%type;
qt_copart_w			integer;
ie_retorno_w			varchar(1);


BEGIN
ie_retorno_w := 'S';
if (nr_seq_conta_proc_p IS NOT NULL AND nr_seq_conta_proc_p::text <> '') then
	
	select	count(1),
		coalesce(sum(a.vl_apropriacao),0)
	into STRICT	qt_copart_w,
		vl_coparticipacao_w
	from	pls_conta_coparticipacao x,
		pls_conta_copartic_aprop a,
		pls_centro_apropriacao b
	where 	a.nr_seq_conta_coparticipacao	= x.nr_sequencia
	and 	a.nr_seq_centro_apropriacao = b.nr_sequencia
	and	x.nr_seq_conta_proc = nr_seq_conta_proc_p
	and 	a.nr_seq_centro_apropriacao = nr_seq_centro_apropriacao_p
	and	coalesce(x.nr_seq_conta_rec::text, '') = '';
	
	select	max(qt_procedimento)
	into STRICT	qt_liberado_org_w
	from	pls_conta_proc
	where	nr_sequencia = nr_seq_conta_proc_p;
	
elsif (nr_seq_conta_mat_p IS NOT NULL AND nr_seq_conta_mat_p::text <> '') then
	
	select	count(1),
		coalesce(sum(a.vl_apropriacao),0)
	into STRICT	qt_copart_w,
		vl_coparticipacao_w
	from	pls_conta_coparticipacao x,
		pls_conta_copartic_aprop a,
		pls_centro_apropriacao b
	where 	a.nr_seq_conta_coparticipacao	= x.nr_sequencia
	and 	a.nr_seq_centro_apropriacao = b.nr_sequencia
	and	x.nr_seq_conta_mat = nr_seq_conta_mat_p
	and 	a.nr_seq_centro_apropriacao = nr_seq_centro_apropriacao_p
	and	coalesce(x.nr_seq_conta_rec::text, '') = '';
	
	
	select	max(qt_material)
	into STRICT	qt_liberado_org_w
	from	pls_conta_mat
	where	nr_sequencia = nr_seq_conta_mat_p;
end if;
	
select	max(nr_sequencia)
into STRICT	nr_seq_regra_copartic_aprop_w
from	pls_regra_copartic_aprop
where	nr_seq_regra = nr_seq_regra_copartic_p
and	nr_seq_centro_apropriacao = nr_seq_centro_apropriacao_p;--nr_seq_centro_apropriacao_w;

if (nr_seq_regra_copartic_aprop_w IS NOT NULL AND nr_seq_regra_copartic_aprop_w::text <> '') then
	select	vl_apropriacao,
		ie_tipo_apropriacao
	into STRICT	vl_apropriacao_w,
		ie_tipo_apropriacao_w
	from	pls_regra_copartic_aprop
	where	nr_sequencia = nr_seq_regra_copartic_aprop_w;


	if ( ie_tipo_apropriacao_w = '1') then
		
		if (qt_liberado_org_w > 0) then
			vl_apropriacao_w := vl_apropriacao_w * qt_liberado_org_w;
		end if;
	
		if (vl_coparticipacao_w >= vl_apropriacao_w) then
			ie_retorno_w := 'N';	
		else
			vl_copartic_rec_w := vl_apropriacao_w - vl_coparticipacao_w;
			
			if (vl_copartic_rec_w <= vl_copartic_rec_p) then
				vl_copartic_rec_p := vl_copartic_rec_w;
			end if;
		end if;
	else
		select	coalesce(max(vl_maximo_copartic),0)
		into STRICT	vl_maximo_copartic_w
		from	pls_regra_copartic
		where	nr_sequencia = nr_seq_regra_copartic_p;
		
		if (vl_maximo_copartic_w > 0) then
			if (vl_coparticipacao_w >= vl_maximo_copartic_w) then
				ie_retorno_w := 'N';
			elsif (vl_coparticipacao_w < vl_maximo_copartic_w) then
				vl_copartic_rec_w := vl_maximo_copartic_w - vl_coparticipacao_w;
				
				if (vl_copartic_rec_w <= vl_copartic_rec_p) then
					vl_copartic_rec_p := vl_copartic_rec_w;
				end if;
			end if;
		end if;
	end if;
end if;


ie_retorno_p := ie_retorno_w;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_apropriacao_pck.valida_regra_copartic_rec ( nr_seq_conta_proc_p pls_conta_proc.nr_sequencia%type, nr_seq_conta_mat_p pls_conta_mat.nr_sequencia%type, nr_seq_regra_copartic_p pls_regra_copartic.nr_sequencia%type, vl_copartic_rec_p INOUT pls_conta_coparticipacao.vl_coparticipacao%type, ie_retorno_p INOUT text, nr_seq_centro_apropriacao_p pls_centro_apropriacao.nr_sequencia%type, ie_tipo_aprop_w pls_regra_copartic_aprop.ie_tipo_apropriacao%type) FROM PUBLIC;
