-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION usernames_available_pck.get_data ( nm_usuario_p text) RETURNS SETOF T_OBJETO_ROW_DATA AS $body$
DECLARE

							
t_objeto_row_w					t_objeto_row;
nm_usuario_lista_w				usuario.nm_usuario%type := 'xpto';
ie_visualiza_bloqueados_w 		varchar(1);					

usernames_available CURSOR FOR
	SELECT	2 ie_tipo,
			b.nr_sequencia,
			a.nm_usuario,
			a.cd_pessoa_fisica,
			substr(obter_nome_pf(a.cd_pessoa_fisica),1,255) nm_pessoa_fisica,
			b.ie_atualizar,
			coalesce(b.nr_seq_tipo,0) nr_seq_tipo,
			coalesce(qt_horas_agendamento,0) qt_horas_agendamento,
			obter_se_ag_part_livre(nm_usuario_p, b.ie_agenda) ie_somente_livre,
			2 ie_ordenacao,
			2 ie_prioridade
	FROM	usuario a,
			agenda_tasy_perm b
	WHERE 	a.nm_usuario = b.nm_usuario_agenda
	and 	a.nm_usuario <> nm_usuario_p
	and 	((coalesce(ie_visualiza_bloqueados_w, 'N') = 'N' and a.ie_situacao = 'A')
			or (coalesce(ie_visualiza_bloqueados_w, 'N') = 'S' and a.ie_situacao in ('A', 'B')))
	and 	exists (SELECT 	1  
					FROM	usuario_perfil x
					WHERE 	b.cd_perfil_perm 	= x.cd_perfil
					AND		x.nm_usuario 		= nm_usuario_p 
					AND		x.cd_perfil 		= wheb_usuario_pck.get_cd_perfil)
	
UNION

	SELECT 	2 ie_tipo,
			b.nr_sequencia,
			a.nm_usuario,
			a.cd_pessoa_fisica,
			substr(obter_nome_pf(a.cd_pessoa_fisica),1,255) nm_pessoa_fisica,
			b.ie_atualizar,
			coalesce(b.nr_seq_tipo,0) nr_seq_tipo,
			coalesce(qt_horas_agendamento,0) qt_horas_agendamento,
			obter_se_ag_part_livre(nm_usuario_p, b.ie_agenda) ie_somente_livre,
			2 ie_ordenacao,
			3 ie_prioridade
	FROM	usuario a,
			agenda_tasy_perm b
	WHERE 	a.nm_usuario   = b.nm_usuario_agenda 
	AND		b.nm_usuario_perm = nm_usuario_p
	AND		b.nm_usuario_agenda <> nm_usuario_p
	and 	((coalesce(ie_visualiza_bloqueados_w, 'N') = 'N' and a.ie_situacao = 'A') 
			or (coalesce(ie_visualiza_bloqueados_w, 'N') = 'S' and a.ie_situacao in ('A', 'B')))
	
UNION ALL

	SELECT  2 ie_tipo,
			1 nr_sequencia,
			a.nm_usuario,
			a.cd_pessoa_fisica,
			substr(obter_nome_pf(a.cd_pessoa_fisica),1,255) nm_pessoa_fisica,
			'S' ie_atualizar,
			0 nr_seq_tipo,
			0 qt_horas_agendamento,
			'N' ie_somente_livre,
			1 ie_ordenacao,
			4 ie_prioridade
	FROM	usuario a
	WHERE 	a.nm_usuario = nm_usuario_p
	and 	((coalesce(ie_visualiza_bloqueados_w, 'N') = 'N' and a.ie_situacao = 'A') 
			or (coalesce(ie_visualiza_bloqueados_w, 'N') = 'S' and a.ie_situacao in ('A', 'B')))
	
UNION ALL

	SELECT 	3 ie_tipo,
			b.nr_sequencia,
			a.nm_usuario,
			a.cd_pessoa_fisica,
			substr(obter_nome_pf(a.cd_pessoa_fisica),1,255) nm_pessoa_fisica,
			b.ie_atualizar,
			coalesce(b.nr_seq_tipo,0) nr_seq_tipo,
			coalesce(qt_horas_agendamento,0) qt_horas_agendamento,
			obter_se_ag_part_livre(nm_usuario_p, b.ie_agenda) ie_somente_livre,
			2 ie_ordenacao,
			1 ie_prioridade
	FROM	usuario a,
			agenda_tasy_perm b
	WHERE 	a.nm_usuario = b.nm_usuario_agenda
	and 	a.nm_usuario <> nm_usuario_p
	and 	coalesce(b.nm_usuario_perm::text, '') = ''
	and 	coalesce(b.cd_perfil_perm::text, '') = ''
	and 	coalesce(b.nr_seq_grupo_usuario::text, '') = ''
	and 	((coalesce(ie_visualiza_bloqueados_w, 'N') = 'N' and a.ie_situacao = 'A') 
			or (coalesce(ie_visualiza_bloqueados_w, 'N') = 'S' and a.ie_situacao in ('A', 'B')))
	
UNION

	SELECT 	4 ie_tipo,
			b.nr_sequencia,
			a.nm_usuario,
			a.cd_pessoa_fisica,
			substr(obter_nome_pf(a.cd_pessoa_fisica),1,255) nm_pessoa_fisica,
			b.ie_atualizar,
			coalesce(b.nr_seq_tipo,0) nr_seq_tipo,
			coalesce(qt_horas_agendamento,0) qt_horas_agendamento,
			obter_se_ag_part_livre(nm_usuario_p, b.ie_agenda) ie_somente_livre,
			2 ie_ordenacao,
			1 ie_prioridade
	FROM	usuario a,
			agenda_tasy_perm b
	WHERE 	a.nm_usuario = b.nm_usuario_agenda
	and 	a.nm_usuario <> nm_usuario_p
	and 	coalesce(b.nm_usuario_perm::text, '') = ''
	and 	coalesce(b.cd_perfil_perm::text, '') = ''
	and 	exists (SELECT 	1
					FROM	usuario_grupo x
					WHERE 	x.nr_seq_grupo = b.nr_seq_grupo_usuario
					AND		x.nm_usuario_grupo = nm_usuario_p
					AND 	((coalesce(ie_visualiza_bloqueados_w, 'N') = 'N' AND a.ie_situacao = 'A') 
							OR (coalesce(ie_visualiza_bloqueados_w, 'N') = 'S' AND a.ie_situacao IN ('A', 'B'))))
	and 	((coalesce(ie_visualiza_bloqueados_w, 'N') = 'N' and a.ie_situacao = 'A') 
			or (coalesce(ie_visualiza_bloqueados_w, 'N') = 'S' and a.ie_situacao in ('A', 'B')))
	ORDER BY	nm_usuario,ie_prioridade desc, nr_sequencia desc;

BEGIN

obter_param_usuario(791,46,obter_perfil_ativo,nm_usuario_p,obter_estabelecimento_ativo,ie_visualiza_bloqueados_w);

FOR c_usernames_available IN usernames_available LOOP
	BEGIN
	if (nm_usuario_lista_w <> c_usernames_available.nm_usuario) then
		nm_usuario_lista_w					:= c_usernames_available.nm_usuario;
		
		t_objeto_row_w.ie_tipo				:= c_usernames_available.ie_tipo;
		t_objeto_row_w.nm_usuario			:= c_usernames_available.nm_usuario;
		t_objeto_row_w.cd_pessoa_fisica		:= c_usernames_available.cd_pessoa_fisica;
		t_objeto_row_w.nm_pessoa_fisica		:= c_usernames_available.nm_pessoa_fisica;
		t_objeto_row_w.ie_atualizar			:= c_usernames_available.ie_atualizar;
		t_objeto_row_w.nr_seq_tipo			:= c_usernames_available.nr_seq_tipo;
		t_objeto_row_w.qt_horas_agendamento	:= c_usernames_available.qt_horas_agendamento;
		t_objeto_row_w.ie_somente_livre		:= c_usernames_available.ie_somente_livre;
		t_objeto_row_w.ie_ordenacao			:= c_usernames_available.ie_ordenacao;
		RETURN NEXT t_objeto_row_w;
	end if;	
	END;
end loop;	

RETURN;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION usernames_available_pck.get_data ( nm_usuario_p text) FROM PUBLIC;
