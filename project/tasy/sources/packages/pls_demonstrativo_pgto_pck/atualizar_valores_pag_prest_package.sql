-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_demonstrativo_pgto_pck.atualizar_valores_pag_prest ( nr_seq_versao_rel_p pls_rel_pprest_versao.nr_sequencia%type) AS $body$
DECLARE


vl_total_informado_w		pls_rel_pprest_dados_pag.vl_total_informado%type;
vl_total_processado_w		pls_rel_pprest_dados_pag.vl_total_processado%type;
vl_total_liberado_w		pls_rel_pprest_dados_pag.vl_total_liberado%type;
vl_total_glosa_w		pls_rel_pprest_dados_pag.vl_total_glosa%type;
vl_total_debito_w		pls_rel_pprest_dados_pag.vl_total_debito%type;
vl_total_credito_w		pls_rel_pprest_dados_pag.vl_total_credito%type;
vl_final_receber_w		pls_rel_pprest_dados_pag.vl_final_receber%type;

vl_total_informado_rel_w	pls_rel_pprest_versao.vl_total_informado%type	:= 0;
vl_total_processado_rel_w	pls_rel_pprest_versao.vl_total_processado%type	:= 0;
vl_total_liberado_rel_w		pls_rel_pprest_versao.vl_total_liberado%type	:= 0;
vl_total_glosa_rel_w		pls_rel_pprest_versao.vl_total_glosa%type	:= 0;
vl_total_debito_rel_w 		pls_rel_pprest_versao.vl_total_debito%type	:= 0;
vl_total_credito_rel_w  	pls_rel_pprest_versao.vl_total_credito%type	:= 0;
vl_final_receber_rel_w 		pls_rel_pprest_versao.vl_final_receber%type	:= 0;


C01 CURSOR(nr_seq_versao_rel_pc	pls_rel_pprest_versao.nr_sequencia%type) FOR
	SELECT	nr_sequencia nr_seq_dados_pag
	from	pls_rel_pprest_dados_pag
	where	nr_seq_versao_rel	= nr_seq_versao_rel_pc;

BEGIN

for r_c01_w in c01(nr_seq_versao_rel_p) loop

	select	sum(vl_informado),
		sum(vl_processado),
		sum(vl_liberado),
		sum(vl_glosa)
	into STRICT	vl_total_informado_w,
		vl_total_processado_w,
		vl_total_liberado_w,
		vl_total_glosa_w
	from	pls_rel_pprest_prot
	where	nr_seq_dados_pag	= r_c01_w.nr_seq_dados_pag;
	
	select	sum(CASE WHEN ie_indicacao='D' THEN vl_debito_credito  ELSE 0 END ),
		sum(CASE WHEN ie_indicacao='C' THEN vl_debito_credito  ELSE 0 END )
	into STRICT	vl_total_debito_w,
		vl_total_credito_w
	from	pls_rel_pprest_deb_cred
	where	nr_seq_dados_pag	= r_c01_w.nr_seq_dados_pag;
	
	update	pls_rel_pprest_dados_pag
	set	vl_total_informado	= coalesce(vl_total_informado_w,0),
		vl_total_processado	= coalesce(vl_total_processado_w,0),
		vl_total_liberado	= coalesce(vl_total_liberado_w,0),
		vl_total_glosa		= coalesce(vl_total_glosa_w,0),
		vl_total_debito		= coalesce(vl_total_debito_w,0),
		vl_total_credito	= coalesce(vl_total_credito_w,0),
		vl_final_receber	= coalesce(vl_total_liberado_w,0) + coalesce(vl_total_debito_w,0) * -1 + coalesce(vl_total_credito_w,0)
	where	nr_sequencia		= r_c01_w.nr_seq_dados_pag;
	
	vl_total_informado_rel_w	:= vl_total_informado_rel_w + coalesce(vl_total_informado_w,0);
	vl_total_processado_rel_w	:= vl_total_processado_rel_w + coalesce(vl_total_processado_w,0);
	vl_total_liberado_rel_w		:= vl_total_liberado_rel_w + coalesce(vl_total_liberado_w,0);
	vl_total_glosa_rel_w		:= vl_total_glosa_rel_w + coalesce(vl_total_glosa_w,0);
	vl_total_debito_rel_w 		:= vl_total_debito_rel_w + coalesce(vl_total_debito_w,0);
	vl_total_credito_rel_w  	:= vl_total_credito_rel_w + coalesce(vl_total_credito_w,0);
	vl_final_receber_rel_w 		:= vl_final_receber_rel_w + coalesce(vl_total_liberado_w,0) + coalesce(vl_total_debito_w,0) * -1 + coalesce(vl_total_credito_w,0);

end loop;

update	pls_rel_pprest_versao
set	vl_total_informado	= coalesce(vl_total_informado_rel_w,0),
	vl_total_processado	= coalesce(vl_total_processado_rel_w,0),
	vl_total_liberado	= coalesce(vl_total_liberado_rel_w,0),
	vl_total_glosa		= coalesce(vl_total_glosa_rel_w,0),
	vl_total_debito		= coalesce(vl_total_debito_rel_w,0),
	vl_total_credito	= coalesce(vl_total_credito_rel_w,0),
	vl_final_receber	= coalesce(vl_final_receber_rel_w,0)
where	nr_sequencia		= nr_seq_versao_rel_p;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_demonstrativo_pgto_pck.atualizar_valores_pag_prest ( nr_seq_versao_rel_p pls_rel_pprest_versao.nr_sequencia%type) FROM PUBLIC;
