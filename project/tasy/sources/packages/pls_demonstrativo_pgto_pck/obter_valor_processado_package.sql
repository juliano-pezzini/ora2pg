-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


/*
	Essa funcion retorna o vl_total_calculado do protocolo que no demonstrativo sera apresentado como o valor processado. Foi necessaria
	essa function pois nao pode ser simplesmente feito um sum desse campo de todos os materiais e procedimentos devido a particularidades como
	ao nao fracionamento do vl_calculado dos procedimentos entre os registros da pls_conta_medica_resumo(Uma conta_proc pode ter mais de uma
	linha na pls_conta_medica_resumo)
*/



CREATE OR REPLACE FUNCTION pls_demonstrativo_pgto_pck.obter_valor_processado (nr_seq_lote_pgto_p pls_lote_pagamento.nr_sequencia%type, nr_seq_protocolo_p pls_protocolo_conta.nr_sequencia%type, nr_seq_prestador_p pls_prestador.nr_sequencia%type, ie_funcao_pagamento_p pls_parametro_pagamento.ie_funcao_pagamento%type) RETURNS bigint AS $body$
DECLARE


vl_processado_materiais_w 	pls_conta_medica_resumo.vl_calculado%type := 0;
vl_processado_procedimentos_w	pls_conta_medica_resumo.vl_calculado%type := 0;
vl_total_w			pls_conta_medica_resumo.vl_calculado%type := 0;
/*
	Como podem ter mais de uma linha na pls_conta_medica resumo para um mesmo procedimento e o vl_calculado nao e dividido propocionalmente entre os registros, entao para que
	o valor correto seja retornado, e buscado o maior valor calculado entre os registros referentes aquela sequencia da conta proc. 
	No select abaixo, sao passados os 3 parametros na pesquisa na pls_conta_medica_resumo devido a necessidade de pegar um determinado indice na realizacao da consulta
*/

C01 CURSOR(	nr_seq_lote_pgto_pc	pls_lote_pagamento.nr_sequencia%type,
		nr_seq_protocolo_pc	pls_protocolo_conta.nr_sequencia%type,
		nr_seq_prestador_pc	pls_prestador.nr_sequencia%type,
		ie_funcao_pagamento_pc	pls_parametro_pagamento.ie_funcao_pagamento%type) FOR
	SELECT  max(coalesce(b.vl_calculado, 0)) vl_processado
	from	pls_conta_medica_resumo b
	where   ie_funcao_pagamento_pc = '1'
	and	b.nr_seq_lote_pgto = nr_seq_lote_pgto_pc
	and	b.nr_seq_prestador_pgto = nr_seq_prestador_pc
	and	b.nr_seq_protocolo = nr_seq_protocolo_pc
	and	b.ie_situacao = 'A'
	group by b.nr_seq_conta_proc
	
union all

	SELECT  max(coalesce(b.vl_calculado, 0)) vl_processado
	from	pls_conta_medica_resumo b
	where   ie_funcao_pagamento_pc = '2'
	and	b.nr_seq_pp_lote = nr_seq_lote_pgto_pc
	and	b.nr_seq_prestador_pgto = nr_seq_prestador_pc
	and	b.nr_seq_protocolo = nr_seq_protocolo_pc
	and	b.ie_situacao = 'A'
	group by b.nr_seq_conta_proc;

BEGIN
	/*
		Valor calculado total dos materiais para o protocolo passado por parametro. No
		select abaixo, sao passados os 3 parametros na pesquisa na pls_conta_medica_resumo 
		devido a necessidade de pegar um determinado indice na realizacao da consulta
	*/

	if (ie_funcao_pagamento_p = '1') then

		select  sum(vl_calculado) vl_processado_materiais
		into STRICT	vl_processado_materiais_w
		from	pls_conta_medica_resumo b
		where   b.nr_seq_lote_pgto = nr_seq_lote_pgto_p
		and	b.nr_seq_prestador_pgto	= nr_seq_prestador_p
		and	b.nr_seq_protocolo = nr_seq_protocolo_p
		and	(b.nr_seq_conta_mat IS NOT NULL AND b.nr_seq_conta_mat::text <> '')
		and	b.ie_situacao = 'A';
	else
		select  sum(vl_calculado) vl_processado_materiais
		into STRICT	vl_processado_materiais_w
		from	pls_conta_medica_resumo b
		where   b.nr_seq_pp_lote = nr_seq_lote_pgto_p
		and	b.nr_seq_prestador_pgto	= nr_seq_prestador_p
		and	b.nr_seq_protocolo = nr_seq_protocolo_p
		and	(b.nr_seq_conta_mat IS NOT NULL AND b.nr_seq_conta_mat::text <> '')
		and	b.ie_situacao = 'A';
	end if;

	-- Percorre o cursor que retorna a cada iteracao o maior valor calculado de cada registro da pls_conta_proc presente na pls_conta_resumo para 

	-- o protocolo passado por parametro.

	for r_c01_w in C01(	nr_seq_lote_pgto_p, nr_seq_protocolo_p, nr_seq_prestador_p,
				ie_funcao_pagamento_p) loop
		--Soma os valores de para ter o total calculado do protocolo(nesse caso, o total dos procedimentos apenas)

		vl_processado_procedimentos_w := vl_processado_procedimentos_w + r_c01_w.vl_processado;
	end loop;

	--Total calculado dos procedimentos + o valor total dos materiais

	vl_total_w := coalesce(vl_processado_procedimentos_w,0) + coalesce(vl_processado_materiais_w,0);

return	vl_total_w;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pls_demonstrativo_pgto_pck.obter_valor_processado (nr_seq_lote_pgto_p pls_lote_pagamento.nr_sequencia%type, nr_seq_protocolo_p pls_protocolo_conta.nr_sequencia%type, nr_seq_prestador_p pls_prestador.nr_sequencia%type, ie_funcao_pagamento_p pls_parametro_pagamento.ie_funcao_pagamento%type) FROM PUBLIC;
