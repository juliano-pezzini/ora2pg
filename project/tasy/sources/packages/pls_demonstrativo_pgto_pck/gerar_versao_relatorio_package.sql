-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_demonstrativo_pgto_pck.gerar_versao_relatorio ( nr_seq_relatorio_p pls_rel_pag_prestador.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, nr_seq_versao_rel_p INOUT pls_rel_pprest_versao.nr_sequencia%type) AS $body$
DECLARE


tb_pls_rel_pag_prestador_w	pls_rel_pag_prestador%rowtype;
cd_estabelecimento_w		pls_web_param_geral.cd_estabelecimento%type;
cd_ans_w			pls_rel_pprest_versao.cd_ans%type;
ds_operadora_w			pls_rel_pprest_versao.ds_operadora%type;
cd_cgc_operadora_w		pls_rel_pprest_versao.cd_cgc_operadora%type;
nm_prestador_w			pls_rel_pprest_versao.nm_prestador%type;
cd_cnes_w			pls_rel_pprest_versao.cd_cnes%type;


BEGIN

/*Busca o estabelecimento da operadora*/


select	max(cd_estabelecimento)
into STRICT	cd_estabelecimento_w
from	pls_web_param_geral;

/*Caso nao tiver, busca da outorgante*/


if (coalesce(cd_estabelecimento_w::text, '') = '') then
	select	max(cd_estabelecimento)
	into STRICT	cd_estabelecimento_w
	from	pls_outorgante;
end if;

/*Busca os dados da operadora*/


select	cd_cgc_outorgante,
	cd_ans,
	substr(obter_nome_pf_pj('',cd_cgc_outorgante),1,255)
into STRICT	cd_cgc_operadora_w,
	cd_ans_w,
	ds_operadora_w
from	pls_outorgante
where	cd_estabelecimento = cd_estabelecimento_w;

select	*
into STRICT	tb_pls_rel_pag_prestador_w
from	pls_rel_pag_prestador
where	nr_sequencia = nr_seq_relatorio_p;

if (coalesce(tb_pls_rel_pag_prestador_w.ie_funcao_pagamento::text, '') = '') then
	tb_pls_rel_pag_prestador_w.ie_funcao_pagamento := '1';
end if;

nm_prestador_w	:= substr(pls_obter_dados_prestador(tb_pls_rel_pag_prestador_w.nr_seq_prestador,'N'),1,70);
nm_prestador_w	:= ptu_somente_caracter_permitido(nm_prestador_w, 'ANS');
cd_cnes_w	:= coalesce(substr(pls_obter_cnes_prestador(tb_pls_rel_pag_prestador_w.nr_seq_prestador),1,40),'9999999');

insert into pls_rel_pprest_versao(	
		nr_sequencia, nm_usuario, dt_atualizacao,
		nm_usuario_nrec, dt_atualizacao_nrec, nr_seq_prestador,
		nr_seq_rel_pag_prest, cd_versao, cd_ans,
		cd_cgc_operadora, ds_operadora, dt_emissao,
		nm_prestador, ds_observacao, vl_total_informado,
		vl_total_processado, vl_total_liberado, vl_total_receber, 
		vl_total_debito, vl_total_credito, vl_final_receber,
		cd_cnes, ie_valor_processado
) values (	
		nextval('pls_rel_pprest_versao_seq'), nm_usuario_p, clock_timestamp(),
		nm_usuario_p, clock_timestamp(), tb_pls_rel_pag_prestador_w.nr_seq_prestador,
		nr_seq_relatorio_p, to_char(nr_seq_versao_rel_p), cd_ans_w,
		cd_cgc_operadora_w, ds_operadora_w, clock_timestamp(),
		nm_prestador_w, '', 0,
		0, 0, 0, 
		0, 0, 0,
		cd_cnes_w, tb_pls_rel_pag_prestador_w.ie_valor_processado
) returning nr_sequencia into nr_seq_versao_rel_p;

--Gera os dados do pagamento

CALL pls_demonstrativo_pgto_pck.gerar_dados_pagamento( tb_pls_rel_pag_prestador_w,nm_usuario_p,nr_seq_versao_rel_p);

--Atualiza os valores 

CALL pls_demonstrativo_pgto_pck.atualizar_valores_pag_prest(nr_seq_versao_rel_p);

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_demonstrativo_pgto_pck.gerar_versao_relatorio ( nr_seq_relatorio_p pls_rel_pag_prestador.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, nr_seq_versao_rel_p INOUT pls_rel_pprest_versao.nr_sequencia%type) FROM PUBLIC;
