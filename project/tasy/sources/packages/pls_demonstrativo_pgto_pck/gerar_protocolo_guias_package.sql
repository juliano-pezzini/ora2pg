-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_demonstrativo_pgto_pck.gerar_protocolo_guias ( nr_seq_lote_pgto_p pls_conta_medica_resumo.nr_seq_lote_pgto%type, nr_seq_protocolo_p pls_conta_medica_resumo.nr_seq_protocolo%type, nr_seq_prestador_p pls_prestador.nr_sequencia%type, nr_seq_prest_prot_p pls_rel_pprest_prot_guia.nr_seq_prest_prot%type, ie_tipo_conta_p text, ie_funcao_pagamento_p text, nr_seq_versao_rel_p pls_rel_pprest_versao.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, nr_seq_pagina_p pls_rel_pprest_prot_guia.nr_seq_pagina%type) AS $body$
DECLARE

					
c01 CURSOR(	nr_seq_lote_pgto_pc	pls_lote_pagamento.nr_sequencia%type,
		nr_seq_protocolo_pc	pls_protocolo_conta.nr_sequencia%type,
		nr_seq_prestador_pc	pls_prestador.nr_sequencia%type) FOR
		-- Conta medica 

		SELECT  b.nr_seq_conta,
			sum(b.vl_calculado) vl_processado,
			sum(b.vl_liberado) vl_liberado,
			sum(b.vl_glosa) vl_glosa
		from  	pls_conta_medica_resumo	b
		where   b.nr_seq_lote_pgto	= nr_seq_lote_pgto_pc
		and	b.nr_seq_prestador_pgto	= nr_seq_prestador_pc
		and	b.nr_seq_protocolo	= nr_seq_protocolo_pc
		and	b.ie_situacao		!= 'I'
		and 	ie_tipo_conta_p 	= 'C'
		group by 	b.nr_seq_conta
		
union

		-- Recurso de glosa (procedimentos) com protocolo

		SELECT	b.nr_seq_conta,
			sum(d.vl_acatado) vl_processado,
			sum(d.vl_acatado) vl_liberado,
			sum(d.vl_recursado) - sum(d.vl_acatado)  vl_glosa
		from	pls_conta_rec_resumo_item	a,
			pls_rec_glosa_conta		b,
			pls_rec_glosa_protocolo		c,
			pls_rec_glosa_proc		d
		where	a.nr_seq_prestador_pgto	= nr_seq_prestador_pc
		and	a.nr_seq_lote_pgto	= nr_seq_lote_pgto_pc
		and	a.nr_seq_proc_rec	= d.nr_sequencia
		and	d.nr_seq_conta_rec	= b.nr_sequencia
		and	b.nr_seq_protocolo	= c.nr_sequencia
		and	c.nr_sequencia		= nr_seq_protocolo_pc
		and 	ie_tipo_conta_p		= 'R'
		group by 	b.nr_seq_conta
		
union

		-- Recurso de glosa (materiais) com protocolo

		select	b.nr_seq_conta,
			sum(d.vl_acatado) vl_processado,
			sum(d.vl_acatado) vl_liberado,
			sum(d.vl_recursado) - sum(d.vl_acatado)  vl_glosa
		from	pls_conta_rec_resumo_item	a,
			pls_rec_glosa_conta		b,
			pls_rec_glosa_protocolo		c,
			pls_rec_glosa_mat		d
		where	a.nr_seq_prestador_pgto	= nr_seq_prestador_pc
		and	a.nr_seq_lote_pgto	= nr_seq_lote_pgto_pc
		and	a.nr_seq_mat_rec	= d.nr_sequencia
		and	d.nr_seq_conta_rec	= b.nr_sequencia
		and	b.nr_seq_protocolo	= c.nr_sequencia
		and	c.nr_sequencia		= nr_seq_protocolo_pc
		and 	ie_tipo_conta_p		= 'R'
		group by 	b.nr_seq_conta;


c03 CURSOR(	nr_seq_lote_pgto_pc	bigint,
		nr_seq_protocolo_pc	pls_protocolo_conta.nr_sequencia%type,
		nr_seq_prestador_pc	pls_prestador.nr_sequencia%type) FOR
		SELECT  a.nr_seq_conta,
			sum(a.vl_calculado) vl_processado,
			sum(a.vl_liberado) vl_liberado,
			sum(a.vl_glosa) vl_glosa
		from  	pls_conta_medica_resumo		a
		where   a.nr_seq_pp_lote 		= nr_seq_lote_pgto_pc
		and	a.nr_seq_prestador_pgto		= nr_seq_prestador_pc
		and	a.nr_seq_protocolo 		= nr_seq_protocolo_pc
		and	a.ie_situacao 			= 'A'
		and 	ie_tipo_conta_p			= 'C'
		group by a.nr_seq_conta	
		
union

		-- Recurso de glosa (procedimentos) com protocolo

		SELECT	b.nr_seq_conta,
			sum(d.vl_acatado) vl_processado,
			sum(d.vl_acatado) vl_liberado,
			sum(d.vl_recursado) - sum(d.vl_acatado)  vl_glosa
		from	pls_conta_rec_resumo_item 	a,
			pls_rec_glosa_conta 		b,
			pls_rec_glosa_protocolo 	c,
			pls_rec_glosa_proc 		d
		where	a.nr_seq_prestador_pgto		= nr_seq_prestador_pc
		and	a.nr_seq_pp_lote 		= nr_seq_lote_pgto_pc
		and	a.nr_seq_proc_rec 		= d.nr_sequencia
		and	d.nr_seq_conta_rec 		= b.nr_sequencia
		and	b.nr_seq_protocolo 		= c.nr_sequencia
		and 	ie_tipo_conta_p			= 'R'
		and	c.nr_sequencia 			= nr_seq_protocolo_pc
		group by b.nr_seq_conta	
		
union

		-- Recurso de glosa (materiais) com protocolo

		select	b.nr_seq_conta,
			sum(d.vl_acatado) vl_processado,
			sum(d.vl_acatado) vl_liberado,
			sum(d.vl_recursado) - sum(d.vl_acatado)  vl_glosa
		from	pls_conta_rec_resumo_item 	a,
			pls_rec_glosa_conta 		b,
			pls_rec_glosa_protocolo 	c,
			pls_rec_glosa_mat 		d
		where	a.nr_seq_prestador_pgto		= nr_seq_prestador_pc
		and	a.nr_seq_pp_lote 		= nr_seq_lote_pgto_pc
		and	a.nr_seq_mat_rec 		= d.nr_sequencia
		and	d.nr_seq_conta_rec 		= b.nr_sequencia
		and	b.nr_seq_protocolo 		= c.nr_sequencia
		and	c.nr_sequencia 			= nr_seq_protocolo_pc
		and 	ie_tipo_conta_p			= 'R'
		group by b.nr_seq_conta;

nr_guia_tiss_prestador_w  	pls_rel_pprest_prot_guia.nr_guia_tiss_prestador%type;
nr_guia_tiss_operadora_w   	pls_rel_pprest_prot_guia.nr_guia_tiss_operadora%type;
cd_senha_w                	pls_rel_pprest_prot_guia.cd_senha%type;
ie_tipo_pagamento_w       	pls_rel_pprest_prot_guia.ie_tipo_pagamento%type;
vl_processado_w           	pls_rel_pprest_prot_guia.vl_processado%type;
vl_liberado_w             	pls_rel_pprest_prot_guia.vl_liberado%type;
vl_glosa_w                	pls_rel_pprest_prot_guia.vl_glosa%type;

BEGIN

if (ie_funcao_pagamento_p = '1') then

	-- busca o tipo de pagamento do lote

	select 	somente_numero(pl.cd_remuneracao)
	into STRICT 	ie_tipo_pagamento_w
	from 	pls_lote_pagamento pl
	where 	pl.nr_sequencia = nr_seq_lote_pgto_p;

  
	-- para cada conta do pagamento de producao medica

	for 	r_01_w in c01(nr_seq_lote_pgto_p, nr_seq_protocolo_p, nr_seq_prestador_p) loop

		vl_processado_w := r_01_w.vl_processado;
		vl_liberado_w := r_01_w.vl_liberado;
		vl_glosa_w := r_01_w.vl_glosa;

		-- se nao for recurso de glosa

		if 	ie_tipo_conta_p = 'C' then

			-- busca os dados da conta

			select 	max(pc.nr_guia_tiss_prestador),
				max(pc.nr_guia_tiss_operadora),
				max(pc.cd_senha)
			into STRICT 	nr_guia_tiss_prestador_w,
				nr_guia_tiss_operadora_w,
				cd_senha_w
			from 	pls_conta pc
			where 	pc.nr_sequencia = r_01_w.nr_seq_conta;
		else
			-- busca os dados da conta de recurso de glosa

			select 	max(pc.nr_guia_tiss_prestador),
				max(pc.nr_guia_tiss_operadora),
				max(pr.cd_senha_rec)
			into STRICT 	nr_guia_tiss_prestador_w,
				nr_guia_tiss_operadora_w,
				cd_senha_w
			from 	pls_conta pc,
				pls_rec_glosa_conta pr
			where 	pc.nr_sequencia = r_01_w.nr_seq_conta
			and 	pr.nr_seq_conta = pc.nr_sequencia;
		end if;

		insert into pls_rel_pprest_prot_guia( 	nr_sequencia,				nr_seq_prest_prot,
							nr_guia_tiss_prestador,			nr_guia_tiss_operadora,
							cd_senha,				ie_tipo_pagamento,
							vl_processado,				vl_liberado,
							vl_glosa,				nr_seq_pagina,
							dt_atualizacao,				nm_usuario)
		values (				nextval('pls_rel_pprest_prot_guia_seq'),	nr_seq_prest_prot_p,
							nr_guia_tiss_prestador_w,		nr_guia_tiss_operadora_w,
							cd_senha_w,				ie_tipo_pagamento_w,
							vl_processado_w,			vl_liberado_w,
							vl_glosa_w,				nr_seq_pagina_p,
							clock_timestamp(),				nm_usuario_p);
	end loop;
else
	select 	somente_numero(pl.cd_remuneracao)
	into STRICT 	ie_tipo_pagamento_w
	from 	pls_pp_lote pl
	where 	pl.nr_sequencia = nr_seq_lote_pgto_p;

	-- para cada conta do pagamento de producao medica

	for r_03_w in c03(nr_seq_lote_pgto_p, nr_seq_protocolo_p, nr_seq_prestador_p) loop

		vl_processado_w := r_03_w.vl_processado;
		vl_liberado_w := r_03_w.vl_liberado;
		vl_glosa_w := r_03_w.vl_glosa;

		-- se nao for recurso de glosa

		if (ie_tipo_conta_p = 'C') then
			-- busca os dados da conta

			select 	max(pc.nr_guia_tiss_prestador),
				max(pc.nr_guia_tiss_operadora),
				max(pc.cd_senha)
			into STRICT 	nr_guia_tiss_prestador_w,
				nr_guia_tiss_operadora_w,
				cd_senha_w
			from 	pls_conta pc
			where 	pc.nr_sequencia = r_03_w.nr_seq_conta;
		else
			-- busca os dados da conta de recurso de glosa

			select 	max(pc.nr_guia_tiss_prestador),
				max(pc.nr_guia_tiss_operadora),
				max(pr.cd_senha_rec)
			into STRICT 	nr_guia_tiss_prestador_w,
				nr_guia_tiss_operadora_w,
				cd_senha_w
			from 	pls_conta pc,
				pls_rec_glosa_conta pr
			where 	pc.nr_sequencia = r_03_w.nr_seq_conta
			and 	pr.nr_seq_conta = pc.nr_sequencia;
		end if;

		insert into pls_rel_pprest_prot_guia( 	nr_sequencia,				nr_seq_prest_prot,
							nr_guia_tiss_prestador,			nr_guia_tiss_operadora,
							cd_senha,				ie_tipo_pagamento,
							vl_processado,				vl_liberado,
							vl_glosa,				nr_seq_pagina,
							dt_atualizacao,				nm_usuario)
		values (				nextval('pls_rel_pprest_prot_guia_seq'),	nr_seq_prest_prot_p,
							nr_guia_tiss_prestador_w,		nr_guia_tiss_operadora_w,
							cd_senha_w,				ie_tipo_pagamento_w,
							vl_processado_w,			vl_liberado_w,
							vl_glosa_w,				nr_seq_pagina_p,
							clock_timestamp(),				nm_usuario_p);
	end loop;
end if;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_demonstrativo_pgto_pck.gerar_protocolo_guias ( nr_seq_lote_pgto_p pls_conta_medica_resumo.nr_seq_lote_pgto%type, nr_seq_protocolo_p pls_conta_medica_resumo.nr_seq_protocolo%type, nr_seq_prestador_p pls_prestador.nr_sequencia%type, nr_seq_prest_prot_p pls_rel_pprest_prot_guia.nr_seq_prest_prot%type, ie_tipo_conta_p text, ie_funcao_pagamento_p text, nr_seq_versao_rel_p pls_rel_pprest_versao.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, nr_seq_pagina_p pls_rel_pprest_prot_guia.nr_seq_pagina%type) FROM PUBLIC;
