-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


---------------------------------------------------------------
--- controlar o processo de valorizacao mensal do estoque, valoriza apenas um material
---------------------------------------------------------------
CREATE OR REPLACE PROCEDURE val_estoque_media_ponderada.val_prod_mat ( dt_mesano_referencia_p timestamp, cd_estabelecimento_p bigint, cd_material_p bigint, nm_usuario_p text) AS $body$
DECLARE


/*NÃ£o pode ter commit de jeito nenhum, chama no atualizar_nota_fiscal*/

cd_material_w			bigint;
ie_status_valorizacao_w		varchar(01);
dt_atualizacao_w			timestamp			:= clock_timestamp();
vl_custo_medio_w			double precision		:= 0;
vl_estoque_w			double precision		:= 0;
qt_estoque_w			double precision		:= 0;
cd_operacao_producao_w		integer		:= 0;
cd_operacao_baixa_w		integer		:= 0;
nr_movimento_estoque_w		bigint		:= 0;
ie_val_diaria_mensal_w		varchar(15);
ie_existe_w			varchar(1);
dt_mesano_vigente_w		timestamp;


BEGIN
select	cd_material_estoque
into STRICT	cd_material_w
from	material
where	cd_material = cd_material_p;

dt_mesano_vigente_w := dt_mesano_referencia_p;

if (coalesce(dt_mesano_vigente_w::text, '') = '') then
	select	max(dt_mesano_vigente)
	into STRICT	dt_mesano_vigente_w
	from	parametro_estoque
	where	cd_estabelecimento = cd_estabelecimento_p;
end if;

select	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
into STRICT	ie_existe_w
from	saldo_estoque
where	dt_mesano_referencia = dt_mesano_vigente_w
and	cd_estabelecimento = cd_estabelecimento_p
and	cd_material = cd_material_w;

if (ie_existe_w = 'S') then
	begin
	select	cd_oper_producao,
		coalesce(ie_val_diaria_mensal,'M')
	into STRICT	cd_operacao_producao_w,
		ie_val_diaria_mensal_w
	from	parametro_estoque
	where	cd_estabelecimento = cd_estabelecimento_p;

	delete  /*+index (a salescm_i1) */	from	saldo_estoque_cm_diario
	where	cd_estabelecimento	= cd_estabelecimento_p
	and	dt_mesano_referencia	= dt_mesano_vigente_w
	and	cd_material 		= cd_material_w;


	select	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
	into STRICT	ie_existe_w
	from	movimento_estoque b
	where	b.cd_estabelecimento	= cd_estabelecimento_p
	and	b.dt_mesano_referencia	= dt_mesano_vigente_w
	and	b.cd_operacao_estoque	= cd_operacao_producao_w
	and	b.cd_material_estoque	= cd_material_w;

	if (ie_existe_w = 'S') then
		begin
		update	saldo_estoque a
		set	ie_status_valorizacao   	= 'P'
		where	a.cd_estabelecimento    	= cd_estabelecimento_p
		and	a.dt_mesano_referencia  	= dt_mesano_vigente_w
		and	a.cd_material 		= cd_material_w;


		CALL val_estoque_media_ponderada.val_custo_producao(cd_material_w, cd_estabelecimento_p, dt_mesano_vigente_w, nm_usuario_p);
		end;
	else
		update	saldo_estoque a
		set	ie_status_valorizacao   	= 'I'
		where	a.cd_estabelecimento    	= cd_estabelecimento_p
		and	a.dt_mesano_referencia  	= dt_mesano_vigente_w
		and	a.cd_material 		= cd_material_w;
	end if;


	SELECT * FROM val_estoque_media_ponderada.val_valorizar_movto(cd_material_w, cd_estabelecimento_p, dt_mesano_vigente_w, nm_usuario_p, nr_movimento_estoque_w, qt_estoque_w, vl_estoque_w, vl_custo_medio_w) INTO STRICT nr_movimento_estoque_w, qt_estoque_w, vl_estoque_w, vl_custo_medio_w;
	CALL val_estoque_media_ponderada.val_saldo(cd_material_w, cd_estabelecimento_p, dt_mesano_vigente_w, qt_estoque_w, vl_estoque_w, vl_custo_medio_w, nm_usuario_p);
	CALL val_estoque_media_ponderada.val_dif_saldo(cd_material_w, cd_estabelecimento_p, dt_mesano_vigente_w, nr_movimento_estoque_w);
	end;
end if;
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE val_estoque_media_ponderada.val_prod_mat ( dt_mesano_referencia_p timestamp, cd_estabelecimento_p bigint, cd_material_p bigint, nm_usuario_p text) FROM PUBLIC;
