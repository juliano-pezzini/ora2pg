-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE itech_pck.itech_common_header ( cd_classif_p text, cd_tele_class_p text, nr_prescricao_p bigint, nr_atendimento_p bigint, nr_seq_interno_p bigint, nr_order_unit_p text default null) AS $body$
DECLARE

    sender_system_code_w  varchar(2) := 'AB';
    receiver_system_code_w  varchar(2) := 'BI';
    number_of_items_w varchar(10) := '00000001';
	nr_controle_lab_w varchar(20);
    cd_pessoa_fisica_w  pessoa_fisica.cd_pessoa_fisica%type;
    cd_department_med_w cpoe_order_unit.cd_departamento_med%type;
    ds_department_med_w varchar(100);
    nr_seq_proc_cpoe_w  prescr_procedimento.nr_seq_proc_cpoe%type;
    nr_seq_cpoe_order_unit_w cpoe_procedimento.nr_seq_cpoe_order_unit%type;

  c04 CURSOR FOR
    SELECT cd_classif_p processing_classification,
      coalesce(c.dt_liberacao, clock_timestamp()) date_of_processing,
      coalesce(c.dt_liberacao, clock_timestamp()) time_of_processing,
      ' ' pt_id,
      ' ' date_of_occurence,
      ' ' seq_number,
      ' ' ws_number,
      ' ' index_classification,
      ' ' xx_classification,
      ' ' xx_type,
      ' ' xx_seq,
      coalesce(nr_order_unit_p,nr_controle_lab_w) nr_prescricao,
      nr_seq_interno_p nr_sequencia,
      CASE WHEN a.type_encounter_id=8 THEN 1 END  patient_classification,
      cd_department_med_w consult_department_code,
      coalesce(ds_department_med_w,' ') consult_department_name,
      a.department_id ward_code,
      a.department_name ward_name,
      a.encounter_doctor_id doctor_id,
      a.encounter_doctor_given_name doctor_name_in_kana,
      a.encounter_doctor_given_name doctor_name,
      a.department_admit_date request_date,
      b.dt_cancelamento cancellation_date,
      CASE WHEN coalesce(b.dt_cancelamento::text, '') = '' THEN  ' '  ELSE '0' END  cancellation_reason,
      d.medical_record_id,
      d.patient_sex,
      d.date_of_birth,
      CASE WHEN a.type_encounter_id=8 THEN 0 END  type_encounter_id,
      coalesce(a.external_dep_code, 0) external_dep_code,
      coalesce(a.room_name, 0) room_name
    from bft_encounter_v a,
      prescr_medica c,
      prescr_procedimento b,
      bft_patient_v d
    where d.patient_id   = a.patient_id
    and a.encounter_id   = nr_atendimento_p
    and c.nr_prescricao  = nr_prescricao_p
    and b.nr_seq_interno = nr_seq_interno_p  LIMIT 1;

  
BEGIN
    select nr_controle_lab,
           cd_pessoa_fisica
    into STRICT   nr_controle_lab_w,
           cd_pessoa_fisica_w
    from   prescr_medica
    where  nr_prescricao = nr_prescricao_p;
	
    select nr_seq_proc_cpoe
    into STRICT   nr_seq_proc_cpoe_w
    from   prescr_procedimento
    where  nr_prescricao = nr_prescricao_p
    and    nr_seq_interno = nr_seq_interno_p;

    select nr_seq_cpoe_order_unit
    into STRICT   nr_seq_cpoe_order_unit_w
    from   cpoe_procedimento
    where  nr_sequencia = nr_seq_proc_cpoe_w;

    select cd_departamento_med,
           obter_nome_departamento_medico(cd_departamento_med)
    into STRICT   cd_department_med_w,
           ds_department_med_w
    from   cpoe_order_unit
    where  nr_sequencia = nr_seq_cpoe_order_unit_w;
  -- Append common header result
    PERFORM set_config('itech_pck.ds_line_w', null, false);
    CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL itech_pck.append_text(cd_tele_class_p,2,'L');
    CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL itech_pck.append_text(to_char(clock_timestamp(),'YYYYMMDD'),8,'L');
    CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL itech_pck.append_text(to_char(clock_timestamp(),'HH24MISS'),6,'L');
    CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL itech_pck.append_text(sender_system_code_w,2,'L');
    CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL itech_pck.append_text(receiver_system_code_w,2,'L');
    CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL itech_pck.append_text(number_of_items_w,8,'L');
  --Append intersystem common header result
  for r_c04 in c04
  loop
    begin
      CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL itech_pck.append_text(r_c04.processing_classification,1,'L');
      CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL itech_pck.append_text(to_char(r_c04.date_of_processing,'YYYYMMDD'),8,'L');
      CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL itech_pck.append_text(to_char(r_c04.time_of_processing,'HH24MISS'),6,'L');
      CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL itech_pck.append_text(r_c04.pt_id,10,'L','0');
      CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL itech_pck.append_text(r_c04.date_of_occurence,8,'L');
      CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL itech_pck.append_text(r_c04.seq_number,6,'L');
      CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL itech_pck.append_text(r_c04.ws_number,4,'L');
      CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL itech_pck.append_text(r_c04.index_classification,1,'L');
      CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL itech_pck.append_text(r_c04.xx_classification,2,'L');
      CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL itech_pck.append_text(r_c04.xx_type,3,'L');
      CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL itech_pck.append_text(r_c04.xx_seq,5,'L');
      CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL itech_pck.append_text(r_c04.nr_prescricao,14,'L','0');
      CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL itech_pck.append_text(r_c04.nr_sequencia,10,'L','0');
      CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL itech_pck.append_text(r_c04.patient_classification,1,'L');
      CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL itech_pck.append_text(r_c04.consult_department_code,3,'L','0');
      CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL itech_pck.append_text(r_c04.consult_department_name,20,'R',' ');
      CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL itech_pck.append_text(r_c04.ward_code,3,'L','0');
      CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL itech_pck.append_text(r_c04.ward_name,20,'R', ' ');
      CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL itech_pck.append_text(r_c04.doctor_id,10,'L','0');
      CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL itech_pck.append_text(r_c04.doctor_name_in_kana,20,'R', ' ');
      CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL itech_pck.append_text(r_c04.doctor_name,20,'R', ' ');
      CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL itech_pck.append_text(to_char(r_c04.request_date,'YYYYMMDD'),8,'L');
      CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL itech_pck.append_text(to_char(r_c04.cancellation_date,'YYYYMMDD'),8,'L');
      CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL itech_pck.append_text(r_c04.cancellation_reason,1,'R', ' ');
      CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL itech_pck.append_text(r_c04.medical_record_id,10,'L', '0');

      CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL itech_pck.append_text(itech_pck.get_patient_name(cd_pessoa_fisica_w, 'translated'),23,'R',' ');
      CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL itech_pck.append_text(itech_pck.get_patient_name(cd_pessoa_fisica_w, 'main'),20,'R',' ');

      CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL itech_pck.append_text(r_c04.patient_sex,1,'L');
      CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL itech_pck.append_text(to_char(r_c04.date_of_birth,'YYYYMMDD'),8,'L');
      CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL itech_pck.append_text(r_c04.type_encounter_id,1,'L');
      CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL itech_pck.append_text(r_c04.external_dep_code,4,'L','0');
      CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL itech_pck.append_text(r_c04.room_name,20,'R',' ');
      CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL itech_pck.append_text(number_of_items_w,8,'L');
    end;
  end loop;
  END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE itech_pck.itech_common_header ( cd_classif_p text, cd_tele_class_p text, nr_prescricao_p bigint, nr_atendimento_p bigint, nr_seq_interno_p bigint, nr_order_unit_p text default null) FROM PUBLIC;
