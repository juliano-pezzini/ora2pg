-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE itech_pck.update_blood_results ( ds_result_p text, cd_test_item_p text, cd_pessoa_fisica_p text, dt_coleta_p timestamp) AS $body$
DECLARE


	ds_result_w varchar(4000) := ds_result_p;
	cd_test_item_w varchar(100);
    is_record_exist_w varchar(1);

	c01 CURSOR FOR
	SELECT cd_desc_classif,
       cd_desc_val_1,
       cd_desc_val_2,
       cd_desc_val_3,
       cd_desc_val_4,
       cd_desc_val_5,
       cd_desc_val_6,
       cd_desc_val_7,
       cd_desc_val_8,
       cd_desc_val_9,
       cd_desc_val_10
	from jpn_lab_test_master where cd_test_item = cd_test_item_w;
	
BEGIN
	cd_test_item_w := cd_test_item_p;
	for r_c01 in c01 loop
	begin
		if (r_c01.cd_desc_classif like 'A%') then
			if length(r_c01.cd_desc_classif ) = 1 then
				if ds_result_w in (r_c01.cd_desc_val_1, r_c01.cd_desc_val_2, r_c01.cd_desc_val_3, r_c01.cd_desc_val_4, r_c01.cd_desc_val_5, r_c01.cd_desc_val_6, r_c01.cd_desc_val_7, r_c01.cd_desc_val_8, r_c01.cd_desc_val_9, r_c01.cd_desc_val_10) then
					select  CASE WHEN count(*)=0 THEN  'N'  ELSE 'S' END
					into STRICT    is_record_exist_w
					from    jpn_irregular_antibody
					where   ie_blood_type = 'A'
					and     ie_situacao = 'A'
					and     (dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
					and     coalesce(dt_inativacao::text, '') = ''
					and     dt_test < dt_coleta_p;

					if is_record_exist_w = 'N' then
						insert into jpn_irregular_antibody(nr_sequencia,
														   dt_atualizacao,
														   dt_test,
														   nm_usuario,
														   ie_situacao,
														   dt_liberacao,
														   ie_blood_type,
														   ds_blood_type,
														   cd_pessoa_fisica)
												   values (nextval('jpn_irregular_antibody_seq'),
														   clock_timestamp(),
														   dt_coleta_p,
														   'ITECH',
														   'A',
														   clock_timestamp(),
														   'A',
														   null,
														   cd_pessoa_fisica_p);
					elsif is_record_exist_w = 'S' then
						update jpn_irregular_antibody
						set    dt_inativacao = clock_timestamp(),
							   ie_situacao = 'I'
						where   cd_pessoa_fisica = cd_pessoa_fisica_p
						and     ie_blood_type = 'A'
						and     (dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
						and     coalesce(dt_inativacao::text, '') = '';
						insert into jpn_irregular_antibody(nr_sequencia,
														   dt_atualizacao,
														   dt_test,
														   nm_usuario,
														   ie_situacao,
														   dt_liberacao,
														   ie_blood_type,
														   ds_blood_type,
														   cd_pessoa_fisica)
												   values (nextval('jpn_irregular_antibody_seq'),
														   clock_timestamp(),
														   dt_coleta_p,
														   'ITECH',
														   'A',
														   clock_timestamp(),
														   'A',
														   null,
														   cd_pessoa_fisica_p);
					end if;
            end if;

			elsif length(r_c01.cd_desc_classif) > 1 then
				if ds_result_w in (r_c01.cd_desc_val_1, r_c01.cd_desc_val_2, r_c01.cd_desc_val_3, r_c01.cd_desc_val_4, r_c01.cd_desc_val_5, r_c01.cd_desc_val_6, r_c01.cd_desc_val_7, r_c01.cd_desc_val_8, r_c01.cd_desc_val_9, r_c01.cd_desc_val_10) then
					select  CASE WHEN count(*)=0 THEN  'N'  ELSE 'S' END
					into STRICT    is_record_exist_w
					from    jpn_irregular_antibody
					where   ie_blood_type = 'A'
					and     ds_blood_type = ds_result_w
					and     ie_situacao = 'A'
					and     (dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
					and     coalesce(dt_inativacao::text, '') = ''
					and     dt_test < dt_coleta_p;

					if is_record_exist_w = 'N' then
						insert into jpn_irregular_antibody(nr_sequencia,
													       dt_atualizacao,
														   dt_test,
													       nm_usuario,
													       ie_situacao,
														   dt_liberacao,
													       ie_blood_type,
														   ds_blood_type,
														   cd_pessoa_fisica)
												   values (nextval('jpn_irregular_antibody_seq'),
														   clock_timestamp(),
														   dt_coleta_p,
														   'ITECH',
														   'A',
														   clock_timestamp(),
														   'A',
														   ds_result_w,
														   cd_pessoa_fisica_p);
					elsif is_record_exist_w = 'S' then
						update jpn_irregular_antibody
						set    dt_inativacao = clock_timestamp(),
							   ie_situacao = 'I'
						where  cd_pessoa_fisica = cd_pessoa_fisica_p
						and    ie_blood_type = 'A'
						and    ds_blood_type = ds_result_w
						and    (dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
						and    coalesce(dt_inativacao::text, '') = '';
						insert into jpn_irregular_antibody(nr_sequencia,
													       dt_atualizacao,
														   dt_test,
													       nm_usuario,
													       ie_situacao,
														   dt_liberacao,
													       ie_blood_type,
														   ds_blood_type,
														   cd_pessoa_fisica)
												   values (nextval('jpn_irregular_antibody_seq'),
														   clock_timestamp(),
														   dt_coleta_p,
														   'ITECH',
														   'A',
														   clock_timestamp(),
														   'A',
														   ds_result_w,
														   cd_pessoa_fisica_p);						
					end if;
			end if;
		end if;

		elsif (r_c01.cd_desc_classif like 'B%') then
			if length(r_c01.cd_desc_classif ) = 1 then
				if ds_result_w in (r_c01.cd_desc_val_1, r_c01.cd_desc_val_2, r_c01.cd_desc_val_3, r_c01.cd_desc_val_4, r_c01.cd_desc_val_5, r_c01.cd_desc_val_6, r_c01.cd_desc_val_7, r_c01.cd_desc_val_8, r_c01.cd_desc_val_9, r_c01.cd_desc_val_10) then
					select  CASE WHEN count(*)=0 THEN  'N'  ELSE 'S' END
					into STRICT    is_record_exist_w
					from    jpn_irregular_antibody
					where   ie_blood_type = 'B'
					and     ie_situacao = 'A'
					and     (dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
					and     coalesce(dt_inativacao::text, '') = ''
					and     dt_test < dt_coleta_p;

					if is_record_exist_w = 'N' then
						insert into jpn_irregular_antibody(nr_sequencia,
													       dt_atualizacao,
														   dt_test,
														   nm_usuario,
														   ie_situacao,
														   dt_liberacao,
													       ie_blood_type,
														   ds_blood_type,
														   cd_pessoa_fisica)
													values (nextval('jpn_irregular_antibody_seq'),
														   clock_timestamp(),
														   dt_coleta_p,
														   'ITECH',
														   'A',
														   clock_timestamp(),
														   'B',
														   null,
													       cd_pessoa_fisica_p);
					elsif is_record_exist_w = 'S' then
						update jpn_irregular_antibody
						set    dt_inativacao = clock_timestamp(),
							   ie_situacao = 'I'
						where  cd_pessoa_fisica = cd_pessoa_fisica_p
						and    ie_blood_type = 'B'
						and    (dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
						and    coalesce(dt_inativacao::text, '') = '';
						insert into jpn_irregular_antibody(nr_sequencia,
													       dt_atualizacao,
														   dt_test,
														   nm_usuario,
														   ie_situacao,
														   dt_liberacao,
													       ie_blood_type,
														   ds_blood_type,
														   cd_pessoa_fisica)
													values (nextval('jpn_irregular_antibody_seq'),
														   clock_timestamp(),
														   dt_coleta_p,
														   'ITECH',
														   'A',
														   clock_timestamp(),
														   'B',
														   null,
													       cd_pessoa_fisica_p);
					end if;
				end if;

			elsif length(r_c01.cd_desc_classif) > 1 then
				if ds_result_w in (r_c01.cd_desc_val_1, r_c01.cd_desc_val_2, r_c01.cd_desc_val_3, r_c01.cd_desc_val_4, r_c01.cd_desc_val_5, r_c01.cd_desc_val_6, r_c01.cd_desc_val_7, r_c01.cd_desc_val_8, r_c01.cd_desc_val_9, r_c01.cd_desc_val_10) then
					select  CASE WHEN count(*)=0 THEN  'N'  ELSE 'S' END
					into STRICT    is_record_exist_w
					from    jpn_irregular_antibody
					where   ie_blood_type = 'B'
					and     ds_blood_type = ds_result_w
					and     ie_situacao = 'A'
					and     (dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
					and     coalesce(dt_inativacao::text, '') = ''
					and     dt_test < dt_coleta_p;

					if is_record_exist_w = 'N' then
						insert into jpn_irregular_antibody(nr_sequencia,
													       dt_atualizacao,
												           dt_test,
												           nm_usuario,
														   ie_situacao,
														   dt_liberacao,
                                                           ie_blood_type,
                                                           ds_blood_type,
                                                           cd_pessoa_fisica)
                                                    values (nextval('jpn_irregular_antibody_seq'),
														   clock_timestamp(),
                                                           dt_coleta_p,
                                                           'ITECH',
                                                           'A',
                                                           clock_timestamp(),
                                                           'B',
                                                           ds_result_w,
                                                           cd_pessoa_fisica_p);
					elsif is_record_exist_w = 'S' then
						update jpn_irregular_antibody
						set    dt_inativacao = clock_timestamp(),
							   ie_situacao = 'I'
						where  cd_pessoa_fisica = cd_pessoa_fisica_p
						and    ie_blood_type = 'B'
						and    ds_blood_type = ds_result_w
						and    (dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
					    and    coalesce(dt_inativacao::text, '') = '';
						insert into jpn_irregular_antibody(nr_sequencia,
													       dt_atualizacao,
												           dt_test,
												           nm_usuario,
														   ie_situacao,
														   dt_liberacao,
                                                           ie_blood_type,
                                                           ds_blood_type,
                                                           cd_pessoa_fisica)
                                                    values (nextval('jpn_irregular_antibody_seq'),
														   clock_timestamp(),
                                                           dt_coleta_p,
                                                           'ITECH',
                                                           'A',
                                                           clock_timestamp(),
                                                           'B',
                                                           ds_result_w,
                                                           cd_pessoa_fisica_p);					
					end if;
				end if;
			end if;
		elsif (r_c01.cd_desc_classif like 'O%') then
			if length(r_c01.cd_desc_classif ) = 1 then
				if ds_result_w in (r_c01.cd_desc_val_1, r_c01.cd_desc_val_2, r_c01.cd_desc_val_3, r_c01.cd_desc_val_4, r_c01.cd_desc_val_5, r_c01.cd_desc_val_6, r_c01.cd_desc_val_7, r_c01.cd_desc_val_8, r_c01.cd_desc_val_9, r_c01.cd_desc_val_10) then
					select  CASE WHEN count(*)=0 THEN  'N'  ELSE 'S' END
					into STRICT    is_record_exist_w
					from    jpn_irregular_antibody
					where   ie_blood_type = 'O'
					and     ie_situacao = 'A'
					and     (dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
					and     coalesce(dt_inativacao::text, '') = ''
					and     dt_test < dt_coleta_p;

					if is_record_exist_w = 'N' then
						insert into jpn_irregular_antibody(nr_sequencia,
													       dt_atualizacao,
														   dt_test,
														   nm_usuario,
													       ie_situacao,
													       dt_liberacao,
												           ie_blood_type,
														   ds_blood_type,
														   cd_pessoa_fisica)
													values (nextval('jpn_irregular_antibody_seq'),
														   clock_timestamp(),
														   dt_coleta_p,
														   'ITECH',
														   'A',
														   clock_timestamp(),
														   'O',
														   null,
													       cd_pessoa_fisica_p);
					elsif is_record_exist_w = 'S' then
						update jpn_irregular_antibody
						set    dt_inativacao = clock_timestamp(),
							   ie_situacao = 'I'
					   where   cd_pessoa_fisica = cd_pessoa_fisica_p
                       and     ie_blood_type = 'O'
                       and     (dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
                       and     coalesce(dt_inativacao::text, '') = '';
						insert into jpn_irregular_antibody(nr_sequencia,
													       dt_atualizacao,
														   dt_test,
														   nm_usuario,
													       ie_situacao,
													       dt_liberacao,
												           ie_blood_type,
														   ds_blood_type,
														   cd_pessoa_fisica)
													values (nextval('jpn_irregular_antibody_seq'),
														   clock_timestamp(),
														   dt_coleta_p,
														   'ITECH',
														   'A',
														   clock_timestamp(),
														   'O',
														   null,
													       cd_pessoa_fisica_p);
                    end if;
			end if;

			elsif length(r_c01.cd_desc_classif) > 1 then
				if ds_result_w in (r_c01.cd_desc_val_1, r_c01.cd_desc_val_2, r_c01.cd_desc_val_3, r_c01.cd_desc_val_4, r_c01.cd_desc_val_5, r_c01.cd_desc_val_6, r_c01.cd_desc_val_7, r_c01.cd_desc_val_8, r_c01.cd_desc_val_9, r_c01.cd_desc_val_10) then
					select  CASE WHEN count(*)=0 THEN  'N'  ELSE 'S' END
					into STRICT    is_record_exist_w
					from    jpn_irregular_antibody
					where   ie_blood_type = 'O'
					and     ds_blood_type = ds_result_w
					and     ie_situacao = 'A'
					and     (dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
					and     coalesce(dt_inativacao::text, '') = ''
					and     dt_test < dt_coleta_p;

					if is_record_exist_w = 'N' then
						insert into jpn_irregular_antibody(nr_sequencia,
														   dt_atualizacao,
                                                           dt_test,
                                                           nm_usuario,
                                                           ie_situacao,
                                                           dt_liberacao,
                                                           ie_blood_type,
                                                           ds_blood_type,
                                                           cd_pessoa_fisica)
												    values (nextval('jpn_irregular_antibody_seq'),
														   clock_timestamp(),
														   dt_coleta_p,
														   'ITECH',
														   'A',
														   clock_timestamp(),
														   'O',
														   ds_result_w,
														   cd_pessoa_fisica_p);
					elsif is_record_exist_w = 'S' then
						update jpn_irregular_antibody
						set    dt_inativacao = clock_timestamp(),
							   ie_situacao = 'I'
						where  cd_pessoa_fisica = cd_pessoa_fisica_p
						and    ie_blood_type = 'O'
						and    ds_blood_type = ds_result_w
						and    (dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
						and    coalesce(dt_inativacao::text, '') = '';
						insert into jpn_irregular_antibody(nr_sequencia,
														   dt_atualizacao,
                                                           dt_test,
                                                           nm_usuario,
                                                           ie_situacao,
                                                           dt_liberacao,
                                                           ie_blood_type,
                                                           ds_blood_type,
                                                           cd_pessoa_fisica)
												    values (nextval('jpn_irregular_antibody_seq'),
														   clock_timestamp(),
														   dt_coleta_p,
														   'ITECH',
														   'A',
														   clock_timestamp(),
														   'O',
														   ds_result_w,
														   cd_pessoa_fisica_p);
					end if;
				end if;
			end if;
		elsif (r_c01.cd_desc_classif like 'C%') then
			if length(r_c01.cd_desc_classif ) = 1 then
				if ds_result_w in (r_c01.cd_desc_val_1, r_c01.cd_desc_val_2, r_c01.cd_desc_val_3, r_c01.cd_desc_val_4, r_c01.cd_desc_val_5, r_c01.cd_desc_val_6, r_c01.cd_desc_val_7, r_c01.cd_desc_val_8, r_c01.cd_desc_val_9, r_c01.cd_desc_val_10) then
					select  CASE WHEN count(*)=0 THEN  'N'  ELSE 'S' END
					into STRICT    is_record_exist_w
					from    jpn_irregular_antibody
					where   ie_blood_type = 'AB'
					and     ie_situacao = 'A'
					and     (dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
					and     coalesce(dt_inativacao::text, '') = ''
					and     dt_test < dt_coleta_p;

					if is_record_exist_w = 'N' then
						insert into jpn_irregular_antibody(nr_sequencia,
													       dt_atualizacao,
														   dt_test,
														   nm_usuario,
														   ie_situacao,
													       dt_liberacao,
														   ie_blood_type,
												           ds_blood_type,
													       cd_pessoa_fisica)
													values (nextval('jpn_irregular_antibody_seq'),
														   clock_timestamp(),
														   dt_coleta_p,
														   'ITECH',
														   'A',
													       clock_timestamp(),
														   'AB',
														   null,
													       cd_pessoa_fisica_p);
					elsif is_record_exist_w = 'S' then
						update jpn_irregular_antibody
						set    dt_inativacao = clock_timestamp(),
							   ie_situacao = 'I'
                       where   cd_pessoa_fisica = cd_pessoa_fisica_p
                       and     ie_blood_type = 'AB'
                       and     (dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
                       and     coalesce(dt_inativacao::text, '') = '';
					   insert into jpn_irregular_antibody(nr_sequencia,
													       dt_atualizacao,
														   dt_test,
														   nm_usuario,
														   ie_situacao,
													       dt_liberacao,
														   ie_blood_type,
												           ds_blood_type,
													       cd_pessoa_fisica)
													values (nextval('jpn_irregular_antibody_seq'),
														   clock_timestamp(),
														   dt_coleta_p,
														   'ITECH',
														   'A',
													       clock_timestamp(),
														   'AB',
														   null,
													       cd_pessoa_fisica_p);
                    end if;
			end if;

			elsif length(r_c01.cd_desc_classif) > 1 then
				if ds_result_w in (r_c01.cd_desc_val_1, r_c01.cd_desc_val_2, r_c01.cd_desc_val_3, r_c01.cd_desc_val_4, r_c01.cd_desc_val_5, r_c01.cd_desc_val_6, r_c01.cd_desc_val_7, r_c01.cd_desc_val_8, r_c01.cd_desc_val_9, r_c01.cd_desc_val_10) then
					select  CASE WHEN count(*)=0 THEN  'N'  ELSE 'S' END
					into STRICT    is_record_exist_w
					from    jpn_irregular_antibody
					where   ie_blood_type = 'AB'
					and     ds_blood_type = ds_result_w
					and     ie_situacao = 'A'
					and     (dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
					and     coalesce(dt_inativacao::text, '') = ''
					and     dt_test < dt_coleta_p;

					if is_record_exist_w = 'N' then
						insert into jpn_irregular_antibody(nr_sequencia,
													       dt_atualizacao,
												           dt_test,
                                                           nm_usuario,
                                                           ie_situacao,
                                                           dt_liberacao,
                                                           ie_blood_type,
                                                           ds_blood_type,
                                                           cd_pessoa_fisica)
												    values (nextval('jpn_irregular_antibody_seq'),
													       clock_timestamp(),
                                                           dt_coleta_p,
                                                           'ITECH',
                                                           'A',
                                                           clock_timestamp(),
                                                           'AB',
                                                           ds_result_w,
                                                           cd_pessoa_fisica_p);
					elsif is_record_exist_w = 'S' then
						update jpn_irregular_antibody
						set    dt_inativacao = clock_timestamp(),
							   ie_situacao = 'I'
						where  cd_pessoa_fisica = cd_pessoa_fisica_p
						and    ie_blood_type = 'AB'
						and    ds_blood_type = ds_result_w
						and    (dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
						and    coalesce(dt_inativacao::text, '') = '';
						insert into jpn_irregular_antibody(nr_sequencia,
													       dt_atualizacao,
												           dt_test,
                                                           nm_usuario,
                                                           ie_situacao,
                                                           dt_liberacao,
                                                           ie_blood_type,
                                                           ds_blood_type,
                                                           cd_pessoa_fisica)
												    values (nextval('jpn_irregular_antibody_seq'),
													       clock_timestamp(),
                                                           dt_coleta_p,
                                                           'ITECH',
                                                           'A',
                                                           clock_timestamp(),
                                                           'AB',
                                                           ds_result_w,
                                                           cd_pessoa_fisica_p);
					end if;
				end if;
			end if;
		elsif (r_c01.cd_desc_classif like 'H%') then
			if ds_result_w in (r_c01.cd_desc_val_1, r_c01.cd_desc_val_2, r_c01.cd_desc_val_3, r_c01.cd_desc_val_4, r_c01.cd_desc_val_5, r_c01.cd_desc_val_6, r_c01.cd_desc_val_7, r_c01.cd_desc_val_8, r_c01.cd_desc_val_9, r_c01.cd_desc_val_10) then
				insert into jpn_irregular_antibody(nr_sequencia,
											       dt_atualizacao,
											       dt_test,
											       nm_usuario,
                                                   ie_situacao,
                                                   dt_liberacao,
                                                   ds_blood_type,
                                                   cd_pessoa_fisica,
                                                   ds_justificativa)
											values (nextval('jpn_irregular_antibody_seq'),
											       clock_timestamp(),
                                                   dt_coleta_p,
											       'ITECH',
											       'A',
											       clock_timestamp(),
											       ds_result_w,
											       cd_pessoa_fisica_p,
											      'The interface has sent H type');
			end if;									
		elsif (r_c01.cd_desc_classif like 'R%') then
			if length(r_c01.cd_desc_classif ) = 1 then
				if ds_result_w in (r_c01.cd_desc_val_1, r_c01.cd_desc_val_2) then
					ds_result_w := '-';
				elsif ds_result_w in (r_c01.cd_desc_val_3, r_c01.cd_desc_val_4) then
					ds_result_w := '+';
				end if;
				select  CASE WHEN count(*)=0 THEN  'N'  ELSE 'S' END
				into STRICT    is_record_exist_w
				from    jpn_irregular_antibody
				where   ie_rh_factor = ds_result_w
				and     ie_situacao = 'A'
				and     (dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
				and     coalesce(dt_inativacao::text, '') = ''
				and     dt_test < dt_coleta_p;

				if is_record_exist_w = 'N' then
					insert into jpn_irregular_antibody(nr_sequencia,
												       dt_atualizacao,
													   dt_test,
													   nm_usuario,
												       ie_situacao,
													   dt_liberacao,
												       ie_rh_factor,
													   cd_pessoa_fisica)
												values (nextval('jpn_irregular_antibody_seq'),
													   clock_timestamp(),
													   dt_coleta_p,
													   'ITECH',
													   'A',
													   clock_timestamp(),
													   ds_result_w,
													   cd_pessoa_fisica_p);
				elsif is_record_exist_w = 'S' then
					update jpn_irregular_antibody
					set    dt_inativacao = clock_timestamp(),
                           ie_situacao = 'I'
                    where  cd_pessoa_fisica = cd_pessoa_fisica_p
                    and    ie_rh_factor = ds_result_w
                    and    (dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
                    and    coalesce(dt_inativacao::text, '') = '';
					insert into jpn_irregular_antibody(nr_sequencia,
												       dt_atualizacao,
													   dt_test,
													   nm_usuario,
												       ie_situacao,
													   dt_liberacao,
												       ie_rh_factor,
													   cd_pessoa_fisica)
												values (nextval('jpn_irregular_antibody_seq'),
													   clock_timestamp(),
													   dt_coleta_p,
													   'ITECH',
													   'A',
													   clock_timestamp(),
													   ds_result_w,
													   cd_pessoa_fisica_p);
				end if;
			elsif length(r_c01.cd_desc_classif) > 1 then
				if ds_result_w in (r_c01.cd_desc_val_1, r_c01.cd_desc_val_2, r_c01.cd_desc_val_3, r_c01.cd_desc_val_4, r_c01.cd_desc_val_5, r_c01.cd_desc_val_6, r_c01.cd_desc_val_7, r_c01.cd_desc_val_8, r_c01.cd_desc_val_9, r_c01.cd_desc_val_10) then
					select  CASE WHEN count(*)=0 THEN  'N'  ELSE 'S' END
					into STRICT    is_record_exist_w
					from    jpn_irregular_antibody
					where   ie_rh_factor = ds_result_w
					and     ie_situacao = 'A'
					and     (dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
					and     coalesce(dt_inativacao::text, '') = ''
					and     dt_test < dt_coleta_p;

					if is_record_exist_w = 'N' then
						insert into jpn_irregular_antibody(nr_sequencia,
													   dt_atualizacao,
													   dt_test,
                                                       nm_usuario,
                                                       ie_situacao,
                                                       dt_liberacao,
                                                       ie_rh_factor,
                                                       cd_pessoa_fisica)
												values (nextval('jpn_irregular_antibody_seq'),
													   clock_timestamp(),
                                                       dt_coleta_p,
                                                       'ITECH',
                                                       'A',
                                                       clock_timestamp(),
                                                       ds_result_w,
                                                       cd_pessoa_fisica_p);
					elsif is_record_exist_w = 'S' then
						update jpn_irregular_antibody
						set    dt_inativacao = clock_timestamp(),
								ie_situacao = 'I'
						where  cd_pessoa_fisica = cd_pessoa_fisica_p
						and    ie_rh_factor = ds_result_w
						and    (dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
						and    coalesce(dt_inativacao::text, '') = '';
						insert into jpn_irregular_antibody(nr_sequencia,
													   dt_atualizacao,
													   dt_test,
                                                       nm_usuario,
                                                       ie_situacao,
                                                       dt_liberacao,
                                                       ie_rh_factor,
                                                       cd_pessoa_fisica)
												values (nextval('jpn_irregular_antibody_seq'),
													   clock_timestamp(),
                                                       dt_coleta_p,
                                                       'ITECH',
                                                       'A',
                                                       clock_timestamp(),
                                                       ds_result_w,
                                                       cd_pessoa_fisica_p);
					end if;
				end if;
			end if;
		elsif (r_c01.cd_desc_classif like 'F') then
			if ds_result_w not in (r_c01.cd_desc_val_1, r_c01.cd_desc_val_2, r_c01.cd_desc_val_3, r_c01.cd_desc_val_4, r_c01.cd_desc_val_5, r_c01.cd_desc_val_6, r_c01.cd_desc_val_7, r_c01.cd_desc_val_8, r_c01.cd_desc_val_9, r_c01.cd_desc_val_10) then
				select  CASE WHEN count(*)=0 THEN  'N'  ELSE 'S' END
				into STRICT    is_record_exist_w
				from    jpn_irregular_antibody
				where   nm_antybody = ds_result_w
				and     ie_situacao = 'A'
				and     (dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
				and     coalesce(dt_inativacao::text, '') = ''
				and     dt_test < dt_coleta_p;

				if is_record_exist_w = 'N' then
					insert into jpn_irregular_antibody(nr_sequencia,
												       dt_atualizacao,
												       dt_test,
                                                       nm_usuario,
                                                       ie_situacao,
                                                       dt_liberacao,
                                                       nm_antybody,
                                                       cd_pessoa_fisica)
												values (nextval('jpn_irregular_antibody_seq'),
													   clock_timestamp(),
													   dt_coleta_p,
													   'ITECH',
													   'A',
													   clock_timestamp(),
													   ds_result_w,
												       cd_pessoa_fisica_p);
                elsif is_record_exist_w = 'S' then
					update jpn_irregular_antibody
					set    dt_inativacao = clock_timestamp(),
                           ie_situacao = 'I'
					where  cd_pessoa_fisica = cd_pessoa_fisica_p
					and    nm_antybody = ds_result_w
					and    (dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
					and    coalesce(dt_inativacao::text, '') = '';
					insert into jpn_irregular_antibody(nr_sequencia,
												       dt_atualizacao,
												       dt_test,
                                                       nm_usuario,
                                                       ie_situacao,
                                                       dt_liberacao,
                                                       nm_antybody,
                                                       cd_pessoa_fisica)
												values (nextval('jpn_irregular_antibody_seq'),
													   clock_timestamp(),
													   dt_coleta_p,
													   'ITECH',
													   'A',
													   clock_timestamp(),
													   ds_result_w,
												       cd_pessoa_fisica_p);
				end if;
			end if;
		end if;
    end;
    end loop;
    commit;
  END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE itech_pck.update_blood_results ( ds_result_p text, cd_test_item_p text, cd_pessoa_fisica_p text, dt_coleta_p timestamp) FROM PUBLIC;
