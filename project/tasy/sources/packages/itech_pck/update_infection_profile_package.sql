-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE itech_pck.update_infection_profile ( cd_test_item_p text, cd_profissional_p text, cd_pessoa_fisica_p text, ds_result_p text, dt_coleta_p timestamp) AS $body$
DECLARE

	cd_test_item_w varchar(10);
	cd_desc_classif_w varchar(10);
	ds_result_w    varchar(4000);
	ds_result_ww   varchar(4000);
	cd_comp1 varchar(100);
	cd_comp2 varchar(100);
	cd_comp3 varchar(100);
	cd_comp4 varchar(100);
	cd_comp5 varchar(100);
	cd_comp6 varchar(100);
	cd_comp7 varchar(100);
	cd_comp8 varchar(100);
	cd_comp9 varchar(100);
	cd_comp10 varchar(100);
	is_record_present_w varchar(1);
	is_doenca_present_w varchar(1);
	cd_upda_classif_w varchar(2);
	cd_pessoa_fisica_w varchar(10) := cd_pessoa_fisica_p;
	nr_doenca_seq_w  bigint;
	cd_profissional_w bigint := cd_profissional_p;
	cd_doenca_result_w bigint;
    nr_result_w bigint;
	infec_resul_seq_w bigint;
	
BEGIN
	cd_test_item_w := cd_test_item_p;
	select CASE WHEN count(*)=0 THEN  'N'  ELSE 'S' END
	into STRICT is_record_present_w
	from jpn_lab_test_master
	where cd_test_item = cd_test_item_w;

	if (is_record_present_w = 'S') then
		select cd_desc_classif,
			   cd_update_classif,
			   cd_desc_val_1,
			   cd_desc_val_2,
			   cd_desc_val_3,
			   cd_desc_val_4,
			   cd_desc_val_5,
               cd_desc_val_6,
               cd_desc_val_7,
               cd_desc_val_8,
               cd_desc_val_9,
               cd_desc_val_10
		into STRICT   cd_desc_classif_w,
			   cd_upda_classif_w,
               cd_comp1,
               cd_comp2,
               cd_comp3,
               cd_comp4,
               cd_comp5,
               cd_comp6,
               cd_comp7,
               cd_comp8,
               cd_comp9,
               cd_comp10
	    from   jpn_lab_test_master
        where  cd_test_item = cd_test_item_w;
	ds_result_w := ds_result_p;
	if (cd_desc_classif_w = '+') then
		if  ds_result_w in (cd_comp1, cd_comp2, cd_comp3, cd_comp4, cd_comp5, cd_comp6, cd_comp7, cd_comp8, cd_comp9, cd_comp10) then
			ds_result_ww := '(+)';
		else
			ds_result_ww := '(-)';
		end if;
	elsif (cd_desc_classif_w = '-') then
		if  ds_result_w in (cd_comp1, cd_comp2, cd_comp3, cd_comp4, cd_comp5, cd_comp6, cd_comp7, cd_comp8, cd_comp9, cd_comp10) then
			ds_result_ww := '(-)';
		else
			ds_result_ww := '(+)';
		end if;
	elsif (cd_desc_classif_w = '*') then
		if  ds_result_w in (cd_comp1, cd_comp2, cd_comp3, cd_comp4, cd_comp5) then
			ds_result_ww := '(-)';
		elsif ds_result_w in (cd_comp6, cd_comp7, cd_comp8, cd_comp9, cd_comp10) then
			ds_result_ww := '(+)';
		else
			ds_result_ww := 'no decision';
		end if;
	elsif (cd_desc_classif_w = '/') then
		if  ds_result_w in (cd_comp1, cd_comp2, cd_comp3, cd_comp4, cd_comp5) then
			ds_result_ww := '(-)';
		elsif ds_result_w in (cd_comp6, cd_comp7, cd_comp8, cd_comp9, cd_comp10) then
			ds_result_ww := 'no decision';
		else
			ds_result_ww := '(+)';
		end if;
	elsif (cd_desc_classif_w = 'n') then
		if cd_comp10 = '<=' then
			if ds_result_w <= cd_comp1 then
				ds_result_ww :=  '(+)';
			else
				ds_result_ww :=  '(-)';
			end if;
		elsif cd_comp10 = '>=' then
			if ds_result_w >= cd_comp1 then
				ds_result_ww :=  '(+)';
			else
				ds_result_ww :=  '(-)';
			end if;
		elsif cd_comp10 = '<' then
			if ds_result_w < cd_comp1 then
				ds_result_ww :=  '(+)';
			else
				ds_result_ww :=  '(-)';
			end if;
		elsif cd_comp10 = '>' then
			if ds_result_w > cd_comp1 then
				ds_result_ww :=  '(+)';
			else
				ds_result_ww :=  '(-)';
			end if;
		else
			if ds_result_w < cd_comp1 then
				ds_result_ww :=  '(+)';
			elsif ds_result_w >= cd_comp2 then
				ds_result_ww :=  '(-)';
			end if;
		end if;
    end if;

	end if;

	begin
	select CASE WHEN count(*)=0 THEN  'N'  ELSE 'S' END ,
		   cd_result_infec
	into STRICT   is_doenca_present_w,
		   cd_doenca_result_w
	from   historico_infeccao
	where  cd_pessoa_fisica = cd_pessoa_fisica_w
	and    cd_doenca = cd_test_item_w
	and    ie_situacao = 'A'
	and    (dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
	and    coalesce(dt_inativacao::text, '') = ''
	and    dt_exame < dt_coleta_p
	group by cd_result_infec;
	exception when others then
	cd_doenca_result_w := 0;
	is_doenca_present_w := 'N';
	end;

  begin
  select  nr_sequencia 
  into STRICT    nr_result_w
  from    infection_result
  where   ds_infecction_result = ds_result_ww
  and     ie_situacao = 'A';
  exception when others then
  nr_result_w := 0;
  end;

  if nr_result_w = 0 then
	select nextval('infection_result_seq')
	into STRICT   infec_resul_seq_w
	;
    insert into infection_result(nr_sequencia,
                              dt_atualizacao,
                              nm_usuario,
                              ie_situacao,
                              nm_usuario_nrec,
                              ds_infecction_result)
                  values ( infec_resul_seq_w,
                                clock_timestamp(),
                                'ITECH',
                                'A',
                                'ITECH',
                                ds_result_ww);
      nr_result_w := infec_resul_seq_w;
  end if;

	if (cd_upda_classif_w = 'A') then
		if (is_doenca_present_w = 'N') then
			select nextval('historico_infeccao_seq')
			into STRICT   nr_doenca_seq_w
			;
			insert into historico_infeccao(nr_sequencia,
                               cd_doenca,
                               cd_pessoa_fisica,
                               dt_atualizacao,
                               nm_usuario,
                               cd_result_infec,
                               cd_profissional,
                               ie_situacao,
                               dt_liberacao,
                               dt_exame)
                        values (nr_doenca_seq_w,
                                cd_test_item_w,
                                cd_pessoa_fisica_w,
                                clock_timestamp(),
                                'ITECH',
                                nr_result_w,
                                cd_profissional_w,
                                'A',
                                clock_timestamp(),
                                dt_coleta_p);
        elsif is_doenca_present_w = 'S' then
            update historico_infeccao
            set dt_inativacao = clock_timestamp(),
             ie_situacao = 'I'
            where cd_pessoa_fisica = cd_pessoa_fisica_w
            and cd_doenca = cd_test_item_w
            and ie_situacao = 'A'
            and (dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
            and coalesce(dt_inativacao::text, '') = '';
      select nextval('historico_infeccao_seq')
      into STRICT nr_doenca_seq_w
;
      insert into historico_infeccao(nr_sequencia,
                               cd_doenca,
                               cd_pessoa_fisica,
                               dt_atualizacao,
                               nm_usuario,
                               cd_result_infec,
                               cd_profissional,
                               ie_situacao,
                               dt_liberacao,
                               dt_exame)
                        values (nr_doenca_seq_w,
                                cd_test_item_w,
                                cd_pessoa_fisica_w,
                                clock_timestamp(),
                                'ITECH',
                                nr_result_w,
                                cd_profissional_w,
                                'A',
                                clock_timestamp(),
                                dt_coleta_p);
      end if;

	elsif (cd_upda_classif_w = '1') then

		if ds_result_w = '(+)' then

			if (is_doenca_present_w = 'N') then
				select nextval('historico_infeccao_seq')
				into STRICT nr_doenca_seq_w
				;
				insert into historico_infeccao(nr_sequencia,
                               cd_doenca,
                               cd_pessoa_fisica,
                               dt_atualizacao,
                               nm_usuario,
                               cd_result_infec,
                               cd_profissional,
                               ie_situacao,
                               dt_liberacao,
                               dt_exame)
                        values (nr_doenca_seq_w,
                                cd_test_item_w,
                                cd_pessoa_fisica_w,
                                clock_timestamp(),
                                'ITECH',
                                nr_result_w,
                                cd_profissional_w,
                                'A',
                                clock_timestamp(),
                                dt_coleta_p);
        elsif is_doenca_present_w = 'S' then
            update historico_infeccao
            set dt_inativacao = clock_timestamp(),
             ie_situacao = 'I'
            where cd_pessoa_fisica = cd_pessoa_fisica_w
            and cd_doenca = cd_test_item_w
            and ie_situacao = 'A'
            and (dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
            and coalesce(dt_inativacao::text, '') = '';
      select nextval('historico_infeccao_seq')
      into STRICT nr_doenca_seq_w
;
      insert into historico_infeccao(nr_sequencia,
                               cd_doenca,
                               cd_pessoa_fisica,
                               dt_atualizacao,
                               nm_usuario,
                               cd_result_infec,
                               cd_profissional,
                               ie_situacao,
                               dt_liberacao,
                               dt_exame)
                        values (nr_doenca_seq_w,
                                cd_test_item_w,
                                cd_pessoa_fisica_w,
                                clock_timestamp(),
                                'ITECH',
                                nr_result_w,
                                cd_profissional_w,
                                'A',
                                clock_timestamp(),
                                dt_coleta_p);
      end if;
    end if;
	elsif (cd_upda_classif_w = '2') then
		if ds_result_w = '(+)' and cd_doenca_result_w = 0 then
			if (is_doenca_present_w = 'N') then
				select nextval('historico_infeccao_seq')
				into STRICT nr_doenca_seq_w
				;
				insert into historico_infeccao(nr_sequencia,
                               cd_doenca,
                               cd_pessoa_fisica,
                               dt_atualizacao,
                               nm_usuario,
                               cd_result_infec,
                               cd_profissional,
                               ie_situacao,
                               dt_liberacao,
                               dt_exame)
                        values (nr_doenca_seq_w,
                                cd_test_item_w,
                                cd_pessoa_fisica_w,
                                clock_timestamp(),
                                'ITECH',
                                nr_result_w,
                                cd_profissional_w,
                                'A',
                                clock_timestamp(),
                                dt_coleta_p);
        elsif is_doenca_present_w = 'S' then
            update historico_infeccao
            set dt_inativacao = clock_timestamp(),
             ie_situacao = 'I'
            where cd_pessoa_fisica = cd_pessoa_fisica_w
            and cd_doenca = cd_test_item_w
            and ie_situacao = 'A'
            and (dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
            and coalesce(dt_inativacao::text, '') = '';
      select nextval('historico_infeccao_seq')
      into STRICT nr_doenca_seq_w
;
      insert into historico_infeccao(nr_sequencia,
                               cd_doenca,
                               cd_pessoa_fisica,
                               dt_atualizacao,
                               nm_usuario,
                               cd_result_infec,
                               cd_profissional,
                               ie_situacao,
                               dt_liberacao,
                               dt_exame)
                        values (nr_doenca_seq_w,
                                cd_test_item_w,
                                cd_pessoa_fisica_w,
                                clock_timestamp(),
                                'ITECH',
                                nr_result_w,
                                cd_profissional_w,
                                'A',
                                clock_timestamp(),
                                dt_coleta_p);
      end if;
    end if;
	elsif (cd_upda_classif_w = '3') then
		if (ds_result_w = '(+)' or ds_result_w = '(-)') and  cd_doenca_result_w = 0  then
			if (is_doenca_present_w = 'N') then
				select nextval('historico_infeccao_seq')
				into STRICT nr_doenca_seq_w
				;
				insert into historico_infeccao(nr_sequencia,
                               cd_doenca,
                               cd_pessoa_fisica,
                               dt_atualizacao,
                               nm_usuario,
                               cd_result_infec,
                               cd_profissional,
                               ie_situacao,
                               dt_liberacao,
                               dt_exame)
                        values (nr_doenca_seq_w,
                                cd_test_item_w,
                                cd_pessoa_fisica_w,
                                clock_timestamp(),
                                'ITECH',
                                nr_result_w,
                                cd_profissional_w,
                                'A',
                                clock_timestamp(),
                                dt_coleta_p);
        elsif is_doenca_present_w = 'S' then
            update historico_infeccao
            set dt_inativacao = clock_timestamp(),
             ie_situacao = 'I'
            where cd_pessoa_fisica = cd_pessoa_fisica_w
            and cd_doenca = cd_test_item_w
            and ie_situacao = 'A'
            and (dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
            and coalesce(dt_inativacao::text, '') = '';
      select nextval('historico_infeccao_seq')
      into STRICT nr_doenca_seq_w
;
      insert into historico_infeccao(nr_sequencia,
                               cd_doenca,
                               cd_pessoa_fisica,
                               dt_atualizacao,
                               nm_usuario,
                               cd_result_infec,
                               cd_profissional,
                               ie_situacao,
                               dt_liberacao,
                               dt_exame)
                        values (nr_doenca_seq_w,
                                cd_test_item_w,
                                cd_pessoa_fisica_w,
                                clock_timestamp(),
                                'ITECH',
                                nr_result_w,
                                cd_profissional_w,
                                'A',
                                clock_timestamp(),
                                dt_coleta_p);
			end if;
		end if;
	end if;
	commit;
  END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE itech_pck.update_infection_profile ( cd_test_item_p text, cd_profissional_p text, cd_pessoa_fisica_p text, ds_result_p text, dt_coleta_p timestamp) FROM PUBLIC;
