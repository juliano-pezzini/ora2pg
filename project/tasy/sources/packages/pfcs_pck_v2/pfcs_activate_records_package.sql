-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pfcs_pck_v2.pfcs_activate_records (nr_seq_indicator_p bigint, nr_seq_operational_level_p bigint, nm_usuario_p text ) AS $body$
DECLARE

		qt_reg_w	bigint := 0;
	
BEGIN

		--pfcs_panel_detail
		select	count(1)
		into STRICT	qt_reg_w
		from	pfcs_panel_detail
		where	nr_seq_indicator = nr_seq_indicator_p
		and	nr_seq_operational_level = nr_seq_operational_level_p
		and	ie_situation = 'A';

		if (qt_reg_w > 0) then

			delete FROM pfcs_detail_employee  e
            where exists (SELECT 1
                          from	pfcs_panel_detail d
                          where	d.nr_sequencia = e.nr_seq_detail
                                and d.nr_seq_indicator = nr_seq_indicator_p
                                and	d.nr_seq_operational_level = nr_seq_operational_level_p
                                and	d.ie_situation = 'A');

            delete FROM pfcs_detail_exam_lab  l
            where exists (SELECT 1
                          from	pfcs_panel_detail d
                          where	d.nr_sequencia = l.nr_seq_detail
                                and d.nr_seq_indicator = nr_seq_indicator_p
                                and	d.nr_seq_operational_level = nr_seq_operational_level_p
                                and	d.ie_situation = 'A');

            delete from pfcs_detail_bed b
            where exists (SELECT 1
                          from pfcs_panel_detail d
                          where d.nr_sequencia = b.nr_seq_detail
                                and d.nr_seq_indicator = nr_seq_indicator_p
                                and d.nr_seq_operational_level = nr_seq_operational_level_p
                                and d.ie_situation = 'A'
            );

            delete from pfcs_detail_patient p
            where exists (SELECT 1
                          from pfcs_panel_detail d
                          where d.nr_sequencia = p.nr_seq_detail
                                and d.nr_seq_indicator = nr_seq_indicator_p
                                and d.nr_seq_operational_level = nr_seq_operational_level_p
                                and d.ie_situation = 'A'
            );

			delete	FROM pfcs_panel_detail a
			where	a.nr_seq_indicator = nr_seq_indicator_p
				and	a.nr_seq_operational_level = nr_seq_operational_level_p
				and	exists (SELECT	1
                            from pfcs_panel x
                            where x.nr_sequencia = a.nr_seq_panel
                            and	x.ie_situation = 'A');

		end if;

		delete FROM pfcs_panel_detail p
        where p.nr_seq_indicator = nr_seq_indicator_p
        and	p.nr_seq_operational_level not in (
            SELECT e.cd_estabelecimento
            from estabelecimento e,
                empresa m
            where e.cd_empresa = m.cd_empresa
                and e.ie_situacao = 'A'
                and m.ie_situacao = 'A'
                and upper(e.nm_usuario_nrec) = 'PFCS'
        )
        and	p.ie_situation = 'A';

		update	pfcs_panel_detail
		set	ie_situation = 'A',
			dt_atualizacao = clock_timestamp(),
			nm_usuario = nm_usuario_p
		where	nr_seq_indicator = nr_seq_indicator_p
		and	nr_seq_operational_level = nr_seq_operational_level_p
		and	ie_situation = 'T';

		--pfcs_panel
		select	count(1)
		into STRICT	qt_reg_w
		from	pfcs_panel
		where	nr_seq_indicator = nr_seq_indicator_p
		and	nr_seq_operational_level = nr_seq_operational_level_p
		and	ie_situation = 'A';

		if (qt_reg_w > 0) then
			delete	FROM pfcs_panel
			where	nr_seq_indicator = nr_seq_indicator_p
			and	nr_seq_operational_level = nr_seq_operational_level_p
			and	ie_situation = 'A';
		end if;

		delete	FROM pfcs_panel p
        where	p.nr_seq_indicator = nr_seq_indicator_p
        and	p.nr_seq_operational_level not in (
            SELECT e.cd_estabelecimento
            from estabelecimento e,
                empresa m
            where e.cd_empresa = m.cd_empresa
                and e.ie_situacao = 'A'
                and m.ie_situacao = 'A'
                and upper(e.nm_usuario_nrec) = 'PFCS'
        )
        and	p.ie_situation = 'A';

		update	pfcs_panel
		set	ie_situation = 'A',
			dt_atualizacao = clock_timestamp(),
			nm_usuario = nm_usuario_p
		where	nr_seq_indicator = nr_seq_indicator_p
		and	nr_seq_operational_level = nr_seq_operational_level_p
		and	ie_situation = 'T';

		commit;

	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pfcs_pck_v2.pfcs_activate_records (nr_seq_indicator_p bigint, nr_seq_operational_level_p bigint, nm_usuario_p text ) FROM PUBLIC;
