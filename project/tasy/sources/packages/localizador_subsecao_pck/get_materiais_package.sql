-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION localizador_subsecao_pck.get_materiais () RETURNS SETOF MATERIAIS_T AS $body$
DECLARE

   indice_w bigint;

   c_materiais CURSOR FOR
      SELECT  a.cd_grupo_material,
              a.ds_grupo_material,
              a.cd_subgrupo_material,
              a.ds_subgrupo_material,
              a.cd_classe_material,
              a.ds_classe_material,
              a.cd_material,
              a.ds_material,
              a.nr_seq_ficha_tecnica,
              b.ds_substancia
      from    estrutura_material_v a,
              medic_ficha_tecnica b,
              table(lista_pck.obter_lista('6,8,9,0,2,3')) c,
              material_estab d
      where   a.nr_seq_ficha_tecnica   = b.nr_sequencia
      and     a.cd_material            = d.cd_material
      and     d.cd_estabelecimento     = cd_estabelecimento_w
      and     coalesce(d.IE_PRESCRICAO,'S') = 'S'
      and     a.ie_tipo_material       = c.nr_registro
      and     coalesce(a.ie_situacao,'A')   = 'A';
BEGIN
if (current_setting('localizador_subsecao_pck.materiais_w')::materiais_t.count = 0) then
   <<read_materiais>>
   for r_materiais in c_materiais
      loop
      current_setting('localizador_subsecao_pck.materiais_w')::materiais_t.extend(1);
      indice_w := current_setting('localizador_subsecao_pck.materiais_w')::materiais_t.count;
      current_setting('localizador_subsecao_pck.materiais_w')::materiais_t[indice_w].cd_grupo_material      := r_materiais.cd_grupo_material;
      current_setting('localizador_subsecao_pck.materiais_w')::materiais_t[indice_w].ds_grupo_material      := r_materiais.ds_grupo_material;
      current_setting('localizador_subsecao_pck.materiais_w')::materiais_t[indice_w].cd_subgrupo_material   := r_materiais.cd_subgrupo_material;
      current_setting('localizador_subsecao_pck.materiais_w')::materiais_t[indice_w].ds_subgrupo_material   := r_materiais.ds_subgrupo_material;
      current_setting('localizador_subsecao_pck.materiais_w')::materiais_t[indice_w].cd_classe_material     := r_materiais.cd_classe_material;
      current_setting('localizador_subsecao_pck.materiais_w')::materiais_t[indice_w].ds_classe_material     := r_materiais.ds_classe_material;
      current_setting('localizador_subsecao_pck.materiais_w')::materiais_t[indice_w].cd_material            := r_materiais.cd_material;
      current_setting('localizador_subsecao_pck.materiais_w')::materiais_t[indice_w].ds_material            := r_materiais.ds_material;
      current_setting('localizador_subsecao_pck.materiais_w')::materiais_t[indice_w].nr_seq_ficha_tecnica   := r_materiais.nr_seq_ficha_tecnica;
      current_setting('localizador_subsecao_pck.materiais_w')::materiais_t[indice_w].ds_substancia          := r_materiais.ds_substancia;
      end loop read_materiais;
end if;

if (current_setting('localizador_subsecao_pck.materiais_w')::materiais_t.count > 0) then
   for linha in current_setting('localizador_subsecao_pck.materiais_w')::materiais_t.first..materiais_w.last loop
      if (current_setting('localizador_subsecao_pck.materiais_w')::materiais_t.exists(linha)) then
         RETURN NEXT current_setting('localizador_subsecao_pck.materiais_w'::materiais_t(linha));
      end if;
   end loop;
end if;
return;
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION localizador_subsecao_pck.get_materiais () FROM PUBLIC;
