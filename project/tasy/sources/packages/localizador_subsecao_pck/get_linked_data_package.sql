-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION localizador_subsecao_pck.get_linked_data (ds_lista_linked_p text) RETURNS SETOF LINKED_DATA_T AS $body$
DECLARE

indice_w bigint;
c_linked_data CURSOR FOR
	SELECT  a.nm_table,
			a.nr_seq_vision,
			c.ie_informacao,
			b.nr_seq_linked_data,
			c.ie_grupo,
			b.nm_atributo,
			b.nm_atributo_linked,
			CASE WHEN coalesce(b.cd_exp_unid_med::text, '') = '' THEN obter_desc_expressao(b.cd_exp_informacao)  ELSE obter_desc_expressao(b.cd_exp_informacao)||' ('||obter_desc_expressao(b.cd_exp_unid_med)||')' END  ds_label,
			(SELECT  substr(max(obter_desc_expressao(z.cd_exp_titulo)),1,255)
			 from    tabela_visao_grupo z,
					 tabela_visao_atributo w
			 where   z.nr_sequencia = w.nr_seq_visao_grupo
			 and     w.nr_sequencia = a.nr_seq_vision
			 and     w.nm_atributo  = b.nm_atributo) ds_grupo_atributo,
			b.nr_sequencia nr_seq_atributo,
			( select  coalesce(max('S'),'N')
			  from    LINKED_DATA_ATRIB_COMP x
			  where   x.NR_SEQ_ATRIB_COMP = b.nr_sequencia) ie_composto_tree,
			  b.ie_tipo_agrupamento_padrao,
			coalesce(a.ie_chart_view,'N') ie_chart_view,
			coalesce(a.ie_timeline_view,'N') ie_timeline_view,
			coalesce(a.ie_grid_view,'S') ie_grid_view
	from    linked_data a,
			linked_data_atributo b,
			linked_data_ativacao c
	where   a.nr_sequencia 			= b.nr_seq_linked_data
	and     (b.cd_exp_informacao IS NOT NULL AND b.cd_exp_informacao::text <> '')
	and     b.ie_visivel_cliente  	= 'S'
	and     a.nr_sequencia        	= c.nr_seq_linked_data
	and     a.nr_seq_vision       	= c.nr_seq_visao;
BEGIN
if (current_setting('localizador_subsecao_pck.linked_data_w')::linked_data_t.count = 0) then
   <<read_linked_data>>
   for r_linked_data in c_linked_data
      loop
      current_setting('localizador_subsecao_pck.linked_data_w')::linked_data_t.extend(1);
      indice_w := current_setting('localizador_subsecao_pck.linked_data_w')::linked_data_t.count;
      current_setting('localizador_subsecao_pck.linked_data_w')::linked_data_t[indice_w].nm_table             	:= r_linked_data.nm_table;
      current_setting('localizador_subsecao_pck.linked_data_w')::linked_data_t[indice_w].nr_seq_vision        	:= r_linked_data.nr_seq_vision;
      current_setting('localizador_subsecao_pck.linked_data_w')::linked_data_t[indice_w].ie_informacao        	:= r_linked_data.ie_informacao;
      current_setting('localizador_subsecao_pck.linked_data_w')::linked_data_t[indice_w].nr_seq_linked_data   	:= r_linked_data.nr_seq_linked_data;
      current_setting('localizador_subsecao_pck.linked_data_w')::linked_data_t[indice_w].ie_grupo             	:= r_linked_data.ie_grupo;
      current_setting('localizador_subsecao_pck.linked_data_w')::linked_data_t[indice_w].nm_atributo          	:= r_linked_data.nm_atributo;
      current_setting('localizador_subsecao_pck.linked_data_w')::linked_data_t[indice_w].nm_atributo_linked   	:= r_linked_data.nm_atributo_linked;
      current_setting('localizador_subsecao_pck.linked_data_w')::linked_data_t[indice_w].ds_label         	   	:= r_linked_data.ds_label;
      current_setting('localizador_subsecao_pck.linked_data_w')::linked_data_t[indice_w].ds_grupo_atributo    	:= r_linked_data.ds_grupo_atributo;
	  current_setting('localizador_subsecao_pck.linked_data_w')::linked_data_t[indice_w].nr_seq_atributo    	:= r_linked_data.nr_seq_atributo;
	  current_setting('localizador_subsecao_pck.linked_data_w')::linked_data_t[indice_w].ie_composto_tree    	:= r_linked_data.ie_composto_tree;
	  current_setting('localizador_subsecao_pck.linked_data_w')::linked_data_t[indice_w].ie_tipo_agrupamento_padrao    	:= r_linked_data.ie_tipo_agrupamento_padrao;
	  current_setting('localizador_subsecao_pck.linked_data_w')::linked_data_t[indice_w].ie_chart_view    		:= r_linked_data.ie_chart_view;
	  current_setting('localizador_subsecao_pck.linked_data_w')::linked_data_t[indice_w].ie_timeline_view    	:= r_linked_data.ie_timeline_view;
	  current_setting('localizador_subsecao_pck.linked_data_w')::linked_data_t[indice_w].ie_grid_view    		:= r_linked_data.ie_grid_view;
      end loop read_linked_data;
end if;

if (current_setting('localizador_subsecao_pck.linked_data_w')::linked_data_t.count > 0) then
   for linha in current_setting('localizador_subsecao_pck.linked_data_w')::linked_data_t.first..linked_data_w.last loop
      if (current_setting('localizador_subsecao_pck.linked_data_w')::linked_data_t.exists(linha)) then
         RETURN NEXT current_setting('localizador_subsecao_pck.linked_data_w'::linked_data_t(linha));
      end if;
   end loop;
end if;

return;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION localizador_subsecao_pck.get_linked_data (ds_lista_linked_p text) FROM PUBLIC;
