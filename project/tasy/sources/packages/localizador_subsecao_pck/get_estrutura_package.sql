-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION localizador_subsecao_pck.get_estrutura (nr_seq_linked_data_p bigint, nr_seq_template_p bigint, nr_seq_documento_secao_p bigint) RETURNS SETOF ESTRUTURA_T AS $body$
DECLARE

indice_w    			bigint := 0;
ie_tabela_w				varchar(1);
nr_seq_linked_data_w	linked_data.nr_sequencia%type;
BEGIN
nr_seq_linked_data_w	:= null;
if (coalesce(pkg_i18n.get_user_locale, 'pt_BR') = 'ja_JP') then
	nr_seq_linked_data_w	:= nr_seq_linked_data_p;
end if;	

select	coalesce(max('S'),'N')
into STRICT	ie_tabela_w
from	w_apap_localizador
where	nm_usuario = wheb_usuario_pck.get_nm_usuario;

if (ie_tabela_w = 'N') then
	if (current_setting('localizador_subsecao_pck.estrutura_w')::estrutura_t.count = 0) then
		CALL CALL localizador_subsecao_pck.gera_niveis(nr_seq_linked_data_p,nr_seq_template_p, nr_seq_documento_secao_p);
	elsif (nr_seq_linked_data_p <> current_setting('localizador_subsecao_pck.estrutura_w')::estrutura_t[1].nr_seq_linked_data) then
		current_setting('localizador_subsecao_pck.estrutura_w')::estrutura_t.delete;
		CALL CALL localizador_subsecao_pck.gera_niveis(nr_seq_linked_data_p,nr_seq_template_p, nr_seq_documento_secao_p);
	end if;
else
	current_setting('localizador_subsecao_pck.estrutura_w')::estrutura_t.delete;
	SELECT 	a.* BULK COLLECT
	into STRICT	current_setting('localizador_subsecao_pck.estrutura_w')::estrutura_t
	from	w_apap_localizador a,
			documento_secao b
	where	a.nm_usuario 			= wheb_usuario_pck.get_nm_usuario
	and		b.nr_sequencia			= nr_seq_documento_secao_p
	and		((a.nr_seq_linked_data	= nr_seq_linked_data_w) or (coalesce(nr_seq_linked_data_w::text, '') = ''))
	and		a.ie_chart_view			= b.ie_chart_view
	and		a.ie_timeline_view		= b.ie_timeline_view
	and		a.ie_grid_view			= b.ie_grid_view;
end if;		

if (current_setting('localizador_subsecao_pck.estrutura_w')::estrutura_t.count > 0) then
   for linha in current_setting('localizador_subsecao_pck.estrutura_w')::estrutura_t.first..estrutura_w.last loop
      if (current_setting('localizador_subsecao_pck.estrutura_w')::estrutura_t.exists(linha)) then
         RETURN NEXT current_setting('localizador_subsecao_pck.estrutura_w'::estrutura_t(linha));
      end if;
   end loop;
end if;
return;
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION localizador_subsecao_pck.get_estrutura (nr_seq_linked_data_p bigint, nr_seq_template_p bigint, nr_seq_documento_secao_p bigint) FROM PUBLIC;
