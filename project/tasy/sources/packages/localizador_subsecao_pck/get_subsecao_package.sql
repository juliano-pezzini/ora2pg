-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION localizador_subsecao_pck.get_subsecao (nr_seq_secao_p bigint, nr_seq_doc_subsessao_p bigint) RETURNS SETOF SUBSECAO_T AS $body$
DECLARE

subsecao_w              subsecao_r;
ds_estrutura_w          varchar(2000);
nr_sequencia_w          bigint;
ds_descricao_w          varchar(255);
indice_w                bigint := 0;
ie_wdlg_w               varchar(15);
ie_informacao_w         varchar(15);
ds_campos_visiveis_w    varchar(2000);
current_setting('localizador_subsecao_pck.nm_usuario_w')::usuario.nm_usuario%type			usuario.nm_usuario%type	:= wheb_usuario_pck.get_nm_usuario;
c_subsecao CURSOR FOR
   SELECT   coalesce(a.nr_seq_linked_data,b.nr_seq_linked_data) nr_seq_linked_data_secao,
            b.nr_seq_linked_data nr_seq_linked_data_subsecao,
            b.nr_seq_apresentacao,
            b.nr_seq_grupo_pg,
            b.nr_seq_tipo_pg,
            b.nr_seq_score_flex,
            b.nr_ficha_tecnica,
            b.ie_tipo_dosagem,
            obter_valor_dominio(2274,b.ie_tipo_dosagem) ds_tipo_dosagem,
            b.nr_seq_gas,
            b.cd_material,
            b.cd_grupo_material,
            b.cd_subgrupo_material,
            b.cd_classe_material,
            b.ie_evolucao_clinica,
            b.nr_seq_inf_adic,
            substr(obter_dados_pg_inf_adic(b.nr_seq_inf_adic,'D'),1,255) ds_seq_inf_adic,
            b.ie_membro,
            substr(obter_valor_dominio(1304,b.ie_membro),1,255) ds_membro,
            b.ie_aparelho_pa,
            substr(obter_valor_dominio(1306,b.ie_aparelho_pa),1,255) ds_aparelho_pa,
            b.ie_pupila_lado,
            substr(obter_valor_dominio(1372,b.ie_pupila_lado),1,255) ds_pupila_lado,
            b.nm_atributo,
            b.nr_seq_exame,
			b.ie_evento_tipo,
			b.ie_tipo_elemento,
            b.nr_seq_tipo_registro,
            b.nr_seq_diagnostico,
			b.nr_seq_temp_conteudo,
			a.nr_seq_template,
			a.nr_sequencia nr_seq_documento_secao
      from  documento_secao a,
            documento_subsecao b
      where a.nr_sequencia       = b.nr_seq_documento_secao
      and   a.nr_sequencia       = nr_seq_secao_p
      and   ((b.nr_sequencia     = nr_seq_doc_subsessao_p) or (coalesce(nr_seq_doc_subsessao_p::text, '') = ''))
      and   ((a.nr_seq_linked_data IS NOT NULL AND a.nr_seq_linked_data::text <> '') or (b.nr_seq_linked_data IS NOT NULL AND b.nr_seq_linked_data::text <> '') or (b.nr_seq_temp_conteudo IS NOT NULL AND b.nr_seq_temp_conteudo::text <> ''))
	  and	coalesce(b.nr_seq_superior::text, '') = ''
      order by b.nr_seq_apresentacao;
BEGIN
<<read_subsecao>>
for r_subsecao in c_subsecao
   loop
   ds_campos_visiveis_w := null;
   if (r_subsecao.cd_material IS NOT NULL AND r_subsecao.cd_material::text <> '') then
		select  max(ds_estrutura),
				max(nr_sequencia),
				max(ds_descricao),
				max(ie_wdlg),
				max(ie_informacao)
      into STRICT     	ds_estrutura_w,
				nr_sequencia_w,
				ds_descricao_w,
				ie_wdlg_w,
				ie_informacao_w
      from     	w_apap_localizador
      where    	cd_material 			= r_subsecao.cd_material
      and      	nm_atributo 			= r_subsecao.nm_atributo
      and      	nr_seq_linked_data   	= r_subsecao.nr_seq_linked_data_subsecao
	  and		nm_usuario				= current_setting('localizador_subsecao_pck.nm_usuario_w')::usuario.nm_usuario%type;
   elsif (r_subsecao.cd_classe_material IS NOT NULL AND r_subsecao.cd_classe_material::text <> '') then
      select   	max(ds_estrutura),
				max(nr_sequencia),
				max(ds_descricao),
				max(ie_wdlg),
				max(ie_informacao)
      into STRICT     	ds_estrutura_w,
				nr_sequencia_w,
				ds_descricao_w,
				ie_wdlg_w,
				ie_informacao_w
      from     	w_apap_localizador
      where    	cd_classe_material  = r_subsecao.cd_classe_material
      and      	nm_atributo         = r_subsecao.nm_atributo
      and      	nr_seq_linked_data  = r_subsecao.nr_seq_linked_data_subsecao
	  and		nm_usuario			= current_setting('localizador_subsecao_pck.nm_usuario_w')::usuario.nm_usuario%type;
   elsif (r_subsecao.cd_subgrupo_material IS NOT NULL AND r_subsecao.cd_subgrupo_material::text <> '') then
      select   max(ds_estrutura),
               max(nr_sequencia),
               max(ds_descricao),
               max(ie_wdlg),
               max(ie_informacao)
      into STRICT     ds_estrutura_w,
               nr_sequencia_w,
               ds_descricao_w,
               ie_wdlg_w,
               ie_informacao_w
      from     w_apap_localizador
      where    cd_subgrupo_material = r_subsecao.cd_subgrupo_material
      and      nm_atributo          = r_subsecao.nm_atributo
      and      nr_seq_linked_data   = r_subsecao.nr_seq_linked_data_subsecao
	  and		nm_usuario			= current_setting('localizador_subsecao_pck.nm_usuario_w')::usuario.nm_usuario%type;
   elsif (r_subsecao.cd_grupo_material IS NOT NULL AND r_subsecao.cd_grupo_material::text <> '') then
      select   max(ds_estrutura),
               max(nr_sequencia),
               max(ds_descricao),
               max(ie_wdlg),
               max(ie_informacao)
      into STRICT     ds_estrutura_w,
               nr_sequencia_w,
               ds_descricao_w,
               ie_wdlg_w,
               ie_informacao_w
      from     w_apap_localizador
      where    cd_grupo_material = r_subsecao.cd_grupo_material
      and      nm_atributo       = r_subsecao.nm_atributo
      and      nr_seq_linked_data   = r_subsecao.nr_seq_linked_data_subsecao
	  and		nm_usuario			= current_setting('localizador_subsecao_pck.nm_usuario_w')::usuario.nm_usuario%type;
   elsif (r_subsecao.nr_ficha_tecnica IS NOT NULL AND r_subsecao.nr_ficha_tecnica::text <> '') then
      select   max(ds_estrutura),
               max(nr_sequencia),
               max(ds_descricao),
               max(ie_wdlg),
               max(ie_informacao)
      into STRICT     ds_estrutura_w,
               nr_sequencia_w,
               ds_descricao_w,
               ie_wdlg_w,
               ie_informacao_w
      from     w_apap_localizador
      where    nr_ficha_tecnica = r_subsecao.nr_ficha_tecnica
      and      nm_atributo      = r_subsecao.nm_atributo
      and      nr_seq_linked_data   = r_subsecao.nr_seq_linked_data_subsecao
	  and		nm_usuario			= current_setting('localizador_subsecao_pck.nm_usuario_w')::usuario.nm_usuario%type;
   elsif (r_subsecao.nr_seq_grupo_pg IS NOT NULL AND r_subsecao.nr_seq_grupo_pg::text <> '' AND r_subsecao.nr_seq_tipo_pg IS NOT NULL AND r_subsecao.nr_seq_tipo_pg::text <> '') then
      select   max(ds_estrutura),
               max(nr_sequencia),
               max(ds_descricao),
               max(ie_wdlg),
               max(ie_informacao)
      into STRICT     ds_estrutura_w,
               nr_sequencia_w,
               ds_descricao_w,
               ie_wdlg_w,
               ie_informacao_w
      from     w_apap_localizador
      where    nr_seq_grupo_pg = r_subsecao.nr_seq_grupo_pg
      and      nr_seq_tipo_pg = r_subsecao.nr_seq_tipo_pg
      and      nm_atributo     = r_subsecao.nm_atributo
      and      nr_seq_linked_data   = r_subsecao.nr_seq_linked_data_subsecao
	  and		nm_usuario			= current_setting('localizador_subsecao_pck.nm_usuario_w')::usuario.nm_usuario%type;
   elsif (r_subsecao.nr_seq_grupo_pg IS NOT NULL AND r_subsecao.nr_seq_grupo_pg::text <> '') then
      select   max(ds_estrutura),
               max(nr_sequencia),
               max(ds_descricao),
               max(ie_wdlg),
               max(ie_informacao)
      into STRICT     ds_estrutura_w,
               nr_sequencia_w,
               ds_descricao_w,
               ie_wdlg_w,
               ie_informacao_w
      from     w_apap_localizador
      where    nr_seq_grupo_pg = r_subsecao.nr_seq_grupo_pg
      and      nm_atributo     = r_subsecao.nm_atributo
      and      coalesce(nr_seq_tipo_pg::text, '') = ''
      and      nr_seq_linked_data   = r_subsecao.nr_seq_linked_data_subsecao
	  and		nm_usuario			= current_setting('localizador_subsecao_pck.nm_usuario_w')::usuario.nm_usuario%type;
   elsif (r_subsecao.nr_seq_tipo_pg IS NOT NULL AND r_subsecao.nr_seq_tipo_pg::text <> '') then
      select   max(ds_estrutura),
               max(nr_sequencia),
               max(ds_descricao),
               max(ie_wdlg),
               max(ie_informacao)
      into STRICT     ds_estrutura_w,
               nr_sequencia_w,
               ds_descricao_w,
               ie_wdlg_w,
               ie_informacao_w
      from     w_apap_localizador
      where    nr_seq_tipo_pg = r_subsecao.nr_seq_tipo_pg
      and      nm_atributo    = r_subsecao.nm_atributo
      and      nr_seq_linked_data   = r_subsecao.nr_seq_linked_data_subsecao
	  and		nm_usuario			= current_setting('localizador_subsecao_pck.nm_usuario_w')::usuario.nm_usuario%type;
   elsif (r_subsecao.nr_seq_score_flex IS NOT NULL AND r_subsecao.nr_seq_score_flex::text <> '') then
      select   max(ds_estrutura),
               max(nr_sequencia),
               max(ds_descricao),
               max(ie_wdlg),
               max(ie_informacao)
      into STRICT     ds_estrutura_w,
               nr_sequencia_w,
               ds_descricao_w,
               ie_wdlg_w,
               ie_informacao_w
      from     w_apap_localizador
      where    nr_seq_score_flex = r_subsecao.nr_seq_score_flex
      and      nm_atributo       = r_subsecao.nm_atributo
      and      nr_seq_linked_data   = r_subsecao.nr_seq_linked_data_subsecao
	  and		nm_usuario			= current_setting('localizador_subsecao_pck.nm_usuario_w')::usuario.nm_usuario%type;
   elsif (r_subsecao.nr_seq_gas IS NOT NULL AND r_subsecao.nr_seq_gas::text <> '') then
      select   max(ds_estrutura),
               max(nr_sequencia),
               max(ds_descricao),
               max(ie_wdlg),
               max(ie_informacao)
      into STRICT     ds_estrutura_w,
               nr_sequencia_w,
               ds_descricao_w,
               ie_wdlg_w,
               ie_informacao_w
      from     w_apap_localizador
      where    nm_atributo          = r_subsecao.nm_atributo
      and      nr_seq_gas           = r_subsecao.nr_seq_gas
      and      nr_seq_linked_data   = r_subsecao.nr_seq_linked_data_subsecao
	  and		nm_usuario			= current_setting('localizador_subsecao_pck.nm_usuario_w')::usuario.nm_usuario%type;
   elsif (r_subsecao.ie_evolucao_clinica IS NOT NULL AND r_subsecao.ie_evolucao_clinica::text <> '') then
      select   max(ds_estrutura),
               max(nr_sequencia),
               max(ds_descricao),
               max(ie_wdlg),
               max(ie_informacao)
      into STRICT     ds_estrutura_w,
               nr_sequencia_w,
               ds_descricao_w,
               ie_wdlg_w,
               ie_informacao_w
      from     w_apap_localizador
      where    nm_atributo          = r_subsecao.nm_atributo
      and      ie_evolucao_clinica  = r_subsecao.ie_evolucao_clinica
      and      nr_seq_linked_data   = r_subsecao.nr_seq_linked_data_subsecao
	  and		nm_usuario			= current_setting('localizador_subsecao_pck.nm_usuario_w')::usuario.nm_usuario%type;
   elsif (r_subsecao.nr_seq_exame IS NOT NULL AND r_subsecao.nr_seq_exame::text <> '') then
      select   max(ds_estrutura),
               max(nr_sequencia),
               max(ds_descricao),
               max(ie_wdlg),
               max(ie_informacao)
      into STRICT     ds_estrutura_w,
               nr_sequencia_w,
               ds_descricao_w,
               ie_wdlg_w,
               ie_informacao_w
      from     w_apap_localizador
      where    nm_atributo          = r_subsecao.nm_atributo
      and      nr_seq_exame         = r_subsecao.nr_seq_exame
      and      nr_seq_linked_data   = r_subsecao.nr_seq_linked_data_subsecao
	  and		nm_usuario			= current_setting('localizador_subsecao_pck.nm_usuario_w')::usuario.nm_usuario%type;
   elsif (r_subsecao.ie_tipo_elemento IS NOT NULL AND r_subsecao.ie_tipo_elemento::text <> '') then	
	  select   max(ds_estrutura),
               max(nr_sequencia),
               max(ds_descricao),
               max(ie_wdlg),
               max(ie_informacao)
      into STRICT     ds_estrutura_w,
               nr_sequencia_w,
               ds_descricao_w,
               ie_wdlg_w,
               ie_informacao_w
      from     w_apap_localizador
      where    nm_atributo          = r_subsecao.nm_atributo
      and      ie_tipo_elemento       = r_subsecao.ie_tipo_elemento
      and      nr_seq_linked_data   = r_subsecao.nr_seq_linked_data_subsecao
	  and		nm_usuario			= current_setting('localizador_subsecao_pck.nm_usuario_w')::usuario.nm_usuario%type;
    elsif (r_subsecao.ie_evento_tipo IS NOT NULL AND r_subsecao.ie_evento_tipo::text <> '') then
      select   max(ds_estrutura),
               max(nr_sequencia),
               max(ds_descricao),
               max(ie_wdlg),
               max(ie_informacao)
      into STRICT     ds_estrutura_w,
               nr_sequencia_w,
               ds_descricao_w,
               ie_wdlg_w,
               ie_informacao_w
      from     w_apap_localizador
      where    nm_atributo          = r_subsecao.nm_atributo
      and      ie_evento_tipo       = r_subsecao.ie_evento_tipo
      and      nr_seq_linked_data   = r_subsecao.nr_seq_linked_data_subsecao
	  and		nm_usuario			= current_setting('localizador_subsecao_pck.nm_usuario_w')::usuario.nm_usuario%type;
   elsif (r_subsecao.nr_seq_diagnostico IS NOT NULL AND r_subsecao.nr_seq_diagnostico::text <> '') then
      select   max(ds_estrutura),
               max(nr_sequencia),
               max(ds_descricao),
               max(ie_wdlg),
               max(ie_informacao)
      into STRICT     ds_estrutura_w,
               nr_sequencia_w,
               ds_descricao_w,
               ie_wdlg_w,
               ie_informacao_w
      from     w_apap_localizador
      where    nm_atributo          = r_subsecao.nm_atributo
      and      nr_seq_diagnostico       = r_subsecao.nr_seq_diagnostico
      and      nr_seq_linked_data   = r_subsecao.nr_seq_linked_data_subsecao
	  and		nm_usuario			= current_setting('localizador_subsecao_pck.nm_usuario_w')::usuario.nm_usuario%type;
    elsif (r_subsecao.nr_seq_tipo_registro IS NOT NULL AND r_subsecao.nr_seq_tipo_registro::text <> '') then	
	  select   max(ds_estrutura),
               max(nr_sequencia),
               max(ds_descricao),
               max(ie_wdlg),
               max(ie_informacao)
      into STRICT     ds_estrutura_w,
               nr_sequencia_w,
               ds_descricao_w,
               ie_wdlg_w,
               ie_informacao_w
      from     w_apap_localizador
      where    nm_atributo          = r_subsecao.nm_atributo
      and      nr_seq_tipo_registro       = r_subsecao.nr_seq_tipo_registro
      and      nr_seq_linked_data   = r_subsecao.nr_seq_linked_data_subsecao
	  and		nm_usuario			= current_setting('localizador_subsecao_pck.nm_usuario_w')::usuario.nm_usuario%type;
	elsif (r_subsecao.nr_seq_temp_conteudo IS NOT NULL AND r_subsecao.nr_seq_temp_conteudo::text <> '') then
		select	max(b.ds_estrutura),
				max(b.nr_sequencia),
				max(b.ds_descricao),
				max(b.ie_wdlg),
				max(b.ie_informacao)
		into STRICT    ds_estrutura_w,
				nr_sequencia_w,
				ds_descricao_w,
				ie_wdlg_w,
				ie_informacao_w
      from     	ehr_template_conteudo a,
				w_apap_localizador b
      where    	a.nr_sequencia 			= r_subsecao.nr_seq_temp_conteudo		
	  and		b.nm_atributo          	= r_subsecao.nm_atributo
      and      	b.nr_seq_temp_conteudo	= r_subsecao.nr_seq_temp_conteudo
	  and		b.nm_usuario			= current_setting('localizador_subsecao_pck.nm_usuario_w')::usuario.nm_usuario%type;
   elsif (r_subsecao.ie_evento_tipo IS NOT NULL AND r_subsecao.ie_evento_tipo::text <> '') then
      select   max(ds_estrutura),
               max(nr_sequencia),
               max(ds_descricao),
               max(ie_wdlg),
               max(ie_informacao)
      into STRICT     ds_estrutura_w,
               nr_sequencia_w,
               ds_descricao_w,
               ie_wdlg_w,
               ie_informacao_w
      from     w_apap_localizador
      where    nm_atributo          = r_subsecao.nm_atributo
      and      ie_evento_tipo       = r_subsecao.ie_evento_tipo
      and      nr_seq_linked_data   = r_subsecao.nr_seq_linked_data_subsecao
	  and		nm_usuario			= current_setting('localizador_subsecao_pck.nm_usuario_w')::usuario.nm_usuario%type;
   else
      select   max(ds_estrutura),
               max(nr_sequencia),
               max(ds_descricao),
               max(ie_wdlg),
               max(ie_informacao)
      into STRICT     ds_estrutura_w,
               nr_sequencia_w,
               ds_descricao_w,
               ie_wdlg_w,
               ie_informacao_w
      from     w_apap_localizador
      where    nm_atributo          = r_subsecao.nm_atributo
      and      nr_seq_linked_data   = r_subsecao.nr_seq_linked_data_subsecao
	  and		nm_usuario			= current_setting('localizador_subsecao_pck.nm_usuario_w')::usuario.nm_usuario%type;
   end if;
   if (ie_informacao_w = 'DE') then
      ds_campos_visiveis_w := 'NR_FICHA_TECNICA';
   elsif (ie_informacao_w in ('IA','IP')) then
      ds_campos_visiveis_w := 'CD_MATERIAL,CD_CLASSE_MATERIAL,CD_GRUPO_MATERIAL,CD_SUBGRUPO_MATERIAL,NR_FICHA_TECNICA';
   elsif ((r_subsecao.nr_seq_grupo_pg IS NOT NULL AND r_subsecao.nr_seq_grupo_pg::text <> '') or (r_subsecao.nr_seq_tipo_pg IS NOT NULL AND r_subsecao.nr_seq_tipo_pg::text <> '')) then
      ds_campos_visiveis_w := 'NR_SEQ_GRUPO_PG,NR_SEQ_TIPO_PG';
   elsif (r_subsecao.nr_seq_score_flex IS NOT NULL AND r_subsecao.nr_seq_score_flex::text <> '') then
      ds_campos_visiveis_w := 'NR_SEQ_SCORE_FLEX';
   elsif (r_subsecao.nr_seq_gas IS NOT NULL AND r_subsecao.nr_seq_gas::text <> '') then
      ds_campos_visiveis_w := 'NR_SEQ_GAS';
   elsif (r_subsecao.ie_evolucao_clinica IS NOT NULL AND r_subsecao.ie_evolucao_clinica::text <> '') then
      ds_campos_visiveis_w := 'IE_EVOLUCAO_CLINICA';
   elsif (r_subsecao.nr_seq_exame IS NOT NULL AND r_subsecao.nr_seq_exame::text <> '') then
      ds_campos_visiveis_w := 'NR_SEQ_EXAME';
   end if;

   if (ds_campos_visiveis_w IS NOT NULL AND ds_campos_visiveis_w::text <> '') then
      if (ie_wdlg_w = 'UM') then
         ds_campos_visiveis_w := ds_campos_visiveis_w||',IE_TIPO_DOSAGEM';
      elsif (ie_wdlg_w = 'SV') then
         ds_campos_visiveis_w := ds_campos_visiveis_w||',IE_APARELHO_PA,IE_MEMBRO';
      elsif (ie_wdlg_w = 'GP') then
         ds_campos_visiveis_w := ds_campos_visiveis_w||',NR_SEQ_INF_ADIC';
      end if;
   else
      if (ie_wdlg_w = 'UM') then
         ds_campos_visiveis_w := 'IE_TIPO_DOSAGEM';
      elsif (ie_wdlg_w = 'SV') then
         ds_campos_visiveis_w := 'IE_APARELHO_PA,IE_MEMBRO';
      elsif (ie_wdlg_w = 'GP') then
         ds_campos_visiveis_w := 'NR_SEQ_INF_ADIC';
      end if;
   end if;
   subsecao_w.nr_seq_apresentacao   := r_subsecao.nr_seq_apresentacao;
   subsecao_w.nr_seq_linked_data    := r_subsecao.nr_seq_linked_data_secao;
   subsecao_w.nr_seq_linked_data_subsecao    := r_subsecao.nr_seq_linked_data_subsecao;
   subsecao_w.nm_atributo           := r_subsecao.nm_atributo;
   subsecao_w.ds_descricao          := ds_descricao_w;
   subsecao_w.ds_estrutura          := ds_estrutura_w;
   subsecao_w.nr_seq_inf_adic       := r_subsecao.nr_seq_inf_adic;
   subsecao_w.ds_seq_inf_adic       := r_subsecao.ds_seq_inf_adic;
   subsecao_w.ie_membro             := r_subsecao.ie_membro;
   subsecao_w.ds_membro             := r_subsecao.ds_membro;
   subsecao_w.ie_aparelho_pa        := r_subsecao.ie_aparelho_pa;
   subsecao_w.ds_aparelho_pa        := r_subsecao.ds_aparelho_pa;
   subsecao_w.ie_pupila_lado        := r_subsecao.ie_pupila_lado;
   subsecao_w.ds_pupila_lado        := r_subsecao.ds_pupila_lado;
   subsecao_w.ie_tipo_dosagem       := r_subsecao.ie_tipo_dosagem;
   subsecao_w.ds_tipo_dosagem       := r_subsecao.ds_tipo_dosagem;
   subsecao_w.nr_sequencia          := nr_sequencia_w;
   subsecao_w.ds_campos_visiveis    := ds_campos_visiveis_w;
   RETURN NEXT subsecao_w;
   end loop read_subsecao;
return;
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION localizador_subsecao_pck.get_subsecao (nr_seq_secao_p bigint, nr_seq_doc_subsessao_p bigint) FROM PUBLIC;
