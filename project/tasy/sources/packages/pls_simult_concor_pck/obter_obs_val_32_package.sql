-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


--manter sincronia entre a obter_obs_val_32 e a obter_obs_val_32_nova_imp
CREATE OR REPLACE FUNCTION pls_simult_concor_pck.obter_obs_val_32 ( dados_regra_cab_p pls_simult_concor_pck.t_dado_cab_regra, cd_guia_referencia_p pls_conta.cd_guia_referencia%type, nr_seq_segurado_p pls_conta.nr_seq_segurado%type, dt_item_p pls_oc_cta_selecao_ocor_v.dt_item%type, nr_seq_conta_p pls_oc_cta_selecao_ocor_v.nr_seq_conta%type, ie_evento_p text) RETURNS text AS $body$
DECLARE

ds_observacao_w	text;

BEGIN

-- por atendimento considera o segurado e a guia
if (dados_regra_cab_p.ie_tipo_verificacao = '1') then

	-- importacao XML
	if (ie_evento_p = 'IMP') then

		select pls_admin_cursor.obter_desc_cursor_gigante( cursor(
			select ds_observacao from (
				select	'Conta: ' || b.nr_seq_conta || ' proc: ' || b.cd_procedimento || ' regra: ' || x.nr_seq_combinacao ||
						 ' - ' || x.nm_regra ds_observacao
				from	pls_combinacao_item_tm x,
					pls_conta_proc_ocor_v  b
				where	x.nr_seq_combinacao	= dados_regra_cab_p.nr_sequencia
				and	x.ie_tipo_registro	= 'P'
				and	b.nr_seq_segurado	= nr_seq_segurado_p
				and 	b.cd_guia_imp 		= cd_guia_referencia_p
				and	b.ie_origem_proced	= x.ie_origem_proced
				and	b.cd_procedimento_imp	= x.cd_procedimento
				
union all

				-- pacote nao grava registro na pls_combinacao_item_tm
				-- se tiver regra para pacote coloca ele na observacao com todos os itens da guia que sao pacotes
				select	'Conta: ' || b.nr_seq_conta || ' pacote: ' || b.cd_procedimento || ' regra: ' || dados_regra_cab_p.nr_sequencia ds_observacao
				from	pls_conta_proc_ocor_v  b					
				where	b.nr_seq_segurado	= nr_seq_segurado_p
				and 	b.cd_guia_imp 		= cd_guia_referencia_p
				and	b.ie_tipo_despesa	= '4'
				and	exists (select	1
						from	pls_comb_cta_item_proc z
						where	z.nr_seq_combinacao = dados_regra_cab_p.nr_sequencia
						and	z.ie_tipo_desp_proc = '4')
				
union all

				select	'Conta: ' || b.nr_seq_conta || ' mat: ' || b.nr_seq_material || ' regra: ' || x.nr_seq_combinacao ||
						 ' - ' || x.nm_regra ds_observacao
				from	pls_combinacao_item_tm x,
					pls_conta_mat_ocor_v b
				where	x.nr_seq_combinacao	= dados_regra_cab_p.nr_sequencia
				and	x.ie_tipo_registro	= 'M'
				and	b.nr_seq_segurado	= nr_seq_segurado_p
				and 	b.cd_guia_imp 		= cd_guia_referencia_p
				and	b.nr_seq_material	= x.nr_seq_material
			) tabela_observacao
			), pls_util_pck.enter_w )
		into STRICT ds_observacao_w
		;
	else
		select pls_admin_cursor.obter_desc_cursor_gigante( cursor(
			select ds_observacao from (
				select	'Conta: ' || b.nr_seq_conta || ' proc: ' || b.cd_procedimento || ' regra: ' || x.nr_seq_combinacao ||
						' - ' || x.nm_regra ds_observacao
				from	pls_combinacao_item_tm x,
					pls_conta_proc_ocor_v  b
				where	x.nr_seq_combinacao	= dados_regra_cab_p.nr_sequencia
				and	x.ie_tipo_registro	= 'P'
				and	b.nr_seq_segurado	= nr_seq_segurado_p
				and 	b.cd_guia_referencia 	= cd_guia_referencia_p
				and	b.ie_origem_proced	= x.ie_origem_proced
				and	b.cd_procedimento	= x.cd_procedimento
				
union all

				-- pacote nao grava registro na pls_combinacao_item_tm
				-- se tiver regra para pacote coloca ele na observacao com todos os itens da guia que sao pacotes
				select	'Conta: ' || b.nr_seq_conta || ' pacote: ' || b.cd_procedimento || ' regra: ' || dados_regra_cab_p.nr_sequencia ds_observacao
				from	pls_conta_proc_ocor_v  b
				where	b.nr_seq_segurado	= nr_seq_segurado_p
				and 	b.cd_guia_referencia 	= cd_guia_referencia_p
				and	b.ie_tipo_despesa	= '4'
				and	exists (select	1
						from	pls_comb_cta_item_proc z
						where	z.nr_seq_combinacao = dados_regra_cab_p.nr_sequencia
						and	z.ie_tipo_desp_proc = '4')
				
union all

				select	'Conta: ' || b.nr_seq_conta || ' mat: ' || b.nr_seq_material || ' regra: ' || x.nr_seq_combinacao ||
						' - ' || x.nm_regra ds_observacao
				from	pls_combinacao_item_tm x,
					pls_conta_mat_ocor_v b
				where	x.nr_seq_combinacao	= dados_regra_cab_p.nr_sequencia
				and	x.ie_tipo_registro	= 'M'
				and	b.nr_seq_segurado	= nr_seq_segurado_p
				and 	b.cd_guia_referencia 	= cd_guia_referencia_p
				and	b.nr_seq_material	= x.nr_seq_material
			) tabela_observacao
			), pls_util_pck.enter_w )
		into STRICT ds_observacao_w
		;

	end if;
elsif (dados_regra_cab_p.ie_tipo_verificacao = '2') then
	-- se for por data do item
	-- importacao XML
	if (ie_evento_p = 'IMP') then

		select pls_admin_cursor.obter_desc_cursor_gigante( cursor(
			select ds_observacao from (
				select	'Conta: ' || b.nr_seq_conta || ' proc: ' || b.cd_procedimento || ' regra: ' || x.nr_seq_combinacao ||
						' - ' || x.nm_regra ds_observacao
				from	pls_combinacao_item_tm x,
					pls_conta_proc_ocor_v  b
				where	x.nr_seq_combinacao	= dados_regra_cab_p.nr_sequencia
				and	x.ie_tipo_registro	= 'P'
				and	b.nr_seq_segurado	= nr_seq_segurado_p
				and 	b.dt_procedimento_imp	= dt_item_p
				and	b.ie_origem_proced	= x.ie_origem_proced
				and	b.cd_procedimento_imp	= x.cd_procedimento
				
union all

				select	'Conta: ' || b.nr_seq_conta || ' pacote: ' || b.cd_procedimento || ' regra: ' || dados_regra_cab_p.nr_sequencia ds_observacao
				from	pls_conta_proc_ocor_v  b
				where	b.nr_seq_segurado	= nr_seq_segurado_p
				and 	b.dt_procedimento_imp	= dt_item_p
				and	b.ie_tipo_despesa	= '4'
				and	exists (select	1
						from	pls_comb_cta_item_proc z
						where	z.nr_seq_combinacao = dados_regra_cab_p.nr_sequencia
						and	z.ie_tipo_desp_proc = '4')
				
union all

				select	'Conta: ' || b.nr_seq_conta || ' mat: ' || b.nr_seq_material || ' regra: ' || x.nr_seq_combinacao ||
						' - ' || x.nm_regra ds_observacao
				from	pls_combinacao_item_tm x,
					pls_conta_mat_ocor_v b
				where	x.nr_seq_combinacao	= dados_regra_cab_p.nr_sequencia
				and	x.ie_tipo_registro	= 'M'
				and	b.nr_seq_segurado	= nr_seq_segurado_p
				and 	b.dt_atendimento_imp	= dt_item_p
				and	b.nr_seq_material	= x.nr_seq_material
			) tabela_observacao
			), pls_util_pck.enter_w )
		into STRICT ds_observacao_w
		;
	else
		select pls_admin_cursor.obter_desc_cursor_gigante( cursor(
			select ds_observacao from (
				select	'Conta: ' || b.nr_seq_conta || ' proc: ' || b.cd_procedimento || ' regra: ' || x.nr_seq_combinacao ||
						' - ' || x.nm_regra ds_observacao
				from	pls_combinacao_item_tm x,
					pls_conta_proc_ocor_v  b
				where	x.nr_seq_combinacao	= dados_regra_cab_p.nr_sequencia
				and	x.ie_tipo_registro	= 'P'
				and	b.nr_seq_segurado	= nr_seq_segurado_p
				and 	b.dt_procedimento 	between trunc(dt_item_p, 'dd') and trunc(dt_item_p,'dd') + 86399/86400
				and	b.ie_origem_proced	= x.ie_origem_proced
				and	b.cd_procedimento	= x.cd_procedimento
				
union all

				select	'Conta: ' || b.nr_seq_conta || ' pacote: ' || b.cd_procedimento || ' regra: ' || dados_regra_cab_p.nr_sequencia ds_observacao
				from	pls_conta_proc_ocor_v  b
				where	b.nr_seq_segurado	= nr_seq_segurado_p
				and 	b.dt_procedimento 	between trunc(dt_item_p, 'dd') and trunc(dt_item_p,'dd') + 86399/86400
				and	b.ie_tipo_despesa	= '4'
				and	exists (select	1
						from	pls_comb_cta_item_proc z
						where	z.nr_seq_combinacao = dados_regra_cab_p.nr_sequencia
						and	z.ie_tipo_desp_proc = '4')
				
union all

				select	'Conta: ' || b.nr_seq_conta || ' mat: ' || b.nr_seq_material || ' regra: ' || x.nr_seq_combinacao ||
						' - ' || x.nm_regra  ds_observacao
				from	pls_combinacao_item_tm x,
					pls_conta_mat_ocor_v b
				where	x.nr_seq_combinacao	= dados_regra_cab_p.nr_sequencia
				and	x.ie_tipo_registro	= 'M'
				and	b.nr_seq_segurado	= nr_seq_segurado_p
				and 	b.dt_atendimento 	between trunc(dt_item_p, 'dd') and trunc(dt_item_p,'dd') + 86399/86400
				and	b.nr_seq_material	= x.nr_seq_material
			) tabela_observacao
			), pls_util_pck.enter_w )
		into STRICT ds_observacao_w
		;
	end if;
else
	-- se for por conta
	-- importacao XML
	if (ie_evento_p = 'IMP') then

		select pls_admin_cursor.obter_desc_cursor_gigante( cursor(
			select ds_observacao from (
				select	'Conta: ' || b.nr_seq_conta || ' proc: ' || b.cd_procedimento || ' regra: ' || x.nr_seq_combinacao ||
						' - ' || x.nm_regra ds_observacao
				from	pls_combinacao_item_tm x,
					pls_conta_proc_ocor_v  b
				where	x.nr_seq_combinacao	= dados_regra_cab_p.nr_sequencia
				and	x.ie_tipo_registro	= 'P'
				and	b.nr_seq_segurado	= nr_seq_segurado_p
				and 	b.nr_seq_conta		= nr_seq_conta_p
				and	b.ie_origem_proced	= x.ie_origem_proced
				and	b.cd_procedimento_imp	= x.cd_procedimento
				
union all

				select	'Conta: ' || b.nr_seq_conta || ' pacote: ' || b.cd_procedimento || ' regra: ' || dados_regra_cab_p.nr_sequencia ds_observacao
				from	pls_conta_proc_ocor_v  b
				where	b.nr_seq_segurado	= nr_seq_segurado_p
				and 	b.nr_seq_conta		= nr_seq_conta_p
				and	b.ie_tipo_despesa	= '4'
				and	exists (select	1
						from	pls_comb_cta_item_proc z
						where	z.nr_seq_combinacao = dados_regra_cab_p.nr_sequencia
						and	z.ie_tipo_desp_proc = '4')
				
union all

				select	'Conta: ' || b.nr_seq_conta || ' mat: ' || b.nr_seq_material || ' regra: ' || x.nr_seq_combinacao ||
						' - ' || x.nm_regra ds_observacao
				from	pls_combinacao_item_tm x,
					pls_conta_mat_ocor_v b
				where	x.nr_seq_combinacao	= dados_regra_cab_p.nr_sequencia
				and	x.ie_tipo_registro	= 'M'
				and	b.nr_seq_segurado	= nr_seq_segurado_p
				and 	b.nr_seq_conta		= nr_seq_conta_p
				and	b.nr_seq_material	= x.nr_seq_material
			) tabela_observacao
			), pls_util_pck.enter_w )
		into STRICT ds_observacao_w
		;
	else
		select pls_admin_cursor.obter_desc_cursor_gigante( cursor(
			select ds_observacao from (
				select	'Conta: ' || b.nr_seq_conta || ' proc: ' || b.cd_procedimento || ' regra: ' || x.nr_seq_combinacao ||
						' - ' || x.nm_regra ds_observacao
				from	pls_combinacao_item_tm x,
					pls_conta_proc_ocor_v  b
				where	x.nr_seq_combinacao	= dados_regra_cab_p.nr_sequencia
				and	x.ie_tipo_registro	= 'P'
				and	b.nr_seq_segurado	= nr_seq_segurado_p
				and 	b.nr_seq_conta		= nr_seq_conta_p
				and	b.ie_origem_proced	= x.ie_origem_proced
				and	b.cd_procedimento	= x.cd_procedimento
				
union all

				select	'Conta: ' || b.nr_seq_conta || ' pacote: ' || b.cd_procedimento || ' regra: ' || dados_regra_cab_p.nr_sequencia ds_observacao
				from	pls_conta_proc_ocor_v  b
				where	b.nr_seq_segurado	= nr_seq_segurado_p
				and 	b.nr_seq_conta		= nr_seq_conta_p
				and	b.ie_tipo_despesa	= '4'
				and	exists (select	1
						from	pls_comb_cta_item_proc z
						where	z.nr_seq_combinacao = dados_regra_cab_p.nr_sequencia
						and	z.ie_tipo_desp_proc = '4')
				
union all

				select	'Conta: ' || b.nr_seq_conta || ' mat: ' || b.nr_seq_material || ' regra: ' || x.nr_seq_combinacao ||
						' - ' || x.nm_regra  ds_observacao
				from	pls_combinacao_item_tm x,
					pls_conta_mat_ocor_v b
				where	x.nr_seq_combinacao	= dados_regra_cab_p.nr_sequencia
				and	x.ie_tipo_registro	= 'M'
				and	b.nr_seq_segurado	= nr_seq_segurado_p
				and 	b.nr_seq_conta		= nr_seq_conta_p
				and	b.nr_seq_material	= x.nr_seq_material
			) tabela_observacao
			), pls_util_pck.enter_w )
		into STRICT ds_observacao_w
		;
	end if;

end if;
					
return ds_observacao_w;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pls_simult_concor_pck.obter_obs_val_32 ( dados_regra_cab_p pls_simult_concor_pck.t_dado_cab_regra, cd_guia_referencia_p pls_conta.cd_guia_referencia%type, nr_seq_segurado_p pls_conta.nr_seq_segurado%type, dt_item_p pls_oc_cta_selecao_ocor_v.dt_item%type, nr_seq_conta_p pls_oc_cta_selecao_ocor_v.nr_seq_conta%type, ie_evento_p text) FROM PUBLIC;
