-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pls_simult_concor_pck.verifica_procedimento_ou ( nr_seq_simult_conc_p pls_combinacao_item_cta.nr_sequencia%type, dados_regra_p pls_tipos_ocor_pck.dados_regra, cd_guia_p pls_conta.cd_guia%type) RETURNS varchar AS $body$
DECLARE

					
ie_retorno_w		varchar(1);
qt_item_ou_w		integer;
qt_dias_considerar_w	pls_combinacao_item_cta.qt_dias_considerar%type;
dt_min_proc_w		timestamp;
dt_max_proc_w		timestamp;
qt_dif_dias_w		bigint;
qt_regra_proc_w		integer;
qt_regra_mat_w		integer;
ie_ou_excecao_w		pls_combinacao_item_cta.ie_ou_excecao%type;
			

BEGIN

ie_retorno_w	:= 'N';
qt_item_ou_w	:= 0;

-- Obter os dados da regra.
select	a.qt_dias_considerar,
	coalesce(ie_ou_excecao,'N') ie_ou_excecao,
	(select	count(1)
	from	pls_comb_cta_item_proc x
	where	x.nr_seq_combinacao = a.nr_sequencia
	and	x.ie_and_or = 'OR') qt_regra_proc,
	(select	count(1)
	from	pls_comb_item_cta_mat x
	where	x.nr_seq_combinacao = a.nr_sequencia
	and	x.ie_and_or = 'OR') qt_regra_mat
into STRICT	qt_dias_considerar_w,
	ie_ou_excecao_w,
	qt_regra_proc_w,
	qt_regra_mat_w
from	pls_combinacao_item_cta a
where	a.nr_sequencia	= nr_seq_simult_conc_p;

-- Verificar se existe regra OU primeiro, senao nem precisa buscar 
if (qt_regra_proc_w > 0) then

	-- Select para verificar a quantidade de procedimentos da analise que estao na lista de procedimentos "E" da regra 
	if (dados_regra_p.ie_evento = 'IMP') then
	
		select	count(distinct a.cd_procedimento_imp) qt,
			min(a.dt_procedimento_imp),
			max(a.dt_procedimento_imp)
		into STRICT	qt_item_ou_w,
			dt_min_proc_w,
			dt_max_proc_w
		from	pls_combinacao_item_tm x,
			pls_conta_proc_ocor_v	a
		where	x.nr_seq_combinacao	= nr_seq_simult_conc_p
		and	x.ie_tipo_registro	= 'P'
		and	x.ie_and_or		= 'OR'
		and	a.cd_guia_imp		= cd_guia_p
		and	a.cd_procedimento_imp	= x.cd_procedimento
		and	a.ie_origem_proced 	= x.ie_origem_proced;
	else
		select	count(distinct a.cd_procedimento) qt,
			min(a.dt_procedimento),
			max(a.dt_procedimento)
		into STRICT	qt_item_ou_w,
			dt_min_proc_w,
			dt_max_proc_w
		from	pls_combinacao_item_tm x,
			pls_conta_proc_ocor_v	a
		where	x.nr_seq_combinacao	= nr_seq_simult_conc_p
		and	x.ie_tipo_registro	= 'P'
		and	x.ie_and_or		= 'OR'
		and	a.cd_guia_referencia	= cd_guia_p
		and	a.cd_procedimento	= x.cd_procedimento
		and	a.ie_origem_proced 	= x.ie_origem_proced;
	end if;
end if;

-- Se o ou for excecao,  nao pode ter nenhum registro que atenda para gerar 
if (qt_regra_proc_w > 0) and (ie_ou_excecao_w = 'S') and (qt_item_ou_w = 0) then
	
	ie_retorno_w	:= 'S';
	
elsif (ie_ou_excecao_w = 'N') and (qt_item_ou_w > 0) then
	
	ie_retorno_w	:= 'S';
else
	if (qt_regra_proc_w + qt_regra_mat_w = 0) then
	
		ie_retorno_w	:= 'S';
	end if;
end if;

-- So verifica se ja for valido. 
if (ie_retorno_w = 'S') then

	--  Se a regra tiver restricao de quantidade de dias, ver se atende 
	if (qt_dias_considerar_w > 0) then
	
		qt_dif_dias_w	:= round(dt_max_proc_w - dt_min_proc_w);
		
		-- Se a quantidade de dias nao se enquadrar, nao pode aplicar a regra 
		if (qt_dif_dias_w > qt_dias_considerar_w) then
		
			ie_retorno_w	:= 'N';
		end if;
	end if;
end if;

return ie_retorno_w;	

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pls_simult_concor_pck.verifica_procedimento_ou ( nr_seq_simult_conc_p pls_combinacao_item_cta.nr_sequencia%type, dados_regra_p pls_tipos_ocor_pck.dados_regra, cd_guia_p pls_conta.cd_guia%type) FROM PUBLIC;
