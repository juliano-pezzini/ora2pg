-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pls_simult_concor_pck.verifica_material_e ( nr_seq_simult_conc_p pls_combinacao_item_cta.nr_sequencia%type, dados_regra_p pls_tipos_ocor_pck.dados_regra, cd_guia_p pls_conta.cd_guia%type) RETURNS varchar AS $body$
DECLARE

			
ie_retorno_w		varchar(1);

qt_item_e_w		integer;
qt_item_regra_w		integer;
qt_item_analise_w	integer;

ie_conta_igual_comb_w	pls_combinacao_item_cta.ie_conta_igual_comb%type;
qt_dias_considerar_w	pls_combinacao_item_cta.qt_dias_considerar%type;

dt_min_mat_w		timestamp;
dt_max_mat_w		timestamp;

qt_dif_dias_w		integer;
			

BEGIN

qt_item_e_w	:= 0;
ie_retorno_w	:= 'N';

select	a.ie_conta_igual_comb,
	a.qt_dias_considerar,
	-- Select para verificar a quantidade total de itens da regra "E" para ver se bate com a quantidade do select acima
	-- se bater, e porque o criterio "E" foi atendido 
	(select	count(1)
	from	pls_comb_item_cta_mat x
	where	x.nr_seq_combinacao = a.nr_sequencia
	and	x.ie_and_or = 'AND') qt_regra
into STRICT	ie_conta_igual_comb_w,
	qt_dias_considerar_w,
	qt_item_regra_w
from	pls_combinacao_item_cta a
where	a.nr_sequencia	= nr_seq_simult_conc_p;

-- Verificar se existe regra E primeiro, senao nem precisa buscar 
if (qt_item_regra_w > 0) then

	-- Select para verificar a quantidade de procedimentos da analise que estao na lista de procedimentos "E" da regra
	if (dados_regra_p.ie_evento = 'IMP') then
		
		select	count(distinct a.nr_seq_material) qt,
			min(a.dt_atendimento_imp),
			max(a.dt_atendimento_imp)
		into STRICT	qt_item_e_w,
			dt_min_mat_w,
			dt_max_mat_w
		from	pls_combinacao_item_tm x,
			pls_conta_mat_ocor_v	a
		where	x.nr_seq_combinacao	= nr_seq_simult_conc_p
		and	x.ie_tipo_registro	= 'M'
		and	x.ie_and_or		= 'AND'
		and	a.cd_guia_imp		= cd_guia_p
		and	a.nr_seq_material	= x.nr_seq_material;
	else
		select	count(distinct a.nr_seq_material) qt,
			min(a.dt_atendimento),
			max(a.dt_atendimento)
		into STRICT	qt_item_e_w,
			dt_min_mat_w,
			dt_max_mat_w
		from	pls_combinacao_item_tm x,
			pls_conta_mat_ocor_v	a
		where	x.nr_seq_combinacao	= nr_seq_simult_conc_p
		and	x.ie_tipo_registro	= 'M'
		and	x.ie_and_or		= 'AND'
		and	a.cd_guia_referencia	= cd_guia_p
		and	a.nr_seq_material	= x.nr_seq_material;
	end if;
end if;

-- Se o campo IE_CONTA_IGUAL_COMB  for S, tem que ser quantidade igual
if (ie_conta_igual_comb_w = 'S') then

	if (dados_regra_p.ie_evento = 'IMP') then
		
		select	count(distinct b.nr_seq_material) qt
		into STRICT	qt_item_analise_w
		from	pls_conta_mat_ocor_v b
		where	b.cd_guia_imp	= cd_guia_p;
	else
		select	count(distinct b.nr_seq_material) qt
		into STRICT	qt_item_analise_w
		from	pls_conta_mat_ocor_v b
		where	b.cd_guia_referencia	= cd_guia_p;
	end if;

	if (qt_item_e_w = qt_item_regra_w) and (qt_item_e_w = qt_item_analise_w) then
		
		ie_retorno_w	:= 'S';
	end if;
else
	if (qt_item_e_w = qt_item_regra_w) then
	
		ie_retorno_w	:= 'S';
	end if;
end if;

-- So entra se for valido, se ja nao for valido entao nem  precisa verificar mais nada.
if (ie_retorno_w = 'S') then

	-- Se a regra tiver restricao de quantidade de dias, ver se atende 
	if (qt_dias_considerar_w > 0) then
	
		qt_dif_dias_w	:= round(dt_max_mat_w - dt_min_mat_w);
		
		-- Se a quantidade de dias nao se enquadrar, nao pode aplicar a regra
		if (qt_dif_dias_w > qt_dias_considerar_w) then
		
			ie_retorno_w	:= 'N';
		end if;
	end if;
end if;

return ie_retorno_w;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pls_simult_concor_pck.verifica_material_e ( nr_seq_simult_conc_p pls_combinacao_item_cta.nr_sequencia%type, dados_regra_p pls_tipos_ocor_pck.dados_regra, cd_guia_p pls_conta.cd_guia%type) FROM PUBLIC;
