-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pls_simult_concor_pck.obter_campo_adic_mat_nova_imp ( dados_regra_ocor_p pls_tipos_ocor_pck.dados_regra, dados_regra_cab_p pls_simult_concor_pck.t_dado_cab_regra, cd_guia_referencia_p pls_conta.cd_guia_referencia%type, dt_item_p pls_oc_cta_selecao_ocor_v.dt_item%type, nr_seq_conta_p pls_oc_cta_selecao_ocor_v.nr_seq_conta%type, nr_seq_prestador_exec_princ_p pls_conta.nr_seq_prestador_exec_princ%type, bind_sql_p INOUT sql_pck.t_dado_bind) AS $body$
DECLARE


ds_campos_adic_w	varchar(1000);
ds_filtro_mat_w		varchar(1000);


BEGIN
ds_campos_adic_w := null;

-- obtem os filtros que sao especificos para o procedimento
bind_sql_p := pls_simult_concor_pck.obter_filtro_item(	'M', 'matadic', dados_regra_ocor_p, dados_regra_cab_p, cd_guia_referencia_p, dt_item_p, nr_seq_conta_p, nr_seq_prestador_exec_princ_p, bind_sql_p, 'N');

-- se for por guia e for para considerar diferenca de dias
-- se a regra for para considerar todos os lancamentos essa verificacao nao faz sentido pois sempre 
-- o menor dia e o maior dia serao iguais
-- por isso o select e feito somente no caso de ser por guia e ter valor informado para a quantidade a considerar
if (dados_regra_cab_p.ie_tipo_verificacao = '1' and dados_regra_cab_p.qt_dias_considerar > 0) then
	
	ds_campos_adic_w := ds_campos_adic_w || ',' || pls_util_pck.enter_w ||
		'	(select min(matadic.' || current_setting('pls_simult_concor_pck.ds_campo_dt_mat_g')::varchar(30) || ')' || pls_util_pck.enter_w ||
		'	 from   pls_conta_mat_ocor_imp_v matadic' || pls_util_pck.enter_w ||
		'	 where	matadic.nr_seq_segurado = :nr_seq_segurado_pc' || pls_util_pck.enter_w ||
		ds_filtro_mat_w || ') dt_material_ini, ' || pls_util_pck.enter_w ||
		'	(select max(matadic.' || current_setting('pls_simult_concor_pck.ds_campo_dt_mat_g')::varchar(30) || ')' || pls_util_pck.enter_w ||
		'	 from   pls_conta_mat_ocor_imp_v matadic' || pls_util_pck.enter_w ||
		'	 where	matadic.nr_seq_segurado = :nr_seq_segurado_pc' || pls_util_pck.enter_w ||
		ds_filtro_mat_w || ') dt_material_fim ' || pls_util_pck.enter_w;
		
-- caso contrario, recebe null
else
	ds_campos_adic_w := ds_campos_adic_w || ',' || pls_util_pck.enter_w ||
		'	null dt_material_ini, ' || pls_util_pck.enter_w ||
		'	null dt_material_fim ';
end if;

-- se for para que o numero de ocorrencias seja igual busca as quantidades independente de casar ou nao na regra
if (dados_regra_cab_p.ie_conta_igual_comb = 'S') then

	ds_campos_adic_w := ds_campos_adic_w || ',' || pls_util_pck.enter_w ||
				'(select	count(distinct matadic.nr_seq_material)' || pls_util_pck.enter_w ||
				'from 		pls_conta_mat_ocor_imp_v matadic' || pls_util_pck.enter_w ||
				'where 		matadic.nr_seq_segurado = :nr_seq_segurado_pc' || pls_util_pck.enter_w ||
				ds_filtro_mat_w || ') qt_total_mat';
else
	ds_campos_adic_w := ds_campos_adic_w || ',' || pls_util_pck.enter_w ||
				'0 qt_total_mat';
end if;

return;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pls_simult_concor_pck.obter_campo_adic_mat_nova_imp ( dados_regra_ocor_p pls_tipos_ocor_pck.dados_regra, dados_regra_cab_p pls_simult_concor_pck.t_dado_cab_regra, cd_guia_referencia_p pls_conta.cd_guia_referencia%type, dt_item_p pls_oc_cta_selecao_ocor_v.dt_item%type, nr_seq_conta_p pls_oc_cta_selecao_ocor_v.nr_seq_conta%type, nr_seq_prestador_exec_princ_p pls_conta.nr_seq_prestador_exec_princ%type, bind_sql_p INOUT sql_pck.t_dado_bind) FROM PUBLIC;
