-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pls_simult_concor_pck.verifica_material_ou ( nr_seq_simult_conc_p pls_combinacao_item_cta.nr_sequencia%type, dados_regra_p pls_tipos_ocor_pck.dados_regra, cd_guia_p pls_conta.cd_guia%type) RETURNS varchar AS $body$
DECLARE

				
ie_retorno_w		varchar(1);
qt_item_ou_w		integer;
qt_dias_considerar_w	pls_combinacao_item_cta.qt_dias_considerar%type;
dt_min_mat_w		timestamp;
dt_max_mat_w		timestamp;
qt_dif_dias_w		integer;
qt_regra_proc_w		integer;
qt_regra_mat_w		integer;
ie_ou_excecao_w		pls_combinacao_item_cta.ie_ou_excecao%type;
			

BEGIN

ie_retorno_w	:= 'N';
qt_item_ou_w	:= 0;

select	a.qt_dias_considerar,
	coalesce(ie_ou_excecao,'N') ie_ou_excecao,
	(select	count(1)
	from	pls_comb_item_cta_mat x
	where	x.nr_seq_combinacao = a.nr_sequencia
	and	x.ie_and_or = 'OR') qt_regra_mat,
	(select	count(1) qt
	from	pls_comb_cta_item_proc a
	where	a.nr_seq_combinacao = a.nr_sequencia
	and	a.ie_and_or = 'OR') qt_regra_proc
into STRICT	qt_dias_considerar_w,
	ie_ou_excecao_w,
	qt_regra_mat_w,
	qt_regra_proc_w
from	pls_combinacao_item_cta a
where	a.nr_sequencia	= nr_seq_simult_conc_p;

-- Verificar se existe regra OU primeiro, senao nem buscar 
if (qt_regra_mat_w > 0) then

	-- Select para verificar a quantidade de procedimentos da analise que estao na lista de procedimentos "E" da regra 
	if (dados_regra_p.ie_evento = 'IMP') then
		
		select	count(distinct a.nr_seq_material) qt,
			min(a.dt_atendimento_imp),
			max(a.dt_atendimento_imp)
		into STRICT	qt_item_ou_w,
			dt_min_mat_w,
			dt_max_mat_w
		from	pls_combinacao_item_tm x,
			pls_conta_mat_ocor_v	a
		where	x.nr_seq_combinacao	= nr_seq_simult_conc_p
		and	x.ie_tipo_registro	= 'M'
		and	x.ie_and_or		= 'OR'
		and	a.cd_guia_imp		= cd_guia_p
		and	a.nr_seq_material	= x.nr_seq_material;
	else	
		select	count(distinct a.nr_seq_material) qt,
			min(a.dt_atendimento),
			max(a.dt_atendimento)
		into STRICT	qt_item_ou_w,
			dt_min_mat_w,
			dt_max_mat_w
		from	pls_combinacao_item_tm x,
			pls_conta_mat_ocor_v a
		where	x.nr_seq_combinacao	= nr_seq_simult_conc_p
		and	x.ie_tipo_registro	= 'M'
		and	x.ie_and_or		= 'OR'
		and	a.cd_guia_referencia	= cd_guia_p
		and	a.nr_seq_material	= x.nr_seq_material;
	end if;
end if;

-- Se o ou for excecao,  nao pode ter nenhum registro que atenda para gerar 
if (qt_regra_mat_w > 0) and (ie_ou_excecao_w = 'S') and (qt_item_ou_w = 0) then
	
	ie_retorno_w	:= 'S';
	
elsif (ie_ou_excecao_w = 'N') and (qt_item_ou_w > 0) then
	
	ie_retorno_w	:= 'S';
else
	if (qt_regra_proc_w + qt_regra_mat_w = 0) then
		ie_retorno_w	:= 'S';
	end if;
end if;

-- So verifica se ja for valido. 
if (ie_retorno_w = 'S') then

	-- Se a regra tiver restricao de quantidade de dias, ver se atende 
	if (qt_dias_considerar_w > 0) then

		qt_dif_dias_w	:= round(dt_max_mat_w - dt_min_mat_w);
		
		-- Se a quantidade de dias nao se enquadrar, nao pode aplicar a regra 
		if (qt_dif_dias_w > qt_dias_considerar_w) then
		
			ie_retorno_w	:= 'N';
		end if;
	end if;
end if;

return ie_retorno_w;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pls_simult_concor_pck.verifica_material_ou ( nr_seq_simult_conc_p pls_combinacao_item_cta.nr_sequencia%type, dados_regra_p pls_tipos_ocor_pck.dados_regra, cd_guia_p pls_conta.cd_guia%type) FROM PUBLIC;
