-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_faturamento_pck.ajusta_tx_pos ( nr_seq_pos_proc_p pls_conta_pos_proc.nr_sequencia%type, nr_seq_pos_mat_p pls_conta_pos_mat.nr_sequencia%type, vl_diferenca_p bigint, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE


--Os valores de ajuste sao necessarios ter 4 casas decimais, pois sao proporcoes do valor de ajuste e precisam ser tratados para 
--que no update para o campo com 2 casas, nao se perca valor
vl_ajustar_tx_co_w    		double precision;
vl_ajustar_tx_servico_w    	double precision;
vl_ajustar_tx_materiais_w  	double precision;
current_setting('pls_faturamento_pck.vl_lib_taxa_co_w')::pls_conta_pos_estabelecido.vl_lib_taxa_co%type    		pls_conta_pos_estabelecido.vl_lib_taxa_co%type;
current_setting('pls_faturamento_pck.vl_lib_taxa_material_w')::pls_conta_pos_estabelecido.vl_lib_taxa_material%type          pls_conta_pos_estabelecido.vl_lib_taxa_material%type;
current_setting('pls_faturamento_pck.vl_lib_taxa_servico_w')::pls_conta_pos_estabelecido.vl_lib_taxa_servico%type           pls_conta_pos_estabelecido.vl_lib_taxa_servico%type;
vl_taxa_co_w                    pls_conta_pos_estabelecido.vl_taxa_co%type;
vl_taxa_material_w              pls_conta_pos_estabelecido.vl_taxa_material%type;
vl_taxa_servico_w               pls_conta_pos_estabelecido.vl_taxa_servico%type;
vl_materiais_w                  pls_conta_pos_estabelecido.vl_materiais%type;
vl_medico_w                     pls_conta_pos_estabelecido.vl_medico%type;
current_setting('pls_faturamento_pck.vl_custo_operacional_w')::pls_conta_pos_estabelecido.vl_beneficiario%type          pls_conta_pos_estabelecido.vl_custo_operacional%type;
vl_administracao_w              pls_conta_pos_estabelecido.vl_administracao%type;
pr_tx_co_w      		double precision;
pr_tx_material_w    		double precision;
pr_tx_servico_w      		double precision;
vl_divergencia_w    		double precision;
nr_seq_cabecalho_w		pls_conta_pos_cabecalho.nr_sequencia%type;
nr_seq_conta_proc_w		pls_conta_proc.nr_sequencia%type;
nr_seq_conta_mat_w		pls_conta_mat.nr_sequencia%type;
cd_estabelecimento_w		estabelecimento.cd_estabelecimento%type;

BEGIN

--Obtem os valores das taxas do pos-estab a ser atualizado e o percentual que cada sub-taxa representa em relacao ao valor
--total da taxa administrativa para que o valor de ajuste seja rateado de maneira proporcional
if (nr_seq_pos_proc_p IS NOT NULL AND nr_seq_pos_proc_p::text <> '') then
	select  vl_lib_taxa_co,
		vl_lib_taxa_material,
		vl_lib_taxa_servico,
		(dividir(vl_lib_taxa_co, (vl_taxa_co + vl_taxa_material + vl_taxa_servico) ))pr_tx_co,
		(dividir(vl_lib_taxa_material, (vl_taxa_co + vl_taxa_material + vl_taxa_servico) ))pr_tx_material,
		(dividir(vl_lib_taxa_servico, (vl_taxa_co + vl_taxa_material + vl_taxa_servico) ))pr_tx_servico,
		nr_seq_cabecalho
	into STRICT  	current_setting('pls_faturamento_pck.vl_lib_taxa_co_w')::pls_conta_pos_estabelecido.vl_lib_taxa_co%type,
		current_setting('pls_faturamento_pck.vl_lib_taxa_material_w')::pls_conta_pos_estabelecido.vl_lib_taxa_material%type,
		current_setting('pls_faturamento_pck.vl_lib_taxa_servico_w')::pls_conta_pos_estabelecido.vl_lib_taxa_servico%type,
		pr_tx_co_w,
		pr_tx_material_w,
		pr_tx_servico_w,
		nr_seq_cabecalho_w
	from  	pls_conta_pos_proc
	where 	nr_sequencia = nr_seq_pos_proc_p;
else
	select  0 vl_lib_taxa_co,
		vl_lib_taxa_material,
		0 vl_lib_taxa_servico,
		0 pr_tx_co,
		(dividir(vl_lib_taxa_material, vl_taxa_material ))pr_tx_material,
		0 pr_tx_servico,
		nr_seq_cabecalho
	into STRICT  	current_setting('pls_faturamento_pck.vl_lib_taxa_co_w')::pls_conta_pos_estabelecido.vl_lib_taxa_co%type,
		current_setting('pls_faturamento_pck.vl_lib_taxa_material_w')::pls_conta_pos_estabelecido.vl_lib_taxa_material%type,
		current_setting('pls_faturamento_pck.vl_lib_taxa_servico_w')::pls_conta_pos_estabelecido.vl_lib_taxa_servico%type,
		pr_tx_co_w,
		pr_tx_material_w,
		pr_tx_servico_w,
		nr_seq_cabecalho_w
	from  	pls_conta_pos_mat
	where 	nr_sequencia = nr_seq_pos_mat_p;
end if;

if (nr_seq_cabecalho_w IS NOT NULL AND nr_seq_cabecalho_w::text <> '') then
	select	max(cd_estabelecimento)
	into STRICT	cd_estabelecimento_w
	from	pls_conta_pos_cabecalho
	where	nr_sequencia	= nr_seq_cabecalho_w;
end if;

	
	--Aqui e feito o Round para duas casas pois os campos na tabela que receberao esse ajuste tem duas casas, entao preciso garantir que a divisao
	--dos valores nao gere fracao de centavo, pois isso viria gerar perda que pode chegar ate 0,99 centavos em cada uma das 3 taxas. Com o round, 
	--pode haver  pequena perda ou ganho nesse momento, porem abaixo eu faco um ajuste  e jogo a divergencia(sem fracao) para a maior das taxas.
	vl_ajustar_tx_co_w         := round((vl_diferenca_p * pr_tx_co_w)::numeric,2);
	vl_ajustar_tx_servico_w    := round((vl_diferenca_p * pr_tx_servico_w)::numeric,2);
	vl_ajustar_tx_materiais_w  := round((vl_diferenca_p * pr_tx_material_w)::numeric,2);

	--Ao distribuir a diferenca de valor entre as 3 taxas, pode ocorrer problema com sobra devido a proporcionalidade do valor, entao atribuo essa sobra ao maior dos valores
	vl_divergencia_w := (vl_ajustar_tx_co_w + vl_ajustar_tx_servico_w + vl_ajustar_tx_materiais_w) - vl_diferenca_p;
	if ( vl_divergencia_w <> 0) then

		--Priorizo a taxa servico para receber essa diferenca, se ela for maior ou pelo menos igual as demais, ela recebera o valor. Se alguma das outras duas taxas for mais, entao
		--continuo verificando quem deve receber a diferenca.
		--A divergencia entre o valor a ser ajustado e o valor distribuido proporcionalmente entre as 3 sub-taxas pode gerar uma divergencia que pode 
		--interferir no valor. Abaixo eu subtraio ela das taxas pois o vl_divergencia sera negativo caso reste uma fracao de centavo a ser distribuida entre os valores de ajuste, entao
		--a mesma acabara "somando" devido a subtracao do valor negativo.
		if ( vl_ajustar_tx_servico_w >= vl_ajustar_tx_co_w and vl_ajustar_tx_servico_w >= vl_ajustar_tx_materiais_w) then
			vl_ajustar_tx_servico_w := vl_ajustar_tx_servico_w - vl_divergencia_w;

		elsif ( vl_ajustar_tx_co_w >= vl_ajustar_tx_materiais_w ) then
			vl_ajustar_tx_co_w := vl_ajustar_tx_co_w - vl_divergencia_w;

		else
			vl_ajustar_tx_materiais_w := vl_ajustar_tx_materiais_w - vl_divergencia_w;
		end if;
	end if;

	--Nesse ponto os valores de ajuste estarao definidos corretamente.
	if (nr_seq_pos_proc_p IS NOT NULL AND nr_seq_pos_proc_p::text <> '') then
		update  pls_conta_pos_proc
		set  	vl_lib_taxa_co       	= vl_lib_taxa_co - vl_ajustar_tx_co_w,
			vl_lib_taxa_material    = vl_lib_taxa_material  - vl_ajustar_tx_materiais_w,
			vl_lib_taxa_servico    	= vl_lib_taxa_servico - vl_ajustar_tx_servico_w,
			vl_liberado_co_fat    	= vl_liberado_co_fat - vl_ajustar_tx_co_w,
			vl_liberado_hi_fat    	= vl_liberado_hi_fat - vl_ajustar_tx_servico_w,
			vl_liberado_material_fat = vl_liberado_material_fat - vl_ajustar_tx_materiais_w,
			vl_taxa_co      	= vl_taxa_co - vl_ajustar_tx_co_w,
			vl_taxa_material    	= vl_taxa_material - vl_ajustar_tx_materiais_w,
			vl_taxa_servico      	= vl_taxa_servico - vl_ajustar_tx_servico_w,
			vl_provisao      	= vl_provisao - ( vl_ajustar_tx_co_w + vl_ajustar_tx_materiais_w + vl_ajustar_tx_servico_w ),
			vl_ajuste		= ( vl_ajustar_tx_co_w + vl_ajustar_tx_materiais_w + vl_ajustar_tx_servico_w ) --Para permitir retornar o ajuste ao desfazer lote de faturamento
		where  	nr_sequencia 		= nr_seq_pos_proc_p
		return;
		
		--Necessario gerar novamente os valores contabies de pos-estabelecido devido a alteracao do registro
		CALL pls_pos_estabelecido_pck.gerar_valores_adicionais(null, null, null, null, null, null, nr_seq_conta_proc_w, 'S', nm_usuario_p, cd_estabelecimento_w);
	else
		update  pls_conta_pos_mat
		set  	vl_lib_taxa_material    = vl_lib_taxa_material  - vl_ajustar_tx_materiais_w,
			vl_liberado_material_fat = vl_liberado_material_fat - vl_ajustar_tx_materiais_w,
			vl_taxa_material    	= vl_taxa_material - vl_ajustar_tx_materiais_w,
			vl_provisao      	= vl_provisao - ( vl_ajustar_tx_co_w + vl_ajustar_tx_materiais_w + vl_ajustar_tx_servico_w ),
			vl_ajuste		= ( vl_ajustar_tx_co_w + vl_ajustar_tx_materiais_w + vl_ajustar_tx_servico_w ) --Para permitir retornar o ajuste ao desfazer lote de faturamento
		where  	nr_sequencia 		= nr_seq_pos_mat_p
		return;
		
		--Necessario gerar novamente os valores contabies de pos-estabelecido devido a alteracao do registro
		CALL pls_pos_estabelecido_pck.gerar_valores_adicionais(null, null, null, null, null, nr_seq_conta_mat_w, null, 'S', nm_usuario_p, cd_estabelecimento_w);
	end if;
end;

begin
for r_c01_w in C01 loop
	--levanta a tx_adminstra utilizada para verificar arredondamento das tx_adm nos itens de pos-estab
	--se retornar zero ou nulo, entao define valor padrao 100 para nao necessitar muitas verificacoes posteriormente
	select	CASE WHEN coalesce(max(tx_administracao)::text, '') = '' THEN  100 WHEN max(tx_administracao)=0 THEN  100  ELSE max(tx_administracao) END
	into STRICT	tx_adm_considerar_w
	from (SELECT	c.tx_administracao
		from   	pls_fatura_conta a,
			pls_fatura_evento b,
			pls_conta_pos_proc c
		where  	a.nr_seq_fatura_evento = b.nr_sequencia
		and    	c.nr_seq_conta = a.nr_seq_conta
		and    	b.nr_sequencia = r_c01_w.nr_seq_evento
		
union

		SELECT	c.tx_administracao
		from   	pls_fatura_conta a,
			pls_fatura_evento b,
			pls_conta_pos_mat c
		where  	a.nr_seq_fatura_evento = b.nr_sequencia
		and    	c.nr_seq_conta = a.nr_seq_conta
		and    	b.nr_sequencia = r_c01_w.nr_seq_evento) alias4;

	--Se no evento em questao existirem itens cuja taxa administrativa forem diferentes, nao sera possivel a realizacao do arredondamento
	--por essa razao, aqui e levantado se apenas 1 pecentual de taxa e definido para todos os pos-estab que "entram" nesse evento de faturamento.
	select  count(distinct tx)
	into STRICT   	qt_dif_taxas_no_evento_w
	from (SELECT  distinct c.tx_administracao tx
		from   	pls_fatura_proc x,
			pls_fatura_conta a,
			pls_fatura_evento b,
			pls_conta_pos_proc c
		where  	a.nr_seq_fatura_evento = b.nr_sequencia
		and	x.nr_seq_fatura_conta = a.nr_sequencia
		and    	x.nr_seq_pos_proc = c.nr_sequencia
		and    	b.nr_sequencia = r_c01_w.nr_seq_evento
		
union all

		SELECT  distinct c.tx_administracao tx
		from   	pls_fatura_mat x,
			pls_fatura_conta a,
			pls_fatura_evento b,
			pls_conta_pos_mat c
		where  	a.nr_seq_fatura_evento = b.nr_sequencia
		and	x.nr_seq_fatura_conta = a.nr_sequencia
		and    	x.nr_seq_pos_mat = c.nr_sequencia
		and    	b.nr_sequencia = r_c01_w.nr_seq_evento
		) alias1;
		

	--Obtem o valor de tx administrativa caso o mesmo fosse aplicado diretamente no valor do evento
	vl_administracao_evento_w :=  dividir((tx_adm_considerar_w * r_c01_w.vl_evento), 100);

	--Obtem a soma do valor das taxas adm. de todos os itens
	select  sum(vl_faturado)
		into STRICT  vl_adm_todos_itens_w
	from (
		SELECT  sum(a.vl_faturado) vl_faturado
		from  	pls_fatura_proc a,
			pls_fatura_conta b
		where  	a.nr_seq_fatura_conta = b.nr_sequencia
		and  	b.nr_seq_fatura_evento = r_c01_w.nr_seq_evento
		
union all

		SELECT  sum(a.vl_faturado) vl_faturado
		from  	pls_fatura_mat a,
			pls_fatura_conta b
		where  	a.nr_seq_fatura_conta = b.nr_sequencia
		and  	b.nr_seq_fatura_evento = r_c01_w.nr_seq_evento) alias3;

	--Verifica se ha diferenca entre o valor de taxa adm gerada para todos os itens no evento e o valor da taxa considerando o percentual sobre o
	--valor total do evento. Caso sim, sera necessario passar essa diferenca para as taxas presentes nos registros de pos-estab. Foi definido que o
	--diferenca sera passada para o registro de pos-estab que possuir o maior valor de taxa.
	if	((vl_adm_todos_itens_w != 0) and (vl_administracao_evento_w <> vl_adm_todos_itens_w ) and (qt_dif_taxas_no_evento_w = 1)) then
		vl_dif_adm_w := vl_adm_todos_itens_w - vl_administracao_evento_w;

		--Maior valor de tx_administrativa entre os itens contidos no evento
		select  max(vl_faturado)
		into STRICT  	vl_maior_taxa_w
		from (
			SELECT  max(a.vl_faturado) vl_faturado
			from  	pls_fatura_proc a,
				pls_fatura_conta b
			where  	a.nr_seq_fatura_conta 	= b.nr_sequencia
			and  	b.nr_seq_fatura_evento 	= r_c01_w.nr_seq_evento
			and   	coalesce(a.nr_seq_fat_proc_cancel::text, '') = ''
			
union all

			SELECT  max(a.vl_faturado)
			from  	pls_fatura_mat a,
				pls_fatura_conta b
			where  	a.nr_seq_fatura_conta 	= b.nr_sequencia
			and  	b.nr_seq_fatura_evento 	= r_c01_w.nr_seq_evento
			and   	coalesce(a.nr_seq_fat_mat_cancel::text, '') = '') alias5;
			
		select 	max(nr_seq_pos_proc)
		into STRICT	nr_seq_pos_proc_atualizar_w
		from  	pls_fatura_proc a,
			pls_fatura_conta b
		where  	a.nr_seq_fatura_conta 	= b.nr_sequencia
		and  	b.nr_seq_fatura_evento	= r_c01_w.nr_seq_evento
		and  	a.vl_faturado 		= vl_maior_taxa_w
		and   	coalesce(a.nr_seq_fat_proc_cancel::text, '') = '';
		
		if (coalesce(nr_seq_pos_proc_atualizar_w::text, '') = '') then
			select 	max(nr_seq_conta_pos_estab)
			into STRICT	nr_seq_pos_mat_atualizar_w
			from  	pls_fatura_mat a,
				pls_fatura_conta b
			where  	a.nr_seq_fatura_conta 	= b.nr_sequencia
			and  	b.nr_seq_fatura_evento 	= r_c01_w.nr_seq_evento
			and  	a.vl_faturado 		= vl_maior_taxa_w
			and  	coalesce(a.nr_seq_fat_mat_cancel::text, '') = '';
		end if;

		--Aqui e chamada rotina para aplicar a diferenca sobre o registro de pos-estabelecido encontrado.
		CALL pls_faturamento_pck.ajusta_tx_pos( nr_seq_pos_proc_atualizar_w, nr_seq_pos_mat_atualizar_w, vl_dif_adm_w, nm_usuario_p );

		if (nr_seq_pos_proc_atualizar_w IS NOT NULL AND nr_seq_pos_proc_atualizar_w::text <> '') then
			--Busca valores de pos alterado e atualiza os valores
			select  vl_lib_taxa_co,
				vl_lib_taxa_material,
				vl_lib_taxa_servico,
				vl_materiais,
				vl_medico,
				vl_custo_operacional
			into STRICT  	current_setting('pls_faturamento_pck.vl_lib_taxa_co_w')::pls_conta_pos_estabelecido.vl_lib_taxa_co%type,
				current_setting('pls_faturamento_pck.vl_lib_taxa_material_w')::pls_conta_pos_estabelecido.vl_lib_taxa_material%type,
				current_setting('pls_faturamento_pck.vl_lib_taxa_servico_w')::pls_conta_pos_estabelecido.vl_lib_taxa_servico%type,
				vl_materiais_w,
				vl_medico_w,
				current_setting('pls_faturamento_pck.vl_custo_operacional_w')::pls_conta_pos_estabelecido.vl_beneficiario%type
			from  	pls_conta_pos_proc
			where  	nr_sequencia = nr_seq_pos_proc_atualizar_w;
		
			update  pls_fatura_proc
			set  	vl_faturado     	=  (current_setting('pls_faturamento_pck.vl_lib_taxa_co_w')::pls_conta_pos_estabelecido.vl_lib_taxa_co%type + current_setting('pls_faturamento_pck.vl_lib_taxa_material_w')::pls_conta_pos_estabelecido.vl_lib_taxa_material%type + current_setting('pls_faturamento_pck.vl_lib_taxa_servico_w')::pls_conta_pos_estabelecido.vl_lib_taxa_servico%type),
				vl_lib_taxa_co    	= current_setting('pls_faturamento_pck.vl_lib_taxa_co_w')::pls_conta_pos_estabelecido.vl_lib_taxa_co%type,
				vl_lib_taxa_material  	= current_setting('pls_faturamento_pck.vl_lib_taxa_material_w')::pls_conta_pos_estabelecido.vl_lib_taxa_material%type,
				vl_lib_taxa_servico  	= current_setting('pls_faturamento_pck.vl_lib_taxa_servico_w')::pls_conta_pos_estabelecido.vl_lib_taxa_servico%type
			where  	nr_seq_pos_proc		= nr_seq_pos_proc_atualizar_w
			and  	coalesce(nr_seq_fat_proc_cancel::text, '') = '';
		end if;

		if (nr_seq_pos_mat_atualizar_w IS NOT NULL AND nr_seq_pos_mat_atualizar_w::text <> '') then
			--Busca valores de pos alterado e atualiza os valores
			select  0 vl_lib_taxa_co,
				vl_lib_taxa_material,
				0 vl_lib_taxa_servico,
				vl_materiais,
				0 vl_medico,
				0 vl_custo_operacional
			into STRICT  	current_setting('pls_faturamento_pck.vl_lib_taxa_co_w')::pls_conta_pos_estabelecido.vl_lib_taxa_co%type,
				current_setting('pls_faturamento_pck.vl_lib_taxa_material_w')::pls_conta_pos_estabelecido.vl_lib_taxa_material%type,
				current_setting('pls_faturamento_pck.vl_lib_taxa_servico_w')::pls_conta_pos_estabelecido.vl_lib_taxa_servico%type,
				vl_materiais_w,
				vl_medico_w,
				current_setting('pls_faturamento_pck.vl_custo_operacional_w')::pls_conta_pos_estabelecido.vl_beneficiario%type
			from  	pls_conta_pos_mat
			where  	nr_sequencia = nr_seq_pos_mat_atualizar_w;
		
			update  pls_fatura_mat
			set  	vl_faturado     	=  ( current_setting('pls_faturamento_pck.vl_lib_taxa_co_w')::pls_conta_pos_estabelecido.vl_lib_taxa_co%type + current_setting('pls_faturamento_pck.vl_lib_taxa_material_w')::pls_conta_pos_estabelecido.vl_lib_taxa_material%type + current_setting('pls_faturamento_pck.vl_lib_taxa_servico_w')::pls_conta_pos_estabelecido.vl_lib_taxa_servico%type ),
				vl_lib_taxa_co    	= current_setting('pls_faturamento_pck.vl_lib_taxa_co_w')::pls_conta_pos_estabelecido.vl_lib_taxa_co%type,
				vl_lib_taxa_material  	= current_setting('pls_faturamento_pck.vl_lib_taxa_material_w')::pls_conta_pos_estabelecido.vl_lib_taxa_material%type,
				vl_lib_taxa_servico  	= current_setting('pls_faturamento_pck.vl_lib_taxa_servico_w')::pls_conta_pos_estabelecido.vl_lib_taxa_servico%type
			where  	nr_seq_pos_mat		= nr_seq_pos_mat_atualizar_w
			and  	coalesce(nr_seq_fat_mat_cancel::text, '') = '';
		end if;

		--Atualiza valor da taxa na respectiva pls_fatura_conta
		update  pls_fatura_conta
		set  	vl_faturado   = vl_faturado - vl_dif_adm_w
		where  	nr_sequencia   = (  	SELECT  max(nr_seq_fatura_conta)
						from (  SELECT   nr_seq_fatura_conta
						from	pls_fatura_proc
						where  	nr_seq_pos_proc = nr_seq_pos_proc_atualizar_w
						
union

						select  nr_seq_fatura_conta
						from  	pls_fatura_mat
						where  	nr_seq_pos_mat = nr_seq_pos_mat_atualizar_w) alias1);

		update  pls_fatura
		set  	vl_fatura = vl_fatura - vl_dif_adm_w
		where  	nr_sequencia = r_c01_w.nr_seq_fatura;

		select	sum(vl_faturado) + sum(vl_faturado_ndc)
		into STRICT	vl_evento_w
		from	pls_fatura_conta
		where	nr_seq_fatura_evento = r_c01_w.nr_seq_evento;

		update  pls_fatura_evento
		set  	vl_evento 	= vl_evento_w
		where  	nr_sequencia 	= r_c01_w.nr_seq_evento;

	end if;
end loop;

commit;

END;

-- Desfazer o lote faturamento
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_faturamento_pck.ajusta_tx_pos ( nr_seq_pos_proc_p pls_conta_pos_proc.nr_sequencia%type, nr_seq_pos_mat_p pls_conta_pos_mat.nr_sequencia%type, vl_diferenca_p bigint, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;
