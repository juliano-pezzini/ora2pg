-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_faturamento_pck.altera_status_fatura ( nr_seq_fatura_p pls_fatura.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nr_seq_ajuste_gerado_p INOUT bigint, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE

				
nr_seq_analise_w		pls_conta.nr_seq_analise%type;

c01 CURSOR(	nr_seq_fatura_pc		pls_fatura.nr_sequencia%type) FOR
	SELECT	c.nr_seq_conta,
		a.nr_seq_lote
	from	pls_fatura_conta 	c,
		pls_fatura_evento	b,
		pls_fatura 		a
	where	a.nr_sequencia		= b.nr_seq_fatura
	and	b.nr_sequencia		= c.nr_seq_fatura_evento
	and	a.nr_sequencia		= nr_seq_fatura_pc
	and	c.nr_seq_conta in (	SELECT	d.nr_seq_conta 	-- Somente contas que NECESSITAM de ajuste
					from	w_pls_fatura_refat d);
					
c02 CURSOR(	nr_seq_analise_pc		pls_analise_conta.nr_sequencia%type) FOR
	SELECT	nr_sequencia nr_seq_auditoria_conta_grupo
	from	pls_auditoria_conta_grupo
	where	nr_seq_analise = nr_seq_analise_pc
	order by nr_seq_ordem desc;
	
BEGIN
for r_c01_w in c01(  nr_seq_fatura_p ) loop
	
	select	max(nr_seq_analise)
	into STRICT	nr_seq_analise_w
	from (SELECT	nr_seq_analise
		from	pls_conta_pos_proc
		where	nr_seq_conta 		= r_c01_w.nr_seq_conta
		and	nr_seq_lote_fat 	= r_c01_w.nr_seq_lote
		
union all

		SELECT	nr_seq_analise
		from	pls_conta_pos_mat
		where	nr_seq_conta 		= r_c01_w.nr_seq_conta
		and	nr_seq_lote_fat 	= r_c01_w.nr_seq_lote) alias2;
	
	if (nr_seq_analise_w IS NOT NULL AND nr_seq_analise_w::text <> '') then
		update	pls_conta_pos_proc
		set	ie_status_faturamento	= 'D',
			nr_seq_lote_fat		 = NULL,
			nr_seq_evento_fat	 = NULL,
			dt_atualizacao		= clock_timestamp(),
			nm_usuario		= nm_usuario_p
		where	nr_seq_analise		= nr_seq_analise_w
		and	nr_seq_lote_fat		= r_c01_w.nr_seq_lote;
		
		update	pls_conta_pos_mat
		set	ie_status_faturamento	= 'D',
			nr_seq_lote_fat		 = NULL,
			nr_seq_evento_fat	 = NULL,
			dt_atualizacao		= clock_timestamp(),
			nm_usuario		= nm_usuario_p
		where	nr_seq_analise		= nr_seq_analise_w
		and	nr_seq_lote_fat		= r_c01_w.nr_seq_lote;
		
		CALL pls_desfazer_fechar_conta_aud(nr_seq_analise_w,	cd_estabelecimento_p, nm_usuario_p);
		
		for r_c02_w in C02( nr_seq_analise_w ) loop
			CALL pls_desf_final_grupo_analise(nr_seq_analise_w, null, r_c02_w.nr_seq_auditoria_conta_grupo, nm_usuario_p, cd_estabelecimento_p, 'S');
		end loop;
	else
		update	pls_conta_pos_proc
		set	ie_status_faturamento	= 'D',
			nr_seq_lote_fat		 = NULL,
			nr_seq_evento_fat	 = NULL,
			dt_atualizacao		= clock_timestamp(),
			nm_usuario		= nm_usuario_p
		where	nr_seq_conta		= r_c01_w.nr_seq_conta
		and	nr_seq_lote_fat		= r_c01_w.nr_seq_lote;
		
		update	pls_conta_pos_mat
		set	ie_status_faturamento	= 'D',
			nr_seq_lote_fat		 = NULL,
			nr_seq_evento_fat	 = NULL,
			dt_atualizacao		= clock_timestamp(),
			nm_usuario		= nm_usuario_p
		where	nr_seq_conta		= r_c01_w.nr_seq_conta
		and	nr_seq_lote_fat		= r_c01_w.nr_seq_lote;
	end if;
end loop;

commit;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_faturamento_pck.altera_status_fatura ( nr_seq_fatura_p pls_fatura.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nr_seq_ajuste_gerado_p INOUT bigint, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;
