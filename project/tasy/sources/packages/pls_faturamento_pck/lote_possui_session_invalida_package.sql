-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pls_faturamento_pck.lote_possui_session_invalida ( nr_seq_lote_p pls_lote_faturamento.nr_sequencia%type) RETURNS varchar AS $body$
DECLARE


--Finalidade:	Verifica se o lote possui uma session valida:
--		1 - O lote deve possuir data de inicio de geracao
--		2 - O lote deve possuir a data de final de geracao NULA
--		3 - O lote deve possuir os identificadores de sessao informados
--		4 - O lote nao deve possuir uma sessao no banco conforme identificadores
--		5 - O Lote deve possuir o status "Em processamento"
qt_session_w	integer;
ds_retorno_w	varchar(1);


BEGIN

select	count(1)
into STRICT	qt_session_w
from	pls_lote_faturamento	a
where	(a.dt_inicio_ger_lote IS NOT NULL AND a.dt_inicio_ger_lote::text <> '')
and	coalesce(a.dt_fim_ger_lote::text, '') = ''
and	(a.nm_id_serial IS NOT NULL AND a.nm_id_serial::text <> '')
and	(a.nm_id_sid IS NOT NULL AND a.nm_id_sid::text <> '')
and	a.ie_status		= 2 -- Em processamento
and	a.nr_sequencia		= nr_seq_lote_p
and	not exists (	SELECT	1
					from	v$session	x
					where	x.serial#	= a.nm_id_serial
					and	x.sid		= nm_id_sid);

if (qt_session_w = 0) then

	ds_retorno_w := 'N';
else
	ds_retorno_w := 'S';
end if;

return ds_retorno_w;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pls_faturamento_pck.lote_possui_session_invalida ( nr_seq_lote_p pls_lote_faturamento.nr_sequencia%type) FROM PUBLIC;
