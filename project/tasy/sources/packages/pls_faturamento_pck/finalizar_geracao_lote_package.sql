-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


-- Finalizar a geracao do lote de faturamento
CREATE OR REPLACE PROCEDURE pls_faturamento_pck.finalizar_geracao_lote ( nr_seq_lote_p pls_lote_faturamento.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
BEGIN
update	pls_lote_faturamento
set	dt_geracao 		= clock_timestamp(),
	dt_atualizacao		= clock_timestamp(),
	nm_usuario		= nm_usuario_p
where	nr_sequencia		= nr_seq_lote_p;

CALL pls_faturamento_pck.altera_status_gerado_lote(nr_seq_lote_p,nm_usuario_p);

-- Calculo do total de contas e itens vinculados ao lote de faturamento
CALL pls_faturamento_pck.calcular_processamento( nr_seq_lote_p, 'CV');

-- Insere o tempo de geracao do lote no historico
update	pls_fatura_log
set	ds_log		= substr(ds_log || ' - '||wheb_mensagem_pck.get_texto(1108921)||' '||pls_obter_dif_data_horario(current_setting('pls_faturamento_pck.dt_inicio_geracao_w')::timestamp,clock_timestamp()) || chr(10) || current_setting('pls_faturamento_pck.ds_log_w')::pls_fatura_log.ds_log%type,1,4000)
where	nr_sequencia	= (	SELECT	max(nr_sequencia)
				from 	pls_fatura_log
				where 	ie_opcao = 'GL'
				and 	nr_seq_lote = nr_seq_lote_p);

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_faturamento_pck.finalizar_geracao_lote ( nr_seq_lote_p pls_lote_faturamento.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;
