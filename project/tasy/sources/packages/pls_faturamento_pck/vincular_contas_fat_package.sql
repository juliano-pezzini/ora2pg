-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_faturamento_pck.vincular_contas_fat ( nr_seq_lote_p pls_lote_faturamento.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type, ie_processo_p text, nr_seq_pos_proc_p pls_conta_pos_proc.nr_sequencia%type, nr_seq_pos_mat_p pls_conta_pos_mat.nr_sequencia%type, nr_seq_evento_fat_p pls_evento_faturamento.nr_sequencia%type) AS $body$
DECLARE

				
-- Quantidade 'pls_regra_lib_fat'
qt_pls_regra_lib_fat_w		integer;

-- Quantidade 'pls_lote_fat_adic'
qt_pls_lote_fat_adic_conta_w	integer;
qt_pls_lote_fat_adic_contr_w	integer;
qt_pls_lote_fat_adic_coope_w	integer;
qt_pls_lote_fat_adic_inter_w	integer;
qt_pls_lote_fat_adic_proto_w	integer;
qt_pls_lote_fat_adic_refer_w	integer;

-- Sql dinamico
ds_sql_contas_faturamento_w	varchar(10000);
ds_sql_contas_fat_pro_w		varchar(10000);
ds_sql_contas_fat_mat_w		varchar(10000);
ds_sql_campos_pro_w		varchar(10000);
ds_sql_campos_mat_w		varchar(10000);

-- Restricoes para o sql dinamico
ds_filtro_contas_faturamento_w	varchar(10000);

-- Cursor para o sql dinamico
cursor_pro_w			sql_pck.t_cursor;
cursor_mat_w			sql_pck.t_cursor;

-- Binds para o sql dinamico
valor_bind_w			sql_pck.t_dado_bind;
valor_bind_pro_w		sql_pck.t_dado_bind;
valor_bind_mat_w		sql_pck.t_dado_bind;

-- Procedimento e Material
tb_nr_seq_conta_w		pls_util_cta_pck.t_number_table;
tb_nr_seq_segurado_w		pls_util_cta_pck.t_number_table;
tb_dt_emissao_w			pls_util_cta_pck.t_date_table;
tb_nr_seq_congenere_w		pls_util_cta_pck.t_number_table;
tb_dt_atendimento_w		pls_util_cta_pck.t_date_table;
tb_ie_tipo_guia_w		pls_util_cta_pck.t_varchar2_table_1;
tb_dt_internacao_w		pls_util_cta_pck.t_date_table;
tb_cd_guia_ok_w			pls_util_cta_pck.t_varchar2_table_20;
tb_ie_prestador_a400_w		pls_util_cta_pck.t_varchar2_table_1;
tb_ie_origem_conta_w		pls_util_cta_pck.t_varchar2_table_1;
tb_ie_tipo_guia_princ_w		pls_util_cta_pck.t_varchar2_table_2;
tb_nr_seq_tipo_atendimento_w	pls_util_cta_pck.t_number_table;
tb_nr_seq_tipo_conta_w		pls_util_cta_pck.t_number_table;
tb_ie_tipo_segurado_w		pls_util_cta_pck.t_varchar2_table_3;
tb_ie_internado_w		pls_util_cta_pck.t_varchar2_table_1;
tb_ie_tipo_intercambio_w	pls_util_cta_pck.t_varchar2_table_10;
tb_ie_tipo_conta_w		pls_util_cta_pck.t_varchar2_table_10;
tb_ie_pcmso_w			pls_util_cta_pck.t_varchar2_table_1;
tb_nr_seq_plano_w		pls_util_cta_pck.t_number_table;
tb_nr_seq_classificacao_sca_w	pls_util_cta_pck.t_number_table;
tb_nr_seq_grupo_rec_w		pls_util_cta_pck.t_number_table;
tb_ie_preco_w			pls_util_cta_pck.t_varchar2_table_2;
tb_dt_atendimento_referencia_w	pls_util_cta_pck.t_date_table;
tb_nr_seq_tipo_prestador_w	pls_util_cta_pck.t_number_table;
tb_ie_tipo_pessoa_prest_w	pls_util_cta_pck.t_varchar2_table_1;
tb_ie_tipo_relacao_w		pls_util_cta_pck.t_varchar2_table_2;
tb_nr_seq_classif_prest_w	pls_util_cta_pck.t_number_table;
tb_ie_ato_cooperado_w		pls_util_cta_pck.t_varchar2_table_1;
tb_ie_apresentacao_prot_w	pls_util_cta_pck.t_varchar2_table_3;
tb_ie_tipo_pes_prest_atend_w	pls_util_cta_pck.t_varchar2_table_1;
tb_ie_tipo_pessoa_prest_ptu_w	pls_util_cta_pck.t_varchar2_table_1;
tb_ie_tipo_pes_prest_solic_w	pls_util_cta_pck.t_varchar2_table_1;
tb_ie_origem_analise_pos_w	pls_util_cta_pck.t_number_table;
tb_cd_guia_referencia_w		pls_util_cta_pck.t_varchar2_table_20;
tb_vl_item_w			pls_util_cta_pck.t_number_table;
tb_vl_item_ndc_w		pls_util_cta_pck.t_number_table;
tb_nr_seq_regra_inter_w		pls_util_cta_pck.t_number_table;
tb_dt_alta_w			pls_util_cta_pck.t_date_table;
tb_ie_origem_protocolo_w	pls_util_cta_pck.t_varchar2_table_1;
tb_ie_tipo_protocolo_w		pls_util_cta_pck.t_varchar2_table_3;
tb_ie_ato_cooperado_pag_w	pls_util_cta_pck.t_varchar2_table_1;
tb_ie_tipo_pessoa_prest_pag_w	pls_util_cta_pck.t_varchar2_table_1;
tb_cd_usuario_plano_w		pls_util_cta_pck.t_varchar2_table_50;
tb_nr_seq_pagador_w		pls_util_cta_pck.t_number_table;
tb_nr_seq_contrato_w		pls_util_cta_pck.t_number_table;
tb_nr_seq_intercambio_w		pls_util_cta_pck.t_number_table;
tb_nr_seq_ops_congenere_w	pls_util_cta_pck.t_number_table;
tb_ie_fat_data_alt_pre_w	pls_util_cta_pck.t_varchar2_table_1;
tb_nr_seq_protocolo_w		pls_util_cta_pck.t_number_table;
tb_nr_seq_congenere_prot_w	pls_util_cta_pck.t_number_table;
tb_nr_seq_conta_princ_w		pls_util_cta_pck.t_number_table;

-- Procedimento
tb_nr_seq_conta_proc_w		pls_util_cta_pck.t_number_table;
tb_nr_seq_conta_pos_proc_w	pls_util_cta_pck.t_number_table;
tb_nr_seq_pos_proc_fat_w	pls_util_cta_pck.t_number_table;
tb_cd_procedimento_w		pls_util_cta_pck.t_number_table;
tb_ie_origem_proced_w		pls_util_cta_pck.t_number_table;
tb_cd_area_procedimento_w	pls_util_cta_pck.t_number_table;
tb_cd_especialidade_w		pls_util_cta_pck.t_number_table;
tb_cd_grupo_proc_w		pls_util_cta_pck.t_number_table;
tb_ie_tipo_despesa_w		pls_util_cta_pck.t_varchar2_table_1;
tb_cd_prestador_w		pls_util_cta_pck.t_varchar2_table_50;
tb_nr_seq_prestador_exec_w	pls_util_cta_pck.t_number_table;
tb_nr_seq_prestador_pgto_w	pls_util_cta_pck.t_number_table;

-- Material
tb_nr_seq_conta_mat_w		pls_util_cta_pck.t_number_table;
tb_nr_seq_conta_pos_mat_w	pls_util_cta_pck.t_number_table;
tb_nr_seq_pos_mat_fat_w		pls_util_cta_pck.t_number_table;
tb_nr_seq_material_w		pls_util_cta_pck.t_number_table;

-- Caso o cliente nao filtre nenhuma data
dt_ref_ini_w			timestamp := trunc(add_months(current_setting('pls_faturamento_pck.dt_mesano_referencia_w')::pls_lote_faturamento.dt_mesano_referencia%type,-70));
dt_ref_fim_w			timestamp := trunc(last_day(current_setting('pls_faturamento_pck.dt_mesano_referencia_w')::pls_lote_faturamento.dt_mesano_referencia%type)) + 86399/86400;


BEGIN

CALL CALL CALL CALL CALL CALL pls_faturamento_pck.carrega_parametros(nr_seq_lote_p, cd_estabelecimento_p);

-- Vincular contas pendentes
if (nr_seq_pos_proc_p IS NOT NULL AND nr_seq_pos_proc_p::text <> '') then
	ds_filtro_contas_faturamento_w	:= ds_filtro_contas_faturamento_w || ' and a.nr_sequencia = :nr_seq_pos_proc ';
	valor_bind_w := sql_pck.bind_variable(':nr_seq_pos_proc', nr_seq_pos_proc_p, valor_bind_w);
end if;

-- Vincular contas pendentes
if (nr_seq_pos_mat_p IS NOT NULL AND nr_seq_pos_mat_p::text <> '') then
	ds_filtro_contas_faturamento_w	:= ds_filtro_contas_faturamento_w || ' and a.nr_sequencia = :nr_seq_pos_mat ';
	valor_bind_w := sql_pck.bind_variable(':nr_seq_pos_mat', nr_seq_pos_mat_p, valor_bind_w);
end if;

-- Se nao for vinculacao manual de contas pendentes ou tratamaneto de conta fechada
if (ie_processo_p not in ('VM','CF')) then
	-- Busca a quantidade de regras cadastradas em 'OPS - Faturamento / Cadastros / Regra liberacao fatura'
	select	count(1)
	into STRICT	qt_pls_regra_lib_fat_w
	from	pls_regra_lib_fat
	where	cd_estabelecimento = cd_estabelecimento_p;

	-- Busca as regras do adicionais do lote de faturamento
	select	count(nr_seq_conta),
		count(nr_seq_contrato),
		count(nr_seq_cooperativa),
		count(nr_seq_intercambio),
		count(nr_seq_protocolo),
		count(cd_guia_referencia)
	into STRICT	qt_pls_lote_fat_adic_conta_w,
		qt_pls_lote_fat_adic_contr_w,
		qt_pls_lote_fat_adic_coope_w,
		qt_pls_lote_fat_adic_inter_w,
		qt_pls_lote_fat_adic_proto_w,
		qt_pls_lote_fat_adic_refer_w
	from	pls_lote_fat_adic
	where	nr_seq_lote = nr_seq_lote_p;

	if (current_setting('pls_faturamento_pck.ie_pos_estab_faturamento_w')::pls_parametros.ie_pos_estab_faturamento%type = 'S') then
		ds_filtro_contas_faturamento_w	:= ds_filtro_contas_faturamento_w || ' and ((b.ie_tipo_conta in (''O'', ''C'', ''I'')) or (z.ie_tipo_protocolo = ''R'')) ' || pls_util_pck.enter_w;

	elsif (current_setting('pls_faturamento_pck.ie_pos_estab_faturamento_w')::pls_parametros.ie_pos_estab_faturamento%type = 'N') then
		ds_filtro_contas_faturamento_w	:= ds_filtro_contas_faturamento_w || ' and ((b.ie_tipo_conta = ''C'') or (z.ie_tipo_protocolo = ''R'')) ' || pls_util_pck.enter_w;

	elsif (current_setting('pls_faturamento_pck.ie_pos_estab_faturamento_w')::pls_parametros.ie_pos_estab_faturamento%type = 'R') then
		ds_filtro_contas_faturamento_w	:= ds_filtro_contas_faturamento_w || ' and pls_obter_forma_cobr_pos_estab(:cd_estabelecimento, nvl(b.ie_tipo_segurado_cta,d.ie_tipo_segurado)) = ''F'' ' || pls_util_pck.enter_w;
	end if;

	if (current_setting('pls_faturamento_pck.dt_inicio_referencia_w')::pls_lote_faturamento.dt_inicio_referencia%(type IS NOT NULL AND type::text <> '')) then
		ds_filtro_contas_faturamento_w	:= ds_filtro_contas_faturamento_w || ' and z.dt_mes_competencia >= :dt_comp_inicial_lote ' || pls_util_pck.enter_w;
		valor_bind_w := sql_pck.bind_variable(':dt_comp_inicial_lote', current_setting('pls_faturamento_pck.dt_inicio_referencia_w')::pls_lote_faturamento.dt_inicio_referencia%type, valor_bind_w);
	end if;

	if (current_setting('pls_faturamento_pck.dt_fim_referencia_w')::pls_lote_faturamento.dt_fim_referencia%(type IS NOT NULL AND type::text <> '')) then
		ds_filtro_contas_faturamento_w	:= ds_filtro_contas_faturamento_w || ' and z.dt_mes_competencia <= :dt_comp_final_lote ' || pls_util_pck.enter_w;
		valor_bind_w := sql_pck.bind_variable(':dt_comp_final_lote', current_setting('pls_faturamento_pck.dt_fim_referencia_w')::pls_lote_faturamento.dt_fim_referencia%type, valor_bind_w, sql_pck.b_data_hora);
	end if;
	
	-- Caso nao tenha informado o periodo de mes referencia e fechamento, entao e limitado pelo mes competencia (12 meses)
	if (current_setting('pls_faturamento_pck.dt_inicio_referencia_w')::pls_lote_faturamento.dt_inicio_referencia%coalesce(type::text, '') = '') and (current_setting('pls_faturamento_pck.dt_fim_referencia_w')::pls_lote_faturamento.dt_fim_referencia%coalesce(type::text, '') = '') and (current_setting('pls_faturamento_pck.dt_inicial_fechamento_w')::pls_lote_faturamento.dt_inicial_fechamento%coalesce(type::text, '') = '') and (current_setting('pls_faturamento_pck.dt_final_fechamento_w')::pls_lote_faturamento.dt_final_fechamento%coalesce(type::text, '') = '') and (current_setting('pls_faturamento_pck.dt_mesano_referencia_w')::pls_lote_faturamento.dt_mesano_referencia%(type IS NOT NULL AND type::text <> '')) then
		PERFORM set_config('pls_faturamento_pck.dt_inicial_fechamento_w', dt_ref_ini_w, false);
		PERFORM set_config('pls_faturamento_pck.dt_final_fechamento_w', dt_ref_fim_w, false);
	end if;

	if (current_setting('pls_faturamento_pck.ie_data_fat_ref_w')::pls_parametro_faturamento.ie_data_fat_ref%type = 'DA') then
		if (current_setting('pls_faturamento_pck.dt_inicial_fechamento_w')::pls_lote_faturamento.dt_inicial_fechamento%(type IS NOT NULL AND type::text <> '')) then
			ds_filtro_contas_faturamento_w	:= ds_filtro_contas_faturamento_w || ' and b.dt_atualizacao >= :dt_fechamento_inicial_lote ' || pls_util_pck.enter_w;
			valor_bind_w := sql_pck.bind_variable(':dt_fechamento_inicial_lote', current_setting('pls_faturamento_pck.dt_inicial_fechamento_w')::pls_lote_faturamento.dt_inicial_fechamento%type, valor_bind_w);
		end if;
		
		if (current_setting('pls_faturamento_pck.dt_final_fechamento_w')::pls_lote_faturamento.dt_final_fechamento%(type IS NOT NULL AND type::text <> '')) then
			ds_filtro_contas_faturamento_w	:= ds_filtro_contas_faturamento_w || ' and b.dt_atualizacao <= :dt_fechamento_final_lote ' || pls_util_pck.enter_w;
			valor_bind_w := sql_pck.bind_variable(':dt_fechamento_final_lote', current_setting('pls_faturamento_pck.dt_final_fechamento_w')::pls_lote_faturamento.dt_final_fechamento%type, valor_bind_w, sql_pck.b_data_hora);
		end if;
		
	elsif (current_setting('pls_faturamento_pck.ie_data_fat_ref_w')::pls_parametro_faturamento.ie_data_fat_ref%type = 'DF') then
		if (current_setting('pls_faturamento_pck.dt_inicial_fechamento_w')::pls_lote_faturamento.dt_inicial_fechamento%(type IS NOT NULL AND type::text <> '')) then
			ds_filtro_contas_faturamento_w	:= ds_filtro_contas_faturamento_w || ' and b.dt_fechamento_conta >= :dt_fechamento_inicial_lote ' || pls_util_pck.enter_w;
			valor_bind_w := sql_pck.bind_variable(':dt_fechamento_inicial_lote', current_setting('pls_faturamento_pck.dt_inicial_fechamento_w')::pls_lote_faturamento.dt_inicial_fechamento%type, valor_bind_w);
		end if;
		
		if (current_setting('pls_faturamento_pck.dt_final_fechamento_w')::pls_lote_faturamento.dt_final_fechamento%(type IS NOT NULL AND type::text <> '')) then
			ds_filtro_contas_faturamento_w	:= ds_filtro_contas_faturamento_w || ' and b.dt_fechamento_conta <= :dt_fechamento_final_lote ' || pls_util_pck.enter_w;
			valor_bind_w := sql_pck.bind_variable(':dt_fechamento_final_lote', current_setting('pls_faturamento_pck.dt_final_fechamento_w')::pls_lote_faturamento.dt_final_fechamento%type, valor_bind_w, sql_pck.b_data_hora);
		end if;
		
	elsif (current_setting('pls_faturamento_pck.ie_data_fat_ref_w')::pls_parametro_faturamento.ie_data_fat_ref%type = 'DFA') then
		if (current_setting('pls_faturamento_pck.dt_inicial_fechamento_w')::pls_lote_faturamento.dt_inicial_fechamento%(type IS NOT NULL AND type::text <> '')) then												
			ds_filtro_contas_faturamento_w	:= ds_filtro_contas_faturamento_w || ' and	exists(	select	1 ' 									|| pls_util_pck.enter_w ||
												'		from	pls_analise_conta analise ' 						|| pls_util_pck.enter_w ||
												'		where	analise.nr_sequencia = a.nr_seq_analise ' 				|| pls_util_pck.enter_w ||
												'		and	fim_dia(analise.dt_final_analise) >= :dt_fechamento_inicial_lote ' 	|| pls_util_pck.enter_w ||
												'		union all ' 									|| pls_util_pck.enter_w ||
												'		select	1 ' 									|| pls_util_pck.enter_w ||
												'		from	pls_conta		cc, '						|| pls_util_pck.enter_w ||
												'			pls_protocolo_conta	pp ' 						|| pls_util_pck.enter_w ||
												'		where	pp.nr_sequencia		= cc.nr_seq_protocolo '				|| pls_util_pck.enter_w ||
												'		and	cc.nr_sequencia		= a.nr_seq_conta ' 				|| pls_util_pck.enter_w ||
												'		and	pp.ie_tipo_protocolo	= ''R'' ' 					|| pls_util_pck.enter_w ||
												'		and	fim_dia(cc.dt_fechamento_conta) >= :dt_fechamento_inicial_lote) '	|| pls_util_pck.enter_w;
			valor_bind_w := sql_pck.bind_variable(':dt_fechamento_inicial_lote', current_setting('pls_faturamento_pck.dt_inicial_fechamento_w')::pls_lote_faturamento.dt_inicial_fechamento%type, valor_bind_w);
		end if;
		
		if (current_setting('pls_faturamento_pck.dt_final_fechamento_w')::pls_lote_faturamento.dt_final_fechamento%(type IS NOT NULL AND type::text <> '')) then												
			ds_filtro_contas_faturamento_w	:= ds_filtro_contas_faturamento_w || ' and	exists(	select	1 ' 									|| pls_util_pck.enter_w ||
												'		from	pls_analise_conta analise ' 						|| pls_util_pck.enter_w ||
												'		where	analise.nr_sequencia = a.nr_seq_analise ' 				|| pls_util_pck.enter_w ||
												'		and	fim_dia(analise.dt_final_analise) <= :dt_fechamento_final_lote ' 	|| pls_util_pck.enter_w ||
												'		union all ' 									|| pls_util_pck.enter_w ||
												'		select	1 ' 									|| pls_util_pck.enter_w ||
												'		from	pls_conta		cc, '						|| pls_util_pck.enter_w ||
												'			pls_protocolo_conta	pp ' 						|| pls_util_pck.enter_w ||
												'		where	pp.nr_sequencia		= cc.nr_seq_protocolo '				|| pls_util_pck.enter_w ||
												'		and	cc.nr_sequencia		= a.nr_seq_conta ' 				|| pls_util_pck.enter_w ||
												'		and	pp.ie_tipo_protocolo	= ''R'' ' 					|| pls_util_pck.enter_w ||
												'		and	fim_dia(cc.dt_fechamento_conta) <= :dt_fechamento_final_lote) '		|| pls_util_pck.enter_w;
			
			valor_bind_w := sql_pck.bind_variable(':dt_fechamento_final_lote', current_setting('pls_faturamento_pck.dt_final_fechamento_w')::pls_lote_faturamento.dt_final_fechamento%type, valor_bind_w, sql_pck.b_data_hora);
		end if;
	end if;

	if (current_setting('pls_faturamento_pck.ie_contas_faturar_w')::pls_parametro_faturamento.ie_contas_faturar%type <> 'CF') then
		ds_filtro_contas_faturamento_w	:= ds_filtro_contas_faturamento_w || ' and z.ie_status in (''3'', ''4'', ''6'', ''7'') ' || pls_util_pck.enter_w;
	end if;

	if (current_setting('pls_faturamento_pck.nr_seq_protocolo_w')::pls_lote_faturamento.nr_seq_protocolo%(type IS NOT NULL AND type::text <> '')) then
		ds_filtro_contas_faturamento_w	:= ds_filtro_contas_faturamento_w || ' and z.nr_sequencia = :nr_seq_protocolo ' || pls_util_pck.enter_w;
		valor_bind_w := sql_pck.bind_variable(':nr_seq_protocolo', current_setting('pls_faturamento_pck.nr_seq_protocolo_w')::pls_lote_faturamento.nr_seq_protocolo%type, valor_bind_w);
	end if;

	if (current_setting('pls_faturamento_pck.ie_apresentacao_prot_w')::pls_lote_faturamento.ie_apresentacao_prot%type <> 'T') then
		ds_filtro_contas_faturamento_w	:= ds_filtro_contas_faturamento_w || ' and z.ie_apresentacao = :ie_apresentacao_prot ' || pls_util_pck.enter_w;
		valor_bind_w := sql_pck.bind_variable(':ie_apresentacao_prot', current_setting('pls_faturamento_pck.ie_apresentacao_prot_w')::pls_lote_faturamento.ie_apresentacao_prot%type, valor_bind_w);
	end if;

	if (qt_pls_lote_fat_adic_conta_w > 0) then
		ds_filtro_contas_faturamento_w	:= ds_filtro_contas_faturamento_w || 	'  and  exists(	select 	1 ' || pls_util_pck.enter_w ||
											'		from	pls_lote_fat_adic y ' || pls_util_pck.enter_w ||
											'		where	y.nr_seq_conta = b.nr_sequencia' || pls_util_pck.enter_w ||
											'		and	y.nr_seq_lote = :nr_seq_lote ' || pls_util_pck.enter_w ||
											'		and	y.nr_seq_conta is not null) ' || pls_util_pck.enter_w;
	end if;

	if (qt_pls_lote_fat_adic_contr_w > 0) then
		ds_filtro_contas_faturamento_w	:= ds_filtro_contas_faturamento_w || 	'  and  exists(	select	1' || pls_util_pck.enter_w ||
											'		from	pls_lote_fat_adic y ' || pls_util_pck.enter_w ||
											'		where	y.nr_seq_lote = :nr_seq_lote ' || pls_util_pck.enter_w ||
											'		and	y.nr_seq_contrato = c.nr_seq_contrato ' || pls_util_pck.enter_w ||
											'		and	y.nr_seq_contrato is not null) ' || pls_util_pck.enter_w;
	end if;

	if (qt_pls_lote_fat_adic_coope_w > 0) then
		ds_filtro_contas_faturamento_w	:= ds_filtro_contas_faturamento_w || 	'  and	exists(	select 	1 ' || pls_util_pck.enter_w ||
											'		from	pls_lote_fat_adic y ' || pls_util_pck.enter_w ||
											'		where	y.nr_seq_lote = :nr_seq_lote ' || pls_util_pck.enter_w ||
											'		and	y.nr_seq_cooperativa = d.nr_seq_ops_congenere ' || pls_util_pck.enter_w ||
											'		union all ' || pls_util_pck.enter_w ||
											'		select	1 ' || pls_util_pck.enter_w ||
											'		from	pls_lote_fat_adic y ' || pls_util_pck.enter_w ||
											'		where	y.nr_seq_lote = :nr_seq_lote ' || pls_util_pck.enter_w ||
											'		and	y.nr_seq_cooperativa = d.nr_seq_congenere) ' || pls_util_pck.enter_w;
	end if;

	if (qt_pls_lote_fat_adic_inter_w > 0) then
		ds_filtro_contas_faturamento_w	:= ds_filtro_contas_faturamento_w || 	'  and  exists(	select	1' || pls_util_pck.enter_w ||
											'		from	pls_lote_fat_adic y ' || pls_util_pck.enter_w ||
											'		where	y.nr_seq_lote = :nr_seq_lote ' || pls_util_pck.enter_w ||
											'		and	y.nr_seq_intercambio = d.nr_seq_intercambio' || pls_util_pck.enter_w ||
											'		and	y.nr_seq_intercambio is not null) ' || pls_util_pck.enter_w;
	end if;

	if (qt_pls_lote_fat_adic_proto_w > 0) then
		ds_filtro_contas_faturamento_w	:= ds_filtro_contas_faturamento_w || 	'  and	exists(	select	1' || pls_util_pck.enter_w ||
											'		from	pls_lote_fat_adic y ' || pls_util_pck.enter_w ||
											'		where	y.nr_seq_lote = :nr_seq_lote ' || pls_util_pck.enter_w ||
											'		and	y.nr_seq_protocolo = z.nr_sequencia ' || pls_util_pck.enter_w ||
											'		and	y.nr_seq_protocolo is not null) ' || pls_util_pck.enter_w;
	end if;

	if (qt_pls_lote_fat_adic_refer_w > 0) then
		ds_filtro_contas_faturamento_w	:= ds_filtro_contas_faturamento_w || 	'  and	exists(	select	1' || pls_util_pck.enter_w ||
											'		from	pls_lote_fat_adic y ' || pls_util_pck.enter_w ||
											'		where	y.nr_seq_lote = :nr_seq_lote ' || pls_util_pck.enter_w ||
											'		and	y.cd_guia_referencia = b.cd_guia_referencia ' || pls_util_pck.enter_w ||
											'		and	y.cd_guia_referencia is not null) ' || pls_util_pck.enter_w;
	end if;

	if (qt_pls_lote_fat_adic_conta_w > 0) or (qt_pls_lote_fat_adic_contr_w > 0) or (qt_pls_lote_fat_adic_coope_w > 0) or (qt_pls_lote_fat_adic_inter_w > 0) or (qt_pls_lote_fat_adic_proto_w > 0) or (qt_pls_lote_fat_adic_refer_w > 0) then
		valor_bind_w := sql_pck.bind_variable(':nr_seq_lote', nr_seq_lote_p, valor_bind_w);
	end if;
end if;

-- create index PLSPPROC_I1 on pls_conta_pos_proc (nvl(nr_seq_evento_fat, 0));
-- create index PLSPPROC_I2 on pls_conta_pos_proc (nvl(nr_seq_lote_fat, 0));
-- create index PLSCPM_I1 on pls_conta_pos_mat (nvl(nr_seq_evento_fat, 0));
-- create index PLSCPM_I2 on pls_conta_pos_mat (nvl(nr_seq_lote_fat, 0));
-- create index PLSMSI_I20 ON pls_mensalidade_seg_item (nr_seq_conta, ie_tipo_item); 
ds_sql_campos_pro_w :=		'select b.nr_sequencia, '															|| pls_util_pck.enter_w ||
				'	b.nr_seq_segurado, ' 															|| pls_util_pck.enter_w ||
				'	b.dt_emissao, '																|| pls_util_pck.enter_w ||
				'	d.nr_seq_congenere, ' 															|| pls_util_pck.enter_w ||
				'	nvl(b.dt_atendimento, b.dt_atendimento_referencia), '											|| pls_util_pck.enter_w ||
				'	b.ie_tipo_guia, ' 															|| pls_util_pck.enter_w ||
				'	nvl(b.dt_inicio_faturamento, b.dt_entrada), ' 												|| pls_util_pck.enter_w ||
				'	b.cd_guia_ok, ' 															|| pls_util_pck.enter_w ||
				'	pls_faturamento_pck.obter_se_prest_a400( b.nr_seq_prestador_exec, :ie_consiste_prest), '						|| pls_util_pck.enter_w ||
				'	b.ie_origem_conta, ' 															|| pls_util_pck.enter_w ||
				'	a.nr_seq_conta_proc, '															|| pls_util_pck.enter_w ||
				'	a.nr_sequencia, '															|| pls_util_pck.enter_w ||
				'	c.nr_sequencia, '															|| pls_util_pck.enter_w ||
				'	(select	max(k.ie_tipo_guia) from pls_conta k where k.nr_sequencia = b.nr_seq_conta_princ), '						|| pls_util_pck.enter_w ||
				'	b.nr_seq_tipo_atendimento, '														|| pls_util_pck.enter_w ||
				'	b.nr_seq_tipo_conta, '															|| pls_util_pck.enter_w ||
				'	nvl((select max(k.ie_tipo_segurado) from pls_conta k where k.nr_sequencia = b.nr_seq_conta_princ), '					|| pls_util_pck.enter_w ||
				'						nvl(b.ie_tipo_segurado_cta,d.ie_tipo_segurado)) ie_tipo_segurado, '				|| pls_util_pck.enter_w ||
				'	b.ie_internado, '															|| pls_util_pck.enter_w ||
				'	pls_obter_tipo_intercambio( '														|| pls_util_pck.enter_w ||
				'		decode(pls_obter_tipo_congenere( '												|| pls_util_pck.enter_w ||
				'			nvl(d.nr_seq_ops_congenere, d.nr_seq_congenere)), ''OP'', '								|| pls_util_pck.enter_w ||
				'				decode(nvl(b.ie_tipo_segurado_cta,d.ie_tipo_segurado), ''T'', nvl(z.nr_seq_congenere, nvl(d.nr_seq_ops_congenere, '	|| pls_util_pck.enter_w ||
				'					d.nr_seq_congenere)), nvl(d.nr_seq_ops_congenere, d.nr_seq_congenere)), '				|| pls_util_pck.enter_w ||
				'						nvl(d.nr_seq_ops_congenere, d.nr_seq_congenere)), :cd_estabelecimento), '			|| pls_util_pck.enter_w ||
				'	b.ie_tipo_conta, ' 															|| pls_util_pck.enter_w ||
				'	nvl(decode(b.nr_seq_guia, null, d.ie_pcmso, decode(b.nr_seq_segurado, (select h.nr_seq_segurado from pls_conta h '			|| pls_util_pck.enter_w ||
				'		where h.nr_sequencia = y.nr_seq_conta), nvl((select max(y.ie_pcmso) from pls_requisicao y, pls_execucao_req_item w '		|| pls_util_pck.enter_w ||
				'			where w.nr_seq_requisicao = y.nr_sequencia and w.nr_seq_guia = b.nr_seq_guia), d.ie_pcmso), d.ie_pcmso)), ''N''), '	|| pls_util_pck.enter_w ||
				'	d.nr_seq_plano, ' 															|| pls_util_pck.enter_w ||
				'	e.nr_seq_classificacao, '														|| pls_util_pck.enter_w ||
				'	y.ie_tipo_despesa, '															|| pls_util_pck.enter_w ||
				'	y.cd_procedimento, '															|| pls_util_pck.enter_w ||
				'	(select	max(h.cd_area_procedimento) '													|| pls_util_pck.enter_w ||
				'	from	estrutura_procedimento_v	h '												|| pls_util_pck.enter_w ||
				'	where	h.ie_origem_proced		= y.ie_origem_proced '										|| pls_util_pck.enter_w ||
				'	and	h.cd_procedimento		= y.cd_procedimento), '										|| pls_util_pck.enter_w ||
				'	(select	max(h.cd_especialidade) '													|| pls_util_pck.enter_w ||
				'	from	estrutura_procedimento_v	h '												|| pls_util_pck.enter_w ||
				'	where	h.ie_origem_proced		= y.ie_origem_proced '										|| pls_util_pck.enter_w ||
				'	and	h.cd_procedimento		= y.cd_procedimento), '										|| pls_util_pck.enter_w ||
				'	(select	max(h.cd_grupo_proc) '														|| pls_util_pck.enter_w ||
				'	from	estrutura_procedimento_v	h '												|| pls_util_pck.enter_w ||
				'	where	h.ie_origem_proced		= y.ie_origem_proced '										|| pls_util_pck.enter_w ||
				'	and	h.cd_procedimento		= y.cd_procedimento), '										|| pls_util_pck.enter_w ||
				'	e.ie_preco, '																|| pls_util_pck.enter_w ||
				'	(select	max(h.nr_seq_grupo_rec) ' 													|| pls_util_pck.enter_w ||
				'	from	procedimento			h '												|| pls_util_pck.enter_w ||
				'	where	h.ie_origem_proced		= y.ie_origem_proced '										|| pls_util_pck.enter_w ||
				'	and	h.cd_procedimento		= y.cd_procedimento), '										|| pls_util_pck.enter_w ||
				'	y.dt_procedimento_referencia, '														|| pls_util_pck.enter_w ||
				'	(select	max(h.cd_prestador) from pls_prestador h where h.nr_sequencia = b.nr_seq_prestador_exec), '					|| pls_util_pck.enter_w ||
				'	(select	max(h.nr_seq_tipo_prestador) from pls_prestador h where h.nr_sequencia = b.nr_seq_prestador_exec), '				|| pls_util_pck.enter_w ||
				'	(select	max(decode(h.cd_pessoa_fisica, null, ''J'', ''F'')) from pls_prestador h where h.nr_sequencia = b.nr_seq_prestador_exec), '	|| pls_util_pck.enter_w ||
				'	(select	max(h.ie_tipo_relacao) from pls_prestador h where h.nr_sequencia = b.nr_seq_prestador_exec), '					|| pls_util_pck.enter_w ||
				'	decode(c.nr_seq_prestador_pgto,null, '													|| pls_util_pck.enter_w ||
				'		(select max(h.nr_seq_classificacao) from pls_prestador h where h.nr_sequencia = b.nr_seq_prestador_exec), '			|| pls_util_pck.enter_w ||
				'		(select max(h.nr_seq_classificacao) from pls_prestador h where h.nr_sequencia = c.nr_seq_prestador_pgto)), '			|| pls_util_pck.enter_w ||
				'	c.ie_ato_cooperado, '															|| pls_util_pck.enter_w ||
				'	b.nr_seq_prestador_exec, '														|| pls_util_pck.enter_w ||
				'	c.nr_seq_prestador_pgto, '														|| pls_util_pck.enter_w ||
				'	z.ie_apresentacao, '															|| pls_util_pck.enter_w ||
				'	(select decode(h.cd_cgc, null, ''F'', ''J'') from pls_prestador h where h.nr_sequencia = z.nr_seq_prestador), '				|| pls_util_pck.enter_w ||
				'	decode(a.nr_seq_regra_tx_opme, null,pls_faturamento_pck.obter_tipo_pes_prest_ptu( y.nr_sequencia, null, b.nr_sequencia, '		|| pls_util_pck.enter_w ||
												' b.ie_origem_conta, b.nr_seq_conta_princ, y.nr_seq_proc_princ), ''J''), '	|| pls_util_pck.enter_w ||
				'	(select	max(decode(m.cd_cgc, null, ''F'', ''J'')) '											|| pls_util_pck.enter_w ||
				'	from	pls_guia_plano	n, '														|| pls_util_pck.enter_w ||
				'		pls_prestador	m '														|| pls_util_pck.enter_w ||
				'	where	m.nr_sequencia	= n.nr_seq_prestador '												|| pls_util_pck.enter_w ||
				'	and	n.nr_sequencia 	= b.nr_seq_guia), '												|| pls_util_pck.enter_w ||
				'	decode(a.nr_seq_analise, null, decode(b.nr_seq_conta_rec, null, null, 8), '								|| pls_util_pck.enter_w ||
				'		(select	nvl(max(h.ie_origem_analise), 2) from pls_analise_conta h where	h.nr_sequencia = a.nr_seq_analise)), ' 			|| pls_util_pck.enter_w ||
				'	nvl(b.cd_guia_fat, nvl(b.cd_guia_pos_estab, b.cd_guia_ok)), '										|| pls_util_pck.enter_w ||
				'	(nvl(c.vl_lib_taxa_servico, 0) + nvl(c.vl_lib_taxa_co, 0) + nvl(c.vl_lib_taxa_material, 0)), '						|| pls_util_pck.enter_w ||
				'	nvl(c.vl_medico, 0) + nvl(c.vl_custo_operacional, 0) + nvl(c.vl_materiais, 0), '							|| pls_util_pck.enter_w ||
				'	decode(a.nr_seq_regra_inter,null,'													|| pls_util_pck.enter_w ||
				'		(select max(t.nr_sequencia) from pls_regra_intercambio t where t.pr_taxa = a.tx_administracao), '				|| pls_util_pck.enter_w ||
				'		a.nr_seq_regra_inter) nr_seq_regra_inter, '											|| pls_util_pck.enter_w ||
				'	nvl(b.dt_alta, sysdate), '														|| pls_util_pck.enter_w ||
				'	z.ie_origem_protocolo, '														|| pls_util_pck.enter_w ||
				'	z.ie_tipo_protocolo, '															|| pls_util_pck.enter_w ||
				'	nvl((	select	max(h.ie_ato_cooperado) '												|| pls_util_pck.enter_w ||
				'		from	pls_conta_medica_resumo h '												|| pls_util_pck.enter_w ||
				'		where	h.nr_sequencia		= c.nr_seq_conta_resumo '									|| pls_util_pck.enter_w ||
				'		and	h.nr_seq_conta		= y.nr_seq_conta '										|| pls_util_pck.enter_w ||
				'		and	h.ie_tipo_item		!= ''I'' '											|| pls_util_pck.enter_w ||
				'		and	h.ie_situacao		= ''A''),c.ie_ato_cooperado) ie_ato_cooperado_pag, '						|| pls_util_pck.enter_w ||
				'	(select	decode(h.cd_cgc, null, ''F'', ''J'') from pls_prestador h where h.nr_sequencia = c.nr_seq_prestador_pgto), ' 			|| pls_util_pck.enter_w ||
				'	(select max(x.cd_usuario_plano) from pls_segurado_carteira x where x.nr_seq_segurado = b.nr_seq_segurado) cd_usuario_plano, '		|| pls_util_pck.enter_w ||
				'	d.nr_seq_pagador, '															|| pls_util_pck.enter_w ||
				'	d.nr_seq_contrato, '															|| pls_util_pck.enter_w ||
				'	d.nr_seq_intercambio, '															|| pls_util_pck.enter_w ||
				'	d.nr_seq_ops_congenere, '														|| pls_util_pck.enter_w ||
				'	pls_faturamento_pck.obter_se_fat_data_altera_benef( b.dt_atendimento_referencia, '							|| pls_util_pck.enter_w ||
				'		(select	max(m.dt_alteracao) from pls_plano w, pls_segurado_alt_plano m where m.nr_seq_segurado = d.nr_sequencia and m.ie_situacao = ''A'' ' || pls_util_pck.enter_w ||
				'		and w.nr_sequencia = m.nr_seq_plano_ant and w.ie_preco = 1), d.dt_rescisao, :ie_pos_estab_fat_resc, e.ie_preco) ie_fat_data_alt_pre, '	|| pls_util_pck.enter_w ||
				'	z.nr_sequencia nr_seq_protocolo, '													|| pls_util_pck.enter_w ||
				'	z.nr_seq_congenere nr_seq_congenere_prot, '												|| pls_util_pck.enter_w ||
				'	b.nr_seq_conta_princ, '															|| pls_util_pck.enter_w ||
				'	y.ie_origem_proced '															|| pls_util_pck.enter_w;
				
ds_sql_contas_fat_pro_w := 	'from	pls_plano			e, '													|| pls_util_pck.enter_w ||
				'	pls_segurado			d, '													|| pls_util_pck.enter_w ||
				'	pls_conta_pos_proc_fat		c, '													|| pls_util_pck.enter_w ||
				'	pls_conta_pos_cab_v		b, '													|| pls_util_pck.enter_w ||
				'	pls_conta_pos_proc		a, '													|| pls_util_pck.enter_w ||
				'	pls_protocolo_conta		z, '													|| pls_util_pck.enter_w ||
				'	pls_conta_proc			y '													|| pls_util_pck.enter_w ||
				'where	y.nr_sequencia			= a.nr_seq_conta_proc'											|| pls_util_pck.enter_w ||
				'and	z.nr_sequencia			= b.nr_seq_protocolo '											|| pls_util_pck.enter_w ||
				'and	a.nr_seq_conta			= b.nr_sequencia '											|| pls_util_pck.enter_w ||
				'and	a.nr_sequencia			= c.nr_seq_conta_pos_proc '										|| pls_util_pck.enter_w ||
				'and	b.nr_seq_segurado		= d.nr_sequencia '											|| pls_util_pck.enter_w ||
				'and	d.nr_seq_plano			= e.nr_sequencia(+) '											|| pls_util_pck.enter_w ||
				'and	a.ie_status_faturamento 	= ''L'' '												|| pls_util_pck.enter_w ||
				'and	b.ie_status_fat			= ''L'' '												|| pls_util_pck.enter_w ||
				'and	b.ie_status 			= ''F'' '												|| pls_util_pck.enter_w ||
				'and	z.ie_situacao in (''D'', ''T'') '													|| pls_util_pck.enter_w ||
				'and	(((nvl(e.ie_preco, ''3'') = ''1'') and (d.dt_rescisao is not null)) or (nvl(e.ie_preco, ''3'') in (''2'', ''3'')) '			|| pls_util_pck.enter_w ||
				'	 or ((e.ie_preco = ''1'') and (z.ie_tipo_protocolo = ''R''))) '										|| pls_util_pck.enter_w ||
				'and	((nvl(c.vl_medico, 0) > 0) or (nvl(c.vl_custo_operacional, 0) > 0) or (nvl(c.vl_materiais, 0) > 0)) '					|| pls_util_pck.enter_w ||
				'and	nvl(a.nr_seq_evento_fat, 0) = 0  '													|| pls_util_pck.enter_w ||
				'and	nvl(a.nr_seq_lote_fat, 0) = 0 '														|| pls_util_pck.enter_w ||
				'and	not exists(	select	1 '														|| pls_util_pck.enter_w ||
				'			from	pls_analise_conta y '												|| pls_util_pck.enter_w ||
				'			where	y.ie_status in (''A'', ''D'', ''G'', ''J'', ''L'', ''P'', ''X'') '						|| pls_util_pck.enter_w ||
				'			and	y.nr_sequencia = a.nr_seq_analise) '										|| pls_util_pck.enter_w ||
				'and	not exists(	select	1 '														|| pls_util_pck.enter_w ||
				'			from	pls_conta x '													|| pls_util_pck.enter_w ||
				'			where	x.nr_seq_conta_referencia = b.nr_sequencia '									|| pls_util_pck.enter_w ||
				'			and	x.nr_seq_ajuste_fat is not null) '										|| pls_util_pck.enter_w ||
				'and	not exists(	select	1   '														|| pls_util_pck.enter_w ||
				'			from	pls_lote_protocolo_conta x '											|| pls_util_pck.enter_w ||
				'			where	x.nr_sequencia = z.nr_seq_lote_conta '										|| pls_util_pck.enter_w ||
				'			and	x.ie_status = ''X'') '												|| pls_util_pck.enter_w ||
				'and	not exists(	select	1 '														|| pls_util_pck.enter_w ||
				'			from	pls_ajuste_fatura_conta x '											|| pls_util_pck.enter_w ||
				'			where	x.nr_seq_conta	= b.nr_sequencia '										|| pls_util_pck.enter_w ||
				'			and	x.ie_status = ''N'') '												|| pls_util_pck.enter_w ||
				'and	((b.nr_seq_discussao is null) or (not exists(	select 1 '										|| pls_util_pck.enter_w ||
				'							from	pls_conta_pos_cab_v x '								|| pls_util_pck.enter_w ||
				'							where	x.nr_sequencia = a.nr_seq_conta '						|| pls_util_pck.enter_w ||
				'							and	x.nr_seq_discussao is null))) '							|| pls_util_pck.enter_w ||
				'and	((b.nr_seq_conta_rec is null) or (not exists(	select	1 '										|| pls_util_pck.enter_w ||
				'							from	pls_conta_pos_cab_v x '								|| pls_util_pck.enter_w ||
				'							where	x.nr_sequencia = a.nr_seq_conta '						|| pls_util_pck.enter_w ||
				'							and	x.nr_seq_conta_rec is null))) '							|| pls_util_pck.enter_w ||
				'and	exists	(	select	1 '														|| pls_util_pck.enter_w ||
				'			from	pls_conta_pos_proc_contab ctb '											|| pls_util_pck.enter_w ||
				'			where	ctb.nr_seq_conta_pos_proc = a.nr_sequencia) '									|| pls_util_pck.enter_w;

if (ie_processo_p not in ('CF')) then
	-- Gravar FROM/WHERE dos procedimentos
	CALL pls_gerar_fatura_log( nr_seq_lote_p, null, null, substr(ds_sql_contas_fat_pro_w,1,4000), 'L', 'N', nm_usuario_p);

	-- Gravar FILTROS dos procedimentos
	CALL pls_gerar_fatura_log( nr_seq_lote_p, null, null, substr(ds_filtro_contas_faturamento_w||'De: '||current_setting('pls_faturamento_pck.dt_inicial_fechamento_w')::pls_lote_faturamento.dt_inicial_fechamento%type ||' '||wheb_mensagem_pck.get_texto(1108913)||' '||current_setting('pls_faturamento_pck.dt_final_fechamento_w')::pls_lote_faturamento.dt_final_fechamento%type,1,4000), 'L', 'N', nm_usuario_p);
end if;

-- Gerar SQL dos procedimentos
ds_sql_contas_fat_pro_w := ds_sql_campos_pro_w || ds_sql_contas_fat_pro_w || ds_filtro_contas_faturamento_w;

ds_sql_campos_mat_w :=		'select b.nr_sequencia, '															|| pls_util_pck.enter_w ||
				'	b.nr_seq_segurado, ' 															|| pls_util_pck.enter_w ||
				'	b.dt_emissao, '																|| pls_util_pck.enter_w ||
				'	nvl(d.nr_seq_ops_congenere, d.nr_seq_congenere), ' 											|| pls_util_pck.enter_w ||
				'	nvl(b.dt_atendimento, b.dt_atendimento_referencia), '											|| pls_util_pck.enter_w ||
				'	b.ie_tipo_guia, ' 															|| pls_util_pck.enter_w ||
				'	nvl(b.dt_inicio_faturamento, b.dt_entrada), ' 												|| pls_util_pck.enter_w ||
				'	b.cd_guia_ok, ' 															|| pls_util_pck.enter_w ||
				'	pls_faturamento_pck.obter_se_prest_a400( b.nr_seq_prestador_exec, :ie_consiste_prest), ' 						|| pls_util_pck.enter_w ||
				'	b.ie_origem_conta, ' 															|| pls_util_pck.enter_w ||
				'	a.nr_seq_conta_mat, '															|| pls_util_pck.enter_w ||
				'	a.nr_sequencia, '															|| pls_util_pck.enter_w ||
				'	c.nr_sequencia, '															|| pls_util_pck.enter_w ||
				'	(select	max(k.ie_tipo_guia) from pls_conta k where k.nr_sequencia = b.nr_seq_conta_princ), '						|| pls_util_pck.enter_w ||
				'	b.nr_seq_tipo_atendimento, '														|| pls_util_pck.enter_w ||
				'	b.nr_seq_tipo_conta, '															|| pls_util_pck.enter_w ||
				'	nvl((select max(k.ie_tipo_segurado) from pls_conta k where k.nr_sequencia = b.nr_seq_conta_princ), '					|| pls_util_pck.enter_w ||
				'						nvl(b.ie_tipo_segurado_cta,d.ie_tipo_segurado)) ie_tipo_segurado, '				|| pls_util_pck.enter_w ||
				'	b.ie_internado, '															|| pls_util_pck.enter_w ||
				'	pls_obter_tipo_intercambio( '														|| pls_util_pck.enter_w ||
				'		decode(pls_obter_tipo_congenere( '												|| pls_util_pck.enter_w ||
				'			nvl(d.nr_seq_ops_congenere, d.nr_seq_congenere)), ''OP'', '								|| pls_util_pck.enter_w ||
				'				decode(nvl(b.ie_tipo_segurado_cta,d.ie_tipo_segurado), ''T'', nvl(z.nr_seq_congenere, nvl(d.nr_seq_ops_congenere, '	|| pls_util_pck.enter_w ||
				'					d.nr_seq_congenere)), nvl(d.nr_seq_ops_congenere, d.nr_seq_congenere)), '				|| pls_util_pck.enter_w ||
				'						nvl(d.nr_seq_ops_congenere, d.nr_seq_congenere)), :cd_estabelecimento), '			|| pls_util_pck.enter_w ||
				'	b.ie_tipo_conta, ' 															|| pls_util_pck.enter_w ||
				'	nvl(decode(b.nr_seq_guia, null, d.ie_pcmso, decode(b.nr_seq_segurado, (select h.nr_seq_segurado from pls_conta h '			|| pls_util_pck.enter_w ||
				'		where h.nr_sequencia = y.nr_seq_conta), nvl((select max(o.ie_pcmso) from pls_requisicao o, pls_execucao_req_item w '		|| pls_util_pck.enter_w ||
				'			where w.nr_seq_requisicao = o.nr_sequencia and w.nr_seq_guia = b.nr_seq_guia), d.ie_pcmso), d.ie_pcmso)), ''N''), '	|| pls_util_pck.enter_w ||
				'	d.nr_seq_plano, ' 															|| pls_util_pck.enter_w ||
				'	e.nr_seq_classificacao, '														|| pls_util_pck.enter_w ||
				'	n.ie_tipo_despesa, '															|| pls_util_pck.enter_w ||
				'	e.ie_preco, '																|| pls_util_pck.enter_w ||
				'	y.nr_seq_material, '															|| pls_util_pck.enter_w ||
				'	(select	max(k.nr_seq_grupo_rec) '													|| pls_util_pck.enter_w ||
				'	from material k '															|| pls_util_pck.enter_w ||
				'	where k.cd_material = n.cd_material), ' 												|| pls_util_pck.enter_w ||
				'	y.dt_atendimento_referencia, '														|| pls_util_pck.enter_w ||
				'	(select	max(h.cd_prestador) from pls_prestador h where h.nr_sequencia = b.nr_seq_prestador_exec), '					|| pls_util_pck.enter_w ||
				'	(select	max(h.nr_seq_tipo_prestador) from pls_prestador h where h.nr_sequencia = b.nr_seq_prestador_exec), '				|| pls_util_pck.enter_w ||
				'	(select	max(decode(h.cd_pessoa_fisica, null, ''J'', ''F'')) from pls_prestador h where h.nr_sequencia = b.nr_seq_prestador_exec), '	|| pls_util_pck.enter_w ||
				'	(select	max(h.ie_tipo_relacao) from pls_prestador h where h.nr_sequencia = b.nr_seq_prestador_exec), '					|| pls_util_pck.enter_w ||
				'	decode(c.nr_seq_prestador_pgto,null, '													|| pls_util_pck.enter_w ||
				'		(select max(h.nr_seq_classificacao) from pls_prestador h where h.nr_sequencia = b.nr_seq_prestador_exec), '			|| pls_util_pck.enter_w ||
				'		(select max(h.nr_seq_classificacao) from pls_prestador h where h.nr_sequencia = c.nr_seq_prestador_pgto)), '			|| pls_util_pck.enter_w ||
				'	c.ie_ato_cooperado, '															|| pls_util_pck.enter_w ||
				'	c.nr_seq_prestador_pgto, '														|| pls_util_pck.enter_w ||
				'	z.ie_apresentacao, '															|| pls_util_pck.enter_w ||
				'	(select	decode(h.cd_cgc, null, ''F'', ''J'') from pls_prestador h where nr_sequencia = z.nr_seq_prestador), '				|| pls_util_pck.enter_w ||
				'	pls_faturamento_pck.obter_tipo_pes_prest_ptu(null, y.nr_sequencia, null, null, null, null), '						|| pls_util_pck.enter_w ||
				'	(select	max(decode(m.cd_cgc, null, ''F'', ''J'')) '											|| pls_util_pck.enter_w ||
				'	from	pls_guia_plano	g, '														|| pls_util_pck.enter_w ||
				'		pls_prestador	m '														|| pls_util_pck.enter_w ||
				'	where	m.nr_sequencia	= g.nr_seq_prestador '												|| pls_util_pck.enter_w ||
				'	and	g.nr_sequencia 	= b.nr_seq_guia), '												|| pls_util_pck.enter_w ||
				'	decode(a.nr_seq_analise, null, decode(b.nr_seq_conta_rec, null, null, 8), '								|| pls_util_pck.enter_w ||
				'		(select	nvl(max(h.ie_origem_analise), 2) from pls_analise_conta h where	h.nr_sequencia = a.nr_seq_analise)), ' 			|| pls_util_pck.enter_w ||
				'	nvl(b.cd_guia_fat, nvl(b.cd_guia_pos_estab, b.cd_guia_ok)), '										|| pls_util_pck.enter_w ||
				'	nvl(c.vl_administracao, 0), '														|| pls_util_pck.enter_w ||
				'	nvl(c.vl_materiais, 0), '														|| pls_util_pck.enter_w ||
				'	decode(a.nr_seq_regra_inter,null,'													|| pls_util_pck.enter_w ||
				'		(select max(t.nr_sequencia) from pls_regra_intercambio t where t.pr_taxa = a.tx_administracao), '				|| pls_util_pck.enter_w ||
				'		a.nr_seq_regra_inter) nr_seq_regra_inter, '											|| pls_util_pck.enter_w ||
				'	nvl(b.dt_alta, sysdate), '														|| pls_util_pck.enter_w ||
				'	z.ie_origem_protocolo, '														|| pls_util_pck.enter_w ||
				'	z.ie_tipo_protocolo, '															|| pls_util_pck.enter_w ||
				'	nvl((	select	max(h.ie_ato_cooperado) '												|| pls_util_pck.enter_w ||
				'		from	pls_conta_medica_resumo h '												|| pls_util_pck.enter_w ||
				'		where	h.nr_sequencia		= c.nr_seq_conta_resumo '									|| pls_util_pck.enter_w ||
				'		and	h.nr_seq_conta		= y.nr_seq_conta '										|| pls_util_pck.enter_w ||
				'		and	h.ie_tipo_item		!= ''I'' '											|| pls_util_pck.enter_w ||
				'		and	h.ie_situacao		= ''A''),c.ie_ato_cooperado) ie_ato_cooperado_pag, '						|| pls_util_pck.enter_w ||
				'	(select	decode(h.cd_cgc, null, ''F'', ''J'') from pls_prestador h where h.nr_sequencia = c.nr_seq_prestador_pgto), ' 			|| pls_util_pck.enter_w ||
				'	(select max(x.cd_usuario_plano) from pls_segurado_carteira x where x.nr_seq_segurado = b.nr_seq_segurado) cd_usuario_plano, '		|| pls_util_pck.enter_w ||
				'	d.nr_seq_pagador, '															|| pls_util_pck.enter_w ||
				'	d.nr_seq_contrato, '															|| pls_util_pck.enter_w ||
				'	d.nr_seq_intercambio, '															|| pls_util_pck.enter_w ||
				'	d.nr_seq_ops_congenere, '														|| pls_util_pck.enter_w ||
				'	pls_faturamento_pck.obter_se_fat_data_altera_benef( b.dt_atendimento_referencia, '							|| pls_util_pck.enter_w ||
				'		(select	max(m.dt_alteracao) from pls_plano w, pls_segurado_alt_plano m where m.nr_seq_segurado = d.nr_sequencia and m.ie_situacao = ''A'' ' || pls_util_pck.enter_w ||
				'		and w.nr_sequencia = m.nr_seq_plano_ant and w.ie_preco = 1), d.dt_rescisao, :ie_pos_estab_fat_resc, e.ie_preco) ie_fat_data_alt_pre, '	|| pls_util_pck.enter_w ||
				'	z.nr_sequencia nr_seq_protocolo, '													|| pls_util_pck.enter_w ||
				'	z.nr_seq_congenere nr_seq_congenere_prot, '												|| pls_util_pck.enter_w ||
				'	b.nr_seq_conta_princ '															|| pls_util_pck.enter_w;
				
ds_sql_contas_fat_mat_w := 	'from	pls_plano			e, '													|| pls_util_pck.enter_w ||
				'	pls_segurado			d, '													|| pls_util_pck.enter_w ||
				'	pls_conta_pos_mat_fat		c, '													|| pls_util_pck.enter_w ||
				'	pls_conta_pos_cab_v		b, '													|| pls_util_pck.enter_w ||
				'	pls_conta_pos_mat		a, '													|| pls_util_pck.enter_w ||
				'	pls_protocolo_conta		z, '													|| pls_util_pck.enter_w ||
				'	pls_conta_mat			y, '													|| pls_util_pck.enter_w ||
				'	pls_material			n '													|| pls_util_pck.enter_w ||
				'where	y.nr_sequencia			= a.nr_seq_conta_mat '											|| pls_util_pck.enter_w ||
				'and	n.nr_sequencia			= y.nr_seq_material '											|| pls_util_pck.enter_w ||
				'and	z.nr_sequencia			= b.nr_seq_protocolo '											|| pls_util_pck.enter_w ||
				'and	a.nr_seq_conta			= b.nr_sequencia '											|| pls_util_pck.enter_w ||
				'and	a.nr_sequencia			= c.nr_seq_conta_mat_pos '										|| pls_util_pck.enter_w ||
				'and	b.nr_seq_segurado		= d.nr_sequencia '											|| pls_util_pck.enter_w ||
				'and	d.nr_seq_plano			= e.nr_sequencia(+) '											|| pls_util_pck.enter_w ||
				'and	a.ie_status_faturamento 	= ''L'' '												|| pls_util_pck.enter_w ||
				'and	b.ie_status_fat			= ''L'' '												|| pls_util_pck.enter_w ||
				'and	b.ie_status 			= ''F'' '												|| pls_util_pck.enter_w ||
				'and	z.ie_situacao in (''D'', ''T'') '													|| pls_util_pck.enter_w ||
				'and	(((nvl(e.ie_preco, ''3'') = ''1'') and (d.dt_rescisao is not null)) or (nvl(e.ie_preco, ''3'') in (''2'', ''3'')) '			|| pls_util_pck.enter_w ||
				'	  or ((e.ie_preco = ''1'') and (z.ie_tipo_protocolo = ''R''))) '									|| pls_util_pck.enter_w ||
				'and	nvl(c.vl_materiais, 0) > 0 '														|| pls_util_pck.enter_w ||
				'and	nvl(a.nr_seq_evento_fat, 0) = 0  '													|| pls_util_pck.enter_w ||
				'and	nvl(a.nr_seq_lote_fat, 0) = 0 '														|| pls_util_pck.enter_w ||
				'and not exists(	select	1 '														|| pls_util_pck.enter_w ||
				'			from	pls_analise_conta y '												|| pls_util_pck.enter_w ||
				'			where	y.ie_status in (''A'', ''D'', ''G'', ''J'', ''L'', ''P'', ''X'') '						|| pls_util_pck.enter_w ||
				'			and	y.nr_sequencia = a.nr_seq_analise) '										|| pls_util_pck.enter_w ||
				'and not exists(	select	1 '														|| pls_util_pck.enter_w ||
				'			from	pls_conta x '													|| pls_util_pck.enter_w ||
				'			where	x.nr_seq_conta_referencia = b.nr_sequencia '									|| pls_util_pck.enter_w ||
				'			and	x.nr_seq_ajuste_fat is not null) '										|| pls_util_pck.enter_w ||
				'and not exists(	select	1   '														|| pls_util_pck.enter_w ||
				'			from	pls_lote_protocolo_conta x '											|| pls_util_pck.enter_w ||
				'			where	x.nr_sequencia = z.nr_seq_lote_conta '										|| pls_util_pck.enter_w ||
				'			and	x.ie_status = ''X'') '												|| pls_util_pck.enter_w ||
				'and not exists(	select	1 '														|| pls_util_pck.enter_w ||
				'			from	pls_ajuste_fatura_conta x '											|| pls_util_pck.enter_w ||
				'			where	x.nr_seq_conta	= b.nr_sequencia '										|| pls_util_pck.enter_w ||
				'			and	x.ie_status = ''N'') '												|| pls_util_pck.enter_w ||
				'and ((b.nr_seq_discussao is null) or (not exists(	select 1 '										|| pls_util_pck.enter_w ||
				'							from	pls_conta_pos_cab_v x '								|| pls_util_pck.enter_w ||
				'							where	x.nr_sequencia = a.nr_seq_conta '						|| pls_util_pck.enter_w ||
				'							and	x.nr_seq_discussao is null))) '							|| pls_util_pck.enter_w ||
				'and ((b.nr_seq_conta_rec is null) or (not exists(	select	1 '										|| pls_util_pck.enter_w ||
				'							from	pls_conta_pos_cab_v x '								|| pls_util_pck.enter_w ||
				'							where	x.nr_sequencia = a.nr_seq_conta '						|| pls_util_pck.enter_w ||
				'							and	x.nr_seq_conta_rec is null))) '							|| pls_util_pck.enter_w ||
				'and	exists	(	select	1 '														|| pls_util_pck.enter_w ||
				'			from	pls_conta_pos_mat_contab ctb '											|| pls_util_pck.enter_w ||
				'			where	ctb.nr_seq_conta_mat_pos = a.nr_sequencia) '									|| pls_util_pck.enter_w;
			
if (ie_processo_p not in ('CF')) then			
	-- Gravar FROM/WHERE dos materiais
	CALL pls_gerar_fatura_log( nr_seq_lote_p, null, null, substr(ds_sql_contas_fat_mat_w,1,4000), 'L', 'N', nm_usuario_p);

	-- Gravar FILTROS dos materiais
	CALL pls_gerar_fatura_log( nr_seq_lote_p, null, null, substr(ds_filtro_contas_faturamento_w||'De: '||current_setting('pls_faturamento_pck.dt_inicial_fechamento_w')::pls_lote_faturamento.dt_inicial_fechamento%type ||' '||wheb_mensagem_pck.get_texto(1108913)||' '||current_setting('pls_faturamento_pck.dt_final_fechamento_w')::pls_lote_faturamento.dt_final_fechamento%type,1,4000), 'L', 'N', nm_usuario_p);
end if;

-- Gerar SQL dos materiais
ds_sql_contas_fat_mat_w := ds_sql_campos_mat_w || ds_sql_contas_fat_mat_w || ds_filtro_contas_faturamento_w;
				
if (current_setting('pls_faturamento_pck.ie_fatura_encerrada_w')::pls_parametro_faturamento.ie_fatura_encerrada%type = 'S') and (ie_processo_p not in ('VM','CF')) then
	ds_sql_contas_fat_pro_w	:= ds_sql_contas_fat_pro_w ||	'and not exists (	select	1 '												|| pls_util_pck.enter_w ||
								'			from	ptu_fatura 		y, '									|| pls_util_pck.enter_w ||
								'				pls_conta 		x '									|| pls_util_pck.enter_w ||
								'			where	y.nr_sequencia 		= x.nr_seq_fatura '							|| pls_util_pck.enter_w ||
								'			and	x.nr_sequencia 		= b.nr_sequencia '							|| pls_util_pck.enter_w ||
								'			and	x.ie_origem_conta	= ''A'' '								|| pls_util_pck.enter_w ||
								'			and	y.ie_status <> ''E'') ';
	
	ds_sql_contas_fat_mat_w := ds_sql_contas_fat_mat_w ||	'and not exists (	select	1 '												|| pls_util_pck.enter_w ||
								'			from	ptu_fatura 		y, '									|| pls_util_pck.enter_w ||
								'				pls_conta 		x '									|| pls_util_pck.enter_w ||
								'			where	y.nr_sequencia 		= x.nr_seq_fatura '							|| pls_util_pck.enter_w ||
								'			and	x.nr_sequencia 		= b.nr_sequencia '							|| pls_util_pck.enter_w ||
								'			and	x.ie_origem_conta	= ''A'' '								|| pls_util_pck.enter_w ||
								'			and	y.ie_status <> ''E'') ';
end if;

valor_bind_w := sql_pck.bind_variable(':cd_estabelecimento', cd_estabelecimento_p, valor_bind_w);
valor_bind_w := sql_pck.bind_variable(':ie_consiste_prest', current_setting('pls_faturamento_pck.ie_consiste_prest_w')::pls_parametros.ie_consiste_prest_envio_a500%type, valor_bind_w);
valor_bind_w := sql_pck.bind_variable(':ie_pos_estab_fat_resc', current_setting('pls_faturamento_pck.ie_pos_estab_fat_resc_w')::pls_parametros.ie_pos_estab_fat_resc%type, valor_bind_w);

valor_bind_pro_w := valor_bind_w;

valor_bind_pro_w := sql_pck.executa_sql_cursor(ds_sql_contas_fat_pro_w, valor_bind_pro_w);

loop
	fetch cursor_pro_w bulk collect into 	tb_nr_seq_conta_w,		tb_nr_seq_segurado_w,		tb_dt_emissao_w,
						tb_nr_seq_congenere_w,		tb_dt_atendimento_w,		tb_ie_tipo_guia_w,
						tb_dt_internacao_w,		tb_cd_guia_ok_w,		tb_ie_prestador_a400_w,
						tb_ie_origem_conta_w,		tb_nr_seq_conta_proc_w,		tb_nr_seq_conta_pos_proc_w,
						tb_nr_seq_pos_proc_fat_w,	tb_ie_tipo_guia_princ_w,	tb_nr_seq_tipo_atendimento_w,
						tb_nr_seq_tipo_conta_w,		tb_ie_tipo_segurado_w,		tb_ie_internado_w,
						tb_ie_tipo_intercambio_w,	tb_ie_tipo_conta_w,		tb_ie_pcmso_w,
						tb_nr_seq_plano_w,		tb_nr_seq_classificacao_sca_w,	tb_ie_tipo_despesa_w,
						tb_cd_procedimento_w,		tb_cd_area_procedimento_w,	tb_cd_especialidade_w,
						tb_cd_grupo_proc_w,		tb_ie_preco_w,			tb_nr_seq_grupo_rec_w,
						tb_dt_atendimento_referencia_w,	tb_cd_prestador_w,		tb_nr_seq_tipo_prestador_w,
						tb_ie_tipo_pessoa_prest_w,	tb_ie_tipo_relacao_w,		tb_nr_seq_classif_prest_w,
						tb_ie_ato_cooperado_w,		tb_nr_seq_prestador_exec_w,	tb_nr_seq_prestador_pgto_w,
						tb_ie_apresentacao_prot_w,	tb_ie_tipo_pes_prest_atend_w,	tb_ie_tipo_pessoa_prest_ptu_w,
						tb_ie_tipo_pes_prest_solic_w,	tb_ie_origem_analise_pos_w,	tb_cd_guia_referencia_w,
						tb_vl_item_w,			tb_vl_item_ndc_w,		tb_nr_seq_regra_inter_w,
						tb_dt_alta_w,			tb_ie_origem_protocolo_w,	tb_ie_tipo_protocolo_w,
						tb_ie_ato_cooperado_pag_w,	tb_ie_tipo_pessoa_prest_pag_w,	tb_cd_usuario_plano_w,
						tb_nr_seq_pagador_w,		tb_nr_seq_contrato_w, 		tb_nr_seq_intercambio_w,
						tb_nr_seq_ops_congenere_w,	tb_ie_fat_data_alt_pre_w,	tb_nr_seq_protocolo_w,
						tb_nr_seq_congenere_prot_w,	tb_nr_seq_conta_princ_w,	tb_ie_origem_proced_w
	limit pls_util_pck.qt_registro_transacao_w;
	exit when tb_nr_seq_conta_w.count = 0;
	
	forall	i in tb_nr_seq_conta_w.first..tb_nr_seq_conta_w.last
		insert into w_pls_lote_fat_proc(nr_sequencia, 				nm_usuario,				dt_atualizacao,
						nm_usuario_nrec,			dt_atualizacao_nrec,			cd_guia_ok,
						dt_atendimento_ref, 			dt_emissao_conta,			dt_inicio_faturamento,
						ie_prestador_a400, 			ie_tipo_guia,				nr_seq_congenere,
						nr_seq_conta, 				nr_seq_conta_proc, 			nr_seq_evento_fat,
						nr_seq_lote_fat, 			nr_seq_pos_proc, 			nr_seq_pos_proc_fat,
						nr_seq_segurado,			ie_tipo_guia_princ,			nr_seq_tipo_atendimento,
						nr_seq_tipo_conta,			ie_origem_conta,			ie_tipo_segurado,
						ie_internado,				ie_tipo_intercambio,			ie_tipo_conta,
						ie_pcmso,				nr_seq_plano,				nr_seq_classificacao_sca,
						ie_tipo_despesa_proc,			cd_procedimento,			cd_area_procedimento,
						cd_especialidade,			cd_grupo_proc,				ie_preco,
						nr_seq_grupo_rec,			dt_procedimento_ref,			cd_prestador,
						nr_seq_tipo_prestador,			ie_tipo_pessoa_prest,			ie_tipo_relacao,
						nr_seq_classif_prest,			ie_ato_cooperado,			nr_seq_prestador_exec,
						nr_seq_prestador_pgto,			ie_apresentacao_prot,			ie_tipo_pessoa_prest_atend,
						ie_tipo_pessoa_prest_ptu,		ie_tipo_pessoa_prest_solic,		ie_origem_analise_pos,
						ie_tipo_cobranca,			vl_item,				vl_item_ndc,
						nr_seq_regra_inter,			dt_alta,				ie_origem_protocolo,
						ie_tipo_protocolo,			ie_ato_cooperado_pag,			ie_tipo_pessoa_prest_pag,
						cd_usuario_plano,			nr_seq_pagador,				nr_seq_contrato,
						nr_seq_intercambio,			nr_seq_ops_congenere,			ie_fat_data_alt_pre,
						nr_seq_protocolo,			nr_seq_congenere_prot,			nr_seq_conta_princ,
						cd_guia_referencia,			ie_origem_proced)
					values (	nextval('w_pls_lote_fat_proc_seq'),	nm_usuario_p,				clock_timestamp(),
						nm_usuario_p,				clock_timestamp(),				tb_cd_guia_ok_w(i),
						tb_dt_atendimento_w(i),			tb_dt_emissao_w(i),			tb_dt_internacao_w(i),
						tb_ie_prestador_a400_w(i),		tb_ie_tipo_guia_w(i),			tb_nr_seq_congenere_w(i),
						tb_nr_seq_conta_w(i),			tb_nr_seq_conta_proc_w(i),		nr_seq_evento_fat_p,
						nr_seq_lote_p,				tb_nr_seq_conta_pos_proc_w(i),		tb_nr_seq_pos_proc_fat_w(i),
						tb_nr_seq_segurado_w(i),		tb_ie_tipo_guia_princ_w(i),		tb_nr_seq_tipo_atendimento_w(i),
						tb_nr_seq_tipo_conta_w(i),		tb_ie_origem_conta_w(i),		tb_ie_tipo_segurado_w(i),
						tb_ie_internado_w(i),			tb_ie_tipo_intercambio_w(i),		tb_ie_tipo_conta_w(i),
						tb_ie_pcmso_w(i),			tb_nr_seq_plano_w(i),			tb_nr_seq_classificacao_sca_w(i),
						tb_ie_tipo_despesa_w(i),		tb_cd_procedimento_w(i),		tb_cd_area_procedimento_w(i),
						tb_cd_especialidade_w(i),		tb_cd_grupo_proc_w(i),			tb_ie_preco_w(i),
						tb_nr_seq_grupo_rec_w(i),		tb_dt_atendimento_referencia_w(i),	tb_cd_prestador_w(i),
						tb_nr_seq_tipo_prestador_w(i),		tb_ie_tipo_pessoa_prest_w(i),		tb_ie_tipo_relacao_w(i),
						tb_nr_seq_classif_prest_w(i),		tb_ie_ato_cooperado_w(i),		tb_nr_seq_prestador_exec_w(i),
						tb_nr_seq_prestador_pgto_w(i),		tb_ie_apresentacao_prot_w(i),		tb_ie_tipo_pes_prest_atend_w(i),
						tb_ie_tipo_pessoa_prest_ptu_w(i),	tb_ie_tipo_pes_prest_solic_w(i),	tb_ie_origem_analise_pos_w(i),
						'1',					tb_vl_item_w(i),			tb_vl_item_ndc_w(i),
						tb_nr_seq_regra_inter_w(i),		tb_dt_alta_w(i),			tb_ie_origem_protocolo_w(i),
						tb_ie_tipo_protocolo_w(i),		tb_ie_ato_cooperado_pag_w(i),		tb_ie_tipo_pessoa_prest_pag_w(i),
						tb_cd_usuario_plano_w(i),		tb_nr_seq_pagador_w(i),			tb_nr_seq_contrato_w(i),
						tb_nr_seq_intercambio_w(i),		tb_nr_seq_ops_congenere_w(i),		tb_ie_fat_data_alt_pre_w(i),
						tb_nr_seq_protocolo_w(i),		tb_nr_seq_congenere_prot_w(i),		tb_nr_seq_conta_princ_w(i),
						tb_cd_guia_referencia_w(i),		tb_ie_origem_proced_w(i));
	commit;
end loop;
close cursor_pro_w;

if (cursor_pro_w%isopen) then
	close cursor_pro_w;
end if;

valor_bind_mat_w := valor_bind_w;
valor_bind_mat_w := sql_pck.executa_sql_cursor(ds_sql_contas_fat_mat_w, valor_bind_mat_w);

loop
	fetch cursor_mat_w bulk collect into	tb_nr_seq_conta_w,		tb_nr_seq_segurado_w,		tb_dt_emissao_w,
						tb_nr_seq_congenere_w,		tb_dt_atendimento_w,		tb_ie_tipo_guia_w,
						tb_dt_internacao_w,		tb_cd_guia_ok_w,		tb_ie_prestador_a400_w,
						tb_ie_origem_conta_w,		tb_nr_seq_conta_mat_w,		tb_nr_seq_conta_pos_mat_w,
						tb_nr_seq_pos_mat_fat_w,	tb_ie_tipo_guia_princ_w,	tb_nr_seq_tipo_atendimento_w,
						tb_nr_seq_tipo_conta_w,		tb_ie_tipo_segurado_w,		tb_ie_internado_w,
						tb_ie_tipo_intercambio_w,	tb_ie_tipo_conta_w,		tb_ie_pcmso_w,
						tb_nr_seq_plano_w,		tb_nr_seq_classificacao_sca_w,	tb_ie_tipo_despesa_w,
						tb_ie_preco_w,			tb_nr_seq_material_w,		tb_nr_seq_grupo_rec_w,
						tb_dt_atendimento_referencia_w,	tb_cd_prestador_w,		tb_nr_seq_tipo_prestador_w,
						tb_ie_tipo_pessoa_prest_w,	tb_ie_tipo_relacao_w,		tb_nr_seq_classif_prest_w,
						tb_ie_ato_cooperado_w,		tb_nr_seq_prestador_pgto_w,	tb_ie_apresentacao_prot_w,	
						tb_ie_tipo_pes_prest_atend_w,	tb_ie_tipo_pessoa_prest_ptu_w,	tb_ie_tipo_pes_prest_solic_w,	
						tb_ie_origem_analise_pos_w,	tb_cd_guia_referencia_w,	tb_vl_item_w,			
						tb_vl_item_ndc_w,		tb_nr_seq_regra_inter_w,	tb_dt_alta_w,			
						tb_ie_origem_protocolo_w,	tb_ie_tipo_protocolo_w,		tb_ie_ato_cooperado_pag_w,	
						tb_ie_tipo_pessoa_prest_pag_w,	tb_cd_usuario_plano_w,		tb_nr_seq_pagador_w,		
						tb_nr_seq_contrato_w, 		tb_nr_seq_intercambio_w, 	tb_nr_seq_ops_congenere_w,	
						tb_ie_fat_data_alt_pre_w,	tb_nr_seq_protocolo_w,		tb_nr_seq_congenere_prot_w,
						tb_nr_seq_conta_princ_w
	limit pls_util_pck.qt_registro_transacao_w;
	exit when tb_nr_seq_conta_w.count = 0;
	
	forall	i in tb_nr_seq_conta_w.first..tb_nr_seq_conta_w.last
		insert into w_pls_lote_fat_mat(	nr_sequencia, 				nm_usuario,				dt_atualizacao,
						nm_usuario_nrec,			dt_atualizacao_nrec,			cd_guia_ok,
						dt_atendimento_ref, 			dt_emissao_conta,			dt_inicio_faturamento,
						ie_prestador_a400, 			ie_tipo_guia,				nr_seq_congenere,
						nr_seq_conta, 				nr_seq_conta_mat, 			nr_seq_evento_fat,
						nr_seq_lote_fat, 			nr_seq_pos_mat, 			nr_seq_pos_mat_fat,
						nr_seq_segurado,			ie_tipo_guia_princ,			nr_seq_tipo_atendimento,
						nr_seq_tipo_conta,			ie_origem_conta,			ie_tipo_segurado,
						ie_internado,				ie_tipo_intercambio,			ie_tipo_conta,
						ie_pcmso,				nr_seq_plano,				nr_seq_classificacao_sca,
						ie_tipo_despesa,			ie_preco,				nr_seq_material,
						nr_seq_grupo_rec,			dt_material_ref,			cd_prestador,
						nr_seq_tipo_prestador,			ie_tipo_pessoa_prest,			ie_tipo_relacao,
						nr_seq_classif_prest,			ie_ato_cooperado,			ie_apresentacao_prot,
						ie_tipo_pessoa_prest_atend,		ie_tipo_pessoa_prest_ptu,		ie_tipo_pessoa_prest_solic,
						ie_origem_analise_pos,			ie_tipo_cobranca,			vl_item,
						vl_item_ndc,				nr_seq_regra_inter,			dt_alta,
						ie_origem_protocolo,			ie_tipo_protocolo,			ie_ato_cooperado_pag,
						ie_tipo_pessoa_prest_pag,		cd_usuario_plano,			nr_seq_pagador,
						nr_seq_contrato,			nr_seq_intercambio,			nr_seq_ops_congenere,
						ie_fat_data_alt_pre,			nr_seq_protocolo,			nr_seq_congenere_prot,
						nr_seq_prestador_pgto,			nr_seq_conta_princ,			cd_guia_referencia)
					values (	nextval('w_pls_lote_fat_mat_seq'),		nm_usuario_p,				clock_timestamp(),
						nm_usuario_p,				clock_timestamp(),				tb_cd_guia_ok_w(i),
						tb_dt_atendimento_w(i),			tb_dt_emissao_w(i),			tb_dt_internacao_w(i),
						tb_ie_prestador_a400_w(i),		tb_ie_tipo_guia_w(i),			tb_nr_seq_congenere_w(i),
						tb_nr_seq_conta_w(i),			tb_nr_seq_conta_mat_w(i),		nr_seq_evento_fat_p,
						nr_seq_lote_p,				tb_nr_seq_conta_pos_mat_w(i),		tb_nr_seq_pos_mat_fat_w(i),
						tb_nr_seq_segurado_w(i),		tb_ie_tipo_guia_princ_w(i),		tb_nr_seq_tipo_atendimento_w(i),
						tb_nr_seq_tipo_conta_w(i),		tb_ie_origem_conta_w(i),		tb_ie_tipo_segurado_w(i),
						tb_ie_internado_w(i),			tb_ie_tipo_intercambio_w(i),		tb_ie_tipo_conta_w(i),
						tb_ie_pcmso_w(i),			tb_nr_seq_plano_w(i),			tb_nr_seq_classificacao_sca_w(i),
						tb_ie_tipo_despesa_w(i),		tb_ie_preco_w(i),			tb_nr_seq_material_w(i),
						tb_nr_seq_grupo_rec_w(i),		tb_dt_atendimento_referencia_w(i),	tb_cd_prestador_w(i),
						tb_nr_seq_tipo_prestador_w(i),		tb_ie_tipo_pessoa_prest_w(i),		tb_ie_tipo_relacao_w(i),
						tb_nr_seq_classif_prest_w(i),		tb_ie_ato_cooperado_w(i),		tb_ie_apresentacao_prot_w(i),
						tb_ie_tipo_pes_prest_atend_w(i),	tb_ie_tipo_pessoa_prest_ptu_w(i),	tb_ie_tipo_pes_prest_solic_w(i),
						tb_ie_origem_analise_pos_w(i),		'1',					tb_vl_item_w(i),
						tb_vl_item_ndc_w(i),			tb_nr_seq_regra_inter_w(i),		tb_dt_alta_w(i),
						tb_ie_origem_protocolo_w(i),		tb_ie_tipo_protocolo_w(i),		tb_ie_ato_cooperado_pag_w(i),
						tb_ie_tipo_pessoa_prest_pag_w(i),	tb_cd_usuario_plano_w(i),		tb_nr_seq_pagador_w(i),
						tb_nr_seq_contrato_w(i),		tb_nr_seq_intercambio_w(i),		tb_nr_seq_ops_congenere_w(i),
						tb_ie_fat_data_alt_pre_w(i),		tb_nr_seq_protocolo_w(i),		tb_nr_seq_congenere_prot_w(i),
						tb_nr_seq_prestador_pgto_w(i),		tb_nr_seq_conta_princ_w(i),		tb_cd_guia_referencia_w(i));
	commit;
end loop;
close cursor_mat_w;

if (cursor_mat_w%isopen) then
	close cursor_mat_w;
end if;

-- Caso nao seja de vinculacao manual 
if (ie_processo_p not in ('VM','CF')) then
	-- Calculo do total de contas e itens apurados
	CALL pls_faturamento_pck.calcular_processamento( nr_seq_lote_p, 'CT');
	
	-- Obter os eventos de faturamento
	CALL pls_faturamento_pck.obter_evento_faturamento( nr_seq_lote_p, cd_estabelecimento_p, nm_usuario_p);
	
	-- Remover todos os itens de contas sem evento para faturamento
	CALL pls_faturamento_pck.remover_contas_sem_evento( nr_seq_lote_p);
end if;

-- Gera as taxas - Tem que ser depois de pegar os eventos, gerar ao gerar o lote e ao vincular de forma manual
CALL pls_faturamento_pck.insere_taxa_pls_lote_fat( nr_seq_lote_p, cd_estabelecimento_p, nm_usuario_p, ie_processo_p);
	
-- Caso nao seja de vinculacao manual
if (ie_processo_p not in ('VM')) then
	-- Verificar se os itens possuem algum impedimento de cobranca
	CALL pls_faturamento_pck.verificar_imped_cobr_fat( nr_seq_lote_p, current_setting('pls_faturamento_pck.ie_conta_fechada_w')::pls_regra_faturamento.ie_conta_fechada%type, nr_seq_pos_proc_p, nr_seq_pos_mat_p, cd_estabelecimento_p, nm_usuario_p);
	
	if (ie_processo_p not in ('CF')) then
		-- Calculo do total de contas e itens com evento informado
		CALL pls_faturamento_pck.calcular_processamento( nr_seq_lote_p, 'CE');
	end if;
end if;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_faturamento_pck.vincular_contas_fat ( nr_seq_lote_p pls_lote_faturamento.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type, ie_processo_p text, nr_seq_pos_proc_p pls_conta_pos_proc.nr_sequencia%type, nr_seq_pos_mat_p pls_conta_pos_mat.nr_sequencia%type, nr_seq_evento_fat_p pls_evento_faturamento.nr_sequencia%type) FROM PUBLIC;
