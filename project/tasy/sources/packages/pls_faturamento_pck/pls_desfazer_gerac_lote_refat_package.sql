-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_faturamento_pck.pls_desfazer_gerac_lote_refat ( nr_seq_lote_fat_p pls_lote_faturamento.nr_sequencia%type) AS $body$
DECLARE


nr_seq_lote_origem_w		pls_lote_faturamento.nr_sequencia%type;

c_eventos CURSOR(	nr_seq_lote_fat_pc		pls_lote_faturamento.nr_sequencia%type) FOR
	SELECT 	nr_sequencia
	from	pls_fatura_evento
	where	nr_seq_fatura in (	SELECT	nr_sequencia
					from	pls_fatura
					where	nr_seq_lote = nr_seq_lote_fat_pc);

c_contas CURSOR(	nr_seq_fatura_evento_pc 	pls_fatura_evento.nr_sequencia%type) FOR
	SELECT	nr_sequencia
	from	pls_fatura_conta
	where	nr_seq_fatura_evento = nr_seq_fatura_evento_pc;
BEGIN
	select 	max(nr_seq_plano)
	into STRICT	nr_seq_plano_w
	from	pls_conta_pos_cab_v
	where	nr_sequencia = nr_seq_conta_p;
	
	select	nr_seq_lote_origem
	into STRICT	nr_seq_lote_origem_w
	from	pls_lote_faturamento
	where	nr_sequencia = nr_seq_lote_fat_p;
	
	for r_c_eventos_w in c_eventos( nr_seq_lote_fat_p ) loop
		for r_c_contas_w in c_contas( r_c_eventos_w.nr_sequencia ) loop
			delete 	FROM pls_fatura_proc
			where	nr_seq_fatura_conta = r_c_contas_w.nr_sequencia;
			
			delete	FROM pls_fatura_mat
			where	nr_seq_fatura_conta = r_c_contas_w.nr_sequencia;
		end loop;
		
		delete	FROM pls_fatura_conta
		where	nr_seq_fatura_evento = r_c_eventos_w.nr_sequencia;
		
		delete 	FROM pls_fatura_evento
		where 	nr_sequencia = r_c_eventos_w.nr_sequencia;
	end loop;
	
	--atualiza o lote nas contas de pos estabelecido, voltando ao lote original
	update	pls_conta_pos_proc
	set	nr_seq_lote_fat = nr_seq_lote_origem_w
	where	nr_seq_lote_fat = nr_seq_lote_fat_p;
	
	update	pls_conta_pos_mat
	set	nr_seq_lote_fat = nr_seq_lote_origem_w
	where	nr_seq_lote_fat = nr_seq_lote_fat_p;
	
	delete	FROM pls_fatura
	where	nr_seq_lote = nr_seq_lote_fat_p;
	
	delete	FROM pls_lote_faturamento
	where	nr_sequencia = nr_seq_lote_fat_p;
	
	commit;
	
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_faturamento_pck.pls_desfazer_gerac_lote_refat ( nr_seq_lote_fat_p pls_lote_faturamento.nr_sequencia%type) FROM PUBLIC;
