-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

-- controle para decidir quando o select para obtencao dos valores dos parametros deve ser executado novamente
CREATE OR REPLACE PROCEDURE pls_faturamento_pck.carrega_parametros ( nr_seq_lote_p pls_pp_lote.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) AS $body$
BEGIN
-- se a data da ultima solicitacao nao estiver registrada ou 
-- se ja se passou 67 segundos deste a ultima solicitacao ou
-- se a origem for diferente da ultima solicitada ou
-- se o estabelecimento anterior for diferente do ultimo solicitado
-- executa o comando para preencher os valores dos parametros
if	((current_setting('pls_faturamento_pck.dt_solicitacao_ult_w')::coalesce(timestamp::text, '') = '') or (current_setting('pls_faturamento_pck.dt_solicitacao_ult_w')::timestamp <= (clock_timestamp() - interval '67 seconds')) or (coalesce(current_setting('pls_faturamento_pck.cd_estabelecimento_ult_w')::estabelecimento.cd_estabelecimento%type, -1) != coalesce(cd_estabelecimento_p, -2))) then
	
	PERFORM set_config('pls_faturamento_pck.dt_solicitacao_ult_w', clock_timestamp(), false);
	PERFORM set_config('pls_faturamento_pck.cd_estabelecimento_ult_w', cd_estabelecimento_p, false);
	
	select	max(trunc(a.dt_inicio_referencia, 'mm')),
		max(trunc(last_day(a.dt_fim_referencia), 'dd')) + 86399/86400, -- e feito o "Fim dia" manualmente, para nao gerar inf quando null
		max(trunc(a.dt_inicial_fechamento)),
		max(trunc(a.dt_final_fechamento, 'dd')) + 86399/86400,
		max(a.nr_seq_protocolo),
		max(coalesce(a.ie_apresentacao_prot, 'T')),
		max(a.nr_seq_regra_fat),
		max(a.dt_vencimento),
		max(a.dt_mesano_referencia),
		max(coalesce(b.ie_conta_fechada, 'N')),
		max(coalesce(b.ie_forma_impedimento_cobr, 'U')),
		max(coalesce(a.ie_aplicar_arredondamento,'N')),
		max(coalesce(b.ie_somente_resumo,'N'))
	into STRICT	current_setting('pls_faturamento_pck.dt_inicio_referencia_w')::pls_lote_faturamento.dt_inicio_referencia%type,
		current_setting('pls_faturamento_pck.dt_fim_referencia_w')::pls_lote_faturamento.dt_fim_referencia%type,
		current_setting('pls_faturamento_pck.dt_inicial_fechamento_w')::pls_lote_faturamento.dt_inicial_fechamento%type,
		current_setting('pls_faturamento_pck.dt_final_fechamento_w')::pls_lote_faturamento.dt_final_fechamento%type,
		current_setting('pls_faturamento_pck.nr_seq_protocolo_w')::pls_lote_faturamento.nr_seq_protocolo%type,
		current_setting('pls_faturamento_pck.ie_apresentacao_prot_w')::pls_lote_faturamento.ie_apresentacao_prot%type,
		current_setting('pls_faturamento_pck.nr_seq_regra_fat_w')::pls_regra_faturamento.nr_sequencia%type,
		current_setting('pls_faturamento_pck.dt_vencimento_w')::pls_lote_faturamento.dt_vencimento%type,
		current_setting('pls_faturamento_pck.dt_mesano_referencia_w')::pls_lote_faturamento.dt_mesano_referencia%type,
		current_setting('pls_faturamento_pck.ie_conta_fechada_w')::pls_regra_faturamento.ie_conta_fechada%type,
		current_setting('pls_faturamento_pck.ie_forma_impedimento_cobr_w')::pls_regra_faturamento.ie_forma_impedimento_cobr%type,
		current_setting('pls_faturamento_pck.ie_aplicar_arredondamento_w')::pls_lote_faturamento.ie_aplicar_arredondamento%type,
		current_setting('pls_faturamento_pck.ie_somente_resumo_w')::pls_regra_faturamento.ie_somente_resumo%type
	from	pls_regra_faturamento 	b,
		pls_lote_faturamento 	a
	where	b.nr_sequencia		= a.nr_seq_regra_fat
	and	a.nr_sequencia		= nr_seq_lote_p;
	
	select	coalesce(max(ie_evento_restritivo), 'N'),
		coalesce(max(ie_contas_faturar), 'PF'),
		coalesce(max(ie_data_fat_ref), 'DA'),
		coalesce(max(ie_fatura_encerrada), 'N')
	into STRICT	current_setting('pls_faturamento_pck.ie_evento_restritivo_w')::pls_parametro_faturamento.ie_evento_restritivo%type,
		current_setting('pls_faturamento_pck.ie_contas_faturar_w')::pls_parametro_faturamento.ie_contas_faturar%type,
	        current_setting('pls_faturamento_pck.ie_data_fat_ref_w')::pls_parametro_faturamento.ie_data_fat_ref%type,
	        current_setting('pls_faturamento_pck.ie_fatura_encerrada_w')::pls_parametro_faturamento.ie_fatura_encerrada%type
	from	pls_parametro_faturamento
	where	cd_estabelecimento = cd_estabelecimento_p;
	
	select	coalesce(max(ie_pos_estab_faturamento), 'N'),
		coalesce(max(ie_consiste_prest_envio_a500),'N'),
		coalesce(max(ie_pos_estab_fat_resc),'M')
	into STRICT	current_setting('pls_faturamento_pck.ie_pos_estab_faturamento_w')::pls_parametros.ie_pos_estab_faturamento%type,
		current_setting('pls_faturamento_pck.ie_consiste_prest_w')::pls_parametros.ie_consiste_prest_envio_a500%type,
		current_setting('pls_faturamento_pck.ie_pos_estab_fat_resc_w')::pls_parametros.ie_pos_estab_fat_resc%type
	from	pls_parametros
	where	cd_estabelecimento = cd_estabelecimento_p;
	
	select	max(o.cd_cgc_outorgante),
		max(c.nr_sequencia)
	into STRICT	current_setting('pls_faturamento_pck.cd_cgc_outorgante_w')::pls_outorgante.cd_cgc_outorgante%type,
		current_setting('pls_faturamento_pck.nr_seq_outorgante_w')::pls_congenere.nr_sequencia%type
	from	pls_outorgante	o,
		pls_congenere	c
	where	o.cd_cgc_outorgante	= c.cd_cgc
	and	o.cd_estabelecimento	= cd_estabelecimento_p;
end if;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_faturamento_pck.carrega_parametros ( nr_seq_lote_p pls_pp_lote.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) FROM PUBLIC;
