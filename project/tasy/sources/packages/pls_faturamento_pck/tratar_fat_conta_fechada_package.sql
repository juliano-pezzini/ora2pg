-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_faturamento_pck.tratar_fat_conta_fechada ( nr_seq_lote_fat_p pls_lote_faturamento.nr_sequencia%type, ie_conta_fechada_p pls_regra_faturamento.ie_conta_fechada%type, ie_apresentacao_prot_p pls_lote_faturamento.ie_apresentacao_prot%type, ie_somente_resumo_p pls_regra_faturamento.ie_somente_resumo%type, ie_vinculo_manual_p text, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE

					
qt_conta_pos_proc_mat_w		integer;
qt_conta_pos_proc_atend_w	integer;
qt_conta_pos_mat_atend_w	integer;
qt_conta_resumo_w		integer;
qt_guia_resumo_w		integer;
ds_observacao_w			varchar(4000);

c01 CURSOR(	nr_seq_lote_fat_pc		pls_lote_faturamento.nr_sequencia%type) FOR
	-- Retornar UMA linha por conta medica do pos
	SELECT	a.nr_seq_conta,
		a.cd_guia_ok,
		a.nr_seq_segurado,
		a.ie_tipo_guia,
		count(1) qt_conta_temp_proc_mat,
		a.ie_apresentacao_prot,
		a.nr_seq_conta_princ,
		(SELECT	CASE WHEN count(1)=0 THEN 'N'  ELSE 'S' END
		from	pls_conta_v v
		where	v.cd_guia_referencia	= a.cd_guia_ok
		and	v.nr_seq_segurado	= a.nr_seq_segurado
		and	v.ie_apresentacao	= a.ie_apresentacao_prot
		and	v.ie_tipo_guia 		in ('4','5')) ie_guia_int_sp, -- 4 = Guia de SP/SADT | 5 = Guia de Resumo de Internacao
		(select	max(cd_tiss)
		from	pls_tipo_atendimento x
		where	x.nr_sequencia = a.nr_seq_tipo_atendimento) cd_tipo_atendimento,
		max(a.nr_seq_evento_fat) nr_seq_evento_fat
	from (	select	nr_seq_conta,
			cd_guia_ok,
			nr_seq_segurado,
			ie_tipo_guia,
			ie_apresentacao_prot,
			nr_seq_conta_princ,
			nr_seq_tipo_atendimento,
			nr_seq_evento_fat
		from	w_pls_lote_fat_proc
		where	nr_seq_lote_fat = nr_seq_lote_fat_pc
		and	coalesce(nr_seq_pos_proc_tx::text, '') = ''  -- Nao considera taxa
		
union all

		select	nr_seq_conta,
			cd_guia_ok,
			nr_seq_segurado,
			ie_tipo_guia,
			ie_apresentacao_prot,
			nr_seq_conta_princ,
			nr_seq_tipo_atendimento,
			nr_seq_evento_fat
		from	w_pls_lote_fat_mat
		where	nr_seq_lote_fat = nr_seq_lote_fat_pc
		and	coalesce(nr_seq_pos_mat_tx::text, '') = ''  -- Nao considera taxa
		) a
	group by nr_seq_conta,
		cd_guia_ok,
		nr_seq_segurado,
		ie_tipo_guia,
		ie_apresentacao_prot,
		nr_seq_conta_princ,
		nr_seq_tipo_atendimento
	order by nr_seq_conta;
	
C02 CURSOR(	cd_guia_ok_pc		pls_conta.cd_guia_ok%type,
		nr_seq_segurado_pc	pls_conta.nr_seq_segurado%type,
		nr_seq_lote_fat_pc	pls_lote_faturamento.nr_sequencia%type ) FOR
	SELECT	i.nr_sequencia nr_seq_conta_pos_proc,
		null nr_seq_conta_pos_mat,
		i.nr_seq_conta,
		c.nr_seq_segurado,
		c.cd_guia_ok
	from	pls_conta_pos_proc i,
		pls_conta_pos_cab_v c,
		pls_protocolo_conta p
	where	p.nr_sequencia	= c.nr_seq_protocolo
	and	c.nr_sequencia	= i.nr_seq_conta
	and	c.cd_guia_ok			= cd_guia_ok_pc
	and	c.nr_seq_segurado		= nr_seq_segurado_pc
	and	i.ie_status_faturamento		= 'L'
	and	c.ie_status			= 'F'
	and	coalesce(i.nr_seq_lote_fat::text, '') = ''
	and	coalesce(i.nr_seq_evento_fat::text, '') = ''
	and (current_setting('pls_faturamento_pck.ie_contas_faturar_w')::pls_parametro_faturamento.ie_contas_faturar%type = 'CF' or p.ie_status in ('3','6'))
	and	not exists (SELECT	1
				from	pls_conta z
				where	z.nr_seq_conta_referencia = c.nr_sequencia
				and	(z.nr_seq_ajuste_fat IS NOT NULL AND z.nr_seq_ajuste_fat::text <> ''))
	and	not exists (select	1
				from	w_pls_lote_fat_proc w
				where	w.nr_seq_lote_fat	= nr_seq_lote_fat_pc
				and	w.nr_seq_conta		= i.nr_seq_conta)
	
union all

	select	null nr_seq_conta_pos_proc,
		i.nr_sequencia nr_seq_conta_pos_mat,
		i.nr_seq_conta,
		c.nr_seq_segurado,
		c.cd_guia_ok
	from	pls_conta_pos_mat i,
		pls_conta_pos_cab_v c,
		pls_protocolo_conta p
	where	p.nr_sequencia	= c.nr_seq_protocolo
	and	c.nr_sequencia	= i.nr_seq_conta
	and	c.cd_guia_ok			= cd_guia_ok_pc
	and	c.nr_seq_segurado		= nr_seq_segurado_pc
	and	i.ie_status_faturamento		= 'L'
	and	c.ie_status			= 'F'
	and	coalesce(i.nr_seq_lote_fat::text, '') = ''
	and	coalesce(i.nr_seq_evento_fat::text, '') = ''
	and (current_setting('pls_faturamento_pck.ie_contas_faturar_w')::pls_parametro_faturamento.ie_contas_faturar%type = 'CF' or p.ie_status in ('3','6'))
	and	not exists (select	1
				from	pls_conta z
				where	z.nr_seq_conta_referencia = c.nr_sequencia
				and	(z.nr_seq_ajuste_fat IS NOT NULL AND z.nr_seq_ajuste_fat::text <> ''))
	and	not exists (select	1
				from	w_pls_lote_fat_mat w
				where	w.nr_seq_lote_fat	= nr_seq_lote_fat_pc
				and	w.nr_seq_conta		= i.nr_seq_conta)
	order by nr_seq_conta;
	
BEGIN
if (ie_somente_resumo_p = 'S') or
	(ie_conta_fechada_p = 'S' AND ie_apresentacao_prot_p != 'R') then
	for r_c01_w in c01( nr_seq_lote_fat_p ) loop
		-- Iniciar variaveis
		qt_conta_pos_proc_mat_w		:= 0;
		qt_conta_pos_proc_atend_w	:= 0;
		qt_conta_pos_mat_atend_w	:= 0;
		qt_guia_resumo_w		:= 0;

		-- Conta fechada
		-- Lote de faturamento nao pode estar restringindo por protocolo de reapresentacao
		if (ie_conta_fechada_p = 'S') and (ie_apresentacao_prot_p != 'R') then
			
			select	coalesce(min(qt),0)
			into STRICT	qt_conta_pos_proc_mat_w
			from (	SELECT	1 qt -- Existe procedimento da conta faturada que nao foi faturado
					from	pls_conta_pos_proc	p
					where	p.nr_seq_conta = r_c01_w.nr_seq_conta
					and	p.ie_status_faturamento in ('D', 'L', 'P', 'U', 'F')
					and	coalesce(p.nr_seq_lote_disc::text, '') = ''
					and	coalesce(p.nr_seq_conta_rec::text, '') = ''
					and	not exists (select	1
								from	w_pls_lote_fat_proc wp
								where	wp.nr_seq_lote_fat	= nr_seq_lote_fat_p
								and	wp.nr_seq_conta 	= r_c01_w.nr_seq_conta
								and	wp.nr_seq_pos_proc	= p.nr_sequencia)
					
union all

					SELECT	2 qt -- Existe material da conta faturada que nao foi faturado
					from	pls_conta_pos_mat m
					where	m.nr_seq_conta = r_c01_w.nr_seq_conta
					and	m.ie_status_faturamento in ('D', 'L', 'P', 'U', 'F')
					and	coalesce(m.nr_seq_lote_disc::text, '') = ''
					and	coalesce(m.nr_seq_conta_rec::text, '') = '' 
					and	not exists (select	1
								from	w_pls_lote_fat_mat wm
								where	wm.nr_seq_lote_fat	= nr_seq_lote_fat_p
								and	wm.nr_seq_conta 	= r_c01_w.nr_seq_conta
								and	wm.nr_seq_pos_mat	= m.nr_sequencia)
					
union all

					select	3 qt -- Existe conta do atendimento sem pos gerado
					from	pls_conta_v c
					where	c.cd_guia_referencia	= r_c01_w.cd_guia_ok
					and	c.nr_seq_segurado	= r_c01_w.nr_seq_segurado
					and	c.ie_apresentacao	!= 'R'
					and 	c.ie_status		!= 'C'
					and	r_c01_w.ie_guia_int_sp	= 'S' -- Atendimento com guia de internacao ou SP/SADT
 
					and	not exists (	select	1
								from	pls_conta_pos_proc	d
								where	d.nr_seq_conta		= c.nr_sequencia
								
union

								select	1
								from	pls_conta_pos_mat	d
								where	d.nr_seq_conta		= c.nr_sequencia)
					
union all

					select	4 qt -- Existe conta do atendimento que na PLS_CONTA o status de faturamento nao esta liberado
					from	pls_conta_v c
					where	c.cd_guia_referencia		= r_c01_w.cd_guia_ok
					and	c.nr_seq_segurado 		= r_c01_w.nr_seq_segurado
					and	c.ie_apresentacao		= r_c01_w.ie_apresentacao_prot
					and 	c.ie_status			!= 'C'
					and	coalesce(c.ie_status_fat, 'N') 	!= 'L'
					and	r_c01_w.ie_guia_int_sp		= 'S' -- Atendimento com guia de internacao ou SP/SADT
 
					
union all

					select	5 qt -- Existe conta do atendimento que esta na excecao da regra do lote de faturamento
					from	pls_conta		c,
						pls_lote_fat_excecao	e
					where	c.nr_sequencia		= e.nr_seq_conta
					and	c.cd_guia_ok		= r_c01_w.cd_guia_ok
					and	c.nr_seq_segurado 	= r_c01_w.nr_seq_segurado
					and	e.nr_seq_lote		= nr_seq_lote_fat_p
					and 	c.ie_status		!= 'C'
					and	r_c01_w.ie_guia_int_sp	= 'S' -- Atendimento com guia de internacao ou SP/SADT
 
					
union all
			
					select	6 -- Existe conta do atendimento em lote de contestacao em aberto
					from	pls_lote_contestacao l,
						pls_contestacao  c,
						pls_conta a
					where	l.nr_sequencia		= c.nr_seq_lote
					and	a.nr_sequencia		= c.nr_seq_conta
					and	a.cd_guia_ok		= r_c01_w.cd_guia_ok
					and	a.nr_seq_segurado	= r_c01_w.nr_seq_segurado
					and	l.ie_status		!= 'C'
					and	(l.nr_seq_ptu_fatura IS NOT NULL AND l.nr_seq_ptu_fatura::text <> '')  
					
union all

					select	7 -- Existe conta de SP/SADT e o tipo de atendimento SADT Internado, mas a guia referencia desta nao e Guia de Resumo de Internacao
					from	pls_conta	x
					where	x.nr_sequencia			= r_c01_w.nr_seq_conta
					and	r_c01_w.cd_tipo_atendimento	= '07' -- SADT Internado
					and	r_c01_w.ie_tipo_guia		= '4' -- SP/SADT
					and	r_c01_w.ie_apresentacao_prot	!= 'R' -- Nao considerar reapresentacao
					and 	not exists (	select	1
								from	pls_conta		y
								where	y.cd_guia_ok		= x.cd_guia_ok
								and	y.nr_seq_segurado	= x.nr_seq_segurado
								and	y.ie_tipo_guia		= '5')
					and 	not exists (	select	1
								from	pls_conta		y
								where	y.cd_guia		= x.cd_guia_ok
								and	y.nr_seq_segurado	= x.nr_seq_segurado
								and	y.ie_tipo_guia		= '5')
					
union all

					select	8 --  Conforme parametro, nao sendo por conta fechada, tem conta fora de protocolo e nao esta "Liberado para pagamento" e "Pago" - Procedimento
					from	pls_conta_pos_proc_contab ctb,
						pls_conta_pos_proc	i,
						pls_protocolo_conta	b,
						pls_conta		c
					where	b.nr_sequencia			= c.nr_seq_protocolo
					and	c.nr_sequencia			= i.nr_seq_conta
					and	i.nr_sequencia			= ctb.nr_seq_conta_pos_proc
					and	c.cd_guia_ok			= r_c01_w.cd_guia_ok
					and	c.nr_seq_segurado		= r_c01_w.nr_seq_segurado
					and	i.ie_status_faturamento		= 'L'
					and	c.ie_status			= 'F'
					and	current_setting('pls_faturamento_pck.ie_contas_faturar_w')::pls_parametro_faturamento.ie_contas_faturar%type		!= 'CF'
					and	coalesce(i.nr_seq_lote_fat::text, '') = ''
					and	coalesce(i.nr_seq_evento_fat::text, '') = ''
					and	b.ie_status not in ('3', '4', '6', '7')
					and	not exists (	select	1
								from	w_pls_lote_fat_proc wp
								where	wp.nr_seq_lote_fat	= nr_seq_lote_fat_p
								and	wp.nr_seq_conta 	= r_c01_w.nr_seq_conta
								and	wp.nr_seq_pos_proc	= i.nr_sequencia)
					
union all

					select	9 --  Conforme parametro, nao sendo por conta fechada, tem conta fora de protocolo e nao esta "Liberado para pagamento" e "Pago" - Material
					from	pls_conta_pos_mat_contab ctb,
						pls_conta_pos_mat	i,
						pls_protocolo_conta	b,
						pls_conta		c
					where	b.nr_sequencia			= c.nr_seq_protocolo
					and	c.nr_sequencia			= i.nr_seq_conta
					and	i.nr_sequencia			= ctb.nr_seq_conta_mat_pos
					and	c.cd_guia_ok			= r_c01_w.cd_guia_ok
					and	c.nr_seq_segurado		= r_c01_w.nr_seq_segurado
					and	i.ie_status_faturamento		= 'L'
					and	c.ie_status			= 'F'
					and	current_setting('pls_faturamento_pck.ie_contas_faturar_w')::pls_parametro_faturamento.ie_contas_faturar%type		!= 'CF'
					and	coalesce(i.nr_seq_lote_fat::text, '') = ''
					and	coalesce(i.nr_seq_evento_fat::text, '') = ''
					and	b.ie_status not in ('3', '4', '6', '7')
					and	not exists (	select	1
								from	w_pls_lote_fat_mat wm
								where	wm.nr_seq_lote_fat	= nr_seq_lote_fat_p
								and	wm.nr_seq_conta 	= r_c01_w.nr_seq_conta
								and	wm.nr_seq_pos_mat	= i.nr_sequencia)
				 LIMIT 1) alias27;
				
			if (qt_conta_pos_proc_mat_w > 0) then
				-- Se for reapresentacao, remove a conta
				if (r_c01_w.ie_apresentacao_prot = 'R') then
					delete	FROM w_pls_lote_fat_proc
					where	nr_seq_lote_fat = nr_seq_lote_fat_p
					and	nr_seq_conta	= r_c01_w.nr_seq_conta;
					
					delete	FROM w_pls_lote_fat_mat
					where	nr_seq_lote_fat = nr_seq_lote_fat_p
					and	nr_seq_conta	= r_c01_w.nr_seq_conta;
				else
				-- Se for apresentacao, remove todo o atendimento
					delete	FROM w_pls_lote_fat_proc
					where	cd_guia_ok		= r_c01_w.cd_guia_ok
					and	nr_seq_segurado		= r_c01_w.nr_seq_segurado
					and	nr_seq_lote_fat 	= nr_seq_lote_fat_p
					and	ie_apresentacao_prot 	!= 'R'; -- Nao considerar reapresentacao
					
					delete	FROM w_pls_lote_fat_mat
					where	cd_guia_ok		= r_c01_w.cd_guia_ok
					and	nr_seq_segurado		= r_c01_w.nr_seq_segurado
					and	nr_seq_lote_fat 	= nr_seq_lote_fat_p
					and	ie_apresentacao_prot 	!= 'R'; -- Nao considerar reapresentacao
				end if;		

				-- Verificar por qual motivo a conta foi removida
				ds_observacao_w	:= 	case qt_conta_pos_proc_mat_w
								when 1 then wheb_mensagem_pck.get_texto(1108922)
								when 2 then wheb_mensagem_pck.get_texto(1108923)
								when 3 then wheb_mensagem_pck.get_texto(1108924)
								when 4 then wheb_mensagem_pck.get_texto(1108925)
								when 5 then wheb_mensagem_pck.get_texto(1108927)
								when 6 then wheb_mensagem_pck.get_texto(1108928)
								when 7 then wheb_mensagem_pck.get_texto(1108929)
								when 8 then wheb_mensagem_pck.get_texto(1108930)
								when 9 then wheb_mensagem_pck.get_texto(1108931)
							end;
				
				-- Gravar log de exclusao
				CALL pls_gerar_fatura_log( nr_seq_lote_fat_p, null, r_c01_w.nr_seq_conta, 'TRATAR_FAT_CONTA_FECHADA - Conta removida do faturamento (1) - ' || ds_observacao_w, 'TC', 'N', nm_usuario_p);
			end if;
			
			if (qt_conta_pos_proc_mat_w = 0) and (r_c01_w.ie_apresentacao_prot != 'R') then -- Nao considerar reapresentacao
				
				-- Verificar pelo CD_GUIA_OK
				select	count(t.nr_seq_pos_proc)
				into STRICT	qt_conta_pos_proc_atend_w
				from (	SELECT	c.nr_sequencia nr_seq_pos_proc
						from	pls_conta_pos_proc	c,
							pls_conta		b,
							pls_protocolo_conta	a
						where	a.nr_sequencia		= b.nr_seq_protocolo
						and	b.nr_sequencia		= c.nr_seq_conta
						and	b.cd_guia_ok 		= r_c01_w.cd_guia_ok
						and	b.nr_seq_segurado	= r_c01_w.nr_seq_segurado
						and	a.ie_apresentacao	= r_c01_w.ie_apresentacao_prot
						and	c.ie_status_faturamento not in ('C','N','A')
						and	coalesce(c.nr_seq_lote_disc::text, '') = ''
						and	coalesce(c.nr_seq_conta_rec::text, '') = ''
						and	coalesce(b.nr_seq_ajuste_fat::text, '') = ''
						EXCEPT
						SELECT	d.nr_seq_pos_proc
						from	w_pls_lote_fat_proc	d
						where	d.cd_guia_ok 		= r_c01_w.cd_guia_ok
						and	d.nr_seq_segurado	= r_c01_w.nr_seq_segurado
						and	d.nr_seq_lote_fat	= nr_seq_lote_fat_p) t;
						
				-- Se nao encontrar, verificar pelo NR_SEQ_CONTA_PRINC
				if (qt_conta_pos_proc_atend_w = 0) then
					select	count(t.nr_seq_pos_proc)
					into STRICT	qt_conta_pos_proc_atend_w
					from (	SELECT	c.nr_sequencia nr_seq_pos_proc
							from	pls_conta_pos_proc	c,
								pls_conta		b,
								pls_protocolo_conta	a
							where	a.nr_sequencia		= b.nr_seq_protocolo
							and	b.nr_sequencia		= c.nr_seq_conta
							and	b.nr_seq_conta_princ 		= r_c01_w.nr_seq_conta_princ
							and	b.nr_seq_segurado		= r_c01_w.nr_seq_segurado
							and	b.cd_guia_ok 		= r_c01_w.cd_guia_ok
							and	a.ie_apresentacao	= r_c01_w.ie_apresentacao_prot
							and	c.ie_status_faturamento not in ('C','N','A')
							and	coalesce(c.nr_seq_lote_disc::text, '') = ''
							and	coalesce(c.nr_seq_conta_rec::text, '') = ''
							and	coalesce(b.nr_seq_ajuste_fat::text, '') = ''
							EXCEPT
							SELECT	d.nr_seq_pos_proc
							from	w_pls_lote_fat_proc	d
							where	d.nr_seq_conta_princ 	= r_c01_w.nr_seq_conta_princ
							and	d.nr_seq_segurado	= r_c01_w.nr_seq_segurado
							and	d.nr_seq_lote_fat	= nr_seq_lote_fat_p) t;
				end if;
						
				if (qt_conta_pos_proc_atend_w > 0) then
					delete	FROM w_pls_lote_fat_proc
					where	cd_guia_ok		= r_c01_w.cd_guia_ok
					and	nr_seq_segurado		= r_c01_w.nr_seq_segurado
					and	nr_seq_lote_fat 	= nr_seq_lote_fat_p;
					--and	ie_apresentacao_prot 	!= 'R'; -- Nao considerar reapresentacao
					
					delete	FROM w_pls_lote_fat_mat
					where	cd_guia_ok		= r_c01_w.cd_guia_ok
					and	nr_seq_segurado		= r_c01_w.nr_seq_segurado
					and	nr_seq_lote_fat 	= nr_seq_lote_fat_p;
					--and	ie_apresentacao_prot 	!= 'R'; -- Nao considerar reapresentacao
					
					-- Gravar log de exclusao
					CALL pls_gerar_fatura_log( nr_seq_lote_fat_p, null, r_c01_w.nr_seq_conta, 'TRATAR_FAT_CONTA_FECHADA - '||wheb_mensagem_pck.get_texto(1108935)||' (2)', 'TC', 'N', nm_usuario_p);
				else	
					-- Verificar pelo CD_GUIA_OK
					select	count(t.nr_seq_pos_mat)
					into STRICT	qt_conta_pos_mat_atend_w
					from (	SELECT	c.nr_sequencia nr_seq_pos_mat
							from	pls_conta_pos_mat	c,
								pls_conta		b,
								pls_protocolo_conta	a
							where	a.nr_sequencia		= b.nr_seq_protocolo
							and	b.nr_sequencia		= c.nr_seq_conta
							and	b.cd_guia_ok 		= r_c01_w.cd_guia_ok
							and	b.nr_seq_segurado	= r_c01_w.nr_seq_segurado
							and	a.ie_apresentacao	= r_c01_w.ie_apresentacao_prot
							and	c.ie_status_faturamento not in ('C','N','A')
							and	coalesce(c.nr_seq_lote_disc::text, '') = ''
							and	coalesce(c.nr_seq_conta_rec::text, '') = ''
							and	coalesce(b.nr_seq_ajuste_fat::text, '') = ''
							EXCEPT
							SELECT	d.nr_seq_pos_mat
							from	w_pls_lote_fat_mat	d
							where	d.cd_guia_ok 		= r_c01_w.cd_guia_ok
							and	d.nr_seq_segurado	= r_c01_w.nr_seq_segurado
							and	d.nr_seq_lote_fat	= nr_seq_lote_fat_p) t;

					-- Se nao encontrar, verificar pelo NR_SEQ_CONTA_PRINC
					if (qt_conta_pos_mat_atend_w = 0) then
						select	count(t.nr_seq_pos_mat)
						into STRICT	qt_conta_pos_mat_atend_w
						from (	SELECT	c.nr_sequencia nr_seq_pos_mat
								from	pls_conta_pos_mat	c,
									pls_conta		b,
									pls_protocolo_conta	a
								where	a.nr_sequencia		= b.nr_seq_protocolo
								and	b.nr_sequencia		= c.nr_seq_conta
								and	b.nr_seq_conta_princ	= r_c01_w.nr_seq_conta_princ
								and	b.nr_seq_segurado	= r_c01_w.nr_seq_segurado
								and	a.ie_apresentacao	= r_c01_w.ie_apresentacao_prot
								and	c.ie_status_faturamento not in ('C','N','A')
								and	coalesce(c.nr_seq_lote_disc::text, '') = ''
								and	coalesce(c.nr_seq_conta_rec::text, '') = ''
								and	coalesce(b.nr_seq_ajuste_fat::text, '') = ''
								EXCEPT
								SELECT	d.nr_seq_pos_mat
								from	w_pls_lote_fat_mat	d
								where	d.nr_seq_conta_princ	= r_c01_w.nr_seq_conta_princ
								and	d.nr_seq_segurado	= r_c01_w.nr_seq_segurado
								and	d.nr_seq_lote_fat	= nr_seq_lote_fat_p) t;
					end if;
							
					if (qt_conta_pos_mat_atend_w > 0) then
						delete	FROM w_pls_lote_fat_proc
						where	cd_guia_ok		= r_c01_w.cd_guia_ok
						and	nr_seq_segurado		= r_c01_w.nr_seq_segurado
						and	nr_seq_lote_fat 	= nr_seq_lote_fat_p;
						--and	ie_apresentacao_prot 	!= 'R'; -- Nao considerar reapresentacao
						
						delete	FROM w_pls_lote_fat_mat
						where	cd_guia_ok		= r_c01_w.cd_guia_ok
						and	nr_seq_segurado		= r_c01_w.nr_seq_segurado
						and	nr_seq_lote_fat 	= nr_seq_lote_fat_p;
						--and	ie_apresentacao_prot 	!= 'R'; -- Nao considerar reapresentacao
						
						-- Gravar log de exclusao
						CALL pls_gerar_fatura_log( nr_seq_lote_fat_p, null, r_c01_w.nr_seq_conta, 'TRATAR_FAT_CONTA_FECHADA - '||wheb_mensagem_pck.get_texto(1108935)||' (3)', 'TC', 'N', nm_usuario_p);
					end if;
				end if;
			end if;
			
			-- Se a conta nao for removida por questao alguma, entao forca a entrada do que falta do atendimento
			if (r_c01_w.ie_apresentacao_prot = 'R') and -- Somente entrar em caso de reapresentacao
				((qt_conta_pos_proc_atend_w + qt_conta_pos_mat_atend_w + qt_conta_pos_proc_mat_w + qt_guia_resumo_w) = 0) then
			
				for r_c02_w in c02( r_c01_w.cd_guia_ok, r_c01_w.nr_seq_segurado, nr_seq_lote_fat_p ) loop
					CALL pls_faturamento_pck.vincular_contas_fat( nr_seq_lote_fat_p, cd_estabelecimento_p, nm_usuario_p, 'CF', r_c02_w.nr_seq_conta_pos_proc, r_c02_w.nr_seq_conta_pos_mat, r_c01_w.nr_seq_evento_fat);
					
					CALL pls_gerar_fatura_log(	nr_seq_lote_fat_p, null, r_c02_w.nr_seq_conta, 'TRATAR_FAT_CONTA_FECHADA - Conta inserida no faturamento (5) - '||r_c01_w.nr_seq_conta, 'TC', 'N', nm_usuario_p);
				end loop;
			end if;
		end if;
			
		if (ie_somente_resumo_p = 'S') then
			--Verificar se o tipo de guia e resumo de internacao neste caso nao precisa verificar mais nada
			if (r_c01_w.ie_tipo_guia != '5') and (ie_vinculo_manual_p = 'N') then
				--Verificar se existe ao menos uma conta de resumo de internacao integrada
				select	count(1)
				into STRICT	qt_conta_resumo_w
				from	pls_conta		c,
					pls_protocolo_conta	p
				where	c.cd_guia_ok		= r_c01_w.cd_guia_ok
				and	c.nr_seq_segurado	= r_c01_w.nr_seq_segurado
				and	c.ie_tipo_guia		= '5'
				and	c.ie_status		!= 'C'
				and	p.nr_sequencia		= c.nr_seq_protocolo
				and	p.ie_situacao		in ('D','T')  LIMIT 1;
				
				if (qt_conta_resumo_w = 0) then
					--Verificar se e filha de uma guia solicitacao de internacao
					select	count(1)
					into STRICT	qt_guia_resumo_w
					from	pls_guia_plano
					where	cd_guia		= r_c01_w.cd_guia_ok
					and	nr_seq_segurado	= r_c01_w.nr_seq_segurado
					and	ie_tipo_guia	= '1'  LIMIT 1;
					
					if (qt_guia_resumo_w > 0) then
						delete	FROM w_pls_lote_fat_proc
						where	cd_guia_ok		= r_c01_w.cd_guia_ok
						and	nr_seq_segurado		= r_c01_w.nr_seq_segurado
						and	nr_seq_lote_fat 	= nr_seq_lote_fat_p
						and	ie_apresentacao_prot	!= 'R'; -- Nao considerar reapresentacao
					
						delete	FROM w_pls_lote_fat_mat
						where	cd_guia_ok		= r_c01_w.cd_guia_ok
						and	nr_seq_segurado		= r_c01_w.nr_seq_segurado
						and	nr_seq_lote_fat 	= nr_seq_lote_fat_p
						and	ie_apresentacao_prot	!= 'R'; -- Nao considerar reapresentacao
						
						-- Gravar log de exclusao
						CALL pls_gerar_fatura_log( nr_seq_lote_fat_p, null, r_c01_w.nr_seq_conta, 'TRATAR_FAT_CONTA_FECHADA - '||wheb_mensagem_pck.get_texto(1108935)||' (4)', 'TC', 'N', nm_usuario_p);
					end if;
				end if;
			end if;
		end if;
	end loop;
end if;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_faturamento_pck.tratar_fat_conta_fechada ( nr_seq_lote_fat_p pls_lote_faturamento.nr_sequencia%type, ie_conta_fechada_p pls_regra_faturamento.ie_conta_fechada%type, ie_apresentacao_prot_p pls_lote_faturamento.ie_apresentacao_prot%type, ie_somente_resumo_p pls_regra_faturamento.ie_somente_resumo%type, ie_vinculo_manual_p text, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;
