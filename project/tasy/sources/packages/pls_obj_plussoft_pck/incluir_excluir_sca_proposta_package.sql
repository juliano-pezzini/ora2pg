-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_obj_plussoft_pck.incluir_excluir_sca_proposta ( nr_seq_proposta_p bigint, nr_seq_plano_sca_p bigint, ie_acao_p text, cd_pessoa_usuario_p text, ds_erro_p INOUT text) AS $body$
DECLARE

/*
ie_acao_p:
'E' - Excluir
'I' - incluir
*/
dt_inicio_proposta_w		pls_proposta_adesao.dt_inicio_proposta%type;
current_setting('pls_obj_plussoft_pck.nm_usuario_w')::usuario.nm_usuario%type			usuario.nm_usuario%type;
nr_seq_tab_sca_w		pls_regra_simulador_web.nr_seq_tabela%type;
			
current_setting('pls_obj_plussoft_pck.c01')::CURSOR CURSOR FOR
	SELECT	nr_sequencia
	from 	pls_proposta_beneficiario
	where 	nr_seq_proposta = nr_seq_proposta_p
	order by 1;
BEGIN

begin
select	max(nm_usuario)
into STRICT	current_setting('pls_obj_plussoft_pck.nm_usuario_w')::usuario.nm_usuario%type
from	usuario
where	cd_pessoa_fisica = cd_pessoa_usuario_p
and	ie_situacao = 'A';
exception
when others then
	PERFORM set_config('pls_obj_plussoft_pck.nm_usuario_w', null, false);
end;

if (coalesce(nr_seq_proposta_p::text, '') = '') then
	ds_erro_p := substr(wheb_mensagem_pck.get_texto(1110437)  ,1,255);
end if;

if (coalesce(nr_seq_plano_sca_p::text, '') = '') and (coalesce(ds_erro_p::text, '') = '') then
	ds_erro_p := substr(wheb_mensagem_pck.get_texto(1110444) ,1,255);
end if;

if (coalesce(ds_erro_p::text, '') = '') then
	--'E' - Excluir
	if (ie_acao_p = 'E') then
		for r_C01_w in current_setting('pls_obj_plussoft_pck.c01')::loop CURSOR
			begin
			delete
			from 	pls_sca_vinculo
			where	nr_seq_benef_proposta = r_C01_w.nr_sequencia
			and	nr_seq_plano = nr_seq_plano_sca_p;
			exception
			when others then
				ds_erro_p := substr(wheb_mensagem_pck.get_texto(1110445) || ' ' || sqlerrm(SQLSTATE), 1, 255);
			end;
		end loop;
	
	--'I' - incluir
	elsif (ie_acao_p = 'I') then
		begin
		select	max(nr_seq_tabela)
		into STRICT	nr_seq_tab_sca_w
		from	pls_regra_simulador_web
		where	nr_seq_plano = nr_seq_plano_sca_p
		and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
		and	clock_timestamp() between pls_util_pck.obter_dt_vigencia_null(dt_inicio_vigencia,'I') and pls_util_pck.obter_dt_vigencia_null(dt_fim_vigencia,'F');
		exception
		when others then
			nr_seq_tab_sca_w := null;
		end;
		
		begin
		select	max(dt_inicio_proposta)
		into STRICT	dt_inicio_proposta_w
		from 	pls_proposta_adesao
		where 	nr_sequencia = nr_seq_proposta_p;
		exception
		when others then
			dt_inicio_proposta_w := null;
		end;
		
		for r_C01_w in current_setting('pls_obj_plussoft_pck.c01')::loop CURSOR
			begin
			insert into pls_sca_vinculo(	nr_sequencia,dt_atualizacao, nm_usuario, dt_atualizacao_nrec, nm_usuario_nrec,
					nr_seq_benef_proposta, nr_seq_plano, nr_seq_tabela, nr_seq_vendedor_canal, nr_seq_vendedor_pf,
					dt_inicio_vigencia)
			values (	nextval('pls_sca_vinculo_seq'), clock_timestamp(), current_setting('pls_obj_plussoft_pck.nm_usuario_w')::usuario.nm_usuario%type, clock_timestamp(), current_setting('pls_obj_plussoft_pck.nm_usuario_w')::usuario.nm_usuario%type,
					r_C01_w.nr_sequencia, nr_seq_plano_sca_p, nr_seq_tab_sca_w, null, null,
					dt_inicio_proposta_w);
			exception
			when others then
				ds_erro_p := substr(wheb_mensagem_pck.get_texto(1110446) || ' ' || sqlerrm(SQLSTATE), 1, 255);
			end;
		end loop;
	end if;
	
	if (coalesce(ds_erro_p::text, '') = '') then
		commit;
	else
		rollback;
	end if;
	
end if;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_obj_plussoft_pck.incluir_excluir_sca_proposta ( nr_seq_proposta_p bigint, nr_seq_plano_sca_p bigint, ie_acao_p text, cd_pessoa_usuario_p text, ds_erro_p INOUT text) FROM PUBLIC;
