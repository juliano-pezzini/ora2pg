-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_obj_plussoft_pck.salvar_portabilidade ( cd_pessoa_fisica_p pessoa_fisica.cd_pessoa_fisica%type, dt_solicitacao_p timestamp, dt_resposta_p timestamp, dt_contratacao_origem_p timestamp, vl_preco_origem_p pls_portab_pessoa.vl_preco_origem%type, nr_seq_portab_operadora_p pls_portab_pessoa.nr_seq_portab_operadora%type, ie_abrangencia_p pls_portab_pessoa.ie_abrangencia%type, nr_prot_ans_origem_p pls_portab_pessoa.nr_prot_ans_origem%type, ie_segmentacao_p pls_portab_pessoa.ie_segmentacao%type, ie_tipo_contratacao_p pls_portab_pessoa.ie_tipo_contratacao%type, nr_seq_plano_p pls_portab_pessoa.nr_seq_plano%type, nr_seq_tabela_p pls_portab_pessoa.nr_seq_tabela%type, nr_seq_motivo_recusa_p pls_portab_pessoa.nr_seq_motivo_recusa%type, ie_status_portabiidade_p pls_portab_pessoa.ie_status%type, nr_seq_benef_prop_adesao_p pls_proposta_beneficiario.nr_sequencia%type, cd_pessoa_usuario_p pessoa_fisica.cd_pessoa_fisica%type, nr_seq_portabilidade_p INOUT pls_portab_pessoa.nr_sequencia%type, ds_mensagem_p INOUT text ) AS $body$
DECLARE


ie_valido_w			boolean;
nr_seq_portabilidade_w		pls_portab_pessoa.nr_sequencia%type;
cd_pessoa_fisica_w		pls_portab_pessoa.cd_pessoa_fisica%type;
nr_seq_portab_operadora_w	pls_portab_pessoa.nr_seq_portab_operadora%type;
nr_seq_plano_w			pls_portab_pessoa.nr_seq_plano%type;
nr_seq_tabela_w			pls_portab_pessoa.nr_seq_tabela%type;
current_setting('pls_obj_plussoft_pck.nm_usuario_w')::usuario.nm_usuario%type			usuario.nm_usuario%type;
current_setting('pls_obj_plussoft_pck.cd_estabelecimento_w')::smallint		estabelecimento.cd_estabelecimento%type;
nr_seq_protocolo_atend_w	pls_protocolo_atendimento.nr_sequencia%type;
nr_protocolo_atend_w		pls_protocolo_atendimento.nr_protocolo%type;


BEGIN
--Encontra o usuario
begin
select	max(nm_usuario)
into STRICT	current_setting('pls_obj_plussoft_pck.nm_usuario_w')::usuario.nm_usuario%type
from	usuario
where	cd_pessoa_fisica = cd_pessoa_usuario_p
and	ie_situacao = 'A';
exception
when others then
	PERFORM set_config('pls_obj_plussoft_pck.nm_usuario_w', null, false);
end;

ie_valido_w := true;

--Valida PF
if (ie_valido_w and (cd_pessoa_fisica_p IS NOT NULL AND cd_pessoa_fisica_p::text <> '')) then
	begin
	select	cd_pessoa_fisica,
		cd_estabelecimento
	into STRICT	cd_pessoa_fisica_w,
		current_setting('pls_obj_plussoft_pck.cd_estabelecimento_w')::smallint
	from	pessoa_fisica
	where	cd_pessoa_fisica = cd_pessoa_fisica_p;
	exception
	when others then
		ds_mensagem_p := substr((ds_mensagem_p || wheb_mensagem_pck.get_texto(1110483) || ' ' || chr(13) || chr(10)),1,255);
		ie_valido_w := false;
	end;
end if;

--Valida Operadora
if (ie_valido_w and (nr_seq_portab_operadora_p IS NOT NULL AND nr_seq_portab_operadora_p::text <> '')) then
	begin
	select	nr_sequencia
	into STRICT	nr_seq_portab_operadora_w
	from	pls_portab_operadora
	where	nr_sequencia	= nr_seq_portab_operadora_p;
	exception
	when others then
		ds_mensagem_p := substr((ds_mensagem_p || wheb_mensagem_pck.get_texto(1110484) || ' ' || chr(13) || chr(10)),1,255);
		ie_valido_w := false;
	end;
end if;

--Valida Plano
if (ie_valido_w and (nr_seq_plano_p IS NOT NULL AND nr_seq_plano_p::text <> '')) then
	begin
	select	nr_sequencia
	into STRICT	nr_seq_plano_w
	from	pls_plano
	where	nr_sequencia = nr_seq_plano_p;
	exception
	when others then
		ds_mensagem_p := substr((ds_mensagem_p || wheb_mensagem_pck.get_texto(1110487) || ' ' || chr(13) || chr(10)),1,255);
		ie_valido_w := false;
	end;
end if;

--Valida tabela
if (ie_valido_w and (nr_seq_tabela_p IS NOT NULL AND nr_seq_tabela_p::text <> '')) then
	begin
	select	nr_sequencia
	into STRICT	nr_seq_tabela_w
	from	pls_tabela_preco
	where	nr_sequencia = nr_seq_tabela_p;
	exception
	when others then
		ds_mensagem_p := substr((ds_mensagem_p || wheb_mensagem_pck.get_texto(1110488) || ' ' || chr(13) || chr(10)),1,255);
		ie_valido_w := false;
	end;
end if;

if (ie_valido_w) then
	--Valida abrangencia
	if (	(ie_abrangencia_p IS NOT NULL AND ie_abrangencia_p::text <> '') and ie_valido_w and
			not ie_abrangencia_p in ('E','GE','GM','M','N')) then
		ds_mensagem_p := substr((ds_mensagem_p || wheb_mensagem_pck.get_texto(1110489) || ' ' || chr(13) || chr(10)),1,255);
		ie_valido_w := false;
	end if;
	--Valida segmentacao
	 if (	(ie_segmentacao_p IS NOT NULL AND ie_segmentacao_p::text <> '') and ie_valido_w and
			not ie_segmentacao_p in ('1','2','3','4','5','6','7','8','9','10','11','12')) then
		ds_mensagem_p := substr((ds_mensagem_p || wheb_mensagem_pck.get_texto(1110490) || ' ' || chr(13) || chr(10)),1,255);
		ie_valido_w := false;
	 end if;
	--Valida status
	 if (	(ie_status_portabiidade_p IS NOT NULL AND ie_status_portabiidade_p::text <> '') and ie_valido_w and
			not ie_status_portabiidade_p in ('A','R','U')) then
		ds_mensagem_p := substr((ds_mensagem_p || wheb_mensagem_pck.get_texto(1110491) || ' ' || chr(13) || chr(10)),1,255);
		ie_valido_w := false;
	 end if;
	--Valida contratacao
	 if (	(ie_tipo_contratacao_p IS NOT NULL AND ie_tipo_contratacao_p::text <> '') and ie_valido_w and
			not ie_tipo_contratacao_p in ('CE','CA','I')) then
		ds_mensagem_p := substr((ds_mensagem_p || wheb_mensagem_pck.get_texto(1110492) || ' ' || chr(13) || chr(10)),1,255);
		ie_valido_w := false;
	 end if;
end if;

 --Verifica se passou pela validacao
 if (ie_valido_w) then
	if (coalesce(nr_seq_portabilidade_p::text, '') = '') then
		begin
		select	nextval('pls_portab_pessoa_seq')
		into STRICT	nr_seq_portabilidade_w
		;
		
		insert into pls_portab_pessoa(	nr_sequencia,
						cd_pessoa_fisica,
						dt_solicitacao,
						dt_resposta,
						vl_preco_origem,
						ie_abrangencia,
						ie_segmentacao,
						ie_tipo_contratacao,
						dt_atualizacao,
						nm_usuario,
						dt_atualizacao_nrec,
						nm_usuario_nrec,
						nr_seq_plano,
						nr_seq_tabela,
						nr_seq_portab_operadora,
						dt_contratacao_origem,
						nr_prot_ans_origem,
						nr_seq_motivo_recusa,
						ie_status,
						ie_adimplente,
						cd_estabelecimento,
						ie_origem_solicitacao)
					values (	nr_seq_portabilidade_w,
						cd_pessoa_fisica_w,
						dt_solicitacao_p,
						dt_resposta_p,
						vl_preco_origem_p,
						ie_abrangencia_p,
						ie_segmentacao_p,
						ie_tipo_contratacao_p,
						clock_timestamp(),
						current_setting('pls_obj_plussoft_pck.nm_usuario_w')::usuario.nm_usuario%type,
						clock_timestamp(),
						current_setting('pls_obj_plussoft_pck.nm_usuario_w')::usuario.nm_usuario%type,
						nr_seq_plano_w,
						nr_seq_tabela_w,
						nr_seq_portab_operadora_w,
						dt_contratacao_origem_p,
						nr_prot_ans_origem_p,
						nr_seq_motivo_recusa_p,
						ie_status_portabiidade_p,
						'N',
						current_setting('pls_obj_plussoft_pck.cd_estabelecimento_w')::smallint,
						'P');
		
		pls_gravar_protocolo_atend('10',null,null,null,null,null,null,null,nr_seq_portabilidade_w,null,current_setting('pls_obj_plussoft_pck.cd_estabelecimento_w')::smallint,current_setting('pls_obj_plussoft_pck.nm_usuario_w')::usuario.nm_usuario%type,nr_seq_protocolo_atend_w,nr_protocolo_atend_w);
		
		commit;
		nr_seq_portabilidade_p	:= nr_seq_portabilidade_w;
		exception
		when others then
			ds_mensagem_p := substr((ds_mensagem_p ||  sqlerrm(SQLSTATE)),1,255);
			rollback;
		end;
	else
		begin
		nr_seq_portabilidade_w	:= nr_seq_portabilidade_p;
		
		update 	pls_portab_pessoa
		set	cd_pessoa_fisica		= cd_pessoa_fisica_w,
			dt_solicitacao 			= dt_solicitacao_p,
			dt_resposta 			= dt_resposta_p,
			vl_preco_origem 		= vl_preco_origem_p,
			ie_abrangencia 			= ie_abrangencia_p,
			ie_segmentacao 			= ie_segmentacao_p,
			ie_tipo_contratacao 		= ie_tipo_contratacao_p,
			dt_atualizacao			= clock_timestamp(),
			nm_usuario 			= current_setting('pls_obj_plussoft_pck.nm_usuario_w')::usuario.nm_usuario%type,
			nr_seq_plano 			= nr_seq_plano_w,
			nr_seq_tabela 			= nr_seq_tabela_w,
			nr_seq_portab_operadora 	= nr_seq_portab_operadora_w,
			dt_contratacao_origem		= dt_contratacao_origem_p,
			nr_prot_ans_origem		= nr_prot_ans_origem_p,
			nr_seq_motivo_recusa 		= nr_seq_motivo_recusa_p,
			ie_status			= ie_status_portabiidade_p
		where 	nr_sequencia = nr_seq_portabilidade_p;
		
		pls_gravar_protocolo_atend('10',null,null,null,null,null,null,null,nr_seq_portabilidade_w,null,current_setting('pls_obj_plussoft_pck.cd_estabelecimento_w')::smallint,current_setting('pls_obj_plussoft_pck.nm_usuario_w')::usuario.nm_usuario%type,nr_seq_protocolo_atend_w,nr_protocolo_atend_w);
		commit;
		exception
		when others then
			ds_mensagem_p := substr((ds_mensagem_p ||  sqlerrm(SQLSTATE)),1,255);
			rollback;
		end;
	end if;
	
	if (coalesce(nr_seq_benef_prop_adesao_p,0) > 0) then
		update 	pls_proposta_beneficiario
		set	nr_seq_portabilidade 	= nr_seq_portabilidade_w
		where	nr_sequencia 		= nr_seq_benef_prop_adesao_p;
	end if;
end if;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_obj_plussoft_pck.salvar_portabilidade ( cd_pessoa_fisica_p pessoa_fisica.cd_pessoa_fisica%type, dt_solicitacao_p timestamp, dt_resposta_p timestamp, dt_contratacao_origem_p timestamp, vl_preco_origem_p pls_portab_pessoa.vl_preco_origem%type, nr_seq_portab_operadora_p pls_portab_pessoa.nr_seq_portab_operadora%type, ie_abrangencia_p pls_portab_pessoa.ie_abrangencia%type, nr_prot_ans_origem_p pls_portab_pessoa.nr_prot_ans_origem%type, ie_segmentacao_p pls_portab_pessoa.ie_segmentacao%type, ie_tipo_contratacao_p pls_portab_pessoa.ie_tipo_contratacao%type, nr_seq_plano_p pls_portab_pessoa.nr_seq_plano%type, nr_seq_tabela_p pls_portab_pessoa.nr_seq_tabela%type, nr_seq_motivo_recusa_p pls_portab_pessoa.nr_seq_motivo_recusa%type, ie_status_portabiidade_p pls_portab_pessoa.ie_status%type, nr_seq_benef_prop_adesao_p pls_proposta_beneficiario.nr_sequencia%type, cd_pessoa_usuario_p pessoa_fisica.cd_pessoa_fisica%type, nr_seq_portabilidade_p INOUT pls_portab_pessoa.nr_sequencia%type, ds_mensagem_p INOUT text ) FROM PUBLIC;
