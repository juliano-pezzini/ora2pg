-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pls_obj_plussoft_pck.obter_dados_contrato ( nr_contrato_p pls_contrato.nr_contrato%type, cd_usuario_plano_p pls_segurado_carteira.cd_usuario_plano%type) RETURNS SETOF T_DADOS_CONTRATO_DATA AS $body$
DECLARE

				
linha_w				t_dados_contrato_row;

nr_seq_plano_w			pls_plano.nr_sequencia%type;
ds_plano_w			pls_plano.ds_plano%type;
nr_protocolo_ans_w		pls_plano.nr_protocolo_ans%type;
cd_scpa_w			pls_plano.cd_scpa%type;
cd_pf_pagador_w 		pls_contrato_pagador.cd_pessoa_fisica%type;
cd_cgc_pagador_w 		pls_contrato_pagador.cd_cgc%type;
dt_dia_vencimento_w		pls_contrato_pagador_fin.dt_dia_vencimento%type;
nr_seq_forma_cobranca_w 	pls_contrato_pagador_fin.nr_seq_forma_cobranca%type;
cd_banco_w 			pls_contrato_pagador_fin.cd_banco%type;
cd_agencia_bancaria_w 		pls_contrato_pagador_fin.cd_agencia_bancaria%type;
cd_conta_w			pls_contrato_pagador_fin.cd_conta%type;
nr_seq_pagador_w		pls_contrato_pagador.nr_sequencia%type;
nm_tabela_w			pls_tabela_preco.nm_tabela%type;
nr_seq_tabela_w			pls_tabela_preco.nr_sequencia%type;
nm_pagador_w			varchar(255);
ie_tipo_contratacao_w		pls_proposta_adesao.ie_tipo_contratacao%type;
nr_seq_dia_vencimento_w		bigint;
ie_tipo_contratacao_plano_w	varchar(2);
ie_endereco_boleto_w		pls_contrato_pagador.ie_endereco_boleto%type;

--Com carteirinha
current_setting('pls_obj_plussoft_pck.c01')::CURSOR CURSOR(	nr_contrato_pc		pls_contrato.nr_contrato%type,
		cd_usuario_plano_pc	pls_segurado_carteira.cd_usuario_plano%type	) FOR
	SELECT	a.nr_contrato						nr_contrato,
		a.nr_sequencia						nr_seq_contrato,
		c.cd_usuario_plano					cd_usuario_plano,
		a.dt_contrato						dt_contrato,
		a.dt_aprovacao						dt_aprovacao,
		a.ie_situacao						ie_situacao_contrato,
		substr(obter_valor_dominio(1733,a.ie_situacao),1,50)	ds_situacao_contrato,
		a.cd_pf_estipulante					cd_pf_estipulante,
		a.cd_cgc_estipulante					cd_cgc_estipulante,
		b.cd_pessoa_fisica					cd_pf_segurado,
		b.nr_seq_parentesco					nr_seq_parentesco,
		(SELECT	max(x.dt_nascimento)
		from	pessoa_fisica x
		where	x.cd_pessoa_fisica = b.cd_pessoa_fisica) 	dt_nascimento,
		b.ie_nascido_plano					ie_nascido_plano,
		null							nr_seq_carencia,
		b.nr_seq_pagador					nr_seq_pagador,
		b.nr_seq_plano						nr_seq_plano,
		b.nr_seq_tabela						nr_seq_tabela,
		a.ie_participacao					cd_participacao_financ,
		a.qt_idade_limite_reaj					qt_idade_limite_reaj,
		a.qt_anos_limite_reaj					qt_anos_limite_reaj,
		(select	max(x.nm_tabela)
		from	pls_tabela_preco x
		where	x.nr_sequencia = b.nr_seq_tabela)		nm_tabela_preco,
		(select substr(obter_nome_pf(x.cd_pessoa_fisica),1,255) nm_pessoa_fisica
		from	pessoa_fisica x
		where	x.cd_pessoa_fisica = a.cd_pf_estipulante
		
union all

		select	y.ds_razao_social
		from	pessoa_juridica y
		where	y.cd_cgc	= a.cd_cgc_estipulante) nm_estipulante,
		a.nr_seq_proposta,
		a.nr_seq_indice_reajuste
	from	pls_contrato		a,
		pls_segurado		b,
		pls_segurado_carteira	c
	where	c.cd_usuario_plano	= cd_usuario_plano_pc
	and	b.nr_sequencia		= c.nr_seq_segurado
	and	a.nr_sequencia		= b.nr_seq_contrato
	and (coalesce(nr_contrato_pc::text, '') = ''
	or	a.nr_contrato		= nr_contrato_pc);

--Sem carteirinha
current_setting('pls_obj_plussoft_pck.c02')::CURSOR CURSOR(	nr_contrato_pc		pls_contrato.nr_contrato%type	) FOR
	SELECT	a.nr_contrato						nr_contrato,
		a.nr_sequencia						nr_seq_contrato,
		a.dt_contrato						dt_contrato,
		a.dt_aprovacao						dt_aprovacao,
		a.ie_situacao						ie_situacao_contrato,
		substr(obter_valor_dominio(1733,a.ie_situacao),1,50)	ds_situacao_contrato,
		a.cd_pf_estipulante					cd_pf_estipulante,
		a.cd_cgc_estipulante					cd_cgc_estipulante,
		a.ie_participacao					cd_participacao_financ,
		a.qt_idade_limite_reaj					qt_idade_limite_reaj,
		a.qt_anos_limite_reaj					qt_anos_limite_reaj,
		(SELECT substr(obter_nome_pf(x.cd_pessoa_fisica),1,255) nm_pessoa_fisica
		from	pessoa_fisica x
		where	x.cd_pessoa_fisica = a.cd_pf_estipulante
		
union all

		select	y.ds_razao_social
		from	pessoa_juridica y
		where	y.cd_cgc	= a.cd_cgc_estipulante) nm_estipulante,
		a.nr_seq_proposta,
		a.nr_seq_indice_reajuste
	from	pls_contrato		a
	where	a.nr_contrato		= nr_contrato_pc;
BEGIN

--Verifica se filtra pela carteirinha
if (cd_usuario_plano_p IS NOT NULL AND cd_usuario_plano_p::text <> '') then
	--Dados do contrato e beneficiarios
	for r_c01_w in current_setting('pls_obj_plussoft_pck.c01')::CURSOR(nr_contrato_p,cd_usuario_plano_p) loop
		linha_w.nr_contrato		:= r_c01_w.nr_contrato;
		linha_w.nr_seq_contrato		:= r_c01_w.nr_seq_contrato;
		linha_w.cd_usuario_plano	:= r_c01_w.cd_usuario_plano;
		linha_w.dt_vigencia		:= r_c01_w.dt_contrato;
		linha_w.dt_contrato		:= r_c01_w.dt_contrato;
		linha_w.dt_aprovacao		:= r_c01_w.dt_aprovacao;
		linha_w.ie_situacao_contrato	:= r_c01_w.ie_situacao_contrato;
		linha_w.ds_situacao_contrato	:= r_c01_w.ds_situacao_contrato;
		linha_w.nm_tabela_preco		:= r_c01_w.nm_tabela_preco;
		--Estipulante
		linha_w.cd_pf_estipulante	:= r_c01_w.cd_pf_estipulante;
		linha_w.cd_cgc_estipulante	:= r_c01_w.cd_cgc_estipulante;
		linha_w.nm_estipulante		:= r_c01_w.nm_estipulante;
		linha_w.cd_moeda		:= r_c01_w.nr_seq_indice_reajuste;
		linha_w.qt_idade_limite_reaj	:= r_c01_w.qt_idade_limite_reaj;
		linha_w.qt_anos_limite_reaj	:= r_c01_w.qt_anos_limite_reaj;
		linha_w.cd_participacao_financ	:= r_c01_w.cd_participacao_financ;
		--Proposta
		begin
		select	ie_tipo_contratacao
		into STRICT	ie_tipo_contratacao_w
		from	pls_proposta_adesao
		where	nr_sequencia	= r_c01_w.nr_seq_proposta;
		exception
		when others then
			ie_tipo_contratacao_w := null;
		end;
		linha_w.ie_tipo_contratacao := ie_tipo_contratacao_w;
		--Dados do plano
		begin
		select	nr_sequencia,
			ds_plano,
			nr_protocolo_ans,
			cd_scpa,
			ie_tipo_contratacao
		into STRICT	nr_seq_plano_w,
			ds_plano_w,
			nr_protocolo_ans_w,
			cd_scpa_w,
			ie_tipo_contratacao_plano_w
		from	pls_plano
		where	nr_sequencia	= r_c01_w.nr_seq_plano;
		exception
		when others then
			nr_seq_plano_w := null;
			ds_plano_w := null;
			nr_protocolo_ans_w := null;
			cd_scpa_w := null;
		end;
		
		if (coalesce(ie_tipo_contratacao_w::text, '') = '') then
			if (ie_tipo_contratacao_plano_w in ('CA', 'CE')) then
				ie_tipo_contratacao_w := 'C';
			else
				ie_tipo_contratacao_w := 'I';
			end if;
		else
			if (ie_tipo_contratacao_w in ('CA', 'CE')) then
				ie_tipo_contratacao_w := 'C';
			else
				ie_tipo_contratacao_w := 'I';
			end if;
		end if;
		--Produto
		linha_w.nr_seq_plano		:= nr_seq_plano_w;
		linha_w.ds_plano		:= ds_plano_w;
		linha_w.nr_protocolo_ans	:= nr_protocolo_ans_w;
		linha_w.cd_scpa			:= cd_scpa_w;
		--Pagador
		begin
		select	a.cd_pessoa_fisica,
			a.cd_cgc,
			pls_obter_dados_pagador(a.nr_sequencia,'D'),
			b.dt_dia_vencimento,
			b.nr_seq_forma_cobranca,
			b.cd_banco,
			b.cd_agencia_bancaria,
			b.cd_conta,
			a.ie_endereco_boleto,
			b.nr_seq_dia_vencimento
		into STRICT	cd_pf_pagador_w,
			cd_cgc_pagador_w,
			nm_pagador_w,
			dt_dia_vencimento_w,
			nr_seq_forma_cobranca_w,
			cd_banco_w,
			cd_agencia_bancaria_w,
			cd_conta_w,
			ie_endereco_boleto_w,
			nr_seq_dia_vencimento_w
		from	pls_contrato_pagador		a,
			pls_contrato_pagador_fin	b
		where	a.nr_sequencia 		= r_c01_w.nr_seq_pagador
		and	b.nr_seq_pagador 	= a.nr_sequencia
		and 	trunc(clock_timestamp()) between b.dt_inicio_vigencia and coalesce(b.dt_fim_vigencia,clock_timestamp());
		exception
		when others then
			cd_pf_pagador_w := null;
			cd_cgc_pagador_w := null;
			dt_dia_vencimento_w := null;
			nr_seq_forma_cobranca_w := null;
			cd_banco_w := null;
			cd_agencia_bancaria_w := null;
			cd_conta_w := null;
			nm_pagador_w := null;
			ie_endereco_boleto_w := null;
		end;
		
		if 	((dt_dia_vencimento_w IS NOT NULL AND dt_dia_vencimento_w::text <> '') and (coalesce(nr_seq_dia_vencimento_w::text, '') = '')) then
			select	max(nr_sequencia)
			into STRICT	nr_seq_dia_vencimento_w
			from 	plussoft_dia_vencimento_v
			where 	dt_dia_vencimento = dt_dia_vencimento_w
			and	ie_tipo_contratacao = ie_tipo_contratacao_w;
		end if;

		linha_w.cd_pf_pagador 		:= cd_pf_pagador_w;
		linha_w.cd_cgc_pagador 		:= cd_cgc_pagador_w;
		linha_w.nm_pagador 		:= nm_pagador_w;
		linha_w.dt_dia_vencimento 	:= nr_seq_dia_vencimento_w;
		linha_w.nr_seq_forma_cobranca 	:= nr_seq_forma_cobranca_w;
		linha_w.cd_banco 		:= cd_banco_w;
		linha_w.cd_agencia_bancaria 	:= cd_agencia_bancaria_w;
		linha_w.cd_conta 		:= cd_conta_w;
		linha_w.ie_endereco_boleto	:= ie_endereco_boleto_w;
		
		RETURN NEXT linha_w;
	end loop;
else
	--Dados do contrato e beneficiarios
	for r_c02_w in current_setting('pls_obj_plussoft_pck.c02')::CURSOR(nr_contrato_p) loop
		linha_w.nr_contrato		:= r_c02_w.nr_contrato;
		linha_w.nr_seq_contrato		:= r_c02_w.nr_seq_contrato;
		linha_w.dt_vigencia		:= r_c02_w.dt_contrato;
		linha_w.dt_contrato		:= r_c02_w.dt_contrato;
		linha_w.dt_aprovacao		:= r_c02_w.dt_aprovacao;
		linha_w.ie_situacao_contrato	:= r_c02_w.ie_situacao_contrato;
		linha_w.ds_situacao_contrato	:= r_c02_w.ds_situacao_contrato;
		--Estipulante		
		linha_w.cd_pf_estipulante	:= r_c02_w.cd_pf_estipulante;
		linha_w.cd_cgc_estipulante	:= r_c02_w.cd_cgc_estipulante;
		linha_w.nm_estipulante		:= r_c02_w.nm_estipulante;
		--Vidas
		linha_w.cd_moeda		:= r_c02_w.nr_seq_indice_reajuste;
		linha_w.qt_idade_limite_reaj	:= r_c02_w.qt_idade_limite_reaj;
		linha_w.qt_anos_limite_reaj	:= r_c02_w.qt_anos_limite_reaj;
		linha_w.cd_participacao_financ	:= r_c02_w.cd_participacao_financ;

		begin
		select 	max(a.nr_seq_plano),
			max(nr_seq_tabela)
		into STRICT	nr_seq_plano_w,
			nr_seq_tabela_w
		from 	pls_contrato_plano a
		where 	nr_seq_contrato = r_c02_w.nr_seq_contrato
		and 	a.ie_situacao = 'A';
		exception
		when others then
			nr_seq_plano_w	:= null;
			nr_seq_tabela_w	:= null;
		end;
		
		begin
		select	max(a.nr_sequencia)
		into STRICT 	nr_seq_pagador_w
		from 	pls_contrato_pagador a
		where 	a.nr_seq_contrato = r_c02_w.nr_seq_contrato 
		and 	a.ie_tipo_pagador = 'P';
		exception
		when others then
			nr_seq_pagador_w := null;
		end;
		
		begin
		select	max(a.nm_tabela)
		into STRICT	nm_tabela_w
		from 	pls_tabela_preco a
		where 	a.nr_sequencia = nr_seq_tabela_w;
		exception
		when others then
			nm_tabela_w := null;
		end;
		linha_w.nr_seq_tabela		:= nr_seq_tabela_w;
		linha_w.nm_tabela_preco		:= nm_tabela_w;
		--Proposta
		begin
		select	ie_tipo_contratacao
		into STRICT	ie_tipo_contratacao_w
		from	pls_proposta_adesao
		where	nr_sequencia	= r_c02_w.nr_seq_proposta;
		exception
		when others then
			ie_tipo_contratacao_w := null;
		end;
		linha_w.ie_tipo_contratacao := ie_tipo_contratacao_w;
		--Dados do plano
		begin
		select	nr_sequencia,
			ds_plano,
			nr_protocolo_ans,
			cd_scpa,
			ie_tipo_contratacao
		into STRICT	nr_seq_plano_w,
			ds_plano_w,
			nr_protocolo_ans_w,
			cd_scpa_w,
			ie_tipo_contratacao_plano_w
		from	pls_plano
		where	nr_sequencia	= nr_seq_plano_w;
		exception
		when others then
			nr_seq_plano_w := null;
			ds_plano_w := null;
			nr_protocolo_ans_w := null;
			cd_scpa_w := null;
		end;
	
		if (coalesce(ie_tipo_contratacao_w::text, '') = '') then
			if (ie_tipo_contratacao_plano_w in ('CA', 'CE')) then
				ie_tipo_contratacao_w := 'C';
			else
				ie_tipo_contratacao_w := 'I';
			end if;
		else
			if (ie_tipo_contratacao_w in ('CA', 'CE')) then
				ie_tipo_contratacao_w := 'C';
			else
				ie_tipo_contratacao_w := 'I';
			end if;
		end if;
		--Produto
		linha_w.nr_seq_plano		:= nr_seq_plano_w;
		linha_w.ds_plano		:= ds_plano_w;
		linha_w.nr_protocolo_ans	:= nr_protocolo_ans_w;
		linha_w.cd_scpa			:= cd_scpa_w;
		--Pagador
		begin
		select	a.cd_pessoa_fisica,
			a.cd_cgc,
			pls_obter_dados_pagador(a.nr_sequencia,'D'),
			b.dt_dia_vencimento,
			b.nr_seq_forma_cobranca,
			b.cd_banco,
			b.cd_agencia_bancaria,
			b.cd_conta,
			a.ie_endereco_boleto,
			b.nr_seq_dia_vencimento
		into STRICT	cd_pf_pagador_w,
			cd_cgc_pagador_w,
			nm_pagador_w,
			dt_dia_vencimento_w,
			nr_seq_forma_cobranca_w,
			cd_banco_w,
			cd_agencia_bancaria_w,
			cd_conta_w,
			ie_endereco_boleto_w,
			nr_seq_dia_vencimento_w
		from	pls_contrato_pagador		a,
			pls_contrato_pagador_fin	b
		where	a.nr_sequencia 		= nr_seq_pagador_w
		and	b.nr_seq_pagador 	= a.nr_sequencia
		and 	trunc(clock_timestamp()) between b.dt_inicio_vigencia and coalesce(b.dt_fim_vigencia,clock_timestamp());
		exception
		when others then
			cd_pf_pagador_w := null;
			cd_cgc_pagador_w := null;
			dt_dia_vencimento_w := null;
			nr_seq_forma_cobranca_w := null;
			cd_banco_w := null;
			cd_agencia_bancaria_w := null;
			cd_conta_w := null;
			nm_pagador_w := null;
			ie_endereco_boleto_w := null;
		end;
		
		if 	((dt_dia_vencimento_w IS NOT NULL AND dt_dia_vencimento_w::text <> '') and (coalesce(nr_seq_dia_vencimento_w::text, '') = '')) then
			select	max(nr_sequencia)
			into STRICT	nr_seq_dia_vencimento_w
			from 	plussoft_dia_vencimento_v
			where 	dt_dia_vencimento = dt_dia_vencimento_w
			and	ie_tipo_contratacao = ie_tipo_contratacao_w;
		end if;
	
		linha_w.cd_pf_pagador 		:= cd_pf_pagador_w;
		linha_w.cd_cgc_pagador 		:= cd_cgc_pagador_w;
		linha_w.nm_pagador		:= nm_pagador_w;
		linha_w.dt_dia_vencimento 	:= nr_seq_dia_vencimento_w;
		linha_w.nr_seq_forma_cobranca 	:= nr_seq_forma_cobranca_w;
		linha_w.cd_banco 		:= cd_banco_w;
		linha_w.cd_agencia_bancaria 	:= cd_agencia_bancaria_w;
		linha_w.cd_conta 		:= cd_conta_w;
		linha_w.ie_endereco_boleto 	:= ie_endereco_boleto_w;
		
		RETURN NEXT linha_w;
	end loop;
end if;
--Retorna nada
return;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pls_obj_plussoft_pck.obter_dados_contrato ( nr_contrato_p pls_contrato.nr_contrato%type, cd_usuario_plano_p pls_segurado_carteira.cd_usuario_plano%type) FROM PUBLIC;
