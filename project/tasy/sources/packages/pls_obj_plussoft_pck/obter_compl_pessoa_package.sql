-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pls_obj_plussoft_pck.obter_compl_pessoa ( cd_pessoa_fisica_p pessoa_fisica.cd_pessoa_fisica%type, cd_cgc_p pessoa_juridica.cd_cgc%type ) RETURNS SETOF T_DADOS_BUSCA_COMPL_DATA AS $body$
DECLARE

		
linha_w				t_dados_busca_compl_row;


nr_seq_vendedor_w		pls_vendedor.nr_sequencia%type;
cd_pesoa_fisica_w		pessoa_fisica.cd_pessoa_fisica%type;
cd_cgc_w			pessoa_juridica.cd_cgc%type;
cd_naturalidade_w		varchar(255);
nm_pais_w			varchar(255);
cd_nacionalidade_w		varchar(255);
ds_grau_instrucao_w		varchar(255);
nr_pis_pasep_w			varchar(255);
nr_cartao_nac_sus_w		varchar(255);
dt_emissao_ci_w			timestamp;
ds_orgao_emissor_ci_w		varchar(255);
sg_emissora_ci_w		varchar(255);
cd_declaracao_nasc_vivo_w	varchar(255);
nm_contato_w			varchar(255);
qt_registro_w			bigint;
nr_seq_lead_pf_w		bigint;
nr_seq_lead_pj_w		bigint;
nr_seq_vendedor_canal_w		pls_vendedor.nr_sequencia%type;
nr_seq_agente_motivador_w	pls_agente_motivador.nr_sequencia%type;
nr_seq_origem_agente_w		pls_agente_motivador_orig.nr_seq_agente_motivador%type;
nr_seq_segurado_indic_w		pls_solicitacao_comercial.nr_seq_segurado_indic%type;
cd_pessoa_indicacao_w		pls_solicitacao_comercial.cd_pessoa_indicacao%type;
ds_observacao_w			pls_solicitacao_comercial.ds_observacao%type;
	

BEGIN

--PF
if (cd_pessoa_fisica_p IS NOT NULL AND cd_pessoa_fisica_p::text <> '') then
	--Verifica se existe a PF
	select	count(1)
	into STRICT	qt_registro_w
	from	pessoa_fisica
	where	cd_pessoa_fisica = cd_pessoa_fisica_p;
	
	if (qt_registro_w > 0) then
		--Dados PF
		select	cd_pessoa_fisica,
			nr_cep_cidade_nasc cd_naturalidade,
			(select	max(x.nm_pais)
			from	pais x
			where	x.nr_sequencia = a.nr_seq_pais) nm_pais,
			obter_valor_dominio(10,ie_grau_instrucao) ds_grau_instrucao,
			a.cd_nacionalidade,
			nr_pis_pasep,
			nr_cartao_nac_sus,
			dt_emissao_ci,
			ds_orgao_emissor_ci,
			sg_emissora_ci,
			cd_declaracao_nasc_vivo,
			pls_obj_plussoft_pck.pls_obter_compl_pf(cd_pessoa_fisica,1,'NM'),
			ds_observacao
		into STRICT	cd_pesoa_fisica_w,
			cd_naturalidade_w,
			nm_pais_w,
			ds_grau_instrucao_w,
			cd_nacionalidade_w,
			nr_pis_pasep_w,
			nr_cartao_nac_sus_w,
			dt_emissao_ci_w,
			ds_orgao_emissor_ci_w,
			sg_emissora_ci_w,
			cd_declaracao_nasc_vivo_w,
			nm_contato_w,
			ds_observacao_w
		from	pessoa_fisica a
		where	cd_pessoa_fisica = cd_pessoa_fisica_p  LIMIT 1;
		
		linha_w.cd_pessoa_fisica	:= cd_pesoa_fisica_w;
		linha_w.cd_naturalidade		:= cd_naturalidade_w;
		linha_w.cd_nacionalidade	:= cd_nacionalidade_w;
		linha_w.ie_grau_instrucao	:= ds_grau_instrucao_w;
		linha_w.nr_pis_pasep		:= nr_pis_pasep_w;
		linha_w.nr_cartao_nac_sus	:= nr_cartao_nac_sus_w;
		linha_w.dt_emissao_ci		:= dt_emissao_ci_w;
		linha_w.ds_orgao_emissor_ci	:= ds_orgao_emissor_ci_w;
		linha_w.sg_emissora_ci		:= sg_emissora_ci_w;
		linha_w.nm_pais			:= nm_pais_w;
		linha_w.cd_declaracao_nasc_vivo	:= cd_declaracao_nasc_vivo_w;
		linha_w.nm_contato		:= nm_contato_w;
		linha_w.ds_observacao		:= ds_observacao_w;
		
		--Dados do contrato PF
		begin
			select	max(x.nr_sequencia)
			into STRICT	nr_seq_lead_pf_w
			from 	pls_solicitacao_comercial x
			where 	x.cd_pf_vinculado = cd_pessoa_fisica_p;
		exception
		when others then
			nr_seq_lead_pf_w := null;
		end;
		
		if (coalesce(nr_seq_lead_pf_w,0) > 0) then
			select	b.nr_seq_vendedor_canal,
				a.nr_seq_agente_motivador,
				a.nr_seq_origem_agente,
				a.nr_seq_segurado_indic,
				a.cd_pessoa_indicacao
			into STRICT	nr_seq_vendedor_canal_w,
				nr_seq_agente_motivador_w,
				nr_seq_origem_agente_w,
				nr_seq_segurado_indic_w,
				cd_pessoa_indicacao_w
			FROM pls_solicitacao_comercial a
LEFT OUTER JOIN pls_solicitacao_vendedor b ON (a.nr_sequencia = b.nr_seq_solicitacao)
WHERE a.nr_sequencia = nr_seq_lead_pf_w;
			
			linha_w.nr_seq_vendedor		:= nr_seq_vendedor_canal_w;
			linha_w.nr_seq_agente_motivador	:= nr_seq_agente_motivador_w;
			linha_w.nr_seq_origem_agente	:= nr_seq_origem_agente_w;
			linha_w.nr_seq_segurado_indic	:= nr_seq_segurado_indic_w;
			linha_w.cd_pessoa_indicacao	:= cd_pessoa_indicacao_w;
						
			RETURN NEXT linha_w;
		end if;
	end if;
--PJ
elsif (cd_cgc_p IS NOT NULL AND cd_cgc_p::text <> '') then
	--Verifica se existe a PJ
	select	count(1)
	into STRICT	qt_registro_w
	from	pessoa_juridica
	where	cd_cgc = cd_cgc_p;
	
	if (qt_registro_w > 0) then
		--Dados PJ
		select	cd_cgc,
			a.cd_municipio_ibge cd_naturalidade,
			(select	max(x.nm_pais)
			from	pais x
			where	x.nr_sequencia = a.nr_seq_pais) nm_pais,
			a.ds_observacao
		into STRICT	cd_cgc_w,
			cd_naturalidade_w,
			nm_pais_w,
			ds_observacao_w
		from	pessoa_juridica a
		where	cd_cgc = cd_cgc_p  LIMIT 1;
		
		linha_w.cd_cgc			:= cd_cgc_w;
		linha_w.cd_naturalidade		:= cd_naturalidade_w;
		linha_w.nm_pais			:= nm_pais_w;
		linha_w.ds_observacao		:= ds_observacao_w;
		
		--Dados do contrato PF
		begin
			select	max(x.nr_sequencia)
			into STRICT	nr_seq_lead_pj_w
			from 	pls_solicitacao_comercial x
			where 	x.cd_cnpj_vinculado = cd_cgc_p;
		exception
		when others then
			nr_seq_lead_pj_w := null;
		end;
		
		if (coalesce(nr_seq_lead_pj_w,0) > 0) then
			select	b.nr_seq_vendedor_canal,
				a.nr_seq_agente_motivador,
				a.nr_seq_origem_agente,
				a.nr_seq_segurado_indic,
				a.cd_pessoa_indicacao
			into STRICT	nr_seq_vendedor_canal_w,
				nr_seq_agente_motivador_w,
				nr_seq_origem_agente_w,
				nr_seq_segurado_indic_w,
				cd_pessoa_indicacao_w	
			FROM pls_solicitacao_comercial a
LEFT OUTER JOIN pls_solicitacao_vendedor b ON (a.nr_sequencia = b.nr_seq_solicitacao)
WHERE a.nr_sequencia 	= nr_seq_lead_pj_w;
			
			linha_w.nr_seq_vendedor		:= nr_seq_vendedor_canal_w;
			linha_w.nr_seq_agente_motivador	:= nr_seq_agente_motivador_w;
			linha_w.nr_seq_origem_agente	:= nr_seq_origem_agente_w;
			linha_w.nr_seq_segurado_indic	:= nr_seq_segurado_indic_w;
			linha_w.cd_pessoa_indicacao	:= cd_pessoa_indicacao_w;
			
			RETURN NEXT linha_w;
		end if;
		
	end if;
end if;
--nao retorna nada
return;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pls_obj_plussoft_pck.obter_compl_pessoa ( cd_pessoa_fisica_p pessoa_fisica.cd_pessoa_fisica%type, cd_cgc_p pessoa_juridica.cd_cgc%type ) FROM PUBLIC;
