-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_obj_plussoft_pck.gerar_emissao_carteirinha ( nr_seq_lote_p pls_lote_carteira.nr_sequencia%type, cd_pessoa_usuario_p pessoa_fisica.cd_pessoa_fisica%type, ds_mensagem_erro_p INOUT text) AS $body$
DECLARE


ie_tipo_beneficiario_w		pls_lote_carteira.ie_tipo_beneficiario%type;
current_setting('pls_obj_plussoft_pck.cd_estabelecimento_w')::smallint		pls_lote_carteira.cd_estabelecimento%type;
cd_interface_w			bigint;
nm_arquivo_w			varchar(255);
qtRegMax_w			bigint;
ds_diretorio_w			varchar(255);
current_setting('pls_obj_plussoft_pck.nm_usuario_w')::usuario.nm_usuario%type			usuario.nm_usuario%type;

C01 CURSOR FOR
	SELECT  nm_atributo,
		qt_tamanho,
		ie_tipo_atributo
	from 	interface_atributo
	where   cd_interface  = cd_interface_w
	and   	qt_tamanho   > 0
	and   	cd_reg_interface = 1
	order by nr_seq_atributo;


BEGIN
--Encontra o usuario
begin
select	max(nm_usuario)
into STRICT	current_setting('pls_obj_plussoft_pck.nm_usuario_w')::usuario.nm_usuario%type
from	usuario
where	cd_pessoa_fisica = cd_pessoa_usuario_p
and	ie_situacao = 'A';
exception
when others then
	PERFORM set_config('pls_obj_plussoft_pck.nm_usuario_w', null, false);
end;

if (coalesce(nr_seq_lote_p,0) = 0 ) then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(wheb_mensagem_pck.get_texto(1110478),'');
end if;

select	ie_tipo_beneficiario,
	cd_estabelecimento
into STRICT	ie_tipo_beneficiario_w,
	current_setting('pls_obj_plussoft_pck.cd_estabelecimento_w')::smallint
from 	pls_lote_carteira
where 	nr_sequencia = nr_seq_lote_p;

if (coalesce(ie_tipo_beneficiario_w,'') = 'R') then
	select	max(b.cd_interface_envio)
	into STRICT	cd_interface_w
        from	pls_parametros a,
		pls_emissor_carteira b
	where  	a.nr_seq_emissor_provisorio   = b.nr_sequencia
	and    	a.cd_estabelecimento          = current_setting('pls_obj_plussoft_pck.cd_estabelecimento_w')::smallint;
else
	select 	max(b.cd_interface_envio)
	into STRICT	cd_interface_w	
        from	pls_parametros a,
		pls_emissor_carteira b
	where  	a.nr_seq_emissor 	= b.nr_sequencia
	and    a.cd_estabelecimento 	= current_setting('pls_obj_plussoft_pck.cd_estabelecimento_w')::smallint;
end if;

if (coalesce(cd_interface_w,0) = 0 ) then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(wheb_mensagem_pck.get_texto(1110493),'');
end if;

if (cd_interface_w = 2155) then
	CALL pls_gerar_cartao_ativia(nr_seq_lote_p,current_setting('pls_obj_plussoft_pck.cd_estabelecimento_w')::smallint,current_setting('pls_obj_plussoft_pck.nm_usuario_w')::usuario.nm_usuario%type);
/*Seisa*/

elsif (cd_interface_w = 2180) then
	CALL pls_gerar_cartao_seisa(nr_seq_lote_p,current_setting('pls_obj_plussoft_pck.cd_estabelecimento_w')::smallint,current_setting('pls_obj_plussoft_pck.nm_usuario_w')::usuario.nm_usuario%type);
/*Unimed Blumenau*/

elsif (cd_interface_w in (2185, 2702, 2722)) then -- 2702 = PTU 5.1 / 2722 = PTU 5.2
	CALL pls_gerar_cartao_unimed_blu(nr_seq_lote_p,cd_interface_w,current_setting('pls_obj_plussoft_pck.cd_estabelecimento_w')::smallint,current_setting('pls_obj_plussoft_pck.nm_usuario_w')::usuario.nm_usuario%type);
/*Unimed Litoral*/

elsif (cd_interface_w in (2205, 2683, 2704)) then -- 2683 = PTU 5.0 / 2704 = PTU 5.1
	CALL pls_gerar_cart_unimed_litoral(nr_seq_lote_p,cd_interface_w,current_setting('pls_obj_plussoft_pck.cd_estabelecimento_w')::smallint,current_setting('pls_obj_plussoft_pck.nm_usuario_w')::usuario.nm_usuario%type);
/*Unimed Ituverava*/

elsif (cd_interface_w = 2237) then
	CALL pls_gerar_cart_unimed_ituverav(nr_seq_lote_p,current_setting('pls_obj_plussoft_pck.cd_estabelecimento_w')::smallint,current_setting('pls_obj_plussoft_pck.nm_usuario_w')::usuario.nm_usuario%type);
/*Unimed Sao Jose Rio Preto*/

elsif (cd_interface_w in (2243, 2720)) then -- 2720 = PTU 5.1
	CALL pls_gerar_cart_unimed_sjrp(nr_seq_lote_p,cd_interface_w,null,null,current_setting('pls_obj_plussoft_pck.cd_estabelecimento_w')::smallint,current_setting('pls_obj_plussoft_pck.nm_usuario_w')::usuario.nm_usuario%type);
/*Unimed Lencois Paulista*/

elsif (cd_interface_w in (2433, 2682, 2723)) then -- 2682 = PTU 5.0 / 2723 = PTU 5.1
	pls_gerar_cart_unimed_lencois(nr_seq_lote_p,cd_interface_w,current_setting('pls_obj_plussoft_pck.cd_estabelecimento_w')::smallint,current_setting('pls_obj_plussoft_pck.nm_usuario_w')::usuario.nm_usuario%type);
/*Unimed Maringa*/

elsif (cd_interface_w in (2607, 2662, 2700)) then -- 2662  PTU 5.0 / 2700 = PTU 5.1
	CALL pls_gerar_cart_unimed_maringa(nr_seq_lote_p,cd_interface_w,current_setting('pls_obj_plussoft_pck.cd_estabelecimento_w')::smallint,current_setting('pls_obj_plussoft_pck.nm_usuario_w')::usuario.nm_usuario%type);
/*Unimed sao Carlos*/

elsif (cd_interface_w in (2622, 2674)) then -- 2674 = PTU 5.1
	CALL pls_gerar_cart_unim_sao_carlos(nr_seq_lote_p,current_setting('pls_obj_plussoft_pck.cd_estabelecimento_w')::smallint,current_setting('pls_obj_plussoft_pck.nm_usuario_w')::usuario.nm_usuario%type);
/*Benecamp*/

elsif (cd_interface_w = 2523) then
	CALL pls_gerar_cartao_benecamp(nr_seq_lote_p,current_setting('pls_obj_plussoft_pck.cd_estabelecimento_w')::smallint,current_setting('pls_obj_plussoft_pck.nm_usuario_w')::usuario.nm_usuario%type);
/*Santamalia*/

elsif (cd_interface_w = 2553) then
	CALL pls_gerar_cartao_santamalia(nr_seq_lote_p,current_setting('pls_obj_plussoft_pck.cd_estabelecimento_w')::smallint,current_setting('pls_obj_plussoft_pck.nm_usuario_w')::usuario.nm_usuario%type);
/*Marcio Cunha*/

elsif (cd_interface_w = 2603) then
	CALL pls_gerar_cartao_marciocunha(nr_seq_lote_p,current_setting('pls_obj_plussoft_pck.cd_estabelecimento_w')::smallint,current_setting('pls_obj_plussoft_pck.nm_usuario_w')::usuario.nm_usuario%type);
/*Filosanitas LTDA*/

elsif (cd_interface_w = 2631) then
	CALL pls_gerar_cartao_filosanitas(nr_seq_lote_p,current_setting('pls_obj_plussoft_pck.cd_estabelecimento_w')::smallint,current_setting('pls_obj_plussoft_pck.nm_usuario_w')::usuario.nm_usuario%type);
/*Hospital  R. Franca*/

elsif (cd_interface_w in (2707, 2708)) then -- 2708 = Odonto
	CALL pls_gerar_cart_hr_franca(nr_seq_lote_p,cd_interface_w,current_setting('pls_obj_plussoft_pck.cd_estabelecimento_w')::smallint,current_setting('pls_obj_plussoft_pck.nm_usuario_w')::usuario.nm_usuario%type);
/* Plano de Saude Ases Ltda */

elsif (cd_interface_w = 2778) then
	CALL pls_gerar_cartao_ases(nr_seq_lote_p,current_setting('pls_obj_plussoft_pck.cd_estabelecimento_w')::smallint,current_setting('pls_obj_plussoft_pck.nm_usuario_w')::usuario.nm_usuario%type);
end if;

if (cd_interface_w in (2603, 1956, 1971, 1992, 2143, 2155, 2180, 2185, 2205, 2237,
		       2243, 2433, 2553, 2607, 2622, 2674, 2523, 2631, 2662, 2682,
		       2683, 2700, 2702, 2704, 2707, 2708, 2720, 2722, 2723, 2778)) then
	
	ds_diretorio_w	:= coalesce(obter_valor_param_usuario(1226, 3, Obter_Perfil_Ativo, current_setting('pls_obj_plussoft_pck.nm_usuario_w')::usuario.nm_usuario%type, current_setting('pls_obj_plussoft_pck.cd_estabelecimento_w')::smallint), null);
	
	select	substr(pls_obter_nome_arquivo_cart(nr_seq_lote_p,cd_interface_w,null,current_setting('pls_obj_plussoft_pck.nm_usuario_w')::usuario.nm_usuario%type),1,255) nm_arquivo
	into STRICT	nm_arquivo_w
	;
	
	ds_diretorio_w := pls_obj_plussoft_pck.pls_gerar_arquivo_interface(nr_seq_lote_p, nm_arquivo_w, cd_interface_w, ds_diretorio_w);
end if;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_obj_plussoft_pck.gerar_emissao_carteirinha ( nr_seq_lote_p pls_lote_carteira.nr_sequencia%type, cd_pessoa_usuario_p pessoa_fisica.cd_pessoa_fisica%type, ds_mensagem_erro_p INOUT text) FROM PUBLIC;
