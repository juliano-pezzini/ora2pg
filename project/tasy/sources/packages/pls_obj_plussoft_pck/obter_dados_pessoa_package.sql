-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pls_obj_plussoft_pck.obter_dados_pessoa ( cd_pessoa_fisica_p pessoa_fisica.cd_pessoa_fisica%type, cd_cgc_p pessoa_juridica.cd_cgc%type ) RETURNS SETOF T_DADOS_PF_PJ_DATA AS $body$
DECLARE

/*
Tipo de pessoa
0 - Pessoa fisica
1 - Pessoa juridica

*/
linha_w			t_dados_pf_pj_row;


qt_registro_w			bigint;
cd_pessoa_fisica_w		pessoa_fisica.cd_pessoa_fisica%type;
cd_cgc_w			pessoa_juridica.cd_cgc%type;
ie_status_w			varchar(50);
ie_tratamento_w			varchar(100);
nm_pessoa_fisica_w		pessoa_fisica.nm_pessoa_fisica%type;
ds_razao_social_w		pessoa_juridica.ds_razao_social%type;
nm_abreviado_w			pessoa_fisica.nm_abreviado%type;
nm_fantasia_w			pessoa_juridica.nm_fantasia%type;
ds_tipo_estipulante_w		varchar(100);
ds_tipo_pulbico_w		varchar(100);
ie_sexo_w			pessoa_fisica.ie_sexo%type;
ie_estado_civil_w		pessoa_fisica.ie_estado_civil%type;
ie_contactar_fone_w		varchar(5);
ie_contactar_cor_w		varchar(5);
ie_contactar_email_w		varchar(5);
ie_contactar_sms_w		varchar(5);
nr_cartao_nac_sus_w		pessoa_fisica.nr_cartao_nac_sus%type;
ds_grau_instrucao_w		varchar(255);
ds_nacionalidade_w		varchar(255);
dt_emissao_ci_w			timestamp;
ds_orgao_emissor_ci_w		varchar(255);
sg_emissora_ci_w		varchar(255);
cd_declaracao_nasc_vivo_w	varchar(255);
nm_contato_w			varchar(255);
nm_mae_w			varchar(255);
--Contato PF/PJ
nr_ddi_telefone_res_w	varchar(255);
nr_ddd_telefone_res_w	varchar(255);
nr_telefone_res_w	varchar(255);
ds_fone_adic_w		varchar(255);
nr_ddi_celular_w	varchar(255);
nr_ddd_celular_w	varchar(255);
nr_telefone_celular_w	varchar(255);
ds_compl_celular_w	varchar(255);
nr_ddi_telefone_com_w	varchar(255);
nr_ddd_telefone_com_w	varchar(255);
nr_telefone_com_w	varchar(255);
ds_compl_fone_com_w	varchar(255);
ds_email_pf_w		varchar(255);
ds_email_pj_w		varchar(255);
ds_email_pf_com_w	varchar(255);
ds_email_pj_adic_w	varchar(255);
--Endereco Res
ie_tipo_complemento_res_w	varchar(255);
cd_cep_res_w			varchar(255);
ds_pais_res_w			varchar(255);
sg_estado_res_w			varchar(255);
ds_estado_res_w			varchar(255);
ds_municipio_res_w		varchar(255);
ds_tipo_logradouro_res_w	varchar(255);
ds_endereco_res_w		varchar(255);
nr_endereco_res_w		varchar(255);
ds_complemento_res_w		varchar(255);
cd_municipio_ibge_res_w		varchar(255);
ds_bairro_res_w			varchar(255);
dt_atualizacao_res_w		timestamp;
ie_endereco_pagador_res_w	varchar(5);
--Endereco Comercial
ie_tipo_complemento_com_w	varchar(255);
cd_cep_com_w			varchar(255);
ds_pais_com_w			varchar(255);
sg_estado_com_w			varchar(255);
ds_estado_com_w			varchar(255);
ds_municipio_com_w		varchar(255);
ds_tipo_logradouro_com_w	varchar(255);
ds_endereco_com_w		varchar(255);
nr_endereco_com_w		varchar(255);
ds_complemento_com_w		varchar(255);
cd_municipio_ibge_com_w		varchar(255);
ds_bairro_com_w			varchar(255);
dt_atualizacao_com_w		timestamp;
ie_endereco_pagador_com_w	varchar(5);
--Inf Adicionais
nr_identidade_w			varchar(255);
nr_inscricao_estadual_w		varchar(255);
nr_cpf_w			varchar(255);
dt_nascimento_w			pessoa_fisica.dt_nascimento%type;
ds_profissao_w			varchar(255);
ds_cargo_w			varchar(255);
ds_observacao_pf_w		varchar(4000);
ds_observacao_pj_w		varchar(4000);
ds_complemento_fone_com_w	varchar(255);
cd_cargo_w			cargo.cd_cargo%type;
nr_seq_renda_w			pessoa_fisica_renda.nr_seq_renda%type;
ds_renda_w			renda.ds_renda%type;
nr_pis_pasep_w			pessoa_fisica.nr_pis_pasep%type;
nm_pais_w			varchar(255);
ds_observacao_w			pessoa_fisica.ds_observacao%type;
nr_seq_vendedor_canal_w		pls_solicitacao_vendedor.nr_seq_vendedor_canal%type;
nr_seq_agente_motivador_w	pls_solicitacao_comercial.nr_seq_agente_motivador%type;
nr_seq_origem_agente_w		pls_solicitacao_comercial.nr_seq_origem_agente%type;
nr_seq_segurado_indic_w		pls_solicitacao_comercial.nr_seq_segurado_indic%type;
cd_pessoa_indicacao_w		pls_solicitacao_comercial.cd_pessoa_indicacao%type;
cd_naturalidade_w		varchar(255);
cd_nacionalidade_w		varchar(255);
cd_pessoa_vendedor_w		pessoa_fisica.cd_pessoa_fisica%type;
nr_seq_lead_w			pls_solicitacao_comercial.nr_sequencia%type;


BEGIN
--PF
if (cd_pessoa_fisica_p IS NOT NULL AND cd_pessoa_fisica_p::text <> '') then
	
	select	count(1)
	into STRICT	qt_registro_w
	from	pessoa_fisica
	where	cd_pessoa_fisica = cd_pessoa_fisica_p;
	
	if (qt_registro_w > 0) then
		select	cd_pessoa_fisica,
			pls_obj_plussoft_pck.pls_obter_status_venda(null,cd_pessoa_fisica),
			CASE WHEN ie_sexo='M' THEN 'Sr.' WHEN ie_sexo='F' THEN 'Sra.'  ELSE 'Sr.' END ,
			nm_pessoa_fisica,
			nm_abreviado,
			'Pessoa fisica',
			'beneficiario',
			ie_sexo,
			ie_estado_civil,
			substr(pls_obj_plussoft_pck.pls_obter_compl_pf(cd_pessoa_fisica,1,'DDI'),1,3),
			substr(pls_obj_plussoft_pck.pls_obter_compl_pf(cd_pessoa_fisica,1,'DDD'),1,3),
			substr(pls_obj_plussoft_pck.pls_obter_compl_pf(cd_pessoa_fisica,1,'TEL'),1,15),
			substr(pls_obj_plussoft_pck.pls_obter_compl_pf(cd_pessoa_fisica,1,'ADIC'),1,80),
			nr_ddi_celular,
			nr_ddd_celular,
			nr_telefone_celular,
			'',
			substr(pls_obj_plussoft_pck.pls_obter_compl_pf(cd_pessoa_fisica,2,'DDI'),1,3),
			substr(pls_obj_plussoft_pck.pls_obter_compl_pf(cd_pessoa_fisica,2,'DDD'),1,3),
			substr(pls_obj_plussoft_pck.pls_obter_compl_pf(cd_pessoa_fisica,2,'TEL'),1,15),
			'',
			pls_obj_plussoft_pck.pls_obter_compl_pf(cd_pessoa_fisica,1,'EMAIL'),
			pls_obj_plussoft_pck.pls_obter_compl_pf(cd_pessoa_fisica,2,'EMAIL'),
			'Residencial',
			substr(pls_obj_plussoft_pck.pls_obter_compl_pf(cd_pessoa_fisica,1,'CEP'),1,15),
			pls_obj_plussoft_pck.pls_obter_compl_pf(cd_pessoa_fisica,1,'PAIS'),
			substr(pls_obj_plussoft_pck.pls_obter_compl_pf(cd_pessoa_fisica,1,'UF'),1,2),
			Obter_Valor_Dominio(50, pls_obj_plussoft_pck.pls_obter_compl_pf(cd_pessoa_fisica,1,'UF')),
			substr(pls_obj_plussoft_pck.pls_obter_compl_pf(cd_pessoa_fisica,1,'MUN'),1,40),
			substr(pls_obj_plussoft_pck.pls_obter_compl_pf(cd_pessoa_fisica,1,'LOG'),1,3),
			substr(pls_obj_plussoft_pck.pls_obter_compl_pf(cd_pessoa_fisica,1,'END'),1,100),
			substr(pls_obj_plussoft_pck.pls_obter_compl_pf(cd_pessoa_fisica,1,'NR'),1,5),
			substr(pls_obj_plussoft_pck.pls_obter_compl_pf(cd_pessoa_fisica,1,'COMP'),1,40),
			substr(pls_obj_plussoft_pck.pls_obter_compl_pf(cd_pessoa_fisica,1,'IBGE'),1,6),
			substr(pls_obj_plussoft_pck.pls_obter_compl_pf(cd_pessoa_fisica,1,'BAI'),1,80),
			pls_obj_plussoft_pck.pls_obter_compl_pf(cd_pessoa_fisica,1,'ATL'),
			pls_obj_plussoft_pck.pls_verifica_se_pagador(null,cd_pessoa_fisica),
			'Comercial',
			pls_obj_plussoft_pck.pls_obter_compl_pf(cd_pessoa_fisica,2,'CEP'),
			pls_obj_plussoft_pck.pls_obter_compl_pf(cd_pessoa_fisica,2,'PAIS'),
			pls_obj_plussoft_pck.pls_obter_compl_pf(cd_pessoa_fisica,2,'UF'),
			Obter_Valor_Dominio(50, pls_obj_plussoft_pck.pls_obter_compl_pf(cd_pessoa_fisica,2,'UF')),
			pls_obj_plussoft_pck.pls_obter_compl_pf(cd_pessoa_fisica,2,'MUN'),
			pls_obj_plussoft_pck.pls_obter_compl_pf(cd_pessoa_fisica,2,'LOG'),
			pls_obj_plussoft_pck.pls_obter_compl_pf(cd_pessoa_fisica,2,'END'),
			pls_obj_plussoft_pck.pls_obter_compl_pf(cd_pessoa_fisica,2,'NR'),
			pls_obj_plussoft_pck.pls_obter_compl_pf(cd_pessoa_fisica,2,'COMP'),
			pls_obj_plussoft_pck.pls_obter_compl_pf(cd_pessoa_fisica,2,'IBGE'),
			pls_obj_plussoft_pck.pls_obter_compl_pf(cd_pessoa_fisica,2,'BAI'),
			pls_obj_plussoft_pck.pls_obter_compl_pf(cd_pessoa_fisica,2,'ATL'),
			'N',
			nr_identidade,
			nr_inscricao_estadual,
			nr_cpf,
			dt_nascimento,
			'',		--Profissao
			substr((select max(a.ds_cargo) from cargo a where a.cd_cargo = b.cd_cargo),1,100) ds_cargo,
			ds_observacao,
			b.cd_cargo,
			b.nr_cartao_nac_sus,
			ie_grau_instrucao ds_grau_instrucao,
			b.cd_nacionalidade,
			dt_emissao_ci,
			ds_orgao_emissor_ci,
			sg_emissora_ci,
			cd_declaracao_nasc_vivo,
			pls_obj_plussoft_pck.pls_obter_compl_pf(cd_pessoa_fisica,1,'NM'),
			pls_obj_plussoft_pck.pls_obter_compl_pf(cd_pessoa_fisica,5,'NM'),
			nr_pis_pasep,
			(select	max(x.nm_pais)
			from	pais x
			where	x.nr_sequencia = b.nr_seq_pais) nm_pais,
			ds_observacao,
			cd_municipio_ibge
		into STRICT	cd_pessoa_fisica_w,
			ie_status_w,
			ie_tratamento_w,
			nm_pessoa_fisica_w,
			nm_abreviado_w,
			ds_tipo_estipulante_w,
			ds_tipo_pulbico_w,
			ie_sexo_w,
			ie_estado_civil_w, 
			nr_ddi_telefone_res_w,
			nr_ddd_telefone_res_w,
			nr_telefone_res_w,
			ds_fone_adic_w,
			nr_ddi_celular_w,
			nr_ddd_celular_w,
			nr_telefone_celular_w,
			ds_compl_celular_w,
			nr_ddi_telefone_com_w,
			nr_ddd_telefone_com_w,
			nr_telefone_com_w,
			ds_compl_fone_com_w,
			ds_email_pf_w,
			ds_email_pf_com_w,
			ie_tipo_complemento_res_w,
			cd_cep_res_w,
			ds_pais_res_w,
			sg_estado_res_w,
			ds_estado_res_w,
			ds_municipio_res_w,
			ds_tipo_logradouro_res_w,
			ds_endereco_res_w,
			nr_endereco_res_w,
			ds_complemento_res_w,
			cd_municipio_ibge_res_w,
			ds_bairro_res_w,
			dt_atualizacao_res_w,
			ie_endereco_pagador_res_w,
			ie_tipo_complemento_com_w, 
			cd_cep_com_w,
			ds_pais_com_w,
			sg_estado_com_w,
			ds_estado_com_w,
			ds_municipio_com_w,
			ds_tipo_logradouro_com_w,
			ds_endereco_com_w,
			nr_endereco_com_w,
			ds_complemento_com_w,
			cd_municipio_ibge_com_w,
			ds_bairro_com_w,
			dt_atualizacao_com_w,  
			ie_endereco_pagador_com_w,
			nr_identidade_w,
			nr_inscricao_estadual_w,
			nr_cpf_w,
			dt_nascimento_w,
			ds_profissao_w,
			ds_cargo_w,
			ds_observacao_pf_w,
			cd_cargo_w,
			nr_cartao_nac_sus_w,
			ds_grau_instrucao_w,
			cd_nacionalidade_w,
			dt_emissao_ci_w,
			ds_orgao_emissor_ci_w,
			sg_emissora_ci_w,
			cd_declaracao_nasc_vivo_w,
			nm_contato_w,
			nm_mae_w,
			nr_pis_pasep_w,
			nm_pais_w,
			ds_observacao_w,
			cd_naturalidade_w
		from	pessoa_fisica b
		where	cd_pessoa_fisica = cd_pessoa_fisica_p  LIMIT 1;
				
		select 	max(a.nr_seq_renda),
			max(b.ds_renda)
		into STRICT	nr_seq_renda_w,
			ds_renda_w
		from 	pessoa_fisica_renda a,
			renda b
		where 	a.cd_pessoa_fisica = cd_pessoa_fisica_p
		and   	a.nr_seq_renda = b.nr_sequencia;
		
		--Dados PF
		linha_w.ie_tipo_pessoa		:= 0;
		linha_w.cd_pessoa_fisica	:= cd_pessoa_fisica_w;
		linha_w.ie_status		:= ie_status_w;
		linha_w.ie_tratamento		:= ie_tratamento_w;
		linha_w.nm_pessoa_fisica	:= nm_pessoa_fisica_w;
		linha_w.nm_abreviado		:= nm_abreviado_w;
		linha_w.ds_tipo_estipulante	:= ds_tipo_estipulante_w;
		linha_w.ds_tipo_pulbico		:= ds_tipo_pulbico_w;
		linha_w.ie_sexo			:= ie_sexo_w;
		linha_w.ie_estado_civil		:= ie_estado_civil_w;
		linha_w.ie_contactar_fone	:= 'N';
		linha_w.ie_contactar_cor	:= 'N';
		linha_w.ie_contactar_email	:= 'N';
		linha_w.ie_contactar_sms	:= 'N';
		linha_w.nr_cartao_nac_sus	:= nr_cartao_nac_sus_w;
		linha_w.ie_grau_instrucao	:= ds_grau_instrucao_w;
		linha_w.cd_nacionalidade	:= ds_nacionalidade_w;
		linha_w.dt_emissao_ci		:= dt_emissao_ci_w;
		linha_w.ds_orgao_emissor_ci	:= ds_orgao_emissor_ci_w;
		linha_w.sg_emissora_ci		:= sg_emissora_ci_w;
		linha_w.cd_declaracao_nasc_vivo	:= cd_declaracao_nasc_vivo_w;
		linha_w.nm_contato		:= nm_contato_w;
		linha_w.nm_mae			:= nm_mae_w;
		linha_w.nr_seq_renda		:= nr_seq_renda_w;
		linha_w.ds_renda		:= ds_renda_w;
		--Contato PF/PJ	
		linha_w.nr_ddi_telefone_res	:= nr_ddi_telefone_res_w;
		linha_w.nr_ddd_telefone_res	:= nr_ddd_telefone_res_w;
		linha_w.nr_telefone_res		:= nr_telefone_res_w;
		linha_w.ds_fone_adic		:= ds_fone_adic_w;
		linha_w.nr_ddi_celular		:= nr_ddi_celular_w;
		linha_w.nr_ddd_celular		:= nr_ddd_celular_w;
		linha_w.nr_telefone_celular	:= nr_telefone_celular_w;
		linha_w.ds_compl_celular	:= ds_compl_celular_w;
		linha_w.nr_ddi_telefone_com	:= nr_ddi_telefone_com_w;
		linha_w.nr_ddd_telefone_com	:= nr_ddd_telefone_com_w;
		linha_w.nr_telefone_com		:= nr_telefone_com_w;
		linha_w.ds_compl_fone_com	:= ds_compl_fone_com_w;
		linha_w.ds_email_pf		:= ds_email_pf_w;
		linha_w.ds_email_pf_com		:= ds_email_pf_com_w;
		--Endereco Res
		linha_w.ie_tipo_complemento_res	:= ie_tipo_complemento_res_w;
		linha_w.cd_cep_res		:= cd_cep_res_w;
		linha_w.ds_pais_res		:= ds_pais_res_w;
		linha_w.sg_estado_res		:= sg_estado_res_w;
		linha_w.ds_estado_res		:= ds_estado_res_w;
		linha_w.ds_municipio_res	:= ds_municipio_res_w;
		linha_w.ds_tipo_logradouro_res	:= ds_tipo_logradouro_res_w;
		linha_w.ds_endereco_res		:= ds_endereco_res_w;
		linha_w.nr_endereco_res		:= nr_endereco_res_w;
		linha_w.ds_complemento_res	:= ds_complemento_res_w;
		linha_w.cd_municipio_ibge_res	:= cd_municipio_ibge_res_w;
		linha_w.ds_bairro_res		:= ds_bairro_res_w;
		linha_w.dt_atualizacao_res	:= dt_atualizacao_res_w;
		linha_w.ie_endereco_pagador_res	:= ie_endereco_pagador_res_w;
		--Endereco Comercial
		linha_w.ie_tipo_complemento_com	:= ie_tipo_complemento_com_w;
		linha_w.cd_cep_com		:= cd_cep_com_w;
		linha_w.ds_pais_com		:= ds_pais_com_w;
		linha_w.sg_estado_com		:= sg_estado_com_w;
		linha_w.ds_estado_com		:= ds_estado_com_w;
		linha_w.ds_municipio_com	:= ds_municipio_com_w;
		linha_w.ds_tipo_logradouro_com	:= ds_tipo_logradouro_com_w;
		linha_w.ds_endereco_com		:= ds_endereco_com_w;
		linha_w.nr_endereco_com		:= nr_endereco_com_w;
		linha_w.ds_complemento_com	:= ds_complemento_com_w;
		linha_w.cd_municipio_ibge_com	:= cd_municipio_ibge_com_w;
		linha_w.ds_bairro_com		:= ds_bairro_com_w;
		linha_w.dt_atualizacao_com	:= dt_atualizacao_com_w;
		linha_w.ie_endereco_pagador_com	:= ie_endereco_pagador_com_w;
		--Inf Adicionais 
		linha_w.nr_identidade		:= nr_identidade_w;
		linha_w.nr_inscricao_estadual	:= nr_inscricao_estadual_w;
		linha_w.nr_cpf			:= nr_cpf_w;
		linha_w.dt_nascimento		:= dt_nascimento_w;
		linha_w.ds_profissao		:= ds_profissao_w;
		linha_w.ds_cargo		:= ds_cargo_w;
		linha_w.ds_observacao_pf	:= ds_observacao_pf_w;
		linha_w.cd_cargo		:= cd_cargo_w;
		linha_w.nr_pis_pasep		:= nr_pis_pasep_w;
		
		linha_w.nm_pais 		:= nm_pais_w;
		linha_w.ds_observacao		:= ds_observacao_w;
		linha_w.cd_naturalidade		:= cd_naturalidade_w;
		linha_w.cd_nacionalidade	:= cd_nacionalidade_w;
		
		select	max(a.nr_sequencia)
		into STRICT	nr_seq_lead_w
		FROM pls_solicitacao_comercial a
LEFT OUTER JOIN pls_solicitacao_vendedor b ON (a.nr_sequencia = b.nr_seq_solicitacao)
WHERE a.cd_pf_vinculado = cd_pessoa_fisica_p and clock_timestamp() between coalesce(b.dt_inicio_vigencia,clock_timestamp()) and coalesce(b.dt_fim_vigencia,clock_timestamp());
		
		if (nr_seq_lead_w IS NOT NULL AND nr_seq_lead_w::text <> '') then
			select	max(b.nr_seq_vendedor_canal),
				max(a.nr_seq_agente_motivador),
				max(a.nr_seq_origem_agente),
				max(a.nr_seq_segurado_indic),
				max(a.cd_pessoa_indicacao)
			into STRICT	nr_seq_vendedor_canal_w,
				nr_seq_agente_motivador_w,
				nr_seq_origem_agente_w,
				nr_seq_segurado_indic_w,
				cd_pessoa_indicacao_w
			FROM pls_solicitacao_comercial a
LEFT OUTER JOIN pls_solicitacao_vendedor b ON (a.nr_sequencia = b.nr_seq_solicitacao)
WHERE a.nr_sequencia = nr_seq_lead_w and clock_timestamp() between coalesce(b.dt_inicio_vigencia,clock_timestamp()) and coalesce(b.dt_fim_vigencia,clock_timestamp())   LIMIT 1;
		else
				nr_seq_vendedor_canal_w		:= null;
				nr_seq_agente_motivador_w	:= null;
				nr_seq_origem_agente_w		:= null;
				nr_seq_segurado_indic_w		:= null;
				cd_pessoa_indicacao_w		:= null;
		end if;
		
		if (nr_seq_vendedor_canal_w IS NOT NULL AND nr_seq_vendedor_canal_w::text <> '') then
			begin
				select 	cd_pessoa_fisica
				into STRICT	cd_pessoa_vendedor_w
				from 	pls_vendedor
				where 	nr_sequencia = nr_seq_vendedor_canal_w;
			exception
			when others then
				cd_pessoa_vendedor_w := null;
			end;
		end if;
		
		linha_w.nr_seq_vendedor		:= nr_seq_vendedor_canal_w;
		linha_w.cd_pessoa_vendedor 	:= cd_pessoa_vendedor_w;
		linha_w.nr_seq_agente_motivador	:= nr_seq_agente_motivador_w;
		linha_w.nr_seq_origem_agente	:= nr_seq_origem_agente_w;
		linha_w.nr_seq_segurado_indic	:= nr_seq_segurado_indic_w;
		linha_w.cd_pessoa_indicacao	:= cd_pessoa_indicacao_w;
		
		RETURN NEXT linha_w;
	end if;
	
--PJ
elsif (cd_cgc_p IS NOT NULL AND cd_cgc_p::text <> '') then
	
	select	count(1)
	into STRICT	qt_registro_w
	from	pessoa_juridica
	where	cd_cgc = cd_cgc_p;
	
	if (qt_registro_w > 0) then
			
		select	cd_cgc,
			pls_obj_plussoft_pck.pls_obter_status_venda(cd_cgc,null),
			ds_razao_social,
			nm_fantasia,
			ds_nome_abrev,
			wheb_mensagem_pck.get_texto(1110353),
			wheb_mensagem_pck.get_texto(1110352),
			nr_ddi_telefone,
			nr_ddd_telefone,
			nr_telefone,
			'',
			'',
			wheb_mensagem_pck.get_texto(1110358),
			cd_cep,
			(select	max(nm_pais)
			from	pais y 
			where	y.nr_sequencia = nr_seq_pais),
			sg_estado,
			Obter_Valor_Dominio(50, sg_estado),
			ds_municipio,
			(select	max(ds_tipo_logradouro)
			from	cns_tipo_logradouro x
			where	x.nr_sequencia = nr_seq_tipo_logradouro),
			ds_endereco,
			nr_endereco,
			ds_complemento,
			cd_municipio_ibge,
			ds_bairro,
			dt_atualizacao,  
			pls_obj_plussoft_pck.pls_verifica_se_pagador(cd_cgc,null),
			nr_inscricao_estadual,
			substr(ds_observacao,1,255),
			nm_pessoa_contato
		into STRICT	cd_cgc_w,
			ie_status_w,
			ds_razao_social_w,
			nm_fantasia_w,
			nm_abreviado_w,
			ds_tipo_estipulante_w,
			ds_tipo_pulbico_w,
			nr_ddi_telefone_com_w,
			nr_ddd_telefone_com_w,
			nr_telefone_com_w,
			ds_complemento_fone_com_w,
			ds_email_pj_adic_w,
			ie_tipo_complemento_com_w, 
			cd_cep_com_w,
			ds_pais_com_w,
			sg_estado_com_w,
			ds_estado_com_w,
			ds_municipio_com_w,
			ds_tipo_logradouro_com_w,
			ds_endereco_com_w,
			nr_endereco_com_w,
			ds_complemento_com_w,
			cd_municipio_ibge_com_w,
			ds_bairro_com_w,
			dt_atualizacao_com_w,  
			ie_endereco_pagador_com_w,
			nr_inscricao_estadual_w,
			ds_observacao_pj_w,
			nm_contato_w
		from	pessoa_juridica b
		where	cd_cgc = cd_cgc_p  LIMIT 1;
		
		select	max(ds_email)
		into STRICT	ds_email_pj_w
		from	pessoa_juridica_estab
		where	cd_cgc = cd_cgc_p;

		--Dados PJ
		linha_w.ie_tipo_pessoa		:= 1;
		linha_w.ie_status		:= ie_status_w;
		linha_w.ds_razao_social		:= ds_razao_social_w;
		linha_w.nm_fantasia		:= nm_fantasia_w;
		linha_w.nm_abreviado		:= nm_abreviado_w;
		linha_w.ds_tipo_estipulante	:= ds_tipo_estipulante_w;
		linha_w.ds_tipo_pulbico		:= ds_tipo_pulbico_w;
		linha_w.ie_contactar_fone	:= 'N';
		linha_w.ie_contactar_cor	:= 'N';
		linha_w.ie_contactar_email	:= 'N';
		linha_w.ie_contactar_sms	:= 'N';
		--Contato PJ
		linha_w.nr_ddi_telefone_com	:= nr_ddi_telefone_com_w;
		linha_w.nr_ddd_telefone_com	:= nr_ddd_telefone_com_w;
		linha_w.nr_telefone_com		:= nr_telefone_com_w;
		linha_w.ds_compl_fone_com	:= ds_compl_fone_com_w;
		linha_w.ds_email_pj		:= ds_email_pj_w;
		--Endereco Comercial
		linha_w.ie_tipo_complemento_com	:= ie_tipo_complemento_com_w;
		linha_w.cd_cep_com		:= cd_cep_com_w;
		linha_w.ds_pais_com		:= ds_pais_com_w;
		linha_w.sg_estado_com		:= sg_estado_com_w;
		linha_w.ds_estado_com		:= ds_estado_com_w;
		linha_w.ds_municipio_com	:= ds_municipio_com_w;
		linha_w.ds_tipo_logradouro_com	:= ds_tipo_logradouro_com_w;
		linha_w.ds_endereco_com		:= ds_endereco_com_w;
		linha_w.nr_endereco_com		:= nr_endereco_com_w;
		linha_w.ds_complemento_com	:= ds_complemento_com_w;
		linha_w.cd_municipio_ibge_com	:= cd_municipio_ibge_com_w;
		linha_w.ds_bairro_com		:= ds_bairro_com_w;
		linha_w.dt_atualizacao_com	:= dt_atualizacao_com_w;
		linha_w.ie_endereco_pagador_com	:= ie_endereco_pagador_com_w;
		--Inf Adicionais 
		linha_w.cd_cgc			:= cd_cgc_w;
		linha_w.nr_inscricao_estadual	:= nr_inscricao_estadual_w;
		linha_w.ds_observacao_pj	:= ds_observacao_pj_w;
		linha_w.nm_contato := nm_contato_w;
		
		select	max(a.nr_sequencia)
		into STRICT	nr_seq_lead_w
		FROM pls_solicitacao_comercial a
LEFT OUTER JOIN pls_solicitacao_vendedor b ON (a.nr_sequencia = b.nr_seq_solicitacao)
WHERE a.cd_cnpj_vinculado = cd_cgc_p and clock_timestamp() between coalesce(b.dt_inicio_vigencia,clock_timestamp()) and coalesce(b.dt_fim_vigencia,clock_timestamp());
		
		if (nr_seq_lead_w IS NOT NULL AND nr_seq_lead_w::text <> '') then
			select	max(b.nr_seq_vendedor_canal),
				max(a.nr_seq_agente_motivador),
				max(a.nr_seq_origem_agente),
				max(a.nr_seq_segurado_indic),
				max(a.cd_pessoa_indicacao),
				max(a.ds_observacao)
			into STRICT	nr_seq_vendedor_canal_w,
				nr_seq_agente_motivador_w,
				nr_seq_origem_agente_w,
				nr_seq_segurado_indic_w,
				cd_pessoa_indicacao_w,
				ds_observacao_w
			FROM pls_solicitacao_comercial a
LEFT OUTER JOIN pls_solicitacao_vendedor b ON (a.nr_sequencia = b.nr_seq_solicitacao)
WHERE a.nr_sequencia = nr_seq_lead_w and clock_timestamp() between coalesce(b.dt_inicio_vigencia,clock_timestamp()) and coalesce(b.dt_fim_vigencia,clock_timestamp())   LIMIT 1;
		else
				nr_seq_vendedor_canal_w		:= null;
				nr_seq_agente_motivador_w	:= null;
				nr_seq_origem_agente_w		:= null;
				nr_seq_segurado_indic_w		:= null;
				cd_pessoa_indicacao_w		:= null;
				ds_observacao_w				:= null;
		end if;
		
		if (nr_seq_vendedor_canal_w IS NOT NULL AND nr_seq_vendedor_canal_w::text <> '') then
			begin
				select 	cd_pessoa_fisica
				into STRICT	cd_pessoa_vendedor_w
				from 	pls_vendedor
				where 	nr_sequencia = nr_seq_vendedor_canal_w;
			exception
			when others then
				cd_pessoa_vendedor_w := null;
			end;
		end if;
		
		linha_w.nr_seq_vendedor		:= nr_seq_vendedor_canal_w;
		linha_w.cd_pessoa_vendedor 	:= cd_pessoa_vendedor_w;
		linha_w.nr_seq_agente_motivador	:= nr_seq_agente_motivador_w;
		linha_w.nr_seq_origem_agente	:= nr_seq_origem_agente_w;
		linha_w.nr_seq_segurado_indic	:= nr_seq_segurado_indic_w;
		linha_w.cd_pessoa_indicacao	:= cd_pessoa_indicacao_w;
		linha_w.ds_observacao 		:= ds_observacao_w;
		
		RETURN NEXT linha_w;
	end if;
	
end if;

--nao retorna nada
return;
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pls_obj_plussoft_pck.obter_dados_pessoa ( cd_pessoa_fisica_p pessoa_fisica.cd_pessoa_fisica%type, cd_cgc_p pessoa_juridica.cd_cgc%type ) FROM PUBLIC;
