-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_obj_plussoft_pck.gerar_mensalidade ( nr_seq_lote_p pls_lote_mensalidade.nr_sequencia%type, cd_pessoa_usuario_p pessoa_fisica.cd_pessoa_fisica%type, ie_resultado_p INOUT bigint, ds_mensagem_erro_p INOUT text) AS $body$
DECLARE


current_setting('pls_obj_plussoft_pck.cd_estabelecimento_w')::smallint		estabelecimento.cd_estabelecimento%type;
dt_mesano_referencia_w		pls_lote_mensalidade.dt_mesano_referencia%type;
nr_seq_lote_w			bigint;
current_setting('pls_obj_plussoft_pck.nr_seq_contrato_w')::bigint		bigint;
current_setting('pls_obj_plussoft_pck.nm_usuario_w')::usuario.nm_usuario%type			usuario.nm_usuario%type;
/*
ie_resultado_p
0 - OK
1 - Erro
*/
BEGIN
--Erro
ie_resultado_p := 1;

--Encontra o usuario
begin
select	max(nm_usuario)
into STRICT	current_setting('pls_obj_plussoft_pck.nm_usuario_w')::usuario.nm_usuario%type
from	usuario
where	cd_pessoa_fisica = cd_pessoa_usuario_p
and	ie_situacao = 'A';
exception
when others then
	PERFORM set_config('pls_obj_plussoft_pck.nm_usuario_w', null, false);
end;

--O lote nao pode estar nulo
if (nr_seq_lote_p IS NOT NULL AND nr_seq_lote_p::text <> '') then

	begin
	select	cd_estabelecimento,
		dt_mesano_referencia,
		nr_seq_contrato
	into STRICT	current_setting('pls_obj_plussoft_pck.cd_estabelecimento_w')::smallint,
		dt_mesano_referencia_w,
		current_setting('pls_obj_plussoft_pck.nr_seq_contrato_w')::bigint
	from	pls_lote_mensalidade
	where	nr_sequencia = nr_seq_lote_p;
	exception
	when others then
		PERFORM set_config('pls_obj_plussoft_pck.cd_estabelecimento_w', null, false);
	end;
	
	--Verifica a existencia do lote
	if (current_setting('pls_obj_plussoft_pck.cd_estabelecimento_w')::(smallint IS NOT NULL AND smallint::text <> '')) then
		begin
		nr_seq_lote_w := nr_seq_lote_p;
		pls_gerar_mensalidade_plusoft(nr_seq_lote_w, current_setting('pls_obj_plussoft_pck.nr_seq_contrato_w')::bigint, dt_mesano_referencia_w, current_setting('pls_obj_plussoft_pck.nm_usuario_w')::usuario.nm_usuario%type, ds_mensagem_erro_p);

		--Apos gerado o lote, chama a mesma rotina de geracao da mensalidade de contratacao
		--pls_geracao_mensalidade(nr_seq_lote_p, cd_estabelecimento_w, 'plusoft');
		
		if (coalesce(ds_mensagem_erro_p::text, '') = '') then
			ie_resultado_p := 0;
		end if;
		
		exception
		when others then
			ds_mensagem_erro_p := substr(wheb_mensagem_pck.get_texto(1110477, 'DS_ERRO='||sqlerrm(SQLSTATE)) ,1,255);
		end;
	else
		ds_mensagem_erro_p := substr(wheb_mensagem_pck.get_texto(1110472) ,1,255);
	end if;
else
	ds_mensagem_erro_p := substr(wheb_mensagem_pck.get_texto(1110478) ,1,255);
end if;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_obj_plussoft_pck.gerar_mensalidade ( nr_seq_lote_p pls_lote_mensalidade.nr_sequencia%type, cd_pessoa_usuario_p pessoa_fisica.cd_pessoa_fisica%type, ie_resultado_p INOUT bigint, ds_mensagem_erro_p INOUT text) FROM PUBLIC;
