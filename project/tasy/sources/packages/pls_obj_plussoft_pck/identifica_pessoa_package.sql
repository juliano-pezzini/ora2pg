-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pls_obj_plussoft_pck.identifica_pessoa ( ie_tipo_pessoa_p bigint, cd_pessoa_fisica_p pessoa_fisica.cd_pessoa_fisica%type, nr_cpf_p pessoa_fisica.nr_cpf%type, cd_cgc_p pessoa_juridica.cd_cgc%type, nm_pessoa_fisica_p pessoa_fisica.nm_pessoa_fisica%type, ds_razao_social_p pessoa_juridica.ds_razao_social%type, nm_abreviado_p pessoa_fisica.nm_abreviado%type, dt_nascimento_p pessoa_fisica.dt_nascimento%type, nr_seq_proposta_p pls_proposta_adesao.nr_sequencia%type, cd_pessoa_vendedor_p pls_vendedor.cd_pessoa_fisica%type, ds_email_pf_p compl_pessoa_fisica.ds_email%type, ds_email_pj_p pessoa_juridica_estab.ds_email%type, ds_status_pessoa_p text ) RETURNS SETOF T_IDENTIFICA_PESSOA_DATA AS $body$
DECLARE

/*
Parametros de entrada serao utilizados como filtro para o retorno da consulta
0 - Pessoa fisica
1 - Pessoa juridica

padrao do alias  
b - pessoa_fisica
c - pessoa_juridica

*/
ds_restricao_w		text;
ds_select_w		text;
ds_select_fim_w		text;
linha_w			t_identifica_pessoa_row;
r_C01_w  		REFCURSOR;
ie_tipo_w		varchar(1);



BEGIN
/*Monta o select conforme o status de venda  ds_status_pessoa_p */

ds_select_w :=  ' select  ie_tipo_pessoa,'||pls_util_pck.enter_w ||
						' cd_pessoa_fisica,  '||pls_util_pck.enter_w ||
						' nm_pessoa_fisica,  '||pls_util_pck.enter_w ||
						' ds_razao_social,   '||pls_util_pck.enter_w ||
						' nm_abreviado,      '||pls_util_pck.enter_w ||
						' dt_nascimento,     '||pls_util_pck.enter_w ||
						' nr_cpf,	      '||pls_util_pck.enter_w ||
						' cd_cgc,	      '||pls_util_pck.enter_w ||
						' ds_email_pf,'||pls_util_pck.enter_w ||
						' ds_email_pj,	      '||pls_util_pck.enter_w ||
						' nr_seq_proposta,   '||pls_util_pck.enter_w ||
						' cd_pessoa_vendedor,'||pls_util_pck.enter_w ||
						' cd_usuario_plano, '||pls_util_pck.enter_w ||
						' nr_seq_contrato,  '||pls_util_pck.enter_w ||
						' nr_seq_segurado,  '||pls_util_pck.enter_w ||
						' ds_tipo_pessoa,   '||pls_util_pck.enter_w ||
						' ie_situacao,	    '||pls_util_pck.enter_w ||
						' ds_situacao,      '||pls_util_pck.enter_w ||
						' ds_status_pessoa, '||pls_util_pck.enter_w ||
						' ds_tipo_publico, '||pls_util_pck.enter_w ||
						' ds_renda         '||pls_util_pck.enter_w ||
						' from	(' ||pls_util_pck.enter_w;

if (upper(ds_status_pessoa_p) = 'LEAD') then
		/*caso nao for PJ */
		if (ie_tipo_pessoa_p = 0 or coalesce(ie_tipo_pessoa_p::text, '') = '') then
			ds_select_w := ds_select_w ||pls_util_pck.enter_w||
					' select  0   ie_tipo_pessoa,    '||pls_util_pck.enter_w ||
					'  	  a.cd_pf_vinculado cd_pessoa_fisica,  '||pls_util_pck.enter_w ||
					'	  b.nm_pessoa_fisica nm_pessoa_fisica,  '||pls_util_pck.enter_w ||
					'	  null		   ds_razao_social,   '||pls_util_pck.enter_w ||
					'	  b.nm_abreviado	   nm_abreviado,      '||pls_util_pck.enter_w ||
 					'	  b.dt_nascimento    dt_nascimento,     '||pls_util_pck.enter_w ||
					'	  a.nr_cpf	   nr_cpf,	      '||pls_util_pck.enter_w ||
					'	  null		   cd_cgc,	      '||pls_util_pck.enter_w ||
					'	  pls_obj_plussoft_pck.obter_email_pf_pj(null, b.cd_pessoa_fisica)  ds_email_pf,'||pls_util_pck.enter_w ||
					'	  null		   ds_email_pj,	      '||pls_util_pck.enter_w ||
					'	  null		   nr_seq_proposta,   '||pls_util_pck.enter_w ||
					'	  pls_obj_plussoft_pck.pls_busca_vendedor(a.nr_sequencia,''L'') cd_pessoa_vendedor,'||pls_util_pck.enter_w ||
 					'	  pls_obter_carteira_benef(a.nr_seq_segurado) cd_usuario_plano,  '||pls_util_pck.enter_w ||
					' 	  a.nr_seq_contrato	   nr_seq_contrato,   '||pls_util_pck.enter_w ||
					'	  a.nr_seq_segurado	   nr_seq_segurado,   '||pls_util_pck.enter_w ||
					'	  wheb_mensagem_pck.get_texto(1110355)	   ds_tipo_pessoa,    '||pls_util_pck.enter_w ||
					'	  a.ie_status 		   ie_situacao,	      '||pls_util_pck.enter_w ||
					'	  (select  substr(ds_expressao,1,20)
						   from  valor_dominio_v
						   where  cd_dominio  = 2461
						   and  vl_dominio  = a.ie_status) ds_situacao,  '||pls_util_pck.enter_w ||
					'	   ''LEAD'' ds_status_pessoa, '||pls_util_pck.enter_w ||
 					'	   wheb_mensagem_pck.get_texto(1110352) ds_tipo_publico, '||pls_util_pck.enter_w ||
					'	   pls_obj_plussoft_pck.pls_obter_pf_renda(b.cd_pessoa_fisica)	ds_renda     	   '||pls_util_pck.enter_w ||
					' from	pls_solicitacao_comercial a,'||pls_util_pck.enter_w ||
					'		pessoa_fisica	b '||pls_util_pck.enter_w ||
					' 		where	a.cd_pf_vinculado = b.cd_pessoa_fisica '||pls_util_pck.enter_w||
					' 		and		a.ie_status  = ''PE''  '||pls_util_pck.enter_w;
		/*restricao cd_vendedor = 0 */

		if (cd_pessoa_vendedor_p = '0' ) then
			ds_select_w := ds_select_w || ' and not exists ( select  1  ' || pls_util_pck.enter_w||
										  ' from pls_solicitacao_vendedor x '|| pls_util_pck.enter_w||
										  ' where x.nr_seq_solicitacao = a.nr_sequencia '||pls_util_pck.enter_w||
										  ' and sysdate between x.dt_inicio_vigencia and nvl(x.dt_fim_vigencia,sysdate) )'||pls_util_pck.enter_w;
		end if;
		
		end if;
		/*caso nao for PF */

		if (ie_tipo_pessoa_p = 1 or coalesce(ie_tipo_pessoa_p::text, '') = '') then
		
			/*Caso o ie_tipo_pessoa for nulo, realiza o union all*/

			if (coalesce(ie_tipo_pessoa_p::text, '') = '') then
				ds_select_w := ds_select_w ||pls_util_pck.enter_w||' union all '||pls_util_pck.enter_w;
			end if;
			
			ds_select_w :=  ds_select_w||
					' select  1 ie_tipo_pessoa,' ||pls_util_pck.enter_w ||
					'	null	   cd_pessoa_fisica,  '||pls_util_pck.enter_w ||
					'	null	   nm_pessoa_fisica,  '||pls_util_pck.enter_w ||
					'	b.ds_razao_social  ds_razao_social,   '||pls_util_pck.enter_w ||
					'	b.ds_nome_abrev nm_abreviado,	   '||pls_util_pck.enter_w ||
 					'	null	dt_nascimento,	   '||pls_util_pck.enter_w ||
					'	null	nr_cpf,		   '||pls_util_pck.enter_w ||
					'	b.cd_cgc	cd_cgc,		   '||pls_util_pck.enter_w ||
					'	null		ds_email_pf,	   '||pls_util_pck.enter_w ||
					'	pls_obj_plussoft_pck.obter_email_pf_pj(b.cd_cgc, null) ds_email_pj,	   '||pls_util_pck.enter_w ||
					'	null	nr_seq_proposta,   '||pls_util_pck.enter_w ||
					'	pls_obj_plussoft_pck.pls_busca_vendedor(a.nr_sequencia,''L'') cd_pessoa_vendedor,'||pls_util_pck.enter_w ||
 					'	null	cd_usuario_plano,  '||pls_util_pck.enter_w ||
					' 	a.nr_seq_contrato	nr_seq_contrato,'||pls_util_pck.enter_w ||
					'	a.nr_seq_segurado	nr_seq_segurado,'||pls_util_pck.enter_w ||
					'	wheb_mensagem_pck.get_texto(1110353) 	ds_tipo_pessoa,'||pls_util_pck.enter_w ||
					'	a.ie_status  ie_situacao,	   '||pls_util_pck.enter_w ||
					'   (select  substr(ds_expressao,1,20) 
						 from 	 valor_dominio_v
						 where  cd_dominio  = 2461
						 and  vl_dominio  = a.ie_status) ds_situacao,'||pls_util_pck.enter_w ||
					'	''LEAD'' ds_status_pessoa, '||pls_util_pck.enter_w ||
 					'	wheb_mensagem_pck.get_texto(1110354) ds_tipo_publico,'||pls_util_pck.enter_w ||
					'	null ds_renda  '||pls_util_pck.enter_w ||
					' from	pls_solicitacao_comercial a,'||pls_util_pck.enter_w ||
					'	pessoa_juridica b '||pls_util_pck.enter_w ||
					' where	a.cd_cgc = b.cd_cgc '||pls_util_pck.enter_w||
					' 	and		a.ie_status  = ''PE''  '||pls_util_pck.enter_w;
		
		/*restricao cd_vendedor = 0 */

		if (cd_pessoa_vendedor_p = '0' ) then
			ds_select_w := ds_select_w || ' and not exists ( select  1  ' || pls_util_pck.enter_w||
										  ' from pls_solicitacao_vendedor x '|| pls_util_pck.enter_w||
										  ' where x.nr_seq_solicitacao = a.nr_sequencia '||pls_util_pck.enter_w||
										  ' and sysdate between x.dt_inicio_vigencia and nvl(x.dt_fim_vigencia,sysdate) )'||pls_util_pck.enter_w;
		end if;
		
		end if;
	
elsif (upper(ds_status_pessoa_p) = 'PROSPECT') then
	if (ie_tipo_pessoa_p = 0 or coalesce(ie_tipo_pessoa_p::text, '') = '') then
		ds_select_w :=  ds_select_w ||pls_util_pck.enter_w||
					/*Prospect*/

					' select	0  ie_tipo_pessoa,    '||pls_util_pck.enter_w ||
							' 	b.cd_pessoa_fisica cd_pessoa_fisica,  '||pls_util_pck.enter_w ||
							' 	b.nm_pessoa_fisica nm_pessoa_fisica,  '||pls_util_pck.enter_w ||
							' 	null		   ds_razao_social,   '||pls_util_pck.enter_w ||
							' 	b.nm_abreviado	   nm_abreviado,      '||pls_util_pck.enter_w ||
							' 	b.dt_nascimento    dt_nascimento,     '||pls_util_pck.enter_w ||
							' 	b.nr_cpf	   nr_cpf,	      '||pls_util_pck.enter_w ||
							' 	null		   cd_cgc,	      '||pls_util_pck.enter_w ||
							' 	pls_obj_plussoft_pck.obter_email_pf_pj(null, b.cd_pessoa_fisica)  ds_email_pf,'||pls_util_pck.enter_w ||
							' 	null		   ds_email_pj,	      '||pls_util_pck.enter_w ||
							'	c.nr_sequencia   nr_seq_proposta,   '||pls_util_pck.enter_w ||
							'	pls_obj_plussoft_pck.pls_busca_vendedor(a.nr_sequencia,''P'') cd_pessoa_vendedor,'||pls_util_pck.enter_w ||
							'	pls_obter_carteira_benef(a.nr_seq_segurado) cd_usuario_plano,  '||pls_util_pck.enter_w ||
							' 	a.nr_contrato_existente  nr_seq_contrato,   '||pls_util_pck.enter_w ||
							'	a.nr_seq_segurado 	  nr_seq_segurado,   '||pls_util_pck.enter_w ||
							'	wheb_mensagem_pck.get_texto(1110355)	   ds_tipo_pessoa,    '||pls_util_pck.enter_w ||
							'	c.ie_status 		   ie_situacao,	      '||pls_util_pck.enter_w ||
							'	(select  substr(ds_expressao,1,20) 
								 from  valor_dominio_v
								 where  cd_dominio  =2331
								 and  vl_dominio  = c.ie_status) ds_situacao,  '||pls_util_pck.enter_w ||
							'	 ''PROSPECT''  ds_status_pessoa, '||pls_util_pck.enter_w ||
							'	 wheb_mensagem_pck.get_texto(1110352) ds_tipo_publico, '||pls_util_pck.enter_w ||
							'	 pls_obj_plussoft_pck.pls_obter_pf_renda(b.cd_pessoa_fisica)	ds_renda '||pls_util_pck.enter_w ||
					' from	pls_comercial_cliente a,'||pls_util_pck.enter_w ||
						'	pessoa_fisica	b, '||pls_util_pck.enter_w ||
						'	pls_proposta_adesao	c '||pls_util_pck.enter_w ||
					' where	a.cd_pessoa_fisica = b.cd_pessoa_fisica '||pls_util_pck.enter_w||
					'  and	c.nr_seq_cliente = a.nr_sequencia  '||pls_util_pck.enter_w||
					'  and	a.ie_status <> ''N'' '||pls_util_pck.enter_w||
					'  and	c.ie_status in (''U'',''C'',''E'',''N'',''A'',''M'') '||pls_util_pck.enter_w||
					'  union all '||pls_util_pck.enter_w||
					/*Proposta*/

					' select  0  ie_tipo_pessoa,    '||pls_util_pck.enter_w ||
					'     b.cd_pessoa_fisica cd_pessoa_fisica,  '||pls_util_pck.enter_w ||
					'	  b.nm_pessoa_fisica nm_pessoa_fisica,  '||pls_util_pck.enter_w ||
					'	  null		   ds_razao_social,   '||pls_util_pck.enter_w ||
					'	  b.nm_abreviado	   nm_abreviado,      '||pls_util_pck.enter_w ||
 					'	  b.dt_nascimento    dt_nascimento,     '||pls_util_pck.enter_w ||
					'	  b.nr_cpf	   nr_cpf,	      '||pls_util_pck.enter_w ||
					'	  null		   cd_cgc,	      '||pls_util_pck.enter_w ||
					'	  pls_obj_plussoft_pck.obter_email_pf_pj(null, b.cd_pessoa_fisica)  ds_email_pf,'||pls_util_pck.enter_w ||
					'	  null		   ds_email_pj,	      '||pls_util_pck.enter_w ||
					'	  a.nr_sequencia   nr_seq_proposta,   '||pls_util_pck.enter_w ||
					'	  pls_obj_plussoft_pck.pls_busca_vendedor(a.nr_sequencia,''PA'') cd_pessoa_vendedor,'||pls_util_pck.enter_w ||
 					'	  null cd_usuario_plano,  '||pls_util_pck.enter_w ||
					' 	  a.nr_seq_contrato  nr_seq_contrato,   '||pls_util_pck.enter_w ||
					'	  null	 	  nr_seq_segurado,   '||pls_util_pck.enter_w ||
					'	  wheb_mensagem_pck.get_texto(1110355)	   ds_tipo_pessoa,    '||pls_util_pck.enter_w ||
					'	  a.ie_status 		   ie_situacao,	      '||pls_util_pck.enter_w ||
					'	  (select  substr(ds_expressao,1,20) 
						   from  valor_dominio_v
						   where  cd_dominio  =2331
						   and  vl_dominio  = a.ie_status) ds_situacao,  '||pls_util_pck.enter_w ||
					'	   ''PROSPECT''  ds_status_pessoa, '||pls_util_pck.enter_w ||
 					'	   wheb_mensagem_pck.get_texto(1110352) ds_tipo_publico, '||pls_util_pck.enter_w ||
					'	   pls_obj_plussoft_pck.pls_obter_pf_renda(b.cd_pessoa_fisica)	ds_renda '||pls_util_pck.enter_w ||
					' from	pls_proposta_adesao a,'||pls_util_pck.enter_w ||
					'		pessoa_fisica	b, '||pls_util_pck.enter_w ||
					'		pls_proposta_beneficiario c '||pls_util_pck.enter_w ||
					' where	c.nr_seq_proposta = a.nr_sequencia '||pls_util_pck.enter_w||
					'  and	c.cd_beneficiario = b.cd_pessoa_fisica  '||pls_util_pck.enter_w||
					'  and	a.nr_seq_cliente is null '||pls_util_pck.enter_w||
					'  and	a.ie_status in (''U'',''C'',''E'',''N'',''A'',''M'') '||pls_util_pck.enter_w;
					
		end if;
	/* PJ */

		if (ie_tipo_pessoa_p = 1 or coalesce(ie_tipo_pessoa_p::text, '') = '') then
			/*Caso o ie_tipo_pessoa for nulo, realiza o union all*/

			if (coalesce(ie_tipo_pessoa_p::text, '') = '') then
				ds_select_w := ds_select_w ||pls_util_pck.enter_w||' union all '||pls_util_pck.enter_w;
			end if;
			ds_select_w := ds_select_w || pls_util_pck.enter_w ||
					/*Prospect*/

					' select	1  ie_tipo_pessoa,' ||pls_util_pck.enter_w ||
					'	a.cd_pessoa_fisica   cd_pessoa_fisica,  '||pls_util_pck.enter_w ||
					'	obter_nome_pf(a.cd_pessoa_fisica)  nm_pessoa_fisica,  '||pls_util_pck.enter_w ||
					'	b.ds_razao_social  ds_razao_social,   '||pls_util_pck.enter_w ||
					'	b.ds_nome_abrev nm_abreviado,	   '||pls_util_pck.enter_w ||
 					'	null	dt_nascimento,	   '||pls_util_pck.enter_w ||
					'	null	nr_cpf,		   '||pls_util_pck.enter_w ||
					'	b.cd_cgc	cd_cgc,		   '||pls_util_pck.enter_w ||
					'	null		ds_email_pf,	   '||pls_util_pck.enter_w ||
					'	pls_obj_plussoft_pck.obter_email_pf_pj(b.cd_cgc, null) ds_email_pj,	   '||pls_util_pck.enter_w ||
					'	c.nr_sequencia	nr_seq_proposta,   '||pls_util_pck.enter_w ||
					'	pls_obj_plussoft_pck.pls_busca_vendedor(a.nr_sequencia,''P'') cd_pessoa_vendedor,'||pls_util_pck.enter_w ||
 					'	null	cd_usuario_plano,  '||pls_util_pck.enter_w ||
					' 	a.nr_seq_contrato	nr_seq_contrato,'||pls_util_pck.enter_w ||
					'	a.nr_seq_segurado	nr_seq_segurado,'||pls_util_pck.enter_w ||
					'	wheb_mensagem_pck.get_texto(1110353) 	ds_tipo_pessoa,'||pls_util_pck.enter_w ||
					'	c.ie_status  ie_situacao,	   '||pls_util_pck.enter_w ||
					'       (select  substr(ds_expressao,1,20) 
							 from 	 valor_dominio_v
							 where  cd_dominio  = 2331
							and  vl_dominio  = c.ie_status) ds_situacao,'||pls_util_pck.enter_w ||
					'	''PROSPECT'' ds_status_pessoa,'||pls_util_pck.enter_w ||
 					'	wheb_mensagem_pck.get_texto(1110354) ds_tipo_publico,'||pls_util_pck.enter_w ||
					'	null ds_renda  '||pls_util_pck.enter_w ||
					' from	pls_comercial_cliente a,'||pls_util_pck.enter_w ||
					'	pessoa_juridica b, '||pls_util_pck.enter_w ||
					'	pls_proposta_adesao	c '||pls_util_pck.enter_w ||
					' where	a.cd_cgc = b.cd_cgc '||pls_util_pck.enter_w||
					'  and	c.nr_seq_cliente = a.nr_sequencia  '||pls_util_pck.enter_w||
					'  and	a.ie_status <> ''N'' '||pls_util_pck.enter_w||
				    '  and	c.ie_status in (''U'',''C'',''E'',''N'',''A'',''M'') '||pls_util_pck.enter_w||
					'  		union all '||pls_util_pck.enter_w||
					/* Proposta */
		
					' select	1  ie_tipo_pessoa,' ||pls_util_pck.enter_w ||
					'	null   cd_pessoa_fisica,  '||pls_util_pck.enter_w ||
					'	null  nm_pessoa_fisica,  '||pls_util_pck.enter_w ||
					'	b.ds_razao_social  ds_razao_social,   '||pls_util_pck.enter_w ||
					'	b.ds_nome_abrev nm_abreviado,	   '||pls_util_pck.enter_w ||
 					'	null	dt_nascimento,	   '||pls_util_pck.enter_w ||
					'	null	nr_cpf,		   '||pls_util_pck.enter_w ||
					'	b.cd_cgc	cd_cgc,		   '||pls_util_pck.enter_w ||
					'	null		ds_email_pf,	   '||pls_util_pck.enter_w ||
					'	pls_obj_plussoft_pck.obter_email_pf_pj(b.cd_cgc, null) ds_email_pj,	   '||pls_util_pck.enter_w ||
					'	c.nr_sequencia	nr_seq_proposta,   '||pls_util_pck.enter_w ||
					'	pls_obj_plussoft_pck.pls_busca_vendedor(c.nr_sequencia,''PA'') cd_pessoa_vendedor,'||pls_util_pck.enter_w ||
 					'	null	cd_usuario_plano,  '||pls_util_pck.enter_w ||
					' 	c.nr_seq_contrato	nr_seq_contrato,'||pls_util_pck.enter_w ||
					'	null	nr_seq_segurado,'||pls_util_pck.enter_w ||
					'	wheb_mensagem_pck.get_texto(1110353) 	ds_tipo_pessoa,'||pls_util_pck.enter_w ||
					'	c.ie_status  ie_situacao,	   '||pls_util_pck.enter_w ||
					'       (select  substr(ds_expressao,1,20) 
							 from 	 valor_dominio_v
							 where  cd_dominio  = 2331
							and  vl_dominio  = c.ie_status) ds_situacao,'||pls_util_pck.enter_w ||
					'	''PROSPECT'' ds_status_pessoa,'||pls_util_pck.enter_w ||
 					'	wheb_mensagem_pck.get_texto(1110354) ds_tipo_publico,'||pls_util_pck.enter_w ||
					'	null ds_renda  '||pls_util_pck.enter_w ||
					' from	pls_proposta_adesao c,'||pls_util_pck.enter_w ||
					'	pessoa_juridica b '||pls_util_pck.enter_w ||
					' where	c.cd_cgc_estipulante = b.cd_cgc '||pls_util_pck.enter_w||
					'  and	c.nr_seq_cliente is null '||pls_util_pck.enter_w||
				    '  and	c.ie_status in (''U'',''C'',''E'',''N'',''A'',''M'') '||pls_util_pck.enter_w;
		end if;
		
elsif (upper(ds_status_pessoa_p) = 'CLIENTE') then
	
		if (ie_tipo_pessoa_p = 0 or coalesce(ie_tipo_pessoa_p::text, '') = '' ) then
		ds_select_w :=  ds_select_w ||pls_util_pck.enter_w||
					' select  0  ie_tipo_pessoa,    '||pls_util_pck.enter_w ||
					'     b.cd_pessoa_fisica cd_pessoa_fisica,  '||pls_util_pck.enter_w ||
					'	  b.nm_pessoa_fisica nm_pessoa_fisica,  '||pls_util_pck.enter_w ||
					'	  null		   ds_razao_social,   '||pls_util_pck.enter_w ||
					'	  b.nm_abreviado	   nm_abreviado,      '||pls_util_pck.enter_w ||
 					'	  b.dt_nascimento    dt_nascimento,     '||pls_util_pck.enter_w ||
					'	  b.nr_cpf	   nr_cpf,	    '||pls_util_pck.enter_w ||
					'	  null		   cd_cgc,	    '||pls_util_pck.enter_w ||
					'	  pls_obj_plussoft_pck.obter_email_pf_pj(null, b.cd_pessoa_fisica)  ds_email_pf,'||pls_util_pck.enter_w ||
					'	  null	ds_email_pj,	 	'||pls_util_pck.enter_w ||
					'	  c.nr_proposta_adesao	nr_seq_proposta,   '||pls_util_pck.enter_w ||
					'	  pls_obj_plussoft_pck.pls_busca_vendedor(c.nr_sequencia,''C'') cd_pessoa_vendedor,'||pls_util_pck.enter_w ||
 					'	  pls_obter_carteira_benef(c.nr_sequencia) cd_usuario_plano,  '||pls_util_pck.enter_w ||
					' 	  a.nr_sequencia  nr_seq_contrato,   '||pls_util_pck.enter_w ||
					'	  c.nr_sequencia 	  nr_seq_segurado,   '||pls_util_pck.enter_w ||
					'	  wheb_mensagem_pck.get_texto(1110355)	   ds_tipo_pessoa,    '||pls_util_pck.enter_w ||
					'	  pls_obter_dados_segurado(c.nr_sequencia,''CS'') ie_situacao,'||pls_util_pck.enter_w ||
					'	  pls_obter_dados_segurado(c.nr_sequencia,''DS'') ds_situacao,'||pls_util_pck.enter_w ||
					'	  ''CLIENTE''  ds_status_pessoa,'||pls_util_pck.enter_w ||
 					'	  wheb_mensagem_pck.get_texto(1110352) ds_tipo_publico, '||pls_util_pck.enter_w ||
					'	  pls_obj_plussoft_pck.pls_obter_pf_renda(b.cd_pessoa_fisica)	ds_renda     	'||pls_util_pck.enter_w ||
					' from	pls_contrato a,'||pls_util_pck.enter_w ||
					'		pessoa_fisica	b,'||pls_util_pck.enter_w ||
					'		pls_segurado	c '||pls_util_pck.enter_w ||
					' where	a.nr_sequencia = c.nr_seq_contrato '||pls_util_pck.enter_w||
					' and	b.cd_pessoa_fisica = c.cd_pessoa_fisica '||pls_util_pck.enter_w;
		end if;
	/*caso nao for PF */

		if (ie_tipo_pessoa_p = 1 or coalesce(ie_tipo_pessoa_p::text, '') = '') then
			/*Caso o ie_tipo_pessoa for nulo, realiza o union all*/

			if (coalesce(ie_tipo_pessoa_p::text, '') = '') then
				ds_select_w := ds_select_w ||pls_util_pck.enter_w||' union all '||pls_util_pck.enter_w;
			end if;
			ds_select_w :=  ds_select_w||' select  1 ie_tipo_pessoa,' ||pls_util_pck.enter_w ||
					'	null	   cd_pessoa_fisica,  '||pls_util_pck.enter_w ||
					'	null	   nm_pessoa_fisica,  '||pls_util_pck.enter_w ||
					'	b.ds_razao_social  ds_razao_social,'||pls_util_pck.enter_w ||
					'	b.ds_nome_abrev nm_abreviado,'||pls_util_pck.enter_w ||
 					'	null	dt_nascimento,'||pls_util_pck.enter_w ||
					'	null	nr_cpf,	'||pls_util_pck.enter_w ||
					'	b.cd_cgc	cd_cgc,	'||pls_util_pck.enter_w ||
					'	null		ds_email_pf, '||pls_util_pck.enter_w ||
					'	pls_obj_plussoft_pck.obter_email_pf_pj(b.cd_cgc, null) ds_email_pj,	'||pls_util_pck.enter_w ||
					'	substr(a.nr_seq_proposta,1,10)	nr_seq_proposta, '||pls_util_pck.enter_w ||
					'	pls_obj_plussoft_pck.pls_busca_vendedor(a.nr_seq_proposta,''PA'') cd_pessoa_vendedor,'||pls_util_pck.enter_w ||
 					'	null	cd_usuario_plano, '||pls_util_pck.enter_w ||
					' 	a.nr_sequencia	nr_seq_contrato,'||pls_util_pck.enter_w ||
					'	null	nr_seq_segurado,'||pls_util_pck.enter_w ||
					'	wheb_mensagem_pck.get_texto(1110353) 	ds_tipo_pessoa,'||pls_util_pck.enter_w ||
					'	a.ie_situacao   ie_situacao, '||pls_util_pck.enter_w ||
					'   (select  substr(ds_expressao,1,20) 
						 from 	 valor_dominio_v
						 where  cd_dominio  = 1733
						 and  vl_dominio  = a.ie_situacao) ds_situacao,'||pls_util_pck.enter_w ||
					'	''CLIENTE'' ds_status_pessoa,'||pls_util_pck.enter_w ||
 					'	wheb_mensagem_pck.get_texto(1110354) ds_tipo_publico,'||pls_util_pck.enter_w ||
					'	null ds_renda  '||pls_util_pck.enter_w ||
					' from	pls_contrato a,'||pls_util_pck.enter_w ||
					'	pessoa_juridica b '||pls_util_pck.enter_w ||
					'   where	a.cd_cgc_estipulante = b.cd_cgc '||pls_util_pck.enter_w;
		end if;
elsif (coalesce(ds_status_pessoa_p::text, '') = '') then
		if (ie_tipo_pessoa_p = 0 or coalesce(ie_tipo_pessoa_p::text, '') = '' ) then
		ds_select_w :=  ds_select_w ||pls_util_pck.enter_w||
					' select  0  ie_tipo_pessoa,    '||pls_util_pck.enter_w ||
					'     b.cd_pessoa_fisica cd_pessoa_fisica,  '||pls_util_pck.enter_w ||
					'	  b.nm_pessoa_fisica nm_pessoa_fisica,  '||pls_util_pck.enter_w ||
					'	  null		   ds_razao_social,   '||pls_util_pck.enter_w ||
					'	  b.nm_abreviado	   nm_abreviado,      '||pls_util_pck.enter_w ||
 					'	  b.dt_nascimento    dt_nascimento,     '||pls_util_pck.enter_w ||
					'	  b.nr_cpf	   nr_cpf,	    '||pls_util_pck.enter_w ||
					'	  null		   cd_cgc,	    '||pls_util_pck.enter_w ||
					'	  pls_obj_plussoft_pck.obter_email_pf_pj(null, b.cd_pessoa_fisica)  ds_email_pf,'||pls_util_pck.enter_w ||
					'	  null	ds_email_pj,	 	'||pls_util_pck.enter_w ||
					'	  a.nr_proposta_adesao	nr_seq_proposta,   '||pls_util_pck.enter_w ||
					'	  pls_obj_plussoft_pck.pls_busca_vendedor(a.nr_sequencia,''C'')   cd_pessoa_vendedor,'||pls_util_pck.enter_w ||
 					'	  pls_obter_carteira_benef(a.nr_sequencia)  cd_usuario_plano,  '||pls_util_pck.enter_w ||
					' 	  a.nr_seq_contrato  nr_seq_contrato,   '||pls_util_pck.enter_w ||
					'	  a.nr_sequencia 	nr_seq_segurado,   '||pls_util_pck.enter_w ||
					'	  wheb_mensagem_pck.get_texto(1110355)	   ds_tipo_pessoa,    '||pls_util_pck.enter_w ||
					'	  pls_obter_dados_segurado(a.nr_sequencia,''CS'') ie_situacao,'||pls_util_pck.enter_w ||
					'	  pls_obter_dados_segurado(a.nr_sequencia,''DS'') ds_situacao,'||pls_util_pck.enter_w ||
					'	  decode(a.nr_sequencia,null, upper(wheb_mensagem_pck.get_texto(1110355)),''CLIENTE'')  ds_status_pessoa,'||pls_util_pck.enter_w ||
 					'	  wheb_mensagem_pck.get_texto(1110355) ds_tipo_publico, '||pls_util_pck.enter_w ||
					'	  pls_obj_plussoft_pck.pls_obter_pf_renda(b.cd_pessoa_fisica)	ds_renda     	'||pls_util_pck.enter_w ||
					' from	pessoa_fisica	b ,'||pls_util_pck.enter_w ||
					' 		pls_segurado	a '||pls_util_pck.enter_w ||
					' where	b.cd_pessoa_fisica = a.cd_pessoa_fisica(+) '||pls_util_pck.enter_w;
		end if;
	/*caso nao for PF */

		if (ie_tipo_pessoa_p = 1 or coalesce(ie_tipo_pessoa_p::text, '') = '') then
			/*Caso o ie_tipo_pessoa for nulo, realiza o union all*/

			if (coalesce(ie_tipo_pessoa_p::text, '') = '') then
				ds_select_w := ds_select_w ||pls_util_pck.enter_w||' union all '||pls_util_pck.enter_w;
			end if;
			ds_select_w :=  ds_select_w||' select  1 ie_tipo_pessoa,' ||pls_util_pck.enter_w ||
					'	null	   cd_pessoa_fisica,  '||pls_util_pck.enter_w ||
					'	null	   nm_pessoa_fisica,  '||pls_util_pck.enter_w ||
					'	b.ds_razao_social  ds_razao_social,'||pls_util_pck.enter_w ||
					'	b.ds_nome_abrev nm_abreviado,'||pls_util_pck.enter_w ||
 					'	null	dt_nascimento,'||pls_util_pck.enter_w ||
					'	null	nr_cpf,	'||pls_util_pck.enter_w ||
					'	b.cd_cgc	cd_cgc,	'||pls_util_pck.enter_w ||
					'	null		ds_email_pf, '||pls_util_pck.enter_w ||
					'	pls_obj_plussoft_pck.obter_email_pf_pj(b.cd_cgc, null) ds_email_pj,	'||pls_util_pck.enter_w ||
					'	substr(a.nr_seq_proposta,1,10)	nr_seq_proposta, '||pls_util_pck.enter_w ||
					'	null  cd_pessoa_vendedor,'||pls_util_pck.enter_w ||
 					'	null	cd_usuario_plano, '||pls_util_pck.enter_w ||
					' 	a.nr_sequencia	nr_seq_contrato,'||pls_util_pck.enter_w ||
					'	null	nr_seq_segurado,'||pls_util_pck.enter_w ||
					'	wheb_mensagem_pck.get_texto(1110353) 	ds_tipo_pessoa,'||pls_util_pck.enter_w ||
					'	a.ie_situacao   ie_situacao, '||pls_util_pck.enter_w ||
					'   (select  substr(ds_expressao,1,20) 
						 from 	 valor_dominio_v
						 where  cd_dominio  = 1733
						 and  vl_dominio  = a.ie_situacao) ds_situacao,'||pls_util_pck.enter_w ||
					'	decode(a.cd_cgc_estipulante,null,upper(wheb_mensagem_pck.get_texto(1110353)),''CLIENTE'') ds_status_pessoa,'||pls_util_pck.enter_w ||
 					'	decode(a.cd_cgc_estipulante,null,'''',wheb_mensagem_pck.get_texto(1110354)) ds_tipo_publico,'||pls_util_pck.enter_w ||
					'	null ds_renda  '||pls_util_pck.enter_w ||
					' from	pessoa_juridica b, '||pls_util_pck.enter_w||
					'    	pls_contrato a '||pls_util_pck.enter_w||
					' where	 b.cd_cgc = a.cd_cgc_estipulante(+) '||pls_util_pck.enter_w;
		end if;
end if;

ds_select_w := ds_select_w || ' ) where 1=1 '||pls_util_pck.enter_w;

/*Restricoes do filtro*/

if (cd_pessoa_fisica_p IS NOT NULL AND cd_pessoa_fisica_p::text <> '') then
	ds_restricao_w := ds_restricao_w || ' and cd_pessoa_fisica  = '''||cd_pessoa_fisica_p||''''||pls_util_pck.enter_w;
end if;
if (nr_cpf_p IS NOT NULL AND nr_cpf_p::text <> '') then
	ds_restricao_w := ds_restricao_w || ' and nr_cpf = '''||nr_cpf_p||''''||pls_util_pck.enter_w;
end if;
if (nm_pessoa_fisica_p IS NOT NULL AND nm_pessoa_fisica_p::text <> '') then
	ds_restricao_w := ds_restricao_w || ' and upper(nm_pessoa_fisica) like upper('''||nm_pessoa_fisica_p||''')'||pls_util_pck.enter_w;
end if;
if (ds_email_pf_p IS NOT NULL AND ds_email_pf_p::text <> '') then
	ds_restricao_w := ds_restricao_w || ' and ds_email_pf = '''||ds_email_pf_p ||''''||pls_util_pck.enter_w;
end if;
if (dt_nascimento_p IS NOT NULL AND dt_nascimento_p::text <> '') then
	ds_restricao_w := ds_restricao_w || ' and trunc(to_date(dt_nascimento)) = trunc(to_date('''||dt_nascimento_p||'''))'||pls_util_pck.enter_w;
end if;
if (nm_abreviado_p IS NOT NULL AND nm_abreviado_p::text <> '') then
	ds_restricao_w := ds_restricao_w || ' and upper(nm_abreviado) like upper('''||nm_abreviado_p ||''')'||pls_util_pck.enter_w;
end if;
if (nr_seq_proposta_p IS NOT NULL AND nr_seq_proposta_p::text <> '') then
	ds_restricao_w := ds_restricao_w || ' and nr_seq_proposta = '||nr_seq_proposta_p||pls_util_pck.enter_w;
end if;
if (cd_cgc_p IS NOT NULL AND cd_cgc_p::text <> '') then
	ds_restricao_w := ds_restricao_w || ' and cd_cgc = '''||cd_cgc_p ||''''||pls_util_pck.enter_w;
end if;
if (ds_razao_social_p IS NOT NULL AND ds_razao_social_p::text <> '') then
	ds_restricao_w := ds_restricao_w || ' and upper(ds_razao_social) like upper ('''||ds_razao_social_p ||''')'||pls_util_pck.enter_w;
end if;
if (ds_email_pj_p IS NOT NULL AND ds_email_pj_p::text <> '') then
	ds_restricao_w := ds_restricao_w || ' and ds_email_pj = '''||ds_email_pj_p ||''''||pls_util_pck.enter_w;
end if;
if (cd_pessoa_vendedor_p IS NOT NULL AND cd_pessoa_vendedor_p::text <> '') then
	if (cd_pessoa_vendedor_p <> '0' or upper(ds_status_pessoa_p) <> 'LEAD' ) then
		ds_restricao_w := ds_restricao_w || ' and cd_pessoa_vendedor = '''||cd_pessoa_vendedor_p ||''''||pls_util_pck.enter_w;
	end if;
end if;
/* concatena os selects e as restricoes */

ds_select_fim_w := ds_select_w || ds_restricao_w;

OPEN r_C01_w FOR EXECUTE ds_select_fim_w;

loop

 Fetch r_C01_w into
		linha_w.ie_tipo_pessoa,
		linha_w.cd_pessoa_fisica,
		linha_w.nm_pessoa_fisica,
		linha_w.ds_razao_social,
		linha_w.nm_abreviado,
		linha_w.dt_nascimento,
		linha_w.nr_cpf,
		linha_w.cd_cgc,
		linha_w.ds_email_pf,
		linha_w.ds_email_pj,
		linha_w.nr_seq_proposta,
		linha_w.cd_pessoa_vendedor,
		linha_w.cd_usuario_plano,
		linha_w.nr_seq_contrato,
		linha_w.nr_seq_segurado,
		linha_w.ds_tipo_pessoa,
		linha_w.ie_situacao,
		linha_w.ds_situacao,
		linha_w.ds_status_pessoa,
		linha_w.ds_tipo_publico,
		linha_w.ds_renda;
EXIT WHEN NOT FOUND; /* apply on r_C01_w  */
RETURN NEXT linha_w;
end loop;
--nao retorna nada
return;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pls_obj_plussoft_pck.identifica_pessoa ( ie_tipo_pessoa_p bigint, cd_pessoa_fisica_p pessoa_fisica.cd_pessoa_fisica%type, nr_cpf_p pessoa_fisica.nr_cpf%type, cd_cgc_p pessoa_juridica.cd_cgc%type, nm_pessoa_fisica_p pessoa_fisica.nm_pessoa_fisica%type, ds_razao_social_p pessoa_juridica.ds_razao_social%type, nm_abreviado_p pessoa_fisica.nm_abreviado%type, dt_nascimento_p pessoa_fisica.dt_nascimento%type, nr_seq_proposta_p pls_proposta_adesao.nr_sequencia%type, cd_pessoa_vendedor_p pls_vendedor.cd_pessoa_fisica%type, ds_email_pf_p compl_pessoa_fisica.ds_email%type, ds_email_pj_p pessoa_juridica_estab.ds_email%type, ds_status_pessoa_p text ) FROM PUBLIC;
