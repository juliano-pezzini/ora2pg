-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_obj_plussoft_pck.gerar_lote_mensalidade ( nr_contrato_p INOUT pls_contrato.nr_contrato%type, dt_mesano_referencia_p INOUT pls_lote_mensalidade.dt_mesano_referencia%type, cd_pessoa_usuario_p pessoa_fisica.cd_pessoa_fisica%type, nr_seq_lote_p INOUT pls_lote_mensalidade.nr_sequencia%type, dt_geracao_p INOUT pls_lote_mensalidade.dt_geracao%type, vl_lote_p INOUT pls_lote_mensalidade.vl_lote%type, vl_pre_estabelecido_p INOUT pls_lote_mensalidade.vl_pre_estabelecido%type, ds_status_p INOUT text, ds_mensagem_p INOUT text) AS $body$
DECLARE


current_setting('pls_obj_plussoft_pck.nr_seq_contrato_w')::bigint		pls_contrato.nr_sequencia%type;
current_setting('pls_obj_plussoft_pck.cd_estabelecimento_w')::smallint		pls_contrato.cd_estabelecimento%type;
nr_seq_lote_w			pls_lote_mensalidade.nr_sequencia%type;
dt_geracao_w			pls_lote_mensalidade.dt_geracao%type;
vl_lote_w			pls_lote_mensalidade.vl_lote%type;
vl_pre_estabelecido_w		pls_lote_mensalidade.vl_pre_estabelecido%type;
ds_status_w			varchar(255);
current_setting('pls_obj_plussoft_pck.nm_usuario_w')::usuario.nm_usuario%type			usuario.nm_usuario%type;


BEGIN
--Encontra o usuario
begin
select	max(nm_usuario)
into STRICT	current_setting('pls_obj_plussoft_pck.nm_usuario_w')::usuario.nm_usuario%type
from	usuario
where	cd_pessoa_fisica = cd_pessoa_usuario_p
and	ie_situacao = 'A';
exception
when others then
	PERFORM set_config('pls_obj_plussoft_pck.nm_usuario_w', null, false);
end;

begin
	select 	max(a.nr_sequencia),
		max(a.vl_lote)
	into STRICT	nr_seq_lote_w,
		vl_lote_w
	from	pls_lote_mensalidade a
	where 	a.nr_contrato = nr_contrato_p
	and 	a.ie_status in (1,3)
	and 	a.dt_mesano_referencia = trunc(dt_mesano_referencia_p, 'MM');
exception
when others then
	nr_seq_lote_w 		:= null;
	vl_lote_w		:= null;
end;

if (coalesce(nr_seq_lote_w::text, '') = '') then
	begin
	select	nr_sequencia,
		cd_estabelecimento
	into STRICT	current_setting('pls_obj_plussoft_pck.nr_seq_contrato_w')::bigint,
		current_setting('pls_obj_plussoft_pck.cd_estabelecimento_w')::smallint
	from	pls_contrato
	where	nr_contrato = nr_contrato_p
	and	trunc(dt_aprovacao,'MM')  <= trunc(dt_mesano_referencia_p,'MM');
	exception
	when others then
		PERFORM set_config('pls_obj_plussoft_pck.nr_seq_contrato_w', null, false);
		PERFORM set_config('pls_obj_plussoft_pck.cd_estabelecimento_w', null, false);
	end;

	if (current_setting('pls_obj_plussoft_pck.nr_seq_contrato_w')::(bigint IS NOT NULL AND bigint::text <> '')) then
		begin
		--Rotina utilizada na gestao de contratos para geracao da mensalidade para o contrato
		SELECT * FROM pls_obj_plussoft_pck.gerar_lote_mensalidade_plus(	current_setting('pls_obj_plussoft_pck.nr_seq_contrato_w')::bigint, dt_mesano_referencia_p, current_setting('pls_obj_plussoft_pck.nm_usuario_w')::usuario.nm_usuario%type, current_setting('pls_obj_plussoft_pck.cd_estabelecimento_w')::smallint, 'P', nr_seq_lote_w) INTO STRICT dt_mesano_referencia_p, nr_seq_lote_w;
		select	dt_geracao,
			vl_lote,
			vl_pre_estabelecido,
			substr(obter_valor_dominio(1928, ie_status),1,50)
		into STRICT	dt_geracao_w,
			vl_lote_w,
			vl_pre_estabelecido_w,
			ds_status_w
		from	pls_lote_mensalidade
		where	nr_sequencia = nr_seq_lote_w;
		
		nr_seq_lote_p		:= nr_seq_lote_w;
		dt_geracao_p		:= dt_geracao_w;
		vl_lote_p		:= vl_lote_w;
		vl_pre_estabelecido_p	:= vl_pre_estabelecido_w;
		ds_status_p		:= ds_status_w;
		
		exception
		when others then
			null;
		end;
	end if;
else
	nr_seq_lote_p 	:= nr_seq_lote_w;
	vl_lote_p	:= vl_lote_w;
	ds_mensagem_p 	:= wheb_mensagem_pck.get_texto(1110476);
end if;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_obj_plussoft_pck.gerar_lote_mensalidade ( nr_contrato_p INOUT pls_contrato.nr_contrato%type, dt_mesano_referencia_p INOUT pls_lote_mensalidade.dt_mesano_referencia%type, cd_pessoa_usuario_p pessoa_fisica.cd_pessoa_fisica%type, nr_seq_lote_p INOUT pls_lote_mensalidade.nr_sequencia%type, dt_geracao_p INOUT pls_lote_mensalidade.dt_geracao%type, vl_lote_p INOUT pls_lote_mensalidade.vl_lote%type, vl_pre_estabelecido_p INOUT pls_lote_mensalidade.vl_pre_estabelecido%type, ds_status_p INOUT text, ds_mensagem_p INOUT text) FROM PUBLIC;
