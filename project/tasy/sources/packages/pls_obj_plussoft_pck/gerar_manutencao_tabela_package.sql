-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_obj_plussoft_pck.gerar_manutencao_tabela ( nr_seq_proposta_p bigint, nr_seq_tabela_p bigint, tx_acrescimo_p bigint, tx_desconto_p bigint, nr_seq_motivo_p bigint, cd_pessoa_usuario_p pessoa_fisica.cd_pessoa_fisica%type, cd_estabelecimento_p bigint, ie_status_retorno_p INOUT bigint, ds_mensagem_erro_p INOUT text) AS $body$
DECLARE


nr_seq_tabela_nova_w 	pls_tabela_preco.nr_sequencia%type;
current_setting('pls_obj_plussoft_pck.ds_erro_w')::varchar(255)		varchar(255);
current_setting('pls_obj_plussoft_pck.nm_usuario_w')::usuario.nm_usuario%type		pessoa_fisica.nm_usuario%type;
vl_parametro_w		varchar(10);
vl_max_tabela_w		bigint;

current_setting('pls_obj_plussoft_pck.c01')::CURSOR CURSOR FOR
	SELECT	nr_sequencia nr_seq_preco
	from 	pls_plano_preco
	where 	nr_seq_tabela = nr_seq_tabela_nova_w;

BEGIN
ie_status_retorno_p := 0;

--Encontra o usuario
begin
select	max(nm_usuario)
into STRICT	current_setting('pls_obj_plussoft_pck.nm_usuario_w')::usuario.nm_usuario%type
from	usuario
where	cd_pessoa_fisica = cd_pessoa_usuario_p
and	ie_situacao = 'A';
exception
when others then
	PERFORM set_config('pls_obj_plussoft_pck.nm_usuario_w', null, false);
end;

Obter_Param_Usuario(1315, 3, obter_perfil_ativo, current_setting('pls_obj_plussoft_pck.nm_usuario_w')::usuario.nm_usuario%type, wheb_usuario_pck.get_cd_estabelecimento, vl_parametro_w);

if (vl_parametro_w IS NOT NULL AND vl_parametro_w::text <> '') then
	if (vl_parametro_w < tx_desconto_p) then
		ie_status_retorno_p 	:= 1;
		ds_mensagem_erro_p	:= wheb_mensagem_pck.get_texto(1110541);
	end if;
else
	select 	coalesce(pls_obter_max_desconto_tabela(nr_seq_tabela_p, current_setting('pls_obj_plussoft_pck.nm_usuario_w')::usuario.nm_usuario%type, null),0)
	into STRICT	vl_max_tabela_w
	;
	
	if (vl_max_tabela_w > 0) then
		if (vl_max_tabela_w < tx_desconto_p) then
			begin
			ie_status_retorno_p 	:= 1;
			ds_mensagem_erro_p	:= wheb_mensagem_pck.get_texto(524101);
			end;
		end if;
        end if;
end if;


if (nr_seq_proposta_p IS NOT NULL AND nr_seq_proposta_p::text <> '') and (nr_seq_tabela_p IS NOT NULL AND nr_seq_tabela_p::text <> '') and (ie_status_retorno_p = 0) then
	begin
	pls_gerar_tabela_manutencao(nr_seq_proposta_p,nr_seq_tabela_p,current_setting('pls_obj_plussoft_pck.nm_usuario_w')::usuario.nm_usuario%type,cd_estabelecimento_p,nr_seq_tabela_nova_w);
	exception
	when others then
		nr_seq_tabela_nova_w 	:= null;
		ie_status_retorno_p 	:= 1;
		ds_mensagem_erro_p	:= wheb_mensagem_pck.get_texto(1110545);
	end;
	
	if (ie_status_retorno_p = 0) then
		for r_C01_w in current_setting('pls_obj_plussoft_pck.c01')::loop CURSOR
			pls_realizar_manutencao_preco(r_C01_w.nr_seq_preco,tx_acrescimo_p,tx_desconto_p,'S',nr_seq_motivo_p,current_setting('pls_obj_plussoft_pck.nm_usuario_w')::usuario.nm_usuario%type,cd_estabelecimento_p,current_setting('pls_obj_plussoft_pck.ds_erro_w')::varchar(255));
		end loop;
		
		if (current_setting('pls_obj_plussoft_pck.ds_erro_w')::coalesce(varchar(255)::text, '') = '') then
			CALL pls_atualiza_vl_tot_proposta(nr_seq_proposta_p,'S');
		else
			ie_status_retorno_p 	:= 1;
			ds_mensagem_erro_p	:= wheb_mensagem_pck.get_texto(1110546) || ' ' ||current_setting('pls_obj_plussoft_pck.ds_erro_w')::varchar(255);
		end if;
	end if;
end if;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_obj_plussoft_pck.gerar_manutencao_tabela ( nr_seq_proposta_p bigint, nr_seq_tabela_p bigint, tx_acrescimo_p bigint, tx_desconto_p bigint, nr_seq_motivo_p bigint, cd_pessoa_usuario_p pessoa_fisica.cd_pessoa_fisica%type, cd_estabelecimento_p bigint, ie_status_retorno_p INOUT bigint, ds_mensagem_erro_p INOUT text) FROM PUBLIC;
