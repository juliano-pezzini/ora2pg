-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_obj_plussoft_pck.pls_gerar_arquivo_interface ( nr_seq_lote_p pls_lote_carteira.nr_sequencia%type, nm_arquivo_p text, cd_interface_p bigint, ds_local_p INOUT text) AS $body$
DECLARE


arq_texto_w			utl_file.file_type;
current_setting('pls_obj_plussoft_pck.ds_erro_w')::varchar(255)			varchar(255);
ds_conteudo_w			varchar(4000);
nm_atributo_w 			interface_atributo.nm_atributo%type;
qt_tamanho_w			interface_atributo.qt_tamanho%type;
ie_tipo_atributo_w		interface_atributo.ie_tipo_atributo%type;
ds_campos_w			varchar(4000);
ds_sql_w			varchar(4000);
bind_sql_valor_w		sql_pck.t_dado_bind;
bind_sql_valor2_w		sql_pck.t_dado_bind;
cursor_w			sql_pck.t_cursor;
cursor2_w			sql_pck.t_cursor;
ds_registro_w			varchar(4000);
ds_local_w			evento_tasy_utl_file.ds_local%type;
ds_local_windows_w		evento_tasy_utl_file.ds_local_rede%type;

current_setting('pls_obj_plussoft_pck.c01')::CURSOR CURSOR FOR
	SELECT	nm_atributo,
		qt_tamanho,
		ie_tipo_atributo
	from 	interface_atributo
	where 	cd_interface = cd_interface_p
	and	cd_reg_interface = 1
	and 	qt_tamanho > 0 
	and	nm_atributo <> 'IE_TIPO_REG'
	order by nr_seq_atributo;

current_setting('pls_obj_plussoft_pck.c02')::CURSOR CURSOR FOR
	SELECT	nm_atributo,
		qt_tamanho,
		ie_tipo_atributo
	from 	interface_atributo
	where 	cd_interface = cd_interface_p
	and	cd_reg_interface = 2
	and 	qt_tamanho > 0 
	and	nm_atributo <> 'IE_TIPO_REG'
	order by nr_seq_atributo;

BEGIN
begin
select	max(ds_local),
	max(ds_local_rede)
into STRICT	ds_local_w,
	ds_local_windows_w
from	evento_tasy_utl_file
where	cd_evento	= 23;

arq_texto_w := utl_file.fopen(ds_local_w,nm_arquivo_p,'W', 4000);
exception
when others then
	if (SQLSTATE = -29289) then
		PERFORM set_config('pls_obj_plussoft_pck.ds_erro_w', wheb_mensagem_pck.get_texto(1110524), false);
	elsif (SQLSTATE = -29298) then
		PERFORM set_config('pls_obj_plussoft_pck.ds_erro_w', wheb_mensagem_pck.get_texto(1110526), false);
	elsif (SQLSTATE = -29291) then
		PERFORM set_config('pls_obj_plussoft_pck.ds_erro_w', wheb_mensagem_pck.get_texto(1110527), false);
	elsif (SQLSTATE = -29286) then
		PERFORM set_config('pls_obj_plussoft_pck.ds_erro_w', wheb_mensagem_pck.get_texto(1110528), false);
	elsif (SQLSTATE = -29282) then
		PERFORM set_config('pls_obj_plussoft_pck.ds_erro_w', wheb_mensagem_pck.get_texto(1110529), false);
	elsif (SQLSTATE = -29288) then
		PERFORM set_config('pls_obj_plussoft_pck.ds_erro_w', wheb_mensagem_pck.get_texto(1110530), false);
	elsif (SQLSTATE = -29287) then
		PERFORM set_config('pls_obj_plussoft_pck.ds_erro_w', wheb_mensagem_pck.get_texto(1110531), false);
	elsif (SQLSTATE = -29281) then
		PERFORM set_config('pls_obj_plussoft_pck.ds_erro_w', wheb_mensagem_pck.get_texto(1110532), false);
	elsif (SQLSTATE = -29290) then
		PERFORM set_config('pls_obj_plussoft_pck.ds_erro_w', wheb_mensagem_pck.get_texto(1110533), false);
	elsif (SQLSTATE = -29283) then
		PERFORM set_config('pls_obj_plussoft_pck.ds_erro_w', wheb_mensagem_pck.get_texto(1110534), false);
	elsif (SQLSTATE = -29280) then
		PERFORM set_config('pls_obj_plussoft_pck.ds_erro_w', wheb_mensagem_pck.get_texto(1110535), false);
	elsif (SQLSTATE = -29284) then
		PERFORM set_config('pls_obj_plussoft_pck.ds_erro_w', wheb_mensagem_pck.get_texto(1110537), false);
	elsif (SQLSTATE = -29292) then
		PERFORM set_config('pls_obj_plussoft_pck.ds_erro_w', wheb_mensagem_pck.get_texto(1110538), false);
	elsif (SQLSTATE = -29285) then
		PERFORM set_config('pls_obj_plussoft_pck.ds_erro_w', wheb_mensagem_pck.get_texto(1110539), false);
	else
		PERFORM set_config('pls_obj_plussoft_pck.ds_erro_w', wheb_mensagem_pck.get_texto(1110540), false);
	end if;
end;
if (current_setting('pls_obj_plussoft_pck.ds_erro_w')::(varchar(255) IS NOT NULL AND (varchar(255))::text <> '')) then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(current_setting('pls_obj_plussoft_pck.ds_erro_w')::varchar(255) );
end if;

begin
	open current_setting('pls_obj_plussoft_pck.c01')::CURSOR;
	loop
	fetch current_setting('pls_obj_plussoft_pck.c01')::into CURSOR
		nm_atributo_w,
		qt_tamanho_w,
		ie_tipo_atributo_w;
	EXIT WHEN NOT FOUND; /* apply on current_setting('pls_obj_plussoft_pck.c01')::CURSOR */
		begin
		if (qt_tamanho_w > 3999) then
			qt_tamanho_w:= 3999;
		end if;
		
		if (ie_tipo_atributo_w = 'NUMBER') then
			ds_campos_w := ds_campos_w ||' lpad('||nm_atributo_w||','||qt_tamanho_w||',0)||'';''||';
		else
			ds_campos_w := ds_campos_w ||' rpad('||nm_atributo_w||','||qt_tamanho_w||')||'';''||';
		end if;
		end;
	end loop;
	close current_setting('pls_obj_plussoft_pck.c01')::CURSOR;
	
	ds_campos_w 	:= substr(ds_campos_w,0,length(ds_campos_w)-2);
	ds_sql_w	:= 'Select ' || ds_campos_w || ' from w_pls_interface_carteira where nr_seq_lote = '||nr_seq_lote_p||' and ie_tipo_reg = 1';
	bind_sql_valor_w := sql_pck.executa_sql_cursor(ds_sql_w, bind_sql_valor_w);
	loop
		fetch 	cursor_w
		into	ds_registro_w;
		EXIT WHEN NOT FOUND; /* apply on cursor_w */
			utl_file.put_line(arq_texto_w,substr(ds_registro_w,1,3999));
			utl_file.fflush(arq_texto_w);
	end loop;
	close cursor_w;
	
	ds_campos_w 	:= '';
	ds_sql_w	:= '';
	
	open current_setting('pls_obj_plussoft_pck.c02')::CURSOR;
	loop
	fetch current_setting('pls_obj_plussoft_pck.c02')::into CURSOR
		nm_atributo_w,
		qt_tamanho_w,
		ie_tipo_atributo_w;
	EXIT WHEN NOT FOUND; /* apply on current_setting('pls_obj_plussoft_pck.c02')::CURSOR */
		begin
		if (qt_tamanho_w > 3999) then
			qt_tamanho_w:= 3999;
		end if;
		
		if (ie_tipo_atributo_w = 'NUMBER') then
			ds_campos_w := ds_campos_w ||' lpad('||nm_atributo_w||','||qt_tamanho_w||',0)||'';''||';
		else
			ds_campos_w := ds_campos_w ||' rpad('||nm_atributo_w||','||qt_tamanho_w||')||'';''||';
		end if;
		end;
	end loop;
	close current_setting('pls_obj_plussoft_pck.c02')::CURSOR;
	
	ds_campos_w 	:= substr(ds_campos_w,0,length(ds_campos_w)-2);
	ds_sql_w	:= 'Select '||ds_campos_w||' from w_pls_interface_carteira where nr_seq_lote = '||nr_seq_lote_p||' and ie_tipo_reg = 2';
	bind_sql_valor2_w := sql_pck.executa_sql_cursor(ds_sql_w, bind_sql_valor2_w);
	loop
		fetch 	cursor2_w
		into	ds_registro_w;
		EXIT WHEN NOT FOUND; /* apply on cursor2_w */
			utl_file.put_line(arq_texto_w,substr(ds_registro_w,1,3999));
			utl_file.fflush(arq_texto_w);
	end loop;
	close cursor2_w;

exception
	when others then
		if (cursor_w%isopen) then
			close cursor_w;
		end if;
		if (cursor2_w%isopen) then
			close cursor2_w;
		end if;
		CALL wheb_mensagem_pck.exibir_mensagem_abort(sqlerrm(SQLSTATE));
end;

utl_file.fclose(arq_texto_w);
ds_local_p := ds_local_w||nm_arquivo_p;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_obj_plussoft_pck.pls_gerar_arquivo_interface ( nr_seq_lote_p pls_lote_carteira.nr_sequencia%type, nm_arquivo_p text, cd_interface_p bigint, ds_local_p INOUT text) FROM PUBLIC;
