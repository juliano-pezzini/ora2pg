-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION panorama_main_filter_2.fn_grid_panorama_clinico_v3 ( CD_ESTABELECIMENTO_P bigint, CD_DEPARTAMENTO_P bigint, CD_SETOR_ATENDIMENTO_P bigint, CD_SINGLE_PATIENT_P text, IE_SCORE_P text, IE_PACIENTE_PAN_P text, IE_STATUS_LEITO_P text, IE_MEUS_PACIENTES_P text, IE_TODOS_SETORES_P text, IE_CONTROLA_ALTA_P text, IE_AGRUPAMENTO_P text, IE_AGRUP_LEITOS_P text, IE_ACOMP_BED_P text, IE_CHAMADA_PERDIDA_P text, IE_PACIENTE_VENT_P text, IE_DEPARTAMENTO_MEDICO_P text, IE_PENDENCIA_ADEP_P text, IE_BOTTOM_PANEL_P text, IE_FOLLOW_UP_P text, IE_NEW_PATIENT_P text ) RETURNS SETOF TABLE_PANORAMA_V3_OBJ AS $body$
DECLARE

     table_aux table_panorama_v3;
     cr_panorama CURSOR FOR
          SELECT cd_setor_atendimento,
                 ds_setor_atendimento,
                 cd_unidade_basica,
                 ds_unidade_atend,
                 nr_seq_interno,
                 ie_status_unidade,
                 cd_unidade_compl,
                 ds_estabelecimento
            from (SELECT distinct sa.cd_setor_atendimento cd_setor_atendimento,
                                  obter_desc_expressao(1064128) ds_setor_atendimento, --My WatchList
                                  ua.cd_unidade_basica,
                                  ua.ds_unidade_atend,
                                  ua.nr_seq_interno,
                                  ua.ie_status_unidade,
                                  ua.cd_unidade_compl,
                                  OBTER_NOME_ESTABELECIMENTO(sa.cd_estabelecimento) ds_estabelecimento,
                                  1 ordem
                    from panorama_acomp_watchlist paw
                   inner join panorama_watchlist pw on (paw.watchlist_id = pw.nr_sequencia)
                   inner join atendimento_paciente ap on (ap.cd_pessoa_fisica = paw.cd_pessoa_fisica)
                   inner join setor_atendimento sa on (obter_setor_atual_paciente(ap.nr_atendimento) = sa.cd_setor_atendimento and sa.ie_situacao = 'A')
                   inner join unidade_atendimento ua on (ap.nr_atendimento = ua.nr_atendimento and sa.cd_setor_atendimento = ua.cd_setor_atendimento)
                    left join departamento_setor ds on (ds.cd_setor_atendimento = sa.cd_setor_atendimento)
                    left join departamento_medico dm on dm.cd_departamento = ds.cd_departamento
                   where (sa.cd_setor_atendimento = coalesce(cd_setor_atendimento_p, sa.cd_setor_atendimento) or ie_todos_setores_P = 'S')
                     and sa.cd_estabelecimento = coalesce(cd_estabelecimento_p, sa.cd_estabelecimento)
                     and pw.nm_usuario = wheb_usuario_pck.get_nm_usuario
                     and ua.ie_status_unidade = coalesce(ie_status_leito_p, ua.ie_status_unidade)
                     and (coalesce(cd_single_patient_p::text, '') = '' or exists (select 1
                             from atendimento_paciente ap
                            where ap.nr_atendimento = ua.nr_atendimento
                              and ap.cd_pessoa_fisica = cd_single_patient_p))
                     and (ie_chamada_perdida_p = 'N' or ((ua.nr_atendimento IS NOT NULL AND ua.nr_atendimento::text <> '') and exists (select 1
                              from video_server_notification vsn
                             where vsn.cd_setor_atendimento = ua.cd_setor_atendimento
                               and vsn.cd_unidade_basica = ua.cd_unidade_basica
                               and vsn.cd_unidade_compl = ua.cd_unidade_compl
                               and coalesce(vsn.dt_video_assessment::text, '') = ''
                               and (clock_timestamp() - cast(vsn.dt_notification as timestamp)) <=
                                   1 / 3)))
                     AND ((coalesce(ie_pendencia_adep_p, 'N') = 'N') OR
                         ((SELECT MAX(d.ie_pendencia_adep)
                              FROM w_pan_paciente d
                             WHERE d.ie_concluido = 'S'
                               AND d.nr_seq_interno = ua.nr_seq_interno) = 'S'))
                     and ((coalesce(ie_departamento_medico_p, 'N') = 'N') OR (patient_belong_departament(ua.nr_seq_interno,
                                                      cd_departamento_P) = 'S'))
                     AND (coalesce(ie_new_patient_p, 'N') = 'N' OR exists (select 1
                             FROM atendimento_paciente ap
                            WHERE ap.nr_atendimento = ua.nr_atendimento
                              and obter_se_paciente_novo_pan(ap.nr_atendimento,
                                                             sa.cd_setor_atendimento) = 'S'))
                     and panorama_main_filter_2.get_piora_clinica(ap.nr_atendimento) = 'N'
                  --
                  
union

                  --
                  select distinct sa.cd_setor_atendimento cd_setor_atendimento,
                                  obter_desc_expressao(283347) ds_setor_atendimento, --Warning
                                  ua.cd_unidade_basica,
                                  ua.ds_unidade_atend,
                                  ua.nr_seq_interno,
                                  ua.ie_status_unidade,
                                  ua.cd_unidade_compl,
                                  OBTER_NOME_ESTABELECIMENTO(sa.cd_estabelecimento) ds_estabelecimento,
                                  2 ordem
                    from panorama_acomp_watchlist paw
                   inner join panorama_watchlist pw on (paw.watchlist_id = pw.nr_sequencia)
                   inner join atendimento_paciente ap on (ap.cd_pessoa_fisica = paw.cd_pessoa_fisica)
                   inner join setor_atendimento sa on (obter_setor_atual_paciente(ap.nr_atendimento) = sa.cd_setor_atendimento and sa.ie_situacao = 'A')
                   inner join unidade_atendimento ua on (ap.nr_atendimento = ua.nr_atendimento and sa.cd_setor_atendimento = ua.cd_setor_atendimento)
                    left join departamento_setor ds on (ds.cd_setor_atendimento = sa.cd_setor_atendimento)
                    left join departamento_medico dm on dm.cd_departamento = ds.cd_departamento
                   where (sa.cd_setor_atendimento = coalesce(cd_setor_atendimento_p, sa.cd_setor_atendimento) or ie_todos_setores_P = 'S')
                     and sa.cd_estabelecimento = coalesce(cd_estabelecimento_p, sa.cd_estabelecimento)
                     and pw.nm_usuario = wheb_usuario_pck.get_nm_usuario
                     and ua.ie_status_unidade = coalesce(ie_status_leito_p, ua.ie_status_unidade)
					 and (coalesce(ie_score_p::text, '') = '' or (PHILIPS_JSON(search_panorama_content.get_pontuacao_acuidade(ua.cd_setor_atendimento,ua.nr_atendimento)).Get['ESCALA_ACUIDADE'].GET_STRING() = ie_score_p))
                     and (coalesce(cd_single_patient_p::text, '') = '' or exists (select 1
                             from atendimento_paciente ap
                            where ap.nr_atendimento = ua.nr_atendimento
                              and ap.cd_pessoa_fisica = cd_single_patient_p))
                     and (ie_chamada_perdida_p = 'N' or ((ua.nr_atendimento IS NOT NULL AND ua.nr_atendimento::text <> '') and exists (select 1
                              from video_server_notification vsn
                             where vsn.cd_setor_atendimento = ua.cd_setor_atendimento
                               and vsn.cd_unidade_basica = ua.cd_unidade_basica
                               and vsn.cd_unidade_compl = ua.cd_unidade_compl
                               and coalesce(vsn.dt_video_assessment::text, '') = ''
                               and (clock_timestamp() - cast(vsn.dt_notification as timestamp)) <=
                                   1 / 3)))
                     AND ((coalesce(ie_pendencia_adep_p, 'N') = 'N') OR
                         ((SELECT MAX(d.ie_pendencia_adep)
                              FROM w_pan_paciente d
                             WHERE d.ie_concluido = 'S'
                               AND d.nr_seq_interno = ua.nr_seq_interno) = 'S'))
                     and ((coalesce(ie_departamento_medico_p, 'N') = 'N') OR (patient_belong_departament(ua.nr_seq_interno,
                                                      cd_departamento_P) = 'S'))
                     AND (coalesce(ie_new_patient_p, 'N') = 'N' OR exists (select 1
                             FROM atendimento_paciente ap
                            WHERE ap.nr_atendimento = ua.nr_atendimento
                              and obter_se_paciente_novo_pan(ap.nr_atendimento,
                                                             sa.cd_setor_atendimento) = 'S'))
                     and panorama_main_filter_2.get_piora_clinica(ap.nr_atendimento) = 'S'
                  --
                  
union

                  --
                  select distinct sa.cd_setor_atendimento cd_setor_atendimento,
                                  obter_desc_expressao(672223) ds_setor_atendimento,-- New Patients
                                  ua.cd_unidade_basica,
                                  ua.ds_unidade_atend,
                                  ua.nr_seq_interno,
                                  ua.ie_status_unidade,
                                  ua.cd_unidade_compl,
                                  OBTER_NOME_ESTABELECIMENTO(sa.cd_estabelecimento) ds_estabelecimento,
                                  3 ordem
                    from atendimento_paciente ap
                   inner join setor_atendimento sa on (obter_setor_atual_paciente(ap.nr_atendimento) = sa.cd_setor_atendimento and sa.ie_situacao = 'A')
                   inner join unidade_atendimento ua on (ap.nr_atendimento = ua.nr_atendimento and sa.cd_setor_atendimento = ua.cd_setor_atendimento)
                    left join departamento_setor ds on (ds.cd_setor_atendimento = sa.cd_setor_atendimento)
                    left join departamento_medico dm on dm.cd_departamento = ds.cd_departamento
                   where ap.cd_pessoa_fisica not in (select pw.cd_pessoa_fisica
                            from panorama_watchlist pw
                           where pw.nm_usuario = wheb_usuario_pck.get_nm_usuario)
                     and (sa.cd_setor_atendimento = coalesce(cd_setor_atendimento_p, sa.cd_setor_atendimento) or ie_todos_setores_P = 'S')
                     and sa.cd_estabelecimento = coalesce(cd_estabelecimento_p, sa.cd_estabelecimento)
                     and ua.ie_status_unidade = coalesce(ie_status_leito_p, ua.ie_status_unidade)
                     and (obter_se_paciente_novo_pan(ap.nr_atendimento, sa.cd_setor_atendimento) = 'S' OR
                         panorama_main_filter_2.get_piora_clinica(ap.nr_atendimento) = 'S')
                     and (coalesce(cd_single_patient_p::text, '') = '' or exists (select 1
                             from atendimento_paciente ap
                            where ap.nr_atendimento = ua.nr_atendimento
                              and ap.cd_pessoa_fisica = cd_single_patient_p))
                     and (ie_chamada_perdida_p = 'N' or ((ua.nr_atendimento IS NOT NULL AND ua.nr_atendimento::text <> '') and exists (select 1
                              from video_server_notification vsn
                             where vsn.cd_setor_atendimento = ua.cd_setor_atendimento
                               and vsn.cd_unidade_basica = ua.cd_unidade_basica
                               and vsn.cd_unidade_compl = ua.cd_unidade_compl
                               and coalesce(vsn.dt_video_assessment::text, '') = ''
                               and (clock_timestamp() - cast(vsn.dt_notification as timestamp)) <=
                                   1 / 3)))
                     AND ((coalesce(ie_pendencia_adep_p, 'N') = 'N') OR
                         ((SELECT MAX(d.ie_pendencia_adep)
                              FROM w_pan_paciente d
                             WHERE d.ie_concluido = 'S'
                               AND d.nr_seq_interno = ua.nr_seq_interno) = 'S'))
                     and ((coalesce(ie_departamento_medico_p, 'N') = 'N') OR (patient_belong_departament(ua.nr_seq_interno,
                                                      cd_departamento_P) = 'S'))
                     AND (coalesce(ie_new_patient_p, 'N') = 'N' OR exists (select 1
                             FROM atendimento_paciente ap
                            WHERE ap.nr_atendimento = ua.nr_atendimento
                              and obter_se_paciente_novo_pan(ap.nr_atendimento,
                                                             sa.cd_setor_atendimento) = 'S'))) temp
           order by ordem, 
                    ds_setor_atendimento asc,
                    CASE WHEN ie_status_unidade='P' THEN  1 WHEN ie_status_unidade='L' THEN  2 WHEN ie_status_unidade='A' THEN  3 WHEN ie_status_unidade='M' THEN  4 END ,
                    cd_unidade_basica,
                    cd_unidade_compl;


BEGIN
     FOR cr IN cr_panorama LOOP
        table_aux.cd_setor_atendimento := cr.cd_setor_atendimento;
        table_aux.ds_setor_atendimento := cr.ds_setor_atendimento;
        table_aux.cd_unidade_basica    := cr.cd_unidade_basica;
        table_aux.ds_unidade_atend     := cr.ds_unidade_atend;
        table_aux.nr_seq_interno       := cr.nr_seq_interno;
        table_aux.ie_status_unidade    := cr.ie_status_unidade;
        table_aux.cd_unidade_compl     := cr.cd_unidade_compl;
        table_aux.ds_estabelecimento   := cr.ds_estabelecimento;
        RETURN NEXT table_aux;
     END LOOP;
     return;
  END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION panorama_main_filter_2.fn_grid_panorama_clinico_v3 ( CD_ESTABELECIMENTO_P bigint, CD_DEPARTAMENTO_P bigint, CD_SETOR_ATENDIMENTO_P bigint, CD_SINGLE_PATIENT_P text, IE_SCORE_P text, IE_PACIENTE_PAN_P text, IE_STATUS_LEITO_P text, IE_MEUS_PACIENTES_P text, IE_TODOS_SETORES_P text, IE_CONTROLA_ALTA_P text, IE_AGRUPAMENTO_P text, IE_AGRUP_LEITOS_P text, IE_ACOMP_BED_P text, IE_CHAMADA_PERDIDA_P text, IE_PACIENTE_VENT_P text, IE_DEPARTAMENTO_MEDICO_P text, IE_PENDENCIA_ADEP_P text, IE_BOTTOM_PANEL_P text, IE_FOLLOW_UP_P text, IE_NEW_PATIENT_P text ) FROM PUBLIC;
