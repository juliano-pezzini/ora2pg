-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION panorama_main_filter_2.get_piora_clinica (nr_atendimento_p automated_acuity.nr_atendimento%type) RETURNS varchar AS $body$
DECLARE


     piora_w            varchar(1) := 'N';
     nr_delta_ant_w     bigint;
     nr_delta_atu_w     bigint;
     nr_pontuacao_ant_w bigint;
     nr_pontuacao_atu_w bigint;

BEGIN

     begin
        -- Primeiro Nr_delta e nr_pontuacao ultimas 24 horas do automated_acuity
        select a.nr_delta, a.nr_pontuacao
          into STRICT nr_delta_ant_w, nr_pontuacao_ant_w
          from automated_acuity a
         where a.nr_sequencia =
               (SELECT min(aa.nr_sequencia)
                  from automated_acuity aa
                 where aa.nr_atendimento = nr_atendimento_p
                   and aa.dt_pontuacao > clock_timestamp() - interval '1 days'
                   and (aa.nr_delta IS NOT NULL AND aa.nr_delta::text <> '')
                   and (aa.nr_pontuacao IS NOT NULL AND aa.nr_pontuacao::text <> ''));

        -- Ultimo Nr_delta e nr_pontuacao ultimas 24 horas do automated_acuity
        select a.nr_delta, a.nr_pontuacao
          into STRICT nr_delta_atu_w, nr_pontuacao_atu_w
          from automated_acuity a
         where a.nr_sequencia =
               (SELECT max(aa.nr_sequencia)
                  from automated_acuity aa
                 where aa.nr_atendimento = nr_atendimento_p
                   and aa.dt_pontuacao > clock_timestamp() - interval '1 days'
                   and (aa.nr_delta IS NOT NULL AND aa.nr_delta::text <> '')
                   and (aa.nr_pontuacao IS NOT NULL AND aa.nr_pontuacao::text <> ''));

        -- diferenca
        if ((nr_delta_atu_w - nr_delta_ant_w >= 1) or (nr_pontuacao_atu_w - nr_pontuacao_ant_w >= 1)) then
           piora_w := 'S';
        end if;

     exception
        when no_data_found then
           null;
     end;

     if (piora_w = 'N') then
        begin
           -- Primeiro Nr_delta e nr_pontuacao ultimas 24 horas do early_warning
           select a.nr_delta, a.nr_pontuacao
             into STRICT nr_delta_ant_w, nr_pontuacao_ant_w
             from early_warning a
            where a.nr_sequencia =
                  (SELECT min(aa.nr_sequencia)
                     from early_warning aa
                    where aa.nr_atendimento = nr_atendimento_p
                      and aa.dt_pontuacao > clock_timestamp() - interval '1 days'
                      and (aa.nr_delta IS NOT NULL AND aa.nr_delta::text <> '')
                      and (aa.nr_pontuacao IS NOT NULL AND aa.nr_pontuacao::text <> ''));

           -- Ultimo Nr_delta e nr_pontuacao ultimas 24 horas do early_warning
           select a.nr_delta, a.nr_pontuacao
             into STRICT nr_delta_atu_w, nr_pontuacao_atu_w
             from early_warning a
            where a.nr_sequencia =
                  (SELECT max(aa.nr_sequencia)
                     from early_warning aa
                    where aa.nr_atendimento = nr_atendimento_p
                      and aa.dt_pontuacao > clock_timestamp() - interval '1 days'
                      and (aa.nr_delta IS NOT NULL AND aa.nr_delta::text <> '')
                      and (aa.nr_pontuacao IS NOT NULL AND aa.nr_pontuacao::text <> ''));

           -- diferenca
           if ((nr_delta_atu_w - nr_delta_ant_w >= 1) or (nr_pontuacao_atu_w - nr_pontuacao_ant_w >= 1)) then
              piora_w := 'S';
           end if;

        exception
           when no_data_found then
              null;
        end;
     end if;

     return(piora_w);

  END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION panorama_main_filter_2.get_piora_clinica (nr_atendimento_p automated_acuity.nr_atendimento%type) FROM PUBLIC;
