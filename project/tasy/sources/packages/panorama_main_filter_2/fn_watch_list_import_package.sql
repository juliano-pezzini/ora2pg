-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION panorama_main_filter_2.fn_watch_list_import (CD_ESTABELECIMENTO_P bigint, CD_DEPARTAMENTO_P bigint, CD_MEDICO_P bigint, CD_PACIENTE_P bigint, IE_SCORE_P text ) RETURNS SETOF TABLE_IMPORT_WATCHLIST_OBJ AS $body$
DECLARE

  table_aux TABLE_IMPORT_WATCHLIST;
  cr_panorama CURSOR FOR
        SELECT DISTINCT
                           obter_nome_medico(ap.cd_medico_atendimento, 'N') nm_medico,
                           obter_nome_medico(paw.cd_profissional, 'N') nm_medico_ori,
                           obter_nome_pessoa_fisica(paw.cd_pessoa_fisica, NULL) nm_paciente,
                           obter_nome_departamento_medico(dm.cd_departamento) ds_departamento,
                           search_panorama_content.get_pontuacao_acuidade(sa.cd_setor_atendimento,ap.nr_atendimento) nr_pontuacao,
                           ua.cd_unidade_basica ||' '|| ua.cd_unidade_compl ds_unidade_atend,
                           paw.nr_sequencia
           FROM panorama_acomp_watchlist paw
           INNER JOIN panorama_watchlist pw on (paw.watchlist_id = pw.nr_sequencia)
           INNER JOIN atendimento_paciente ap on (ap.cd_pessoa_fisica = paw.cd_pessoa_fisica and paw.watchlist_id = ap.nr_atendimento)
           INNER JOIN setor_atendimento sa on (obter_setor_atual_paciente(ap.nr_atendimento) = sa.cd_setor_atendimento
                                              AND sa.ie_situacao = 'A')
           INNER JOIN unidade_atendimento ua on (ap.nr_atendimento = ua.nr_atendimento
                                                AND sa.cd_setor_atendimento = ua.cd_setor_atendimento)
           LEFT JOIN departamento_setor ds ON (ds.cd_setor_atendimento = sa.cd_setor_atendimento)
           LEFT JOIN departamento_medico dm ON dm.cd_departamento = obter_departamento_atual_atend(ap.nr_atendimento)
           WHERE sa.cd_estabelecimento = coalesce(cd_estabelecimento_p, sa.cd_estabelecimento)
             AND NOT EXISTS (SELECT 1 FROM panorama_watchlist my_wl where my_wl.NM_USUARIO = wheb_usuario_pck.get_nm_usuario AND my_wl.NR_SEQUENCIA = pw.NR_SEQUENCIA AND my_wl.CD_PESSOA_FISICA = pw.CD_PESSOA_FISICA)
             AND (coalesce(cd_paciente_p::text, '') = ''
                  OR EXISTS (SELECT 1
                     FROM atendimento_paciente ap
                     WHERE ap.nr_atendimento = ua.nr_atendimento
                       AND ap.cd_pessoa_fisica = cd_paciente_p))
             AND (coalesce(cd_medico_p::text, '') = ''
                  OR EXISTS (SELECT 1
                     FROM atendimento_paciente ap
                     WHERE ap.nr_atendimento = ua.nr_atendimento
                       AND ap.cd_medico_atendimento = cd_medico_p))
             AND ((coalesce(cd_departamento_P::text, '') = '')
                  OR (patient_belong_departament(ua.nr_seq_interno, cd_departamento_P) = 'S'))
             AND ((coalesce(ie_score_p::text, '') = '') OR (search_panorama_content.get_pontuacao_acuidade(sa.cd_setor_atendimento,ap.nr_atendimento) = ie_score_p))
            ORDER BY nm_paciente ASC;

BEGIN
     FOR cr IN cr_panorama LOOP
        table_aux.nm_medico            := cr.nm_medico;
        table_aux.nm_medico_ori		     := cr.nm_medico_ori;
        table_aux.nm_paciente          := cr.nm_paciente;
        table_aux.ds_departamento      := cr.ds_departamento;
        table_aux.ie_score             := cr.nr_pontuacao;
        table_aux.ds_unidade_atend     := cr.ds_unidade_atend;
        table_aux.nr_sequencia         := cr.nr_sequencia;
        RETURN NEXT table_aux;
     END LOOP;
  RETURN;
  END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION panorama_main_filter_2.fn_watch_list_import (CD_ESTABELECIMENTO_P bigint, CD_DEPARTAMENTO_P bigint, CD_MEDICO_P bigint, CD_PACIENTE_P bigint, IE_SCORE_P text ) FROM PUBLIC;
