-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pls_gerar_relatorios_pck.pls_relat_obter_se_cpt (nr_contrato_p bigint, nr_seq_cpt_p bigint, dt_inicio_p text, dt_fim_p text, ds_doenca_p text, cd_usuario_plano_p text, ie_utilizacao_p text, nr_seq_intercambio_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) RETURNS SETOF T_RELAT_CPLS_2992_CPT AS $body$
DECLARE

	 
nr_seq_contrato_w 		pls_contrato.nr_sequencia%type;

nr_seq_segurado_w		pls_segurado.nr_sequencia%type;
nr_seq_segurado_ww		pls_segurado.nr_sequencia%type;	
 
 
 
nm_segurado_w			varchar(255);
ds_idade_segurado_w		varchar(255);
nm_estipulante_w		varchar(255);

nr_seq_relatorio_w		bigint;

ds_carencia_w			pls_tipo_carencia.ds_carencia%type;
nr_seq_tipo_carencia_w		pls_carencia.nr_seq_tipo_carencia%type;
cd_usuario_plano_w		pls_segurado_carteira.cd_usuario_plano%type;
vl_preco_atual_w		pls_segurado_preco.vl_preco_atual%type;
nr_seq_preco_w			pls_segurado_preco.nr_sequencia%type;

t_relat_cpls_2992_cpt_w		t_relat_cpls_2992_cpt_row;

C01 CURSOR FOR 
	SELECT a.nr_sequencia nr_seq_segurado, 
		coalesce(c.dt_inicio_vigencia,a.dt_contratacao) dt_inicio_cpt, 
		pls_obter_dados_segurado(a.nr_sequencia,'N') nm_segurado, 
		pls_obter_dados_segurado(a.nr_sequencia,'ID') ds_idade_segurado, 
		coalesce((c.dt_inicio_vigencia + c.qt_dias), (a.dt_contratacao + c.qt_dias)) dt_fim_cpt, 
		e.cd_usuario_plano cd_usuario_plano, 
		substr(obter_nome_pf_pj(b.cd_pf_estipulante, b.cd_cgc_estipulante),1,255) nm_estipulante, 
		c.nr_seq_tipo_carencia nr_seq_tipo_carencia, 
		b.nr_contrato 
	from  pls_segurado a, 
		pls_contrato b, 
		pls_carencia c, 
		pls_segurado_carteira e 
	where  a.nr_seq_contrato	= b.nr_sequencia 
	and   c.nr_seq_segurado  	= a.nr_sequencia 
	and   e.nr_seq_segurado 	= a.nr_sequencia 
	and 	c.ie_cpt = 'S' 
	and 	(((coalesce(a.dt_rescisao::text, '') = '') and (coalesce(a.dt_cancelamento::text, '') = '')) or ((a.dt_rescisao IS NOT NULL AND a.dt_rescisao::text <> '') and (coalesce(a.dt_limite_utilizacao,a.dt_rescisao) >= clock_timestamp()))) 
	and   ((b.nr_sequencia 	= nr_seq_contrato_w) or (coalesce(nr_contrato_p::text, '') = '')) 
	and (e.cd_usuario_plano 	= cd_usuario_plano_p or coalesce(cd_usuario_plano_p::text, '') = '') 
	and (c.nr_seq_tipo_carencia = nr_seq_cpt_p or coalesce(nr_seq_cpt_p::text, '') = '') 
	and  	(((c.dt_inicio_vigencia + c.qt_dias ) between to_date(dt_inicio_p, 'dd/mm/yyyy') and to_date(dt_fim_p,'dd/mm/yyyy')) or ((coalesce(dt_inicio_p::text, '') = '') and (coalesce(dt_fim_p::text, '') = '')));

C02 CURSOR FOR 
	SELECT a.nr_sequencia nr_seq_segurado , 
		coalesce(c.dt_inicio_vigencia,a.dt_contratacao) dt_inicio_cpt, 
		pls_obter_dados_segurado(a.nr_sequencia,'N') nm_segurado, 
		pls_obter_dados_segurado(a.nr_sequencia,'ID') ds_idade_segurado, 
		coalesce((c.dt_inicio_vigencia + c.qt_dias), (a.dt_contratacao + c.qt_dias)) dt_fim_cpt, 
		e.cd_usuario_plano cd_usuario_plano, 
		substr(obter_nome_pf_pj(b.cd_pessoa_fisica, b.cd_cgc),1,255) nm_estipulante, 
		c.nr_seq_tipo_carencia nr_seq_tipo_carencia, 
		b.nr_sequencia nr_contrato 
	from  pls_segurado a, 
		pls_intercambio b, 
		pls_carencia c, 
		pls_segurado_carteira e 
	where  a.nr_seq_intercambio	= b.nr_sequencia 
	and   c.nr_seq_segurado  	= a.nr_sequencia 
	and   e.nr_seq_segurado 	= a.nr_sequencia 
	and 	c.ie_cpt = 'S' 
	and 	(((coalesce(a.dt_rescisao::text, '') = '') and (coalesce(a.dt_cancelamento::text, '') = '')) or ((a.dt_rescisao IS NOT NULL AND a.dt_rescisao::text <> '') and (coalesce(a.dt_limite_utilizacao,a.dt_rescisao) >= clock_timestamp()))) 
	and   ((b.nr_sequencia 	= nr_seq_intercambio_p) or (coalesce(nr_seq_intercambio_p::text, '') = '')) 
	and (e.cd_usuario_plano 	= cd_usuario_plano_p or coalesce(cd_usuario_plano_p::text, '') = '') 
	and (c.nr_seq_tipo_carencia = nr_seq_cpt_p or coalesce(nr_seq_cpt_p::text, '') = '') 
	and  	(((c.dt_inicio_vigencia + c.qt_dias ) between to_date(dt_inicio_p, 'dd/mm/yyyy') and to_date(dt_fim_p,'dd/mm/yyyy')) or ((coalesce(dt_inicio_p::text, '') = '') and (coalesce(dt_fim_p::text, '') = '')));

BEGIN
 
if (coalesce(ie_utilizacao_p,'N') = 'N') then	 
	if (coalesce(nr_contrato_p,0) <> 0) then 
		select 	coalesce(nr_sequencia,0) 
		into STRICT	nr_seq_contrato_w 
		from 	pls_contrato 
		where 	nr_contrato = nr_contrato_p;
	end if;
	 
	open C01;
	loop 
	fetch C01 into 
		t_relat_cpls_2992_cpt_w.nr_seq_segurado, 
		t_relat_cpls_2992_cpt_w.dt_inicio_cpt, 
		t_relat_cpls_2992_cpt_w.nm_segurado, 
		t_relat_cpls_2992_cpt_w.ds_idade_segurado, 
		t_relat_cpls_2992_cpt_w.dt_fim_cpt, 
		t_relat_cpls_2992_cpt_w.cd_usuario_plano, 
		t_relat_cpls_2992_cpt_w.nm_estipulante, 
		t_relat_cpls_2992_cpt_w.nr_seq_tipo_carencia, 
		t_relat_cpls_2992_cpt_w.nr_contrato;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin 
		 
		nr_seq_preco_w	:= coalesce(pls_obter_seg_preco_ativo(t_relat_cpls_2992_cpt_w.nr_seq_segurado,clock_timestamp()),0);
		 
		select 	vl_preco_atual 
		into STRICT	vl_preco_atual_w 
		from 	pls_segurado_preco 
		where nr_sequencia = nr_seq_preco_w;
	 
		select 	ds_carencia 
		into STRICT	ds_carencia_w 
		from 	pls_tipo_carencia 
		where 	nr_sequencia = coalesce(t_relat_cpls_2992_cpt_w.nr_seq_tipo_carencia,0);
 
		t_relat_cpls_2992_cpt_w.ds_carencia	:= ds_carencia_w;
		t_relat_cpls_2992_cpt_w.vl_preco_atual 	:= vl_preco_atual_w;
		RETURN NEXT t_relat_cpls_2992_cpt_w;
		 
		end;		
	end loop;
	close C01;
	 
elsif (coalesce(ie_utilizacao_p,'N') = 'S') then 
	open C02;
	loop 
	fetch C02 into 
		t_relat_cpls_2992_cpt_w.nr_seq_segurado, 
		t_relat_cpls_2992_cpt_w.dt_inicio_cpt, 
		t_relat_cpls_2992_cpt_w.nm_segurado, 
		t_relat_cpls_2992_cpt_w.ds_idade_segurado, 
		t_relat_cpls_2992_cpt_w.dt_fim_cpt, 
		t_relat_cpls_2992_cpt_w.cd_usuario_plano, 
		t_relat_cpls_2992_cpt_w.nm_estipulante, 
		t_relat_cpls_2992_cpt_w.nr_seq_tipo_carencia, 
		t_relat_cpls_2992_cpt_w.nr_contrato;
	EXIT WHEN NOT FOUND; /* apply on C02 */
	begin 
	 
		nr_seq_preco_w	:= coalesce(pls_obter_seg_preco_ativo(t_relat_cpls_2992_cpt_w.nr_seq_segurado,clock_timestamp()),0);
		 
		if (nr_seq_preco_w <> 0) then 
		 
			select 	vl_preco_atual 
			into STRICT	vl_preco_atual_w 
			from 	pls_segurado_preco 
			where nr_sequencia = nr_seq_preco_w;
		else 
			vl_preco_atual_w := 0;
		end if;
	 
		select 	ds_carencia 
		into STRICT	ds_carencia_w 
		from 	pls_tipo_carencia 
		where 	nr_sequencia = coalesce(t_relat_cpls_2992_cpt_w.nr_seq_tipo_carencia,0);
 
		t_relat_cpls_2992_cpt_w.ds_carencia	:= ds_carencia_w;
		t_relat_cpls_2992_cpt_w.vl_preco_atual 	:= vl_preco_atual_w;
		RETURN NEXT t_relat_cpls_2992_cpt_w;
		 
	end;
	end loop;
	close C02;
	 
end if;	
 
 
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pls_gerar_relatorios_pck.pls_relat_obter_se_cpt (nr_contrato_p bigint, nr_seq_cpt_p bigint, dt_inicio_p text, dt_fim_p text, ds_doenca_p text, cd_usuario_plano_p text, ie_utilizacao_p text, nr_seq_intercambio_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;
