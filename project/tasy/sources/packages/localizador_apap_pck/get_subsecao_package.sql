-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION localizador_apap_pck.get_subsecao (nr_seq_secao_p bigint) RETURNS SETOF SUBSECAO_T AS $body$
DECLARE

   subsecao_w              subsecao_r;
   ds_estrutura_w          varchar(2000);
   nr_sequencia_w          bigint;
   indice_w                bigint := 0;

   c_subsecao CURSOR FOR
      SELECT   b.nr_seq_linked_data,
               b.nr_seq_apresentacao,
               b.nr_seq_grupo_pg,
               b.nr_seq_tipo_pg,
               b.nr_seq_score_flex,
               b.nr_ficha_tecnica,
               b.ie_tipo_dosagem,
               obter_valor_dominio(2274,b.ie_tipo_dosagem) ds_tipo_dosagem,
               b.nr_seq_gas,
               b.cd_material,
               b.cd_grupo_material,
               b.cd_subgrupo_material,
               b.cd_classe_material,
               b.ie_evolucao_clinica,
               b.nr_seq_inf_adic,
               substr(obter_dados_pg_inf_adic(b.nr_seq_inf_adic,'D'),1,255) ds_seq_inf_adic,
               b.ie_membro,
               substr(obter_valor_dominio(1304,b.ie_membro),1,255) ds_membro,
               b.ie_aparelho_pa,
               substr(obter_valor_dominio(1306,b.ie_aparelho_pa),1,255) ds_aparelho_pa,
               b.ie_pupila_lado,
               substr(obter_valor_dominio(1372,b.ie_pupila_lado),1,255) ds_pupila_lado,
               b.nm_atributo,
               SUBSTR(obter_desc_expressao(d.cd_exp_label),1,80) ds_label,
               e.ie_informacao,
               b.nr_seq_exame
      from     documento_secao a,
               documento_subsecao b,
               linked_data c,
               tabela_visao_atributo d,
               linked_data_ativacao e
      where    a.nr_sequencia       = b.nr_seq_documento_secao
      and      b.nr_seq_linked_data = c.nr_sequencia
      and      c.nr_sequencia       = e.nr_seq_linked_data
      and      c.nr_seq_vision      = d.nr_sequencia
      and      b.nm_atributo        = d.nm_atributo
      and      a.nr_sequencia       = nr_seq_secao_p
      and      (c.nm_table IS NOT NULL AND c.nm_table::text <> '')
      order by b.nr_seq_apresentacao;

BEGIN
   
   <<read_subsecao>>
   for r_subsecao in c_subsecao
      loop
      if (r_subsecao.cd_material IS NOT NULL AND r_subsecao.cd_material::text <> '') then
         select   max(ds_estrutura),
                  max(nr_sequencia)
         into STRICT     ds_estrutura_w,
                  nr_sequencia_w
         from     table(get_estrutura)
         where    cd_material = r_subsecao.cd_material
         and      nm_atributo = r_subsecao.nm_atributo
         and      nr_seq_linked_data = r_subsecao.nr_seq_linked_data;
      elsif (r_subsecao.cd_classe_material IS NOT NULL AND r_subsecao.cd_classe_material::text <> '') then
         select   max(ds_estrutura),
                  max(nr_sequencia)
         into STRICT     ds_estrutura_w,
                  nr_sequencia_w
         from     table(get_estrutura)
         where    cd_classe_material   = r_subsecao.cd_classe_material
         and      nm_atributo          = r_subsecao.nm_atributo
         and      nr_seq_linked_data = r_subsecao.nr_seq_linked_data;
      elsif (r_subsecao.cd_subgrupo_material IS NOT NULL AND r_subsecao.cd_subgrupo_material::text <> '') then
         select   max(ds_estrutura),
                  max(nr_sequencia)
         into STRICT     ds_estrutura_w,
                  nr_sequencia_w
         from     table(get_estrutura)
         where    cd_subgrupo_material = r_subsecao.cd_subgrupo_material
         and      nm_atributo          = r_subsecao.nm_atributo
         and      nr_seq_linked_data = r_subsecao.nr_seq_linked_data;
      elsif (r_subsecao.cd_grupo_material IS NOT NULL AND r_subsecao.cd_grupo_material::text <> '') then
         select   max(ds_estrutura),
                  max(nr_sequencia)
         into STRICT     ds_estrutura_w,
                  nr_sequencia_w
         from     table(get_estrutura)
         where    cd_grupo_material = r_subsecao.cd_grupo_material
         and      nm_atributo       = r_subsecao.nm_atributo
         and      nr_seq_linked_data = r_subsecao.nr_seq_linked_data;
      elsif (r_subsecao.nr_ficha_tecnica IS NOT NULL AND r_subsecao.nr_ficha_tecnica::text <> '') then
         select   max(ds_estrutura),
                  max(nr_sequencia)
         into STRICT     ds_estrutura_w,
                  nr_sequencia_w
         from     table(get_estrutura)
         where    nr_ficha_tecnica = r_subsecao.nr_ficha_tecnica
         and      nm_atributo      = r_subsecao.nm_atributo
         and      nr_seq_linked_data = r_subsecao.nr_seq_linked_data;
      elsif (r_subsecao.nr_seq_grupo_pg IS NOT NULL AND r_subsecao.nr_seq_grupo_pg::text <> '') then
         select   max(ds_estrutura),
                  max(nr_sequencia)
         into STRICT     ds_estrutura_w,
                  nr_sequencia_w
         from     table(get_estrutura)
         where    nr_seq_grupo_pg = r_subsecao.nr_seq_grupo_pg
         and      nm_atributo     = r_subsecao.nm_atributo
         and      nr_seq_linked_data = r_subsecao.nr_seq_linked_data;
      elsif (r_subsecao.nr_seq_tipo_pg IS NOT NULL AND r_subsecao.nr_seq_tipo_pg::text <> '') then
         select   max(ds_estrutura),
                  max(nr_sequencia)
         into STRICT     ds_estrutura_w,
                  nr_sequencia_w
         from     table(get_estrutura)
         where    nr_seq_tipo_pg = r_subsecao.nr_seq_tipo_pg
         and      nm_atributo    = r_subsecao.nm_atributo
         and      nr_seq_linked_data = r_subsecao.nr_seq_linked_data;
      elsif (r_subsecao.nr_seq_score_flex IS NOT NULL AND r_subsecao.nr_seq_score_flex::text <> '') then
         select   max(ds_estrutura),
                  max(nr_sequencia)
         into STRICT     ds_estrutura_w,
                  nr_sequencia_w
         from     table(get_estrutura)
         where    nr_seq_score_flex = r_subsecao.nr_seq_score_flex
         and      nm_atributo       = r_subsecao.nm_atributo
         and      nr_seq_linked_data = r_subsecao.nr_seq_linked_data;
      elsif (r_subsecao.nr_seq_gas IS NOT NULL AND r_subsecao.nr_seq_gas::text <> '') then
         select   max(ds_estrutura),
                  max(nr_sequencia)
         into STRICT     ds_estrutura_w,
                  nr_sequencia_w
         from     table(get_estrutura)
         where    nm_atributo          = r_subsecao.nm_atributo
         and      nr_seq_linked_data   = r_subsecao.nr_seq_linked_data
         and      nr_seq_gas           = r_subsecao.nr_seq_gas;
      elsif (r_subsecao.ie_evolucao_clinica IS NOT NULL AND r_subsecao.ie_evolucao_clinica::text <> '') then
         select   max(ds_estrutura),
                  max(nr_sequencia)
         into STRICT     ds_estrutura_w,
                  nr_sequencia_w
         from     table(get_estrutura)
         where    nm_atributo          = r_subsecao.nm_atributo
         and      nr_seq_linked_data   = r_subsecao.nr_seq_linked_data
         and      ie_evolucao_clinica  = r_subsecao.ie_evolucao_clinica;
      elsif (r_subsecao.nr_seq_exame IS NOT NULL AND r_subsecao.nr_seq_exame::text <> '') then
         select   max(ds_estrutura),
                  max(nr_sequencia)
         into STRICT     ds_estrutura_w,
                  nr_sequencia_w
         from     table(get_estrutura)
         where    nm_atributo          = r_subsecao.nm_atributo
         and      nr_seq_linked_data   = r_subsecao.nr_seq_linked_data
         and      nr_seq_exame         = r_subsecao.nr_seq_exame;
      else
         select   max(ds_estrutura),
                  max(nr_sequencia)
         into STRICT     ds_estrutura_w,
                  nr_sequencia_w
         from     table(get_estrutura)
         where    nm_atributo          = r_subsecao.nm_atributo
         and      nr_seq_linked_data   = r_subsecao.nr_seq_linked_data;
      end if;
      subsecao_w.nr_seq_apresentacao   := r_subsecao.nr_seq_apresentacao;
      subsecao_w.nr_seq_linked_data    := r_subsecao.nr_seq_linked_data;
      subsecao_w.nm_atributo           := r_subsecao.nm_atributo;
      subsecao_w.ds_descricao          := r_subsecao.ds_label;
      subsecao_w.ds_estrutura          := ds_estrutura_w;
      subsecao_w.nr_seq_inf_adic       := r_subsecao.nr_seq_inf_adic;
      subsecao_w.ds_seq_inf_adic       := r_subsecao.ds_seq_inf_adic;
      subsecao_w.ie_membro             := r_subsecao.ie_membro;
      subsecao_w.ds_membro             := r_subsecao.ds_membro;
      subsecao_w.ie_aparelho_pa        := r_subsecao.ie_aparelho_pa;
      subsecao_w.ds_aparelho_pa        := r_subsecao.ds_aparelho_pa;
      subsecao_w.ie_pupila_lado        := r_subsecao.ie_pupila_lado;
      subsecao_w.ds_pupila_lado        := r_subsecao.ds_pupila_lado;
      subsecao_w.ie_tipo_dosagem       := r_subsecao.ie_tipo_dosagem;
      subsecao_w.ds_tipo_dosagem       := r_subsecao.ds_tipo_dosagem;
      subsecao_w.nr_sequencia          := nr_sequencia_w;

      
      RETURN NEXT subsecao_w;
      end loop read_subsecao;
   return;
   END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION localizador_apap_pck.get_subsecao (nr_seq_secao_p bigint) FROM PUBLIC;
