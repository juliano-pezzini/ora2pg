-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE localizador_apap_pck.atualizar_subsecao ( nr_seq_documento_secao_p bigint, nr_sequencia_p bigint, nr_seq_apresentacao_p bigint, ie_tipo_dosagem_p text, nr_seq_inf_adic_p bigint, ie_membro_p text, ie_aparelho_pa_p text, ie_pupila_lado_p text, ds_lista_removidos_p text) AS $body$
DECLARE


nm_atributo_w           documento_subsecao.nm_atributo%type;
nr_seq_grupo_pg_w       documento_subsecao.nr_seq_grupo_pg%type;
nr_seq_tipo_pg_w        documento_subsecao.nr_seq_tipo_pg%type;
nr_seq_linked_data_w    documento_subsecao.nr_seq_linked_data%type;
nr_seq_score_flex_w     documento_subsecao.nr_seq_score_flex%type;
nr_ficha_tecnica_w      documento_subsecao.nr_ficha_tecnica%type;
nr_seq_gas_w            documento_subsecao.nr_seq_gas%type;
cd_material_w           documento_subsecao.cd_material%type;
cd_grupo_material_w     documento_subsecao.cd_grupo_material%type;
cd_subgrupo_material_w  documento_subsecao.cd_subgrupo_material%type;
cd_classe_material_w    documento_subsecao.cd_classe_material%type;
ie_evolucao_clinica_w   documento_subsecao.ie_evolucao_clinica%type;
nr_seq_exame_w          documento_subsecao.nr_seq_exame%type;

c_removidos CURSOR FOR
   SELECT   nm_atributo,
            nr_seq_grupo_pg,
            nr_seq_tipo_pg,
            nr_seq_linked_data,
            nr_seq_score_flex,
            nr_ficha_tecnica,
            nr_seq_gas,
            cd_material,
            cd_grupo_material,
            cd_subgrupo_material,
            cd_classe_material,
            ie_evolucao_clinica,
            nr_seq_exame
   from     table(get_estrutura)
   where    obter_se_contido(nr_sequencia,ds_lista_removidos_p) = 'S';

   
BEGIN
   if (ds_lista_removidos_p IS NOT NULL AND ds_lista_removidos_p::text <> '') then
      <<read_removidos>>
      for r_removidos in c_removidos
         loop
         delete   
         from     documento_subsecao
         where    nr_seq_linked_data         = r_removidos.nr_seq_linked_data
         and      nm_atributo                = r_removidos.nm_atributo
         and      nr_seq_documento_secao     = nr_seq_documento_secao_p
         and      (((nr_seq_grupo_pg         = r_removidos.nr_seq_grupo_pg) or (coalesce(r_removidos.nr_seq_grupo_pg::text, '') = ''))
         and       ((nr_seq_tipo_pg          = r_removidos.nr_seq_tipo_pg) or (coalesce(r_removidos.nr_seq_tipo_pg::text, '') = ''))
         and       ((nr_seq_score_flex       = r_removidos.nr_seq_score_flex) or (coalesce(r_removidos.nr_seq_score_flex::text, '') = ''))
         and       ((nr_ficha_tecnica        = r_removidos.nr_ficha_tecnica) or (coalesce(r_removidos.nr_ficha_tecnica::text, '') = ''))
         and       ((nr_seq_gas              = r_removidos.nr_seq_gas) or (coalesce(r_removidos.nr_seq_gas::text, '') = ''))
         and       ((cd_material             = r_removidos.cd_material) or (coalesce(r_removidos.cd_material::text, '') = ''))
         and       ((cd_grupo_material       = r_removidos.cd_grupo_material) or (coalesce(r_removidos.cd_grupo_material::text, '') = ''))
         and       ((cd_subgrupo_material    = r_removidos.cd_subgrupo_material) or (coalesce(r_removidos.cd_subgrupo_material::text, '') = ''))
         and       ((cd_classe_material      = r_removidos.cd_classe_material) or (coalesce(r_removidos.cd_classe_material::text, '') = ''))
         and       ((ie_evolucao_clinica     = r_removidos.ie_evolucao_clinica) or (coalesce(r_removidos.ie_evolucao_clinica::text, '') = ''))
         and       ((nr_seq_exame            = r_removidos.nr_seq_exame) or (coalesce(r_removidos.nr_seq_exame::text, '') = '')));
         end loop read_removidos;
   else
      select   a.nm_atributo,
               a.nr_seq_grupo_pg,
               a.nr_seq_tipo_pg,
               a.nr_seq_linked_data,
               a.nr_seq_score_flex,
               a.nr_ficha_tecnica,
               a.nr_seq_gas,
               a.cd_material,
               a.cd_grupo_material,
               a.cd_subgrupo_material,
               a.cd_classe_material,
               a.ie_evolucao_clinica,
               a.nr_seq_exame
      into STRICT     nm_atributo_w,
               nr_seq_grupo_pg_w,
               nr_seq_tipo_pg_w,
               nr_seq_linked_data_w,
               nr_seq_score_flex_w,
               nr_ficha_tecnica_w,
               nr_seq_gas_w,
               cd_material_w,
               cd_grupo_material_w,
               cd_subgrupo_material_w,
               cd_classe_material_w,
               ie_evolucao_clinica_w,
               nr_seq_exame_w
      from     table(get_estrutura) a
      where    nr_sequencia = nr_sequencia_p;

      update   documento_subsecao
      set      nr_seq_apresentacao     = nr_seq_apresentacao_p,
               nr_seq_inf_adic         = nr_seq_inf_adic_p,
               ie_membro               = ie_membro_p,
               ie_aparelho_pa          = ie_aparelho_pa_p,
               ie_tipo_dosagem         = ie_tipo_dosagem_p,
               dt_atualizacao          = clock_timestamp(),
               nm_usuario              = current_setting('localizador_apap_pck.nm_usuario_w')::usuario.nm_usuario%type
      where    nr_seq_documento_secao  = nr_seq_documento_secao_p
      and      nr_seq_linked_data      = nr_seq_linked_data_w
      and      nm_atributo             = nm_atributo_w
      and      (((nr_seq_grupo_pg       = nr_seq_grupo_pg_w) or (coalesce(nr_seq_grupo_pg_w::text, '') = ''))
      and       ((nr_seq_tipo_pg        = nr_seq_tipo_pg_w) or (coalesce(nr_seq_tipo_pg_w::text, '') = ''))
      and       ((nr_seq_score_flex     = nr_seq_score_flex_w) or (coalesce(nr_seq_score_flex_w::text, '') = ''))
      and       ((nr_ficha_tecnica      = nr_ficha_tecnica_w) or (coalesce(nr_ficha_tecnica_w::text, '') = ''))
      and       ((nr_seq_gas            = nr_seq_gas_w) or (coalesce(nr_seq_gas_w::text, '') = ''))
      and       ((cd_material           = cd_material_w) or (coalesce(cd_material_w::text, '') = ''))
      and       ((cd_grupo_material     = cd_grupo_material_w) or (coalesce(cd_grupo_material_w::text, '') = ''))
      and       ((cd_subgrupo_material  = cd_subgrupo_material_w) or (coalesce(cd_subgrupo_material_w::text, '') = ''))
      and       ((cd_classe_material    = cd_classe_material_w) or (coalesce(cd_classe_material_w::text, '') = ''))
      and       ((nr_seq_exame          = nr_seq_exame_w) or (coalesce(nr_seq_exame_w::text, '') = ''))
      and       ((ie_evolucao_clinica   = ie_evolucao_clinica_w) or (coalesce(ie_evolucao_clinica_w::text, '') = '')));

      if	NOT FOUND then
         insert   into  documento_subsecao( nr_sequencia,
                                             nr_seq_documento_secao,
                                             dt_atualizacao,
                                             nm_usuario,
                                             dt_atualizacao_nrec,
                                             nm_usuario_nrec,
                                             nr_seq_apresentacao,
                                             ie_modo,
                                             nm_atributo,
                                             nr_seq_grupo_pg,
                                             nr_seq_tipo_pg,
                                             nr_seq_linked_data,
                                             nr_seq_score_flex,
                                             nr_ficha_tecnica,
                                             ie_tipo_dosagem,
                                             ie_controla_adep,
                                             nr_seq_gas,
                                             cd_material,
                                             cd_grupo_material,
                                             cd_subgrupo_material,
                                             cd_classe_material,
                                             ie_evolucao_clinica,
                                             nr_seq_inf_adic,
                                             ie_membro,
                                             ie_aparelho_pa,
                                             nr_seq_exame)
         SELECT                              nextval('documento_subsecao_seq'),
                                             nr_seq_documento_secao_p,
                                             clock_timestamp(),
                                             current_setting('localizador_apap_pck.nm_usuario_w')::usuario.nm_usuario%type,
                                             clock_timestamp(),
                                             current_setting('localizador_apap_pck.nm_usuario_w')::usuario.nm_usuario%type,
                                             nr_seq_apresentacao_p,
                                             'A',
                                             nm_atributo_w,
                                             nr_seq_grupo_pg_w,
                                             nr_seq_tipo_pg_w,
                                             nr_seq_linked_data_w,
                                             nr_seq_score_flex_w,
                                             nr_ficha_tecnica_w,
                                             ie_tipo_dosagem_p,
                                             'N',
                                             nr_seq_gas_w,
                                             cd_material_w,
                                             cd_grupo_material_w,
                                             cd_subgrupo_material_w,
                                             cd_classe_material_w,
                                             ie_evolucao_clinica_w,
                                             nr_seq_inf_adic_p,
                                             ie_membro_p,
                                             ie_aparelho_pa_p,
                                             nr_seq_exame_w
;
      end if;
   end if;
   commit;
   END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE localizador_apap_pck.atualizar_subsecao ( nr_seq_documento_secao_p bigint, nr_sequencia_p bigint, nr_seq_apresentacao_p bigint, ie_tipo_dosagem_p text, nr_seq_inf_adic_p bigint, ie_membro_p text, ie_aparelho_pa_p text, ie_pupila_lado_p text, ds_lista_removidos_p text) FROM PUBLIC;
