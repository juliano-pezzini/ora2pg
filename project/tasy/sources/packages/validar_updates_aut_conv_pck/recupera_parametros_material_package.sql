-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE validar_updates_aut_conv_pck.recupera_parametros_material (nr_sequencia_autor_p material_autorizado.nr_sequencia_autor%TYPE, cd_material_glo_p material_vinculo_global.cd_material_glo%TYPE, cd_material_p INOUT material_autorizado.cd_material%type, ds_mensagem_erro_p INOUT integration_call_log.ds_notes%TYPE) AS $body$
DECLARE


    nr_sequencia_autor_w material_autorizado.nr_sequencia_autor%TYPE := nr_sequencia_autor_p;
    cd_material_glo_w material_vinculo_global.cd_material_glo%TYPE := cd_material_glo_p;
    cd_categoria_w atend_categoria_convenio.cd_categoria%TYPE;
    cd_plano_convenio_w atend_categoria_convenio.cd_plano_convenio%TYPE;
    cd_convenio_w autorizacao_convenio.cd_convenio%TYPE;
    cd_setor_atendimento_w autorizacao_convenio.cd_setor_resp%TYPE;
	current_setting('validar_updates_aut_conv_pck.separador_linha_w')::varchar(50)CHR(13)|| constant varchar(50) :=  CHR(13) || CHR(10);
    cd_estabelecimento_w autorizacao_convenio.cd_estabelecimento%TYPE;
    ds_mensagem_erro_mat_w integration_call_log.ds_notes%TYPE := ' An error occurred while retrieving the material code of '||
                                                                 'the insurance authorization. Transaction Id: '||nr_sequencia_autor_p||' Material Code: '
                                                                 ||cd_material_glo_p||'. ';
    ds_mensagem_erro_param_w integration_call_log.ds_notes%TYPE := ' An error occurred when consulting the parameters to change the material records of the '||
                                                                   'insurance authorization. Validate the registered information of the material and try'||
                                                                   'again. Transaction Id: '||nr_sequencia_autor_p||' Material Code: '||cd_material_glo_p||'. ';


BEGIN
        BEGIN
            select c.cd_categoria, c.cd_plano_convenio, b.cd_convenio, b.cd_setor_resp, b.cd_estabelecimento
            into STRICT cd_categoria_w, cd_plano_convenio_w, cd_convenio_w, cd_setor_atendimento_w, cd_estabelecimento_w
            from autorizacao_convenio b, atend_categoria_convenio c
            where b.nr_sequencia = nr_sequencia_autor_w
            and c.nr_atendimento = b.nr_atendimento
            and c.dt_inicio_vigencia = (SELECT max(d.dt_inicio_vigencia)
                                        from atend_categoria_convenio d
                                        where d.nr_atendimento = c.nr_atendimento);
        EXCEPTION
            WHEN no_data_found OR too_many_rows THEN
                ds_mensagem_erro_p := ds_mensagem_erro_param_w||current_setting('validar_updates_aut_conv_pck.separador_linha_w')::varchar(50)CHR(13)||;
        END;

        BEGIN                            
            select max(g.cd_material)
            into STRICT cd_material_p
            from material_vinculo_global g
            where g.cd_material_glo = cd_material_glo_w
            and g.cd_estabelecimento = cd_estabelecimento_w            
            and (g.cd_setor_atendimento = cd_setor_atendimento_w or (coalesce(g.cd_setor_atendimento::text, '') = '' and coalesce(cd_setor_atendimento_w::text, '') = ''))            
            and (g.cd_convenio = cd_convenio_w or (coalesce(g.cd_convenio::text, '') = '' and coalesce(cd_convenio_w::text, '') = ''))
            and (g.cd_categoria = cd_categoria_w or (coalesce(g.cd_categoria::text, '') = '' and coalesce(cd_categoria_w::text, '') = ''))
            and (g.cd_plano = cd_plano_convenio_w or (coalesce(g.cd_plano::text, '') = '' and coalesce(cd_plano_convenio_w::text, '') = ''))
            and g.dt_inicio_vigencia <= clock_timestamp()
            and (g.dt_fim_vigencia >= clock_timestamp() or coalesce(g.dt_fim_vigencia::text, '') = '');

            IF (coalesce(cd_material_p::text, '') = '') THEN
                ds_mensagem_erro_p := ds_mensagem_erro_p||ds_mensagem_erro_mat_w;
            END IF;
        EXCEPTION
            WHEN no_data_found THEN
                ds_mensagem_erro_p := ds_mensagem_erro_p||ds_mensagem_erro_mat_w||' . Error: '||sqlerrm;
                CALL wheb_mensagem_pck.exibir_mensagem_abort(ds_mensagem_erro_mat_w||sqlerrm);
        END;
    END;


$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE validar_updates_aut_conv_pck.recupera_parametros_material (nr_sequencia_autor_p material_autorizado.nr_sequencia_autor%TYPE, cd_material_glo_p material_vinculo_global.cd_material_glo%TYPE, cd_material_p INOUT material_autorizado.cd_material%type, ds_mensagem_erro_p INOUT integration_call_log.ds_notes%TYPE) FROM PUBLIC;
