-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE gerar_dados_301_pck.obter_seq_arquivo (nr_seq_lote_p bigint, nr_seq_log_scheduler_p bigint, cd_convenio_p bigint, nm_usuario_p text, nr_seq_arquivo_p INOUT bigint) AS $body$
DECLARE


	nr_seq_arquivo_w	d301_arquivo_envio.nr_sequencia%type;
	nr_seq_lote_w		d301_lote_envio.nr_sequencia%type;
	cd_estabelecimento_w	estabelecimento.cd_estabelecimento%type;
	ds_nome_arquivo_w	d301_arquivo_envio.ds_nome_arquivo%type;

	
BEGIN

	select	max(a.nr_sequencia) nr_seq_arquivo,
		max(a.nr_seq_estrut_arq) nr_seq_estrut_arq
	into STRICT	nr_seq_arquivo_w,
		current_setting('gerar_dados_301_pck.nr_seq_estrut_arq_w')::bigint
	from	d301_arquivo_envio a
	where	a.nr_seq_lote_envio = nr_seq_lote_p
	and	a.cd_convenio	= cd_convenio_p;

	if (coalesce(nr_seq_arquivo_w::text, '') = '') then
		if (coalesce(nr_seq_lote_p::text, '') = '') then
			select	nextval('d301_lote_envio_seq')
			into STRICT	nr_seq_lote_w
			;

			select 	wheb_usuario_pck.get_cd_estabelecimento
			into STRICT	cd_estabelecimento_w
			;

			insert into d301_lote_envio(nr_sequencia,
				nm_usuario,
				dt_atualizacao,
				nm_usuario_nrec,
				dt_atualizacao_nrec,
				cd_estabelecimento,
				dt_inicio_geracao,
				nr_seq_log_scheduler)
			values (nr_seq_lote_p,
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				cd_estabelecimento_w,
				trunc(clock_timestamp(),'dd'),
				nr_seq_log_scheduler_p);
		else
			select	cd_estabelecimento
			into STRICT	cd_estabelecimento_w
			from	d301_lote_envio a
			where	a.nr_sequencia = nr_seq_lote_p;

			nr_seq_lote_w	:= nr_seq_lote_p;
		end if;

		select	nextval('d301_arquivo_envio_seq')
		into STRICT	nr_seq_arquivo_w
		;

		PERFORM set_config('gerar_dados_301_pck.nr_seq_estrut_arq_w', rcm301_arquivo_pck.get_seq_estrutura_arq(clock_timestamp(), cd_estabelecimento_w, cd_convenio_p ), false);

		insert into d301_arquivo_envio(nr_sequencia,
			nm_usuario,
			dt_atualizacao,
			nm_usuario_nrec,
			dt_atualizacao_nrec,
			nr_seq_lote_envio,
			ds_nome_arquivo,
			cd_convenio,
			nr_seq_estrut_arq)
		values (nr_seq_arquivo_w,
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nr_seq_lote_w,
			null,
			cd_convenio_p,
			current_setting('gerar_dados_301_pck.nr_seq_estrut_arq_w')::bigint);

		OBTER_NOME_ARQUIVO_301(nr_seq_arquivo_w,ds_nome_arquivo_w);

		update	d301_arquivo_envio
		set	ds_nome_arquivo = ds_nome_arquivo_w
		where	nr_sequencia	= nr_seq_arquivo_w;

		CALL ajustar_newvalue_sequence('DATASET_301_ORDEM_SEQ',0);
	end if;

	nr_seq_arquivo_p	:= nr_seq_arquivo_w;

	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_dados_301_pck.obter_seq_arquivo (nr_seq_lote_p bigint, nr_seq_log_scheduler_p bigint, cd_convenio_p bigint, nm_usuario_p text, nr_seq_arquivo_p INOUT bigint) FROM PUBLIC;
