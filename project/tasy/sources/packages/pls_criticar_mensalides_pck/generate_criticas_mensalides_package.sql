-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_criticar_mensalides_pck.generate_criticas_mensalides (nm_usuario_p text) AS $body$
DECLARE


	nr_seq_mensalidade_seg_ant_w		pls_mensalidade_segurado.nr_sequencia%type;
	dt_mesano_referencia_ant_w		pls_mensalidade_segurado.dt_mesano_referencia%type;
	index_w					bigint	:= 0;
	vl_pre_estabelecido_ant_w		pls_mensalidade_segurado.vl_pre_estabelecido%type;
	qt_idade_ant_w				pls_mensalidade_segurado.qt_idade%type;
	nr_seq_critica_mens_w			pls_critica_mensalidade.nr_sequencia%type;

	C01 CURSOR FOR
		SELECT	nr_sequencia
		from	pls_critica_mensalidade;

	
BEGIN

	current_setting('pls_criticar_mensalides_pck.vector_critica_mensalidade_w')::vector_2.delete;

	open C01;
	loop
	fetch C01 into
		nr_seq_critica_mens_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		current_setting('pls_criticar_mensalides_pck.vector_critica_mensalidade_w')::vector_2(current_setting('pls_criticar_mensalides_pck.vector_critica_mensalidade_w')::vector_2.count+1).nr_seq_critica_w := nr_seq_critica_mens_w;
		end;
	end loop;
	close C01;

	for index_w in 1..vector_mensalidade_seg_w.count loop
		begin

		if (current_setting('pls_criticar_mensalides_pck.vector_mensalidade_seg_w')::vector_1[index_w].record_mensalidade_seg.nr_parcela	> 1) then

			dt_mesano_referencia_ant_w	:= add_months(current_setting('pls_criticar_mensalides_pck.vector_mensalidade_seg_w')::vector_1[index_w].record_mensalidade_seg.dt_mesano_referencia,-1);

			select	max(b.nr_sequencia)
			into STRICT	nr_seq_mensalidade_seg_ant_w
			from	pls_mensalidade_segurado	b,
				pls_mensalidade			a
			where	b.nr_seq_mensalidade		= a.nr_sequencia
			and	b.nr_seq_segurado		= current_setting('pls_criticar_mensalides_pck.vector_mensalidade_seg_w')::vector_1[index_w].record_mensalidade_seg.nr_seq_segurado
			and	b.dt_mesano_referencia		= dt_mesano_referencia_ant_w
			and	coalesce(a.ie_cancelamento::text, '') = '';

			if (nr_seq_mensalidade_seg_ant_w IS NOT NULL AND nr_seq_mensalidade_seg_ant_w::text <> '') then
				select	coalesce(vl_pre_estabelecido,0),
					coalesce(qt_idade,0)
				into STRICT	vl_pre_estabelecido_ant_w,
					qt_idade_ant_w
				from	pls_mensalidade_segurado
				where	nr_sequencia	= nr_seq_mensalidade_seg_ant_w;

				if (vl_pre_estabelecido_ant_w > coalesce(current_setting('pls_criticar_mensalides_pck.vector_mensalidade_seg_w')::vector_1[index_w].record_mensalidade_seg.vl_pre_estabelecido,0)) and (vl_pre_estabelecido_ant_w > 0) and (coalesce(current_setting('pls_criticar_mensalides_pck.vector_mensalidade_seg_w')::vector_1[index_w].record_mensalidade_seg.vl_pre_estabelecido,0) > 0) then
					CALL pls_criticar_mensalides_pck.insert_critica_mens_segurado(current_setting('pls_criticar_mensalides_pck.vector_mensalidade_seg_w')::vector_1[index_w].record_mensalidade_seg.nr_sequencia,1,nm_usuario_p);
				end if;

				if (qt_idade_ant_w > coalesce(current_setting('pls_criticar_mensalides_pck.vector_mensalidade_seg_w')::vector_1[index_w].record_mensalidade_seg.qt_idade,0)) then
					CALL pls_criticar_mensalides_pck.insert_critica_mens_segurado(current_setting('pls_criticar_mensalides_pck.vector_mensalidade_seg_w')::vector_1[index_w].record_mensalidade_seg.nr_sequencia,2,nm_usuario_p);
				end if;
			end if;

		end if;
		end;
	end loop;

	end;


$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_criticar_mensalides_pck.generate_criticas_mensalides (nm_usuario_p text) FROM PUBLIC;
