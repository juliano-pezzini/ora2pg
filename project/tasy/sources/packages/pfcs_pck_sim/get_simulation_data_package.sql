-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pfcs_pck_sim.get_simulation_data ( cd_establishment_p bigint, nr_hour_p bigint, cd_type_p bigint, cd_unit_classification_p text, cd_unit_p text, ie_std_deviation_p text ) RETURNS varchar AS $body$
DECLARE

        vl_simulation_w         integer;
        vl_std_deviation_w      integer;
        nr_hour_w               integer;
        dt_simulation_w         timestamp;

BEGIN
        PERFORM set_config('pfcs_pck_sim.ds_sim_value_w', null, false);
        vl_simulation_w := 0;
        vl_std_deviation_w := 0;
        nr_hour_w := to_number(to_char((clock_timestamp() + (nr_hour_p/24)), PFCS_PCK_CONSTANTS.CD_MASK_HH24));
        dt_simulation_w := trunc(clock_timestamp() + (nr_hour_p/24));

        if (cd_type_p IS NOT NULL AND cd_type_p::text <> '')  then
            select coalesce(
                case cd_type_p
                    when current_setting('pfcs_pck_sim.cd_pred_capacity_w')::smallint then sum(sim.nr_mean_pred_capacity)
                    when current_setting('pfcs_pck_sim.cd_pred_arrival_w')::smallint then sum(sim.nr_mean_pred_arrival)
                    when current_setting('pfcs_pck_sim.cd_pred_discharges_w')::smallint then sum(sim.nr_mean_pred_discharges)
                    else null
                end,
            0),
            coalesce(
                case cd_type_p
                    when current_setting('pfcs_pck_sim.cd_pred_capacity_w')::smallint then avg(sim.nr_sd_pred_capacity)
                    when current_setting('pfcs_pck_sim.cd_pred_arrival_w')::smallint then avg(sim.nr_sd_pred_arrival)
                    when current_setting('pfcs_pck_sim.cd_pred_discharges_w')::smallint then avg(sim.nr_sd_pred_discharges)
                    else null
                end,
            0) into STRICT vl_simulation_w, vl_std_deviation_w
            from pfcs_patient_simulation sim,
                setor_atendimento sec
            where sim.dt_simulation = dt_simulation_w
                and sim.hr_time_simulation = nr_hour_w
                and ( (cd_unit_classification_p = PFCS_PCK_CONSTANTS.CD_HOSPITAL_OCCUPANCY and sec.ie_ocup_hospitalar <> PFCS_PCK_CONSTANTS.IE_NO)
                        or coalesce(cd_unit_classification_p::text, '') = ''
                        or sim.cd_classif_setor = cd_unit_classification_p)
                and (coalesce(cd_unit_p::text, '') = '' or sim.cd_unit = cd_unit_p)
                and sim.cd_estabelecimento = cd_establishment_p
                and sec.cd_setor_atendimento = isnumber(sim.cd_unit);
        end if;

        PERFORM set_config('pfcs_pck_sim.ds_sim_value_w', to_char(vl_simulation_w), false);
        if (ie_std_deviation_p = PFCS_PCK_CONSTANTS.IE_YES) then
            PERFORM set_config('pfcs_pck_sim.ds_sim_value_w', current_setting('pfcs_pck_sim.ds_sim_value_w')::varchar(80) || PFCS_PCK_CONSTANTS.DS_SEMICOLON || vl_std_deviation_w, false);
        end if;
        return current_setting('pfcs_pck_sim.ds_sim_value_w')::varchar(80);
    END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pfcs_pck_sim.get_simulation_data ( cd_establishment_p bigint, nr_hour_p bigint, cd_type_p bigint, cd_unit_classification_p text, cd_unit_p text, ie_std_deviation_p text ) FROM PUBLIC;
