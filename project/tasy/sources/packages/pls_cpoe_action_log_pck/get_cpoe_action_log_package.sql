-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pls_cpoe_action_log_pck.get_cpoe_action_log (nr_atendimento_p cpoe_action_log_v.nr_atendimento%type, cd_pessoa_fisica_p cpoe_action_log_v.cd_pessoa_fisica%type, qt_referencia_p cpoe_action_log_v.nr_atendimento%type) RETURNS SETOF T_CPOE_ACTION_LOG AS $body$
DECLARE

    c01_cpoe_action_log CURSOR FOR
                 SELECT * from (
                SELECT  nr_sequencia,
                replace(replace(ds_item,lower('<del>'),''),lower('</del>'),'') || '<br> <span class="ds_material_prescritor">'|| obter_med_simult(cd_pessoa_fisica,nm_maquina,cd_maquina_ip) || '</span> <span class="ds_material_data">' || to_char(dt_atualizacao_nrec, obter_desc_mascara(34, 'dd/MM/yyyy hh24:mi'))
                || ' - '|| coalesce(GET_TERMINAL_INF_CPOE_ACT_LOG(ds_sigla,nr_sequencia, nm_usuario, dt_atualizacao_nrec), '')
                || '</span>' ds_item, 
                trunc(dt_liberacao, 'mi') dt_liberacao,
                 trunc(dt_suspensao, 'mi') dt_suspensao,
                 trunc(dt_atualizacao_nrec, 'mi') dt_atualizacao_nrec,
                 trunc(dt_lib_suspensao, 'mi') dt_lib_suspensao,
                 nm_usuario,
                 nr_seq_cpoe_anterior,
                 nr_seq_grid_cpoe,
                 'A' ie_status,
                 obter_nome_usuario(nm_usuario) nm_comp_usuario,
                 ds_sigla
                FROM	cpoe_action_log_v
                WHERE ((nr_atendimento = nr_atendimento_p) OR (coalesce(nr_atendimento::text, '') = '' 
                    AND	cd_pessoa_fisica = cd_pessoa_fisica_p))
                and coalesce(nr_seq_cpoe_anterior::text, '') = ''
                and  dt_atualizacao_nrec > (clock_timestamp() - qt_referencia_p)
                and  (dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
                and  coalesce(dt_lib_suspensao::text, '') = ''
                
                
UNION ALL

                SELECT  a.nr_sequencia,	
                 a.ds_item || '<br> <span class="ds_material_prescritor">'|| obter_med_simult(cd_pessoa_fisica,nm_maquina,cd_maquina_ip) || '</span> <span class="ds_material_data">' || to_char(dt_atualizacao_nrec, obter_desc_mascara(34, 'dd/MM/yyyy hh24:mi')) 
                 || '</span>' ds_item,
                 trunc(a.dt_liberacao, 'mi') dt_liberacao,
                 trunc(a.dt_suspensao, 'mi') dt_suspensao,
                 trunc(a.dt_atualizacao_nrec, 'mi') dt_atualizacao_nrec,
                 trunc(a.dt_lib_suspensao, 'mi') dt_lib_suspensao,
                 a.nm_usuario,
                 a.nr_seq_cpoe_anterior,
                 a.nr_seq_grid_cpoe,
                 'S' ie_status,
                 obter_nome_usuario(nm_usuario) nm_comp_usuario,
                 ds_sigla
                FROM	cpoe_action_log_v a
                WHERE ((nr_atendimento = nr_atendimento_p) OR (coalesce(nr_atendimento::text, '') = '' 
                    AND	cd_pessoa_fisica = cd_pessoa_fisica_p))
                and  a.dt_atualizacao_nrec > (clock_timestamp() - qt_referencia_p)
                and coalesce(a.dt_suspensao,a.dt_fim) < clock_timestamp()
                and (a.dt_lib_suspensao IS NOT NULL AND a.dt_lib_suspensao::text <> '')
                and  (a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
                and  not exists (SELECT 1 FROM	cpoe_action_log_v b WHERE b.nr_atendimento = a.nr_atendimento AND	b.nr_seq_cpoe_anterior = a.nr_sequencia) 
                
UNION ALL

                SELECT  nr_sequencia,	
                 ds_item || '<br> <span class="ds_material_prescritor">'|| obter_med_simult(cd_pessoa_fisica,nm_maquina,cd_maquina_ip) || '</span> <span class="ds_material_data">' || to_char(dt_atualizacao_nrec, obter_desc_mascara(34, 'dd/MM/yyyy hh24:mi')) 
                 || ' - '|| coalesce(GET_TERMINAL_INF_CPOE_ACT_LOG(ds_sigla,nr_sequencia, nm_usuario, dt_atualizacao_nrec), '')
                 || '</span>' ds_item,
                 trunc(dt_liberacao, 'mi') dt_liberacao,
                 trunc(dt_suspensao, 'mi') dt_suspensao,
                 trunc(dt_atualizacao_nrec, 'mi') dt_atualizacao_nrec,
                 trunc(dt_lib_suspensao, 'mi') dt_lib_suspensao,
                 nm_usuario,
                 nr_seq_cpoe_anterior,
                 nr_seq_grid_cpoe,
                 'M' ie_status,
                 obter_nome_usuario(nm_usuario) nm_comp_usuario,
                 ds_sigla
                FROM	cpoe_action_log_v
                WHERE ((nr_atendimento = nr_atendimento_p) OR (coalesce(nr_atendimento::text, '') = '' AND	cd_pessoa_fisica = cd_pessoa_fisica_p))
                and (nr_seq_cpoe_anterior IS NOT NULL AND nr_seq_cpoe_anterior::text <> '')
                and  dt_atualizacao_nrec > (clock_timestamp() - qt_referencia_p)
                and  (dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
                
UNION ALL

                SELECT  nr_sequencia,
                 ds_item || '<br> <span class="ds_material_prescritor">'||  OBTER_NOME_PESSOA_FISICA(cd_medico,null) ||'</span>' || '<span class="ds_material_data">' || to_char(DT_CIENCIA_MEDICO, obter_desc_mascara(34, 'dd/MM/yyyy hh24:mi')) 
                 || ' - '|| coalesce(GET_TERMINAL_INF_CPOE_ACT_LOG(ds_sigla,nr_sequencia, nm_usuario, dt_atualizacao_nrec), '')
                 || '</span>' ds_item,
                 trunc(dt_liberacao, 'mi') dt_liberacao,
                 trunc(dt_suspensao, 'mi') dt_suspensao,
                 trunc(dt_atualizacao_nrec, 'mi') dt_atualizacao_nrec,
                 trunc(dt_lib_suspensao, 'mi') dt_lib_suspensao,
                 nm_usuario,
                 nr_seq_cpoe_anterior,
                 nr_seq_grid_cpoe,
                 'O' ie_status,
                 OBTER_NOME_PESSOA_FISICA(cd_medico,null) nm_comp_usuario,
                 ds_sigla
                FROM	cpoe_action_log_v
                WHERE ((nr_atendimento = nr_atendimento_p) OR (coalesce(nr_atendimento::text, '') = '' 
                AND	cd_pessoa_fisica = cd_pessoa_fisica_p)) 
                and  dt_atualizacao_nrec > (clock_timestamp() - qt_referencia_p) and (cd_medico IS NOT NULL AND cd_medico::text <> '') and IE_EXIGE_CIENCIA = 'S' and  (dt_liberacao IS NOT NULL AND dt_liberacao::text <> '') and dt_lib_suspensao is  null and (DT_CIENCIA_MEDICO IS NOT NULL AND DT_CIENCIA_MEDICO::text <> '') and pkg_i18n.get_user_locale() in ('en_AU','de_DE')
                ORDER BY dt_atualizacao_nrec desc,	
                 nm_usuario,
                 nr_seq_grid_cpoe,
                 nr_sequencia desc,
                 ie_status desc) alias81;

    c01_cpoe_action_log_w  c01_cpoe_action_log%rowtype;

    t_cpoe_action_log_row_w  t_cpoe_action_log_row;
    nr_sequencia bigint;

BEGIN

    open c01_cpoe_action_log;
        loop
            fetch c01_cpoe_action_log into c01_cpoe_action_log_w;
            EXIT WHEN NOT FOUND; /* apply on c01_cpoe_action_log */
            t_cpoe_action_log_row_w.nr_sequencia        := C01_CPOE_ACTION_LOG_W.nr_sequencia;
            t_cpoe_action_log_row_w.ds_item             := C01_CPOE_ACTION_LOG_W.ds_item;

            t_cpoe_action_log_row_w.dt_liberacao        := C01_CPOE_ACTION_LOG_W.dt_liberacao;
            t_cpoe_action_log_row_w.dt_suspensao        := C01_CPOE_ACTION_LOG_W.dt_suspensao;
            t_cpoe_action_log_row_w.dt_atualizacao_nrec := C01_CPOE_ACTION_LOG_W.dt_atualizacao_nrec;
            t_cpoe_action_log_row_w.dt_lib_suspensao    := C01_CPOE_ACTION_LOG_W.dt_lib_suspensao;
            t_cpoe_action_log_row_w.nm_usuario          := C01_CPOE_ACTION_LOG_W.nm_usuario;
            t_cpoe_action_log_row_w.nr_seq_cpoe_anterior:= C01_CPOE_ACTION_LOG_W.nr_seq_cpoe_anterior;
            t_cpoe_action_log_row_w.nr_seq_grid_cpoe    := C01_CPOE_ACTION_LOG_W.nr_seq_grid_cpoe;
            t_cpoe_action_log_row_w.ie_status           := C01_CPOE_ACTION_LOG_W.ie_status;
            t_cpoe_action_log_row_w.nm_comp_usuario     := C01_CPOE_ACTION_LOG_W.nm_comp_usuario;
            t_cpoe_action_log_row_w.ds_sigla            := C01_CPOE_ACTION_LOG_W.ds_sigla;

            
            RETURN NEXT t_cpoe_action_log_row_w;
        end loop;
    end;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_cpoe_action_log_pck.get_cpoe_action_log (nr_atendimento_p cpoe_action_log_v.nr_atendimento%type, cd_pessoa_fisica_p cpoe_action_log_v.cd_pessoa_fisica%type, qt_referencia_p cpoe_action_log_v.nr_atendimento%type) FROM PUBLIC;
