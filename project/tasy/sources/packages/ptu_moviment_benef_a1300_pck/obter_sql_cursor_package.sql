-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION ptu_moviment_benef_a1300_pck.obter_sql_cursor (ie_tipo_movimentacao_p ptu_mov_benef_lote.ie_tipo_movimentacao%type) RETURNS varchar AS $body$
DECLARE

		sql_cursor_w		varchar(32000);
	
BEGIN
	
	if (ie_tipo_movimentacao_p in ('A','M')) then
		sql_cursor_w	:=	'	select	a.nr_sequencia,	' ||
					'		a.dt_rescisao,  ' ||
					'		a.dt_contratacao, ' ||
					'		a.cd_pessoa_fisica, ' ||
					'		b.nr_sequencia, ' ||
					'		decode(b.cd_cgc_estipulante,'''',''PF'',''PJ'') ie_tipo_contrato, '||
					'		d.ie_preco,		' ||
					'		a.ie_tipo_segurado,	' ||
					'		''A'' ie_tipo_mov_cadastral, ' ||
					'		b.ie_empresario_individual ' ||
					'	from	pls_segurado 		a,	' ||
					'		pls_contrato		b,	' ||
					'		pls_segurado_carteira	c,	' ||
					'		pls_plano		d	' ||
					'	where	a.nr_seq_contrato	= b.nr_sequencia ' ||
					'	and	c.nr_seq_segurado	= a.nr_sequencia ' ||
					'	and	a.nr_seq_plano		= d.nr_sequencia ' ||
					'	and	a.dt_liberacao is not null ' ||
					'	and	a.dt_cancelamento is null  ' ||
					'	and	a.ie_tipo_segurado	in (''B'',''R'') ' ||
					'	and	b.cd_estabelecimento	= :cd_estabelecimento ' ||
					'	and	a.dt_contratacao	<= :dt_fim ';
	elsif (ie_tipo_movimentacao_p = 'P') then
		sql_cursor_w	:=	'	select	a.nr_sequencia,	' ||
					'		a.dt_rescisao,  ' ||
					'		a.dt_contratacao, ' ||
					'		a.cd_pessoa_fisica, ' ||
					'		b.nr_sequencia, ' ||
					'		decode(b.cd_cgc_estipulante,'''',''PF'',''PJ'') ie_tipo_contrato, '||
					'		'''' ie_preco,		' ||
					'		a.ie_tipo_segurado,	' ||
					'		''I'' ie_tipo_mov_cadastral, ' ||
					'		b.ie_empresario_individual ' ||
					'	from	pls_segurado 		a,	' ||
					'		pls_contrato		b,	' ||
					'		pls_segurado_carteira	c	' ||
					'	where	a.nr_seq_contrato	= b.nr_sequencia ' ||
					'	and	c.nr_seq_segurado	= a.nr_sequencia ' ||
					'	and	a.dt_liberacao is not null ' ||
					'	and	a.dt_cancelamento is null  ' ||
					'	and	a.ie_tipo_segurado	in (''B'',''R'') ' ||
					'	and	a.dt_contratacao between :dt_inicio AND :dt_fim ' ||
					'	and	((trunc(a.dt_contratacao,''month'') <> trunc(a.dt_rescisao,''month'') and a.dt_rescisao is not null) or a.dt_rescisao is null) ' ||
					'	and	b.cd_estabelecimento	= :cd_estabelecimento ' ||
					'	union ' ||
					'	select	a.nr_sequencia,	' ||
					'		a.dt_rescisao,  ' ||
					'		a.dt_reativacao, ' ||
					'		a.cd_pessoa_fisica, ' ||
					'		b.nr_sequencia, ' ||
					'		decode(b.cd_cgc_estipulante,'''',''PF'',''PJ'') ie_tipo_contrato, '|| 
					'		'''' ie_preco,		' ||
					'		a.ie_tipo_segurado,	' ||
					'		''I'' ie_tipo_mov_cadastral, ' ||
					'		b.ie_empresario_individual ' ||
					'	from	pls_segurado 		a,	' ||
					'		pls_contrato		b,	' ||
					'		pls_segurado_carteira	c	' ||
					'	where	a.nr_seq_contrato	= b.nr_sequencia ' ||
					'	and	c.nr_seq_segurado	= a.nr_sequencia ' ||
					'	and	a.dt_liberacao is not null ' ||
					'	and	a.dt_cancelamento is null  ' ||
					'	and	a.ie_tipo_segurado	in (''B'',''R'') ' ||
					'	and	a.dt_reativacao is not null ' ||
					'	and	a.dt_reativacao between :dt_inicio AND :dt_fim ' ||
					'	and	b.cd_estabelecimento	= :cd_estabelecimento '||	
					'	union all ' ||
					'	select	a.nr_sequencia,	' ||
					'		a.dt_rescisao,  ' ||
					'		a.dt_contratacao, ' ||
					'		a.cd_pessoa_fisica, ' ||
					'		b.nr_sequencia, ' ||
					'		decode(b.cd_cgc_estipulante,'''',''PF'',''PJ'') ie_tipo_contrato, '|| 
					'		'''' ie_preco,		' ||
					'		a.ie_tipo_segurado,	' ||
					'		''E'' ie_tipo_mov_cadastral, ' ||
					'		b.ie_empresario_individual ' ||
					'	from	pls_segurado 		a,	' ||
					'		pls_contrato		b,	' ||
					'		pls_segurado_carteira	c	' ||
					'	where	a.nr_seq_contrato	= b.nr_sequencia ' ||
					'	and	c.nr_seq_segurado	= a.nr_sequencia ' ||
					'	and	a.dt_liberacao is not null ' ||
					'	and	a.dt_cancelamento is null  ' ||
					'	and	a.ie_tipo_segurado	in (''B'',''R'') ' ||
					'	and	a.dt_rescisao between :dt_inicio AND :dt_fim ' ||
					'	and	(trunc(a.dt_contratacao,''month'') <> trunc(a.dt_rescisao,''month'') and a.dt_rescisao is not null) '||
					'	and	b.cd_estabelecimento	= :cd_estabelecimento ' ||
					'	union all ' ||
					'	select	a.nr_sequencia,	' ||
					'		a.dt_rescisao,  ' ||
					'		a.dt_contratacao, ' ||
					'		a.cd_pessoa_fisica, ' ||
					'		b.nr_sequencia, ' ||
					'		decode(b.cd_cgc_estipulante,'''',''PF'',''PJ'') ie_tipo_contrato, '|| 
					'		'''' ie_preco,		' ||
					'		a.ie_tipo_segurado,	' ||
					'		''A'' ie_tipo_mov_cadastral, ' ||
					'		b.ie_empresario_individual ' ||
					'	from	pls_segurado 		a,	' ||
					'		pls_contrato		b,	' ||
					'		pls_pessoa_fisica_sib	c,	' ||
					'		pls_segurado_carteira	d	' ||
					'	where	a.nr_seq_contrato	= b.nr_sequencia ' ||
					'	and	c.cd_pessoa_fisica	= a.cd_pessoa_fisica ' ||
					'	and	d.nr_seq_segurado	= a.nr_sequencia ' ||
					'	and	a.dt_liberacao is not null ' ||
					'	and	a.dt_cancelamento is null  ' ||
					'	and	((a.dt_rescisao is null) or (a.dt_rescisao > :dt_fim)) ' ||
					'	and	a.ie_tipo_segurado	in (''B'',''R'') ' ||
					'	and	c.dt_ocorrencia_sib between :dt_inicio AND :dt_fim ' ||
					'	and	b.cd_estabelecimento	= :cd_estabelecimento ' ||
					'	union all ' ||
					'	select	a.nr_sequencia, ' ||
					'		a.dt_rescisao, ' ||
					'		a.dt_contratacao, ' ||
					'		a.cd_pessoa_fisica, ' ||
					'		d.nr_sequencia, '||
					'		decode(d.cd_cgc_estipulante,'''',''PF'',''PJ'') ie_tipo_contrato, '||
					'		'''' ie_preco, ' ||
					'		a.ie_tipo_segurado,	' ||
					'		''A'' ie_tipo_mov_cadastral, ' ||
					'		d.ie_empresario_individual ' ||
					'	from	pls_carteira_vencimento b, ' ||
					'		pls_segurado_carteira c, ' ||
					'		pls_segurado a, ' ||
					'		pls_contrato d ' ||
					'	where	b.nr_seq_seg_carteira = c.nr_sequencia ' ||
					'	and     c.nr_seq_segurado = a.nr_sequencia ' ||
					'	and	d.nr_sequencia = a.nr_seq_contrato ' ||
					'	and	a.dt_cancelamento is null  ' ||
					'	and	a.ie_tipo_segurado in (''B'',''R'') ' ||
					'	and     b.dt_atualizacao between  :dt_inicio AND :dt_fim ' ||
					'	and     a.cd_estabelecimento = :cd_estabelecimento ' ||
					'	union all ' ||
					'	select	a.nr_sequencia, ' ||
					'		a.dt_rescisao, ' ||
					'		a.dt_contratacao, ' ||
					'		a.cd_pessoa_fisica, ' ||
					'		d.nr_sequencia, '||
					'		decode(d.cd_cgc_estipulante,'''',''PF'',''PJ'') ie_tipo_contrato, '||
					'		'''' ie_preco, ' ||
					'		a.ie_tipo_segurado,	' ||
					'		''A'' ie_tipo_mov_cadastral, ' ||
					'		d.ie_empresario_individual ' ||
					'	from	pls_segurado_cart_ant c, ' ||
					'		pls_segurado a, ' ||
					'		pls_contrato d ' ||
					'	where	c.nr_seq_segurado = a.nr_sequencia ' ||
					'	and	d.nr_sequencia = a.nr_seq_contrato ' ||
					'	and	a.dt_cancelamento is null  ' ||
					'	and	a.ie_tipo_segurado in (''B'',''R'') ' ||
					'	and     c.dt_alteracao between  :dt_inicio AND :dt_fim ' ||
					'	and	c.ie_status_carteira = ''P'' ' ||
					'	and     a.cd_estabelecimento = :cd_estabelecimento ' ||
					'	union all ' ||
					'	select	a.nr_sequencia,	' ||
					'		a.dt_rescisao,  ' ||
					'		a.dt_contratacao, ' ||
					'		a.cd_pessoa_fisica, ' ||
					'		b.nr_sequencia, ' ||
					'		decode(b.cd_cgc_estipulante,'''',''PF'',''PJ'') ie_tipo_contrato, '|| 
					'		'''' ie_preco,		' ||
					'		a.ie_tipo_segurado,	' ||
					'		''A'' ie_tipo_mov_cadastral, ' ||
					'		b.ie_empresario_individual ' ||
					'	from	pls_segurado 		a,	' ||
					'		pls_contrato		b,	' ||
					'		pls_segurado_alt_plano	c	' ||
					'	where	a.nr_seq_contrato	= b.nr_sequencia ' ||
					'	and	c.nr_seq_segurado	= a.nr_sequencia ' ||					
					'	and	a.dt_liberacao is not null ' ||
					'	and	a.dt_cancelamento is null  ' ||					
					'	and	a.ie_tipo_segurado	in (''B'',''R'') ' ||
					'	and	c.dt_alteracao between :dt_inicio AND :dt_fim ' ||
					'	and	b.cd_estabelecimento	= :cd_estabelecimento ' ||
					'	union all ' ||
					'	select	a.nr_sequencia, ' ||
					'		a.dt_rescisao,  ' ||
					'		a.dt_contratacao, ' ||
					'		a.cd_pessoa_fisica, ' ||
					'		b.nr_sequencia, ' ||
					'		decode(b.cd_cgc_estipulante,'''',''PF'',''PJ'') ie_tipo_contrato, '|| 
					'		'''' ie_preco,		' ||
					'		a.ie_tipo_segurado,	' ||
					'		''A'' ie_tipo_mov_cadastral, ' ||
					'		b.ie_empresario_individual ' ||
					'	from	pls_segurado 		a,	' ||
					'		pls_contrato		b,	' ||
					'		pls_segurado_repasse	c	' ||
					'	where	a.nr_seq_contrato	= b.nr_sequencia ' ||
					'	and	a.dt_liberacao is not null ' ||
					'	and	c.dt_liberacao is not null ' ||
					'	and	c.nr_seq_segurado 	= a.nr_sequencia ' ||
					'	and	a.dt_cancelamento is null  ' ||
					'	and	a.ie_tipo_segurado in (''B'',''R'') ' ||
					'	and	b.cd_estabelecimento	= :cd_estabelecimento ';
		if (current_setting('ptu_moviment_benef_a1300_pck.ie_gerar_liberacao_a100_w')::pls_parametros.ie_gerar_liberacao_a100%type = 'S') then
			sql_cursor_w := sql_cursor_w ||	'	and c.dt_liberacao between :dt_inicio AND :dt_fim ';
		else
			sql_cursor_w := sql_cursor_w ||	'	and c.dt_repasse between :dt_inicio AND :dt_fim ';
		end if;
	elsif (ie_tipo_movimentacao_p = 'E') then
		sql_cursor_w	:= 	'	select	a.nr_sequencia,	' ||
					'		a.dt_rescisao,  ' ||
					'		a.dt_contratacao, ' ||
					'		a.cd_pessoa_fisica, ' ||
					'		b.nr_sequencia, ' ||
					'		decode(b.cd_cgc_estipulante,'''',''PF'',''PJ'') ie_tipo_contrato, '||
					'		'''' ie_preco,		' ||
					'		a.ie_tipo_segurado,	' ||
					'		''E'' ie_tipo_mov_cadastral, ' ||
					'		b.ie_empresario_individual ' ||
					'	from	pls_segurado 		a,	' ||
					'		pls_contrato		b,	' ||
					'		pls_segurado_carteira	c	' ||
					'	where	a.nr_seq_contrato	= b.nr_sequencia ' ||
					'	and	c.nr_seq_segurado	= a.nr_sequencia ' ||
					'	and	a.dt_liberacao is not null ' ||
					'	and	a.dt_cancelamento is null  ' ||
					'	and	a.ie_tipo_segurado	in (''B'',''R'') ' ||
					'	and	a.dt_rescisao between :dt_inicio AND :dt_fim ' ||
					'	and	(trunc(a.dt_contratacao,''month'') <> trunc(a.dt_rescisao,''month'') and a.dt_rescisao is not null) '||
					'	and	b.cd_estabelecimento	= :cd_estabelecimento ';
	end if;
	
	return sql_cursor_w;
	end;
	

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION ptu_moviment_benef_a1300_pck.obter_sql_cursor (ie_tipo_movimentacao_p ptu_mov_benef_lote.ie_tipo_movimentacao%type) FROM PUBLIC;
