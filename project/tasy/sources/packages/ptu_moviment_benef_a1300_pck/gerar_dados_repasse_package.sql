-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE ptu_moviment_benef_a1300_pck.gerar_dados_repasse ( pls_segurado_w pls_segurado_w_record, cd_unimed_p text) AS $body$
DECLARE

	
	nr_cartao_intercambio_w		pls_segurado_carteira.nr_cartao_intercambio%type;
	ie_gerar_repasse_w		varchar(1);
	
	C01 CURSOR(	nr_seq_segurado_pc	pls_segurado.nr_sequencia%type) FOR
		SELECT	a.dt_repasse,
			a.ie_tipo_repasse,
			a.dt_fim_repasse,
			coalesce(a.nr_seq_congenere_atend,a.nr_seq_congenere) nr_seq_congenere,
			a.ie_tipo_compartilhamento,
			a.nr_cartao_intercambio
		from	pls_segurado_repasse	a
		where	a.nr_seq_segurado	= nr_seq_segurado_pc
		and	(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '');
		
	
BEGIN
	
	for i in pls_segurado_w.nr_seq_segurado.first..pls_segurado_w.nr_seq_segurado.count loop
		begin
		
		for r_c01_w in C01(pls_segurado_w.nr_seq_segurado(i)) loop
			begin
			ie_gerar_repasse_w	:= 'S';
			
			if	((r_c01_w.ie_tipo_compartilhamento = 1) and (r_c01_w.ie_tipo_repasse = 'P') and (coalesce(r_c01_w.nr_cartao_intercambio::text, '') = '')) then
				ie_gerar_repasse_w	:= 'N';
			end if;
			
			if	((coalesce(r_c01_w.dt_fim_repasse,clock_timestamp()) >= clock_timestamp()) and (ie_gerar_repasse_w = 'S')) then
				insert into ptu_mov_benef_seg_repasse(	nr_sequencia, dt_atualizacao, nm_usuario, dt_atualizacao_nrec, nm_usuario_nrec,
						nr_seq_mov_segurado, cd_unimed_destino, cd_unimed_origem,
						dt_repasse, ie_tipo_repasse, dt_fim_repasse,
						dt_comp_risco, ie_tipo_compartilhamento, nr_cartao_intercambio)
				values (	nextval('ptu_mov_benef_seg_repasse_seq'), clock_timestamp(), get_nm_usuario, clock_timestamp(), get_nm_usuario,
						pls_segurado_w.nr_seq_mov_benef_seg(i), substr(pls_obter_dados_cooperativa(r_c01_w.nr_seq_congenere,'C'),1,4),cd_unimed_p,
						r_c01_w.dt_repasse, r_c01_w.ie_tipo_repasse, r_c01_w.dt_fim_repasse,
						r_c01_w.dt_repasse, r_c01_w.ie_tipo_compartilhamento, r_c01_w.nr_cartao_intercambio);
				
				PERFORM set_config('ptu_moviment_benef_a1300_pck.qt_total_r307_w', current_setting('ptu_moviment_benef_a1300_pck.qt_total_r307_w')::ptu_mov_benef_trailer.qt_total_r307%type + 1, false);
			end if;
			end;
		end loop; --C01
		
		end;
	end loop;
	
	end;
	

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ptu_moviment_benef_a1300_pck.gerar_dados_repasse ( pls_segurado_w pls_segurado_w_record, cd_unimed_p text) FROM PUBLIC;
