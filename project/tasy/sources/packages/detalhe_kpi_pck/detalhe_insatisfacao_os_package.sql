-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

--################################################################################################################################################
CREATE OR REPLACE FUNCTION detalhe_kpi_pck.detalhe_insatisfacao_os () RETURNS SETOF T_DETALHE AS $body$
DECLARE

	
	t_detalhe_row_w	t_detalhe_row;	

	c01 CURSOR FOR
	SELECT	a.nr_sequencia,
		b.ds_dano_breve	
	from	os_insatisfacao_gerencia_v a,
		man_ordem_servico b,
		gerencia_wheb g,
		man_localizacao l	
	where	a.nr_seq_gerencia	= g.nr_sequencia
	and	a.nr_sequencia		= b.nr_sequencia
	and	g.nr_seq_diretoria	= nr_seq_diretoria_w
	and	coalesce(nr_seq_diretoria_w,0) > 0
	and	a.nr_seq_localizacao 	= l.nr_sequencia
	and	l.ie_terceiro 		= 'S'
	and	a.dt_fim_real between dt_ref_inicio_w and dt_ref_fim_w
	
union

	SELECT	a.nr_sequencia,
		b.ds_dano_breve	
	from	os_insatisfacao_gerencia_v a,
		man_ordem_servico b,
		gerencia_wheb g,
		man_localizacao l	
	where	a.nr_seq_gerencia	= g.nr_sequencia
	and	a.nr_sequencia		= b.nr_sequencia
	and	coalesce(a.nr_seq_gerencia_insatisf,a.nr_seq_gerencia) = nr_seq_gerencia_w
	and	coalesce(nr_seq_gerencia_w,0) > 0
	and	a.nr_seq_localizacao 	= l.nr_sequencia
	and	l.ie_terceiro 		= 'S'
	and	a.dt_fim_real between dt_ref_inicio_w and dt_ref_fim_w
	
union

	select	a.nr_sequencia,
		b.ds_dano_breve	
	from	os_insatisfacao_gerencia_v a,
		man_ordem_servico b,
		grupo_desenvolvimento c,
		man_localizacao l
	where   a.nr_sequencia		= b.nr_sequencia
	and	a.nr_seq_grupo	 	= nr_seq_grupo_w
	and	coalesce(nr_seq_grupo_w,0) > 0
	and	a.nr_seq_grupo		= c.nr_sequencia
	and	a.nr_seq_gerencia 	= c.nr_seq_gerencia
	and	a.nr_seq_localizacao 	= l.nr_sequencia
	and	l.ie_terceiro 		= 'S'
	and	coalesce(a.nr_seq_gerencia_insatisf, c.nr_seq_gerencia) = c.nr_seq_gerencia
	and	a.dt_fim_real 		between  dt_ref_inicio_w and dt_ref_fim_w	
	
union

	select	a.nr_sequencia,
		a.ds_dano_breve
	from   	man_ordem_servico a,
		grupo_desenvolvimento b,
		usuario_grupo_des g,
		man_ordem_servico_exec c,
		usuario d,
		pessoa_fisica e,
		man_localizacao l
	where  	a.nr_seq_grupo_des	= b.nr_sequencia
	and    	a.nr_sequencia		=  c.nr_seq_ordem
	and    	c.nm_usuario_exec	= d.nm_usuario
	and    	d.cd_pessoa_fisica	= e.cd_pessoa_fisica
	and	a.nr_seq_localizacao 	= l.nr_sequencia
	and	a.ie_grau_satisfacao	in ('P','R') --Ruim, Regular
	and	a.dt_fim_real 		between dt_ref_inicio_w and dt_ref_fim_w
	and    	b.nr_sequencia		= g.nr_seq_grupo
	and	g.nm_usuario_grupo	= d.nm_usuario
	and	e.cd_pessoa_fisica 	= cd_pessoa_fisica_w
	and	coalesce(c.dt_fim_execucao::text, '') = ''
	and	l.ie_terceiro 		= 'S'	
	and      c.nm_usuario_exec    =  (	select   max(k.nm_usuario_exec) nm_usuario_exec
						from     man_ordem_servico_exec k
						where    k.nr_seq_ordem	= a.nr_sequencia
						and exists (	select   1
										from     usuario_grupo_des l
										where    k.nm_usuario_exec = l.nm_usuario_grupo))
	and		(a.ie_grau_satisfacao IS NOT NULL AND a.ie_grau_satisfacao::text <> '')
	and    	exists (select   1
			from    man_estagio_processo c,
				man_ordem_serv_estagio b
			where   b.nr_seq_estagio        = c.nr_sequencia
			and     c.ie_desenv             = 'S'
			and     a.nr_sequencia          = b.nr_seq_ordem)
	and (
			select	max(ie_indicador)
			from	man_grau_satisf_justif
			where	nr_sequencia = a.nr_seq_justif_grau_satisf
		) = 'S';
			
	c01_w	c01%rowtype;
	
	
BEGIN
	
	open C01;
	loop
	fetch C01 into
		c01_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
				
		t_detalhe_row_w.identificador	:= c01_w.nr_sequencia;
		t_detalhe_row_w.descricao	:= c01_w.ds_dano_breve;		
		t_detalhe_row_w.detalhe		:= '';

		RETURN NEXT t_detalhe_row_w;		
	
	end loop;
	close C01;
	
	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION detalhe_kpi_pck.detalhe_insatisfacao_os () FROM PUBLIC;
