-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


	
--################################################################################################################################################	
CREATE OR REPLACE FUNCTION detalhe_kpi_pck.obter_dados ( nr_seq_metrica_p bigint, dt_referencia_p timestamp, nr_seq_diretoria_p bigint, nr_seq_gerencia_p bigint, nr_seq_grupo_p bigint, cd_pessoa_fisica_p text) RETURNS SETOF T_DETALHE AS $body$
DECLARE

				
	t_result_row_w		t_detalhe_row;
	ds_procedure_meta_w	varchar(255);
	
	c01 CURSOR FOR
	SELECT	*
	from	table(detalhe_defeitos)
	where	ds_procedure_meta_w	= 'PPM_METRICA_DEFEITOS'
	
union

	SELECT	*
	from	table(detalhe_retornos_os)
	where	ds_procedure_meta_w	= 'PPM_SO_RETURNS'
	
union

	select	*
	from	table(detalhe_retornos_interno_os)
	where	ds_procedure_meta_w	= 'PPM_SO_INTERNAL_RETURNS'
	
union

	select	*
	from	table(detalhe_reclassificacao_os)
	where	ds_procedure_meta_w	= 'PPM_RECLASSIFICATION'
	
union

	select	*
	from	table(detalhe_hpi_os)
	where	ds_procedure_meta_w	= 'PPM_METRICA_HPI_OS'
	
union

	select	*
	from	table(detalhe_insatisfacao_os)
	where	ds_procedure_meta_w	= 'PPM_METRICA_SATISF_OS'
	
union

	select	*
	from	table(detalhe_hpi_proj)
	where	ds_procedure_meta_w	= 'PPM_METRICA_HPI'
	
union

	select	*
	from	table(detalhe_spi_proj)
	where	ds_procedure_meta_w	= 'PPM_METRICA_SPI'
	
union

	select	*
	from	table(detalhe_incidental_build)
	where	ds_procedure_meta_w	= 'PPM_METRICA_INC_BUILD'
	
union

	select	*
	from	table(detalhe_kloc)
	where	ds_procedure_meta_w	= 'PPM_METRICA_KLOC';
	
	c01_w	c01%rowtype;

	
BEGIN
	
	PERFORM set_config('detalhe_kpi_pck.nr_seq_metrica_w', nr_seq_metrica_p, false);
	PERFORM set_config('detalhe_kpi_pck.dt_ref_inicio_w', pkg_date_utils.start_of(dt_referencia_p,'MONTH'), false);
	PERFORM set_config('detalhe_kpi_pck.dt_ref_fim_w', pkg_date_utils.end_of(last_day(dt_referencia_p),'DAY'), false);
	PERFORM set_config('detalhe_kpi_pck.nr_seq_diretoria_w', nr_seq_diretoria_p, false);
	PERFORM set_config('detalhe_kpi_pck.nr_seq_gerencia_w', nr_seq_gerencia_p, false);
	PERFORM set_config('detalhe_kpi_pck.nr_seq_grupo_w', nr_seq_grupo_p, false);
	PERFORM set_config('detalhe_kpi_pck.cd_pessoa_fisica_w', cd_pessoa_fisica_p, false);	
	
	select	max(nm_usuario),
		max(obter_cargo_usuario(nm_usuario,'C'))
	into STRICT	current_setting('detalhe_kpi_pck.nm_usuario_exec_w')::varchar(15),
		current_setting('detalhe_kpi_pck.cd_cargo_user_w')::cargo.cd_cargo%type
	from	usuario a
	where	ie_situacao 		= 'A'
	and 	cd_pessoa_fisica	= cd_pessoa_fisica_p;
			
	select	max(nm_procedure)
	into STRICT	ds_procedure_meta_w
	from	ppm_metrica
	where	nr_sequencia	= nr_seq_metrica_p;
		
	open C01;
	loop
	fetch C01 into
		c01_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
	
		t_result_row_w := c01_w;
		RETURN NEXT t_result_row_w;
	end loop;
	close C01;
		
	end;
	
--################################################################################################################################################
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION detalhe_kpi_pck.obter_dados ( nr_seq_metrica_p bigint, dt_referencia_p timestamp, nr_seq_diretoria_p bigint, nr_seq_gerencia_p bigint, nr_seq_grupo_p bigint, cd_pessoa_fisica_p text) FROM PUBLIC;
