-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

--################################################################################################################################################
CREATE OR REPLACE FUNCTION detalhe_kpi_pck.detalhe_hpi_os () RETURNS SETOF T_DETALHE AS $body$
DECLARE

	
	t_detalhe_row_w	t_detalhe_row;	
	--Diretoria
	c01 CURSOR FOR
	SELECT	a.nr_sequencia,
		a.ds_dano_breve,		
		sum(c.qt_min_prev) qt_min_prev,
		sum((SELECT sum(d.qt_minuto) from man_ordem_serv_ativ d where a.nr_sequencia = d.nr_Seq_ordem_serv and c.nm_usuario_exec = d.nm_usuario_exec)) qt_real
	from	man_ordem_servico a,
		MAN_ORDEM_SERVICO_EXEC c,
		grupo_desenvolvimento d,
		gerencia_wheb g
	where	a.nr_Sequencia 		= c.nr_Seq_ordem
	and	a.nr_seq_grupo_des 	= d.nr_sequencia
	and	d.nr_seq_gerencia	= g.nr_sequencia
	and	g.nr_seq_diretoria	= nr_seq_diretoria_w
	and	coalesce(c.qt_min_prev,0) > 0
	and	a.ie_classificacao <> 'E'
	and	a.ie_status_ordem = '3'
	and	coalesce(a.cd_funcao,0) <> -3001
	and	coalesce(c.ie_considera_hpi,'S') = 'S'
	and	coalesce(a.nr_seq_proj_cron_etapa::text, '') = ''
	and	coalesce(a.nr_seq_projeto::text, '') = ''
	and	a.dt_fim_real between dt_ref_inicio_w and dt_ref_fim_w
	and	obter_cargo_usuario(c.nm_usuario_exec,'C') in ('66','69','73','133','1379') --Executadas por programador
	and	obter_cargo_usuario(c.nm_usuario_prev,'C') in ('61','62','113','221','1354','1380','371','1393','1428','1430') --prevista por Analista	
	and	exists (select 	1
			from	man_ordem_serv_ativ e 
			where	a.nr_sequencia = e.nr_Seq_ordem_serv 
			and	c.nm_usuario_exec = e.nm_usuario_exec
			and	coalesce(e.qt_minuto,0) > 0) 
	group by a.nr_sequencia, a.ds_dano_breve			
	
union
  --Gerencia
	select	a.nr_sequencia,
		a.ds_dano_breve,
		sum(c.qt_min_prev) qt_min_prev,
		sum((select sum(d.qt_minuto) from man_ordem_serv_ativ d where a.nr_sequencia = d.nr_Seq_ordem_serv and c.nm_usuario_exec = d.nm_usuario_exec)) qt_real
	from	man_ordem_servico a,
		MAN_ORDEM_SERVICO_EXEC c,
		grupo_desenvolvimento d
	where	a.nr_Sequencia 		= c.nr_Seq_ordem
	and	a.nr_seq_grupo_des 	= d.nr_sequencia
	and	d.nr_seq_gerencia	= nr_seq_gerencia_w
	and	coalesce(c.qt_min_prev,0) > 0
	and	a.ie_classificacao <> 'E'
	and	a.ie_status_ordem = '3'
	and	coalesce(a.cd_funcao,0) <> -3001
	and	coalesce(c.ie_considera_hpi,'S') = 'S'
	and	coalesce(a.nr_seq_proj_cron_etapa::text, '') = ''
	and	coalesce(a.nr_seq_projeto::text, '') = ''
	and	a.dt_fim_real between dt_ref_inicio_w and dt_ref_fim_w
	and	obter_cargo_usuario(c.nm_usuario_exec,'C') in ('66','69','73','133','1379') --Executadas por programador
	and	obter_cargo_usuario(c.nm_usuario_prev,'C') in ('61','62','113','221','1354','1380','371','1393','1428','1430') --prevista por Analista	
	and	exists (select 	1 
			from	man_ordem_serv_ativ e 
			where	a.nr_sequencia = e.nr_Seq_ordem_serv 
			and	c.nm_usuario_exec = e.nm_usuario_exec
			and	coalesce(e.qt_minuto,0) > 0) 
	group by a.nr_sequencia, a.ds_dano_breve		
	
union
  --Grupo
	select	a.nr_sequencia,
		a.ds_dano_breve,
		sum(c.qt_min_prev) qt_min_prev,
		sum((select sum(d.qt_minuto) from man_ordem_serv_ativ d where a.nr_sequencia = d.nr_Seq_ordem_serv and c.nm_usuario_exec = d.nm_usuario_exec)) qt_real
	from	man_ordem_servico a,
		MAN_ORDEM_SERVICO_EXEC c
	where	a.nr_Sequencia = c.nr_Seq_ordem
	and	coalesce(c.qt_min_prev,0) > 0
	and	a.ie_classificacao <> 'E'
	and	a.ie_status_ordem = '3'
	and	coalesce(coalesce(a.cd_funcao,0),0) <> -3001
	and	coalesce(c.ie_considera_hpi,'S') = 'S'
	and	coalesce(a.nr_seq_proj_cron_etapa::text, '') = ''
	and	coalesce(a.nr_seq_projeto::text, '') = ''
	and	a.dt_fim_real between dt_ref_inicio_w and dt_ref_fim_w
	and	a.nr_seq_grupo_des = nr_seq_grupo_w
	and	obter_cargo_usuario(c.nm_usuario_exec,'C') in ('66','69','73','133','1379') --Executadas por programador
	and	obter_cargo_usuario(c.nm_usuario_prev,'C') in ('61','62','113','221','1354','1380','371','1393','1428','1430') --prevista por Analista	
	and	exists (select 	1 
			from	man_ordem_serv_ativ e 
			where	a.nr_sequencia = e.nr_Seq_ordem_serv 
			and	c.nm_usuario_exec = e.nm_usuario_exec
			and	coalesce(e.qt_minuto,0) > 0) 
	group by a.nr_sequencia	,a.ds_dano_breve
	
union
  --Pessoa programadores
	select	a.nr_sequencia,
		a.ds_dano_breve,
		sum(c.qt_min_prev) qt_min_prev,
		sum((select sum(d.qt_minuto) from man_ordem_serv_ativ d where a.nr_sequencia = d.nr_Seq_ordem_serv and c.nm_usuario_exec = d.nm_usuario_exec)) qt_real	
	from	man_ordem_servico a,
		MAN_ORDEM_SERVICO_EXEC c
	where	a.nr_Sequencia = c.nr_Seq_ordem
	and	coalesce(c.qt_min_prev,0) > 0
	and	a.ie_classificacao <> 'E'
	and	a.ie_status_ordem = '3'
	and	a.cd_funcao <> -3001
	and	coalesce(c.ie_considera_hpi,'S') = 'S'
	and	coalesce(a.nr_seq_proj_cron_etapa::text, '') = ''
	and	coalesce(a.nr_seq_projeto::text, '') = ''
	and	a.dt_fim_real between dt_ref_inicio_w and dt_ref_fim_w
	and	c.nm_usuario_exec = nm_usuario_exec_w
	and	cd_cargo_user_w in ('66','69','73','133','1379') --Programadores
	and	exists (select 1 
			from	man_ordem_serv_ativ e 
			where	a.nr_sequencia = e.nr_Seq_ordem_serv 
			and	c.nm_usuario_exec = e.nm_usuario_exec
			and	coalesce(e.qt_minuto,0) > 0)
	group by a.nr_sequencia, a.ds_dano_breve
	
union
  --Pessoa analistas
	select	a.nr_sequencia,
		a.ds_dano_breve,
		sum(c.qt_min_prev) qt_min_prev,
		sum((select sum(d.qt_minuto) from man_ordem_serv_ativ d where a.nr_sequencia = d.nr_Seq_ordem_serv and c.nm_usuario_exec = d.nm_usuario_exec)) qt_real	
	from	man_ordem_servico a,
		MAN_ORDEM_SERVICO_EXEC c
	where	a.nr_Sequencia = c.nr_Seq_ordem
	and	coalesce(c.qt_min_prev,0) > 0
	and	a.ie_classificacao <> 'E'
	and	a.ie_status_ordem = '3'
	and	a.cd_funcao <> -3001
	and	coalesce(c.ie_considera_hpi,'S') = 'S'
	and	coalesce(a.nr_seq_proj_cron_etapa::text, '') = ''
	and	coalesce(a.nr_seq_projeto::text, '') = ''
	and	a.dt_fim_real between dt_ref_inicio_w and dt_ref_fim_w
	and	c.nm_usuario_prev = nm_usuario_exec_w
	and	obter_cargo_usuario(c.nm_usuario_exec,'C') in ('66','69','73','133','1379') --Executadas por programador
	and	cd_cargo_user_w in ('61','62','113','221','1354','1380','371','1393','1428','1430') --prevista por Analista	
	and	exists (select 1 
			from	man_ordem_serv_ativ e 
			where	a.nr_sequencia = e.nr_Seq_ordem_serv 
			and	c.nm_usuario_exec = e.nm_usuario_exec
			and	coalesce(e.qt_minuto,0) > 0)
	group by a.nr_sequencia, a.ds_dano_breve;

	c01_w	c01%rowtype;	
	
	
BEGIN
	
	open C01;
	loop
	fetch C01 into
		c01_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
				
		t_detalhe_row_w.identificador	:= c01_w.nr_sequencia;
		t_detalhe_row_w.descricao	:= c01_w.ds_dano_breve;	
		t_detalhe_row_w.detalhe		:= 'HPI: '||	campo_mascara_virgula(round((dividir(c01_w.qt_min_prev,c01_w.qt_real))::numeric,2))||' '||
								obter_desc_expressao(627690)||':'||c01_w.qt_min_prev||' '||
								obter_desc_expressao(737814)||':'||c01_w.qt_real;		

		if (c01_w.qt_real > 0) then
			RETURN NEXT t_detalhe_row_w;		
		end if;
	
	end loop;
	close C01;
	
	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION detalhe_kpi_pck.detalhe_hpi_os () FROM PUBLIC;
