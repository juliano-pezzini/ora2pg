-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE rep_gerar_resumo_pck.gerar_rep_resumo_npta () AS $body$
DECLARE

	
	ds_protocolo_w			varchar(100);
	ie_via_adm_w			varchar(50);
	qt_vel_inf_w			double precision;
	qt_vol_diario_w			double precision;
	ds_intervalo_w			varchar(80);
	ds_dia_fases_w			varchar(150);
	ds_justificativa_w		varchar(255);
	
	C01 CURSOR FOR
	SELECT	substr(obter_desc_prot_npt(a.nr_seq_protocolo),1,50) || '  /  '|| substr(Obter_Valor_Dominio(1537,a.ie_dispositivo_infusao),1,30),
		substr(obter_valor_dominio(1953,ie_via_administracao),1,30) ie_via_adm,
		a.qt_gotejo_npt,
		a.qt_volume_diario,
		b.ds_intervalo,
		a.qt_dia_npt ||'/'|| a.qt_fase_npt,
		substr(a.ds_justificativa,1,255)
	FROM nut_pac a
LEFT OUTER JOIN intervalo_prescricao b ON (a.cd_intervalo = b.cd_intervalo)
WHERE a.nr_prescricao	= nr_prescricao_w;

	
BEGIN
	PERFORM set_config('rep_gerar_resumo_pck.ds_resumo_w', '', false);
	open C01;
	loop
	fetch C01 into	
		ds_protocolo_w,
		ie_via_adm_w,
		qt_vel_inf_w,
		qt_vol_diario_w,
		ds_intervalo_w,
		ds_dia_fases_w,
		ds_justificativa_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin

		if (current_setting('rep_gerar_resumo_pck.ie_rtf_w')::varchar(1) = 'N') then
			PERFORM set_config('rep_gerar_resumo_pck.ds_resumo_w', substr(current_setting('rep_gerar_resumo_pck.ds_resumo_w')::text ||
					rep_gerar_resumo_pck.get_tr_html(ds_protocolo_w, ie_via_adm_w, qt_vel_inf_w, qt_vol_diario_w, null,
								ds_intervalo_w, ds_dia_fases_w, null, 7),1,30000), false);
			
			if (ds_justificativa_w IS NOT NULL AND ds_justificativa_w::text <> '') then
				PERFORM set_config('rep_gerar_resumo_pck.ds_resumo_w', substr(current_setting('rep_gerar_resumo_pck.ds_resumo_w')::text || rep_gerar_resumo_pck.get_tr_html_justif(ds_justificativa_w),1,30000), false);
			end if;					
								
		else
			PERFORM set_config('rep_gerar_resumo_pck.ds_resumo_w', substr(current_setting('rep_gerar_resumo_pck.ds_resumo_w')::text ||
					rep_gerar_resumo_pck.get_tr_rtf(ds_protocolo_w, ie_via_adm_w, qt_vel_inf_w, qt_vol_diario_w, null,
									ds_intervalo_w, ds_dia_fases_w, 7),1,30000), false);
		end if;
		
		end;
	end loop;
	close C01;
	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE rep_gerar_resumo_pck.gerar_rep_resumo_npta () FROM PUBLIC;
