-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE rep_gerar_resumo_pck.gerar_receita ( nr_prescricao_p bigint, ie_medicamentos_p text, ie_solucoes_p text, ie_recomendacoes_p text, nm_usuario_p text, ie_rtf_p text default 'N') AS $body$
DECLARE


	nr_sequencia_w				bigint;
	nr_atendimento_w			bigint;
	cd_estabelecimento_w		bigint;
	current_setting('rep_gerar_resumo_pck.cd_pessoa_fisica_w')::varchar(10)			varchar(10);
	cd_medico_w					varchar(10);
	cd_motivo_baixa_receita_w	varchar(10);
	ie_fecha_rtf_w				varchar(1) := 'N';

	
BEGIN
	
	CALL rep_gerar_resumo_pck.gerar_expressoes();
	
	PERFORM set_config('rep_gerar_resumo_pck.ie_rtf_w', ie_rtf_p, false);
	PERFORM set_config('rep_gerar_resumo_pck.ie_receita_w', 'S', false);
	
	if (current_setting('rep_gerar_resumo_pck.ie_rtf_w')::varchar(1) = 'S') then
		PERFORM set_config('rep_gerar_resumo_pck.nl_w', ' \par\par ', false);
		PERFORM set_config('rep_gerar_resumo_pck.ds_resumo_ww', '{\rtf1\ansi\ansicpg1252\deff0\deflang1046{\fonttbl{\f0\fswiss\fcharset0 Arial;}}'||
					'{\*\generator Msftedit 5.41.15.1507;}\viewkind4\uc1\pard\f0\fs20 ', false);
	else
		PERFORM set_config('rep_gerar_resumo_pck.nl_w', chr(13) || chr(10), false);
		PERFORM set_config('rep_gerar_resumo_pck.ds_resumo_ww', '', false);
	end if;
	
	PERFORM set_config('rep_gerar_resumo_pck.nr_prescricao_w', nr_prescricao_p, false);
	
	select	nr_atendimento,
		cd_pessoa_fisica,
		cd_medico,
		cd_estabelecimento
	into STRICT	nr_atendimento_w,
		current_setting('rep_gerar_resumo_pck.cd_pessoa_fisica_w')::varchar(10),
		cd_medico_w,
		cd_estabelecimento_w
	from	prescr_medica
	where	nr_prescricao	= nr_prescricao_p;
	
	if (coalesce(ie_medicamentos_p,'S') = 'S') then
		CALL rep_gerar_resumo_pck.gerar_rep_resumo_medic();
		if (current_setting('rep_gerar_resumo_pck.ds_resumo_w')::(text IS NOT NULL AND text::text <> '')) then
			PERFORM set_config('rep_gerar_resumo_pck.ds_resumo_ww', substr(current_setting('rep_gerar_resumo_pck.ds_resumo_ww')::text ||
				current_setting('rep_gerar_resumo_pck.ds_exp14_w')::varchar(255) || current_setting('rep_gerar_resumo_pck.nl_w')::varchar(255) || current_setting('rep_gerar_resumo_pck.ds_resumo_w')::text  || current_setting('rep_gerar_resumo_pck.nl_w')::varchar(255),1,30000), false);
				
			ie_fecha_rtf_w := 'S';
		end if;
		
		Obter_Param_Usuario(924,659,obter_perfil_ativo,nm_usuario_p,cd_estabelecimento_w,cd_motivo_baixa_receita_w);
	
		if (cd_motivo_baixa_receita_w IS NOT NULL AND cd_motivo_baixa_receita_w::text <> '') then
			update	prescr_material
			set	cd_motivo_baixa	= cd_motivo_baixa_receita_w,
				dt_baixa	= clock_timestamp()
			where	nr_prescricao	= current_setting('rep_gerar_resumo_pck.nr_prescricao_w')::bigint
			and	ie_agrupador	= 1
			and	coalesce(cd_motivo_baixa,0) = 0;			
		end if;
	end if;
	
	if (coalesce(ie_solucoes_p,'N') = 'S') then
		CALL rep_gerar_resumo_pck.gerar_rep_resumo_solucao();
		if (current_setting('rep_gerar_resumo_pck.ds_resumo_w')::(text IS NOT NULL AND text::text <> '')) then
			PERFORM set_config('rep_gerar_resumo_pck.ds_resumo_ww', substr(current_setting('rep_gerar_resumo_pck.ds_resumo_ww')::text ||
				current_setting('rep_gerar_resumo_pck.ds_exp15_w')::varchar(255) || current_setting('rep_gerar_resumo_pck.nl_w')::varchar(255) || current_setting('rep_gerar_resumo_pck.ds_resumo_w')::text  || current_setting('rep_gerar_resumo_pck.nl_w')::varchar(255),1,30000), false);
				
			ie_fecha_rtf_w := 'S';	
		end if;
	end if;

	if (coalesce(ie_recomendacoes_p,'N') = 'S') then
		CALL rep_gerar_resumo_pck.gerar_rep_resumo_recomend();
		if (current_setting('rep_gerar_resumo_pck.ds_resumo_w')::(text IS NOT NULL AND text::text <> '')) then
			PERFORM set_config('rep_gerar_resumo_pck.ds_resumo_ww', substr(current_setting('rep_gerar_resumo_pck.ds_resumo_ww')::text ||
				current_setting('rep_gerar_resumo_pck.ds_exp17_w')::varchar(255) || current_setting('rep_gerar_resumo_pck.nl_w')::varchar(255) || current_setting('rep_gerar_resumo_pck.ds_resumo_w')::text  || current_setting('rep_gerar_resumo_pck.nl_w')::varchar(255),1,30000), false);
				
			ie_fecha_rtf_w := 'S';	
		end if;
	end if;
	
	if (current_setting('rep_gerar_resumo_pck.ie_rtf_w')::varchar(1) = 'S') then
	   if (ie_fecha_rtf_w = 'S') then
			PERFORM set_config('rep_gerar_resumo_pck.ds_resumo_ww', current_setting('rep_gerar_resumo_pck.ds_resumo_ww')::text||'}', false);
		else
			PERFORM set_config('rep_gerar_resumo_pck.ds_resumo_ww', '', false);
		end if;
	end if;
	
	if (current_setting('rep_gerar_resumo_pck.ds_resumo_ww')::(text IS NOT NULL AND text::text <> '')) then
		insert into med_receita(
			nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			nr_atendimento,
			dt_receita,
			ds_receita,
			nr_atendimento_hosp,
			nr_seq_cliente,
			cd_pessoa_fisica,
			cd_medico,
			dt_liberacao,
			ie_tipo_receita,
			ie_situacao,
			dt_inativacao,
			nm_usuario_inativacao,
			ds_justificativa,
			cd_perfil_ativo)
		values (nextval('med_receita_seq'),
			clock_timestamp(),
			nm_usuario_p,
			null,
			clock_timestamp(),
			current_setting('rep_gerar_resumo_pck.ds_resumo_ww')::text,
			nr_atendimento_w,
			null,
			current_setting('rep_gerar_resumo_pck.cd_pessoa_fisica_w')::varchar(10),
			Obter_Pessoa_Fisica_Usuario(nm_usuario_p,'C'), --cd_medico_w,
			null,
			'C',
			'A',
			null,
			null,
			null,
			CASE WHEN obter_perfil_ativo=0 THEN null  ELSE obter_perfil_ativo END );
	end if;
	commit;
	end;



$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE rep_gerar_resumo_pck.gerar_receita ( nr_prescricao_p bigint, ie_medicamentos_p text, ie_solucoes_p text, ie_recomendacoes_p text, nm_usuario_p text, ie_rtf_p text default 'N') FROM PUBLIC;
