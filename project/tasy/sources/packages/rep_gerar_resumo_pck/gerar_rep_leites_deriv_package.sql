-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE rep_gerar_resumo_pck.gerar_rep_leites_deriv () AS $body$
DECLARE

	
	ds_dispositivo_w		varchar(255);
	ds_horarios_w			prescr_leite_deriv.ds_horarios%type;
	ds_intervalo_w			varchar(80);
	nr_sequencia_w			prescr_leite_deriv.nr_sequencia%type;
	qt_dose_w				prescr_material.qt_dose%type;
	ds_observacao_w			varchar(255);
	ds_material_w			material.ds_material%type;
	ds_componentes_w		varchar(3000);
    ds_componentes_adic_w	ds_componentes_w%type;
	nr_sequencia_prod_w		nr_sequencia_w%type;
	ds_um_w					ds_dispositivo_w%type;
	ds_material_adic_w		ds_material_w%type;
	qt_dose_adic_w			qt_dose_w%type;
		
	c01 CURSOR FOR
	SELECT 	substr(obter_desc_disp_succao(nr_seq_disp_succao),1,255),
			substr(ds_horarios,1,255),
			substr(obter_desc_intervalo(cd_intervalo),1,80),
			nr_sequencia
	from	prescr_leite_deriv
	where	nr_prescricao = nr_prescricao_w;
	
	c02 CURSOR FOR
	SELECT 	substr(b.ds_material,1,255),
			a.qt_dose,
			substr(a.ds_observacao,1,255),
			'ml',
			nr_sequencia
	from	prescr_material a,
			material b
	where	a.cd_material = b.cd_material
	and		a.nr_prescricao = nr_prescricao_w
	and		a.ie_agrupador = 16
	and		a.nr_seq_leite_deriv = nr_sequencia_w;
		
	c03 CURSOR FOR
	SELECT 	substr(b.ds_material,1,255),
			a.qt_dose,			
			substr(obter_desc_unid_med(a.cd_unidade_medida_dose),1,255)
	from	prescr_material a,
			material b
	where	a.cd_material = b.cd_material
	and		a.nr_prescricao = nr_prescricao_w
	and		a.ie_agrupador = 17
	and		a.nr_sequencia_diluicao = nr_sequencia_prod_w;		
	
	
BEGIN
	PERFORM set_config('rep_gerar_resumo_pck.ds_resumo_w', '', false);
	
	open C01;
	loop
	fetch C01 into	
		ds_dispositivo_w,
		ds_horarios_w,
		ds_intervalo_w,
		nr_sequencia_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
						
		if (current_setting('rep_gerar_resumo_pck.ie_rtf_w')::varchar(1) = 'N') then
			ds_componentes_w := '<table align="right" width="90%" border="0" cellpadding="2" cellspacing="0" >'	;
		end if;
		
		
		open C02;
		loop
		fetch C02 into	
			ds_material_w,
			qt_dose_w,
			ds_observacao_w,
			ds_um_w,
			nr_sequencia_prod_w;
		EXIT WHEN NOT FOUND; /* apply on C02 */
			begin
			
			ds_componentes_adic_w	:= null;	
			
			open C03;
			loop
			fetch C03 into	
				ds_material_adic_w,
				qt_dose_adic_w,
				ds_um_w;
			EXIT WHEN NOT FOUND; /* apply on C03 */
				begin
								
				if (current_setting('rep_gerar_resumo_pck.ie_rtf_w')::varchar(1) = 'N') then
					ds_componentes_adic_w	:= substr(ds_componentes_adic_w ||
									rep_gerar_resumo_pck.get_tr_html(qt_dose_adic_w||' '|| ds_um_w || ' - ' || ds_material_adic_w,
												null,null,null,null,null,null,null,3),1,1000);	
											
				else
					ds_componentes_adic_w	:= substr(ds_componentes_adic_w ||
									rep_gerar_resumo_pck.get_tr_rtf(qt_dose_adic_w||' '|| ds_um_w || ' - ' ||ds_material_adic_w,
											null,null,null,null,null,null,3),1,1000);	
				end if;	
				
				end;
			end loop;
			close C03;
			
			if (current_setting('rep_gerar_resumo_pck.ie_rtf_w')::varchar(1) = 'N') then
				ds_componentes_w	:= substr(ds_componentes_w ||
							rep_gerar_resumo_pck.get_tr_html(qt_dose_w||' '|| 'ml' || ' - ' ||ds_material_w,
								null,null,null,null,null,null,null,3),1,3000);		
								
				if (ds_observacao_w IS NOT NULL AND ds_observacao_w::text <> '') then
					ds_componentes_w := substr(ds_componentes_w || rep_gerar_resumo_pck.get_tr_html_obs(ds_observacao_w),1,3000);
				end if;
				
				if (ds_componentes_adic_w IS NOT NULL AND ds_componentes_adic_w::text <> '') then
					ds_componentes_w := substr(ds_componentes_w || rep_gerar_resumo_pck.get_tr_html(ds_componentes_adic_w,null,null,null,null,null,null,null,1),1,3000);
				end if;
											
			else
				ds_componentes_w	:= substr(ds_componentes_w ||
							rep_gerar_resumo_pck.get_tr_rtf(qt_dose_w||' '|| 'ml' || ' - ' ||ds_material_w,
								    null,null,null,null,null,null,3) ||
							rep_gerar_resumo_pck.get_tr_rtf(ds_componentes_adic_w,null,null,null,null,null,null,1),1,3000);	
			end if;	
			
			
			end;
		end loop;
		close C02;		
		
		if (current_setting('rep_gerar_resumo_pck.ie_rtf_w')::varchar(1) = 'N') then		
			ds_componentes_w := ds_componentes_w||'</table>';
		
			PERFORM set_config('rep_gerar_resumo_pck.ds_resumo_w', substr(current_setting('rep_gerar_resumo_pck.ds_resumo_w')::text ||
					rep_gerar_resumo_pck.get_tr_html(ds_dispositivo_w, ds_intervalo_w, ds_horarios_w,
							null, null, null, null, null, 3)||
					rep_gerar_resumo_pck.get_tr_html(ds_componentes_w,null,null,null,null,null,null,null,1)							
							,1,3000), false);
		else
			PERFORM set_config('rep_gerar_resumo_pck.ds_resumo_w', substr(current_setting('rep_gerar_resumo_pck.ds_resumo_w')::text ||
					rep_gerar_resumo_pck.get_tr_rtf(ds_dispositivo_w, ds_intervalo_w, ds_horarios_w,
							null, null, null, null, 3)||
					rep_gerar_resumo_pck.get_tr_rtf(ds_componentes_w,null,null,null,null,null,null,1)
					,1,3000), false);		
		
		end if;
		
		end;
	end loop;
	close C01;	
	END;	

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE rep_gerar_resumo_pck.gerar_rep_leites_deriv () FROM PUBLIC;
