-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


/*registro c300: itens do documento*/

CREATE OR REPLACE PROCEDURE fis_sef_edoc_reg_extrato_pck.fis_gerar_reg_c300_edoc ( nr_seq_superior_p bigint, nr_seq_nota_p bigint) AS $body$
DECLARE


nr_seq_fis_sef_edoc_c300_w	fis_sef_edoc_c300.nr_sequencia%type;

vl_bc_icms_w			fis_sef_edoc_c300.vl_bc_icms%type;
tx_aliq_icms_w			fis_sef_edoc_c300.tx_aliq_icms%type;
vl_icms_w			fis_sef_edoc_c300.vl_icms%type;
vl_bc_icms_st_w			fis_sef_edoc_c300.vl_bc_icms_st%type;
tx_aliq_st_w			fis_sef_edoc_c300.tx_aliq_st%type;
vl_icms_st_w			fis_sef_edoc_c300.vl_icms_st%type;
vl_bc_ipi_w			fis_sef_edoc_c300.vl_bc_ipi%type;
tx_aliq_ipi_w			fis_sef_edoc_c300.tx_aliq_ipi%type;
vl_ipi_w			fis_sef_edoc_c300.vl_ipi%type;

/**/

c_reg_c300 CURSOR FOR
	SELECT	b.nr_item_nf nr_item,
		b.cd_material cd_item,
		substr(b.cd_unidade_medida_compra, 1,6) cd_unid,
		b.vl_unitario_item_nf vl_unid,
		b.qt_item_nf qt_item,
		b.vl_desconto vl_desc,
		null vl_acmo,
		b.vl_liquido vl_item,
		null cd_ncm,
		substr(c.ie_origem_mercadoria, 1, 1) || substr(c.ie_tributacao_icms, 1, 2) cd_cst,
		substr(Elimina_Caracter(obter_dados_natureza_operacao(a.cd_natureza_operacao, 'CF'), '.'), 1, 4) cd_cfop,
		c.ie_tributacao_icms,		-- Verificação para icms
		c.ie_tributacao_ipi,		-- Verificação para ipi
		b.nr_sequencia nr_seq_item_nf  	-- Informação para obter os impostos
	FROM nota_fiscal a, nota_fiscal_item b
LEFT OUTER JOIN material_fiscal c ON (b.cd_material = c.cd_material)
WHERE a.nr_sequencia = b.nr_Sequencia  and a.nr_sequencia = nr_seq_nota_p;

/*Criação do array com o tipo sendo do cursor eespecificado - c_reg_0175*/

type reg_c_reg_c300 is table of c_reg_c300%RowType;
vetregc300 reg_c_reg_c300;

BEGIN

open c_reg_c300;
loop
fetch c_reg_c300 bulk collect into vetregc300 limit 1000;
	for i in 1 .. vetregc300.Count loop
		begin

		/*Limpeza de variaveis*/

		vl_icms_w	:= 0;
		vl_bc_icms_w	:= 0;
		tx_aliq_icms_w	:= 0;
		vl_icms_st_w	:= 0;
		vl_bc_icms_st_w	:= 0;
		tx_aliq_st_w	:= 0;
		vl_ipi_w	:= 0;
		vl_bc_ipi_w	:= 0;
		tx_aliq_ipi_w	:= 0;

		/*Incrementa a variavel para o array*/

		PERFORM set_config('fis_sef_edoc_reg_extrato_pck.qt_cursor_c300_w', current_setting('fis_sef_edoc_reg_extrato_pck.qt_cursor_c300_w')::bigint + 1, false);

		/*Bloco para obter os valores de impostos. ICMS,*/

		if (vetregc300[i].ie_tributacao_icms in ('00', '10', '20', '70')) then
			fis_obter_valor_trib_item(	vetregc300[i].nr_seq_item_nf,
							vetregc300[i].nr_item,
							'ICMS',
							vl_icms_w,
							vl_bc_icms_w,
							tx_aliq_icms_w);
		end if;

		/*Bloco para obter os valores de impostos. ICMSST*/

		if (vetregc300[i].ie_tributacao_icms in ('10', '30', '70')) then
			fis_obter_valor_trib_item(	vetregc300[i].nr_seq_item_nf,
							vetregc300[i].nr_item,
							'ICMSST',
							vl_icms_st_w,
							vl_bc_icms_st_w,
							tx_aliq_st_w);
		end if;

		/*Bloco para obter os valores de impostos. IPI*/

		if (vetregc300[i].ie_tributacao_ipi in ('00', '50')) then
			fis_obter_valor_trib_item(	vetregc300[i].nr_seq_item_nf,
							vetregc300[i].nr_item,
							'IPI',
							vl_ipi_w,
							vl_bc_ipi_w,
							tx_aliq_ipi_w);
		end if;

		/*Pega a sequencia da taleba fis_sef_edoc_c300 para o insert*/

		select	nextval('fis_sef_edoc_c300_seq')
		into STRICT	nr_seq_fis_sef_edoc_c300_w
		;

		/*Inserindo valores no array para realização do forall posteriormente*/

		current_setting('fis_sef_edoc_reg_extrato_pck.fis_registros_c300_w')::registro_c300(current_setting('fis_sef_edoc_reg_extrato_pck.qt_cursor_c300_w')::bigint).nr_sequencia 		:= nr_seq_fis_sef_edoc_c300_w;
		current_setting('fis_sef_edoc_reg_extrato_pck.fis_registros_c300_w')::registro_c300(current_setting('fis_sef_edoc_reg_extrato_pck.qt_cursor_c300_w')::bigint).dt_atualizacao 		:= clock_timestamp();
		current_setting('fis_sef_edoc_reg_extrato_pck.fis_registros_c300_w')::registro_c300(current_setting('fis_sef_edoc_reg_extrato_pck.qt_cursor_c300_w')::bigint).nm_usuario 		:= current_setting('fis_sef_edoc_reg_extrato_pck.nm_usuario_w')::usuario.nm_usuario%type;
		current_setting('fis_sef_edoc_reg_extrato_pck.fis_registros_c300_w')::registro_c300(current_setting('fis_sef_edoc_reg_extrato_pck.qt_cursor_c300_w')::bigint).dt_atualizacao_nrec	:= clock_timestamp();
		current_setting('fis_sef_edoc_reg_extrato_pck.fis_registros_c300_w')::registro_c300(current_setting('fis_sef_edoc_reg_extrato_pck.qt_cursor_c300_w')::bigint).nm_usuario_nrec 		:= current_setting('fis_sef_edoc_reg_extrato_pck.nm_usuario_w')::usuario.nm_usuario%type;
		current_setting('fis_sef_edoc_reg_extrato_pck.fis_registros_c300_w')::registro_c300(current_setting('fis_sef_edoc_reg_extrato_pck.qt_cursor_c300_w')::bigint).cd_reg 			:= 'C300';
		current_setting('fis_sef_edoc_reg_extrato_pck.fis_registros_c300_w')::registro_c300(current_setting('fis_sef_edoc_reg_extrato_pck.qt_cursor_c300_w')::bigint).nr_item			:= vetregc300[i].nr_item;
		current_setting('fis_sef_edoc_reg_extrato_pck.fis_registros_c300_w')::registro_c300(current_setting('fis_sef_edoc_reg_extrato_pck.qt_cursor_c300_w')::bigint).cd_item			:= vetregc300[i].cd_item;
		current_setting('fis_sef_edoc_reg_extrato_pck.fis_registros_c300_w')::registro_c300(current_setting('fis_sef_edoc_reg_extrato_pck.qt_cursor_c300_w')::bigint).cd_unid			:= vetregc300[i].cd_unid;
		current_setting('fis_sef_edoc_reg_extrato_pck.fis_registros_c300_w')::registro_c300(current_setting('fis_sef_edoc_reg_extrato_pck.qt_cursor_c300_w')::bigint).vl_unit			:= vetregc300[i].vl_unid;
		current_setting('fis_sef_edoc_reg_extrato_pck.fis_registros_c300_w')::registro_c300(current_setting('fis_sef_edoc_reg_extrato_pck.qt_cursor_c300_w')::bigint).qt_item			:= vetregc300[i].qt_item;
		current_setting('fis_sef_edoc_reg_extrato_pck.fis_registros_c300_w')::registro_c300(current_setting('fis_sef_edoc_reg_extrato_pck.qt_cursor_c300_w')::bigint).vl_desc			:= vetregc300[i].vl_desc;
		current_setting('fis_sef_edoc_reg_extrato_pck.fis_registros_c300_w')::registro_c300(current_setting('fis_sef_edoc_reg_extrato_pck.qt_cursor_c300_w')::bigint).vl_acmo			:= vetregc300[i].vl_acmo;
		current_setting('fis_sef_edoc_reg_extrato_pck.fis_registros_c300_w')::registro_c300(current_setting('fis_sef_edoc_reg_extrato_pck.qt_cursor_c300_w')::bigint).vl_item			:= vetregc300[i].vl_item;
		current_setting('fis_sef_edoc_reg_extrato_pck.fis_registros_c300_w')::registro_c300(current_setting('fis_sef_edoc_reg_extrato_pck.qt_cursor_c300_w')::bigint).cd_ncm			:= vetregc300[i].cd_ncm;
		current_setting('fis_sef_edoc_reg_extrato_pck.fis_registros_c300_w')::registro_c300(current_setting('fis_sef_edoc_reg_extrato_pck.qt_cursor_c300_w')::bigint).cd_cst			:= vetregc300[i].cd_cst;
		current_setting('fis_sef_edoc_reg_extrato_pck.fis_registros_c300_w')::registro_c300(current_setting('fis_sef_edoc_reg_extrato_pck.qt_cursor_c300_w')::bigint).cd_cfop			:= vetregc300[i].cd_cfop;
		current_setting('fis_sef_edoc_reg_extrato_pck.fis_registros_c300_w')::registro_c300(current_setting('fis_sef_edoc_reg_extrato_pck.qt_cursor_c300_w')::bigint).vl_bc_icms		:= vl_bc_icms_w;
		current_setting('fis_sef_edoc_reg_extrato_pck.fis_registros_c300_w')::registro_c300(current_setting('fis_sef_edoc_reg_extrato_pck.qt_cursor_c300_w')::bigint).tx_aliq_icms		:= tx_aliq_icms_w;
		current_setting('fis_sef_edoc_reg_extrato_pck.fis_registros_c300_w')::registro_c300(current_setting('fis_sef_edoc_reg_extrato_pck.qt_cursor_c300_w')::bigint).vl_icms			:= vl_icms_w;
		current_setting('fis_sef_edoc_reg_extrato_pck.fis_registros_c300_w')::registro_c300(current_setting('fis_sef_edoc_reg_extrato_pck.qt_cursor_c300_w')::bigint).vl_bc_icms_st		:= vl_bc_icms_st_w;
		current_setting('fis_sef_edoc_reg_extrato_pck.fis_registros_c300_w')::registro_c300(current_setting('fis_sef_edoc_reg_extrato_pck.qt_cursor_c300_w')::bigint).tx_aliq_st		:= tx_aliq_st_w;
		current_setting('fis_sef_edoc_reg_extrato_pck.fis_registros_c300_w')::registro_c300(current_setting('fis_sef_edoc_reg_extrato_pck.qt_cursor_c300_w')::bigint).vl_icms_st		:= vl_icms_st_w;
		current_setting('fis_sef_edoc_reg_extrato_pck.fis_registros_c300_w')::registro_c300(current_setting('fis_sef_edoc_reg_extrato_pck.qt_cursor_c300_w')::bigint).vl_bc_ipi		:= vl_bc_ipi_w;
		current_setting('fis_sef_edoc_reg_extrato_pck.fis_registros_c300_w')::registro_c300(current_setting('fis_sef_edoc_reg_extrato_pck.qt_cursor_c300_w')::bigint).tx_aliq_ipi		:= tx_aliq_ipi_w;
		current_setting('fis_sef_edoc_reg_extrato_pck.fis_registros_c300_w')::registro_c300(current_setting('fis_sef_edoc_reg_extrato_pck.qt_cursor_c300_w')::bigint).vl_ipi			:= vl_ipi_w;
		current_setting('fis_sef_edoc_reg_extrato_pck.fis_registros_c300_w')::registro_c300(current_setting('fis_sef_edoc_reg_extrato_pck.qt_cursor_c300_w')::bigint).nr_seq_superior		:= nr_seq_superior_p;
		current_setting('fis_sef_edoc_reg_extrato_pck.fis_registros_c300_w')::registro_c300(current_setting('fis_sef_edoc_reg_extrato_pck.qt_cursor_c300_w')::bigint).nr_seq_controle 		:= current_setting('fis_sef_edoc_reg_extrato_pck.nr_seq_controle_w')::fis_sef_edoc_controle.nr_sequencia%type;

		/*Totalizadores para o c020*/

		/*Totalizador do valore de desconto*/

		current_setting('fis_sef_edoc_reg_extrato_pck.fis_totalizador_c300_w')::totalizador_c300(1) :=	current_setting('fis_sef_edoc_reg_extrato_pck.fis_totalizador_c300_w')::totalizador_c300(1) + vetregc300[i].vl_desc;
		/*Totalizador do valor do item/ valor da mercadoria*/

		current_setting('fis_sef_edoc_reg_extrato_pck.fis_totalizador_c300_w')::totalizador_c300(2) :=	current_setting('fis_sef_edoc_reg_extrato_pck.fis_totalizador_c300_w')::totalizador_c300(2) + vetregc300[i].vl_item;
		/*Totalizador do valor base de ICMS*/

		current_setting('fis_sef_edoc_reg_extrato_pck.fis_totalizador_c300_w')::totalizador_c300(3) :=	current_setting('fis_sef_edoc_reg_extrato_pck.fis_totalizador_c300_w')::totalizador_c300(3) + vl_bc_icms_w;
		/*Totalizador do valor de ICMS*/

		current_setting('fis_sef_edoc_reg_extrato_pck.fis_totalizador_c300_w')::totalizador_c300(4) :=	current_setting('fis_sef_edoc_reg_extrato_pck.fis_totalizador_c300_w')::totalizador_c300(4) + vl_icms_w;
		/*Totalizador do valor base de ICMSST*/

		current_setting('fis_sef_edoc_reg_extrato_pck.fis_totalizador_c300_w')::totalizador_c300(5) :=	current_setting('fis_sef_edoc_reg_extrato_pck.fis_totalizador_c300_w')::totalizador_c300(5) + vl_bc_icms_st_w;
		/*Totalizador do valor de ICMSST*/

		current_setting('fis_sef_edoc_reg_extrato_pck.fis_totalizador_c300_w')::totalizador_c300(6) :=	current_setting('fis_sef_edoc_reg_extrato_pck.fis_totalizador_c300_w')::totalizador_c300(6) + vl_icms_st_w;
		/*Totalizador dO valor de IPI*/

		current_setting('fis_sef_edoc_reg_extrato_pck.fis_totalizador_c300_w')::totalizador_c300(7) :=	current_setting('fis_sef_edoc_reg_extrato_pck.fis_totalizador_c300_w')::totalizador_c300(7) + vl_ipi_w;

		end;
	end loop;
EXIT WHEN NOT FOUND; /* apply on c_reg_c300 */
end loop;
close c_reg_c300;

/*Libera memoria*/

dbms_session.free_unused_user_memory;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE fis_sef_edoc_reg_extrato_pck.fis_gerar_reg_c300_edoc ( nr_seq_superior_p bigint, nr_seq_nota_p bigint) FROM PUBLIC;
