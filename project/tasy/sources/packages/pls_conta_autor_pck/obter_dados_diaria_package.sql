-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pls_conta_autor_pck.obter_dados_diaria ( nr_seq_guia_p pls_guia_plano.nr_sequencia%type, ie_origem_proced_p pls_guia_plano_proc.ie_origem_proced%type, cd_procedimento_p pls_guia_plano_proc.cd_procedimento%type) RETURNS SETOF T_CONTA_AUTOR_DATA AS $body$
DECLARE

conta_autor_proc_row_w 		t_conta_autor_row;
qt_utilizada_w			pls_conta_proc.qt_procedimento%type;
qt_utilizada_soma_w		pls_conta_proc.qt_procedimento%type;
qt_prorrogacao_dia_w		pls_guia_plano.qt_dia_autorizado%type	:= 0;
qt_autorizada_w			pls_guia_plano_proc.qt_autorizada%type;
sql_conta_w 			varchar(4000);
filtro_regra_sql_w 		varchar(2000);
var_cur_w 			integer;
var_exec_w			integer;
var_retorno_w			integer;

C01 CURSOR(nr_seq_guia_pc	pls_guia_plano.nr_sequencia%type) FOR
	SELECT	nr_seq_guia_ok nr_seq_guia,
		sum(a.qt_dia_autorizado) qt_autorizada
	from	pls_guia_plano a
	where	((a.nr_sequencia  = nr_seq_guia_pc) or (a.nr_seq_guia_ok = nr_seq_guia_pc and a.ie_tipo_guia in ('2','8')))
	and	a.ie_status	= '1'
	group by a.nr_seq_guia_ok;

C02 CURSOR(	nr_seq_guia_pc		pls_guia_plano.nr_sequencia%type,
		ie_origem_proced_pc	pls_guia_plano_proc.ie_origem_proced%type,
		cd_procedimento_pc	pls_guia_plano_proc.cd_procedimento%type)FOR
	SELECT 	sum(qt_procedimento) qt_procedimento,
		ie_glosa,
	       	ie_estagio_complemento,
	       	ie_status
	from   	pls_conta_autor_v
	where  	nr_seq_guia   = nr_seq_guia_pc
	and   	ie_tipo_item  = 'D'
	-- se for para verificar somente de um procedimento filtra direto ja
	and ((coalesce(ie_origem_proced_pc::text, '') = '' and coalesce(cd_procedimento_pc::text, '') = '') or (ie_origem_proced = ie_origem_proced_pc and cd_procedimento = cd_procedimento_pc))
	group by ie_glosa,
	         ie_estagio_complemento,
	         ie_status;
BEGIN

for r_C01 in C01(nr_seq_guia_p) loop
	conta_autor_proc_row_w.ie_tipo_registro := 'D';
	conta_autor_proc_row_w.nr_seq_autor 	:= r_C01.nr_seq_guia;
	conta_autor_proc_row_w.nr_seq_conta 	:= null;
	conta_autor_proc_row_w.nr_seq_conta_proc_mat := null;
	conta_autor_proc_row_w.qt_utilizada 	:= 0;
	conta_autor_proc_row_w.qt_saldo 	:= 0;
	conta_autor_proc_row_w.nr_seq_material 	:= null;
	qt_autorizada_w				:= r_C01.qt_autorizada;
	-- tratamento para obter as quantidades dos procedimentos
	qt_utilizada_soma_w := 0;
	conta_autor_proc_row_w.qt_saldo_complemento := 0;
	conta_autor_proc_row_w.qt_utilizada_compl   := 0;
	
	for r_c02_w in C02(r_C01.nr_seq_guia, ie_origem_proced_p, cd_procedimento_p) loop
		begin
		if	((r_c02_w.ie_glosa = 'N') or (coalesce(r_c02_w.ie_glosa::text, '') = '')) and
			((r_c02_w.ie_status != 'U') or (r_c02_w.ie_estagio_complemento != '3' AND r_c02_w.ie_estagio_complemento IS NOT NULL AND r_c02_w.ie_estagio_complemento::text <> '')) then
			qt_utilizada_soma_w := qt_utilizada_soma_w + coalesce(r_c02_w.qt_procedimento, 0);
		end if;
		end;
	end loop;

	conta_autor_proc_row_w.qt_utilizada 	:= qt_utilizada_soma_w;
	conta_autor_proc_row_w.qt_saldo 	:= (qt_autorizada_w - qt_utilizada_soma_w);
	conta_autor_proc_row_w.qt_autorizada 	:= qt_autorizada_w;
	
	RETURN NEXT conta_autor_proc_row_w;
end loop;

return;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pls_conta_autor_pck.obter_dados_diaria ( nr_seq_guia_p pls_guia_plano.nr_sequencia%type, ie_origem_proced_p pls_guia_plano_proc.ie_origem_proced%type, cd_procedimento_p pls_guia_plano_proc.cd_procedimento%type) FROM PUBLIC;
