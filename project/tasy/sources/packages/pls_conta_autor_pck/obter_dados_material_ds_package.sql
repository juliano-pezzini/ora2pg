-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pls_conta_autor_pck.obter_dados_material_ds ( nr_seq_guia_p pls_guia_plano.nr_sequencia%type, nr_seq_material_p pls_guia_plano_mat.nr_seq_material%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, cd_guia_ok_p pls_guia_plano.cd_guia%type, nr_seq_segurado_p pls_conta.nr_seq_segurado%type) RETURNS SETOF T_CONTA_AUTOR_DATA AS $body$
DECLARE

	
conta_autor_proc_row_w 		t_conta_autor_row;
qt_utilizada_w				pls_conta_proc.qt_procedimento%type;
qt_utilizada_soma_w			pls_conta_proc.qt_procedimento%type;
qt_utilizada_fora_compl_w	pls_conta_proc.qt_procedimento%type;
qt_prorrogacao_w			pls_guia_plano_mat.qt_autorizada%type	:= 0;	
sql_conta_w 				varchar(4000);
filtro_regra_sql_w 			varchar(2000);
var_cur_w 					integer;
var_exec_w					integer;
var_retorno_w				integer;
ie_glosa_w					pls_conta.ie_glosa%type;
ie_estagio_complemento_w	pls_conta.ie_estagio_complemento%type;
ie_status_w					pls_conta_mat.ie_status%type;
qt_utilizada_soma_compl_w	pls_conta_proc.qt_procedimento%type;
ie_considera_anexo_guia_w	pls_parametros.ie_considera_anexo_guia%type;

C01 CURSOR(	nr_seq_guia_pc		pls_guia_plano.nr_sequencia%type,
			nr_seq_material_pc	pls_guia_plano_mat.nr_seq_material%type) FOR
	SELECT	nr_seq_guia_ok nr_seq_guia,
			b.nr_seq_material,
			sum(b.qt_autorizada) qt_autorizada,
			max(a.nr_seq_regra_compl) nr_seq_regra_compl,
			sum(c.qt_autorizado) qt_autorizado_anexo,
			sum(c.qt_dosagem_total) qt_dosagem
	FROM pls_guia_plano a, pls_guia_plano_mat b
LEFT OUTER JOIN pls_lote_anexo_mat_aut c ON (b.nr_sequencia = c.nr_seq_plano_mat)
WHERE ((a.nr_sequencia  = nr_seq_guia_pc) or (a.nr_seq_guia_ok = nr_seq_guia_pc and a.ie_tipo_guia in ('2','8'))) and a.ie_status	= '1' and b.nr_seq_guia	= a.nr_sequencia and b.ie_status 	in ('L', 'P', 'S') -- se for para verificar somente do material, ja filtra direto
  and ((coalesce(nr_seq_material_pc::text, '') = '') or (b.nr_seq_material = nr_seq_material_pc))  group by a.nr_seq_guia_ok,
			b.nr_seq_material;

C02 CURSOR(	nr_seq_guia_pc		pls_guia_plano.nr_sequencia%type,
				nr_seq_material_pc	pls_conta_mat.nr_seq_material%type,
				cd_guia_ok_pc		pls_guia_plano.cd_guia%type,
				nr_seq_segurado_pc	pls_conta.nr_seq_segurado%type) FOR				
	SELECT 	ie_glosa,
	        ie_estagio_complemento,
	        ie_status,
		sum(qt_procedimento) qt_procedimento
	from    pls_conta_autor_v
	where   ((nr_seq_guia 	= nr_seq_guia_pc) or (cd_guia_ok = cd_guia_ok_pc and nr_seq_segurado = nr_seq_segurado_pc))
	and   	nr_seq_material = nr_seq_material_pc
	and	ie_tipo_item	= 'M'
	group by ie_glosa,
	         ie_estagio_complemento,
	         ie_status;
BEGIN

select	coalesce(max(ie_considera_anexo_guia),'N')
into STRICT	ie_considera_anexo_guia_w
from	pls_parametros
where 	cd_estabelecimento = cd_estabelecimento_p;

for r_C01 in C01(nr_seq_guia_p, nr_seq_material_p) loop
	conta_autor_proc_row_w.ie_tipo_registro := 'D';
	conta_autor_proc_row_w.nr_seq_autor 	:= r_C01.nr_seq_guia;
	conta_autor_proc_row_w.nr_seq_conta 	:= null;
	conta_autor_proc_row_w.nr_seq_conta_proc_mat := null;
	
	--Se parametrizado para utilizar quantidade do anexo e existe quantidade informada la(Mesmo que seja zero, considerara a qtde informada no anexo, caso for nula, ainda 
	--verificare a quantidade dosagem, pois para anexo quimioterapia, esse e o campo informado,	somente desconsiderando caso for nula)
	if (ie_considera_anexo_guia_w = 'S' and (r_c01.qt_autorizado_anexo IS NOT NULL AND r_c01.qt_autorizado_anexo::text <> '')) then
		conta_autor_proc_row_w.qt_autorizada := r_c01.qt_autorizado_anexo;
	elsif (ie_considera_anexo_guia_w = 'S' and (r_c01.qt_dosagem IS NOT NULL AND r_c01.qt_dosagem::text <> '')) then
		conta_autor_proc_row_w.qt_autorizada := r_c01.qt_dosagem;
	else
		conta_autor_proc_row_w.qt_autorizada 	:= r_C01.qt_autorizada;
	end if;
	
	conta_autor_proc_row_w.qt_utilizada 	:= 0;
	conta_autor_proc_row_w.qt_saldo 	:= 0;
	conta_autor_proc_row_w.nr_seq_material 	:= r_C01.nr_seq_material;
	conta_autor_proc_row_w.qt_saldo_complemento := 0;
	conta_autor_proc_row_w.qt_utilizada_compl   := 0;
	-- tratamento para obter as quantidades dos procedimentos
	qt_utilizada_soma_w := 0;
	qt_utilizada_soma_compl_w := 0;
	qt_utilizada_fora_compl_w := 0;
	
	for r_c02_w in C02(nr_seq_guia_p, r_C01.nr_seq_material, cd_guia_ok_p, nr_seq_segurado_p) loop
		begin
		if (r_c01.nr_seq_regra_compl IS NOT NULL AND r_c01.nr_seq_regra_compl::text <> '') and
			(r_c02_w.ie_estagio_complemento != '3' AND r_c02_w.ie_estagio_complemento IS NOT NULL AND r_c02_w.ie_estagio_complemento::text <> '')  then
			qt_utilizada_soma_compl_w := qt_utilizada_soma_compl_w + coalesce(r_c02_w.qt_procedimento, 0);
		end if;
		
		/*Quantidade utilizada exclusivamente fora do complemento. Isso aqui e feito pois casos com regra de complemento, podem ter utilizacao via digitacao pelo portal por exemplo, com isso, o saldo do complemento necessita de 
			atualizacao tambem
			*/
		if (r_c01.nr_seq_regra_compl IS NOT NULL AND r_c01.nr_seq_regra_compl::text <> '') and (coalesce(r_c02_w.ie_estagio_complemento::text, '') = '') and
			((r_c02_w.ie_glosa = 'N') or (coalesce(r_c02_w.ie_glosa::text, '') = '')) and (r_c02_w.ie_status != 'U') then
			qt_utilizada_fora_compl_w := qt_utilizada_fora_compl_w + coalesce(r_c02_w.qt_procedimento,0);
		end if;
	
		/* tratamento para atualizar a quantidade utilizada das guias no geral*/

		if	((r_c02_w.ie_glosa = 'N') or (coalesce(r_c02_w.ie_glosa::text, '') = '')) and
			((r_c02_w.ie_status != 'U') or (r_c02_w.ie_estagio_complemento != '3' AND r_c02_w.ie_estagio_complemento IS NOT NULL AND r_c02_w.ie_estagio_complemento::text <> '')) then
			qt_utilizada_soma_w := qt_utilizada_soma_w + coalesce(r_c02_w.qt_procedimento, 0);
		end if;
		end;
	end loop;
	
	conta_autor_proc_row_w.qt_utilizada_compl   := qt_utilizada_soma_compl_w;
	
	conta_autor_proc_row_w.qt_saldo_complemento := (conta_autor_proc_row_w.qt_autorizada  - qt_utilizada_soma_compl_w - qt_utilizada_fora_compl_w);
	
	conta_autor_proc_row_w.qt_utilizada := qt_utilizada_soma_w;
	conta_autor_proc_row_w.qt_saldo := (conta_autor_proc_row_w.qt_autorizada  - qt_utilizada_soma_w);
	
	RETURN NEXT conta_autor_proc_row_w;
end loop;

return;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pls_conta_autor_pck.obter_dados_material_ds ( nr_seq_guia_p pls_guia_plano.nr_sequencia%type, nr_seq_material_p pls_guia_plano_mat.nr_seq_material%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, cd_guia_ok_p pls_guia_plano.cd_guia%type, nr_seq_segurado_p pls_conta.nr_seq_segurado%type) FROM PUBLIC;
