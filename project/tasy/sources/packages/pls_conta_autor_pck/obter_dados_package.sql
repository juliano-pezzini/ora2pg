-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pls_conta_autor_pck.obter_dados ( nr_seq_guia_p pls_guia_plano.nr_sequencia%type, ie_tipo_registro_p text, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, ie_origem_proced_p pls_guia_plano_proc.ie_origem_proced%type default null, cd_procedimento_p pls_guia_plano_proc.cd_procedimento%type default null, nr_seq_material_p pls_guia_plano_mat.nr_seq_material%type default null) RETURNS SETOF T_CONTA_AUTOR_DATA AS $body$
DECLARE


conta_autor_row_w 		t_conta_autor_row;
ie_forma_consist_diaria_w	varchar(2);

C01 CURSOR(	nr_seq_guia_pc 		pls_guia_plano.nr_sequencia%type,
		ie_origem_proced_pc	pls_guia_plano_proc.ie_origem_proced%type,
		cd_procedimento_pc	pls_guia_plano_proc.cd_procedimento%type) FOR

	SELECT	*
	from	table(pls_conta_autor_pck.obter_dados_procedimento(	nr_seq_guia_pc,
									ie_origem_proced_pc,
									cd_procedimento_pc));

C02 CURSOR(	nr_seq_guia_pc 		pls_guia_plano.nr_sequencia%type,
		nr_seq_material_pc	pls_guia_plano_mat.nr_seq_material%type) FOR

	SELECT	*
	from	table(pls_conta_autor_pck.obter_dados_material(	nr_seq_guia_pc,
								nr_seq_material_pc, cd_estabelecimento_p));

C03 CURSOR(	nr_seq_guia_pc		pls_guia_plano.nr_sequencia%type,
		ie_origem_proced_pc	pls_guia_plano_proc.ie_origem_proced%type,
		cd_procedimento_pc	pls_guia_plano_proc.cd_procedimento%type) FOR

	SELECT	*
	from	table(pls_conta_autor_pck.obter_dados_diaria(	nr_seq_guia_pc,
								ie_origem_proced_pc,
								cd_procedimento_pc));
	
BEGIN
-- para procedimentos
select	ie_forma_consist_diaria
into STRICT	ie_forma_consist_diaria_w
from	table(pls_parametros_pck.f_retorna_param(cd_estabelecimento_p));

if (ie_tipo_registro_p = 'P') or	
	((ie_forma_consist_diaria_w = 'P') and (not(ie_tipo_registro_p = 'M')))then
	for r_C01 in C01(nr_seq_guia_p, ie_origem_proced_p, cd_procedimento_p) loop
		conta_autor_row_w.ie_tipo_registro 	:= r_C01.ie_tipo_registro;
		conta_autor_row_w.nr_seq_autor 		:= r_C01.nr_seq_autor;
		conta_autor_row_w.cd_procedimento 	:= r_C01.cd_procedimento;
		conta_autor_row_w.ie_origem_proced 	:= r_C01.ie_origem_proced;
		conta_autor_row_w.nr_seq_conta 		:= r_C01.nr_seq_conta;
		conta_autor_row_w.nr_seq_conta_proc_mat := r_C01.nr_seq_conta_proc_mat;
		conta_autor_row_w.qt_autorizada 	:= r_C01.qt_autorizada;
		conta_autor_row_w.qt_utilizada 		:= r_C01.qt_utilizada;
		conta_autor_row_w.qt_saldo 		:= r_C01.qt_saldo;
		conta_autor_row_w.qt_saldo_complemento  := r_C01.qt_saldo_complemento;
		conta_autor_row_w.qt_utilizada_compl    := r_C01.qt_utilizada_compl;
		RETURN NEXT conta_autor_row_w;
	end loop;
-- para materiais	
elsif (ie_tipo_registro_p = 'M') then
	for r_C02 in C02(nr_seq_guia_p, nr_seq_material_p) loop
		conta_autor_row_w.ie_tipo_registro 	:= r_C02.ie_tipo_registro;
		conta_autor_row_w.nr_seq_autor 		:= r_C02.nr_seq_autor;
		conta_autor_row_w.cd_procedimento 	:= r_C02.cd_procedimento;
		conta_autor_row_w.ie_origem_proced 	:= r_C02.ie_origem_proced;
		conta_autor_row_w.nr_seq_conta 		:= r_C02.nr_seq_conta;
		conta_autor_row_w.nr_seq_conta_proc_mat := r_C02.nr_seq_conta_proc_mat;
		conta_autor_row_w.qt_autorizada 	:= r_C02.qt_autorizada;
		conta_autor_row_w.qt_utilizada 		:= r_C02.qt_utilizada;
		conta_autor_row_w.qt_saldo 		:= r_C02.qt_saldo;
		conta_autor_row_w.nr_seq_material	:= r_C02.nr_seq_material;
		conta_autor_row_w.qt_saldo_complemento  := r_C02.qt_saldo_complemento;
		conta_autor_row_w.qt_utilizada_compl    := r_C02.qt_utilizada_compl;
		RETURN NEXT conta_autor_row_w;
	end loop;
-- para diarias
elsif (ie_tipo_registro_p = 'D') then
	for r_C03 in C03(nr_seq_guia_p, ie_origem_proced_p, cd_procedimento_p) loop
		conta_autor_row_w.ie_tipo_registro 	:= r_C03.ie_tipo_registro;
		conta_autor_row_w.nr_seq_autor 		:= r_C03.nr_seq_autor;
		conta_autor_row_w.cd_procedimento 	:= r_C03.cd_procedimento;
		conta_autor_row_w.ie_origem_proced 	:= r_C03.ie_origem_proced;
		conta_autor_row_w.nr_seq_conta 		:= r_C03.nr_seq_conta;
		conta_autor_row_w.nr_seq_conta_proc_mat := r_C03.nr_seq_conta_proc_mat;
		conta_autor_row_w.qt_autorizada 	:= r_C03.qt_autorizada;
		conta_autor_row_w.qt_utilizada 		:= r_C03.qt_utilizada;
		conta_autor_row_w.qt_saldo 		:= r_C03.qt_saldo;
		
		RETURN NEXT conta_autor_row_w;
	end loop;
end if;

return;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pls_conta_autor_pck.obter_dados ( nr_seq_guia_p pls_guia_plano.nr_sequencia%type, ie_tipo_registro_p text, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, ie_origem_proced_p pls_guia_plano_proc.ie_origem_proced%type default null, cd_procedimento_p pls_guia_plano_proc.cd_procedimento%type default null, nr_seq_material_p pls_guia_plano_mat.nr_seq_material%type default null) FROM PUBLIC;
