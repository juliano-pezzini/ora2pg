-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE fin_capa_ficha_financ_pck.fin_gerar_vl_atrib_capa ( dt_inicial_p timestamp, dt_final_p timestamp, cd_pessoa_fisica_p text, cd_cgc_p text, nm_usuario_p text) AS $body$
DECLARE


c001			integer;

ds_sql_w			varchar(4000);
ds_macro_w		varchar(50);
vl_resultado_w		double precision;
dt_inicial_w		varchar(255);
dt_final_w		varchar(255);
vl_coluna_w		varchar(17);


c01 CURSOR FOR
	SELECT	ds_macro,
		ds_sql
	from	ficha_financ_valor
	where	(ds_sql IS NOT NULL AND ds_sql::text <> '');

BEGIN

dt_inicial_w	:= 'to_date('||''''||to_char(dt_inicial_p,'dd/mm/yyyy')||''','''||'dd/mm/yyyy'||''''||')';
dt_final_w	:= 'to_date('||''''||to_char(fim_dia(dt_final_p),'dd/mm/yyyy hh24:mi:ss')||''','''||'dd/mm/yyyy hh24:mi:ss'||''''||')';

open c01;
loop
fetch c01 into
	ds_macro_w,
	ds_sql_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin
	ds_sql_w := replace(ds_sql_w, ':dt_ini', dt_inicial_w);
	ds_sql_w := replace(ds_sql_w, ':dt_fim', dt_final_w);
	ds_sql_w := replace(ds_sql_w, ':cd_cgc', ''''||cd_cgc_p||'''');
	ds_sql_w := replace(ds_sql_w, ':cd_pessoa_fisica', ''''||cd_pessoa_fisica_p||'''');
	ds_sql_w := replace(ds_sql_w, ':nm_usuario', ''''||nm_usuario_p||'''');
	ds_sql_w := replace(ds_sql_w, ':cd_estabelecimento', ''''||obter_estabelecimento_ativo||'''');

	begin
	c001	:= dbms_sql.open_cursor;
	dbms_sql.parse(c001,ds_sql_w,dbms_sql.native);
	dbms_sql.define_column(c001, 1, vl_coluna_w, 17);
	vl_resultado_w	:= dbms_sql.execute(c001);
	vl_resultado_w	:= dbms_sql.fetch_rows(c001);
	dbms_sql.column_value(c001,1,vl_coluna_w);
	dbms_sql.close_cursor(c001);

	vl_resultado_w := coalesce(vl_coluna_w,0);

	ds_macro_w := '#A_'||ds_macro_w||'@';
	exception
	when others then
		begin
		vl_resultado_w := 0;
		ds_macro_w := '#E_'||ds_macro_w||'@';
		end;
	end;

	insert into w_fin_valor_capa(
		ds_macro,
		vl_resultado,
		nr_seq_formula,
		ds_sql,
		nm_usuario)
	values (ds_macro_w,
		vl_resultado_w,
		null,
		ds_sql_w,
		nm_usuario_p);
	end;
end loop;
close c01;

commit;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE fin_capa_ficha_financ_pck.fin_gerar_vl_atrib_capa ( dt_inicial_p timestamp, dt_final_p timestamp, cd_pessoa_fisica_p text, cd_cgc_p text, nm_usuario_p text) FROM PUBLIC;
