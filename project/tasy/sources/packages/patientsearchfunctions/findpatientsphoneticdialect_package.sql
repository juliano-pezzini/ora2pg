-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION patientsearchfunctions.findpatientsphoneticdialect ( pInSst text ,pInBirthL timestamp ,pInBirthH timestamp ,pInSex text ,pInCode text ,pInRNumL integer ,pInRNumH integer ) RETURNS PATIENTSEARCHFUNCTIONS.CURRESULT AS $body$
DECLARE

    l_cnt integer;
    v_sql_table varchar(4000);
    v_sql_insert varchar(4000);

BEGIN
    EXECUTE 'TRUNCATE TABLE W_PESSOA_FISICA_SEARCH';

    SELECT count(*) INTO STRICT l_cnt
    FROM all_objects
    WHERE object_type IN ('TABLE', 'VIEW')
      AND object_name = 'DF_PESSOA_FISICA';

    IF (l_cnt <= 0)
    THEN
         v_sql_table := 'CREATE TABLE "DF_PESSOA_FISICA" 
           (  "NR_SEQ_DIALECT_FIELD" NUMBER GENERATED BY DEFAULT AS IDENTITY MINVALUE 1 MAXVALUE 9999999999999999999999999999 INCREMENT BY 1 START WITH 1 CACHE 20 NOORDER  NOCYCLE  NOT NULL ENABLE, 
            "CD_ENTITY" VARCHAR2(50 BYTE) NOT NULL ENABLE, 
            "DS_DIALECT_FIELD_NAME" VARCHAR2(50 BYTE) NOT NULL ENABLE, 
            "DS_DIALECT_FIELD_VALUE" VARCHAR2(50 BYTE) NOT NULL ENABLE, 
            "DT_CREATION" DATE NOT NULL ENABLE, 
            "NM_CREATION_USER" VARCHAR2(15 BYTE) NOT NULL ENABLE, 
            "DT_UPDATE" DATE, 
            "NM_UPDATE_USER" VARCHAR2(15 BYTE), 
             CONSTRAINT "DF_PESSOA_FISICA_PK" PRIMARY KEY ("NR_SEQ_DIALECT_FIELD")
          )';

          EXECUTE v_sql_table;
    END IF;

    v_sql_insert := 'INSERT INTO W_PESSOA_FISICA_SEARCH
      SELECT /*+INDEX(T, PESSOA_FISICA_PHONETIC_INDEX)*/ cd_pessoa_fisica, nm_pessoa_fisica, dt_nascimento, ie_sexo, cd_pessoa_mae, "" AS matchRange
      FROM (
          SELECT cd_pessoa_fisica, nm_pessoa_fisica, dt_nascimento, ie_sexo, cd_pessoa_mae
          FROM PESSOA_FISICA T
          WHERE (' || pInSst || ' IS NULL OR GERA_FONETICA(nm_pessoa_fisica, "N") LIKE GERA_FONETICA(' || pInSst || ', "S"))
              AND (' || pInCode || ' IS NULL OR cd_pessoa_fisica LIKE "' || pInCode || '%")
              AND (' || pInBirthL || ' IS NULL OR dt_nascimento >= ' || pInBirthL || ')
              AND (' || pInBirthH || ' IS NULL OR dt_nascimento <= ' || pInBirthH || ')
              AND (' || pInSex || ' IS NULL OR ie_sexo = ' || pInSex || ') 
          UNION ALL
          SELECT T.cd_pessoa_fisica, DF.DS_DIALECT_FIELD_VALUE AS nm_pessoa_fisica, T.dt_nascimento, T.ie_sexo, T.cd_pessoa_mae
          FROM PESSOA_FISICA T
          INNER JOIN DF_PESSOA_FISICA DF
                ON DF.CD_ENTITY = T.CD_PESSOA_FISICA
                AND UPPER(DF.DS_DIALECT_FIELD_NAME) LIKE "NM_PESSOA_FISICA%"
          WHERE (' || pInSst || ' IS NULL OR GERA_FONETICA(DF.DS_DIALECT_FIELD_VALUE, "N") LIKE GERA_FONETICA(' || pInSst || ', "S"))
              AND (' || pInCode || ' IS NULL OR T.cd_pessoa_fisica LIKE ' || pInCode || '%")
              AND (' || pInBirthL || ' IS NULL OR T.dt_nascimento >= ' || pInBirthL || ')
              AND (' || pInBirthH || ' IS NULL OR T.dt_nascimento <= ' || pInBirthH || ')
              AND (' || pInSex || ' IS NULL OR T.ie_sexo = ' || pInSex || ') 
      )';

    EXECUTE v_sql_insert;

    RETURN patientsearchfunctions.fetchfromexisting(pInRNumL, pInRNumH);

  END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION patientsearchfunctions.findpatientsphoneticdialect ( pInSst text ,pInBirthL timestamp ,pInBirthH timestamp ,pInSex text ,pInCode text ,pInRNumL integer ,pInRNumH integer ) FROM PUBLIC;
