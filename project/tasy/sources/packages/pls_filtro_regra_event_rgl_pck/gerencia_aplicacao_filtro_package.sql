-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_filtro_regra_event_rgl_pck.gerencia_aplicacao_filtro ( nr_seq_regra_filtro_p pls_pp_cta_combinada.nr_sequencia%type, ie_tipo_regra_p pls_pp_cta_combinada.ie_tipo_regra%type, dt_inicio_vigencia_p pls_pp_cta_combinada.dt_inicio_vigencia%type, dt_fim_vigencia_p pls_pp_cta_combinada.dt_fim_vigencia%type, nr_id_transacao_p pls_pp_cta_rec_selecao.nr_id_transacao%type, nr_seq_analise_rec_p pls_analise_conta.nr_sequencia%type, nr_seq_prot_rec_p pls_rec_glosa_protocolo.nr_sequencia%type, nr_seq_cta_rec_p pls_rec_glosa_conta.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE

					
-- controle para saber quando e necessario restringir apenas os registros que estao na tabela de selecao

ie_considera_tab_selecao_w 	boolean;
qt_filtro_processado_w		integer;
ie_processou_filtro_w		boolean;

c_conf_filtro CURSOR(nr_seq_regra_filtro_pc	pls_pp_cta_combinada.nr_sequencia%type) FOR
	SELECT	a.nr_sequencia nr_seq_filtro,
		a.ie_filtro_conta,
		a.ie_filtro_beneficiario,
		a.ie_filtro_prestador,
		a.ie_filtro_procedimento,
		a.ie_filtro_material,
		a.ie_excecao
	from	pls_pp_cta_filtro a
	where	a.nr_seq_pp_combinada = nr_seq_regra_filtro_pc
	and	a.ie_situacao = 'A'
	order by a.ie_excecao,
		 a.nr_sequencia;
		
BEGIN

-- abre os "cabecalhos" das configuracoes de filtros

for r_c_conf_filtro_w in c_conf_filtro(nr_seq_regra_filtro_p) loop

	-- faz a devida alimentacao dos campos de acordo com o tipo de regra para realizar o correto processamento dos filtros

	CALL CALL CALL CALL CALL pls_filtro_regra_event_rgl_pck.prepara_reg_proces_filtro(nr_id_transacao_p, r_c_conf_filtro_w.ie_excecao);
	
	-- so considera a tabela de selecao quando for filtro de excecao (retira registros) para qualquer outro caso nao considerar, pois serao inseridos registros a nivel de filtro

	if (r_c_conf_filtro_w.ie_excecao = 'S') then
		ie_considera_tab_selecao_w := true;
	else
		ie_considera_tab_selecao_w := false;
	end if;
	
	ie_processou_filtro_w := false;
	
	-- filtro de conta

	if (r_c_conf_filtro_w.ie_filtro_conta = 'S') then
		SELECT * FROM pls_filtro_regra_event_rgl_pck.aplica_filtro_conta(	ie_considera_tab_selecao_w, qt_filtro_processado_w, ie_tipo_regra_p, nr_id_transacao_p, r_c_conf_filtro_w.ie_excecao, r_c_conf_filtro_w.nr_seq_filtro, dt_inicio_vigencia_p, dt_fim_vigencia_p, nr_seq_analise_rec_p, nr_seq_prot_rec_p, nr_seq_cta_rec_p, cd_estabelecimento_p, nm_usuario_p) INTO STRICT 	ie_considera_tab_selecao_w, qt_filtro_processado_w;
					
		if (qt_filtro_processado_w > 0) then
			ie_processou_filtro_w := true;
		end if;
	end if;
	
	-- filtro de beneficiario

	if (r_c_conf_filtro_w.ie_filtro_beneficiario = 'S') then
		SELECT * FROM pls_filtro_regra_event_rgl_pck.aplica_filtro_beneficiario(	ie_considera_tab_selecao_w, qt_filtro_processado_w, ie_tipo_regra_p, nr_id_transacao_p, r_c_conf_filtro_w.ie_excecao, r_c_conf_filtro_w.nr_seq_filtro, dt_inicio_vigencia_p, dt_fim_vigencia_p, nr_seq_analise_rec_p, nr_seq_prot_rec_p, nr_seq_cta_rec_p, cd_estabelecimento_p, nm_usuario_p) INTO STRICT 	ie_considera_tab_selecao_w, qt_filtro_processado_w;
						
		if (qt_filtro_processado_w > 0) then
			ie_processou_filtro_w := true;
		end if;
	end if;
	
	-- filtro de prestador

	if (r_c_conf_filtro_w.ie_filtro_prestador = 'S') then
		SELECT * FROM pls_filtro_regra_event_rgl_pck.aplica_filtro_prestador(	ie_considera_tab_selecao_w, qt_filtro_processado_w, ie_tipo_regra_p, nr_id_transacao_p, r_c_conf_filtro_w.ie_excecao, r_c_conf_filtro_w.nr_seq_filtro, dt_inicio_vigencia_p, dt_fim_vigencia_p, nr_seq_analise_rec_p, nr_seq_prot_rec_p, nr_seq_cta_rec_p, cd_estabelecimento_p, nm_usuario_p) INTO STRICT 	ie_considera_tab_selecao_w, qt_filtro_processado_w;
						
		if (qt_filtro_processado_w > 0) then
			ie_processou_filtro_w := true;
		end if;
	end if;
	
	-- filtro de procedimento

	if (r_c_conf_filtro_w.ie_filtro_procedimento = 'S') then
		SELECT * FROM pls_filtro_regra_event_rgl_pck.aplica_filtro_procedimento(	ie_considera_tab_selecao_w, qt_filtro_processado_w, ie_tipo_regra_p, nr_id_transacao_p, r_c_conf_filtro_w.ie_excecao, r_c_conf_filtro_w.nr_seq_filtro, dt_inicio_vigencia_p, dt_fim_vigencia_p, nr_seq_analise_rec_p, nr_seq_prot_rec_p, nr_seq_cta_rec_p, cd_estabelecimento_p, nm_usuario_p) INTO STRICT 	ie_considera_tab_selecao_w, qt_filtro_processado_w;
						
		if (qt_filtro_processado_w > 0) then
			ie_processou_filtro_w := true;
		end if;
	end if;
	
	-- filtro de material

	if (r_c_conf_filtro_w.ie_filtro_material = 'S') then
		SELECT * FROM pls_filtro_regra_event_rgl_pck.aplica_filtro_material(	ie_considera_tab_selecao_w, qt_filtro_processado_w, ie_tipo_regra_p, nr_id_transacao_p, r_c_conf_filtro_w.ie_excecao, r_c_conf_filtro_w.nr_seq_filtro, dt_inicio_vigencia_p, dt_fim_vigencia_p, nr_seq_analise_rec_p, nr_seq_prot_rec_p, nr_seq_cta_rec_p, cd_estabelecimento_p, nm_usuario_p) INTO STRICT 	ie_considera_tab_selecao_w, qt_filtro_processado_w;
					
		if (qt_filtro_processado_w > 0) then
			ie_processou_filtro_w := true;
		end if;
	end if;
	
	-- quando for excecao, busca tudo o que tiver o ie_excecao = S e coloca o ie_valido = N pois se caiu na excecao nao deve casar

	CALL CALL CALL CALL CALL pls_filtro_regra_event_rgl_pck.atualiza_sel_excecao_end(nr_id_transacao_p, ie_processou_filtro_w, r_c_conf_filtro_w.ie_excecao);
end loop;

-- limpa tudo o que for invalido, porque na tabela de selecao so podera ser utilizado o que for ie_valido = S nos passos seguintes

CALL CALL CALL CALL CALL CALL pls_filtro_regra_event_rgl_pck.limpar_invalidos(nr_id_transacao_p);

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_filtro_regra_event_rgl_pck.gerencia_aplicacao_filtro ( nr_seq_regra_filtro_p pls_pp_cta_combinada.nr_sequencia%type, ie_tipo_regra_p pls_pp_cta_combinada.ie_tipo_regra%type, dt_inicio_vigencia_p pls_pp_cta_combinada.dt_inicio_vigencia%type, dt_fim_vigencia_p pls_pp_cta_combinada.dt_fim_vigencia%type, nr_id_transacao_p pls_pp_cta_rec_selecao.nr_id_transacao%type, nr_seq_analise_rec_p pls_analise_conta.nr_sequencia%type, nr_seq_prot_rec_p pls_rec_glosa_protocolo.nr_sequencia%type, nr_seq_cta_rec_p pls_rec_glosa_conta.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;
