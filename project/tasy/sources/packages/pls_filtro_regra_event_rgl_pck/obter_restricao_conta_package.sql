-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pls_filtro_regra_event_rgl_pck.obter_restricao_conta ( ie_tipo_guia_p pls_pp_cta_filtro_conta.ie_tipo_guia%type, ie_tipo_guia_princ_p pls_pp_cta_filtro_conta.ie_tipo_guia_princ%type, nr_seq_tipo_atendimento_p pls_pp_cta_filtro_conta.nr_seq_tipo_atendimento%type, nr_seq_tipo_atend_princ_p pls_pp_cta_filtro_conta.nr_seq_tipo_atend_princ%type, ie_origem_conta_p pls_pp_cta_filtro_conta.ie_origem_conta%type, ie_apresentacao_p pls_pp_cta_filtro_conta.ie_apresentacao%type, ie_regime_atend_princ_p pls_pp_cta_filtro_conta.ie_regime_atend_princ%type, ie_regime_atendimento_p pls_pp_cta_filtro_conta.ie_regime_atendimento%type, ie_saude_ocupacional_p pls_pp_cta_filtro_conta.ie_saude_ocupacional%type, ds_campos_p out text, valor_bind_p INOUT sql_pck.t_dado_bind) AS $body$
DECLARE

				
dados_restricao_w		varchar(2000);
ds_campos_w			varchar(500);
dados_restricao_guia_princ_w	varchar(2000);
ds_alias_conta_orig_w		varchar(60);
ds_alias_prot_orig_w		varchar(60);


BEGIN

-- inicializar o retorno

dados_restricao_w := null;
ds_campos_w := null;
ds_alias_conta_orig_w := pls_filtro_regra_event_rgl_pck.obter_alias_tabela('conta_original');
ds_alias_prot_orig_w := pls_filtro_regra_event_rgl_pck.obter_alias_tabela('protocolo_original');

-- tipo guia

if (ie_tipo_guia_p IS NOT NULL AND ie_tipo_guia_p::text <> '') then
	dados_restricao_w := dados_restricao_w || ' and	' || ds_alias_conta_orig_w || '.ie_tipo_guia = :ie_tipo_guia_pc' || pls_util_pck.enter_w;
	valor_bind_p := sql_pck.bind_variable(':ie_tipo_guia_pc', ie_tipo_guia_p, valor_bind_p);
end if;

-- neste bloco tratamos os campos de guia principal

if (ie_tipo_guia_princ_p IS NOT NULL AND ie_tipo_guia_princ_p::text <> '') or (nr_seq_tipo_atend_princ_p IS NOT NULL AND nr_seq_tipo_atend_princ_p::text <> '') or (ie_regime_atend_princ_p IS NOT NULL AND ie_regime_atend_princ_p::text <> '') then
	
	-- tipo guia principal

	if (ie_tipo_guia_princ_p IS NOT NULL AND ie_tipo_guia_princ_p::text <> '') then
		dados_restricao_guia_princ_w	:= dados_restricao_guia_princ_w || ' and x.ie_tipo_guia = :ie_tipo_guia_princ_pc ' || pls_util_pck.enter_w;
		valor_bind_p := sql_pck.bind_variable(':ie_tipo_guia_princ_pc', ie_tipo_guia_princ_p, valor_bind_p);
	end if;
	
	-- tipo atendimento principal

	if (nr_seq_tipo_atend_princ_p IS NOT NULL AND nr_seq_tipo_atend_princ_p::text <> '') then
		dados_restricao_guia_princ_w	:= dados_restricao_guia_princ_w || ' and x.nr_seq_tipo_atendimento = :nr_seq_tipo_atend_princ_pc ' || pls_util_pck.enter_w;
		valor_bind_p := sql_pck.bind_variable(':nr_seq_tipo_atend_princ_pc', nr_seq_tipo_atend_princ_p, valor_bind_p);
	end if;
	
	-- regime atendimento principal

	if (ie_regime_atend_princ_p IS NOT NULL AND ie_regime_atend_princ_p::text <> '') then
		dados_restricao_guia_princ_w	:= dados_restricao_guia_princ_w || ' and x.ie_regime_atendimento = :ie_regime_atend_princ_pc ' || pls_util_pck.enter_w;
		valor_bind_p := sql_pck.bind_variable(':ie_regime_atend_princ_pc', ie_regime_atend_princ_p, valor_bind_p);
	end if;
	
	dados_restricao_w := dados_restricao_w || ' and exists( select	1 ' || pls_util_pck.enter_w ||
						  '		from	pls_conta x ' || pls_util_pck.enter_w ||
						  '		where	x.nr_sequencia = ' || ds_alias_conta_orig_w || '.nr_seq_conta_princ ' || pls_util_pck.enter_w ||
								dados_restricao_guia_princ_w || ')' || pls_util_pck.enter_w;
end if;

-- tipo atendimento

if (nr_seq_tipo_atendimento_p IS NOT NULL AND nr_seq_tipo_atendimento_p::text <> '') then
	dados_restricao_w := dados_restricao_w || ' and ' || ds_alias_conta_orig_w || '.nr_seq_tipo_atendimento = :nr_seq_tipo_atendimento_pc ' || pls_util_pck.enter_w;
	valor_bind_p := sql_pck.bind_variable(':nr_seq_tipo_atendimento_pc', nr_seq_tipo_atendimento_p, valor_bind_p);
end if;

-- origem conta

if (ie_origem_conta_p IS NOT NULL AND ie_origem_conta_p::text <> '') then
	dados_restricao_w := dados_restricao_w || ' and	' || ds_alias_conta_orig_w || '.ie_origem_conta = :ie_origem_conta_pc' || pls_util_pck.enter_w;
	valor_bind_p := sql_pck.bind_variable(':ie_origem_conta_pc', ie_origem_conta_p, valor_bind_p);
end if;

if (ie_apresentacao_p IS NOT NULL AND ie_apresentacao_p::text <> '') and (ie_apresentacao_p != 'T') then
	dados_restricao_w := dados_restricao_w || ' and	' || ds_alias_prot_orig_w || '.ie_apresentacao = :ie_apresentacao_pc' || pls_util_pck.enter_w;
	valor_bind_p := sql_pck.bind_variable(':ie_apresentacao_pc', ie_apresentacao_p, valor_bind_p);
end if;

if (ie_regime_atendimento_p IS NOT NULL AND ie_regime_atendimento_p::text <> '') then
	dados_restricao_w := dados_restricao_w || ' and	' || ds_alias_conta_orig_w || '.ie_regime_atendimento = :ie_regime_atendimento_pc' || pls_util_pck.enter_w;
	valor_bind_p := sql_pck.bind_variable(':ie_regime_atendimento_pc', ie_regime_atendimento_p, valor_bind_p);
end if;

if (ie_saude_ocupacional_p IS NOT NULL AND ie_saude_ocupacional_p::text <> '') then
	dados_restricao_w := dados_restricao_w || ' and	' || ds_alias_conta_orig_w || '.ie_saude_ocupacional = :ie_saude_ocupacional_pc' || pls_util_pck.enter_w;
	valor_bind_p := sql_pck.bind_variable(':ie_saude_ocupacional_pc', ie_saude_ocupacional_p, valor_bind_p);
end if;

ds_campos_p := ds_campos_w;

return;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pls_filtro_regra_event_rgl_pck.obter_restricao_conta ( ie_tipo_guia_p pls_pp_cta_filtro_conta.ie_tipo_guia%type, ie_tipo_guia_princ_p pls_pp_cta_filtro_conta.ie_tipo_guia_princ%type, nr_seq_tipo_atendimento_p pls_pp_cta_filtro_conta.nr_seq_tipo_atendimento%type, nr_seq_tipo_atend_princ_p pls_pp_cta_filtro_conta.nr_seq_tipo_atend_princ%type, ie_origem_conta_p pls_pp_cta_filtro_conta.ie_origem_conta%type, ie_apresentacao_p pls_pp_cta_filtro_conta.ie_apresentacao%type, ie_regime_atend_princ_p pls_pp_cta_filtro_conta.ie_regime_atend_princ%type, ie_regime_atendimento_p pls_pp_cta_filtro_conta.ie_regime_atendimento%type, ie_saude_ocupacional_p pls_pp_cta_filtro_conta.ie_saude_ocupacional%type, ds_campos_p out text, valor_bind_p INOUT sql_pck.t_dado_bind) FROM PUBLIC;
