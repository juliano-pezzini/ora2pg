-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pls_filtro_regra_event_rgl_pck.obter_restricao_padrao ( ie_tipo_regra_p pls_pp_cta_combinada.ie_tipo_regra%type, dt_inicio_vigencia_p pls_pp_cta_combinada.dt_inicio_vigencia%type, dt_fim_vigencia_p pls_pp_cta_combinada.dt_fim_vigencia%type, nr_seq_analise_rec_p pls_analise_conta.nr_sequencia%type, nr_seq_prot_rec_p pls_rec_glosa_protocolo.nr_sequencia%type, nr_seq_cta_rec_p pls_rec_glosa_conta.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, ds_restricao_mat_p out text, ds_restricao_proc_p out text, valor_bind_p INOUT sql_pck.t_dado_bind) AS $body$
DECLARE

					
ds_restricao_w 		varchar(4000);
ds_restricao_mat_w	varchar(4000);
ds_restricao_proc_w	varchar(4000);

ds_alias_con_w		varchar(60);
ds_alias_con_orig_w	varchar(60);
ds_alias_pro_orig_w	varchar(60);
ds_alias_mat_orig_w	varchar(60);


BEGIN

-- inicia a variavel com null

ds_restricao_w := null;

ds_alias_con_w := pls_filtro_regra_event_rgl_pck.obter_alias_tabela('conta');
ds_alias_con_orig_w := pls_filtro_regra_event_rgl_pck.obter_alias_tabela('conta_original');
ds_alias_mat_orig_w := pls_filtro_regra_event_rgl_pck.obter_alias_tabela('material_original');
ds_alias_pro_orig_w := pls_filtro_regra_event_rgl_pck.obter_alias_tabela('procedimento_original');

-- tratamento para inicio e fim de vigencia

if (dt_inicio_vigencia_p IS NOT NULL AND dt_inicio_vigencia_p::text <> '') then
	
	if (ie_tipo_regra_p = 'M') then	-- regra material
		ds_restricao_mat_w := ds_restricao_mat_w || ' and ' || ds_alias_mat_orig_w || '.dt_atendimento_referencia between :dt_inicio_vigencia_pc and :dt_fim_vigencia_pc ' || pls_util_pck.enter_w;		
	elsif (ie_tipo_regra_p = 'P') then	-- regra procedimento
		ds_restricao_proc_w := ds_restricao_proc_w || ' and ' || ds_alias_pro_orig_w || '.dt_procedimento_referencia between :dt_inicio_vigencia_pc and :dt_fim_vigencia_pc ' || pls_util_pck.enter_w;
	else	-- regra conta
		ds_restricao_w := ds_restricao_w || ' and ' || ds_alias_con_orig_w || '.dt_atendimento_referencia between :dt_inicio_vigencia_pc and :dt_fim_vigencia_pc ' || pls_util_pck.enter_w;
	end if;
	
	valor_bind_p := sql_pck.bind_variable(':dt_inicio_vigencia_pc', dt_inicio_vigencia_p, valor_bind_p);
	valor_bind_p := sql_pck.bind_variable(':dt_fim_vigencia_pc', dt_fim_vigencia_p, valor_bind_p);
end if;

-- analise

if (nr_seq_analise_rec_p IS NOT NULL AND nr_seq_analise_rec_p::text <> '') then
	ds_restricao_w := ds_restricao_w || 'and ' || ds_alias_con_w || '.nr_seq_analise = :nr_seq_analise_pc ' || pls_util_pck.enter_w;
	valor_bind_p := sql_pck.bind_variable(':nr_seq_analise_pc', nr_seq_analise_rec_p, valor_bind_p);
end if;

-- protocolo

if (nr_seq_prot_rec_p IS NOT NULL AND nr_seq_prot_rec_p::text <> '') then
	ds_restricao_w := ds_restricao_w || 'and ' || ds_alias_con_w || '.nr_seq_protocolo = :nr_seq_protocolo_pc ' || pls_util_pck.enter_w;
	valor_bind_p := sql_pck.bind_variable(':nr_seq_protocolo_pc', nr_seq_prot_rec_p, valor_bind_p);
end if;

-- conta

if (nr_seq_cta_rec_p IS NOT NULL AND nr_seq_cta_rec_p::text <> '') then
	ds_restricao_w := ds_restricao_w || ' and ' || ds_alias_con_w || '.nr_sequencia = :nr_seq_conta_pc ' || pls_util_pck.enter_w;
	valor_bind_p := sql_pck.bind_variable(':nr_seq_conta_pc', nr_seq_cta_rec_p, valor_bind_p);
end if;

-- parametros OUT

ds_restricao_mat_p	:= ds_restricao_mat_w;
ds_restricao_proc_p	:= ds_restricao_proc_w;

-- retorna a restricao que sera utilizada no select

return;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pls_filtro_regra_event_rgl_pck.obter_restricao_padrao ( ie_tipo_regra_p pls_pp_cta_combinada.ie_tipo_regra%type, dt_inicio_vigencia_p pls_pp_cta_combinada.dt_inicio_vigencia%type, dt_fim_vigencia_p pls_pp_cta_combinada.dt_fim_vigencia%type, nr_seq_analise_rec_p pls_analise_conta.nr_sequencia%type, nr_seq_prot_rec_p pls_rec_glosa_protocolo.nr_sequencia%type, nr_seq_cta_rec_p pls_rec_glosa_conta.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, ds_restricao_mat_p out text, ds_restricao_proc_p out text, valor_bind_p INOUT sql_pck.t_dado_bind) FROM PUBLIC;
