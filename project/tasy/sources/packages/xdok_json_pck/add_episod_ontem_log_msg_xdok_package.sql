-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE xdok_json_pck.add_episod_ontem_log_msg_xdok () AS $body$
DECLARE


episodios CURSOR FOR
SELECT  b.nr_sequencia nr_seq_episodio
from    episodio_paciente b
where   trunc(b.dt_episodio) = trunc(clock_timestamp() - interval '1 days')
and     not exists (    SELECT  1
                        from    log_mensagem_xdok x
                        where   x.cd_estabelecimento = b.cd_estabelecimento
                        and     x.nr_episodio = b.nr_episodio)
and     coalesce(b.dt_fim_episodio::text, '') = ''
and     coalesce(b.dt_cancelamento::text, '') = '';

ds_json_w text;

BEGIN
    for episodio in episodios loop
    begin
        ds_json_w := xdok_json_pck.get_json_xdok(episodio.nr_seq_episodio);
    end;
end loop;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE xdok_json_pck.add_episod_ontem_log_msg_xdok () FROM PUBLIC;
