-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION xdok_json_pck.get_xdok_converter_externo ( nm_tabela_p text, nm_atributo_p text, ds_valor_p text ) RETURNS varchar AS $body$
DECLARE


cd_externo_w             conversao_meio_externo.cd_externo%type;
cont_w                   bigint;
nm_tabela_referencia_w   integridade_referencial.nm_tabela_referencia%type;
nm_atributo_w            indice_atributo.nm_atributo%type;
ie_sequencia_criacao_w   integridade_atributo.ie_sequencia_criacao%type;
ie_consistir_fk_w        varchar(1) := 'N';
nr_seq_regra_w           conversao_meio_externo.nr_seq_regra%type;

BEGIN
    ie_consistir_fk_w := 'N';
    nm_tabela_referencia_w := nm_tabela_p;
    nm_atributo_w := nm_atributo_p;
    loop begin
    begin
        /*'busca o nome da tabela_referencia'*/

        select  a.nm_tabela_referencia,
                b.ie_sequencia_criacao
        into STRICT    nm_tabela_referencia_w,
                ie_sequencia_criacao_w
        from    integridade_referencial   a,
                integridade_atributo      b
        where   a.nm_tabela = b.nm_tabela
        and     a.nm_integridade_referencial = b.nm_integridade_referencial
        and     a.nm_tabela = nm_tabela_referencia_w
        and     b.nm_atributo = nm_atributo_w  LIMIT 1;
        exception
            when others then
                exit;
        end;

        /*'busca o nome do atributo que e pk da tabela referencia'*/

        select  b.nm_atributo
        into STRICT    nm_atributo_w
        from    indice            a,
                indice_atributo   b
        where   a.nm_tabela = b.nm_tabela
        and     a.nm_indice = b.nm_indice
        and     a.nm_tabela = nm_tabela_referencia_w
        and     b.nr_sequencia = ie_sequencia_criacao_w
        and     a.ie_tipo = 'PK';

        ie_consistir_fk_w := 'S';
        end;
    end loop;

    if ( ie_consistir_fk_w = 'N' ) then
    begin
        nm_tabela_referencia_w := nm_tabela_p;
        nm_atributo_w := nm_atributo_p;
    end;
    end if;

    begin
    select  nr_sequencia
    into STRICT    nr_seq_regra_w
    from    regra_conv_meio_ext
    where   upper(ds_regra) like '%XDOK%';
    exception
    when others then
        nr_seq_regra_w := null;
    end;

    begin
    select  a.cd_externo
    into STRICT    cd_externo_w
    from    conversao_meio_externo a
    where   a.nr_seq_regra = nr_seq_regra_w
    and     a.nm_tabela = nm_tabela_referencia_w
    and     a.nm_atributo = nm_atributo_w
    and     a.cd_interno = ds_valor_p;
    exception
    when others then
        cd_externo_w := ds_valor_p;
    end;

return cd_externo_w;
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION xdok_json_pck.get_xdok_converter_externo ( nm_tabela_p text, nm_atributo_p text, ds_valor_p text ) FROM PUBLIC;
