-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION xdok_json_pck.get_scoring_data ( nr_seq_episodio_p bigint ) RETURNS PHILIPS_JSON AS $body$
DECLARE


json_scoring_w   philips_json;
scoring_data_w   scoring_data%rowtype;

x05 CURSOR FOR
SELECT  xdok_json_pck.get_sistema_externo(null, ap1.cd_estabelecimento) hospitalid,
        ap1.nr_atendimento        nr_atendimento_ap,
        ap1.nr_seq_episodio       casenumber,
        ap1.cd_pessoa_fisica      cd_pessoa_fisica_ap,
        ap1.ie_tipo_atendimento   ie_tipo_atendimento_ap,
        to_char(ap1.dt_entrada, 'dd/mm/yyyy hh24:mi:ss') entrydate
from    atendimento_paciente ap1
where   ap1.nr_seq_episodio = nr_seq_episodio_p;

BEGIN
json_scoring_w := philips_json();
for r_x05 in x05 loop
begin
    begin
    select  *
    into STRICT    scoring_data_w
    from    scoring_data
    where   nr_case = r_x05.casenumber;
    exception
    when others then
        scoring_data_w.nr_sequencia := null;
    end;

    json_scoring_w := xdok_json_pck.add_json_value(json_scoring_w, 'hospitalID', r_x05.hospitalid);
    json_scoring_w := xdok_json_pck.add_json_value(json_scoring_w, 'caseNumber', r_x05.casenumber);
    json_scoring_w := xdok_json_pck.add_json_value(json_scoring_w, 'recordID', '');
    json_scoring_w := xdok_json_pck.add_json_value(json_scoring_w, 'entryDate', r_x05.entrydate);
    json_scoring_w := xdok_json_pck.add_json_value(json_scoring_w, 'groupCode', scoring_data_w.cd_billing_group);
    json_scoring_w := xdok_json_pck.add_json_value(json_scoring_w, 'node', scoring_data_w.cd_billing_node);
    json_scoring_w := xdok_json_pck.add_json_value(json_scoring_w, 'performanceServicePoints', scoring_data_w.qt_performance_points);
    json_scoring_w := xdok_json_pck.add_json_value(json_scoring_w, 'dailyContactPoint', scoring_data_w.qt_contact_points);
    json_scoring_w := xdok_json_pck.add_json_value(json_scoring_w, 'durationPoints', scoring_data_w.qt_duration_points);
    json_scoring_w := xdok_json_pck.add_json_value(json_scoring_w, 'creditPoints', scoring_data_w.qt_credit_points);
    json_scoring_w := xdok_json_pck.add_json_value(json_scoring_w, 'additionalPoints', scoring_data_w.qt_additional_points);
    json_scoring_w := xdok_json_pck.add_json_value(json_scoring_w, 'intensivePoints', scoring_data_w.qt_add_points_intensive);
    json_scoring_w := xdok_json_pck.add_json_value(json_scoring_w, 'multipleBenefitsPoints', scoring_data_w.qt_add_points_multiple);
    json_scoring_w := xdok_json_pck.add_json_value(json_scoring_w, 'specificAreaPoints', scoring_data_w.qt_points_specific_area);
    json_scoring_w := xdok_json_pck.add_json_value(json_scoring_w, 'totalScore', scoring_data_w.qt_total_points);
end;
end loop;

return json_scoring_w;
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION xdok_json_pck.get_scoring_data ( nr_seq_episodio_p bigint ) FROM PUBLIC;
