-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pfcs_pck_utils.get_histogram_hours (nr_seq_indicator_p bigint, cd_option_p text) RETURNS bigint AS $body$
DECLARE

        CD_OPTION_PAST_W    CONSTANT PFCS_PCK_SUBTYPES.VARCHAR_1_T := 'P';

        cd_profile_w        pfcs_chart_config.cd_perfil%type;
        cd_establishment_w  pfcs_chart_config.cd_estabelecimento%type;
        nm_user_w           pfcs_chart_config.nm_usuario_regra%type;
        qt_past_hours_w     pfcs_chart_config.qt_hours_past%type;
        qt_future_hours_w   pfcs_chart_config.qt_hours_past%type;

BEGIN
        cd_profile_w := obter_perfil_ativo;
        cd_establishment_w := obter_estabelecimento_ativo;
        nm_user_w := obter_usuario_ativo;

        select  coalesce(max(v.qt_past_hours), 5) qt_past_hours,
                coalesce(22 - max(v.qt_past_hours), 12) qt_future_hours
        into STRICT    qt_past_hours_w,
                qt_future_hours_w
        from (
            SELECT  cfg.qt_hours_past qt_past_hours
            from    pfcs_chart_config cfg
            where   coalesce(cfg.nm_usuario_regra, nm_user_w) = nm_user_w and
                    coalesce(cfg.cd_perfil, cd_profile_w) = cd_profile_w and
                    coalesce(cfg.cd_estabelecimento, cd_establishment_w) = cd_establishment_w and
                    cfg.nr_seq_indicator = nr_seq_indicator_p
            order by    cfg.nm_usuario_regra,
                        cfg.cd_perfil,
                        cfg.cd_estabelecimento asc
        ) v LIMIT 1;

        return case when cd_option_p = CD_OPTION_PAST_W then qt_past_hours_w else qt_future_hours_w end;
    END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pfcs_pck_utils.get_histogram_hours (nr_seq_indicator_p bigint, cd_option_p text) FROM PUBLIC;
