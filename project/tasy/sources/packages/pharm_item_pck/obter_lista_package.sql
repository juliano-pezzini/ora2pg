-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pharm_item_pck.obter_lista ( nr_processo_p bigint, ie_param_lf_p text, ie_param_70_p text ) RETURNS SETOF T_OBJETO_ROW_DATA AS $body$
DECLARE

t_objeto_row_w		t_objeto_row;
cd_w	bigint;
ds_w	varchar(2000);
qt_w	double precision;
sl_w	double precision;
fn_w	varchar(200);
nr_seq_lf_w bigint;
dt_suspensao_w timestamp;
nr_seq_horario_w bigint;
ie_param_75_w varchar(1);

C01 CURSOR FOR
	SELECT	to_char(a.cd_material) cd,
		CASE WHEN obter_se_item_frac(a.nr_sequencia)='N' THEN substr(obter_desc_material(a.cd_material),1,100)  ELSE 'Frac - '||substr(obter_desc_material(a.cd_material),1,95) END  ds,
		CASE WHEN obter_se_item_frac(a.nr_sequencia)='N' THEN sum(coalesce(qt_dispensar_hor,CASE WHEN ie_param_75_w='S' THEN 1  ELSE 0 END ))  ELSE 1 END  qt,
		CASE WHEN obter_se_item_frac(a.nr_sequencia)='N' THEN sum(coalesce(qt_dispensar_hor,CASE WHEN ie_param_75_w='S' THEN 1  ELSE 0 END ))  ELSE 1 END  sl, '' fn,
		b.nr_seq_lote_fornec nr_seq_lf,
		a.dt_suspensao dt_suspensao,
		a.nr_sequencia nr_seq_horario
	from    prescr_material b,
		prescr_mat_hor a
	where	b.nr_prescricao = a.nr_prescricao
	and 	b.nr_sequencia = a.nr_seq_material
	and 	((coalesce(a.nr_seq_etiqueta::text, '') = '') or (ie_param_lf_p in ('C', 'X')))
	and 	coalesce(b.dt_suspensao::text, '') = ''
	and 	coalesce(a.dt_suspensao::text, '') = ''
	and 	coalesce(b.ie_regra_disp,'X') <> 'N'
	and 	a.nr_seq_processo = nr_processo_p
	and	obter_se_horario_liberado(a.dt_lib_horario, a.dt_horario) = 'S'
	and 	obter_se_conferencia_barras(a.cd_material, obter_setor_atendimento(obter_atendimento_prescr(b.nr_prescricao))) = 'S'
	and	coalesce(a.ie_situacao,'A') <> 'I'
	and	coalesce(b.ie_medicacao_paciente,'N') = 'N'
	and	coalesce(ie_param_70_p, 'N') = 'N'
	group by a.cd_material,a.dt_suspensao,b.nr_seq_lote_fornec,a.nr_sequencia,CASE WHEN obter_se_item_frac(a.nr_sequencia)='N' THEN substr(obter_desc_material(a.cd_material),1,100)  ELSE 'Frac - '||substr(obter_desc_material(a.cd_material),1,100) END
	
union

	SELECT	to_char(a.cd_material) cd,
		substr(obter_desc_material(a.cd_material),1,100) ds,
		CASE WHEN ie_param_75_w='S' THEN 1  ELSE 0 END  qt, CASE WHEN ie_param_75_w='S' THEN 1  ELSE 0 END  sl, '' fn,
		b.nr_seq_lote_fornec nr_seq_lf,
		a.dt_suspensao,
		a.nr_sequencia nr_seq_horario
	from	prescr_material b,
		prescr_mat_hor a
	where 	b.nr_prescricao = a.nr_prescricao
	and	b.nr_sequencia = a.nr_seq_material
	and	((coalesce(a.nr_seq_etiqueta::text, '') = '') or (ie_param_lf_p in ('C', 'X')))
	and	coalesce(b.dt_suspensao::text, '') = ''
	and	coalesce(a.dt_suspensao::text, '') = ''
	and	coalesce(b.ie_regra_disp,'X') = 'N'
	and	a.nr_seq_processo = nr_processo_p
	and	obter_se_horario_liberado(a.dt_lib_horario, a.dt_horario) = 'S'
	and	obter_se_conferencia_barras(a.cd_material, obter_setor_atendimento(obter_atendimento_prescr(b.nr_prescricao))) = 'S'
	and	coalesce(a.ie_situacao, 'A') <> 'I'
	and	coalesce(b.ie_medicacao_paciente,'N') = 'N'
	and	coalesce(ie_param_70_p, 'N') = 'N'
	group by a.cd_material, a.dt_suspensao, b.nr_seq_lote_fornec, a.nr_sequencia
	
union

	select 	obter_codigo_barras_processo(a.nr_seq_etiqueta, a.cd_material, 'F') cd,
		substr(obter_desc_expressao(346632)/*'manip/frac : '*/
 || obter_desc_material(a.cd_material),1,100) ds,
		1 qt, 1 sl, '' fn,
		b.nr_seq_lote_fornec nr_seq_lf,
		a.dt_suspensao,
		a.nr_sequencia nr_seq_horario
	from 	prescr_material b,
		prescr_mat_hor a
	where	b.nr_prescricao = a.nr_prescricao
	and	b.nr_sequencia = a.nr_seq_material
	and	coalesce(a.nr_seq_superior::text, '') = ''
	and	(a.nr_seq_etiqueta IS NOT NULL AND a.nr_seq_etiqueta::text <> '' AND ie_param_lf_p = 'N')
	and	a.nr_seq_processo = nr_processo_p
	and	obter_se_horario_liberado(a.dt_lib_horario, a.dt_horario) = 'S'
	and	obter_se_conferencia_barras(a.cd_material, obter_setor_atendimento(obter_atendimento_prescr(b.nr_prescricao))) = 'S'
	and 	coalesce(a.ie_situacao, 'A') <> 'I'
	and	coalesce(ie_param_70_p, 'N') = 'N'
	group by a.nr_seq_etiqueta, a.cd_material, a.dt_suspensao, b.nr_seq_lote_fornec, a.nr_sequencia
	
union

	select 	obter_codigo_barras_processo(a.nr_seq_etiqueta, a.cd_material, 'F') cd,
		substr(obter_desc_expressao(346632)|| obter_Concat_comp_sol(a.nr_prescricao, a.nr_seq_solucao),1,100) ds,
		1 qt, 1 sl, '' fn,
		b.nr_seq_lote_fornec nr_seq_lf,
		a.dt_suspensao,
		null nr_seq_horario
	from 	prescr_material b,
		prescr_mat_hor a
	where	b.nr_prescricao = a.nr_prescricao
	and	b.nr_sequencia = a.nr_seq_material
	and	coalesce(a.nr_seq_superior::text, '') = ''
	and	(a.nr_seq_etiqueta IS NOT NULL AND a.nr_seq_etiqueta::text <> '' AND ie_param_lf_p = 'N')
	and	a.nr_seq_processo = nr_processo_p
	and	obter_se_horario_liberado(a.dt_lib_horario, a.dt_horario) = 'S'
	and	obter_se_conferencia_barras(a.cd_material, obter_setor_atendimento(obter_atendimento_prescr(b.nr_prescricao))) = 'S'
	and 	coalesce(a.ie_situacao, 'A') <> 'I'
	and	coalesce(ie_param_70_p, 'N') = 'S'
	group by obter_codigo_barras_processo(a.nr_seq_etiqueta, a.cd_material, 'F'),
		substr(obter_desc_expressao(346632)|| obter_Concat_comp_sol(a.nr_prescricao, a.nr_seq_solucao),1,100),
		a.dt_suspensao,
		b.nr_seq_lote_fornec
	
union

	select	to_char(a.cd_material) cd,
		substr(obter_desc_material(a.cd_material),1,100) ds,
		1 qt, 1 sl, '' fn,
		b.nr_seq_lote_fornec nr_seq_lf,
		a.dt_suspensao, a.nr_sequencia nr_seq_horario
	from 	prescr_material b,
		prescr_mat_hor a
	where 	b.nr_prescricao = a.nr_prescricao
	and	b.nr_sequencia = a.nr_seq_material
	and	((coalesce(a.nr_seq_etiqueta::text, '') = '') or (ie_param_lf_p in ('C', 'X')))
	and	coalesce(b.dt_suspensao::text, '') = ''
	and	coalesce(a.dt_suspensao::text, '') = ''
	and	coalesce(b.ie_regra_disp,'X') = 'N'
	and	a.nr_seq_processo = nr_processo_p
	and	obter_se_horario_liberado(a.dt_lib_horario, a.dt_horario) = 'S'
	and	obter_se_conferencia_barras(a.cd_material, obter_setor_atendimento(obter_atendimento_prescr(b.nr_prescricao))) = 'S'
	and	coalesce(a.ie_situacao,'A') <> 'I'
	and	coalesce(b.ie_medicacao_paciente,'N') = 'S'
	and	coalesce(ie_param_70_p, 'N') = 'N'
	group by a.cd_material, a.dt_suspensao, b.nr_seq_lote_fornec, a.nr_sequencia
	
union

	select	to_char(a.cd_material) cd,
		substr(obter_desc_material(a.cd_material),1,100) ds,
		sum(coalesce(CASE WHEN coalesce(a.nr_seq_solucao::text, '') = '' THEN  qt_horario  ELSE CASE WHEN a.cd_unidade_medida=a.cd_unidade_medida_dose THEN  qt_horario  ELSE ceil(qt_horario) END  END ,0)) qt,
		sum(coalesce(CASE WHEN coalesce(a.nr_seq_solucao::text, '') = '' THEN  qt_horario  ELSE CASE WHEN a.cd_unidade_medida=a.cd_unidade_medida_dose THEN  qt_horario  ELSE ceil(qt_horario) END  END ,0)) sl,
		'' fn,
		b.nr_seq_lote_fornec nr_seq_lf,
		a.dt_suspensao dt_suspensao,
		a.nr_sequencia nr_seq_horario
	from    prescr_material b,
		prescr_mat_hor a
	where	b.nr_prescricao = a.nr_prescricao
	and 	b.nr_sequencia = a.nr_seq_material
	and 	((coalesce(a.nr_seq_etiqueta::text, '') = '') or (ie_param_lf_p in ('C', 'X')))
	and 	coalesce(b.dt_suspensao::text, '') = ''
	and 	coalesce(a.dt_suspensao::text, '') = ''
	and 	coalesce(b.ie_regra_disp,'X') <> 'N'
	and 	a.nr_seq_processo = nr_processo_p
	and 	obter_se_horario_liberado(a.dt_lib_horario, a.dt_horario) = 'S'
	and	obter_se_conferencia_barras(a.cd_material, obter_setor_atendimento(obter_atendimento_prescr(b.nr_prescricao))) = 'S'
	and	coalesce(a.ie_situacao,'A') <> 'I'
	and	coalesce(b.ie_medicacao_paciente,'N') = 'N'
	and	coalesce(ie_param_70_p, 'N') = 'S'
	group by a.cd_material,a.dt_suspensao,b.nr_seq_lote_fornec,a.nr_sequencia,substr(obter_desc_material(a.cd_material),1,100)
	order by ds;


BEGIN

ie_param_75_w := Wheb_assist_pck.obterParametroFuncao(-1113, 75, wheb_usuario_pck.get_cd_perfil, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento);

open C01;
loop
fetch C01 into	
	cd_w,
	ds_w,
	qt_w,
	sl_w,
	fn_w,
	nr_seq_lf_w,
	dt_suspensao_w,
	nr_seq_horario_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	t_objeto_row_w.cd	:= cd_w;
	t_objeto_row_w.ds	:= ds_w;
	t_objeto_row_w.qt	:= qt_w;
	t_objeto_row_w.sl	:= sl_w;
	t_objeto_row_w.fn	:= fn_w;
	t_objeto_row_w.nr_seq_lf	:= nr_seq_lf_w;
	t_objeto_row_w.dt_suspensao	:= dt_suspensao_w;
	t_objeto_row_w.nr_seq_horario	:= nr_seq_horario_w;
	RETURN NEXT t_objeto_row_w;
	end;
end loop;
close C01;

return;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pharm_item_pck.obter_lista ( nr_processo_p bigint, ie_param_lf_p text, ie_param_70_p text ) FROM PUBLIC;
