-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pls_mens_beneficiario_pck.obter_se_suspensao_fx_etaria ( dt_mesano_referencia_p pls_mensalidade_segurado.dt_mesano_referencia%type, ie_tipo_contratacao_p pls_plano.ie_tipo_contratacao%type, ie_regulamentacao_p pls_plano.ie_regulamentacao%type, ie_tipo_estipulante_p text, nr_seq_contrato_p pls_contrato.nr_sequencia%type, nr_seq_segurado_p pls_segurado.nr_sequencia%type) RETURNS bigint AS $body$
DECLARE


nr_seq_regra_susp_reaj_fx_w	pls_susp_reaj_fx_etaria.nr_sequencia%type;
dt_inicio_susp_aplicado_w	pls_susp_reaj_fx_etaria.dt_inicio_susp_aplicado%type;
dt_fim_susp_aplicado_w		pls_susp_reaj_fx_etaria.dt_fim_susp_aplicado%type;
qt_reaj_fx_w			integer;
ie_susp_reaj_aplicado_w		pls_susp_reaj_fx_etaria.ie_susp_reaj_aplicado%type;


BEGIN

select	max(a.nr_sequencia)
into STRICT	nr_seq_regra_susp_reaj_fx_w
from	pls_susp_reaj_fx_etaria a
where	a.cd_estabelecimento = cd_estabelecimento_p
and	dt_mesano_referencia_p between trunc(coalesce(a.dt_inicio_vigencia, dt_mesano_referencia_p), 'dd') and fim_mes(coalesce(a.dt_fim_vigencia, dt_mesano_referencia_p))
and	((coalesce(a.ie_tipo_contratacao::text, '') = '') or (a.ie_tipo_contratacao = ie_tipo_contratacao_p))
and	((coalesce(a.ie_regulamentacao::text, '') = '') or (a.ie_regulamentacao = ie_regulamentacao_p))
and	((a.ie_tipo_estipulante = 'A') or (a.ie_tipo_estipulante = ie_tipo_estipulante_p))
and	((coalesce(a.nr_seq_grupo_relac::text, '') = '') or (exists (	SELECT	1
							from	pls_contrato_grupo x
							where	x.nr_seq_grupo = a.nr_seq_grupo_relac
							and	x.nr_seq_contrato = nr_seq_contrato_p)))
and	((coalesce(a.nr_seq_tipo_aditamento::text, '') = '') or (not exists (	select	1
								from	pls_contrato_aditamento x
								where	x.nr_seq_contrato = nr_seq_contrato_p
								and	x.nr_seq_tipo_aditamento = a.nr_seq_tipo_aditamento
								and	x.ie_status_aditamento = 'A')));

if (nr_seq_regra_susp_reaj_fx_w IS NOT NULL AND nr_seq_regra_susp_reaj_fx_w::text <> '') then
	select	coalesce(ie_susp_reaj_aplicado, 'N'),
		trunc(dt_inicio_susp_aplicado, 'dd'),
		fim_mes(dt_fim_susp_aplicado)
	into STRICT	ie_susp_reaj_aplicado_w,
		dt_inicio_susp_aplicado_w,
		dt_fim_susp_aplicado_w
	from	pls_susp_reaj_fx_etaria
	where	nr_sequencia = nr_seq_regra_susp_reaj_fx_w;
	
	if (ie_susp_reaj_aplicado_w = 'N') then
		select	count(1)
		into STRICT	qt_reaj_fx_w
		from	pls_mensalidade a,
			pls_mensalidade_segurado b,
			pls_mensalidade_seg_item c
		where	a.nr_sequencia = b.nr_seq_mensalidade
		and	b.nr_sequencia = c.nr_seq_mensalidade_seg
		and	c.ie_tipo_item = '5'
		and	coalesce(a.ie_cancelamento::text, '') = ''
		and	coalesce(c.nr_seq_item_estorno::text, '') = ''
		and	b.nr_seq_segurado = nr_seq_segurado_p
		and	b.dt_mesano_referencia between dt_inicio_susp_aplicado_w and dt_fim_susp_aplicado_w
		and	not exists (	SELECT	1
					from	pls_mensalidade_seg_item x
					where	c.nr_sequencia = x.nr_seq_item_estorno);
	
		if (qt_reaj_fx_w > 0) then
			nr_seq_regra_susp_reaj_fx_w	:= null;
		end if;
	end if;
end if;
								
return	nr_seq_regra_susp_reaj_fx_w;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_mens_beneficiario_pck.obter_se_suspensao_fx_etaria ( dt_mesano_referencia_p pls_mensalidade_segurado.dt_mesano_referencia%type, ie_tipo_contratacao_p pls_plano.ie_tipo_contratacao%type, ie_regulamentacao_p pls_plano.ie_regulamentacao%type, ie_tipo_estipulante_p text, nr_seq_contrato_p pls_contrato.nr_sequencia%type, nr_seq_segurado_p pls_segurado.nr_sequencia%type) FROM PUBLIC;
