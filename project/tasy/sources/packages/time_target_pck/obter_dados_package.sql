-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION time_target_pck.obter_dados ( report_date_p timestamp ) RETURNS SETOF T_OBJETO_ROW_DATA AS $body$
DECLARE

    c01 CURSOR(dt_report_date_w timestamp )
    FOR
   SELECT row_number() OVER () AS row_number_dept, ds, qt from( SELECT  1  row_number_dept, 'OPERATING MINUTES' ds, NULL qt
    
UNION ALL

    SELECT 2  row_number_dept,'Operating Mins (Cardiac Cath Lab)' ds,
      coalesce(
      (SELECT SUM(nr_min_duracao_real)
      FROM cirurgia
      WHERE TRUNC(dt_inicio_real) = dt_report_date_w
      AND cd_setor_atendimento   IN (79533)
      ),0) qt
    
    
UNION ALL

    SELECT 3  row_number_dept,'Operating Mins (Endoscopy Rooms)' ds,
      coalesce(
      (SELECT SUM(nr_min_duracao_real)
      FROM cirurgia
      WHERE TRUNC(dt_inicio_real) = dt_report_date_w
      AND cd_setor_atendimento   IN (1062)
      ),0) qt
    
    
UNION ALL

    SELECT 4  row_number_dept, 'Operating Mins (Theatre 4 and Recovery)' ds,
      coalesce(
      (SELECT SUM(nr_min_duracao_real)
      FROM cirurgia
      WHERE TRUNC(dt_inicio_real) = dt_report_date_w
      AND cd_setor_atendimento   IN (47,1056,1055)
      ),0) qt
    
    
UNION ALL

    SELECT 5  row_number_dept, 'PATIENT DAYS' ds, NULL qt 
    
UNION ALL

    SELECT 6  row_number_dept, 'Patient Days (East)' ds,
      coalesce(obter_qt_pacientes_dia_setor(PKG_DATE_UTILS.START_OF(dt_report_date_w, 'DAY', 0),PKG_DATE_UTILS.END_OF(dt_report_date_w, 'DAY', 0),45),0) qt
    
    
UNION ALL

    SELECT 7  row_number_dept, 'Patient Days (Central)' ds,
      coalesce(obter_qt_pacientes_dia_setor(PKG_DATE_UTILS.START_OF(dt_report_date_w, 'DAY', 0),PKG_DATE_UTILS.END_OF(dt_report_date_w, 'DAY', 0),46),0) qt
    
    
UNION ALL

    SELECT 8  row_number_dept, 'Patient Days (Intensive Care Unit)' ds,
      coalesce(obter_qt_pacientes_dia_setor(PKG_DATE_UTILS.START_OF(dt_report_date_w, 'DAY', 0),PKG_DATE_UTILS.END_OF(dt_report_date_w, 'DAY', 0),12),0) qt
    
    
UNION ALL

    SELECT 9  row_number_dept, 'Patient Days (Cardiac Medical Unit)' ds,
      coalesce(obter_qt_pacientes_dia_setor(PKG_DATE_UTILS.START_OF(dt_report_date_w, 'DAY', 0),PKG_DATE_UTILS.END_OF(dt_report_date_w, 'DAY', 0),13),0) qt
    
    
UNION ALL

    SELECT  10  row_number_dept,'Patient Days (South)' ds,
      coalesce(obter_qt_pacientes_dia_setor(PKG_DATE_UTILS.START_OF(dt_report_date_w, 'DAY', 0),PKG_DATE_UTILS.END_OF(dt_report_date_w, 'DAY', 0),53),0) qt
    
    
UNION ALL

    SELECT 11  row_number_dept,'Patient Days (West)' ds,
      coalesce(obter_qt_pacientes_dia_setor(PKG_DATE_UTILS.START_OF(dt_report_date_w, 'DAY', 0),PKG_DATE_UTILS.END_OF(dt_report_date_w, 'DAY', 0),10),0) qt
    
    
UNION ALL

    SELECT 12  row_number_dept, 'Patient Days (North)' ds,
      coalesce(obter_qt_pacientes_dia_setor(PKG_DATE_UTILS.START_OF(dt_report_date_w, 'DAY', 0),PKG_DATE_UTILS.END_OF(dt_report_date_w, 'DAY', 0),11),0) qt
    
    
UNION ALL

    SELECT  13  row_number_dept, 'Total Patient Days' ds,
      coalesce(SUM(qt),0) qt
    FROM (SELECT 'Patient Days (East)' ds,
        obter_qt_pacientes_dia_setor(PKG_DATE_UTILS.START_OF(dt_report_date_w, 'DAY', 0),PKG_DATE_UTILS.END_OF(dt_report_date_w, 'DAY', 0),45) qt
      
      
UNION ALL

      SELECT 'Patient Days (Central)' ds,
        obter_qt_pacientes_dia_setor(PKG_DATE_UTILS.START_OF(dt_report_date_w, 'DAY', 0),PKG_DATE_UTILS.END_OF(dt_report_date_w, 'DAY', 0),46) qt
      
      
UNION ALL

      SELECT 'Patient Days (Intensive Care Unit)' ds,
        obter_qt_pacientes_dia_setor(PKG_DATE_UTILS.START_OF(dt_report_date_w, 'DAY', 0),PKG_DATE_UTILS.END_OF(dt_report_date_w, 'DAY', 0),12) qt
      
      
UNION ALL

      SELECT 'Patient Days (Cardiac Medical Unit)' ds,
        obter_qt_pacientes_dia_setor(PKG_DATE_UTILS.START_OF(dt_report_date_w, 'DAY', 0),PKG_DATE_UTILS.END_OF(dt_report_date_w, 'DAY', 0),13) qt
      
      
UNION ALL

      SELECT 'Patient Days (South)' ds,
        obter_qt_pacientes_dia_setor(PKG_DATE_UTILS.START_OF(dt_report_date_w, 'DAY', 0),PKG_DATE_UTILS.END_OF(dt_report_date_w, 'DAY', 0),53) qt
      
      
UNION ALL

      SELECT 'Patient Days (West)' ds,
        obter_qt_pacientes_dia_setor(PKG_DATE_UTILS.START_OF(dt_report_date_w, 'DAY', 0),PKG_DATE_UTILS.END_OF(dt_report_date_w, 'DAY', 0),10) qt
      
      
UNION ALL

      SELECT 'Patient Days (North)' ds,
        obter_qt_pacientes_dia_setor(PKG_DATE_UTILS.START_OF(dt_report_date_w, 'DAY', 0),PKG_DATE_UTILS.END_OF(dt_report_date_w, 'DAY', 0),11) qt
      
      ) alias67)
   order by row_number_dept;

BEGIN
    PERFORM set_config('time_target_pck.dt_curr_date_w', pkg_date_utils.start_of(report_date_p,'MONTH'), false);-- first date of month
    PERFORM set_config('time_target_pck.nr_curr_day_w', pkg_date_utils.extract_field('DAY',pkg_date_utils.start_of(report_date_p,'MONTH')), false);
    PERFORM set_config('time_target_pck.nr_end_day_w', pkg_date_utils.extract_field('DAY', PKG_DATE_UTILS.END_OF(report_date_p, 'MONTH')), false); --end date of month
FOR r2 IN 1.. current_setting('time_target_pck.nr_end_day_w')::bigint
LOOP
  BEGIN
    FOR r_c01 IN c01(current_setting('time_target_pck.dt_curr_date_w')::timestamp)
    LOOP
      BEGIN
        --raise_application_error(-20111,r2);
        current_setting('time_target_pck.t_objeto_row_w')::t_objeto_row.ds_department := r_c01.ds;
        current_setting('time_target_pck.t_objeto_row_w')::t_objeto_row.row_val       := r_c01.row_number_dept;
        IF (r2                         =1) THEN
          current_setting('time_target_pck.t_objeto_row_w')::t_objeto_row.Day1        := r_c01.qt;
        ELSE
          current_setting('time_target_pck.t_objeto_row_w')::t_objeto_row.Day1 := NULL;
        END IF;
        IF (r2                  =2) THEN
          current_setting('time_target_pck.t_objeto_row_w')::t_objeto_row.Day2 := r_c01.qt;
        ELSE
          current_setting('time_target_pck.t_objeto_row_w')::t_objeto_row.Day2 := NULL;
        END IF;
        IF (r2                  =3) THEN
          current_setting('time_target_pck.t_objeto_row_w')::t_objeto_row.Day3 := r_c01.qt;
        ELSE
          current_setting('time_target_pck.t_objeto_row_w')::t_objeto_row.Day3 := NULL;
        END IF;
        IF (r2                  =4) THEN
          current_setting('time_target_pck.t_objeto_row_w')::t_objeto_row.Day4 := r_c01.qt;
        ELSE
          current_setting('time_target_pck.t_objeto_row_w')::t_objeto_row.Day4 := NULL;
        END IF;
        IF (r2                  =5) THEN
          current_setting('time_target_pck.t_objeto_row_w')::t_objeto_row.Day5 := r_c01.qt;
        ELSE
          current_setting('time_target_pck.t_objeto_row_w')::t_objeto_row.Day5 := NULL;
        END IF;
        IF (r2                  =6) THEN
          current_setting('time_target_pck.t_objeto_row_w')::t_objeto_row.Day6 := r_c01.qt;
        ELSE
          current_setting('time_target_pck.t_objeto_row_w')::t_objeto_row.Day6 := NULL;
        END IF;
        IF (r2                  =7) THEN
          current_setting('time_target_pck.t_objeto_row_w')::t_objeto_row.Day7 := r_c01.qt;
        ELSE
          current_setting('time_target_pck.t_objeto_row_w')::t_objeto_row.Day7 := NULL;
        END IF;
        IF (r2                  =8) THEN
          current_setting('time_target_pck.t_objeto_row_w')::t_objeto_row.Day8 := r_c01.qt;
        ELSE
          current_setting('time_target_pck.t_objeto_row_w')::t_objeto_row.Day8 := NULL;
        END IF;
        IF (r2                  =9) THEN
          current_setting('time_target_pck.t_objeto_row_w')::t_objeto_row.Day9 := r_c01.qt;
        ELSE
          current_setting('time_target_pck.t_objeto_row_w')::t_objeto_row.Day9 := NULL;
        END IF;
        IF (r2                   =10) THEN
          current_setting('time_target_pck.t_objeto_row_w')::t_objeto_row.Day10 := r_c01.qt;
        ELSE
          current_setting('time_target_pck.t_objeto_row_w')::t_objeto_row.Day10 := NULL;
        END IF;
        IF (r2                   =11) THEN
          current_setting('time_target_pck.t_objeto_row_w')::t_objeto_row.Day11 := r_c01.qt;
        ELSE
          current_setting('time_target_pck.t_objeto_row_w')::t_objeto_row.Day11 := NULL;
        END IF;
        IF (r2                   =12) THEN
          current_setting('time_target_pck.t_objeto_row_w')::t_objeto_row.Day12 := r_c01.qt;
        ELSE
          current_setting('time_target_pck.t_objeto_row_w')::t_objeto_row.Day12 := NULL;
        END IF;
        IF (r2                   =13) THEN
          current_setting('time_target_pck.t_objeto_row_w')::t_objeto_row.Day13 := r_c01.qt;
        ELSE
          current_setting('time_target_pck.t_objeto_row_w')::t_objeto_row.Day13 := NULL;
        END IF;
        IF (r2                   =14) THEN
          current_setting('time_target_pck.t_objeto_row_w')::t_objeto_row.Day14 := r_c01.qt;
        ELSE
          current_setting('time_target_pck.t_objeto_row_w')::t_objeto_row.Day14 := NULL;
        END IF;
        IF (r2                   =15) THEN
          current_setting('time_target_pck.t_objeto_row_w')::t_objeto_row.Day15 := r_c01.qt;
        ELSE
          current_setting('time_target_pck.t_objeto_row_w')::t_objeto_row.Day15 := NULL;
        END IF;
        IF (r2                   =16) THEN
          current_setting('time_target_pck.t_objeto_row_w')::t_objeto_row.Day16 := r_c01.qt;
        ELSE
          current_setting('time_target_pck.t_objeto_row_w')::t_objeto_row.Day16 := NULL;
        END IF;
        IF (r2                   =17) THEN
          current_setting('time_target_pck.t_objeto_row_w')::t_objeto_row.Day17 := r_c01.qt;
        ELSE
          current_setting('time_target_pck.t_objeto_row_w')::t_objeto_row.Day17 := NULL;
        END IF;
        IF (r2                   =18) THEN
          current_setting('time_target_pck.t_objeto_row_w')::t_objeto_row.Day18 := r_c01.qt;
        ELSE
          current_setting('time_target_pck.t_objeto_row_w')::t_objeto_row.Day18 := NULL;
        END IF;
        IF (r2                   =19) THEN
          current_setting('time_target_pck.t_objeto_row_w')::t_objeto_row.Day19 := r_c01.qt;
        ELSE
          current_setting('time_target_pck.t_objeto_row_w')::t_objeto_row.Day19 := NULL;
        END IF;
        IF (r2                   =20) THEN
          current_setting('time_target_pck.t_objeto_row_w')::t_objeto_row.Day20 := r_c01.qt;
        ELSE
          current_setting('time_target_pck.t_objeto_row_w')::t_objeto_row.Day20 := NULL;
        END IF;
        IF (r2                   =21) THEN
          current_setting('time_target_pck.t_objeto_row_w')::t_objeto_row.Day21 := r_c01.qt;
        ELSE
          current_setting('time_target_pck.t_objeto_row_w')::t_objeto_row.Day21 := NULL;
        END IF;
        IF (r2                   =22) THEN
          current_setting('time_target_pck.t_objeto_row_w')::t_objeto_row.Day22 := r_c01.qt;
        ELSE
          current_setting('time_target_pck.t_objeto_row_w')::t_objeto_row.Day22 := NULL;
        END IF;
        IF (r2                   =23) THEN
          current_setting('time_target_pck.t_objeto_row_w')::t_objeto_row.Day23 := r_c01.qt;
        ELSE
          current_setting('time_target_pck.t_objeto_row_w')::t_objeto_row.Day23 := NULL;
        END IF;
        IF (r2                   =24) THEN
          current_setting('time_target_pck.t_objeto_row_w')::t_objeto_row.Day24 := r_c01.qt;
        ELSE
          current_setting('time_target_pck.t_objeto_row_w')::t_objeto_row.Day24 := NULL;
        END IF;
        IF (r2                   =25) THEN
          current_setting('time_target_pck.t_objeto_row_w')::t_objeto_row.Day25 := r_c01.qt;
        ELSE
          current_setting('time_target_pck.t_objeto_row_w')::t_objeto_row.Day25 := NULL;
        END IF;
        IF (r2                   =26) THEN
          current_setting('time_target_pck.t_objeto_row_w')::t_objeto_row.Day26 := r_c01.qt;
        ELSE
          current_setting('time_target_pck.t_objeto_row_w')::t_objeto_row.Day26 := NULL;
        END IF;
        IF (r2                   =27) THEN
          current_setting('time_target_pck.t_objeto_row_w')::t_objeto_row.Day27 := r_c01.qt;
        ELSE
          current_setting('time_target_pck.t_objeto_row_w')::t_objeto_row.Day27 := NULL;
        END IF;
        IF (r2                   =28) THEN
          current_setting('time_target_pck.t_objeto_row_w')::t_objeto_row.Day28 := r_c01.qt;
        ELSE
          current_setting('time_target_pck.t_objeto_row_w')::t_objeto_row.Day28 := NULL;
        END IF;
        IF (r2                   =29) THEN
          current_setting('time_target_pck.t_objeto_row_w')::t_objeto_row.Day29 := r_c01.qt;
        ELSE
          current_setting('time_target_pck.t_objeto_row_w')::t_objeto_row.Day29 := NULL;
        END IF;
        IF (r2                   =30) THEN
          current_setting('time_target_pck.t_objeto_row_w')::t_objeto_row.Day30 := r_c01.qt;
        ELSE
          current_setting('time_target_pck.t_objeto_row_w')::t_objeto_row.Day30 := NULL;
        END IF;
        IF (r2                   =31) THEN
          current_setting('time_target_pck.t_objeto_row_w')::t_objeto_row.Day31 := r_c01.qt;
        ELSE
          current_setting('time_target_pck.t_objeto_row_w')::t_objeto_row.Day31 := NULL;
        END IF;
        --           nr_curr_day_w              := nr_curr_day_w+1;
        --           dt_curr_date_w             := dt_curr_date_w +1;
        RETURN NEXT current_setting('time_target_pck.t_objeto_row_w'::t_objeto_row);
      END;
    END LOOP;
    PERFORM set_config('time_target_pck.dt_curr_date_w', current_setting('time_target_pck.dt_curr_date_w')::timestamp +1, false);

  END;
END LOOP;
  END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION time_target_pck.obter_dados ( report_date_p timestamp ) FROM PUBLIC;
