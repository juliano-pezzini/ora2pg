-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE reg_test_plan_pck.mark_items_as_excluded ( ds_motivo_exclusao_p text, nm_usuario_p text ) AS $body$
DECLARE


	nr_seq_controle_plano_w		reg_plano_teste_controle.nr_sequencia%type;
	ds_version_w			reg_tc_pendencies.ds_version%type;

	
BEGIN

		select	max(nr_sequencia)
		into STRICT	nr_seq_controle_plano_w
		from	reg_plano_teste_controle
		where	coalesce(dt_fim_plano::text, '') = ''
		and	dt_inicio_plano <= clock_timestamp()
		and	ie_situacao = 'A';

		if (coalesce(nr_seq_controle_plano_w::text, '') = '') then

			if (current_setting('reg_test_plan_pck.t_tc_version_w')::coalesce(t_tc_version.cd_versao::text, '') = '') then
				CALL reg_test_plan_pck.set_tc_version();
			end if;

			select	nextval('reg_plano_teste_controle_seq')
			into STRICT	nr_seq_controle_plano_w
			;

			insert into reg_plano_teste_controle(
				nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				ie_situacao,
				cd_versao,
				dt_inicio_plano,
				dt_fim_plano )
			values (
				nr_seq_controle_plano_w,
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				'A',
				current_setting('reg_test_plan_pck.t_tc_version_w')::t_tc_version.cd_versao,
				clock_timestamp(),
				null );

			ds_version_w := current_setting('reg_test_plan_pck.t_tc_version_w')::t_tc_version.cd_versao;

		else
			select	cd_versao
			into STRICT	ds_version_w
			from	reg_plano_teste_controle
			where	nr_sequencia = nr_seq_controle_plano_w;
		end if;

		update	reg_tc_pendencies tcp
		set	tcp.ds_version = ds_version_w,
			tcp.ds_motivo_exclusao = ds_motivo_exclusao_p,
			tcp.nr_seq_controle_plano = nr_seq_controle_plano_w,
			tcp.ie_status = 'E',
			tcp.nm_usuario = nm_usuario_p,
			tcp.dt_atualizacao = clock_timestamp()
		where	coalesce(tcp.ds_version::text, '') = ''
		and	exists (	SELECT	1
					from	w_test_plan_ignored_prs i
					where	i.ie_tipo_operacao = 'G'
					and	i.ie_tipo_mudanca = tcp.ie_tipo_mudanca
					and	i.nr_seq_product_req = tcp.nr_seq_pr
					and	i.nr_seq_caso_teste = tcp.nr_seq_tc
					and	i.cd_funcao = tcp.cd_funcao
					and	i.ie_matriz_risco = (	select	coalesce(max('S'), 'N')
									from	reg_caso_teste rct,
										reg_product_requirement rpr
									where	rct.nr_sequencia = tcp.nr_seq_tc
									and	rpr.nr_sequencia = rct.nr_seq_product
                                    and 12 = (select max(rt.nr_seq_type)
                                                from reg_product_req_type rt
                                               where rt.nr_seq_type = 12
                                                 and rt.nr_seq_product_req = rpr.nr_sequencia)
								)
					and	i.nm_usuario = nm_usuario_p
				);

		commit;

	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE reg_test_plan_pck.mark_items_as_excluded ( ds_motivo_exclusao_p text, nm_usuario_p text ) FROM PUBLIC;
