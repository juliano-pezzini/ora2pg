-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE reg_test_plan_pck.insert_reg_tc_pendencies ( nr_seq_tc_p bigint, nr_seq_pr_p bigint, cd_funcao_p bigint, ie_tipo_mudanca_p text, nr_seq_intencao_uso_p bigint ) AS $body$
DECLARE


	ie_situacao_w		varchar(1);
	qt_ct_w			bigint;

	
BEGIN

		select	max(coalesce(ct.ie_situacao, 'A'))
		into STRICT	ie_situacao_w
		from	reg_caso_teste ct
		where	ct.nr_sequencia = nr_seq_tc_p
		and	(ct.dt_aprovacao IS NOT NULL AND ct.dt_aprovacao::text <> '')
		and	coalesce(ct.ie_situacao,'A') = 'A';

		select	count(*)
		into STRICT	qt_ct_w
		from	reg_caso_teste c
		where	c.nr_seq_product = nr_seq_pr_p
		and	coalesce(c.ie_situacao,'A') = 'A'
		and	(c.dt_aprovacao IS NOT NULL AND c.dt_aprovacao::text <> '');

		if (qt_ct_w < 1) then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(1098982 , 'NR_SEQ_PRS=' || nr_seq_pr_p);
		end if;

		if (upper(ie_situacao_w) = 'A') then
			begin

				insert into reg_tc_pendencies(
					nr_sequencia,
					dt_atualizacao,
					nm_usuario,
					dt_atualizacao_nrec,
					nm_usuario_nrec,
					nr_seq_tc,
					nr_seq_pr,
					ds_version,
					cd_funcao,
					ie_status,
					ie_tipo_mudanca,
					nr_seq_intencao_uso )
				values (
					nextval('reg_tc_pendencies_seq'),
					clock_timestamp(),
					nm_usuario_p,
					clock_timestamp(),
					nm_usuario_p,
					nr_seq_tc_p,
					nr_seq_pr_p,
					null,
					cd_funcao_p,
					'P',
					ie_tipo_mudanca_p,
					nr_seq_intencao_uso_p );
			end;
		end if;
	end;


$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE reg_test_plan_pck.insert_reg_tc_pendencies ( nr_seq_tc_p bigint, nr_seq_pr_p bigint, cd_funcao_p bigint, ie_tipo_mudanca_p text, nr_seq_intencao_uso_p bigint ) FROM PUBLIC;
