-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE reg_test_plan_pck.process_pendencies ( nr_seq_tc_p bigint, nr_seq_pr_p bigint, cd_funcao_p bigint, ie_tipo_mudanca_p text, ie_matriz_risco_p text, count_pendency_p bigint, nr_seq_intencao_uso_p bigint ) AS $body$
BEGIN
		if (count_pendency_p = 0) then
			CALL CALL reg_test_plan_pck.insert_reg_tc_pendencies(nr_seq_tc_p, nr_seq_pr_p, cd_funcao_p, ie_origem_p, nr_seq_intencao_uso_p);

			if (ie_matriz_risco_p = 'S') then
				CALL CALL reg_test_plan_pck.insert_reg_tc_pendencies(nr_seq_tc_p, nr_seq_pr_p, cd_funcao_p, ie_origem_p, nr_seq_intencao_uso_p);
			end if;
		end if;

		if (nr_seq_ordem_serv_p IS NOT NULL AND nr_seq_ordem_serv_p::text <> '') then
			for r_c_tcp in current_setting('reg_test_plan_pck.c_tcp')::CURSOR(nr_seq_tc_p(nr_seq_tc_p, nr_seq_pr_p, cd_funcao_p) loop
				CALL reg_test_plan_pck.insert_reg_tc_so_dev(nr_seq_ordem_serv_p, r_c_tcp.seq_pendency, nm_usuario_p);
			end loop;		
		end if;
	end;

	begin

		if (ie_origem_p = 'D') then

			if (nr_seq_caso_teste_p IS NOT NULL AND nr_seq_caso_teste_p::text <> '') then
				for r_c_prs_ct in current_setting('reg_test_plan_pck.c_prs_ct')::CURSOR(nr_seq_tc_p(nr_seq_caso_teste_p) loop
					CALL reg_test_plan_pck.process_pendencies(r_c_prs_ct.nr_seq_tc, r_c_prs_ct.nr_seq_pr, r_c_prs_ct.cd_funcao, ie_origem_p, r_c_prs_ct.ie_matriz_risco, r_c_prs_ct.count_pendency, r_c_prs_ct.nr_seq_intencao_uso);
				end loop;
			else
				for r_c_prs in current_setting('reg_test_plan_pck.c_prs')::CURSOR(nr_product_requirement_p(nr_seq_product_req_p) loop
					CALL reg_test_plan_pck.process_pendencies(r_c_prs.nr_seq_tc, r_c_prs.nr_seq_pr, r_c_prs.cd_funcao, ie_origem_p, r_c_prs.ie_matriz_risco, r_c_prs.count_pendency, r_c_prs.nr_seq_intencao_uso);
				end loop;
			end if;

		elsif (ie_origem_p in ('S', 'O', 'F')) then

			PERFORM set_config('reg_test_plan_pck.ie_os_filha_w', man_obter_se_ordem_serv_filha(nr_seq_ordem_serv_p), false);
			if (current_setting('reg_test_plan_pck.ie_os_filha_w')::varchar(1) = 'S') then
				for r_c_prs_os in current_setting('reg_test_plan_pck.c_prs_os_filha')::CURSOR(nr_seq_ordem_serv_p(nr_seq_ordem_serv_p) loop
					CALL reg_test_plan_pck.process_pendencies(r_c_prs_os.nr_seq_tc, r_c_prs_os.nr_seq_pr, r_c_prs_os.cd_funcao, ie_origem_p, r_c_prs_os.ie_matriz_risco, r_c_prs_os.count_pendency, r_c_prs_os.nr_seq_intencao_uso);
				end loop;			
			else
				for r_c_prs_os in current_setting('reg_test_plan_pck.c_prs_os')::CURSOR(nr_seq_ordem_serv_p(nr_seq_ordem_serv_p) loop
					CALL reg_test_plan_pck.process_pendencies(r_c_prs_os.nr_seq_tc, r_c_prs_os.nr_seq_pr, r_c_prs_os.cd_funcao, ie_origem_p, r_c_prs_os.ie_matriz_risco, r_c_prs_os.count_pendency, r_c_prs_os.nr_seq_intencao_uso);
				end loop;			
			end if;
		end if;

	END;


$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE reg_test_plan_pck.process_pendencies ( nr_seq_tc_p bigint, nr_seq_pr_p bigint, cd_funcao_p bigint, ie_tipo_mudanca_p text, ie_matriz_risco_p text, count_pendency_p bigint, nr_seq_intencao_uso_p bigint ) FROM PUBLIC;
