-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE reg_test_plan_pck.insert_item_in_test_plan (nm_usuario_p text, nr_seq_intencao_uso_p bigint default 2) AS $body$
DECLARE


	nr_seq_controle_plano_w		reg_plano_teste_controle.nr_sequencia%type;
	ds_version_w			reg_tc_pendencies.ds_version%type;

	
BEGIN

		delete	from w_test_plan_ignored_prs
		where	nm_usuario = nm_usuario_p;

		select	max(nr_sequencia)
		into STRICT	nr_seq_controle_plano_w
		from	reg_plano_teste_controle
		where	coalesce(dt_fim_plano::text, '') = ''
		and	dt_inicio_plano <= clock_timestamp()
        and nr_seq_intencao_uso = nr_seq_intencao_uso_p
		and	ie_situacao = 'A';

		if (coalesce(nr_seq_controle_plano_w::text, '') = '') then

			if (current_setting('reg_test_plan_pck.t_tc_version_w')::coalesce(t_tc_version.cd_versao::text, '') = '') then
				CALL reg_test_plan_pck.set_tc_version(nr_seq_intencao_uso_p);
			end if;

			select	nextval('reg_plano_teste_controle_seq')
			into STRICT	nr_seq_controle_plano_w
			;

			insert into reg_plano_teste_controle(
				nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				ie_situacao,
				cd_versao,
				dt_inicio_plano,
				dt_fim_plano,
                nr_seq_intencao_uso)
			values (
				nr_seq_controle_plano_w,
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				'A',
				current_setting('reg_test_plan_pck.t_tc_version_w')::t_tc_version.cd_versao,
				clock_timestamp(),
				null,
                nr_seq_intencao_uso_p);

			ds_version_w := current_setting('reg_test_plan_pck.t_tc_version_w')::t_tc_version.cd_versao;

		else
			select	cd_versao
			into STRICT	ds_version_w
			from	reg_plano_teste_controle
			where	nr_sequencia = nr_seq_controle_plano_w;
		end if;

		update(	SELECT	rtp.ds_version,
					rtp.nr_seq_controle_plano,
					rtp.dt_atualizacao,
					rtp.nm_usuario
				from	reg_tc_pendencies rtp,
					reg_caso_teste rct
				where	rct.nr_sequencia = rtp.nr_seq_tc
				and	(rct.dt_aprovacao IS NOT NULL AND rct.dt_aprovacao::text <> '')
                and rct.ie_situacao = 'A'
                and rct.nr_seq_intencao_uso = nr_seq_intencao_uso_p
                and exists (select 1
                              from reg_acao_teste rat
                             where rat.ie_situacao = 'A'
                               and rat.nr_seq_caso_teste = rct.nr_sequencia)
			) reg
		set	reg.ds_version = ds_version_w,
			reg.nr_seq_controle_plano = nr_seq_controle_plano_w,
			reg.dt_atualizacao = clock_timestamp(),
			reg.nm_usuario = nm_usuario_p
		where	coalesce(reg.ds_version::text, '') = '';

		commit;

	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE reg_test_plan_pck.insert_item_in_test_plan (nm_usuario_p text, nr_seq_intencao_uso_p bigint default 2) FROM PUBLIC;
