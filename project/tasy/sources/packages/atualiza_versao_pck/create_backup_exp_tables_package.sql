-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE atualiza_versao_pck.create_backup_exp_tables () AS $body$
DECLARE

    v_cmd varchar(32000);

  t RECORD;
  c RECORD;

BEGIN
    for t in (SELECT current_setting('atualiza_versao_pck.g_backup_prefix')::varchar(60) || upper(o.ds_shortname) bkp_table_name,
                     tep.table_name
                from tasy_versao.tasy_exptables tep, tabela_sistema o
               where tep.table_name = o.nm_tabela) loop
      v_cmd := null;
      for c in (SELECT /*+ NO_PARALLEL */                 column_name
                  from user_tab_cols tc
                 where tc.table_name = t.table_name
                   and tc.data_type not in ('LONG RAW', 'LONG')
                 order by tc.column_id) loop
        v_cmd := v_cmd || c.column_name || ',';
      end loop;

      v_cmd := 'create table ' || t.bkp_table_name || ' as select ' ||
               trim(both ',' from v_cmd) || ' from ' || t.table_name;

      CALL atualiza_versao_pck.insert_cmd(p_operacao    => 'CREATE BACKUP OF EXPORTED TABLES',
                 p_cmd         => v_cmd,
                 p_object_name => t.table_name);
    end loop;

  end;

  --------------------------------------------------------------------------------------
  --                                                                                 
  -- Cria backup das tabelas utilizadas pelo downtime.
  -- A nomenclatura destas tabelas foi abreviada para atender ao tamanho de
  -- objetos em versões mais antigas (10g e 11g).
  --
  -- Tabelas criadas:
  -- B_<BACKUP_PREFIX>_ATU_VER_CMD -> Backup da tabela ATUALIZA_VERSAO_CMD
  -- B_<BACKUP_PREFIX>_ERR_EXP_TAB -> Backup da tabela LOG_ERROR_EXP_TABLES
  --
  -- <BACKUP_PREFIX> é definida no inicio da procedure prepare_update_database,
  -- e é armazenada na variável global G_BACKUP_PREFIX
  --                                                                                 
  --------------------------------------------------------------------------------------
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualiza_versao_pck.create_backup_exp_tables () FROM PUBLIC;
