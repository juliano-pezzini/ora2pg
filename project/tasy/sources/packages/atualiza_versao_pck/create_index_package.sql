-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE atualiza_versao_pck.create_index () AS $body$
DECLARE

    v_cmd             varchar(32000);
    v_tablespace_name varchar(250);
    v_new_table       varchar(1);

BEGIN
    for i in current_setting('atualiza_versao_pck.c_create_index_01')::loop CURSOR
      v_cmd := null;
      for ic in c_create_index_02(i.nm_tabela, i.nm_indice) loop
        v_cmd := v_cmd || ',' || ic.nm_atributo;
      end loop;

      v_tablespace_name := atualiza_versao_pck.get_index_tablespace(i.nm_indice); --Obter_Tablespace_Index(i.nm_indice);
      v_cmd := 'create index ' || i.nm_indice || ' on ' || i.nm_tabela || '(' ||
               trim(both ',' from v_cmd) || ') nologging @PARALLEL_DEGREE@ ';

      select /*+ NO_PARALLEL */       CASE WHEN count(1)=0 THEN  'S'  ELSE 'N' END 
        into STRICT v_new_table
        from user_tables t
       where t.table_name = i.nm_tabela;

      if v_new_table = 'S' then
        CALL atualiza_versao_pck.insert_cmd(p_operacao    => 'CREATE INDEX (NEW TABLES)',
                   p_cmd         => v_cmd,
                   p_object_name => i.nm_indice,
                   p_nm_tabela   => i.nm_tabela,
                   p_tablespace  => v_tablespace_name);
      else
        CALL atualiza_versao_pck.insert_cmd(p_operacao    => 'CREATE INDEX',
                   p_cmd         => v_cmd,
                   p_object_name => i.nm_indice,
                   p_nm_tabela   => i.nm_tabela,
                   p_tablespace  => v_tablespace_name);
      end if;

      v_cmd := 'alter index ' || i.nm_indice || ' logging';

      CALL atualiza_versao_pck.insert_cmd(p_operacao    => 'ENABLE INDEX LOGGING',
                 p_cmd         => v_cmd,
                 p_object_name => i.nm_indice);
    end loop;
  end;

  --------------------------------------------------------------------------------------
  --                                                                                 
  -- Cria as instruções CREATE UNIQUE INDEX para a atualização.
  --                                                                                 
  --------------------------------------------------------------------------------------
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualiza_versao_pck.create_index () FROM PUBLIC;
