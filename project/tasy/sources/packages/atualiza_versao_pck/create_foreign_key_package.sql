-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE atualiza_versao_pck.create_foreign_key () AS $body$
DECLARE

    v_cmd          varchar(32000);
    v_fk_col_list  varchar(32000);
    v_ref_col_list varchar(32000);

  f RECORD;
  fc RECORD;

BEGIN
    for f in (SELECT /*+ NO_PARALLEL */               b.nm_tabela,
               b.nm_integridade_referencial,
               b.nm_tabela_referencia,
               CASE WHEN b.ie_regra_delecao='CASCADE' THEN  ' ON DELETE CASCADE ' END  ie_regra_delecao
                from tasy_versao.integridade_referencial b
               where not exists (select 1
                        from user_constraints c
                       where b.nm_tabela = c.table_name
                         and b.nm_integridade_referencial = c.constraint_name)
                 and not exists (select 1
                        from tasy_versao.tabela_sistema ts
                       where ts.nm_tabela = b.nm_tabela
                         and ts.ie_temporaria in ('S', 'G', 'GD'))
                 and not exists (select 1
                        from tasy_versao.tabela_sistema ts
                       where ts.nm_tabela = b.nm_tabela_referencia
                         and ts.ie_temporaria in ('S', 'G', 'GD'))
                 and b.dt_atualizacao > current_setting('atualiza_versao_pck.g_tasy_version_date')::timestamp
               order by 1) loop

      v_cmd          := null;
      v_fk_col_list  := null;
      v_ref_col_list := null;

      for fc in (SELECT /*+ NO_PARALLEL */                  fc.nm_atributo
                   from tasy_versao.integridade_atributo fc
                  where fc.nm_tabela = f.nm_tabela
                    and fc.nm_tabela = f.nm_tabela
                    and fc.nm_integridade_referencial =
                        f.nm_integridade_referencial
                  order by fc.ie_sequencia_criacao) loop
        v_fk_col_list := v_fk_col_list || fc.nm_atributo || ',';
      end loop;

      for fc in (SELECT /*+ NO_PARALLEL */                  ia.nm_atributo
                   from tasy_versao.indice i, tasy_versao.indice_atributo ia
                  where i.nm_tabela = i.nm_tabela
                    and i.nm_indice = ia.nm_indice
                    and i.ie_tipo = 'PK'
                    and i.nm_tabela =
                        (select ir.nm_tabela_referencia
                           from tasy_versao.integridade_referencial ir
                          where ir.nm_tabela = f.nm_tabela
                            and ir.nm_integridade_referencial =
                                f.nm_integridade_referencial)
                  order by ia.nr_sequencia) loop
        v_ref_col_list := v_ref_col_list || fc.nm_atributo || ',';
      end loop;

      v_cmd := 'alter table ' || f.nm_tabela || ' add constraint ' ||
               f.nm_integridade_referencial || ' foreign key (' ||
               trim(both ',' from v_fk_col_list) || ') references ' ||
               f.nm_tabela_referencia || '(' ||
               trim(both ',' from v_ref_col_list) || ') ' || f.ie_regra_delecao;

      CALL atualiza_versao_pck.insert_cmd(p_operacao    => 'CREATE FOREIGN KEY',
                 p_cmd         => v_cmd,
                 p_object_name => f.nm_integridade_referencial);
    end loop;
  end;

  --------------------------------------------------------------------------------------
  --                                                                                 
  -- Cria as instruções para desativar e ativar triggers e FKs na atualização.
  --                                                                                 
  --------------------------------------------------------------------------------------
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualiza_versao_pck.create_foreign_key () FROM PUBLIC;
