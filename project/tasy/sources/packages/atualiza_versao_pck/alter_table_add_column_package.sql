-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE atualiza_versao_pck.alter_table_add_column () AS $body$
DECLARE

    v_cmd              varchar(32000);
    v_operacao         varchar(5000) := 'ALTER TABLE ADD COLUMN';
    v_mandatory_fields varchar(2000);

BEGIN
    for t in current_setting('atualiza_versao_pck.c_add_col_01')::loop CURSOR
      v_cmd              := null;
      v_mandatory_fields := null;
      for c in current_setting('atualiza_versao_pck.c_add_col_02')::CURSOR(p_nm_tabela(t.nm_tabela) loop
        if atualiza_versao_pck.is_valid_column_name(c.nm_atributo) = 'S' then
          v_cmd := v_cmd || ',' || c.nm_atributo || ' ' ||
                   atualiza_versao_pck.format_data_type(c.ie_tipo_atributo,
                                    c.qt_tamanho,
                                    c.qt_decimais);
          -- Campos considerados mandatórios. São preencidos em uma operação posterior.
          if c.nm_atributo in ('DT_ATUALIZACAO', 'DT_ATUALIZACAO_NREC',
              'NM_USUARIO', 'NM_USUARIO_NREC') then
            case c.nm_atributo
              when 'NM_USUARIO' then
                v_mandatory_fields := v_mandatory_fields ||
                                      ', NM_USUARIO=''atualizacao''';
              when 'NM_USUARIO_NREC' then
                v_mandatory_fields := v_mandatory_fields ||
                                      ', NM_USUARIO_NREC=''atualizacao''';
              when 'DT_ATUALIZACAO' then
                v_mandatory_fields := v_mandatory_fields ||
                                      ', DT_ATUALIZACAO=sysdate';
              when 'DT_ATUALIZACAO_NREC' then
                v_mandatory_fields := v_mandatory_fields ||
                                      ', DT_ATUALIZACAO_NREC=sysdate';
              else
                null;
            end case; end if;
        end if;
      end loop;
      v_cmd := 'alter table ' || t.nm_tabela || ' add (' ||
               trim(both ',' from v_cmd) || ')';

      v_operacao := 'ALTER TABLE ADD COLUMN';

      CALL atualiza_versao_pck.insert_cmd(p_operacao    => v_operacao,
                 p_cmd         => v_cmd,
                 p_object_name => t.nm_tabela);

      if (v_mandatory_fields IS NOT NULL AND v_mandatory_fields::text <> '') then
        v_cmd      := 'update ' || t.nm_tabela || ' set ' ||
                      trim(both trim(both ',' from v_mandatory_fields));
        v_operacao := 'UPDATE MANDATORY COLUMNS';

        CALL atualiza_versao_pck.insert_cmd(p_operacao    => v_operacao,
                   p_cmd         => v_cmd,
                   p_object_name => t.nm_tabela);
      end if;

    end loop;
  end;

  --------------------------------------------------------------------------------------
  --                                                                                 
  -- Cria as instruções MODIFY COLUMN para a atualização.
  --                                                                                 
  --------------------------------------------------------------------------------------
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualiza_versao_pck.alter_table_add_column () FROM PUBLIC;
