-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE tax_dmed_ir_pck.update_payer_amount_irpf ( nr_contrato_p pls_contrato.nr_contrato%type, cd_responsavel_pagamento_p pessoa_fisica.cd_pessoa_fisica%type, nr_seq_lote_p tax_dmed_lote.nr_sequencia%type) AS $body$
DECLARE

					
  nr_seq_lote_dmed_irpf_w		tax_dmed_irpf.nr_sequencia%type;
  nr_seq_dmed_irpf_payer_w		tax_dmed_irpf_payer.nr_sequencia%type;
  vl_pago_w				tax_dmed_dados_gerais.vl_pago%type;
  vl_reembolso_w			tax_dmed_dados_gerais.vl_pago%type;

  
BEGIN
  if (nr_contrato_p IS NOT NULL AND nr_contrato_p::text <> '') then
	select	max(b.nr_sequencia)
	into STRICT	nr_seq_lote_dmed_irpf_w
	from	tax_dmed_controle a,
		tax_dmed_irpf b
	where	a.nr_sequencia = b.nr_seq_controle
	and	a.nr_seq_lote = nr_seq_lote_p;
	
	if (nr_seq_lote_dmed_irpf_w IS NOT NULL AND nr_seq_lote_dmed_irpf_w::text <> '') then
		select	max(nr_sequencia)
		into STRICT	nr_seq_dmed_irpf_payer_w
		from	tax_dmed_irpf_payer
		where	nr_seq_dmed_irpf = nr_seq_lote_dmed_irpf_w
		and	nr_contrato = nr_contrato_p
		and	cd_pagador = cd_responsavel_pagamento_p;
			
		if (nr_seq_dmed_irpf_payer_w IS NOT NULL AND nr_seq_dmed_irpf_payer_w::text <> '') then
			select	sum(vl_pago),
				sum(vl_reembolso)
			into STRICT	vl_pago_w,
				vl_reembolso_w
			from	tax_dmed_dados_gerais_v
			where	nr_seq_lote = nr_seq_lote_p
			and	nr_contrato = nr_contrato_p
			and	cd_responsavel_pagamento = cd_responsavel_pagamento_p;
			
			update	tax_dmed_irpf_payer
			set	vl_pago = vl_pago_w,
				vl_reembolso = vl_reembolso_w
			where	nr_sequencia = nr_seq_dmed_irpf_payer_w;
		end if;
	end if;
  end if;
  commit;
  END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE tax_dmed_ir_pck.update_payer_amount_irpf ( nr_contrato_p pls_contrato.nr_contrato%type, cd_responsavel_pagamento_p pessoa_fisica.cd_pessoa_fisica%type, nr_seq_lote_p tax_dmed_lote.nr_sequencia%type) FROM PUBLIC;
