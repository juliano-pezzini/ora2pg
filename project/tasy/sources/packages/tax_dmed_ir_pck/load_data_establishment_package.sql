-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE tax_dmed_ir_pck.load_data_establishment () AS $body$
DECLARE

      dynamic_query_w varchar(1000) :=   q'[select lpad(e.cd_cgc, 14, '0') cnpj, ]'                                                                ||
                                                    'substr(p.ds_razao_social, 1, 150) company_name, '                                              || 
                                                  q'[decode(t.ie_comercial_ops, 'H', '1', 'O', '2', '3') ie_commercial_ops, ]'                      ||
                                                  q'[lpad(p.cd_ans, 6, '0') ans, ]'	                                                                || 
                                                  q'[lpad(obter_cnes_estab_cnpj(e.cd_cgc), 7, '0') cnes, ]'                                         ||
                                                  q'[decode(t.ie_comercial_ops, 'H', '', decode(p.cd_ans, null, 'N', 'S')) declaring_indicator]'    ||
                                            ' from	pessoa_juridica		      p,'                                                                     ||
                                                  'tipo_pessoa_juridica	    t,'                                                                     ||
                                                  'tax_dmed_lote            l,'                                                                     ||
                                                  'estabelecimento          e'                                                                      ||
                                            ' where p.cd_tipo_pessoa        = t.cd_tipo_pessoa'                                                     ||
                                            ' and	  p.cd_cgc		            = e.cd_cgc'                                                             ||
                                            ' and   e.cd_estabelecimento    = l.cd_estabelecimento'                                                 ||
                                            ' and   l.nr_sequencia          = ';

BEGIN
      EXECUTE dynamic_query_w || current_setting('tax_dmed_ir_pck.control_table')::generalda_control_type[1].nr_seq_lote
      bulk collect into STRICT current_setting('tax_dmed_ir_pck.data_establishment_vector')::data_establishment_reference;
  END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE tax_dmed_ir_pck.load_data_establishment () FROM PUBLIC;
