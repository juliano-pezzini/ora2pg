-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE tax_dmed_ir_pck.load_plan_holder () AS $body$
DECLARE

      procedure_name_w varchar(20) := 'TaxDmed7';
      document_vector    response_reference;
      alternative_query  varchar(4000) :=    'select d.nr_titulo_rec document_sequence,'                                                                 ||
                                                      'nvl(d.cd_pessoa_pagador, d.cd_pessoa_titular) responsible_code,'                                   ||
                                                      'd.cd_pessoa_fisica beneficiary_code,'                                                              ||
                                                      '(d.vl_item - (d.vl_desconto + d.vl_desconto_negociacao)) total_amount,'                            ||
                                                      'd.vl_juros + d.vl_juros_negociacao interest_amount,'                                               ||
                                                      'd.vl_multa + d.vl_multa_negociacao fine_amount,'                                                   ||
                                                      'd.vl_glosa gloss_amount,'                                                                          ||
                                                      'd.vl_nota_credito credit_note_amount, '                                                            ||
                                                      'd.vl_taxa_negociacao trading_fee_amount, '                                                         ||
                                                      'nvl(d.vl_recebido_maior,0) higher_amount,'                                                         ||
                                                      'l.dt_recebimento date_document,'                                                                   ||
                                                      '0 attendance_code,'                                                                                ||
                                                      'null refund_provider_pf,'                                                                          ||
                                                      'null refund_provider_pj,'                                                                          ||
                                                      'd.nr_sequencia data_code,'                                                                         ||
                                                      'd.ie_tipo_item_mensalidade additional_index,'                                                      ||
                                                      'nvl(d.vl_item,0) item_value'                                                                       ||
                                              ' from  fis_dados_dmed d, '                                                                                 ||
                                                      'titulo_receber r, '                                                                                ||
                                                      'titulo_receber_liq l'                                                                              ||
                                              ' where d.nr_titulo_rec = r.nr_titulo'                                                                      ||
                                              ' and d.nr_titulo_pag is null'                                                                              ||
					                                    ' and l.nr_sequencia = d.nr_seq_baixa_rec '                                                                 ||
                                              ' and r.nr_titulo = l.nr_titulo '                                                                           ||
                                              ' and r.cd_estabelecimento = ' || reference_establishment                                                   ||
                                            q'[ and to_date(l.dt_recebimento, 'dd/mm/rrrr') between tax_dmed_ir_pck.get_initial_date() and tax_dmed_ir_pck.get_final_date()]'         ||
                                              ' and l.nr_seq_liq_origem is null	'                                                                         ||
                                              ' and not exists (select 1'                                                                                 ||
                                                            ' from titulo_receber_liq x'                                                                  ||
                                                            ' where x.nr_titulo = l.nr_titulo'                                                            ||
                                                            ' and x.nr_seq_liq_origem = l.nr_sequencia)'                                                  ||
                                              ' and tax_dmed_ir_pck.is_insured_valid(d.ie_tipo_contratacao, d.cd_pessoa_pagador, d.cd_cgc_administradora, r.cd_cgc, r.ie_origem_titulo) = 1'                           ||
                                            q'[ and ((d.ie_tipo_segurado is null) or (tax_dmed_ir_pck.in_array(d.ie_tipo_segurado, 'B') = 1)) ]'                                                                       ||
                                            q'[ and tax_dmed_ir_pck.in_array(l.cd_tipo_recebimento, 'R') = 1 ]'                                                                                                        ||
                                            q'[ and ((d.ie_tipo_pagador = 'PF') or (tax_dmed_ir_pck.is_empty('T') = 1) or (tax_dmed_ir_pck.in_array(d.ie_tipo_contratacao, 'T') = 1)) ]'                               ||
                                            q'[ and (r.ie_situacao not in ('3', '5') or (r.ie_situacao = '5' and tax_dmed_ir_pck.exists_receipt_receive(r.nr_titulo) > 0)) ]'                                          ||
                                            q'[ and ((d.nr_seq_classif_ops is null) or (tax_dmed_ir_pck.in_array(d.nr_seq_classif_ops, 'C') = 1)) ]'                                                                   ||
                                            q'[ and ((r.ie_origem_titulo is null) or (tax_dmed_ir_pck.is_empty('O') = 1) or (tax_dmed_ir_pck.in_array(r.ie_origem_titulo, 'O') = 1)) ]'                                ||
                                            q'[ and ((d.nr_seq_forma_cobranca is null) or (tax_dmed_ir_pck.is_empty('BM') = 1) or (tax_dmed_ir_pck.in_array(d.nr_seq_forma_cobranca, 'BM') = 1)) ]'                    ||
                                            q'[ and ((d.ie_tipo_item_mensalidade is null) or ((tax_dmed_ir_pck.in_array(d.ie_tipo_item_mensalidade, 'I') = 1) ]'                                                       ||
                                            q'[ and ((d.nr_seq_centro_apropriacao is null) or (tax_dmed_ir_pck.is_empty('AP', d.ie_tipo_item_mensalidade) = 1) or (tax_dmed_ir_pck.in_array(d.nr_seq_centro_apropriacao, 'AP', d.ie_tipo_item_mensalidade) = 1))]'   ||
                                            q'[ and ((d.nr_seq_tipo_lanc is null) or (tax_dmed_ir_pck.is_empty('D', d.ie_tipo_item_mensalidade) = 1) or (tax_dmed_ir_pck.in_array(d.nr_seq_tipo_lanc, 'D', d.ie_tipo_item_mensalidade) = 1))))]';

BEGIN
      document_vector := tax_dmed_ir_pck.run_dynamic_sql(document_vector, alternative_query_p => alternative_query, procedure_name_p => procedure_name_w);
      CALL tax_dmed_ir_pck.add_monthly_data(document_vector, 'N', procedure_name_w);
  END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE tax_dmed_ir_pck.load_plan_holder () FROM PUBLIC;
