-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE tax_dmed_ir_pck.include_receivable (establishment_code_p tax_dmed_lote.cd_estabelecimento%type, username_p tax_dmed_dados_gerais.nm_usuario%type, batch_code_p tax_dmed_dados_gerais.nr_seq_lote_mensal%type, receivable_p tax_dmed_dados_gerais.nr_documento%type) AS $body$
DECLARE

      document_vector_w            response_reference;
      nr_seq_dmed_dados_gerais_w   tax_dmed_dados_gerais.nr_sequencia%type;
      alternative_query_w          varchar(4000);
      ie_provider_w                varchar(2);
      alternative_query_provider_w varchar(4000)   := 'select  r.nr_titulo document_sequence,'                                                                                           ||
                                                            q'[ substr(nvl(obter_pessoa_titulo_data(r.nr_titulo, l.dt_recebimento, 'C'), r.cd_pessoa_fisica), 1, 10) responsible_code,]'  ||
                                                            q'[ substr(nvl(a.cd_pessoa_fisica, nvl(obter_pessoa_titulo_data(r.nr_titulo, l.dt_recebimento, 'C'), r.cd_pessoa_fisica)), 1, 10) beneficiary_code,]' ||
                                                              ' sum(nvl(l.vl_recebido, r.vl_titulo)) total_amount,'                                                                       ||
                                                              ' sum(nvl(l.vl_juros, 0)) interest_amount,'                                                                                 ||
                                                              ' sum(nvl(l.vl_multa, 0)) fine_amount,'                                                                                     ||
                                                              ' sum(nvl(l.vl_glosa, 0)) gloss_amount,'                                                                                    ||
                                                              ' sum(nvl(l.vl_nota_credito, 0)) credit_note_amount,'                                                                       ||
                                                              ' max(0) trading_fee_amount, '                                                                                              ||
                                                              ' sum(nvl(l.vl_rec_maior, 0)) higher_amount,'                                                                               ||
                                                              ' nvl(l.dt_recebimento, r.dt_emissao) date_document,'                                                                       ||
                                                              ' a.nr_atendimento attendance_code,'                                                                                        ||
                                                              ' max(null) refund_provider_pf,'                                                                                            ||
                                                              ' max(null) refund_provider_pj,'                                                                                            ||                                                                                                 
                                                              ' min(null) data_code,'                                                                                                     ||
                                                              ' max(0) additional_index,'                                                                                                 ||
                                                              ' min(null) item_value'                                                                                                     ||
                                                      ' from    atendimento_paciente a,'                                                                                                  ||
                                                              ' pessoa_fisica p,'                                                                                                         ||
                                                              ' titulo_receber r,'                                                                                                        ||
                                                              ' titulo_receber_liq l'                                                                                                     ||
                                                      ' where   r.cd_estabelecimento = :establishment_code '                                                                              ||
                                                      ' and     r.nr_atendimento = a.nr_atendimento(+)'                                                                                   ||
                                                      ' and     r.nr_titulo = l.nr_titulo(+)'                                                                                             ||
                                                      ' and     r.cd_pessoa_fisica = p.cd_pessoa_fisica'                                                                                  ||
                                                      ' and     r.nr_titulo = ' || receivable_p                                                                                           ||
                                                      ' and     tax_dmed_ir_pck.exists_intermediary(r.nr_titulo) = 0'                                                                     ||
                                                      ' and     tax_dmed_ir_pck.exists_dmed(r.nr_titulo) = 0'                                                                             ||
                                                    q'[ and     (r.ie_situacao not in ('3', '5') or (r.ie_situacao = '5' and tax_dmed_ir_pck.exists_receipt_receive(r.nr_titulo) > 0)) ]' ||
                                                      --' and     l.dt_recebimento between tax_dmed_ir_pck.get_initial_date() and tax_dmed_ir_pck.get_final_date()'                           ||    
                                                      ' group by r.nr_titulo,'                                                                                                            ||
                                                    q'[ substr(nvl(obter_pessoa_titulo_data(r.nr_titulo, l.dt_recebimento, 'C'), r.cd_pessoa_fisica), 1, 10),]'                           ||
                                                    q'[ substr(nvl(a.cd_pessoa_fisica, nvl(obter_pessoa_titulo_data(r.nr_titulo, l.dt_recebimento, 'C'), r.cd_pessoa_fisica)), 1, 10),]'  ||
                                                      ' nvl(l.dt_recebimento, r.dt_emissao),'                                                                                             ||
                                                      ' a.nr_atendimento';
      alternative_query_operator_w varchar(4000)  :=  'select d.nr_titulo_rec document_sequence,'                                                                                        ||
                                                         'nvl(d.cd_pessoa_pagador, d.cd_pessoa_titular) responsible_code,'                                                                ||
                                                         'd.cd_pessoa_fisica beneficiary_code,'                                                                                           ||
                                                         '(d.vl_item - (d.vl_desconto + d.vl_desconto_negociacao) + (d.vl_juros_negociacao + d.vl_multa_negociacao)) total_amount,'       ||
                                                         'd.vl_juros interest_amount,'                                                                                                    ||
                                                         'd.vl_multa  fine_amount,'                                                                                                       ||
                                                         'd.vl_glosa gloss_amount,'                                                                                                       ||
                                                         'd.vl_nota_credito credit_note_amount, '                                                                                         ||
                                                         'd.vl_taxa_negociacao trading_fee_amount, '                                                                                      ||
                                                         'nvl(d.vl_recebido_maior,0) higher_amount,'                                                                                      ||
                                                         'l.dt_recebimento date_document,'                                                                                                ||
                                                         '0 attendance_code,'                                                                                                             ||
                                                         'null refund_provider_pf,'                                                                                                       ||
                                                         'null refund_provider_pj,'                                                                                                       ||
                                                         'd.nr_sequencia data_code,'                                                                                                      ||
                                                         'd.ie_tipo_item_mensalidade additional_index,'                                                                                   ||
                                                         'nvl(d.vl_item,0) item_value'                                                                                                    ||
                                                 ' from  fis_dados_dmed d, '                                                                                                              ||
                                                         'titulo_receber r, '                                                                                                             ||
                                                         'titulo_receber_liq l'                                                                                                           ||
                                                 ' where d.nr_titulo_rec = r.nr_titulo'                                                                                                   ||
                                                 ' and d.nr_titulo_pag is null'                                                                                                           ||
					                                       ' and l.nr_sequencia = d.nr_seq_baixa_rec '                                                                                              ||
                                                 ' and r.nr_titulo = l.nr_titulo '                                                                                                        ||
                                                 ' and r.cd_estabelecimento = :establishment_code '                                                                                       ||
                                                 --' and l.dt_recebimento between tax_dmed_ir_pck.get_initial_date() and tax_dmed_ir_pck.get_final_date()'                                      ||
                                                 ' and     r.nr_titulo = ' || receivable_p                                                                                                ||
                                                 ' and     tax_dmed_ir_pck.exists_dmed(r.nr_titulo) = 0'                                                                                  ||
                                                 ' and l.nr_seq_liq_origem is null	'                                                                                                     ||
                                                 ' and not exists (select 1'                                                                                                              ||
                                                               ' from titulo_receber_liq x'                                                                                               ||
                                                               ' where x.nr_titulo = l.nr_titulo'                                                                                         ||
                                                               ' and x.nr_seq_liq_origem = l.nr_sequencia)'                                                                               ||
                                                 ' and tax_dmed_ir_pck.is_insured_valid(d.ie_tipo_contratacao, d.cd_pessoa_pagador, d.cd_cgc_administradora, r.cd_cgc, r.ie_origem_titulo) = 1'  ||
                                               q'[ and ((d.ie_tipo_segurado is null) or (tax_dmed_ir_pck.in_array(d.ie_tipo_segurado, 'B') = 1)) ]'                                       ||
                                               q'[ and (r.ie_situacao not in ('3', '5') or (r.ie_situacao = '5' and tax_dmed_ir_pck.exists_receipt_receive(r.nr_titulo) > 0)) ]';
					
  C01 CURSOR FOR
 	SELECT	b.nr_contrato,
		a.cd_responsavel_pagamento,
		c.nr_seq_lote
	from	tax_dmed_dados_gerais a,
		fis_dados_dmed b,
		tax_dmed_lote_mensal c
	where	b.nr_sequencia = a.nr_seq_dados_dmed
	and	c.nr_sequencia = a.nr_seq_lote_mensal
	and	a.nr_seq_lote_mensal = batch_code_p
	and	a.nr_documento = receivable_p;
					
  
BEGIN   
      PERFORM set_config('tax_dmed_ir_pck.batch_monthly_sequence', batch_code_p, false);
      CALL tax_dmed_ir_pck.load_general_rule();

      if (tax_dmed_ir_pck.exists_intermediary(receivable_p) = 0) then
        alternative_query_w :=  alternative_query_provider_w;
        ie_provider_w       :=  'S';
      else
        alternative_query_w :=  alternative_query_operator_w;
        ie_provider_w       :=  'N';
      end if;

      for i in current_setting('tax_dmed_ir_pck.establishment_vector')::establishment_type.first .. current_setting('tax_dmed_ir_pck.establishment_vector')::establishment_type.last loop	
        PERFORM set_config('tax_dmed_ir_pck.reference_establishment', current_setting('tax_dmed_ir_pck.establishment_vector')::establishment_type[i].cd_estabelecimento, false);
        document_vector_w := tax_dmed_ir_pck.run_dynamic_sql(document_vector_w, alternative_query_p => replace(alternative_query_w, ':establishment_code', current_setting('tax_dmed_ir_pck.reference_establishment')::tax_dmed_lote.cd_estabelecimento%type));
        CALL tax_dmed_ir_pck.add_monthly_data(document_vector_w, ie_provider_w, username_p);
        CALL tax_dmed_ir_pck.write_data_table();
      end loop;

      select	max(nr_sequencia)
      into STRICT	nr_seq_dmed_dados_gerais_w
      from	tax_dmed_dados_gerais
      where	nr_seq_lote_mensal = batch_code_p
      and	nr_documento = receivable_p;

      if (nr_seq_dmed_dados_gerais_w IS NOT NULL AND nr_seq_dmed_dados_gerais_w::text <> '') then
		for r_c01_w in c01 loop
			begin
			CALL tax_dmed_ir_pck.update_payer_amount_irpf(r_c01_w.nr_contrato, r_c01_w.cd_responsavel_pagamento, r_c01_w.nr_seq_lote);
			end;
		end loop;
      end if;
  END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE tax_dmed_ir_pck.include_receivable (establishment_code_p tax_dmed_lote.cd_estabelecimento%type, username_p tax_dmed_dados_gerais.nm_usuario%type, batch_code_p tax_dmed_dados_gerais.nr_seq_lote_mensal%type, receivable_p tax_dmed_dados_gerais.nr_documento%type) FROM PUBLIC;
