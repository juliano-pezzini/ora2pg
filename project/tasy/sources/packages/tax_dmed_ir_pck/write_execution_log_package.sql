-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE tax_dmed_ir_pck.write_execution_log (sql_executed_1_p text, sql_executed_2_p text default null, procedure_name_p text DEFAULT NULL, array_p response_reference DEFAULT NULL) AS $body$
DECLARE

    sql_1_w     varchar(4000) := sql_executed_1_p;
    sql_2_w     varchar(4000) := sql_executed_2_p;
    sequence_w  tax_dmed_log_comando.nr_sequencia%type;
    additional_index_w     bigint := 0;

BEGIN
    if (array_p.count > 0) then
      select  coalesce(max(w.nr_sequencia), 0) 
      into STRICT    additional_index_w
      from    tax_dmed_regra_tipo_item w 
      where   w.nr_tipo_item = array_p[1].additional_index 
      and     w.nr_seq_lote = current_setting('tax_dmed_ir_pck.batch_sequence')::tax_dmed_lote.nr_sequencia%type;
    end if;

    if (coalesce(sql_2_w::text, '') = '') then
      sql_1_w := tax_dmed_ir_pck.converte_sql_log(sql_1_w, 'tax_dmed_ir_pck.in_array()', additional_index_w);
      sql_1_w := tax_dmed_ir_pck.converte_sql_log(sql_1_w, 'tax_dmed_ir_pck.is_empty()');
    else

      sql_2_w := tax_dmed_ir_pck.converte_sql_log(sql_2_w, 'tax_dmed_ir_pck.in_array()', additional_index_w);
      sql_2_w := tax_dmed_ir_pck.converte_sql_log(sql_2_w, 'tax_dmed_ir_pck.is_empty()');
    end if;

    select  nextval('tax_dmed_log_comando_seq')
          into STRICT    sequence_w
;

    insert into tax_dmed_log_comando(nr_sequencia,
                                      dt_atualizacao, 
                                      nm_usuario, 
                                      dt_atualizacao_nrec, 
                                      nm_usuario_nrec, 
                                      nr_seq_lote_mensal, 
                                      dt_geracao, 
                                      ds_comando, 
                                      ds_comando_compl, 
                                      ds_rotina,
                                      cd_estabelecimento)
                              values (sequence_w, 
                                      clock_timestamp(), 
                                      'Tasy', 
                                      clock_timestamp(), 
                                      'Tasy', 
                                      current_setting('tax_dmed_ir_pck.batch_monthly_sequence')::tax_dmed_lote_mensal.nr_sequencia%type, 
                                      clock_timestamp(), 
                                      sql_1_w, 
                                      sql_2_w, 
                                      procedure_name_p,
                                      current_setting('tax_dmed_ir_pck.reference_establishment')::tax_dmed_lote.cd_estabelecimento%type);
      commit;

  END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE tax_dmed_ir_pck.write_execution_log (sql_executed_1_p text, sql_executed_2_p text default null, procedure_name_p text DEFAULT NULL, array_p response_reference DEFAULT NULL) FROM PUBLIC;
