-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE tax_dmed_ir_pck.load_refund () AS $body$
DECLARE

      procedure_name_w varchar(20) := 'TaxDmed8';
      document_vector    response_reference;
      alternative_query  varchar(4000) :=    'select  d.nr_titulo_pag document_sequence,'                                                                ||
                                                      'nvl(d.cd_pessoa_pagador, d.cd_pessoa_titular) responsible_code,'                                   ||
                                                      'd.cd_pessoa_fisica beneficiary_code,'                                                              ||
                                                    q'[sum(decode(p.ie_origem_titulo, '6', d.vl_item, d.vl_item * -1)) total_amount,]'                    ||
                                                      'sum(d.vl_juros) interest_amount,'                                                                  ||
                                                      'sum(d.vl_multa) fine_amount,'                                                                      ||
                                                      'max(0) gloss_amount,'                                                                              ||
                                                      'max(0) credit_note_amount,'                                                                        ||
                                                      'max(0) trading_fee_amount, '                                                                       ||
                                                      'max(0) higher_amount,'                                                                             ||
                                                      'p.dt_liquidacao date_document,'                                                                    ||
                                                      'max(0) attendance_code,'                                                                           ||
                                                    q'[decode(p.ie_origem_titulo, '6', d.cd_pessoa_reembolso, d.cd_pessoa_pagador) refund_provider_pf,]'  ||
                                                    q'[decode(p.ie_origem_titulo, '6', d.cd_cgc_reembolso, null) refund_provider_pj,]'                    ||
                                                      'min(d.nr_sequencia) data_code,'                                                                    ||
                                                      'max(0) additional_index,'                                                                          ||
                                                      'min(null) item_value'                                                                              ||						
                                            ' from     fis_dados_dmed d,'                                                                                 ||
                                            '          titulo_pagar p,'                                                                                   ||
                                            '          titulo_pagar_baixa c '                                                                             ||
                                            ' where    not exists (	select  1 '                                                                           ||
                                                              '     from    titulo_pagar_baixa x '                                                        ||
                                                              '     where   x.nr_titulo = c.nr_titulo '                                                   ||
                                                              '     and     x.nr_seq_baixa_origem = c.nr_sequencia) '                                     ||
                                            ' and      c.nr_titulo = d.nr_titulo_pag '                                                                    ||
                                            ' and      c.nr_sequencia = d.nr_seq_baixa_pag '                                                              ||
                                            ' and      c.nr_seq_baixa_origem is null '                                                                    ||
                                            ' and      p.nr_titulo = c.nr_titulo'                                                                         ||
                                            ' and      p.cd_estabelecimento = ' || reference_establishment                                                ||
                                          q'[ and      to_date(l.dt_liquidacao, 'dd/mm/rrrr') between between tax_dmed_ir_pck.get_initial_date() and tax_dmed_ir_pck.get_final_date()]'       ||
					                                  ' and      tax_dmed_ir_pck.is_insured_valid(d.ie_tipo_contratacao, d.cd_pessoa_pagador, d.cd_cgc_administradora, p.cd_cgc, 3) = 1'                          ||
                                          q'[ and      ((d.nr_seq_forma_cobranca is null) or (tax_dmed_ir_pck.is_empty('BM') = 1) or (tax_dmed_ir_pck.in_array(d.nr_seq_forma_cobranca, 'BM') = 1)) ]'  ||  
                                          q'[ and      ((d.ie_origem_protocolo is null) or (tax_dmed_ir_pck.is_empty('OP') = 1) or (tax_dmed_ir_pck.in_array(d.ie_origem_protocolo, 'OP') = 1)) ]'      ||   
                                          q'[ and      ((d.nr_seq_mot_reembolso is null) or (tax_dmed_ir_pck.is_empty('RR') = 1) or (tax_dmed_ir_pck.in_array(d.nr_seq_mot_reembolso, 'RR') = 1)) ]'    ||   
                                          q'[ and      ((tax_dmed_ir_pck.is_empty('P') = 1) or (tax_dmed_ir_pck.in_array(c.cd_tipo_baixa, 'P') = 1)) ]'                                                 ||                                           
                                          q'[ and      p.ie_situacao <> 'C' ]'                                                                            ||
                                            'group by d.nr_titulo_pag,'                                                                                   ||
                                                      'd.cd_pessoa_fisica,'                                                                               ||
                                                      'p.dt_liquidacao,'                                                                                  ||
                                                      'd.cd_pessoa_titular,'                                                                              ||
                                                      'd.cd_pessoa_pagador,'                                                                              ||
                                                    q'[decode(p.ie_origem_titulo, '6', d.cd_pessoa_reembolso, d.cd_pessoa_pagador),]'                     || 
                                                    q'[decode(p.ie_origem_titulo, '6', d.cd_cgc_reembolso, null)]';

BEGIN
      document_vector := tax_dmed_ir_pck.run_dynamic_sql(document_vector, alternative_query_p => alternative_query, procedure_name_p => procedure_name_w);
      CALL tax_dmed_ir_pck.add_monthly_data(document_vector, 'N', procedure_name_w);
  END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE tax_dmed_ir_pck.load_refund () FROM PUBLIC;
