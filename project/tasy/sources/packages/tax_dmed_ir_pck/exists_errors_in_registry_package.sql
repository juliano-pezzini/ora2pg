-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION tax_dmed_ir_pck.exists_errors_in_registry (responsible_code_p tax_dmed_dados_gerais.cd_responsavel_pagamento%type, beneficiary_code_p tax_dmed_dados_gerais.cd_beneficiario%type, total_amount_p tax_dmed_dados_gerais.vl_pago%type) RETURNS bigint AS $body$
DECLARE

      cpf_responsible_w   varchar(11);
      cpf_beneficiary_w   varchar(11);
      beneficiary_minor_w varchar(1);
      foreign_w           varchar(1);
      total_amount_w      tax_dmed_dados_gerais.vl_pago%type;

BEGIN
      cpf_responsible_w   := substr(obter_dados_pf(responsible_code_p, 'CPF'), 1, 11);
      cpf_beneficiary_w   := substr(obter_dados_pf(beneficiary_code_p, 'CPF'), 1, 11);
      beneficiary_minor_w := obter_se_pf_menor_idade(beneficiary_code_p, clock_timestamp());
      total_amount_w      := total_amount_p;
      foreign_w           := obter_se_pf_pj_estrangeiro(responsible_code_p, null);

      if foreign_w = 'S' then
          return 3;
      end if;

      if coalesce(cpf_responsible_w::text, '') = '' then
          return 1; -- responsible without CPF (1)
      end if;

      if beneficiary_minor_w = 'N' and coalesce(cpf_beneficiary_w::text, '') = '' then
          return 2; -- beneficiary of legal age without CPF (2)
      end if;

      return 0; -- no inconsistencies (0)
  END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION tax_dmed_ir_pck.exists_errors_in_registry (responsible_code_p tax_dmed_dados_gerais.cd_responsavel_pagamento%type, beneficiary_code_p tax_dmed_dados_gerais.cd_beneficiario%type, total_amount_p tax_dmed_dados_gerais.vl_pago%type) FROM PUBLIC;
