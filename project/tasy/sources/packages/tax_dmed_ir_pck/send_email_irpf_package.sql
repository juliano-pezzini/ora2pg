-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE tax_dmed_ir_pck.send_email_irpf ( nr_seq_dmed_irpf_p tax_dmed_irpf.nr_sequencia%type, nr_seq_dmed_irpf_payer_p tax_dmed_irpf_payer.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) AS $body$
DECLARE


nr_seq_email_w		pls_email.nr_sequencia%type;
nr_seq_email_anexo_w	pls_email_anexo.nr_sequencia%type;
cd_prioridade_w		pls_email_parametros.cd_prioridade%type;
nr_seq_regra_email_w	tax_dmed_regra_email.nr_sequencia%type;
ds_assunto_w		tax_dmed_regra_email.ds_assunto%type;
ds_remetente_w		tax_dmed_regra_email.ds_remetente%type;
ds_mensagem_w		tax_dmed_regra_email.ds_mensagem%type;
ds_assunto_regra_w	tax_dmed_regra_email.ds_assunto%type;
ds_mensagem_regra_w	tax_dmed_regra_email.ds_mensagem%type;
ds_valor_paramentro_w	pls_email_anexo_param.ds_valor_parametro%type;

c01 CURSOR(	nr_seq_dmed_irpf_pc 		tax_dmed_irpf.nr_sequencia%type,
		nr_seq_dmed_irpf_payer_pc	tax_dmed_irpf_payer.nr_sequencia%type) FOR
	SELECT	a.nr_sequencia,
		tax_dmed_ir_pck.get_paying_email(a.cd_pagador, a.nr_contrato) ds_email,
		a.cd_pagador,
		to_char(c.dt_ano_referencia, 'yyyy') ds_ano_referencia,
		to_char(c.dt_ano_calendario, 'yyyy') ds_ano_calendario,
		a.nr_contrato
	from	tax_dmed_irpf_payer a,
		tax_dmed_irpf b,
		tax_dmed_controle c
	where	b.nr_sequencia = a.nr_seq_dmed_irpf
	and	c.nr_sequencia = b.nr_seq_controle
	and	a.nr_seq_dmed_irpf = nr_seq_dmed_irpf_pc
	and	((coalesce(nr_seq_dmed_irpf_payer_pc,0) = 0) or (a.nr_sequencia = nr_seq_dmed_irpf_payer_pc));

c02 CURSOR(	nr_seq_regra_email_pc	tax_dmed_regra_email.nr_sequencia%type) FOR
	SELECT	CASE WHEN coalesce(ds_arquivo::text, '') = '' THEN  'R'  ELSE 'A' END  ie_tipo_anexo,
		cd_classif_relat,
		cd_relatorio,
		ds_arquivo
	from	tax_dmed_regra_email_anexo
	where	nr_seq_regra_email = nr_seq_regra_email_pc;

C03 CURSOR(	cd_classif_relat_pc relatorio.cd_classif_relat%type,
		cd_relatorio_pc relatorio.cd_relatorio%type)FOR
	SELECT	b.cd_parametro
	from	relatorio a,
		relatorio_parametro b
	where	a.nr_sequencia	= b.nr_seq_relatorio
	and	a.cd_classif_relat = cd_classif_relat_pc
	and	a.cd_relatorio	= cd_relatorio_pc;
BEGIN

select	max(d.nr_sequencia)
into STRICT	nr_seq_regra_email_w
from	tax_dmed_regra_email d,
	tax_dmed_lote a,
	tax_dmed_controle b,
	tax_dmed_irpf c
where	c.nr_sequencia = nr_seq_dmed_irpf_p
and	b.nr_sequencia = c.nr_seq_controle
and	a.nr_sequencia = b.nr_seq_lote
and	a.nr_sequencia = d.nr_seq_lote;

if (nr_seq_regra_email_w IS NOT NULL AND nr_seq_regra_email_w::text <> '') then
	select	substr(ds_assunto,1,255),
		ds_remetente,
		substr(ds_mensagem,1,4000)
	into STRICT	ds_assunto_regra_w,
		ds_remetente_w,
		ds_mensagem_regra_w
	from	tax_dmed_regra_email
	where	nr_sequencia = nr_seq_regra_email_w;

	if (coalesce(ds_remetente_w::text, '') = '') then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(1132046);
	end if;
else
	CALL wheb_mensagem_pck.exibir_mensagem_abort(1132045);
end if;

select	coalesce(max(cd_prioridade),5)
into STRICT	cd_prioridade_w
from	pls_email_parametros
where	ie_origem		= 8
and	cd_estabelecimento	= cd_estabelecimento_p
and	ie_situacao		= 'A';

for r_c01_w in c01(	nr_seq_dmed_irpf_p,
			nr_seq_dmed_irpf_payer_p) loop
	begin
	if (r_c01_w.ds_email IS NOT NULL AND r_c01_w.ds_email::text <> '') then
		ds_mensagem_w := ds_mensagem_regra_w;
		ds_mensagem_w := substr(replace(ds_mensagem_w,'@DS_ANO_REFERENCIA',r_c01_w.ds_ano_referencia),1,4000);
		ds_mensagem_w := substr(replace(ds_mensagem_w,'@DS_ANO_CALENDARIO',r_c01_w.ds_ano_calendario),1,4000);
		ds_mensagem_w := substr(replace(ds_mensagem_w,'@NM_PAGADOR',obter_nome_pf(r_c01_w.cd_pagador)),1,4000);
		ds_mensagem_w := substr(replace(ds_mensagem_w,'@NR_CONTRATO',r_c01_w.nr_contrato),1,4000);
		
		ds_assunto_w := ds_assunto_regra_w;
		ds_assunto_w := substr(replace(ds_assunto_w,'@DS_ANO_REFERENCIA',r_c01_w.ds_ano_referencia),1,255);
		ds_assunto_w := substr(replace(ds_assunto_w,'@DS_ANO_CALENDARIO',r_c01_w.ds_ano_calendario),1,255);
		ds_assunto_w := substr(replace(ds_assunto_w,'@NM_PAGADOR',obter_nome_pf(r_c01_w.cd_pagador)),1,255);
		ds_assunto_w := substr(replace(ds_assunto_w,'@NR_CONTRATO',r_c01_w.nr_contrato),1,255);
		
		insert into pls_email(nr_sequencia, cd_estabelecimento, nm_usuario_nrec,
			dt_atualizacao_nrec, nm_usuario, dt_atualizacao,
			ie_tipo_mensagem, ie_status, ie_origem,
			ds_remetente, ds_mensagem, ds_assunto,
			ds_destinatario, cd_prioridade, cd_pessoa_fisica,
			nr_seq_dmed_irpf_payer, ie_tipo_documento)
		values (nextval('pls_email_seq'), cd_estabelecimento_p, nm_usuario_p,
			clock_timestamp(), nm_usuario_p, clock_timestamp(),
			8, 'P', 8,
			ds_remetente_w, ds_mensagem_w, ds_assunto_w,
			r_c01_w.ds_email, cd_prioridade_w, r_c01_w.cd_pagador,
			r_c01_w.nr_sequencia, '3')
		returning nr_sequencia into nr_seq_email_w;
		
		for r_c02_w in c02(nr_seq_regra_email_w) loop
			begin
			insert into pls_email_anexo(nr_sequencia, nr_seq_email, nm_usuario,
				nm_usuario_nrec, dt_atualizacao, dt_atualizacao_nrec,
				cd_classif_relat, cd_relatorio, ds_arquivo,
				ie_tipo_anexo)
			values (nextval('pls_email_anexo_seq'), nr_seq_email_w, nm_usuario_p,
				nm_usuario_p, clock_timestamp(), clock_timestamp(),
				r_c02_w.cd_classif_relat, r_c02_w.cd_relatorio, r_c02_w.ds_arquivo,
				r_c02_w.ie_tipo_anexo)
			returning nr_sequencia into nr_seq_email_anexo_w;
				
			if (r_c02_w.ie_tipo_anexo = 'R') then
				for r_c03_w in c03(	r_c02_w.cd_classif_relat,
							r_c02_w.cd_relatorio) loop
					begin
					ds_valor_paramentro_w	:= null;
					
					if (r_c03_w.cd_parametro = 'NR_SEQ_DMED_IRPF_PAYER_P') then
						ds_valor_paramentro_w := r_c01_w.nr_sequencia;
					end if;
					
					insert 	into	pls_email_anexo_param(nr_sequencia, dt_atualizacao, nm_usuario,
						dt_atualizacao_nrec, nm_usuario_nrec, nr_seq_anexo,
						nm_parametro, ds_valor_parametro, ie_tipo_parametro)
					values (nextval('pls_email_anexo_param_seq'),clock_timestamp(), nm_usuario_p,
						clock_timestamp(), nm_usuario_p, nr_seq_email_anexo_w,
						r_c03_w.cd_parametro, ds_valor_paramentro_w, 'C');
					end;
				end loop;
			end if;
			end;
		end loop;
	end if;
	end;
end loop;

commit;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE tax_dmed_ir_pck.send_email_irpf ( nr_seq_dmed_irpf_p tax_dmed_irpf.nr_sequencia%type, nr_seq_dmed_irpf_payer_p tax_dmed_irpf_payer.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) FROM PUBLIC;
