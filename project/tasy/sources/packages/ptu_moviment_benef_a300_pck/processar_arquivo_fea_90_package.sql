-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

	
/* --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------*/

	


CREATE OR REPLACE PROCEDURE ptu_moviment_benef_a300_pck.processar_arquivo_fea_90 ( nr_seq_lote_p bigint, arq_texto_p utl_file.file_type) AS $body$
DECLARE

	
	ds_conteudo_w			varchar(4000);
	ds_hash_w			varchar(32);
	
	
BEGIN
	PERFORM set_config('ptu_moviment_benef_a300_pck.nr_sequencial_arq_w', 0, false);
	
	for r_c01_w in current_setting('ptu_moviment_benef_a300_pck.c01')::CURSOR(nr_seq_lote_pc(nr_seq_lote_p) loop
		
		ds_conteudo_w := lpad(r_c01_w.cd_unimed_destino,4,0) || lpad(r_c01_w.cd_unimed_origem,4,0) || to_char(r_c01_w.dt_geracao,'YYYYMMDD') ||
				lpad(r_c01_w.ie_tipo_mov,1,0) || to_char(r_c01_w.dt_mov_inicio, 'YYYYMMDD') || to_char(r_c01_w.dt_mov_fim,'YYYYMMDD') ||
				rpad(r_c01_w.ie_tipo_produto,2,' ') || '15';
		
		CALL CALL CALL CALL CALL CALL ptu_moviment_benef_a300_pck.incluir_linha_arq('301', ds_conteudo_w, arq_texto_p);
		
		for r_c02_w in current_setting('ptu_moviment_benef_a300_pck.c02')::CURSOR(nr_seq_mov_produto_pc(r_c01_w.nr_seq_mov_produto) loop
			ds_conteudo_w := lpad(r_c02_w.ds_reservado,4,' ') || lpad(coalesce(r_c02_w.cd_filial,0),3,0) || rpad(coalesce(r_c02_w.ds_razao_social,' '),40,' ') ||
					rpad(r_c02_w.ds_reservado,18,' ') || lpad(r_c02_w.ie_tipo_pessoa,1,0) || lpad(r_c02_w.cd_cgc_cpf,15,0) ||
					lpad(coalesce(r_c02_w.nr_insc_estadual,0),20,0) || rpad(coalesce(r_c02_w.ds_endereco,' '),40,' ') || rpad(coalesce(r_c02_w.ds_complemento,' '),20,' ') ||
					rpad(coalesce(r_c02_w.ds_bairro,' '),30,' ') || rpad(r_c02_w.cd_cep,8,' ') || rpad(r_c02_w.ds_reservado,30,' ') ||
					rpad(r_c02_w.ds_reservado,2,' ') || lpad(coalesce(somente_numero(r_c02_w.nr_ddd),0),4,0) || '                ' ||
					coalesce(to_char(r_c02_w.dt_inclusao,'YYYYMMDD'),'        ') || coalesce(to_char(r_c02_w.dt_exclusao,'YYYYMMDD'),'        ') || lpad(coalesce(r_c02_w.cd_empresa_origem,0),10,0) ||
					r_c02_w.ie_natureza_contratacao || lpad(coalesce(r_c02_w.cd_municipio_ibge,0),7,0) || lpad(coalesce(somente_numero(r_c02_w.nr_telefone),0),9,0) ||
					lpad(coalesce(r_c02_w.nr_fax,0),9,0) || lpad(coalesce(r_c02_w.nr_contrato,0),15,0) || lpad(coalesce(r_c02_w.nr_endereco,0),6,0) || rpad(coalesce(r_c02_w.nm_empr_abrev,' '),30,' ');
			
			ds_conteudo_w := nfe_elimina_caractere_especial(replace(ds_conteudo_w, '''', ' '));
			CALL CALL CALL CALL CALL CALL ptu_moviment_benef_a300_pck.incluir_linha_arq('302', ds_conteudo_w, arq_texto_p);
			
			for r_c03_w in current_setting('ptu_moviment_benef_a300_pck.c03')::CURSOR(nr_seq_mov_prod_empresa_pc(r_c02_w.nr_seq_mov_prod_empresa) loop
				ds_conteudo_w := lpad(r_c03_w.cd_unimed,4,'0') || lpad(r_c03_w.ds_reservado,3,' ') || lpad(r_c03_w.id_benef,13,0) ||
						rpad(r_c03_w.ds_reservado,4,' ') || lpad(r_c03_w.cd_familia,6,0) || rpad(r_c03_w.nm_benef_abreviado,25,' ') ||
						rpad(r_c03_w.cd_plano_destino,6,' ') || coalesce(to_char(r_c03_w.dt_nascimento,'YYYYMMDD'),'        ') || rpad(r_c03_w.ie_sexo,1,' ') ||
						lpad(coalesce(r_c03_w.cd_cgc_cpf,0),15,0) || lpad(coalesce(r_c03_w.nr_rg,0),15,0) || rpad(coalesce(r_c03_w.sg_uf_rg,' '),2,' ') ||
						lpad(r_c03_w.ie_estado_civil,1,' ') || coalesce(to_char(r_c03_w.dt_inclusao,'YYYYMMDD'),'        ') || coalesce(r_c03_w.dt_exclusao,'        ') ||
						lpad(r_c03_w.cd_dependencia,02,0) || coalesce(to_char(r_c03_w.dt_repasse,'YYYYMMDD'),'        ') || coalesce(to_char(r_c03_w.dt_base_carencia,'YYYYMMDD'),'        ') ||
						coalesce(to_char(r_c03_w.dt_inclusao_plano_dest,'YYYYMMDD'),'        ') || coalesce(to_char(r_c03_w.dt_inclusao_empr_uni,'YYYYMMDD'),'        ') || lpad(r_c03_w.vl_mensalidade,14,0) ||
						lpad(coalesce(r_c03_w.cd_unimed_anterior,0),4,0) || lpad(coalesce(r_c03_w.cd_usuario_plano_ant,0),13,0) || lpad(coalesce(r_c03_w.id_benef_tit,0),13,0) ||
						rpad(r_c03_w.nm_beneficiario,118,' ') || lpad(r_c03_w.qt_prazo_vinculo,2,0) || lpad(coalesce(r_c03_w.ie_filho,0),2,0) || lpad(coalesce(r_c03_w.cd_empresa_origem,0),10,0) ||
						rpad(coalesce(r_c03_w.ie_tipo_acomodacao,' '),2,' ') || rpad(coalesce(r_c03_w.nr_identidade,' '),30,' ') || rpad(coalesce(r_c03_w.ds_orgao_emissor,' '),30,' ') ||
						lpad(coalesce(r_c03_w.cd_pais,0),3,0) || rpad(coalesce(r_c03_w.nr_cartao_nac_sus,0),15,0) || rpad(coalesce(r_c03_w.nm_mae_benef,' '),70,' ') ||
						rpad(coalesce(r_c03_w.nr_pis_pasep,0),11,0) || lpad(r_c03_w.renda_mensal,14,0);
				
				ds_conteudo_w := nfe_elimina_caractere_especial(replace(ds_conteudo_w, '''', ' '));
				CALL CALL CALL CALL CALL CALL ptu_moviment_benef_a300_pck.incluir_linha_arq('304', ds_conteudo_w, arq_texto_p);
				
				for r_c04_w in current_setting('ptu_moviment_benef_a300_pck.c04')::CURSOR((r_c03_w.nr_sequencia) loop
					ds_conteudo_w := rpad(r_c04_w.ds_endereco,40,' ') || rpad(r_c04_w.ds_bairro,30,' ') || lpad(r_c04_w.cd_cep,8,0) ||
							rpad(r_c04_w.ds_municipio,30,' ') || lpad(r_c04_w.sg_estado,2,' ') || lpad(coalesce(somente_numero(r_c04_w.nr_ddd_telefone),0),4,0) ||
							lpad(r_c04_w.ds_reservado,8,' ') || lpad(coalesce(r_c04_w.nr_ramal,0),4,0) || lpad(coalesce(somente_numero(r_c04_w.nr_telefone),0),9,0) ||
							lpad(coalesce(r_c04_w.nr_endereco,0),6,0);
					ds_conteudo_w := nfe_elimina_caractere_especial(replace(ds_conteudo_w, '''', ' '));
					CALL CALL CALL CALL CALL CALL ptu_moviment_benef_a300_pck.incluir_linha_arq('306', ds_conteudo_w, arq_texto_p);
				end loop;
				
			end loop;
			
		end loop;
		
		ds_conteudo_w := lpad(r_c01_w.qt_reg_benef,7,0) || lpad(r_c01_w.qt_reg_compl_benf,7,0) || lpad(0,28,0) || lpad(r_c01_w.qt_reg_empresas,7,0);
		
		CALL CALL CALL CALL CALL CALL ptu_moviment_benef_a300_pck.incluir_linha_arq('309', ds_conteudo_w, arq_texto_p);
		current_setting('ptu_moviment_benef_a300_pck.ds_arquivo_w')::text := pls_hash_ptu_pck.obter_hash_txt(current_setting('ptu_moviment_benef_a300_pck.ds_arquivo_w')::text);
		ds_conteudo_w		:=	lpad(ds_hash_w,32,' ');
		CALL CALL CALL CALL CALL CALL ptu_moviment_benef_a300_pck.incluir_linha_arq('998',ds_conteudo_w, arq_texto_p);
		
		update	ptu_movimentacao_produto
		set	ds_hash_a300	= ds_hash_w
		where	nr_sequencia 	= r_c01_w.nr_seq_mov_produto;
		commit;
	end loop;
	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ptu_moviment_benef_a300_pck.processar_arquivo_fea_90 ( nr_seq_lote_p bigint, arq_texto_p utl_file.file_type) FROM PUBLIC;
