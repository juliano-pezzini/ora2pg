-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

	
/* --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------*/

	


CREATE OR REPLACE PROCEDURE ptu_moviment_benef_a300_pck.criar_arquivo ( nm_arquivo_p text, arq_texto_p INOUT utl_file.file_type) AS $body$
DECLARE

	arq_texto_w			utl_file.file_type;
	ds_local_w			varchar(255) := null;
	ds_erro_w			varchar(255);
	file_exist_w			boolean;
	size_w				bigint;
	block_size_w			bigint;
	
BEGIN
	dbms_lob.createtemporary(current_setting('ptu_moviment_benef_a300_pck.ds_arquivo_w')::text, TRUE);
	dbms_lob.open(current_setting('ptu_moviment_benef_a300_pck.ds_arquivo_w')::text, dbms_lob.lob_readwrite);
	
	-- ARQUIVO
	begin
	obter_evento_utl_file(17, null, ds_local_w, ds_erro_w);
	exception
	when others then
		ds_local_w := null;
	end;
	
	if (ds_erro_w IS NOT NULL AND ds_erro_w::text <> '') then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(ds_erro_w);
	end if;
	
	--Obtem os dados do arquivo no diretorio
	utl_file.fgetattr(ds_local_w,nm_arquivo_p,file_exist_w,size_w,block_size_w);

	--Caso existir, remove ele para nao criar registros no arquivo ja criado
	if (file_exist_w) then
		utl_file.fremove(ds_local_w,nm_arquivo_p);
	end if;
	
	begin
		arq_texto_w := utl_file.fopen(ds_local_w,nm_arquivo_p,'W');
	exception
	when others then
		ds_erro_w := obter_erro_utl_open(SQLSTATE);
		CALL wheb_mensagem_pck.exibir_mensagem_abort('Local: ' || ds_local_w || ' Nome arquivo: ' || nm_arquivo_p || ' ' || ds_erro_w);
	end;
	
	arq_texto_p	:= arq_texto_w;
	
	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ptu_moviment_benef_a300_pck.criar_arquivo ( nm_arquivo_p text, arq_texto_p INOUT utl_file.file_type) FROM PUBLIC;
