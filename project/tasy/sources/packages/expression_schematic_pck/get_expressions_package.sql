-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION expression_schematic_pck.get_expressions (cd_funcao_p bigint, nr_seq_funcao_schematic_p bigint, nr_seq_obj_schematic_p bigint, si_children_p text, si_by_use_p text, cd_pais_p bigint) RETURNS SETOF T_ITEM AS $body$
DECLARE

		 
	line_w						t_item_row;
	nr_seq_funcao_schematic_w	bigint;	
		 
		c01 CURSOR(cd_funcao_pc					bigint, 
					nr_seq_funcao_schematic_pc	bigint, 
					nr_seq_obj_schematic_pc		bigint, 
					si_by_use_pc				text) FOR 
			/* By function code */
 
			SELECT	a.cd_expressao, 
					a.ds_expressao_br, 
					a.ds_expressao_us, 
					a.ds_expressao_de, 
					a.ds_glossario, 
					a.cd_funcao, 
					CASE WHEN si_by_use_pc='S' THEN a.ds_use  ELSE null END  ds_use, 
					dt_atualizacao, 
					null nr_seq_obj_schematic, 
					null nr_seq_funcao_schematic 
			from	expressao_schematic_v a 
			where	a.cd_funcao	= cd_funcao_pc 
			and		coalesce(nr_seq_funcao_schematic_pc::text, '') = '' 
			and		coalesce(nr_seq_obj_schematic_pc::text, '') = '' 
			group by 
					a.cd_expressao, 
					a.ds_expressao_br, 
					a.ds_expressao_us, 
					a.ds_expressao_de, 
					a.ds_glossario, 
					a.cd_funcao, 
					CASE WHEN si_by_use_pc='S' THEN a.ds_use  ELSE null END , 
					dt_atualizacao 
			
union all
 
			/* By schematic function code */
 
			SELECT	a.cd_expressao, 
					a.ds_expressao_br, 
					a.ds_expressao_us, 
					a.ds_expressao_de, 
					a.ds_glossario, 
					a.cd_funcao, 
					CASE WHEN si_by_use_pc='Y' THEN a.ds_use  ELSE null END  ds_use, 
					dt_atualizacao, 
					null nr_seq_obj_schematic, 
					a.nr_seq_funcao_schematic 
			from	expressao_schematic_v a 
			where	a.nr_seq_funcao_schematic = nr_seq_funcao_schematic_pc 
			and		coalesce(nr_seq_obj_schematic_pc::text, '') = '' 
			group by 
					a.cd_expressao, 
					a.ds_expressao_br, 
					a.ds_expressao_us, 
					a.ds_expressao_de, 
					a.ds_glossario, 
					a.cd_funcao, 
					CASE WHEN si_by_use_pc='Y' THEN a.ds_use  ELSE null END , 
					dt_atualizacao, 
					a.nr_seq_funcao_schematic 
			
union all
 
			/* By schematic object code - Without country view */
 
			select	a.cd_expressao, 
					a.ds_expressao_br, 
					a.ds_expressao_us, 
					a.ds_expressao_de, 
					a.ds_glossario, 
					a.cd_funcao, 
					CASE WHEN si_by_use_pc='Y' THEN a.ds_use  ELSE null END  ds_use, 
					dt_atualizacao, 
					a.nr_seq_obj_schematic, 
					a.nr_seq_funcao_schematic 
			from	expressao_schematic_v a 
			where	a.nr_seq_obj_schematic = nr_seq_obj_schematic_pc 
			and		coalesce(a.cd_pais::text, '') = '' 
			and (not exists (select	1 
								from	expressao_schematic_v x 
								where	x.nr_seq_obj_schematic = a.nr_seq_obj_schematic 
								and		(x.cd_pais IS NOT NULL AND x.cd_pais::text <> '')) or coalesce(cd_pais_p::text, '') = '') 
			group by 
					a.cd_expressao, 
					a.ds_expressao_br, 
					a.ds_expressao_us, 
					a.ds_expressao_de, 
					a.ds_glossario, 
					a.cd_funcao, 
					CASE WHEN si_by_use_pc='Y' THEN a.ds_use  ELSE null END , 
					dt_atualizacao, 
					a.nr_seq_obj_schematic, 
					a.nr_seq_funcao_schematic 
			
union all
 
			/* By schematic object code - Country view */
 
			select	a.cd_expressao, 
					a.ds_expressao_br, 
					a.ds_expressao_us, 
					a.ds_expressao_de, 
					a.ds_glossario, 
					a.cd_funcao, 
					CASE WHEN si_by_use_pc='Y' THEN a.ds_use  ELSE null END  ds_use, 
					dt_atualizacao, 
					a.nr_seq_obj_schematic, 
					a.nr_seq_funcao_schematic 
			from	expressao_schematic_v a 
			where	a.nr_seq_obj_schematic = nr_seq_obj_schematic_pc 
			and		a.cd_pais = cd_pais_p 
			group by 
					a.cd_expressao, 
					a.ds_expressao_br, 
					a.ds_expressao_us, 
					a.ds_expressao_de, 
					a.ds_glossario, 
					a.cd_funcao, 
					CASE WHEN si_by_use_pc='Y' THEN a.ds_use  ELSE null END , 
					dt_atualizacao, 
					a.nr_seq_obj_schematic, 
					a.nr_seq_funcao_schematic;WITH RECURSIVE cte AS (

					
		cObjSchem CURSOR FOR 
			/* Children schematic objects */
 
			SELECT	1 as level,a.*,ARRAY[ row_number() OVER (ORDER BY  nr_seq_apres) ] as hierarchy 
			FROM 	objeto_schematic a WHERE a.nr_sequencia = nr_seq_obj_schematic_p 
					AND a.nr_seq_funcao_schematic = nr_seq_funcao_schematic_w
  UNION ALL

					 
		cObjSchem CURSOR FOR 
			
 
			SELECT	(c.level+1),a.*, array_append(c.hierarchy, row_number() OVER (ORDER BY  nr_seq_apres))  as hierarchy 
			FROM 	objeto_schematic a JOIN cte c ON (c.nr_sequencia = a.nr_seq_obj_sup)

) SELECT * FROM cte WHERE nr_seq_funcao_schematic = nr_seq_funcao_schematic_w ORDER BY hierarchy;
;

	
BEGIN 
	 
		if (si_children_p = 'Y') and (nr_seq_obj_schematic_p IS NOT NULL AND nr_seq_obj_schematic_p::text <> '') then 
			select	a.nr_seq_funcao_schematic 
			into STRICT	nr_seq_funcao_schematic_w 
			from	objeto_schematic a 
			where	a.nr_sequencia	= nr_seq_obj_schematic_p;
		 
			for r_cObjSchem in cObjSchem loop 
					for r_c01 in c01(null,null,r_cObjSchem.nr_sequencia,si_by_use_p) loop 
						line_w.cd_expressao				:= r_c01.cd_expressao;
						line_w.ds_expressao_br			:= r_c01.ds_expressao_br;
						line_w.ds_expressao_us			:= r_c01.ds_expressao_us;
						line_w.ds_expressao_de			:= r_c01.ds_expressao_de;
						line_w.ds_glossario				:= r_c01.ds_glossario;
						line_w.cd_funcao				:= r_c01.cd_funcao;
						line_w.ds_use					:= r_c01.ds_use;
						line_w.dt_atualizacao			:= r_c01.dt_atualizacao;
						line_w.nr_seq_obj_schematic		:= r_c01.nr_seq_obj_schematic;
						line_w.nr_seq_funcao_schematic	:= r_c01.nr_seq_funcao_schematic;
						 
						RETURN NEXT line_w;
						 
					end loop;
			end loop;
		else 
			for r_c01 in c01(cd_funcao_p,nr_seq_funcao_schematic_p,nr_seq_obj_schematic_p,si_by_use_p) loop 
				 
				line_w.cd_expressao				:= r_c01.cd_expressao;
				line_w.ds_expressao_br			:= r_c01.ds_expressao_br;
				line_w.ds_expressao_us			:= r_c01.ds_expressao_us;
				line_w.ds_expressao_de			:= r_c01.ds_expressao_de;
				line_w.ds_glossario				:= r_c01.ds_glossario;
				line_w.cd_funcao				:= r_c01.cd_funcao;
				line_w.ds_use					:= r_c01.ds_use;
				line_w.dt_atualizacao			:= r_c01.dt_atualizacao;
				line_w.nr_seq_obj_schematic		:= r_c01.nr_seq_obj_schematic;
				line_w.nr_seq_funcao_schematic	:= r_c01.nr_seq_funcao_schematic;
				 
				RETURN NEXT line_w;
				 
			end loop;
		end if;
	 
		return;
				 
	END;			

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION expression_schematic_pck.get_expressions (cd_funcao_p bigint, nr_seq_funcao_schematic_p bigint, nr_seq_obj_schematic_p bigint, si_children_p text, si_by_use_p text, cd_pais_p bigint) FROM PUBLIC;
