-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_conv_xml_cta_pck.identifica_campos_conv () AS $body$
DECLARE


_ora2pg_r RECORD;
nr_contador_w		integer;
tb_nr_seq_item_w	pls_util_cta_pck.t_number_table;
tb_nr_seq_fornec_mat_w	pls_util_cta_pck.t_number_table;
tb_nr_seq_setor_atend_w	pls_util_cta_pck.t_number_table;
vl_conversao_fornec_w	pls_xml_campo_esp_conv.vl_conversao%type;
ie_codigo_fornecedor_w	pls_xml_campo_esp_conv.ie_codigo_fornecedor%type;

C01 CURSOR FOR
	SELECT 	nr_sequencia,
		nr_seq_regra,
		ie_tipo_item_conv,
		cd_fornecedor_material,
		cd_setor_atendimento
	from	pls_conta_item_imp_tmp
	where 	CASE WHEN coalesce(nr_seq_regra::text, '') = '' THEN  -1   ELSE -2 END  = -2;

BEGIN

nr_contador_w := 0;
SELECT * FROM pls_conv_xml_cta_pck.alimenta_campo_espec_conv(	tb_nr_seq_item_w, tb_nr_seq_fornec_mat_w, tb_nr_seq_setor_atend_w) INTO STRICT _ora2pg_r;
 	tb_nr_seq_item_w := _ora2pg_r.tb_nr_seq_item_p; tb_nr_seq_fornec_mat_w := _ora2pg_r.tb_nr_seq_fornec_mat_p; tb_nr_seq_setor_atend_w := _ora2pg_r.tb_nr_seq_setor_atend_p;


for r_c01_w in C01 loop
	
	tb_nr_seq_item_w(nr_contador_w) := r_c01_w.nr_sequencia;
	
	-- fornecedor do material

	if (coalesce(r_c01_w.cd_fornecedor_material::text, '') = '') then
	
		tb_nr_seq_fornec_mat_w(nr_contador_w) := null;
	else
		-- apenas serve a regra quando for material

		if (r_c01_w.ie_tipo_item_conv = 'M') then
			
			select	max(vl_conversao),
				max(ie_codigo_fornecedor)
			into STRICT	vl_conversao_fornec_w,
				ie_codigo_fornecedor_w
			from	pls_xml_campo_esp_conv
			where	nr_seq_regra = r_c01_w.nr_seq_regra
			and	coalesce(vl_origem, r_c01_w.cd_fornecedor_material) = r_c01_w.cd_fornecedor_material
			and	ie_campo = 'F';
			
			-- se for por sequencia

			if (ie_codigo_fornecedor_w = 'S') then
				
				-- se foi informado um valor de convers_o _ atribuido o mesmo

				if (vl_conversao_fornec_w IS NOT NULL AND vl_conversao_fornec_w::text <> '') then
				
					tb_nr_seq_fornec_mat_w(nr_contador_w) := vl_conversao_fornec_w;
				-- sen_o _ pego apenas os numeros do c_digo identificado no XML

				else
					tb_nr_seq_fornec_mat_w(nr_contador_w) := pls_util_pck.obter_somente_numero(r_c01_w.cd_fornecedor_material);
				end if;

			-- se for por c_digo ou estiver nulo entra aqui

			else
			
				select	max(nr_sequencia)
				into STRICT	tb_nr_seq_fornec_mat_w(nr_contador_w)
				from	pls_prestador
				where	cd_prestador = r_c01_w.cd_fornecedor_material;
			end if;
		else
			tb_nr_seq_fornec_mat_w(nr_contador_w) := null;
		end if;
	end if;
	
	-- setor de antedimento

	if (coalesce(r_c01_w.cd_setor_atendimento::text, '') = '') then
	
		tb_nr_seq_setor_atend_w(nr_contador_w) := null;
	else
		-- verifica se possui algum valor de convers_o para o campo

		select	max(vl_conversao)
		into STRICT	vl_conversao_fornec_w
		from	pls_xml_campo_esp_conv
		where	nr_seq_regra = r_c01_w.nr_seq_regra
		and	vl_origem = r_c01_w.cd_setor_atendimento
		and	ie_campo  = 'S';
		
		-- se tiver valor de convers_o atribui direto

		if (vl_conversao_fornec_w IS NOT NULL AND vl_conversao_fornec_w::text <> '') then
		
			tb_nr_seq_setor_atend_w(nr_contador_w) := vl_conversao_fornec_w;
			
		-- sen_o _ feito um select para tentar identificar o setor de atendimento

		else
			
			select	max(nr_sequencia)
			into STRICT	tb_nr_seq_setor_atend_w(nr_contador_w)
			from	pls_setor_atendimento
			where	cd_setor_atendimento = r_c01_w.cd_setor_atendimento;
		end if;
	end if;
	
	-- se atingiu a quantidade manda pro banco

	if (nr_contador_w >= pls_util_pck.qt_registro_transacao_w) then
	
		SELECT * FROM pls_conv_xml_cta_pck.alimenta_campo_espec_conv(	tb_nr_seq_item_w, tb_nr_seq_fornec_mat_w, tb_nr_seq_setor_atend_w) INTO STRICT _ora2pg_r;
 	tb_nr_seq_item_w := _ora2pg_r.tb_nr_seq_item_p; tb_nr_seq_fornec_mat_w := _ora2pg_r.tb_nr_seq_fornec_mat_p; tb_nr_seq_setor_atend_w := _ora2pg_r.tb_nr_seq_setor_atend_p;
		nr_contador_w := 0;
	else
		nr_contador_w := nr_contador_w + 1;
	end if;
end loop;

-- se sobrou algo manda pro banco

SELECT * FROM pls_conv_xml_cta_pck.alimenta_campo_espec_conv(	tb_nr_seq_item_w, tb_nr_seq_fornec_mat_w, tb_nr_seq_setor_atend_w) INTO STRICT _ora2pg_r;
 	tb_nr_seq_item_w := _ora2pg_r.tb_nr_seq_item_p; tb_nr_seq_fornec_mat_w := _ora2pg_r.tb_nr_seq_fornec_mat_p; tb_nr_seq_setor_atend_w := _ora2pg_r.tb_nr_seq_setor_atend_p;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_conv_xml_cta_pck.identifica_campos_conv () FROM PUBLIC;
