-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_conv_xml_cta_pck.pls_conv_dados_para_tasy ( nr_seq_protocolo_p pls_protocolo_conta_imp.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) AS $body$
DECLARE


cd_estabelecimento_w	estabelecimento.cd_estabelecimento%type;
cd_versao_tiss_conv_w	pls_protocolo_conta_imp.cd_versao_tiss_conv%type;


BEGIN
-- carrega os par_metros para vari_veis globais da package

CALL CALL CALL CALL CALL CALL pls_conv_xml_cta_pck.carrega_parametros(cd_estabelecimento_p, 'C');

-- rotina que alimenta campos com valores padr_o para otimizar a performance

-- ela resolver casos em que normalmente se utilizar OR em clausulas where

-- ex: and (a.ie_situacao = 'A' or a.ie_situacao is null)

-- no caso do exemplo acima _ feito um update para que tudo o que for nulo receba o valor 'A'

CALL pls_conv_xml_cta_pck.alimenta_campos_nulo();

-- faz todo o reconhecimento e convers_o dos dados importados do arquivo para o dom_nio do Tasy referente a protocolo

CALL pls_conv_xml_cta_pck.pls_conv_nv_protocolo(nr_seq_protocolo_p, nm_usuario_p, cd_estabelecimento_p);

-- existe uma atualizacao no cd_estabelecimento do protocolo.

-- por isso copiamos aqui o que est_ no protocolo e enviamos para a conta

select 	max(cd_estabelecimento),
	max(cd_versao_tiss_conv)
into STRICT 	cd_estabelecimento_w,
	cd_versao_tiss_conv_w
from	pls_protocolo_conta_imp
where	nr_sequencia = nr_seq_protocolo_p;

-- faz todo o reconhecimento e convers_o dos dados importados do arquivo para o dom_nio do Tasy referente a conta

CALL pls_conv_xml_cta_pck.pls_conv_nv_conta(nr_seq_protocolo_p, nm_usuario_p, cd_estabelecimento_w);

-- faz todo o reconhecimento e convers_o dos dados importados do arquivo para o dom_nio do Tasy referente aos diagn_sticos das contas

CALL pls_conv_xml_cta_pck.pls_conv_nv_diagnostico_conta(nr_seq_protocolo_p, nm_usuario_p, cd_estabelecimento_w);

-- faz todo o reconhecimento e convers_o dos dados importados do arquivo para o dom_nio do Tasy referente as declaracoes de obitos

CALL pls_conv_xml_cta_pck.pls_conv_nv_declaracao_conta(nr_seq_protocolo_p, nm_usuario_p, cd_estabelecimento_w);

-- faz todo o reconhecimento e convers_o dos dados importados do arquivo para o dom_nio do Tasy referente aos itens das contas

CALL pls_conv_xml_cta_pck.pls_conv_nv_item_conta(nr_seq_protocolo_p, cd_versao_tiss_conv_w, nm_usuario_p, cd_estabelecimento_w);

-- aqui faz os tratamentos para gerar um registro para cada face do dente nas guias de odontologia no padr_o TISS esses dados

-- s_o enviados em um _nico campo (pls_conta_item_imp -> cd_face_dente)

CALL pls_conv_xml_cta_pck.pls_conv_nv_gerar_face_dente(nr_seq_protocolo_p, nm_usuario_p);

-- faz a identificacao dos dados da equipe m_dica que executou os procedimentos do protocolo

CALL pls_conv_xml_cta_pck.pls_conv_nv_equipe_item_conta(nr_seq_protocolo_p, nm_usuario_p, cd_estabelecimento_w);

-- faz a separacao da tabela pls_conta_item_imp nas tabelas pls_conta_proc_imp e pls_conta_mat_imp

CALL pls_conv_xml_cta_pck.pls_desmembrar_tab_item(nr_seq_protocolo_p);

--Atualiza as coberturas dos itens.

CALL pls_conv_xml_cta_pck.pls_atualiza_coberturas(nr_seq_protocolo_p, nm_usuario_p, cd_estabelecimento_p);

--Faz _ltimas tratativas sobre procedimentos(se faz necess_rio pois em tese aqui as convers_es j_ ocorreram e informacoes necess_rias passam a estar dispon_veis)

--como obter grupo ANS e outras coisas mais.

CALL pls_conv_xml_cta_pck.pls_atualizar_info_finais_proc(nr_seq_protocolo_p, cd_estabelecimento_p);

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_conv_xml_cta_pck.pls_conv_dados_para_tasy ( nr_seq_protocolo_p pls_protocolo_conta_imp.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) FROM PUBLIC;
