-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_conv_xml_cta_pck.processa_regras_conv_proc ( cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) AS $body$
DECLARE


ds_select_w		varchar(4000);
ds_restricao_w		varchar(3500);
ds_campo_w		varchar(500);
cursor_w		sql_pck.t_cursor;
bind_sql_valor_w	sql_pck.t_dado_bind;
tb_nr_seq_item_w	pls_util_cta_pck.t_number_table;
tb_nr_seq_regra_w	pls_util_cta_pck.t_number_table;
tb_ie_orig_proc_conv_w	pls_util_cta_pck.t_number_table;
tb_cd_proc_conv_w	pls_util_cta_pck.t_number_table;

C01 CURSOR FOR
	SELECT	a.nr_sequencia nr_seq_regra,
		a.dt_inicio_vigencia,
		a.dt_fim_vigencia,
		a.nr_seq_tipo_prestador,
		a.nr_seq_grupo_prestador,
		a.nr_seq_prestador,
		a.ie_tipo_tabela,
		a.cd_area_procedimento,
		a.cd_especialidade,
		a.cd_grupo_proc,
		a.cd_procedimento,
		a.ie_origem_proced,
		a.nr_seq_congenere,
		a.ie_origem_conversao,
		a.cd_proc_conversao,
		a.nr_seq_grupo_contrato,
		a.cd_material_imp,
		a.ie_tipo_intercambio
	from	pls_regra_conv_item_tmp b,
		pls_conversao_proc a
	where	a.nr_sequencia = b.nr_seq_regra
	order by
		coalesce(a.nr_ordem_exec_regra, 9999999999),
		a.nr_sequencia;

BEGIN
-- faz o select do item, da regra e dos campos 'ent_o', restringe pelo campo da regra

-- para caso j_ tenha entrado em alguma regra n_o processe novamente para respeitar (nr_seq_regra is null)

-- a ordenacao definida pelo usu_rio

ds_campo_w := 	' select a.nr_sequencia nr_seq_item, '|| pls_util_pck.enter_w ||
			' :nr_seq_regra nr_seq_regra_conv, '|| pls_util_pck.enter_w ||
			' :ie_origem_conversao ie_origem_proc_conv, '|| pls_util_pck.enter_w ||
			' nvl(:cd_proc_conversao, a.cd_procedimento_conv) cd_procedimento_conv '|| pls_util_pck.enter_w ||
		' from pls_conta_item_imp_tmp a ' || pls_util_pck.enter_w ||
		' where decode(a.nr_seq_regra, null, -1, -2) = -1 ' || pls_util_pck.enter_w;
	
for r_c01_w in C01 loop

	-- limpa os dados da bind

	bind_sql_valor_w.delete;
	ds_restricao_w := '';
	ds_select_w := '';

	bind_sql_valor_w := sql_pck.bind_variable(':nr_seq_regra', r_c01_w.nr_seq_regra, bind_sql_valor_w);
	-- atribui os valores do ent_o da regra para retornar no select

	bind_sql_valor_w := sql_pck.bind_variable(':ie_origem_conversao', r_c01_w.ie_origem_conversao, bind_sql_valor_w);
	bind_sql_valor_w := sql_pck.bind_variable(':cd_proc_conversao', r_c01_w.cd_proc_conversao, bind_sql_valor_w);

	-- monta a restricao de acordo com os dados da regra que esta sendo processada

	bind_sql_valor_w := pls_conv_xml_cta_pck.obter_restricao_regra_proc(	'a', r_c01_w.dt_inicio_vigencia, r_c01_w.dt_fim_vigencia, r_c01_w.ie_tipo_tabela, r_c01_w.nr_seq_prestador, r_c01_w.nr_seq_tipo_prestador, r_c01_w.nr_seq_grupo_prestador, r_c01_w.cd_area_procedimento, r_c01_w.cd_especialidade, r_c01_w.cd_grupo_proc, r_c01_w.cd_procedimento, r_c01_w.ie_origem_proced, r_c01_w.nr_seq_congenere, r_c01_w.nr_seq_grupo_contrato, r_c01_w.cd_material_imp, r_c01_w.ie_tipo_intercambio, cd_estabelecimento_p, bind_sql_valor_w);

	-- monta o select

	ds_select_w := ds_campo_w || ds_restricao_w;
	
	bind_sql_valor_w := sql_pck.executa_sql_cursor(ds_select_w, bind_sql_valor_w);
	
	-- pega tudo que retornar e atribui o ent_o da regra

	loop
		fetch cursor_w bulk collect into 	tb_nr_seq_item_w, tb_nr_seq_regra_w,
							tb_ie_orig_proc_conv_w, tb_cd_proc_conv_w
		limit pls_util_pck.qt_registro_transacao_w;
		exit when tb_nr_seq_item_w.count = 0;

		forall i in tb_nr_seq_item_w.first..tb_nr_seq_item_w.last
			update	pls_conta_item_imp
			set	nr_seq_regra_item_conv = tb_nr_seq_regra_w(i),
				ie_origem_proced_conv = tb_ie_orig_proc_conv_w(i),
				cd_procedimento_conv = tb_cd_proc_conv_w(i)
			where  	nr_sequencia = tb_nr_seq_item_w(i);
		commit;
	end loop;
	close cursor_w;
end loop;
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_conv_xml_cta_pck.processa_regras_conv_proc ( cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) FROM PUBLIC;
