-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_conv_xml_cta_pck.pls_gerar_resumo_prot_imp ( nr_seq_protocolo_p pls_protocolo_conta_imp.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE


qt_contas_w 		pls_resumo_importacao.qt_contas%type;
qt_contas_glosa_w 	pls_resumo_importacao.qt_contas_criticadas%type;
qt_itens_w 		pls_resumo_importacao.qt_itens_protocolo%type;
qt_itens_glosa_w 	pls_resumo_importacao.qt_itens_criticados%type;
vl_total_w 		pls_conta_item_imp.vl_total%type;
vl_tot_crit_w 		pls_conta_imp.vl_total_geral%type;
qt_mensagem_aviso_w 	pls_resumo_importacao.qt_mensagens_aviso%type;
qt_mensagem_bloqueio_w	pls_resumo_importacao.qt_mensagens_bloqueio%type;
nr_seq_usu_prestador_w  pls_protocolo_conta_imp.nr_seq_prestador_web%type;
ds_observacao_w		pls_acesso_portal_log.ds_observacao%type;
ds_acao_w		pls_acesso_portal_log.ds_acao%type;
nr_seq_resumo_w		pls_resumo_importacao.nr_sequencia%type;


BEGIN
--Obt_m a quantidade de contas no protocolo

select	count(1)
into STRICT	qt_contas_w
from	pls_conta_imp
where	nr_seq_protocolo = nr_seq_protocolo_p;

--Obt_m a quantidade de contas com ocorr_ncias no protocolo

select	count(1)
into STRICT	qt_contas_glosa_w
from	pls_conta_imp a
where	exists (
		SELECT	1
		from	pls_ocorrencia_imp b
		where	a.nr_sequencia = b.nr_seq_conta)
and	a.nr_seq_protocolo = nr_seq_protocolo_p;

--Obt_m a quantidade de itens das contas do protocolo

select	count(1)
into STRICT	qt_itens_w
from	pls_conta_imp a,
	pls_conta_item_imp b
where	a.nr_seq_protocolo	= nr_seq_protocolo_p
and	b.nr_seq_conta		= a.nr_sequencia;
	
-- Obt_m a quantidade de itens (procedimentos e materiais) que foram glosados.		

select 	sum(qt)
into STRICT	qt_itens_glosa_w
from (
	SELECT	count(1) qt
	from	pls_conta_imp a,
		pls_conta_proc_imp b
	where	a.nr_seq_protocolo	= nr_seq_protocolo_p
	and	b.nr_seq_conta		= a.nr_sequencia
	and	exists (	SELECT	1
			from	pls_ocorrencia_imp x
			where	x.nr_seq_conta		= b.nr_seq_conta
			and	x.nr_seq_conta_proc	= b.nr_sequencia)
	
union	all

	select	count(1) qt
	from	pls_conta_imp a,
		pls_conta_mat_imp b
	where	a.nr_seq_protocolo	= nr_seq_protocolo_p
	and	b.nr_seq_conta		= a.nr_sequencia
	and	exists (	select	1
			from	pls_ocorrencia_imp w
			where	w.nr_seq_conta		= b.nr_seq_conta
			and	w.nr_seq_conta_mat	= b.nr_sequencia)) alias5;

-- Obt_m o valor apresentado(Importado). Soma dos Procedimentos  + Materiais.

select	sum(coalesce(a.vl_total,0))
into STRICT	vl_total_w
from	pls_conta_imp b,
	pls_conta_item_imp a
where	b.nr_seq_protocolo	= nr_seq_protocolo_p
and	a.nr_seq_conta		= b.nr_sequencia;

-- Obter o valor total de importacao com glosa

select	coalesce(sum(vl_total_geral),0)
into STRICT	vl_tot_crit_w
from (
	SELECT	sum(b.vl_total) vl_total_geral
	from	pls_conta_imp a,
		pls_conta_proc_imp b
	where	a.nr_seq_protocolo	= nr_seq_protocolo_p
	and	b.nr_seq_conta		= a.nr_sequencia
	and	exists (	SELECT	1
			from	pls_ocorrencia_imp w
			where	w.nr_seq_conta		= b.nr_seq_conta
			and	w.nr_seq_conta_proc	= b.nr_sequencia)
	
union	all

	select	sum(b.vl_total) vl_total_geral
	from	pls_conta_imp a,
		pls_conta_mat_imp b
	where	a.nr_seq_protocolo	= nr_seq_protocolo_p
	and	b.nr_seq_conta		= a.nr_sequencia
	and	exists (	select	1
			from	pls_ocorrencia_imp x
			where	x.nr_seq_conta		= b.nr_seq_conta
			and	x.nr_seq_conta_mat	= b.nr_sequencia)) alias6;	

--Obt_m a quantidade de avisos gerados na importacao do XML

select	count(1)
into STRICT	qt_mensagem_aviso_w
from	pls_mensagem_importacao
where	nr_seq_protocolo_imp = nr_seq_protocolo_p
and	nr_seq_mensagem in (5013, 5011);

--Obt_m a quantidade de mensagens que bloqueiam a importacao do XML

select	count(1)
into STRICT	qt_mensagem_bloqueio_w
from	pls_mensagem_importacao
where	nr_seq_protocolo_imp = nr_seq_protocolo_p
and	nr_seq_mensagem in (5014, 5001, 5002, 5012, 5010, 5007);


-- Verifica se ja existe um resumo, se existir somente atualiza ele

select	max(nr_sequencia)
into STRICT	nr_seq_resumo_w
from	pls_resumo_importacao
where	nr_seq_protocolo_imp	= nr_seq_protocolo_p;

if (coalesce(nr_seq_resumo_w::text, '') = '') then

	--Grava resumo da importacao

	insert into pls_resumo_importacao(
		nr_sequencia,
		nm_usuario,
		nr_seq_protocolo_imp,
		qt_contas,
		qt_contas_criticadas,
		qt_itens_protocolo,
		qt_itens_criticados,
		qt_mensagens_aviso,
		qt_mensagens_bloqueio,
		dt_atualizacao,
		qt_valor_total,
		qt_valor_tot_crit
	) values (
		nextval('pls_resumo_importacao_seq'),
		nm_usuario_p,
		nr_seq_protocolo_p,
		qt_contas_w,
		qt_contas_glosa_w,
		qt_itens_w,
		qt_itens_glosa_w,
		qt_mensagem_aviso_w,
		qt_mensagem_bloqueio_w,
		clock_timestamp(),
		vl_total_w,
		vl_tot_crit_w
	);
else

	update	pls_resumo_importacao
	set	nm_usuario		= nm_usuario_p,
		nr_seq_protocolo_imp	= nr_seq_protocolo_p,
		qt_contas		= qt_contas_w,
		qt_contas_criticadas	= qt_contas_glosa_w,
		qt_itens_protocolo	= qt_itens_w,
		qt_itens_criticados	= qt_itens_glosa_w,
		qt_mensagens_aviso	= qt_mensagem_aviso_w,
		qt_mensagens_bloqueio	= qt_mensagem_bloqueio_w,
		dt_atualizacao		= clock_timestamp(),
		qt_valor_total		= vl_total_w,
		qt_valor_tot_crit	= vl_tot_crit_w
	where	nr_sequencia		= nr_seq_resumo_w;

end if;

--Grava Log de acesso ao portal para a importacao do XML.

if (nm_usuario_p <> 'WebService') then
	
	select	max(nr_seq_prestador_web)
	into STRICT	nr_seq_usu_prestador_w
	from	pls_protocolo_conta_imp
	where	nr_sequencia = nr_seq_protocolo_p;
	
	if (nr_seq_usu_prestador_w IS NOT NULL AND nr_seq_usu_prestador_w::text <> '') then
		----'O usu_rio '||nm_usuario_p||' importou um arquivo TISS.', 

		ds_observacao_w	:= wheb_mensagem_pck.get_texto(352136,'nm_usuario_p=' || nm_usuario_p);
		--'Importou arquivo TISS.', 

		ds_acao_w	:= wheb_mensagem_pck.get_texto(352137);
		
		CALL pls_gravar_log_acesso_portal(	null, null, nr_seq_usu_prestador_w,
						null, null, null,
						null, null, '18',
						ds_observacao_w, ds_acao_w, 'N');
	end if;
end if;

commit;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_conv_xml_cta_pck.pls_gerar_resumo_prot_imp ( nr_seq_protocolo_p pls_protocolo_conta_imp.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;
