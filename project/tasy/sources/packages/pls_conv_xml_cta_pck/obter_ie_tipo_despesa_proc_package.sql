-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pls_conv_xml_cta_pck.obter_ie_tipo_despesa_proc ( cd_procedimento_conv_p pls_conta_item_imp.cd_procedimento_conv%type, ie_origem_proced_conv_p pls_conta_item_imp.ie_origem_proced_conv%type, ie_tipo_despesa_conv_p pls_conta_item_imp.ie_tipo_despesa_conv%type, cd_versao_tiss_conv_p pls_protocolo_conta_imp.cd_versao_tiss_conv%type) RETURNS varchar AS $body$
DECLARE


ie_tipo_despesa_w	pls_conta_item_imp.ie_tipo_despesa_conv%type;
				

BEGIN
-- function recebe sempre o padr_o TISS - varchar2(2) com zero na frente

-- 05 -> Di_rias

-- 07 -> Taxas e alugu_is

-- retorna o ie_tipo_despesa do padr_o Tasy 


ie_tipo_despesa_w := ie_tipo_despesa_conv_p;

-- se for procedimento e ainda n_o conseguimos identificar o tipo de despesa

-- busca do cadastro de procedimentos

if (coalesce(ie_tipo_despesa_w::text, '') = '') then

	select 	max(ie_classificacao)
	into STRICT	ie_tipo_despesa_w
	from	procedimento
	where	cd_procedimento = cd_procedimento_conv_p
	and	ie_origem_proced = ie_origem_proced_conv_p;
end if;

-- se for versao tiss igual ou superior a 3.01 _ necess_rio fazer uma convers_o na informacao

-- que vem no XML ou nas regras que foram aplicadas para o c_digo do tasy

if (cd_versao_tiss_conv_p >= '3.01.00') then	
	-- di_rias

	if (ie_tipo_despesa_w = '05') then
		ie_tipo_despesa_w := '3';
		
	-- taxas e alugu_is

	elsif (ie_tipo_despesa_w = '07') then
		ie_tipo_despesa_w := '2';
	end if;
end if;

-- se for maior que um o tamanho, busca da _ltima casa para retirar o zero a esquerda

if (length(ie_tipo_despesa_w) > 1) then
	ie_tipo_despesa_w := substr(ie_tipo_despesa_w, -1);
end if;

-- se mesmo assim ainda n_o encontrou nada _ um procedimento normal (1)

if (ie_tipo_despesa_w not in ('1', '2', '3', '4') or coalesce(ie_tipo_despesa_w::text, '') = '') then
	ie_tipo_despesa_w := '1';
end if;

return	ie_tipo_despesa_w;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pls_conv_xml_cta_pck.obter_ie_tipo_despesa_proc ( cd_procedimento_conv_p pls_conta_item_imp.cd_procedimento_conv%type, ie_origem_proced_conv_p pls_conta_item_imp.ie_origem_proced_conv%type, ie_tipo_despesa_conv_p pls_conta_item_imp.ie_tipo_despesa_conv%type, cd_versao_tiss_conv_p pls_protocolo_conta_imp.cd_versao_tiss_conv%type) FROM PUBLIC;
