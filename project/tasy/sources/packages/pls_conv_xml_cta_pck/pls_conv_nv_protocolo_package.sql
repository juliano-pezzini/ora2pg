-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_conv_xml_cta_pck.pls_conv_nv_protocolo ( nr_seq_protocolo_p pls_protocolo_conta_imp.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) AS $body$
DECLARE


nr_seq_prestador_conv_w		pls_protocolo_conta_imp.nr_seq_prestador_conv%type;
cd_prestador_conv_w		pls_protocolo_conta_imp.cd_prestador_conv%type;
cd_prest_upper_conv_w		pls_protocolo_conta_imp.cd_prest_upper_conv%type;
cd_prest_number_conv_w		pls_protocolo_conta_imp.cd_prest_number_conv%type;
cd_cgc_prestador_conv_w		pls_protocolo_conta_imp.cd_cgc_prestador_conv%type;
cd_cpf_prestador_conv_w		pls_protocolo_conta_imp.cd_cpf_prestador_conv%type;
cd_estabelecimento_w		pls_protocolo_conta_imp.cd_estabelecimento%type;
nr_seq_outorgante_conv_w	pls_protocolo_conta_imp.nr_seq_outorgante_conv%type;
cd_versao_tiss_conv_w		pls_protocolo_conta_imp.cd_versao_tiss_conv%type;
dt_mes_competencia_w		timestamp;

c01 CURSOR(nr_seq_protocolo_pc	pls_protocolo_conta_imp.nr_sequencia%type) FOR
	SELECT	a.nr_sequencia nr_seq_protocolo,
		a.cd_prestador,
		a.cd_cgc_prestador,
		a.cd_cpf_prestador,
		a.cd_ans,
		a.cd_versao_tiss,
		a.nr_seq_lote_protocolo,
		a.nr_seq_prestador_conv,
		a.dt_mes_competencia_conv,
		a.ie_tipo_guia,
		a.dt_recebimento_conv,
		a.dt_transacao
	from	pls_protocolo_conta_imp a
	where	a.nr_sequencia = nr_seq_protocolo_pc;
	
BEGIN
-- carrega os par_metros para vari_veis globais da package

CALL CALL CALL CALL CALL CALL pls_conv_xml_cta_pck.carrega_parametros(cd_estabelecimento_p, 'C');

for r_c01_w in c01(nr_seq_protocolo_p) loop

	--Obt_m o outorgante pelo c_digo ANS

	nr_seq_outorgante_conv_w := pls_conv_xml_cta_pck.obter_outorgante_conv(r_c01_w.cd_ans, cd_estabelecimento_p);
	--Obt_m o estabelecimento do outorgante

	cd_estabelecimento_w  := pls_conv_xml_cta_pck.obter_estabelecimento_outor(nr_seq_outorgante_conv_w);
	--formata a vers_o do TISS do protocolo XML

	cd_versao_tiss_conv_w := pls_conv_xml_cta_pck.formata_cd_versao_tiss(r_c01_w.cd_versao_tiss);
	--Obt_m a data de compet_ncia

	dt_mes_competencia_w  := pls_obter_dataref_prot_imp(	r_c01_w.nr_seq_prestador_conv, 'E',
								clock_timestamp(), r_c01_w.dt_transacao,
								r_c01_w.dt_recebimento_conv, null,
								r_c01_w.ie_tipo_guia,null, cd_estabelecimento_p);
	
	-- Caso n_o encontre um estabelecimento permanece o que j_ estava informado

	if (coalesce(cd_estabelecimento_w::text, '') = '') then
		cd_estabelecimento_w := cd_estabelecimento_p;
	end if;
	
	-- obt_m a sequ_ncia do prestador do protocolo

	SELECT * FROM pls_conv_xml_cta_pck.obter_prestador_tasy(	'C', r_c01_w.cd_prestador, r_c01_w.cd_cgc_prestador, r_c01_w.cd_cpf_prestador, cd_estabelecimento_w, r_c01_w.dt_recebimento_conv) INTO STRICT cd_prestador_conv_w, cd_prest_upper_conv_w, cd_prest_number_conv_w, cd_cgc_prestador_conv_w, cd_cpf_prestador_conv_w;

	-- alimenta os campos convertidos

	update	pls_protocolo_conta_imp set
		nr_seq_prestador_conv 	= nr_seq_prestador_conv_w,
		ie_guia_fisica_conv 	= current_setting('pls_conv_xml_cta_pck.ie_guia_fisica_param_w')::pls_param_importacao_conta.ie_guia_fisica%type,
		cd_prestador_conv 	= cd_prestador_conv_w,
		cd_prest_upper_conv 	= cd_prest_upper_conv_w,
		cd_prest_number_conv 	= cd_prest_number_conv_w,
		cd_cgc_prestador_conv 	= cd_cgc_prestador_conv_w,
		cd_cpf_prestador_conv	= cd_cpf_prestador_conv_w,
		nr_seq_outorgante_conv 	= nr_seq_outorgante_conv_w,
		cd_estabelecimento	= cd_estabelecimento_w,
		cd_versao_tiss_conv	= cd_versao_tiss_conv_w,
		dt_recebimento_conv	= clock_timestamp(),
		dt_mes_competencia_conv	= dt_mes_competencia_w
	where	nr_sequencia 	= r_c01_w.nr_seq_protocolo;
	commit;
	
	if (nm_usuario_p = 'WebService') then
		update	pls_lote_protocolo_conta
		set	nr_seq_prestador	= nr_seq_prestador_conv_w
		where	nr_sequencia		= r_c01_w.nr_seq_lote_protocolo;
	end if;
	
end loop;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_conv_xml_cta_pck.pls_conv_nv_protocolo ( nr_seq_protocolo_p pls_protocolo_conta_imp.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) FROM PUBLIC;
