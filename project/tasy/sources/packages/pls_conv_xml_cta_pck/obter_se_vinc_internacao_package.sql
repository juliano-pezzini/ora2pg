-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pls_conv_xml_cta_pck.obter_se_vinc_internacao ( ie_tipo_guia_p pls_protocolo_conta_imp.ie_tipo_guia%type default null, nr_seq_segurado_p pls_conta_imp.nr_seq_segurado_conv%type default null, cd_guia_ok_p pls_conta_imp.cd_guia_ok_conv%type default null) RETURNS varchar AS $body$
DECLARE


ds_retorno_w	varchar(1);
qt_guia_int_w	integer;


BEGIN

ds_retorno_w	:= null;

-- Se for resumo de internacao ent_o _ internacao

if (ie_tipo_guia_p = '5') then

	ds_retorno_w	:= 'S';
	
-- qualquer outro tipo de guia verifica se existe algum v_nculo com outra guia de resumo de internacao

-- se tiver vinculo _ internacao, sen_o n_o _

else
	-- somente verifica pelo c_digo da guia os outros atendimentos vinculados

	-- solicitacao feita pelo Carlos em conex_o sobre a OS 853108

	select	sum(qt_guia_int)
	into STRICT	qt_guia_int_w
	from (SELECT	count(1) qt_guia_int
		from	pls_conta
		where	ie_tipo_guia	= '5'
		and	cd_guia_ok	= cd_guia_ok_p
		and	nr_seq_segurado = nr_seq_segurado_p
		and	ie_status	!= 'C'
		
union	all

		PERFORM	count(1) qt_guia_int
		from	pls_protocolo_conta_imp b,
			pls_conta_imp a
		where	b.ie_tipo_guia	= '5'
		and	a.nr_seq_protocolo = b.nr_sequencia
		and	a.cd_guia_ok_conv = cd_guia_ok_p
		and	a.nr_seq_segurado_conv = nr_seq_segurado_p) alias3;
	
	if (qt_guia_int_w	> 0) then
		ds_retorno_w	:= 'S';
	end if;
	
end if;

if (coalesce(ds_retorno_w::text, '') = '') then
	ds_retorno_w	:= 'N';
end if;

return ds_retorno_w;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pls_conv_xml_cta_pck.obter_se_vinc_internacao ( ie_tipo_guia_p pls_protocolo_conta_imp.ie_tipo_guia%type default null, nr_seq_segurado_p pls_conta_imp.nr_seq_segurado_conv%type default null, cd_guia_ok_p pls_conta_imp.cd_guia_ok_conv%type default null) FROM PUBLIC;
