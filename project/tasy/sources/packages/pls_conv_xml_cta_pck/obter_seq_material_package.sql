-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pls_conv_xml_cta_pck.obter_seq_material ( cd_tipo_tabela_conv_p pls_conta_item_imp.cd_tipo_tabela_conv%type, cd_material_p pls_conta_item_imp.cd_procedimento%type, cd_material_number_p pls_conta_item_imp.cd_procedimento_conv%type, dt_execucao_mat_p pls_conta_item_imp.dt_execucao%type, ie_tipo_despesa_conv_p pls_conta_item_imp.ie_tipo_despesa_conv%type, ie_tipo_relacao_prest_p pls_conta_item_imp_tmp.ie_tipo_rel_prest_conv%type, nr_seq_material_conv_p pls_material.nr_sequencia%type, cd_versao_tiss_conv_p pls_protocolo_conta_imp.cd_versao_tiss_conv%type) RETURNS bigint AS $body$
DECLARE


nr_seq_material_conv_w	pls_material.nr_sequencia%type;


BEGIN

case(cd_tipo_tabela_conv_p)
	
	-- tipo tabela 5 _ brasindice

	when '05' then
		nr_seq_material_conv_w := pls_conv_xml_cta_pck.obter_seq_mat_brasindice( 	cd_material_p, cd_material_number_p,
									dt_execucao_mat_p);
	-- tipo tabela 12 _ simpro

	when '12' then
		nr_seq_material_conv_w := pls_conv_xml_cta_pck.obter_seq_mat_simpro(cd_material_p, dt_execucao_mat_p);
	else
		-- verifica o tipo tabela e o parametro da gest_o de operadoras - importacao

		if (cd_tipo_tabela_conv_p in ('18', '19', '20')) and (current_setting('pls_conv_xml_cta_pck.ie_material_tuss_w')::pls_param_importacao_conta.ie_material_tuss%type in ('T', 'A')) then

			-- _ feito um select no cd_material_tuss, o mesmo _ um number por isso passo o cd_material_number_p

			nr_seq_material_conv_w := pls_converte_codigo_tuss_mat(cd_material_number_p, cd_versao_tiss_conv_p, dt_execucao_mat_p);
		end if;
		
		-- se n_o encontrou material acima e a regra sinaliza que _ ambos

		if (coalesce(nr_seq_material_conv_w::text, '') = '') and (current_setting('pls_conv_xml_cta_pck.ie_material_tuss_w')::pls_param_importacao_conta.ie_material_tuss%type in ('C','A')) then
			
			-- se o parametro da operadora diz que depende da regra verifica a regra v_lida

			-- sen_o j_ identifica de acordo com o parametro

			if (current_setting('pls_conv_xml_cta_pck.ie_tipo_material_w')::pls_param_importacao_conta.ie_tipo_material%type  = 'R') then
			
				nr_seq_material_conv_w := pls_conv_xml_cta_pck.obter_seq_mat_regra_imp(	cd_material_p, cd_material_number_p,
											ie_tipo_despesa_conv_p, ie_tipo_relacao_prest_p,
											dt_execucao_mat_p, cd_versao_tiss_conv_p);
			
			else
			
				nr_seq_material_conv_w := pls_conv_xml_cta_pck.obter_material_parametro_imp(	current_setting('pls_conv_xml_cta_pck.ie_tipo_material_w')::pls_param_importacao_conta.ie_tipo_material%type, dt_execucao_mat_p,
												cd_material_number_p, cd_versao_tiss_conv_p);
			end if;
		end if;
end case;

-- se n_o identificou nada neste processo usa a identificacao inicial que foi feita no item como verdade

if (coalesce(nr_seq_material_conv_w::text, '') = '') then
	 nr_seq_material_conv_w := nr_seq_material_conv_p;
end if;

return nr_seq_material_conv_w;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pls_conv_xml_cta_pck.obter_seq_material ( cd_tipo_tabela_conv_p pls_conta_item_imp.cd_tipo_tabela_conv%type, cd_material_p pls_conta_item_imp.cd_procedimento%type, cd_material_number_p pls_conta_item_imp.cd_procedimento_conv%type, dt_execucao_mat_p pls_conta_item_imp.dt_execucao%type, ie_tipo_despesa_conv_p pls_conta_item_imp.ie_tipo_despesa_conv%type, ie_tipo_relacao_prest_p pls_conta_item_imp_tmp.ie_tipo_rel_prest_conv%type, nr_seq_material_conv_p pls_material.nr_sequencia%type, cd_versao_tiss_conv_p pls_protocolo_conta_imp.cd_versao_tiss_conv%type) FROM PUBLIC;
