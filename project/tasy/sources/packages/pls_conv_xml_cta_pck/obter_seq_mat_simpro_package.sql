-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pls_conv_xml_cta_pck.obter_seq_mat_simpro ( cd_procedimento_p pls_conta_item_imp.cd_procedimento%type, dt_execucao_mat_p pls_conta_item_imp.dt_execucao%type) RETURNS bigint AS $body$
DECLARE


nr_seq_material_conv_w	pls_material.nr_sequencia%type;
cd_simpro_w		simpro_cadastro.cd_simpro%type;
				

BEGIN
nr_seq_material_conv_w := null;

select  max(cd_simpro)
into STRICT    cd_simpro_w
from    simpro_cadastro
where   cd_simpro = cd_procedimento_p;

-- se achou o c_digo simpro vai atr_s do nr_sequencia da pls_material, primeiro levando em

-- consideracao as datas e situacao depois apenas a situacao e por ultimo sem levar nada em consideracao

if (cd_simpro_w IS NOT NULL AND cd_simpro_w::text <> '') then

	select  max(nr_sequencia)
	into STRICT    nr_seq_material_conv_w
	from    pls_material
	where   cd_simpro = cd_simpro_w
	and	ie_situacao = 'A'
	and	dt_execucao_mat_p between dt_inclusao_ref and dt_fim_vigencia_ref;
	
	if (coalesce(nr_seq_material_conv_w::text, '') = '') then
		
		select  max(nr_sequencia)
		into STRICT    nr_seq_material_conv_w
		from    pls_material
		where   cd_simpro = cd_simpro_w
		and	ie_situacao = 'A';
		
		if (coalesce(nr_seq_material_conv_w::text, '') = '') then
			
			select  max(nr_sequencia)
			into STRICT    nr_seq_material_conv_w
			from    pls_material
			where   cd_simpro      = cd_simpro_w;
		end if;
	end if;
end if;

return	nr_seq_material_conv_w;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pls_conv_xml_cta_pck.obter_seq_mat_simpro ( cd_procedimento_p pls_conta_item_imp.cd_procedimento%type, dt_execucao_mat_p pls_conta_item_imp.dt_execucao%type) FROM PUBLIC;
