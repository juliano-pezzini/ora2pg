-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

-- controle para decidir quando o select para obtencao dos valores dos par_metros deve ser executado novamente



-- vari_veis que armazenam os valores dos par_metros




CREATE OR REPLACE PROCEDURE pls_conv_xml_cta_pck.carrega_parametros ( cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, ie_origem_p text default 'C') AS $body$
BEGIN

-- se a data da _ltima solicitacao n_o estiver registrada ou 

-- se j_ se passou 67 segundos deste a _ltima solicitacao ou

-- se a origem for diferente da _ltima solicitada ou

-- se o estabelecimento anterior for diferente do _ltimo solicitado

-- executa o comando para preencher os valores dos par_metros

if	((current_setting('pls_conv_xml_cta_pck.dt_solicitacao_ult_w')::coalesce(timestamp::text, '') = '') or
	(current_setting('pls_conv_xml_cta_pck.dt_solicitacao_ult_w')::timestamp <= (clock_timestamp() - interval '67 seconds')) or (coalesce(current_setting('pls_conv_xml_cta_pck.ie_origem_ult_w')::varchar(1), 'A') != coalesce(ie_origem_p, 'A')) or (coalesce(current_setting('pls_conv_xml_cta_pck.cd_estabelecimento_ult_w')::estabelecimento.cd_estabelecimento%type, -1) != coalesce(cd_estabelecimento_p, -2))) then
	
	-- par_metro 3 da funcao OPSW - Contas M_dicas

	PERFORM set_config('pls_conv_xml_cta_pck.ie_valida_zero_param_w', pls_obter_param_padrao_funcao(3, 1249), false);
	
	-- se for por guia busca par_metros da pls_param_importacao_guia (autorizacao)

	-- caso contr_rio, busca da pls_param_importacao_conta (conta m_dica)

	if (ie_origem_p = 'G') then
		
		select	coalesce(max(ie_codigo_prest_operadora), 'S'),
			null
		into STRICT	current_setting('pls_conv_xml_cta_pck.ie_utiliza_codigo_param_w')::pls_param_importacao_conta.ie_codigo_prest_operadora%type,
			current_setting('pls_conv_xml_cta_pck.ie_guia_fisica_param_w')::pls_param_importacao_conta.ie_guia_fisica%type
		from	pls_param_importacao_guia;
		
	else
		-- se tiver estabelecimento filtra por estabelecimento

		-- caso contr_rio pega o registro m_ximo da tabela

		if (cd_estabelecimento_p IS NOT NULL AND cd_estabelecimento_p::text <> '') then
		
			select	coalesce(max(ie_codigo_prest_operadora), 'S'),
				coalesce(max(ie_guia_fisica), 'N'),
				coalesce(max(ie_ignora_caracter_cid), 'N'),
				coalesce(max(ie_importacao_material),'N'),
				coalesce(max(ie_tipo_material),'S'),/*(S,H,C,R)(Sequ_ncia do material,Material do hospital,C_digo do material,Conforme regra)*/

				coalesce(max(ie_material_tuss),'A')
			into STRICT	current_setting('pls_conv_xml_cta_pck.ie_utiliza_codigo_param_w')::pls_param_importacao_conta.ie_codigo_prest_operadora%type,
				current_setting('pls_conv_xml_cta_pck.ie_guia_fisica_param_w')::pls_param_importacao_conta.ie_guia_fisica%type,
				current_setting('pls_conv_xml_cta_pck.ie_ignora_caracter_cid_w')::pls_param_importacao_conta.ie_ignora_caracter_cid%type,
				current_setting('pls_conv_xml_cta_pck.ie_importacao_material_w')::pls_param_importacao_conta.ie_importacao_material%type,
				current_setting('pls_conv_xml_cta_pck.ie_tipo_material_w')::pls_param_importacao_conta.ie_tipo_material%type,
				current_setting('pls_conv_xml_cta_pck.ie_material_tuss_w')::pls_param_importacao_conta.ie_material_tuss%type
			from	pls_param_importacao_conta
			where	cd_estabelecimento = cd_estabelecimento_p;
				
			select	coalesce(max(ie_gerar_usuario_eventual),'N'),
				coalesce(max(ie_via_acesso_regra),'N')
			into STRICT	current_setting('pls_conv_xml_cta_pck.ie_gerar_usu_eventual_param_w')::pls_parametros.ie_gerar_usuario_eventual%type,
				current_setting('pls_conv_xml_cta_pck.ie_via_acesso_regra_w')::pls_parametros.ie_via_acesso_regra%type
			from	pls_parametros
			where	cd_estabelecimento = cd_estabelecimento_p;			
			
		else
			select	coalesce(max(ie_codigo_prest_operadora),'S'),
				coalesce(max(ie_guia_fisica),'N'),
				coalesce(max(ie_ignora_caracter_cid), 'N'),
				coalesce(max(ie_importacao_material),'N'),
				coalesce(max(ie_tipo_material),'S'),/*(S,H,C,R)(Sequ_ncia do material,Material do hospital,C_digo do material,Conforme regra)*/

				coalesce(max(ie_material_tuss),'A')
			into STRICT	current_setting('pls_conv_xml_cta_pck.ie_utiliza_codigo_param_w')::pls_param_importacao_conta.ie_codigo_prest_operadora%type,
				current_setting('pls_conv_xml_cta_pck.ie_guia_fisica_param_w')::pls_param_importacao_conta.ie_guia_fisica%type,
				current_setting('pls_conv_xml_cta_pck.ie_ignora_caracter_cid_w')::pls_param_importacao_conta.ie_ignora_caracter_cid%type,
				current_setting('pls_conv_xml_cta_pck.ie_importacao_material_w')::pls_param_importacao_conta.ie_importacao_material%type,
				current_setting('pls_conv_xml_cta_pck.ie_tipo_material_w')::pls_param_importacao_conta.ie_tipo_material%type,
				current_setting('pls_conv_xml_cta_pck.ie_material_tuss_w')::pls_param_importacao_conta.ie_material_tuss%type
			from	pls_param_importacao_conta;
			
			select	coalesce(max(ie_gerar_usuario_eventual),'N')
			into STRICT	current_setting('pls_conv_xml_cta_pck.ie_gerar_usu_eventual_param_w')::pls_parametros.ie_gerar_usuario_eventual%type
			from	pls_parametros;
		end if;
	end if;
	
	select	coalesce(max(ie_prestador),'N')
	into STRICT	current_setting('pls_conv_xml_cta_pck.ie_prestador_w')::pls_controle_estab.ie_prestador%type
	from	pls_controle_estab;
	
	PERFORM set_config('pls_conv_xml_cta_pck.cd_estabelecimento_ult_w', cd_estabelecimento_p, false);
	PERFORM set_config('pls_conv_xml_cta_pck.ie_origem_ult_w', ie_origem_p, false);
	PERFORM set_config('pls_conv_xml_cta_pck.dt_solicitacao_ult_w', clock_timestamp(), false);
end if;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_conv_xml_cta_pck.carrega_parametros ( cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, ie_origem_p text default 'C') FROM PUBLIC;
