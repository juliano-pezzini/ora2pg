-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_conv_xml_cta_pck.pls_desmembrar_tab_item ( nr_seq_protocolo_p pls_protocolo_conta_imp.nr_sequencia%type) AS $body$
DECLARE


tb_nr_seq_conta_w		pls_util_cta_pck.t_number_table;
tb_nr_seq_item_conta_w 		pls_util_cta_pck.t_number_table;
tb_cd_dente_w			pls_util_cta_pck.t_varchar2_table_10;
tb_cd_face_dente_w		pls_util_cta_pck.t_varchar2_table_10;
tb_cd_procedimento_conv_w	pls_util_cta_pck.t_number_table;
tb_cd_regiao_boca_w		pls_util_cta_pck.t_varchar2_table_10;
tb_cd_tipo_tabela_conv_w	pls_util_cta_pck.t_varchar2_table_10;
tb_dt_atualizacao_w		pls_util_cta_pck.t_date_table;
tb_dt_atualizacao_nrec_w	pls_util_cta_pck.t_date_table;
tb_dt_execucao_conv_w		pls_util_cta_pck.t_date_table;
tb_dt_fim_w			pls_util_cta_pck.t_date_table;
tb_dt_inicio_w			pls_util_cta_pck.t_date_table;
tb_ie_autorizado_w		pls_util_cta_pck.t_varchar2_table_10;
tb_ie_origem_proced_conv_w	pls_util_cta_pck.t_number_table;
tb_ie_tecnica_utilizada_conv_w	pls_util_cta_pck.t_varchar2_table_10;
tb_ie_via_acesso_conv_w		pls_util_cta_pck.t_varchar2_table_10;
tb_nm_usuario_w			pls_util_cta_pck.t_varchar2_table_20;
tb_nm_usuario_nrec_w		pls_util_cta_pck.t_varchar2_table_20;
tb_nr_seq_pacote_conv_w		pls_util_cta_pck.t_number_table;
tb_nr_seq_setor_atend_conv_w	pls_util_cta_pck.t_number_table;
tb_qt_executado_w		pls_util_cta_pck.t_number_table;
tb_qt_unidade_serv_w		pls_util_cta_pck.t_number_table;
tb_tx_item_via_acesso_conv_w	pls_util_cta_pck.t_number_table;
tb_vl_proc_copartic_w		pls_util_cta_pck.t_number_table;
tb_vl_total_w			pls_util_cta_pck.t_number_table;
tb_vl_unitario_w		pls_util_cta_pck.t_number_table;

tb_cd_ref_fabricante_w		pls_util_cta_pck.t_varchar2_table_200;
tb_cd_seq_prestador_conv_w	pls_util_cta_pck.t_varchar2_table_200;
tb_cd_unidade_medida_w		pls_util_cta_pck.t_varchar2_table_10;
tb_ie_tipo_despesa_conv_w	pls_util_cta_pck.t_varchar2_table_10;
tb_nr_aut_funcionamento_w	pls_util_cta_pck.t_varchar2_table_50;
tb_nr_registro_anvisa_w		pls_util_cta_pck.t_varchar2_table_20;
tb_nr_seq_fornec_mat_conv_w	pls_util_cta_pck.t_number_table;
tb_nr_seq_material_conv_w	pls_util_cta_pck.t_number_table;
tb_tx_reducao_acrescimo_w	pls_util_cta_pck.t_number_table;
tb_cd_material_conv_w		pls_util_cta_pck.t_number_table;

tb_nr_seq_conta_proc_w 		pls_util_cta_pck.t_number_table;
tb_dt_dia_semana_exec_conv_w	pls_util_cta_pck.t_number_table;
tb_dt_execucao_trunc_conv_w	pls_util_cta_pck.t_date_table;

-- cursor dos procedimentos

C01 CURSOR(	nr_seq_protocolo_pc	pls_protocolo_conta_imp.nr_sequencia%type) FOR
	SELECT	a.nr_sequencia nr_seq_conta,
		b.nr_sequencia nr_seq_item_conta,
		b.cd_dente,
		b.cd_face_dente,
		b.cd_procedimento_conv,
		b.cd_regiao_boca,
		b.cd_tipo_tabela_conv,
		b.dt_atualizacao,
		b.dt_atualizacao_nrec,
		b.dt_execucao_conv,
		b.dt_fim,
		b.dt_inicio,
		b.ie_tipo_despesa_conv,
		b.ie_autorizado,
		b.ie_origem_proced_conv,
		b.ie_tecnica_utilizada_conv,
		CASE WHEN ie_via_acesso_regra_w='N' THEN  CASE WHEN b.ie_via_acesso='1' THEN  'U' WHEN b.ie_via_acesso='2' THEN  'M' WHEN b.ie_via_acesso='3' THEN  'D' END   ELSE null END ,
		b.nm_usuario,
		b.nm_usuario_nrec,
		b.nr_seq_pacote_conv,
		b.nr_seq_setor_atend_conv,
		b.qt_executado,
		b.qt_unidade_serv,
		CASE WHEN b.ie_via_acesso='2' THEN  70 WHEN b.ie_via_acesso='3' THEN  50  ELSE 100 END ,
		b.vl_proc_copartic,
		b.vl_total,
		b.vl_unitario,
		b.dt_dia_semana_exec_conv,
		b.dt_execucao_trunc_conv,
		b.tx_reducao_acrescimo
	from	pls_conta_imp a,
		pls_conta_item_imp b
	where 	a.nr_seq_protocolo = nr_seq_protocolo_pc
	and	b.nr_seq_conta = a.nr_sequencia
	and	b.ie_tipo_item_conv = 'P';

C02 CURSOR(	nr_seq_protocolo_pc	pls_protocolo_conta_imp.nr_sequencia%type) FOR
	SELECT	a.nr_sequencia nr_seq_conta,
		b.nr_sequencia nr_seq_item_conta,
		b.cd_ref_fabricante,
		b.cd_seq_prestador_conv,
		b.cd_tipo_tabela_conv,
		b.cd_unidade_medida,
		b.dt_atualizacao,
		b.dt_atualizacao_nrec,
		b.dt_execucao_conv,
		b.dt_fim,
		b.dt_inicio,
		b.ie_tipo_despesa_conv,
		b.nm_usuario,
		b.nm_usuario_nrec,
		b.nr_aut_funcionamento,
		b.nr_registro_anvisa,
		b.nr_seq_fornec_mat_conv,
		b.nr_seq_material_conv,
		b.nr_seq_setor_atend_conv,
		b.qt_executado,
		b.tx_reducao_acrescimo,
		b.vl_total,
		b.vl_unitario,
		(SELECT	max(x.cd_material)
		from	pls_material x
		where	x.nr_sequencia = b.nr_seq_material_conv) cd_material_conv,
		b.dt_dia_semana_exec_conv,
		b.dt_execucao_trunc_conv
	from	pls_conta_imp a,
		pls_conta_item_imp b
	where 	a.nr_seq_protocolo = nr_seq_protocolo_pc
	and	b.nr_seq_conta = a.nr_sequencia
	and	b.ie_tipo_item_conv = 'M';
	
-- cursor dos procedimentos desmembrados

C03 CURSOR(	nr_seq_protocolo_pc	pls_protocolo_conta_imp.nr_sequencia%type) FOR
	SELECT	b.nr_sequencia nr_seq_item_conta,
		c.nr_sequencia nr_seq_conta_proc
	from	pls_conta_imp a,
		pls_conta_item_imp b,
		pls_conta_proc_imp c
	where 	a.nr_seq_protocolo = nr_seq_protocolo_pc
	and	b.nr_seq_conta = a.nr_sequencia
	and	b.ie_tipo_item_conv = 'P'
	and	c.nr_seq_item_conta = b.nr_sequencia;
	

BEGIN

-- alimenta a tabela de procedimentos

open C01(nr_seq_protocolo_p);
loop
	fetch C01 bulk collect into	tb_nr_seq_conta_w, tb_nr_seq_item_conta_w, tb_cd_dente_w,
					tb_cd_face_dente_w, tb_cd_procedimento_conv_w, tb_cd_regiao_boca_w,
					tb_cd_tipo_tabela_conv_w, tb_dt_atualizacao_w, tb_dt_atualizacao_nrec_w,
					tb_dt_execucao_conv_w, tb_dt_fim_w, tb_dt_inicio_w,
					tb_ie_tipo_despesa_conv_w, tb_ie_autorizado_w, tb_ie_origem_proced_conv_w,
					tb_ie_tecnica_utilizada_conv_w, tb_ie_via_acesso_conv_w, tb_nm_usuario_w, 
					tb_nm_usuario_nrec_w, tb_nr_seq_pacote_conv_w, tb_nr_seq_setor_atend_conv_w, 
					tb_qt_executado_w, tb_qt_unidade_serv_w, tb_tx_item_via_acesso_conv_w,
					tb_vl_proc_copartic_w, tb_vl_total_w, tb_vl_unitario_w,
					tb_dt_dia_semana_exec_conv_w, tb_dt_execucao_trunc_conv_w, tb_tx_reducao_acrescimo_w
	limit pls_util_pck.qt_registro_transacao_w;
	exit when tb_nr_seq_conta_w.count = 0;
	
	forall i in tb_nr_seq_conta_w.first..tb_nr_seq_conta_w.last
		insert into pls_conta_proc_imp(
			nr_sequencia, nr_seq_conta, nr_seq_item_conta,
			cd_dente, cd_face_dente, cd_procedimento_conv, 
			cd_regiao_boca, cd_tipo_tabela_conv, dt_atualizacao, 
			dt_atualizacao_nrec, dt_execucao_conv, dt_fim, 
			dt_inicio, ie_tipo_despesa_conv, ie_autorizado, 
			ie_origem_proced_conv, ie_tecnica_utilizada_conv, ie_via_acesso_conv, 
			nm_usuario, nm_usuario_nrec, nr_seq_pacote_conv, 
			nr_seq_setor_atend_conv, qt_executado, qt_unidade_serv,
			tx_item_via_acesso_conv, vl_proc_copartic, vl_total,
			vl_unitario, dt_dia_semana_exec_conv, dt_execucao_trunc_conv,
			tx_reducao_acrescimo
		) values (
			nextval('pls_conta_proc_imp_seq'), tb_nr_seq_conta_w(i), tb_nr_seq_item_conta_w(i), 
			tb_cd_dente_w(i), tb_cd_face_dente_w(i), tb_cd_procedimento_conv_w(i), 
			tb_cd_regiao_boca_w(i), tb_cd_tipo_tabela_conv_w(i), tb_dt_atualizacao_w(i), 
			tb_dt_atualizacao_nrec_w(i), tb_dt_execucao_conv_w(i), tb_dt_fim_w(i), 
			tb_dt_inicio_w(i), pls_util_pck.elimina_zero_esquerda_char(tb_ie_tipo_despesa_conv_w(i)), tb_ie_autorizado_w(i), 
			tb_ie_origem_proced_conv_w(i), tb_ie_tecnica_utilizada_conv_w(i), tb_ie_via_acesso_conv_w(i),
			tb_nm_usuario_w(i), tb_nm_usuario_nrec_w(i), tb_nr_seq_pacote_conv_w(i), 
			tb_nr_seq_setor_atend_conv_w(i), tb_qt_executado_w(i), tb_qt_unidade_serv_w(i), 
			tb_tx_item_via_acesso_conv_w(i), tb_vl_proc_copartic_w(i), tb_vl_total_w(i), 
			tb_vl_unitario_w(i), tb_dt_dia_semana_exec_conv_w(i),tb_dt_execucao_trunc_conv_w(i),
			tb_tx_reducao_acrescimo_w(i)
		);
	commit;
end loop;
close C01;

-- limpa as tabela que s_o usadas em ambos os cursores por garantia

tb_nr_seq_conta_w.delete;
tb_nr_seq_item_conta_w.delete;
tb_cd_tipo_tabela_conv_w.delete;
tb_dt_atualizacao_w.delete;
tb_dt_atualizacao_nrec_w.delete;
tb_dt_execucao_conv_w.delete;
tb_dt_fim_w.delete;
tb_dt_inicio_w.delete;
tb_ie_tipo_despesa_conv_w.delete;
tb_nm_usuario_w.delete;
tb_nm_usuario_nrec_w.delete;
tb_nr_seq_setor_atend_conv_w.delete;
tb_qt_executado_w.delete;
tb_vl_total_w.delete;
tb_vl_unitario_w.delete;
tb_dt_dia_semana_exec_conv_w.delete;
tb_dt_execucao_trunc_conv_w.delete;

open C02(nr_seq_protocolo_p);
loop

	fetch C02 bulk collect into 	tb_nr_seq_conta_w, tb_nr_seq_item_conta_w, tb_cd_ref_fabricante_w,
					tb_cd_seq_prestador_conv_w, tb_cd_tipo_tabela_conv_w, tb_cd_unidade_medida_w,
					tb_dt_atualizacao_w, tb_dt_atualizacao_nrec_w, tb_dt_execucao_conv_w,
					tb_dt_fim_w, tb_dt_inicio_w, tb_ie_tipo_despesa_conv_w,
					tb_nm_usuario_w, tb_nm_usuario_nrec_w, tb_nr_aut_funcionamento_w,
					tb_nr_registro_anvisa_w, tb_nr_seq_fornec_mat_conv_w, tb_nr_seq_material_conv_w,
					tb_nr_seq_setor_atend_conv_w, tb_qt_executado_w, tb_tx_reducao_acrescimo_w,
					tb_vl_total_w, tb_vl_unitario_w, tb_cd_material_conv_w,
					tb_dt_dia_semana_exec_conv_w, tb_dt_execucao_trunc_conv_w
	limit pls_util_pck.qt_registro_transacao_w;
	exit when tb_nr_seq_conta_w.count = 0;
					
	forall i in tb_nr_seq_conta_w.first..tb_nr_seq_conta_w.last
		insert into pls_conta_mat_imp(
			nr_sequencia, nr_seq_conta, nr_seq_item_conta,
			cd_ref_fabricante, cd_seq_prestador_conv, cd_tipo_tabela_conv, 
			cd_unidade_medida, dt_atualizacao, dt_atualizacao_nrec, 
			dt_execucao_conv, dt_fim, dt_inicio, 
			ie_tipo_despesa_conv, nm_usuario, nm_usuario_nrec, 
			nr_aut_funcionamento, nr_registro_anvisa, nr_seq_fornec_mat_conv, 
			nr_seq_material_conv, nr_seq_setor_atend_conv, qt_executado, 
			tx_reducao_acrescimo, vl_total, vl_unitario, 
			cd_material_conv, dt_dia_semana_exec_conv, dt_execucao_trunc_conv
		) values (
			nextval('pls_conta_mat_imp_seq'), tb_nr_seq_conta_w(i), tb_nr_seq_item_conta_w(i), 
			tb_cd_ref_fabricante_w(i), tb_cd_seq_prestador_conv_w(i), tb_cd_tipo_tabela_conv_w(i), 
			tb_cd_unidade_medida_w(i), tb_dt_atualizacao_w(i), tb_dt_atualizacao_nrec_w(i), 
			tb_dt_execucao_conv_w(i), tb_dt_fim_w(i), tb_dt_inicio_w(i), 
			pls_util_pck.elimina_zero_esquerda_char(tb_ie_tipo_despesa_conv_w(i)), tb_nm_usuario_w(i), tb_nm_usuario_nrec_w(i), 
			tb_nr_aut_funcionamento_w(i), tb_nr_registro_anvisa_w(i), tb_nr_seq_fornec_mat_conv_w(i), 
			tb_nr_seq_material_conv_w(i), tb_nr_seq_setor_atend_conv_w(i), tb_qt_executado_w(i), 
			tb_tx_reducao_acrescimo_w(i), tb_vl_total_w(i), tb_vl_unitario_w(i),
			tb_cd_material_conv_w(i), tb_dt_dia_semana_exec_conv_w(i), tb_dt_execucao_trunc_conv_w(i)
		);
	commit;
end loop;
close C02;

-- limpa as tabela que s_o usadas em ambos os cursores por garantia

tb_nr_seq_item_conta_w.delete;
tb_nr_seq_conta_proc_w.delete;

-- alimenta a tabela de procedimentos desmembrados

open C03(nr_seq_protocolo_p);
loop
	fetch C03 bulk collect into tb_nr_seq_item_conta_w, tb_nr_seq_conta_proc_w
	limit pls_util_pck.qt_registro_transacao_w;
	exit when tb_nr_seq_item_conta_w.count = 0;
	
	forall i in tb_nr_seq_item_conta_w.first..tb_nr_seq_item_conta_w.last
		
		update 	pls_conta_item_equipe_imp set
			nr_seq_conta_proc = tb_nr_seq_conta_proc_w(i)
		where	nr_seq_conta_item = tb_nr_seq_item_conta_w(i);
	commit;
end loop;
close C03;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_conv_xml_cta_pck.pls_desmembrar_tab_item ( nr_seq_protocolo_p pls_protocolo_conta_imp.nr_sequencia%type) FROM PUBLIC;
