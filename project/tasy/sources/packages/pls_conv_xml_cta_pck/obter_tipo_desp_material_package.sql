-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pls_conv_xml_cta_pck.obter_tipo_desp_material ( nr_seq_material_p pls_conta_item_imp.nr_seq_material_conv%type, ie_tipo_despesa_p pls_conta_item_imp.ie_tipo_despesa_conv%type, cd_versao_tiss_conv_p pls_protocolo_conta_imp.cd_versao_tiss_conv%type) RETURNS varchar AS $body$
DECLARE


ie_tipo_despesa_conv_w	pls_material.ie_tipo_despesa%type;
					

BEGIN

-- caso n_o entre nos if retorna o mesmo valor que foi passado

ie_tipo_despesa_conv_w := ie_tipo_despesa_p;

-- se encontrou 

if (nr_seq_material_p IS NOT NULL AND nr_seq_material_p::text <> '') then

	select  max(ie_tipo_despesa)
	into STRICT    ie_tipo_despesa_conv_w
	from    pls_material
	where   nr_sequencia = nr_seq_material_p;
	
-- este tratamento _ feito para quando n_o encontrou o material apenas converter

-- o tipo despesa que veio no XML para o dominio do Tasy

else
	-- se for versao tiss igual ou superior a 3.01 _ necess_rio fazer uma convers_o na informacao

	-- que vem no XML ou nas regras que foram aplicadas para o c_digo do tasy

	if (cd_versao_tiss_conv_p >= '3.01.00') then
		
		-- OPME

		if (ie_tipo_despesa_conv_w = '08') then
			ie_tipo_despesa_conv_w := '7';
		end if;
	end if;
	
	-- se for maior que um o tamanho, busca da _ltima casa para retirar o zero a esquerda

	if (length(ie_tipo_despesa_conv_w) > 1) then
		ie_tipo_despesa_conv_w := substr(ie_tipo_despesa_conv_w, -1);
	end if;
end if;

-- se n_o for um tipo de despesa de material v_lido ou for nulo, fica material

if (ie_tipo_despesa_conv_w not in ('1','2','3','7') or coalesce(ie_tipo_despesa_conv_w::text, '') = '') then
	ie_tipo_despesa_conv_w := '3';
end if;

return	ie_tipo_despesa_conv_w;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pls_conv_xml_cta_pck.obter_tipo_desp_material ( nr_seq_material_p pls_conta_item_imp.nr_seq_material_conv%type, ie_tipo_despesa_p pls_conta_item_imp.ie_tipo_despesa_conv%type, cd_versao_tiss_conv_p pls_protocolo_conta_imp.cd_versao_tiss_conv%type) FROM PUBLIC;
