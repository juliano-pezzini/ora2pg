-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pls_conv_xml_cta_pck.obter_seq_mat_brasindice ( cd_material_p pls_conta_item_imp.cd_procedimento%type, cd_material_number_p pls_conta_item_imp.cd_procedimento_conv%type, dt_execucao_mat_p pls_conta_item_imp.dt_execucao%type) RETURNS bigint AS $body$
DECLARE


nr_seq_material_conv_w	pls_material.nr_sequencia%type;
cd_brasindice_w		brasindice_preco.cd_tiss%type;
					

BEGIN
nr_seq_material_conv_w := null;

select  max(cd_tiss)
into STRICT    cd_brasindice_w
from    brasindice_preco
where   cd_tiss = cd_material_p;

--tratamento realizado Marico Cunha OS 828974, retirados os 0s a esquerda

if (coalesce(cd_brasindice_w::text, '') = '') then

	select  max(cd_tiss)
	into STRICT    cd_brasindice_w
	from    brasindice_preco
	where   (cd_tiss)::numeric  = cd_material_number_p;
end if;

-- se achou o c_digo brasindice vai atr_s do nr_sequencia da pls_material, primeiro levando em

-- consideracao as datas e situacao depois apenas a situacao e por ultimo sem levar nada em consideracao

if (cd_brasindice_w IS NOT NULL AND cd_brasindice_w::text <> '') then
	
	select  max(nr_sequencia)
	into STRICT    nr_seq_material_conv_w
	from    pls_material
	where   cd_tiss_brasindice = cd_brasindice_w
	and	ie_situacao = 'A'
	and	dt_execucao_mat_p between dt_inclusao_ref and dt_fim_vigencia_ref;
	
	if (coalesce(nr_seq_material_conv_w::text, '') = '') then
		
		select  max(nr_sequencia)
		into STRICT    nr_seq_material_conv_w
		from    pls_material
		where   cd_tiss_brasindice = cd_brasindice_w
		and	ie_situacao = 'A';
		
		if (coalesce(nr_seq_material_conv_w::text, '') = '') then
			
			select  max(nr_sequencia)
			into STRICT    nr_seq_material_conv_w
			from    pls_material
			where   cd_tiss_brasindice = cd_brasindice_w;
		end if;
	end if;
end if;

return	nr_seq_material_conv_w;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pls_conv_xml_cta_pck.obter_seq_mat_brasindice ( cd_material_p pls_conta_item_imp.cd_procedimento%type, cd_material_number_p pls_conta_item_imp.cd_procedimento_conv%type, dt_execucao_mat_p pls_conta_item_imp.dt_execucao%type) FROM PUBLIC;
