-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_conv_xml_cta_pck.pls_atualiza_coberturas ( nr_seq_protocolo_p pls_protocolo_conta_imp.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) AS $body$
DECLARE


qt_glosa_w	integer := 0; --apenas para tratar o retorno da pls_consistir_cobertura_proc. N_o ser_ tratado aqui
					
C01 CURSOR FOR
	SELECT	b.nr_sequencia nr_seq_proc,
		b.cd_procedimento_conv,
		b.ie_origem_proced_conv,
		b.dt_execucao_conv,
		a.nr_seq_segurado_conv,
		(	SELECT 	max(y.ie_segmentacao)
			from	pls_segurado x,
				pls_plano y
			where 	x.nr_seq_plano = y.nr_sequencia
			and 	x.nr_sequencia = a.nr_seq_segurado_conv) ie_segmentacao
	from	pls_conta_imp a,
		pls_conta_proc_imp b
	where	a.nr_sequencia = b.nr_seq_conta
	and 	a.nr_seq_protocolo = nr_seq_protocolo_p;
	
C02 CURSOR FOR
	SELECT	b.nr_sequencia nr_seq_conta_mat,
		b.nr_seq_material_conv nr_seq_material,
		a.nr_seq_segurado_conv
	from	pls_conta_imp a,
		pls_conta_mat_imp b
	where	a.nr_sequencia = b.nr_seq_conta
	and 	a.nr_seq_protocolo = nr_seq_protocolo_p;

BEGIN

	for r_c01_w in C01 loop

		pls_consistir_cobertura_proc(	r_c01_w.nr_seq_segurado_conv, null, r_c01_w.nr_seq_proc, null, r_c01_w.cd_procedimento_conv,
						r_c01_w.ie_origem_proced_conv, r_c01_w.dt_execucao_conv, r_c01_w.ie_segmentacao, cd_estabelecimento_p, 
						null, nm_usuario_p, qt_glosa_w, 'I');
	end loop;
	
	for r_c02_w in C02 loop
	
		pls_consistir_cobertura_mat(	r_c02_w.nr_seq_segurado_conv, '', r_c02_w.nr_seq_conta_mat, r_c02_w.nr_seq_material,
						'', cd_estabelecimento_p, 0,nm_usuario_p, 'IA', qt_glosa_w, 'I');
	end loop;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_conv_xml_cta_pck.pls_atualiza_coberturas ( nr_seq_protocolo_p pls_protocolo_conta_imp.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) FROM PUBLIC;
