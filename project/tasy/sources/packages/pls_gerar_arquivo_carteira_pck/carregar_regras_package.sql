-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_gerar_arquivo_carteira_pck.carregar_regras () AS $body$
DECLARE

	pls_atributo_w	pls_atributo_row;
	pls_atr_car_w	pls_atr_car_row;

-- Regra
c01_w CURSOR FOR
	SELECT	a.nr_sequencia,
		a.ds_regra,
		a.cd_estabelecimento,
		a.ie_gerar_cabecalho,
		a.dt_inicio_vigencia,
		a.dt_fim_vigencia,
		a.ie_separador,
		a.nm_arquivo,
		a.ie_padrao_dt_carencia
	from	pls_regra_arq_carteira	a
	where	a.nr_sequencia	= current_setting('pls_gerar_arquivo_carteira_pck.nr_seq_regra_w')::pls_regra_arq_carteira.nr_sequencia%type;

-- Atributo da Regra
c02_w CURSOR FOR
	SELECT	a.nr_sequencia,
		a.nr_seq_regra,
		a.cd_atributo,
		a.ds_cabecalho,
		a.cd_tipo_atributo,
		a.nr_ordem,
		a.vl_padrao,
		a.ds_mascara,
		a.qt_tamanho,
		a.vl_fixo_inicio,
		a.cd_caracter_completar,
		a.ie_posicao_completar,
		a.nr_ordem_resultado,
		a.ie_letras_valor,
		a.ie_somente_sem_carencia,
		coalesce(a.ie_carencias_cumpridas,1),
		(	SELECT	count(*)
			from	pls_regra_arq_cart_cond x
			where	x.nr_seq_regra_atrib = a.nr_sequencia) qt_regra_condicao,
		a.ie_vl_padrao_condicao,
		coalesce(a.ie_exibir_atributo, 'S') ie_exibir_atributo,
		a.ie_remover_acentuacao,
		a.ds_function
	from	pls_regra_arq_cart_atrib	a
	where	a.nr_seq_regra	= current_setting('pls_gerar_arquivo_carteira_pck.nr_seq_regra_w')::pls_regra_arq_carteira.nr_sequencia%type
	order by a.nr_ordem;

-- Atributos da Carencia
c03_w CURSOR FOR
	SELECT	a.nr_sequencia,
		a.nr_seq_regra,
		a.cd_atributo,
		a.qt_tamanho,
		a.vl_padrao,
		a.nr_ordem
	from	pls_regra_arq_caren_atrib	a
	where	a.nr_seq_regra	= current_setting('pls_gerar_arquivo_carteira_pck.nr_seq_regra_w')::pls_regra_arq_carteira.nr_sequencia%type
	order by a.nr_ordem;
BEGIN
	-- Carrega a regra para uma variavel global
	for rc01_w in c01_w loop
		current_setting('pls_gerar_arquivo_carteira_pck.pls_regra_w')::pls_regra_arq_carteira%rowtype.nr_sequencia		:= rc01_w.nr_sequencia;
		current_setting('pls_gerar_arquivo_carteira_pck.pls_regra_w')::pls_regra_arq_carteira%rowtype.ds_regra			:= rc01_w.ds_regra;
		current_setting('pls_gerar_arquivo_carteira_pck.pls_regra_w')::pls_regra_arq_carteira%rowtype.cd_estabelecimento		:= rc01_w.cd_estabelecimento;
		current_setting('pls_gerar_arquivo_carteira_pck.pls_regra_w')::pls_regra_arq_carteira%rowtype.ie_gerar_cabecalho		:= rc01_w.ie_gerar_cabecalho;
		current_setting('pls_gerar_arquivo_carteira_pck.pls_regra_w')::pls_regra_arq_carteira%rowtype.dt_inicio_vigencia		:= rc01_w.dt_inicio_vigencia;
		current_setting('pls_gerar_arquivo_carteira_pck.pls_regra_w')::pls_regra_arq_carteira%rowtype.dt_fim_vigencia		:= rc01_w.dt_fim_vigencia;
		current_setting('pls_gerar_arquivo_carteira_pck.pls_regra_w')::pls_regra_arq_carteira%rowtype.ie_separador		:= rc01_w.ie_separador;
		current_setting('pls_gerar_arquivo_carteira_pck.pls_regra_w')::pls_regra_arq_carteira%rowtype.nm_arquivo			:= rc01_w.nm_arquivo;
		current_setting('pls_gerar_arquivo_carteira_pck.pls_regra_w')::pls_regra_arq_carteira%rowtype.ie_padrao_dt_carencia	:= rc01_w.ie_padrao_dt_carencia;
	end loop;
	
	-- Carrega os atributos da regra em um vetor global
	current_setting('pls_gerar_arquivo_carteira_pck.pls_atributo_t')::pls_atributo_row.delete;
	open c02_w;
	loop
		fetch c02_w bulk collect into pls_atributo_w;
		exit when pls_atributo_w.count = 0;
		PERFORM set_config('pls_gerar_arquivo_carteira_pck.pls_atributo_t', pls_atributo_w, false);
	end loop;
	close c02_w;
	
	if (current_setting('pls_gerar_arquivo_carteira_pck.pls_atributo_t')::pls_atributo_row.count = 0) then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(1066821,'NR_SEQ_REGRA='||current_setting('pls_gerar_arquivo_carteira_pck.nr_seq_regra_w')::pls_regra_arq_carteira.nr_sequencia%type); --Nao foram encontrados atributos configurados na regra de emissao da carteira #@NR_SEQ_REGRA#@
	end if;
	
	-- Carrega o separador de atributos
	PERFORM set_config('pls_gerar_arquivo_carteira_pck.ie_separador_w', null, false);
	if (current_setting('pls_gerar_arquivo_carteira_pck.pls_regra_w')::pls_regra_arq_carteira%rowtype.ie_separador != 'Nenhum') then
		PERFORM set_config('pls_gerar_arquivo_carteira_pck.ie_separador_w', current_setting('pls_gerar_arquivo_carteira_pck.pls_regra_w')::pls_regra_arq_carteira%rowtype.ie_separador, false);
	end if;
	
	-- Carrega os atributos de Carencia em um vetor global
	current_setting('pls_gerar_arquivo_carteira_pck.pls_atr_car_t')::pls_atr_car_row.delete;
	open c03_w;
	loop
		fetch c03_w bulk collect into pls_atr_car_w;
		exit when pls_atr_car_w.count = 0;
		PERFORM set_config('pls_gerar_arquivo_carteira_pck.pls_atr_car_t', pls_atr_car_w, false);
	end loop;
	close c03_w;
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_arquivo_carteira_pck.carregar_regras () FROM PUBLIC;
