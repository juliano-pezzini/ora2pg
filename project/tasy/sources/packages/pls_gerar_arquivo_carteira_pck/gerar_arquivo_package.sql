-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_gerar_arquivo_carteira_pck.gerar_arquivo (nr_seq_lote_p pls_lote_carteira.nr_sequencia%type, nr_seq_regra_p pls_regra_arq_carteira.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE

	nr_seq_regra_geracao_w	pls_lote_carteira.nr_seq_regra_geracao%type;
BEGIN
	PERFORM set_config('pls_gerar_arquivo_carteira_pck.nr_seq_regra_w', nr_seq_regra_p, false);
	
	-- Se nao for informada a regra, finaliza a execucao
	if (current_setting('pls_gerar_arquivo_carteira_pck.nr_seq_regra_w')::pls_regra_arq_carteira.nr_sequencia%coalesce(type::text, '') = '') then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(1066822); --Informe a regra para geracao do arquivo
	end if;
	
	-- Carrega informacoes de regras para gerar as carteiras
	CALL pls_gerar_arquivo_carteira_pck.carregar_regras();
	
	-- Prepara Nome do Arquivo
	select	max(nr_seq_regra_geracao)
	into STRICT	nr_seq_regra_geracao_w
	from	pls_lote_carteira
	where	nr_sequencia = nr_seq_lote_p;
	
	if (current_setting('pls_gerar_arquivo_carteira_pck.pls_regra_w')::pls_regra_arq_carteira%coalesce(rowtype.nm_arquivo::text, '') = '') then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(1107390,'NR_SEQ_REGRA='||current_setting('pls_gerar_arquivo_carteira_pck.nr_seq_regra_w')::pls_regra_arq_carteira.nr_sequencia%type);
	end if;
	
	PERFORM set_config('pls_gerar_arquivo_carteira_pck.nm_arquivo_w', upper(current_setting('pls_gerar_arquivo_carteira_pck.pls_regra_w')::pls_regra_arq_carteira%rowtype.nm_arquivo), false); --Upper necessario para substituir as macros abaixo
	PERFORM set_config('pls_gerar_arquivo_carteira_pck.nm_arquivo_w', replace(current_setting('pls_gerar_arquivo_carteira_pck.nm_arquivo_w')::varchar(255), '@USUARIO', nm_usuario_p), false);
	PERFORM set_config('pls_gerar_arquivo_carteira_pck.nm_arquivo_w', replace(current_setting('pls_gerar_arquivo_carteira_pck.nm_arquivo_w')::varchar(255), '@LOTE', nr_seq_lote_p), false);
	PERFORM set_config('pls_gerar_arquivo_carteira_pck.nm_arquivo_w', replace(current_setting('pls_gerar_arquivo_carteira_pck.nm_arquivo_w')::varchar(255), '@DT_ATUAL_DDMMYYYY', to_char(clock_timestamp(), 'ddmmyyyy')), false);
	PERFORM set_config('pls_gerar_arquivo_carteira_pck.nm_arquivo_w', replace(current_setting('pls_gerar_arquivo_carteira_pck.nm_arquivo_w')::varchar(255), '@DT_ATUAL_MMYYYY', to_char(clock_timestamp(), 'mmyyyy')), false);
	PERFORM set_config('pls_gerar_arquivo_carteira_pck.nm_arquivo_w', replace(current_setting('pls_gerar_arquivo_carteira_pck.nm_arquivo_w')::varchar(255), '@REGRA_GERACAO', nr_seq_regra_geracao_w), false);
	
	-- Cria arquivo para o evento 'Geracao de carteira de identificacao.' da funcao 'OPS - Controle de Carteira de Identificacao (1226)'
	current_setting('pls_gerar_arquivo_carteira_pck.ds_diretorio_w')::varchar(255) := pls_utl_file_pck.novo_arquivo(23, current_setting('pls_gerar_arquivo_carteira_pck.nm_arquivo_w')::varchar(255), 'S', current_setting('pls_gerar_arquivo_carteira_pck.qt_tamanho_max_linha_w')::integer, current_setting('pls_gerar_arquivo_carteira_pck.ds_diretorio_w')::varchar(255));
	
	-- Monta o cabecalho do arquivo
	if (current_setting('pls_gerar_arquivo_carteira_pck.pls_regra_w')::pls_regra_arq_carteira%rowtype.ie_gerar_cabecalho = 'S') then
		PERFORM set_config('pls_gerar_arquivo_carteira_pck.ds_linha_w', '', false);
		for i in current_setting('pls_gerar_arquivo_carteira_pck.pls_atributo_t')::pls_atributo_row.first .. current_setting('pls_gerar_arquivo_carteira_pck.pls_atributo_t')::pls_atributo_row.last loop
			-- Descricao do Cabecalho
			if (current_setting('pls_gerar_arquivo_carteira_pck.ie_separador_w')::coalesce(varchar(10)::text, '') = '') and (current_setting('pls_gerar_arquivo_carteira_pck.pls_atributo_t')::pls_atributo_row[i](.qt_tamanho IS NOT NULL AND .qt_tamanho::text <> '')) then --Se o separador for nulo e tiver tamanho, deve completar com espacos a direita
				PERFORM set_config('pls_gerar_arquivo_carteira_pck.ds_linha_w', current_setting('pls_gerar_arquivo_carteira_pck.ds_linha_w')::varchar(32767) || rpad(current_setting('pls_gerar_arquivo_carteira_pck.pls_atributo_t')::pls_atributo_row[i].ds_cabecalho,current_setting('pls_gerar_arquivo_carteira_pck.pls_atributo_t')::pls_atributo_row[i].qt_tamanho,' '), false);
			else
				PERFORM set_config('pls_gerar_arquivo_carteira_pck.ds_linha_w', current_setting('pls_gerar_arquivo_carteira_pck.ds_linha_w')::varchar(32767) || current_setting('pls_gerar_arquivo_carteira_pck.pls_atributo_t')::pls_atributo_row[i].ds_cabecalho || current_setting('pls_gerar_arquivo_carteira_pck.ie_separador_w')::varchar(10), false);
			end if;
		end loop;
		
		-- Verifica que a linha gerada nao possua mais do que a quantidade de caracteres permitidas
		if (length(current_setting('pls_gerar_arquivo_carteira_pck.ds_linha_w')::varchar(32767)) > current_setting('pls_gerar_arquivo_carteira_pck.qt_tamanho_max_linha_w')::integer-2) then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(1107391,'QT_TAM_LINHA='||length(current_setting('pls_gerar_arquivo_carteira_pck.ds_linha_w')::varchar(32767))||';QT_TAM_MAX_LINHA='||current_setting('pls_gerar_arquivo_carteira_pck.qt_tamanho_max_linha_w')::integer);
		end if;
		
		-- Escreve linha no arquivo
		CALL pls_utl_file_pck.escrever(current_setting('pls_gerar_arquivo_carteira_pck.ds_linha_w')::varchar(32767));
	end if;
	
	-- Carrega informacoes de carteiras a serem geradas
	CALL pls_gerar_arquivo_carteira_pck.carregar_carteiras(nr_seq_lote_p, cd_estabelecimento_p);
	
	-- Fecha arquivo
	CALL pls_utl_file_pck.fechar_arquivo();
	
	-- Atualiza Lote de Carteiras
	update	pls_lote_carteira
	set	dt_emissao_arquivo	= clock_timestamp(),
		nm_usuario		= nm_usuario_p,
		dt_atualizacao		= clock_timestamp()
	where	nr_sequencia		= nr_seq_lote_p;
	
	-- Salva a transacao
	commit;
	
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_arquivo_carteira_pck.gerar_arquivo (nr_seq_lote_p pls_lote_carteira.nr_sequencia%type, nr_seq_regra_p pls_regra_arq_carteira.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;
