-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE gerar_pre_rep_pck.gerar_pre_rep_medic ( nr_atendimento_p bigint, nr_prescricao_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
	cd_material_w		prescr_material.cd_material%type;
	cd_unidade_medida_w	prescr_material.cd_unidade_medida%type;
	ie_via_aplicacao_w		prescr_material.ie_via_aplicacao%type;
	qt_dose_w		prescr_material.qt_dose%type;
	cd_protocolo_w		prescr_material.cd_protocolo%type;
	nr_seq_protocolo_w	prescr_material.nr_seq_protocolo%type;
	ds_diluicao_w		varchar(255);
	ds_item_w		varchar(255);
	ie_tipo_item_w		varchar(10);

	c01 CURSOR FOR 
	SELECT	cd_material, 
		cd_unidade_medida, 
		obter_diluicao_medic(nr_sequencia, nr_prescricao) ds_diluicao, 
		substr(obter_desc_material(cd_material),1,255) ds_item, 
		'MED' ie_tipo_item, 
		ie_via_aplicacao, 
		qt_dose, 
		cd_protocolo, 
		nr_seq_protocolo 
	from	prescr_material 
	where	nr_prescricao	= nr_prescricao_p 
	and	ie_agrupador	= 1;

	
BEGIN 
 
	open c01;
	loop 
	fetch c01 into 
		cd_material_w, 
		cd_unidade_medida_w, 
		ds_diluicao_w, 
		ds_item_w, 
		ie_tipo_item_w, 
		ie_via_aplicacao_w, 
		qt_dose_w, 
		cd_protocolo_w, 
		nr_seq_protocolo_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
 
		insert into w_item_pre_rep( 
			nr_sequencia, 
			cd_item, 
			cd_unidade_medida, 
			ds_diluicao, 
			ds_item, 
			dt_atualizacao, 
			dt_atualizacao_nrec, 
			ie_gerar_prescr, 
			ie_tipo_item, 
			ie_via_aplicacao, 
			nm_usuario, 
			nm_usuario_nrec, 
			qt_item, 
			cd_protocolo, 
			nr_seq_protocolo, 
			nr_seq_mat_protocolo, 
			nr_seq_prot_protocolo, 
			nr_atendimento) 
		values (	nextval('w_item_pre_rep_seq'), 
			cd_material_w, 
			cd_unidade_medida_w, 
			ds_diluicao_w, 
			ds_item_w, 
			clock_timestamp(), 
			clock_timestamp(), 
			'S', 
			ie_tipo_item_w, 
			ie_via_aplicacao_w, 
			nm_usuario_p, 
			nm_usuario_p, 
			qt_dose_w, 
			cd_protocolo_w, 
			nr_seq_protocolo_w, 
			null, 
			null, 
			nr_atendimento_p);
 
	end loop;
	close c01;
 
	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_pre_rep_pck.gerar_pre_rep_medic ( nr_atendimento_p bigint, nr_prescricao_p bigint, nm_usuario_p text) FROM PUBLIC;
