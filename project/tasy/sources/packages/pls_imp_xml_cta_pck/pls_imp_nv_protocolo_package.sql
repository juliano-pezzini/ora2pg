-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_imp_xml_cta_pck.pls_imp_nv_protocolo ( nr_seq_lote_protocolo_p pls_protocolo_conta_imp.nr_seq_lote_protocolo%type, nr_lote_prestador_p pls_protocolo_conta_imp.nr_lote_prestador%type, cd_prestador_p pls_protocolo_conta_imp.cd_prestador%type, cd_cgc_prestador_p pls_protocolo_conta_imp.cd_cgc_prestador%type, cd_cpf_prestador_p pls_protocolo_conta_imp.cd_cpf_prestador%type, dt_transacao_p pls_protocolo_conta_imp.dt_transacao%type, nr_seq_transacao_p pls_protocolo_conta_imp.nr_seq_transacao%type, cd_ans_p pls_protocolo_conta_imp.cd_ans%type, ie_tipo_guia_p pls_protocolo_conta_imp.ie_tipo_guia%type, cd_versao_tiss_p pls_protocolo_conta_imp.cd_versao_tiss%type, nr_seq_prestador_web_p pls_protocolo_conta_imp.nr_seq_prestador_web%type, nr_seq_xml_arquivo_p pls_protocolo_conta_imp.nr_seq_xml_arquivo%type, ds_login_ws_p pls_autenticacao_tiss.nm_usuario_ws%type, ds_senha_ws_p pls_autenticacao_tiss.ds_senha_ws%type, ds_hash_p pls_protocolo_conta_imp.ds_hash%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nr_sequencia_p INOUT pls_protocolo_conta_imp.nr_sequencia%type, nr_seq_prest_logado_p pls_protocolo_conta_imp.nr_seq_prestador_web%type) AS $body$
DECLARE


nr_seq_lote_protocolo_w	pls_protocolo_conta_imp.nr_seq_lote_protocolo%type	:= null;
nr_seq_protocolo_w	pls_protocolo_conta_imp.nr_sequencia%type;


BEGIN

select	nextval('pls_protocolo_conta_imp_seq')
into STRICT	nr_seq_protocolo_w
;

-- insere o protocolo

insert 	into pls_protocolo_conta_imp(
	nr_sequencia, dt_atualizacao, nm_usuario,
	dt_atualizacao_nrec, nm_usuario_nrec, nr_seq_lote_protocolo,
	nr_lote_prestador, cd_prestador, cd_cgc_prestador,
	cd_cpf_prestador, dt_transacao, nr_seq_transacao,
	cd_ans, ie_tipo_guia, cd_versao_tiss,
	nr_seq_prestador_web, nr_seq_xml_arquivo, ds_hash,
	cd_estabelecimento, ie_situacao, ie_tipo_importacao
) values (
	nr_seq_protocolo_w, clock_timestamp(), nm_usuario_p,
	clock_timestamp(), nm_usuario_p, nr_seq_lote_protocolo_p,
	nr_lote_prestador_p, cd_prestador_p, cd_cgc_prestador_p,
	cd_cpf_prestador_p, dt_transacao_p, nr_seq_transacao_p,
	cd_ans_p, ie_tipo_guia_p, cd_versao_tiss_p,
	nr_seq_prestador_web_p, nr_seq_xml_arquivo_p, ds_hash_p,
	cd_estabelecimento_p, 'I', CASE WHEN nm_usuario_p='WebService' THEN  'WE'  ELSE 'UP' END 
) returning nr_sequencia into nr_sequencia_p;
	
-- se foi enviado login e senha grava na tabela de controle	

if ((ds_login_ws_p IS NOT NULL AND ds_login_ws_p::text <> '') or (ds_senha_ws_p IS NOT NULL AND ds_senha_ws_p::text <> '')) then
	insert	into pls_autenticacao_tiss(
		nr_sequencia, dt_atualizacao, nm_usuario,
		dt_atualizacao_nrec, nm_usuario_nrec, nm_usuario_ws,
		ds_senha_ws, nr_seq_protocolo_imp
	) values (
		nextval('pls_autenticacao_tiss_seq'), clock_timestamp(), nm_usuario_p,
		clock_timestamp(), nm_usuario_p, ds_login_ws_p,
		ds_senha_ws_p, nr_sequencia_p);
end if;

--Criada esta verificacao para a geracao do Lote de Protocolos. Sem o lote de protocolos nenhuma informacao e apresentada em tela.

if (nm_usuario_p = 'WebService') then
	pls_gerar_lote_analise(null, null, nm_usuario_p,cd_estabelecimento_p, null, nr_seq_lote_protocolo_w);
	CALL pls_imp_xml_cta_pck.pls_vinc_prot_lote_conta_imp(nr_seq_lote_protocolo_w,nr_seq_protocolo_w,nm_usuario_p);
else
	if (coalesce(nr_seq_lote_protocolo_p::text, '') = '') then
		pls_obter_lote_aberto_web(	nr_seq_prest_logado_p,
						cd_estabelecimento_p,
						nr_seq_prestador_web_p,
						nm_usuario_p,
						nr_lote_prestador_p,
						'N',
						nr_seq_lote_protocolo_w);
	CALL pls_imp_xml_cta_pck.pls_vinc_prot_lote_conta_imp(nr_seq_lote_protocolo_w,nr_seq_protocolo_w,nm_usuario_p);					
	end if;
end if;
commit;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_imp_xml_cta_pck.pls_imp_nv_protocolo ( nr_seq_lote_protocolo_p pls_protocolo_conta_imp.nr_seq_lote_protocolo%type, nr_lote_prestador_p pls_protocolo_conta_imp.nr_lote_prestador%type, cd_prestador_p pls_protocolo_conta_imp.cd_prestador%type, cd_cgc_prestador_p pls_protocolo_conta_imp.cd_cgc_prestador%type, cd_cpf_prestador_p pls_protocolo_conta_imp.cd_cpf_prestador%type, dt_transacao_p pls_protocolo_conta_imp.dt_transacao%type, nr_seq_transacao_p pls_protocolo_conta_imp.nr_seq_transacao%type, cd_ans_p pls_protocolo_conta_imp.cd_ans%type, ie_tipo_guia_p pls_protocolo_conta_imp.ie_tipo_guia%type, cd_versao_tiss_p pls_protocolo_conta_imp.cd_versao_tiss%type, nr_seq_prestador_web_p pls_protocolo_conta_imp.nr_seq_prestador_web%type, nr_seq_xml_arquivo_p pls_protocolo_conta_imp.nr_seq_xml_arquivo%type, ds_login_ws_p pls_autenticacao_tiss.nm_usuario_ws%type, ds_senha_ws_p pls_autenticacao_tiss.ds_senha_ws%type, ds_hash_p pls_protocolo_conta_imp.ds_hash%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nr_sequencia_p INOUT pls_protocolo_conta_imp.nr_sequencia%type, nr_seq_prest_logado_p pls_protocolo_conta_imp.nr_seq_prestador_web%type) FROM PUBLIC;
