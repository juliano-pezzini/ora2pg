-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE ctb_regras_contabil.ctb_gerar_cd_controle_banco ( nr_lote_contabil_p LOTE_CONTABIL.NR_LOTE_CONTABIL%type, nm_usuario_p text ) AS $body$
DECLARE


    cd_tipo_lote_contabil_w     LOTE_CONTABIL.CD_TIPO_LOTE_CONTABIL%type;
    cd_regra_w                  REGRAS_TIPO_LOTE_CONTABIL.CD_REGRA%type;
    ds_prefixo_w                REGRAS_TIPO_LOTE_CONTABIL.DS_PREFIXO%type;

    nr_tipo_movimento_w         smallint;
    nr_tipo_transacao_w         smallint;
    nr_fonte_transferencia_w    smallint;
    nr_comprovante_w            varchar(255);
    arr_data_w                  arr_regra_prefix_t;

    c010 CURSOR FOR
        SELECT  NR_SEQUENCIA,
                NR_SEQ_PARC_CARTAO,
                NR_SEQ_TITULO_PAGAR,
                NR_SEQ_TITULO_RECEBER,
                NR_LOTE_CONTABIL,
		NR_CODIGO_CONTROLE
        FROM    MOVTO_TRANS_FINANC
        WHERE   NR_LOTE_CONTABIL = nr_lote_contabil_p;


BEGIN
        IF nr_lote_contabil_p > 0 THEN
	    CALL ctb_regras_contabil.restore_comprovante_from_cache(nr_lote_contabil_p, nm_usuario_p);

            SELECT  MAX(CD_TIPO_LOTE_CONTABIL)
            INTO STRICT    cd_tipo_lote_contabil_w
            FROM    LOTE_CONTABIL
            WHERE   NR_LOTE_CONTABIL = nr_lote_contabil_p;

            FOR operacao IN c010 LOOP
		IF (coalesce(operacao.nr_codigo_controle::text, '') = '') THEN
			SELECT  MAX(NR_TIPO_MOVIMENTO)
			INTO STRICT    nr_tipo_movimento_w
			FROM (
			    SELECT (CASE WHEN A.IE_BANCO = 'C' THEN 3 WHEN A.IE_BANCO = 'D' THEN 4 END) NR_TIPO_MOVIMENTO
			    FROM    TRANSACAO_FINANCEIRA a,
				    MOVTO_TRANS_FINANC b
			    WHERE   a.NR_SEQUENCIA = b.NR_SEQ_TRANS_FINANC
			    AND     b.NR_SEQUENCIA = operacao.nr_sequencia
			) alias4;

			SELECT  MAX(NR_TIPO_TRANSACAO)
			INTO STRICT    nr_tipo_transacao_w
			FROM    (
			    SELECT  a.NR_SEQUENCIA NR_SEQUENCIA,
				    a.NR_LOTE_CONTABIL NR_LOTE_CONTABIL,
				    (CASE WHEN a.NR_SEQ_DEPOSITO > 0 THEN 1 WHEN a.NR_SEQ_CHEQUE > 0 OR a.NR_SEQ_CHEQUE_CP > 0 THEN 2 END) NR_TIPO_TRANSACAO
			    FROM    MOVTO_TRANS_FINANC a
			    WHERE   (a.NR_LOTE_CONTABIL IS NOT NULL AND a.NR_LOTE_CONTABIL::text <> '')
			    AND     a.NR_LOTE_CONTABIL > 0
			
UNION ALL

			    SELECT  c.NR_SEQUENCIA NR_SEQUENCIA,
				    b.NR_LOTE_CONTABIL NR_LOTE_CONTABIL,
				    (CASE WHEN b.NR_SEQ_TERCEIRO > 0 THEN 3 END) NR_TIPO_TRANSACAO
			    FROM    REPASSE_TERCEIRO b,
				    MOVTO_TRANS_FINANC c
			    WHERE   b.NR_LOTE_CONTABIL = c.NR_LOTE_CONTABIL
			    AND     b.NR_LOTE_CONTABIL > 0
			    AND     (b.NR_LOTE_CONTABIL IS NOT NULL AND b.NR_LOTE_CONTABIL::text <> '')
			) alias5
			WHERE    (NR_TIPO_TRANSACAO IS NOT NULL AND NR_TIPO_TRANSACAO::text <> '')
			AND      NR_LOTE_CONTABIL = nr_lote_contabil_p
			GROUP BY NR_LOTE_CONTABIL,
				 NR_TIPO_TRANSACAO
			ORDER BY NR_LOTE_CONTABIL;

			SELECT  MAX(NR_FONTE_TRANSFERENCIA)
			INTO STRICT    nr_fonte_transferencia_w
			FROM (
			    SELECT (CASE WHEN (b.NR_SEQ_CAIXA IS NOT NULL AND b.NR_SEQ_CAIXA::text <> '') THEN 1 WHEN (b.NR_SEQ_BANCO IS NOT NULL AND b.NR_SEQ_BANCO::text <> '') THEN 2 END) NR_FONTE_TRANSFERENCIA
			    FROM    TRANSACAO_FINANCEIRA a,
				    MOVTO_TRANS_FINANC b
			    WHERE   a.NR_SEQUENCIA      = b.NR_SEQ_TRANS_FINANC
			    AND     b.NR_SEQUENCIA      = operacao.nr_sequencia
			) alias4;

			arr_data_w := ctb_regras_contabil.obter_prefix_regra_rest(
			    cd_tipo_lote_contabil_w,
			    nr_tipo_movimento_w || ',' || nr_tipo_transacao_w || ',' || nr_fonte_transferencia_w
			);

			IF ((arr_data_w(1) IS NOT NULL AND (arr_data_w(1))::text <> '')) THEN
			    cd_regra_w          := arr_data_w(1);
			    ds_prefixo_w        := arr_data_w(2);
			
			    IF (coalesce(operacao.nr_codigo_controle::text, '') = '' AND (ds_prefixo_w IS NOT NULL AND ds_prefixo_w::text <> '')) THEN
				nr_comprovante_w	:= ctb_regras_contabil.gerar_seq_comprovante(ds_prefixo_w, nm_usuario_p);
			    ELSE
				nr_comprovante_w	:= operacao.nr_codigo_controle;
			    END IF;

			    UPDATE  W_MOVIMENTO_CONTABIL
			    SET	    NR_CODIGO_CONTROLE 	= nr_comprovante_w
			    WHERE   NR_LOTE_CONTABIL 	= nr_lote_contabil_p
			    AND     ((NM_TABELA		= 'MOVTO_TRANS_FINANC' 		AND NR_SEQ_TAB_ORIG = operacao.nr_sequencia)
			    OR (NM_TABELA		= 'MOVTO_CARTAO_CR_PARCELA'	AND NR_SEQ_TAB_ORIG = operacao.nr_seq_parc_cartao)
			    OR (NM_TABELA		= 'TITULO_PAGAR_BAIXA'		AND NR_SEQ_TAB_ORIG = operacao.nr_seq_titulo_pagar)
			    OR (NM_TABELA		= 'TITULO_PAGAR_IMPOSTO'	AND NR_SEQ_TAB_ORIG = operacao.nr_seq_titulo_pagar)
			    OR (NM_TABELA		= 'TITULO_PAGAR_TRIB_BAIXA'	AND NR_SEQ_TAB_ORIG = operacao.nr_seq_titulo_pagar)
			    OR (NM_TABELA		= 'TITULO_RECEBER_LIQ'		AND NR_SEQ_TAB_ORIG = operacao.nr_seq_titulo_receber)
			    OR (NM_TABELA		= 'PLS_TITULO_REC_LIQ_MENS'	AND NR_SEQ_TAB_ORIG = operacao.nr_seq_titulo_receber));

			    UPDATE  MOVTO_TRANS_FINANC
			    SET     NR_CODIGO_CONTROLE 	= nr_comprovante_w
			    WHERE   NR_SEQUENCIA 	= operacao.nr_sequencia
			    AND     coalesce(NR_CODIGO_CONTROLE::text, '') = '';

			    UPDATE  MOVTO_CARTAO_CR_PARCELA
			    SET     NR_CODIGO_CONTROLE 	= nr_comprovante_w
			    WHERE   NR_SEQUENCIA 	= operacao.nr_seq_parc_cartao
			    AND     coalesce(NR_CODIGO_CONTROLE::text, '') = '';

			    UPDATE  TITULO_PAGAR_BAIXA
			    SET     NR_CODIGO_CONTROLE 	= nr_comprovante_w
			    WHERE   NR_TITULO 		= operacao.nr_seq_titulo_pagar
			    AND     coalesce(NR_CODIGO_CONTROLE::text, '') = '';

			    UPDATE  TITULO_PAGAR_IMPOSTO
			    SET     NR_CODIGO_CONTROLE 	= nr_comprovante_w
			    WHERE   NR_TITULO 		= operacao.nr_seq_titulo_pagar
			    AND     coalesce(NR_CODIGO_CONTROLE::text, '') = '';

			    UPDATE  TITULO_PAGAR_TRIB_BAIXA
			    SET     NR_CODIGO_CONTROLE 	= nr_comprovante_w
			    WHERE   NR_TITULO 		= operacao.nr_seq_titulo_pagar
			    AND     coalesce(NR_CODIGO_CONTROLE::text, '') = ''
			    AND     NR_SEQ_TIT_BAIXA 	= (
				SELECT  MAX(NR_SEQUENCIA)
				FROM    TITULO_PAGAR_BAIXA
				WHERE   NR_TITULO 	= operacao.nr_seq_titulo_pagar
			    );

			    UPDATE  TITULO_RECEBER_LIQ
			    SET     NR_CODIGO_CONTROLE 	= nr_comprovante_w
			    WHERE   NR_TITULO 		= operacao.nr_seq_titulo_receber
			    AND     coalesce(NR_CODIGO_CONTROLE::text, '') = '';

			    UPDATE  PLS_TITULO_REC_LIQ_MENS
			    SET NR_CODIGO_CONTROLE 	= nr_comprovante_w
			    WHERE   NR_TITULO 		= operacao.nr_seq_titulo_receber
			    AND     coalesce(NR_CODIGO_CONTROLE::text, '') = ''
			    AND     NR_SEQ_BAIXA 	= (
				SELECT  MAX(NR_SEQUENCIA)
				FROM    TITULO_RECEBER_LIQ 
				WHERE   NR_TITULO = operacao.nr_seq_titulo_receber
			    );
			END IF;
		END IF;
            END LOOP;
            COMMIT;
        END IF;

    END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ctb_regras_contabil.ctb_gerar_cd_controle_banco ( nr_lote_contabil_p LOTE_CONTABIL.NR_LOTE_CONTABIL%type, nm_usuario_p text ) FROM PUBLIC;
