-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION ctb_regras_contabil.ctb_obter_regra_mais_retr ( cd_tipo_lote_contabil_p REGRAS_TIPO_LOTE_CONTABIL.CD_TIPO_LOTE_CONTABIL%type, vl_operacao_p text ) RETURNS varchar AS $body$
DECLARE


    c010                	REFCURSOR;
    cd_regra_w          	REGRAS_TIPO_LOTE_CONTABIL.CD_REGRA%type;
    ds_prefixo_w        	REGRAS_TIPO_LOTE_CONTABIL.DS_PREFIXO%type;
    cd_regra_ww         	REGRAS_TIPO_LOTE_CONTABIL.CD_REGRA%type;
    ds_prefixo_ww       	REGRAS_TIPO_LOTE_CONTABIL.DS_PREFIXO%type;
    ds_variavel_w       	varchar(50);
    ds_comando_vingencia_w 	varchar(255);
    ds_comando_w        	varchar(4000);
    ds_comando_base_w   	varchar(4000)   := '';
    qt_restricoes_w     	bigint      := 0;
    qt_restricoes_ww    	bigint      := 0;


BEGIN

        ds_comando_w := 'SELECT MAX(DS_VALOR) FROM ( ' || 
            ctb_regras_contabil.split_regra_contabil('SELECT CTB_REGRAS_CONTABIL.CTB_OBTER_REGRAS_TMPLT(' || cd_tipo_lote_contabil_p || 
            ',''' || vl_operacao_p || ''') FL FROM DUAL', 'FL' , ',') ||
            ' ) WHERE DS_VALOR LIKE ''%_%''';
        EXECUTE ds_comando_w INTO STRICT ds_variavel_w;

	ds_comando_vingencia_w 	:=	' AND   ((DT_INICIO_VIGENCIA IS NULL AND DT_FIM_VIGENCIA IS NULL)' ||
					' OR    ((DT_INICIO_VIGENCIA <= SYSDATE OR DT_INICIO_VIGENCIA IS NULL)' ||
					' AND   (DT_FIM_VIGENCIA >= SYSDATE OR DT_FIM_VIGENCIA IS NULL)))';
	
        ds_comando_base_w := 'SELECT  DS_PREFIXO, CD_REGRA' ||
            ' FROM  REGRAS_TIPO_LOTE_CONTABIL' ||
            ' WHERE CD_TIPO_LOTE_CONTABIL = ' || cd_tipo_lote_contabil_p ||
	    ds_comando_vingencia_w ||
            ' AND   CD_REGRA IN (' || ctb_regras_contabil.split_regra_contabil('SELECT CTB_REGRAS_CONTABIL.CTB_OBTER_REGRAS_TMPLT(' || cd_tipo_lote_contabil_p || 
            ',''' || vl_operacao_p || ''') VL FROM DUAL', 'VL', ',') || 
            ' ) OR (CD_REGRA LIKE :ds_variavel_w ' ||
	    ds_comando_vingencia_w || ')';

        OPEN c010 FOR EXECUTE ds_comando_base_w USING ds_variavel_w;
            LOOP
                FETCH c010 INTO ds_prefixo_w, cd_regra_w;
                EXIT WHEN NOT FOUND; /* apply on c010 */

                ds_comando_w := 'SELECT COUNT(DS_VALOR) FROM ( ' ||
                    ctb_regras_contabil.split_regra_contabil('SELECT CD_REGRA VL FROM REGRAS_TIPO_LOTE_CONTABIL WHERE CD_TIPO_LOTE_CONTABIL = ' || 
                    cd_tipo_lote_contabil_p || ' AND CD_REGRA = ''' || 
                    cd_regra_w || '''', 'VL', '-') || ')';

                EXECUTE ds_comando_w INTO STRICT qt_restricoes_ww;

                IF qt_restricoes_ww >= qt_restricoes_w THEN
                    qt_restricoes_w  := qt_restricoes_ww;
                    cd_regra_ww      := cd_regra_w;
                    ds_prefixo_ww    := ds_prefixo_w;
                END IF;

            END LOOP;
        CLOSE c010;

        IF (cd_regra_w IS NOT NULL AND cd_regra_w::text <> '') THEN
            RETURN cd_regra_ww || ',' || ds_prefixo_ww;
        END IF;

        RETURN '';

    END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION ctb_regras_contabil.ctb_obter_regra_mais_retr ( cd_tipo_lote_contabil_p REGRAS_TIPO_LOTE_CONTABIL.CD_TIPO_LOTE_CONTABIL%type, vl_operacao_p text ) FROM PUBLIC;
