-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION ctb_regras_contabil.gerar_seq_comprovante ( ds_prefixo_p GERAR_CD_COMPROV_CONTABIL.DS_PREFIXO%type, nm_usuario_p text ) RETURNS varchar AS $body$
DECLARE


        dt_atualizacao_w        timestamp;
        ds_seq_comprovante_w    varchar(30);
        nr_mes_w                GERAR_CD_COMPROV_CONTABIL.NR_MES%type;
        nr_sequencia_mes_w      GERAR_CD_COMPROV_CONTABIL.NR_SEQUENCIA_MES%type;


BEGIN

        dt_atualizacao_w    := clock_timestamp();
        nr_mes_w            := EXTRACT(MONTH FROM clock_timestamp());

        SELECT  coalesce(MAX(NR_SEQUENCIA_MES),0) + 1
        INTO STRICT    nr_sequencia_mes_w
        FROM    GERAR_CD_COMPROV_CONTABIL
        WHERE   DS_PREFIXO = ds_prefixo_p
        AND     NR_MES = nr_mes_w;

        INSERT INTO GERAR_CD_COMPROV_CONTABIL(
            NR_SEQUENCIA,
            NR_MES,
            NR_SEQUENCIA_MES,
            DS_PREFIXO,
            NM_USUARIO,
            DT_ATUALIZACAO,
            DT_ATUALIZACAO_NREC
        ) VALUES (
            nextval('gerar_cd_comprov_contabil_seq'),
            nr_mes_w,
            nr_sequencia_mes_w,
            ds_prefixo_p,
            nm_usuario_p,
            dt_atualizacao_w,
            dt_atualizacao_w
        );

        COMMIT;

        ds_seq_comprovante_w := ds_prefixo_p || nr_mes_w || '-' || nr_sequencia_mes_w;
        RETURN ds_seq_comprovante_w;

    END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION ctb_regras_contabil.gerar_seq_comprovante ( ds_prefixo_p GERAR_CD_COMPROV_CONTABIL.DS_PREFIXO%type, nm_usuario_p text ) FROM PUBLIC;
