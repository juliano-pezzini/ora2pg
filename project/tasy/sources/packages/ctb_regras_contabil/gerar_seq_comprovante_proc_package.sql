-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE ctb_regras_contabil.gerar_seq_comprovante_proc ( ds_prefixo_p gerar_cd_comprov_contabil.ds_prefixo%type, nm_usuario_p gerar_cd_comprov_contabil.nm_usuario%type, cd_comprov_contab_p INOUT text ) AS $body$
DECLARE


        dt_atualizacao_w        gerar_cd_comprov_contabil.dt_atualizacao%type;
        nr_mes_w                gerar_cd_comprov_contabil.nr_mes%type;
        nr_sequencia_mes_w      gerar_cd_comprov_contabil.nr_sequencia_mes%type;

    
BEGIN
        
        dt_atualizacao_w    := clock_timestamp();
        nr_mes_w            := EXTRACT(MONTH FROM clock_timestamp());

        SELECT  coalesce(MAX(nr_sequencia_mes),0) + 1
        INTO STRICT    nr_sequencia_mes_w
        FROM    gerar_cd_comprov_contabil 
        WHERE   ds_prefixo = ds_prefixo_p
        AND     nr_mes = nr_mes_w;

        INSERT INTO gerar_cd_comprov_contabil( 
            nr_sequencia,
            nr_mes,
            nr_sequencia_mes,
            ds_prefixo,
            nm_usuario,
            dt_atualizacao,
            dt_atualizacao_nrec 
        ) VALUES (
            nextval('gerar_cd_comprov_contabil_seq'),
            nr_mes_w,
            nr_sequencia_mes_w,
            ds_prefixo_p,
            nm_usuario_p,
            dt_atualizacao_w,
            dt_atualizacao_w
        );

        COMMIT;
        cd_comprov_contab_p := ds_prefixo_p || nr_mes_w || '-' || nr_sequencia_mes_w;

    END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ctb_regras_contabil.gerar_seq_comprovante_proc ( ds_prefixo_p gerar_cd_comprov_contabil.ds_prefixo%type, nm_usuario_p gerar_cd_comprov_contabil.nm_usuario%type, cd_comprov_contab_p INOUT text ) FROM PUBLIC;
