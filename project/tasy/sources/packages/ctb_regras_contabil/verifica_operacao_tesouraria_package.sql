-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION ctb_regras_contabil.verifica_operacao_tesouraria ( cd_tipo_lote_contabil_p bigint, nr_sequencia_p MOVTO_TRANS_FINANC.NR_SEQUENCIA%type ) RETURNS varchar AS $body$
DECLARE


    payment_in_cash_w       double precision;
    payment_in_check_w      double precision;
    payment_in_card_w       double precision;

    ie_tipo_transacao_w     varchar(3);
    ie_tipo_pagamento_w     varchar(3);


BEGIN
	BEGIN
		SELECT	OBTER_VALORES_CAIXA_REC(NR_SEQ_CAIXA_REC, 'VE'),
			OBTER_VALORES_CAIXA_REC(NR_SEQ_CAIXA_REC, 'VCH'),
			OBTER_VALORES_CAIXA_REC(NR_SEQ_CAIXA_REC, 'VCA')
		INTO STRICT    payment_in_cash_w,
		        payment_in_check_w,
		        payment_in_card_w
		FROM   MOVTO_TRANS_FINANC
		WHERE  NR_SEQUENCIA = nr_sequencia_p
		AND    (NR_SEQ_CAIXA_REC IS NOT NULL AND NR_SEQ_CAIXA_REC::text <> '')
		AND    coalesce(NR_SEQ_CAIXA_OD::text, '') = '';

		IF (nr_sequencia_p IS NOT NULL AND nr_sequencia_p::text <> '') THEN
			ie_tipo_transacao_w	:= 1;
		ELSE
			ie_tipo_transacao_w     := 2;
		END IF;

		IF (payment_in_cash_w IS NOT NULL AND payment_in_cash_w::text <> '') THEN
			ie_tipo_pagamento_w	:= 1;
		ELSIF (payment_in_check_w IS NOT NULL AND payment_in_check_w::text <> '') THEN
			ie_tipo_pagamento_w	:= 2;
		ELSIF (payment_in_card_w IS NOT NULL AND payment_in_card_w::text <> '') THEN
			ie_tipo_pagamento_w	:= 3;
		END IF;

		IF ((ie_tipo_transacao_w IS NOT NULL AND ie_tipo_transacao_w::text <> '') OR (ie_tipo_pagamento_w IS NOT NULL AND ie_tipo_pagamento_w::text <> '')) THEN
			RETURN ie_tipo_transacao_w || ',' || ie_tipo_pagamento_w;
		END IF;

		RETURN '';
	EXCEPTION
		WHEN OTHERS THEN NULL;
	END;
	RETURN '';
    END;


$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION ctb_regras_contabil.verifica_operacao_tesouraria ( cd_tipo_lote_contabil_p bigint, nr_sequencia_p MOVTO_TRANS_FINANC.NR_SEQUENCIA%type ) FROM PUBLIC;
