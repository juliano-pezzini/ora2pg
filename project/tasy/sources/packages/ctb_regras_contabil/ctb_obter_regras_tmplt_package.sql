-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


CREATE TYPE rc_valores AS (ds_valor varchar(4000));


CREATE OR REPLACE FUNCTION ctb_regras_contabil.ctb_obter_regras_tmplt ( cd_tipo_lote_contabil_p TEMPLATE_REGRA_LT_CONTABIL.CD_TIPO_LOTE_CONTABIL%type, vl_controles_p text ) RETURNS varchar AS $body$
DECLARE


    qt_template_w       bigint      := 0;
    qt_count_w          bigint      := 0;
    qt_count_ww         bigint      := 0;
    ds_resultado_w      varchar(4000)  := '';
    TYPE tb_valores     IS TABLE OF     rc_valores;
    tb_valores_w        tb_valores;

    TYPE tb_resultados  IS TABLE OF     varchar(255) INDEX BY integer not NULL;
    tb_resultados_w     tb_resultados;


BEGIN

        SELECT  COUNT(1)
        INTO STRICT    qt_template_w
        FROM    TEMPLATE_REGRA_LT_CONTABIL
        WHERE   CD_TIPO_LOTE_CONTABIL = cd_tipo_lote_contabil_p;

        EXECUTE ctb_regras_contabil.split_regra_contabil('SELECT (''' || vl_controles_p || ',' || ''') VL FROM DUAL', 'VL', ',')
        BULK COLLECT INTO STRICT tb_valores_w;

        FOR a IN 1..qt_template_w LOOP
            tb_resultados_w(a) := TO_CHAR(cd_tipo_lote_contabil_p);

            FOR b IN 1..qt_template_w LOOP
                IF tb_resultados_w.last >= b AND tb_valores_w.last >= b THEN
                    tb_resultados_w(a) := tb_resultados_w(a) || '-' || tb_valores_w[b].ds_valor;
                ELSE
                    tb_resultados_w(a) := tb_resultados_w(a) || '-';
                END IF;
            END LOOP;

            ds_resultado_w := ds_resultado_w || ',' || tb_resultados_w(a);
        END LOOP;

        IF tb_resultados_w.count > 0 THEN
            ds_resultado_w := ds_resultado_w || ',' || tb_resultados_w(tb_resultados_w.last) || '%';

            FOR a IN 1..tb_valores_w.last LOOP
                IF  qt_count_w = 0 THEN
                    qt_count_w := 3;
                END IF;

                FOR b IN 1..qt_template_w LOOP
                    qt_count_ww := (REGEXP_SUBSTR(ctb_regras_contabil.index_of(tb_resultados_w(b), '-', tb_valores_w[a].ds_valor, qt_count_w), '[^,]+', 1, 1))::numeric;

                    IF (qt_count_ww IS NOT NULL AND qt_count_ww::text <> '') THEN
                        ds_resultado_w := ds_resultado_w || ',' || ctb_regras_contabil.replace_first(tb_resultados_w(b), '', qt_count_ww, LENGTH(tb_valores_w[a].ds_valor));
                    END IF;
                END LOOP;

                qt_count_w := qt_count_w + 2;
            END LOOP;

            ds_resultado_w := ds_resultado_w || ',' || tb_resultados_w(tb_resultados_w.last);
            RETURN SUBSTR(ds_resultado_w, 2, LENGTH(ds_resultado_w));
        END IF;

        RETURN TO_CHAR(cd_tipo_lote_contabil_p) || '%';

    END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION ctb_regras_contabil.ctb_obter_regras_tmplt ( cd_tipo_lote_contabil_p TEMPLATE_REGRA_LT_CONTABIL.CD_TIPO_LOTE_CONTABIL%type, vl_controles_p text ) FROM PUBLIC;
