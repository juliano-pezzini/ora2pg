-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

-- Responsáel por obter os dados do prestador contratado
CREATE OR REPLACE FUNCTION pls_gerar_pre_estab_ans_pck.obter_dados_prestador ( nr_seq_prestador_p pls_prestador.nr_sequencia%type) RETURNS DADOS_PRESTADOR AS $body$
DECLARE


dados_prestador_w		dados_prestador;
cd_cgc_w			pessoa_juridica.cd_cgc%type;
cd_pessoa_fisica_w		pessoa_fisica.cd_pessoa_fisica%type;


BEGIN
-- Busca o CNES do cadastro
dados_prestador_w.cd_cnes := substr(trim(both pls_obter_cnes_prestador(nr_seq_prestador_p)),1,7);

-- Caso não encontre ou não possua CNES, deve ser preenchido com '9999999'
if (coalesce(dados_prestador_w.cd_cnes::text, '') = '') then
	dados_prestador_w.cd_cnes := '9999999';
end if;

select	cd_cgc,
	cd_pessoa_fisica
into STRICT	cd_cgc_w,
	cd_pessoa_fisica_w
from	pls_prestador
where	nr_sequencia = nr_seq_prestador_p;

-- Caso for PF
if (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '') then

	dados_prestador_w.ie_tipo_ident_prest := '2';

	select	nr_cpf
	into STRICT	dados_prestador_w.cd_cpf_cnpj
	from	pessoa_fisica
	where	cd_pessoa_fisica = cd_pessoa_fisica_w;

	select	max(cd_municipio_ibge)
	into STRICT	dados_prestador_w.cd_municipio_ibge_prest
	from	compl_pessoa_fisica
	where	cd_pessoa_fisica = cd_pessoa_fisica_w
	and	ie_tipo_complemento = '2';

	if (coalesce(dados_prestador_w.cd_municipio_ibge_prest::text, '') = '') then
		select	max(cd_municipio_ibge)
		into STRICT	dados_prestador_w.cd_municipio_ibge_prest
		from	compl_pessoa_fisica
		where	cd_pessoa_fisica = cd_pessoa_fisica_w;
	end if;
-- Caso for PJ
elsif (cd_cgc_w IS NOT NULL AND cd_cgc_w::text <> '') then

	dados_prestador_w.ie_tipo_ident_prest := '1';
	dados_prestador_w.cd_cpf_cnpj := cd_cgc_w;

	select	substr(cd_municipio_ibge, 1, 7)
	into STRICT	dados_prestador_w.cd_municipio_ibge_prest
	from	pessoa_juridica
	where	cd_cgc = cd_cgc_w;
end if;

-- Se o código do IBGE não possui o dígito verificador, busca e concatena
if (dados_prestador_w.cd_municipio_ibge_prest < 7) then
	dados_prestador_w.cd_municipio_ibge_prest := dados_prestador_w.cd_municipio_ibge_prest || calcula_digito('MODULO10',substr(dados_prestador_w.cd_municipio_ibge_prest,1,10));
end if;

return dados_prestador_w;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pls_gerar_pre_estab_ans_pck.obter_dados_prestador ( nr_seq_prestador_p pls_prestador.nr_sequencia%type) FROM PUBLIC;
