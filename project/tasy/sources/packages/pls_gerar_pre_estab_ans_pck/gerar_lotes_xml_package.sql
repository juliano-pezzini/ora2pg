-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


-- Rotina responsável por gerar os registros quentes dos lotes de contratações
CREATE OR REPLACE PROCEDURE pls_gerar_pre_estab_ans_pck.gerar_lotes_xml ( nr_seq_lote_p pls_monitor_tiss_lote.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE


dados_lote_w		dados_lote;

C01 CURSOR(nr_seq_lote_pc		pls_monit_tiss_pre_est_val.nr_sequencia%type) FOR
	SELECT	cd_cnes,
		cd_cpf_cnpj,
		cd_municipio_ibge_prest,
		ie_tipo_ident_prest,
		nr_identificador,
		nr_registro_operadora_inter,
		nr_seq_prestador,
		nr_sequencia,
		vl_total_franquia,
		cd_cooperativa
	from	pls_monit_tiss_pre_est_val
	where	nr_seq_lote_monitor = nr_seq_lote_pc;


BEGIN

Open C01(nr_seq_lote_p);
loop
	-- Limap o type
	dados_lote_w := pls_gerar_pre_estab_ans_pck.limpar_dados_lote(dados_lote_w);

	-- Alimenta a informação no type
	fetch C01 bulk collect into 	dados_lote_w.cd_cnes,
					dados_lote_w.cd_cpf_cnpj,
					dados_lote_w.cd_municipio_ibge_prest,
					dados_lote_w.ie_tipo_ident_prest,
					dados_lote_w.nr_identificador,
					dados_lote_w.nr_registro_operadora_inter,
					dados_lote_w.nr_seq_prestador,
					dados_lote_w.nr_sequencia,
					dados_lote_w.vl_total_franquia,
					dados_lote_w.cd_cooperativa
	limit current_setting('pls_gerar_pre_estab_ans_pck.qt_transacao_w')::integer;

	exit when dados_lote_w.cd_cnes.count = 0;

	-- Depois somente manda para o banco
	forall i in dados_lote_w.cd_cnes.first .. dados_lote_w.cd_cnes.last
		insert	into	pls_monit_tiss_pre_est(	cd_cnes, cd_cpf_cnpj, cd_municipio_ibge_prest,
				dt_atualizacao, dt_atualizacao_nrec, ie_tipo_ident_prest,
				ie_tipo_registro, nm_usuario, nm_usuario_nrec,
				nr_identificador, nr_registro_operadora_inter, nr_seq_lote_monitor,
				nr_seq_pre_estab_val, nr_seq_prestador, nr_sequencia,
				vl_total_franquia, cd_cooperativa)
		values (	dados_lote_w.cd_cnes(i), dados_lote_w.cd_cpf_cnpj(i), dados_lote_w.cd_municipio_ibge_prest(i),
				clock_timestamp(), clock_timestamp(), dados_lote_w.ie_tipo_ident_prest(i),
				'1', nm_usuario_p, nm_usuario_p,
				dados_lote_w.nr_identificador(i), dados_lote_w.nr_registro_operadora_inter(i), nr_seq_lote_p,
				dados_lote_w.nr_sequencia(i), dados_lote_w.nr_seq_prestador(i), nextval('pls_monit_tiss_pre_est_seq'),
				dados_lote_w.vl_total_franquia(i), dados_lote_w.cd_cooperativa(i));
	commit;
end loop;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_pre_estab_ans_pck.gerar_lotes_xml ( nr_seq_lote_p pls_monitor_tiss_lote.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;
