-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


-- Rotina responsável por gerar o lote de contratação de retorno
CREATE OR REPLACE PROCEDURE pls_gerar_pre_estab_ans_pck.gera_contratacao_ret ( dados_lote_ret_p dados_lote_ret, nm_usuario_p usuario.nm_usuario%type, nr_seq_pre_est_ret_p INOUT pls_monit_tiss_pre_est_ret.nr_sequencia%type) AS $body$
DECLARE


nr_seq_arquivo_w		pls_monitor_tiss_arquivo.nr_sequencia%type;
nr_seq_pre_estab_w		pls_monit_tiss_pre_est.nr_sequencia%type;
nr_seq_prestador_w		pls_prestador.nr_sequencia%type;
cd_cooperativa_w		pls_monit_tiss_pre_est_ret.cd_cooperativa%type;


BEGIN
-- Busca o sequencial do arquivo que está sendo importado
select	max(nr_seq_arquivo)
into STRICT	nr_seq_arquivo_w
from	pls_monitor_tiss_lote_ret
where	nr_sequencia = dados_lote_ret_p.nr_seq_guia_monitor_ret;

-- Busca os dados do prestador
if (dados_lote_ret_p.cd_cpf_cnpj IS NOT NULL AND dados_lote_ret_p.cd_cpf_cnpj::text <> '') then
	if (dados_lote_ret_p.ie_tipo_ident_prest = '1') then
		select	max(nr_sequencia)
		into STRICT	nr_seq_prestador_w
		from	pls_prestador
		where	cd_cgc = dados_lote_ret_p.cd_cpf_cnpj;
	else
		select	max(a.nr_sequencia)
		into STRICT	nr_seq_prestador_w
		from	pls_prestador a,
			pessoa_fisica b
		where	a.cd_pessoa_fisica = b.cd_pessoa_fisica
		and	b.nr_cpf = dados_lote_ret_p.cd_cpf_cnpj;
	end if;

	select	max(nr_sequencia)
	into STRICT	nr_seq_pre_estab_w
	from	pls_monit_tiss_pre_est
	where	nr_seq_arq_monitor = nr_seq_arquivo_w
	and	nr_identificador = dados_lote_ret_p.nr_identificador
	and	nr_seq_prestador = nr_seq_prestador_w;

-- Busca o código da operadora
elsif (dados_lote_ret_p.nr_registro_operadora_inter IS NOT NULL AND dados_lote_ret_p.nr_registro_operadora_inter::text <> '') then
	select	max(cd_cooperativa)
	into STRICT	cd_cooperativa_w
	from	pls_congenere
	where	cd_ans = dados_lote_ret_p.nr_registro_operadora_inter;
end if;

-- Busca o sequencial da tabela quente para vínculo entre envio e retorno
if (coalesce(nr_seq_pre_estab_w::text, '') = '') then
	select	max(nr_sequencia)
	into STRICT	nr_seq_pre_estab_w
	from	pls_monit_tiss_pre_est
	where	nr_seq_arq_monitor = nr_seq_arquivo_w
	and	nr_identificador = dados_lote_ret_p.nr_identificador;
end if;

-- Insere o registro de contratação glosado
insert	into	pls_monit_tiss_pre_est_ret(	cd_cpf_cnpj, dt_atualizacao, dt_atualizacao_nrec,
		ie_tipo_ident_prest, nm_usuario, nm_usuario_nrec,
		nr_seq_guia_monitor_ret, nr_sequencia, nr_registro_operadora_inter,
		nr_identificador, nr_seq_pre_estab, nr_seq_prestador,
		cd_cooperativa)
values (	dados_lote_ret_p.cd_cpf_cnpj, clock_timestamp(), clock_timestamp(),
		dados_lote_ret_p.ie_tipo_ident_prest, nm_usuario_p, nm_usuario_p,
		dados_lote_ret_p.nr_seq_guia_monitor_ret, nextval('pls_monit_tiss_pre_est_ret_seq'), dados_lote_ret_p.nr_registro_operadora_inter,
		dados_lote_ret_p.nr_identificador, nr_seq_pre_estab_w, nr_seq_prestador_w,
		cd_cooperativa_w)
	returning nr_sequencia into nr_seq_pre_est_ret_p;
commit;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_pre_estab_ans_pck.gera_contratacao_ret ( dados_lote_ret_p dados_lote_ret, nm_usuario_p usuario.nm_usuario%type, nr_seq_pre_est_ret_p INOUT pls_monit_tiss_pre_est_ret.nr_sequencia%type) FROM PUBLIC;
