-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


-- Rotina chamada dentro do Delphi responsável por preparar a base para envio
CREATE OR REPLACE PROCEDURE pls_gerar_pre_estab_ans_pck.prepara_base_para_envio ( nr_seq_lote_p pls_monitor_tiss_lote.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) AS $body$
DECLARE


nr_seq_processo_w	pls_monitor_tempo_lote.nr_sequencia%type;
vl_param_session_w	integer;


BEGIN
-- Alimenta as variáveis de data
select	trunc(dt_mes_competencia, 'mm'),
	fim_mes(dt_mes_competencia)
into STRICT	current_setting('pls_gerar_pre_estab_ans_pck.dt_inicio_ref_w')::pls_monitor_tiss_lote.dt_mes_competencia%type,
	current_setting('pls_gerar_pre_estab_ans_pck.dt_fim_ref_w')::pls_monitor_tiss_lote.dt_mes_competencia%type
from	pls_monitor_tiss_lote
where	nr_sequencia = nr_seq_lote_p;

-- Verifica o parametro Oracle db_file_multiblock_read_count. O mesmo deve ter 128 ou mais para execução desta rotina por conta do
-- select de vários registros e os diversos inserts\updates que serão feitos.
begin
	EXECUTE	'select to_number(max(value)) ' ||
				'from	v$parameter ' ||
				'where  name = ''db_file_multiblock_read_count'' '
	into STRICT	vl_param_session_w;
exception
when others then
	-- ganha 1000 pra não entrar nos if's e não alterar nada.
	vl_param_session_w := 1000;
end;
-- Se tiver menos que esse valor então manda para 128 e no fim da rotina será retornado ao original caso foi alterado.
if (vl_param_session_w < 128) then

	-- Trata a exceção, se não der para alterar deixa como está,
	begin
		EXECUTE 'alter session set db_file_multiblock_read_count=128';
	exception
	when others then
		null;
	end;
end if;

begin
	-- Grava o processo executado pelo usuário
	CALL pls_gerar_pre_estab_ans_pck.grava_processo(nr_seq_lote_p, 2, nm_usuario_p);

	-- Gera as contratações na tabela quente
	nr_seq_processo_w := pls_gerar_pre_estab_ans_pck.grava_log_tempo_processo(nr_seq_lote_p, 'Gerando os lotes no XML', 'I', nm_usuario_p, nr_seq_processo_w);
	CALL pls_gerar_pre_estab_ans_pck.gerar_lotes_xml(nr_seq_lote_p, nm_usuario_p);
	nr_seq_processo_w := pls_gerar_pre_estab_ans_pck.grava_log_tempo_processo(null, null, 'F', null, nr_seq_processo_w);

	-- Gera os nomes dos arquivos e separa as contratações para cada arquivo
	nr_seq_processo_w := pls_gerar_pre_estab_ans_pck.grava_log_tempo_processo(nr_seq_lote_p, 'Gerando os nomes dos dos arquivos e vinculando os lotes', 'I', nm_usuario_p, nr_seq_processo_w);
	CALL CALL pls_gerar_pre_estab_ans_pck.inserir_arquivo_xml(nr_seq_lote_p, nm_usuario_p);
	nr_seq_processo_w := pls_gerar_pre_estab_ans_pck.grava_log_tempo_processo(null, null, 'F', null, nr_seq_processo_w);

	-- Atualiza o status dos registros para "Processando"
	nr_seq_processo_w := pls_gerar_pre_estab_ans_pck.grava_log_tempo_processo(nr_seq_lote_p, 'Atualizando o status dos registros para "Processando"', 'I', nm_usuario_p, nr_seq_processo_w);
	CALL pls_gerar_pre_estab_ans_pck.atualiza_status_prep_base(nr_seq_lote_p, nm_usuario_p);
	nr_seq_processo_w := pls_gerar_pre_estab_ans_pck.grava_log_tempo_processo(null, null, 'F', null, nr_seq_processo_w);

	-- Atualiza o status do lote
	nr_seq_processo_w := pls_gerar_pre_estab_ans_pck.grava_log_tempo_processo(nr_seq_lote_p, 'Atualizando status do lote', 'I', nm_usuario_p, nr_seq_processo_w);
	update	pls_monitor_tiss_lote set
		ie_status  	= 'LG',
		dt_atualizacao  = clock_timestamp(),
		dt_geracao_lote = clock_timestamp(),
		nm_usuario 	= nm_usuario_p
	where 	nr_sequencia  	= nr_seq_lote_p;
	commit;
	nr_seq_processo_w := pls_gerar_pre_estab_ans_pck.grava_log_tempo_processo(null, null, 'F', null, nr_seq_processo_w);

exception
when others then
	-- Atualiza o status do lote para dizer que deu Erro na geração do mesmo.
	-- lotes com esse status podem ter a preparação do arquivo desfeita
	update	pls_monitor_tiss_lote set
		ie_status  = 'PE',
		dt_atualizacao  = clock_timestamp(),
		dt_geracao_lote  = NULL,
		nm_usuario = nm_usuario_p
	where 	nr_sequencia  = nr_seq_lote_p;
	commit;

	-- exibe a mensagem do erro para o usuário
	CALL wheb_mensagem_pck.exibir_mensagem_abort(324928, 'ERRO=' || substr(sqlerrm, 0, 4000), -20012);
end;

-- se o parametro teve que ser alterado então volta como tava.
if (vl_param_session_w < 128) then

	-- Trata a exceção, se não der para alterar deixa como está,
	begin
		EXECUTE 'alter session set db_file_multiblock_read_count=' || vl_param_session_w;
	exception
	when others then
		null;
	end;
end if;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_pre_estab_ans_pck.prepara_base_para_envio ( nr_seq_lote_p pls_monitor_tiss_lote.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) FROM PUBLIC;
