-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE conciliar_integracao_ret_pck.desdobrar_pagamento_recurso (nr_seq_retorno_p convenio_retorno.nr_sequencia%type) AS $body$
DECLARE


nr_seq_ret_recurso_w		convenio_retorno.nr_sequencia%type;

qt_guia_pag_rec_w		bigint;

ie_desdob_pagto_recurso_w	convenio_estabelecimento.ie_desdob_pagto_recurso%type;
cd_estab_ret_w			estabelecimento.cd_estabelecimento%type;
cd_conv_ret_w			convenio.cd_convenio%type;


BEGIN

nr_seq_ret_recurso_w := null;

if	(nr_seq_retorno_p IS NOT NULL AND nr_seq_retorno_p::text <> '') then

	select 	count(*)
	into STRICT	qt_guia_pag_rec_w
	from	convenio_retorno_item
	where	nr_seq_retorno = nr_seq_retorno_p
	and	ie_tipo_pagamento = 'R';

	select	cd_convenio,
		cd_estabelecimento
	into STRICT	cd_conv_ret_w,
		cd_estab_ret_w
	from	convenio_retorno
	where	nr_sequencia = nr_seq_retorno_p;

	select	coalesce(max(ie_desdob_pagto_recurso), 'N')
	into STRICT	ie_desdob_pagto_recurso_w
	from	convenio_estabelecimento
	where	cd_convenio	 	= cd_conv_ret_w
	and	cd_estabelecimento 	= cd_estab_ret_w;

	if	qt_guia_pag_rec_w > 0 and ie_desdob_pagto_recurso_w = 'S' then

		select	nextval('convenio_retorno_seq')
		into STRICT	nr_seq_ret_recurso_w
		;

        if (current_setting('conciliar_integracao_ret_pck.ie_opcao_w')::varchar(2) <> 'V') then
            insert into convenio_retorno(nr_sequencia,
                cd_convenio,
                cd_estabelecimento,
                dt_atualizacao,
                dt_retorno,
                ie_status_retorno,
                nm_usuario,
                nm_usuario_retorno,
                cd_convenio_particular,
                ds_lote_convenio,
                ds_observacao,
                dt_baixa_cr,
                dt_consistencia,
                dt_fim_glosa,
                dt_final,
                dt_inicial,
                dt_limite_glosa,
                dt_recebimento,
                dt_ref_preco,
                dt_vinculacao,
                ie_baixa_unica_ret,
                ie_doc_retorno,
                ie_tipo_glosa,
                nr_seq_cobranca,
                nr_seq_prot_adic,
                nr_seq_protocolo,
                nr_seq_ret_estorno,
                nr_seq_ret_origem,
                nr_seq_tipo)
            SELECT	nr_seq_ret_recurso_w,
                cd_convenio,
                cd_estabelecimento,
                dt_atualizacao,
                dt_retorno,
                ie_status_retorno,
                nm_usuario,
                nm_usuario_retorno,
                cd_convenio_particular,
                ds_lote_convenio,
                obter_desc_expressao(953972),
                dt_baixa_cr,
                dt_consistencia,
                dt_fim_glosa,
                dt_final,
                dt_inicial,
                dt_limite_glosa,
                dt_recebimento,
                dt_ref_preco,
                dt_vinculacao,
                ie_baixa_unica_ret,
                ie_doc_retorno,
                ie_tipo_glosa,
                nr_seq_cobranca,
                nr_seq_prot_adic,
                nr_seq_protocolo,
                nr_seq_ret_estorno,
                nr_seq_ret_origem,
                nr_seq_tipo
            from	convenio_retorno
            where	nr_sequencia	= nr_seq_retorno_p;

            update	convenio_retorno_item
            set	nr_seq_retorno 		= nr_seq_ret_recurso_w
            where	nr_seq_retorno   	= nr_seq_retorno_p
            and	ie_tipo_pagamento = 'R';
        end if;
	end if;

end if;

end;


$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE conciliar_integracao_ret_pck.desdobrar_pagamento_recurso (nr_seq_retorno_p convenio_retorno.nr_sequencia%type) FROM PUBLIC;
