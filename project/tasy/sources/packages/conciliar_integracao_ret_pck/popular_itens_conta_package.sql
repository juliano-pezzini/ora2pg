-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE conciliar_integracao_ret_pck.popular_itens_conta () AS $body$
DECLARE


/* 
	Variaveis para select dos cursores.
*/
nr_interno_conta_w 			imp_dem_retorno_guia.nr_interno_conta%type;
cd_autorizacao_w 			imp_dem_retorno_guia.cd_autorizacao%type;
nr_seq_dem_ret_guia_w 			imp_dem_retorno_guia.nr_sequencia%type;

/*
	Cursores.
*/
cursor_itens CURSOR FOR
SELECT	a.cd_procedimento cd_procedimento,
	a.ie_tipo_guia,
	a.dt_realizacao,
	a.ie_tipo_pagamento,
	coalesce(a.cd_setor_exec,0)cd_setor_exec,	
	coalesce(a.vl_informado,0) vl_informado,
	coalesce(a.qt_executada,0) qt_executada,
	coalesce(a.vl_liberado,0) vl_liberado,
	a.cd_glosa cd_glosa,
	a.cd_motivo_interno cd_motivo_interno,
	coalesce(a.vl_glosado,0) vl_glosado,
	a.nr_sequencia,
	coalesce(	(	
			SELECT	f.cd_funcao
			from 	funcao_medico f 
			where 	f.ie_grau_partic_tiss = a.cd_grau_participacao 
		 LIMIT 1), 0) cd_funcao
from	imp_dem_ret_item a
where	a.nr_seq_dem_ret_guia 	= nr_seq_dem_ret_guia_w
and	coalesce(ie_status, 'P') 	= 'P'
or 	coalesce(ie_status, 'P') 	= 'V';

cursor_conta_procedimentos CURSOR FOR
SELECT	nr_sequencia,
	ie_origem_proced,
	cd_procedimento,	
	cd_procedimento_tuss,
	cd_procedimento_convenio,
	dt_procedimento,
	dt_conta,
	cd_setor_atendimento,
	vl_procedimento,
	vl_medico,
	vl_custo_operacional,
	cd_edicao_amb cd_edicao,
	ie_funcao_medico,
	coalesce(nr_doc_convenio,cd_autorizacao_w) nr_doc_convenio,
	nr_interno_conta
from	procedimento_paciente
where	nr_interno_conta  			= nr_interno_conta_w
and	coalesce(nr_doc_convenio,cd_autorizacao_w) 	= cd_autorizacao_w
and	coalesce(cd_motivo_exc_conta::text, '') = ''
and	qt_procedimento 			> 0

union

select	p.nr_sequencia,
	p.cd_procedimento,
	p.ie_origem_proced,
	p.cd_procedimento_tuss,
	p.cd_procedimento_convenio,
	p.dt_procedimento,
	p.dt_conta,
	p.cd_setor_atendimento,
	pp.vl_conta,
	pp.vl_participante,
	0 vl_custo_operacional,
	p.cd_edicao_amb cd_edicao,
	pp.ie_funcao ie_funcao_medico,
	coalesce(pp.nr_doc_honor_conv,cd_autorizacao_w) nr_doc_convenio,
	p.nr_interno_conta
from	procedimento_paciente p,
	procedimento_participante pp
where	p.nr_interno_conta  				= nr_interno_conta_w
and	p.nr_sequencia 					= pp.nr_sequencia
and	coalesce(pp.nr_doc_honor_conv,cd_autorizacao_w) 	= cd_autorizacao_w
and	coalesce(p.cd_motivo_exc_conta::text, '') = ''
and	p.qt_procedimento 				> 0
order by 
	cd_procedimento, 
	nr_sequencia desc;

cursor_conta_material CURSOR FOR
SELECT	a.nr_sequencia nr_sequencia,
	a.cd_material cd_material,
	a.cd_material_tiss cd_material_tiss,
	a.cd_material_tuss cd_material_tuss,
	a.cd_material_convenio cd_material_convenio,
	a.dt_atendimento dt_atendimento,
	a.dt_conta dt_conta,
	a.vl_material vl_material,
	a.qt_material qt_material,
	a.vl_unitario vl_unitario,
	coalesce(tiss_obter_codigo_tabela(a.nr_seq_tiss_tabela),'00') cd_edicao,
	coalesce(a.nr_doc_convenio,cd_autorizacao_w) nr_doc_convenio,
	a.cd_setor_atendimento
from	material_atend_paciente a
where	a.nr_interno_conta 			= nr_interno_conta_w
and	coalesce(a.nr_doc_convenio,cd_autorizacao_w) = cd_autorizacao_w
and	coalesce(cd_motivo_exc_conta::text, '') = ''
and	qt_material 				> 0
order by 
	cd_material, 
	nr_sequencia desc;

/*
	Row types.
*/
cursor_itens_row	cursor_itens%rowtype;
cursor_conta_proc_row	cursor_conta_procedimentos%rowtype;
cursor_conta_mat_row	cursor_conta_material%rowtype;

k integer;
BEGIN

	if (current_setting('conciliar_integracao_ret_pck.protocolos_w')::protocolo_v.count > 0) then

		for i in current_setting('conciliar_integracao_ret_pck.protocolos_w')::protocolo_v.first .. current_setting('conciliar_integracao_ret_pck.protocolos_w')::protocolo_v.last loop

			if (current_setting('conciliar_integracao_ret_pck.protocolos_w')::protocolo_v[i].contas.count > 0) then

				for j in current_setting('conciliar_integracao_ret_pck.protocolos_w')::protocolo_v[i].contas.first .. current_setting('conciliar_integracao_ret_pck.protocolos_w')::protocolo_v[i].contas.last loop
					k := 0;
					cd_autorizacao_w 	:= current_setting('conciliar_integracao_ret_pck.protocolos_w')::protocolo_v[i].contas(j).cd_autorizacao;					
					nr_interno_conta_w 	:= current_setting('conciliar_integracao_ret_pck.protocolos_w')::protocolo_v[i].contas(j).nr_interno_conta;
					nr_seq_dem_ret_guia_w 	:= current_setting('conciliar_integracao_ret_pck.protocolos_w')::protocolo_v[i].contas(j).nr_sequencia;
					for cursor_itens_row in cursor_itens loop

						current_setting('conciliar_integracao_ret_pck.protocolos_w')::protocolo_v[i].contas(j).itens_conta[k].nr_sequencia 		:= cursor_itens_row.nr_sequencia;				
						current_setting('conciliar_integracao_ret_pck.protocolos_w')::protocolo_v[i].contas(j).itens_conta[k].cd_procedimento 	:= cursor_itens_row.cd_procedimento;
						current_setting('conciliar_integracao_ret_pck.protocolos_w')::protocolo_v[i].contas(j).itens_conta[k].ie_tipo_guia 		:= cursor_itens_row.ie_tipo_guia;
						current_setting('conciliar_integracao_ret_pck.protocolos_w')::protocolo_v[i].contas(j).itens_conta[k].dt_realizacao 		:= cursor_itens_row.dt_realizacao;
						current_setting('conciliar_integracao_ret_pck.protocolos_w')::protocolo_v[i].contas(j).itens_conta[k].ie_tipo_pagamento 	:= cursor_itens_row.ie_tipo_pagamento;
						current_setting('conciliar_integracao_ret_pck.protocolos_w')::protocolo_v[i].contas(j).itens_conta[k].cd_setor_exec 		:= cursor_itens_row.cd_setor_exec;
						current_setting('conciliar_integracao_ret_pck.protocolos_w')::protocolo_v[i].contas(j).itens_conta[k].cd_funcao 		:= cursor_itens_row.cd_funcao;
						current_setting('conciliar_integracao_ret_pck.protocolos_w')::protocolo_v[i].contas(j).itens_conta[k].vl_informado 		:= cursor_itens_row.vl_informado;
						current_setting('conciliar_integracao_ret_pck.protocolos_w')::protocolo_v[i].contas(j).itens_conta[k].vl_glosado		:= cursor_itens_row.vl_glosado;
						current_setting('conciliar_integracao_ret_pck.protocolos_w')::protocolo_v[i].contas(j).itens_conta[k].qt_executada 		:= cursor_itens_row.qt_executada;
						current_setting('conciliar_integracao_ret_pck.protocolos_w')::protocolo_v[i].contas(j).itens_conta[k].vl_liberado 		:= cursor_itens_row.vl_liberado;
						current_setting('conciliar_integracao_ret_pck.protocolos_w')::protocolo_v[i].contas(j).itens_conta[k].cd_glosa 		:= cursor_itens_row.cd_glosa;
						current_setting('conciliar_integracao_ret_pck.protocolos_w')::protocolo_v[i].contas(j).itens_conta[k].cd_motivo_interno 	:= cursor_itens_row.cd_motivo_interno;
						current_setting('conciliar_integracao_ret_pck.protocolos_w')::protocolo_v[i].contas(j).itens_conta[k].ie_status 		:= current_setting('conciliar_integracao_ret_pck.ie_status_pendente_const_w')::imp_dem_retorno_prot.ie_status%type;

						k := k + 1;
					end loop;

					k := 0;					
					for cursor_conta_proc_row in cursor_conta_procedimentos loop

						current_setting('conciliar_integracao_ret_pck.protocolos_w')::protocolo_v[i].contas(j).procedimentos_conta[k].nr_sequencia 			:= cursor_conta_proc_row.nr_sequencia;
						current_setting('conciliar_integracao_ret_pck.protocolos_w')::protocolo_v[i].contas(j).procedimentos_conta[k].cd_procedimento 		:= cursor_conta_proc_row.cd_procedimento;
						current_setting('conciliar_integracao_ret_pck.protocolos_w')::protocolo_v[i].contas(j).procedimentos_conta[k].ie_origem_proced 		:= cursor_conta_proc_row.ie_origem_proced;
						current_setting('conciliar_integracao_ret_pck.protocolos_w')::protocolo_v[i].contas(j).procedimentos_conta[k].cd_procedimento_tuss 		:= cursor_conta_proc_row.cd_procedimento_tuss;
						current_setting('conciliar_integracao_ret_pck.protocolos_w')::protocolo_v[i].contas(j).procedimentos_conta[k].cd_procedimento_convenio 	:= cursor_conta_proc_row.cd_procedimento_convenio;
						current_setting('conciliar_integracao_ret_pck.protocolos_w')::protocolo_v[i].contas(j).procedimentos_conta[k].dt_atendimento 		:= cursor_conta_proc_row.dt_procedimento;
						current_setting('conciliar_integracao_ret_pck.protocolos_w')::protocolo_v[i].contas(j).procedimentos_conta[k].dt_conta			:= cursor_conta_proc_row.dt_conta;
						current_setting('conciliar_integracao_ret_pck.protocolos_w')::protocolo_v[i].contas(j).procedimentos_conta[k].cd_setor_atendimento 		:= cursor_conta_proc_row.cd_setor_atendimento;
						current_setting('conciliar_integracao_ret_pck.protocolos_w')::protocolo_v[i].contas(j).procedimentos_conta[k].vl_procedimento 		:= cursor_conta_proc_row.vl_procedimento;
						current_setting('conciliar_integracao_ret_pck.protocolos_w')::protocolo_v[i].contas(j).procedimentos_conta[k].vl_medico 			:= cursor_conta_proc_row.vl_medico;
						current_setting('conciliar_integracao_ret_pck.protocolos_w')::protocolo_v[i].contas(j).procedimentos_conta[k].vl_custo_operacional 		:= cursor_conta_proc_row.vl_custo_operacional;
						current_setting('conciliar_integracao_ret_pck.protocolos_w')::protocolo_v[i].contas(j).procedimentos_conta[k].cd_edicao 			:= cursor_conta_proc_row.cd_edicao;
						current_setting('conciliar_integracao_ret_pck.protocolos_w')::protocolo_v[i].contas(j).procedimentos_conta[k].nr_doc_convenio 		:= cursor_conta_proc_row.nr_doc_convenio;
						current_setting('conciliar_integracao_ret_pck.protocolos_w')::protocolo_v[i].contas(j).procedimentos_conta[k].nr_interno_conta 		:= cursor_conta_proc_row.nr_interno_conta;
						current_setting('conciliar_integracao_ret_pck.protocolos_w')::protocolo_v[i].contas(j).procedimentos_conta[k].ie_conciliado 			:= 'N';

						k := k + 1;
					end loop;

					k := 0;
					for cursor_conta_mat_row in cursor_conta_material loop			

						current_setting('conciliar_integracao_ret_pck.protocolos_w')::protocolo_v[i].contas(j).materiais_conta[k].nr_sequencia 		:= cursor_conta_mat_row.nr_sequencia;
						current_setting('conciliar_integracao_ret_pck.protocolos_w')::protocolo_v[i].contas(j).materiais_conta[k].cd_material 		:= cursor_conta_mat_row.cd_material;
						current_setting('conciliar_integracao_ret_pck.protocolos_w')::protocolo_v[i].contas(j).materiais_conta[k].cd_material_tiss 		:= cursor_conta_mat_row.cd_material_tiss;
						current_setting('conciliar_integracao_ret_pck.protocolos_w')::protocolo_v[i].contas(j).materiais_conta[k].cd_material_tuss 		:= cursor_conta_mat_row.cd_material_tuss;
						current_setting('conciliar_integracao_ret_pck.protocolos_w')::protocolo_v[i].contas(j).materiais_conta[k].cd_material_convenio 	:= cursor_conta_mat_row.cd_material_convenio;
						current_setting('conciliar_integracao_ret_pck.protocolos_w')::protocolo_v[i].contas(j).materiais_conta[k].dt_atendimento 		:= cursor_conta_mat_row.dt_atendimento;
						current_setting('conciliar_integracao_ret_pck.protocolos_w')::protocolo_v[i].contas(j).materiais_conta[k].dt_conta 			:= cursor_conta_mat_row.dt_conta;
						current_setting('conciliar_integracao_ret_pck.protocolos_w')::protocolo_v[i].contas(j).materiais_conta[k].cd_setor_atendimento 	:= cursor_conta_mat_row.cd_setor_atendimento;
						current_setting('conciliar_integracao_ret_pck.protocolos_w')::protocolo_v[i].contas(j).materiais_conta[k].vl_material 		:= cursor_conta_mat_row.vl_material;
						current_setting('conciliar_integracao_ret_pck.protocolos_w')::protocolo_v[i].contas(j).materiais_conta[k].vl_unitario 		:= cursor_conta_mat_row.vl_unitario;
						current_setting('conciliar_integracao_ret_pck.protocolos_w')::protocolo_v[i].contas(j).materiais_conta[k].qt_material 		:= cursor_conta_mat_row.qt_material;
						current_setting('conciliar_integracao_ret_pck.protocolos_w')::protocolo_v[i].contas(j).materiais_conta[k].cd_edicao 			:= cursor_conta_mat_row.cd_edicao;
						current_setting('conciliar_integracao_ret_pck.protocolos_w')::protocolo_v[i].contas(j).materiais_conta[k].nr_doc_convenio 		:= cursor_conta_mat_row.nr_doc_convenio;
						current_setting('conciliar_integracao_ret_pck.protocolos_w')::protocolo_v[i].contas(j).materiais_conta[k].ie_conciliado 		:= 'N';

						k := k + 1;
					end loop;
				end loop;

			end if;

		end loop;

	end if;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE conciliar_integracao_ret_pck.popular_itens_conta () FROM PUBLIC;
