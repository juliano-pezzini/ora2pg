-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE conciliar_integracao_ret_pck.gerar_convenio_retorno_glosa (item_w INOUT item) AS $body$
DECLARE


	nr_seq_ret_item_w	convenio_retorno_item.nr_sequencia%type;
	nr_seq_ret_glosa_w	convenio_retorno_glosa.nr_sequencia%type;

	cd_procedimento_w	convenio_retorno_glosa.cd_procedimento%type;
	ie_origem_proced_w	convenio_retorno_glosa.ie_origem_proced%type;

	cd_setor_atendimento_w	convenio_retorno_glosa.cd_setor_atendimento%type;

	cd_material_w		convenio_retorno_glosa.cd_material%type;

	cd_motivo_glosa_tasy_w	convenio_retorno_glosa.cd_motivo_glosa%type;
	cd_resposta_glosa_w	convenio_retorno_glosa.cd_resposta%type;
	ie_acao_glosa_w		convenio_retorno_glosa.ie_acao_glosa%type;	

	nr_seq_partic_w		convenio_retorno_glosa.nr_seq_partic%type;

	vl_amaior_w		convenio_retorno_glosa.vl_amaior%type := 0;


BEGIN
	nr_seq_ret_item_w	:= item_w.nr_seq_ret_item;	

	select	nextval('convenio_retorno_glosa_seq')
	into STRICT	nr_seq_ret_glosa_w
	;

	ie_origem_proced_w 	:= item_w.ie_origem_proced;
	cd_setor_atendimento_w 	:= item_w.cd_setor_atendimento;
	cd_procedimento_w	:= item_w.cd_procedimento;
	cd_material_w		:= item_w.cd_material;	

	if (item_w.nr_seq_propaci IS NOT NULL AND item_w.nr_seq_propaci::text <> '' AND item_w.cd_funcao IS NOT NULL AND item_w.cd_funcao::text <> '') then

		select	max(nr_seq_partic)
		into STRICT	nr_seq_partic_w
		from	procedimento_participante
		where	nr_sequencia	= item_w.nr_seq_propaci
		and	ie_funcao 	= item_w.cd_funcao
		and (
			vl_participante = item_w.vl_informado
			or 
			vl_conta = item_w.vl_informado
			);

	end if;

	if ((item_w.cd_setor_exec IS NOT NULL AND item_w.cd_setor_exec::text <> '') and item_w.cd_setor_exec > 0) then
		cd_setor_atendimento_w := item_w.cd_setor_exec;
	end if;

	if (item_w.cd_glosa IS NOT NULL AND item_w.cd_glosa::text <> '') or (item_w.cd_motivo_interno IS NOT NULL AND item_w.cd_motivo_interno::text <> '') then

		select 	max(cd_motivo_glosa) cd_motivo_glosa,
			max(cd_resposta) cd_resposta,
			max(ie_acao_glosa) ie_acao_glosa
		into STRICT	cd_motivo_glosa_tasy_w,
			cd_resposta_glosa_w,
			ie_acao_glosa_W
		from (
			SELECT	cd_motivo_glosa cd_motivo_glosa,
				cd_resposta cd_resposta,
				ie_acao_glosa ie_acao_glosa
			from	motivo_glosa
			where 	ie_situacao = 'A'
			and	clock_timestamp() between coalesce(dt_inicio_vigencia, clock_timestamp()) and coalesce(dt_fim_vigencia, clock_timestamp())
			and	cd_motivo_glosa_conv = item_w.cd_motivo_interno
			
union all

			SELECT 	a.cd_motivo_glosa cd_motivo_glosa,
				b.cd_resposta cd_resposta,
				b.ie_acao_glosa ie_acao_glosa
			from	tiss_motivo_glosa a,
				motivo_glosa b
			where	a.cd_motivo_tiss 	= item_w.cd_glosa
			and	a.cd_motivo_glosa 	= b.cd_motivo_glosa
		) alias10;

	end if;

	item_w.cd_glosa_tasy 		:= cd_motivo_glosa_tasy_w;
	item_w.cd_resposta_glosa 	:= cd_resposta_glosa_w;
	item_w.ie_acao_glosa		:= ie_acao_glosa_w;
	item_w.nr_seq_partic		:= nr_seq_partic_w;
	item_w.nr_seq_ret_glosa		:= nr_seq_ret_glosa_w;

	if item_w.vl_liberado > item_w.vl_informado then
		vl_amaior_w 		:= item_w.vl_liberado - item_w.vl_informado;
		/*

		Removido na OS 2250274.
		A subtracao eh somente para o vl_amaior, o vl_liberado se mantem o que veio no arquivo.

		item_w.vl_liberado 	:= item_w.vl_informado;

		*/
	end if;

    if (current_setting('conciliar_integracao_ret_pck.ie_opcao_w')::varchar(2) = 'V') then
        item_w.ie_status := 'V';
    else
        begin
            insert into convenio_retorno_glosa(
                dt_atualizacao,
                ie_atualizacao,
                nm_usuario,
                nr_seq_ret_item,
                nr_sequencia,
                qt_glosa,
                vl_glosa,
                nr_seq_matpaci,
                nr_seq_propaci,
                cd_material,
                cd_procedimento,
                ie_origem_proced,
                cd_setor_atendimento,
                cd_motivo_glosa,
                ie_acao_glosa,
                dt_integracao,
                nr_seq_partic,
                vl_pago_digitado,
                vl_cobrado,
                vl_amaior
                )
                values (
                clock_timestamp(),
                current_setting('conciliar_integracao_ret_pck.ie_atualizacao_const_w')::convenio_retorno_glosa.ie_atualizacao%type,
                current_setting('conciliar_integracao_ret_pck.nm_usuario_const_w')::convenio_retorno.nm_usuario%type,
                nr_seq_ret_item_w,
                nr_seq_ret_glosa_w,
                coalesce(item_w.qt_executada,0),
                coalesce(item_w.vl_glosado,0),
                item_w.nr_seq_matpaci,
                item_w.nr_seq_propaci,
                cd_material_w,
                cd_procedimento_w,
                ie_origem_proced_w,
                cd_setor_atendimento_w,
                cd_motivo_glosa_tasy_w,
                ie_acao_glosa_w,
                clock_timestamp(),
                nr_seq_partic_w,
                item_w.vl_liberado,
                item_w.vl_informado,
                vl_amaior_w
                );
        exception
        when others then
            DBMS_APPLICATION_INFO.SET_ACTION(null);
            item_w.ds_erro := sqlerrm;
            item_w.ie_status := 'E';
        end;
    end if;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE conciliar_integracao_ret_pck.gerar_convenio_retorno_glosa (item_w INOUT item) FROM PUBLIC;
