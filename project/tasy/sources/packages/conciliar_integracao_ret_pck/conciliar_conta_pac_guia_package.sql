-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE conciliar_integracao_ret_pck.conciliar_conta_pac_guia () AS $body$
DECLARE


vl_saldo_conta_w double precision;
BEGIN
if (current_setting('conciliar_integracao_ret_pck.protocolos_w')::protocolo_v.count > 0) then
	for i in current_setting('conciliar_integracao_ret_pck.protocolos_w')::protocolo_v.first .. current_setting('conciliar_integracao_ret_pck.protocolos_w')::protocolo_v.last loop
		if (current_setting('conciliar_integracao_ret_pck.protocolos_w')::protocolo_v[i].contas.count > 0) then

			for j in current_setting('conciliar_integracao_ret_pck.protocolos_w')::protocolo_v[i].contas.first .. current_setting('conciliar_integracao_ret_pck.protocolos_w')::protocolo_v[i].contas.last loop
				if (current_setting('conciliar_integracao_ret_pck.campos_conta_w')::campos_conta_v.count > 0) then
					for k in current_setting('conciliar_integracao_ret_pck.campos_conta_w')::campos_conta_v.first .. current_setting('conciliar_integracao_ret_pck.campos_conta_w')::campos_conta_v.last loop							
						if (current_setting('conciliar_integracao_ret_pck.protocolos_w')::protocolo_v[i].contas(j).nr_interno_conta = current_setting('conciliar_integracao_ret_pck.campos_conta_w')::campos_conta_v[k].nr_interno_conta)  then
							current_setting('conciliar_integracao_ret_pck.protocolos_w')::protocolo_v[i].contas(j).cd_autorizacao 	:= current_setting('conciliar_integracao_ret_pck.campos_conta_w')::campos_conta_v[k].cd_autorizacao;
							current_setting('conciliar_integracao_ret_pck.protocolos_w')::protocolo_v[i].contas(j).ie_status 		:= 'C';								
							current_setting('conciliar_integracao_ret_pck.protocolos_w')::protocolo_v[i].contas(j).vl_guia    		:= current_setting('conciliar_integracao_ret_pck.campos_conta_w')::campos_conta_v[k].vl_guia;
						elsif (current_setting('conciliar_integracao_ret_pck.protocolos_w')::protocolo_v[i].contas(j).ie_status <> 'C') then				
							current_setting('conciliar_integracao_ret_pck.protocolos_w')::protocolo_v[i].contas(j).ie_status 		:= 'N'; -- Guia nao localizada na conta paciente.									
						end if;
					end loop;
				end if;
			end loop;

			for j in current_setting('conciliar_integracao_ret_pck.protocolos_w')::protocolo_v[i].contas.first .. current_setting('conciliar_integracao_ret_pck.protocolos_w')::protocolo_v[i].contas.last loop			
				if (current_setting('conciliar_integracao_ret_pck.campos_conta_aux2_w')::campos_conta_v.count > 0) then
					for k in current_setting('conciliar_integracao_ret_pck.campos_conta_aux2_w')::campos_conta_v.first .. current_setting('conciliar_integracao_ret_pck.campos_conta_aux2_w')::campos_conta_v.last loop							
						if (current_setting('conciliar_integracao_ret_pck.campos_conta_aux2_w')::campos_conta_v[k].nr_interno_conta = current_setting('conciliar_integracao_ret_pck.protocolos_w')::protocolo_v[i].contas(j).nr_interno_conta) then
							if (current_setting('conciliar_integracao_ret_pck.campos_conta_aux2_w')::campos_conta_v[k].cd_autorizacao = current_setting('conciliar_integracao_ret_pck.protocolos_w')::protocolo_v[i].contas(j).nr_guia_operadora) then									
								current_setting('conciliar_integracao_ret_pck.protocolos_w')::protocolo_v[i].contas(j).cd_autorizacao 	:= current_setting('conciliar_integracao_ret_pck.campos_conta_aux2_w')::campos_conta_v[k].cd_autorizacao;
								current_setting('conciliar_integracao_ret_pck.protocolos_w')::protocolo_v[i].contas(j).vl_guia		:= current_setting('conciliar_integracao_ret_pck.campos_conta_aux2_w')::campos_conta_v[k].vl_guia;
								current_setting('conciliar_integracao_ret_pck.protocolos_w')::protocolo_v[i].contas(j).ie_status		:= 'C';																				
							elsif (current_setting('conciliar_integracao_ret_pck.campos_conta_aux2_w')::campos_conta_v[k].cd_autorizacao = current_setting('conciliar_integracao_ret_pck.protocolos_w')::protocolo_v[i].contas(j).nr_guia_prestador) then

								current_setting('conciliar_integracao_ret_pck.protocolos_w')::protocolo_v[i].contas(j).cd_autorizacao 	:= current_setting('conciliar_integracao_ret_pck.campos_conta_aux2_w')::campos_conta_v[k].cd_autorizacao;
								current_setting('conciliar_integracao_ret_pck.protocolos_w')::protocolo_v[i].contas(j).vl_guia		:= current_setting('conciliar_integracao_ret_pck.campos_conta_aux2_w')::campos_conta_v[k].vl_guia;
								current_setting('conciliar_integracao_ret_pck.protocolos_w')::protocolo_v[i].contas(j).ie_status		:= 'C';																	
							elsif (current_setting('conciliar_integracao_ret_pck.campos_conta_aux2_w')::campos_conta_v[k].vl_guia = current_setting('conciliar_integracao_ret_pck.protocolos_w')::protocolo_v[i].contas(j).vl_informado) then	

								current_setting('conciliar_integracao_ret_pck.protocolos_w')::protocolo_v[i].contas(j).cd_autorizacao 	:= current_setting('conciliar_integracao_ret_pck.campos_conta_aux2_w')::campos_conta_v[k].cd_autorizacao;
								current_setting('conciliar_integracao_ret_pck.protocolos_w')::protocolo_v[i].contas(j).vl_guia		:= current_setting('conciliar_integracao_ret_pck.campos_conta_aux2_w')::campos_conta_v[k].vl_guia;
								current_setting('conciliar_integracao_ret_pck.protocolos_w')::protocolo_v[i].contas(j).ie_status		:= 'C';										
							elsif (current_setting('conciliar_integracao_ret_pck.protocolos_w')::protocolo_v[i].contas(j).ie_status <> 'C') then												
								current_setting('conciliar_integracao_ret_pck.protocolos_w')::protocolo_v[i].contas(j).ie_status 		:= 'M'; -- Localizada mais de uma guia.
							end if;
						end if;
					end loop;
				end if;				
			end loop;

			for j in current_setting('conciliar_integracao_ret_pck.protocolos_w')::protocolo_v[i].contas.first .. current_setting('conciliar_integracao_ret_pck.protocolos_w')::protocolo_v[i].contas.last loop				
				if (current_setting('conciliar_integracao_ret_pck.campos_conta_aux_w')::campos_conta_v.count > 0) then
					for k in current_setting('conciliar_integracao_ret_pck.campos_conta_aux_w')::campos_conta_v.first .. current_setting('conciliar_integracao_ret_pck.campos_conta_aux_w')::campos_conta_v.last loop		
						if (current_setting('conciliar_integracao_ret_pck.campos_conta_aux_w')::campos_conta_v[k].nr_interno_conta = current_setting('conciliar_integracao_ret_pck.protocolos_w')::protocolo_v[i].contas(j).nr_interno_conta)then								
							if (current_setting('conciliar_integracao_ret_pck.campos_conta_aux_w')::campos_conta_v[k].cd_autorizacao = current_setting('conciliar_integracao_ret_pck.protocolos_w')::protocolo_v[i].contas(j).nr_guia_operadora) then
								current_setting('conciliar_integracao_ret_pck.protocolos_w')::protocolo_v[i].contas(j).cd_autorizacao 	:= current_setting('conciliar_integracao_ret_pck.campos_conta_aux_w')::campos_conta_v[k].cd_autorizacao;
								current_setting('conciliar_integracao_ret_pck.protocolos_w')::protocolo_v[i].contas(j).vl_guia		:= current_setting('conciliar_integracao_ret_pck.campos_conta_aux_w')::campos_conta_v[k].vl_guia;
								current_setting('conciliar_integracao_ret_pck.protocolos_w')::protocolo_v[i].contas(j).ie_status		:= 'C';
							elsif (current_setting('conciliar_integracao_ret_pck.campos_conta_aux_w')::campos_conta_v[k].cd_autorizacao = current_setting('conciliar_integracao_ret_pck.protocolos_w')::protocolo_v[i].contas(j).nr_guia_prestador) then								
								current_setting('conciliar_integracao_ret_pck.protocolos_w')::protocolo_v[i].contas(j).cd_autorizacao 	:= current_setting('conciliar_integracao_ret_pck.campos_conta_aux_w')::campos_conta_v[k].cd_autorizacao;
								current_setting('conciliar_integracao_ret_pck.protocolos_w')::protocolo_v[i].contas(j).vl_guia		:= current_setting('conciliar_integracao_ret_pck.campos_conta_aux_w')::campos_conta_v[k].vl_guia;
								current_setting('conciliar_integracao_ret_pck.protocolos_w')::protocolo_v[i].contas(j).ie_status		:= 'C';									
							elsif (current_setting('conciliar_integracao_ret_pck.campos_conta_aux_w')::campos_conta_v[k].vl_guia = current_setting('conciliar_integracao_ret_pck.protocolos_w')::protocolo_v[i].contas(j).vl_informado) then								
								current_setting('conciliar_integracao_ret_pck.protocolos_w')::protocolo_v[i].contas(j).cd_autorizacao 	:= current_setting('conciliar_integracao_ret_pck.campos_conta_aux_w')::campos_conta_v[k].cd_autorizacao;
								current_setting('conciliar_integracao_ret_pck.protocolos_w')::protocolo_v[i].contas(j).vl_guia		:= current_setting('conciliar_integracao_ret_pck.campos_conta_aux_w')::campos_conta_v[k].vl_guia;
								current_setting('conciliar_integracao_ret_pck.protocolos_w')::protocolo_v[i].contas(j).ie_status		:= 'C';
							elsif (current_setting('conciliar_integracao_ret_pck.protocolos_w')::protocolo_v[i].contas(j).ie_status <> 'C') then												
								current_setting('conciliar_integracao_ret_pck.protocolos_w')::protocolo_v[i].contas(j).ie_status 		:= 'N'; -- Guia nao localizada na conta paciente.
							end if;
						end if;
					end loop;
				end if;				
			end loop;

			for j in current_setting('conciliar_integracao_ret_pck.protocolos_w')::protocolo_v[i].contas.first .. current_setting('conciliar_integracao_ret_pck.protocolos_w')::protocolo_v[i].contas.last loop				
				if (current_setting('conciliar_integracao_ret_pck.protocolos_w')::protocolo_v[i].contas(j).ie_status in ('P', 'C')) then

					select 	coalesce(obter_saldo_conpaci(current_setting('conciliar_integracao_ret_pck.protocolos_w')::protocolo_v[i].contas(j).nr_interno_conta, current_setting('conciliar_integracao_ret_pck.protocolos_w')::protocolo_v[i].contas(j).cd_autorizacao),0)
					into STRICT 	vl_saldo_conta_w
					;

					current_setting('conciliar_integracao_ret_pck.protocolos_w')::protocolo_v[i].contas(j).vl_saldo := vl_saldo_conta_w;

					if (vl_saldo_conta_w <= 0) then
						current_setting('conciliar_integracao_ret_pck.protocolos_w')::protocolo_v[i].contas(j).ie_status := 'S'; -- Guia sem saldo.
					end if;

				end if;
			end loop;
		end if;		
	end loop;
end if;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE conciliar_integracao_ret_pck.conciliar_conta_pac_guia () FROM PUBLIC;
