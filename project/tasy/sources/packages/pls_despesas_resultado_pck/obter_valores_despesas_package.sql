-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pls_despesas_resultado_pck.obter_valores_despesas (ie_dimensao_um_p text, ie_dimensao_dois_p text, ds_vl_dimensao_um_p text, ds_vl_dimensao_dois_p text, dt_inicial_p text, dt_final_p text, ds_filtros_p text, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, ie_tipo_valor_p text) RETURNS SETOF T_VALORES_DESPESAS AS $body$
DECLARE


sql_base_w			varchar(32000);
sql_restricao_w			varchar(32000);
dt_mesano_referencia_w		varchar(10);
ie_forma_pagamento_w		pls_parametro_pagamento.ie_forma_pagamento%type;
nr_seq_contrato_w		pls_contrato.nr_sequencia%type;

t_valores_despesas_w		t_valores_despesas;


retorno_valores_despesas_w REFCURSOR;

dt_leitura_w			timestamp;
dt_mes_referencia_w		timestamp;
dados_restricao_w 		pls_util_pck.dados_select;

BEGIN
if (coalesce(upper(ie_dimensao_um_p), 'X') not in ('ANO', 'MES', 'T', 'S')) and (coalesce(upper(ie_dimensao_dois_p), 'X') not in ('ANO', 'MES', 'T', 'S')) then
	sql_restricao_w := sql_restricao_w || ' and	lote.dt_mes_competencia between to_date(''' || dt_inicial_p || ''') and to_date(''' || coalesce(dt_final_p,fim_mes(dt_inicial_p)) || ''')' || pls_util_pck.enter_w;
end if;

/* Produto */


if (ie_dimensao_um_p = 'P') or (ie_dimensao_dois_p = 'P') then
	if (ie_dimensao_um_p = 'P') then
		sql_restricao_w := sql_restricao_w || 	' and	a.nr_seq_plano = ' || ds_vl_dimensao_um_p || pls_util_pck.enter_w;
	else
		sql_restricao_w := sql_restricao_w || 	' and	a.nr_seq_plano = ' || ds_vl_dimensao_dois_p || pls_util_pck.enter_w;
	end if;
end if;

/* Tipo de contratacao */


if (ie_dimensao_um_p = 'TC') or (ie_dimensao_dois_p = 'TC') then
	if (ie_dimensao_um_p = 'TC') then
		sql_restricao_w := sql_restricao_w || 	' and	a.ie_tipo_contratacao = ''' || ds_vl_dimensao_um_p || '''' || pls_util_pck.enter_w;
	else
		sql_restricao_w := sql_restricao_w || 	' and	a.ie_tipo_contratacao = ''' || ds_vl_dimensao_dois_p || '''' || pls_util_pck.enter_w;
	end if;
end if;

/* Contrato */


if (ie_dimensao_um_p = 'C') or (ie_dimensao_dois_p = 'C') then
	
	if (ie_dimensao_um_p = 'C') and (ds_vl_dimensao_um_p IS NOT NULL AND ds_vl_dimensao_um_p::text <> '') then
		select	max(nr_sequencia)
		into STRICT	nr_seq_contrato_w
		from	pls_contrato
		where	nr_contrato = ds_vl_dimensao_um_p;
		if (nr_seq_contrato_w IS NOT NULL AND nr_seq_contrato_w::text <> '') then
			sql_restricao_w := sql_restricao_w || 	' and	a.nr_seq_contrato = ' || nr_seq_contrato_w || pls_util_pck.enter_w;
		else
			sql_restricao_w := sql_restricao_w || 	' and	a.nr_seq_intercambio = ' || ds_vl_dimensao_um_p || pls_util_pck.enter_w;
		end if;
	elsif (ie_dimensao_dois_p = 'C') and (ds_vl_dimensao_dois_p IS NOT NULL AND ds_vl_dimensao_dois_p::text <> '') then
		select	max(nr_sequencia)
		into STRICT	nr_seq_contrato_w
		from	pls_contrato
		where	nr_contrato = ds_vl_dimensao_dois_p;
		if (nr_seq_contrato_w IS NOT NULL AND nr_seq_contrato_w::text <> '') then
			sql_restricao_w := sql_restricao_w || 	' and	a.nr_seq_contrato = ' || nr_seq_contrato_w || pls_util_pck.enter_w;
		else
			sql_restricao_w := sql_restricao_w || 	' and	a.nr_seq_intercambio = ' || ds_vl_dimensao_dois_p || pls_util_pck.enter_w;
		end if;
	else
		sql_restricao_w := sql_restricao_w || ' and a.nr_seq_contrato is null and a.nr_seq_intercambio is null' || pls_util_pck.enter_w;
	end if;
end if;

/* Ano */


if (upper(ie_dimensao_um_p) = 'ANO') or (upper(ie_dimensao_dois_p) = 'ANO') then
	if (upper(ie_dimensao_um_p) = 'ANO') then
		dt_mesano_referencia_w := '01/01/' || ds_vl_dimensao_um_p;
	else
		dt_mesano_referencia_w := '01/01/' || ds_vl_dimensao_dois_p;
	end if;
	sql_restricao_w := sql_restricao_w || ' and	lote.dt_mes_competencia between to_date(''' || dt_mesano_referencia_w || ''') and to_date(''' || to_char(last_day(add_months(to_date(dt_mesano_referencia_w),11)),'dd/mm/yyyy') || ''')' || pls_util_pck.enter_w;
end if;

/* Mes */
	
if (upper(ie_dimensao_um_p) = 'MES') or (upper(ie_dimensao_dois_p) = 'MES') then
	if (upper(ie_dimensao_um_p) = 'MES') then
		dt_mesano_referencia_w := ds_vl_dimensao_um_p;
	else
		dt_mesano_referencia_w := ds_vl_dimensao_dois_p;
	end if;
	
	sql_restricao_w := sql_restricao_w || ' and	lote.dt_mes_competencia between to_date(''' || '01/' || dt_mesano_referencia_w || ''') and to_date(''' || to_char(last_day(to_date('01/' || dt_mesano_referencia_w)), 'dd/mm/yyyy') || ''')'|| pls_util_pck.enter_w;		
end if;

/* Trimestre*/


if (ie_dimensao_um_p = 'T') or (ie_dimensao_dois_p = 'T') then
	if (ie_dimensao_um_p = 'T') then
		dt_mesano_referencia_w := ds_vl_dimensao_um_p;
	else
		dt_mesano_referencia_w := ds_vl_dimensao_dois_p;
	end if;
	
	sql_restricao_w := sql_restricao_w || ' and	lote.dt_mes_competencia between to_date(''' || dt_mesano_referencia_w || ''') and to_date(''' || to_char(last_day(add_months(to_date(dt_mesano_referencia_w),2)), 'dd/mm/yyyy') || ''')' || pls_util_pck.enter_w;
end if;

/* Faixa etaria */


if (ie_dimensao_um_p = 'F') or (ie_dimensao_dois_p = 'F') then
	if (ie_dimensao_um_p = 'F') then
		sql_restricao_w := sql_restricao_w || ' and	a.nr_seq_faixa_etaria = ' || ds_vl_dimensao_um_p || pls_util_pck.enter_w;
	else
		sql_restricao_w := sql_restricao_w || ' and	a.nr_seq_faixa_etaria = ' || ds_vl_dimensao_dois_p || pls_util_pck.enter_w;
	end if;
end if;

/* Pagador */


if (upper(ie_dimensao_um_p) = 'PAG') or (upper(ie_dimensao_dois_p) = 'PAG') then
	if (upper(ie_dimensao_um_p) = 'PAG') and (ds_vl_dimensao_um_p IS NOT NULL AND ds_vl_dimensao_um_p::text <> '') then
		sql_restricao_w := sql_restricao_w || ' and	a.nr_seq_pagador = ' || ds_vl_dimensao_um_p || pls_util_pck.enter_w;
	elsif (upper(ie_dimensao_dois_p) = 'PAG') and (ds_vl_dimensao_dois_p IS NOT NULL AND ds_vl_dimensao_dois_p::text <> '') then
		sql_restricao_w := sql_restricao_w || ' and	a.nr_seq_pagador = ' || ds_vl_dimensao_dois_p || pls_util_pck.enter_w;
	else
		sql_restricao_w := sql_restricao_w || ' and	a.nr_seq_pagador is null ' || pls_util_pck.enter_w;
	end if;
end if;

/* Semestre */


if (ie_dimensao_um_p = 'S') or (ie_dimensao_dois_p = 'S') then
	if (ie_dimensao_um_p = 'S') then
		dt_mesano_referencia_w := ds_vl_dimensao_um_p;
	else
		dt_mesano_referencia_w := ds_vl_dimensao_dois_p;
	end if;
	
	if (substr(dt_mesano_referencia_w,1,2) = '01') then
		sql_restricao_w := sql_restricao_w || ' and	lote.dt_mes_competencia between to_date(''' || '01/01/' || substr(dt_mesano_referencia_w, 4, 4) || ''') and to_date(''' || '30/06/' || substr(dt_mesano_referencia_w, 4, 4) || ''')' || pls_util_pck.enter_w;
	else
		sql_restricao_w := sql_restricao_w || ' and	lote.dt_mes_competencia between to_date(''' || '01/07/' || substr(dt_mesano_referencia_w, 4, 4) || ''') and to_date(''' || '31/12/' || substr(dt_mesano_referencia_w, 4, 4) || ''')' || pls_util_pck.enter_w;
	end if;
end if;

/* Beneficiario */


if (ie_dimensao_um_p = 'B') or (ie_dimensao_dois_p = 'B') then
	if (ie_dimensao_um_p = 'B') then
		sql_restricao_w := sql_restricao_w || ' and	a.nr_seq_segurado = ' || ds_vl_dimensao_um_p || pls_util_pck.enter_w;
	else
		sql_restricao_w := sql_restricao_w || ' and	a.nr_seq_segurado = ' || ds_vl_dimensao_dois_p || pls_util_pck.enter_w;
	end if;
end if;

sql_restricao_w	:= ' and a.ie_tipo_valor = ''' || ie_tipo_valor_p || '''' || pls_util_pck.enter_w;

/* Obter restricao dos filtros da analise. */


sql_restricao_w := sql_restricao_w || pls_ar_montar_resultado_pck.obter_dados_restricao(ds_filtros_p, 'A');

sql_base_w := 	'select	nvl(sum(decode(ie_tipo_grupo_ans, ''10'', vl_liberado)),0) vl_consulta, ' || pls_util_pck.enter_w ||
		'	nvl(sum(decode(ie_tipo_grupo_ans, ''20'', vl_liberado)),0) vl_exame, ' || pls_util_pck.enter_w ||
		'	nvl(sum(decode(ie_tipo_grupo_ans, ''30'', vl_liberado)),0) vl_terapia, ' || pls_util_pck.enter_w ||
		'	nvl(sum(	case when (ie_tipo_grupo_ans in (''41'',''42'',''43'',''44'',''45'',''46'',''49'')) then ' || pls_util_pck.enter_w ||
		'			vl_liberado ' || pls_util_pck.enter_w ||
		'		else ' || pls_util_pck.enter_w ||
		'			0 ' || pls_util_pck.enter_w ||
		'		end),0) vl_internacao, ' || pls_util_pck.enter_w ||
		'	nvl(sum(decode(ie_tipo_grupo_ans, ''50'', vl_liberado)),0) vl_outro_atendimento, ' || pls_util_pck.enter_w ||
		'	nvl(sum(decode(ie_tipo_grupo_ans, ''60'', vl_liberado)),0) vl_demais_despesas, ' || pls_util_pck.enter_w ||
		'	nvl(sum(	case when (nvl(ie_tipo_grupo_ans, ''X'') not in (''10'',''20'',''30'',''41'',''42'',''43'',''44'',''45'',''46'',''49'',''50'',''60'')) then ' || pls_util_pck.enter_w ||
		'			vl_liberado ' || pls_util_pck.enter_w ||
		'		else ' || pls_util_pck.enter_w ||
		'			0 ' || pls_util_pck.enter_w ||
		'		end),0) vl_sem_grupo, ' || pls_util_pck.enter_w ||
		'	nvl(sum(vl_liberado),0) vl_total ' || pls_util_pck.enter_w ||
		'from	(select	nvl(sum(d.vl_liberado),0) vl_liberado, ' || pls_util_pck.enter_w ||
		'		c.ie_tipo_grupo_ans ' || pls_util_pck.enter_w ||
		'	from	pls_ar_lote		lote, ' || pls_util_pck.enter_w ||
		'		pls_ar_conta		a, ' || pls_util_pck.enter_w ||
		'		pls_conta_v		b, ' || pls_util_pck.enter_w ||
		'		ans_grupo_despesa 	c, ' || pls_util_pck.enter_w ||
		'		pls_conta_proc		d, ' || pls_util_pck.enter_w ||
		'		pls_segurado		s  ' || pls_util_pck.enter_w ||
		'	where	a.nr_seq_lote 		= lote.nr_sequencia ' || pls_util_pck.enter_w ||
		'	and	c.nr_sequencia(+)	= d.nr_seq_grupo_ans ' || pls_util_pck.enter_w ||
		'	and	b.nr_sequencia		= a.nr_seq_conta ' || pls_util_pck.enter_w ||
		'	and	s.nr_sequencia 		= a.nr_seq_segurado ' || pls_util_pck.enter_w ||
		'	and	b.nr_sequencia		= d.nr_seq_conta ' || pls_util_pck.enter_w ||
		'	and	d.ie_status 	not in  (''M'',''D'') ' || pls_util_pck.enter_w ||
		sql_restricao_w || pls_util_pck.enter_w ||
		'	group by ' || pls_util_pck.enter_w ||
		'		c.ie_tipo_grupo_ans ' || pls_util_pck.enter_w ||
		'	union all ' || pls_util_pck.enter_w ||
		'	select	nvl(sum(d.vl_liberado),0) vl_liberado, ' || pls_util_pck.enter_w ||
		'		c.ie_tipo_grupo_ans ' || pls_util_pck.enter_w ||
		'	from	pls_ar_lote		lote, ' || pls_util_pck.enter_w ||
		'		pls_ar_conta		a, ' || pls_util_pck.enter_w ||
		'		pls_conta_v		b, ' || pls_util_pck.enter_w ||
		'		ans_grupo_despesa 	c, ' || pls_util_pck.enter_w ||
		'		pls_conta_mat		d, ' || pls_util_pck.enter_w ||
		'		pls_segurado		s  ' || pls_util_pck.enter_w ||
		'	where	a.nr_seq_lote 		= lote.nr_sequencia ' || pls_util_pck.enter_w ||
		'	and	c.nr_sequencia(+)	= d.nr_seq_grupo_ans ' || pls_util_pck.enter_w ||
		'	and	b.nr_sequencia		= a.nr_seq_conta ' || pls_util_pck.enter_w ||
		'	and	s.nr_sequencia 		= a.nr_seq_segurado ' || pls_util_pck.enter_w ||
		'	and	b.nr_sequencia		= d.nr_seq_conta ' || pls_util_pck.enter_w ||
		'	and	d.ie_status 	not in  (''M'',''D'') ' || pls_util_pck.enter_w ||
		sql_restricao_w || pls_util_pck.enter_w ||
		'	group by ' || pls_util_pck.enter_w ||
		'		c.ie_tipo_grupo_ans) ';

open retorno_valores_despesas_w for EXECUTE sql_base_w;	
fetch retorno_valores_despesas_w bulk collect into t_valores_despesas_w limit current_setting('pls_despesas_resultado_pck.qt_registro_transacao_w')::integer;
close retorno_valores_despesas_w;

for i in t_valores_despesas_w.first..t_valores_despesas_w.last loop
	RETURN NEXT t_valores_despesas_w(i);
end loop;

end;


$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_despesas_resultado_pck.obter_valores_despesas (ie_dimensao_um_p text, ie_dimensao_dois_p text, ds_vl_dimensao_um_p text, ds_vl_dimensao_dois_p text, dt_inicial_p text, dt_final_p text, ds_filtros_p text, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, ie_tipo_valor_p text) FROM PUBLIC;
