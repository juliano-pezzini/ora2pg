-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_consulta_analise_pck.pls_gerar_w_item_analise ( nr_seq_analise_p bigint, nr_nivel_p bigint, nr_seq_grupo_p bigint, ie_minha_analise_p text, ie_pendentes_p text, nm_usuario_p text, ie_somente_ocor_p text default 'N', ie_ocultar_canc_p text default 'N', nr_id_transacao_p INOUT bigint DEFAULT NULL, ie_html5_p text default 'N') AS $body$
BEGIN
		--exec_sql_dinamico(nm_usuario_p,'truncate table w_pls_analise_glosa_ocor');
		delete FROM w_pls_analise_glosa_ocor
		where nr_seq_analise = nr_seq_analise_p;

		CALL CALL pls_consulta_analise_pck.pls_iniciar_dados_analise(nr_seq_analise_p);
		
		select	count(1)
		into STRICT	current_setting('pls_consulta_analise_pck.qt_selecao_w')::bigint
		from	w_pls_analise_selecao_item	a
		where	a.nr_seq_analise	= nr_seq_analise_p;

		PERFORM set_config('pls_consulta_analise_pck.nr_nivel_w', nr_nivel_p, false);
		PERFORM set_config('pls_consulta_analise_pck.nr_seq_item_w', 1, false);
		--por ser por análise realiza o select fora do cursor
		select	count(1)
		into STRICT	current_setting('pls_consulta_analise_pck.qt_item_sem_id_w')::integer
		from (SELECT	a.nr_sequencia
			from	pls_conta_proc 	a,
				pls_conta	b
			where	a.nr_seq_conta		= b.nr_sequencia
			and	b.nr_seq_analise 	= nr_seq_analise_p
			and	coalesce(nr_id_analise::text, '') = ''
			
union all

			SELECT	b.nr_sequencia
			from	pls_conta_mat	b,
				pls_conta	a
			where	b.nr_seq_conta		= a.nr_sequencia
			and	a.nr_seq_analise	= nr_seq_analise_p
			and	coalesce(nr_id_analise::text, '') = ''
			
union all

			select	a.nr_sequencia
			from	pls_proc_participante	c,
				pls_conta_proc 		a,
				pls_conta		b
			where	a.nr_seq_conta		= b.nr_sequencia
			and	b.nr_seq_analise 	= nr_seq_analise_p
			and	c.nr_seq_conta_proc	= a.nr_sequencia
			and	coalesce(c.nr_id_analise::text, '') = '') alias5;
			
		if (coalesce(nr_id_transacao_p,0)	=0) then
			select 	nextval('pls_id_analise_seq')
			into STRICT	nr_id_transacao_p
			;
		else
			delete	FROM w_pls_analise_item
			where 	nr_id_transacao	= nr_id_transacao_p;
			
			delete 	FROM w_pls_analise_glosa_ocor
			where	nr_id_transacao	= nr_id_transacao_p;
			
		end if;
		
		delete 	FROM w_pls_analise_total
		where	nr_seq_analise = nr_seq_analise_p;
		
		pls_gerar_w_analise_cabecalho(nr_seq_analise_p, nr_seq_grupo_p, nm_usuario_p, nr_id_transacao_p);
		
		open current_setting('pls_consulta_analise_pck.c02')::CURSOR;
		loop
		fetch current_setting('pls_consulta_analise_pck.c02')::into CURSOR	
			current_setting('pls_consulta_analise_pck.nr_seq_conta_w')::bigint,
			current_setting('pls_consulta_analise_pck.nr_seq_guia_w')::bigint,
			current_setting('pls_consulta_analise_pck.nr_seq_protocolo_w')::bigint,
			current_setting('pls_consulta_analise_pck.nr_seq_prestador_solic_w')::bigint,
			current_setting('pls_consulta_analise_pck.nr_seq_prestador_exec_w')::bigint,
			current_setting('pls_consulta_analise_pck.dt_emissao_conta_w')::timestamp,
			current_setting('pls_consulta_analise_pck.nr_seq_cbo_saude_w')::bigint,
			current_setting('pls_consulta_analise_pck.cd_medico_executor_w')::varchar(20),
			current_setting('pls_consulta_analise_pck.cd_guia_conta_w')::varchar(30),
			current_setting('pls_consulta_analise_pck.ie_tipo_guia_conta_w')::varchar(20),
			current_setting('pls_consulta_analise_pck.cd_estabelecimento_w')::pls_conta.cd_estabelecimento%type,
			current_setting('pls_consulta_analise_pck.ie_tipo_conta_w')::pls_conta.ie_tipo_conta%type;
		EXIT WHEN NOT FOUND; /* apply on current_setting('pls_consulta_analise_pck.c02')::CURSOR */
			begin
			PERFORM set_config('pls_consulta_analise_pck.nm_prestador_solic_w', pls_obter_dados_prestador(current_setting('pls_consulta_analise_pck.nr_seq_prestador_solic_w')::bigint,'N'), false);
			PERFORM set_config('pls_consulta_analise_pck.nm_prestador_exec_w', pls_obter_dados_prestador(current_setting('pls_consulta_analise_pck.nr_seq_prestador_exec_w')::bigint,'N'), false);
			PERFORM set_config('pls_consulta_analise_pck.cd_prestador_exec_w', pls_obter_dados_prestador(current_setting('pls_consulta_analise_pck.nr_seq_prestador_exec_w')::bigint,'CD'), false);
			
			PERFORM set_config('pls_consulta_analise_pck.ie_autorizado_w', null, false);
			
			if (current_setting('pls_consulta_analise_pck.nr_seq_guia_w')::(bigint IS NOT NULL AND bigint::text <> '')) then
				select	a.ie_tipo_guia,
					obter_valor_dominio(1746,a.ie_tipo_guia),
					cd_guia,
					CASE WHEN ie_status=1 THEN  'S'  ELSE 'N' END
				into STRICT	current_setting('pls_consulta_analise_pck.ie_tipo_guia_w')::varchar(2),
					current_setting('pls_consulta_analise_pck.ds_tipo_guia_w')::varchar(255),
					current_setting('pls_consulta_analise_pck.cd_guia_w')::varchar(30),
					current_setting('pls_consulta_analise_pck.ie_autorizado_w')::varchar(3)
				from	pls_guia_plano a
				where	nr_sequencia = current_setting('pls_consulta_analise_pck.nr_seq_guia_w')::bigint;
				
				PERFORM set_config('pls_consulta_analise_pck.ds_tipo_guia_w', obter_valor_dominio(1746,current_setting('pls_consulta_analise_pck.ie_tipo_guia_conta_w')::varchar(20)), false);
				PERFORM set_config('pls_consulta_analise_pck.ie_tipo_guia_w', current_setting('pls_consulta_analise_pck.ie_tipo_guia_conta_w')::varchar(20), false);
			else
				PERFORM set_config('pls_consulta_analise_pck.cd_guia_w', current_setting('pls_consulta_analise_pck.cd_guia_conta_w')::varchar(30), false);
				PERFORM set_config('pls_consulta_analise_pck.ds_tipo_guia_w', obter_valor_dominio(1746,current_setting('pls_consulta_analise_pck.ie_tipo_guia_conta_w')::varchar(20)), false);
				PERFORM set_config('pls_consulta_analise_pck.ie_tipo_guia_w', current_setting('pls_consulta_analise_pck.ie_tipo_guia_conta_w')::varchar(20), false);
			end if;
			
			if (current_setting('pls_consulta_analise_pck.ie_tipo_conta_w')::pls_conta.ie_tipo_conta%type	= 'I') then
				PERFORM set_config('pls_consulta_analise_pck.cd_guia_w', current_setting('pls_consulta_analise_pck.cd_guia_conta_w')::varchar(30), false);
			end if;
			
			if (current_setting('pls_consulta_analise_pck.nr_seq_cbo_saude_w')::(bigint IS NOT NULL AND bigint::text <> '')) then
				select	max(a.ds_cbo)
				into STRICT	current_setting('pls_consulta_analise_pck.ds_espec_cbo_w')::varchar(255)
				from	cbo_saude	a
				where	a.nr_sequencia	= current_setting('pls_consulta_analise_pck.nr_seq_cbo_saude_w')::bigint;
			end if;
			
			if (current_setting('pls_consulta_analise_pck.cd_medico_executor_w')::(varchar(20) IS NOT NULL AND (varchar(20))::text <> '')) then
				select	substr(nm_pessoa_fisica,1,255)
				into STRICT	current_setting('pls_consulta_analise_pck.ds_medico_executor_w')::varchar(255)
				from	pessoa_fisica
				where	cd_pessoa_fisica	= current_setting('pls_consulta_analise_pck.cd_medico_executor_w')::varchar(20);
			end if;
			--Mantido o tratamento acima para evitar erros
			if (current_setting('pls_consulta_analise_pck.qt_item_sem_id_w')::integer > 0) then
				select	count(1)
				into STRICT	current_setting('pls_consulta_analise_pck.qt_item_sem_id_w')::integer
				from (SELECT	a.nr_sequencia
					from	pls_conta_proc 	a,
						pls_conta	b
					where	a.nr_seq_conta		= b.nr_sequencia
					and	b.nr_seq_analise 	= nr_seq_analise_p
					and	coalesce(nr_id_analise::text, '') = ''
					
union all

					SELECT	b.nr_sequencia
					from	pls_conta_mat	b,
						pls_conta	a
					where	b.nr_seq_conta		= a.nr_sequencia
					and	a.nr_seq_analise	= nr_seq_analise_p
					and	coalesce(nr_id_analise::text, '') = ''
					
union all

					select	a.nr_sequencia
					from	pls_proc_participante	c,
						pls_conta_proc 		a,
						pls_conta		b
					where	a.nr_seq_conta		= b.nr_sequencia
					and	b.nr_seq_analise 	= nr_seq_analise_p
					and	c.nr_seq_conta_proc	= a.nr_sequencia
					and	coalesce(c.nr_id_analise::text, '') = '') alias7;
				if (current_setting('pls_consulta_analise_pck.qt_item_sem_id_w')::integer > 0) then
					/* gera o id para os itens que não possuem o mesmo*/

					CALL pls_analise_atualizar_id_itens(current_setting('pls_consulta_analise_pck.nr_seq_conta_w')::bigint,nm_usuario_p,current_setting('pls_consulta_analise_pck.cd_estabelecimento_w')::pls_conta.cd_estabelecimento%type,'S');
				end if;
			end if;
			if (coalesce(ie_html5_p,'N') = 'N') then
				CALL pls_gerar_w_analise_item_tit(nr_seq_analise_p,current_setting('pls_consulta_analise_pck.nr_seq_conta_w')::bigint,nm_usuario_p, nr_id_transacao_p);
				CALL pls_gerar_w_analise_item_conta(nr_seq_analise_p,current_setting('pls_consulta_analise_pck.nr_seq_conta_w')::bigint,nr_seq_grupo_p,ie_minha_analise_p,ie_pendentes_p,nm_usuario_p, coalesce(ie_somente_ocor_p,'N'), nr_id_transacao_p);
				CALL pls_gerar_w_analise_item_agr(nr_seq_analise_p, current_setting('pls_consulta_analise_pck.nr_seq_conta_w')::bigint, nr_seq_grupo_p, ie_minha_analise_p, ie_pendentes_p, nm_usuario_p, coalesce(ie_somente_ocor_p,'N'), ie_ocultar_canc_p, nr_id_transacao_p);
				CALL pls_gerar_w_analise_item_proc(nr_seq_analise_p, current_setting('pls_consulta_analise_pck.nr_seq_conta_w')::bigint, nr_seq_grupo_p, ie_minha_analise_p, ie_pendentes_p, nm_usuario_p, coalesce(ie_somente_ocor_p,'N'), ie_ocultar_canc_p, nr_id_transacao_p);
				CALL pls_gerar_w_analise_item_mat(nr_seq_analise_p, current_setting('pls_consulta_analise_pck.nr_seq_conta_w')::bigint, nr_seq_grupo_p, ie_minha_analise_p, ie_pendentes_p, nm_usuario_p, coalesce(ie_somente_ocor_p,'N'), ie_ocultar_canc_p, nr_id_transacao_p);
			else
				CALL pls_gerar_w_analise_item_tit(nr_seq_analise_p,current_setting('pls_consulta_analise_pck.nr_seq_conta_w')::bigint,nm_usuario_p, nr_id_transacao_p);
				CALL pls_gerar_w_analise_conta_html(nr_seq_analise_p,current_setting('pls_consulta_analise_pck.nr_seq_conta_w')::bigint,nr_seq_grupo_p,ie_minha_analise_p,ie_pendentes_p,nm_usuario_p, coalesce(ie_somente_ocor_p,'N'), nr_id_transacao_p);
				CALL pls_gerar_w_analise_proc_html(nr_seq_analise_p, current_setting('pls_consulta_analise_pck.nr_seq_conta_w')::bigint, nr_seq_grupo_p, ie_minha_analise_p, ie_pendentes_p, nm_usuario_p, coalesce(ie_somente_ocor_p,'N'), ie_ocultar_canc_p, nr_id_transacao_p);
				CALL pls_gerar_w_analise_mat_html(nr_seq_analise_p, current_setting('pls_consulta_analise_pck.nr_seq_conta_w')::bigint, nr_seq_grupo_p, ie_minha_analise_p, ie_pendentes_p, nm_usuario_p, coalesce(ie_somente_ocor_p,'N'), ie_ocultar_canc_p, nr_id_transacao_p);
			end if;
			end;
		end loop;
		close current_setting('pls_consulta_analise_pck.c02')::CURSOR;
		
		CALL pls_ordenar_w_analise_item(nr_seq_analise_p,nm_usuario_p, nr_id_transacao_p);
		
		insert into w_pls_analise_total(nr_sequencia,
			nm_usuario,
			dt_atualizacao,
			nm_usuario_nrec,
			dt_atualizacao_nrec,
			nr_seq_analise,
			vl_total_liberado,
			vl_total_glosado,
			vl_total_apresentado,
			vl_total_calculado,
			vl_total_taxa,
			nr_id_transacao)
		values (nextval('w_pls_analise_total_seq'),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nr_seq_analise_p,
			current_setting('pls_consulta_analise_pck.vl_total_liberado_w')::double,
			current_setting('pls_consulta_analise_pck.vl_total_glosado_w')::double,
			current_setting('pls_consulta_analise_pck.vl_total_apresentado_w')::double,
			current_setting('pls_consulta_analise_pck.vl_total_calculado_w')::double,
			current_setting('pls_consulta_analise_pck.vl_total_taxa_w')::double,
			nr_id_transacao_p);
			
		commit;
		
	end;
	
	/* Getters e Setters */

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_consulta_analise_pck.pls_gerar_w_item_analise ( nr_seq_analise_p bigint, nr_nivel_p bigint, nr_seq_grupo_p bigint, ie_minha_analise_p text, ie_pendentes_p text, nm_usuario_p text, ie_somente_ocor_p text default 'N', ie_ocultar_canc_p text default 'N', nr_id_transacao_p INOUT bigint DEFAULT NULL, ie_html5_p text default 'N') FROM PUBLIC;
