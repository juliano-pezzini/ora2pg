-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_pp_apropriacao_pck.insere_item_apropriacao ( nr_id_transacao_p pls_pp_rp_aprop_selecao.nr_id_transacao%type, nr_seq_lote_p pls_pp_lote.nr_sequencia%type, nr_seq_regra_periodo_p pls_pp_lote.nr_seq_regra_periodo%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE


tb_nr_seq_it_aprop_w	pls_util_cta_pck.t_number_table;
tb_nr_seq_evento_w	pls_util_cta_pck.t_number_table;
tb_nr_seq_prest_w	pls_util_cta_pck.t_number_table;
tb_vl_divida_w		pls_util_cta_pck.t_number_table;

c01 CURSOR(	nr_seq_lote_pc		pls_pp_lote.nr_sequencia%type,
		nr_seq_regra_periodo_pc	pls_pp_lote.nr_seq_regra_periodo%type) FOR
	SELECT	a.nr_sequencia nr_seq_filtro
	from	pls_pp_rp_cta_filtro a
	where	a.nr_seq_regra_periodo = nr_seq_regra_periodo_pc
	and	a.ie_tipo_filtro = 'A'
	and	a.ie_excecao = 'N'
	and	a.ie_situacao = 'A'
	
union all

	SELECT	a.nr_sequencia nr_seq_filtro
	from	pls_pp_rp_cta_filtro a
	where	a.nr_seq_lote = nr_seq_lote_pc
	and	a.ie_tipo_filtro = 'A'
	and	a.ie_excecao = 'N'
	and	a.ie_situacao = 'A';

c02 CURSOR(	nr_id_transacao_pc	pls_pp_rp_aprop_selecao.nr_id_transacao%type,
		nr_seq_filtro_pc	pls_pp_rp_cta_filtro.nr_sequencia%type,
		nr_seq_lote_pc		pls_pp_lote.nr_sequencia%type) FOR
	SELECT	a.nr_sequencia,
		a.nr_seq_evento,
		a.nr_seq_prestador,
		a.vl_divida
	from	pls_pp_item_apropriacao a,
		pls_pp_rp_aprop_selecao b
	where	b.nr_id_transacao = nr_id_transacao_pc
	and	b.nr_seq_filtro = nr_seq_filtro_pc
	and	b.ie_valido = 'S'
	and	a.nr_sequencia = b.nr_seq_pp_it_aprop
	and	a.ie_baixado = 'N'
	and not exists (	SELECT	1
			from	pls_pp_item_lote x
			where	x.nr_seq_lote = nr_seq_lote_pc
			and	x.nr_seq_pp_it_aprop = a.nr_sequencia);

BEGIN

for r_c01_w in c01(nr_seq_lote_p, nr_seq_regra_periodo_p) loop

	open c02(nr_id_transacao_p, r_c01_w.nr_seq_filtro, nr_seq_lote_p);
	loop
		fetch c02 bulk collect into	tb_nr_seq_it_aprop_w, tb_nr_seq_evento_w, tb_nr_seq_prest_w,
						tb_vl_divida_w
		limit pls_util_pck.qt_registro_transacao_w;
		exit when tb_nr_seq_it_aprop_w.count = 0;
		
		forall i in tb_nr_seq_it_aprop_w.first..tb_nr_seq_it_aprop_w.last
			insert into pls_pp_item_lote(
				nr_sequencia, nr_seq_lote, nm_usuario,
				nm_usuario_nrec, dt_atualizacao, dt_atualizacao_nrec,
				ie_tipo_item, nr_seq_evento, nr_seq_prestador,
				vl_glosa, vl_liquido, vl_item,
				nr_seq_pp_it_aprop, vl_desconto_tributo, vl_acao_negativo,
				ie_cancelado, nr_seq_prestador_origem
			) values (
				nextval('pls_pp_item_lote_seq'), nr_seq_lote_p, nm_usuario_p,
				nm_usuario_p, clock_timestamp(), clock_timestamp(),
				'6', tb_nr_seq_evento_w(i), tb_nr_seq_prest_w(i),
				0, tb_vl_divida_w(i), tb_vl_divida_w(i),
				tb_nr_seq_it_aprop_w(i), 0, 0,
				'N', tb_nr_seq_prest_w(i)
			);
		commit;
	end loop;
	close c02;
end loop;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_pp_apropriacao_pck.insere_item_apropriacao ( nr_id_transacao_p pls_pp_rp_aprop_selecao.nr_id_transacao%type, nr_seq_lote_p pls_pp_lote.nr_sequencia%type, nr_seq_regra_periodo_p pls_pp_lote.nr_seq_regra_periodo%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;
