-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pls_pp_apropriacao_pck.validar_campos_regra ( nr_seq_pp_it_aprop_p pls_pp_item_apropriacao.nr_sequencia%type, qt_pag_negativo_max_p pls_evento_regra_pag.qt_pag_sem_movimento%type, vl_minimo_titulo_p pls_evento_regra_pag.vl_minimo_titulo%type, vl_acao_negativo_p pls_pp_item_lote.vl_acao_negativo%type, ie_acao_neg_regra_p pls_evento.ie_saldo_negativo%type, ie_acao_neg_origi_p pls_evento.ie_saldo_negativo%type) RETURNS varchar AS $body$
DECLARE


qt_vezes_aprop_w	integer;
ie_valido_w		boolean;
ie_acao_pgto_neg_w	pls_evento.ie_saldo_negativo%type;


BEGIN
-- inicia as variáveis
ie_valido_w := true;

-- se tem a quantidade máxima de registros precisa verificar
if (qt_pag_negativo_max_p IS NOT NULL AND qt_pag_negativo_max_p::text <> '') then
	
	-- só precisa validar caso o registro já seja uma apropriacao
	if (nr_seq_pp_it_aprop_p IS NOT NULL AND nr_seq_pp_it_aprop_p::text <> '') then
		
		-- verifica a quantidade de vezes que este item apropriou, o campo ie_acao_negativo deve estar como S pois só com
		-- este valor é que o item vai estar ainda apropriando
		select	count(1)
		into STRICT	qt_vezes_aprop_w
		from	pls_pp_item_lote x
		where	x.nr_seq_pp_it_aprop = nr_seq_pp_it_aprop_p
		and	x.ie_acao_negativo = 'S';
		
		-- se ainda não apropriou a quantidade que está na regra então não é válida
		if (qt_vezes_aprop_w < qt_pag_negativo_max_p) then

			ie_valido_w := false;
		end if;
	-- se for para verificar a quantidade e não é apropriação ainda então a regra não é válida
	else
		ie_valido_w := false;
	end if;
end if;

-- se precisa verificar o valor minimo para gerar o titulo e o valor do título é menor que
-- o informado na regra então não é válida
if (vl_minimo_titulo_p IS NOT NULL AND vl_minimo_titulo_p::text <> '') and (vl_minimo_titulo_p > vl_acao_negativo_p) then

	ie_valido_w := false;
end if;

-- se a regra é válida então a ação para pagamento é a informada na regra
if (ie_valido_w) then

	ie_acao_pgto_neg_w := ie_acao_neg_regra_p;

-- senão é a informada no evento/prestador
else

	ie_acao_pgto_neg_w := ie_acao_neg_origi_p;
end if;

return ie_acao_pgto_neg_w;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pls_pp_apropriacao_pck.validar_campos_regra ( nr_seq_pp_it_aprop_p pls_pp_item_apropriacao.nr_sequencia%type, qt_pag_negativo_max_p pls_evento_regra_pag.qt_pag_sem_movimento%type, vl_minimo_titulo_p pls_evento_regra_pag.vl_minimo_titulo%type, vl_acao_negativo_p pls_pp_item_lote.vl_acao_negativo%type, ie_acao_neg_regra_p pls_evento.ie_saldo_negativo%type, ie_acao_neg_origi_p pls_evento.ie_saldo_negativo%type) FROM PUBLIC;
