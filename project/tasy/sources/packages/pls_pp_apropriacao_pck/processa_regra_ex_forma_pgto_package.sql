-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pls_pp_apropriacao_pck.processa_regra_ex_forma_pgto ( nr_seq_pp_it_aprop_p pls_pp_item_apropriacao.nr_sequencia%type, vl_acao_negativo_p pls_pp_item_lote.vl_acao_negativo%type, dt_referente_p timestamp, nr_seq_evento_p pls_evento.nr_sequencia%type, nr_seq_prestador_p pls_prestador.nr_sequencia%type, ie_acao_pgto_neg_p pls_evento.ie_saldo_negativo%type) RETURNS varchar AS $body$
DECLARE


ie_acao_pgto_neg_reg_w	pls_evento.ie_saldo_negativo%type;
ie_excecao_valida_w	boolean;

c01 CURSOR(	dt_referente_pc		timestamp,
		nr_seq_evento_pc	pls_evento.nr_sequencia%type) FOR
	SELECT	a.nr_seq_prestador,
		a.qt_pag_sem_movimento,
		a.vl_minimo_titulo
	from	pls_evento_regra_pag a
	where	a.nr_seq_evento = nr_seq_evento_pc
	and	dt_referente_pc between a.dt_inicio_vigencia_ref and a.dt_fim_vigencia_ref
	order by coalesce(a.nr_seq_prestador, 0) desc,
		coalesce(a.qt_pag_sem_movimento, 0) desc;

BEGIN

-- alimenta a ação do evento como sendo a correta, pois caso não encontre nenhuma regra válida essa deverá ser a
-- ação correta a ser tomada, seja ela Aproprição ou Título
ie_acao_pgto_neg_reg_w := ie_acao_pgto_neg_p;

for r_c01_w in c01(dt_referente_p, nr_seq_evento_p) loop

	-- a regra de exceção sempre inicia sendo válida, caso caia em algum IF ela não é válida
	ie_excecao_valida_w := True;

	-- se o campo não estiver nulo e for diferente do prestador que estamos verificando
	if (r_c01_w.nr_seq_prestador IS NOT NULL AND r_c01_w.nr_seq_prestador::text <> '') and (r_c01_w.nr_seq_prestador != nr_seq_prestador_p) then

		ie_excecao_valida_w := False;
	end if;

	-- se a exceção é válida então invertemos a ação, apropriação passa a ser gerar título e gerar título
	-- passa a ser apropriação, basta que uma regra de exceção case para realizar esta alteração, então saimos do cursor
	if (ie_excecao_valida_w) then

		if (ie_acao_pgto_neg_p = 'PP') then

			-- se estivermos verificando um evento onde a ação é apropriação temos alguns campos que devem ser observados para verificar
			-- se irá ou não gerar o título, estes campos são verificados dentro da rotina
			ie_acao_pgto_neg_reg_w := pls_pp_apropriacao_pck.validar_campos_regra(	nr_seq_pp_it_aprop_p, r_c01_w.qt_pag_sem_movimento,
									r_c01_w.vl_minimo_titulo, vl_acao_negativo_p,
									'TR', ie_acao_pgto_neg_p);
		else

			ie_acao_pgto_neg_reg_w := 'PP';
		end if;
		
		exit;
	end if;
end loop;

return ie_acao_pgto_neg_reg_w;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pls_pp_apropriacao_pck.processa_regra_ex_forma_pgto ( nr_seq_pp_it_aprop_p pls_pp_item_apropriacao.nr_sequencia%type, vl_acao_negativo_p pls_pp_item_lote.vl_acao_negativo%type, dt_referente_p timestamp, nr_seq_evento_p pls_evento.nr_sequencia%type, nr_seq_prestador_p pls_prestador.nr_sequencia%type, ie_acao_pgto_neg_p pls_evento.ie_saldo_negativo%type) FROM PUBLIC;
