-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

-----------------
CREATE OR REPLACE FUNCTION pck_cdsdvt_report.get_agv_padua_score (start_date_p timestamp, end_date_p timestamp, cd_setor_p text, ds_age_p text, nr_week_p bigint) RETURNS bigint AS $body$
DECLARE


       nr_padua_score_w    bigint;
       qt_reg_w            bigint;

       c1 CURSOR FOR
        SELECT distinct a.nr_atendimento nr_atendimento
          from gqa_protocolo_pac       a,
              gqa_protocolo_etapa_pac b,
              atendimento_paciente    c,
              setor_atendimento       d,
              usuario_setor u,
              atend_paciente_unidade n
        where a.nr_sequencia = b.nr_seq_prot_pac
          and c.nr_atendimento = a.nr_atendimento
          and d.cd_setor_atendimento = u.cd_setor_atendimento
          and n.cd_setor_atendimento = d.cd_setor_atendimento
          and c.nr_atendimento = n.nr_atendimento
          and n.nr_seq_interno = Obter_Atepacu_paciente(a.nr_atendimento, 'A')
          and a.nr_seq_protocolo = pkg_report_data.get_protocol(2,a.nr_seq_protocolo)--1304
          and d.cd_classif_setor <> 4
          and to_char(b.dt_atualizacao, 'WW') = nr_week_p
          and ((coalesce(cd_setor_p::text, '') = '') or (obter_se_contido(d.cd_setor_atendimento, cd_setor_p) = 'S'))
          and d.ie_situacao = 'A'
          and u.nm_usuario_param = wheb_usuario_pck.get_nm_usuario
          and b.dt_atualizacao between start_date_p and end_date_p
          and (obter_idade_pf(c.cd_pessoa_fisica, clock_timestamp(), 'A') >= 18 or ds_age_p = 'X');

       r1 c1%rowtype;

       c2 CURSOR FOR
          SELECT qt_score
            from ESCALA_PADUA a
           where a.nr_atendimento = r1.nr_atendimento
           order by a.dt_avaliacao asc;

       r2 c2%rowtype;


BEGIN
       nr_padua_score_w := 0;
       qt_reg_w := 0;

       --Abre cursor principal
       open c1;
       loop
          fetch c1
             into r1;
          EXIT WHEN NOT FOUND; /* apply on c1 */

          qt_reg_w := qt_reg_w + 1;

          open c2;
          fetch c2 into r2;

             nr_padua_score_w := nr_padua_score_w + r2.qt_score;

          close c2;

       end loop;
       close c1;

       --
       if (qt_reg_w = 0) then
          qt_reg_w := 1;
       end if;

       --
       return ceil(nr_padua_score_w/qt_reg_w);

    END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pck_cdsdvt_report.get_agv_padua_score (start_date_p timestamp, end_date_p timestamp, cd_setor_p text, ds_age_p text, nr_week_p bigint) FROM PUBLIC;
