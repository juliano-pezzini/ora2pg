-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


   -----------------
CREATE OR REPLACE FUNCTION pck_cdsdvt_report.get_avg_daily_census (start_date_p timestamp, end_date_p timestamp, cd_setor_p text, nr_week_p bigint) RETURNS bigint AS $body$
DECLARE


      qtd_dias_w bigint;


BEGIN

      begin

        select count(1)
          into STRICT qtd_dias_w
          from (SELECT greatest(min(u.dt_entrada_unidade), pkg_atend_pac_unid.get_sys_dt(s.cd_estabelecimento, start_date_p)) dt_entrada,
                      least(coalesce(pkg_atend_pac_unid.get_max_exit_unit(u.nr_atendimento, u.dt_entrada_unidade, u.cd_setor_atendimento),
                                pkg_atend_pac_unid.get_sys_dt(s.cd_estabelecimento, least(end_date_p + 1, clock_timestamp()))),
                            pkg_atend_pac_unid.get_sys_dt(s.cd_estabelecimento, least(end_date_p + 1, clock_timestamp()))) dt_saida
                  from atend_paciente_unidade u,
                      setor_atendimento s,
                      usuario_setor r
                where s.cd_setor_atendimento = u.cd_setor_atendimento
                  and s.cd_setor_atendimento = r.cd_setor_atendimento
                  and ((coalesce(cd_setor_p::text, '') = '') or (obter_se_contido(u.cd_setor_atendimento, cd_setor_p) = 'S'))
                  and s.ie_situacao = 'A'
                  and r.nm_usuario_param = wheb_usuario_pck.get_nm_usuario
                  and u.ie_passagem_setor not in ('S', 'l')
                  and s.cd_classif_setor not in ('6', '7', '10')
                  and to_char(u.dt_entrada_unidade, 'WW') = nr_week_p
                  and u.dt_entrada_unidade < pkg_atend_pac_unid.get_sys_dt(s.cd_estabelecimento, least(end_date_p + 1, clock_timestamp()))
                  and coalesce(pkg_atend_pac_unid.get_max_exit_unit(u.nr_atendimento, u.dt_entrada_unidade, u.cd_setor_atendimento),
                          pkg_atend_pac_unid.get_sys_dt(s.cd_estabelecimento, start_date_p)) >= pkg_atend_pac_unid.get_sys_dt(s.cd_estabelecimento, start_date_p)
                group by u.nr_atendimento,
                          s.cd_estabelecimento,
                          u.cd_setor_atendimento,
                          pkg_atend_pac_unid.get_max_exit_unit(u.nr_atendimento,
                                                              u.dt_entrada_unidade,
                                                              u.cd_setor_atendimento)) t;

      exception
         when others then
            qtd_dias_w := 0;
      end;

      return coalesce(qtd_dias_w, 0);

   END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pck_cdsdvt_report.get_avg_daily_census (start_date_p timestamp, end_date_p timestamp, cd_setor_p text, nr_week_p bigint) FROM PUBLIC;
