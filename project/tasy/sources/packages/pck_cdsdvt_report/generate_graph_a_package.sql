-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


  -- Grafico A (Encounter Count/Clinical Unit.)
CREATE OR REPLACE FUNCTION pck_cdsdvt_report.generate_graph_a (dt_ini_p timestamp, dt_fim_p timestamp, cd_unidade_p text, ds_age_p text) RETURNS boolean AS $body$
DECLARE

  --
  c1 CURSOR FOR
   SELECT substr(obter_nome_setor(obter_setor_atendimento(c.nr_atendimento)),1,255) label,
       count(c.nr_atendimento) valor
   from gqa_protocolo_pac       a,
         gqa_protocolo_etapa_pac b,
         atendimento_paciente    c,
         atend_paciente_unidade d,
         setor_atendimento       s,
         usuario_setor u
   where a.nr_sequencia = b.nr_seq_prot_pac
     and c.nr_atendimento = a.nr_atendimento
     and s.cd_setor_atendimento = u.cd_setor_atendimento
     and s.cd_setor_atendimento = d.cd_setor_atendimento
     and c.nr_atendimento = d.nr_atendimento
     and d.nr_seq_interno = Obter_Atepacu_paciente(a.nr_atendimento, 'A')
     and a.nr_seq_protocolo = pkg_report_data.get_protocol(2,a.nr_seq_protocolo)--1304
     and ((coalesce(cd_unidade_p::text, '') = '') or (obter_se_contido(s.cd_setor_atendimento, cd_unidade_p) = 'S'))
     and s.ie_situacao = 'A'
     and u.nm_usuario_param = wheb_usuario_pck.get_nm_usuario
     and s.cd_classif_setor = 4
     and b.dt_atualizacao between dt_ini_p and dt_fim_p
     and (obter_idade_pf(c.cd_pessoa_fisica, clock_timestamp(), 'A') >= 18 or ds_age_p = 'X')
   group by obter_setor_atendimento(c.nr_atendimento)
   order by 1;

  r1 c1%rowtype;

BEGIN
  --Limpa tabelas
  delete FROM dvt_critical_care_graph;

  --Abre cursor principal
  open c1;
  loop
      fetch c1 into r1;
      EXIT WHEN NOT FOUND; /* apply on c1 */

      insert into dvt_critical_care_graph(ds_label,nr_valor)
      values (r1.label, r1.valor);

  end loop;
  close c1;

  --
  return true;
  END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pck_cdsdvt_report.generate_graph_a (dt_ini_p timestamp, dt_fim_p timestamp, cd_unidade_p text, ds_age_p text) FROM PUBLIC;
