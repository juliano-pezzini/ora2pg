-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


   ----------
CREATE OR REPLACE PROCEDURE pck_cdsdvt_report.get_data_uti (dt_ini_p timestamp, dt_fim_p timestamp, cd_unidade_p text, ds_age_p text, ie_relatorio_p text) AS $body$
DECLARE


      nr_avg_daily_census_w     w_cdsdvt_report.nr_avg_daily_census%type;
      nr_exclude_bundle_w       w_cdsdvt_report.nr_exclude_bundle%type;
      nr_appropriate_tratment_w w_cdsdvt_report.nr_appropriate_tratment%type;
      nr_incorrect_tratment_w   w_cdsdvt_report.nr_incorrect_tratment %type;
      nr_agv_impprove_score_w   w_cdsdvt_report.nr_agv_impprove_score%type;
      nr_agv_padua_score_w      w_cdsdvt_report.nr_agv_padua_score%type;

      --
      c1 CURSOR FOR
        SELECT obter_setor_atendimento(c.nr_atendimento) cd_setor,
              to_char(b.dt_atualizacao, 'WW') nr_week,
              ceil(count(b.nr_sequencia) / 7) nr_avg_daily_census
        from gqa_protocolo_pac       a,
              gqa_protocolo_etapa_pac b,
              atendimento_paciente    c,
              atend_paciente_unidade d,
              setor_atendimento s,
              usuario_setor u
        where a.nr_sequencia = b.nr_seq_prot_pac
          and c.nr_atendimento = a.nr_atendimento
          and s.cd_setor_atendimento = u.cd_setor_atendimento
          and s.cd_setor_atendimento = d.cd_setor_atendimento
          and c.nr_atendimento = d.nr_atendimento
          and d.nr_seq_interno = Obter_Atepacu_paciente(a.nr_atendimento, 'A')
          and a.nr_seq_protocolo = pkg_report_data.get_protocol(2,a.nr_seq_protocolo)--1304
          and ((coalesce(cd_unidade_p::text, '') = '') or (obter_se_contido(s.cd_setor_atendimento, cd_unidade_p) = 'S'))
          and s.ie_situacao = 'A'
          and u.nm_usuario_param = wheb_usuario_pck.get_nm_usuario
          and ((s.cd_classif_setor = 4 and ie_relatorio_p = 1) or (s.cd_classif_setor <> 4 and ie_relatorio_p <> 1))
          and b.dt_atualizacao between dt_ini_p and dt_fim_p
          and (obter_idade_pf(c.cd_pessoa_fisica, clock_timestamp(), 'A') >= 18 or ds_age_p = 'X')
        group by obter_setor_atendimento(c.nr_atendimento),
                  to_char(b.dt_atualizacao, 'WW');

      r1 c1%rowtype;
      graph_generate boolean := false;
      graph_generate_b boolean := false;

BEGIN
   
      --Limpa tabela W
      delete FROM w_cdsdvt_report;

      --Abre cursor principal
      open c1;
      loop
         fetch c1
            into r1;
         EXIT WHEN NOT FOUND; /* apply on c1 */

         --
         nr_avg_daily_census_w := pck_cdsdvt_report.get_avg_daily_census(dt_ini_p,
                                                       dt_fim_p,
                                                       cd_unidade_p,
                                                       r1.nr_week);

         --
         nr_appropriate_tratment_w := pck_cdsdvt_report.get_appropriate_tratment(dt_ini_p,
                                                               dt_fim_p,
                                                               cd_unidade_p,
                                                               ds_age_p,
                                                               r1.nr_week);

         --
         nr_incorrect_tratment_w := pck_cdsdvt_report.get_incorrect_tratment(dt_ini_p,
                                                           dt_fim_p,
                                                           cd_unidade_p,
                                                           ds_age_p,
                                                           r1.nr_week);

         --
         nr_agv_impprove_score_w := pck_cdsdvt_report.get_agv_impprove_score(dt_ini_p,
                                                           dt_fim_p,
                                                           cd_unidade_p,
                                                           ds_age_p,
                                                           r1.nr_week);

         --
         if (ie_relatorio_p <> 1) then
            nr_agv_padua_score_w := pck_cdsdvt_report.get_agv_padua_score(dt_ini_p,
                                                        dt_fim_p,
                                                        cd_unidade_p,
                                                        ds_age_p,
                                                        r1.nr_week);
         end if;


         --Patients excluded from bundle.
         select count(a.nr_atendimento)
           into STRICT nr_exclude_bundle_w
           from gqa_protocolo_pac       a,
                gqa_protocolo_etapa_pac b,
                atendimento_paciente    c,
                atend_paciente_unidade d,
                usuario_setor u,
                setor_atendimento s
          where a.nr_sequencia = b.nr_seq_prot_pac
            and c.nr_atendimento = a.nr_atendimento
            and c.nr_atendimento = d.nr_atendimento
            and s.cd_setor_atendimento = u.cd_setor_atendimento
            and d.cd_setor_atendimento = s.cd_setor_atendimento
            and d.nr_seq_interno = Obter_Atepacu_paciente(a.nr_atendimento, 'A')
            and a.nr_seq_protocolo = pkg_report_data.get_protocol(2,a.nr_seq_protocolo)--1304
            and b.nr_seq_etapa = pkg_report_data.get_stage(14,b.nr_seq_etapa)--= 3327
            and b.qt_resultado = 0
            and b.dt_atualizacao between dt_ini_p and dt_fim_p
            and ((coalesce(cd_unidade_p::text, '') = '') or (obter_se_contido(d.cd_setor_atendimento, cd_unidade_p) = 'S'))
            and s.ie_situacao = 'A'
            and s.cd_classif_setor not in ('6', '7', '10')
            and u.nm_usuario_param = wheb_usuario_pck.get_nm_usuario
            and (obter_idade_pf(c.cd_pessoa_fisica, clock_timestamp(), 'A') >= 18 or  ds_age_p = 'X')
            and to_char(b.dt_atualizacao, 'WW') = r1.nr_week;

         --Patients receiving prophylaxis but of the wrong type / combination
         insert into w_cdsdvt_report(nm_usuario,
             dt_atualizacao,
             cd_unidade,
             nr_week,
             nr_avg_daily_census,
             nr_exclude_bundle,
             nr_appropriate_tratment,
             nr_incorrect_tratment,
             nr_agv_impprove_score,
             nr_agv_padua_score)
         values (wheb_usuario_pck.get_nm_usuario,
             clock_timestamp(),
             r1.cd_setor,
             r1.nr_week,
             nr_avg_daily_census_w,
             nr_exclude_bundle_w,
             nr_appropriate_tratment_w,
             nr_incorrect_tratment_w,
             nr_agv_impprove_score_w,
             nr_agv_padua_score_w);

      end loop;
      close c1;

      graph_generate := pck_cdsdvt_report.generate_graph_a(dt_ini_p,dt_fim_p,cd_unidade_p,ds_age_p);
      graph_generate_b := pck_cdsdvt_report.generate_graph_b(dt_ini_p,dt_fim_p,cd_unidade_p,ds_age_p);
      --
      commit;

      return;

   END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pck_cdsdvt_report.get_data_uti (dt_ini_p timestamp, dt_fim_p timestamp, cd_unidade_p text, ds_age_p text, ie_relatorio_p text) FROM PUBLIC;
