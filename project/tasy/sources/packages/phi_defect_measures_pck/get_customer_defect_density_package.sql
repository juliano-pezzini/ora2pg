-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION phi_defect_measures_pck.get_customer_defect_density ( dt_referencia_p timestamp, ie_opcao_p text default 'R') RETURNS bigint AS $body$
DECLARE


qtd_customer_defects_w		double precision;
qtd_loc_w			double precision;
dt_ref_mes_w			timestamp;
dt_fim_mes_w			timestamp;
customer_defect_density_w	double precision;

/*
ie_opcao_p
D	= Customer Defect Number
L	= KPI Lines Kaloc
R	= Result
*/
ie_opcao_w			varchar(1);


BEGIN

dt_ref_mes_w	:= pkg_date_utils.start_of(dt_referencia_p, 'MONTH', 0);
dt_fim_mes_w	:= pkg_date_utils.end_of(dt_ref_mes_w, 'MONTH', 0);
ie_opcao_w	:= coalesce(upper(ie_opcao_p),'R');

select	sum(klk.qt_modified) + sum(klk.qt_added) + sum(klk.qt_deleted) qtd_loc
into STRICT	qtd_loc_w
from 	kpi_lines_kaloc klk
where	trunc(klk.dt_atualizacao, 'MONTH') = dt_ref_mes_w
and 	klk.ds_branch in ('tasy-plsql-objects','tasy','tasy-backend','tasy-plsql');

select	count(distinct a.nr_sequencia)
into STRICT	qtd_customer_defects_w
from	os_erro_gerencia_v a
where	a.dt_liberacao between dt_ref_mes_w and dt_fim_mes_w
 and	(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
 and	a.ie_plataforma = 'H'
 and	a.ie_ident_erro    <> 'W'
 and	((exists	(SELECT	1
			 from	proj_projeto x
			 where	x.nr_sequencia = a.nr_seq_proj_def
			  and	((x.dt_fim_real IS NOT NULL AND x.dt_fim_real::text <> '')
			  and (obter_dias_entre_datas(x.dt_fim_real,a.dt_ordem_servico) > 120))))
	or (coalesce(a.nr_seq_proj_def::text, '') = ''));

customer_defect_density_w := (dividir_sem_round(qtd_customer_defects_w,qtd_loc_w)*1000);

if (ie_opcao_w = 'D') then
	return	qtd_customer_defects_w;
elsif (ie_opcao_w = 'L')then
	return	qtd_loc_w;
else
	return	customer_defect_density_w;
end if;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION phi_defect_measures_pck.get_customer_defect_density ( dt_referencia_p timestamp, ie_opcao_p text default 'R') FROM PUBLIC;
