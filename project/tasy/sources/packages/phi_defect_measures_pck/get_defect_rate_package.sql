-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION phi_defect_measures_pck.get_defect_rate ( dt_referencia_p timestamp, nr_seq_dir_p bigint default null, nr_seq_gerencia_p bigint default null, nr_seq_grupo_des_p bigint default null, nr_seq_grupo_sup_p bigint default null, ie_opcao_p text default 'R') RETURNS bigint AS $body$
DECLARE


qtd_total_defeitos_w		double precision;
qtd_localizacoes_unicas_w	double precision;
nr_seq_dir_w			diretoria_philips.nr_sequencia%type := nr_seq_dir_p;
nr_seq_gerencia_w		gerencia_wheb.nr_sequencia%type := nr_seq_gerencia_p;
nr_seq_grupo_sup_w		man_ordem_servico.nr_seq_grupo_sup%type := nr_seq_grupo_sup_p;
nr_seq_grupo_des_w		man_ordem_servico.nr_seq_grupo_des%type := nr_seq_grupo_des_p;
nr_seq_history_w		w_defect_rate_history.nr_sequencia%type;
dt_ref_mes_w			timestamp;
dt_fim_mes_w			timestamp;
defect_rate_w			double precision;

/*
ie_opcao_p
D	= Defect Service Order Number
L	= Unique Localization Number
R	= Result
*/
ie_opcao_w			varchar(1);


BEGIN

dt_ref_mes_w	:= pkg_date_utils.start_of(dt_referencia_p, 'MONTH', 0);
dt_fim_mes_w	:= pkg_date_utils.end_of(dt_ref_mes_w, 'MONTH', 0);
ie_opcao_w	:= coalesce(upper(ie_opcao_p),'R');

select	max(nr_sequencia)
into STRICT	nr_seq_history_w
from	w_defect_rate_history
where	trunc(dt_referencia) = trunc(dt_fim_mes_w);

if (nr_seq_history_w IS NOT NULL AND nr_seq_history_w::text <> '') then

	select	count(1) qtd,
		count(distinct drh.nr_seq_localizacao) qtd_loc
	into STRICT	qtd_total_defeitos_w,
		qtd_localizacoes_unicas_w
	from	w_defect_rate_history drh
	where	trunc(drh.dt_referencia) = trunc(dt_fim_mes_w)
	 and (drh.nr_seq_grupo_sup = nr_seq_grupo_sup_w or coalesce(nr_seq_grupo_sup_w,0) = 0 )
	 and (drh.nr_seq_grupo_des = nr_seq_grupo_des_w or coalesce(nr_seq_grupo_des_w,0) = 0 )
	 and (somente_numero(obter_gerencia_grupo_desen(drh.nr_seq_grupo_des,'C')) = nr_seq_gerencia_w
		or
		somente_numero(obter_gerencia_grupo_sup(drh.nr_seq_grupo_sup,'C')) = nr_seq_gerencia_w
		or
		coalesce(nr_seq_gerencia_w,0) = 0)
	 and (somente_numero(phi_defect_measures_pck.get_philips_board(somente_numero(obter_gerencia_grupo_desen(drh.nr_seq_grupo_des,'C')),'C')) = nr_seq_dir_w
		or
		somente_numero(phi_defect_measures_pck.get_philips_board(somente_numero(obter_gerencia_grupo_sup(drh.nr_seq_grupo_sup,'C')),'C')) = nr_seq_dir_w
		or
		coalesce(nr_seq_dir_w,0) = 0
		);

else

	select	count(1) qtd,
		count(distinct mos.nr_seq_localizacao) qtd_loc
	into STRICT	qtd_total_defeitos_w,
		qtd_localizacoes_unicas_w
	from	man_ordem_servico mos
	where	1=1
	 and	mos.ie_origem = 'E'
	 and	mos.ie_classificacao_cliente = 'E'
	 and	mos.ie_classificacao = 'E'
	 and	mos.dt_ordem_servico between dt_ref_mes_w and dt_fim_mes_w
	 and (mos.nr_seq_grupo_sup = nr_seq_grupo_sup_w or coalesce(nr_seq_grupo_sup_w,0) = 0 )
	 and (mos.nr_seq_grupo_des = nr_seq_grupo_des_w or coalesce(nr_seq_grupo_des_w,0) = 0 )
	 and	somente_numero(phi_defect_measures_pck.get_philips_board(somente_numero(obter_gerencia_grupo_desen(mos.nr_seq_grupo_des,'C')),'C')) not in (16)
	 and	coalesce(phi_defect_measures_pck.get_management_area(somente_numero(obter_gerencia_grupo_desen(mos.nr_seq_grupo_des,'C'))),0) in ('DES','DEC','PDES','TEC')
	 and (somente_numero(obter_gerencia_grupo_desen(mos.nr_seq_grupo_des,'C')) = nr_seq_gerencia_w
		or
		somente_numero(obter_gerencia_grupo_sup(mos.nr_seq_grupo_sup,'C')) = nr_seq_gerencia_w
		or
		coalesce(nr_seq_gerencia_w,0) = 0)
	 and (somente_numero(phi_defect_measures_pck.get_philips_board(somente_numero(obter_gerencia_grupo_desen(mos.nr_seq_grupo_des,'C')),'C')) = nr_seq_dir_w
		or
		somente_numero(phi_defect_measures_pck.get_philips_board(somente_numero(obter_gerencia_grupo_sup(mos.nr_seq_grupo_sup,'C')),'C')) = nr_seq_dir_w
		or
		coalesce(nr_seq_dir_w,0) = 0
		);

end if;

defect_rate_w := (dividir_sem_round(qtd_total_defeitos_w,qtd_localizacoes_unicas_w));

if (ie_opcao_w = 'D') then
	return	qtd_total_defeitos_w;
elsif (ie_opcao_w = 'L')then
	return	qtd_localizacoes_unicas_w;
else
	return	defect_rate_w;
end if;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION phi_defect_measures_pck.get_defect_rate ( dt_referencia_p timestamp, nr_seq_dir_p bigint default null, nr_seq_gerencia_p bigint default null, nr_seq_grupo_des_p bigint default null, nr_seq_grupo_sup_p bigint default null, ie_opcao_p text default 'R') FROM PUBLIC;
