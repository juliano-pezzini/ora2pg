-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION phi_defect_measures_pck.get_accumulated_indicator ( dt_referencia_p timestamp, nr_seq_dir_p bigint default null, nr_seq_gerencia_p bigint default null, nr_seq_grupo_des_p bigint default null, ie_opcao_p text default null) RETURNS bigint AS $body$
DECLARE


nr_seq_dir_w		diretoria_philips.nr_sequencia%type := nr_seq_dir_p;
nr_seq_gerencia_w	gerencia_wheb.nr_sequencia%type := nr_seq_gerencia_p;
nr_seq_grupo_des_w	man_ordem_servico.nr_seq_grupo_des%type := nr_seq_grupo_des_p;
dt_ref_mes_w		timestamp;
indicator_result_w	double precision := 0;
acumulated_indicator_w	double precision := 0;
mes_ref_w		bigint;
ano_ref_w		bigint;
mes_incremento_w	bigint := 1;

/*
ie_opcao_p:
DRA	= Defect Rate
CDD	= Customer Defect Density
IDD	= Internal Defect Density
*/
BEGIN

if (ie_opcao_p IS NOT NULL AND ie_opcao_p::text <> '') then

	mes_ref_w		:= extract(month from dt_referencia_p);
	ano_ref_w		:= extract(year from dt_referencia_p);

	<<month_loop>>
	for i in mes_incremento_w..mes_ref_w

	loop

		dt_ref_mes_w	:= pkg_date_utils.get_date(ano_ref_w,mes_incremento_w,1);
		dt_ref_mes_w	:= pkg_date_utils.end_of(dt_ref_mes_w, 'MONTH', 0);

		if (ie_opcao_p = 'DRA') then

			select	phi_defect_measures_pck.get_defect_rate(dt_ref_mes_w,
									nr_seq_dir_w,
									nr_seq_gerencia_w,
									nr_seq_grupo_des_w)
			into STRICT	indicator_result_w
			;

			acumulated_indicator_w	:= acumulated_indicator_w + indicator_result_w;
			mes_incremento_w	:= mes_incremento_w + 1;

		elsif (ie_opcao_p = 'CDD') then

			select	phi_defect_measures_pck.get_customer_defect_density(dt_ref_mes_w)
			into STRICT	indicator_result_w
			;

			acumulated_indicator_w	:= acumulated_indicator_w + indicator_result_w;
			mes_incremento_w	:= mes_incremento_w + 1;

		elsif (ie_opcao_p = 'IDD') then

			select	phi_defect_measures_pck.get_internal_defect_density( dt_ref_mes_w)
			into STRICT	indicator_result_w
			;

			acumulated_indicator_w	:= acumulated_indicator_w + indicator_result_w;
			mes_incremento_w	:= mes_incremento_w + 1;

		else
			acumulated_indicator_w	:= 0;
		end if;

	end loop month_loop;

	acumulated_indicator_w		:= dividir_sem_round(acumulated_indicator_w,mes_ref_w);

end if;

return acumulated_indicator_w;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION phi_defect_measures_pck.get_accumulated_indicator ( dt_referencia_p timestamp, nr_seq_dir_p bigint default null, nr_seq_gerencia_p bigint default null, nr_seq_grupo_des_p bigint default null, ie_opcao_p text default null) FROM PUBLIC;
