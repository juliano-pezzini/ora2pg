-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE phi_defect_measures_pck.record_defect_rate_history ( dt_referencia_p timestamp, nm_usuario_p text default null) AS $body$
DECLARE


nr_seq_ordem_serv_w		man_ordem_servico.nr_sequencia%type;
ie_origem_w			man_ordem_servico.ie_origem%type;
ie_classificacao_cliente_w	man_ordem_servico.ie_classificacao_cliente%type;
ie_classificacao_w		man_ordem_servico.ie_classificacao%type;
dt_ordem_servico_w		man_ordem_servico.dt_ordem_servico%type;
nr_seq_grupo_des_w		man_ordem_servico.nr_seq_grupo_des%type;
nr_seq_grupo_sup_w		man_ordem_servico.nr_seq_grupo_sup%type;
nr_seq_localizacao_w		man_ordem_servico.nr_seq_localizacao%type;
nr_seq_gerencia_w		gerencia_wheb.nr_sequencia%type;
nr_seq_diretoria_w		diretoria_philips.nr_sequencia%type;
dt_ref_mes_w			timestamp;
dt_fim_mes_w			timestamp;
nm_usuario_w			usuario.nm_usuario%type := nm_usuario_p;

c01 CURSOR FOR
	SELECT	mos.nr_sequencia,
		mos.ie_origem,
		mos.ie_classificacao_cliente,
		mos.ie_classificacao,
		mos.dt_ordem_servico,
		mos.nr_seq_grupo_des,
		mos.nr_seq_grupo_sup,
		mos.nr_seq_localizacao
	from	man_ordem_servico mos
	where	1=1
	 and	mos.ie_origem = 'E'
	 and	mos.ie_classificacao_cliente = 'E'
	 and	mos.ie_classificacao = 'E'
	 and	mos.dt_ordem_servico between dt_ref_mes_w and dt_fim_mes_w
	 and	somente_numero(phi_defect_measures_pck.get_philips_board(somente_numero(obter_gerencia_grupo_desen(mos.nr_seq_grupo_des,'C')),'C')) not in (16)
	 and	coalesce(phi_defect_measures_pck.get_management_area(somente_numero(obter_gerencia_grupo_desen(mos.nr_seq_grupo_des,'C'))),0) in ('DES','DEC','PDES','TEC');


BEGIN

dt_ref_mes_w	:= pkg_date_utils.start_of(dt_referencia_p, 'MONTH', 0);
dt_fim_mes_w	:= pkg_date_utils.end_of(dt_ref_mes_w, 'MONTH', 0);
nm_usuario_w	:= coalesce(nm_usuario_w,'Tasy');

delete	FROM w_defect_rate_history
where	trunc(dt_referencia) = trunc(dt_fim_mes_w);

commit;

<<defect_rate_os_loop>>
open c01;
loop

	fetch c01 into
		nr_seq_ordem_serv_w,
		ie_origem_w,
		ie_classificacao_cliente_w,
		ie_classificacao_w,
		dt_ordem_servico_w,
		nr_seq_grupo_des_w,
		nr_seq_grupo_sup_w,
		nr_seq_localizacao_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */

	begin

		nr_seq_gerencia_w	:= somente_numero(obter_gerencia_grupo_desen(nr_seq_grupo_des_w,'C'));
		nr_seq_diretoria_w	:= somente_numero(phi_defect_measures_pck.get_philips_board(nr_seq_gerencia_w,'C'));

		insert into w_defect_rate_history(
			nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			dt_referencia,
			nr_seq_ordem_serv,
			ie_origem,
			ie_classificacao_cliente,
			ie_classificacao,
			dt_ordem_servico,
			nr_seq_grupo_des,
			nr_seq_grupo_sup,
			nr_seq_gerencia,
			nr_seq_diretoria,
			nr_seq_localizacao)
		values (
			nextval('w_defect_rate_history_seq'),
			clock_timestamp(),
			nm_usuario_w,
			clock_timestamp(),
			nm_usuario_w,
			trunc(dt_fim_mes_w),
			nr_seq_ordem_serv_w,
			ie_origem_w,
			ie_classificacao_cliente_w,
			ie_classificacao_w,
			dt_ordem_servico_w,
			nr_seq_grupo_des_w,
			nr_seq_grupo_sup_w,
			nr_seq_gerencia_w,
			nr_seq_diretoria_w,
			nr_seq_localizacao_w);

		commit;

	end;

end loop defect_rate_os_loop;
close c01;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE phi_defect_measures_pck.record_defect_rate_history ( dt_referencia_p timestamp, nm_usuario_p text default null) FROM PUBLIC;
