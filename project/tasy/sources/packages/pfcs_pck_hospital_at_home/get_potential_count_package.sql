-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pfcs_pck_hospital_at_home.get_potential_count (cd_establishment_p bigint) RETURNS bigint AS $body$
DECLARE

		nr_return_count_w		funcao_filtro.nr_seq_filtro%type;
	
BEGIN
		CALL pfcs_pck_hospital_at_home.set_potential_patient_filters();

		select	count(1)
		  into STRICT	nr_return_count_w
		  from	pfcs_hah_filter_v
		 where	nr_seq_operational_level = cd_establishment_p
		   and	(((current_setting('pfcs_pck_hospital_at_home.ie_checkbox_ed_w')::funcao_filtro.vl_campo%type = PFCS_PCK_CONSTANTS.IE_YES) and (ie_classification = PFCS_PCK_CONSTANTS.DS_ED)) or
				((current_setting('pfcs_pck_hospital_at_home.ie_checkbox_icu_w')::funcao_filtro.vl_campo%type = PFCS_PCK_CONSTANTS.IE_YES) and (ie_classification = PFCS_PCK_CONSTANTS.CD_ICU)) or
				((current_setting('pfcs_pck_hospital_at_home.ie_checkbox_acu_w')::funcao_filtro.vl_campo%type = PFCS_PCK_CONSTANTS.IE_YES) and (ie_classification = PFCS_PCK_CONSTANTS.CD_ACU)) or
				((current_setting('pfcs_pck_hospital_at_home.ie_checkbox_tcu_w')::funcao_filtro.vl_campo%type = PFCS_PCK_CONSTANTS.IE_YES) and (ie_classification = PFCS_PCK_CONSTANTS.CD_TCU)))
		   and	((current_setting('pfcs_pck_hospital_at_home.ds_diagnosis_w')::funcao_filtro.vl_campo%coalesce(type::text, '') = '') or (upper(current_setting('pfcs_pck_hospital_at_home.ds_diagnosis_w')::funcao_filtro.vl_campo%type) like PFCS_PCK_CONSTANTS.DS_PERCENT_SIGN||UPPER(ds_problem)||PFCS_PCK_CONSTANTS.DS_PERCENT_SIGN) and (ds_problem IS NOT NULL AND ds_problem::text <> ''))
		   and	((current_setting('pfcs_pck_hospital_at_home.qt_min_trs_w')::pfcs_detail_patient.qt_edi_score%coalesce(type::text, '') = '') or qt_trs >= current_setting('pfcs_pck_hospital_at_home.qt_min_trs_w')::pfcs_detail_patient.qt_edi_score%type)
		   and	((current_setting('pfcs_pck_hospital_at_home.qt_max_trs_w')::pfcs_detail_patient.qt_edi_score%coalesce(type::text, '') = '') or qt_trs <= current_setting('pfcs_pck_hospital_at_home.qt_max_trs_w')::pfcs_detail_patient.qt_edi_score%type)
		   and	((current_setting('pfcs_pck_hospital_at_home.qt_min_readmission_w')::coalesce(bigint::text, '') = '') or qt_readmission_risk >= current_setting('pfcs_pck_hospital_at_home.qt_min_readmission_w')::bigint)
		   and	((current_setting('pfcs_pck_hospital_at_home.qt_max_readmission_w')::coalesce(bigint::text, '') = '') or qt_readmission_risk <= current_setting('pfcs_pck_hospital_at_home.qt_max_readmission_w')::bigint)
		   and	((current_setting('pfcs_pck_hospital_at_home.ie_recurring_pat_w')::funcao_filtro.vl_campo%coalesce(type::text, '') = '') or ie_frequent_flyer = current_setting('pfcs_pck_hospital_at_home.ie_recurring_pat_w')::funcao_filtro.vl_campo%type)
		   and	((current_setting('pfcs_pck_hospital_at_home.ds_remaining_los_w')::funcao_filtro.vl_campo%coalesce(type::text, '') = '') or ds_remaining_los like current_setting('pfcs_pck_hospital_at_home.ds_remaining_los_w')::funcao_filtro.vl_campo%type)
		   and	((current_setting('pfcs_pck_hospital_at_home.ds_postal_code_w')::funcao_filtro.vl_campo%coalesce(type::text, '') = '') or (upper(current_setting('pfcs_pck_hospital_at_home.ds_postal_code_w')::funcao_filtro.vl_campo%type) like PFCS_PCK_CONSTANTS.DS_PERCENT_SIGN||UPPER(ds_postal_code)||PFCS_PCK_CONSTANTS.DS_PERCENT_SIGN) and (ds_postal_code IS NOT NULL AND ds_postal_code::text <> ''))
		   and	((current_setting('pfcs_pck_hospital_at_home.ds_marital_status_w')::funcao_filtro.vl_campo%coalesce(type::text, '') = '') or upper(ds_marital_status) = upper(current_setting('pfcs_pck_hospital_at_home.ds_marital_status_w')::funcao_filtro.vl_campo%type))
		   and	ds_gender = CASE WHEN current_setting('pfcs_pck_hospital_at_home.ds_gender_w')::funcao_filtro.vl_campo%type=PFCS_PCK_CONSTANTS.CD_MALE THEN  PFCS_PCK_CONSTANTS.CD_MALE WHEN current_setting('pfcs_pck_hospital_at_home.ds_gender_w')::funcao_filtro.vl_campo%type=PFCS_PCK_CONSTANTS.CD_FEMALE THEN  PFCS_PCK_CONSTANTS.CD_FEMALE  ELSE ds_gender END 
		   and	((current_setting('pfcs_pck_hospital_at_home.qt_min_age_w')::coalesce(bigint::text, '') = '') or qt_age >= PFCS_PCK_UTILS.get_age(current_setting('pfcs_pck_hospital_at_home.ds_age_unit_w')::funcao_filtro.vl_campo%type, current_setting('pfcs_pck_hospital_at_home.qt_min_age_w')::bigint))
		   and	((current_setting('pfcs_pck_hospital_at_home.qt_max_age_w')::coalesce(bigint::text, '') = '') or qt_age <= PFCS_PCK_UTILS.get_age(current_setting('pfcs_pck_hospital_at_home.ds_age_unit_w')::funcao_filtro.vl_campo%type, current_setting('pfcs_pck_hospital_at_home.qt_max_age_w')::bigint));

		return nr_return_count_w;
	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pfcs_pck_hospital_at_home.get_potential_count (cd_establishment_p bigint) FROM PUBLIC;
