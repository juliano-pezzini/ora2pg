-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION sql_pck.obter_bind_sql ( ds_sql_p text) RETURNS SQL_PCK.T_VARCHAR2_TABLE_BIND AS $body$
DECLARE

/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade:	Recebe um comando sql e devolve o nome das binds contidas nele
-------------------------------------------------------------------------------------------------------------------
Locais de chamada direta:
[X]  Objetos do dicionário [ ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatórios [ ] Outros:
-------------------------------------------------------------------------------------------------------------------
Pontos de atenção:

Alterações:
 ------------------------------------------------------------------------------------------------------------------
 usuario OS XXXXXX 01/01/2000 -
 Alteração:	Descrição da alteração.
Motivo:	Descrição do motivo.
 ------------------------------------------------------------------------------------------------------------------
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
qt_registro_w		integer;
tb_bind_w		sql_pck.t_varchar2_table_bind;
-- jjung - Alterado a string de início para utilizar o regexp_str e não considerar binds erroneamente
-- nas strings da cláusula select, como por exemplo select 'Valor total:' || sum(vl_total) vl_total
str_inicio_bind_w	varchar(100) := ':[a-z|A-Z|_|:|0-9]';
ds_sql_temp_w		varchar(32000);
nr_pos_ini_w		integer;
nr_pos_fim_w		integer;


BEGIN
qt_registro_w := 0;
tb_bind_w.delete;
ds_sql_temp_w := ds_sql_p;
--busca a primeira ocorrência do caracter : que significa que existe um bind
nr_pos_ini_w := regexp_instr(ds_sql_temp_w, str_inicio_bind_w);

-- busca todos os caracteres dois pontos
while(nr_pos_ini_w > 0) loop
	-- elimina todo o comando sql anterior ao caracter :
	ds_sql_temp_w := substr(ds_sql_temp_w, nr_pos_ini_w);
	-- retorna a posição do último caracter da bind buscando desde o início com os dois pontos até algum espaço ou quebra de linha, etc.
	-- a tradução seria: me retorne a posição de qualquer caracter que não for letra, _ : número ou que tenha chegado o fim do arquivo
	nr_pos_fim_w := regexp_instr(ds_sql_temp_w,'[^a-z|A-Z|_|:|0-9]|$');

	-- retorna o nome da bind
	-- é usado o menos 1 para desconsiderar o caracter que foi encontrado (espaço em branco, quebra de linha, etc.)
	-- coloca tudo em caixa baixa para facilitar comparações futuras
	tb_bind_w(qt_registro_w) := lower(substr(ds_sql_temp_w, 0, nr_pos_fim_w - 1));

	-- elimina todo o comando sql anterior com a última bind
	ds_sql_temp_w := substr(ds_sql_temp_w, nr_pos_fim_w + 1);

	nr_pos_ini_w := regexp_instr(ds_sql_temp_w, str_inicio_bind_w);
	qt_registro_w := qt_registro_w + 1;
end loop;

return tb_bind_w;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION sql_pck.obter_bind_sql ( ds_sql_p text) FROM PUBLIC;
