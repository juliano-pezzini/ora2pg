-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_reembolso_pck.preenche_inf_lote ( nr_id_transacao_p pls_lote_titulo_reembolso.nr_sequencia%type) AS $body$
DECLARE


tb_nr_seq_lote_titulo_w		dbms_sql.number_table;
tb_nr_seq_protocolo_w		dbms_sql.number_table;
tb_ie_tipo_resp_credito_w	dbms_sql.varchar2_table;
tb_nr_seq_segurado_w		dbms_sql.number_table;
tb_cd_pessoa_fisica_w		dbms_sql.varchar2_table;
tb_nr_contrato_principal_w	dbms_sql.number_table;
tb_nr_seq_subestipulante_w	dbms_sql.number_table;
tb_cd_cgc_estipulante_cont_w	dbms_sql.varchar2_table;
tb_cd_pf_estipulante_cont_w	dbms_sql.varchar2_table;
tb_cd_cgc_estipulante_pag_w	dbms_sql.varchar2_table;
tb_cd_pf_estipulante_pag_w	dbms_sql.varchar2_table;
tb_nr_seq_titular_w		dbms_sql.number_table;
tb_cd_pf_prot_w			dbms_sql.varchar2_table;
tb_cd_cgc_w			dbms_sql.varchar2_table;
tb_cd_pf_w			dbms_sql.varchar2_table;

c01 CURSOR(	nr_id_transacao_pc	pls_lote_titulo_reembolso.nr_sequencia%type) FOR
	SELECT	a.nr_sequencia nr_seq_lote_titulo,
		b.nr_sequencia nr_seq_protocolo,
		b.ie_tipo_resp_credito,
		b.nr_seq_segurado,
		b.cd_pessoa_fisica,
		d.nr_contrato_principal,	
		c.nr_seq_subestipulante,
		d.cd_cgc_estipulante cd_cgc_estipulante_cont,
		d.cd_pf_estipulante cd_pf_estipulante_cont,
		e.cd_cgc cd_cgc_estipulante_pag,
		e.cd_pessoa_fisica cd_pf_estipulante_pag,
		coalesce(c.nr_seq_titular, c.nr_sequencia) nr_seq_titular,
		substr(pls_obter_dados_protocolo(b.nr_sequencia, 'PF'),1,60) cd_pf_prot
	from	pls_lote_titulo_reembolso	a,
		pls_protocolo_conta		b,
		pls_segurado			c,
		pls_contrato			d,
		pls_contrato_pagador		e
	where	b.nr_sequencia		= a.nr_seq_protocolo
	and	c.nr_sequencia		= b.nr_seq_segurado
	and	d.nr_sequencia		= c.nr_seq_contrato
	and	e.nr_sequencia		= c.nr_seq_pagador
	and	a.nr_id_transacao	= nr_id_transacao_pc;
	
BEGIN

open c01(nr_id_transacao_p);
loop
	fetch C01 bulk collect into	tb_nr_seq_lote_titulo_w,
					tb_nr_seq_protocolo_w,
					tb_ie_tipo_resp_credito_w,
					tb_nr_seq_segurado_w,
					tb_cd_pessoa_fisica_w,
					tb_nr_contrato_principal_w,
					tb_nr_seq_subestipulante_w,
					tb_cd_cgc_estipulante_cont_w,
					tb_cd_pf_estipulante_cont_w,
					tb_cd_cgc_estipulante_pag_w,
					tb_cd_pf_estipulante_pag_w,
					tb_nr_seq_titular_w,
					tb_cd_pf_prot_w limit pls_util_pck.qt_registro_transacao_w;
	exit when tb_nr_seq_protocolo_w.count = 0;
	
	for i in tb_nr_seq_lote_titulo_w.first..tb_nr_seq_lote_titulo_w.last loop
		if (tb_ie_tipo_resp_credito_w(i) = 'P') then
			tb_cd_pf_w(i)	:= tb_cd_pf_estipulante_pag_w(i);
			tb_cd_cgc_w(i)	:= tb_cd_cgc_estipulante_pag_w(i);
			
		elsif (tb_ie_tipo_resp_credito_w(i) = 'E') then
			tb_cd_pf_w(i)	:= tb_cd_pf_estipulante_cont_w(i);
			tb_cd_cgc_w(i)	:= tb_cd_cgc_estipulante_cont_w(i);
			
		elsif (tb_ie_tipo_resp_credito_w(i) = 'CP') then
			select	max(cd_cgc_estipulante),
				max(cd_pf_estipulante)
			into STRICT	tb_cd_cgc_w(i),
				tb_cd_pf_w(i)
			from	pls_contrato
			where	nr_sequencia	= tb_nr_contrato_principal_w(i);
			
		elsif (tb_ie_tipo_resp_credito_w(i) = 'SE') then
			begin
				select	max(cd_pessoa_fisica),
					max(cd_cgc)
				into STRICT	tb_cd_pf_w(i),
					tb_cd_cgc_w(i)
				from	pls_sub_estipulante
				where	nr_sequencia = tb_nr_seq_subestipulante_w(i);
			exception
			when others then
				tb_cd_pf_w(i)	:= '';
				tb_cd_cgc_w(i)	:= '';
			end;
			
		elsif (tb_ie_tipo_resp_credito_w(i) = 'T') then
			if ((tb_nr_seq_titular_w(i) IS NOT NULL AND (tb_nr_seq_titular_w(i))::text <> '')) then
				select	max(cd_pessoa_fisica)
				into STRICT	tb_cd_pf_w(i)
				from	pls_segurado
				where	nr_sequencia = tb_nr_seq_titular_w(i);
			else
				select	max(cd_pessoa_fisica)
				into STRICT	tb_cd_pf_w(i)
				from	pls_segurado
				where	nr_sequencia = tb_nr_seq_titular_w(i);
			end if;
			
			tb_cd_cgc_w(i)	:= '';
			
		elsif (tb_ie_tipo_resp_credito_w(i) = 'PI') then
			tb_cd_pf_w(i)	:= tb_cd_pessoa_fisica_w(i);
			tb_cd_cgc_w(i)	:= '';
			
		else
			tb_cd_pf_w(i)	:= tb_cd_pf_prot_w(i);
			tb_cd_cgc_w(i)	:= '';
		end if;
	end loop;
	
	forall i in tb_cd_pf_w.first..tb_cd_pf_w.last
		update	pls_lote_titulo_reembolso
		set	cd_pessoa_fisica	= tb_cd_pf_w(i),
			cd_cgc			= tb_cd_cgc_w(i)
		where	nr_sequencia		= tb_nr_seq_lote_titulo_w(i);
		
	tb_nr_seq_lote_titulo_w.delete;
	tb_nr_seq_protocolo_w.delete;
	tb_ie_tipo_resp_credito_w.delete;
	tb_nr_seq_segurado_w.delete;
	tb_cd_pessoa_fisica_w.delete;
	tb_nr_contrato_principal_w.delete;
	tb_nr_seq_subestipulante_w.delete;
	tb_cd_pf_estipulante_cont_w.delete;
	tb_cd_cgc_estipulante_pag_w.delete;
	tb_cd_pf_estipulante_pag_w.delete;
	tb_nr_seq_titular_w.delete;
	tb_cd_pf_w.delete;
	tb_cd_cgc_w.delete;
end loop;

if (C01%isOpen) then
	close C01;
end if;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_reembolso_pck.preenche_inf_lote ( nr_id_transacao_p pls_lote_titulo_reembolso.nr_sequencia%type) FROM PUBLIC;
