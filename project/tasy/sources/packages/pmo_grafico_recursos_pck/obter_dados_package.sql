-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pmo_grafico_recursos_pck.obter_dados (dt_inicial_p timestamp, dt_final_p timestamp, nm_usuario_param_p text, nr_seq_departamento_p bigint, nr_seq_gerencia_p bigint, nr_seq_grupo_p bigint) RETURNS SETOF T_OBJETO_ROW_DATA AS $body$
DECLARE


	current_setting('pmo_grafico_recursos_pck.t_objeto_row_w')::t_objeto_row			t_objeto_row;

	dt_aux_w		timestamp	:= trunc(dt_inicial_p);
	qt_dias_w		bigint;
	qt_resultado_w		double precision;
	cd_pessoa_fisica_w	varchar(15);
	nr_seq_cronograma_w	bigint;
	ie_ausencia_w		varchar(1) := 'N';
	qt_fora_escopo_w	double precision;


	c01 CURSOR FOR
	SELECT 	distinct b.cd_pessoa_fisica,
		b.nm_usuario
	from 	GERENCIA_WHEB_GRUPO_USU a,
		usuario b
	where	a.nm_usuario_grupo = b.nm_usuario
	and	a.nr_seq_grupo = nr_seq_grupo_p
	and	(nr_seq_grupo_p IS NOT NULL AND nr_seq_grupo_p::text <> '')
	and	coalesce(nr_seq_gerencia_p::text, '') = ''
	and 	coalesce(nr_seq_departamento_p::text, '') = ''
	
union

	SELECT 	distinct d.cd_pessoa_fisica,
		d.nm_usuario
	from	GERENCIA_WHEB a,
		GERENCIA_WHEB_GRUPO b,
		GERENCIA_WHEB_GRUPO_USU c,
		usuario d
	where	a.nr_sequencia = nr_seq_gerencia_p
	and	a.nr_sequencia = b.nr_seq_gerencia
	and	b.nr_sequencia = c.nr_seq_grupo
	and	c.nm_usuario_grupo = d.nm_usuario
	and	a.ie_situacao = 'A'
	and	(nr_seq_gerencia_p IS NOT NULL AND nr_seq_gerencia_p::text <> '')
	and	coalesce(nr_seq_departamento_p::text, '') = ''
	and	coalesce(nr_seq_grupo_p::text, '') = ''
	
union

	select 	distinct e.cd_pessoa_fisica,
		e.nm_usuario
	from	DEPTO_GERENCIA_PHILIPS a,
		GERENCIA_WHEB b,
		GERENCIA_WHEB_GRUPO c,
		GERENCIA_WHEB_GRUPO_USU d,
		usuario e
	where	a.NR_SEQ_DEPARTAMENTO = nr_seq_departamento_p
	and	a.nr_Seq_gerencia = b.nr_sequencia
	and	b.nr_sequencia = c.nr_seq_gerencia
	and	c.nr_sequencia = d.nr_seq_grupo
	and	d.nm_usuario_grupo = e.nm_usuario
	and	b.ie_situacao = 'A'
	and	(nr_seq_departamento_p IS NOT NULL AND nr_seq_departamento_p::text <> '')
	and	coalesce(nr_seq_gerencia_p::text, '') = ''
	and	coalesce(nr_seq_grupo_p::text, '') = '';


	
BEGIN

	qt_dias_w	:= Obter_Dias_Entre(dt_inicial_p,dt_final_p)+1;



	if (nm_usuario_param_p IS NOT NULL AND nm_usuario_param_p::text <> '') then
		select 	coalesce(max(qt_fora_escopo),0)
		into STRICT	qt_fora_escopo_w
		from 	project_time_out_scope
		where	nm_usuario_grupo = nm_usuario_param_p;


		if (qt_fora_escopo_w = 0) then
			select 	coalesce(max(qt_fora_escopo),60)
			into STRICT	qt_fora_escopo_w
			from 	project_time_out_scope
			where 	nr_seq_grupo = (SELECT max(x.nr_sequencia)
						from GERENCIA_WHEB_GRUPO x
						where nm_usuario_grupo = nm_usuario_param_p);
		end if;


		select cd_pessoa_fisica
		into STRICT   cd_pessoa_fisica_w
		from   usuario
		where  nm_usuario = nm_usuario_param_p;
	else
		select 	coalesce(max(qt_fora_escopo),60)/60
		into STRICT	qt_fora_escopo_w
		from 	project_time_out_scope
		where 	((coalesce(nr_seq_departamento_p::text, '') = '' and coalesce(nr_seq_departamento::text, '') = '') or nr_seq_departamento = nr_seq_departamento_p)
		and	((coalesce(nr_seq_gerencia_p::text, '') = '' and coalesce(nr_seq_gerencia::text, '') = '') or nr_seq_gerencia = nr_seq_gerencia_p)
		and	((coalesce(nr_seq_grupo_p::text, '') = '' and coalesce(nr_seq_grupo::text, '') = '') or nr_seq_grupo = nr_seq_grupo_p)
		and	coalesce(nm_usuario_grupo::text, '') = '';
	end if;


	for i in 1..qt_dias_w loop
		begin
			current_setting('pmo_grafico_recursos_pck.t_objeto_row_w')::t_objeto_row.dt_referencia			:= dt_aux_w;
			current_setting('pmo_grafico_recursos_pck.t_objeto_row_w')::t_objeto_row.qt_dif_alocacao			:= 0;
			current_setting('pmo_grafico_recursos_pck.t_objeto_row_w')::t_objeto_row.qt_alocacao_proj_os		:= 0;
			current_setting('pmo_grafico_recursos_pck.t_objeto_row_w')::t_objeto_row.qt_alocacao_proj			:= 0;
			current_setting('pmo_grafico_recursos_pck.t_objeto_row_w')::t_objeto_row.qt_alocacao_os			:= 0;
			current_setting('pmo_grafico_recursos_pck.t_objeto_row_w')::t_objeto_row.qt_previsto_dia			:= 0;
			current_setting('pmo_grafico_recursos_pck.t_objeto_row_w')::t_objeto_row.qt_fora_escopo			:= 0;
			current_setting('pmo_grafico_recursos_pck.t_objeto_row_w')::t_objeto_row.qt_previsto_real			:= 0;

			if (nm_usuario_param_p IS NOT NULL AND nm_usuario_param_p::text <> '') then
				current_setting('pmo_grafico_recursos_pck.t_objeto_row_w')::t_objeto_row.nm_usuario			:= nm_usuario_param_p;

				/*Obter projetos do usuário*/

				qt_resultado_w := get_project_calendar(dt_aux_w,cd_pessoa_fisica_w);

				if (qt_resultado_w = 0) then
					qt_resultado_w := null;
				end if;

				current_setting('pmo_grafico_recursos_pck.t_objeto_row_w')::t_objeto_row.qt_alocacao_proj 		:= qt_resultado_w;
				qt_resultado_w := null;

				/*Obter OS de projetos do usuário*/

				select	coalesce(trunc(sum(b.qt_min_prev) / 60, 2),0)
				into STRICT	qt_resultado_w
				from	man_ordem_servico a left join man_ordem_ativ_prev b ON (a.nr_sequencia = b.nr_seq_ordem_serv)
				where	b.nm_usuario_prev = nm_usuario_param_p
				and	b.dt_prevista = dt_aux_w
				and	(a.nr_seq_proj_cron_etapa IS NOT NULL AND a.nr_seq_proj_cron_etapa::text <> '');

				current_setting('pmo_grafico_recursos_pck.t_objeto_row_w')::t_objeto_row.qt_alocacao_proj_os 		:= qt_resultado_w;
				qt_resultado_w := null;

				/* Tempo previsto em OS fora do projeto */

				select	trunc(sum(b.qt_min_prev) / 60, 2)
				into STRICT	qt_resultado_w
				from	man_ordem_servico a left join man_ordem_ativ_prev b ON (a.nr_sequencia = b.nr_seq_ordem_serv)
				where	b.nm_usuario_prev = nm_usuario_param_p
				and	b.dt_prevista = dt_aux_w
				and	coalesce(a.nr_seq_proj_cron_etapa::text, '') = '';

				current_setting('pmo_grafico_recursos_pck.t_objeto_row_w')::t_objeto_row.qt_alocacao_os			:= qt_resultado_w;
				qt_resultado_w := null;

				/*Tempo previsto em atividades diariamente*/

				if (Obter_Se_Dia_Util(dt_aux_w,obter_estabelecimento_ativo) = 'S') then
					qt_resultado_w := 8;
				else
					qt_resultado_w := null;
				end if;

				current_setting('pmo_grafico_recursos_pck.t_objeto_row_w')::t_objeto_row.qt_previsto_dia			:= qt_resultado_w;
				qt_resultado_w := null;

				/*Tempo fora escopo (ICC)*/

				if (Obter_Se_Dia_Util(dt_aux_w,obter_estabelecimento_ativo) = 'S') then
					qt_resultado_w := qt_fora_escopo_w;
				else
					qt_resultado_w := null;
				end if;

				current_setting('pmo_grafico_recursos_pck.t_objeto_row_w')::t_objeto_row.qt_fora_escopo			:= qt_resultado_w;
				qt_resultado_w := null;

				/*Previsto real */

				current_setting('pmo_grafico_recursos_pck.t_objeto_row_w')::t_objeto_row.qt_previsto_real := coalesce(current_setting('pmo_grafico_recursos_pck.t_objeto_row_w')::t_objeto_row.qt_alocacao_proj_os,0) + coalesce(current_setting('pmo_grafico_recursos_pck.t_objeto_row_w')::t_objeto_row.qt_alocacao_os,0) + coalesce(current_setting('pmo_grafico_recursos_pck.t_objeto_row_w')::t_objeto_row.qt_fora_escopo,0);

				/*Diferença diária */

				current_setting('pmo_grafico_recursos_pck.t_objeto_row_w')::t_objeto_row.qt_dif_alocacao := coalesce(current_setting('pmo_grafico_recursos_pck.t_objeto_row_w')::t_objeto_row.qt_previsto_real,0) - coalesce(current_setting('pmo_grafico_recursos_pck.t_objeto_row_w')::t_objeto_row.qt_previsto_dia,0);

			elsif ((nr_seq_grupo_p IS NOT NULL AND nr_seq_grupo_p::text <> '') or (nr_seq_gerencia_p IS NOT NULL AND nr_seq_gerencia_p::text <> '') or (nr_seq_departamento_p IS NOT NULL AND nr_seq_departamento_p::text <> '')) then

				for r_c01_w in c01 loop

					/*Obter projetos do grupo*/

					current_setting('pmo_grafico_recursos_pck.t_objeto_row_w')::t_objeto_row.qt_alocacao_proj := current_setting('pmo_grafico_recursos_pck.t_objeto_row_w')::t_objeto_row.qt_alocacao_proj +  get_project_calendar(dt_aux_w,r_c01_w.cd_pessoa_fisica);

					/*Obter OS de projetos do grupo*/

					select	coalesce(trunc(sum(b.qt_min_prev) / 60, 2),0)
					into STRICT	qt_resultado_w
					from	man_ordem_servico a left join man_ordem_ativ_prev b ON (a.nr_sequencia = b.nr_seq_ordem_serv)
					where	b.nm_usuario_prev = r_c01_w.nm_usuario
					and	b.dt_prevista = dt_aux_w
					and	(a.nr_seq_proj_cron_etapa IS NOT NULL AND a.nr_seq_proj_cron_etapa::text <> '');

					current_setting('pmo_grafico_recursos_pck.t_objeto_row_w')::t_objeto_row.qt_alocacao_proj_os := current_setting('pmo_grafico_recursos_pck.t_objeto_row_w')::t_objeto_row.qt_alocacao_proj_os + qt_resultado_w;
					qt_resultado_w := 0;

					/* Tempo previsto em OS fora do projeto */

					select	coalesce(trunc(sum(b.qt_min_prev) / 60, 2),0)
					into STRICT	qt_resultado_w
					from	man_ordem_servico a left join man_ordem_ativ_prev b ON (a.nr_sequencia = b.nr_seq_ordem_serv)
					where	b.nm_usuario_prev = r_c01_w.nm_usuario
					and	b.dt_prevista = dt_aux_w
					and	coalesce(a.nr_seq_proj_cron_etapa::text, '') = '';

					current_setting('pmo_grafico_recursos_pck.t_objeto_row_w')::t_objeto_row.qt_alocacao_os := current_setting('pmo_grafico_recursos_pck.t_objeto_row_w')::t_objeto_row.qt_alocacao_os + qt_resultado_w;
					qt_resultado_w := 0;

					/*Tempo fora escopo (ICC)*/

					select 	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
					into STRICT 	ie_ausencia_w
					from 	AUSENCIA_TASY
					where 	upper(nm_usuario_ausente) = upper(r_c01_w.nm_usuario)
					and	trunc(dt_aux_w) between trunc(dt_inicio) and trunc(dt_fim);

					if (Obter_Se_Dia_Util(dt_aux_w,obter_estabelecimento_ativo) = 'S' and ie_ausencia_w = 'N') then
						current_setting('pmo_grafico_recursos_pck.t_objeto_row_w')::t_objeto_row.qt_fora_escopo := current_setting('pmo_grafico_recursos_pck.t_objeto_row_w')::t_objeto_row.qt_fora_escopo + qt_fora_escopo_w;
					end if;

					/*Tempo previsto em atividades diariamente*/

					if (Obter_Se_Dia_Util(dt_aux_w,obter_estabelecimento_ativo) = 'S' and ie_ausencia_w = 'N') then
						current_setting('pmo_grafico_recursos_pck.t_objeto_row_w')::t_objeto_row.qt_previsto_dia :=  current_setting('pmo_grafico_recursos_pck.t_objeto_row_w')::t_objeto_row.qt_previsto_dia + 8;
					end if;

				end loop;

				/*Previsto real */

				current_setting('pmo_grafico_recursos_pck.t_objeto_row_w')::t_objeto_row.qt_previsto_real := coalesce(current_setting('pmo_grafico_recursos_pck.t_objeto_row_w')::t_objeto_row.qt_alocacao_proj_os,0) + coalesce(current_setting('pmo_grafico_recursos_pck.t_objeto_row_w')::t_objeto_row.qt_alocacao_os,0) + coalesce(current_setting('pmo_grafico_recursos_pck.t_objeto_row_w')::t_objeto_row.qt_fora_escopo,0);

				/*Diferença diária */

				current_setting('pmo_grafico_recursos_pck.t_objeto_row_w')::t_objeto_row.qt_dif_alocacao :=  coalesce(current_setting('pmo_grafico_recursos_pck.t_objeto_row_w')::t_objeto_row.qt_previsto_real,0) - coalesce(current_setting('pmo_grafico_recursos_pck.t_objeto_row_w')::t_objeto_row.qt_previsto_dia,0);


			end if;

		dt_aux_w := dt_aux_w + 1;
		RETURN NEXT current_setting('pmo_grafico_recursos_pck.t_objeto_row_w'::t_objeto_row);

		end;
	end loop;

	return;

	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pmo_grafico_recursos_pck.obter_dados (dt_inicial_p timestamp, dt_final_p timestamp, nm_usuario_param_p text, nr_seq_departamento_p bigint, nr_seq_gerencia_p bigint, nr_seq_grupo_p bigint) FROM PUBLIC;
