-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION prescription_json_pck.get_analyte_exam ( nr_seq_exame_p bigint) RETURNS PHILIPS_JSON_LIST AS $body$
DECLARE

	
	json_exam_w		philips_json;
	json_exam_list_w   	philips_json_list;
	qt_order_control_w		bigint	:= 1;
	
	C01 CURSOR FOR
		SELECT  a.nr_seq_exame lab_sequence_code,
			elimina_acentuacao(a.nm_exame) exam_procedure_name,
			a.cd_exame_integracao integration_exam_code,
			a.cd_exame lab_exam_code,
			1 ie_order
		from    exame_laboratorio a
		where 	a.nr_seq_exame = nr_seq_exame_p
		
union

		SELECT  a.nr_seq_exame lab_sequence_code,
			elimina_acentuacao(a.nm_exame) exam_procedure_name,
			a.cd_exame_integracao integration_exam_code,
			a.cd_exame lab_exam_code,
			2 ie_order
		from    exame_laboratorio a
		where 	a.nr_seq_superior = nr_seq_exame_p
		and	a.ie_situacao = 'A'
		order by ie_order;
	
	
BEGIN
	
	json_exam_list_w	:= philips_json_list();
		
	for r_c01 in c01 loop
		begin
		json_exam_w		:= philips_json();
		 json_exam_w := prescription_json_pck.add_json_value( json_exam_w, 'orderControl', qt_order_control_w);
		 json_exam_w := prescription_json_pck.add_json_value( json_exam_w, 'labSequenceCode', r_c01.lab_sequence_code);
		 json_exam_w := prescription_json_pck.add_json_value( json_exam_w, 'examProcedureName', r_c01.exam_procedure_name);
		 json_exam_w := prescription_json_pck.add_json_value( json_exam_w, 'integrationExamCode', r_c01.integration_exam_code);
		 json_exam_w := prescription_json_pck.add_json_value( json_exam_w, 'labExamCode', r_c01.lab_exam_code);
		json_exam_list_w.append(json_exam_w.to_json_value());
		qt_order_control_w	:= qt_order_control_w + 1;
		end;
	end loop;
	
	return json_exam_list_w;
	
	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION prescription_json_pck.get_analyte_exam ( nr_seq_exame_p bigint) FROM PUBLIC;
