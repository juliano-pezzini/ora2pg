-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE adep_onc_gerar_horarios_pck.gerar_horarios_adep_onc ( cd_estabelecimento_p bigint, cd_perfil_p bigint, nm_usuario_p text, nr_atendimento_p bigint, ie_opcao_filtro_p text, dt_filtro_p timestamp, ie_exibir_suspensos_p text, qt_horas_adicionais_p bigint DEFAULT null) AS $body$
DECLARE

	
	i				integer		:= 0;
	j				integer		:= 0;
	k				integer		:= 0;

	nr_seq_wadep_w			bigint;	
	nr_ciclo_w			smallint;
	ie_carregar_w			varchar(1)	:= 'S';
	param_user_exibir_suspensos_w 	varchar(1) 	:= NULL;
	
	c02 CURSOR FOR
	SELECT	dt_horario
	from	w_adep_horarios_t
	where	nm_usuario = nm_usuario_p
	group by
		dt_horario
	order by
		dt_horario;

	
BEGIN

	CALL CALL adep_onc_gerar_horarios_pck.clearpackage();
	
	PERFORM set_config('adep_onc_gerar_horarios_pck.cd_estabelecimento_w', cd_estabelecimento_p, false);
	PERFORM set_config('adep_onc_gerar_horarios_pck.cd_perfil_w', cd_perfil_p, false);
	PERFORM set_config('adep_onc_gerar_horarios_pck.nm_usuario_w', nm_usuario_p, false);
		
	CALL exec_sql_dinamico(nm_usuario_p, 'truncate table w_adep_t');
	CALL exec_sql_dinamico(nm_usuario_p, 'truncate table w_adep_horarios_t');

	if (ie_opcao_filtro_p	= 'C') then
		select	max(a.nr_ciclo)
		into STRICT	nr_ciclo_w
		from	paciente_atendimento a,
			paciente_setor b,
			prescr_medica c
		where	a.nr_seq_paciente 	= b.nr_seq_paciente
		and	a.nr_seq_atendimento 	= c.nr_seq_atend
		and	c.nr_atendimento	= nr_atendimento_p
		and	c.cd_pessoa_fisica	= b.cd_pessoa_fisica
		and	coalesce(a.dt_real,a.dt_prevista)	between trunc(dt_filtro_p) and fim_dia(dt_filtro_p)
		and	coalesce(a.dt_suspensao::text, '') = '';

		if (coalesce(nr_ciclo_w::text, '') = '') then
			ie_carregar_w	:= 'N';
		end if;
		
	end if;
	
	if	(dt_filtro_p IS NOT NULL AND dt_filtro_p::text <> '' AND ie_opcao_filtro_p	= 'H') then
		begin
		PERFORM set_config('adep_onc_gerar_horarios_pck.dt_inicial_horarios_w', dt_filtro_p, false);
		if (qt_horas_adicionais_p = 24) then
			PERFORM set_config('adep_onc_gerar_horarios_pck.dt_final_horarios_w', dt_filtro_p + dividir(qt_horas_adicionais_p,24) - 1/86400, false);
		else
			PERFORM set_config('adep_onc_gerar_horarios_pck.dt_final_horarios_w', dt_filtro_p + dividir(qt_horas_adicionais_p,24), false);
		end if;
		end;
	end if;
	
	Obter_Param_Usuario(1113, 117, current_setting('adep_onc_gerar_horarios_pck.cd_perfil_w')::bigint, current_setting('adep_onc_gerar_horarios_pck.nm_usuario_w')::varchar(15), current_setting('adep_onc_gerar_horarios_pck.cd_estabelecimento_w')::smallint, param_user_exibir_suspensos_w);
	IF (param_user_exibir_suspensos_w = 'N') THEN
		PERFORM set_config('adep_onc_gerar_horarios_pck.ie_exibir_suspensos_w', 'S', false);
	ELSE
		PERFORM set_config('adep_onc_gerar_horarios_pck.ie_exibir_suspensos_w', coalesce(ie_exibir_suspensos_p,'S'), false);
	END IF;

	if (ie_carregar_w	= 'S') then
	
		CALL adep_onc_gerar_horarios_pck.adep_onc_obter_hor_medic(
			nm_usuario_p,
			nr_atendimento_p,
			get_ie_data_lib_prescr,
			get_ie_exibir_suspensos,
			ie_opcao_filtro_p,
			dt_filtro_p,
			nr_ciclo_w,
			current_setting('adep_onc_gerar_horarios_pck.dt_inicial_horarios_w')::timestamp,
			current_setting('adep_onc_gerar_horarios_pck.dt_final_horarios_w')::timestamp);
		CALL adep_onc_gerar_horarios_pck.adep_onc_obter_hor_proced(
			nm_usuario_p,
			nr_atendimento_p,
			get_ie_exibir_suspensos,
			get_ie_data_lib_proced,
			ie_opcao_filtro_p,
			dt_filtro_p,
			nr_ciclo_w,
			current_setting('adep_onc_gerar_horarios_pck.dt_inicial_horarios_w')::timestamp,
			current_setting('adep_onc_gerar_horarios_pck.dt_final_horarios_w')::timestamp);
		CALL adep_onc_gerar_horarios_pck.adep_onc_obter_hor_solucao(
			nm_usuario_p,
			nr_atendimento_p,
			get_ie_data_lib_prescr,
			get_ie_exibir_suspensos,
			ie_opcao_filtro_p,
			dt_filtro_p,
			nr_ciclo_w,
			current_setting('adep_onc_gerar_horarios_pck.dt_inicial_horarios_w')::timestamp,
			current_setting('adep_onc_gerar_horarios_pck.dt_final_horarios_w')::timestamp);
		CALL adep_onc_gerar_horarios_pck.adep_onc_obter_hor_rec(
			nm_usuario_p,
			nr_atendimento_p,
			get_ie_data_lib_prescr,
			get_ie_exibir_suspensos,
			ie_opcao_filtro_p,
			dt_filtro_p,
			nr_ciclo_w,
			current_setting('adep_onc_gerar_horarios_pck.dt_inicial_horarios_w')::timestamp,
			current_setting('adep_onc_gerar_horarios_pck.dt_final_horarios_w')::timestamp);
		
		open c02;
		loop
		fetch c02 into current_setting('adep_onc_gerar_horarios_pck.dt_horario_w')::timestamp;
		EXIT WHEN NOT FOUND; /* apply on c02 */
			begin
			if (i < 40) then
				begin
				i			:= i + 1;
				current_setting('adep_onc_gerar_horarios_pck.vetor_w')::vetor[i].horario_w	:= to_char(current_setting('adep_onc_gerar_horarios_pck.dt_horario_w')::timestamp,'dd/mm/yyyy hh24:mi:ss');
				end;
			end if;
			end;
		end loop;
		close c02;

		j	:= i;
		while(j < 40) loop
			begin
			j			:= j + 1;
			current_setting('adep_onc_gerar_horarios_pck.vetor_w')::vetor[j].horario_w	:= null;
			end;
		end loop;

		select	nextval('w_adep_t_seq')
		into STRICT	nr_seq_wadep_w
		;

		insert into w_adep_t(
			nr_sequencia,
			nm_usuario,
			ie_tipo_item,
			hora1, 	hora2,	hora3,	hora4,	hora5,	hora6,	hora7,	hora8,	hora9,	hora10,
			hora11, hora12, hora13, hora14, hora15, hora16, hora17, hora18, hora19, hora20,
			hora21, hora22, hora23, hora24, hora25, hora26, hora27, hora28, hora29, hora30,
			hora31, hora32, hora33, hora34, hora35, hora36, hora37, hora38, hora39, hora40)
		values (
			nr_seq_wadep_w,
			nm_usuario_p,
			'H',
			current_setting('adep_onc_gerar_horarios_pck.vetor_w')::vetor[1].horario_w,
			current_setting('adep_onc_gerar_horarios_pck.vetor_w')::vetor[2].horario_w,
			current_setting('adep_onc_gerar_horarios_pck.vetor_w')::vetor[3].horario_w,
			current_setting('adep_onc_gerar_horarios_pck.vetor_w')::vetor[4].horario_w,
			current_setting('adep_onc_gerar_horarios_pck.vetor_w')::vetor[5].horario_w,
			current_setting('adep_onc_gerar_horarios_pck.vetor_w')::vetor[6].horario_w,
			current_setting('adep_onc_gerar_horarios_pck.vetor_w')::vetor[7].horario_w,
			current_setting('adep_onc_gerar_horarios_pck.vetor_w')::vetor[8].horario_w,
			current_setting('adep_onc_gerar_horarios_pck.vetor_w')::vetor[9].horario_w,
			current_setting('adep_onc_gerar_horarios_pck.vetor_w')::vetor[10].horario_w,
			current_setting('adep_onc_gerar_horarios_pck.vetor_w')::vetor[11].horario_w,
			current_setting('adep_onc_gerar_horarios_pck.vetor_w')::vetor[12].horario_w,
			current_setting('adep_onc_gerar_horarios_pck.vetor_w')::vetor[13].horario_w,
			current_setting('adep_onc_gerar_horarios_pck.vetor_w')::vetor[14].horario_w,
			current_setting('adep_onc_gerar_horarios_pck.vetor_w')::vetor[15].horario_w,
			current_setting('adep_onc_gerar_horarios_pck.vetor_w')::vetor[16].horario_w,
			current_setting('adep_onc_gerar_horarios_pck.vetor_w')::vetor[17].horario_w,
			current_setting('adep_onc_gerar_horarios_pck.vetor_w')::vetor[18].horario_w,
			current_setting('adep_onc_gerar_horarios_pck.vetor_w')::vetor[19].horario_w,
			current_setting('adep_onc_gerar_horarios_pck.vetor_w')::vetor[20].horario_w,
			current_setting('adep_onc_gerar_horarios_pck.vetor_w')::vetor[21].horario_w,
			current_setting('adep_onc_gerar_horarios_pck.vetor_w')::vetor[22].horario_w,
			current_setting('adep_onc_gerar_horarios_pck.vetor_w')::vetor[23].horario_w,
			current_setting('adep_onc_gerar_horarios_pck.vetor_w')::vetor[24].horario_w,
			current_setting('adep_onc_gerar_horarios_pck.vetor_w')::vetor[25].horario_w,
			current_setting('adep_onc_gerar_horarios_pck.vetor_w')::vetor[26].horario_w,
			current_setting('adep_onc_gerar_horarios_pck.vetor_w')::vetor[27].horario_w,
			current_setting('adep_onc_gerar_horarios_pck.vetor_w')::vetor[28].horario_w,
			current_setting('adep_onc_gerar_horarios_pck.vetor_w')::vetor[29].horario_w,
			current_setting('adep_onc_gerar_horarios_pck.vetor_w')::vetor[30].horario_w,
			current_setting('adep_onc_gerar_horarios_pck.vetor_w')::vetor[31].horario_w,
			current_setting('adep_onc_gerar_horarios_pck.vetor_w')::vetor[32].horario_w,
			current_setting('adep_onc_gerar_horarios_pck.vetor_w')::vetor[33].horario_w,
			current_setting('adep_onc_gerar_horarios_pck.vetor_w')::vetor[34].horario_w,
			current_setting('adep_onc_gerar_horarios_pck.vetor_w')::vetor[35].horario_w,
			current_setting('adep_onc_gerar_horarios_pck.vetor_w')::vetor[36].horario_w,
			current_setting('adep_onc_gerar_horarios_pck.vetor_w')::vetor[37].horario_w,
			current_setting('adep_onc_gerar_horarios_pck.vetor_w')::vetor[38].horario_w,
			current_setting('adep_onc_gerar_horarios_pck.vetor_w')::vetor[39].horario_w,
			current_setting('adep_onc_gerar_horarios_pck.vetor_w')::vetor[40].horario_w);
		commit;

		CALL adep_onc_gerar_horarios_pck.adep_onc_obter_medic(
			nm_usuario_p,
			nr_atendimento_p,
			get_ie_data_lib_prescr,
			get_ie_exibir_suspensos,
			get_ie_agrupar_acm_sn,			
			get_agrupar_suspensos,
			ie_opcao_filtro_p,
			dt_filtro_p,
			nr_ciclo_w,
			get_ie_lib_pend_rep,
			current_setting('adep_onc_gerar_horarios_pck.dt_inicial_horarios_w')::timestamp,
			current_setting('adep_onc_gerar_horarios_pck.dt_final_horarios_w')::timestamp);
		CALL adep_onc_gerar_horarios_pck.adep_onc_obter_proced(
			nm_usuario_p,
			nr_atendimento_p,
			get_ie_exibir_suspensos,
			get_ie_agrupar_acm_sn,
			get_ie_agrupar_associados,
			get_ie_data_lib_proced,
			ie_opcao_filtro_p,
			dt_filtro_p,
			nr_ciclo_w,
			get_ie_lib_pend_rep,
			current_setting('adep_onc_gerar_horarios_pck.dt_inicial_horarios_w')::timestamp,
			current_setting('adep_onc_gerar_horarios_pck.dt_final_horarios_w')::timestamp);
		CALL adep_onc_gerar_horarios_pck.adep_onc_obter_solucao(
			cd_estabelecimento_p,
			nm_usuario_p,
			nr_atendimento_p,
			get_ie_data_lib_prescr,
			get_ie_exibir_suspensos,
			ie_opcao_filtro_p,
			dt_filtro_p,
			nr_ciclo_w,
			get_ie_lib_pend_rep);
		CALL adep_onc_gerar_horarios_pck.adep_onc_obter_rec(
			nm_usuario_p,
			nr_atendimento_p,
			get_ie_data_lib_prescr,
			get_ie_exibir_suspensos,
			get_ie_agrupar_acm_sn,
			ie_opcao_filtro_p,
			dt_filtro_p,
			nr_ciclo_w,
			get_ie_lib_pend_rep,
			current_setting('adep_onc_gerar_horarios_pck.dt_inicial_horarios_w')::timestamp,
			current_setting('adep_onc_gerar_horarios_pck.dt_final_horarios_w')::timestamp);
		CALL adep_onc_gerar_horarios_pck.adep_onc_sincronizar_medic(
			nm_usuario_p,
			nr_atendimento_p,
			get_ie_data_lib_prescr,
			get_ie_exibir_suspensos,
			ie_opcao_filtro_p,
			dt_filtro_p,
			nr_ciclo_w,
			current_setting('adep_onc_gerar_horarios_pck.dt_inicial_horarios_w')::timestamp,
			current_setting('adep_onc_gerar_horarios_pck.dt_final_horarios_w')::timestamp);
		CALL adep_onc_gerar_horarios_pck.adep_onc_sincronizar_proced(
			nm_usuario_p,
			nr_atendimento_p,
			get_ie_exibir_suspensos,
			get_ie_data_lib_proced,
			ie_opcao_filtro_p,
			dt_filtro_p,
			nr_ciclo_w,
			current_setting('adep_onc_gerar_horarios_pck.dt_inicial_horarios_w')::timestamp,
			current_setting('adep_onc_gerar_horarios_pck.dt_final_horarios_w')::timestamp);
		CALL adep_onc_gerar_horarios_pck.adep_onc_sincronizar_solucao(
			nm_usuario_p,
			nr_atendimento_p,
			get_ie_data_lib_prescr,
			get_ie_exibir_suspensos,
			ie_opcao_filtro_p,
			dt_filtro_p,
			nr_ciclo_w,
			current_setting('adep_onc_gerar_horarios_pck.dt_inicial_horarios_w')::timestamp,
			current_setting('adep_onc_gerar_horarios_pck.dt_final_horarios_w')::timestamp);
		CALL adep_onc_gerar_horarios_pck.adep_onc_sincronizar_rec(
			nm_usuario_p,
			nr_atendimento_p,
			get_ie_data_lib_prescr,
			get_ie_exibir_suspensos,
			ie_opcao_filtro_p,
			dt_filtro_p,
			nr_ciclo_w,
			current_setting('adep_onc_gerar_horarios_pck.dt_inicial_horarios_w')::timestamp,
			current_setting('adep_onc_gerar_horarios_pck.dt_final_horarios_w')::timestamp);

		update	w_adep_t
		set	nr_prescricoes = adep_obter_prescricoes(nr_atendimento_p, ie_tipo_item, cd_item, nr_seq_proc_interno, cd_intervalo, qt_item, current_setting('adep_onc_gerar_horarios_pck.ie_data_lib_proced_w')::varchar(15), current_setting('adep_onc_gerar_horarios_pck.ie_data_lib_prescr_w')::varchar(15), current_setting('adep_onc_gerar_horarios_pck.ie_exibir_suspensos_w')::varchar(15), (clock_timestamp() - interval '100 days'),null, null)
		where	nm_usuario = nm_usuario_p
		and	coalesce(nr_prescricoes::text, '') = '';

		CALL CALL adep_onc_gerar_horarios_pck.gerar_flag_horarios(nm_usuario_p);
		
	end if;	
		
	end;
	

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE adep_onc_gerar_horarios_pck.gerar_horarios_adep_onc ( cd_estabelecimento_p bigint, cd_perfil_p bigint, nm_usuario_p text, nr_atendimento_p bigint, ie_opcao_filtro_p text, dt_filtro_p timestamp, ie_exibir_suspensos_p text, qt_horas_adicionais_p bigint DEFAULT null) FROM PUBLIC;
