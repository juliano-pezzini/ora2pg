-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE adep_onc_gerar_horarios_pck.adep_onc_obter_hor_medic ( nm_usuario_p text, nr_atendimento_p bigint, ie_data_lib_prescr_p text, ie_exibir_suspensos_p text, ie_opcao_filtro_p text, dt_filtro_p timestamp, nr_ciclo_p bigint, dt_inicial_horario_p timestamp, dt_final_horario_p timestamp) AS $body$
DECLARE

						
	current_setting('adep_onc_gerar_horarios_pck.dt_horario_w')::timestamp	timestamp;
						
	c01 CURSOR FOR
	SELECT	c.dt_horario
	from	prescr_material x,
		prescr_mat_hor c,
		prescr_medica a,
		paciente_atendimento b,
		paciente_setor p
	where	x.nr_prescricao	= c.nr_prescricao
	and	x.nr_sequencia	= c.nr_seq_material
	and	x.nr_prescricao = a.nr_prescricao
	and	c.nr_prescricao = a.nr_prescricao
	and	a.nr_seq_atend	= b.nr_seq_atendimento
	and	b.nr_seq_paciente = p.nr_seq_paciente
	and	p.cd_pessoa_fisica = a.cd_pessoa_fisica
	and	a.nr_atendimento = nr_atendimento_p
	and	obter_se_prescr_lib_adep(coalesce(a.dt_liberacao_medico,x.dt_lib_material), coalesce(a.dt_liberacao,x.dt_lib_material), coalesce(a.dt_liberacao_farmacia,x.dt_lib_material), ie_data_lib_prescr_p) = 'S'
	and	x.ie_agrupador = 1
	and	((ie_exibir_suspensos_p = 'S') or (coalesce(x.dt_suspensao::text, '') = ''))
	and	coalesce(c.ie_situacao,'A') = 'A'
	and	coalesce(c.ie_adep,'S') = 'S'
	and	c.ie_agrupador = 1
	and	coalesce(a.ie_recem_nato,'N')	= 'N'
	and	coalesce(x.nr_seq_kit::text, '') = ''
	and	Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'
	and	obter_se_gerar_item_adep('M',a.nr_prescricao,c.nr_seq_material,x.nr_agrupamento,getie_apres_kit) = 'S'
	and ((ie_opcao_filtro_p in ('Q','C')) or
		 ((ie_opcao_filtro_p = 'D') and (coalesce(b.dt_real,b.dt_prevista) between trunc(dt_filtro_p) and fim_dia(dt_filtro_p))) or
         (ie_opcao_filtro_p = 'H' AND c.dt_horario between dt_inicial_horario_p and dt_final_horario_p))
	and	b.nr_ciclo	= coalesce(nr_ciclo_p,b.nr_ciclo)
	group by
		c.dt_horario;
		
	
BEGIN
	
	open c01;
	loop
	fetch c01 into current_setting('adep_onc_gerar_horarios_pck.dt_horario_w')::timestamp;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin
		insert into w_adep_horarios_t(
			nm_usuario,
			dt_horario,
			ie_medicamento)
		values (
			nm_usuario_p,
			current_setting('adep_onc_gerar_horarios_pck.dt_horario_w')::timestamp,
			'S');
		commit;
		end;
	end loop;
	close c01;
	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE adep_onc_gerar_horarios_pck.adep_onc_obter_hor_medic ( nm_usuario_p text, nr_atendimento_p bigint, ie_data_lib_prescr_p text, ie_exibir_suspensos_p text, ie_opcao_filtro_p text, dt_filtro_p timestamp, nr_ciclo_p bigint, dt_inicial_horario_p timestamp, dt_final_horario_p timestamp) FROM PUBLIC;
