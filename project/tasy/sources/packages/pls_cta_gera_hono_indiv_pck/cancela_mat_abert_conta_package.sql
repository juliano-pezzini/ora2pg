-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


-- cancela o material e suas respectivas glosas e ocorrencias se a regra permitir



CREATE OR REPLACE PROCEDURE pls_cta_gera_hono_indiv_pck.cancela_mat_abert_conta ( nr_seq_conta_p pls_conta.nr_sequencia%type, nr_seq_conta_mat_p pls_conta_mat.nr_sequencia%type, dt_material_p pls_conta_mat.dt_atendimento%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE


C01 CURSOR(dt_material_pc		pls_conta_mat.dt_atendimento%type) is
	with query_tmp as (
			SELECT	a.nr_sequencia,
				coalesce(a.ie_cancelamento, 'N') ie_cancelamento
			from	pls_regra_canc_item_orig	a
			where	dt_material_pc between a.dt_inicio_vigencia and coalesce(a.dt_fim_vigencia, dt_material_pc)
			order by a.ie_cancelamento desc
			)
	SELECT	nr_sequencia,
		ie_cancelamento
	from	query_tmp LIMIT 1;
BEGIN


	for r_C01_w in C01(dt_material_p) loop
		
		-- se na regra esta marcado para cancelar

		if (r_C01_w.ie_cancelamento = 'S') then
			update	pls_conta_mat
			set	ie_status			= 'D',
				nr_seq_regra_canc_item_orig	= r_C01_w.nr_sequencia
			where	nr_sequencia			= nr_seq_conta_mat_p;
			
			-- cancela todas as glosas e ocorrencias vinculadas ao procedimento que foi cancelado

			CALL pls_gerencia_dados_ocor_pck.pls_gerencia_situ_glo_ocor( nr_seq_conta_p,
										null,
										nr_seq_conta_mat_p,
										null,
										'I',
										nm_usuario_p);
		end if;

	end loop;


END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_cta_gera_hono_indiv_pck.cancela_mat_abert_conta ( nr_seq_conta_p pls_conta.nr_sequencia%type, nr_seq_conta_mat_p pls_conta_mat.nr_sequencia%type, dt_material_p pls_conta_mat.dt_atendimento%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;
