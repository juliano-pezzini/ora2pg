-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_cta_gera_hono_indiv_pck.gera_mat_abert_conta ( nr_seq_conta_p pls_conta.nr_sequencia%type, nr_seq_conta_mat_p pls_conta_mat.nr_sequencia%type, dt_material_p pls_conta_mat.dt_atendimento%type, dt_inicio_atend_p pls_conta_mat.dt_inicio_atend%type, dt_fim_atend_p pls_conta_mat.dt_fim_atend%type, nm_usuario_p usuario.nm_usuario%type, ie_gerou_novo_p INOUT text) AS $body$
DECLARE


qt_materiais_w			integer;
nr_seq_conta_mat_nv_w		pls_conta_mat.nr_sequencia%type;
nr_seq_item_tiss_w		pls_conta_mat_regra.nr_seq_item_tiss%type;
nr_seq_item_tiss_vinculo_w	pls_conta_mat_regra.nr_seq_item_tiss_vinculo%type;


BEGIN

-- se no processo anterior (criacao da conta) criou um novo registro, obviamente aqui se deve ser gerado um novo material e nem precisa fazer um select para buscar

if (ie_gerou_novo_p = 'N') then

	select	count(a.nr_sequencia),
		max((select max(x.nr_seq_item_tiss) from pls_conta_mat_regra x where x.nr_sequencia = a.nr_sequencia)),
		max((select max(x.nr_seq_item_tiss_vinculo) from pls_conta_mat_regra x where x.nr_sequencia = a.nr_sequencia))
	into STRICT	qt_materiais_w,
		nr_seq_item_tiss_w,
		nr_seq_item_tiss_vinculo_w
	from	pls_conta_mat	a
	where	a.nr_seq_conta				= nr_seq_conta_p
	and	((coalesce(a.dt_atendimento::text, '') = '') or (a.dt_atendimento = dt_material_p))
	and	((coalesce(a.dt_inicio_atend::text, '') = '') or (a.dt_inicio_atend = dt_inicio_atend_p))
	and	((coalesce(a.dt_fim_atend::text, '') = '') or (a.dt_fim_atend = dt_fim_atend_p))
	and	a.ie_status != 'D';
end if;

--Se nao existe o procedimento ou se foi gerado uma nova conta, cria um procedimento novo	

if (qt_materiais_w = 0 or ie_gerou_novo_p = 'S') then
	ie_gerou_novo_p := 'S';
	
	select	nextval('pls_conta_mat_seq')
	into STRICT	nr_seq_conta_mat_nv_w
	;
	
	insert into pls_conta_mat(nr_sequencia, dt_atualizacao, nm_usuario,
		dt_atualizacao_nrec, nm_usuario_nrec, dt_atendimento,
		nr_seq_material, cd_material, vl_unitario,
		nr_seq_conta, dt_atendimento_imp, qt_material_imp, 
		vl_unitario_imp, vl_material_imp, dt_inicio_atend, 
		dt_fim_atend, dt_inicio_atend_imp, dt_fim_atend_imp, 
		tx_participacao, vl_participacao, ds_material_imp, 
		cd_tipo_tabela_imp, tx_reducao_acrescimo_imp, ie_tipo_despesa_imp,
		vl_liberado, vl_glosa, vl_saldo,
		nr_seq_regra, ie_tipo_despesa, ie_situacao,
		ie_status, dt_liberacao, nm_usuario_liberacao,
		nr_seq_tiss_tabela, vl_material, nr_seq_regra_lib,
		ds_log, cd_conta_cred, cd_conta_deb,
		cd_historico, cd_conta_glosa_cred, cd_conta_glosa_deb,
		cd_historico_glosa, nr_seq_regra_ctb_deb, nr_seq_regra_ctb_cred,
		nr_seq_grupo_ans, ie_status_pagamento, ie_acao_analise,
		nr_seq_mat_ref)
	SELECT	nr_seq_conta_mat_nv_w, dt_atualizacao, nm_usuario,
		dt_atualizacao_nrec, nm_usuario_nrec, dt_atendimento,
		nr_seq_material, cd_material, vl_unitario, 
		nr_seq_conta_p, dt_atendimento_imp, qt_material_imp, 
		vl_unitario_imp, vl_material_imp, dt_inicio_atend, 
		dt_fim_atend, dt_inicio_atend_imp, dt_fim_atend_imp, 
		tx_participacao, vl_participacao, ds_material_imp, 
		cd_tipo_tabela_imp, tx_reducao_acrescimo_imp, ie_tipo_despesa_imp, 
		vl_liberado, vl_glosa, vl_saldo, 
		nr_seq_regra, ie_tipo_despesa, ie_situacao, 
		ie_status, dt_liberacao, nm_usuario_liberacao, 
		nr_seq_tiss_tabela, vl_material, nr_seq_regra_lib,
		ds_log, cd_conta_cred, cd_conta_deb,
		cd_historico, cd_conta_glosa_cred, cd_conta_glosa_deb,
		cd_historico_glosa, nr_seq_regra_ctb_deb, nr_seq_regra_ctb_cred,
		nr_seq_grupo_ans, ie_status_pagamento, ie_acao_analise,
		nr_sequencia
	from	pls_conta_mat
	where	nr_sequencia	= nr_seq_conta_mat_p;
	
	if (nr_seq_item_tiss_w IS NOT NULL AND nr_seq_item_tiss_w::text <> '') then
	
		CALL pls_cta_proc_mat_regra_pck.cria_registro_regra_mat(nr_seq_conta_mat_nv_w, nm_usuario_p);
		CALL pls_cta_proc_mat_regra_pck.atualiza_seq_tiss_mat(nr_seq_conta_mat_nv_w, nr_seq_item_tiss_w, nr_seq_item_tiss_vinculo_w, nm_usuario_p);
	end if;
	
else
	ie_gerou_novo_p := 'N';	
end if;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_cta_gera_hono_indiv_pck.gera_mat_abert_conta ( nr_seq_conta_p pls_conta.nr_sequencia%type, nr_seq_conta_mat_p pls_conta_mat.nr_sequencia%type, dt_material_p pls_conta_mat.dt_atendimento%type, dt_inicio_atend_p pls_conta_mat.dt_inicio_atend%type, dt_fim_atend_p pls_conta_mat.dt_fim_atend%type, nm_usuario_p usuario.nm_usuario%type, ie_gerou_novo_p INOUT text) FROM PUBLIC;
