-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pls_mens_itens_conta_pck.obter_se_status_liberado ( nr_seq_protocolo_p pls_protocolo_conta.nr_sequencia%type, nr_seq_conta_p pls_conta.nr_sequencia%type, nr_seq_proc_rec_p pls_rec_glosa_proc.nr_sequencia%type, nr_seq_mat_rec_p pls_rec_glosa_mat.nr_sequencia%type, ie_origem_desp_p text) RETURNS varchar AS $body$
DECLARE

--ie_origem_desp_p

-- C = Coparticipacao

-- O = Custo operacional (Valores nao cobertos pelo contrato

-- P = Pos-estabelecido

ie_status_w		varchar(5);
ie_status_liberado_w	varchar(1)	:= 'N';

BEGIN
if (pls_mensalidade_util_pck.get_ie_forma_pagamento = 'P') then
	if ((nr_seq_proc_rec_p IS NOT NULL AND nr_seq_proc_rec_p::text <> '') or (nr_seq_mat_rec_p IS NOT NULL AND nr_seq_mat_rec_p::text <> '')) then -- Recurso de glosa - IE_STATUS Dominio 5828
		if (nr_seq_proc_rec_p IS NOT NULL AND nr_seq_proc_rec_p::text <> '') then
			select	max(c.ie_status)
			into STRICT	ie_status_w
			from	pls_rec_glosa_proc a,
				pls_rec_glosa_conta b,
				pls_rec_glosa_protocolo c
			where	b.nr_sequencia	= a.nr_seq_conta_rec
			and	c.nr_sequencia	= b.nr_seq_protocolo
			and	a.nr_sequencia	= nr_seq_proc_rec_p;
		elsif (nr_seq_mat_rec_p IS NOT NULL AND nr_seq_mat_rec_p::text <> '') then
			select	max(c.ie_status)
			into STRICT	ie_status_w
			from	pls_rec_glosa_mat a,
				pls_rec_glosa_conta b,
				pls_rec_glosa_protocolo c
			where	b.nr_sequencia	= a.nr_seq_conta_rec
			and	c.nr_sequencia	= b.nr_seq_protocolo
			and	a.nr_sequencia	= nr_seq_mat_rec_p;
		end if;
		
		if 	((ie_status_w in ('3','6')) or
			((ie_origem_desp_p = 'C') and (ie_status_w = '4') and (pls_mensalidade_util_pck.get_ie_copartic_prot_sem_pag = 'S'))) then
			ie_status_liberado_w	:= 'S';
		else
			ie_status_liberado_w	:= 'N';
		end if;
	else
		select	max(ie_status) --Dominio 1869
		into STRICT	ie_status_w
		from	pls_protocolo_conta
		where	nr_sequencia	= nr_seq_protocolo_p;
		
		if 	((ie_status_w in ('3','6','7')) or
			((ie_origem_desp_p = 'C') and (ie_status_w = '4') and (pls_mensalidade_util_pck.get_ie_copartic_prot_sem_pag = 'S'))) then
			ie_status_liberado_w	:= 'S';
		else
			ie_status_liberado_w	:= 'N';
		end if;
	end if;
else
	begin
	select	'S'
	into STRICT	ie_status_liberado_w
	from	pls_conta
	where	nr_sequencia	= nr_seq_conta_p
	and	ie_status	in ('F','S');
	exception
	when others then
		ie_status_liberado_w	:= 'N';
	end;
end if;

return	ie_status_liberado_w;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pls_mens_itens_conta_pck.obter_se_status_liberado ( nr_seq_protocolo_p pls_protocolo_conta.nr_sequencia%type, nr_seq_conta_p pls_conta.nr_sequencia%type, nr_seq_proc_rec_p pls_rec_glosa_proc.nr_sequencia%type, nr_seq_mat_rec_p pls_rec_glosa_mat.nr_sequencia%type, ie_origem_desp_p text) FROM PUBLIC;
