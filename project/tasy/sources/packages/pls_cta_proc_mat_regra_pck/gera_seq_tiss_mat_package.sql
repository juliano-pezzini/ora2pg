-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_cta_proc_mat_regra_pck.gera_seq_tiss_mat ( nr_seq_conta_mat_regra_p pls_conta_mat_regra.nr_sequencia%type, nr_seq_conta_regra_vinc_p pls_conta_proc_regra.nr_sequencia%type, ie_vinculo_proc_mat_p text, nr_seq_conta_p pls_conta.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE

_ora2pg_r RECORD;
/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade:	Gera um novo sequencial tiss para o item em questao, se nao o mesmo nao possuir

		se precisar vincular o item a um outro, tem que passar o sequencial do original
		
		Atualmente o sequencial tem que ser "reiniciado" a nivel de atendimento, a priori nao temos outra
		definicao de sua geracao da ANS, entao e utilizado o max
		
		ie_vinculo_proc_mat_p Define se o vinculo vira de um procedimento (P) ou material (M)
-------------------------------------------------------------------------------------------------------------------

Locais de chamada direta: 
[X]  Objetos do dicionario [ ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatorios [ ] Outros:
-------------------------------------------------------------------------------------------------------------------

Pontos de atencao: 

Alteracoes:

------------------------------------------------------------------------------------------------------------------

++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */


tb_nr_seq_conta_mat_regra_w	dbms_sql.number_table;
tb_nr_seq_item_tiss_w		dbms_sql.number_table;
tb_nr_seq_item_tiss_vinc_w	dbms_sql.number_table;

nr_seq_max_item_tiss_w		pls_conta_proc_regra.nr_seq_item_tiss_vinculo%type;

BEGIN

if	(nr_seq_conta_mat_regra_p IS NOT NULL AND nr_seq_conta_mat_regra_p::text <> '' AND nr_seq_conta_p IS NOT NULL AND nr_seq_conta_p::text <> '') then
	
	-- carrega o maximo seq tiss do atendimento

	select	max(pls_cta_proc_mat_regra_pck.get_max_seq_tiss_atend(a.nr_sequencia, a.nr_seq_segurado))
	into STRICT	nr_seq_max_item_tiss_w
	from	pls_conta	a
	where	a.nr_sequencia	= nr_seq_conta_p;
	
	-- carrega tudo na posicao "zero" dos vetores, pois so deve existir um registro

	select	max(c.nr_sequencia),
		coalesce(nr_seq_max_item_tiss_w,0) + 1,
		-- cuidado ao alterar o union, so pode retornar o conteudo de um deles sempre

		max((	select	max(t.nr_seq_item_tiss_vinculo)
				from (	select	max(x.nr_seq_item_tiss) nr_seq_item_tiss_vinculo
					from	pls_conta_proc_regra	x
					where	x.nr_sequencia		= nr_seq_conta_regra_vinc_p
					and	ie_vinculo_proc_mat_p	= 'P'
					
union all

					select	max(x.nr_seq_item_tiss) nr_seq_item_tiss_vinculo
					from	pls_conta_mat_regra	x
					where	x.nr_sequencia		= nr_seq_conta_regra_vinc_p
					and	ie_vinculo_proc_mat_p	= 'M') t )) nr_seq_item_tiss_vinculo
	into STRICT	tb_nr_seq_conta_mat_regra_w(0),
		tb_nr_seq_item_tiss_w(0),
		tb_nr_seq_item_tiss_vinc_w(0)
	from	pls_conta		a,
		pls_conta_mat		b,
		pls_conta_mat_regra	c
	where	b.nr_seq_conta		= a.nr_sequencia
	and	c.nr_sequencia		= b.nr_sequencia
	and	coalesce(c.nr_seq_item_tiss::text, '') = ''
	and	c.nr_sequencia		= nr_seq_conta_mat_regra_p;
	
	-- manda para o banco

	SELECT * FROM pls_cta_proc_mat_regra_pck.grava_seq_tiss_mat(	tb_nr_seq_conta_mat_regra_w, tb_nr_seq_item_tiss_w, tb_nr_seq_item_tiss_vinc_w, nm_usuario_p) INTO STRICT _ora2pg_r;
 	tb_nr_seq_conta_mat_regra_w := _ora2pg_r.tb_nr_seq_conta_mat_regra_p; tb_nr_seq_item_tiss_w := _ora2pg_r.tb_nr_seq_item_tiss_p; tb_nr_seq_item_tiss_vinc_w := _ora2pg_r.tb_nr_seq_item_tiss_vinc_p;
	
end if;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_cta_proc_mat_regra_pck.gera_seq_tiss_mat ( nr_seq_conta_mat_regra_p pls_conta_mat_regra.nr_sequencia%type, nr_seq_conta_regra_vinc_p pls_conta_proc_regra.nr_sequencia%type, ie_vinculo_proc_mat_p text, nr_seq_conta_p pls_conta.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;
