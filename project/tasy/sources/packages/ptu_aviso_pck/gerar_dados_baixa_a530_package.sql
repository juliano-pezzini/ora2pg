-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


-- Gerar dados de baixa do A530



CREATE OR REPLACE PROCEDURE ptu_aviso_pck.gerar_dados_baixa_a530 ( nr_seq_arquivo_p ptu_aviso_arquivo.nr_sequencia%type, ie_motivo_baixa_p ptu_aviso_glosa_bx_dados.ie_motivo_baixa%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE


nr_seq_glosa_baixa_w		ptu_aviso_glosa_bx.nr_sequencia%type;

c01 CURSOR( nr_seq_arquivo_pc	ptu_aviso_arquivo.nr_sequencia%type ) FOR
	SELECT	aa.nr_sequencia nr_seq_arquivo,
		aa.cd_unimed_origem,
		aa.cd_unimed_destino,
		coalesce(ptu_obter_versao_transacao( 'A530',coalesce(pls_obter_versao_ptu( la.cd_estabelecimento, aa.nr_seq_congenere, clock_timestamp(), 'A530'),'10.0')),'01') nr_versao_transacao,
		aa.cd_unimed_origem cd_unimed_aviso,
		aa.dt_transacao dt_conhecimento,
		coalesce(ac.cd_cpf_executante,ac.cd_cnpj_executante) cd_cnpj_cpf,
		aa.nr_lote,
		ac.nr_guia_prestador,
		aa.cd_unimed_destino cd_unimed_benef,
		substr(ac.nr_carteira_benef,4,13) cd_identificacao_benef
	from	ptu_lote_aviso		la,
		ptu_aviso_arquivo	aa,
		ptu_aviso_protocolo	ap,
		ptu_aviso_conta		ac
	where	la.nr_sequencia	= aa.nr_seq_lote
	and	aa.nr_sequencia	= ap.nr_seq_arquivo
	and	ap.nr_sequencia	= ac.nr_seq_aviso_protocolo
	and	aa.nr_sequencia	= nr_seq_arquivo_pc
	and	not exists (	SELECT	1
				from	ptu_aviso_glosa_bx	 gb,
					ptu_aviso_glosa_bx_dados bd
				where	gb.nr_sequencia		= bd.nr_seq_glosa_baixa
				and	gb.nr_seq_arquivo	= nr_seq_arquivo_pc
				and	bd.ie_tipo_glosa_baixa	= '2');

BEGIN
for r_c01_w in c01( nr_seq_arquivo_p ) loop
	insert into ptu_aviso_glosa_bx(nr_sequencia,				dt_atualizacao,			nm_usuario,
		dt_atualizacao_nrec,			nm_usuario_nrec,		nr_seq_arquivo,
		cd_unimed_origem,			cd_unimed_destino,		nr_versao_transacao,
		ds_hash,				ie_status)
	values (nextval('ptu_aviso_glosa_bx_seq'),	clock_timestamp(),			nm_usuario_p,
		clock_timestamp(),				nm_usuario_p,			r_c01_w.nr_seq_arquivo,
		r_c01_w.cd_unimed_origem,		r_c01_w.cd_unimed_destino,	r_c01_w.nr_versao_transacao,
		null,					'1') returning nr_sequencia into nr_seq_glosa_baixa_w;

	insert into ptu_aviso_glosa_bx_dados(nr_sequencia,				dt_atualizacao,			nm_usuario,
		dt_atualizacao_nrec,			nm_usuario_nrec,		nr_seq_glosa_baixa,
		ie_tipo_glosa_baixa,			ie_motivo_baixa,		cd_unimed_aviso,
		dt_conhecimento,			cd_cnpj_cpf,			nr_lote_prestador,
		nr_guia_tiss_prestador,			cd_unimed_benef,		cd_identificacao_benef)
	values (nextval('ptu_aviso_glosa_bx_dados_seq'),	clock_timestamp(),			nm_usuario_p,
		clock_timestamp(),				nm_usuario_p,			nr_seq_glosa_baixa_w,
		'2',					ie_motivo_baixa_p,		r_c01_w.cd_unimed_aviso,
		r_c01_w.dt_conhecimento,		r_c01_w.cd_cnpj_cpf,		r_c01_w.nr_lote,
		r_c01_w.nr_guia_prestador,		r_c01_w.cd_unimed_benef,	r_c01_w.cd_identificacao_benef);
end loop;

commit;
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ptu_aviso_pck.gerar_dados_baixa_a530 ( nr_seq_arquivo_p ptu_aviso_arquivo.nr_sequencia%type, ie_motivo_baixa_p ptu_aviso_glosa_bx_dados.ie_motivo_baixa%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;
