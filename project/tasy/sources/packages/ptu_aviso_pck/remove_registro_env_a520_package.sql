-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



-- Remove lote para enviar o arquivo A520 com detalhamento do nivel que deseja desfazer



CREATE OR REPLACE PROCEDURE ptu_aviso_pck.remove_registro_env_a520 ( nr_seq_lote_p ptu_lote_aviso.nr_sequencia%type, nr_seq_arquivo_p ptu_aviso_arquivo.nr_sequencia%type, nr_seq_aviso_protocolo_p ptu_aviso_protocolo.nr_sequencia%type, nr_seq_aviso_conta_p ptu_aviso_conta.nr_sequencia%type, nr_seq_aviso_decla_p ptu_aviso_declaracao.nr_sequencia%type, nr_seq_aviso_mat_p ptu_aviso_material.nr_sequencia%type, nr_seq_aviso_proc_p ptu_aviso_procedimento.nr_sequencia%type, nr_seq_aviso_part_p ptu_aviso_participante.nr_sequencia%type) AS $body$
DECLARE

/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade:	Remove os registros do lote de envio de A520, conforme o nivel passado pelos parametros
-------------------------------------------------------------------------------------------------------------------

Pontos de atencao:

			A rotina vai apagar APENAS um nivel hierarquico. Se for passado dois parametros de mesmo nivel, por
			exemplo nr_seq_aviso_proc_p e nr_seq_aviso_mat_p ao mesmo tempo, a rotina pode decidir excluir nenhum deles.
			
			Isso e necessario devido as travas de segurancao por nivel, para impedir falsos positivos e acabar excluindo
			um nivel superior ao desejado, causando perda de dados
			
			Toda a estrutura deve respeitar os niveis de detalhamento passado nos parametros, SEMPRE apagando
			com base no nivel mais restritivo, apenas.
			
			Ao adicionar um novo parametro ou tabela, tera de ver ocmo encaixar nos niveis, e tambem adicionar nas
			demais rotinas pertinentes, por exemplo, o nivel de lote e o maior nivel, e so vai ter efeito se todos
			os demais parametros estiverem null. Atualmente o menor e mais restritivo nivel e o de participante, logo
			essa rotina vai possuir os union de todos os demais niveis, desde o lote, ate o participante, sendo este ultimo
			apenas sera executado se tiver inf o parametro de participante(independente dos demais)
			
			
			
			
Alteracoes:
-------------------------------------------------------------------------------------------------------------------

++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */

-- Atributo utilizado para a contabilidade instantanea

ie_concil_contab_w	pls_visible_false.ie_concil_contab%type;

BEGIN

-- Contabilidade instantanea

select	coalesce(max(ie_concil_contab), 'N')
into STRICT	ie_concil_contab_w
from	pls_visible_false;

if (ie_concil_contab_w = 'S') then
	CALL pls_ctb_onl_gravar_movto_pck.gravar_movto_exclusao_a520(nr_seq_arquivo_p);
end if;

-- so vai apagar o log, quando for desfeito o lote inteiro

delete	FROM ptu_aviso_log_ws l
where	l.nr_seq_arquivo	in (	SELECT	a.nr_sequencia
					from	ptu_aviso_arquivo	a
					where	a.nr_seq_lote		= nr_seq_lote_p);
					
delete	FROM ptu_aviso_participante x
where	x.nr_sequencia 	in (	-- por lote
				SELECT	ap.nr_sequencia
				from	ptu_aviso_participante		ap,
					ptu_aviso_procedimento		pr,
					ptu_aviso_conta			c,
					ptu_aviso_protocolo		p,
					ptu_aviso_arquivo		a
				where	a.nr_sequencia			= p.nr_seq_arquivo
				and	p.nr_sequencia			= c.nr_seq_aviso_protocolo
				and	c.nr_sequencia			= pr.nr_seq_aviso_conta
				and	ap.nr_seq_aviso_procedimento	= pr.nr_sequencia
				and	a.nr_seq_lote			= nr_seq_lote_p
				and	coalesce(nr_seq_arquivo_p::text, '') = ''
				and	coalesce(nr_seq_aviso_protocolo_p::text, '') = ''
				and	coalesce(nr_seq_aviso_conta_p::text, '') = ''
				and	coalesce(nr_seq_aviso_proc_p::text, '') = ''
				and	coalesce(nr_seq_aviso_part_p::text, '') = ''
				and	coalesce(nr_seq_aviso_decla_p::text, '') = ''
				and	coalesce(nr_seq_aviso_mat_p::text, '') = ''
				
union all

				-- por arquivo

				SELECT	ap.nr_sequencia
				from	ptu_aviso_participante		ap,
					ptu_aviso_procedimento		pr,
					ptu_aviso_conta			c,
					ptu_aviso_protocolo		p,
					ptu_aviso_arquivo		a
				where	a.nr_sequencia			= p.nr_seq_arquivo
				and	p.nr_sequencia			= c.nr_seq_aviso_protocolo
				and	c.nr_sequencia			= pr.nr_seq_aviso_conta
				and	ap.nr_seq_aviso_procedimento	= pr.nr_sequencia
				and	a.nr_sequencia			= nr_seq_arquivo_p
				and	coalesce(nr_seq_aviso_protocolo_p::text, '') = ''
				and	coalesce(nr_seq_aviso_conta_p::text, '') = ''
				and	coalesce(nr_seq_aviso_proc_p::text, '') = ''
				and	coalesce(nr_seq_aviso_part_p::text, '') = ''
				and	coalesce(nr_seq_aviso_decla_p::text, '') = ''
				and	coalesce(nr_seq_aviso_mat_p::text, '') = ''
				
union all

				-- por protocolo

				select	ap.nr_sequencia
				from	ptu_aviso_participante		ap,
					ptu_aviso_procedimento		pr,
					ptu_aviso_conta			c,
					ptu_aviso_protocolo		p
				where	p.nr_sequencia			= c.nr_seq_aviso_protocolo
				and	c.nr_sequencia			= pr.nr_seq_aviso_conta
				and	ap.nr_seq_aviso_procedimento	= pr.nr_sequencia
				and	p.nr_sequencia			= nr_seq_aviso_protocolo_p
				and	coalesce(nr_seq_aviso_conta_p::text, '') = ''
				and	coalesce(nr_seq_aviso_proc_p::text, '') = ''
				and	coalesce(nr_seq_aviso_part_p::text, '') = ''
				and	coalesce(nr_seq_aviso_decla_p::text, '') = ''
				and	coalesce(nr_seq_aviso_mat_p::text, '') = ''
				
union all

				-- por conta

				select	ap.nr_sequencia
				from	ptu_aviso_participante		ap,
					ptu_aviso_procedimento		pr,
					ptu_aviso_conta			c
				where	c.nr_sequencia			= pr.nr_seq_aviso_conta
				and	ap.nr_seq_aviso_procedimento	= pr.nr_sequencia
				and	c.nr_sequencia			= nr_seq_aviso_conta_p
				and	coalesce(nr_seq_aviso_proc_p::text, '') = ''
				and	coalesce(nr_seq_aviso_part_p::text, '') = ''
				and	coalesce(nr_seq_aviso_decla_p::text, '') = ''
				and	coalesce(nr_seq_aviso_mat_p::text, '') = ''
				
union all

				-- por procedimento

				select	ap.nr_sequencia
				from	ptu_aviso_participante		ap,
					ptu_aviso_procedimento		pr
				where	ap.nr_seq_aviso_procedimento	= pr.nr_sequencia
				and	pr.nr_sequencia			= nr_seq_aviso_proc_p
				and	coalesce(nr_seq_aviso_part_p::text, '') = ''
				and	coalesce(nr_seq_aviso_decla_p::text, '') = ''
				and	coalesce(nr_seq_aviso_mat_p::text, '') = ''
				
union all

				-- por participante

				select	ap.nr_sequencia
				from	ptu_aviso_participante	ap
				where	ap.nr_sequencia		= nr_seq_aviso_part_p
				and	coalesce(nr_seq_aviso_decla_p::text, '') = ''
				and	coalesce(nr_seq_aviso_mat_p::text, '') = '');

delete  FROM ptu_aviso_proc_item x
where	x.nr_seq_aviso_procedimento	in (	-- por lote
						SELECT	d.nr_sequencia
						from	ptu_aviso_procedimento		d,
							ptu_aviso_conta			c,
							ptu_aviso_protocolo		p,
							ptu_aviso_arquivo		a
						where	a.nr_sequencia			= p.nr_seq_arquivo
						and	p.nr_sequencia			= c.nr_seq_aviso_protocolo
						and	d.nr_seq_aviso_conta		= c.nr_sequencia
						and	a.nr_seq_lote			= nr_seq_lote_p
						and	coalesce(nr_seq_arquivo_p::text, '') = ''
						and	coalesce(nr_seq_aviso_protocolo_p::text, '') = ''
						and	coalesce(nr_seq_aviso_conta_p::text, '') = ''
						and	coalesce(nr_seq_aviso_proc_p::text, '') = ''
						and	coalesce(nr_seq_aviso_decla_p::text, '') = ''
						and	coalesce(nr_seq_aviso_mat_p::text, '') = ''
						
union all

						-- por arquivo

						SELECT	d.nr_sequencia
						from	ptu_aviso_procedimento		d,
							ptu_aviso_conta			c,
							ptu_aviso_protocolo		p,
							ptu_aviso_arquivo		a
						where	a.nr_sequencia			= p.nr_seq_arquivo
						and	p.nr_sequencia			= c.nr_seq_aviso_protocolo
						and	d.nr_seq_aviso_conta		= c.nr_sequencia
						and	a.nr_sequencia			= nr_seq_arquivo_p
						and	coalesce(nr_seq_aviso_protocolo_p::text, '') = ''
						and	coalesce(nr_seq_aviso_conta_p::text, '') = ''
						and	coalesce(nr_seq_aviso_proc_p::text, '') = ''
						and	coalesce(nr_seq_aviso_decla_p::text, '') = ''
						and	coalesce(nr_seq_aviso_mat_p::text, '') = ''
						
union all

						-- por protocolo

						select	d.nr_sequencia
						from	ptu_aviso_procedimento		d,
							ptu_aviso_conta			c,
							ptu_aviso_protocolo		p
						where	p.nr_sequencia			= c.nr_seq_aviso_protocolo
						and	d.nr_seq_aviso_conta		= c.nr_sequencia
						and	p.nr_sequencia			= nr_seq_aviso_protocolo_p
						and	coalesce(nr_seq_aviso_conta_p::text, '') = ''
						and	coalesce(nr_seq_aviso_proc_p::text, '') = ''
						and	coalesce(nr_seq_aviso_decla_p::text, '') = ''
						and	coalesce(nr_seq_aviso_mat_p::text, '') = ''
						
union all

						-- por conta

						select	d.nr_sequencia
						from	ptu_aviso_procedimento		d,
							ptu_aviso_conta			c
						where	d.nr_seq_aviso_conta		= c.nr_sequencia
						and	c.nr_sequencia			= nr_seq_aviso_conta_p
						and	coalesce(nr_seq_aviso_proc_p::text, '') = ''
						and	coalesce(nr_seq_aviso_decla_p::text, '') = ''
						and	coalesce(nr_seq_aviso_mat_p::text, '') = ''
						
union all

						-- por procedimento

						select	d.nr_sequencia
						from	ptu_aviso_procedimento		d
						where	d.nr_sequencia			= nr_seq_aviso_proc_p
						and	coalesce(nr_seq_aviso_decla_p::text, '') = ''
						and	coalesce(nr_seq_aviso_mat_p::text, '') = '');

delete  FROM ptu_aviso_mat_item x
where	x.nr_seq_aviso_material	in (	-- por lote
					SELECT	d.nr_sequencia
					from	ptu_aviso_material		d,
						ptu_aviso_conta			c,
						ptu_aviso_protocolo		p,
						ptu_aviso_arquivo		a
					where	a.nr_sequencia			= p.nr_seq_arquivo
					and	p.nr_sequencia			= c.nr_seq_aviso_protocolo
					and	d.nr_seq_aviso_conta		= c.nr_sequencia
					and	a.nr_seq_lote			= nr_seq_lote_p
					and	coalesce(nr_seq_arquivo_p::text, '') = ''
					and	coalesce(nr_seq_aviso_protocolo_p::text, '') = ''
					and	coalesce(nr_seq_aviso_conta_p::text, '') = ''
					and	coalesce(nr_seq_aviso_mat_p::text, '') = ''
					and	coalesce(nr_seq_aviso_decla_p::text, '') = ''
					and	coalesce(nr_seq_aviso_proc_p::text, '') = ''
					
union all

					-- por arquivo

					SELECT	d.nr_sequencia
					from	ptu_aviso_material		d,
						ptu_aviso_conta			c,
						ptu_aviso_protocolo		p,
						ptu_aviso_arquivo		a
					where	a.nr_sequencia			= p.nr_seq_arquivo
					and	p.nr_sequencia			= c.nr_seq_aviso_protocolo
					and	d.nr_seq_aviso_conta		= c.nr_sequencia
					and	a.nr_sequencia			= nr_seq_arquivo_p
					and	coalesce(nr_seq_aviso_protocolo_p::text, '') = ''
					and	coalesce(nr_seq_aviso_conta_p::text, '') = ''
					and	coalesce(nr_seq_aviso_mat_p::text, '') = ''
					and	coalesce(nr_seq_aviso_decla_p::text, '') = ''
					and	coalesce(nr_seq_aviso_proc_p::text, '') = ''
					
union all

					-- por protocolo

					select	d.nr_sequencia
					from	ptu_aviso_material		d,
						ptu_aviso_conta			c,
						ptu_aviso_protocolo		p
					where	p.nr_sequencia			= c.nr_seq_aviso_protocolo
					and	d.nr_seq_aviso_conta		= c.nr_sequencia
					and	p.nr_sequencia			= nr_seq_aviso_protocolo_p
					and	coalesce(nr_seq_aviso_conta_p::text, '') = ''
					and	coalesce(nr_seq_aviso_mat_p::text, '') = ''
					and	coalesce(nr_seq_aviso_decla_p::text, '') = ''
					and	coalesce(nr_seq_aviso_proc_p::text, '') = ''
					
union all

					-- por conta

					select	d.nr_sequencia
					from	ptu_aviso_material		d,
						ptu_aviso_conta			c
					where	d.nr_seq_aviso_conta		= c.nr_sequencia
					and	c.nr_sequencia			= nr_seq_aviso_conta_p
					and	coalesce(nr_seq_aviso_mat_p::text, '') = ''
					and	coalesce(nr_seq_aviso_decla_p::text, '') = ''
					and	coalesce(nr_seq_aviso_proc_p::text, '') = ''
					
union all

					-- por material

					select	d.nr_sequencia
					from	ptu_aviso_material		d
					where	d.nr_sequencia			= nr_seq_aviso_mat_p
					and	coalesce(nr_seq_aviso_decla_p::text, '') = ''
					and	coalesce(nr_seq_aviso_proc_p::text, '') = '');



delete	FROM ptu_aviso_procedimento x
where	x.nr_sequencia	in (	-- por lote
				SELECT	d.nr_sequencia
				from	ptu_aviso_procedimento		d,
					ptu_aviso_conta			c,
					ptu_aviso_protocolo		p,
					ptu_aviso_arquivo		a
				where	a.nr_sequencia			= p.nr_seq_arquivo
				and	p.nr_sequencia			= c.nr_seq_aviso_protocolo
				and	d.nr_seq_aviso_conta		= c.nr_sequencia
				and	a.nr_seq_lote			= nr_seq_lote_p
				and	coalesce(nr_seq_arquivo_p::text, '') = ''
				and	coalesce(nr_seq_aviso_protocolo_p::text, '') = ''
				and	coalesce(nr_seq_aviso_conta_p::text, '') = ''
				and	coalesce(nr_seq_aviso_proc_p::text, '') = ''
				and	coalesce(nr_seq_aviso_part_p::text, '') = ''
				and	coalesce(nr_seq_aviso_decla_p::text, '') = ''
				and	coalesce(nr_seq_aviso_mat_p::text, '') = ''
				
union all

				-- por arquivo

				SELECT	d.nr_sequencia
				from	ptu_aviso_procedimento		d,
					ptu_aviso_conta			c,
					ptu_aviso_protocolo		p,
					ptu_aviso_arquivo		a
				where	a.nr_sequencia			= p.nr_seq_arquivo
				and	p.nr_sequencia			= c.nr_seq_aviso_protocolo
				and	d.nr_seq_aviso_conta		= c.nr_sequencia
				and	a.nr_sequencia			= nr_seq_arquivo_p
				and	coalesce(nr_seq_aviso_protocolo_p::text, '') = ''
				and	coalesce(nr_seq_aviso_conta_p::text, '') = ''
				and	coalesce(nr_seq_aviso_proc_p::text, '') = ''
				and	coalesce(nr_seq_aviso_part_p::text, '') = ''
				and	coalesce(nr_seq_aviso_decla_p::text, '') = ''
				and	coalesce(nr_seq_aviso_mat_p::text, '') = ''
				
union all

				-- por protocolo

				select	d.nr_sequencia
				from	ptu_aviso_procedimento		d,
					ptu_aviso_conta			c,
					ptu_aviso_protocolo		p
				where	p.nr_sequencia			= c.nr_seq_aviso_protocolo
				and	d.nr_seq_aviso_conta		= c.nr_sequencia
				and	p.nr_sequencia			= nr_seq_aviso_protocolo_p
				and	coalesce(nr_seq_aviso_conta_p::text, '') = ''
				and	coalesce(nr_seq_aviso_proc_p::text, '') = ''
				and	coalesce(nr_seq_aviso_part_p::text, '') = ''
				and	coalesce(nr_seq_aviso_decla_p::text, '') = ''
				and	coalesce(nr_seq_aviso_mat_p::text, '') = ''
				
union all

				-- por conta

				select	d.nr_sequencia
				from	ptu_aviso_procedimento		d,
					ptu_aviso_conta			c
				where	d.nr_seq_aviso_conta		= c.nr_sequencia
				and	c.nr_sequencia			= nr_seq_aviso_conta_p
				and	coalesce(nr_seq_aviso_proc_p::text, '') = ''
				and	coalesce(nr_seq_aviso_part_p::text, '') = ''
				and	coalesce(nr_seq_aviso_decla_p::text, '') = ''
				and	coalesce(nr_seq_aviso_mat_p::text, '') = ''
				
union all

				-- por procedimento

				select	d.nr_sequencia
				from	ptu_aviso_procedimento		d
				where	d.nr_sequencia			= nr_seq_aviso_proc_p
				and	coalesce(nr_seq_aviso_part_p::text, '') = '' /* para os casos aonde foi apagado apenas os participantes*/

				and	coalesce(nr_seq_aviso_decla_p::text, '') = ''
				and	coalesce(nr_seq_aviso_mat_p::text, '') = '');
					
delete	FROM ptu_aviso_material x
where	x.nr_sequencia	in (	-- por lote
				SELECT	d.nr_sequencia
				from	ptu_aviso_material		d,
					ptu_aviso_conta			c,
					ptu_aviso_protocolo		p,
					ptu_aviso_arquivo		a
				where	a.nr_sequencia			= p.nr_seq_arquivo
				and	p.nr_sequencia			= c.nr_seq_aviso_protocolo
				and	d.nr_seq_aviso_conta		= c.nr_sequencia
				and	a.nr_seq_lote			= nr_seq_lote_p
				and	coalesce(nr_seq_arquivo_p::text, '') = ''
				and	coalesce(nr_seq_aviso_protocolo_p::text, '') = ''
				and	coalesce(nr_seq_aviso_conta_p::text, '') = ''
				and	coalesce(nr_seq_aviso_mat_p::text, '') = ''
				and	coalesce(nr_seq_aviso_part_p::text, '') = ''
				and	coalesce(nr_seq_aviso_decla_p::text, '') = ''
				and	coalesce(nr_seq_aviso_proc_p::text, '') = ''
				
union all

				-- por arquivo

				SELECT	d.nr_sequencia
				from	ptu_aviso_material		d,
					ptu_aviso_conta			c,
					ptu_aviso_protocolo		p,
					ptu_aviso_arquivo		a
				where	a.nr_sequencia			= p.nr_seq_arquivo
				and	p.nr_sequencia			= c.nr_seq_aviso_protocolo
				and	d.nr_seq_aviso_conta		= c.nr_sequencia
				and	a.nr_sequencia			= nr_seq_arquivo_p
				and	coalesce(nr_seq_aviso_protocolo_p::text, '') = ''
				and	coalesce(nr_seq_aviso_conta_p::text, '') = ''
				and	coalesce(nr_seq_aviso_mat_p::text, '') = ''
				and	coalesce(nr_seq_aviso_part_p::text, '') = ''
				and	coalesce(nr_seq_aviso_decla_p::text, '') = ''
				and	coalesce(nr_seq_aviso_proc_p::text, '') = ''
				
union all

				-- por protocolo

				select	d.nr_sequencia
				from	ptu_aviso_material		d,
					ptu_aviso_conta			c,
					ptu_aviso_protocolo		p
				where	p.nr_sequencia			= c.nr_seq_aviso_protocolo
				and	d.nr_seq_aviso_conta		= c.nr_sequencia
				and	p.nr_sequencia			= nr_seq_aviso_protocolo_p
				and	coalesce(nr_seq_aviso_conta_p::text, '') = ''
				and	coalesce(nr_seq_aviso_mat_p::text, '') = ''
				and	coalesce(nr_seq_aviso_part_p::text, '') = ''
				and	coalesce(nr_seq_aviso_decla_p::text, '') = ''
				and	coalesce(nr_seq_aviso_proc_p::text, '') = ''
				
union all

				-- por conta

				select	d.nr_sequencia
				from	ptu_aviso_material		d,
					ptu_aviso_conta			c
				where	d.nr_seq_aviso_conta		= c.nr_sequencia
				and	c.nr_sequencia			= nr_seq_aviso_conta_p
				and	coalesce(nr_seq_aviso_mat_p::text, '') = ''
				and	coalesce(nr_seq_aviso_part_p::text, '') = ''
				and	coalesce(nr_seq_aviso_decla_p::text, '') = ''
				and	coalesce(nr_seq_aviso_proc_p::text, '') = ''
				
union all

				-- por material

				select	d.nr_sequencia
				from	ptu_aviso_material		d
				where	d.nr_sequencia			= nr_seq_aviso_mat_p
				and	coalesce(nr_seq_aviso_part_p::text, '') = '' /* para os casos aonde foi apagado apenas os participantes*/

				and	coalesce(nr_seq_aviso_decla_p::text, '') = ''
				and	coalesce(nr_seq_aviso_proc_p::text, '') = '');
				
delete	FROM ptu_aviso_declaracao x
where	x.nr_sequencia	in (	-- por lote
				SELECT	d.nr_sequencia
				from	ptu_aviso_declaracao		d,
					ptu_aviso_conta			c,
					ptu_aviso_protocolo		p,
					ptu_aviso_arquivo		a
				where	a.nr_sequencia			= p.nr_seq_arquivo
				and	p.nr_sequencia			= c.nr_seq_aviso_protocolo
				and	d.nr_seq_aviso_conta		= c.nr_sequencia
				and	a.nr_seq_lote			= nr_seq_lote_p
				and	coalesce(nr_seq_arquivo_p::text, '') = ''
				and	coalesce(nr_seq_aviso_protocolo_p::text, '') = ''
				and	coalesce(nr_seq_aviso_conta_p::text, '') = ''
				and	coalesce(nr_seq_aviso_mat_p::text, '') = ''
				and	coalesce(nr_seq_aviso_part_p::text, '') = ''
				and	coalesce(nr_seq_aviso_proc_p::text, '') = ''
				and	coalesce(nr_seq_aviso_decla_p::text, '') = ''
				
union all

				-- por arquivo

				SELECT	d.nr_sequencia
				from	ptu_aviso_declaracao		d,
					ptu_aviso_conta			c,
					ptu_aviso_protocolo		p,
					ptu_aviso_arquivo		a
				where	a.nr_sequencia			= p.nr_seq_arquivo
				and	p.nr_sequencia			= c.nr_seq_aviso_protocolo
				and	d.nr_seq_aviso_conta		= c.nr_sequencia
				and	a.nr_sequencia			= nr_seq_arquivo_p
				and	coalesce(nr_seq_aviso_protocolo_p::text, '') = ''
				and	coalesce(nr_seq_aviso_conta_p::text, '') = ''
				and	coalesce(nr_seq_aviso_mat_p::text, '') = ''
				and	coalesce(nr_seq_aviso_part_p::text, '') = ''
				and	coalesce(nr_seq_aviso_proc_p::text, '') = ''
				and	coalesce(nr_seq_aviso_decla_p::text, '') = ''
				
union all

				-- por protocolo

				select	d.nr_sequencia
				from	ptu_aviso_declaracao		d,
					ptu_aviso_conta			c,
					ptu_aviso_protocolo		p
				where	p.nr_sequencia			= c.nr_seq_aviso_protocolo
				and	d.nr_seq_aviso_conta		= c.nr_sequencia
				and	p.nr_sequencia			= nr_seq_aviso_protocolo_p
				and	coalesce(nr_seq_aviso_conta_p::text, '') = ''
				and	coalesce(nr_seq_aviso_mat_p::text, '') = ''
				and	coalesce(nr_seq_aviso_part_p::text, '') = ''
				and	coalesce(nr_seq_aviso_proc_p::text, '') = ''
				and	coalesce(nr_seq_aviso_decla_p::text, '') = ''
				
union all

				-- por conta

				select	d.nr_sequencia
				from	ptu_aviso_declaracao		d,
					ptu_aviso_conta			c
				where	d.nr_seq_aviso_conta		= c.nr_sequencia
				and	c.nr_sequencia			= nr_seq_aviso_conta_p
				and	coalesce(nr_seq_aviso_mat_p::text, '') = ''
				and	coalesce(nr_seq_aviso_part_p::text, '') = ''
				and	coalesce(nr_seq_aviso_proc_p::text, '') = ''
				and	coalesce(nr_seq_aviso_decla_p::text, '') = ''
				
union all

				-- por declaracao

				select	d.nr_sequencia
				from	ptu_aviso_declaracao		d
				where	nr_seq_aviso_decla_p		= d.nr_sequencia
				and	coalesce(nr_seq_aviso_mat_p::text, '') = ''
				and	coalesce(nr_seq_aviso_part_p::text, '') = ''
				and	coalesce(nr_seq_aviso_proc_p::text, '') = '');
					
delete	FROM ptu_aviso_conta x
where	x.nr_sequencia in (	-- por lote
				SELECT	c.nr_sequencia
				from	ptu_aviso_conta			c,
					ptu_aviso_protocolo		p,
					ptu_aviso_arquivo		a
				where	a.nr_sequencia			= p.nr_seq_arquivo
				and	p.nr_sequencia			= c.nr_seq_aviso_protocolo
				and	a.nr_seq_lote			= nr_seq_lote_p
				and	coalesce(nr_seq_arquivo_p::text, '') = ''
				and	coalesce(nr_seq_aviso_protocolo_p::text, '') = ''
				and	coalesce(nr_seq_aviso_conta_p::text, '') = ''
				and	coalesce(nr_seq_aviso_mat_p::text, '') = ''
				and	coalesce(nr_seq_aviso_part_p::text, '') = ''
				and	coalesce(nr_seq_aviso_proc_p::text, '') = ''
				and	coalesce(nr_seq_aviso_decla_p::text, '') = ''
				
union all

				-- por arquivo

				SELECT	c.nr_sequencia
				from	ptu_aviso_conta			c,
					ptu_aviso_protocolo		p,
					ptu_aviso_arquivo		a
				where	a.nr_sequencia			= p.nr_seq_arquivo
				and	p.nr_sequencia			= c.nr_seq_aviso_protocolo
				and	a.nr_sequencia			= nr_seq_arquivo_p
				and	coalesce(nr_seq_aviso_protocolo_p::text, '') = ''
				and	coalesce(nr_seq_aviso_conta_p::text, '') = ''
				and	coalesce(nr_seq_aviso_mat_p::text, '') = ''
				and	coalesce(nr_seq_aviso_part_p::text, '') = ''
				and	coalesce(nr_seq_aviso_proc_p::text, '') = ''
				and	coalesce(nr_seq_aviso_decla_p::text, '') = ''
				
union all

				-- por protocolo

				select	c.nr_sequencia
				from	ptu_aviso_conta			c,
					ptu_aviso_protocolo		p
				where	p.nr_sequencia			= c.nr_seq_aviso_protocolo
				and	p.nr_sequencia			= nr_seq_aviso_protocolo_p
				and	coalesce(nr_seq_aviso_conta_p::text, '') = ''
				and	coalesce(nr_seq_aviso_mat_p::text, '') = ''
				and	coalesce(nr_seq_aviso_part_p::text, '') = ''
				and	coalesce(nr_seq_aviso_proc_p::text, '') = ''
				and	coalesce(nr_seq_aviso_decla_p::text, '') = ''
				
union all

				-- por conta

				select	c.nr_sequencia
				from	ptu_aviso_conta			c
				where	c.nr_sequencia			= nr_seq_aviso_conta_p
				and	coalesce(nr_seq_aviso_mat_p::text, '') = ''
				and	coalesce(nr_seq_aviso_part_p::text, '') = ''
				and	coalesce(nr_seq_aviso_proc_p::text, '') = ''
				and	coalesce(nr_seq_aviso_decla_p::text, '') = '');
					
delete	FROM ptu_aviso_protocolo x
where	x.nr_sequencia	in (	-- por lote
				SELECT	a.nr_sequencia
				from	ptu_aviso_protocolo		a,
					ptu_aviso_arquivo		b
				where	a.nr_seq_arquivo		= b.nr_sequencia
				and	b.nr_seq_lote			= nr_seq_lote_p
				and	coalesce(nr_seq_arquivo_p::text, '') = ''
				and	coalesce(nr_seq_aviso_protocolo_p::text, '') = ''
				and	coalesce(nr_seq_aviso_conta_p::text, '') = ''
				and	coalesce(nr_seq_aviso_mat_p::text, '') = ''
				and	coalesce(nr_seq_aviso_part_p::text, '') = ''
				and	coalesce(nr_seq_aviso_proc_p::text, '') = ''
				and	coalesce(nr_seq_aviso_decla_p::text, '') = ''
				
union all

				-- por arquivo

				SELECT	a.nr_sequencia
				from	ptu_aviso_protocolo		a,
					ptu_aviso_arquivo		b
				where	a.nr_seq_arquivo		= b.nr_sequencia
				and	b.nr_sequencia			= nr_seq_arquivo_p
				and	coalesce(nr_seq_aviso_protocolo_p::text, '') = ''
				and	coalesce(nr_seq_aviso_conta_p::text, '') = ''
				and	coalesce(nr_seq_aviso_mat_p::text, '') = ''
				and	coalesce(nr_seq_aviso_part_p::text, '') = ''
				and	coalesce(nr_seq_aviso_proc_p::text, '') = ''
				and	coalesce(nr_seq_aviso_decla_p::text, '') = ''
				
union all

				-- por protocolo

				select	a.nr_sequencia
				from	ptu_aviso_protocolo		a
				where	a.nr_sequencia			= nr_seq_aviso_protocolo_p
				and	coalesce(nr_seq_aviso_conta_p::text, '') = ''
				and	coalesce(nr_seq_aviso_mat_p::text, '') = ''
				and	coalesce(nr_seq_aviso_part_p::text, '') = ''
				and	coalesce(nr_seq_aviso_proc_p::text, '') = ''
				and	coalesce(nr_seq_aviso_decla_p::text, '') = '');
					
if (nr_seq_lote_p IS NOT NULL AND nr_seq_lote_p::text <> '') then
	delete	FROM ptu_aviso_arquivo a
	where	a.nr_seq_lote			= nr_seq_lote_p
	and	coalesce(nr_seq_arquivo_p::text, '') = ''
	and	coalesce(nr_seq_aviso_protocolo_p::text, '') = ''
	and	coalesce(nr_seq_aviso_conta_p::text, '') = ''
	and	coalesce(nr_seq_aviso_mat_p::text, '') = ''
	and	coalesce(nr_seq_aviso_part_p::text, '') = ''
	and	coalesce(nr_seq_aviso_proc_p::text, '') = ''
	and	coalesce(nr_seq_aviso_decla_p::text, '') = '';
	
elsif (nr_seq_arquivo_p IS NOT NULL AND nr_seq_arquivo_p::text <> '') then
	delete	FROM ptu_aviso_arquivo a
	where	a.nr_sequencia			= nr_seq_arquivo_p
	and	coalesce(nr_seq_lote_p::text, '') = ''
	and	coalesce(nr_seq_aviso_protocolo_p::text, '') = ''
	and	coalesce(nr_seq_aviso_conta_p::text, '') = ''
	and	coalesce(nr_seq_aviso_mat_p::text, '') = ''
	and	coalesce(nr_seq_aviso_part_p::text, '') = ''
	and	coalesce(nr_seq_aviso_proc_p::text, '') = ''
	and	coalesce(nr_seq_aviso_decla_p::text, '') = '';
end if;

commit;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ptu_aviso_pck.remove_registro_env_a520 ( nr_seq_lote_p ptu_lote_aviso.nr_sequencia%type, nr_seq_arquivo_p ptu_aviso_arquivo.nr_sequencia%type, nr_seq_aviso_protocolo_p ptu_aviso_protocolo.nr_sequencia%type, nr_seq_aviso_conta_p ptu_aviso_conta.nr_sequencia%type, nr_seq_aviso_decla_p ptu_aviso_declaracao.nr_sequencia%type, nr_seq_aviso_mat_p ptu_aviso_material.nr_sequencia%type, nr_seq_aviso_proc_p ptu_aviso_procedimento.nr_sequencia%type, nr_seq_aviso_part_p ptu_aviso_participante.nr_sequencia%type) FROM PUBLIC;
