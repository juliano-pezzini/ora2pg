-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION ptu_aviso_pck.gera_cd_tabela ( ie_tipo_item_p text, ie_tipo_despesa_p pls_conta_proc.ie_tipo_despesa%type, ie_origem_proced_p pls_conta_pos_estabelecido.ie_origem_proced%type, cd_item text) RETURNS varchar AS $body$
DECLARE


/*
 Rotina criada para calculo do cd_tabela a ser enviado no arquivo PTU A520 no padrao TISS.
 Esta considerando a origem do procedimento, tipo de despesa e tambem o cadastro do material junto a operadora.

**/

				
cd_tabela_w varchar(2);

BEGIN

cd_tabela_w := '00';

	-- se for tuss

	if ie_origem_proced_p = 8 then

		if ie_tipo_item_p = 'P' then
			if ie_tipo_despesa_p in (2, 3) then
				cd_tabela_w := '18'; -- Taxas hospitalares, diarias e gases medicinais
			-- Se for pacote

			elsif ie_tipo_despesa_p = 4 then
				cd_tabela_w := '98'; -- Tabela Propria de Pacotes
			else
				cd_tabela_w := '22'; -- Procedimentos e eventos em saude
			end if;
		end if;
	else
		if ie_tipo_item_p = 'P' then
			if ie_tipo_despesa_p in (2, 3) then
				cd_tabela_w := '18'; -- Taxas hospitalares, diarias e gases medicinais
			-- Se for pacote

			elsif ie_tipo_despesa_p = 4 then
				cd_tabela_w := '98'; -- Tabela Propria de Pacotes
			else
				cd_tabela_w := '22'; -- Procedimentos e eventos em saude
			end if;
		end if;
	end if;

	if ie_tipo_item_p = 'M' then

		select 	coalesce(max(pmu.tp_tabela_tiss), 'XX')
		into STRICT 	cd_tabela_w
		from 	pls_material_unimed pmu, pls_material pm
		where 	pm.nr_sequencia = cd_item
		and 	pmu.nr_sequencia = pm.nr_seq_material_unimed;

		if cd_tabela_w = 'XX' then
			if ie_tipo_despesa_p in (3, 7) then
				cd_tabela_w := '19'; -- Materiais
			
			elsif ie_tipo_despesa_p = 2 then
				cd_tabela_w := '20'; -- Medicamentos
			else
				cd_tabela_w := '00'; -- Tabela propria das Operadoras
			end if;
		end if;
	end if;

	return cd_tabela_w;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION ptu_aviso_pck.gera_cd_tabela ( ie_tipo_item_p text, ie_tipo_despesa_p pls_conta_proc.ie_tipo_despesa%type, ie_origem_proced_p pls_conta_pos_estabelecido.ie_origem_proced%type, cd_item text) FROM PUBLIC;
