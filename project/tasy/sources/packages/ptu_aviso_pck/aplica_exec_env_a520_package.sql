-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE ptu_aviso_pck.aplica_exec_env_a520 ( nr_seq_lote_p ptu_lote_aviso.nr_sequencia%type) AS $body$
DECLARE

/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade:	Aplica os filtros de excecao em cima do lote.

		Neste caso os filtros vao remover o que parear no lote, conforme o nivel do filtro
-------------------------------------------------------------------------------------------------------------------

Pontos de atencao:

			A rotina vai apenas remover os itens que encontrar, sempre atuando do nivel mais alto para
			o mais baixo.

Alteracoes:
-------------------------------------------------------------------------------------------------------------------

++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */


qt_excecao_prot_w	integer;
qt_excecao_cta_w	integer;
qt_excecao_benef_w	integer;
qt_excecao_proc_w	integer;
qt_excecao_mat_w	integer;
dados_a520_w		dados_lote_a520_t;
alias_w			alias_a520_t;
dados_gerais_a520_w	dados_gerais_a520_t;

BEGIN

-- primeiro verifica se existe alguma regra de excecao para aplicar

select	sum(t.qt_prot),
	sum(t.qt_cta),
	sum(t.qt_benef),
	sum(t.qt_proc),
	sum(t.qt_mat)
into STRICT	qt_excecao_prot_w,
	qt_excecao_cta_w,
	qt_excecao_benef_w,
	qt_excecao_proc_w,
	qt_excecao_mat_w
from (	SELECT	count(1) qt_prot,
		0 qt_cta,
		0 qt_benef,
		0 qt_proc,
		0 qt_mat
	from	ptu_lote_aviso			a,
		ptu_regra_aviso_cobr		b,
		ptu_regra_aviso_cob_prot	c
	where	b.nr_sequencia			= a.nr_seq_regra
	and	c.nr_seq_regra			= b.nr_sequencia
	and	c.ie_excecao			= 'S'
	and	a.nr_sequencia			= nr_seq_lote_p
	
union all

	SELECT	0 qt_prot,
		count(1) qt_cta,
		0 qt_benef,
		0 qt_proc,
		0 qt_mat
	from	ptu_lote_aviso			a,
		ptu_regra_aviso_cobr		b,
		ptu_regra_aviso_cob_conta	c
	where	b.nr_sequencia			= a.nr_seq_regra
	and	c.nr_seq_regra			= b.nr_sequencia
	and	c.ie_excecao			= 'S'
	and	a.nr_sequencia			= nr_seq_lote_p
	
union all

	select	0 qt_prot,
		0 qt_cta,
		count(1) qt_benef,
		0 qt_proc,
		0 qt_mat
	from	ptu_lote_aviso			a,
		ptu_regra_aviso_cobr		b,
		ptu_regra_aviso_cob_benef	c
	where	b.nr_sequencia			= a.nr_seq_regra
	and	c.nr_seq_regra			= b.nr_sequencia
	and	c.ie_excecao			= 'S'
	and	a.nr_sequencia			= nr_seq_lote_p
	
union all

	select	0 qt_prot,
		0 qt_cta,
		0 qt_benef,
		count(1) qt_proc,
		0 qt_mat
	from	ptu_lote_aviso			a,
		ptu_regra_aviso_cobr		b,
		ptu_regra_aviso_cob_proc	c
	where	b.nr_sequencia			= a.nr_seq_regra
	and	c.nr_seq_regra			= b.nr_sequencia
	and	c.ie_excecao			= 'S'
	and	a.nr_sequencia			= nr_seq_lote_p
	
union all

	select	0 qt_prot,
		0 qt_cta,
		0 qt_benef,
		0 qt_proc,
		count(1) qt_mat
	from	ptu_lote_aviso			a,
		ptu_regra_aviso_cobr		b,
		ptu_regra_aviso_cob_mat		c
	where	b.nr_sequencia			= a.nr_seq_regra
	and	c.nr_seq_regra			= b.nr_sequencia
	and	c.ie_excecao			= 'S'
	and	a.nr_sequencia			= nr_seq_lote_p	) t;
	

-- se existe regra

if	((qt_excecao_prot_w > 0) or (qt_excecao_cta_w > 0) or (qt_excecao_benef_w > 0) or (qt_excecao_proc_w > 0) or (qt_excecao_mat_w > 0)) then
	
	-- carrega os dados iniciais do lote

	dados_a520_w := ptu_aviso_pck.busca_dados_lote_a520(nr_seq_lote_p, dados_a520_w);

	-- gera os dados gerais para o processo

	dados_gerais_a520_w.ie_excecao := 'S';
	
	-- valida conforme o nivel

	-- importante, tem que testar tanto para proc, mat e nenhum

	-- procedimento

	if (qt_excecao_proc_w > 0) then
	
		CALL ptu_aviso_pck.aplica_exec_env_a520(	dados_a520_w, alias_w, dados_gerais_a520_w, 'P');
	end if;
	
	-- material

	if (qt_excecao_mat_w > 0) then
	
		CALL ptu_aviso_pck.aplica_exec_env_a520(	dados_a520_w, alias_w, dados_gerais_a520_w, 'M');
	end if;
	
	-- quando nao tem nenhum nivel de item, entao testa somente  nivel de conta

	if	(qt_excecao_proc_w = 0 AND qt_excecao_mat_w = 0)then
	
		CALL ptu_aviso_pck.aplica_exec_env_a520(	dados_a520_w, alias_w, dados_gerais_a520_w, 'N');
	end if;
	

	commit;
end if;
	


END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ptu_aviso_pck.aplica_exec_env_a520 ( nr_seq_lote_p ptu_lote_aviso.nr_sequencia%type) FROM PUBLIC;
