-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


-- Gerar dados PTU_AVISO_PARTICIPANTE para envio



CREATE OR REPLACE PROCEDURE ptu_aviso_pck.gerar_dados_ptu_part_env_a520 ( nr_seq_aviso_procedimento_p ptu_aviso_procedimento.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type ) AS $body$
DECLARE

cd_prestador_w		ptu_aviso_participante.cd_prestador%type;
cd_cpf_contratado_w	ptu_aviso_participante.cd_cpf_contratado%type;
nm_profissional_w	ptu_aviso_participante.nm_profissional%type;
sg_conselho_w		ptu_aviso_participante.sg_conselho%type;
nr_conselho_w		ptu_aviso_participante.nr_conselho%type;
sg_uf_w			ptu_aviso_participante.sg_uf%type;
nr_cbo_w		ptu_aviso_participante.nr_cbo%type;
	
c01 CURSOR(	nr_seq_aviso_procedimento_pc	ptu_aviso_procedimento.nr_sequencia%type) FOR
	SELECT	pp.nr_sequencia nr_seq_participante,
		pp.cd_grau_partic_imp ie_grau_participante_imp,
		(	SELECT	max(x.cd_tiss)
			from	pls_grau_participacao	x
			where	x.nr_sequencia		= pp.nr_seq_grau_partic) ie_grau_participante,
		pp.cd_prestador_imp cd_prestador_imp,
		(	select	coalesce(pls_obter_dados_prestador(pp.nr_seq_prestador, 'CD'),
				CASE WHEN coalesce(pls_obter_dados_medico(pp.cd_medico,'CPF')::text, '') = '' THEN obter_dados_pf(pp.cd_medico,'CPR') END ) ) cd_prestador,
		pp.nr_cpf_imp cd_cpf_contratado_imp,
		(	select	pls_obter_dados_medico(pp.cd_medico, 'CPF') ) cd_cpf_contratado_med,
		(	select	pls_obter_dados_prestador(pp.nr_seq_prestador, 'CPF') ) cd_cpf_contratado_prest,
		pp.nm_medico_executor_imp nm_profissional_imp,
		(	select	pls_obter_dados_medico(pp.cd_medico, 'NM') ) nm_profissional_med,
		(	select	pls_obter_dados_prestador(pp.nr_seq_prestador, 'N') ) nm_profissional_prest,
		pp.sg_conselho_imp sg_conselho_imp,
		(	select	obter_dados_medico(pp.cd_medico, 'SGCRM') ) sg_conselho_med,
		(	select	pls_obter_dados_prestador(pp.nr_seq_prestador, 'SGCM') ) sg_conselho_prest,
		pp.nr_crm_imp nr_conselho_imp,
		(	select	obter_dados_medico(pp.cd_medico, 'CRM') ) nr_conselho_med,
		(	select	pls_obter_dados_prestador(pp.nr_seq_prestador, 'CONS') ) nr_conselho_prest,

		pp.uf_crm_imp sg_uf_imp,
		(	select	obter_dados_medico(pp.cd_medico, 'UFCRM') ) sg_uf_med,
		(	select	obter_dados_medico(x.cd_pessoa_fisica, 'UFCRM')
			from	pls_prestador	x
			where	x.nr_sequencia	= pp.nr_seq_prestador) sg_uf_prest,
		substr((	select	max(x.cd_cbo)
				from	cbo_saude	x
				where	x.cd_cbo	= pp.cd_cbo_saude_imp),1,6) nr_cbo_imp,
		substr((	select	max(x.cd_cbo)
				from	cbo_saude	x
				where	x.nr_sequencia	= pp.nr_seq_cbo_saude),1,6) nr_cbo
	from	pls_proc_participante 	pp,
		pls_conta_proc		cp,
		ptu_aviso_procedimento	ap
	where	cp.nr_sequencia	= ap.nr_seq_conta_proc
	and	cp.nr_sequencia	= pp.nr_seq_conta_proc
	and	ap.nr_sequencia	= nr_seq_aviso_procedimento_p
	
union all

	select	null nr_seq_participante,
		null ie_grau_participante_imp,
		(	select	max(x.cd_tiss)
			from	pls_grau_participacao	x
			where	x.nr_sequencia		= c.nr_seq_grau_partic) ie_grau_participante,
		null cd_prestador_imp,
		ac.cd_prestador_executante cd_prestador,
		null cd_cpf_contratado_imp,
		null cd_cpf_contratado_med,
		ac.cd_cpf_executante cd_cpf_contratado_prest,
		null nm_profissional_imp,
		null nm_profissional_med,
		ac.nm_profissional_executante nm_profissional_prest,
		null sg_conselho_imp,
		null sg_conselho_med,
		ac.sg_conselho_executante sg_conselho_prest,
		null nr_conselho_imp,
		null nr_conselho_med,
		ac.nr_conselho_executante nr_conselho_prest,
		null sg_uf_imp,
		null sg_uf_med,
		ac.sg_uf_executante sg_uf_prest,
		null nr_cbo_imp,
		ac.nr_cbo_executante nr_cbo
	from	pls_conta		c,
		ptu_aviso_conta		ac,
		pls_conta_proc		cp,
		ptu_aviso_procedimento	ap
	where	cp.nr_sequencia	= ap.nr_seq_conta_proc
	and	ac.nr_sequencia	= ap.nr_seq_aviso_conta
	and	c.nr_sequencia	= ac.nr_seq_conta
	and	ap.nr_sequencia	= nr_seq_aviso_procedimento_p
	and	c.ie_tipo_guia	= '6' --  HI

	and	not exists (select	1
				from	pls_proc_participante 	pp
				where	cp.nr_sequencia	= pp.nr_seq_conta_proc);
	
	
BEGIN


for r_c01_w in c01( nr_seq_aviso_procedimento_p ) loop

	cd_prestador_w		:= coalesce(r_c01_w.cd_prestador_imp, r_c01_w.cd_prestador);
	cd_cpf_contratado_w	:= coalesce(r_c01_w.cd_cpf_contratado_imp, coalesce(r_c01_w.cd_cpf_contratado_med, r_c01_w.cd_cpf_contratado_prest));
	nm_profissional_w	:= coalesce(r_c01_w.nm_profissional_imp, coalesce(r_c01_w.nm_profissional_med, r_c01_w.nm_profissional_prest));
	sg_conselho_w		:= lpad(coalesce(coalesce(r_c01_w.sg_conselho_imp, pls_obter_conselho_tiss_xml(coalesce(r_c01_w.sg_conselho_med, r_c01_w.sg_conselho_prest))),'06'), 2, '0');
	nr_conselho_w		:= coalesce(coalesce(r_c01_w.nr_conselho_imp, coalesce(r_c01_w.nr_conselho_med, r_c01_w.nr_conselho_prest)),0);
	sg_uf_w			:= ptu_aviso_pck.obter_uf_tiss(coalesce(r_c01_w.sg_uf_med, coalesce(r_c01_w.sg_uf_prest, r_c01_w.sg_uf_imp)));
	nr_cbo_w		:= coalesce(coalesce(r_c01_w.nr_cbo_imp, r_c01_w.nr_cbo),'999999');
	
	insert into ptu_aviso_participante(nr_sequencia,				dt_atualizacao,				nm_usuario,
		dt_atualizacao_nrec,			nm_usuario_nrec,			nr_seq_aviso_procedimento,
		nr_seq_participante,			ie_grau_participante,			cd_prestador,
		cd_cpf_contratado,			nm_profissional,			sg_conselho,
		nr_conselho,				sg_uf,					nr_cbo)
	values (nextval('ptu_aviso_participante_seq'),	clock_timestamp(),				nm_usuario_p,
		clock_timestamp(),				nm_usuario_p,				nr_seq_aviso_procedimento_p,
		r_c01_w.nr_seq_participante,		r_c01_w.ie_grau_participante,		cd_prestador_w,
		cd_cpf_contratado_w,			nm_profissional_w,			sg_conselho_w,
		nr_conselho_w,				sg_uf_w,				nr_cbo_w);
end loop;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ptu_aviso_pck.gerar_dados_ptu_part_env_a520 ( nr_seq_aviso_procedimento_p ptu_aviso_procedimento.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type ) FROM PUBLIC;
