-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


-- Gerar dados PTU_AVISO_DECLARACAO para envio



CREATE OR REPLACE PROCEDURE ptu_aviso_pck.gerar_dados_ptu_decl_env_a520 ( nr_seq_aviso_conta_p ptu_aviso_conta.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type ) AS $body$
DECLARE

						
c01 CURSOR(	nr_seq_aviso_conta_pc	ptu_aviso_conta.nr_sequencia%type) FOR
	SELECT	substr(coalesce(dn.nr_decl_nasc_vivo_imp,dn.nr_decl_nasc_vivo),1,11) nr_declaracao_nasc,
		null nr_diagnostico_obito,
		null nr_declarao_obito,
		coalesce(coalesce(dn.ie_indicador_dorn_imp,dn.ie_indicador_dorn),'N') ie_indicador_dorn
	from	pls_diagnostico_nasc_vivo	dn,
		pls_conta			cc,
		ptu_aviso_conta			ac
	where	cc.nr_sequencia	= ac.nr_seq_conta
	and	cc.nr_sequencia	= dn.nr_seq_conta
	and	ac.nr_sequencia	= nr_seq_aviso_conta_pc
	
union

	SELECT	null nr_declaracao_nasc,
		null nr_diagnostico_obito,
		coalesce(dd.nr_declaracao_obito_imp,dd.nr_declaracao_obito) nr_declarao_obito,
		coalesce(coalesce(dd.ie_indicador_dorn_imp,dd.ie_indicador_dorn),'N') ie_indicador_dorn
	from	pls_diagnost_conta_obito	dd,
		pls_conta			cc,
		ptu_aviso_conta			ac
	where	cc.nr_sequencia	= ac.nr_seq_conta
	and	cc.nr_sequencia	= dd.nr_seq_conta
	and	ac.nr_sequencia	= nr_seq_aviso_conta_pc;
						
BEGIN

for r_c01_w in c01( nr_seq_aviso_conta_p ) loop
	PERFORM set_config('ptu_aviso_pck.ie_qtd_proc_mat', 'S', false);
	insert into ptu_aviso_declaracao(nr_sequencia,				dt_atualizacao,			nm_usuario,
		dt_atualizacao_nrec,			nm_usuario_nrec,		nr_seq_aviso_conta,
		nr_declaracao_nasc,			nr_diagnostico_obito,		nr_declarao_obito,
		ie_indicador_dorn)
	values (nextval('ptu_aviso_declaracao_seq'),	clock_timestamp(),			nm_usuario_p,
		clock_timestamp(),				nm_usuario_p,			nr_seq_aviso_conta_p,
		r_c01_w.nr_declaracao_nasc,		r_c01_w.nr_diagnostico_obito,	r_c01_w.nr_declarao_obito,
		r_c01_w.ie_indicador_dorn);
end loop;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ptu_aviso_pck.gerar_dados_ptu_decl_env_a520 ( nr_seq_aviso_conta_p ptu_aviso_conta.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type ) FROM PUBLIC;
