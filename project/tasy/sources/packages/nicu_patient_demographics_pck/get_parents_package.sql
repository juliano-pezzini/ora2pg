-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION nicu_patient_demographics_pck.get_parents (nr_seq_patient_p bigint) RETURNS SETOF T_PARENT_TABLE AS $body$
DECLARE


ds_telephone_w		varchar(20);
ds_country_w		varchar(5);
ds_area_w		varchar(5);
ds_parent_name_w        varchar(255);
nr_seq_registro_w       bigint := 0;
r_parent_field_w        r_parent_field;

cParents CURSOR FOR
	SELECT  par.nr_sequencia,
			per.ds_given_name,
			per.ds_component_name_1,
			per.ds_family_name
	from    person_name per,
			nicu_parent par,
			nicu_parent_patient pat
	where   pat.nr_seq_patient = nr_seq_patient_p
	and     pat.nr_seq_parent = par.nr_sequencia
	and     per.nr_sequencia = par.nr_seq_person_name;
BEGIN

    for rParent in cParents loop
	begin

		nr_seq_registro_w := nr_seq_registro_w + 1;

		if (rParent.ds_given_name <> ' ') then

			ds_parent_name_w := rParent.ds_given_name;

			if (rParent.ds_component_name_1 <> ' ') then
				ds_parent_name_w := ds_parent_name_w || ' ' || rParent.ds_component_name_1;
			end if;

			if (rParent.ds_family_name <> ' ') then
				ds_parent_name_w := ds_parent_name_w || ' ' || rParent.ds_family_name;
			end if;

		end if;

		r_parent_field_w.nr_seq_order := nr_seq_registro_w;
		r_parent_field_w.ds_full_name := ds_parent_name_w;

		select	max(nr_telephone_number),
				max(cd_country),
				max(cd_area_city)
		into STRICT	ds_telephone_w,
				ds_country_w,
				ds_area_w
		from (	SELECT	nr_telephone_number,
							cd_country,
							cd_area_city
					from	nicu_telecom
					where	nr_seq_parent = rParent.nr_sequencia
					order 	by dt_atualizacao desc, nr_telephone_number) alias3 LIMIT 1;

		if (ds_telephone_w <> ' ') then

			if (ds_area_w <> ' ') then

				if ((instr(ds_area_w, '(', 1, 1) > 0) or (instr(ds_area_w, ')', 1, 1) > 0)) then
					ds_area_w := replace(ds_area_w, '(', '');
					ds_area_w := replace(ds_area_w, ')', '');
				end if;

				ds_area_w := '(' || ds_area_w || ')';

				ds_telephone_w := ds_area_w || ' ' || ds_telephone_w;
			end if;

			if (ds_country_w <> ' ') then
				ds_telephone_w := ds_country_w || ds_telephone_w;
			end if;
		end if;

		r_parent_field_w.nr_phone_number := ds_telephone_w;
		RETURN NEXT r_parent_field_w;

	end;
	end loop;

    return;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION nicu_patient_demographics_pck.get_parents (nr_seq_patient_p bigint) FROM PUBLIC;
