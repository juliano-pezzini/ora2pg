-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pfcs_pck_modules_backup.compare_tables ( dt_backup_p timestamp, nm_table_p text ) RETURNS varchar AS $body$
DECLARE

        ds_sql_w            varchar(4000);
        ds_restriction_w    varchar(4000);
        nm_atributo_w       tabela_atributo.nm_atributo%type;

        cur_table_columns CURSOR FOR
        SELECT nm_atributo
        from tabela_atributo
        where nm_tabela = nm_table_p||'_BCK'
            and ie_tipo_atributo not in ('FUNCTION','VISUAL')
            and nm_atributo not in (
                'DT_BACKUP',
                'NR_SEQUENCIA',
                'NM_USUARIO_NREC',
                'DT_ATUALIZACAO_NREC')
        order by nm_tabela;

BEGIN
        for c01_w in cur_table_columns loop
            ds_sql_w            := ds_sql_w || ', decode(a.'||c01_w.nm_atributo||', b.'||c01_w.nm_atributo||', null, '''||c01_w.nm_atributo||''') '||c01_w.nm_atributo;
            ds_restriction_w    := ds_restriction_w || ' or a.'||c01_w.nm_atributo||' <> b.'||c01_w.nm_atributo;
        end loop;

        select 'select a.NR_SEQUENCIA, ' || substr(ds_sql_w,2,4000)
        into STRICT ds_sql_w
;

        select substr(ds_restriction_w,4,4000)
        into STRICT ds_restriction_w
;

        ds_sql_w    := ds_sql_w || '    from    '||nm_table_p||' a, '||nm_table_p||'_bck b ';
        ds_sql_w    := ds_sql_w || '    where   a.nr_sequencia = b.nr_sequencia  ';
        ds_sql_w    := ds_sql_w || '    and     trunc(b.dt_backup) = trunc(to_date('''||to_char(dt_backup_p,'dd/mm/yyyy')||''',''dd/mm/yyyy'')) ';
        ds_sql_w    := ds_sql_w || '    and (' || ds_restriction_w || ')';

        return ds_sql_w;
    END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pfcs_pck_modules_backup.compare_tables ( dt_backup_p timestamp, nm_table_p text ) FROM PUBLIC;
