-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE tiss_regra_campos_pck.gerar_regra_campos (cd_convenio_p bigint, cd_estabelecimento_p bigint, qt_existentes_p INOUT bigint, qt_geradas_p INOUT bigint) AS $body$
DECLARE


i				integer;	
ds_versao_tiss_w		varchar(50);	
qt_existe_regra_conv_w		integer;				
  r RECORD;

BEGIN

if (cd_convenio_p IS NOT NULL AND cd_convenio_p::text <> '' AND cd_estabelecimento_p IS NOT NULL AND cd_estabelecimento_p::text <> '') then
	
	begin
	ds_versao_tiss_w		:= tiss_obter_versao(cd_convenio_p,cd_estabelecimento_p);
	exception
	when others then
		ds_versao_tiss_w	:= null;
	end;
	qt_existe_regra_conv_w := 0;
	i := 0;
	if	current_setting('tiss_regra_campos_pck.regra_campos_tb_w')::regra_campos_tb_v.count > 0 then
		for i in current_setting('tiss_regra_campos_pck.regra_campos_tb_w')::regra_campos_tb_v.first .. current_setting('tiss_regra_campos_pck.regra_campos_tb_w')::regra_campos_tb_v.last  loop
			begin
			if (current_setting('tiss_regra_campos_pck.regra_campos_tb_w')::regra_campos_tb_v[i].cd_convenio	= cd_convenio_p) and (current_setting('tiss_regra_campos_pck.regra_campos_tb_w')::regra_campos_tb_v[i].cd_estabelecimento = cd_estabelecimento_p) then
				qt_existe_regra_conv_w := qt_existe_regra_conv_w + 1;
			end if;
			end;
		end loop;
	end if;
	
	qt_existentes_p := qt_existe_regra_conv_w;
	
	i := current_setting('tiss_regra_campos_pck.regra_campos_tb_w')::regra_campos_tb_v.count;
	if	qt_existe_regra_conv_w = 0 then
	
		for	r in (	SELECT	coalesce(a.ie_envio, 'E')ie_envio,
					a.ds_padrao,
					a.vl_max_campo,
					a.ds_valor_gerado,
					a.ds_mascara,
					b.ie_tiss_tipo_guia,
					b.nm_atributo,
					a.ie_tipo_atendimento,
					a.cd_categoria,
					a.ie_gases,
					a.ie_taxas,
					a.ie_medicamento,
					a.ie_material,
					a.ie_taxas_diversas,
					a.ie_diarias,
					a.ie_alugueis,
					a.ie_clinica,
					a.nr_seq_classificacao,
					a.cd_setor_entrada,
					a.cd_setor_exec,
					a.ie_tipo_atend_tiss,
					a.ie_tipo_atend_proc_tiss,
					a.cd_perfil
				from	tiss_lista_campo b,
					tiss_regra_campo_conv a
				where	a.nr_seq_campo		= b.nr_sequencia
				and	a.cd_convenio		= cd_convenio_p
				and	a.cd_estabelecimento	= cd_estabelecimento_p
				order by	a.ie_taxas,
					coalesce(cd_setor_exec, 0),
					coalesce(ie_tipo_atendimento, 0),
					coalesce(ie_clinica, 0),
					coalesce(cd_categoria, '0'),
					coalesce(cd_setor_entrada, '0'),
					coalesce(a.nr_seq_classificacao,0),
					coalesce(a.ie_tipo_atend_tiss,'0'),
					coalesce(a.ie_tipo_atend_proc_tiss,'0'),
					coalesce(a.cd_perfil,0)) loop
					
			i := i + 1;
					
			current_setting('tiss_regra_campos_pck.regra_campos_tb_w')::regra_campos_tb_v[i].ie_envio			:= r.ie_envio;		
			current_setting('tiss_regra_campos_pck.regra_campos_tb_w')::regra_campos_tb_v[i].ds_padrao			:= r.ds_padrao;	
			current_setting('tiss_regra_campos_pck.regra_campos_tb_w')::regra_campos_tb_v[i].vl_max_campo		:= r.vl_max_campo;	
			current_setting('tiss_regra_campos_pck.regra_campos_tb_w')::regra_campos_tb_v[i].ds_valor_gerado		:= r.ds_valor_gerado;	
			current_setting('tiss_regra_campos_pck.regra_campos_tb_w')::regra_campos_tb_v[i].ds_mascara			:= r.ds_mascara;	
			current_setting('tiss_regra_campos_pck.regra_campos_tb_w')::regra_campos_tb_v[i].cd_convenio		:= cd_convenio_p;	
			current_setting('tiss_regra_campos_pck.regra_campos_tb_w')::regra_campos_tb_v[i].cd_estabelecimento		:= cd_estabelecimento_p;
			current_setting('tiss_regra_campos_pck.regra_campos_tb_w')::regra_campos_tb_v[i].ds_versao			:= ds_versao_tiss_w;
			current_setting('tiss_regra_campos_pck.regra_campos_tb_w')::regra_campos_tb_v[i].ie_tiss_tipo_guia		:= r.ie_tiss_tipo_guia;
			current_setting('tiss_regra_campos_pck.regra_campos_tb_w')::regra_campos_tb_v[i].nm_atributo		:= r.nm_atributo;
			current_setting('tiss_regra_campos_pck.regra_campos_tb_w')::regra_campos_tb_v[i].ie_tipo_atendimento	:= r.ie_tipo_atendimento;
			current_setting('tiss_regra_campos_pck.regra_campos_tb_w')::regra_campos_tb_v[i].cd_categoria		:= r.cd_categoria;	
			current_setting('tiss_regra_campos_pck.regra_campos_tb_w')::regra_campos_tb_v[i].ie_gases			:= r.ie_gases;
			current_setting('tiss_regra_campos_pck.regra_campos_tb_w')::regra_campos_tb_v[i].ie_taxas			:= r.ie_taxas;
			current_setting('tiss_regra_campos_pck.regra_campos_tb_w')::regra_campos_tb_v[i].ie_medicamento		:= r.ie_medicamento;
			current_setting('tiss_regra_campos_pck.regra_campos_tb_w')::regra_campos_tb_v[i].ie_material		:= r.ie_material;
			current_setting('tiss_regra_campos_pck.regra_campos_tb_w')::regra_campos_tb_v[i].ie_taxas_diversas		:= r.ie_taxas_diversas;
			current_setting('tiss_regra_campos_pck.regra_campos_tb_w')::regra_campos_tb_v[i].ie_diarias			:= r.ie_diarias;
			current_setting('tiss_regra_campos_pck.regra_campos_tb_w')::regra_campos_tb_v[i].ie_alugueis		:= r.ie_alugueis;
			current_setting('tiss_regra_campos_pck.regra_campos_tb_w')::regra_campos_tb_v[i].ie_clinica			:= r.ie_clinica;
			current_setting('tiss_regra_campos_pck.regra_campos_tb_w')::regra_campos_tb_v[i].nr_seq_classificacao	:= r.nr_seq_classificacao;
			current_setting('tiss_regra_campos_pck.regra_campos_tb_w')::regra_campos_tb_v[i].cd_setor_entrada		:= r.cd_setor_entrada;
			current_setting('tiss_regra_campos_pck.regra_campos_tb_w')::regra_campos_tb_v[i].cd_setor_exec		:= r.cd_setor_exec;
			current_setting('tiss_regra_campos_pck.regra_campos_tb_w')::regra_campos_tb_v[i].ie_tipo_atend_tiss		:= r.ie_tipo_atend_tiss;
			current_setting('tiss_regra_campos_pck.regra_campos_tb_w')::regra_campos_tb_v[i].ie_tipo_atend_proc_tiss	:= r.ie_tipo_atend_proc_tiss;
			current_setting('tiss_regra_campos_pck.regra_campos_tb_w')::regra_campos_tb_v[i].cd_perfil			:= r.cd_perfil;
			current_setting('tiss_regra_campos_pck.regra_campos_tb_w')::regra_campos_tb_v[i].indice			:= i;
			qt_existe_regra_conv_w				:= qt_existe_regra_conv_w + 1;		
		end loop;

		qt_geradas_p := qt_existe_regra_conv_w;
	end if;
	
	if	qt_existe_regra_conv_w = 0 then
		i := current_setting('tiss_regra_campos_pck.regra_campos_tb_w')::regra_campos_tb_v.count + 1;
		current_setting('tiss_regra_campos_pck.regra_campos_tb_w')::regra_campos_tb_v[i].cd_convenio		:= cd_convenio_p;	
		current_setting('tiss_regra_campos_pck.regra_campos_tb_w')::regra_campos_tb_v[i].cd_estabelecimento		:= cd_estabelecimento_p;
		current_setting('tiss_regra_campos_pck.regra_campos_tb_w')::regra_campos_tb_v[i].ie_conv_sem_regra		:= 'S';
		current_setting('tiss_regra_campos_pck.regra_campos_tb_w')::regra_campos_tb_v[i].indice			:= current_setting('tiss_regra_campos_pck.regra_campos_tb_w')::regra_campos_tb_v.count + 1;
	end if;
end if;
end;


$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE tiss_regra_campos_pck.gerar_regra_campos (cd_convenio_p bigint, cd_estabelecimento_p bigint, qt_existentes_p INOUT bigint, qt_geradas_p INOUT bigint) FROM PUBLIC;
