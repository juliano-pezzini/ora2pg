-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION tiss_regra_campos_pck.obter_regra_campos ( ie_tipo_guia_p text, nm_atributo_p text, cd_convenio_p bigint, vl_campo_p text, ie_tipo_atendimento_p bigint, cd_categoria_conv_p text, ie_tipo_despesa_p text, vl_max_campo_p bigint, cd_estabelecimento_p bigint, ie_clinica_p bigint, nr_seq_classificacao_p bigint, cd_setor_atendimento_p bigint, ds_parametros_p text, cd_setor_execucao_p bigint default null) RETURNS varchar AS $body$
DECLARE



j				bigint;
ie_envio_w			varchar(4000);
ds_padrao_w			varchar(4000);
vl_permitido_w			double precision;
ds_retorno_w			varchar(4000);
ds_temp_w			varchar(4000);
dt_retorno_aux_w		timestamp;
ds_valor_gerado_w		varchar(4000);
ds_conteudo_w			varchar(4000);
vl_atributo_w			varchar(255);
ie_tipo_atend_tiss_w		varchar(255);
ie_tipo_atend_tiss_proc_w	varchar(255);
ds_mascara_w			varchar(255);
qt_digitos_mascara_w		bigint;
qt_digitos_valor_w		bigint;
qt_registros_vetor_w		bigint;
i				integer;
cd_perfil_w			integer := wheb_usuario_pck.get_cd_perfil;

ds_versao_tiss_w		varchar(20);
nm_atributo_w			varchar(255);
qt_regra_w			bigint;	
ie_versao_3_w			varchar(1);		

BEGIN
ie_envio_w 		:= null;
ds_valor_gerado_w 	:= null;
ds_padrao_w		:= null;
i := 0;

ds_conteudo_w			:= ds_parametros_p;
j 				:= position('#@' in ds_conteudo_w);
ie_tipo_atend_tiss_w		:= ltrim(substr(substr(ds_conteudo_w,1, j - 1),1,255),'0');
ds_conteudo_w			:= substr(ds_conteudo_w, j + 2, 4000);
ie_tipo_atend_tiss_proc_w	:= ltrim(substr(substr(ds_conteudo_w,1, j - 1),1,255),'0');
ds_conteudo_w			:= substr(ds_conteudo_w, j + 2, 4000);

if (current_setting('tiss_regra_campos_pck.regra_campos_tb_w')::regra_campos_tb_v.count > 0) then
	for i in current_setting('tiss_regra_campos_pck.regra_campos_tb_w')::regra_campos_tb_v.first .. current_setting('tiss_regra_campos_pck.regra_campos_tb_w')::regra_campos_tb_v.last loop
			begin
		if (current_setting('tiss_regra_campos_pck.regra_campos_tb_w')::regra_campos_tb_v[i].cd_convenio		= cd_convenio_p) and (current_setting('tiss_regra_campos_pck.regra_campos_tb_w')::regra_campos_tb_v[i].cd_estabelecimento 	= cd_estabelecimento_p) and (current_setting('tiss_regra_campos_pck.regra_campos_tb_w')::regra_campos_tb_v[i].nm_atributo 		= nm_atributo_p) and (current_setting('tiss_regra_campos_pck.regra_campos_tb_w')::regra_campos_tb_v[i].ie_tiss_tipo_guia 	= ie_tipo_guia_p) then
			
			ie_versao_3_w := obter_se_projeto_versao(0,12,current_setting('tiss_regra_campos_pck.regra_campos_tb_w')::regra_campos_tb_v[i].ds_versao,0);
			
			if	((current_setting('tiss_regra_campos_pck.regra_campos_tb_w')::regra_campos_tb_v[i].ie_gases = 'S') 		or ((current_setting('tiss_regra_campos_pck.regra_campos_tb_w')::regra_campos_tb_v[i].ie_gases = 'N') 	and (ie_tipo_despesa_p <> '1'))) and
				((current_setting('tiss_regra_campos_pck.regra_campos_tb_w')::regra_campos_tb_v[i].ie_medicamento = 'S')	or ((current_setting('tiss_regra_campos_pck.regra_campos_tb_w')::regra_campos_tb_v[i].ie_medicamento = 'N') and (ie_tipo_despesa_p <> '2'))) and
				((current_setting('tiss_regra_campos_pck.regra_campos_tb_w')::regra_campos_tb_v[i].ie_material = 'S') 	or ((current_setting('tiss_regra_campos_pck.regra_campos_tb_w')::regra_campos_tb_v[i].ie_material = 'N') 	and (ie_tipo_despesa_p <> '3'))) and
				((current_setting('tiss_regra_campos_pck.regra_campos_tb_w')::regra_campos_tb_v[i].ie_diarias = 'S') 	or ((current_setting('tiss_regra_campos_pck.regra_campos_tb_w')::regra_campos_tb_v[i].ie_diarias = 'N') 	and (ie_tipo_despesa_p <> '5'))) and (coalesce(current_setting('tiss_regra_campos_pck.regra_campos_tb_w')::regra_campos_tb_v[i].ie_tipo_atendimento, coalesce(ie_tipo_atendimento_p, 0)) 			= coalesce(ie_tipo_atendimento_p,0))and (coalesce(current_setting('tiss_regra_campos_pck.regra_campos_tb_w')::regra_campos_tb_v[i].ie_clinica, coalesce(ie_clinica_p, 0)) 					= coalesce(ie_clinica_p, 0)) and (coalesce(current_setting('tiss_regra_campos_pck.regra_campos_tb_w')::regra_campos_tb_v[i].cd_categoria, coalesce(cd_categoria_conv_p, '0')) 				= coalesce(cd_categoria_conv_p, '0')) and (coalesce(current_setting('tiss_regra_campos_pck.regra_campos_tb_w')::regra_campos_tb_v[i].nr_seq_classificacao, coalesce(nr_seq_classificacao_p, '0'))		= coalesce(nr_seq_classificacao_p, '0')) and (coalesce(current_setting('tiss_regra_campos_pck.regra_campos_tb_w')::regra_campos_tb_v[i].cd_setor_entrada, coalesce(cd_setor_atendimento_p, '0'))			= coalesce(cd_setor_atendimento_p, '0')) and (coalesce(current_setting('tiss_regra_campos_pck.regra_campos_tb_w')::regra_campos_tb_v[i].cd_setor_exec, coalesce(cd_setor_execucao_p, '0'))				= coalesce(cd_setor_execucao_p, '0'))and (coalesce(current_setting('tiss_regra_campos_pck.regra_campos_tb_w')::regra_campos_tb_v[i].ie_tipo_atend_tiss, coalesce(ie_tipo_atend_tiss_w,'0'))			= coalesce(ie_tipo_atend_tiss_w,'0'))and (coalesce(current_setting('tiss_regra_campos_pck.regra_campos_tb_w')::regra_campos_tb_v[i].ie_tipo_atend_proc_tiss, coalesce(ie_tipo_atend_tiss_proc_w,'0'))		= coalesce(ie_tipo_atend_tiss_proc_w,'0'))and (coalesce(current_setting('tiss_regra_campos_pck.regra_campos_tb_w')::regra_campos_tb_v[i].cd_perfil,coalesce(cd_perfil_w,0))						= coalesce(cd_perfil_w,0)) and
				((ie_versao_3_w = 'N') and ((current_setting('tiss_regra_campos_pck.regra_campos_tb_w')::regra_campos_tb_v[i].ie_taxas = 'N') or (current_setting('tiss_regra_campos_pck.regra_campos_tb_w')::regra_campos_tb_v[i].ie_taxas = 'S' and ie_tipo_despesa_p in ('4','5'))) or (ie_versao_3_w = 'S')  and ((current_setting('tiss_regra_campos_pck.regra_campos_tb_w')::regra_campos_tb_v[i].ie_taxas = 'N') 		or (current_setting('tiss_regra_campos_pck.regra_campos_tb_w')::regra_campos_tb_v[i].ie_taxas = 'S' and ie_tipo_despesa_p in ('5','7'))))	and
				((ie_versao_3_w = 'N') and ((current_setting('tiss_regra_campos_pck.regra_campos_tb_w')::regra_campos_tb_v[i].ie_taxas_diversas = 'S') or ((current_setting('tiss_regra_campos_pck.regra_campos_tb_w')::regra_campos_tb_v[i].ie_taxas_diversas = 'N') and (ie_tipo_despesa_p <> '4'))) or (ie_versao_3_w = 'S')  and ((current_setting('tiss_regra_campos_pck.regra_campos_tb_w')::regra_campos_tb_v[i].ie_taxas_diversas = 'S') or ((current_setting('tiss_regra_campos_pck.regra_campos_tb_w')::regra_campos_tb_v[i].ie_taxas_diversas = 'N') and (ie_tipo_despesa_p <> '7')))) and
				((ie_versao_3_w = 'N') and (current_setting('tiss_regra_campos_pck.regra_campos_tb_w')::regra_campos_tb_v[i].ie_alugueis = 'S') or ((current_setting('tiss_regra_campos_pck.regra_campos_tb_w')::regra_campos_tb_v[i].ie_alugueis = 'N') and (ie_tipo_despesa_p <> '6')) or (ie_versao_3_w = 'S') and (current_setting('tiss_regra_campos_pck.regra_campos_tb_w')::regra_campos_tb_v[i].ie_alugueis = 'S') or ((current_setting('tiss_regra_campos_pck.regra_campos_tb_w')::regra_campos_tb_v[i].ie_alugueis = 'N') and (ie_tipo_despesa_p <> '7'))) then
							
				ie_envio_w 		:= current_setting('tiss_regra_campos_pck.regra_campos_tb_w')::regra_campos_tb_v[i].ie_envio;
				ds_valor_gerado_w	:= current_setting('tiss_regra_campos_pck.regra_campos_tb_w')::regra_campos_tb_v[i].ds_valor_gerado;
				ds_padrao_w		:= current_setting('tiss_regra_campos_pck.regra_campos_tb_w')::regra_campos_tb_v[i].ds_padrao;
				
			end if;
		
			
			
			
		end if;
		end;
	end loop;
end if;

if (coalesce(ie_envio_w, 'E') = 'PG') and (coalesce(ds_valor_gerado_w,'X') = coalesce(vl_campo_p,'Z')) then
	ds_retorno_w	:= ds_padrao_w;
end if;

if (coalesce(ds_retorno_w::text, '') = '') then

	if (coalesce(vl_max_campo_p, 0) > 0) and (coalesce(vl_permitido_w, 0) > 0) then
		if (vl_max_campo_p	> vl_permitido_w) then
			ds_retorno_w	:= vl_permitido_w;
		else
			ds_retorno_w	:= vl_max_campo_p;
		end if;
	elsif (coalesce(ie_envio_w,'E') = 'E')  then

		ds_retorno_w		:= vl_campo_p;
		
		if (position('@sem_quebra' in ds_padrao_w) > 0) then
			ds_retorno_w	:= replace(replace(ds_retorno_w,chr(13),' '),chr(10),' ');
			ds_padrao_w	:= replace(ds_padrao_w,'@sem_quebra','');
		end if;	
		
	elsif (coalesce(ie_envio_w,'E') = 'T')  then
		ds_retorno_w		:= ds_padrao_w;
	elsif (coalesce(ie_envio_w,'E') = 'DP') and (ds_padrao_w <> vl_campo_p) then
		ds_retorno_w		:= vl_campo_p;
	elsif (coalesce(ie_envio_w,'E') = 'PG') then
		if (coalesce(ds_valor_gerado_w,'XYZ')   = coalesce(vl_campo_p,'XYZ')) then
			ds_retorno_w		:= ds_padrao_w;
		else
			ds_retorno_w		:= vl_campo_p;
		end if;
	elsif (coalesce(ie_envio_w,'E') = 'DZ')  then
		if (somente_numero(vl_campo_p) <> 0) then
			ds_retorno_w		:= vl_campo_p;
		end if;
	else
		ds_retorno_w	:= null;
	end if;

	--se soh veio a hora e o atributo eh um horario e estiver sem a data
	ds_temp_w := ds_retorno_w;
	if (position('hora' in lower(nm_atributo_p)) > 0) and (length(ds_retorno_w) < 10) then
		begin
			if (vl_campo_p IS NOT NULL AND vl_campo_p::text <> '') then
				ds_retorno_w 	:= substr(vl_campo_p,1,10) || ' ' || ds_retorno_w;
			else
				ds_retorno_w 	:= '01/01/2000 ' || ds_retorno_w;			
			end if;
		exception
			when others then
			ds_retorno_w := ds_temp_w;
		end;
	end if;

	begin
	dt_retorno_aux_w := to_date(ds_retorno_w,'dd/mm/yyyy');
	exception
		when others then
		dt_retorno_aux_w := null;
	end;

	if (ds_mascara_w IS NOT NULL AND ds_mascara_w::text <> '') and (ds_retorno_w IS NOT NULL AND ds_retorno_w::text <> '') and (coalesce(dt_retorno_aux_w::text, '') = '') then
		begin

		if (length(ds_mascara_w) > length(ds_retorno_w)) then
			qt_digitos_mascara_w	:= length(ds_mascara_w);
			qt_digitos_valor_w	:= length(ds_retorno_w);
			ds_retorno_w		:= rpad(ds_retorno_w,qt_digitos_mascara_w,'Z');
		end if;
		
		select	TISS_OBTER_COD_USUARIO_MASC(ds_retorno_w, ds_mascara_w)
		into STRICT	ds_retorno_w
		;
		
		if (length(ds_retorno_w) >  qt_digitos_valor_w) then
			ds_retorno_w	:= rtrim(ds_retorno_w,'Z');
		end if;

		exception
			when others then
			ds_retorno_w	:= null;
		end;
	end if;
end if;	

return ds_retorno_w;

end;	


$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION tiss_regra_campos_pck.obter_regra_campos ( ie_tipo_guia_p text, nm_atributo_p text, cd_convenio_p bigint, vl_campo_p text, ie_tipo_atendimento_p bigint, cd_categoria_conv_p text, ie_tipo_despesa_p text, vl_max_campo_p bigint, cd_estabelecimento_p bigint, ie_clinica_p bigint, nr_seq_classificacao_p bigint, cd_setor_atendimento_p bigint, ds_parametros_p text, cd_setor_execucao_p bigint default null) FROM PUBLIC;
