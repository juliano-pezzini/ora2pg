-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE dpc_pkg.set_quest_columns_value (nr_seq_dpc_quest_p bigint, si_action_p text, ds_column_p text, ds_value_p text, nm_usuario_p text, dt_value_p timestamp, cd_formulary_p bigint, nr_seq_formulary_p bigint) AS $body$
DECLARE

				
    ds_value_w pat_dpc_quest_item.ds_value%type;
    dt_value_w pat_dpc_quest_item.dt_value%type;
    nr_seq_quest_form_w pat_dpc_quest_form.nr_sequencia%type;

    c01 CURSOR FOR
        SELECT	nm_atributo,
                nr_seq_objeto,
		nr_seq_grupo
        FROM 	dic_objeto_filtro
        WHERE	nr_seq_objeto = nr_seq_formulary_p;
	
    r01_w   c01%rowtype;

BEGIN
    IF (si_action_p = 'I') THEN
        select 	nextval('pat_dpc_quest_form_seq')
        into STRICT 	nr_seq_quest_form_w
;

        DELETE  FROM pat_dpc_quest_item
        WHERE   nr_seq_quest_form = (
			SELECT 	max(nr_sequencia)
			from 	pat_dpc_quest_form
			where   nr_seq_dpc_quest = nr_seq_dpc_quest_p
			and     cd_formulary = cd_formulary_p);

        INSERT INTO pat_dpc_quest_form(
                       nr_sequencia,
                       dt_atualizacao,
                       nm_usuario,
                       dt_atualizacao_nrec,
                       nm_usuario_nrec,
                       nr_seq_dpc_quest,
                       nr_seq_formulary,
                       cd_formulary,
		       cd_serial_number,
                       cd_code,
                       cd_version)
                VALUES (nr_seq_quest_form_w,
                       clock_timestamp(),
                       nm_usuario_p,
                       clock_timestamp(),
                       nm_usuario_p,
                       nr_seq_dpc_quest_p,
                       nr_seq_formulary_p,
                       cd_formulary_p,
                       0,
                       '0',
		       '20210101');
        COMMIT;
        
        OPEN C01;
        LOOP
            FETCH c01 INTO r01_w;
            EXIT WHEN NOT FOUND; /* apply on C01 */
            BEGIN				
                select max(ds_value), max(dt_value)
                into STRICT ds_value_w,
		     dt_value_w
                from  table(dpc_pkg.get_data_dpc_quest(nr_seq_dpc_quest_p, cd_formulary_p))
                where ds_field = r01_w.nm_atributo;
				
		IF (substr(r01_w.nm_atributo, 0, 2) = 'DT') THEN
                    SELECT  REPLACE(REPLACE(to_char(substr(ds_value_w, 0, 18)), '.', ':'),'-','/') || substr(ds_value_w, length(ds_value_w)-2)
                    INTO STRICT    ds_value_w
;
                END IF;
				
                INSERT INTO pat_dpc_quest_item(
                       nr_sequencia,
                       nr_seq_quest_form,
                       nr_seq_form_obj,
                       dt_atualizacao,
                       nm_usuario,
                       dt_atualizacao_nrec,
                       nm_usuario_nrec,
                       ds_column,
		       cd_group,
                       ds_value,
                       dt_value)
                VALUES (nextval('pat_dpc_quest_item_seq'),
                       nr_seq_quest_form_w,
                       r01_w.nr_seq_objeto,
                       clock_timestamp(),
                       nm_usuario_p,
                       clock_timestamp(),
                       nm_usuario_p,
                       r01_w.nm_atributo,
		       r01_w.nr_seq_grupo,
                       ds_value_w,
                       dt_value_w);
            END;
        END LOOP;
        COMMIT;

    ELSIF (si_action_p = 'U') THEN
        select 	nr_sequencia
        into STRICT 	nr_seq_quest_form_w
        from 	pat_dpc_quest_form
        where   nr_seq_dpc_quest = nr_seq_dpc_quest_p
        and     cd_formulary = cd_formulary_p;
	
        ds_value_w := ds_value_p;
        IF (substr(ds_column_p, 0, 2) = 'DT') THEN
			dt_value_w := dt_value_p;
            SELECT  REPLACE(REPLACE(to_char(substr(ds_value_p, 0, 18)), '.', ':'),'-','/') || substr(ds_value_p, length(ds_value_p)-2)
            INTO STRICT    ds_value_w
;
        END IF;
		
        UPDATE  pat_dpc_quest_item
        SET	ds_value            = ds_value_w,
                dt_value            = dt_value_w
        WHERE	ds_column           = ds_column_p
        AND     nr_seq_quest_form   = nr_seq_quest_form_w;

        COMMIT;

    ELSIF (si_action_p = 'D') THEN
	delete from pat_dpc_quest_item
	where	nr_seq_quest_form in (	SELECT	x.nr_sequencia
					from	pat_dpc_quest_form x
					where	x.nr_seq_dpc_quest = nr_seq_dpc_quest_p	);
					
	delete from pat_dpc_quest_form
	where	nr_seq_dpc_quest = nr_seq_dpc_quest_p;

        COMMIT;

    END IF;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE dpc_pkg.set_quest_columns_value (nr_seq_dpc_quest_p bigint, si_action_p text, ds_column_p text, ds_value_p text, nm_usuario_p text, dt_value_p timestamp, cd_formulary_p bigint, nr_seq_formulary_p bigint) FROM PUBLIC;
