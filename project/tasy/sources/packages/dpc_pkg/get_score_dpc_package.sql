-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION dpc_pkg.get_score_dpc (nr_seq_patient_dpc_p bigint ) RETURNS bigint AS $body$
DECLARE

  ds_return_w bigint;
  nr_atendimento_w patient_dpc.nr_atendimento%type;
  nr_seq_dpc_score_w patient_dpc.nr_seq_dpc_score%type;
  qt_days_hosp_1_w dpc_score.qt_days_hosp_1%type;
  qt_days_hosp_2_w dpc_score.qt_days_hosp_2%type;
  qt_days_hosp_3_w dpc_score.qt_days_hosp_3%type;
  qt_points_hosp_1_W dpc_score.qt_points_hosp_1%type;
  qt_points_hosp_2_W dpc_score.qt_points_hosp_2%type;
  qt_points_hosp_3_W dpc_score.qt_points_hosp_3%type;
  hosp_days_w 		bigint;
  qt_period_1_w		bigint;
  qt_period_2_w		bigint;
  qt_period_3_w		bigint;
  qt_remaining_days_w bigint;

BEGIN
  SELECT nr_atendimento,
         nr_seq_dpc_score,
         obter_dias_entre(dt_start_dpc,  clock_timestamp())
  INTO STRICT   nr_atendimento_w,
         nr_seq_dpc_score_w,
         hosp_days_w
  FROM   patient_dpc
  WHERE  nr_sequencia= nr_seq_patient_dpc_p;

  SELECT qt_days_hosp_1,
         qt_days_hosp_2,
         qt_days_hosp_3,
         qt_points_hosp_1,
         qt_points_hosp_2,
         qt_points_hosp_3
  INTO STRICT   qt_days_hosp_1_w,
         qt_days_hosp_2_w,
         qt_days_hosp_3_w,
         qt_points_hosp_1_w,
         qt_points_hosp_2_w,
         qt_points_hosp_3_w
  FROM   dpc_score
  WHERE  nr_sequencia=nr_seq_dpc_score_w;

  qt_remaining_days_w := hosp_days_w;

  /* Example:
	DPC: 010060x1990521 	qt_days_hosp_1:  2 || qt_points_hosp_1: 3593
			qt_days_hosp_2: 8 || qt_points_hosp_2: 2212
			qt_days_hosp_3: 30 || qt_points_hosp_3: 1880

	Period 1: 1st day to 2nd to day = 2 days;
	Period 2: 3rd day to 8th day = 6 days;
	Period 3: 9th day to 30rd day = 22 days;
	Fee for service: 31rd day;

	Thats why is necessary always discount the previous period, to calculate just the number of days of each period.
    */
  --Fee for service
  if (hosp_days_w > qt_days_hosp_3_w) then
	qt_period_1_w 		:= qt_days_hosp_1_w * qt_points_hosp_1_w;
	qt_period_2_w		:= (qt_days_hosp_2_w - qt_days_hosp_1_w) * qt_points_hosp_2_w;
	qt_period_3_w		:= (qt_days_hosp_3_w - qt_days_hosp_2_w) * qt_points_hosp_3_w;
	
  --Period 3
  elsif (hosp_days_w > qt_days_hosp_2_w) then
  	qt_period_1_w 		:= qt_days_hosp_1_w * qt_points_hosp_1_w;
	qt_period_2_w		:= (qt_days_hosp_2_w - qt_days_hosp_1_w) * qt_points_hosp_2_w;
	qt_period_3_w		:= (hosp_days_w - qt_days_hosp_2_w) * qt_points_hosp_3_w;

  --Period 2
  elsif (hosp_days_w > qt_days_hosp_1_w) then
	qt_period_1_w 		:= qt_days_hosp_1_w * qt_points_hosp_1_w;
	qt_period_2_w		:= (hosp_days_w - qt_days_hosp_1_w) * qt_points_hosp_2_w;
	qt_period_3_w		:= 0;

  --Period 1
  elsif (hosp_days_w > 0) then
	qt_period_1_w 		:= hosp_days_w * qt_points_hosp_1_w;
	qt_period_2_w		:= 0;
	qt_period_3_w		:= 0;
  else
	qt_period_1_w 		:= 0;
	qt_period_2_w		:= 0;
	qt_period_3_w		:= 0;
  end if;

  ds_return_w := qt_period_1_w + qt_period_2_w + qt_period_3_w;

  RETURN ds_return_w;
END;



$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION dpc_pkg.get_score_dpc (nr_seq_patient_dpc_p bigint ) FROM PUBLIC;
