-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE dpc_pkg.generate_medical_information (nr_seq_patient_dpc_p bigint, nm_usuario_p text) AS $body$
DECLARE


count_w bigint;
qt_peso_sala_parto_w bigint;
gestational_age_w bigint;
nr_atendimento_w bigint;


BEGIN

  qt_peso_sala_parto_w := 0;
  gestational_age_w := 0;

  select nr_atendimento
  into STRICT nr_atendimento_w
  from patient_dpc
  where nr_sequencia= nr_seq_patient_dpc_p;
   
  select count(*)
  into STRICT count_w
  from nascimento
  where nr_atendimento = nr_atendimento_w;

  if (count_w = 1) then
	select max(qt_peso_sala_parto)
	into STRICT qt_peso_sala_parto_w
	from nascimento
	where nr_atendimento = nr_atendimento_w;
	
  end if;

	select max(qt_sem_ig_total)
	into STRICT gestational_age_w 
	from nascimento
	where nr_atendimento = nr_atendimento_w;

  if (coalesce(qt_peso_sala_parto_w,0) > 0 or coalesce(gestational_age_w,0) > 0) then
  
    update patient_dpc_general_cond
	set qt_birth_weight_grams = qt_peso_sala_parto_w,
	qt_pregnancy_age_weeks = gestational_age_w
	where nr_seq_patient_dpc = nr_seq_patient_dpc_p;

  end if;

commit;
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE dpc_pkg.generate_medical_information (nr_seq_patient_dpc_p bigint, nm_usuario_p text) FROM PUBLIC;
