-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE dpc_pkg.gen_pat_dpc_general_cond (nr_seq_patient_dpc_p bigint, nm_usario_p text) AS $body$
DECLARE


count_w2 		bigint;
nr_seq_mdc_w 		bigint;
cd_mdc_w 		varchar(50);
nr_seq_classification_w bigint;
cd_classification_w 	varchar(50);
nr_seq_problem_w 	bigint;
cd_seq_classification_w bigint;
si_origin_w 		varchar(50);
vl_gaf_score_w 		bigint;
vl_rankin_scale_w 	bigint;
nr_seq_pat_dpc_w 	bigint;
si_pneumonia_state_w 	varchar(50);
cd_doenca_w             diagnostico_doenca.cd_doenca%type;

BEGIN

select 	max(c.nr_sequencia),
	max(b.cd_mdc),
	max(d.nr_sequencia),
	max(b.cd_classification)
into STRICT 	nr_seq_mdc_w,
	cd_mdc_w,
	nr_seq_classification_w,
	cd_classification_w
from 	patient_dpc a,
	dpc_icd b,
        dpc_mdc c, 
        dpc_classification d,
	diagnostico_doenca e
where 	a.nr_sequencia   = nr_seq_patient_dpc_p
and	e.nr_seq_interno = a.nr_seq_most_exp_diagnosis
and    	b.nr_seq_edition = a.nr_seq_edition
and     c.nr_seq_edition = b.nr_seq_edition
and     d.nr_seq_edition = c.nr_seq_edition
and (trim(both trailing '$' from trim(both b.cd_icd)) = substr(trim(both e.cd_doenca),1,3) or trim(both b.cd_icd) = trim(both e.cd_doenca))
and    	c.cd_mdc = b.cd_mdc
and     d.cd_mdc = b.cd_mdc
and 	d.cd_classification = b.cd_classification;

if (coalesce(nr_seq_mdc_w::text, '') = '') then
        select  b.cd_doenca
        into STRICT    cd_doenca_w
        from    patient_dpc a,
                diagnostico_doenca b
        where   b.nr_seq_interno = a.nr_seq_most_exp_diagnosis
        and     a.nr_sequencia = nr_seq_patient_dpc_p;

        CALL wheb_mensagem_pck.exibir_mensagem_abort(1153274,'CD_PROCED_P=' || cd_doenca_w);
end if;

if (cd_mdc_w = '04' and cd_classification_w = '0080') then
	begin     
	select	CASE WHEN max(a.ie_origem_infeccao)='H' THEN '3' WHEN max(a.ie_origem_infeccao)='C' THEN '5'  ELSE max(a.ie_origem_infeccao) END 
	into STRICT	si_pneumonia_state_w
	from	cpoe_material a,
		prescr_item_sintoma b,
		lista_problema_pac c,
		patient_dpc d
	where	a.nr_sequencia = b.nr_seq_medic
	and	b.nr_seq_problema = c.nr_sequencia
	and	c.nr_atendimento = d.nr_atendimento
	and	d.nr_sequencia = nr_seq_patient_dpc_p
	and	c.ie_situacao = 'A'
	and    (c.dt_liberacao IS NOT NULL AND c.dt_liberacao::text <> '')
	and	coalesce(c.dt_inativacao::text, '') = '';
	end;
elsif (cd_mdc_w = '17' and cd_classification_w in ('0020','0030','0040','0050','0060')) then
	begin
	   select max(b.qt_score)
	   into STRICT vl_gaf_score_w
	   from patient_dpc a,
		escala_agf b
	   where a.nr_sequencia = nr_seq_patient_dpc_p
	   and   b.nr_atendimento = a.nr_atendimento
	   and   b.ie_situacao = 'A';
	end;
elsif (cd_mdc_w = '01' and cd_classification_w = '0060') then
       begin
           select max(b.ie_indice)
           into STRICT vl_rankin_scale_w
           from patient_dpc a,
                escala_rankin b
           where a.nr_sequencia = nr_seq_patient_dpc_p
           and   b.nr_atendimento = a.nr_atendimento
           and   b.ie_situacao = 'A';
       end;
end if;

select 	count(1) 
into STRICT 	count_w2 
from 	patient_dpc_general_cond 
where 	nr_seq_patient_dpc = nr_seq_patient_dpc_p;

if (count_w2 = 0 and (cd_classification_w IS NOT NULL AND cd_classification_w::text <> '')) then
	begin
	   insert into patient_dpc_general_cond(
           nr_sequencia,
		   dt_atualizacao,
		   nm_usuario,
		   nr_seq_patient_dpc,
		   nr_seq_mdc,
		   nr_seq_classification,
		   si_pneumonia_state,
		   vl_gaf_score,
		   vl_rankin_scale)
	   values (
       nextval('patient_dpc_general_cond_seq'),
	   clock_timestamp(),
		   nm_usario_p,
		   nr_seq_patient_dpc_p,
		   nr_seq_mdc_w,
		   nr_seq_classification_w,
		   si_pneumonia_state_w,
		   vl_gaf_score_w,
		   vl_rankin_scale_w);
	end;
elsif (count_w2 > 0 and (cd_classification_w IS NOT NULL AND cd_classification_w::text <> '')) then
    begin
    
        delete  from patient_dpc_general_cond 
        where 	nr_seq_patient_dpc = nr_seq_patient_dpc_p;

        insert into patient_dpc_general_cond(
           nr_sequencia,
		   dt_atualizacao,
		   nm_usuario,
		   nr_seq_patient_dpc,
		   nr_seq_mdc,
		   nr_seq_classification,
		   si_pneumonia_state,
		   vl_gaf_score,
		   vl_rankin_scale) 
	    values (
           nextval('patient_dpc_general_cond_seq'),
	       clock_timestamp(),
		   nm_usario_p,
		   nr_seq_patient_dpc_p,
		   nr_seq_mdc_w,
		   nr_seq_classification_w,
		   si_pneumonia_state_w,
		   vl_gaf_score_w,
		   vl_rankin_scale_w);
    end;
end if;
commit;
CALL dpc_pkg.gen_pat_dpc_surgery(nr_seq_patient_dpc_p, nm_usario_p);
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE dpc_pkg.gen_pat_dpc_general_cond (nr_seq_patient_dpc_p bigint, nm_usario_p text) FROM PUBLIC;
