-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION dpc_pkg.get_most_expensive_disease (nr_atendimento_p bigint) RETURNS bigint AS $body$
DECLARE

ds_return_w	diagnostico_doenca.nr_seq_interno%type;
ie_most_exp_disease_w   parametros_episodio.ie_most_exp_disease%type;

BEGIN

select  coalesce(max(ie_most_exp_disease), 'Y')
into STRICT    ie_most_exp_disease_w
from    parametros_episodio 
where   cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento;

if (ie_most_exp_disease_w = 'Y') then
        select  max(nr_seq_interno)
        into STRICT    ds_return_w
        from    diagnostico_doenca
        where   nr_atendimento = nr_atendimento_p
        and     ie_classificacao_doenca ='P';
elsif (ie_most_exp_disease_w = 'N') then
      	select  max(a.NR_SEQ_INTERNO)
        into STRICT    ds_return_w
        from    DIAGNOSTICO_DOENCA a,
                DIAGNOSTICO_CLASSIF_ADIC b
        where   b.nr_sequencia = a.NR_SEQ_CLASSIF_ADIC
        and     a.nr_atendimento = nr_atendimento_p
        and     b.ie_tipo_diagnostico = 'E';
end if;

return	ds_return_w;
end;



$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION dpc_pkg.get_most_expensive_disease (nr_atendimento_p bigint) FROM PUBLIC;
