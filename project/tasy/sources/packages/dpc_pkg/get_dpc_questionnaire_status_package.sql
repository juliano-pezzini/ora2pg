-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION dpc_pkg.get_dpc_questionnaire_status (nr_seq_dpc_p bigint) RETURNS bigint AS $body$
DECLARE

si_status_w     patient_dpc_questionnaire.si_status%type;
quantity_w      bigint;
ds_return_w     bigint;

BEGIN

select  count(1)
into STRICT    quantity_w
from    patient_dpc_questionnaire a,
        patient_dpc b
where   a.nr_seq_patient_dpc = b.nr_sequencia 
and     b.nr_sequencia = nr_seq_dpc_p
and     a.ie_situacao = 'A';

if (quantity_w > 1) then
        ds_return_w := 0;       --status : 0 - More than one Questionnaire
elsif (quantity_w > 0) then
        select  max(si_status)
        into STRICT    si_status_w
        from    patient_dpc_questionnaire a,
                patient_dpc b
        where   a.nr_seq_patient_dpc = b.nr_sequencia 
        and     b.nr_sequencia       = nr_seq_dpc_p
        and     a.ie_situacao        = 'A';
        if (si_status_w = 1) then
                ds_return_w := 1;       --status: 1 - Saved as draft by physician
        elsif (si_status_w = 2) then
                ds_return_w := 2;       --status: 2 - Submitted by physician  
        elsif (si_status_w = 3) then
                ds_return_w := 3;       --status: 3 - Saved as draft by the team
        elsif (si_status_w = 4) then
                ds_return_w := 4;       --status: 4 - Submitted by the team
        else
                ds_return_w := 5;
        end if;
else
        ds_return_w := 5;       --status: 5 - There is no Questionnaire
end if;
return	ds_return_w;
end;


$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION dpc_pkg.get_dpc_questionnaire_status (nr_seq_dpc_p bigint) FROM PUBLIC;
