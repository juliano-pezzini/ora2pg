-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE dpc_pkg.inactivate_patient_dpc (NR_SEQ_PATIENT_DPC_P bigint, NM_USUARIO_P text) AS $body$
DECLARE

ie_gerar_evol_cancel_dpc_w     varchar(1);
cd_evolucao_w                   bigint;

BEGIN
  update PATIENT_DPC
	set IE_SITUACAO = 'I', DT_INATIVACAO = clock_timestamp(), NM_USUARIO_INATIVACAO = NM_USUARIO_P
	WHERE NR_SEQUENCIA = NR_SEQ_PATIENT_DPC_P;
	obter_param_usuario(281, 1629, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, coalesce(wheb_usuario_pck.get_cd_estabelecimento, 1), ie_gerar_evol_cancel_dpc_w);
/* Clinical note Soap deletion of record */

    if ( ie_gerar_evol_cancel_dpc_w = 'S' ) then
    select CD_EVOLUCAO
    into STRICT cd_evolucao_w
    from PATIENT_DPC
    where NR_SEQUENCIA = NR_SEQ_PATIENT_DPC_P;
    if (coalesce(cd_evolucao_w ,0) > 0) then
    delete from clinical_note_soap_data where cd_evolucao = cd_evolucao_w and ie_med_rec_type ='DPC' and ie_stage = 1 and ie_soap_type = 'P' and nr_seq_med_item= NR_SEQ_PATIENT_DPC_P;
	CALL clinical_notes_pck.soap_data_after_delete(cd_evolucao_w);
    end if;
    end if;
commit;
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE dpc_pkg.inactivate_patient_dpc (NR_SEQ_PATIENT_DPC_P bigint, NM_USUARIO_P text) FROM PUBLIC;
