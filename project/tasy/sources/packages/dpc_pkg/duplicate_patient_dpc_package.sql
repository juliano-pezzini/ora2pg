-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE dpc_pkg.duplicate_patient_dpc (NR_SEQ_DPC_P bigint,DT_END_DPC_P timestamp,DT_START_DPC_P timestamp,NM_USUARIO_P text) AS $body$
DECLARE

NR_SEQ_NEW_DPC_W PATIENT_DPC.NR_SEQUENCIA%TYPE;
DT_START_OLD_DPC_W PATIENT_DPC.DT_START_DPC%type;


BEGIN

SELECT	nextval('patient_dpc_seq')
INTO STRICT NR_SEQ_NEW_DPC_W
;

begin
INSERT INTO PATIENT_DPC(	
	NR_SEQUENCIA,
	NM_USUARIO,
	DT_ATUALIZACAO,
	DT_ATUALIZACAO_NREC,                        
	NM_USUARIO_NREC,              
	NR_ATENDIMENTO,            
	IE_SITUACAO,           
	DT_LIBERACAO,                                
	DT_INATIVACAO,                              
	NM_USUARIO_INATIVACAO,              
	CD_DEPARTAMENTO,                      
	DT_START_DPC,                             
	NR_SEQ_MOST_EXP_DIAGNOSIS,           
	SI_SURGERY,                        
	NR_SEQ_DPC_SCORE,                   
	NR_SEQ_EDITION,                    
	SI_CATEGORY,                        
	SI_ADMISSION_REASON,                 
	SI_INPATIENT_ROUTE,                 
	SI_EXIT_POINT,                      
	SI_OUT_COME,                          
	SI_AMBULANCE,                       
	DT_END_DPC,                             
	SI_NORMAL_URGENT,
	NR_DISEASE_NUMBER	
	)
SELECT	NR_SEQ_NEW_DPC_W,
	NM_USUARIO_P,
	clock_timestamp(),
	clock_timestamp(),
	NM_USUARIO_P,
	NR_ATENDIMENTO,            
	IE_SITUACAO,           
	DT_LIBERACAO,                                
	DT_INATIVACAO,                              
	NM_USUARIO_INATIVACAO,              
	CD_DEPARTAMENTO,                      
	DT_START_DPC_P,                             
	NR_SEQ_MOST_EXP_DIAGNOSIS,           
	SI_SURGERY,                        
	NR_SEQ_DPC_SCORE,                   
	NR_SEQ_EDITION,                    
	SI_CATEGORY,                        
	SI_ADMISSION_REASON,                 
	SI_INPATIENT_ROUTE,                 
	SI_EXIT_POINT,                      
	SI_OUT_COME,                          
	SI_AMBULANCE,                       
	null,                             
	SI_NORMAL_URGENT,
	NR_DISEASE_NUMBER
FROM PATIENT_DPC
WHERE NR_SEQUENCIA = NR_SEQ_DPC_P;

exception when others then
CALL gravar_log_tasy(91210,'Error when trying to insert record into table PATIENT_DPC',NM_USUARIO_P);
end;
begin
insert into PATIENT_DPC_GENERAL_COND(
	NR_SEQUENCIA,
	DT_ATUALIZACAO,                  
	NM_USUARIO,               
	DT_ATUALIZACAO_NREC,                      
	NM_USUARIO_NREC,                   
	NR_SEQ_PATIENT_DPC,        
	NR_SEQ_MDC,                 
	NR_SEQ_CLASSIFICATION,     
	SI_PNEUMONIA_STATE,                 
	VL_BURN_INDEX,                      
	SI_JCS,                             
	VL_GAF_SCORE,                          
	QT_PREGNANCY_AGE_WEEKS,             
	QT_BIRTH_WEIGHT_GRAMS,                 
	SI_STROKE_ONSET,                    
	VL_ACUTE_PANCREATITIS_3_9,           
	VL_ACUTE_PANCREATITIS_0_2,            
	VL_RANKIN_SCALE,                      
	VL_DROP_SCORE)
SELECT nextval('patient_dpc_general_cond_seq'),
	clock_timestamp(),
	NM_USUARIO_P,
	clock_timestamp(),
	NM_USUARIO_P,
	NR_SEQ_NEW_DPC_W,        
	NR_SEQ_MDC,                 
	NR_SEQ_CLASSIFICATION,     
	SI_PNEUMONIA_STATE,                 
	VL_BURN_INDEX,                      
	SI_JCS,                             
	VL_GAF_SCORE,                          
	QT_PREGNANCY_AGE_WEEKS,             
	QT_BIRTH_WEIGHT_GRAMS,                 
	SI_STROKE_ONSET,                    
	VL_ACUTE_PANCREATITIS_3_9,           
	VL_ACUTE_PANCREATITIS_0_2,            
	VL_RANKIN_SCALE,                      
	VL_DROP_SCORE
from PATIENT_DPC_GENERAL_COND
WHERE NR_SEQ_PATIENT_DPC = NR_SEQ_DPC_P;
commit;

exception when others then
CALL gravar_log_tasy(91210,'Error when trying to insert record into table PATIENT_DPC_GENERAL_COND',NM_USUARIO_P);
end;
begin
insert into PATIENT_DPC_DIAGNOSIS(
	NR_SEQUENCIA,
	DT_ATUALIZACAO,                  
	NM_USUARIO,               
	DT_ATUALIZACAO_NREC,                    
	NM_USUARIO_NREC,                    
	NR_SEQ_PATIENT_DPC,                 
	NR_SEQ_DIAGNOSIS,                     
	SI_MAIN,                             
	SI_FOR_HOSPITALIZATION,             
	SI_SECOND_MOST_EXPENSIVE,             
	SI_SUB_DISEASE,                     
	SI_COMORBIDITY_BEFORE,              
	SI_AFTER_ADMISSION,                
	SI_PSYCHOSOMATIC_DISORDER,          
	SI_CAUSE_OF_DEATH,
	NR_DISEASE_NUMBER)
SELECT nextval('patient_dpc_diagnosis_seq'),
	clock_timestamp(),
	NM_USUARIO_P,
	clock_timestamp(),
	NM_USUARIO_P,
	NR_SEQ_NEW_DPC_W,                 
	NR_SEQ_DIAGNOSIS,                     
	SI_MAIN,                             
	SI_FOR_HOSPITALIZATION,             
	SI_SECOND_MOST_EXPENSIVE,             
	SI_SUB_DISEASE,                     
	SI_COMORBIDITY_BEFORE,              
	SI_AFTER_ADMISSION,                
	SI_PSYCHOSOMATIC_DISORDER,          
	SI_CAUSE_OF_DEATH,
	NR_DISEASE_NUMBER
from PATIENT_DPC_DIAGNOSIS
where NR_SEQ_PATIENT_DPC = NR_SEQ_DPC_P;

exception when others then
CALL gravar_log_tasy(91210,'Error when trying to insert record into table PATIENT_DPC_DIAGNOSIS',NM_USUARIO_P);
end;
begin
insert into PATIENT_DPC_TREATMENT(
	NR_SEQUENCIA,
	DT_ATUALIZACAO,             
	NM_USUARIO,          
	DT_ATUALIZACAO_NREC,                  
	NM_USUARIO_NREC,              
	NR_SEQ_PATIENT_DPC,            
	NR_SEQ_DPC_TREAT_1,           
	DT_TREATMENT_1,                     
	NR_SEQ_DPC_TREAT_2,           
	DT_TREATMENT_2)
SELECT 	nextval('patient_dpc_treatment_seq'),
	clock_timestamp(),
	NM_USUARIO_P,
	clock_timestamp(),
	NM_USUARIO_P,
	NR_SEQ_NEW_DPC_W,            
	NR_SEQ_DPC_TREAT_1,           
	DT_TREATMENT_1,                     
	NR_SEQ_DPC_TREAT_2,           
	DT_TREATMENT_2
from PATIENT_DPC_TREATMENT
where NR_SEQ_PATIENT_DPC = NR_SEQ_DPC_P;

exception when others then
CALL gravar_log_tasy(91210,'Error when trying to insert record into table PATIENT_DPC_TREATMENT',NM_USUARIO_P);
end;
begin
insert into PATIENT_DPC_SURGERY(
	NR_SEQUENCIA,
	DT_ATUALIZACAO,               
	NM_USUARIO,         
	DT_ATUALIZACAO_NREC,           
	NM_USUARIO_NREC,             
	NR_SEQ_PATIENT_DPC,      
	NR_SEQ_DPC_SURGERY,              
	NR_SEQ_DPC_SEVERITY,             
	DT_SURGERY,                 
	CD_TIMES_SURGERY,              
	CD_ANESTHESIA,                 
	CD_EXTERNAL_PART,              
	CD_INTERNAL_PART,              
	CD_EYES,                       
	DT_SURGERY2,                       
	CD_TIMES_SURGERY2,             
	CD_ANESTHESIA2,                
	CD_EXTERNAL_PART2,             
	CD_INTERNAL_PART2,             
	CD_EYES2,                      
	DT_SURGERY3,                          
	CD_TIMES_SURGERY3,             
	CD_ANESTHESIA3,                
	CD_EXTERNAL_PART3,             
	CD_INTERNAL_PART3,            
	CD_EYES3,            
	DT_SURGERY4,                          
	CD_TIMES_SURGERY4,             
	CD_ANESTHESIA4,            
	CD_EXTERNAL_PART4,             
	CD_INTERNAL_PART4,            
	CD_EYES4,            
	DT_SURGERY5,                         
	CD_TIMES_SURGERY5,             
	CD_ANESTHESIA5,            
	CD_EXTERNAL_PART5,             
	CD_INTERNAL_PART5,            
	CD_EYES5,            
	CD_REHABILITATION,             
	IE_SITUACAO)
SELECT nextval('patient_dpc_surgery_seq'),           
	clock_timestamp(),               
	NM_USUARIO_P,         
	clock_timestamp(),           
	NM_USUARIO_P,             
	NR_SEQ_NEW_DPC_W,      
	NR_SEQ_DPC_SURGERY,              
	NR_SEQ_DPC_SEVERITY,             
	DT_SURGERY,                 
	CD_TIMES_SURGERY,              
	CD_ANESTHESIA,                 
	CD_EXTERNAL_PART,              
	CD_INTERNAL_PART,              
	CD_EYES,                       
	DT_SURGERY2,                       
	CD_TIMES_SURGERY2,             
	CD_ANESTHESIA2,                
	CD_EXTERNAL_PART2,             
	CD_INTERNAL_PART2,             
	CD_EYES2,                      
	DT_SURGERY3,                          
	CD_TIMES_SURGERY3,             
	CD_ANESTHESIA3,                
	CD_EXTERNAL_PART3,             
	CD_INTERNAL_PART3,            
	CD_EYES3,            
	DT_SURGERY4,                          
	CD_TIMES_SURGERY4,             
	CD_ANESTHESIA4,            
	CD_EXTERNAL_PART4,             
	CD_INTERNAL_PART4,            
	CD_EYES4,            
	DT_SURGERY5,                         
	CD_TIMES_SURGERY5,             
	CD_ANESTHESIA5,            
	CD_EXTERNAL_PART5,             
	CD_INTERNAL_PART5,            
	CD_EYES5,            
	CD_REHABILITATION,             
	IE_SITUACAO       
from PATIENT_DPC_SURGERY 
where NR_SEQ_PATIENT_DPC = NR_SEQ_DPC_P;

exception when others then
CALL gravar_log_tasy(91210,'Error when trying to insert record into table PATIENT_DPC_TREATMENT',NM_USUARIO_P);
end;

SELECT DT_START_DPC
INTO STRICT DT_START_OLD_DPC_W
FROM PATIENT_DPC
WHERE NR_SEQUENCIA = NR_SEQ_DPC_P;

CALL DPC_PKG.VALIDATE_PATIENT_DPC(NR_SEQ_DPC_P,DT_START_OLD_DPC_W, DT_END_DPC_P);

update PATIENT_DPC set DT_END_DPC = DT_END_DPC_P
where NR_SEQUENCIA= NR_SEQ_DPC_P;



commit;
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE dpc_pkg.duplicate_patient_dpc (NR_SEQ_DPC_P bigint,DT_END_DPC_P timestamp,DT_START_DPC_P timestamp,NM_USUARIO_P text) FROM PUBLIC;
