-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION dpc_pkg.get_scores_dpc (nr_seq_dpc_score_p bigint, dt_start_p timestamp, dt_end_p timestamp) RETURNS SETOF T_DPC_SCORES_DATA AS $body$
DECLARE


row_w 			t_dpc_scores_row;
qt_days_hosp_1_w 	dpc_score.qt_days_hosp_1%type;
qt_days_hosp_2_w 	dpc_score.qt_days_hosp_2%type;
qt_days_hosp_3_w 	dpc_score.qt_days_hosp_3%type;
qt_points_hosp_1_W 	dpc_score.qt_points_hosp_1%type;
qt_points_hosp_2_W 	dpc_score.qt_points_hosp_2%type;
qt_points_hosp_3_W 	dpc_score.qt_points_hosp_3%type;
qt_period_1_w		bigint;
qt_period_2_w		bigint;
qt_period_3_w		bigint;
number_of_days_w	bigint;

BEGIN
  number_of_days_w := round((trunc(dt_end_p,'dd') - trunc(dt_start_p,'dd'))::numeric,0);
  if (number_of_days_w = 0) then number_of_days_w := 1; end if;

  SELECT qt_days_hosp_1,
         qt_days_hosp_2, 
         qt_days_hosp_3, 
         qt_points_hosp_1, 
         qt_points_hosp_2, 
         qt_points_hosp_3 
  INTO STRICT   qt_days_hosp_1_w, 
         qt_days_hosp_2_w, 
         qt_days_hosp_3_w, 
         qt_points_hosp_1_w, 
         qt_points_hosp_2_w, 
         qt_points_hosp_3_w 
  FROM   dpc_score 
  WHERE  nr_sequencia=nr_seq_dpc_score_p;
	
  --accumulating per days 	
  for i in 1..number_of_days_w loop
  	begin
  	  --Fee for service
	  if (i > qt_days_hosp_3_w) then
		row_w.qt_days   := i;
		row_w.qt_points := qt_period_3_w + ((i-qt_days_hosp_3_w) * qt_points_hosp_3_w);
		RETURN NEXT row_w;
	  --Period 3
	  elsif (i > qt_days_hosp_2_w) then		
		row_w.qt_days   := i;
		row_w.qt_points := qt_period_2_w + ((i-qt_days_hosp_2_w) * qt_points_hosp_3_w);
		qt_period_3_w   := row_w.qt_points;
		RETURN NEXT row_w;
		
	  --Period 2
	  elsif (i > qt_days_hosp_1_w) then
		row_w.qt_days   := i;
		row_w.qt_points := qt_period_1_w + ((i-qt_days_hosp_1_w) * qt_points_hosp_2_w);
		qt_period_2_w   := row_w.qt_points;
		RETURN NEXT row_w;

	  --Period 1
	  elsif (i > 0) then
		row_w.qt_days   := i;
		row_w.qt_points := i * qt_points_hosp_1_w;
		qt_period_1_w   := row_w.qt_points;
		RETURN NEXT row_w;
	  end if;
	
  	end;
  end loop;

  return;
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION dpc_pkg.get_scores_dpc (nr_seq_dpc_score_p bigint, dt_start_p timestamp, dt_end_p timestamp) FROM PUBLIC;
