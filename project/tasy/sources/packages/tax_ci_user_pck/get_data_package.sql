-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION tax_ci_user_pck.get_data (username_p usuario.nm_usuario%type) RETURNS SETOF USER_TABLE_DATA_W AS $body$
DECLARE

    user_w					      user_record_w;
    view_blocked_users_w  varchar(1);

    c_users CURSOR FOR
      SELECT distinct a.nm_usuario,
                      a.ds_usuario,
                      b.ds_setor_atendimento,
                      substr(obter_nome_estabelecimento(a.cd_estabelecimento), 1,255) ds_estabelecimento,
                      substr(obter_valor_dominio(72,a.ie_tipo_evolucao),1,30) ds_evolucao,
                      a.ie_situacao
      FROM usuario a
LEFT OUTER JOIN usuario_estabelecimento x ON (a.nm_usuario = x.nm_usuario_param)
LEFT OUTER JOIN setor_atendimento b ON (a.cd_setor_atendimento = b.cd_setor_atendimento)
WHERE ((coalesce(view_blocked_users_w, 'N') = 'N' and a.ie_situacao = 'A')
      or (coalesce(view_blocked_users_w, 'N') = 'S' and a.ie_situacao in ('A', 'B')));


BEGIN
    obter_param_usuario(87, 64, obter_perfil_ativo, username_p, obter_estabelecimento_ativo, view_blocked_users_w);

    for user in c_users loop
      begin
        user_w.username             := user.nm_usuario;
        user_w.user_description     := user.ds_usuario;
        user_w.sector               := user.ds_setor_atendimento;
        user_w.establishment_name   := user.ds_estabelecimento;
        user_w.evolution            := user.ds_evolucao;
        user_w.user_status          := user.ie_situacao;
        RETURN NEXT user_w;
      end;
    end loop;
    return;
  END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION tax_ci_user_pck.get_data (username_p usuario.nm_usuario%type) FROM PUBLIC;
