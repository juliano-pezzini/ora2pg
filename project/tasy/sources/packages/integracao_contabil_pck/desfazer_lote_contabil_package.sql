-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE integracao_contabil_pck.desfazer_lote_contabil ( nr_lote_contabil_p text, nm_usuario_p text, ds_erro_p INOUT text) AS $body$
DECLARE


	cd_log_w				bigint;
	ds_erro_w			varchar(255);
	dt_atualizacao_saldo_w		timestamp;
	nr_lote_contabil_w			bigint;

	
BEGIN

	select	coalesce(max(nr_lote_contabil),0)
	into STRICT	nr_lote_contabil_w
	from	lote_contabil
	where	nr_lote_externo	= nr_lote_contabil_p;

	select	max(dt_atualizacao_saldo)
	into STRICT	dt_atualizacao_saldo_w
	from	lote_contabil
	where	nr_lote_contabil	= nr_lote_contabil_w;

	if (dt_atualizacao_saldo_w IS NOT NULL AND dt_atualizacao_saldo_w::text <> '') then
		ds_erro_w	:= substr('O lote (W/S): ' || nr_lote_contabil_w || '/' || nr_lote_contabil_p || ' j√° foi atualizado no Tasy!',1,255);
	end if;

	if (coalesce(ds_erro_w,'X') = 'X') then
		begin
		delete	FROM ctb_movimento
		where	nr_lote_contabil	= nr_lote_contabil_w
		and	nm_usuario_nrec	= 'IntegrSen';

		update	lote_contabil
		set	vl_debito		= 0,
			vl_credito		= 0,
			nm_usuario	= nm_usuario_p,
			dt_atualizacao	= clock_timestamp()
		where	nr_lote_contabil	= nr_lote_contabil_w;

		exception when others then
		ds_erro_w	:= substr('Erro ao excluir o lote: ' || nr_lote_contabil_p ||  ' - ' || sqlerrm(SQLSTATE),1,255);
		end;
	end if;
	ds_erro_p		:= ds_erro_w;
	end;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE integracao_contabil_pck.desfazer_lote_contabil ( nr_lote_contabil_p text, nm_usuario_p text, ds_erro_p INOUT text) FROM PUBLIC;
