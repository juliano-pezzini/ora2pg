-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE hdm_indic_pck.link_program_with_mu_fact () AS $body$
BEGIN
		merge into hdm_indic_ft_medication_pr y
		using(	/* Program whit module */

			SELECT	a.nr_sequencia nr_seq_dimensao,
				x.nr_sequencia nr_seq_fact
			FROM hdm_indic_dm_day y, mprev_programa_modulo pm, mprev_participante g, mprev_programa_partic e, mprev_prog_partic_modulo d, hdm_indic_dm_program a, hdm_indic_ft_medication x
LEFT OUTER JOIN hdm_indic_dm_day z ON (x.nr_seq_day_end = z.nr_sequencia)
WHERE y.dt_complete_date <= coalesce(e.dt_exclusao,y.dt_complete_date) and y.dt_complete_date <= coalesce(d.dt_saida,y.dt_complete_date) and (z.dt_complete_date > e.dt_exclusao or coalesce(z.dt_complete_date::text, '') = '') and (z.dt_complete_date > d.dt_saida or coalesce(z.dt_complete_date::text, '') = '') and y.nr_sequencia = x.nr_seq_day_start  and a.nr_seq_program = pm.nr_seq_programa and a.nr_seq_module = pm.nr_seq_modulo and d.nr_seq_prog_modulo = pm.nr_sequencia and d.nr_seq_programa_partic = e.nr_sequencia and g.nr_sequencia	= e.nr_seq_participante and x.nr_dif_person	= g.cd_pessoa_fisica group by
				a.nr_sequencia,
				x.nr_sequencia
			
union

			/* Without module */


			SELECT	distinct
				a.nr_sequencia nr_seq_dimensao,
				x.nr_sequencia nr_seq_fact
			FROM hdm_indic_dm_day y, mprev_participante g, mprev_programa_partic e, hdm_indic_dm_program a, hdm_indic_ft_medication x
LEFT OUTER JOIN hdm_indic_dm_day z ON (x.nr_seq_day_end = z.nr_sequencia)
WHERE y.dt_complete_date <= coalesce(e.dt_exclusao,y.dt_complete_date) and (z.dt_complete_date > e.dt_exclusao or coalesce(z.dt_complete_date::text, '') = '') and a.nr_seq_program = e.nr_seq_programa and a.nr_seq_module = 0 and y.nr_sequencia = x.nr_seq_day_start  and g.nr_sequencia	= e.nr_seq_participante and x.nr_dif_person	= g.cd_pessoa_fisica group by
				a.nr_sequencia,
				x.nr_sequencia
			) x
		on (	y.nr_seq_fact = x.nr_seq_fact and
			y.nr_seq_dimensao = x.nr_seq_dimensao)
		when not matched then
			insert(y.nr_seq_fact,
				y.nr_seq_dimensao)
			values (x.nr_seq_fact,
				x.nr_seq_dimensao);
		commit;
		
		merge into hdm_indic_ft_medication_pr y
		using(	SELECT	0 nr_seq_dimensao,
			x.nr_sequencia nr_seq_fact
		from	hdm_indic_ft_medication x
		where	not exists (select	1
					from	hdm_indic_ft_medication_pr a
					where	a.nr_seq_fact	= x.nr_sequencia)
			) x
		on (	y.nr_seq_fact = x.nr_seq_fact and
			y.nr_seq_dimensao = x.nr_seq_dimensao)
		when not matched then
			insert(y.nr_seq_fact,
				y.nr_seq_dimensao)
			values (x.nr_seq_fact,
				x.nr_seq_dimensao);
		commit;
	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE hdm_indic_pck.link_program_with_mu_fact () FROM PUBLIC;
