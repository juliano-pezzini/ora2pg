-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE hdm_indic_pck.populate_dim_month () AS $body$
DECLARE

		dt_month_w		timestamp;
	
BEGIN
		dt_month_w	:= pkg_date_utils.start_of(current_setting('hdm_indic_pck.dt_start_population_w')::timestamp,'MONTH', 0);
		while(dt_month_w <= current_setting('hdm_indic_pck.dt_end_population_w')::timestamp) loop
			insert into hdm_indic_dm_month(	nr_sequencia,
								dt_atualizacao, 
								nm_usuario, 
								dt_atualizacao_nrec, 
								nm_usuario_nrec, 
								nr_year, 
								nr_month, 
								nr_semester, 
								nr_quarter, 
								dt_complete_date,
								dt_month_end)
			values (	nextval('hdm_indic_dm_month_seq'),
					clock_timestamp(),
					current_setting('hdm_indic_pck.nm_usuario_w')::usuario.nm_usuario%type,
					clock_timestamp(),
					current_setting('hdm_indic_pck.nm_usuario_w')::usuario.nm_usuario%type,
					(PKG_DATE_UTILS.extract_field('YEAR',dt_month_w))::numeric ,
					(PKG_DATE_UTILS.extract_field('MONTH',dt_month_w))::numeric ,
					(CASE WHEN to_char(dt_month_w, 'q')=1 THEN  1 WHEN to_char(dt_month_w, 'q')=2 THEN  1  ELSE 2 END )::numeric ,
					(to_char(dt_month_w, 'q'))::numeric ,
					dt_month_w,
					fim_mes(dt_month_w));
			dt_month_w := pkg_date_utils.add_month(dt_month_w, 1, 0);
			
			if (current_setting('hdm_indic_pck.qt_record_w')::integer >= current_setting('hdm_indic_pck.qt_rec_commit_w')::integer) then
				commit;
				PERFORM set_config('hdm_indic_pck.qt_record_w', 0, false);
			end if;
			PERFORM set_config('hdm_indic_pck.qt_record_w', current_setting('hdm_indic_pck.qt_record_w')::integer + 1, false);
		end loop;
		commit;
	end;

	/*---------------------------------------------------------------------------------------------------------------------------------------------
	|			FACTS						 	    |
	*/


	/*				*
	*	VITAL SIGNS FACTS		*
	*				*/

	

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE hdm_indic_pck.populate_dim_month () FROM PUBLIC;
