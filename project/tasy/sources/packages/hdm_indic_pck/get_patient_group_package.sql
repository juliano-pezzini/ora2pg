-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION hdm_indic_pck.get_patient_group ( cd_pessoa_fisica_p text, nr_seq_participante_p bigint, dt_nascimento_p timestamp, ie_sexo_p text) RETURNS bigint AS $body$
DECLARE

	nr_seq_patient_group_w	bigint;
	si_participant_w	varchar(1);
	c_patient_group CURSOR FOR
		-- With all fields

		SELECT	x.nr_sequencia
		from	hdm_indic_dm_patient_group x
		where	ie_sexo_p = x.si_sex
		and	si_participant_w = x.si_participant
		and	dt_nascimento_p between x.dt_age_min and x.dt_age_max
		
union all

		-- Without sex or indereminate sex

		SELECT	x.nr_sequencia
		from	hdm_indic_dm_patient_group x
		where	si_participant_w = x.si_participant
		and	coalesce(ie_sexo_p,'I') = x.si_sex
		and	dt_nascimento_p between x.dt_age_min and x.dt_age_max
		
union all

		-- Without bithdate

		select	x.nr_sequencia
		from	hdm_indic_dm_patient_group x
		where	si_participant_w = x.si_participant
		and	ie_sexo_p = x.si_sex
		and	coalesce(dt_nascimento_p::text, '') = ''
		and	coalesce(x.dt_age_min::text, '') = ''
		and	coalesce(x.dt_age_max::text, '') = ''
		
union all

		-- Without sex or indeterminate sex and birthdate

		select	x.nr_sequencia
		from	hdm_indic_dm_patient_group x
		where	si_participant_w = x.si_participant
		and	coalesce(ie_sexo_p,'I') = x.si_sex
		and	coalesce(dt_nascimento_p::text, '') = ''
		and	coalesce(x.dt_age_min::text, '') = ''
		and	coalesce(x.dt_age_max::text, '') = '';
	
BEGIN
		si_participant_w	:= 'N';
		if (nr_seq_participante_p IS NOT NULL AND nr_seq_participante_p::text <> '') then
			si_participant_w	:= 'S';
		end if;
		for r_c_patient_group in c_patient_group loop
			nr_seq_patient_group_w := r_c_patient_group.nr_sequencia;
		end loop;
		return coalesce(nr_seq_patient_group_w,0);
	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION hdm_indic_pck.get_patient_group ( cd_pessoa_fisica_p text, nr_seq_participante_p bigint, dt_nascimento_p timestamp, ie_sexo_p text) FROM PUBLIC;
