-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE hdm_indic_pck.link_professional_whit_ap_fact () AS $body$
BEGIN
		merge into hdm_indic_ft_appoint_pf y
		using (	SELECT	a.nr_sequencia nr_seq_dimension,
						x.nr_sequencia nr_seq_fact,
						x.nr_min_duration
				from	hdm_indic_dm_professional a,	
						mprev_equipe_profissional c,
						mprev_agendamento ap,
						hdm_indic_ft_appoint x,
						pessoa_fisica pf,
						mprev_funcao_colaborador fu,
						mprev_equipe eq,
						hdm_indic_dm_month y		
				where 	y.dt_complete_date between pkg_date_utils.start_of(ap.dt_agenda,'MONTH', 0) and pkg_date_utils.start_of(ap.dt_agenda,'MONTH', 0)
				and		a.nm_professional = obter_nome_pf(pf.cd_pessoa_fisica)
				and		pf.cd_pessoa_fisica = c.cd_pessoa_fisica
				and		a.nm_responsability = fu.nm_funcao
				and		fu.nr_sequencia = c.nr_seq_funcao
				and		a.nm_team = eq.nm_equipe 
				and		eq.nr_sequencia = c.nr_seq_equipe
				and		c.cd_pessoa_fisica = (	select	max(e.cd_pessoa_fisica)
												from	agenda e
												where	e.cd_agenda	= coalesce(ap.cd_agenda_profissional,ap.cd_agenda))
				and		x.Nr_Seq_Month = y.nr_sequencia
				and   	x.nr_seq_agendamento = ap.nr_sequencia
				group by
					a.nr_sequencia,
					x.nr_sequencia,
					x.nr_min_duration			
			) x
		on (	y.nr_seq_fact = x.nr_seq_fact and
			y.nr_seq_dimension = x.nr_seq_dimension)
		when not matched then
			insert(y.nr_seq_fact, 
				y.nr_seq_dimension,
				y.nr_min_duration)
			values (x.nr_seq_fact,
				x.nr_seq_dimension,
				x.nr_min_duration);
		commit;
	
		merge into hdm_indic_ft_appoint_pf y
		using(	SELECT	0 nr_seq_dimension,
				x.nr_sequencia nr_seq_fact,
				x.nr_min_duration
			from	hdm_indic_ft_appoint x
			where	not exists (select	1
						from	hdm_indic_ft_appoint_pf a
						where	a.nr_seq_fact	= x.nr_sequencia)
			) x
		on (	y.nr_seq_fact = x.nr_seq_fact and
			y.nr_seq_dimension = x.nr_seq_dimension)
		when not matched then
			insert(y.nr_seq_fact,
				y.nr_seq_dimension,
				y.nr_min_duration)
			values (x.nr_seq_fact,
				x.nr_seq_dimension,
				x.nr_min_duration);
		commit;
	END;	

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE hdm_indic_pck.link_professional_whit_ap_fact () FROM PUBLIC;
