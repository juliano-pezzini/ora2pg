-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE hdm_indic_pck.populate_dim_patient_group () AS $body$
BEGIN
		merge into hdm_indic_dm_patient_group y
		using(	/* Male, participant and with birthdate */

			SELECT	a.nm_range || CHR(13) || CHR(10) || '(' || a.nr_minimum || ' ~ ' || a.nr_maximum ||')' nm_age_range,
				'M' si_sex,
				obter_valor_dominio(4,'M') ds_sex,
				'S' si_participant,
				wheb_mensagem_pck.get_texto(309708) ds_participant,
				pkg_date_utils.start_of(trunc(pkg_date_utils.add_month(current_setting('hdm_indic_pck.dt_start_w')::timestamp, - a.nr_maximum * 12, 0)), 'YEAR', 0) dt_age_min,
				fim_ano(trunc(pkg_date_utils.add_month(current_setting('hdm_indic_pck.dt_start_w')::timestamp, - a.nr_minimum * 12, 0))) dt_age_max,
				'N' si_default
			from	hdm_indic_age_range a
			
union all

			/* Male, not participant and with birthdate */


			SELECT	a.nm_range || CHR(13) || CHR(10) || '(' || a.nr_minimum || ' ~ ' || a.nr_maximum ||')' nm_age_range,
				'M' si_sex,
				obter_valor_dominio(4,'M') ds_sex,
				'N' si_participant,
				wheb_mensagem_pck.get_texto(309709) ds_participant,
				pkg_date_utils.start_of(trunc(pkg_date_utils.add_month(current_setting('hdm_indic_pck.dt_start_w')::timestamp, - a.nr_maximum * 12, 0)), 'YEAR', 0) dt_age_min,
				fim_ano(trunc(pkg_date_utils.add_month(current_setting('hdm_indic_pck.dt_start_w')::timestamp, - a.nr_minimum * 12, 0))) dt_age_max,
				'N' si_default
			from	hdm_indic_age_range a
			
union all

			/* Female, participant and with birthdate */


			select	a.nm_range || CHR(13) || CHR(10) || '(' || a.nr_minimum || ' ~ ' || a.nr_maximum ||')' nm_age_range,
				'F' si_sex,
				obter_valor_dominio(4,'F') ds_sex,
				'S' si_participant,
				wheb_mensagem_pck.get_texto(309708) ds_participant,
				pkg_date_utils.start_of(trunc(pkg_date_utils.add_month(current_setting('hdm_indic_pck.dt_start_w')::timestamp, - a.nr_maximum * 12, 0)), 'YEAR', 0) dt_age_min,
				fim_ano(trunc(pkg_date_utils.add_month(current_setting('hdm_indic_pck.dt_start_w')::timestamp, - a.nr_minimum * 12, 0))) dt_age_max,
				'N' si_default
			from	hdm_indic_age_range a
			
union all

			/* Female, not participant and with birthdate */


			select	a.nm_range || CHR(13) || CHR(10) || '(' || a.nr_minimum || ' ~ ' || a.nr_maximum ||')' nm_age_range,
				'F' si_sex,
				obter_valor_dominio(4,'F') ds_sex,
				'N' si_participant,
				wheb_mensagem_pck.get_texto(309709) ds_participant,
				pkg_date_utils.start_of(trunc(pkg_date_utils.add_month(current_setting('hdm_indic_pck.dt_start_w')::timestamp, - a.nr_maximum * 12, 0)), 'YEAR', 0) dt_age_min,
				fim_ano(trunc(pkg_date_utils.add_month(current_setting('hdm_indic_pck.dt_start_w')::timestamp, - a.nr_minimum * 12, 0))) dt_age_max,
				'N' si_default
			from	hdm_indic_age_range a
			
union all

			/* Indefinite, participant and with birthdate */


			select	a.nm_range || CHR(13) || CHR(10) || '(' || a.nr_minimum || ' ~ ' || a.nr_maximum ||')' nm_age_range,
				'I' si_sex,
				obter_valor_dominio(4,'I') ds_sex,
				'S' si_participant,
				wheb_mensagem_pck.get_texto(309708) ds_participant,
				pkg_date_utils.start_of(trunc(pkg_date_utils.add_month(current_setting('hdm_indic_pck.dt_start_w')::timestamp, - a.nr_maximum * 12, 0)), 'YEAR', 0) dt_age_min,
				fim_ano(trunc(pkg_date_utils.add_month(current_setting('hdm_indic_pck.dt_start_w')::timestamp, - a.nr_minimum * 12, 0))) dt_age_max,
				'N' si_default
			from	hdm_indic_age_range a
			
union all

			/* Indefinite, not participant and with birthdate */


			select	a.nm_range || CHR(13) || CHR(10) || '(' || a.nr_minimum || ' ~ ' || a.nr_maximum ||')' nm_age_range,
				'I' si_sex,
				obter_valor_dominio(4,'I') ds_sex,
				'N' si_participant,
				wheb_mensagem_pck.get_texto(309709) ds_participant,
				pkg_date_utils.start_of(trunc(pkg_date_utils.add_month(current_setting('hdm_indic_pck.dt_start_w')::timestamp, - a.nr_maximum * 12, 0)), 'YEAR', 0) dt_age_min,
				fim_ano(trunc(pkg_date_utils.add_month(current_setting('hdm_indic_pck.dt_start_w')::timestamp, - a.nr_minimum * 12, 0))) dt_age_max,
				'N' si_default
			from	hdm_indic_age_range a
			
union all

			/* Male, participant and without birthdate */


			select	wheb_mensagem_pck.get_texto(358141) nm_age_range,
				'M' si_sex,
				obter_valor_dominio(4,'M') ds_sex,
				'S' si_participant,
				wheb_mensagem_pck.get_texto(309708) ds_participant,
				null dt_age_min,
				null dt_age_max,
				'N' si_default
			
			
union all

			/* Male, not participantand without birthdate */


			select	wheb_mensagem_pck.get_texto(358141) nm_age_range,
				'M' si_sex,
				obter_valor_dominio(4,'M') ds_sex,
				'N' si_participant,
				wheb_mensagem_pck.get_texto(309709) ds_participant,
				null dt_age_min,
				null dt_age_max,
				'N' si_default
			
			
union all

			/* Female, participant and without birthdate */


			select	wheb_mensagem_pck.get_texto(358141) nm_age_range,
				'F' si_sex,
				obter_valor_dominio(4,'F') ds_sex,
				'S' si_participant,
				wheb_mensagem_pck.get_texto(309708) ds_participant,
				null dt_age_min,
				null dt_age_max,
				'N' si_default
			
			
union all

			/* Female, not participant and without birthdate */


			select	wheb_mensagem_pck.get_texto(358141) nm_age_range,
				'F' si_sex,
				obter_valor_dominio(4,'F') ds_sex,
				'N' si_participant,
				wheb_mensagem_pck.get_texto(309709) ds_participant,
				null dt_age_min,
				null dt_age_max,
				'N' si_default
			
			
union all

			/* Indefinite, participant and without birthdate */


			select	wheb_mensagem_pck.get_texto(358141) nm_age_range,
				'I' si_sex,
				obter_valor_dominio(4,'I') ds_sex,
				'S' si_participant,
				wheb_mensagem_pck.get_texto(309708) ds_participant,
				null dt_age_min,
				null dt_age_max,
				'N' si_default
			
			
union all

			/* Indefinite, not participant and without birthdate */


			select	wheb_mensagem_pck.get_texto(358141) nm_age_range,
				'I' si_sex,
				obter_valor_dominio(4,'I') ds_sex,
				'N' si_participant,
				wheb_mensagem_pck.get_texto(309709) ds_participant,
				null dt_age_min,
				null dt_age_max,
				'N' si_default
			
			
union
	
			select	wheb_mensagem_pck.get_texto(358141) nm_age_range,
				'I' si_sex,
				obter_valor_dominio(4,'I') ds_sex,
				'N' si_participant,
				wheb_mensagem_pck.get_texto(309709) ds_participant,
				null dt_age_min,
				null dt_age_max,
				'S' si_default
			) x
		on (	y.nm_age_range = x.nm_age_range and
			y.si_sex = x.si_sex and
			y.si_participant = x.si_participant and (y.dt_age_min = x.dt_age_min or coalesce(y.dt_age_min::text, '') = '' and coalesce(x.dt_age_min::text, '') = '') and (y.dt_age_max = x.dt_age_max or coalesce(y.dt_age_max::text, '') = '' and coalesce(x.dt_age_max::text, '') = ''))
		when not matched then
			insert(nr_sequencia,
				dt_atualizacao, 
				nm_usuario, 
				dt_atualizacao_nrec, 
				nm_usuario_nrec, 
				nm_age_range, 
				si_sex, 
				ds_sex, 
				si_participant, 
				ds_participant,
				dt_age_min, 
				dt_age_max)
			values (CASE WHEN x.si_default='S' THEN  0  ELSE nextval('hdm_indic_dm_patient_group_seq') END ,
				clock_timestamp(),
				current_setting('hdm_indic_pck.nm_usuario_w')::usuario.nm_usuario%type,
				clock_timestamp(),
				current_setting('hdm_indic_pck.nm_usuario_w')::usuario.nm_usuario%type,
				substr(x.nm_age_range,1,255),
				x.si_sex,
				x.ds_sex,
				x.si_participant,
				x.ds_participant,
				x.dt_age_min,
				x.dt_age_max);
		commit;
	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE hdm_indic_pck.populate_dim_patient_group () FROM PUBLIC;
