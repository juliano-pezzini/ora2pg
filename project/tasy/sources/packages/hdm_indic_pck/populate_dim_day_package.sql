-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


	/* DAY, MONTH and YEAR */


	


CREATE OR REPLACE PROCEDURE hdm_indic_pck.populate_dim_day () AS $body$
DECLARE

		dt_day_w	timestamp;
	
BEGIN
		dt_day_w	:= pkg_date_utils.start_of(current_setting('hdm_indic_pck.dt_start_population_w')::timestamp,'DD', 0);
		while(dt_day_w <= current_setting('hdm_indic_pck.dt_end_population_w')::timestamp) loop
			insert into hdm_indic_dm_day(	nr_sequencia,
							dt_atualizacao, 
							nm_usuario, 
							dt_atualizacao_nrec, 
							nm_usuario_nrec, 
							nr_year, 
							nr_month, 
							nr_semester, 
							nr_quarter, 
							nr_day_of_week,
							ds_day_of_week,
							nr_day, 
							si_holiday, 
							si_weekend, 
							dt_complete_date,
							dt_day_end)
			values (	nextval('hdm_indic_dm_day_seq'),
					clock_timestamp(),
					current_setting('hdm_indic_pck.nm_usuario_w')::usuario.nm_usuario%type,
					clock_timestamp(),
					current_setting('hdm_indic_pck.nm_usuario_w')::usuario.nm_usuario%type,
					(PKG_DATE_UTILS.extract_field('YEAR',dt_day_w))::numeric ,
					(PKG_DATE_UTILS.extract_field('MONTH',dt_day_w))::numeric ,
					(CASE WHEN to_char(dt_day_w, 'q')=1 THEN  1 WHEN to_char(dt_day_w, 'q')=2 THEN  1  ELSE 2 END )::numeric ,
					(to_char(dt_day_w, 'q'))::numeric ,
					PKG_DATE_UTILS.get_WeekDay(dt_day_w),
					hdm_indic_pck.get_ds_day(PKG_DATE_UTILS.get_WeekDay(dt_day_w)),
					(PKG_DATE_UTILS.extract_field('DAY',dt_day_w))::numeric ,
					CASE WHEN obter_se_feriado(current_setting('hdm_indic_pck.cd_estabelecimento_w')::estabelecimento.cd_estabelecimento%type, dt_day_w)=0 THEN  'N'  ELSE 'S' END ,
					CASE WHEN PKG_DATE_UTILS.get_WeekDay(dt_day_w)=1 THEN  'S' WHEN PKG_DATE_UTILS.get_WeekDay(dt_day_w)=7 THEN  'S'  ELSE 'N' END ,
					dt_day_w,
					fim_dia(dt_day_w));
			dt_day_w	:= dt_day_w + 1;
			if (current_setting('hdm_indic_pck.qt_record_w')::integer >= current_setting('hdm_indic_pck.qt_rec_commit_w')::integer) then
				commit;
				PERFORM set_config('hdm_indic_pck.qt_record_w', 0, false);
			end if;
			PERFORM set_config('hdm_indic_pck.qt_record_w', current_setting('hdm_indic_pck.qt_record_w')::integer + 1, false);
		end loop;
		commit;
	end;
	

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE hdm_indic_pck.populate_dim_day () FROM PUBLIC;
