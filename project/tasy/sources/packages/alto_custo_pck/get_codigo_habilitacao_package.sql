-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION alto_custo_pck.get_codigo_habilitacao ( nr_atendimento_p atendimento_paciente.nr_atendimento%type, ie_tipo_doenca_p regra_alto_custo.ie_tipo_doenca%type ) RETURNS varchar AS $body$
DECLARE

    c_historico CURSOR FOR
      SELECT a.cd_doenca
      from paciente_antec_clinico a
      where a.nr_atendimento = nr_atendimento_p
      and (a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
      and coalesce(a.dt_inativacao::text, '') = ''
      and ((ie_tipo_doenca_p = 'T' and a.cd_doenca( SELECT cd_doenca_cid from cid_doenca where ie_doenca_cronica_mx('TUBER', 'TEXPU')))
      or (ie_tipo_doenca_p <> 'T' and alto_custo_pck.is_alto_custo(a.cd_doenca, ie_tipo_doenca_p) = 'S'));

    c_diagnostico CURSOR FOR
      SELECT cd_habilitacao
      from
        (SELECT est.cd_habilitacao,
          dd.cd_doenca,
          dd.dt_atualizacao
        from estabelecimento est,
          setor_atendimento sa,
          diagnostico_doenca dd
        where sa.cd_estabelecimento  = est.cd_estabelecimento
        and dd.cd_setor_atendimento  = sa.cd_setor_atendimento
        and dd.nr_atendimento        = nr_atendimento_p
        and (dd.dt_liberacao IS NOT NULL AND dd.dt_liberacao::text <> '')
        and coalesce(dd.dt_inativacao::text, '') = ''
        and ((ie_tipo_doenca_p = 'T' and dd.cd_doenca( select cd_doenca_cid from cid_doenca where ie_doenca_cronica_mx('TUBER', 'TEXPU')))
        or (ie_tipo_doenca_p <> 'T' and alto_custo_pck.is_alto_custo(dd.cd_doenca, ie_tipo_doenca_p) = 'S'))
        order by dd.dt_atualizacao desc
        ) alias8 LIMIT 1;

    r_historico c_historico%rowtype;
    r_diagnostico c_diagnostico%rowtype;
    ds_retorno_w estabelecimento.cd_habilitacao%type                    := '';
    const_possui_historico constant estabelecimento.cd_habilitacao%type := '99';

BEGIN
    begin
      open c_historico;
      fetch c_historico into r_historico;
      if c_historico%notfound then
        open c_diagnostico;
        fetch c_diagnostico into r_diagnostico;
        if c_diagnostico%notfound then
          null;
        else
          ds_retorno_w := r_diagnostico.cd_habilitacao;
        end if;
        close c_diagnostico;
      else
        ds_retorno_w := const_possui_historico;
      end if;
      close c_historico;
    exception
    when others then
      ds_retorno_w := '';
    end;
    return elimina_caracteres_especiais(ds_retorno_w);
  END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION alto_custo_pck.get_codigo_habilitacao ( nr_atendimento_p atendimento_paciente.nr_atendimento%type, ie_tipo_doenca_p regra_alto_custo.ie_tipo_doenca%type ) FROM PUBLIC;
