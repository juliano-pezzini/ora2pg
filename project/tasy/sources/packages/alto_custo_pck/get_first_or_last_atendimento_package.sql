-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION alto_custo_pck.get_first_or_last_atendimento ( cd_pessoa_fisica_p pessoa_fisica.cd_pessoa_fisica%type, ie_tipo_doenca_p regra_alto_custo.ie_tipo_doenca%type, retornar_p text ) RETURNS bigint AS $body$
DECLARE

    nr_atendimento_w  atendimento_paciente.nr_atendimento%type;

BEGIN
    begin
      select
              case
                when retornar_p = current_setting('alto_custo_pck.option_first_w')::varchar(1) then min(a.nr_atendimento)
                when retornar_p = current_setting('alto_custo_pck.option_last_w')::varchar(1) then max(a.nr_atendimento)
                else null
              end
      into STRICT    nr_atendimento_w
      from    atendimento_paciente a,
              diagnostico_doenca d,
              atend_categoria_convenio c
      where   d.nr_atendimento = a.nr_atendimento
      and     d.ie_situacao = 'A'
      and     coalesce(a.dt_cancelamento::text, '') = ''
      and     (d.dt_liberacao IS NOT NULL AND d.dt_liberacao::text <> '')
      and     alto_custo_pck.is_alto_custo(d.cd_doenca, ie_tipo_doenca_p) = 'S'
      and     trunc(a.dt_entrada) >= alto_custo_pck.get_data_inicio_emissao_guia()
      and     trunc(a.dt_entrada) <= alto_custo_pck.get_data_corte()
      and     a.cd_pessoa_fisica = cd_pessoa_fisica_p
      and     c.nr_atendimento = a.nr_atendimento
      and     c.cd_convenio = (
                                SELECT  ac.cd_convenio
                                from    alto_custo ac
                                where   ac.nr_sequencia = current_setting('alto_custo_pck.nr_seq_alto_custo_w')::alto_custo.nr_sequencia%type
                              );
    exception
      when no_data_found then
        nr_atendimento_w := null;
    end;

    return nr_atendimento_w;
  END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION alto_custo_pck.get_first_or_last_atendimento ( cd_pessoa_fisica_p pessoa_fisica.cd_pessoa_fisica%type, ie_tipo_doenca_p regra_alto_custo.ie_tipo_doenca%type, retornar_p text ) FROM PUBLIC;
