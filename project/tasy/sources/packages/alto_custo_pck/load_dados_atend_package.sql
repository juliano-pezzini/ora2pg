-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE alto_custo_pck.load_dados_atend ( cd_pessoa_fisica_p pessoa_fisica.cd_pessoa_fisica%type, ie_tipo_doenca_p regra_alto_custo.ie_tipo_doenca%type, retornar_p text ) AS $body$
 /*
  Paramentros:
    retornar_p
      F = First (primeiro atendimento)
      L = Last  (ultimo atendimento)
      A = All (todos atendimentos)
  */
DECLARE

    indice_w bigint;

    c_atendimentos CURSOR FOR
      SELECT  distinct
              a.nr_atendimento,
              a.dt_entrada
      from    atendimento_paciente a,
              diagnostico_doenca d,
              atend_categoria_convenio c
      where   d.nr_atendimento = a.nr_atendimento
      and     d.ie_situacao = 'A'
      and     coalesce(a.dt_cancelamento::text, '') = ''
      and     (d.dt_liberacao IS NOT NULL AND d.dt_liberacao::text <> '')
      and     alto_custo_pck.is_alto_custo(d.cd_doenca, ie_tipo_doenca_p) = 'S'
      and     a.cd_pessoa_fisica = cd_pessoa_fisica_p
      and     trunc(a.dt_entrada) >= alto_custo_pck.get_data_inicio_emissao_guia()
      and     trunc(a.dt_entrada) <= alto_custo_pck.get_data_corte()
      and     c.nr_atendimento = a.nr_atendimento
      and     c.cd_convenio = (
                                SELECT  ac.cd_convenio
                                from    alto_custo ac
                                where   ac.nr_sequencia = nr_seq_alto_custo_w
                              )
      and (
                upper(retornar_p) = current_setting('alto_custo_pck.option_all_w')::varchar(1)
                or (
                      upper(retornar_p) in (current_setting('alto_custo_pck.option_first_w')::varchar(1), current_setting('alto_custo_pck.option_last_w')::varchar(1))
                      and a.nr_atendimento = alto_custo_pck.get_first_or_last_atendimento(a.cd_pessoa_fisica, ie_tipo_doenca_p, retornar_p)
                    )
              );


BEGIN
    current_setting('alto_custo_pck.linha_v_w')::tabela_atend_paciente.delete();
    for linha in c_atendimentos
    loop
      begin
        current_setting('alto_custo_pck.linha_v_w')::tabela_atend_paciente.extend();
        indice_w := current_setting('alto_custo_pck.linha_v_w')::tabela_atend_paciente.count();
        current_setting('alto_custo_pck.linha_v_w')::tabela_atend_paciente[indice_w].nr_atendimento := linha.nr_atendimento;
        current_setting('alto_custo_pck.linha_v_w')::tabela_atend_paciente[indice_w].dt_entrada := linha.dt_entrada;
      end;
    end loop;

    if (retornar_p = current_setting('alto_custo_pck.option_all_w')::varchar(1)) then
      PERFORM set_config('alto_custo_pck.linha_all_v_w', current_setting('alto_custo_pck.linha_v_w')::tabela_atend_paciente, false);
    elsif (retornar_p = current_setting('alto_custo_pck.option_first_w')::varchar(1)) then
      PERFORM set_config('alto_custo_pck.linha_first_v_w', current_setting('alto_custo_pck.linha_v_w')::tabela_atend_paciente, false);
    elsif (retornar_p = current_setting('alto_custo_pck.option_last_w')::varchar(1)) then
      PERFORM set_config('alto_custo_pck.linha_last_v_w', current_setting('alto_custo_pck.linha_v_w')::tabela_atend_paciente, false);
    end if;
  END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE alto_custo_pck.load_dados_atend ( cd_pessoa_fisica_p pessoa_fisica.cd_pessoa_fisica%type, ie_tipo_doenca_p regra_alto_custo.ie_tipo_doenca%type, retornar_p text ) FROM PUBLIC;
