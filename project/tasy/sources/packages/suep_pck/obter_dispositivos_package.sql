-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION suep_pck.obter_dispositivos ( cd_pessoa_fisica_p text, nr_atendimento_p bigint, nr_seq_suep_p bigint, nm_usuario_p text ) RETURNS SETOF T_DISPOSITIVOS_ROW_DATA AS $body$
DECLARE

			 
t_dispositivos_row_w	t_dispositivos_row;

C01 CURSOR FOR 
	SELECT	substr(b.ds_dispositivo, 1, 255) ds_dispositivo, 
		a.dt_instalacao, 
		a.dt_retirada_prev, 
		a.dt_retirada 
	from	pessoa_fisica p, 
		dispositivo b, 
		atendimento_paciente c, 
		atend_pac_dispositivo a 
	where 	a.nr_seq_dispositivo = b.nr_sequencia 
	and	c.nr_atendimento = a.nr_atendimento 
	and	c.cd_pessoa_fisica = p.cd_pessoa_fisica 
	--and	a.dt_retirada is null 
	and	(a.dt_retirada_prev IS NOT NULL AND a.dt_retirada_prev::text <> '') 
	and	coalesce(c.dt_alta::text, '') = '' 
	and	p.cd_pessoa_fisica = cd_pessoa_fisica_p 
	order by a.dt_retirada_prev desc;
BEGIN
 
for r_c01 in c01 loop 
	begin 
	t_dispositivos_row_w.ds_dispositivo		:= r_c01.ds_dispositivo;
	t_dispositivos_row_w.dt_instalacao		:= r_c01.dt_instalacao;
	t_dispositivos_row_w.dt_retirada_prev		:= r_c01.dt_retirada_prev;
	t_dispositivos_row_w.dt_retirada		:= r_c01.dt_retirada;
	 
	if ((coalesce(r_c01.dt_retirada::text, '') = '') and (clock_timestamp() >= r_c01.dt_retirada_prev)) then 
	  t_dispositivos_row_w.ds_status := substr(obter_desc_expressao(330951),1,100); -- Expirado. 
	elsif ((coalesce(r_c01.dt_retirada::text, '') = '') and (clock_timestamp() between r_c01.dt_retirada_prev -1 and r_c01.dt_retirada_prev)) then
	  t_dispositivos_row_w.ds_status := substr(obter_desc_expressao(330479),1,100); -- A Expirar. 
	else
	  t_dispositivos_row_w.ds_status := substr(obter_desc_expressao(294264),1,100); -- Normal. 
	end if;
	 
	RETURN NEXT t_dispositivos_row_w;
	end;
end loop;
 
return;
 
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION suep_pck.obter_dispositivos ( cd_pessoa_fisica_p text, nr_atendimento_p bigint, nr_seq_suep_p bigint, nm_usuario_p text ) FROM PUBLIC;
