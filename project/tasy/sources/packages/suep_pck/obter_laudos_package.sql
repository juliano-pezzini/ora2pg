-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION suep_pck.obter_laudos ( cd_pessoa_fisica_p text, nr_atendimento_p bigint, nr_seq_suep_p bigint, nm_usuario_p text ) RETURNS SETOF T_LAUDO_ROW_DATA AS $body$
DECLARE

			 
t_laudo_row_w			t_laudo_row;
dt_inicial_w		timestamp;
dt_final_w			timestamp;
ie_tipo_busca_w		varchar(1);
qt_dias_busca_w		bigint;
qt_consultas_w		bigint;
ie_restringir_tipo_atend_w		varchar(1);
ie_tipo_atendimento_w	smallint := -1;
ds_lista_atendimentos_w varchar(2000) := '';

C01 CURSOR FOR 
	SELECT	a.ds_titulo_laudo, 
		a.dt_exame, 
		a.ie_normal, 
		a.nr_sequencia, 
		b.cd_tipo_procedimento, 
		ds_laudo ds_laudo, 
		substr(Obter_nr_acesso_dicom(a.nr_prescricao, a.nr_seq_prescricao, a.nr_seq_proc),1,20) nr_acesso_dicom, 
		nr_seq_prescricao, 
		obter_seq_interno_prescr(a.nr_prescricao, a.nr_seq_prescricao, a.nr_seq_proc) nr_seq_interno_prescr, 
		a.nr_prescricao 
	FROM	laudo_paciente a, 
		procedimento b, 
		procedimento_paciente c 
	WHERE a.nr_seq_proc = c.nr_sequencia 
	AND	c.cd_procedimento = b.cd_procedimento 
	AND	c.ie_origem_proced = b.ie_origem_proced 
	and	coalesce(a.DT_CANCELAMENTO::text, '') = '' 
	AND	((ie_tipo_busca_w = 'A' and a.nr_atendimento = nr_atendimento_p) or (ie_tipo_busca_w = 'P' and a.cd_pessoa_fisica = cd_pessoa_fisica_p))	 
	AND	((coalesce(qt_dias_busca_w::text, '') = '') or (dt_exame BETWEEN dt_inicial_w AND dt_final_w)) 
	and	 ((ie_restringir_tipo_atend_w = 'N') or (obter_tipo_atendimento(a.nr_atendimento) = ie_tipo_atendimento_w)) 
	and	((coalesce(qt_consultas_w::text, '') = '') or (a.nr_atendimento in (ds_lista_atendimentos_w))) 
	ORDER BY dt_exame DESC;

 
BEGIN 
 
Select 	coalesce(max(a.ie_formato_busca),'A'), 
		max(a.qt_dias_busca), 
		max(a.qt_consultas), 
		coalesce(max(a.ie_restringir_tipo_atend),'N') 
into STRICT	ie_tipo_busca_w, 
		qt_dias_busca_w, 
		qt_consultas_w, 
		ie_restringir_tipo_atend_w 
from	item_suep a, 
		suep b	 
where	a.nr_seq_suep = b.nr_sequencia 
and		a.ie_tipo_item = 'EN' 
and		b.nr_sequencia = nr_seq_suep_p;
 
if ( ie_restringir_tipo_atend_w = 'S') then 
 
	Select 	max(ie_tipo_atendimento) 
	into STRICT	ie_tipo_atendimento_w 
	from 	atendimento_paciente 
	where 	nr_Atendimento = nr_atendimento_p;
 
end if;
 
if (qt_dias_busca_w > 0) then 
 
	Select 	trunc(clock_timestamp() - qt_dias_busca_w) 
	into STRICT	dt_inicial_w 
	;
	 
	 
elsif (qt_consultas_w > 0) then	 
 
  Select 	obter_lista_atend_suep(cd_pessoa_fisica_p,ie_tipo_atendimento_w,qt_consultas_w) 
	into STRICT	ds_lista_atendimentos_w 
	;
	 
end if;	
	 
dt_final_w	:= fim_dia(clock_timestamp());
 
for r_c01 in c01 loop 
	begin 
	t_laudo_row_w.ds_titulo_laudo			:= r_c01.ds_titulo_laudo;
	t_laudo_row_w.dt_exame				:= r_c01.dt_exame;
	t_laudo_row_w.ie_normal				:= r_c01.ie_normal;
	t_laudo_row_w.nr_sequencia			:= r_c01.nr_sequencia;
	t_laudo_row_w.cd_tipo_procedimento		:= r_c01.cd_tipo_procedimento;
	--t_laudo_row_w.ds_laudo				:= to_lob(r_c01.ds_laudo); 
	t_laudo_row_w.nr_acesso_dicom			:= r_c01.nr_acesso_dicom;
	t_laudo_row_w.nr_seq_prescricao			:= r_c01.nr_seq_prescricao;
	t_laudo_row_w.nr_seq_interno_prescr		:= r_c01.nr_seq_interno_prescr;
	t_laudo_row_w.nr_prescricao			:= r_c01.nr_prescricao;
	 
	RETURN NEXT t_laudo_row_w;
	 
	end;
end loop;
 
 
 
return;
 
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION suep_pck.obter_laudos ( cd_pessoa_fisica_p text, nr_atendimento_p bigint, nr_seq_suep_p bigint, nm_usuario_p text ) FROM PUBLIC;
