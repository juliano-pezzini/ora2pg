-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION suep_pck.obter_perda_ganho ( cd_pessoa_fisica_p text, nr_atendimento_p bigint, nr_seq_suep_p bigint, nm_usuario_p text ) RETURNS SETOF T_PERDA_GANHO_ROW_DATA AS $body$
DECLARE

			 
t_perda_ganho_row_w	t_perda_ganho_row;
dt_inicial_w		timestamp;
dt_final_w		timestamp;

C01 CURSOR FOR 
	SELECT trunc(coalesce(c.dt_referencia,c.dt_medida)) dt_medida,	 
		sum(CASE WHEN a.ie_perda_ganho='G' THEN  c.qt_volume  ELSE 0 END ) qt_ganho,	 
		sum(CASE WHEN a.ie_perda_ganho='P' THEN  c.qt_volume  ELSE 0 END ) qt_perda,	 
		sum(CASE WHEN a.ie_perda_ganho='G' THEN  c.qt_volume  ELSE 0 END  - CASE WHEN a.ie_perda_ganho='P' THEN  c.qt_volume  ELSE 0 END ) qt_diferenca,	 
		(obter_delta_peso(nr_atendimento_p,trunc(coalesce(c.dt_referencia,c.dt_medida)),'D'))::numeric  qt_delta_peso,	 
		(obter_delta_peso(nr_atendimento_p,trunc(coalesce(c.dt_referencia,c.dt_medida)),'P'))::numeric  qt_peso, 
		sum(qt_ocorrencia) qt_ocorrencia 
	from	tipo_perda_ganho b, 
		grupo_perda_ganho a, 
		atendimento_perda_ganho c 
	where 	c.nr_atendimento = nr_atendimento_p 
	and	b.nr_sequencia = c.nr_seq_tipo 
	and	b.nr_seq_grupo = a.nr_sequencia 
	and  	trunc(coalesce(c.dt_referencia,c.dt_medida)) between dt_inicial_w and dt_final_w 
	and  	coalesce(b.ie_soma_bh,'S') = 'S' 
	and  	coalesce(c.ie_situacao,'A') = 'A' 
	group by trunc(coalesce(c.dt_referencia,c.dt_medida)) 
	order by dt_medida desc;
	
BEGIN 
 
dt_inicial_w	:= trunc(clock_timestamp() - interval '7 days');
dt_final_w	:= fim_dia(clock_timestamp());
 
for r_c01 in c01 loop 
	begin 
	t_perda_ganho_row_w.dt_medida			:= r_c01.dt_medida;
	t_perda_ganho_row_w.qt_ganho			:= r_c01.qt_ganho;
	t_perda_ganho_row_w.qt_perda			:= r_c01.qt_perda;
	t_perda_ganho_row_w.qt_diferenca		:= r_c01.qt_diferenca;
	t_perda_ganho_row_w.qt_delta_peso		:= r_c01.qt_delta_peso;
	t_perda_ganho_row_w.qt_peso			:= r_c01.qt_peso;
	t_perda_ganho_row_w.qt_ocorrencia		:= r_c01.qt_ocorrencia;
	RETURN NEXT t_perda_ganho_row_w;
	 
	end;
end loop;
 
return;
 
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION suep_pck.obter_perda_ganho ( cd_pessoa_fisica_p text, nr_atendimento_p bigint, nr_seq_suep_p bigint, nm_usuario_p text ) FROM PUBLIC;
