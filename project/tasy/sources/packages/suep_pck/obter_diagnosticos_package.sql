-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION suep_pck.obter_diagnosticos ( cd_pessoa_fisica_p text, nr_atendimento_p bigint, nr_seq_suep_p bigint, nm_usuario_p text) RETURNS SETOF T_DIAGNOSTICO_ROW_DATA AS $body$
DECLARE

			 
t_diagnostico_row_w			t_diagnostico_row;
C01 CURSOR FOR
	SELECT	a.cd_doenca, 
		b.ds_doenca_cid, 
		a.dt_diagnostico, 
		substr(obter_valor_dominio(58,ie_classificacao_doenca),1,255) ds_classif_diag, 
		substr(obter_valor_dominio(13,ie_tipo_diagnostico),1,255) ds_tipo_diag 
	from	diagnostico_doenca a, 
		cid_doenca b 
	where	a.cd_doenca = b.cd_doenca_cid 
	and	coalesce(a.ie_situacao,'N') = 'A' 
	and	a.nr_atendimento = nr_atendimento_p 
	and	obter_se_exibe_cid_suep(a.nr_atendimento, a.cd_doenca, a.dt_diagnostico, nr_seq_suep_p,'N',a.ie_classificacao_doenca,a.ie_tipo_diagnostico) = 'S' 
	and	(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '') 
	order by a.dt_diagnostico desc;
BEGIN
 
for r_c01 in c01 loop 
	begin 
	 
	t_diagnostico_row_w.cd_doenca		:= r_c01.cd_doenca;
	t_diagnostico_row_w.ds_doenca_cid	:= r_c01.ds_doenca_cid;
	t_diagnostico_row_w.ds_classif_diag	:= r_c01.ds_classif_diag;
	t_diagnostico_row_w.ds_tipo_diag	:= r_c01.ds_tipo_diag;
	t_diagnostico_row_w.dt_diagnostico	:= r_c01.dt_diagnostico;
	RETURN NEXT t_diagnostico_row_w;
	end;
end loop;
 
return;
 
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION suep_pck.obter_diagnosticos ( cd_pessoa_fisica_p text, nr_atendimento_p bigint, nr_seq_suep_p bigint, nm_usuario_p text) FROM PUBLIC;
