-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION suep_pck.obter_metacuidado ( cd_pessoa_fisica_p text, nr_atendimento_p bigint, nr_seq_suep_p bigint, nm_usuario_p text) RETURNS SETOF T_METACUIDADO_ROW_DATA AS $body$
DECLARE

					 
ds_espaco_w				varchar(255) := chr(38)||'nbsp;'||chr(38)||'nbsp;'||chr(38)||'nbsp;';
qt_reg_w				bigint := 0;
qt_regra_w				bigint := 0;
t_metacuidado_row_w			t_metacuidado_row;

C01 CURSOR FOR 
	 SELECT	a.nr_seq_meta nr_seq_meta,  
		max(c.ds_meta) ds_meta,  
		max(a.nr_sequencia) nr_sequencia,  
		max(a.ie_status) ie_status,  
		max(a.dt_inicio) dt_inicio, 
		max(c.nr_sequencia) nr_seq_meta_tof 
	from 	tof_meta_atend a,  
		tof_meta_atend_hor b,  
		tof_meta c  
	where  a.nr_sequencia = b.nr_seq_meta_atend  
	and   Obter_se_meta_liberada(a.nr_atendimento,a.nr_seq_meta) = 'S' 
	and   a.nr_seq_meta = c.nr_sequencia  
	and   c.ie_tipo_meta = 'D'  
	and	a.nr_atendimento = nr_atendimento_p 
	group by a.nr_seq_meta 
	order by ds_meta;
	
C02 CURSOR FOR 
	 SELECT  a.nr_seq_meta nr_seq_meta,  
	    max(c.ds_meta) ds_meta,  
	    max(a.nr_sequencia) nr_sequencia  
	from 	tof_meta_atend a,  
	    tof_meta_atend_hor b,  
	    tof_meta c  
	where  a.nr_sequencia = b.nr_seq_meta_atend  
	and   Obter_se_meta_liberada(a.nr_atendimento,a.nr_seq_meta) = 'S' 
	and   a.nr_seq_meta = c.nr_sequencia  
	and   c.ie_tipo_meta = 'U'  
	and	a.nr_atendimento = nr_atendimento_p 
	group by a.nr_seq_meta 
	order by ds_meta;
	
BEGIN 
 
qt_reg_w	:= 0;
 
select 	count(*) 
into STRICT	qt_regra_w 
from	item_suep a, 
	informacao_suep b 
where 	a.nr_seq_suep = nr_seq_suep_p 
and  	a.nr_sequencia = b.NR_SEQ_ITEM 
and  	a.IE_TIPO_ITEM = 'MC' 
and  	b.IE_TIPO_META = 'R';
 
if (qt_regra_w	> 0) then 
 
	for r_c01 in c01 loop 
		begin 
		if (qt_reg_w	= 0) then 
 
			t_metacuidado_row_w.ds_meta		:= '<b>'||obter_desc_expressao(297359)||'</b>';
			t_metacuidado_row_w.ie_meta		:= 'D';
			t_metacuidado_row_w.ie_valor		:= 'T';
			RETURN NEXT t_metacuidado_row_w;
		end if;
		 
		t_metacuidado_row_w.ds_meta		:= ds_espaco_w|| r_c01.ds_meta;
		t_metacuidado_row_w.ie_meta		:= 'D';
		t_metacuidado_row_w.ie_valor		:= 'D';
		t_metacuidado_row_w.dt_inicio		:= r_c01.dt_inicio;
		t_metacuidado_row_w.nr_seq_meta		:= r_c01.nr_seq_meta;
		t_metacuidado_row_w.nr_sequencia	:= r_c01.nr_sequencia;
		t_metacuidado_row_w.ie_status_geral 	:= r_c01.ie_status;
		t_metacuidado_row_w.ie_status_hoje	:= suep_pck.getstatusdia(nr_atendimento_p, r_c01.nr_seq_meta_tof,0);
		t_metacuidado_row_w.ie_status_1		:= suep_pck.getstatusdia(nr_atendimento_p, r_c01.nr_seq_meta_tof,1);
		t_metacuidado_row_w.ie_status_2		:= suep_pck.getstatusdia(nr_atendimento_p, r_c01.nr_seq_meta_tof,2);
		t_metacuidado_row_w.ie_status_3		:= suep_pck.getstatusdia(nr_atendimento_p, r_c01.nr_seq_meta_tof,3);
		t_metacuidado_row_w.ie_status_4		:= suep_pck.getstatusdia(nr_atendimento_p, r_c01.nr_seq_meta_tof,4);
		t_metacuidado_row_w.ie_status_5		:= suep_pck.getstatusdia(nr_atendimento_p, r_c01.nr_seq_meta_tof,5);
		t_metacuidado_row_w.ie_status_6		:= suep_pck.getstatusdia(nr_atendimento_p, r_c01.nr_seq_meta_tof,6);
		t_metacuidado_row_w.ie_status_7		:= suep_pck.getstatusdia(nr_atendimento_p, r_c01.nr_seq_meta_tof,7);
		RETURN NEXT t_metacuidado_row_w;
		qt_reg_w	:= qt_reg_w+1;
		 
		end;
	end loop;
 
end if;
 
qt_reg_w	:= 0;
 
select 	count(*) 
into STRICT	qt_regra_w 
from	item_suep a, 
	informacao_suep b 
where 	a.nr_seq_suep = nr_seq_suep_p 
and  	a.nr_sequencia = b.NR_SEQ_ITEM 
and  	a.IE_TIPO_ITEM = 'MC' 
and  	b.IE_TIPO_META = 'U';
 
 
if (qt_regra_w	> 0) then 
 
	for r_c02 in c02 loop 
		begin 
		 
	if (qt_reg_w	= 0) then 
			t_metacuidado_row_w.ds_meta		:= '<b>'||obter_desc_expressao(303885)||'</b>';
			t_metacuidado_row_w.ie_meta		:= 'U';
			t_metacuidado_row_w.ie_valor		:= 'T';
			t_metacuidado_row_w.ie_status_geral	:= null;
			t_metacuidado_row_w.ie_status_hoje	:= null;
			t_metacuidado_row_w.ie_status_1		:= null;
			t_metacuidado_row_w.ie_status_2		:= null;
			t_metacuidado_row_w.ie_status_3		:= null;
			t_metacuidado_row_w.ie_status_4		:= null;
			t_metacuidado_row_w.ie_status_5		:= null;
			t_metacuidado_row_w.ie_status_6		:= null;
			t_metacuidado_row_w.ie_status_7		:= null;
			RETURN NEXT t_metacuidado_row_w;
		end if;
		 
		t_metacuidado_row_w.ds_meta		:= ds_espaco_w|| r_c02.ds_meta;
		t_metacuidado_row_w.ie_meta		:= 'U';
		t_metacuidado_row_w.ie_valor		:= 'D';
		t_metacuidado_row_w.ie_status_geral	:= suep_pck.getstatussingle(r_c02.nr_sequencia);
		t_metacuidado_row_w.nr_seq_meta		:= r_c02.nr_seq_meta;
		t_metacuidado_row_w.nr_sequencia	:= r_c02.nr_sequencia;
		t_metacuidado_row_w.ie_status_hoje	:= null;
		t_metacuidado_row_w.ie_status_1		:= null;
		t_metacuidado_row_w.ie_status_2		:= null;
		t_metacuidado_row_w.ie_status_3		:= null;
		t_metacuidado_row_w.ie_status_4		:= null;
		t_metacuidado_row_w.ie_status_5		:= null;
		t_metacuidado_row_w.ie_status_6		:= null;
		t_metacuidado_row_w.ie_status_7		:= null;
		 
		RETURN NEXT t_metacuidado_row_w;
		 
		qt_reg_w	:= qt_reg_w+1;
		end;
	end loop;
 
end if;
 
return;
 
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION suep_pck.obter_metacuidado ( cd_pessoa_fisica_p text, nr_atendimento_p bigint, nr_seq_suep_p bigint, nm_usuario_p text) FROM PUBLIC;
