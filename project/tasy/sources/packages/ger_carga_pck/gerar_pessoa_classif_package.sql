-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE ger_carga_pck.gerar_pessoa_classif ( reg_proc_p INOUT r_reg_proc, cd_pessoa_fisica_p text, ie_classif_p text, vl_classif_p text, nr_seq_regra_p bigint, ie_conversao_p text, nm_usuario_p text, dt_atualizacao_p timestamp) AS $body$
DECLARE


_ora2pg_r RECORD;
pessoa_classif_w	pessoa_classif%rowtype;

BEGIN
reg_proc_p.nm_tabela			:=	'PESSOA_CLASSIF';

if (vl_classif_p = 'X') then
	SELECT * FROM ger_carga_pck.proc_val(reg_proc_p, 'VIPKZ', 'NR_SEQ_CLASSIF', ie_classif_p, pessoa_classif_w.nr_seq_classif) INTO STRICT _ora2pg_r;
 reg_proc_p := _ora2pg_r.reg_proc_p; pessoa_classif_w.nr_seq_classif := _ora2pg_r.ds_valor_retorno_p;
else
	pessoa_classif_w.nr_seq_classif := intpd_conv('CLASSIF_PESSOA', 'NR_SEQUENCIA', ie_classif_p, nr_seq_regra_p, ie_conversao_p, 'I');
end if;


if (reg_proc_p.ie_tipo_proc = 'IMP') and (reg_proc_p.qt_reg_log = 0) then
	begin
	begin
	select	*
	into STRICT	pessoa_classif_w
	from	pessoa_classif
	where	cd_pessoa_fisica = cd_pessoa_fisica_p
	and	nr_seq_classif = pessoa_classif_w.nr_seq_classif
	and	coalesce(dt_final_vigencia::text, '') = ''
	and	dt_inicio_vigencia < clock_timestamp()  LIMIT 1;
	exception
	when others then
		pessoa_classif_w.nr_sequencia	:=	null;
	end;

	if (pessoa_classif_w.nr_sequencia IS NOT NULL AND pessoa_classif_w.nr_sequencia::text <> '') and (coalesce(vl_classif_p,'A') <> 'X') then
		begin
		pessoa_classif_w.dt_final_vigencia	:=	clock_timestamp();
		pessoa_classif_w.nm_usuario		:=	nm_usuario_p;
		pessoa_classif_w.dt_atualizacao	:=	dt_atualizacao_p;

		update	pessoa_classif
		set	row = pessoa_classif_w
		where	nr_sequencia = pessoa_classif_w.nr_sequencia;
		end;
	elsif (coalesce(pessoa_classif_w.nr_sequencia::text, '') = '') and (coalesce(vl_classif_p,'A') = 'X') then
		begin
		select	nextval('pessoa_classif_seq')
		into STRICT	pessoa_classif_w.nr_sequencia
		;

		pessoa_classif_w.cd_pessoa_fisica	:=	cd_pessoa_fisica_p;
		pessoa_classif_w.dt_inicio_vigencia	:=	clock_timestamp();
		pessoa_classif_w.dt_final_vigencia	:=	null;
		pessoa_classif_w.nm_usuario		:=	nm_usuario_p;
		pessoa_classif_w.dt_atualizacao	:=	dt_atualizacao_p;
		pessoa_classif_w.nm_usuario_nrec	:=	nm_usuario_p;
		pessoa_classif_w.dt_atualizacao_nrec	:=	dt_atualizacao_p;
		--ger_carga_pck.proc_val(reg_proc_p, 'NR_SEQ_CLASSIF', ie_classif_p, pessoa_classif_w.nr_seq_classif);
		insert into pessoa_classif values (pessoa_classif_w.*);
		end;
	end if;
	end;
end if;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ger_carga_pck.gerar_pessoa_classif ( reg_proc_p INOUT r_reg_proc, cd_pessoa_fisica_p text, ie_classif_p text, vl_classif_p text, nr_seq_regra_p bigint, ie_conversao_p text, nm_usuario_p text, dt_atualizacao_p timestamp) FROM PUBLIC;
