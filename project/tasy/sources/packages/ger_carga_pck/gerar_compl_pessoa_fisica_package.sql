-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE ger_carga_pck.gerar_compl_pessoa_fisica ( reg_proc_p INOUT r_reg_proc, cd_pessoa_fisica_p text, ie_tipo_complemento_p bigint, nr_seq_tipo_compl_adic_p bigint, ds_profissao_p text, cd_empresa_refer_p text, nm_contato_p text, nr_telefone_p text, nr_ramal_p text, ds_fax_p text, nr_ddd_fax_p text, nr_seq_pais_p text, sg_estado_p text, cd_cep_p text, ds_municipio_p text, ds_bairro_p text, ds_endereco_p text, nr_endereco_p text, ds_complemento_p text, ds_email_p text, ds_fonetica_p text, ds_compl_p text, nr_seq_parentesco_p text, cd_pessoa_fisica_ref_p text, nm_usuario_p text, nr_sequencia_p text default null, ds_tipo_p text default null, ie_resp_legal_p text default null, institution_p text default null) AS $body$
DECLARE


_ora2pg_r RECORD;
compl_pessoa_fisica_w		compl_pessoa_fisica%rowtype;
nr_sequencia_w			compl_pessoa_fisica.nr_sequencia%type;
profissao_w			profissao%rowtype;
ds_conversao_p			varchar(255);
ds_fone_adic_w			varchar(30);
cd_empresa_refer_w		varchar(255);
cd_cgc_w			compl_pessoa_fisica.cd_cgc%type;


BEGIN
reg_proc_p.nm_tabela	:=	'COMPL_PESSOA_FISICA';

begin

select	*
into STRICT	compl_pessoa_fisica_w
from	compl_pessoa_fisica
where	cd_pessoa_fisica = cd_pessoa_fisica_p
and	nr_sequencia = nr_sequencia_p;
exception
when others then
	begin
	select	*
	into STRICT	compl_pessoa_fisica_w
	from	compl_pessoa_fisica
	where	cd_pessoa_fisica = cd_pessoa_fisica_p
	and	ie_tipo_complemento = ie_tipo_complemento_p
	and	((nr_seq_tipo_compl_adic = nr_seq_tipo_compl_adic_p) or (
		coalesce(nr_seq_tipo_compl_adic::text, '') = '' and coalesce(nr_seq_tipo_compl_adic_p::text, '') = ''))  LIMIT 1;
	exception
	when others then
		compl_pessoa_fisica_w.nr_sequencia	:=	null;
	end;
end;

nr_sequencia_w					:=	compl_pessoa_fisica_w.nr_sequencia;

if (ds_tipo_p <> 'TEL') then
	compl_pessoa_fisica_w				:=	null;
end if;

compl_pessoa_fisica_w.nr_sequencia		:=	nr_sequencia_w;
compl_pessoa_fisica_w.cd_pessoa_fisica		:=	cd_pessoa_fisica_p;
compl_pessoa_fisica_w.ie_tipo_complemento	:=	ie_tipo_complemento_p;
compl_pessoa_fisica_w.nr_seq_tipo_compl_adic	:=	nr_seq_tipo_compl_adic_p;

if (length(trim(both ds_profissao_p)) > 0) then
	begin
	select	cd_profissao
	into STRICT	compl_pessoa_fisica_w.cd_profissao
	from	profissao
	where	upper(ds_profissao) like upper(ds_profissao_p)  LIMIT 1;
	exception
	when others then
		begin
		profissao_w.ds_profissao		:=	ds_profissao_p;
		profissao_w.ie_situacao			:=	'A';
		profissao_w.dt_atualizacao		:=	clock_timestamp();
		profissao_w.nm_usuario			:=	reg_proc_p.usernametasy;
		profissao_w.dt_atualizacao_nrec		:=	clock_timestamp();
		profissao_w.nm_usuario_nrec		:=	reg_proc_p.usernametasy;

		SELECT * FROM ger_carga_pck.gerar_profissao(reg_proc_p, profissao_w) INTO STRICT _ora2pg_r;
 reg_proc_p := _ora2pg_r.reg_proc_p; profissao_w := _ora2pg_r.profissao_p;

		compl_pessoa_fisica_w.cd_profissao	:=	profissao_w.cd_profissao;
		end;
	end;
end if;

begin
cd_empresa_refer_w	:=	ltrim(cd_empresa_refer_p,'0');
exception
when others then
	cd_empresa_refer_w := 0;
end;

begin
select	a.cd_cgc
into STRICT	cd_cgc_w
from	pessoa_juridica a
where	ltrim(a.cd_cgc,'0') = cd_empresa_refer_w  LIMIT 1;
exception
when others then
	cd_cgc_w := null;
end;

if (coalesce(cd_empresa_refer_w,0) > 0) and (coalesce(cd_cgc_w::text, '') = '') then
	null;
	/*ger_carga_pck.incluir_ger_carga_log_import(	reg_proc_p,'9',
						substr(	wheb_mensagem_pck.get_texto(736986,
							'DS_ELEMENTO=IMPNPAT' ||
							';DS_ATRIBUTO=AGNUM'||
							';NR_SEQ_REGRA='|| reg_proc_p.nr_seq_regra_conv ||
							';NM_TABELA=PESSOA_JURIDICA' ||
							';NM_ATRIBUTO=CD_CGC' ||
							';DS_VALOR='|| cd_empresa_refer_w),1,4000));*/
else
	SELECT * FROM ger_carga_pck.proc_val(reg_proc_p, null, 'CD_CGC', cd_cgc_w, compl_pessoa_fisica_w.cd_cgc) INTO STRICT _ora2pg_r;
 reg_proc_p := _ora2pg_r.reg_proc_p; compl_pessoa_fisica_w.cd_cgc := _ora2pg_r.ds_valor_retorno_p;
end if;
SELECT * FROM ger_carga_pck.proc_val(reg_proc_p, null, 'NM_CONTATO', nm_contato_p, compl_pessoa_fisica_w.nm_contato) INTO STRICT _ora2pg_r;
 reg_proc_p := _ora2pg_r.reg_proc_p; compl_pessoa_fisica_w.nm_contato := _ora2pg_r.ds_valor_retorno_p;
SELECT * FROM ger_carga_pck.proc_val(reg_proc_p, 'TELNR', 'DS_FONE_ADIC', substr(nr_telefone_p,1,30), compl_pessoa_fisica_w.ds_fone_adic) INTO STRICT _ora2pg_r;
 reg_proc_p := _ora2pg_r.reg_proc_p; compl_pessoa_fisica_w.ds_fone_adic := _ora2pg_r.ds_valor_retorno_p;
SELECT * FROM ger_carga_pck.proc_val(reg_proc_p, 'TELXT', 'NR_RAMAL', nr_ramal_p, compl_pessoa_fisica_w.nr_ramal) INTO STRICT _ora2pg_r;
 reg_proc_p := _ora2pg_r.reg_proc_p; compl_pessoa_fisica_w.nr_ramal := _ora2pg_r.ds_valor_retorno_p;
SELECT * FROM ger_carga_pck.proc_val(reg_proc_p, 'FAXNR', 'DS_FAX', ds_fax_p, compl_pessoa_fisica_w.ds_fax) INTO STRICT _ora2pg_r;
 reg_proc_p := _ora2pg_r.reg_proc_p; compl_pessoa_fisica_w.ds_fax := _ora2pg_r.ds_valor_retorno_p;
SELECT * FROM ger_carga_pck.proc_val(reg_proc_p, 'FAXXT', 'NR_DDD_FAX', nr_ddd_fax_p, compl_pessoa_fisica_w.nr_ddd_fax) INTO STRICT _ora2pg_r;
 reg_proc_p := _ora2pg_r.reg_proc_p; compl_pessoa_fisica_w.nr_ddd_fax := _ora2pg_r.ds_valor_retorno_p;
SELECT * FROM ger_carga_pck.proc_val(reg_proc_p, 'LAND', 'NR_SEQ_PAIS', nr_seq_pais_p, compl_pessoa_fisica_w.nr_seq_pais) INTO STRICT _ora2pg_r;
 reg_proc_p := _ora2pg_r.reg_proc_p; compl_pessoa_fisica_w.nr_seq_pais := _ora2pg_r.ds_valor_retorno_p;
SELECT * FROM ger_carga_pck.proc_val(reg_proc_p, 'REGIO', 'SG_ESTADO', sg_estado_p, compl_pessoa_fisica_w.sg_estado) INTO STRICT _ora2pg_r;
 reg_proc_p := _ora2pg_r.reg_proc_p; compl_pessoa_fisica_w.sg_estado := _ora2pg_r.ds_valor_retorno_p;
SELECT * FROM ger_carga_pck.proc_val(reg_proc_p, 'PSTLZ', 'CD_CEP', cd_cep_p, compl_pessoa_fisica_w.cd_cep) INTO STRICT _ora2pg_r;
 reg_proc_p := _ora2pg_r.reg_proc_p; compl_pessoa_fisica_w.cd_cep := _ora2pg_r.ds_valor_retorno_p;
SELECT * FROM ger_carga_pck.proc_val(reg_proc_p, 'STORT', 'DS_MUNICIPIO', ds_municipio_p, compl_pessoa_fisica_w.ds_municipio) INTO STRICT _ora2pg_r;
 reg_proc_p := _ora2pg_r.reg_proc_p; compl_pessoa_fisica_w.ds_municipio := _ora2pg_r.ds_valor_retorno_p;
SELECT * FROM ger_carga_pck.proc_val(reg_proc_p, 'ORT2', 'DS_BAIRRO', ds_bairro_p, compl_pessoa_fisica_w.ds_bairro) INTO STRICT _ora2pg_r;
 reg_proc_p := _ora2pg_r.reg_proc_p; compl_pessoa_fisica_w.ds_bairro := _ora2pg_r.ds_valor_retorno_p;
SELECT * FROM ger_carga_pck.proc_val(reg_proc_p, 'STRAS', 'DS_ENDERECO', ds_endereco_p, compl_pessoa_fisica_w.ds_endereco) INTO STRICT _ora2pg_r;
 reg_proc_p := _ora2pg_r.reg_proc_p; compl_pessoa_fisica_w.ds_endereco := _ora2pg_r.ds_valor_retorno_p;
SELECT * FROM ger_carga_pck.proc_val(reg_proc_p, 'HSNM1', 'DS_COMPL_END', nr_endereco_p, compl_pessoa_fisica_w.ds_compl_end) INTO STRICT _ora2pg_r;
 reg_proc_p := _ora2pg_r.reg_proc_p; compl_pessoa_fisica_w.ds_compl_end := _ora2pg_r.ds_valor_retorno_p;
SELECT * FROM ger_carga_pck.proc_val(reg_proc_p, 'STR_SUPPL', 'DS_COMPLEMENTO', ds_complemento_p, compl_pessoa_fisica_w.ds_complemento) INTO STRICT _ora2pg_r;
 reg_proc_p := _ora2pg_r.reg_proc_p; compl_pessoa_fisica_w.ds_complemento := _ora2pg_r.ds_valor_retorno_p;
SELECT * FROM ger_carga_pck.proc_val(reg_proc_p, 'EMAIL', 'DS_EMAIL', ds_email_p, compl_pessoa_fisica_w.ds_email) INTO STRICT _ora2pg_r;
 reg_proc_p := _ora2pg_r.reg_proc_p; compl_pessoa_fisica_w.ds_email := _ora2pg_r.ds_valor_retorno_p;
SELECT * FROM ger_carga_pck.proc_val(reg_proc_p, null, 'NM_USUARIO', nm_usuario_p, compl_pessoa_fisica_w.nm_usuario) INTO STRICT _ora2pg_r;
 reg_proc_p := _ora2pg_r.reg_proc_p; compl_pessoa_fisica_w.nm_usuario := _ora2pg_r.ds_valor_retorno_p;
SELECT * FROM ger_carga_pck.proc_val(reg_proc_p, null, 'DS_FONETICA', ds_fonetica_p, compl_pessoa_fisica_w.ds_fonetica) INTO STRICT _ora2pg_r;
 reg_proc_p := _ora2pg_r.reg_proc_p; compl_pessoa_fisica_w.ds_fonetica := _ora2pg_r.ds_valor_retorno_p;
SELECT * FROM ger_carga_pck.proc_val(reg_proc_p, null, 'DS_COMPLEMENTO', ds_compl_p, compl_pessoa_fisica_w.ds_complemento) INTO STRICT _ora2pg_r;
 reg_proc_p := _ora2pg_r.reg_proc_p; compl_pessoa_fisica_w.ds_complemento := _ora2pg_r.ds_valor_retorno_p;
SELECT * FROM ger_carga_pck.proc_val(reg_proc_p, null, 'NR_SEQ_PARENTESCO', nr_seq_parentesco_p, compl_pessoa_fisica_w.nr_seq_parentesco) INTO STRICT _ora2pg_r;
 reg_proc_p := _ora2pg_r.reg_proc_p; compl_pessoa_fisica_w.nr_seq_parentesco := _ora2pg_r.ds_valor_retorno_p;
SELECT * FROM ger_carga_pck.proc_val(reg_proc_p, null, 'CD_PESSOA_FISICA_REF', cd_pessoa_fisica_ref_p, compl_pessoa_fisica_w.cd_pessoa_fisica_ref) INTO STRICT _ora2pg_r;
 reg_proc_p := _ora2pg_r.reg_proc_p; compl_pessoa_fisica_w.cd_pessoa_fisica_ref := _ora2pg_r.ds_valor_retorno_p;
SELECT * FROM ger_carga_pck.proc_val(reg_proc_p, null, 'IE_RESP_LEGAL', ie_resp_legal_p, compl_pessoa_fisica_w.ie_resp_legal) INTO STRICT _ora2pg_r;
 reg_proc_p := _ora2pg_r.reg_proc_p; compl_pessoa_fisica_w.ie_resp_legal := _ora2pg_r.ds_valor_retorno_p;


if (reg_proc_p.ie_tipo_proc = 'IMP') and (reg_proc_p.qt_reg_log = 0) and (compl_pessoa_fisica_w.ie_tipo_complemento IS NOT NULL AND compl_pessoa_fisica_w.ie_tipo_complemento::text <> '') then
	begin
	compl_pessoa_fisica_w.dt_atualizacao	:=	clock_timestamp();
	compl_pessoa_fisica_w.nm_usuario	:=	reg_proc_p.usernametasy;

	if (coalesce(compl_pessoa_fisica_w.nr_sequencia::text, '') = '') then
		begin

		select	coalesce(max(nr_sequencia),0) + 1
		into STRICT	compl_pessoa_fisica_w.nr_sequencia
		from	compl_pessoa_fisica
		where	cd_pessoa_fisica = cd_pessoa_fisica_p;

		insert into compl_pessoa_fisica values (compl_pessoa_fisica_w.*);

		end;
	else
		update	compl_pessoa_fisica
		set	row = compl_pessoa_fisica_w
		where	cd_pessoa_fisica = cd_pessoa_fisica_p
		and	nr_sequencia = compl_pessoa_fisica_w.nr_sequencia
		and	current_setting('ger_carga_pck.ie_atualizar_w')::varchar(1) = 'S';
	end if;
	end;
end if;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ger_carga_pck.gerar_compl_pessoa_fisica ( reg_proc_p INOUT r_reg_proc, cd_pessoa_fisica_p text, ie_tipo_complemento_p bigint, nr_seq_tipo_compl_adic_p bigint, ds_profissao_p text, cd_empresa_refer_p text, nm_contato_p text, nr_telefone_p text, nr_ramal_p text, ds_fax_p text, nr_ddd_fax_p text, nr_seq_pais_p text, sg_estado_p text, cd_cep_p text, ds_municipio_p text, ds_bairro_p text, ds_endereco_p text, nr_endereco_p text, ds_complemento_p text, ds_email_p text, ds_fonetica_p text, ds_compl_p text, nr_seq_parentesco_p text, cd_pessoa_fisica_ref_p text, nm_usuario_p text, nr_sequencia_p text default null, ds_tipo_p text default null, ie_resp_legal_p text default null, institution_p text default null) FROM PUBLIC;
