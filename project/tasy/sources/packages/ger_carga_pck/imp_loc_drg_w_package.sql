-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE ger_carga_pck.imp_loc_drg_w ( nr_seq_carga_p ger_carga_inicial.nr_sequencia%type, nr_seq_carga_arq_p ger_carga_arq.nr_sequencia%type, nr_sequencia_p bigint default null, dt_inicio_vigencia_p timestamp default null, dt_fim_vigencia_p timestamp default null) AS $body$
DECLARE



	loc_drg_ww                      loc_drg_w%rowtype;
	qt_hauptabteilungen_w           bigint;
	imp_drg_belegabteilungen_w	imp_drg_belegabteilungen%rowtype;
	seq_hauptabteilungen_w          imp_drg_hauptabteilungen.nr_sequencia%type;
	seq_belegabteilungen_w	        imp_drg_belegabteilungen_w.nr_sequencia%type;

	c_hauptabteilungen CURSOR FOR
	SELECT      *
	from        imp_drg_hauptabteilungen
	where       ie_status	= 'V'
	and         nr_seq_carga = nr_seq_carga_p
	order by    nr_linha;

	
BEGIN

	delete from loc_drg_w;

	begin
	for 	row_hauptabteilungen in c_hauptabteilungen loop

		if (ie_tipo_proc_p = 'IMP')then
			select 	count(*)
			into STRICT   	qt_hauptabteilungen_w
			from   	imp_drg_hauptabteilungen
			where  	field_1 = row_hauptabteilungen.field_1;

			select  nextval('loc_drg_w_seq')
			into STRICT    seq_hauptabteilungen_w
			;

			if (qt_hauptabteilungen_w = 0 or current_setting('ger_carga_pck.ie_atualizar_w')::varchar(1) = 'N')then

				if (coalesce(row_hauptabteilungen.field_2::text, '') = '') then --Indica que e um registro de grupo
					begin
					select	cd_grupo_proc
					into STRICT	loc_drg_ww.cd_grupo_proc
					from	grupo_proc
					where	ds_grupo_proc 		= row_hauptabteilungen.field_1
					and	    ie_origem_proced	= 15  LIMIT 1;

					loc_drg_ww.ds_grupo_proc := substr(row_hauptabteilungen.field_1,1,240);

					exception
					when others then

					    select coalesce(max(cd_grupo_proc),0) + 1
					    into STRICT   loc_drg_ww.cd_grupo_proc
					    from   grupo_proc;

					    loc_drg_ww.ds_grupo_proc := substr(row_hauptabteilungen.field_1,1,240);

					end;
				else
					loc_drg_ww.cd_drg		        := row_hauptabteilungen.field_1;
					loc_drg_ww.ds_drg		        := row_hauptabteilungen.field_3;
					loc_drg_ww.ie_origem_proced	   	:= 15;
					loc_drg_ww.ie_tipo_drg		   	:= row_hauptabteilungen.field_2;
					loc_drg_ww.qt_estadia_min	   	:= row_hauptabteilungen.field_7;
					loc_drg_ww.qt_estadia_max	   	:= row_hauptabteilungen.field_9;
					loc_drg_ww.qt_estadia_media	   	:= row_hauptabteilungen.field_6;
					loc_drg_ww.tx_departamento	   	:= row_hauptabteilungen.field_4;
					loc_drg_ww.tx_estadia_min	   	:= row_hauptabteilungen.field_8;
					loc_drg_ww.tx_estadia_max	   	:= row_hauptabteilungen.field_10;
					loc_drg_ww.tx_transferencia	   	:= row_hauptabteilungen.field_11;
					loc_drg_ww.dt_inicio_vigencia		:= row_hauptabteilungen.start_date;
					loc_drg_ww.dt_final_vigencia		:= row_hauptabteilungen.end_date;
					loc_drg_ww.dt_atualizacao       	:= clock_timestamp();
					loc_drg_ww.nr_sequencia         	:= seq_hauptabteilungen_w;
					loc_drg_ww.nm_usuario           	:= 'LOAD_TASY';
					loc_drg_ww.nr_seq_carga         	:= nr_seq_carga_p;
					loc_drg_ww.nr_seq_carga_arq     	:= nr_seq_carga_arq_p;
					loc_drg_ww.nr_seq_hauptabteilungen	:= row_hauptabteilungen.nr_sequencia;

					begin
					select	*
					into STRICT	imp_drg_belegabteilungen_w
					from	imp_drg_belegabteilungen
					where	field_1	= row_hauptabteilungen.field_1
					and	(field_2 IS NOT NULL AND field_2::text <> '')  LIMIT 1;
					exception
					when others then
						imp_drg_belegabteilungen_w.field_1 := null;
					end;

					if (imp_drg_belegabteilungen_w.field_1 IS NOT NULL AND imp_drg_belegabteilungen_w.field_1::text <> '') then
						loc_drg_ww.tx_departamento_ter 		:= imp_drg_belegabteilungen_w.field_13;
						loc_drg_ww.tx_estadia_min_ter		:= imp_drg_belegabteilungen_w.field_10;
						loc_drg_ww.tx_estadia_max_ter		:= imp_drg_belegabteilungen_w.field_12;
						loc_drg_ww.dt_inicio_vigencia_ter	:= to_char(dt_inicio_vigencia_p,'dd/mm/yyyy');
						loc_drg_ww.dt_final_vigencia_ter	:= to_char(dt_fim_vigencia_p,'dd/mm/yyyy');

						if (coalesce(imp_drg_belegabteilungen_w.field_4::text, '') = '') and (coalesce(imp_drg_belegabteilungen_w.field_5::text, '') = '') and (coalesce(imp_drg_belegabteilungen_w.field_6::text, '') = '') and (coalesce(imp_drg_belegabteilungen_w.field_7::text, '') = '') then

							insert into loc_drg_w values (loc_drg_ww.*);

						else
							if (imp_drg_belegabteilungen_w.field_4 IS NOT NULL AND imp_drg_belegabteilungen_w.field_4::text <> '') then
								loc_drg_ww.ie_terceiro			:= 'X';
								loc_drg_ww.ie_cirurgiao			:= 'S';
								loc_drg_ww.ie_anestesista		:= 'N';
								loc_drg_ww.ie_assistente		:= 'N';
								loc_drg_ww.ie_terapeuta_ocupacional	:= 'N';
								loc_drg_ww.ie_parteira			:= 'N';
								loc_drg_ww.pr_funcao			:= imp_drg_belegabteilungen_w.field_4;

								insert into loc_drg_w values (loc_drg_ww.*);
							end if;

							if (imp_drg_belegabteilungen_w.field_5 IS NOT NULL AND imp_drg_belegabteilungen_w.field_5::text <> '') then
								loc_drg_ww.ie_terceiro			:= 'X';
								loc_drg_ww.ie_cirurgiao			:= 'N';
								loc_drg_ww.ie_anestesista		:= 'S';
								loc_drg_ww.ie_assistente		:= 'S';
								loc_drg_ww.ie_terapeuta_ocupacional 	:= 'N';
								loc_drg_ww.ie_parteira			:= 'N';
								loc_drg_ww.pr_funcao			:= imp_drg_belegabteilungen_w.field_5;

								insert into loc_drg_w values (loc_drg_ww.*);
							end if;

							if (imp_drg_belegabteilungen_w.field_6 IS NOT NULL AND imp_drg_belegabteilungen_w.field_6::text <> '') then
								loc_drg_ww.ie_terceiro			:= 'X';
								loc_drg_ww.ie_cirurgiao			:= 'N';
								loc_drg_ww.ie_anestesista		:= 'N';
								loc_drg_ww.ie_assistente		:= 'N';
								loc_drg_ww.ie_terapeuta_ocupacional	:= 'S';
								loc_drg_ww.ie_parteira			:= 'S';
								loc_drg_ww.pr_funcao			:= imp_drg_belegabteilungen_w.field_6;

								insert into loc_drg_w values (loc_drg_ww.*);
							end if;

							if (imp_drg_belegabteilungen_w.field_7 IS NOT NULL AND imp_drg_belegabteilungen_w.field_7::text <> '') then
								loc_drg_ww.ie_terceiro			:= 'X';
								loc_drg_ww.ie_cirurgiao			:= 'N';
								loc_drg_ww.ie_anestesista		:= 'S';
								loc_drg_ww.ie_assistente		:= 'N';
								loc_drg_ww.ie_terapeuta_ocupacional	:= 'S';
								loc_drg_ww.ie_parteira			:= 'S';
								loc_drg_ww.pr_funcao			:= imp_drg_belegabteilungen_w.field_7;

								insert into loc_drg_w values (loc_drg_ww.*);
							end if;
						end if;
					end if;
					insert into loc_drg_w values (loc_drg_ww.*);
				end if;
			else
				update  loc_drg_w
				set     ds_drg		        = row_hauptabteilungen.field_3,
					ie_origem_proced	= 15,
					ie_tipo_drg		= row_hauptabteilungen.field_2,
					qt_estadia_min	    	= row_hauptabteilungen.field_7,
					qt_estadia_max	    	= row_hauptabteilungen.field_9,
					qt_estadia_media	= row_hauptabteilungen.field_6,
					tx_departamento	    	= row_hauptabteilungen.field_4,
					tx_estadia_min	    	= row_hauptabteilungen.field_8,
					tx_estadia_max	    	= row_hauptabteilungen.field_10,
					tx_transferencia	= row_hauptabteilungen.field_11,
					dt_inicio_vigencia	= row_hauptabteilungen.start_date,
					dt_final_vigencia	= row_hauptabteilungen.end_date,
					nr_seq_hauptabteilungen	= row_hauptabteilungen.nr_sequencia
				where   cd_drg		        = row_hauptabteilungen.field_1;
			end if;
		end if;
	end loop;

	end;

	commit;

	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ger_carga_pck.imp_loc_drg_w ( nr_seq_carga_p ger_carga_inicial.nr_sequencia%type, nr_seq_carga_arq_p ger_carga_arq.nr_sequencia%type, nr_sequencia_p bigint default null, dt_inicio_vigencia_p timestamp default null, dt_fim_vigencia_p timestamp default null) FROM PUBLIC;
