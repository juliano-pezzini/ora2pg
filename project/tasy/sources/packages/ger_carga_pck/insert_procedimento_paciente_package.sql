-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE ger_carga_pck.insert_procedimento_paciente ( procedimento_paciente_p procedimento_paciente, nr_seq_proc_p INOUT bigint ) AS $body$
DECLARE

        procedimento_paciente_w   procedimento_paciente%rowtype;
        nr_sequencia_w            procedimento_paciente.nr_sequencia%TYPE;
        nr_seq_episodio_w         procedimento_pac_medico.nr_seq_episodio%TYPE;
        cd_setor_atendimento_w    procedimento_pac_medico.cd_setor_atendimento%TYPE;
        cd_departamento_w         procedimento_pac_medico.cd_departamento%TYPE;

BEGIN
        procedimento_paciente_w := procedimento_paciente_p;
        SELECT
            MAX(a.dt_entrada_unidade),
            MAX(a.cd_departamento),
            MAX(a.cd_setor_atendimento)
        INTO STRICT
            procedimento_paciente_w.dt_entrada_unidade,
            cd_departamento_w,
            cd_setor_atendimento_w
        FROM
            atend_paciente_unidade a
        WHERE
            nr_seq_interno = procedimento_paciente_w.nr_seq_atepacu;
        IF ( coalesce(cd_departamento_w::text, '') = '' ) THEN
            SELECT
                obter_departamento_setor(cd_setor_atendimento_w)
            INTO STRICT cd_departamento_w
;
        END IF;

        SELECT
            a.cd_cgc
        INTO STRICT procedimento_paciente_w.cd_cgc_prestador
        FROM
            estabelecimento        a,
            atendimento_paciente   b
        WHERE
            a.cd_estabelecimento = b.cd_estabelecimento
            AND b.nr_atendimento = procedimento_paciente_w.nr_atendimento;

        SELECT
            nr_seq_episodio
        INTO STRICT nr_seq_episodio_w
        FROM
            atendimento_paciente
        WHERE
            nr_atendimento = procedimento_paciente_w.nr_atendimento;

        SELECT
            nextval('procedimento_paciente_seq')
        INTO STRICT nr_sequencia_w
;

        procedimento_paciente_w.nr_sequencia := nr_sequencia_w;
        procedimento_paciente_w.ie_auditoria := 'N';
        procedimento_paciente_w.nr_seq_cor_exec := 96;
        procedimento_paciente_w.vl_procedimento := 0;
        procedimento_paciente_w.ie_proc_princ_atend := 'N';
        procedimento_paciente_w.ie_video := 'N';
        procedimento_paciente_w.tx_medico := 100;
        procedimento_paciente_w.tx_anestesia := 100;
        procedimento_paciente_w.tx_procedimento := 100;
        procedimento_paciente_w.ie_valor_informado := 'N';
        procedimento_paciente_w.ie_guia_informada := 'N';
        procedimento_paciente_w.cd_situacao_glosa := 0;
        INSERT INTO procedimento_paciente VALUES (procedimento_paciente_w.*);

        IF (procedimento_paciente_w.cd_convenio IS NOT NULL AND procedimento_paciente_w.cd_convenio::text <> '') THEN
            CALL atualiza_preco_procedimento(nr_sequencia_w, procedimento_paciente_w.cd_convenio, procedimento_paciente_w.nm_usuario);

		/*gerar_autor_regra( 	procedimento_paciente_w.nr_atendimento, null, nr_sequencia_w, null, null,
					procedimento_paciente_w.nr_seq_proc_interno, 'EP', procedimento_paciente_w.nm_usuario,
					null,null,null,null,null,null,'','','');*/
        END IF;

        INSERT INTO procedimento_pac_medico(
            nr_sequencia,
            dt_atualizacao,
            nm_usuario,
            dt_atualizacao_nrec,
            nm_usuario_nrec,
            nr_atendimento,
            ie_situacao,
            cd_procedimento,
            ie_origem_proced,
            qt_procedimento,
            nr_seq_episodio,
            ie_lado,
            ie_proc_princ,
            cd_departamento,
            cd_setor_atendimento,
            nr_seq_proc_interno,
            dt_procedimento,
            nr_seq_propaci,
            dt_liberacao
        ) VALUES (
            nextval('procedimento_pac_medico_seq'),
            procedimento_paciente_w.dt_atualizacao,
            procedimento_paciente_w.nm_usuario,
            procedimento_paciente_w.dt_atualizacao,
            procedimento_paciente_w.nm_usuario,
            procedimento_paciente_w.nr_atendimento,
            'A',
            procedimento_paciente_w.cd_procedimento,
            procedimento_paciente_w.ie_origem_proced,
            procedimento_paciente_w.qt_procedimento,
            nr_seq_episodio_w,
            procedimento_paciente_w.ie_lado,
            procedimento_paciente_w.ie_proc_princ_atend,
            cd_departamento_w,
            cd_setor_atendimento_w,
            procedimento_paciente_w.nr_seq_proc_interno,
            procedimento_paciente_w.dt_procedimento,
            nr_sequencia_w,
            clock_timestamp()
        );

        nr_seq_proc_p := nr_sequencia_w;
    END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ger_carga_pck.insert_procedimento_paciente ( procedimento_paciente_p procedimento_paciente, nr_seq_proc_p INOUT bigint ) FROM PUBLIC;
