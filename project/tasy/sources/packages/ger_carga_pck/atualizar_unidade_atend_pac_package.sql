-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE ger_carga_pck.atualizar_unidade_atend_pac (nr_seq_carga_p bigint) AS $body$
DECLARE



/*Busca todos os cases importados para o registro da carga.
Verifica se os atendimentos possuem movimentacoes sem data de saida
Se existir, entao atualiza o status da unidade do atendimento para 'P-Paciente' e grava o numero do atendimento.
*/
current_setting('ger_carga_pck.c01')::CURSOR CURSOR FOR
SELECT 	a.nr_atendimento,
	x.dt_entrada_unidade,
	x.cd_unidade_basica,
	x.cd_unidade_compl,
	x.cd_setor_atendimento
from 	impnfal b,
	atendimento_paciente a,
	atend_paciente_unidade x,
	unidade_atendimento y
where 	b.nr_seq_carga			= nr_seq_carga_p
and	a.nr_seq_episodio		= (b.ds_chave_tasy)::numeric
and 	x.nr_atendimento 		= a.nr_atendimento
and	coalesce(a.dt_alta::text, '') = ''
and 	a.ie_tipo_atendimento 		= '1'
and 	coalesce(x.dt_saida_unidade::text, '') = ''
and 	y.cd_unidade_basica 		= x.cd_unidade_basica
and 	y.cd_unidade_compl 		= x.cd_unidade_compl
and 	y.cd_setor_atendimento 		= x.cd_setor_atendimento
and 	y.ie_status_unidade 		<> 'P'
and	coalesce(x.ie_passagem_setor,'N') 	in ('N','L')
and 	obter_se_sem_acomodacao(y.cd_tipo_acomodacao) = 'N'
order by 1;

c01_w	current_setting('ger_carga_pck.c01')::CURSOR%rowtype;


BEGIN

open current_setting('ger_carga_pck.c01')::CURSOR;
loop
fetch current_setting('ger_carga_pck.c01')::into CURSOR
	c01_w;
EXIT WHEN NOT FOUND; /* apply on current_setting('ger_carga_pck.c01')::CURSOR */

	begin
	update	unidade_atendimento a
	set 	a.nr_atendimento      	= c01_w.nr_atendimento,
		a.dt_entrada_unidade  	= c01_w.dt_entrada_unidade,
		a.ie_status_unidade   	= 'P',
		a.nm_usuario		= 'LOAD_TASY',
		a.dt_atualizacao	= clock_timestamp()
	where 	a.cd_unidade_basica 	= c01_w.cd_unidade_basica
	and 	a.cd_unidade_compl  	= c01_w.cd_unidade_compl
	and 	a.cd_setor_atendimento 	= c01_w.cd_setor_atendimento;

	CALL Atualizar_Unidade_atendimento(	c01_w.cd_setor_atendimento,
					c01_w.cd_unidade_basica,
					c01_w.cd_unidade_compl);
	exception
	when others then
		null;
	end;

end loop;
close current_setting('ger_carga_pck.c01')::CURSOR;

commit;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ger_carga_pck.atualizar_unidade_atend_pac (nr_seq_carga_p bigint) FROM PUBLIC;
