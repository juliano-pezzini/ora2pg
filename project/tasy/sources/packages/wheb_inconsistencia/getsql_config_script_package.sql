-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION wheb_inconsistencia.getsql_config_script (nm_tabela_p text, nm_objeto_p text, ie_tipo_objeto_in_p text) RETURNS varchar AS $body$
DECLARE

    sql_w varchar(2000);

BEGIN
    sql_w := NULL;

    IF (nm_objeto_p IS NOT NULL AND nm_objeto_p::text <> '') THEN

      sql_w := ' (TAB.NM_TABELA = ' || WHEB_DB.QUOTED_STR(nm_tabela_p) ||
                ' AND TAB.IE_REGRA_TABELA = ' || WHEB_DB.QUOTED_STR(current_setting('wheb_inconsistencia.domain_tab_rule_inctable')::varchar(1)) ||
                ' AND TAB.NM_OBJETO = ' || WHEB_DB.QUOTED_STR(nm_objeto_p);

      IF (ie_tipo_objeto_in_p IS NOT NULL AND ie_tipo_objeto_in_p::text <> '') THEN
        sql_w := sql_w || ' AND TAB.IE_TIPO_OBJETO IN (' || ie_tipo_objeto_in_p || ')';
      END IF;

      sql_w := sql_w || ')';
    END IF;

    IF (sql_w IS NOT NULL AND sql_w::text <> '') THEN
      sql_w := sql_w || ' OR';
    END IF;

    sql_w := sql_w || ' (TAB.NM_TABELA = ' || WHEB_DB.QUOTED_STR(nm_tabela_p) ||
                       ' AND TAB.IE_REGRA_TABELA = ' || WHEB_DB.QUOTED_STR(current_setting('wheb_inconsistencia.domain_tab_rule_reftable')::varchar(1)) ||
                       ' AND TAB.NM_OBJETO IS NULL' ||
					   ' AND TAB.DT_LIBERACAO IS NOT NULL' ||
					   ' AND TAB.DT_INATIVACAO IS NULL' ||
                       ' AND TAB.IE_TIPO_OBJETO IN (' || ie_tipo_objeto_in_p || '))' ||
                   ' OR (TAB.NM_OBJETO IS NOT NULL' ||
                       ' AND TAB.IE_TIPO_OBJETO IN (' || ie_tipo_objeto_in_p || ')' ||
                       ' AND EXISTS (SELECT 1' ||
                                     ' FROM INTEGRIDADE_REFERENCIAL IR' ||
                                    ' WHERE IR.NM_INTEGRIDADE_REFERENCIAL = TAB.NM_OBJETO' ||
                                      ' AND IR.NM_TABELA_REFERENCIA = ' || WHEB_DB.QUOTED_STR(nm_tabela_p) || '))';

    IF coalesce(sql_w::text, '') = '' THEN
      RETURN ' FROM TASY_AJUSTE_BASE TAB WHERE 1 = 2' || sql_w;
    ELSE
      RETURN ' FROM TASY_AJUSTE_BASE TAB WHERE' || sql_w;
    END IF;
  END;


$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION wheb_inconsistencia.getsql_config_script (nm_tabela_p text, nm_objeto_p text, ie_tipo_objeto_in_p text) FROM PUBLIC;
