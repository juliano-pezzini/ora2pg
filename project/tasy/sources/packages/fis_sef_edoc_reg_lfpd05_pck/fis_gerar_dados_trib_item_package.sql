-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


/*Procedure que carrega os dados da tabela nota_fiscal_item  e  nota_fiscal_item_trib nos array global da pck*/

CREATE OR REPLACE PROCEDURE fis_sef_edoc_reg_lfpd05_pck.fis_gerar_dados_trib_item ( nr_seq_nota_p bigint, cd_natureza_operacao_p bigint, ie_entrada_saida_p text) AS $body$
DECLARE


nr_item_nf_old_w	nota_fiscal_item.nr_item_nf%type:= 0;

/*cursor para trazer os tributos dos itens da nota*/

c_trib_itens_nota CURSOR FOR
	SELECT	c.ie_tipo_tributo,
		a.nr_item_nf,
		--d.ie_tributacao_icms,
		coalesce(substr(obter_dados_situacao_trib(a.nr_seq_classif_trib,'CD'),2,3), substr(d.ie_tributacao_icms, 1, 2)) ie_tributacao_icms,
		d.ie_tributacao_ipi,
		coalesce(sum(b.vl_tributo),0) vl_tributo,
		coalesce(sum(b.vl_base_calculo),0) vl_base_calculo,
		coalesce(sum(b.tx_tributo),0) tx_tributo,
		coalesce(sum(a.vl_total_item_nf - a.vl_desconto),0) vl_item,
		max(substr(Elimina_Caracter(obter_dados_natureza_operacao(coalesce(a.cd_natureza_operacao, cd_natureza_operacao_p), 'CF'), '.'), 1, 4)) cd_cfop,
		coalesce((sum(n.vl_frete) + sum(n.vl_seguro) + sum(n.vl_despesa_acessoria) + sum(n.vl_ipi)) - sum(n.vl_descontos),0) vl_encargos
	FROM nota_fiscal n, nota_fiscal_item a
LEFT OUTER JOIN nota_fiscal_item_trib b ON (a.nr_item_nf = b.nr_item_nf AND a.nr_sequencia = b.nr_sequencia)
LEFT OUTER JOIN material_fiscal d ON (a.cd_material = d.cd_material)
LEFT OUTER JOIN tributo c ON (b.cd_tributo = c.cd_tributo)
WHERE n.nr_sequencia	= a.nr_sequencia     and a.nr_sequencia	= nr_seq_nota_p group by 	c.ie_tipo_tributo,
			a.nr_item_nf,
			--d.ie_tributacao_icms,
			coalesce(substr(obter_dados_situacao_trib(a.nr_seq_classif_trib,'CD'),2,3), substr(d.ie_tributacao_icms, 1, 2)),
			d.ie_tributacao_ipi
	order by	a.nr_item_nf;

/*Criação do array com o tipo sendo do cursor eespecificado - c_trib_itens_nota */

type reg_c_trib_itens_nota is table of c_trib_itens_nota%RowType;
vet_c_trib_itens_nota 		reg_c_trib_itens_nota;

BEGIN

current_setting('fis_sef_edoc_reg_lfpd05_pck.vet_tributos_itens_nota_w')::tributos_itens_nota.delete;

open c_trib_itens_nota;
loop
fetch c_trib_itens_nota bulk collect into vet_c_trib_itens_nota limit 1000;
	for i in 1..vet_c_trib_itens_nota.Count loop
		begin

		if i = 1 then
			vet_c_trib_itens_nota[i].vl_item := vet_c_trib_itens_nota[i].vl_item + vet_c_trib_itens_nota[i].vl_encargos;
		end if;

		/*Restrição para o tributo ICMS*/

		if (vet_c_trib_itens_nota[i].ie_tipo_tributo = 'ICMS') then
			begin

			if (vet_c_trib_itens_nota[i].ie_tributacao_icms in ('00', '10', '20', '70')) then
				begin
				current_setting('fis_sef_edoc_reg_lfpd05_pck.vet_tributos_itens_nota_w')::tributos_itens_nota[i].vl_icms		:=	vet_c_trib_itens_nota[i].vl_tributo;
				current_setting('fis_sef_edoc_reg_lfpd05_pck.vet_tributos_itens_nota_w')::tributos_itens_nota[i].vl_bc_icms	:=	vet_c_trib_itens_nota[i].vl_base_calculo;
				current_setting('fis_sef_edoc_reg_lfpd05_pck.vet_tributos_itens_nota_w')::tributos_itens_nota[i].tx_aliq_icms	:=	vet_c_trib_itens_nota[i].tx_tributo;
				end;
			end if;

			current_setting('fis_sef_edoc_reg_lfpd05_pck.vet_tributos_itens_nota_w')::tributos_itens_nota[i].ie_tributacao_icms	:=	vet_c_trib_itens_nota[i].ie_tributacao_icms;
			end;
		end if;

		if (vet_c_trib_itens_nota[i].ie_tributacao_icms in ('40', '41', '50', '51', '60')) then
			current_setting('fis_sef_edoc_reg_lfpd05_pck.vet_tributos_itens_nota_w')::tributos_itens_nota[i].vl_isnt_icms	:=	vet_c_trib_itens_nota[i].vl_item;
		elsif (vet_c_trib_itens_nota[i].ie_tributacao_icms = '90') then
			current_setting('fis_sef_edoc_reg_lfpd05_pck.vet_tributos_itens_nota_w')::tributos_itens_nota[i].vl_out_icms	:=	vet_c_trib_itens_nota[i].vl_item;
		end if;

		/*Restrição para o tributo ICMS*/

		if (vet_c_trib_itens_nota[i].ie_tipo_tributo = 'ICMSST') then
			begin
			current_setting('fis_sef_edoc_reg_lfpd05_pck.vet_tributos_itens_nota_w')::tributos_itens_nota[i].vl_icms_st		:=	vet_c_trib_itens_nota[i].vl_tributo;
			current_setting('fis_sef_edoc_reg_lfpd05_pck.vet_tributos_itens_nota_w')::tributos_itens_nota[i].vl_bc_st_p		:=	vet_c_trib_itens_nota[i].vl_base_calculo;

			if (vet_c_trib_itens_nota[i].ie_tributacao_icms in ('10', '30', '70')) then
				if (ie_entrada_saida_p = 'E') then
					current_setting('fis_sef_edoc_reg_lfpd05_pck.vet_tributos_itens_nota_w')::tributos_itens_nota[i].vl_st_e:= vet_c_trib_itens_nota[i].vl_tributo;
				elsif (ie_entrada_saida_p = 'S') then
					current_setting('fis_sef_edoc_reg_lfpd05_pck.vet_tributos_itens_nota_w')::tributos_itens_nota[i].vl_st_s:= vet_c_trib_itens_nota[i].vl_tributo;
				end if;
			end if;

			end;
		end if;

		/*Restrição para o tributo IPI*/

		if (vet_c_trib_itens_nota[i].ie_tipo_tributo = 'IPI') then
			begin
			if (vet_c_trib_itens_nota[i].ie_tributacao_ipi in ('00', '50')) then
				begin
				current_setting('fis_sef_edoc_reg_lfpd05_pck.vet_tributos_itens_nota_w')::tributos_itens_nota[i].vl_ipi		:=	vet_c_trib_itens_nota[i].vl_tributo;
				current_setting('fis_sef_edoc_reg_lfpd05_pck.vet_tributos_itens_nota_w')::tributos_itens_nota[i].vl_bc_ipi	:=	vet_c_trib_itens_nota[i].vl_base_calculo;
				end;
			/*elsif	(vet_c_trib_itens_nota(i).ie_tributacao_ipi not in ('00', '49', '50', '99')) then
				vet_tributos_itens_nota_w(i).vl_isnt_ipi	:=	vet_c_trib_itens_nota(i).vl_item;
			elsif	(vet_c_trib_itens_nota(i).ie_tributacao_ipi in ('49', '99')) then
				vet_tributos_itens_nota_w(i).vl_out_ipi	:=	vet_c_trib_itens_nota(i).vl_item;*/
			end if;

			current_setting('fis_sef_edoc_reg_lfpd05_pck.vet_tributos_itens_nota_w')::tributos_itens_nota[i].ie_tributacao_ipi	:=	vet_c_trib_itens_nota[i].ie_tributacao_ipi;
			end;
		end if;

		/*Esses itens só entre uma vez a cada item*/

		if (nr_item_nf_old_w <> vet_c_trib_itens_nota[i].nr_item_nf) then
			begin
			current_setting('fis_sef_edoc_reg_lfpd05_pck.vet_tributos_itens_nota_w')::tributos_itens_nota[i].vl_item			:=	vet_c_trib_itens_nota[i].vl_item;
			current_setting('fis_sef_edoc_reg_lfpd05_pck.vet_tributos_itens_nota_w')::tributos_itens_nota[i].nr_item_nf		:=	vet_c_trib_itens_nota[i].nr_item_nf;
			current_setting('fis_sef_edoc_reg_lfpd05_pck.vet_tributos_itens_nota_w')::tributos_itens_nota[i].cd_cfop			:=	vet_c_trib_itens_nota[i].cd_cfop;
			current_setting('fis_sef_edoc_reg_lfpd05_pck.vet_tributos_itens_nota_w')::tributos_itens_nota[i].nr_seq_nota		:=	nr_seq_nota_p;
			nr_item_nf_old_w 									:=	vet_c_trib_itens_nota[i].nr_item_nf;
			end;
		end if;

		end;
	end loop;
EXIT WHEN NOT FOUND; /* apply on c_trib_itens_nota */
end loop;
close c_trib_itens_nota;


commit;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE fis_sef_edoc_reg_lfpd05_pck.fis_gerar_dados_trib_item ( nr_seq_nota_p bigint, cd_natureza_operacao_p bigint, ie_entrada_saida_p text) FROM PUBLIC;
