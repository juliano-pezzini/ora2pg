-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


/*registro e105: itens do documento*/

CREATE OR REPLACE PROCEDURE fis_sef_edoc_reg_lfpd05_pck.fis_gerar_reg_e105_edoc ( nr_seq_superior_p bigint, nr_seq_nota_p bigint) AS $body$
DECLARE


nr_seq_fis_sef_edoc_e105_w	fis_sef_edoc_e105.nr_sequencia%type;

/*Cursor para trazer os tributos agrupados por cfop e aliquota*/

c_reg_e105 CURSOR FOR
	SELECT	sum(vl_item)		vl_cont_p,
		null			vl_op_iss_p,
		cd_cfop			cd_cfop,
		sum(vl_bc_icms)		vl_bc_icms_p,
		tx_aliq_icms		tx_aliq_icms,
		sum(vl_icms)		vl_icms_p,
		sum(vl_icms_st)		vl_icms_st_p,
		sum(vl_isnt_icms)	vl_isnt_icms_p,
		sum(vl_out_icms)	vl_out_icms_p,
		'0'			ie_ind_petr
	from	table(fis_sef_edoc_reg_lfpd05_pck.obter_valores(nr_seq_nota_p)) a
	where	nr_seq_nota		= nr_seq_nota_p
	group by	tx_aliq_icms,
			cd_cfop;

/*Criação do array com o tipo sendo do cursor eespecificado - c_reg_e025*/

type reg_c_reg_e105 is table of c_reg_e105%RowType;
vetrege105 reg_c_reg_e105;

BEGIN

open c_reg_e105;
loop
fetch c_reg_e105 bulk collect into vetrege105 limit 1000;
	for i in 1 .. vetrege105.Count loop
		begin

		/*Incrementa a variavel para o array*/

		PERFORM set_config('fis_sef_edoc_reg_lfpd05_pck.qt_cursor_e105_w', current_setting('fis_sef_edoc_reg_lfpd05_pck.qt_cursor_e105_w')::bigint + 1, false);

		/*Pega a sequencia da taleba fis_sef_edoc_e105 para o insert*/

		select	nextval('fis_sef_edoc_e105_seq')
		into STRICT	nr_seq_fis_sef_edoc_e105_w
		;

		/*Inserindo valores no array para realização do forall posteriormente*/

		current_setting('fis_sef_edoc_reg_lfpd05_pck.fis_registros_e105_w')::registro_e105(current_setting('fis_sef_edoc_reg_lfpd05_pck.qt_cursor_e105_w')::bigint).nr_sequencia 		:= nr_seq_fis_sef_edoc_e105_w;
		current_setting('fis_sef_edoc_reg_lfpd05_pck.fis_registros_e105_w')::registro_e105(current_setting('fis_sef_edoc_reg_lfpd05_pck.qt_cursor_e105_w')::bigint).dt_atualizacao 		:= clock_timestamp();
		current_setting('fis_sef_edoc_reg_lfpd05_pck.fis_registros_e105_w')::registro_e105(current_setting('fis_sef_edoc_reg_lfpd05_pck.qt_cursor_e105_w')::bigint).nm_usuario 		:= current_setting('fis_sef_edoc_reg_lfpd05_pck.nm_usuario_w')::usuario.nm_usuario%type;
		current_setting('fis_sef_edoc_reg_lfpd05_pck.fis_registros_e105_w')::registro_e105(current_setting('fis_sef_edoc_reg_lfpd05_pck.qt_cursor_e105_w')::bigint).dt_atualizacao_nrec	:= clock_timestamp();
		current_setting('fis_sef_edoc_reg_lfpd05_pck.fis_registros_e105_w')::registro_e105(current_setting('fis_sef_edoc_reg_lfpd05_pck.qt_cursor_e105_w')::bigint).nm_usuario_nrec 		:= current_setting('fis_sef_edoc_reg_lfpd05_pck.nm_usuario_w')::usuario.nm_usuario%type;
		current_setting('fis_sef_edoc_reg_lfpd05_pck.fis_registros_e105_w')::registro_e105(current_setting('fis_sef_edoc_reg_lfpd05_pck.qt_cursor_e105_w')::bigint).cd_reg 			:= 'E105';
		current_setting('fis_sef_edoc_reg_lfpd05_pck.fis_registros_e105_w')::registro_e105(current_setting('fis_sef_edoc_reg_lfpd05_pck.qt_cursor_e105_w')::bigint).vl_cont_p		:= vetrege105[i].vl_cont_p;
		current_setting('fis_sef_edoc_reg_lfpd05_pck.fis_registros_e105_w')::registro_e105(current_setting('fis_sef_edoc_reg_lfpd05_pck.qt_cursor_e105_w')::bigint).vl_op_iss_p		:= vetrege105[i].vl_op_iss_p;
		current_setting('fis_sef_edoc_reg_lfpd05_pck.fis_registros_e105_w')::registro_e105(current_setting('fis_sef_edoc_reg_lfpd05_pck.qt_cursor_e105_w')::bigint).cd_cfop			:= vetrege105[i].cd_cfop;
		current_setting('fis_sef_edoc_reg_lfpd05_pck.fis_registros_e105_w')::registro_e105(current_setting('fis_sef_edoc_reg_lfpd05_pck.qt_cursor_e105_w')::bigint).vl_bc_icms_p		:= vetrege105[i].vl_bc_icms_p;
		current_setting('fis_sef_edoc_reg_lfpd05_pck.fis_registros_e105_w')::registro_e105(current_setting('fis_sef_edoc_reg_lfpd05_pck.qt_cursor_e105_w')::bigint).tx_aliq_icms		:= vetrege105[i].tx_aliq_icms;
		current_setting('fis_sef_edoc_reg_lfpd05_pck.fis_registros_e105_w')::registro_e105(current_setting('fis_sef_edoc_reg_lfpd05_pck.qt_cursor_e105_w')::bigint).vl_icms_p		:= vetrege105[i].vl_icms_p;
		current_setting('fis_sef_edoc_reg_lfpd05_pck.fis_registros_e105_w')::registro_e105(current_setting('fis_sef_edoc_reg_lfpd05_pck.qt_cursor_e105_w')::bigint).vl_icms_st_p		:= vetrege105[i].vl_icms_st_p;
		current_setting('fis_sef_edoc_reg_lfpd05_pck.fis_registros_e105_w')::registro_e105(current_setting('fis_sef_edoc_reg_lfpd05_pck.qt_cursor_e105_w')::bigint).vl_isnt_icms_p		:= vetrege105[i].vl_isnt_icms_p;
		current_setting('fis_sef_edoc_reg_lfpd05_pck.fis_registros_e105_w')::registro_e105(current_setting('fis_sef_edoc_reg_lfpd05_pck.qt_cursor_e105_w')::bigint).vl_out_icms_p		:= vetrege105[i].vl_out_icms_p;
		current_setting('fis_sef_edoc_reg_lfpd05_pck.fis_registros_e105_w')::registro_e105(current_setting('fis_sef_edoc_reg_lfpd05_pck.qt_cursor_e105_w')::bigint).ie_ind_petr		:= vetrege105[i].ie_ind_petr;
		current_setting('fis_sef_edoc_reg_lfpd05_pck.fis_registros_e105_w')::registro_e105(current_setting('fis_sef_edoc_reg_lfpd05_pck.qt_cursor_e105_w')::bigint).nr_seq_superior		:= nr_seq_superior_p;
		current_setting('fis_sef_edoc_reg_lfpd05_pck.fis_registros_e105_w')::registro_e105(current_setting('fis_sef_edoc_reg_lfpd05_pck.qt_cursor_e105_w')::bigint).nr_seq_controle 		:= current_setting('fis_sef_edoc_reg_lfpd05_pck.nr_seq_controle_w')::fis_sef_edoc_controle.nr_sequencia%type;


		end;
	end loop;
EXIT WHEN NOT FOUND; /* apply on c_reg_e105 */
end loop;
close c_reg_e105;

/*Libera memoria*/

dbms_session.free_unused_user_memory;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE fis_sef_edoc_reg_lfpd05_pck.fis_gerar_reg_e105_edoc ( nr_seq_superior_p bigint, nr_seq_nota_p bigint) FROM PUBLIC;
