-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


CREATE TYPE reg_seq_doc AS (	nr_seq_documento	ctb_documento.nr_sequencia%type);


CREATE OR REPLACE PROCEDURE ctb_concil_financeira_pck.ctb_vincular_documento ( nr_documento_p ctb_documento.nr_documento%type, nr_lote_contabil_p ctb_documento.nr_lote_contabil%type, nm_usuario_p ctb_documento.nm_usuario%type) AS $body$
DECLARE



nr_seq_ctb_documento_w		ctb_documento.nr_sequencia%type;
vl_total_debito_w		ctb_documento.vl_movimento%type;
vl_total_credito_w		ctb_documento.vl_movimento%type;
nm_tabela_ant_w			ctb_documento.nm_tabela%type;
nm_atributo_ant_w		ctb_documento.nm_atributo%type;
ie_debito_credito_ant_w		movimento_contabil.ie_debito_credito%type;
vl_movimento_w			ctb_documento.vl_movimento%type;
ie_conciliar_w			tipo_lote_contabil.ie_conciliar%type;
cd_tipo_lote_contabil_w	tipo_lote_contabil.cd_tipo_lote_contabil%type;
nm_atributo_w			ctb_documento.nm_atributo%type;
vl_movimento_doc_w		ctb_documento.vl_movimento%type:= 0;
vl_movimento_total_doc_w	ctb_documento.vl_movimento%type:= 0;
nm_atributo_ret_w		varchar(255);
id_indx_aux_w			integer:= 0;
ie_atributo_unico_w		boolean:= false;
ds_seq_cdt_documento_w		varchar(255);
count_w				double precision;
vl_parametro_lotes_w		varchar(255);

type seq_ctb_documento is table of reg_seq_doc index by integer;

array_seq_ctb_documento_w		seq_ctb_documento;

c01 CURSOR FOR
	SELECT	a.nr_seq_info,
		a.nr_seq_doc_compl,
		a.vl_movimento,
		c.cd_tipo_lote_contabil,
		b.dt_movimento,
		a.nm_tabela,
		a.nm_atributo,
		b.cd_estabelecimento,
		b.ie_debito_credito,
		a.nr_sequencia,
		a.nr_doc_analitico
	from	movimento_contabil_doc a,
		movimento_contabil b,
		lote_contabil c
	where	a.nr_lote_contabil	= b.nr_lote_contabil
	and	a.nr_seq_movimento	= b.nr_sequencia
	and 	a.nr_lote_contabil	= c.nr_lote_contabil
	and 	a.nr_documento		= nr_documento_p
	and 	a.nr_lote_contabil	= nr_lote_contabil_p
	order by	a.nm_tabela,
			a.nm_atributo,
			b.ie_debito_credito,
			b.cd_estabelecimento;

c01_w		c01%rowtype;
BEGIN

vl_total_debito_w	:= 0;
vl_total_credito_w	:= 0;
vl_movimento_w		:= 0;

open c01;
loop
fetch c01 into	
	c01_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin
	
	current_setting('ctb_concil_financeira_pck.array_regitros_w')::campos(current_setting('ctb_concil_financeira_pck.array_regitros_w')::campos.count + 1).nr_seq_movto_doc	:= c01_w.nr_sequencia;
	current_setting('ctb_concil_financeira_pck.array_regitros_w')::campos(current_setting('ctb_concil_financeira_pck.array_regitros_w')::campos.count).cd_estabelecimento	:= c01_w.cd_estabelecimento;
	current_setting('ctb_concil_financeira_pck.array_regitros_w')::campos(current_setting('ctb_concil_financeira_pck.array_regitros_w')::campos.count).cd_tipo_lote_contabil	:= c01_w.cd_tipo_lote_contabil;
	current_setting('ctb_concil_financeira_pck.array_regitros_w')::campos(current_setting('ctb_concil_financeira_pck.array_regitros_w')::campos.count).nr_seq_info		:= c01_w.nr_seq_info;
	current_setting('ctb_concil_financeira_pck.array_regitros_w')::campos(current_setting('ctb_concil_financeira_pck.array_regitros_w')::campos.count).nr_seq_doc_compl	:= c01_w.nr_seq_doc_compl;
	current_setting('ctb_concil_financeira_pck.array_regitros_w')::campos(current_setting('ctb_concil_financeira_pck.array_regitros_w')::campos.count).nm_tabela		:= c01_w.nm_tabela;
	current_setting('ctb_concil_financeira_pck.array_regitros_w')::campos(current_setting('ctb_concil_financeira_pck.array_regitros_w')::campos.count).nm_atributo		:= c01_w.nm_atributo;
	current_setting('ctb_concil_financeira_pck.array_regitros_w')::campos(current_setting('ctb_concil_financeira_pck.array_regitros_w')::campos.count).ie_debito_credito	:= c01_w.ie_debito_credito;
	current_setting('ctb_concil_financeira_pck.array_regitros_w')::campos(current_setting('ctb_concil_financeira_pck.array_regitros_w')::campos.count).vl_movimento		:= c01_w.vl_movimento;
	current_setting('ctb_concil_financeira_pck.array_regitros_w')::campos(current_setting('ctb_concil_financeira_pck.array_regitros_w')::campos.count).dt_competencia		:= c01_w.dt_movimento;
	current_setting('ctb_concil_financeira_pck.array_regitros_w')::campos(current_setting('ctb_concil_financeira_pck.array_regitros_w')::campos.count).ie_update		:= 'N';
	current_setting('ctb_concil_financeira_pck.array_regitros_w')::campos(current_setting('ctb_concil_financeira_pck.array_regitros_w')::campos.count).nr_doc_analitico	:= c01_w.nr_doc_analitico;
	
	if (c01_w.ie_debito_credito = 'D') and (coalesce(c01_w.vl_movimento, 0) <> 0)	then
		begin
		vl_total_debito_w := vl_total_debito_w + c01_w.vl_movimento;	
		end;
	elsif (c01_w.ie_debito_credito = 'C') and (coalesce(c01_w.vl_movimento, 0) <> 0)	then
		begin
		vl_total_credito_w := vl_total_credito_w + c01_w.vl_movimento;
		end;
	end if;
	
	end;
end loop;
close c01;

if (vl_total_debito_w = vl_total_credito_w)	then
	begin
	
	for idx in 1..array_regitros_w.count loop
		begin
		if (current_setting('ctb_concil_financeira_pck.array_regitros_w')::campos[idx].ie_update = 'N') then
			begin
			
			for idx_w in 1..array_regitros_w.count loop
				begin
				
				if	((current_setting('ctb_concil_financeira_pck.array_regitros_w')::campos[idx].nm_tabela = current_setting('ctb_concil_financeira_pck.array_regitros_w')::campos[idx_w].nm_tabela)
						and (current_setting('ctb_concil_financeira_pck.array_regitros_w')::campos[idx].nm_atributo = current_setting('ctb_concil_financeira_pck.array_regitros_w')::campos[idx_w].nm_atributo)
						and (current_setting('ctb_concil_financeira_pck.array_regitros_w')::campos[idx].ie_debito_credito = current_setting('ctb_concil_financeira_pck.array_regitros_w')::campos[idx_w].ie_debito_credito)) then
					begin
					
					vl_movimento_w	:= vl_movimento_w + current_setting('ctb_concil_financeira_pck.array_regitros_w')::campos[idx_w].vl_movimento;
					
					if (current_setting('ctb_concil_financeira_pck.array_regitros_w')::campos[idx].nr_seq_movto_doc = current_setting('ctb_concil_financeira_pck.array_regitros_w')::campos[idx_w].nr_seq_movto_doc) then
						begin
						current_setting('ctb_concil_financeira_pck.array_regitros_w')::campos[idx_w].ie_update := 'S';
						end;
					else
						begin
						current_setting('ctb_concil_financeira_pck.array_regitros_w')::campos[idx_w].ie_update := 'SI';
						end;
					end if;
					
					end;
				else
					begin
					current_setting('ctb_concil_financeira_pck.array_regitros_w')::campos[idx_w].ie_update := 'N';
					end;
				end if;
								
				end;
			end loop;
			
			end;
		end if;
		
		
		nm_atributo_ret_w:= ctb_concil_financeira_pck.formata_atributos_conciliacao(current_setting('ctb_concil_financeira_pck.array_regitros_w')::campos[idx].nm_atributo);
		
		id_indx_aux_w := 0;
		
		
		for i in 1..length(nm_atributo_ret_w)loop
			begin
			
			if ( substr(nm_atributo_ret_w,i,1) = '|') then
				id_indx_aux_w := id_indx_aux_w + 1;
			end if;
			
			end;
		end loop;
		
		if (id_indx_aux_w = 1) and (length(nm_atributo_ret_w) > 0) then
			begin
			id_indx_aux_w		:=1;
			ie_atributo_unico_w	:= true;
			end;
		end if;
		
		
		vl_movimento_doc_w	:= 0;
		vl_movimento_total_doc_w:= 0;
		
		for i in 1..id_indx_aux_w loop
			begin
								
			nm_atributo_w:= substr(nm_atributo_ret_w,1 , position('|' in nm_atributo_ret_w) - 1);
			nm_atributo_ret_w:= substr(nm_atributo_ret_w, position('|' in nm_atributo_ret_w) + 1, length(nm_atributo_ret_w));
				
			if (current_setting('ctb_concil_financeira_pck.array_regitros_w')::campos[idx].ie_update = 'S') then
				begin
				
				begin
				
				select	a.nr_sequencia,
					a.vl_movimento
				into STRICT	nr_seq_ctb_documento_w,
                                        vl_movimento_doc_w
				from	ctb_documento a
				where	a.cd_estabelecimento		= current_setting('ctb_concil_financeira_pck.array_regitros_w')::campos[idx].cd_estabelecimento
				and 	a.dt_competencia		= current_setting('ctb_concil_financeira_pck.array_regitros_w')::campos[idx].dt_competencia
				and 	a.cd_tipo_lote_contabil		= current_setting('ctb_concil_financeira_pck.array_regitros_w')::campos[idx].cd_tipo_lote_contabil
				and 	a.nr_seq_info			= current_setting('ctb_concil_financeira_pck.array_regitros_w')::campos[idx].nr_seq_info
				and 	a.nr_documento			= nr_documento_p
				and 	coalesce(a.nr_seq_doc_compl,0)	= coalesce(current_setting('ctb_concil_financeira_pck.array_regitros_w')::campos[idx].nr_seq_doc_compl,0)
				and 	coalesce(a.nr_doc_analitico,0)	= coalesce(current_setting('ctb_concil_financeira_pck.array_regitros_w')::campos[idx].nr_doc_analitico,0)
				and 	a.nm_tabela			= current_setting('ctb_concil_financeira_pck.array_regitros_w')::campos[idx].nm_tabela
				and 	a.nm_atributo			= nm_atributo_w;

				exception
				when others then
					nr_seq_ctb_documento_w	:= 0;
				end;
				
				if (coalesce(nr_seq_ctb_documento_w, 0) <> 0) then
					begin
						
						vl_movimento_total_doc_w:= vl_movimento_total_doc_w + vl_movimento_doc_w;
						array_seq_ctb_documento_w[array_seq_ctb_documento_w.count + 1].nr_seq_documento	:=	nr_seq_ctb_documento_w;
						
					end;
				end if;
				
				end;
			end if;
						
			if	((coalesce(nr_seq_ctb_documento_w, 0) 	<> 0)	and 
				((current_setting('ctb_concil_financeira_pck.array_regitros_w')::campos[idx].ie_update 	= 'S')	
					or (current_setting('ctb_concil_financeira_pck.array_regitros_w')::campos[idx].ie_update	= 'SI'))  and (vl_movimento_total_doc_w 		= current_setting('ctb_concil_financeira_pck.array_regitros_w')::campos[idx].vl_movimento) and (id_indx_aux_w = i)) then
				begin
				
				for idx_ctb_doc in 1..array_seq_ctb_documento_w.count loop
					begin
					
					update	movimento_contabil_doc
					set	nr_seq_ctb_documento					= nr_seq_ctb_documento_w,
						nm_usuario						= nm_usuario_p,
						dt_atualizacao						= clock_timestamp()
					where	nr_sequencia						= current_setting('ctb_concil_financeira_pck.array_regitros_w')::campos[idx].nr_seq_movto_doc
					and 	ctb_obter_tipo_lote_contabil(nr_lote_contabil, 'C')	= current_setting('ctb_concil_financeira_pck.array_regitros_w')::campos[idx].cd_tipo_lote_contabil;
					
					update	ctb_documento
					set	nr_lote_contabil	= nr_lote_contabil_p,
						ie_status		= 'C',
						nm_usuario		= nm_usuario_p,
						dt_atualizacao		= clock_timestamp()
					where	nr_sequencia		= array_seq_ctb_documento_w[idx_ctb_doc].nr_seq_documento;
					
					end;
				end loop;
				
				end;
			end if;
			
			
			end;
		end loop;
		
		array_seq_ctb_documento_w.delete;
	
		end;
	end loop;
	
	end;
end if;	



current_setting('ctb_concil_financeira_pck.array_regitros_w')::campos.delete;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ctb_concil_financeira_pck.ctb_vincular_documento ( nr_documento_p ctb_documento.nr_documento%type, nr_lote_contabil_p ctb_documento.nr_lote_contabil%type, nm_usuario_p ctb_documento.nm_usuario%type) FROM PUBLIC;
