-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE gerar_int_dankia_pck.dankia_disp_item_transf ( cd_material_p bigint, cd_barras_p text, cd_transferencia_p text, cd_item_transferencia_p text, qt_material_p bigint, cd_local_estoque_destino_p bigint, cd_local_estoque_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, ie_operacao_p text, nr_seq_lote_fornec_p bigint default null) AS $body$
BEGIN
		
		if (get_ie_int_dankia = 'S') and (gerar_int_dankia_pck.get_ie_local_dankia(cd_local_estoque_destino_p) = 'S') then
			
			cd_barras_mat_w := cd_barras_p;
			
			if (nr_seq_lote_fornec_p IS NOT NULL AND nr_seq_lote_fornec_p::text <> '') and (coalesce(cd_barras_p::text, '') = '') then
				select	max(lpad(nr_seq_lote_fornec_p || nr_digito_verif,11,0))
				into STRICT	cd_barras_mat_w
				from	material_lote_fornec
				where	nr_sequencia = nr_seq_lote_fornec_p;
			end if;
						
			select 	max(nr_sequencia)
			into STRICT	nr_seq_item_transf_w
			from 	dankia_disp_item_transf
			where 	cd_barras = cd_barras_p
			and 	cd_local_estoque_p = cd_local_estoque_p
			and 	cd_local_estoque_destino = cd_local_estoque_destino_p
			and 	cd_estabelecimento = cd_estabelecimento_p;
			
			insert into gerar_int_dankia_pck.dankia_disp_item_transf(
						nr_sequencia,
						cd_estabelecimento,
						cd_transferencia,
						dt_atualizacao,
						nm_usuario,
						cd_material,
						cd_barras,
						cd_item_transferencia,
						ie_operacao,
						cd_local_estoque_origem,
						qt_material,
						cd_local_estoque_destino,
						dt_lido_dankia,
						ie_processado,
						ds_processado_observacao,
						ds_stack)
			values (nextval('dankia_disp_item_transf_seq'),
						cd_estabelecimento_p,
						cd_transferencia_p,
						clock_timestamp(),
						nm_usuario_p,
						cd_material_p,
						coalesce(cd_barras_mat_w,cd_material_p),
						cd_item_transferencia_p,
						ie_operacao_p,
						cd_local_estoque_p,
						qt_material_p,
						cd_local_estoque_destino_p,
						null,
						'N',
						null,
						substr(dbms_utility.format_call_stack,1,2000));	
		end if;
		end;


$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_int_dankia_pck.dankia_disp_item_transf ( cd_material_p bigint, cd_barras_p text, cd_transferencia_p text, cd_item_transferencia_p text, qt_material_p bigint, cd_local_estoque_destino_p bigint, cd_local_estoque_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, ie_operacao_p text, nr_seq_lote_fornec_p bigint default null) FROM PUBLIC;
