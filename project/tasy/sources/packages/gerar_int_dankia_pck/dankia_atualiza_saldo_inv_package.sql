-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE gerar_int_dankia_pck.dankia_atualiza_saldo_inv (cd_material_p bigint, cd_barras_p text, qt_material_p bigint, cd_local_estoque_p bigint, cd_operacao_estoque_p bigint, nm_usuario_p text, nr_seq_lote_fornec_p bigint, cd_estabelecimento_p bigint) AS $body$
DECLARE

	qt_saldo_disponivel_w	double precision;
	qt_saldo_atual_w		double precision;
	ie_estoque_lote_w		parametro_estoque.ie_estoque_lote%type;
	qt_movimento_w			movimento_estoque.qt_movimento%type;
	
	
BEGIN

	if (get_ie_int_dankia = 'S') and (gerar_int_dankia_pck.get_ie_local_dankia(cd_local_estoque_p) = 'S') then
			
		dt_mesano_referencia_w		:= trunc(clock_timestamp(),'mm');
			
		qt_saldo_disponivel_w	:= obter_saldo_disp_estoque(cd_estabelecimento_p, cd_material_p, cd_local_estoque_p, dt_mesano_referencia_w);
			
		if (nr_seq_lote_fornec_p IS NOT NULL AND nr_seq_lote_fornec_p::text <> '') then

			select	coalesce(max(ie_estoque_lote),'N')
			into STRICT	ie_estoque_lote_w
			from	parametro_estoque
			where	cd_estabelecimento = cd_estabelecimento_p;
			
			if (ie_estoque_lote_w = 'S') and (substr(obter_se_material_estoque_lote(cd_estabelecimento_p, cd_material_p),1,1) = 'S') then
				qt_saldo_disponivel_w	:= obter_saldo_estoque_lote(cd_estabelecimento_p, cd_material_p, cd_local_estoque_p, dt_mesano_referencia_w, nr_seq_lote_fornec_p);
			end if;
		end if;
		
		insert into gerar_int_dankia_pck.dankia_disp_saldo_local(nr_sequencia,
				cd_estabelecimento,
				dt_atualizacao,
				nm_usuario,
				cd_material,
				cd_barras,
				cd_local_estoque,
				qt_saldo,
				vl_custo,
				cd_operacao_estoque,
				nr_seq_dankia,
				dt_lido_dankia,
				ie_processado,
				ds_processado_observacao,
				ds_stack)
		values (nextval('dankia_disp_saldo_local_seq'),
				cd_estabelecimento_p,
				clock_timestamp(),
				nm_usuario_p,
				cd_material_p,
				cd_barras_p,
				cd_local_estoque_p,
				qt_saldo_disponivel_w,
				null,
				cd_operacao_estoque_p,
				null,
				null,
				'N',
				null,
				substr(dbms_utility.format_call_stack,1,2000));		
	end if;
	
	end;
	

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_int_dankia_pck.dankia_atualiza_saldo_inv (cd_material_p bigint, cd_barras_p text, qt_material_p bigint, cd_local_estoque_p bigint, cd_operacao_estoque_p bigint, nm_usuario_p text, nr_seq_lote_fornec_p bigint, cd_estabelecimento_p bigint) FROM PUBLIC;
