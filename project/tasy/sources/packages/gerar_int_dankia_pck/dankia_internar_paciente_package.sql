-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE gerar_int_dankia_pck.dankia_internar_paciente ( nr_atendimento_p bigint, cd_setor_atendimento_p bigint, cd_unidade_compl_p text, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE


	ie_dispensario_new_w	varchar(1);
	
	
BEGIN

	if (get_ie_int_dankia = 'S') then
		
		select	coalesce(max('S'), 'N')
		into STRICT 	ie_dispensario_new_w
		from	dis_regra_setor
		where 	cd_setor_atendimento = cd_setor_atendimento_p
		and 	cd_estabelecimento = cd_estabelecimento_p;

		select	max(cd_pessoa_fisica),
				max(ie_tipo_atendimento),
				max(dt_alta)
		into STRICT	current_setting('gerar_int_dankia_pck.cd_pessoa_fisica_w')::atendimento_paciente.cd_pessoa_fisica%type,
				ie_tipo_atendimento_w,
				current_setting('gerar_int_dankia_pck.dt_alta_w')::atendimento_paciente.dt_alta%type
		from	atendimento_paciente
		where	nr_atendimento = nr_atendimento_p
		and 	cd_estabelecimento = cd_estabelecimento_p;

		select 	count(1)
		into STRICT	current_setting('gerar_int_dankia_pck.qt_existe_w')::bigint
		from	dankia_disp_paciente
		where 	cd_pessoa_fisica = current_setting('gerar_int_dankia_pck.cd_pessoa_fisica_w')::atendimento_paciente.cd_pessoa_fisica%type
		and 	cd_estabelecimento = cd_estabelecimento_p;
		
		select	count(1)
		into STRICT	current_setting('gerar_int_dankia_pck.qt_atend_pac_w')::bigint
		from	dankia_disp_atend_paciente a
		where	a.nr_atendimento = nr_atendimento_p
		and 	a.cd_estabelecimento = cd_estabelecimento_p;
	
		if (ie_dispensario_new_w = 'S') then
		
			select 	max(a.nm_pessoa_fisica),
					max(a.ie_sexo),
					max(a.dt_nascimento),
					max(gerar_int_dankia_pck.get_nm_mae_dankia(a.cd_pessoa_fisica))
			into STRICT	nm_paciente_w,
					ie_sexo_w,
					dt_nascimento_w,
					current_setting('gerar_int_dankia_pck.nm_mae_w')::compl_pessoa_fisica.nm_contato%type
			from	pessoa_fisica a
			where	a.cd_pessoa_fisica	= current_setting('gerar_int_dankia_pck.cd_pessoa_fisica_w')::atendimento_paciente.cd_pessoa_fisica%type;
			
			if (current_setting('gerar_int_dankia_pck.qt_existe_w')::bigint = 0) then

				insert into dankia_disp_paciente(
						nr_sequencia,
						cd_estabelecimento,
						dt_atualizacao,
						nm_usuario,
						cd_pessoa_fisica,
						nm_paciente,
						nm_mae,
						ie_sexo,
						dt_nascimento,
						ie_operacao,
						dt_lido_dankia,
						ie_processado,
						ds_processado_observacao,
						ds_stack)
				values (	nextval('dankia_disp_paciente_seq'),
						cd_estabelecimento_p,
						clock_timestamp(),
						nm_usuario_p,
						current_setting('gerar_int_dankia_pck.cd_pessoa_fisica_w')::atendimento_paciente.cd_pessoa_fisica%type,
						nm_paciente_w,
						current_setting('gerar_int_dankia_pck.nm_mae_w')::compl_pessoa_fisica.nm_contato%type,
						ie_sexo_w,
						dt_nascimento_w,
						'I',
						null,
						'N',
						null,
						substr(dbms_utility.format_call_stack,1,2000));

			end if;	
			
			if (current_setting('gerar_int_dankia_pck.qt_atend_pac_w')::bigint = 0) then
				
				insert into dankia_disp_atend_paciente(
						nr_sequencia,
						cd_estabelecimento,
						dt_atualizacao,
						nm_usuario,
						cd_pessoa_fisica,
						nr_atendimento,
						cd_setor_atendimento,
						ie_tipo_atendimento,
						cd_leito,
						ie_alta,
						dt_alta,
						ie_operacao,
						dt_lido_dankia,
						ie_processado,
						ds_processado_observacao,
						ds_stack)
				values (	nextval('dankia_disp_atend_paciente_seq'),
						cd_estabelecimento_p,
						clock_timestamp(),
						nm_usuario_p,
						current_setting('gerar_int_dankia_pck.cd_pessoa_fisica_w')::atendimento_paciente.cd_pessoa_fisica%type,
						nr_atendimento_p,
						cd_setor_atendimento_p,
						ie_tipo_atendimento_w,
						cd_unidade_compl_p,
						CASE WHEN current_setting('gerar_int_dankia_pck.dt_alta_w')::atendimento_paciente.dt_alta%coalesce(type::text, '') = '' THEN 'N'  ELSE 'S' END ,
						current_setting('gerar_int_dankia_pck.dt_alta_w')::atendimento_paciente.dt_alta%type,
						'I',
						null,
						'N',
						null,
						substr(dbms_utility.format_call_stack,1,2000));
				end if;
			end if;
		end if;
	end;
	

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_int_dankia_pck.dankia_internar_paciente ( nr_atendimento_p bigint, cd_setor_atendimento_p bigint, cd_unidade_compl_p text, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;
