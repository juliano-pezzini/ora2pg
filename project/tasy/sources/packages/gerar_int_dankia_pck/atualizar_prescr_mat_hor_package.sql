-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE gerar_int_dankia_pck.atualizar_prescr_mat_hor ( nr_seq_mat_hor_p bigint, cd_material_p bigint, nr_seq_lote_p bigint, qt_dispensar_p bigint, ie_alteracao_p text, cd_local_estoque_p bigint, nm_usuario_p text) AS $body$
DECLARE


	cd_estabelecimento_w	estabelecimento.cd_estabelecimento%type;
	
	
BEGIN
	
	if (get_ie_int_dankia = 'S') then
		
		ie_tipo_horario_w := 'R';
		
		select	max(b.nr_sequencia),
				max(a.dt_horario),
				max(a.dt_suspensao),
				max(b.ds_justificativa),
				max(a.nr_seq_superior),
				max(b.dt_validade),
				max(coalesce(coalesce(a.cd_local_estoque, b.cd_local_estoque),c.cd_local_estoque)),
				max(a.nr_prescricao),
				max(c.nr_atendimento),
				max(coalesce(b.ie_acm,'N')),
				max(coalesce(b.ie_se_necessario,'N')),
				max(coalesce(b.ie_urgencia,'N')),
				max(substr(obter_desc_material(b.cd_material),1,255)),
				max(substr(Obter_Desc_Prescr_Proc(p.cd_procedimento,p.ie_origem_proced, p.nr_seq_proc_interno),1,240)),
				max(b.nr_sequencia_proc),
				max(c.cd_estabelecimento)
		into STRICT	nr_seq_prescricao_w,
				dt_horario_w,
				dt_suspensao_w,
				ds_justificativa_w,
				nr_seq_superior_w,
				dt_validade_w,
				current_setting('gerar_int_dankia_pck.cd_local_estoque_w')::local_estoque.cd_local_estoque%type,
				nr_prescricao_w,
				nr_atendimento_w,
				ie_acm_w,
				ie_se_necessario_w,
				ie_urgencia_w,
				current_setting('gerar_int_dankia_pck.ds_material_w')::material.ds_material%type,
				ds_procedimento_w,
				nr_sequencia_proc_w,
				cd_estabelecimento_w
		FROM prescr_medica c, prescr_mat_hor a, prescr_material b
LEFT OUTER JOIN prescr_procedimento p ON (b.nr_prescricao = p.nr_prescricao AND b.nr_sequencia_proc = p.nr_sequencia)
WHERE a.nr_prescricao = b.nr_prescricao and a.nr_seq_material = b.nr_sequencia and b.nr_prescricao = c.nr_prescricao   and a.nr_sequencia = nr_seq_mat_hor_p;
		
		if (ie_acm_w = 'S') then
			ie_tipo_horario_w := 'M';
		elsif (ie_se_necessario_w = 'S') then
			ie_tipo_horario_w := 'S';
		elsif (ie_urgencia_w = 'S') then
			ie_tipo_horario_w := 'A';
		end if;

		if (coalesce(nr_seq_superior_w,0) = 0) and (coalesce(nr_sequencia_proc_w,0) = 0) then
			ds_prescricao_w := current_setting('gerar_int_dankia_pck.ds_material_w')::material.ds_material%type;
		else
			ds_prescricao_w := ds_procedimento_w;
		end if;

		if (nr_seq_superior_w IS NOT NULL AND nr_seq_superior_w::text <> '') then
			PERFORM set_config('gerar_int_dankia_pck.ie_medic_principal_w', 'N', false);
		else
			PERFORM set_config('gerar_int_dankia_pck.ie_medic_principal_w', 'S', false);
		end if;
		
		insert into dankia_disp_mat_hor(
				nr_sequencia,
				cd_estabelecimento,
				nr_prescricao,
				dt_atualizacao,
				nr_seq_lote,
				nm_usuario,
				nr_seq_prescricao,
				nr_seq_horario,
				qt_dispensar,
				dt_horario,
				dt_suspensao,
				ds_prescricao,
				ie_medic_principal,
				dt_validade,
				cd_local_estoque,
				ie_operacao,
				dt_lido_dankia,
				ie_processado,
				ds_processado_observacao,
				ds_stack,
				cd_material,
				nr_atendimento,
				ie_tipo_horario,
				ds_procedimento)
		values (	nextval('dankia_disp_mat_hor_seq'),
				cd_estabelecimento_w,
				nr_prescricao_w,
				clock_timestamp(),
				nr_seq_lote_p,
				nm_usuario_p,
				nr_seq_prescricao_w,
				nr_seq_mat_hor_p,
				qt_dispensar_p,
				dt_horario_w,
				dt_suspensao_w,
				ds_prescricao_w,
				current_setting('gerar_int_dankia_pck.ie_medic_principal_w')::varchar(1),
				dt_validade_w,
				coalesce(cd_local_estoque_p, current_setting('gerar_int_dankia_pck.cd_local_estoque_w')::local_estoque.cd_local_estoque%type),
				ie_alteracao_p,
				null,
				'N',
				null,
				substr(dbms_utility.format_call_stack,1,2000),
				cd_material_p,
				nr_atendimento_w,
				ie_tipo_horario_w,
				ds_procedimento_w);
	end if;
	end;


$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_int_dankia_pck.atualizar_prescr_mat_hor ( nr_seq_mat_hor_p bigint, cd_material_p bigint, nr_seq_lote_p bigint, qt_dispensar_p bigint, ie_alteracao_p text, cd_local_estoque_p bigint, nm_usuario_p text) FROM PUBLIC;
