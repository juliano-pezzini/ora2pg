-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


	-- Grava dados exame
CREATE OR REPLACE PROCEDURE igtln_integracao_pck.apae_ws_grava_exame ( nr_seq_ficha_p bigint, cd_exame_equip_p text, nm_usuario_p text) AS $body$
DECLARE

	nr_sequencia_w		bigint;
	nr_seq_exame_w		bigint;
	cd_material_w		varchar(20);
	
BEGIN

		if  (nr_seq_ficha_p IS NOT NULL AND nr_seq_ficha_p::text <> '' AND cd_exame_equip_p IS NOT NULL AND cd_exame_equip_p::text <> '') then
			select	a.nr_seq_exame, c.cd_material_exame
			into STRICT	nr_seq_exame_w, cd_material_w
			from	lab_exame_equip a,
					equipamento_lab b,
					material_exame_lab c
			where	a.cd_exame_equip = cd_exame_equip_p
			and		a.cd_equipamento = b.cd_equipamento
			and		a.nr_seq_material = c.nr_sequencia
			and		upper(b.ds_sigla) = 'APAE';

			if (nr_seq_exame_w IS NOT NULL AND nr_seq_exame_w::text <> '') then
				select	nextval('lote_ent_sec_ficha_exam_seq')
				into STRICT	nr_sequencia_w
				;

				insert into lote_ent_sec_ficha_exam(
					nr_sequencia,
					dt_atualizacao,
					nm_usuario,
					nr_seq_exame,
					cd_material_exame,
					nr_seq_ficha
				) values (
					nr_sequencia_w,
					clock_timestamp(),
					nm_usuario_p,
					nr_seq_exame_w,
					cd_material_w,
					nr_seq_ficha_p
				);

			end if;
		end if;

	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE igtln_integracao_pck.apae_ws_grava_exame ( nr_seq_ficha_p bigint, cd_exame_equip_p text, nm_usuario_p text) FROM PUBLIC;
