-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


	-- Retorna verdadeiro se todos os exames de um lote estÃ£o com status >= 35
CREATE OR REPLACE FUNCTION igtln_integracao_pck.apae_ws_obter_result_exames (nr_lote_p bigint) RETURNS varchar AS $body$
DECLARE

	nr_aprovados_w	bigint;
	nr_total_w		bigint;
	
BEGIN
		select	count(*) aprovados
		into STRICT	nr_aprovados_w
		from	prescr_procedimento a,
				lote_ent_sec_ficha_exam b,
				lote_ent_sec_ficha c
		where	a.ie_status_atend >= 35
		and		a.nr_seq_exame = b.nr_seq_exame
		and		c.nr_sequencia = b.nr_seq_ficha
		and		c.nr_prescricao = a.nr_prescricao
		and		c.nr_seq_lote_sec = nr_lote_p;

		select	count(*) total
		into STRICT	nr_total_w
		from	prescr_procedimento a,
				lote_ent_sec_ficha_exam b,
				lote_ent_sec_ficha c
		where	a.nr_seq_exame = b.nr_seq_exame
		and		c.nr_sequencia = b.nr_seq_ficha
		and		c.nr_prescricao = a.nr_prescricao
		and		c.nr_seq_lote_sec = nr_lote_p;

    if 	(nr_total_w > 0 AND nr_aprovados_w = nr_total_w) then
		return 'S';
	else
		return 'N';
	end if;

	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION igtln_integracao_pck.apae_ws_obter_result_exames (nr_lote_p bigint) FROM PUBLIC;
