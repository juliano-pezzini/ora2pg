-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

  --
CREATE OR REPLACE FUNCTION pkg_low_tidal.buscar_pcts_low_tidal ( setor bigint, estabelecimento bigint, quarter bigint, dtFim timestamp ) RETURNS SETOF TABLE_ANALIT_TYPE AS $body$
DECLARE


C_PCTS CURSOR FOR
         SELECT '% of ventilator days with a documented Tidal Volume' label,
                coalesce(pr, 0) pr,
                coalesce(seg, 0) seg,
                coalesce(ter, 0) ter,
                coalesce(qua, 0) qua,
                coalesce(alleicu, 0) alleicu
           FROM (
                 SELECT ROUND (
                         (
                          (
                           SELECT COUNT(a.dt_monitorizacao)
                             FROM w_low_tidal a
                            WHERE (a.qt_vci IS NOT NULL AND a.qt_vci::text <> '')
                              AND a.cd_estabelecimento = estabelecimento
                              AND a.cd_setor_atendimento = setor
                              AND a.nr_trimestre = CASE
                                                       WHEN quarter = 4
                                                       THEN 1 
                                                       WHEN quarter < 4
                                                       THEN quarter + 1
                                                   END
                          ) / (
                           SELECT SUM(a.qt_dias_ventilados)
                             FROM w_low_tidal_population a
                            WHERE a.cd_estabelecimento = estabelecimento
                              AND a.cd_setor_atendimento = setor
                              AND a.nr_trimestre = CASE 
                                                       WHEN quarter = 4
                                                       THEN 1 
                                                       WHEN quarter < 4
                                                       THEN quarter + 1
                                                   END
                          )
                         ) * 100
                        , 2) PR,
                        ROUND (
                         (
                          (
                           SELECT COUNT(a.dt_monitorizacao)
                             FROM w_low_tidal a
                            WHERE (a.qt_vci IS NOT NULL AND a.qt_vci::text <> '')
                              AND a.cd_estabelecimento = estabelecimento
                              AND a.cd_setor_atendimento = setor
                              AND a.nr_trimestre = CASE 
                                                       WHEN quarter > 2
                                                       THEN quarter - 2
                                                       ELSE quarter + 2
                                                   END
                          ) / (
                           SELECT SUM(a.qt_dias_ventilados)
                             FROM w_low_tidal_population a
                            WHERE a.cd_estabelecimento = estabelecimento
                              AND a.cd_setor_atendimento = setor
                              AND a.nr_trimestre = CASE 
                                                       WHEN quarter > 2
                                                       THEN quarter - 2
                                                       ELSE quarter + 2
                                                   END
                          )
                         ) * 100
                        , 2) SEG,
                        ROUND (
                         (
                          (
                           SELECT COUNT(a.dt_monitorizacao)
                             FROM w_low_tidal a
                            WHERE (a.qt_vci IS NOT NULL AND a.qt_vci::text <> '')
                              AND a.cd_estabelecimento = estabelecimento
                              AND a.cd_setor_atendimento = setor
                              AND a.nr_trimestre = CASE 
                                                       WHEN quarter > 1
                                                       THEN quarter - 1
                                                       ELSE 4
                                                   END
                          ) / (
                           SELECT SUM(a.qt_dias_ventilados)
                             FROM w_low_tidal_population a
                            WHERE a.cd_estabelecimento = estabelecimento
                              AND a.cd_setor_atendimento = setor
                              AND a.nr_trimestre = CASE 
                                                       WHEN quarter > 1
                                                       THEN quarter - 1
                                                       ELSE 4
                                                   END
                          )
                         ) * 100
                        , 2) TER,
                        ROUND (
                         (
                          (
                           SELECT COUNT(a.dt_monitorizacao)
                             FROM w_low_tidal a
                            WHERE (a.qt_vci IS NOT NULL AND a.qt_vci::text <> '')
                              AND a.cd_estabelecimento = estabelecimento
                              AND a.cd_setor_atendimento = setor
                              AND a.nr_trimestre = quarter
                          ) / (
                           SELECT SUM(a.qt_dias_ventilados)
                             FROM w_low_tidal_population a
                            WHERE a.cd_estabelecimento = estabelecimento
                              AND a.cd_setor_atendimento = setor
                              AND a.nr_trimestre = quarter
                          )
                         ) * 100
                        , 2) QUA,
                        ROUND (
                         (
                          (
                           SELECT COUNT(a.dt_monitorizacao)
                             FROM w_low_tidal a
                            WHERE (a.qt_vci IS NOT NULL AND a.qt_vci::text <> '')
                              AND a.nr_trimestre = quarter
                          ) / (
                           SELECT SUM(a.qt_dias_ventilados)
                             FROM w_low_tidal_population a
                            WHERE a.nr_trimestre = quarter
                          )
                         ) * 100
                        , 2) ALLEICU
                   
              ) a
          
UNION ALL

         SELECT '% of ventilator days with a documented Plateau Pressure' label,
                coalesce(pr, 0) pr,
                coalesce(seg, 0) seg,
                coalesce(ter, 0) ter,
                coalesce(qua, 0) qua,
                coalesce(alleicu, 0) alleicu
           FROM (
                 SELECT ROUND (
                         (
                          (
                           SELECT COUNT(a.dt_monitorizacao)
                             FROM w_low_tidal a
                            WHERE (a.qt_pplato IS NOT NULL AND a.qt_pplato::text <> '')
                              AND a.cd_estabelecimento = estabelecimento
                              AND a.cd_setor_atendimento = setor
                              AND a.nr_trimestre = CASE 
                                                       WHEN quarter = 4
                                                       THEN 1 
                                                       WHEN quarter < 4
                                                       THEN quarter + 1
                                                   END
                          ) / (
                           SELECT SUM(a.qt_dias_ventilados)
                             FROM w_low_tidal_population a
                            WHERE a.cd_estabelecimento = estabelecimento
                              AND a.cd_setor_atendimento = setor
                              AND a.nr_trimestre = CASE 
                                                       WHEN quarter = 4
                                                       THEN 1 
                                                       WHEN quarter < 4
                                                       THEN quarter + 1
                                                   END
                          )
                         ) * 100
                        , 2) PR,
                        ROUND (
                         (
                          (
                           SELECT COUNT(a.dt_monitorizacao)
                             FROM w_low_tidal a
                            WHERE (a.qt_pplato IS NOT NULL AND a.qt_pplato::text <> '')
                              AND a.cd_estabelecimento = estabelecimento
                              AND a.cd_setor_atendimento = setor
                              AND a.nr_trimestre = CASE 
                                                       WHEN quarter > 2
                                                       THEN quarter - 2
                                                       ELSE quarter + 2
                                                   END
                          ) / (
                           SELECT SUM(a.qt_dias_ventilados)
                             FROM w_low_tidal_population a
                            WHERE a.cd_estabelecimento = estabelecimento
                              AND a.cd_setor_atendimento = setor
                              AND a.nr_trimestre = CASE 
                                                       WHEN quarter > 2
                                                       THEN quarter - 2
                                                       ELSE quarter + 2
                                                   END
                          )
                         ) * 100
                        , 2) SEG,
                        ROUND (
                         (
                          (
                           SELECT COUNT(a.dt_monitorizacao)
                             FROM w_low_tidal a
                            WHERE (a.qt_pplato IS NOT NULL AND a.qt_pplato::text <> '')
                              AND a.cd_estabelecimento = estabelecimento
                              AND a.cd_setor_atendimento = setor
                              AND a.nr_trimestre = CASE 
                                                       WHEN quarter > 1
                                                       THEN quarter - 1
                                                       ELSE 4
                                                   END
                          ) / (
                           SELECT SUM(a.qt_dias_ventilados)
                             FROM w_low_tidal_population a
                            WHERE a.cd_estabelecimento = estabelecimento
                              AND a.cd_setor_atendimento = setor
                              AND a.nr_trimestre = CASE 
                                                       WHEN quarter > 1
                                                       THEN quarter - 1
                                                       ELSE 4
                                                   END
                          )
                         ) * 100
                        , 2) TER,
                        ROUND (
                         (
                          (
                           SELECT COUNT(a.dt_monitorizacao)
                             FROM w_low_tidal a
                            WHERE (a.qt_pplato IS NOT NULL AND a.qt_pplato::text <> '')
                              AND a.cd_estabelecimento = estabelecimento
                              AND a.cd_setor_atendimento = setor
                              AND a.nr_trimestre = quarter
                          ) / (
                           SELECT SUM(a.qt_dias_ventilados)
                             FROM w_low_tidal_population a
                            WHERE a.cd_estabelecimento = estabelecimento
                              AND a.cd_setor_atendimento = setor
                              AND a.nr_trimestre = quarter
                          )
                         ) * 100
                        , 2) QUA,
                        ROUND (
                         (
                          (
                           SELECT COUNT(a.dt_monitorizacao)
                             FROM w_low_tidal a
                            WHERE (a.qt_pplato IS NOT NULL AND a.qt_pplato::text <> '')
                              AND a.nr_trimestre = quarter
                          ) / (
                           SELECT SUM(a.qt_dias_ventilados)
                             FROM w_low_tidal_population a
                            WHERE a.nr_trimestre = quarter
                          )
                         ) * 100
                        , 2) ALLEICU
                   
              ) a
          
UNION ALL

         SELECT '% of ventilator days with a documented ARDS Diagnosis' label,
                coalesce(pr, 0) pr,
                coalesce(seg, 0) seg,
                coalesce(ter, 0) ter,
                coalesce(qua, 0) qua,
                coalesce(alleicu, 0) alleicu
           FROM (
                 SELECT ROUND (
                         (
                          (
                           SELECT SUM(LEAST(coalesce(dt_fim_ards, LEAST(dtFim, clock_timestamp())), coalesce(dt_retirada, LEAST(dtFim, clock_timestamp()))) - GREATEST(dt_instalacao, dt_inicio_ards))
                             FROM w_low_tidal a
                            WHERE (a.qt_pplato IS NOT NULL AND a.qt_pplato::text <> '')
                              AND a.cd_estabelecimento = estabelecimento
                              AND a.cd_setor_atendimento = setor
                              AND a.nr_trimestre = CASE 
                                                       WHEN quarter = 4
                                                       THEN 1 
                                                       WHEN quarter < 4
                                                       THEN quarter + 1
                                                   END
                          ) / (
                           SELECT SUM(a.qt_dias_ventilados)
                             FROM w_low_tidal_population a
                            WHERE a.cd_estabelecimento = estabelecimento
                              AND a.cd_setor_atendimento = setor
                              AND a.nr_trimestre = CASE 
                                                       WHEN quarter = 4
                                                       THEN 1 
                                                       WHEN quarter < 4
                                                       THEN quarter + 1
                                                   END
                          )
                         ) * 100
                        , 2) PR,
                        ROUND (
                         (
                          (
                           SELECT SUM(LEAST(coalesce(dt_fim_ards, LEAST(dtFim, clock_timestamp())), coalesce(dt_retirada, LEAST(dtFim, clock_timestamp()))) - GREATEST(dt_instalacao, dt_inicio_ards))
                             FROM w_low_tidal a
                            WHERE (a.qt_pplato IS NOT NULL AND a.qt_pplato::text <> '')
                              AND a.cd_estabelecimento = estabelecimento
                              AND a.cd_setor_atendimento = setor
                              AND a.nr_trimestre = CASE 
                                                       WHEN quarter > 2
                                                       THEN quarter - 2
                                                       ELSE quarter + 2
                                                   END
                          ) / (
                           SELECT SUM(a.qt_dias_ventilados)
                             FROM w_low_tidal_population a
                            WHERE a.cd_estabelecimento = estabelecimento
                              AND a.cd_setor_atendimento = setor
                              AND a.nr_trimestre = CASE 
                                                       WHEN quarter > 2
                                                       THEN quarter - 2
                                                       ELSE quarter + 2
                                                   END
                          )
                         ) * 100
                        , 2) SEG,
                        ROUND (
                         (
                          (
                           SELECT SUM(LEAST(coalesce(dt_fim_ards, LEAST(dtFim, clock_timestamp())), coalesce(dt_retirada, LEAST(dtFim, clock_timestamp()))) - GREATEST(dt_instalacao, dt_inicio_ards))
                             FROM w_low_tidal a
                            WHERE (a.qt_pplato IS NOT NULL AND a.qt_pplato::text <> '')
                              AND a.cd_estabelecimento = estabelecimento
                              AND a.cd_setor_atendimento = setor
                              AND a.nr_trimestre = CASE 
                                                       WHEN quarter > 1
                                                       THEN quarter - 1
                                                       ELSE 4
                                                   END
                          ) / (
                           SELECT SUM(a.qt_dias_ventilados)
                             FROM w_low_tidal_population a
                            WHERE a.cd_estabelecimento = estabelecimento
                              AND a.cd_setor_atendimento = setor
                              AND a.nr_trimestre = CASE 
                                                       WHEN quarter > 1
                                                       THEN quarter - 1
                                                       ELSE 4
                                                   END
                          )
                         ) * 100
                        , 2) TER,
                        ROUND (
                         (
                          (
                           SELECT SUM(LEAST(coalesce(dt_fim_ards, LEAST(dtFim, clock_timestamp())), coalesce(dt_retirada, LEAST(dtFim, clock_timestamp()))) - GREATEST(dt_instalacao, dt_inicio_ards))
                             FROM w_low_tidal a
                            WHERE (a.qt_pplato IS NOT NULL AND a.qt_pplato::text <> '')
                              AND a.cd_estabelecimento = estabelecimento
                              AND a.cd_setor_atendimento = setor
                              AND a.nr_trimestre = quarter
                          ) / (
                           SELECT SUM(a.qt_dias_ventilados)
                             FROM w_low_tidal_population a
                            WHERE a.cd_estabelecimento = estabelecimento
                              AND a.cd_setor_atendimento = setor
                              AND a.nr_trimestre = quarter
                          )
                         ) * 100
                        , 2) QUA,
                        ROUND (
                         (
                          (
                           SELECT SUM(LEAST(coalesce(dt_fim_ards, LEAST(dtFim, clock_timestamp())), coalesce(dt_retirada, LEAST(dtFim, clock_timestamp()))) - GREATEST(dt_instalacao, dt_inicio_ards))
                             FROM w_low_tidal a
                            WHERE (a.qt_pplato IS NOT NULL AND a.qt_pplato::text <> '')
                              AND a.nr_trimestre = quarter
                          ) / (
                           SELECT SUM(a.qt_dias_ventilados)
                             FROM w_low_tidal_population a
                            WHERE a.nr_trimestre = quarter
                          )
                         ) * 100
                        , 2) ALLEICU
                   
              ) a
          
UNION ALL

         SELECT '% of ventilator days with a documented P/F Ratio' label,
                coalesce(pr, 0) pr,
                coalesce(seg, 0) seg,
                coalesce(ter, 0) ter,
                coalesce(qua, 0) qua,
                coalesce(alleicu, 0) alleicu
           FROM (
                 SELECT ROUND (
                         (
                          (
                           SELECT COUNT(a.dt_monitorizacao)
                             FROM w_low_tidal a
                            WHERE (a.qt_rel_pao2_fio2 IS NOT NULL AND a.qt_rel_pao2_fio2::text <> '')
                              AND a.cd_estabelecimento = estabelecimento
                              AND a.cd_setor_atendimento = setor
                              AND a.nr_trimestre = CASE 
                                                       WHEN quarter = 4
                                                       THEN 1 
                                                       WHEN quarter < 4
                                                       THEN quarter + 1
                                                   END
                          ) / (
                           SELECT SUM(a.qt_dias_ventilados)
                             FROM w_low_tidal_population a
                            WHERE a.cd_estabelecimento = estabelecimento
                              AND a.cd_setor_atendimento = setor
                              AND a.nr_trimestre = CASE 
                                                       WHEN quarter = 4
                                                       THEN 1 
                                                       WHEN quarter < 4
                                                       THEN quarter + 1
                                                   END
                          )
                         ) * 100
                        , 2) PR,
                        ROUND (
                         (
                          (
                           SELECT COUNT(a.dt_monitorizacao)
                             FROM w_low_tidal a
                            WHERE (a.qt_rel_pao2_fio2 IS NOT NULL AND a.qt_rel_pao2_fio2::text <> '')
                              AND a.cd_estabelecimento = estabelecimento
                              AND a.cd_setor_atendimento = setor
                              AND a.nr_trimestre = CASE 
                                                       WHEN quarter > 2
                                                       THEN quarter - 2
                                                       ELSE quarter + 2
                                                   END
                          ) / (
                           SELECT SUM(a.qt_dias_ventilados)
                             FROM w_low_tidal_population a
                            WHERE a.cd_estabelecimento = estabelecimento
                              AND a.cd_setor_atendimento = setor
                              AND a.nr_trimestre = CASE 
                                                       WHEN quarter > 2
                                                       THEN quarter - 2
                                                       ELSE quarter + 2
                                                   END
                          )
                         ) * 100
                        , 2) SEG,
                        ROUND (
                         (
                          (
                           SELECT COUNT(a.dt_monitorizacao)
                             FROM w_low_tidal a
                            WHERE (a.qt_rel_pao2_fio2 IS NOT NULL AND a.qt_rel_pao2_fio2::text <> '')
                              AND a.cd_estabelecimento = estabelecimento
                              AND a.cd_setor_atendimento = setor
                              AND a.nr_trimestre = CASE 
                                                       WHEN quarter > 1
                                                       THEN quarter - 1
                                                       ELSE 4
                                                   END
                          ) / (
                           SELECT SUM(a.qt_dias_ventilados)
                             FROM w_low_tidal_population a
                            WHERE a.cd_estabelecimento = estabelecimento
                              AND a.cd_setor_atendimento = setor
                              AND a.nr_trimestre = CASE 
                                                       WHEN quarter > 1
                                                       THEN quarter - 1
                                                       ELSE 4
                                                   END
                          )
                         ) * 100
                        , 2) TER,
                        ROUND (
                         (
                          (
                           SELECT COUNT(a.dt_monitorizacao)
                             FROM w_low_tidal a
                            WHERE (a.qt_rel_pao2_fio2 IS NOT NULL AND a.qt_rel_pao2_fio2::text <> '')
                              AND a.cd_estabelecimento = estabelecimento
                              AND a.cd_setor_atendimento = setor
                              AND a.nr_trimestre = quarter
                          ) / (
                           SELECT SUM(a.qt_dias_ventilados)
                             FROM w_low_tidal_population a
                            WHERE a.cd_estabelecimento = estabelecimento
                              AND a.cd_setor_atendimento = setor
                              AND a.nr_trimestre = quarter
                          )
                         ) * 100
                        , 2) QUA,
                        ROUND (
                         (
                          (
                           SELECT COUNT(a.dt_monitorizacao)
                             FROM w_low_tidal a
                            WHERE (a.qt_rel_pao2_fio2 IS NOT NULL AND a.qt_rel_pao2_fio2::text <> '')
                              AND a.nr_trimestre = quarter
                          ) / (
                           SELECT SUM(a.qt_dias_ventilados)
                             FROM w_low_tidal_population a
                            WHERE a.nr_trimestre = quarter
                          )
                         ) * 100
                        , 2) ALLEICU
                   
              ) a;


TYPE T_PCTS IS TABLE OF C_PCTS%ROWTYPE;
R_PCTS T_PCTS;

BEGIN
  OPEN C_PCTS;
  LOOP
    FETCH C_PCTS BULK COLLECT INTO R_PCTS LIMIT 1000;

      BEGIN
        FOR i IN R_PCTS.FIRST..R_PCTS.LAST LOOP
          RETURN NEXT R_PCTS(i);
        END LOOP;
      EXCEPTION WHEN OTHERS THEN
        NULL;
      END;

    EXIT WHEN NOT FOUND; /* apply on C_PCTS */

  END LOOP;
  CLOSE C_PCTS;

  RETURN;
END;
  --
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pkg_low_tidal.buscar_pcts_low_tidal ( setor bigint, estabelecimento bigint, quarter bigint, dtFim timestamp ) FROM PUBLIC;
