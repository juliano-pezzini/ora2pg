-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pkg_low_tidal.buscar_vent_vt_pp_low_tidal ( setor bigint, estabelecimento bigint, quarter bigint ) RETURNS SETOF TABLE_ANALIT_TYPE AS $body$
DECLARE


C_VENT_VT_PP CURSOR FOR
         SELECT 'Ventilator Days with Vt' label,
                coalesce(pr, 0) pr,
                coalesce(seg, 0) seg,
                coalesce(ter, 0) ter,
                coalesce(qua, 0) qua,
                coalesce(alleicu, 0) alleicu
           FROM (
                 SELECT (
                         SELECT COUNT(a.dt_monitorizacao)
                           FROM w_low_tidal a
                          WHERE (a.qt_vt IS NOT NULL AND a.qt_vt::text <> '')
                            AND a.cd_estabelecimento = estabelecimento
                            AND a.cd_setor_atendimento = setor
                            AND a.nr_trimestre = CASE
                                                     WHEN quarter = 4
                                                     THEN 1 
                                                     WHEN quarter < 4
                                                     THEN quarter + 1
                                                 END
                        ) PR,
                        (
                         SELECT COUNT(a.dt_monitorizacao)
                           FROM w_low_tidal a
                          WHERE (a.qt_vt IS NOT NULL AND a.qt_vt::text <> '')
                            AND a.cd_estabelecimento = estabelecimento
                            AND a.cd_setor_atendimento = setor
                            AND a.nr_trimestre = CASE 
                                                     WHEN quarter > 2
                                                     THEN quarter - 2
                                                     ELSE quarter + 2
                                                 END
                        ) SEG,
                        (
                         SELECT COUNT(a.dt_monitorizacao)
                           FROM w_low_tidal a
                          WHERE (a.qt_vt IS NOT NULL AND a.qt_vt::text <> '')
                            AND a.cd_estabelecimento = estabelecimento
                            AND a.cd_setor_atendimento = setor
                            AND a.nr_trimestre = CASE 
                                                     WHEN quarter > 1
                                                     THEN quarter - 1
                                                     ELSE 4
                                                 END
                        ) TER,
                        (
                         SELECT COUNT(a.dt_monitorizacao)
                           FROM w_low_tidal a
                          WHERE (a.qt_vt IS NOT NULL AND a.qt_vt::text <> '')
                            AND a.cd_estabelecimento = estabelecimento
                            AND a.cd_setor_atendimento = setor
                            AND a.nr_trimestre = quarter
                        ) QUA,
                        (
                         SELECT COUNT(a.dt_monitorizacao)
                           FROM w_low_tidal a
                          WHERE (a.qt_vt IS NOT NULL AND a.qt_vt::text <> '')
                            AND a.nr_trimestre = quarter
                        ) ALLEICU
                   
              ) a
          
UNION ALL

         SELECT '  Vt < 6.5 mls/kg(%)' label,
                coalesce(pr, 0) pr,
                coalesce(seg, 0) seg,
                coalesce(ter, 0) ter,
                coalesce(qua, 0) qua,
                coalesce(alleicu, 0) alleicu
           FROM (
                 SELECT ROUND (
                         (
                          (
                           SELECT COUNT(a.dt_monitorizacao)
                             FROM w_low_tidal a
                            WHERE (a.qt_vt IS NOT NULL AND a.qt_vt::text <> '')
                              AND a.qt_vt < 6.5
                              AND a.cd_estabelecimento = estabelecimento
                              AND a.cd_setor_atendimento = setor
                              AND a.nr_trimestre = CASE 
                                                       WHEN quarter = 4
                                                       THEN 1 
                                                       WHEN quarter < 4
                                                       THEN quarter + 1
                                                   END
                          ) / (
                           SELECT COUNT(a.dt_monitorizacao)
                             FROM w_low_tidal a
                            WHERE (a.qt_vt IS NOT NULL AND a.qt_vt::text <> '')
                              AND a.cd_estabelecimento = estabelecimento
                              AND a.cd_setor_atendimento = setor
                              AND a.nr_trimestre = CASE 
                                                       WHEN quarter = 4
                                                       THEN 1 
                                                       WHEN quarter < 4
                                                       THEN quarter + 1
                                                   END
                          )
                         )
                        , 2) PR,
                        ROUND (
                         (
                          (
                           SELECT COUNT(a.dt_monitorizacao)
                             FROM w_low_tidal a
                            WHERE (a.qt_vt IS NOT NULL AND a.qt_vt::text <> '')
                              AND a.qt_vt < 6.5
                              AND a.cd_estabelecimento = estabelecimento
                              AND a.cd_setor_atendimento = setor
                              AND a.nr_trimestre = CASE 
                                                       WHEN quarter > 2
                                                       THEN quarter - 2
                                                       ELSE quarter + 2
                                                   END
                          ) / (
                           SELECT COUNT(a.dt_monitorizacao)
                             FROM w_low_tidal a
                            WHERE (a.qt_vt IS NOT NULL AND a.qt_vt::text <> '')
                              AND a.cd_estabelecimento = estabelecimento
                              AND a.cd_setor_atendimento = setor
                              AND a.nr_trimestre = CASE 
                                                       WHEN quarter > 2
                                                       THEN quarter - 2
                                                       ELSE quarter + 2
                                                   END
                          )
                         )
                        , 2) SEG,
                        ROUND (
                         (
                          (
                           SELECT COUNT(a.dt_monitorizacao)
                             FROM w_low_tidal a
                            WHERE (a.qt_vt IS NOT NULL AND a.qt_vt::text <> '')
                              AND a.qt_vt < 6.5
                              AND a.cd_estabelecimento = estabelecimento
                              AND a.cd_setor_atendimento = setor
                              AND a.nr_trimestre = CASE 
                                                       WHEN quarter > 1
                                                       THEN quarter - 1
                                                       ELSE 4
                                                   END
                          ) / (
                           SELECT COUNT(a.dt_monitorizacao)
                             FROM w_low_tidal a
                            WHERE (a.qt_vt IS NOT NULL AND a.qt_vt::text <> '')
                              AND a.cd_estabelecimento = estabelecimento
                              AND a.cd_setor_atendimento = setor
                              AND a.nr_trimestre = CASE 
                                                       WHEN quarter > 1
                                                       THEN quarter - 1
                                                       ELSE 4
                                                   END
                          )
                         )
                        , 2) TER,
                        ROUND (
                         (
                          (
                           SELECT COUNT(a.dt_monitorizacao)
                             FROM w_low_tidal a
                            WHERE (a.qt_vt IS NOT NULL AND a.qt_vt::text <> '')
                              AND a.qt_vt < 6.5
                              AND a.cd_estabelecimento = estabelecimento
                              AND a.cd_setor_atendimento = setor
                              AND a.nr_trimestre = quarter
                          ) / (
                           SELECT COUNT(a.dt_monitorizacao)
                             FROM w_low_tidal a
                            WHERE (a.qt_vt IS NOT NULL AND a.qt_vt::text <> '')
                              AND a.cd_estabelecimento = estabelecimento
                              AND a.cd_setor_atendimento = setor
                              AND a.nr_trimestre = quarter
                          )
                         )
                        , 2) QUA,
                        ROUND (
                         (
                          (
                           SELECT COUNT(a.dt_monitorizacao)
                             FROM w_low_tidal a
                            WHERE (a.qt_vt IS NOT NULL AND a.qt_vt::text <> '')
                              AND a.qt_vt < 6.5
                              AND a.nr_trimestre = quarter
                          ) / (
                           SELECT COUNT(a.dt_monitorizacao)
                             FROM w_low_tidal a
                            WHERE (a.qt_vt IS NOT NULL AND a.qt_vt::text <> '')
                              AND a.nr_trimestre = quarter
                          )
                         )
                        , 2) ALLEICU
                   
              ) a
          
UNION ALL

         SELECT '  Vt 6.5 - 8 mls/kg(%)' label,
                coalesce(pr, 0) pr,
                coalesce(seg, 0) seg,
                coalesce(ter, 0) ter,
                coalesce(qua, 0) qua,
                coalesce(alleicu, 0) alleicu
           FROM (
                 SELECT ROUND (
                         (
                          (
                           SELECT COUNT(a.dt_monitorizacao)
                             FROM w_low_tidal a
                            WHERE (a.qt_vt IS NOT NULL AND a.qt_vt::text <> '')
                              AND a.qt_vt BETWEEN 6.5 AND 8
                              AND a.cd_estabelecimento = estabelecimento
                              AND a.cd_setor_atendimento = setor
                              AND a.nr_trimestre = CASE 
                                                       WHEN quarter = 4
                                                       THEN 1 
                                                       WHEN quarter < 4
                                                       THEN quarter + 1
                                                   END
                          ) / (
                           SELECT COUNT(a.dt_monitorizacao)
                             FROM w_low_tidal a
                            WHERE (a.qt_vt IS NOT NULL AND a.qt_vt::text <> '')
                              AND a.cd_estabelecimento = estabelecimento
                              AND a.cd_setor_atendimento = setor
                              AND a.nr_trimestre = CASE 
                                                       WHEN quarter = 4
                                                       THEN 1 
                                                       WHEN quarter < 4
                                                       THEN quarter + 1
                                                   END
                          )
                         )
                        , 2) PR,
                        ROUND (
                         (
                          (
                           SELECT COUNT(a.dt_monitorizacao)
                             FROM w_low_tidal a
                            WHERE (a.qt_vt IS NOT NULL AND a.qt_vt::text <> '')
                              AND a.qt_vt BETWEEN 6.5 AND 8
                              AND a.cd_estabelecimento = estabelecimento
                              AND a.cd_setor_atendimento = setor
                              AND a.nr_trimestre = CASE 
                                                       WHEN quarter > 2
                                                       THEN quarter - 2
                                                       ELSE quarter + 2
                                                   END
                         ) / (
                           SELECT COUNT(a.dt_monitorizacao)
                             FROM w_low_tidal a
                            WHERE (a.qt_vt IS NOT NULL AND a.qt_vt::text <> '')
                              AND a.cd_estabelecimento = estabelecimento
                              AND a.cd_setor_atendimento = setor
                              AND a.nr_trimestre = CASE 
                                                       WHEN quarter > 2
                                                       THEN quarter - 2
                                                       ELSE quarter + 2
                                                   END
                          )
                         )
                        , 2) SEG,
                        ROUND (
                         (
                          (
                           SELECT COUNT(a.dt_monitorizacao)
                             FROM w_low_tidal a
                            WHERE (a.qt_vt IS NOT NULL AND a.qt_vt::text <> '')
                              AND a.qt_vt BETWEEN 6.5 AND 8
                              AND a.cd_estabelecimento = estabelecimento
                              AND a.cd_setor_atendimento = setor
                              AND a.nr_trimestre = CASE 
                                                       WHEN quarter > 1
                                                       THEN quarter - 1
                                                       ELSE 4
                                                   END
                          ) / (
                           SELECT COUNT(a.dt_monitorizacao)
                             FROM w_low_tidal a
                            WHERE (a.qt_vt IS NOT NULL AND a.qt_vt::text <> '')
                              AND a.cd_estabelecimento = estabelecimento
                              AND a.cd_setor_atendimento = setor
                              AND a.nr_trimestre = CASE 
                                                       WHEN quarter > 1
                                                       THEN quarter - 1
                                                       ELSE 4
                                                   END
                          )
                         )
                        , 2) TER,
                        ROUND (
                         (
                          (
                           SELECT COUNT(a.dt_monitorizacao)
                             FROM w_low_tidal a
                            WHERE (a.qt_vt IS NOT NULL AND a.qt_vt::text <> '')
                              AND a.qt_vt BETWEEN 6.5 AND 8
                              AND a.cd_estabelecimento = estabelecimento
                              AND a.cd_setor_atendimento = setor
                              AND a.nr_trimestre = quarter
                          ) / (
                           SELECT COUNT(a.dt_monitorizacao)
                             FROM w_low_tidal a
                            WHERE (a.qt_vt IS NOT NULL AND a.qt_vt::text <> '')
                              AND a.cd_estabelecimento = estabelecimento
                              AND a.cd_setor_atendimento = setor
                              AND a.nr_trimestre = quarter
                          )
                         )
                        , 2) QUA,
                        ROUND (
                         (
                          (
                           SELECT COUNT(a.dt_monitorizacao)
                             FROM w_low_tidal a
                            WHERE (a.qt_vt IS NOT NULL AND a.qt_vt::text <> '')
                              AND a.qt_vt BETWEEN 6.5 AND 8
                              AND a.nr_trimestre = quarter
                          ) / (
                           SELECT COUNT(a.dt_monitorizacao)
                             FROM w_low_tidal a
                            WHERE (a.qt_vt IS NOT NULL AND a.qt_vt::text <> '')
                              AND a.nr_trimestre = quarter
                          )
                         )
                        , 2) ALLEICU
                   
              ) a
          
UNION ALL

         SELECT '  Vt > 8 mls/kg(%)' label,
                coalesce(pr, 0) pr,
                coalesce(seg, 0) seg,
                coalesce(ter, 0) ter,
                coalesce(qua, 0) qua,
                coalesce(alleicu, 0) alleicu
           FROM (
                 SELECT ROUND (
                         (
                          (
                           SELECT COUNT(a.dt_monitorizacao)
                             FROM w_low_tidal a
                            WHERE (a.qt_vt IS NOT NULL AND a.qt_vt::text <> '')
                              AND a.qt_vt > 8
                              AND a.cd_estabelecimento = estabelecimento
                              AND a.cd_setor_atendimento = setor
                              AND a.nr_trimestre = CASE 
                                                       WHEN quarter = 4
                                                       THEN 1 
                                                       WHEN quarter < 4
                                                       THEN quarter + 1
                                                   END
                          ) / (
                           SELECT COUNT(a.dt_monitorizacao)
                             FROM w_low_tidal a
                            WHERE (a.qt_vt IS NOT NULL AND a.qt_vt::text <> '')
                              AND a.cd_estabelecimento = estabelecimento
                              AND a.cd_setor_atendimento = setor
                              AND a.nr_trimestre = CASE 
                                                       WHEN quarter = 4
                                                       THEN 1 
                                                       WHEN quarter < 4
                                                       THEN quarter + 1
                                                   END
                          )
                         )
                        , 2) PR,
                        ROUND (
                         (
                          (
                           SELECT COUNT(a.dt_monitorizacao)
                             FROM w_low_tidal a
                            WHERE (a.qt_vt IS NOT NULL AND a.qt_vt::text <> '')
                              AND a.qt_vt > 8
                              AND a.cd_estabelecimento = estabelecimento
                              AND a.cd_setor_atendimento = setor
                              AND a.nr_trimestre = CASE 
                                                       WHEN quarter > 2
                                                       THEN quarter - 2
                                                       ELSE quarter + 2
                                                   END
                          ) / (
                           SELECT COUNT(a.dt_monitorizacao)
                             FROM w_low_tidal a
                            WHERE (a.qt_vt IS NOT NULL AND a.qt_vt::text <> '')
                              AND a.cd_estabelecimento = estabelecimento
                              AND a.cd_setor_atendimento = setor
                              AND a.nr_trimestre = CASE 
                                                       WHEN quarter > 2
                                                       THEN quarter - 2
                                                       ELSE quarter + 2
                                                   END
                          )
                         )
                        , 2) SEG,
                        ROUND (
                         (
                          (
                           SELECT COUNT(a.dt_monitorizacao)
                             FROM w_low_tidal a
                            WHERE (a.qt_vt IS NOT NULL AND a.qt_vt::text <> '')
                              AND a.qt_vt > 8
                              AND a.cd_estabelecimento = estabelecimento
                              AND a.cd_setor_atendimento = setor
                              AND a.nr_trimestre = CASE 
                                                       WHEN quarter > 1
                                                       THEN quarter - 1
                                                       ELSE 4
                                                   END
                          ) / (
                           SELECT COUNT(a.dt_monitorizacao)
                             FROM w_low_tidal a
                            WHERE (a.qt_vt IS NOT NULL AND a.qt_vt::text <> '')
                              AND a.cd_estabelecimento = estabelecimento
                              AND a.cd_setor_atendimento = setor
                              AND a.nr_trimestre = CASE 
                                                       WHEN quarter > 1
                                                       THEN quarter - 1
                                                       ELSE 4
                                                   END
                          )
                         )
                        , 2) TER,
                        ROUND (
                         (
                          (
                           SELECT COUNT(a.dt_monitorizacao)
                             FROM w_low_tidal a
                            WHERE (a.qt_vt IS NOT NULL AND a.qt_vt::text <> '')
                              AND a.qt_vt > 8
                              AND a.cd_estabelecimento = estabelecimento
                              AND a.cd_setor_atendimento = setor
                              AND a.nr_trimestre = quarter
                          ) / (
                           SELECT COUNT(a.dt_monitorizacao)
                             FROM w_low_tidal a
                            WHERE (a.qt_vt IS NOT NULL AND a.qt_vt::text <> '')
                              AND a.cd_estabelecimento = estabelecimento
                              AND a.cd_setor_atendimento = setor
                              AND a.nr_trimestre = quarter
                          )
                         )
                        , 2) QUA,
                        ROUND (
                         (
                          (
                           SELECT COUNT(a.dt_monitorizacao)
                             FROM w_low_tidal a
                            WHERE (a.qt_vt IS NOT NULL AND a.qt_vt::text <> '')
                              AND a.qt_vt > 8
                              AND a.nr_trimestre = quarter
                          ) / (
                           SELECT COUNT(a.dt_monitorizacao)
                             FROM w_low_tidal a
                            WHERE (a.qt_vt IS NOT NULL AND a.qt_vt::text <> '')
                              AND a.nr_trimestre = quarter
                          )
                         )
                        , 2) ALLEICU
                   
              ) a
          
UNION ALL

         SELECT 'Ventilator Days with Plateau Pressures' label,
                coalesce(pr, 0) pr,
                coalesce(seg, 0) seg,
                coalesce(ter, 0) ter,
                coalesce(qua, 0) qua,
                coalesce(alleicu, 0) alleicu
           FROM (
                 SELECT (
                         SELECT COUNT(a.dt_monitorizacao)
                           FROM w_low_tidal a
                          WHERE (a.qt_pplato IS NOT NULL AND a.qt_pplato::text <> '')
                            AND a.cd_estabelecimento = estabelecimento
                            AND a.cd_setor_atendimento = setor
                            AND a.nr_trimestre = CASE 
                                                     WHEN quarter = 4
                                                     THEN 1 
                                                     WHEN quarter < 4
                                                     THEN quarter + 1
                                                 END
                        ) PR,
                        (
                         SELECT COUNT(a.dt_monitorizacao)
                           FROM w_low_tidal a
                          WHERE (a.qt_pplato IS NOT NULL AND a.qt_pplato::text <> '')
                            AND a.cd_estabelecimento = estabelecimento
                            AND a.cd_setor_atendimento = setor
                            AND a.nr_trimestre = CASE 
                                                     WHEN quarter > 2
                                                     THEN quarter - 2
                                                     ELSE quarter + 2
                                                 END
                        ) SEG,
                        (
                         SELECT COUNT(a.dt_monitorizacao)
                           FROM w_low_tidal a
                          WHERE (a.qt_pplato IS NOT NULL AND a.qt_pplato::text <> '')
                            AND a.cd_estabelecimento = estabelecimento
                            AND a.cd_setor_atendimento = setor
                            AND a.nr_trimestre = CASE 
                                                     WHEN quarter > 1
                                                     THEN quarter - 1
                                                     ELSE 4
                                                 END
                        ) TER,
                        (
                         SELECT COUNT(a.dt_monitorizacao)
                           FROM w_low_tidal a
                          WHERE (a.qt_pplato IS NOT NULL AND a.qt_pplato::text <> '')
                            AND a.cd_estabelecimento = estabelecimento
                            AND a.cd_setor_atendimento = setor
                            AND a.nr_trimestre = quarter
                        ) QUA,
                        (
                         SELECT COUNT(a.dt_monitorizacao)
                           FROM w_low_tidal a
                          WHERE (a.qt_pplato IS NOT NULL AND a.qt_pplato::text <> '')
                            AND a.nr_trimestre = quarter
                        ) ALLEICU
                   
              ) a
          
UNION ALL

         SELECT '  Plateau Pressure <= 30(%)' label,
                coalesce(pr, 0) pr,
                coalesce(seg, 0) seg,
                coalesce(ter, 0) ter,
                coalesce(qua, 0) qua,
                coalesce(alleicu, 0) alleicu
           FROM (
                 SELECT ROUND (
                         (
                          (
                           SELECT COUNT(a.dt_monitorizacao)
                             FROM w_low_tidal a
                            WHERE (a.qt_pplato IS NOT NULL AND a.qt_pplato::text <> '')
                              AND a.qt_pplato <= 30
                              AND a.cd_estabelecimento = estabelecimento
                              AND a.cd_setor_atendimento = setor
                              AND a.nr_trimestre = CASE 
                                                       WHEN quarter = 4
                                                       THEN 1 
                                                       WHEN quarter < 4
                                                       THEN quarter + 1
                                                   END
                          ) / (
                           SELECT COUNT(a.dt_monitorizacao)
                             FROM w_low_tidal a
                            WHERE (a.qt_pplato IS NOT NULL AND a.qt_pplato::text <> '')
                              AND a.cd_estabelecimento = estabelecimento
                              AND a.cd_setor_atendimento = setor
                              AND a.nr_trimestre = CASE 
                                                       WHEN quarter = 4
                                                       THEN 1 
                                                       WHEN quarter < 4
                                                       THEN quarter + 1
                                                   END
                          )
                         )
                        , 2) PR,
                        ROUND (
                         (
                          (
                           SELECT COUNT(a.dt_monitorizacao)
                             FROM w_low_tidal a
                            WHERE (a.qt_pplato IS NOT NULL AND a.qt_pplato::text <> '')
                              AND a.qt_pplato <= 30
                              AND a.cd_estabelecimento = estabelecimento
                              AND a.cd_setor_atendimento = setor
                              AND a.nr_trimestre = CASE 
                                                       WHEN quarter > 2
                                                       THEN quarter - 2
                                                       ELSE quarter + 2
                                                   END
                          ) / (
                           SELECT COUNT(a.dt_monitorizacao)
                             FROM w_low_tidal a
                            WHERE (a.qt_pplato IS NOT NULL AND a.qt_pplato::text <> '')
                              AND a.cd_estabelecimento = estabelecimento
                              AND a.cd_setor_atendimento = setor
                              AND a.nr_trimestre = CASE 
                                                       WHEN quarter > 2
                                                       THEN quarter - 2
                                                       ELSE quarter + 2
                                                   END
                          )
                         )
                        , 2) SEG,
                        ROUND (
                         (
                          (
                           SELECT COUNT(a.dt_monitorizacao)
                             FROM w_low_tidal a
                            WHERE (a.qt_pplato IS NOT NULL AND a.qt_pplato::text <> '')
                              AND a.qt_pplato <= 30
                              AND a.cd_estabelecimento = estabelecimento
                              AND a.cd_setor_atendimento = setor
                              AND a.nr_trimestre = CASE 
                                                       WHEN quarter > 1
                                                       THEN quarter - 1
                                                       ELSE 4
                                                   END
                          ) / (
                           SELECT COUNT(a.dt_monitorizacao)
                             FROM w_low_tidal a
                            WHERE (a.qt_pplato IS NOT NULL AND a.qt_pplato::text <> '')
                              AND a.cd_estabelecimento = estabelecimento
                              AND a.cd_setor_atendimento = setor
                              AND a.nr_trimestre = CASE 
                                                       WHEN quarter > 1
                                                       THEN quarter - 1
                                                       ELSE 4
                                                   END
                          )
                         )
                        , 2) TER,
                        ROUND (
                         (
                          (
                           SELECT COUNT(a.dt_monitorizacao)
                             FROM w_low_tidal a
                            WHERE (a.qt_pplato IS NOT NULL AND a.qt_pplato::text <> '')
                              AND a.qt_pplato <= 30
                              AND a.cd_estabelecimento = estabelecimento
                              AND a.cd_setor_atendimento = setor
                              AND a.nr_trimestre = quarter
                          ) / (
                           SELECT COUNT(a.dt_monitorizacao)
                             FROM w_low_tidal a
                            WHERE (a.qt_pplato IS NOT NULL AND a.qt_pplato::text <> '')
                              AND a.cd_estabelecimento = estabelecimento
                              AND a.cd_setor_atendimento = setor
                              AND a.nr_trimestre = quarter
                          )
                         )
                        , 2) QUA,
                        ROUND (
                         (
                          (
                           SELECT COUNT(a.dt_monitorizacao)
                             FROM w_low_tidal a
                            WHERE (a.qt_pplato IS NOT NULL AND a.qt_pplato::text <> '')
                              AND a.qt_pplato <= 30
                              AND a.nr_trimestre = quarter
                          ) / (
                           SELECT COUNT(a.dt_monitorizacao)
                             FROM w_low_tidal a
                            WHERE (a.qt_pplato IS NOT NULL AND a.qt_pplato::text <> '')
                              AND a.nr_trimestre = quarter
                          )
                         )
                        , 2) ALLEICU
                   
              ) a
          
UNION ALL

         SELECT '  Plateau Pressure > 30(%)' label,
                coalesce(pr, 0) pr,
                coalesce(seg, 0) seg,
                coalesce(ter, 0) ter,
                coalesce(qua, 0) qua,
                coalesce(alleicu, 0) alleicu
           FROM (
                 SELECT ROUND (
                         (
                          (
                           SELECT COUNT(a.dt_monitorizacao)
                             FROM w_low_tidal a
                            WHERE (a.qt_pplato IS NOT NULL AND a.qt_pplato::text <> '')
                              AND a.qt_pplato > 30
                              AND a.cd_estabelecimento = estabelecimento
                              AND a.cd_setor_atendimento = setor
                              AND a.nr_trimestre = CASE 
                                                       WHEN quarter = 4
                                                       THEN 1 
                                                       WHEN quarter < 4
                                                       THEN quarter + 1
                                                   END
                          ) / (
                           SELECT COUNT(a.dt_monitorizacao)
                             FROM w_low_tidal a
                            WHERE (a.qt_pplato IS NOT NULL AND a.qt_pplato::text <> '')
                              AND a.cd_estabelecimento = estabelecimento
                              AND a.cd_setor_atendimento = setor
                              AND a.nr_trimestre = CASE 
                                                       WHEN quarter = 4
                                                       THEN 1 
                                                       WHEN quarter < 4
                                                       THEN quarter + 1
                                                   END
                          )
                         )
                        , 2) PR,
                        ROUND (
                         (
                          (
                           SELECT COUNT(a.dt_monitorizacao)
                             FROM w_low_tidal a
                            WHERE (a.qt_pplato IS NOT NULL AND a.qt_pplato::text <> '')
                              AND a.qt_pplato > 30
                              AND a.cd_estabelecimento = estabelecimento
                              AND a.cd_setor_atendimento = setor
                              AND a.nr_trimestre = CASE 
                                                       WHEN quarter > 2
                                                       THEN quarter - 2
                                                       ELSE quarter + 2
                                                   END
                          ) / (
                           SELECT COUNT(a.dt_monitorizacao)
                             FROM w_low_tidal a
                            WHERE (a.qt_pplato IS NOT NULL AND a.qt_pplato::text <> '')
                              AND a.cd_estabelecimento = estabelecimento
                              AND a.cd_setor_atendimento = setor
                              AND a.nr_trimestre = CASE 
                                                       WHEN quarter > 2
                                                       THEN quarter - 2
                                                       ELSE quarter + 2
                                                   END
                          )
                         )
                        , 2) SEG,
                        ROUND (
                         (
                          (
                           SELECT COUNT(a.dt_monitorizacao)
                             FROM w_low_tidal a
                            WHERE (a.qt_pplato IS NOT NULL AND a.qt_pplato::text <> '')
                              AND a.qt_pplato > 30
                              AND a.cd_estabelecimento = estabelecimento
                              AND a.cd_setor_atendimento = setor
                              AND a.nr_trimestre = CASE 
                                                       WHEN quarter > 1
                                                       THEN quarter - 1
                                                       ELSE 4
                                                   END
                          ) / (
                           SELECT COUNT(a.dt_monitorizacao)
                             FROM w_low_tidal a
                            WHERE (a.qt_pplato IS NOT NULL AND a.qt_pplato::text <> '')
                              AND a.cd_estabelecimento = estabelecimento
                              AND a.cd_setor_atendimento = setor
                              AND a.nr_trimestre = CASE 
                                                       WHEN quarter > 1
                                                       THEN quarter - 1
                                                       ELSE 4
                                                   END
                          )
                         )
                        , 2) TER,
                        ROUND (
                         (
                          (
                           SELECT COUNT(a.dt_monitorizacao)
                             FROM w_low_tidal a
                            WHERE (a.qt_pplato IS NOT NULL AND a.qt_pplato::text <> '')
                              AND a.qt_pplato > 30
                              AND a.cd_estabelecimento = estabelecimento
                              AND a.cd_setor_atendimento = setor
                              AND a.nr_trimestre = quarter
                          ) / (
                           SELECT COUNT(a.dt_monitorizacao)
                             FROM w_low_tidal a
                            WHERE (a.qt_pplato IS NOT NULL AND a.qt_pplato::text <> '')
                              AND a.cd_estabelecimento = estabelecimento
                              AND a.cd_setor_atendimento = setor
                              AND a.nr_trimestre = quarter
                          )
                         )
                        , 2) QUA,
                        ROUND (
                         (
                          (
                           SELECT COUNT(a.dt_monitorizacao)
                             FROM w_low_tidal a
                            WHERE (a.qt_pplato IS NOT NULL AND a.qt_pplato::text <> '')
                              AND a.qt_pplato > 30
                              AND a.nr_trimestre = quarter
                          ) / (
                           SELECT COUNT(a.dt_monitorizacao)
                             FROM w_low_tidal a
                            WHERE (a.qt_pplato IS NOT NULL AND a.qt_pplato::text <> '')
                              AND a.nr_trimestre = quarter
                          )
                         )
                        , 2) ALLEICU
                   
              ) a;


TYPE T_VENT_VT_PP IS TABLE OF C_VENT_VT_PP%ROWTYPE;
R_VENT_VT_PP T_VENT_VT_PP;

BEGIN
  OPEN C_VENT_VT_PP;
  LOOP
    FETCH C_VENT_VT_PP BULK COLLECT INTO R_VENT_VT_PP LIMIT 1000;

      BEGIN
        FOR i IN R_VENT_VT_PP.FIRST..R_VENT_VT_PP.LAST LOOP
          RETURN NEXT R_VENT_VT_PP(i);
        END LOOP;
      EXCEPTION WHEN OTHERS THEN
        NULL;
      END;

    EXIT WHEN NOT FOUND; /* apply on C_VENT_VT_PP */

  END LOOP;
  CLOSE C_VENT_VT_PP;

  RETURN;
END;
  --
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pkg_low_tidal.buscar_vent_vt_pp_low_tidal ( setor bigint, estabelecimento bigint, quarter bigint ) FROM PUBLIC;
