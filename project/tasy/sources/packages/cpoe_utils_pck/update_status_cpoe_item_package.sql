-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE cpoe_utils_pck.update_status_cpoe_item (list_itens_p text) AS $body$
BEGIN
        if (obter_funcao_ativa = 281) then
            PERFORM set_config('cpoe_utils_pck.ds_items_w', list_itens_p, false);
            cpoe_shoppingcart(current_setting('cpoe_utils_pck.ds_items_w')::varchar(4000), 'N');

            while(current_setting('cpoe_utils_pck.ds_items_w')::(varchar(4000) IS NOT NULL AND (varchar(4000))::text <> '') and position(';' in current_setting('cpoe_utils_pck.ds_items_w')::varchar(4000)) > 0) loop
                PERFORM set_config('cpoe_utils_pck.ds_item_w', substr(current_setting('cpoe_utils_pck.ds_items_w')::varchar(4000), 1, position(';' in current_setting('cpoe_utils_pck.ds_items_w')::varchar(4000)) - 1), false);
                PERFORM set_config('cpoe_utils_pck.nr_seq_item_w', (substr(current_setting('cpoe_utils_pck.ds_item_w')::varchar(4000), 1, position(',' in current_setting('cpoe_utils_pck.ds_item_w')::varchar(4000)) - 1))::numeric , false);

                if (substr(current_setting('cpoe_utils_pck.ds_item_w')::varchar(4000), position(',' in current_setting('cpoe_utils_pck.ds_item_w')::varchar(4000)) + 1, 2) = 'MA' or substr(current_setting('cpoe_utils_pck.ds_item_w')::varchar(4000), position(',' in current_setting('cpoe_utils_pck.ds_item_w')::varchar(4000)) + 1, 2) = 'AP'
					or substr(current_setting('cpoe_utils_pck.ds_item_w')::varchar(4000), position(',' in current_setting('cpoe_utils_pck.ds_item_w')::varchar(4000)) + 1, 2) = 'DI') then
                    PERFORM set_config('cpoe_utils_pck.ie_tipo_item_w', substr(current_setting('cpoe_utils_pck.ds_item_w')::varchar(4000), position(',' in current_setting('cpoe_utils_pck.ds_item_w')::varchar(4000)) + 1, 2), false);
                else
                    PERFORM set_config('cpoe_utils_pck.ie_tipo_item_w', substr(current_setting('cpoe_utils_pck.ds_item_w')::varchar(4000), position(',' in current_setting('cpoe_utils_pck.ds_item_w')::varchar(4000)) + 1, 1), false);
                end if;

                if(current_setting('cpoe_utils_pck.ie_tipo_item_w')::varchar(30) = ('MA') or current_setting('cpoe_utils_pck.ie_tipo_item_w')::varchar(30) = ('AP') or current_setting('cpoe_utils_pck.ie_tipo_item_w')::varchar(30) = ('DI')) then
                    PERFORM set_config('cpoe_utils_pck.ie_item_valido_w', substr(current_setting('cpoe_utils_pck.ds_item_w')::varchar(4000), position(',' in current_setting('cpoe_utils_pck.ds_item_w')::varchar(4000)) + 4, 1), false);
                else
                    PERFORM set_config('cpoe_utils_pck.ie_item_valido_w', substr(current_setting('cpoe_utils_pck.ds_item_w')::varchar(4000), position(',' in current_setting('cpoe_utils_pck.ds_item_w')::varchar(4000)) + 3, 1), false);
                end if;

                PERFORM set_config('cpoe_utils_pck.ds_items_w', substr(current_setting('cpoe_utils_pck.ds_items_w')::varchar(4000), position(';' in current_setting('cpoe_utils_pck.ds_items_w')::varchar(4000)) + 1, length(current_setting('cpoe_utils_pck.ds_items_w')::varchar(4000))), false);

                if (current_setting('cpoe_utils_pck.ie_tipo_item_w')::varchar(30) = 'N') then /*Nutrition*/
                    EXECUTE 'UPDATE CPOE_DIETA SET ie_item_valido = :v2 WHERE nr_sequencia = :v3'
                    USING current_setting('cpoe_utils_pck.ie_item_valido_w')::varchar(1), current_setting('cpoe_utils_pck.nr_seq_item_w')::bigint;
                elsif (current_setting('cpoe_utils_pck.ie_tipo_item_w')::varchar(30) = 'M') then /*Medicine*/
                    EXECUTE 'UPDATE CPOE_MATERIAL SET ie_item_valido = :v2 WHERE nr_sequencia = :v3'
                    USING current_setting('cpoe_utils_pck.ie_item_valido_w')::varchar(1), current_setting('cpoe_utils_pck.nr_seq_item_w')::bigint;
                elsif (current_setting('cpoe_utils_pck.ie_tipo_item_w')::varchar(30) = 'DI') then /*Dialysis*/
                    EXECUTE 'UPDATE CPOE_DIALISE SET ie_item_valido = :v2 WHERE nr_sequencia = :v3'
                    USING current_setting('cpoe_utils_pck.ie_item_valido_w')::varchar(1), current_setting('cpoe_utils_pck.nr_seq_item_w')::bigint;
                elsif (current_setting('cpoe_utils_pck.ie_tipo_item_w')::varchar(30) = 'P') then /*Procedure*/
                    EXECUTE 'UPDATE CPOE_PROCEDIMENTO SET ie_item_valido = :v2 WHERE nr_sequencia = :v3'
                    USING current_setting('cpoe_utils_pck.ie_item_valido_w')::varchar(1), current_setting('cpoe_utils_pck.nr_seq_item_w')::bigint;
                elsif (current_setting('cpoe_utils_pck.ie_tipo_item_w')::varchar(30) = 'G') then /*Gas therapy*/
                    EXECUTE 'UPDATE CPOE_GASOTERAPIA SET ie_item_valido = :v2 WHERE nr_sequencia = :v3'
                    USING current_setting('cpoe_utils_pck.ie_item_valido_w')::varchar(1), current_setting('cpoe_utils_pck.nr_seq_item_w')::bigint;
                elsif (current_setting('cpoe_utils_pck.ie_tipo_item_w')::varchar(30) = 'R') then /*Recomendation*/
                    EXECUTE 'UPDATE CPOE_RECOMENDACAO SET ie_item_valido = :v2 WHERE nr_sequencia = :v3'
                    USING current_setting('cpoe_utils_pck.ie_item_valido_w')::varchar(1), current_setting('cpoe_utils_pck.nr_seq_item_w')::bigint;
                elsif (current_setting('cpoe_utils_pck.ie_tipo_item_w')::varchar(30) = 'H') then /*Hemotherapy*/
                    EXECUTE 'UPDATE CPOE_HEMOTERAPIA SET ie_item_valido = :v2 WHERE nr_sequencia = :v3'
                    USING current_setting('cpoe_utils_pck.ie_item_valido_w')::varchar(1), current_setting('cpoe_utils_pck.nr_seq_item_w')::bigint;
                elsif (current_setting('cpoe_utils_pck.ie_tipo_item_w')::varchar(30) = 'MA') then /*Material*/
                    EXECUTE 'UPDATE CPOE_MATERIAL SET ie_item_valido = :v2 WHERE nr_sequencia = :v3'
                    USING current_setting('cpoe_utils_pck.ie_item_valido_w')::varchar(1), current_setting('cpoe_utils_pck.nr_seq_item_w')::bigint;
                elsif (current_setting('cpoe_utils_pck.ie_tipo_item_w')::varchar(30) = 'AP') then
                    EXECUTE 'UPDATE CPOE_ANATOMIA_PATOLOGICA SET ie_item_valido = :v2 WHERE nr_sequencia = :v3'
                    USING current_setting('cpoe_utils_pck.ie_item_valido_w')::varchar(1), current_setting('cpoe_utils_pck.nr_seq_item_w')::bigint;
                end if;

            if (current_setting('cpoe_utils_pck.ie_item_inconsistente_w')::coalesce(varchar(1)::text, '') = '') then
                if current_setting('cpoe_utils_pck.ie_item_valido_w')::varchar(1) = 'N' then
                    PERFORM set_config('cpoe_utils_pck.ie_item_inconsistente_w', 'S', false);
                end if;
            end if;
            end loop;
        end if;
    end;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_utils_pck.update_status_cpoe_item (list_itens_p text) FROM PUBLIC;
