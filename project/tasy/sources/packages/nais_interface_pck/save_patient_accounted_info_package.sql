-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE nais_interface_pck.save_patient_accounted_info ( file_data_p text, status_p INOUT text) AS $body$
DECLARE


	nr_counter_w	 smallint;
	cd_person_w      varchar(10);
	cd_person_mrn_w      varchar(10);
	number_of_visits_w      smallint;
	medical_record_w      bigint;
	acceptance_number_w      varchar(10);
	date_of_acceptance_w      varchar(14);
	seqeunce_num      bigint;
	encounter_num      bigint;
	is_record_exist    varchar(1) := 'N';
	nr_seq_int_call_log_w      integration_message_log.nr_seq_int_call_log%type := 0;
	ie_status_w      integration_call_log.ie_status%type;
	cd_agenda_w 	 agenda_consulta.cd_agenda%type;
	ie_status_agenda_w      varchar(10);
	file_data_w 			varchar(32767);
	nr_tele_length_w    	bigint;

	
BEGIN
		PERFORM set_config('nais_interface_pck.ds_error_w', null, false);
		file_data_w := replace(replace(file_data_p, chr(13), ''), chr(10), '');
		nr_tele_length_w := (substr(file_data_w, 46, 5))::numeric;

		if nr_tele_length_w = length(file_data_w) then
		begin
		select  (substr(file_data_w,65,10))::numeric  patient_mrn, -- Patient identifier
				(substr(file_data_w,75,1))::numeric  number_of_visits  -- Number of visits
		into STRICT    cd_person_mrn_w,
                number_of_visits_w
		;
		exception
		when others then
            PERFORM set_config('nais_interface_pck.ds_error_w', sqlerrm||' Error occurred while retriving the patient identifier and Number Of visits ', false);
		end;
        select    cd_pessoa_fisica
        into STRICT      cd_person_w
        from      pessoa_fisica
        where     nr_prontuario = cd_person_mrn_w;
		for nr_counter_w in 0 .. 5
			loop
				begin
				select	to_number(trim(substr(file_data_w, 79 + (42 * nr_counter_w), 4))) acceptance_number, -- Acceptance Number
						trim(substr(file_data_w, 83 + (42 * nr_counter_w), 14)) acceptance_date -- Acceptance Date
				into STRICT	acceptance_number_w,
						date_of_acceptance_w
				;

			if  acceptance_number_w <> 0 then

			begin
                select  a.nr_sequencia,
                        a.nr_atendimento,
						a.cd_agenda,
                        a.ie_status_agenda
                into STRICT    seqeunce_num,
                        encounter_num,
                        cd_agenda_w,
                        ie_status_agenda_w
                from    agenda_consulta a,
                        paciente_senha_fila b
                where   a.cd_pessoa_fisica = cd_person_w
                and     a.nr_seq_pac_senha_fila = b.nr_sequencia
                and     SubStr(((substr(obter_letra_verifacao_senha(coalesce(b.nr_seq_fila_senha_origem, b.nr_seq_fila_senha)),1,10)) || b.cd_senha_gerada),1,10) = to_char(acceptance_number_w);
			exception when others then
                seqeunce_num := 0;
                encounter_num := 0;
                cd_agenda_w := '0';
                ie_status_agenda_w := 'N';
            end;
				if encounter_num <> 0 and  seqeunce_num <> 0 then
					begin
						select CASE WHEN count(*)=1 THEN  'S' WHEN count(*)=0 THEN  'N' END
						into STRICT   is_record_exist
						from   atendimento_paciente_aux
						where   nr_atendimento = encounter_num
						and     nr_seq_agenda = seqeunce_num;
						if is_record_exist = 'S' then
						begin
							update  atendimento_paciente_aux
							set     dt_payment_end = to_date(date_of_acceptance_w, 'YYYYmmDDHH24miSS')
							where   nr_atendimento = encounter_num
							and     nr_seq_agenda = seqeunce_num;
						end;
						else
							insert into atendimento_paciente_aux(cd_cid_principal,
														dt_atualizacao,
														dt_atualizacao_nrec,
														dt_payment_end,
														nm_usuario,
														nm_usuario_nrec,
														nr_atendimento,
														nr_sequencia,
														nr_seq_agenda)
												values (null,
														clock_timestamp(),
														clock_timestamp(),
														to_date(date_of_acceptance_w, 'YYYYmmDDHH24miSS'),
														'NAIS',
														'NAIS',
														encounter_num,
														nextval('atendimento_paciente_aux_seq'),
														seqeunce_num);
						end if;

						if ie_status_agenda_w <> 'FI' then
							update agenda_consulta
							set    ie_status_agenda = 'FI'
							where  cd_agenda = cd_agenda_w
							and    nr_atendimento = encounter_num
							and    nr_sequencia = seqeunce_num;
						end if;

						commit;
					end;
				end if;
			end if;
			exception
			when others then
                PERFORM set_config('nais_interface_pck.ds_error_w', sqlerrm||' Error occurred while retriving the Accounted Table information ', false);
			end;
		end loop;

		if  current_setting('nais_interface_pck.ds_error_w')::coalesce(varchar(2000)::text, '') = '' then
			status_p := 'OK';
			ie_status_w := 'S';
			PERFORM set_config('nais_interface_pck.ds_message_w', 'Successfully saved '
                              || 'Nais Patient Accounting Information '
                              || '. '
                              || 'Integration name - Nais Patient Accounting Information '
                              || 'Time of message received : '
                              || clock_timestamp()||' '
                              || 'Patient Id : '
                              || cd_person_w, false);
		else
			status_p := 'N1';
			ie_status_w := 'E';
			PERFORM set_config('nais_interface_pck.ds_message_w', current_setting('nais_interface_pck.ds_error_w')::varchar(2000)||' Error occured while saving '
                              || 'Nais Patient Accounting Information '
                              || '. '
                              || 'Integration name - Nais Patient Accounting Information '
                              || 'Time of faliure : '
                              || clock_timestamp()||' '
                              || 'Patient Id : '
                              || cd_person_w, false);
		end if;

	else
	    status_p := 'N2';
			ie_status_w := 'E';
			PERFORM set_config('nais_interface_pck.ds_message_w', current_setting('nais_interface_pck.ds_error_w')::varchar(2000)||' Error occured while saving '
                              || 'Nais Patient Accounting Information '
                              || '. '
                              || 'Integration name - Nais Patient Accounting Information '
                              || 'Time of faliure : '
                              || clock_timestamp()||' '
                              || 'Patient MRN : '
                              || (substr(file_data_w,65,10))::numeric , false);
    end if;
		record_integration_call_log(current_setting('nais_interface_pck.nm_usuario_w')::varchar(20), current_setting('nais_interface_pck.nm_usuario_w')::varchar(20), clock_timestamp(), 'Nais Patient Information', 'Nais Patient Information',
        ie_status_w, 'R', null, current_setting('nais_interface_pck.ds_message_w')::varchar(4000), file_data_p, current_setting('nais_interface_pck.ds_error_w')::varchar(2000), 'Nais Patient Information', nr_seq_int_call_log_w, cd_person_w, null);
	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE nais_interface_pck.save_patient_accounted_info ( file_data_p text, status_p INOUT text) FROM PUBLIC;
