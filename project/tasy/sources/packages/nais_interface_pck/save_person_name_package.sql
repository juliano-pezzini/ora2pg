-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE nais_interface_pck.save_person_name ( ds_type_p text, ds_given_name_p text, nr_seq_person_name_p bigint, person_name_flag_p text) AS $body$
DECLARE

    ds_given_name_w     varchar(500);
    ds_family_name_w    varchar(500);

BEGIN
  
        select  coalesce(substr(ds_given_name_p, 0, position(current_setting('nais_interface_pck.jpn_space_w')::varchar(255) in ds_given_name_p) - 1), ds_given_name_p) into STRICT ds_family_name_w
;

        select  coalesce(substr(ds_given_name_p, position(current_setting('nais_interface_pck.jpn_space_w')::varchar(255) in ds_given_name_p) + 1, 255), ds_given_name_p) into STRICT ds_given_name_w
;

        if (person_name_flag_p = '0') then
            begin
                insert
                into person_name(
                  nr_sequencia,
                  dt_atualizacao,
                  dt_atualizacao_nrec,
                  nm_usuario,
                  nm_usuario_nrec,
                  ds_type,
                  ds_given_name,
                  ds_family_name
                )
                values (
                  nr_seq_person_name_p,
                  clock_timestamp(),
                  clock_timestamp(),
                  current_setting('nais_interface_pck.nm_usuario_w')::varchar(20),
                  current_setting('nais_interface_pck.nm_usuario_w')::varchar(20),
                  ds_type_p,
                  trim(both replace(ds_given_name_w,current_setting('nais_interface_pck.jpn_space_w')::varchar(255),' ') ),
                  trim(both replace(ds_family_name_w,current_setting('nais_interface_pck.jpn_space_w')::varchar(255),' ') )
                );
                commit;
            exception
            when others then
                PERFORM set_config('nais_interface_pck.ds_error_w', sqlerrm || ' Error occurred while saving person name for  ' || ds_given_name_p || ' .' || chr(13) || chr(10), false);
                RAISE EXCEPTION 'nais_exception_w' USING ERRCODE = '50020';
            end;
        else
			begin
				update	person_name
				set		ds_given_name = trim(both replace(ds_given_name_w,current_setting('nais_interface_pck.jpn_space_w')::varchar(255),' ') ),
						ds_family_name = trim(both replace(ds_family_name_w,current_setting('nais_interface_pck.jpn_space_w')::varchar(255),' ') ),
						dt_atualizacao = clock_timestamp(),
                        nm_usuario = current_setting('nais_interface_pck.nm_usuario_w')::varchar(20)
				where	ds_type = ds_type_p
				and 	nr_sequencia = nr_seq_person_name_p;
                commit;
			exception
			when others then
				PERFORM set_config('nais_interface_pck.ds_error_w', sqlerrm || ' Error occurred while updating person name for  ' || ds_given_name_p || ' .' || chr(13) || chr(10), false);
				RAISE EXCEPTION 'nais_exception_w' USING ERRCODE = '50020';
			end;
		end if;
  END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE nais_interface_pck.save_person_name ( ds_type_p text, ds_given_name_p text, nr_seq_person_name_p bigint, person_name_flag_p text) FROM PUBLIC;
