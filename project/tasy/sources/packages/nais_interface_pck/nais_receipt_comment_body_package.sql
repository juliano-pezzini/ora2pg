-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE nais_interface_pck.nais_receipt_comment_body ( cd_sequence_p text, file_output_p INOUT text) AS $body$
DECLARE


cd_pessoa_fisica_w    varchar(10) := null;
dt_comment_start_w    timestamp;
dt_comment_end_w      timestamp;
ds_comment_w          text := null;
cd_patient_classif_w  varchar(1);
nr_atendimento_w      bigint;
current_setting('nais_interface_pck.json_output_w')::philips_json         philips_json;
current_setting('nais_interface_pck.json_output_list_w')::philips_json_list    philips_json_list;
patient_mrn_w         bigint;
nr_comment_length_w   bigint;
nr_remainder_w        bigint;
nr_count_w            bigint;
nr_counnter_w         bigint;
cd_continue_flag_w    varchar(10) := 'C';
ds_log_message_w      varchar(4000) := null;
ds_erro_w             varchar(4000) := null;
ie_message_status_w   varchar(2) := null;
nr_seq_int_call_log_w integration_message_log.nr_seq_int_call_log%type := 0;
dt_inactive_w         timestamp;
cd_process_classif_w  varchar(10) := '1';
cd_order_number_w     varchar(40);
nr_comment_length     bigint;
cd_date_start_w       varchar(10);
cd_date_end_w         varchar(10);
current_setting('nais_interface_pck.nm_usuario_w')::varchar(20)          varchar(15);
cd_symp_cat_w         varchar(80);
cd_dis_category_w     smallint;
ds_comment_conv_w     text;
i                     integer;
nr_multi_char_w       integer := 0;

BEGIN

  PERFORM set_config('nais_interface_pck.json_output_w', philips_json(), false);
  PERFORM set_config('nais_interface_pck.json_output_list_w', philips_json_list(), false);

  begin
  select cd_pessoa_fisica,
         dt_cli_start,
         dt_cli_end,
         nr_atendimento,
         CASE WHEN ie_tipo_atendimento='0' THEN  '2' WHEN ie_tipo_atendimento='1' THEN  '1' END ,
		 dt_inativacao,
         nm_usuario,
		 cd_dis_category
  into STRICT   cd_pessoa_fisica_w,
         dt_comment_start_w,
         dt_comment_end_w,
         nr_atendimento_w,
         cd_patient_classif_w,
		 dt_inactive_w,
         current_setting('nais_interface_pck.nm_usuario_w')::varchar(20),
		 cd_dis_category_w
  from   evolucao_paciente
  where  cd_evolucao = cd_sequence_p;
  exception when others then
      ds_erro_w := ds_erro_w || 'The Result set is not found in clinical notes table';
  end;

  select obter_conversao_externa_int(null, 'EVOLUCAO_PACIENTE', 'CD_DIS_CATEGORY', cd_dis_category_w, 'NAIS')
  into STRICT   cd_symp_cat_w
;

  if cd_patient_classif_w = '1' then
    cd_date_start_w := to_char(dt_comment_start_w, 'YYYYMM') || '01';
    cd_date_end_w   := to_char(dt_comment_start_w, 'YYYYMM') || to_char(last_day(dt_comment_start_w), 'DD');
  elsif cd_patient_classif_w = '2' then
    cd_date_start_w := to_char(dt_comment_start_w, 'YYYYMMDD');
    cd_date_end_w   := to_char(dt_comment_end_w, 'YYYYMMDD');
  end if;

  select convert_html_to_str_nais('DS_EVOLUCAO','EVOLUCAO_PACIENTE','CD_EVOLUCAO = ' || cd_sequence_p)
  into STRICT ds_comment_w
;

  ds_comment_w := replace(ds_comment_w, '--END--', '');
  ds_comment_w := replace(ds_comment_w, '--BREAK--', chr(14845587));
  ds_comment_w := trim(both ds_comment_w);
  ds_comment_w := replace(ds_comment_w, chr(49824), '');
  if substr(ds_comment_w, length(ds_comment_w)) = chr(14845587) then
    ds_comment_w := substr(ds_comment_w, 1 ,length(ds_comment_w) - 1);
  end if;
  ds_comment_w := REPLACE(ds_comment_w, CHR(32)||CHR(32), TO_MULTI_BYTE(chr(32)));
  ds_comment_w := replace(ds_comment_w,  chr(10), '');
  ds_comment_w := replace(ds_comment_w,  chr(13), '');
  ds_comment_w := replace(ds_comment_w,  chr(9), TO_MULTI_BYTE(chr(32)));
  ds_comment_w := replace(ds_comment_w,  chr(14909568), TO_MULTI_BYTE(chr(32)));
  ds_comment_w := replace(ds_comment_w,chr(14913166), 'mg');
  ds_comment_w := trim(both ds_comment_w);

  select nr_prontuario
  into STRICT patient_mrn_w
  from pessoa_fisica
  where cd_pessoa_fisica = cd_pessoa_fisica_w;

  if (dt_inactive_w IS NOT NULL AND dt_inactive_w::text <> '') then
    cd_process_classif_w := '3';
  end if;

  PERFORM set_config('nais_interface_pck.ds_line_w', null, false);
  generate_int_serial_number(nr_atendimento_w, 'RC', '1', coalesce(current_setting('nais_interface_pck.nm_usuario_w')::varchar(20), 'NAIS'), current_setting('nais_interface_pck.filename_sequence_w')::varchar(255), 969);

  begin
  select cd_externo
  into STRICT   cd_order_number_w
  from   conversao_meio_externo
  where  ie_sistema_externo = 'NAIS'
  and    nm_tabela = 'EVOLUCAO_PACIENTE'
  and    nm_atributo = 'CD_EVOLUCAO'
  and    cd_interno = cd_sequence_p;
  exception when others then
  cd_order_number_w := null;
  end;

  if coalesce(cd_order_number_w::text, '') = '' then
      cd_order_number_w := to_char(current_setting('nais_interface_pck.filename_sequence_w')::varchar(255));
      CALL bft_gerar_conv_meio_externo(null, 'EVOLUCAO_PACIENTE', 'CD_EVOLUCAO', cd_sequence_p, to_char(current_setting('nais_interface_pck.filename_sequence_w')::varchar(255)) , 'NAIS', 'E', coalesce(current_setting('nais_interface_pck.nm_usuario_w')::varchar(20),'NAIS'));
  end if;

  
  nr_comment_length_w := lengthb(ds_comment_w);
  nr_count_w := floor(nr_comment_length_w/2400);
  nr_remainder_w := MOD(nr_comment_length_w, 2400);

  if (nr_comment_length_w > 24000) then
    ds_erro_w := ds_erro_w || 'Comment Length Not applicable as per japan standards';
  end if;

  if (nr_comment_length_w <= 24000) then
    begin
    for counter in 0 .. (nr_count_w)
       loop

          if (counter = nr_count_w) then
                cd_continue_flag_w := 'E';
          end if;
                    CALL CALL CALL CALL CALL CALL CALL nais_interface_pck.nais_common_header('RC', nr_atendimento_w, cd_process_classif_w, cd_continue_flag_w, '1', 2628, current_setting('nais_interface_pck.filename_sequence_w')::varchar(255), current_setting('nais_interface_pck.nm_usuario_w')::varchar(20));
                    CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL nais_interface_pck.append_text(to_char(patient_mrn_w), 10, 'L', '0');
                    CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL nais_interface_pck.append_text(cd_process_classif_w, 1, 'R', ' ');
                    CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL nais_interface_pck.append_text('1', 1, 'R', ' ');
                    CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL nais_interface_pck.append_text(cd_patient_classif_w, 1, 'R', ' ');
                    CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL nais_interface_pck.append_text(cd_date_start_w, 8, 'R', ' ');
                    CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL nais_interface_pck.append_text(cd_order_number_w, 8, 'L', '0');
                    CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL nais_interface_pck.append_text(cd_date_end_w, 8, 'R', ' ');
					ds_comment_conv_w := substrb(ds_comment_w,((2400 * counter) + 1),2400);
					ds_comment_conv_w := elimina_acentuacao(ds_comment_conv_w);
					for i in 1 .. length(ds_comment_conv_w) loop
                        if substr(ds_comment_conv_w, i, 1) = chr(14845587) then
                            nr_multi_char_w := nr_multi_char_w + 1;
                        end if;
                    end loop;
                    CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL nais_interface_pck.append_text(ds_comment_conv_w,2400-nr_multi_char_w, 'R', ' ');
                    CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL nais_interface_pck.append_text('2', 1, 'R', ' ');
                    CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL nais_interface_pck.append_text(' ',2, 'R', ' ');
                    CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL nais_interface_pck.append_text(' ',1, 'R', ' ');
                    CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL nais_interface_pck.append_text(cd_symp_cat_w, 2, 'L', '0');
                    CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL nais_interface_pck.append_text('00', 2, 'L', '0');
                    CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL nais_interface_pck.append_text('[', 1, 'L', ' ');
                    CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL nais_interface_pck.append_text(' ',48, 'L', ' ');
                    CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL nais_interface_pck.append_text(' ',48, 'L', ' ');
                    CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL nais_interface_pck.append_text(']', 1, 'L', '0');
                    CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL nais_interface_pck.append_text(' ',20, 'R', ' ');
                    CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL nais_interface_pck.append_text(chr(13), 1, 'L', ' ');
					nr_multi_char_w := 0;
            current_setting('nais_interface_pck.json_output_w')::philips_json := nais_interface_pck.add_json_value(current_setting('nais_interface_pck.json_output_w')::philips_json, 'message', current_setting('nais_interface_pck.ds_line_w')::varchar(32767));
            current_setting('nais_interface_pck.json_output_list_w')::philips_json_list.append(current_setting('nais_interface_pck.json_output_w')::philips_json.to_json_value());
         end loop;

         exception when others then
         ds_erro_w := ds_erro_w || 'There is an error while looping first loop of comment text';
         end;
         end if;
        dbms_lob.createtemporary(file_output_p, true);
        current_setting('nais_interface_pck.json_output_list_w')::philips_json_list.(file_output_p);

        if coalesce(ds_erro_w::text, '') = '' then
          ie_message_status_w := 'S';
          ds_log_message_w := ds_log_message_w || 'NAIS - Receipt Comment executed successfully';
        elsif (ds_erro_w IS NOT NULL AND ds_erro_w::text <> '') then
           ie_message_status_w := 'E';
           ds_log_message_w := ds_log_message_w || 'Failure in Execution';
        end if;

          ds_log_message_w := ds_log_message_w || 'NAIS - Receipt Comment executed successfully';

          record_integration_call_log('NAIS', 'NAIS', clock_timestamp(), 'Nais Receipt Comment Symptom', 'Nais Receipt Comment Symptom',
          ie_message_status_w, 'E', null, ds_log_message_w, current_setting('nais_interface_pck.ds_line_w')::varchar(32767), ds_erro_w, 'Nais Patient Information', nr_seq_int_call_log_w, cd_pessoa_fisica_w, null);

	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE nais_interface_pck.nais_receipt_comment_body ( cd_sequence_p text, file_output_p INOUT text) FROM PUBLIC;
