-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE nais_interface_pck.process_physical_person_data ( cd_pessoa_fisica_p pessoa_fisica.cd_pessoa_fisica%type, ie_tipo_complemento_p compl_pessoa_fisica.ie_tipo_complemento%type, nr_telephone_p compl_pessoa_fisica.nr_telefone%type, ds_fone_adic_p compl_pessoa_fisica.ds_fone_adic%type, ds_given_name_main_p text) AS $body$
DECLARE

		nr_seq_compl_w compl_pessoa_fisica.nr_sequencia%type;
	
BEGIN

        select	coalesce(max(nr_sequencia), 0)
        into STRICT	nr_seq_compl_w
        from	compl_pessoa_fisica
        where	cd_pessoa_fisica = cd_pessoa_fisica_p
        and 	ie_tipo_complemento = ie_tipo_complemento_p;
        
        if (nr_seq_compl_w = 0) then
    
            select coalesce(max(nr_sequencia),0) + 1
            into STRICT nr_seq_compl_w
            from compl_pessoa_fisica
            where cd_pessoa_fisica = cd_pessoa_fisica_p;

            begin
                insert
                into compl_pessoa_fisica(
                  nr_sequencia,
                  cd_pessoa_fisica,
                  nm_usuario,
                  nm_usuario_nrec,
                  ie_tipo_complemento,
                  dt_atualizacao,
                  dt_atualizacao_nrec,
                  nr_ddi_telefone,
                  nr_telefone,
                  ds_fone_adic,
                  nr_ddi_fone_adic
                )
                values (
                  nr_seq_compl_w,
                  cd_pessoa_fisica_p,
                  current_setting('nais_interface_pck.nm_usuario_w')::varchar(20),
                  current_setting('nais_interface_pck.nm_usuario_w')::varchar(20),
                  ie_tipo_complemento_p,
                  clock_timestamp(),
                  clock_timestamp(),
                  81,
                  nr_telephone_p,
                  ds_fone_adic_p,
                  81
                );
                commit;
            exception
            when others then
                PERFORM set_config('nais_interface_pck.ds_error_w', sqlerrm || ' Error occurred while saving the COMPL_PESSOA_FISICA details of ' || ds_given_name_main_p || ' .' || chr(13) || chr(10), false);
                RAISE EXCEPTION 'nais_exception_w' USING ERRCODE = '50020';
            end;
        else
            begin

                update	compl_pessoa_fisica
                set		dt_atualizacao = clock_timestamp(),
                        nm_usuario = current_setting('nais_interface_pck.nm_usuario_w')::varchar(20),
                        nr_ddi_telefone = 81,
                        nr_telefone = nr_telephone_p,
                        ds_fone_adic = ds_fone_adic_p,
                        nr_ddi_fone_adic = 81
                where	nr_sequencia = 	nr_seq_compl_w
                and 	cd_pessoa_fisica = cd_pessoa_fisica_p;
                commit;
            exception
            when others then
                PERFORM set_config('nais_interface_pck.ds_error_w', sqlerrm || ' Error occurred while updating the COMPL_PESSOA_FISICA details of ' || ds_given_name_main_p || ' .' || chr(13) || chr(10), false);
                RAISE EXCEPTION 'nais_exception_w' USING ERRCODE = '50020';
            end;
        end if;
  END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE nais_interface_pck.process_physical_person_data ( cd_pessoa_fisica_p pessoa_fisica.cd_pessoa_fisica%type, ie_tipo_complemento_p compl_pessoa_fisica.ie_tipo_complemento%type, nr_telephone_p compl_pessoa_fisica.nr_telefone%type, ds_fone_adic_p compl_pessoa_fisica.ds_fone_adic%type, ds_given_name_main_p text) FROM PUBLIC;
