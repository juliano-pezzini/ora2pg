-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE nais_interface_pck.save_insurance_accessory_data ( insurance_accessory_data_p text, nais_insurance_seq_p bigint) AS $body$
DECLARE

    accessory_counter_w smallint;
    cd_public_expense_defrayer_w nais_insurance_accessory.cd_public_expense_defrayer%type;
    ds_recipient_number_w nais_insurance_accessory.ds_recipient_number%type;
    insurance_accessory_seq_w nais_insurance_accessory.nr_sequencia%type;
    ie_accessory_exists_w smallint := 0;

BEGIN
    
        select  coalesce(max(1),0)
        into STRICT    ie_accessory_exists_w
        from    nais_insurance_accessory
        where   nr_seq_nais_insurance =  nais_insurance_seq_p;

        if (ie_accessory_exists_w = 1) then
            begin
                delete 
                from    nais_insurance_accessory
                where   nr_seq_nais_insurance =  nais_insurance_seq_p;
                commit;
            exception
            when others then
                PERFORM set_config('nais_interface_pck.ds_error_w', sqlerrm||' Error occurred while deleting accessory insurance table details. ', false);
                RAISE EXCEPTION 'nais_exception_w' USING ERRCODE = '50020';
            end;
        end if;

        for accessory_counter_w in 0 .. (4 - 1)
          loop
            begin
              select  to_number(substr(insurance_accessory_data_p,1 + (28 * accessory_counter_w),8)) public_expense_defrayer,
                      substr(insurance_accessory_data_p,9 + (28 * accessory_counter_w),20) recipient_number
              into STRICT    cd_public_expense_defrayer_w,
                      ds_recipient_number_w
;
            exception
            when others then
              PERFORM set_config('nais_interface_pck.ds_error_w', sqlerrm||' Error occurred while retriving accessory insurance table details. ', false);
              RAISE EXCEPTION 'nais_exception_w' USING ERRCODE = '50020';
            end;

            select  coalesce(max(nr_sequencia),0)+1 
            into STRICT  insurance_accessory_seq_w
            from  nais_insurance_accessory;

            begin
              insert
              into nais_insurance_accessory(
                nr_sequencia,
                nr_seq_nais_insurance,
                cd_public_expense_defrayer,
                ds_recipient_number
              )
              values (
                insurance_accessory_seq_w,
                nais_insurance_seq_p,
                cd_public_expense_defrayer_w,
                ds_recipient_number_w
              );
            commit;
            exception
            when others then
              PERFORM set_config('nais_interface_pck.ds_error_w', sqlerrm||' Error occurred while inserting accessory insurance table details. ', false);
              RAISE EXCEPTION 'nais_exception_w' USING ERRCODE = '50020';
            end;
        end loop;
    END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE nais_interface_pck.save_insurance_accessory_data ( insurance_accessory_data_p text, nais_insurance_seq_p bigint) FROM PUBLIC;
