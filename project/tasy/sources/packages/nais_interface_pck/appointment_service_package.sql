-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE nais_interface_pck.appointment_service ( parameter_id_p bigint, ds_file_output_p INOUT text) AS $body$
DECLARE


		C01 CURSOR FOR
		SELECT	00001 serial_number,
				'H' system_code,
				'YO' message_type_code,
				'C' continuation_flag,
				'M' destination_code,
				'D' sender_code,
				clock_timestamp() processing_date,
				clock_timestamp() processing_time,
				'TASY' terminal_name,
                current_setting('nais_interface_pck.nm_usuario_ww')::varchar(20) user_number,
				'01' processing_classification,
				' ' response_class,
				98  telegram_length,
				'S' eot,
				'MD' med_institution_code,
				' ' blank
		;

		C02 CURSOR FOR
		SELECT 	substr(obter_prontuario_pf(obter_estab_agenda(a.cd_agenda),a.cd_pessoa_fisica),1,255) patient_id,
				'01' appointment_department_code,	
				to_char(a.dt_agendamento,'YYYYMMDD') appointment_date, 	--Scheduled date of consultation
				to_char(a.dt_agendamento,'HH24MI') appointment_time,	--Scheduled start time
				' ' consultation_room_no,
				'12345678' physician_code,	
				a.ie_status_agenda physician_name,	
				to_char(a.dt_agendamento,'YYYYMMDD') on_the_day_appointment_class,		--Scheduling date 
				' ' application_classification,
				a.ie_status_agenda appointment_slot_name,	
				' ' appointment_comment1,
				a.ds_observacao appointment_comment2,
				' ' appointment_code,
				' ' date_of_registration,
				0 time_of_registration,
				12345678 order_number,
				' ' send_destination_code,
				' ' urgent_exam_flag,
				'R0' appointment_classification

		from agenda_consulta a,
			agenda b

		where	a.cd_agenda = b.cd_agenda		
		and	b.cd_tipo_agenda = 5
		and a.nr_sequencia = parameter_id_p;
		
BEGIN

		PERFORM set_config('nais_interface_pck.ds_line_w', null, false);

        select coalesce(wheb_usuario_pck.get_nm_usuario, 'NAIS')
            into STRICT current_setting('nais_interface_pck.nm_usuario_ww')::varchar(20)
;

		for r_C01 in C01 loop
			begin
				CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL nais_interface_pck.append_text(r_C01.serial_number,5,'L','0');   									
				CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL nais_interface_pck.append_text(r_C01.system_code,1,'L');
				CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL nais_interface_pck.append_text(r_C01.message_type_code,2,'L');
				CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL nais_interface_pck.append_text(r_C01.continuation_flag,1,'L');
				CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL nais_interface_pck.append_text(r_C01.destination_code,1,'L');
				CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL nais_interface_pck.append_text(r_C01.sender_code,1,'L');
				CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL nais_interface_pck.append_text(to_char(r_C01.processing_date,'YYYYMMDD'),8,'L','0'); 					
				CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL nais_interface_pck.append_text(to_char(r_C01.processing_time,'HHMISS'),6,'L','0');
				CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL nais_interface_pck.append_text(r_C01.terminal_name,8,'L');
				CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL nais_interface_pck.append_text(r_C01.user_number,8,'L');
				CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL nais_interface_pck.append_text(r_C01.processing_classification,2,'L');
				CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL nais_interface_pck.append_text(r_C01.response_class,2,'L');
				CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL nais_interface_pck.append_text(r_C01.telegram_length,5,'L','0');
				CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL nais_interface_pck.append_text(r_C01.eot,1,'L');
				CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL nais_interface_pck.append_text(r_C01.med_institution_code,2,'L');
				CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL nais_interface_pck.append_text(r_C01.blank,11,'L');
			end;
		end loop;

		for r_C02 in C02 loop
			begin
				CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL nais_interface_pck.append_text(r_C02.patient_id,10,'L','0');
				CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL nais_interface_pck.append_text(r_C02.appointment_department_code,2,'L');
				CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL nais_interface_pck.append_text(r_C02.appointment_date,8,'L','0');
				CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL nais_interface_pck.append_text(r_C02.appointment_time,4,'L','0');
				CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL nais_interface_pck.append_text(r_C02.consultation_room_no,5,'L');
				CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL nais_interface_pck.append_text(r_C02.physician_code,10);
				CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL nais_interface_pck.append_text(r_C02.physician_name,20,'L');
				CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL nais_interface_pck.append_text(r_C02.on_the_day_appointment_class,1,'L');
				CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL nais_interface_pck.append_text(r_C02.application_classification,2,'L');
				CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL nais_interface_pck.append_text(r_C02.appointment_slot_name,20,'L');
				CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL nais_interface_pck.append_text(r_C02.appointment_comment1,50, 'L');
				CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL nais_interface_pck.append_text(r_C02.appointment_comment2,130,'L');
				CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL nais_interface_pck.append_text(r_C02.appointment_code,5,'L');
				CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL nais_interface_pck.append_text(r_C02.date_of_registration,8,'L','0');
				CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL nais_interface_pck.append_text(r_C02.time_of_registration,8,'L','0');
				CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL nais_interface_pck.append_text(r_C02.order_number,8,'L','0');
				CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL nais_interface_pck.append_text(r_C02.send_destination_code,2,'L');
				CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL nais_interface_pck.append_text(r_C02.urgent_exam_flag,1,'L');
				CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL nais_interface_pck.append_text(r_C02.appointment_classification,2,'L');
			end;
		end loop;

		RAISE NOTICE '%', current_setting('nais_interface_pck.ds_line_w')::varchar(32767);
		ds_file_output_p	:= current_setting('nais_interface_pck.ds_line_w')::varchar(32767);

	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE nais_interface_pck.appointment_service ( parameter_id_p bigint, ds_file_output_p INOUT text) FROM PUBLIC;
