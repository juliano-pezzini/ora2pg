-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE nais_interface_pck.save_limited_department_data ( limited_department_data_p text, nais_insurance_seq_p bigint) AS $body$
DECLARE

    limited_counter_w smallint;
    department_code_w nais_insurance_department.cd_department%type;
    nais_department_seq_w nais_insurance_department.nr_sequencia%type;
    ie_department_exists_w smallint := 0;

BEGIN
    
        select  coalesce(max(1),0)
        into STRICT    ie_department_exists_w
        from    nais_insurance_department
        where   nr_seq_nais_insurance =  nais_insurance_seq_p;

        if (ie_department_exists_w = 1) then
            begin
                delete 
                from    nais_insurance_department
                where   nr_seq_nais_insurance =  nais_insurance_seq_p;
                commit;
            exception
            when others then
                PERFORM set_config('nais_interface_pck.ds_error_w', sqlerrm||' Error occurred while deleting limited department details. ', false);
                RAISE EXCEPTION 'nais_exception_w' USING ERRCODE = '50020';
            end;
        end if;

        for limited_counter_w in 0 .. (6 - 1)
        loop
            begin
                select  substr(limited_department_data_p,1 + (2 * limited_counter_w),2) department
                into STRICT  department_code_w
;
            exception
            when others then
                PERFORM set_config('nais_interface_pck.ds_error_w', sqlerrm||' Error occurred while retriving limited department details. ', false);
                RAISE EXCEPTION 'nais_exception_w' USING ERRCODE = '50020';
            end;
            
            select  coalesce(max(nr_sequencia),0)+1 
            into STRICT  nais_department_seq_w
            from  nais_insurance_department;

            begin
                insert
                into nais_insurance_department(
                  nr_sequencia,
                  nr_seq_nais_insurance,
                  cd_department
                )
                values (
                  nais_department_seq_w,
                  nais_insurance_seq_p,
                  department_code_w
                );
                commit;
            exception
            when others then
                PERFORM set_config('nais_interface_pck.ds_error_w', sqlerrm||' Error occurred while inserting limited department details. ', false);
                RAISE EXCEPTION 'nais_exception_w' USING ERRCODE = '50020';
            end;
        end loop;
  END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE nais_interface_pck.save_limited_department_data ( limited_department_data_p text, nais_insurance_seq_p bigint) FROM PUBLIC;
