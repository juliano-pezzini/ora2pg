-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_solic_rescisao_fin_pck.gerar_historico_pagador ( nr_seq_pagador_p pls_contrato_pagador.nr_sequencia%type, nr_seq_solic_rescisao_p pls_solicitacao_rescisao.nr_sequencia%type, nr_seq_solic_resc_fin_p pls_solic_rescisao_fin.nr_sequencia%type, dt_rescisao_p timestamp, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) AS $body$
DECLARE


ds_mensagem_w		varchar(4000)	:= null;
ds_lista_abatimento_w	varchar(4000);
ds_titulos_pagar_w	varchar(255);
nr_seq_nota_credito_w	nota_credito.nr_sequencia%type;


BEGIN
select	max(nr_seq_nota_credito)
into STRICT	nr_seq_nota_credito_w
from	pls_solic_resc_fin_venc
where	nr_seq_solic_resc_fin	= nr_seq_solic_resc_fin_p;

ds_titulos_pagar_w	:= obter_titulos_nota_credito(nr_seq_nota_credito_w);

ds_mensagem_w	:= wheb_mensagem_pck.get_texto(1107900, 'NR_SEQ_SOLICITACAO='||nr_seq_solic_rescisao_p||';'||
							'DT_RESCISAO='||to_char(dt_rescisao_p,'dd/mm/yyyy'));

if (nr_seq_nota_credito_w IS NOT NULL AND nr_seq_nota_credito_w::text <> '') then
	ds_mensagem_w	:= ds_mensagem_w || chr(13) || wheb_mensagem_pck.get_texto(1107901) || ' ' || nr_seq_nota_credito_w;
end if;

if (ds_titulos_pagar_w IS NOT NULL AND ds_titulos_pagar_w::text <> '') then
	ds_mensagem_w	:= ds_mensagem_w || chr(13) || wheb_mensagem_pck.get_texto(1107902) || ds_titulos_pagar_w;
end if;

ds_mensagem_w	:= substr(ds_mensagem_w || chr(13) ||pls_solic_rescisao_fin_pck.obter_lista_beneficiarios(nr_seq_solic_resc_fin_p,cd_estabelecimento_p,'NC'),1,4000);

ds_lista_abatimento_w := pls_solic_rescisao_fin_pck.obter_lista_beneficiarios(nr_seq_solic_resc_fin_p,cd_estabelecimento_p, 'A');

if (ds_lista_abatimento_w IS NOT NULL AND ds_lista_abatimento_w::text <> '') then
	ds_mensagem_w := ds_mensagem_w || chr(13) || wheb_mensagem_pck.get_texto(1107903);
	ds_mensagem_w	:= substr(ds_mensagem_w || chr(13) ||ds_lista_abatimento_w,1,4000);
end if;

insert	into	pls_pagador_historico(	nr_sequencia, nr_seq_pagador, cd_estabelecimento,
		dt_atualizacao, nm_usuario, dt_atualizacao_nrec,
		nm_usuario_nrec, nm_usuario_historico, dt_historico,
		ds_titulo, ie_tipo_historico, ie_origem,
		ds_historico)
	values (	nextval('pls_pagador_historico_seq'), nr_seq_pagador_p, cd_estabelecimento_p,
		clock_timestamp(), nm_usuario_p, clock_timestamp(),
		nm_usuario_p, nm_usuario_p, clock_timestamp(),
		wheb_mensagem_pck.get_texto(1107904), 'S', 'FF',
		ds_mensagem_w);

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_solic_rescisao_fin_pck.gerar_historico_pagador ( nr_seq_pagador_p pls_contrato_pagador.nr_sequencia%type, nr_seq_solic_rescisao_p pls_solicitacao_rescisao.nr_sequencia%type, nr_seq_solic_resc_fin_p pls_solic_rescisao_fin.nr_sequencia%type, dt_rescisao_p timestamp, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) FROM PUBLIC;
