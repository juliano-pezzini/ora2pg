-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_solic_rescisao_fin_pck.gerar_baixa_titulo_mens ( nr_seq_solic_resc_fin_p pls_solic_rescisao_fin.nr_sequencia%type, cd_moeda_padrao_p parametro_contas_receber.cd_moeda_padrao%type, cd_tipo_recebimento_p pls_resc_fin_mens.cd_tipo_recebimento%type, nr_seq_solic_rescisao_p pls_solicitacao_rescisao.nr_sequencia%type, cd_centro_custo_desc_p pls_resc_fin_mens.cd_centro_custo_desc%type, nr_seq_motivo_desc_p pls_resc_fin_mens.nr_seq_motivo_desc%type, nr_seq_motivo_cancel_mens_p pls_resc_fin_mens.nr_seq_motivo_cancel_mens%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) AS $body$
DECLARE


C01 CURSOR FOR
	SELECT	a.nr_titulo,
		sum(a.vl_cancelar) vl_cancelar,
		b.ie_situacao,
		b.vl_saldo_titulo,
		b.vl_titulo,
		b.ie_origem_titulo,
		b.nr_seq_mensalidade,
		b.ie_tipo_titulo
	from	pls_solic_resc_fin_item a,
		titulo_receber b
	where	b.nr_titulo	= a.nr_titulo
	and	a.nr_seq_solic_resc_fin = nr_seq_solic_resc_fin_p
	and	a.ie_tipo_item	= '1'
	and	(a.nr_titulo IS NOT NULL AND a.nr_titulo::text <> '')
	group by
		a.nr_titulo,
		b.ie_situacao,
		b.vl_saldo_titulo,
		b.vl_titulo,
		b.ie_origem_titulo,
		b.nr_seq_mensalidade,
		b.ie_tipo_titulo;

nr_seq_baixa_w			bigint;
nr_titulo_contab_w		bigint;
vl_baixa_w			double precision;
nr_seq_trans_fin_w		transacao_financeira.nr_sequencia%type;
qt_benef_resc_origem_mens_w	bigint;
qt_benef_mens_w			bigint;

BEGIN

for r_c01_w in c01 loop
	begin
	if (r_c01_w.vl_cancelar > 0) and (r_c01_w.ie_situacao = '1') then
		if (r_c01_w.vl_cancelar > r_c01_w.vl_saldo_titulo) then
			vl_baixa_w	:= r_c01_w.vl_saldo_titulo;
		else
			vl_baixa_w	:= r_c01_w.vl_cancelar;
		end if;
		
		qt_benef_mens_w			:= 0;
		qt_benef_resc_origem_mens_w	:= 0;
		
		if (r_c01_w.nr_seq_mensalidade IS NOT NULL AND r_c01_w.nr_seq_mensalidade::text <> '') then
			select	count(1)
			into STRICT	qt_benef_mens_w
			from (SELECT	nr_seq_segurado
				from	pls_mensalidade_segurado
				where	nr_seq_mensalidade = r_c01_w.nr_seq_mensalidade
				group by
					nr_seq_segurado) alias2;
					
			select	count(1)
			into STRICT	qt_benef_resc_origem_mens_w
			from	pls_solic_rescisao_benef a
			where	a.nr_seq_solicitacao = nr_seq_solic_rescisao_p
			and	exists (SELECT	1
					from	pls_mensalidade_segurado x
					where	x.nr_seq_segurado = a.nr_seq_segurado
					and	x.nr_seq_mensalidade = r_c01_w.nr_seq_mensalidade);
		end if;

		if	(r_c01_w.vl_titulo = vl_baixa_w AND qt_benef_mens_w = qt_benef_resc_origem_mens_w) then
			if	(r_c01_w.ie_origem_titulo = '3' AND nr_seq_motivo_cancel_mens_p IS NOT NULL AND nr_seq_motivo_cancel_mens_p::text <> '') then
				CALL pls_cancelar_mensalidade(r_c01_w.nr_seq_mensalidade, clock_timestamp(), nm_usuario_p,
							'E', nr_seq_motivo_cancel_mens_p, 'N',
							' - ' || wheb_mensagem_pck.get_texto(1107909, 'NR_SEQ_SOLICITACAO='||nr_seq_solic_rescisao_p), cd_estabelecimento_p);
			else
				CALL cancelar_titulo_receber(r_c01_w.nr_titulo, nm_usuario_p, 'N', clock_timestamp());
			end if;
		else
			select	max(nr_seq_trans_fin)
			into STRICT	nr_seq_trans_fin_w
			from	tipo_recebimento
			where	cd_tipo_recebimento = cd_tipo_recebimento_p;

			select	coalesce(max(nr_sequencia),0) + 1
			into STRICT	nr_seq_baixa_w
			from	titulo_receber_liq
			where	nr_titulo	= r_c01_w.nr_titulo;

			insert	into titulo_receber_liq(nr_titulo, nr_sequencia, dt_recebimento,
				vl_recebido, vl_descontos, vl_juros,
				vl_multa, vl_rec_maior, vl_glosa,
				cd_moeda, dt_atualizacao, nm_usuario,
				cd_tipo_recebimento, ie_acao, ie_lib_caixa,
				nr_seq_resc_fin, ds_observacao, cd_centro_custo_desc,
				nr_seq_motivo_desc, nr_seq_trans_fin, dt_real_recebimento,
				vl_adequado, vl_despesa_bancaria, vl_perdas,
				vl_outros_acrescimos, vl_cambial_ativo, vl_cambial_passivo)
			values (r_c01_w.nr_titulo, nr_seq_baixa_w, clock_timestamp(),
				0, vl_baixa_w, 0,
				0, 0, 0,
				cd_moeda_padrao_p, clock_timestamp(), nm_usuario_p,
				cd_tipo_recebimento_p, 'I', 'S',
				nr_seq_solic_resc_fin_p, wheb_mensagem_pck.get_texto(1107915, 'NR_SEQ_SOLICITACAO='||nr_seq_solic_rescisao_p), cd_centro_custo_desc_p,
				nr_seq_motivo_desc_p, nr_seq_trans_fin_w, clock_timestamp(),
				0, 0, 0,
				0, 0, 0);

				CALL gerar_titulo_rec_liq_cc(cd_estabelecimento_p, null, nm_usuario_p, r_c01_w.nr_titulo, nr_seq_baixa_w);
				pls_gerar_tit_rec_liq_mens(r_c01_w.nr_titulo, nr_seq_baixa_w, nm_usuario_p, nr_titulo_contab_w);
				CALL pls_gerar_amortizacao_regra(r_c01_w.nr_titulo, nr_seq_baixa_w, nm_usuario_p, 'N');
				CALL atualizar_saldo_tit_rec(r_c01_w.nr_titulo, nm_usuario_p);
				
				if (r_c01_w.ie_tipo_titulo <> '10') then
					CALL gerar_bloqueto_tit_rec(r_c01_w.nr_titulo,'OPSMS'); --Atualizar a linha digitavel
				end if;
		end if;
	end if;
	end;
end loop;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_solic_rescisao_fin_pck.gerar_baixa_titulo_mens ( nr_seq_solic_resc_fin_p pls_solic_rescisao_fin.nr_sequencia%type, cd_moeda_padrao_p parametro_contas_receber.cd_moeda_padrao%type, cd_tipo_recebimento_p pls_resc_fin_mens.cd_tipo_recebimento%type, nr_seq_solic_rescisao_p pls_solicitacao_rescisao.nr_sequencia%type, cd_centro_custo_desc_p pls_resc_fin_mens.cd_centro_custo_desc%type, nr_seq_motivo_desc_p pls_resc_fin_mens.nr_seq_motivo_desc%type, nr_seq_motivo_cancel_mens_p pls_resc_fin_mens.nr_seq_motivo_cancel_mens%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) FROM PUBLIC;
