-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_solic_rescisao_fin_pck.gerar_mensalidade (nr_seq_solic_resc_fin_p pls_solic_rescisao_fin.nr_sequencia%type, nr_seq_pagador_p pls_contrato_pagador.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nr_seq_lote_p INOUT pls_lote_mensalidade.nr_sequencia%type) AS $body$
DECLARE


nr_seq_lote_mensalidade_w	pls_lote_mensalidade.nr_sequencia%type;
nr_seq_lote_w			pls_lote_mensalidade.nr_sequencia%type;
qt_lote_gerado_w		bigint;	
nr_seq_solicitacao_w		pls_solicitacao_rescisao.nr_sequencia%type;
ie_tipo_lote_w			pls_lote_mensalidade.ie_tipo_lote%type;


BEGIN
nr_seq_lote_w	:= null;

select	max(a.nr_seq_solicitacao),
	CASE WHEN coalesce(max(b.nr_seq_intercambio)::text, '') = '' THEN 'CO'  ELSE 'CI' END  ie_tipo_lote
into STRICT	nr_seq_solicitacao_w,
	ie_tipo_lote_w
from	pls_solic_rescisao_fin a,
	pls_solicitacao_rescisao b
where	b.nr_sequencia	= a.nr_seq_solicitacao
and	a.nr_sequencia	= nr_seq_solic_resc_fin_p;

insert into	pls_lote_mensalidade(nr_sequencia, cd_estabelecimento, dt_atualizacao,
	dt_atualizacao_nrec, nm_usuario, dt_mesano_referencia,
	nm_usuario_nrec, ie_fator_moderador, ie_participacao,
	ie_primeira_mensalidade, ie_regulamentacao, ie_status,
	ie_tipo_contratacao, ie_tipo_lote, vl_lote,
	nr_seq_pagador, ie_tipo_pessoa_pagador, ie_geracao_nota_titulo,
	ie_utilizacao, nr_seq_solic_resc_fin, ds_observacao,
	ie_pagador_beneficio_obito, ie_visualizar_portal, ie_gerar_mensalidade_futura,
	ie_mensalidade_mes_anterior)
values (nextval('pls_lote_mensalidade_seq'), cd_estabelecimento_p, clock_timestamp(),
	clock_timestamp(), nm_usuario_p, clock_timestamp(),
	nm_usuario_p, 'T', 'T',
	'N', 'T', '1',
	'T', ie_tipo_lote_w, 0,
	nr_seq_pagador_p, 'A', 'A',
	'N', nr_seq_solic_resc_fin_p, wheb_mensagem_pck.get_texto(1041191, 'NR_SEQ_SOLIC_RESC='||nr_seq_solicitacao_w),
	'N', 'N', 'N',
	'N')
	returning nr_sequencia into nr_seq_lote_mensalidade_w;

CALL pls_geracao_mensalidade(nr_seq_lote_mensalidade_w, cd_estabelecimento_p, nm_usuario_p);

select	count(1)
into STRICT	qt_lote_gerado_w
from	pls_lote_mensalidade
where	nr_sequencia	= nr_seq_lote_mensalidade_w
and	ie_status	= '3';

if (qt_lote_gerado_w = 0) then
	delete from pls_lote_mensalidade
	where	nr_sequencia = nr_seq_lote_mensalidade_w;
	
	commit;
else
	nr_seq_lote_w := nr_seq_lote_mensalidade_w;
end if;

nr_seq_lote_p	:= nr_seq_lote_w;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_solic_rescisao_fin_pck.gerar_mensalidade (nr_seq_solic_resc_fin_p pls_solic_rescisao_fin.nr_sequencia%type, nr_seq_pagador_p pls_contrato_pagador.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nr_seq_lote_p INOUT pls_lote_mensalidade.nr_sequencia%type) FROM PUBLIC;
