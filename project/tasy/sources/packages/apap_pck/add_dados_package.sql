-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE apap_pck.add_dados ( dt_registro_p timestamp, vl_resultado_p bigint, ds_resultado_p text, ie_grupo_inf_p text, informacao_p INOUT dadosInformacao_tp) AS $body$
DECLARE

indice_w	integer;			
nr_hora_w	smallint;
nr_dia_w	bigint;
vl_resultado_w	double precision	:= vl_resultado_p;
BEGIN

indice_w	:= informacao_p.horarios.count+1;
nr_hora_w	:= (to_char(dt_registro_p,'hh24'))::numeric;
nr_hora_w	:= trunc(nr_hora_w / current_setting('apap_pck.nr_agrupamento_horas_w')::smallint) * current_setting('apap_pck.nr_agrupamento_horas_w')::smallint;
nr_dia_w	:= Obter_Dias_Entre_Datas(trunc(current_setting('apap_pck.dt_inicial_w')::timestamp),trunc(dt_registro_p))+1;

for i in 1..informacao_p.horarios.count loop
	begin
	if (informacao_p.horarios[i].nr_hora	= nr_hora_w) and (informacao_p.horarios[i].nr_dia	= nr_dia_w) and (ie_grupo_inf_p	not in ('CH','OC')) then
		informacao_p.horarios[indice_w].ie_outros_registros	:= 'S';
		informacao_p.horarios[i].ie_outros_registros		:= 'S';
	elsif (informacao_p.horarios[i].nr_hora	= nr_hora_w) and (informacao_p.horarios[i].nr_dia	= nr_dia_w)  and (ie_grupo_inf_p	in ('CH','OC')) then --For CH / OC (Gain / Loss) type records, only one line will be recorded in the vector, and will always add up to total the gp
		indice_w	:= i;
		vl_resultado_w	:= coalesce(vl_resultado_w,0) + coalesce(informacao_p.horarios[i].vl_resultado,0);
	end if;
	end;
end loop;


informacao_p.horarios[indice_w].nr_hora			:= nr_hora_w;
informacao_p.horarios[indice_w].nr_dia			:= nr_dia_w;
informacao_p.horarios[indice_w].vl_resultado		:= vl_resultado_w;
informacao_p.horarios[indice_w].ds_resultado		:= ds_resultado_p;
informacao_p.horarios[indice_w].dt_registro		:= dt_registro_p;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE apap_pck.add_dados ( dt_registro_p timestamp, vl_resultado_p bigint, ds_resultado_p text, ie_grupo_inf_p text, informacao_p INOUT dadosInformacao_tp) FROM PUBLIC;
