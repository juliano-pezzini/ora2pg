-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION apap_pck.obter_dados ( nr_atendimento_p bigint, nm_usuario_p text, dt_inicial_p timestamp, dt_final_p timestamp, nr_agrupamento_horas_p bigint default 1) RETURNS SETOF T_OBJETO_ROW_DATA AS $body$
DECLARE

			
indice_grupo_w		integer;

C01 CURSOR FOR
	SELECT  distinct ds_grupo_informacao, nr_seq_apap_grupo, a.ie_grupo_inf, a.ie_informacao
	FROM  	w_apap_pac_v a
	where 	a.nr_atendimento = nr_atendimento_p
	and 	a.nm_usuario = nm_usuario_p
	order by nr_seq_apap_grupo;
BEGIN

PERFORM set_config('apap_pck.nr_atendimento_w', nr_atendimento_p, false);
PERFORM set_config('apap_pck.nm_usuario_w', nm_usuario_p, false);
PERFORM set_config('apap_pck.dt_inicial_w', dt_inicial_p, false);
PERFORM set_config('apap_pck.nr_agrupamento_horas_w', coalesce(nr_agrupamento_horas_p,1), false);
if (current_setting('apap_pck.nr_agrupamento_horas_w')::smallint	<=0) then
	PERFORM set_config('apap_pck.nr_agrupamento_horas_w', 1, false);
end if;

current_setting('apap_pck.vetor_grupo_w')::vetor_Grupo.delete;

for r_c01 in c01 loop
	begin
	indice_grupo_w		:= current_setting('apap_pck.vetor_grupo_w')::vetor_Grupo.count + 1;
	current_setting('apap_pck.vetor_grupo_w')::vetor_Grupo[indice_grupo_w].ds_informacao		:= r_c01.ds_grupo_informacao;
	current_setting('apap_pck.vetor_grupo_w')::vetor_Grupo[indice_grupo_w].nr_seq_apap_grupo		:= r_c01.nr_seq_apap_grupo;
	current_setting('apap_pck.vetor_grupo_w')::vetor_Grupo[indice_grupo_w].ie_grupo_inf		:= r_c01.ie_grupo_inf;
	current_setting('apap_pck.vetor_grupo_w')::vetor_Grupo[indice_grupo_w].ie_informacao		:= r_c01.ie_informacao;

	current_setting('apap_pck.vetor_grupo_w')::vetor_Grupo(indice_grupo_w) := apap_pck.carregar_informacoes(current_setting('apap_pck.vetor_grupo_w')::vetor_Grupo(indice_grupo_w));
	
	PERFORM set_config('apap_pck.t_objeto_grupo_row_w', current_setting('apap_pck.vetor_grupo_w')::vetor_Grupo(indice_grupo_w) := apap_pck.obter_grupo(current_setting('apap_pck.vetor_grupo_w')::vetor_Grupo(indice_grupo_w)), false);
	
	RETURN NEXT current_setting('apap_pck.t_objeto_grupo_row_w'::t_objeto_row);
	
	if (r_c01.ie_grupo_inf <> 'BH' or r_c01.ie_informacao = 'S') then
		for i in 1..vetor_Grupo_w[indice_grupo_w].informacoes.count loop
			begin
			PERFORM set_config('apap_pck.t_objeto_row_w', current_setting('apap_pck.vetor_grupo_w')::vetor_Grupo[indice_grupo_w].informacoes(i) := apap_pck.obter_informacao(current_setting('apap_pck.vetor_grupo_w')::vetor_Grupo[indice_grupo_w].informacoes(i)), false);
			RETURN NEXT current_setting('apap_pck.t_objeto_row_w'::t_objeto_row);
			end;
		end loop;
	end if;
	end;
end loop;

			
return;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION apap_pck.obter_dados ( nr_atendimento_p bigint, nm_usuario_p text, dt_inicial_p timestamp, dt_final_p timestamp, nr_agrupamento_horas_p bigint default 1) FROM PUBLIC;
