-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_pp_canc_pgto_prest_pck.estornar_trib_pessoa_pgto ( nr_seq_lote_p pls_pp_lote.nr_sequencia%type, nr_seq_prest_estor_p pls_pp_prestador.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE


tb_nr_base_atual_trib_est_w	pls_util_cta_pck.t_number_table;
nr_vl_trib_pess_est_w		pls_pp_valor_trib_pessoa.nr_sequencia%type;

-- utilizado o in com subselect ao inves de um group by

c01 CURSOR(	nr_seq_lote_pc		pls_pp_lote.nr_sequencia%type,
		nr_seq_prest_estor_pc	pls_pp_prestador.nr_sequencia%type) FOR
	SELECT	x.cd_beneficiario,
		x.cd_cgc,
		x.cd_darf,
		x.cd_pessoa_fisica,
		x.cd_tributo,
		x.dt_competencia,
		x.dt_pgto_tributo,
		x.ie_tipo_contratacao,
		x.ie_tipo_prestador,
		x.ie_tipo_tributo,
		x.nr_seq_prestador,
		x.nr_seq_tipo_prestador,
		x.nr_seq_trib_conta_pagar,
		x.pr_aliquota,
		x.qt_dependente,
		x.vl_base_acumulada,
		x.vl_base_adic,
		x.vl_base_atual,
		x.vl_base_calculo,
		x.vl_base_nao_retido,
		x.vl_base_total,
		x.vl_desc_dependente,
		x.vl_nao_retido,
		x.vl_reducao,
		x.vl_trib_adic,
		x.vl_tributo,
		x.vl_tributo_pago,
		x.nr_sequencia,
		x.nr_seq_regra_irpf
	from	pls_pp_valor_trib_pessoa x
	where	x.nr_seq_lote = nr_seq_lote_pc
	and	x.nr_sequencia in (
					SELECT	d.nr_seq_trib_pessoa
					from	pls_pp_prest_event_prest a,
						pls_pp_it_prest_event_val b,
						pls_pp_base_atual_trib c,
						pls_pp_base_atual_trib d
					where	a.nr_seq_pp_prest = nr_seq_prest_estor_pc
					and	b.nr_seq_prest_even_val = a.nr_seq_pp_prest_even_val
					and	c.nr_seq_lote = nr_seq_lote_pc
					and	c.nr_seq_item_lote = b.nr_seq_item_lote
					and	d.nr_sequencia = c.nr_seq_origem_estorno);

c02 CURSOR(	nr_seq_vl_trib_pess_pc	pls_pp_valor_trib_pessoa.nr_sequencia%type) FOR
	SELECT	b.nr_sequencia
	from	pls_pp_base_atual_trib a,
		pls_pp_base_atual_trib b
	where	a.nr_seq_trib_pessoa = nr_seq_vl_trib_pess_pc
	and	b.nr_seq_origem_estorno = a.nr_sequencia;

BEGIN
-- retorna todos os registros da pls_pp_valor_trib_pessoa que estao vinculados ao pagamento que esta sendo cancelado

for r_c01_w in c01(nr_seq_lote_p, nr_seq_prest_estor_p) loop

	-- insere os registros de estornos e retorna a sequencia do registro inserido para vincular na tabela pls_pp_base_atual_trib

	insert into pls_pp_valor_trib_pessoa(
		cd_beneficiario, cd_cgc, cd_pessoa_fisica,
		cd_tributo, dt_atualizacao, dt_atualizacao_nrec,
		dt_competencia, dt_pgto_tributo, ie_cancelado, 
		ie_tipo_contratacao, ie_tipo_prestador, ie_tipo_tributo, 
		nm_usuario, nm_usuario_nrec, nr_seq_lote, 
		nr_seq_origem_estorno, nr_seq_prestador, nr_seq_regra_irpf, 
		nr_seq_tipo_prestador, nr_seq_trib_conta_pagar, nr_sequencia, 
		pr_aliquota, qt_dependente, vl_base_acumulada, 
		vl_base_adic, vl_base_atual, vl_base_calculo, 
		vl_base_nao_retido, vl_base_total, vl_desc_dependente, 
		vl_nao_retido, vl_reducao, vl_trib_adic, 
		vl_tributo, vl_tributo_pago
	) values (
		r_c01_w.cd_beneficiario, r_c01_w.cd_cgc, r_c01_w.cd_pessoa_fisica,
		r_c01_w.cd_tributo, clock_timestamp(), clock_timestamp(),
		r_c01_w.dt_competencia, r_c01_w.dt_pgto_tributo, 'S',
		r_c01_w.ie_tipo_contratacao, r_c01_w.ie_tipo_prestador, r_c01_w.ie_tipo_tributo,
		nm_usuario_p, nm_usuario_p, nr_seq_lote_p,
		r_c01_w.nr_sequencia, r_c01_w.nr_seq_prestador, r_c01_w.nr_seq_regra_irpf,
		r_c01_w.nr_seq_tipo_prestador, r_c01_w.nr_seq_trib_conta_pagar, nextval('pls_pp_valor_trib_pessoa_seq'),
		r_c01_w.pr_aliquota, r_c01_w.qt_dependente, r_c01_w.vl_base_acumulada,
		r_c01_w.vl_base_adic, r_c01_w.vl_base_atual, r_c01_w.vl_base_calculo,
		r_c01_w.vl_base_nao_retido, r_c01_w.vl_base_total, r_c01_w.vl_desc_dependente,
		r_c01_w.vl_nao_retido, r_c01_w.vl_reducao, r_c01_w.vl_trib_adic,
		r_c01_w.vl_tributo, r_c01_w.vl_tributo_pago
	) returning nr_sequencia into nr_vl_trib_pess_est_w;

	-- com o registro original da pls_pp_valor_trib_pessoa chega aos registros de estorno da pls_pp_base_atual_trib

	-- para que possa fazer o vinculo entre os registros de estorno

	open c02(r_c01_w.nr_sequencia);
	loop
		fetch c02 bulk collect into	tb_nr_base_atual_trib_est_w
		limit pls_util_pck.qt_registro_transacao_w;
		exit when tb_nr_base_atual_trib_est_w.count = 0;

		forall i in tb_nr_base_atual_trib_est_w.first..tb_nr_base_atual_trib_est_w.last
			update	pls_pp_base_atual_trib
			set	nr_seq_trib_pessoa = nr_vl_trib_pess_est_w
			where	nr_sequencia = tb_nr_base_atual_trib_est_w(i);
		commit;
	end loop;
	close c02;
end loop;
commit;
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_pp_canc_pgto_prest_pck.estornar_trib_pessoa_pgto ( nr_seq_lote_p pls_pp_lote.nr_sequencia%type, nr_seq_prest_estor_p pls_pp_prestador.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;
