-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_pp_canc_pgto_prest_pck.estornar_pagamento_prest ( nr_seq_pp_prest_p pls_pp_prestador.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, nr_seq_pp_prest_estor_p INOUT pls_pp_prestador.nr_sequencia%type) AS $body$
DECLARE


nr_seq_prest_estorno_w	pls_pp_prestador.nr_sequencia%type;


BEGIN

select	nextval('pls_pp_prestador_seq')
into STRICT	nr_seq_prest_estorno_w
;

-- insere o registro de estorno

insert into pls_pp_prestador(
	nr_sequencia, dt_atualizacao, dt_atualizacao_nrec,
	nm_usuario, nm_usuario_nrec, dt_cancelamento,
	ie_acao_pgto_negativo, ie_cancelado, ie_exibe_portal,
	nr_seq_lote, nr_seq_origem_estorno, nr_seq_prestador,
	nr_seq_prestador_matriz, vl_apropriado, vl_desconto,
	vl_glosa, vl_liquido,
	vl_minimo_tit_liq, vl_provento, vl_titulo_pagar,
	vl_titulo_receber, vl_tributo, ie_estorno
	)
SELECT	nr_seq_prest_estorno_w, clock_timestamp(), clock_timestamp(),
	nm_usuario_p, nm_usuario_p, clock_timestamp(),
	'N', 'S', ie_exibe_portal,
	nr_seq_lote, nr_seq_pp_prest_p, nr_seq_prestador,
	nr_seq_prestador_matriz, vl_apropriado * -1, vl_desconto * -1,
	vl_glosa * -1, vl_liquido * -1,
	vl_minimo_tit_liq * -1, vl_provento * -1, vl_titulo_pagar * -1,
	vl_titulo_receber * -1, vl_tributo * -1, 'S'
from	pls_pp_prestador
where	nr_sequencia = nr_seq_pp_prest_p;

-- cancela o registro

update	pls_pp_prestador
set	ie_cancelado = 'S',
	dt_cancelamento = clock_timestamp(),
	ie_estorno = 'N'
where	nr_sequencia = nr_seq_pp_prest_p;

-- alimenta o parametro out

nr_seq_pp_prest_estor_p := nr_seq_prest_estorno_w;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_pp_canc_pgto_prest_pck.estornar_pagamento_prest ( nr_seq_pp_prest_p pls_pp_prestador.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, nr_seq_pp_prest_estor_p INOUT pls_pp_prestador.nr_sequencia%type) FROM PUBLIC;
