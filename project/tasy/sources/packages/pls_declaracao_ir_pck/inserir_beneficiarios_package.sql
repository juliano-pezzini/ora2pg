-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


-- inserir_beneficiarios
CREATE OR REPLACE PROCEDURE pls_declaracao_ir_pck.inserir_beneficiarios ( nr_seq_lote_p pls_lote_mens_ir.nr_sequencia%type, nr_seq_pagador_ir_p pls_mens_pagador_ir.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE


_ora2pg_r RECORD;
nr_indice_w			integer;
tb_nr_seq_pagador_ir_w		pls_util_cta_pck.t_number_table;
tb_nr_seq_segurado_w		pls_util_cta_pck.t_number_table;

C01 CURSOR(	nr_seq_lote_pc	pls_lote_mens_ir.nr_sequencia%type) FOR
	SELECT	nr_sequencia nr_seq_pagador_ir,
		nr_seq_pagador
	from	pls_mens_pagador_ir
	where	nr_seq_lote	= nr_seq_lote_pc
	and	((nr_sequencia = nr_seq_pagador_ir_p) or (coalesce(nr_seq_pagador_ir_p::text, '') = ''));

C02 CURSOR(nr_seq_pagador_pc bigint, dt_inicial_pc timestamp, dt_final_pc timestamp) FOR
	SELECT	x.nr_seq_segurado nr_seq_segurado
	from	pls_segurado_pagador	x
	where	x.nr_seq_pagador	= nr_seq_pagador_pc
	group by
		x.nr_seq_segurado
	
union

	SELECT	a.nr_seq_segurado nr_seq_segurado
	from	pls_segurado_pagador a,
		pls_contrato_pagador b,
		pls_pagador_item_mens c
	where	b.nr_sequencia	= a.nr_seq_pagador
	and	b.nr_sequencia = c.nr_seq_pagador
	and	c.nr_seq_pagador_item = nr_seq_pagador_pc
	
union

	select	a.nr_seq_segurado
	from	pls_titulo_rec_liq_neg a,
		titulo_receber_liq d,
		titulo_receber b,
		negociacao_cr c
	where	a.nr_titulo = b.nr_titulo
	and	d.nr_titulo = a.nr_titulo
	and	d.nr_sequencia = a.nr_seq_baixa
	and	c.nr_sequencia = b.nr_seq_negociacao_origem
	and	c.nr_seq_pagador = nr_seq_pagador_pc
	and 	coalesce(d.nr_seq_liq_origem::text, '') = ''
	and	d.dt_recebimento between dt_inicial_pc and dt_final_pc
	and 	not exists (	select 1
				from   titulo_receber_liq x
				where  x.nr_titulo		= d.nr_titulo
				and    x.nr_seq_liq_origem   	= d.nr_sequencia)
	group by
		a.nr_seq_segurado
	
union

	select	a.nr_seq_segurado
	from	pls_sca_vinculo a
	where	a.nr_seq_pagador = nr_seq_pagador_pc
	group by
		a.nr_seq_segurado;
BEGIN

nr_indice_w	:= 0;
tb_nr_seq_pagador_ir_w.delete;
tb_nr_seq_segurado_w.delete;

for r_c01_w in C01(nr_seq_lote_p) loop
	begin

	for r_c02_w in C02(r_c01_w.nr_seq_pagador, current_setting('pls_declaracao_ir_pck.dt_inicial_w')::timestamp, current_setting('pls_declaracao_ir_pck.dt_final_w')::timestamp) loop
		begin
		tb_nr_seq_pagador_ir_w(nr_indice_w)	:= r_c01_w.nr_seq_pagador_ir;
		tb_nr_seq_segurado_w(nr_indice_w)	:= r_c02_w.nr_seq_segurado;
		
		if (nr_indice_w >= pls_util_pck.qt_registro_transacao_w) then
			SELECT * FROM pls_declaracao_ir_pck.insert_beneficiario(	tb_nr_seq_pagador_ir_w, tb_nr_seq_segurado_w, nm_usuario_p) INTO STRICT _ora2pg_r;
 	tb_nr_seq_pagador_ir_w := _ora2pg_r.tb_nr_seq_pagador_ir_p; tb_nr_seq_segurado_w := _ora2pg_r.tb_nr_seq_segurado_p;
			
			nr_indice_w	:= 0;
		else
			nr_indice_w	:= nr_indice_w + 1;
		end if;
		end;
	end loop;
	end;
end loop;

SELECT * FROM pls_declaracao_ir_pck.insert_beneficiario(	tb_nr_seq_pagador_ir_w, tb_nr_seq_segurado_w, nm_usuario_p) INTO STRICT _ora2pg_r;
 	tb_nr_seq_pagador_ir_w := _ora2pg_r.tb_nr_seq_pagador_ir_p; tb_nr_seq_segurado_w := _ora2pg_r.tb_nr_seq_segurado_p;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_declaracao_ir_pck.inserir_beneficiarios ( nr_seq_lote_p pls_lote_mens_ir.nr_sequencia%type, nr_seq_pagador_ir_p pls_mens_pagador_ir.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;
