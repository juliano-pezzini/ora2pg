-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------




CREATE OR REPLACE FUNCTION pls_gerenciar_reembolso_pck.obter_restricao_fil_item ( nr_id_transacao_p pls_def_reemb_selecao.nr_id_transacao%type, dados_filtro_p pls_gerenciar_reembolso_pck.dados_filtro, ie_proc_mat_p text, valor_bind_p INOUT sql_pck.t_dado_bind) AS $body$
DECLARE


qt_filtro_item_w	integer;
ds_sql_w		varchar(300);


BEGIN

-- Obter a quantidade de filtros de conta na regra

select	count(1)
into STRICT	qt_filtro_item_w
from	pls_def_reemb_selecao a
where	a.nr_id_transacao = nr_id_transacao_p
and	a.nr_seq_filtro = dados_filtro_p.nr_sequencia
and	a.ie_valido = 'S';

ds_sql_w := null;

-- So retorna algo se existir filtro de conta na regra

if (qt_filtro_item_w > 0) then
	
	-- Monta a restricao para verificar se a conta se encaixou nos filtros da regra

	ds_sql_w :=	' and	exists (select	1 							' || pls_util_pck.enter_w ||
			'		from	pls_def_reemb_selecao 	x			' || pls_util_pck.enter_w ||
			'		where	x.nr_id_transacao 	= :nr_id_transacao 		' || pls_util_pck.enter_w ||
			'		and	x.ie_valido 		= ''S'' 			' || pls_util_pck.enter_w ||
			' 		and	x.nr_seq_filtro 	= :nr_seq_filtro 		' || pls_util_pck.enter_w;
	
	if (ie_proc_mat_p = 'P')  then
		ds_sql_w := ds_sql_w || ' and	x.nr_seq_conta_proc = a.nr_sequencia ' || pls_util_pck.enter_w;
	elsif (ie_proc_mat_p = 'M')  then
		ds_sql_w := ds_sql_w || ' and	x.nr_seq_conta_mat = a.nr_sequencia ' || pls_util_pck.enter_w;
	end if;	
	
	ds_sql_w := ds_sql_w || ')';	

	valor_bind_p := sql_pck.bind_variable(':nr_id_transacao', nr_id_transacao_p, valor_bind_p);
	valor_bind_p := sql_pck.bind_variable(':nr_seq_filtro', dados_filtro_p.nr_sequencia, valor_bind_p);	

end if;

return;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pls_gerenciar_reembolso_pck.obter_restricao_fil_item ( nr_id_transacao_p pls_def_reemb_selecao.nr_id_transacao%type, dados_filtro_p pls_gerenciar_reembolso_pck.dados_filtro, ie_proc_mat_p text, valor_bind_p INOUT sql_pck.t_dado_bind) FROM PUBLIC;
