-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------




CREATE OR REPLACE PROCEDURE pls_gerenciar_reembolso_pck.aplica_acao_regra ( dados_regra_p pls_gerenciar_reembolso_pck.dados_regra, dt_atendimento_p pls_conta.dt_atendimento%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) AS $body$
DECLARE


ie_acao_w	pls_regra_reemb_acao.ie_acao%type;

c_acao_regra CURSOR( 	dt_atendimento_pc	pls_conta.dt_atendimento%type,
			nr_seq_regra_pc		pls_regra_reembolso.nr_sequencia%type) FOR
	SELECT	a.nr_sequencia,
		a.nr_seq_regra
	from	pls_regra_reemb_acao	a
	where	a.nr_seq_regra = nr_seq_regra_pc
	and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
	and	dt_atendimento_pc between
			CASE WHEN coalesce(a.dt_inicio_vigencia::text, '') = '' THEN  dt_atendimento_pc  ELSE a.dt_inicio_vigencia END  and 
			CASE WHEN coalesce(a.dt_fim_vigencia::text, '') = '' THEN  dt_atendimento_pc  ELSE a.dt_fim_vigencia END;	
			
c_reemb_proc CURSOR( nr_seq_regra_pc	pls_regra_reembolso.nr_sequencia%type) FOR	  
	SELECT	a.nr_seq_conta_proc
	from	pls_def_reemb_selecao	a,
		pls_regra_reemb_filtro		b
	where	a.nr_seq_filtro = b.nr_sequencia
	and	a.ie_valido = 'S'
	and	(a.nr_seq_conta_proc IS NOT NULL AND a.nr_seq_conta_proc::text <> '')
	and	b.nr_seq_regra = nr_seq_regra_pc;

c_reemb_mat CURSOR( nr_seq_regra_pc	pls_regra_reembolso.nr_sequencia%type) FOR	 	
	SELECT	a.nr_seq_conta_mat
	from	pls_def_reemb_selecao	a,
		pls_regra_reemb_filtro		b
	where	a.nr_seq_filtro = b.nr_sequencia
	and	a.ie_valido = 'S'
	and	(a.nr_seq_conta_mat IS NOT NULL AND a.nr_seq_conta_mat::text <> '')
	and	b.nr_seq_regra = nr_seq_regra_pc;
		
BEGIN

for r_c_acao_regra in c_acao_regra(dt_atendimento_p, dados_regra_p.nr_sequencia) loop

	for r_c_reemb_proc in c_reemb_proc(r_c_acao_regra.nr_seq_regra) loop
			
		update	pls_conta_proc
		set	nr_seq_regra_acao_reemb = r_c_acao_regra.nr_sequencia,
			nm_usuario = nm_usuario_p,
			dt_atualizacao = clock_timestamp()
		where	nr_sequencia = r_c_reemb_proc.nr_seq_conta_proc;
	end loop;
		
	
	for r_c_reemb_mat in c_reemb_mat(r_c_acao_regra.nr_seq_regra) loop
	
		update	pls_conta_mat
		set	nr_seq_regra_acao_reemb = r_c_acao_regra.nr_sequencia,
			nm_usuario = nm_usuario_p,
			dt_atualizacao = clock_timestamp()
		where	nr_sequencia = r_c_reemb_mat.nr_seq_conta_mat;

	end loop;	
end loop;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerenciar_reembolso_pck.aplica_acao_regra ( dados_regra_p pls_gerenciar_reembolso_pck.dados_regra, dt_atendimento_p pls_conta.dt_atendimento%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) FROM PUBLIC;
