-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pls_gerenciar_reembolso_pck.obter_ordem_sugerida_regra ( nr_seq_cp_cta_p pls_regra_reembolso.nr_sequencia%type) RETURNS bigint AS $body$
DECLARE


nr_valor_total_w	pls_regra_reembolso.nr_ordem_execucao%type;
nr_valor_filtro_w	pls_regra_reembolso.nr_ordem_execucao%type;
					
C01 CURSOR(nr_seq_cp_cta_pc	pls_regra_reembolso.nr_sequencia%type) FOR
	SELECT	b.nr_sequencia 	nr_seq_cp_filtro,
		b.ie_filtro_benef	ie_filtro_beneficiario,
		b.ie_filtro_atend 	ie_filtro_atendimento,
		b.ie_filtro_mat 	ie_filtro_material,
		b.ie_filtro_proc	ie_filtro_procedimento,
		b.ie_filtro_qtd		ie_filtro_qtde
	from	pls_regra_reembolso a,
			pls_regra_reemb_filtro b
	where	a.nr_sequencia = nr_seq_cp_cta_pc
	and	a.ie_ordenacao_sugerida = 'S'
	and	b.nr_seq_regra = a.nr_sequencia
	and	b.ie_situacao = 'A';
	
BEGIN
-- iniciliza a variavel

nr_valor_total_w := 0;

-- verifica para cada registro do cursor quais sao os filtros que estao ativos, caso o filtro esteja ativo faz 

-- a contagem do valor dos filtros sendo que para cada campo com valor informado vale 100 pontos no peso da regra

-- apos verificar os filtros se retornar um valor e somado 500 pontos por ter algum registro informado no filtro 

-- que esta ativo ex: filtro beneficiario esta ativo e existe 1 regra de filtro nele com um campo informado este 

-- campo dara 100 pontos, e por ter um filtro de beneficiario valido recebe mais 500 pontos total 600. ex2: filtro

-- beneficiario esta ativo porem nao existe nenhuma regra de filtro informada, total de pontos 0 pois para contabilizar 

-- os 500 pontos precisaria ter ao menos 1 regra valida

for r_C01_w in C01(nr_seq_cp_cta_p) loop

	-- verifica as regras de filtro de beneficario

	if (r_C01_w.ie_filtro_beneficiario = 'S') then
	
		nr_valor_filtro_w := pls_gerenciar_reembolso_pck.obter_qt_ponto_filtro(	r_C01_w.nr_seq_cp_filtro, 'PLS_REGRA_REEMB_FIL_BENEF');
		
		-- se retornou um valor significa que o filtro e valido entao somamos o valor que a regra combinada ja tem

		-- mais 500 pelo filtro estar valido e o valor que retornou dos filtros

		if (nr_valor_filtro_w > 0) then
		
			nr_valor_total_w := nr_valor_total_w + 500 + nr_valor_filtro_w;
		end if;
	end if;
	-- verifica as regras de filtro de conta

	if (r_C01_w.ie_filtro_atendimento = 'S') then
	
		nr_valor_filtro_w := pls_gerenciar_reembolso_pck.obter_qt_ponto_filtro(	r_C01_w.nr_seq_cp_filtro, 'PLS_REGRA_REEMB_FIL_ATEND');
		
		-- se retornou um valor significa que o filtro e valido entao somamos o valor que a regra combinada ja tem

		-- mais 500 pelo filtro estar valido e o valor que retornou dos filtros

		if (nr_valor_filtro_w > 0) then
		
			nr_valor_total_w := nr_valor_total_w + 500 + nr_valor_filtro_w;
		end if;
	end if;

	-- verifica as regras de filtro de material

	if (r_C01_w.ie_filtro_material = 'S') then
	
		nr_valor_filtro_w := pls_gerenciar_reembolso_pck.obter_qt_ponto_filtro(	r_C01_w.nr_seq_cp_filtro, 'PLS_REGRA_REEMB_FIL_MAT');
		
		-- se retornou um valor significa que o filtro e valido entao somamos o valor que a regra combinada ja tem

		-- mais 500 pelo filtro estar valido e o valor que retornou dos filtros

		if (nr_valor_filtro_w > 0) then
		
			nr_valor_total_w := nr_valor_total_w + 500 + nr_valor_filtro_w;
		end if;
	end if;

	-- verifica as regras de filtro de procedimento

	if (r_C01_w.ie_filtro_procedimento = 'S') then
	
		nr_valor_filtro_w := pls_gerenciar_reembolso_pck.obter_qt_ponto_filtro(	r_C01_w.nr_seq_cp_filtro, 'PLS_REGRA_REEMB_FIL_PROC');
		
		-- se retornou um valor significa que o filtro e valido entao somamos o valor que a regra combinada ja tem

		-- mais 500 pelo filtro estar valido e o valor que retornou dos filtros

		if (nr_valor_filtro_w > 0) then
		
			nr_valor_total_w := nr_valor_total_w + 500 + nr_valor_filtro_w;
		end if;
	end if;	
	
	-- verifica as regras de filtro de quantidade

	if (r_C01_w.ie_filtro_qtde = 'S') then
	
		nr_valor_filtro_w := pls_gerenciar_reembolso_pck.obter_qt_ponto_filtro(	r_C01_w.nr_seq_cp_filtro, 'PLS_REGRA_REEMB_FIL_QTD');
		
		-- se retornou um valor significa que o filtro e valido entao somamos o valor que a regra combinada ja tem

		-- mais 500 pelo filtro estar valido e o valor que retornou dos filtros

		if (nr_valor_filtro_w > 0) then
		
			nr_valor_total_w := nr_valor_total_w + 500 + nr_valor_filtro_w;
		end if;
	end if;	

end loop;
	
return nr_valor_total_w;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pls_gerenciar_reembolso_pck.obter_ordem_sugerida_regra ( nr_seq_cp_cta_p pls_regra_reembolso.nr_sequencia%type) FROM PUBLIC;
