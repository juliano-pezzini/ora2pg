-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE qsm_document_pck.getdocumentlist_response (nr_seq_fila_p bigint) AS $body$
DECLARE


reg_integracao_p			gerar_int_padrao.reg_integracao;
nm_usuario_w				intpd_fila_transmissao.nm_usuario%type;
nr_seq_documento_w			intpd_fila_transmissao.nr_seq_documento%type;

nr_atendimento_w			atendimento_paciente.nr_atendimento%type;

ds_client_w				varchar(32);
ds_case_documents_w			varchar(32);
ds_id_document_w			varchar(32);
ds_header_w				xml;
ds_admissionDate_w 			varchar(32);
ds_cancelled_w				varchar(32);
ds_case_w				varchar(32);
ds_department_w				varchar(32);
ds_dischargeDate_w			varchar(32);
ds_documentingOU_w			varchar(32);
ds_employee_Responsible_w		varchar(32);
ds_exported_w				varchar(32);
ds_module_w				varchar(32);
ds_oiNumber_w				varchar(32);
ds_patient_w				varchar(32);
ds_patient_birth_date_w			varchar(32);
ds_patientName_w			varchar(32);
ds_patientSex_w				varchar(32);
ds_released_w				varchar(32);
ds_role_w				varchar(32);
ds_status_w				varchar(32);


xml_w					xml;
ds_xml_w				text;
ds_erro_w				varchar(4000);

C01 CURSOR FOR
	SELECT	ds_case,
            ds_client
	from	xmltable(
			xmlnamespaces(
			'http://schemas.xmlsoap.org/soap/envelope/' as "soapenv"),
			'soapenv:Envelope/soapenv:Body/getDocumentListResponse/caseDocuments' passing xml_w columns
            ds_case		varchar(32)	path	'@case',
			ds_client	varchar(32)	path	'@client');

C02 CURSOR FOR
	SELECT	ds_id,
			ds_header,
            ds_status
	from	xmltable(
			xmlnamespaces(
            'http://schemas.xmlsoap.org/soap/envelope/' as "soapenv"),
			'soapenv:Envelope/soapenv:Body/getDocumentListResponse/caseDocuments/document' passing xml_w columns
			ds_id		varchar(32)	path	'@id',
            ds_header	xml		path	'header',
			ds_status	xml		path	'status');

C03 CURSOR FOR
	SELECT	ds_role,
            ds_status
	from	xmltable(
			xmlnamespaces(
			'http://www.mmm.com/his/qsmed/doc' as "doc",
			'http://schemas.xmlsoap.org/soap/envelope/' as "soapenv"),
			'soapenv:Envelope/soapenv:Body/getDocumentListResponse/caseDocuments/document/status' passing xml_w columns
	ds_role		varchar(32)	path	'@role',
    ds_status	varchar(32)	path	'@status');
BEGIN
begin
select	replace(ds_xml_retorno,'xmlns="http://www.mmm.com/his/qsmed/doc"',''),
	nm_usuario,
	nr_seq_documento
into STRICT	ds_xml_w,
	nm_usuario_w,
	nr_seq_documento_w
from	intpd_fila_transmissao a
where	a.nr_sequencia	= nr_seq_fila_p;

xml_w	:= xmlparse(DOCUMENT, convert_from(, 'utf-8'));
for r_C01_w in C01 loop
	begin
	for r_C02_w in C02 loop
		begin
		for r_C03_w in C03 loop
			begin
			if	(r_C03_w.ds_role = 'USE' AND r_C03_w.ds_status = 'REDUNDANT') then

				select	max(nr_atendimento)
				into STRICT	nr_atendimento_w
				from	atendimento_paciente
				where	nr_seq_episodio		= r_C01_w.ds_case;
				CALL gerar_int_padrao.set_executando_recebimento('N');
				CALL qsm_gravar_integracao('132', r_C02_w.ds_id,nm_usuario_w, 'true;false;S;'||nr_seq_documento_w);
				CALL gerar_int_padrao.set_executando_recebimento('S');
			end if;

			end;
		end loop;
		end;
	end loop;
	end;
end loop;

update	intpd_fila_transmissao
set	ie_status		= 'S',
	ie_response_procedure	= 'S',
	dt_atualizacao		= clock_timestamp()
where	nr_sequencia		= nr_seq_fila_p;

commit;

exception
when others then
	begin
	ds_erro_w	:= substr(dbms_utility.format_error_backtrace || chr(13) || chr(10) || sqlerrm,1,2000);

	rollback;

	update	intpd_fila_transmissao
	set	ie_status		= 'E',
		ie_response_procedure	= 'S',
		ds_log			= ds_erro_w,
		dt_atualizacao		= clock_timestamp()
	where	nr_sequencia		= nr_seq_fila_p;

	commit;
	end;
end;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE qsm_document_pck.getdocumentlist_response (nr_seq_fila_p bigint) FROM PUBLIC;
