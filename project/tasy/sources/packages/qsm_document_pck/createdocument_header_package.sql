-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



-- createDocument
CREATE OR REPLACE FUNCTION qsm_document_pck.createdocument_header ( nr_seq_fila_p bigint) RETURNS SETOF T_CREATEDOCUMENT_HEADER AS $body$
DECLARE


C01 CURSOR(nr_atendimento_pc bigint) FOR
SELECT	a.dt_entrada admissionDate,
	coalesce(b.nr_episodio, b.nr_sequencia) ds_case,
	e.cd_estabelecimento client_id,
	obter_departamento_data(a.nr_atendimento) department,
	a.dt_alta_medico dischargeDate,
	'' documentingOU,
	a.cd_medico_resp employeeResponsible,
	'' ds_module,
	'' oiNumber,
	coalesce(obter_pf_codigo_externo('ISH', pf.cd_pessoa_fisica),pf.cd_pessoa_fisica) patient,
	pf.dt_nascimento patientDateOfBirth,
	obter_dados_pf(pf.cd_pessoa_fisica, 'PNC') patientName,
	CASE WHEN pf.ie_sexo='M' THEN 'male' WHEN pf.ie_sexo='F' THEN 'female'  ELSE 'unknown' END  patientSex
from	atendimento_paciente a,
	episodio_paciente b,
	pessoa_fisica pf,
	estabelecimento e,
	pessoa_juridica pj
where	a.nr_atendimento	= nr_atendimento_pc
and	a.nr_seq_episodio	= b.nr_sequencia
and	a.cd_pessoa_fisica	= pf.cd_pessoa_fisica
and	a.cd_estabelecimento	= e.cd_estabelecimento
and	e.cd_cgc		= pj.cd_cgc;

ds_parametros_adic_w			intpd_fila_transmissao.ds_parametros_adic%type;
ie_conversao_w				intpd_eventos_sistema.ie_conversao%type;
nr_seq_regra_w				intpd_eventos_sistema.nr_seq_regra_conv%type;
r_createDocument_header_row_w		r_createDocument_header_row;
ds_param_list_w				dbms_sql.varchar2_table;

BEGIN
select	coalesce(b.ie_conversao,'I'),
	b.nr_seq_regra_conv,
	a.ds_parametros_adic
into STRICT	ie_conversao_w,
	nr_seq_regra_w,
	ds_parametros_adic_w
from	intpd_fila_transmissao a,
	intpd_eventos_sistema b
where	a.nr_seq_evento_sistema = b.nr_sequencia
and	a.nr_sequencia		= nr_seq_fila_p;

ds_param_list_w		:= obter_lista_string(ds_parametros_adic_w, ';');

for r_C01_w in C01(ds_param_list_w(2)) loop
	begin
	r_createDocument_header_row_w := qsm_document_pck.limpar_atrib_createdoc_header(r_createDocument_header_row_w);

	r_createDocument_header_row_w.admissionDate		:= to_char(r_C01_w.admissionDate,'yyyy-mm-dd');
	r_createDocument_header_row_w.ds_case			:= r_C01_w.ds_case;
	r_createDocument_header_row_w.client_id			:= intpd_conv('ESTABELECIMENTO', 'CD_ESTABELECIMENTO', r_C01_w.client_id, nr_seq_regra_w, ie_conversao_w, 'E');
	r_createDocument_header_row_w.department		:= intpd_conv('ATEND_PACIENTE_UNIDADE', 'CD_DEPARTAMENTO', r_C01_w.department, nr_seq_regra_w, ie_conversao_w, 'E');
	r_createDocument_header_row_w.dischargeDate		:= to_char(r_C01_w.dischargeDate,'yyyy-mm-dd');
	r_createDocument_header_row_w.documentingOU		:= r_C01_w.documentingOU;
	r_createDocument_header_row_w.employeeResponsible	:= r_C01_w.employeeResponsible;
	r_createDocument_header_row_w.ds_module			:= ds_param_list_w(1);
	r_createDocument_header_row_w.oiNumber			:= r_C01_w.oiNumber;
	r_createDocument_header_row_w.patient			:= r_C01_w.patient;
	r_createDocument_header_row_w.patientDateOfBirth	:= to_char(r_C01_w.patientDateOfBirth,'yyyy-mm-dd');
	r_createDocument_header_row_w.patientName		:= r_C01_w.patientName;
	r_createDocument_header_row_w.patientSex		:= r_C01_w.patientSex;

	RETURN NEXT r_createDocument_header_row_w;
	end;
end loop;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION qsm_document_pck.createdocument_header ( nr_seq_fila_p bigint) FROM PUBLIC;
