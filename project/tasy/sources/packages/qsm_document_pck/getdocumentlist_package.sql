-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



-- getDocumentList
CREATE OR REPLACE FUNCTION qsm_document_pck.getdocumentlist ( nr_seq_fila_p bigint) RETURNS SETOF T_GETDOCUMENTLIST AS $body$
DECLARE


C01 CURSOR(nr_atendimento_pc bigint) FOR
	SELECT	a.cd_estabelecimento client_id,
		b.nr_sequencia case_id,
		'true' headerRequested,
		'true' includeCancelled,
		'true' statusRequested
	from	atendimento_paciente a,
		episodio_paciente b
	where	a.nr_atendimento	= nr_atendimento_pc
	and	a.nr_seq_episodio	= b.nr_sequencia;

nr_seq_documento_w			intpd_fila_transmissao.nr_seq_documento%type;
ie_conversao_w				intpd_eventos_sistema.ie_conversao%type;
nr_seq_sistema_w			intpd_eventos_sistema.nr_seq_sistema%type;
nr_seq_projeto_xml_w			intpd_eventos_sistema.nr_seq_projeto_xml%type;
nr_seq_regra_w				intpd_eventos_sistema.nr_seq_regra_conv%type;
r_getDocumentList_row_w			r_getDocumentList_row;
nr_atendimento_w			atendimento_paciente.nr_atendimento%type;

BEGIN
select	a.nr_seq_documento,
	coalesce(b.ie_conversao,'I'),
	b.nr_seq_sistema,
	b.nr_seq_projeto_xml,
	b.nr_seq_regra_conv
into STRICT	nr_seq_documento_w,
	ie_conversao_w,
	nr_seq_sistema_w,
	nr_seq_projeto_xml_w,
	nr_seq_regra_w
from	intpd_fila_transmissao a,
	intpd_eventos_sistema b
where	a.nr_seq_evento_sistema = b.nr_sequencia
and	a.nr_sequencia		= nr_seq_fila_p;

for r_C01_w in C01(nr_seq_documento_w) loop
	begin
	r_getDocumentList_row_w := qsm_document_pck.limpar_atrib_getdocumentlist(r_getDocumentList_row_w);

	r_getDocumentList_row_w.client_id		:= intpd_conv('ESTABELECIMENTO', 'CD_ESTABELECIMENTO', r_C01_w.client_id, nr_seq_regra_w, ie_conversao_w, 'E');
	r_getDocumentList_row_w.case_id			:= r_C01_w.case_id;
	r_getDocumentList_row_w.headerRequested		:= r_C01_w.headerRequested;
	r_getDocumentList_row_w.includeCancelled	:= r_C01_w.includeCancelled;
	r_getDocumentList_row_w.statusRequested		:= r_C01_w.statusRequested;

	RETURN NEXT r_getDocumentList_row_w;
	end;
end loop;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION qsm_document_pck.getdocumentlist ( nr_seq_fila_p bigint) FROM PUBLIC;
