-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE qsm_document_pck.preparedocumenteditor_response (nr_sequencia_p bigint) AS $body$
DECLARE


nr_seq_doc_origem_w		intpd_fila_transmissao.nr_seq_documento%type;

ds_url_w			varchar(2000);
ds_url_schema_w			varchar(2000);
ds_id_w				varchar(32);
ds_value_w			varchar(32);

xml_w				xml;
ds_xml_w			text;
ds_erro_w			varchar(4000);

C01 CURSOR FOR
	SELECT	editorParameters
	from	xmltable(
			xmlnamespaces(
			'http://www.mmm.com/his/qsmed/doc' as "doc",
			'http://schemas.xmlsoap.org/soap/envelope/' as "soapenv"),
			'soapenv:Envelope/soapenv:Body' passing xml_w columns
			prepareDocumentEditorResponse	xml		path	'doc:prepareDocumentEditorResponse') x,
		xmltable(
			xmlnamespaces(
			'http://www.mmm.com/his/qsmed/doc' as "doc",
			'http://schemas.xmlsoap.org/soap/envelope/' as "soapenv"),
			'doc:prepareDocumentEditorResponse' passing x.prepareDocumentEditorResponse columns
			editorParameters	xml		path	'doc:editorParameters') z;

C02 CURSOR(editorParameters_pc xml) FOR
	SELECT	z.ds_id,
		z.ds_value
	from	xmltable(
			xmlnamespaces(
			'http://www.mmm.com/his/qsmed/doc' as "doc"),
			'doc:editorParameters' passing editorParameters_pc columns
			parameter	xml	path	'doc:parameter') x,
		xmltable(
			xmlnamespaces(
			'http://www.mmm.com/his/qsmed/doc' as "doc"),
			'doc:parameter' passing x.parameter columns
			ds_id		varchar(32)	path	'@id',
			ds_value	varchar(32)	path	'@value') z;

C10 CURSOR FOR
	SELECT	messages
	from	xmltable(
			xmlnamespaces(
			'http://www.mmm.com/his/qsmed/doc' as "doc",
			'http://schemas.xmlsoap.org/soap/envelope/' as "soapenv"),
			'soapenv:Envelope/soapenv:Body' passing xml_w columns
			prepareDocumentEditorResponse	xml		path	'doc:prepareDocumentEditorResponse') x,
		xmltable(
			xmlnamespaces(
			'http://www.mmm.com/his/qsmed/doc' as "doc",
			'http://schemas.xmlsoap.org/soap/envelope/' as "soapenv"),
			'doc:prepareDocumentEditorResponse' passing x.prepareDocumentEditorResponse columns
			messages		xml		path	'doc:messages') z;
BEGIN
begin

select	ds_xml_retorno,
	nr_seq_documento
into STRICT	ds_xml_w,
	nr_seq_doc_origem_w
from	intpd_fila_transmissao a
where	a.nr_sequencia	= nr_sequencia_p;

xml_w	:= xmlparse(DOCUMENT, convert_from(, 'utf-8'));

for r_C01_w in C01 loop
	begin

	begin
		select	ds_url_schema
		into STRICT	ds_url_schema_w
		from	xmltable(
				xmlnamespaces(
				'http://www.mmm.com/his/qsmed/doc' as "doc"),
				'doc:editorParameters' passing r_C01_w.editorParameters columns
				ds_url_schema		varchar2(2000)	path	'@urlSchema');

	exception
	when others then
		ds_url_schema_w		:= null;
	end;

	ds_url_w := ds_url_schema_w;

	for r_C02_w in C02(r_C01_w.editorParameters) loop
		begin
			ds_url_w := replace(ds_url_w,'$'||r_C02_w.ds_id||'$', r_C02_w.ds_value||'@');
		end;
	end loop;

	update	episodio_pac_document
	set	ds_url		= ds_url_w
	where	nr_sequencia	= nr_seq_doc_origem_w;

	end;
end loop;

for r_C10_w in C10 loop
	begin
	CALL qsm_messages_pck.qsm_process_message( nr_sequencia_p, r_C10_w.messages, 'N' );
	end;
end loop;

update	intpd_fila_transmissao
set	ie_status		= 'S',
	ie_response_procedure	= 'S',
	dt_atualizacao		= clock_timestamp()
where	nr_sequencia		= nr_sequencia_p;

commit;

exception
when others then
	begin
	ds_erro_w	:= substr(dbms_utility.format_error_backtrace || chr(13) || chr(10) || sqlerrm,1,2000);

	rollback;

	update	intpd_fila_transmissao
	set	ie_status		= 'E',
		ie_response_procedure	= 'S',
		ds_log			= ds_erro_w,
		dt_atualizacao		= clock_timestamp()
	where	nr_sequencia		= nr_sequencia_p;

	commit;
	end;
end;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE qsm_document_pck.preparedocumenteditor_response (nr_sequencia_p bigint) FROM PUBLIC;
