-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE qsm_document_pck.changedocument_response ( nr_sequencia_p bigint, ds_xml_p text) AS $body$
DECLARE


xml_w			xml;
ds_erro_w		varchar(4000);

C01 CURSOR(ds_xml_pc xml) FOR
	SELECT	z.messages
	from	xmltable(
			xmlnamespaces(
			'http://www.mmm.com/his/qsmed/doc' as "doc",
			'http://schemas.xmlsoap.org/soap/envelope/' as "soapenv"),
			'soapenv:Envelope/soapenv:Body' passing ds_xml_pc columns
			changeDocumentResponse		xml		path	'doc:changeDocumentResponse') x,
		xmltable(
			xmlnamespaces(
			'http://www.mmm.com/his/qsmed/doc' as "doc",
			'http://schemas.xmlsoap.org/soap/envelope/' as "soapenv"),
			'doc:changeDocumentResponse' passing x.changeDocumentResponse columns
			messages		xml		path	'doc:messages') z;

BEGIN
begin
xml_w		:= xmlparse(DOCUMENT, convert_from(, 'utf-8'));

for r_C01_w in C01(xml_w) loop
	begin
	CALL qsm_messages_pck.qsm_process_message( nr_sequencia_p, r_C01_w.messages, 'N' );
	end;
end loop;

update	intpd_fila_transmissao
set	ie_status		= 'S',
	ie_response_procedure	= 'S',
	dt_atualizacao		= clock_timestamp(),
	ds_xml_retorno		= ds_xml_p
where	nr_sequencia		= nr_sequencia_p;

commit;

exception
when others then
	begin
	ds_erro_w	:= substr(dbms_utility.format_error_backtrace || chr(13) || chr(10) || sqlerrm,1,2000);

	rollback;

	update	intpd_fila_transmissao
	set	ie_status		= 'E',
		ie_response_procedure	= 'S',
		ds_log			= ds_erro_w,
		dt_atualizacao		= clock_timestamp(),
		ds_xml_retorno		= ds_xml_p
	where	nr_sequencia		= nr_sequencia_p;

	commit;
	end;
end;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE qsm_document_pck.changedocument_response ( nr_sequencia_p bigint, ds_xml_p text) FROM PUBLIC;
