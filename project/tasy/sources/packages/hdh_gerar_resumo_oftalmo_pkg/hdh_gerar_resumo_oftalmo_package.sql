-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE hdh_gerar_resumo_oftalmo_pkg.hdh_gerar_resumo_oftalmo ( cd_pessoa_fisica_p text, nm_usuario_p text, ds_fundoscopia_p text) AS $body$
DECLARE

 
	nm_medico_w				varchar(80);
	nm_medico_cirurgiao_w	varchar(80);
	cd_pessoa_usuario_w		varchar(10);
	cd_medico_w				varchar(10);
	ie_dinamica_w			varchar(1);
	ie_estatica_w			varchar(1);
	ie_receita_w			varchar(1);
	ie_adicao_w				varchar(1);
	vl_de_rd_od_w			varchar(10);
	vl_dc_rd_od_w			varchar(10);
	vl_eixo_rd_od_w			varchar(10);
	ds_visao_rd_od_w		varchar(40);
	vl_de_rd_oe_w			varchar(10);
	vl_dc_rd_oe_w			varchar(10);
	vl_eixo_rd_oe_w			varchar(10);
	ds_visao_rd_oe_w		varchar(40);
	vl_de_re_od_w			varchar(10);
	vl_dc_re_od_w			varchar(10);
	vl_eixo_re_od_w			varchar(10);
	ds_visao_re_od_w		varchar(40);
	vl_de_re_oe_w			varchar(10);
	vl_dc_re_oe_w			varchar(10);
	vl_eixo_re_oe_w			varchar(10);
	ds_visao_re_oe_w		varchar(40);
	vl_de_receita_od_w		varchar(10);
	vl_dc_receita_od_w		varchar(10);
	vl_eixo_receita_od_w	varchar(10);
	ds_visao_receita_od_w	varchar(40);
	vl_de_receita_oe_w		varchar(10);
	vl_dc_receita_oe_w		varchar(10);
	vl_eixo_receita_oe_w	varchar(10);
	ds_visao_receita_oe_w	varchar(40);
	vl_adicao_od_w			varchar(10);
	vl_adicao_oe_w			varchar(10);
	vl_soma_de_rd_od_w		varchar(10);
	vl_soma_de_rd_oe_w		varchar(10);
	dt_consulta_w			varchar(30);
	ds_queixa_paciente_w	varchar(4000);
	ds_fundoscopia_w		varchar(4000);
	ds_biomicroscopia_w		varchar(4000);
	ds_outros_exames_w		varchar(4000);
	ds_hip_diag_w			varchar(4000);
	ds_conduta_w			varchar(4000);
	ds_diagnostico_w		varchar(300);
	nr_seq_laudo_w			bigint;
	ds_consulta_w			varchar(32000);
	vl_pressao_od_w			varchar(40);
	vl_pressao_oe_w			varchar(40);
	hr_pressao_w			varchar(10);
	ds_procedimento_w		PROCEDIMENTO.DS_PROCEDIMENTO%type;
	ds_exames_long_w		text;
	ds_exam_adic_long_w	text;
	ie_tipo_fundoscopia_w	varchar(1);
	ds_av_sc_od_w			varchar(40);
	ds_av_cc_od_w			varchar(40);
	ds_av_sc_oe_w			varchar(40);
	ds_av_cc_oe_w			varchar(40);
	ds_meo_w				varchar(60);
	vl_visao_rd_od_w		varchar(3);
	vl_visao_rd_oe_w		varchar(3);
	vl_visao_re_od_w		varchar(3);
	vl_visao_re_oe_w		varchar(3);
	vl_visao_receita_od_w	varchar(3);
	vl_visao_receita_oe_w	varchar(3);
	ds_olho_diag_w			varchar(10);
	ds_olho_cirurgia_w		varchar(10);
	ds_doenca_w				varchar(5);
	ds_observacao_olho_w	varchar(255);
	ds_elemento_w			varchar(240);
	ds_complemento_w		varchar(4000);
	ds_alergia_w			varchar(32000);
	ds_exame_w				varchar(255);
	ds_classif_atend_w		varchar(4000);
	dt_nascimento_w			timestamp;
	ds_idade_w				varchar(60);
	nm_medico_atend_w		varchar(60);
	ds_titulo_laudo_w		varchar(255);
	ie_tem_laudo_w			varchar(1);
	ds_obs_receita_w		varchar(255);
	nr_seq_cons_med_w		bigint;	
	ds_impressao1_w			varchar(10);
	ds_impressao2_w			varchar(10);
	nm_usuario2_w			varchar(15);	
	ds_tipo_w				varchar(30);
	ds_enter_w				varchar(10)	:= chr(13) || chr(10);
	dt_procedimento_w		timestamp;
	ds_proced_agenda_w		varchar(240);
	nr_seq_agenda_w			bigint;
	ds_proced_adic_w		varchar(240);
	dt_agenda_w				timestamp;	
	nm_lente_w				varchar(255);
	qt_curva_base_w			double precision;
	qt_curva_base_um_w		double precision;
	qt_curva_base_dois_w	double precision;
	qt_grau_w				double precision;
	qt_grau_esferico_w		double precision;
	qt_grau_cilindrico_w	double precision;
	qt_grau_longe_w			double precision;
	qt_diametro_w			double precision;
	qt_eixo_w				double precision;
	qt_adicao_w				double precision;
	qt_dk_w					double precision;
	qt_h2o_w				double precision;
	ds_marca_w				varchar(255);
	ds_cor_w				varchar(255);
	ds_material_w			varchar(255);
	ds_modelo_w				varchar(255);
	ds_tipo_lente_w			varchar(255);
	ie_lado_w				varchar(15);
	ds_lentes_w				varchar(5000);
	ds_lente_linha_w		varchar(100);
	cd_medico_executor_w	varchar(10);
	ds_observacao_w			varchar(255);
	nr_seq_lente_w			varchar(255);
	insere_cabecalho_w		boolean;
	dt_registro_ant_w		varchar(30);
	pos_w					bigint := 0;
	nm_medico_resp_w		varchar(255);
	dt_liberacao_lado_w		varchar(1);
	nr_seq_aval_w			bigint;
	ds_resumo_aval_aux_w	varchar(5000);
	ds_resumo_aval_w		varchar(32000);
	ds_crm_w				varchar(20);
	ds_crm_cirurgiao_w		varchar(20);
	ds_crm_usuario_w		varchar(20);
	ds_funcao_w				varchar(60);
	ds_usuario_w			varchar(80);
	ie_lib_consulta_oft_w		varchar(1);
	ds_exame_long_w			text;
	ds_procedimento_executado_w	PROCEDIMENTO.DS_PROCEDIMENTO%type;
	qt_ref_cons_w			bigint;
	nr_seq_registro_w		bigint;
	nr_cirurgia_w			bigint;
	ds_material_ww		   varchar(255);
	dt_procedimento_ww 		   timestamp;
	ds_procedimento_ww 	   PROCEDIMENTO.DS_PROCEDIMENTO%type;
	dt_cirurgia_w 			   timestamp;
	ds_cirurgia_w 		   varchar(255);
	insere_cabecalho_ww     	  boolean;
	insere_cabecalho_www     	  boolean;	
	 
	C01 CURSOR FOR 
	SELECT	ds_tipo, 
		nr_atendimento, 
		dt_entrada, 
		ds_classificacao, 
		ds_idade, 
		ds_medico_resp, 
		nm_usuario 
	from	( 
		SELECT	wheb_mensagem_pck.get_texto(307144) ds_tipo, -- Atendimento 
			a.nr_atendimento nr_atendimento, 
			a.dt_entrada dt_entrada, 
			substr(obter_descricao_padrao('CLASSIFICACAO_ATENDIMENTO','DS_CLASSIFICACAO',a.NR_SEQ_CLASSIFICACAO),1,254) ds_classificacao, 
			substr(obter_idade(dt_nascimento_w,a.dt_entrada,'S'),1,60) ds_idade, 
			substr(obter_nome_pf(a.cd_medico_resp),1,60) ds_medico_resp, 
			a.nm_usuario 
		from	atendimento_paciente a 
		where	a.cd_pessoa_fisica	= cd_pessoa_fisica_p 
		
union all
 
		select	wheb_mensagem_pck.get_texto(307145) ds_tipo, -- Complemento 
			null nr_atendimento, 
			a.dt_complemento dt_entrada, 
			a.ds_complemento ds_classificacao, 
			'' ds_idade, 
			'' ds_medico_resp, 
			a.nm_usuario_nrec nm_usuario 
		from	oft_consulta_complemento a, 
			oft_consulta_medica b 
		where	a.cd_pessoa_fisica	= cd_pessoa_fisica_p 
		and	b.nr_sequencia = a.nr_seq_cons_med 
		and	b.ie_situacao <> 'I' 
		and	a.ie_situacao <> 'I' 
		and	((b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '') or (ie_lib_consulta_oft_w = 'N')) 
		and	((a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '') or (ie_lib_consulta_oft_w = 'N')) 		 
		) alias14				 
	order by 
		dt_entrada desc;

	C02 CURSOR FOR 
	SELECT	to_char(dt_consulta,'dd/mm/yyyy hh24:mi:ss'), 
		substr(obter_nome_pf(cd_profissional),1,80), 
		nr_atendimento, 
		ie_dinamica, 
		ie_estatica, 
		ie_receita, 
		ie_adicao, 
		vl_de_rd_od, 
		campo_mascara_virgula(abs(vl_dc_rd_od)), 
		to_char(abs(vl_eixo_rd_od)), 
		ds_visao_rd_od, 
		vl_de_rd_oe, 
		campo_mascara_virgula(abs(vl_dc_rd_oe)), 
		to_char(abs(vl_eixo_rd_oe)), 
		ds_visao_rd_oe, 
		vl_de_re_od, 
		campo_mascara_virgula(abs(vl_dc_re_od)), 
		to_char(abs(vl_eixo_re_od)), 
		ds_visao_re_od, 
		vl_de_re_oe, 
		campo_mascara_virgula(abs(vl_dc_re_oe)), 
		to_char(abs(vl_eixo_re_oe)), 
		ds_visao_re_oe, 
		vl_de_receita_od, 
		campo_mascara_virgula(abs(vl_dc_receita_od)), 
		to_char(abs(vl_eixo_receita_od)), 
		ds_visao_receita_od, 
		vl_de_receita_oe, 
		campo_mascara_virgula(abs(vl_dc_receita_oe)), 
		to_char(abs(vl_eixo_receita_oe)), 
		ds_visao_receita_oe, 
		campo_mascara_virgula(abs(vl_adicao_od)), 
		campo_mascara_virgula(abs(vl_adicao_oe)), 
		ds_queixa_paciente, 
		ds_fundoscopia,     
		ds_biomicroscopia, 
		ds_outros_exames, 
		ds_conduta, 
		vl_pressao_od, 
		vl_pressao_oe, 
		to_char(hr_pressao,'hh24:mi'), 
		ie_tipo_fundoscopia, 
		ds_av_sc_od, 
		ds_av_cc_od, 
		ds_av_sc_oe, 
		ds_av_cc_oe, 
		ds_meo, 
		to_char(vl_visao_rd_od), 
		to_char(vl_visao_rd_oe), 
		to_char(vl_visao_re_od), 
		to_char(vl_visao_re_oe), 
		to_char(vl_visao_receita_od), 
		to_char(vl_visao_receita_oe), 
		ds_obs_receita, 
		nr_sequencia, 
		ds_hip_diag, 
		cd_profissional 
	from	oft_consulta_medica 
	where	nr_atendimento	= current_setting('hdh_gerar_resumo_oftalmo_pkg.nr_atendimento_w')::bigint 
	and	ie_situacao		<> 'I' 
	and	((dt_liberacao IS NOT NULL AND dt_liberacao::text <> '') or (ie_lib_consulta_oft_w = 'N')) 
	order by dt_liberacao desc;
		
	
BEGIN 
	PERFORM set_config('hdh_gerar_resumo_oftalmo_pkg.cd_pessoa_fisica_w', cd_pessoa_fisica_p, false);
	PERFORM set_config('hdh_gerar_resumo_oftalmo_pkg.nm_usuario_w', nm_usuario_p, false);
	obter_param_usuario(281, 68, Obter_perfil_Ativo, nm_usuario_p, 0, dt_liberacao_lado_w);
	insere_cabecalho_ww := true;
	insere_cabecalho_www := true;
 
	select	coalesce(max(dt_nascimento),clock_timestamp()) 
	into STRICT	dt_nascimento_w 
	from	pessoa_fisica 
	where	cd_pessoa_fisica	= current_setting('hdh_gerar_resumo_oftalmo_pkg.cd_pessoa_fisica_w')::varchar(10);
 
	delete	from w_oft_resumo_consulta 
	where	nm_usuario		= nm_usuario_p;
 
	commit;	
	 
	SELECT coalesce(max(IE_LIB_OFTALMOLOGIA),'N') 
	into STRICT  ie_lib_consulta_oft_w 
	from	parametro_medico 
	WHERE 	cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento; 	
 
	open C01;
	loop 
		fetch C01 into	 
			ds_tipo_w, 
			current_setting('hdh_gerar_resumo_oftalmo_pkg.nr_atendimento_w')::bigint, 
			current_setting('hdh_gerar_resumo_oftalmo_pkg.dt_entrada_w')::timestamp, 
			ds_classif_atend_w, 
			ds_idade_w, 
			nm_medico_atend_w, 
			nm_usuario2_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
		begin 
		insere_cabecalho_w	:= True;
		dt_registro_ant_w	:= '01/01/1900';
		 
		select	count(*) 
		into STRICT	qt_ref_cons_w 
		from	oft_consulta_medica 
		where	nr_atendimento = current_setting('hdh_gerar_resumo_oftalmo_pkg.nr_atendimento_w')::bigint;
		 
			open C02;
			loop 
				fetch C02 into 
					dt_consulta_w,	 
					nm_medico_w, 
					current_setting('hdh_gerar_resumo_oftalmo_pkg.nr_atendimento_w')::bigint, 
					ie_dinamica_w, 
					ie_estatica_w, 
					ie_receita_w, 
					ie_adicao_w, 
					vl_de_rd_od_w, 
					vl_dc_rd_od_w, 
					vl_eixo_rd_od_w, 
					ds_visao_rd_od_w, 
					vl_de_rd_oe_w, 
					vl_dc_rd_oe_w, 
					vl_eixo_rd_oe_w, 
					ds_visao_rd_oe_w, 
					vl_de_re_od_w, 
					vl_dc_re_od_w, 
					vl_eixo_re_od_w, 
					ds_visao_re_od_w, 
					vl_de_re_oe_w, 
					vl_dc_re_oe_w, 
					vl_eixo_re_oe_w, 
					ds_visao_re_oe_w, 
					vl_de_receita_od_w, 
					vl_dc_receita_od_w, 
					vl_eixo_receita_od_w, 
					ds_visao_receita_od_w, 
					vl_de_receita_oe_w, 
					vl_dc_receita_oe_w, 
					vl_eixo_receita_oe_w, 
					ds_visao_receita_oe_w, 
					vl_adicao_od_w, 
					vl_adicao_oe_w, 
					ds_queixa_paciente_w, 
					ds_fundoscopia_w,     
					ds_biomicroscopia_w, 
					ds_outros_exames_w, 
					ds_conduta_w, 
					vl_pressao_od_w, 
					vl_pressao_oe_w, 
					hr_pressao_w, 
					ie_tipo_fundoscopia_w, 
					ds_av_sc_od_w, 
					ds_av_cc_od_w, 
					ds_av_sc_oe_w, 
					ds_av_cc_oe_w, 
					ds_meo_w, 
					vl_visao_rd_od_w, 
					vl_visao_rd_oe_w, 
					vl_visao_re_od_w, 
					vl_visao_re_oe_w, 
					vl_visao_receita_od_w, 
					vl_visao_receita_oe_w, 
					ds_obs_receita_w, 
					nr_seq_cons_med_w, 
					ds_hip_diag_w, 
					cd_medico_w;
				EXIT WHEN NOT FOUND; /* apply on C02 */
				begin 
				 
				Select substr(max(coalesce(obter_dados_medico(cd_medico_w,'SGCRM'),obter_dados_pf(cd_medico_w,'CON')) || ':' || 
						coalesce(obter_dados_medico(cd_medico_w,'CRM'),obter_dados_pf(cd_medico_w,'CPR'))),1,20) 
				into STRICT	ds_crm_w 
				;
				 
				if (ds_crm_w IS NOT NULL AND ds_crm_w::text <> '') then 
					nm_medico_w:= substr(nm_medico_w||' ('||ds_crm_w||')',1,80);
				end if;
		 
				ds_consulta_w	:= ds_consulta_w ||LPAD(upper(wheb_mensagem_pck.get_texto(307162)) || ': ',20,' ')		||nm_medico_w		||ds_enter_w; -- MÉDICO(A) 
				ds_consulta_w	:= ds_consulta_w ||LPAD(upper(wheb_mensagem_pck.get_texto(307163)) || ': ',20,' ')	||dt_consulta_w		||ds_enter_w; -- DATA CONSULTA 
				ds_consulta_w	:= ds_consulta_w ||LPAD(upper(wheb_mensagem_pck.get_texto(307164)) || ': ',20,' ')	||ds_queixa_paciente_w	||ds_enter_w||ds_enter_w; -- HISTÓRIA CLÍNICA 
			
				if (ds_av_sc_od_w IS NOT NULL AND ds_av_sc_od_w::text <> '') or (ds_av_sc_oe_w IS NOT NULL AND ds_av_sc_oe_w::text <> '') then 
					ds_consulta_w	:= ds_consulta_w ||LPAD(wheb_mensagem_pck.get_texto(307166) || ' ' || wheb_mensagem_pck.get_texto(307169) || ': ',20,' ')||ds_av_sc_od_w ||ds_enter_w; -- AC VISUAL SC OD 
					ds_consulta_w	:= ds_consulta_w ||LPAD(wheb_mensagem_pck.get_texto(307171) || ': ',20,' ')||ds_av_sc_oe_w ||ds_enter_w; -- OE 
				end if;
		 
				if (ds_av_cc_od_w IS NOT NULL AND ds_av_cc_od_w::text <> '') or (ds_av_cc_oe_w IS NOT NULL AND ds_av_cc_oe_w::text <> '') then 
					ds_consulta_w	:= ds_consulta_w ||LPAD(wheb_mensagem_pck.get_texto(307172) || ' ' || wheb_mensagem_pck.get_texto(307169) || ': ',20,' ')||ds_av_cc_od_w ||ds_enter_w; -- AC VISUAL CC OD 
					ds_consulta_w	:= ds_consulta_w ||LPAD(wheb_mensagem_pck.get_texto(307171) || ': ',20,' ')||ds_av_cc_oe_w ||ds_enter_w; -- OE 
				end if;
	 
				if (ds_meo_w IS NOT NULL AND ds_meo_w::text <> '') then 
					ds_consulta_w	:= ds_consulta_w ||LPAD(wheb_mensagem_pck.get_texto(307173) || ': ',20,' ') ||ds_meo_w ||ds_enter_w; -- MEO 
				end if;
	 
				if (vl_de_rd_od_w IS NOT NULL AND vl_de_rd_od_w::text <> '') or (vl_dc_rd_od_w IS NOT NULL AND vl_dc_rd_od_w::text <> '') or (vl_eixo_rd_od_w IS NOT NULL AND vl_eixo_rd_od_w::text <> '') or (vl_visao_rd_od_w IS NOT NULL AND vl_visao_rd_od_w::text <> '') or (ds_visao_rd_od_w IS NOT NULL AND ds_visao_rd_od_w::text <> '') or (vl_de_rd_oe_w IS NOT NULL AND vl_de_rd_oe_w::text <> '') or (vl_dc_rd_oe_w IS NOT NULL AND vl_dc_rd_oe_w::text <> '') or (vl_eixo_rd_oe_w IS NOT NULL AND vl_eixo_rd_oe_w::text <> '') or (vl_visao_rd_oe_w IS NOT NULL AND vl_visao_rd_oe_w::text <> '') or (ds_visao_rd_oe_w IS NOT NULL AND ds_visao_rd_oe_w::text <> '') or (vl_de_re_od_w IS NOT NULL AND vl_de_re_od_w::text <> '') or (vl_dc_re_od_w IS NOT NULL AND vl_dc_re_od_w::text <> '') or (vl_eixo_re_od_w IS NOT NULL AND vl_eixo_re_od_w::text <> '') or (vl_visao_re_od_w IS NOT NULL AND vl_visao_re_od_w::text <> '') or (ds_visao_re_od_w IS NOT NULL AND ds_visao_re_od_w::text <> '') or (vl_de_re_oe_w IS NOT NULL AND vl_de_re_oe_w::text <> '') or (vl_dc_re_oe_w IS NOT NULL AND vl_dc_re_oe_w::text <> '') or (vl_eixo_re_oe_w IS NOT NULL AND vl_eixo_re_oe_w::text <> '') or (vl_visao_re_oe_w IS NOT NULL AND vl_visao_re_oe_w::text <> '') or (ds_visao_re_oe_w IS NOT NULL AND ds_visao_re_oe_w::text <> '') or (vl_dc_receita_od_w IS NOT NULL AND vl_dc_receita_od_w::text <> '') or (vl_de_receita_od_w IS NOT NULL AND vl_de_receita_od_w::text <> '') or (vl_eixo_receita_od_w IS NOT NULL AND vl_eixo_receita_od_w::text <> '') or (vl_visao_receita_od_w is not 
 
null) or (ds_visao_receita_od_w IS NOT NULL AND ds_visao_receita_od_w::text <> '') or (vl_dc_receita_oe_w IS NOT NULL AND vl_dc_receita_oe_w::text <> '') or (vl_de_receita_oe_w IS NOT NULL AND vl_de_receita_oe_w::text <> '') or (vl_eixo_receita_oe_w IS NOT NULL AND vl_eixo_receita_oe_w::text <> '') or (vl_visao_receita_oe_w is not 
 
null) or (ds_visao_receita_oe_w IS NOT NULL AND ds_visao_receita_oe_w::text <> '') or (vl_adicao_od_w IS NOT NULL AND vl_adicao_od_w::text <> '') or (vl_adicao_oe_w IS NOT NULL AND vl_adicao_oe_w::text <> '') then 
					ds_consulta_w	:= ds_consulta_w ||LPAD(wheb_mensagem_pck.get_texto(307528) || ': ',20,' ')||ds_enter_w; -- REFRAÇÃO 
				end if;
	 
				if (vl_de_rd_od_w IS NOT NULL AND vl_de_rd_od_w::text <> '') or (vl_dc_rd_od_w IS NOT NULL AND vl_dc_rd_od_w::text <> '') or (vl_eixo_rd_od_w IS NOT NULL AND vl_eixo_rd_od_w::text <> '') or (vl_visao_rd_od_w IS NOT NULL AND vl_visao_rd_od_w::text <> '') or (ds_visao_rd_od_w IS NOT NULL AND ds_visao_rd_od_w::text <> '') or (vl_de_rd_oe_w IS NOT NULL AND vl_de_rd_oe_w::text <> '') or (vl_dc_rd_oe_w IS NOT NULL AND vl_dc_rd_oe_w::text <> '') or (vl_eixo_rd_oe_w IS NOT NULL AND vl_eixo_rd_oe_w::text <> '') or (vl_visao_rd_oe_w IS NOT NULL AND vl_visao_rd_oe_w::text <> '') or (ds_visao_rd_oe_w IS NOT NULL AND ds_visao_rd_oe_w::text <> '') then				 
					 
					if (vl_de_rd_od_w IS NOT NULL AND vl_de_rd_od_w::text <> '') then 
						select	CASE WHEN obter_se_negativo(vl_de_rd_od_w)='S' THEN  LPAD(campo_mascara_virgula(vl_de_rd_od_w),7,' ')  ELSE LPAD('+'||campo_mascara_virgula(vl_de_rd_od_w),7,' ') END  
						into STRICT	ds_impressao1_w 
						;
					else 
						ds_impressao1_w	:= LPAD(' ',7,' ');
					end if;	
					 
					if (vl_de_rd_oe_w IS NOT NULL AND vl_de_rd_oe_w::text <> '') then 
						select	CASE WHEN obter_se_negativo(vl_de_rd_oe_w)='S' THEN  LPAD(campo_mascara_virgula(vl_de_rd_oe_w),7,' ')  ELSE LPAD('+'||campo_mascara_virgula(vl_de_rd_oe_w),7,' ') END  
						into STRICT	ds_impressao2_w 
						;
					else 
						ds_impressao2_w	:= LPAD(' ',7,' ');
					end if;	
					 
					ds_consulta_w	:= ds_consulta_w ||LPAD(upper(wheb_mensagem_pck.get_texto(307175)) || ' ' || wheb_mensagem_pck.get_texto(307169) || ':',20,' ') || ds_impressao1_w ||' / '||LPAD('-'||vl_dc_rd_od_w,7,' ') ||' / '||LPAD -- OBJ/SUB OD 
 
(vl_eixo_rd_od_w,3,' ') ||'   20/'||vl_visao_rd_od_w ||' '||ds_visao_rd_od_w ||ds_enter_w;
					ds_consulta_w	:= ds_consulta_w ||LPAD(wheb_mensagem_pck.get_texto(307171) || ':',20,' ')|| ds_impressao2_w ||' / '||LPAD('-'||vl_dc_rd_oe_w,7,' ') ||' / '||LPAD -- OE 
 
(vl_eixo_rd_oe_w,3,' ') ||'   20/'||vl_visao_rd_oe_w||' '||ds_visao_rd_oe_w ||ds_enter_w;
	 
				end if;
						 
				if (vl_de_re_od_w IS NOT NULL AND vl_de_re_od_w::text <> '') or (vl_dc_re_od_w IS NOT NULL AND vl_dc_re_od_w::text <> '') or (vl_eixo_re_od_w IS NOT NULL AND vl_eixo_re_od_w::text <> '') or (vl_visao_re_od_w IS NOT NULL AND vl_visao_re_od_w::text <> '') or (ds_visao_re_od_w IS NOT NULL AND ds_visao_re_od_w::text <> '') or (vl_de_re_oe_w IS NOT NULL AND vl_de_re_oe_w::text <> '') or (vl_dc_re_oe_w IS NOT NULL AND vl_dc_re_oe_w::text <> '') or (vl_eixo_re_oe_w IS NOT NULL AND vl_eixo_re_oe_w::text <> '') or (vl_visao_re_oe_w IS NOT NULL AND vl_visao_re_oe_w::text <> '') or (ds_visao_re_oe_w IS NOT NULL AND ds_visao_re_oe_w::text <> '') then				 
					 
					if (vl_de_re_od_w IS NOT NULL AND vl_de_re_od_w::text <> '') then 
						select	CASE WHEN obter_se_negativo(vl_de_re_od_w)='S' THEN  LPAD(campo_mascara_virgula(vl_de_re_od_w),7,' ')  ELSE LPAD('+'||campo_mascara_virgula(vl_de_re_od_w),7,' ') END  
						into STRICT	ds_impressao1_w 
						;
					else 
						ds_impressao1_w	:= LPAD(' ',7,' ');
					end if;
					 
					if (vl_de_re_oe_w IS NOT NULL AND vl_de_re_oe_w::text <> '') then 
						select	CASE WHEN obter_se_negativo(vl_de_re_oe_w)='S' THEN  LPAD(campo_mascara_virgula(vl_de_re_oe_w),7,' ')  ELSE LPAD('+'||campo_mascara_virgula(vl_de_re_oe_w),7,' ') END  
						into STRICT	ds_impressao2_w 
						;
					else 
						ds_impressao2_w	:= LPAD(' ',7,' ');
					end if;
					 
					ds_consulta_w	:= ds_consulta_w ||LPAD(upper(wheb_mensagem_pck.get_texto(307177)) || ' ' || wheb_mensagem_pck.get_texto(307169) || ':',20,' ')|| ds_impressao1_w ||' / '||LPAD('-'||vl_dc_re_od_w,7,' ') ||' / '||LPAD -- CICLOPLEGIA OD 
(vl_eixo_re_od_w,3,' ') ||'   20/'||vl_visao_re_od_w||' '||ds_visao_re_od_w ||ds_enter_w;
					ds_consulta_w	:= ds_consulta_w ||LPAD(wheb_mensagem_pck.get_texto(307171) || ':',20,' ')|| ds_impressao2_w ||' / '||LPAD('-'||vl_dc_re_oe_w,7,' ') ||' / '||LPAD -- OE 
(vl_eixo_re_oe_w,3,' ') ||'   20/'||vl_visao_re_oe_w||' '||ds_visao_re_oe_w ||ds_enter_w;
				end if;		
	 
				if (vl_dc_receita_od_w IS NOT NULL AND vl_dc_receita_od_w::text <> '') or (vl_de_receita_od_w IS NOT NULL AND vl_de_receita_od_w::text <> '') or (vl_eixo_receita_od_w IS NOT NULL AND vl_eixo_receita_od_w::text <> '') or (vl_visao_receita_od_w is not 
null) or (ds_visao_receita_od_w IS NOT NULL AND ds_visao_receita_od_w::text <> '') or (vl_dc_receita_oe_w IS NOT NULL AND vl_dc_receita_oe_w::text <> '') or (vl_de_receita_oe_w IS NOT NULL AND vl_de_receita_oe_w::text <> '') or (vl_eixo_receita_oe_w IS NOT NULL AND vl_eixo_receita_oe_w::text <> '') or (vl_visao_receita_oe_w is not 
null) or (ds_visao_receita_oe_w IS NOT NULL AND ds_visao_receita_oe_w::text <> '') then				 
					 
					if (vl_de_receita_od_w IS NOT NULL AND vl_de_receita_od_w::text <> '') then 
						select	CASE WHEN obter_se_negativo(vl_de_receita_od_w)='S' THEN  LPAD(campo_mascara_virgula(vl_de_receita_od_w),7,' ')  ELSE LPAD('+'||campo_mascara_virgula(vl_de_receita_od_w),7,' ') END  
						into STRICT	ds_impressao1_w 
						;
					else 
						ds_impressao1_w	:= LPAD(' ',7,' ');
					end if;
					 
					if (vl_de_receita_oe_w IS NOT NULL AND vl_de_receita_oe_w::text <> '') then 
						select	CASE WHEN obter_se_negativo(vl_de_receita_oe_w)='S' THEN  LPAD(campo_mascara_virgula(vl_de_receita_oe_w),7,' ')  ELSE LPAD('+'||campo_mascara_virgula(vl_de_receita_oe_w),7,' ') END  
						into STRICT	ds_impressao2_w 
						;
					else 
						ds_impressao2_w	:= LPAD(' ',7,' ');
					end if;
					 
					ds_consulta_w	:= ds_consulta_w ||LPAD(upper(wheb_mensagem_pck.get_texto(307182)) || ' ' || wheb_mensagem_pck.get_texto(307169) || ':',20,' ')|| ds_impressao1_w ||' / '||LPAD('-'||vl_dc_receita_od_w,7,' ') ||' / '||LPAD(vl_eixo_receita_od_w,3,' ') ||'   20/'||vl_visao_receita_od_w||' '||ds_visao_receita_od_w ||ds_enter_w; -- RECEITA OD 
					ds_consulta_w	:= ds_consulta_w ||LPAD(wheb_mensagem_pck.get_texto(307171) || ':',20,' ')|| ds_impressao2_w ||' / '||LPAD('-'||vl_dc_receita_oe_w,7,' ') ||' / '||LPAD -- OE 
(vl_eixo_receita_oe_w,3,' ') ||'   20/'||vl_visao_receita_oe_w||' '||ds_visao_receita_oe_w ||ds_enter_w;			
				end if;
	 
				if (vl_adicao_od_w IS NOT NULL AND vl_adicao_od_w::text <> '') or (vl_adicao_oe_w IS NOT NULL AND vl_adicao_oe_w::text <> '') then 
					ds_consulta_w	:= ds_consulta_w ||LPAD(upper(wheb_mensagem_pck.get_texto(307185)) || ' ' || wheb_mensagem_pck.get_texto(307169) || ':',20,' ')||LPAD('+'||vl_adicao_od_w,7,' ') ||ds_enter_w; -- ADIÇÃO OD 
					ds_consulta_w	:= ds_consulta_w ||LPAD(wheb_mensagem_pck.get_texto(307171) || ':',20,' ')||LPAD('+'||vl_adicao_oe_w,7,' ') ||ds_enter_w; -- OE 
				end if;
				 
				if (ds_obs_receita_w IS NOT NULL AND ds_obs_receita_w::text <> '') then 
					ds_consulta_w	:= ds_consulta_w ||LPAD(wheb_mensagem_pck.get_texto(307532) || ': ',20,' ')|| ds_obs_receita_w || ds_enter_w; -- OBS RECEITA 
				end if;
				 
				if (vl_pressao_od_w IS NOT NULL AND vl_pressao_od_w::text <> '') or (vl_pressao_oe_w IS NOT NULL AND vl_pressao_oe_w::text <> '') then 
					ds_consulta_w	:= ds_consulta_w ||LPAD(wheb_mensagem_pck.get_texto(307187) || ': ',20,' ')||LPAD(wheb_mensagem_pck.get_texto(307169) || ': ',4,' ')||vl_pressao_od_w ||'  ' ||wheb_mensagem_pck.get_texto(307171) || ': '||vl_pressao_oe_w||' ' || wheb_mensagem_pck.get_texto(307189) || ': '||hr_pressao_w ||ds_enter_w;
														-- PIO															-- OD																			--OE																	-- HORA 
				end if;
		 
				if (ds_biomicroscopia_w IS NOT NULL AND ds_biomicroscopia_w::text <> '') then 
					ds_consulta_w	:= ds_consulta_w ||ds_enter_w||LPAD(upper(wheb_mensagem_pck.get_texto(307202)) || ': ',20,' ')||ds_biomicroscopia_w||ds_enter_w; -- BIOMICROSCOPIA 
				end if;
			 
		 
				if (ds_fundoscopia_w IS NOT NULL AND ds_fundoscopia_w::text <> '') then 
					begin 
					ds_consulta_w	:= ds_consulta_w ||ds_enter_w||LPAD(coalesce(ds_fundoscopia_p,wheb_mensagem_pck.get_texto(307201))||': ',20,' ')||ds_fundoscopia_w	||ds_enter_w; -- FO 
					end;
				end if;
			 
				 
				if (ds_outros_exames_w IS NOT NULL AND ds_outros_exames_w::text <> '') then 
					ds_consulta_w	:= ds_consulta_w ||ds_enter_w||LPAD(upper(wheb_mensagem_pck.get_texto(307203)) || ': ',20,' ')||ds_outros_exames_w||ds_enter_w; -- OUTROS EXAMES 
				end if;
	 
				if (ds_hip_diag_w IS NOT NULL AND ds_hip_diag_w::text <> '') then 
					ds_consulta_w	:= ds_consulta_w ||ds_enter_w||LPAD(upper(wheb_mensagem_pck.get_texto(307534)) || ': ',22,' ')||ds_hip_diag_w||ds_enter_w; -- HIPÓTESE DIAGNÓSTICA 
				end if;
	 
				if (ds_conduta_w IS NOT NULL AND ds_conduta_w::text <> '') then 
					ds_consulta_w	:= ds_consulta_w ||ds_enter_w||LPAD(upper(wheb_mensagem_pck.get_texto(307204)) || ': ',20,' ')||ds_conduta_w||ds_enter_w; -- CONDUTA 
				end if;
				 
				ds_consulta_w	:= ds_consulta_w ||ds_enter_w;
				 
				if (qt_ref_cons_w > 1) then 
					ds_consulta_w	:= ds_consulta_w || '______________________________________________________________' ||ds_enter_w||ds_enter_w;
				end if;
				 
				end;
			end loop;
			close C02;		
			 
			ds_exame_long_w	:= '';
 
			if (ds_exame_long_w IS NOT NULL AND ds_exame_long_w::text <> '') then 
				CALL CALL CALL CALL hdh_gerar_resumo_oftalmo_pkg.addresumo(upper(wheb_mensagem_pck.get_texto(333998)) || ds_enter_w); -- Procedimentos 
				CALL CALL CALL CALL hdh_gerar_resumo_oftalmo_pkg.addresumo(ds_exame_long_w || ds_enter_w);
			end if;
 
			ds_exames_long_w	:= '';
			 
			if (ds_resumo_aval_w IS NOT NULL AND ds_resumo_aval_w::text <> '') then 
				CALL CALL CALL CALL hdh_gerar_resumo_oftalmo_pkg.addresumo(ds_resumo_aval_w || ds_enter_w);
			end if;
			 
			ds_resumo_aval_w := null;
			 
			if (ds_consulta_w IS NOT NULL AND ds_consulta_w::text <> '') then	 
				begin 
				CALL CALL CALL CALL hdh_gerar_resumo_oftalmo_pkg.addresumo(ds_consulta_w || ds_enter_w);
				ds_consulta_w	:= null;
				end;
			end if;
			 
		end;
		end loop;
		close C01;
 
	CALL CALL CALL CALL hdh_gerar_resumo_oftalmo_pkg.gravar_resumo_banco(null);
	PERFORM set_config('hdh_gerar_resumo_oftalmo_pkg.ds_resumo_w', null, false);
	END;

$body$
LANGUAGE PLPGSQL
;
-- REVOKE ALL ON PROCEDURE hdh_gerar_resumo_oftalmo_pkg.hdh_gerar_resumo_oftalmo ( cd_pessoa_fisica_p text, nm_usuario_p text, ds_fundoscopia_p text) FROM PUBLIC;
