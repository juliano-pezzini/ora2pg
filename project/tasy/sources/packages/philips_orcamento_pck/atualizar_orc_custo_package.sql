-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


	/* Rotina que realiza a atualização dos valores recebidos e distribuídos em cada insert da orcamento_distribuido */

CREATE OR REPLACE PROCEDURE philips_orcamento_pck.atualizar_orc_custo ( cd_estabelecimento_p bigint, cd_tabela_custo_p bigint, nr_seq_tabela_p bigint, cd_centro_controle_p bigint, cd_natureza_gasto_p bigint, nr_seq_ng_p bigint, vl_distribuido_p bigint, vl_receb_distrib_p bigint, lista_orcamentos INOUT t_orcamento) AS $body$
BEGIN
	/* Necessário melhorar tratamento para ganho de PERFORMANCE */

	ie_tipo_gasto_w	:= substr(cus_obter_tipo_gasto_centro(cd_estabelecimento_p, cd_centro_controle_p, null, cd_natureza_gasto_p, nr_seq_ng_p),1,1);

	ds_idx_centro_w :=	lpad(cd_estabelecimento_p,4,0)||
				lpad(cd_centro_controle_p,8,0);
	ds_idx_orcamento_custo_w := 	lpad(cd_estabelecimento_p,4,0)||
					lpad(cd_centro_controle_p,8,0)||
					lpad(nr_seq_ng_p,10,0)||
					lpad(ie_tipo_gasto_w,2,0)||
					lpad(cd_tabela_custo_p,5,0);

	if (not orcamentos.exists(ds_idx_centro_w)) then
		begin
		lista_orcamentos[ds_idx_centro_w].cd_centro_controle := cd_centro_controle_p;
		lista_orcamentos[ds_idx_centro_w].cd_estabelecimento := cd_estabelecimento_p;
		end;
	end if;

	if (orcamentos[ds_idx_centro_w].orcamento.exists(ds_idx_orcamento_custo_w)) then
		begin
		orcamento_atual := lista_orcamentos[ds_idx_centro_w].orcamento(ds_idx_orcamento_custo_w);
		end;
	else
		begin
		orcamento_atual := null;
		orcamento_atual.cd_natureza_gasto	:= cd_natureza_gasto_p;
		orcamento_atual.ie_tipo_gasto		:= ie_tipo_gasto_w;
		orcamento_atual.nr_seq_ng		:= nr_seq_ng_p;
		orcamento_atual.vl_receb_distrib_acum	:= 0;
		orcamento_atual.vl_distribuido_acum	:= 0;
		orcamento_atual.vl_pendente		:= 0;
		orcamento_atual.vl_a_distribuir		:= 0;
		orcamento_atual.vl_avista		:= 0;
		orcamento_atual.vl_distribuido		:= 0; /* Valor que será atualizado */
		orcamento_atual.vl_orcado		:= 0;
		orcamento_atual.vl_receb_distrib	:= 0;
		orcamento_atual.ie_pos_neg		:= 1;
		orcamento_atual.vl_distrib_contabil	:= 0;

		begin
		select	a.nr_seq_gng
		into STRICT	orcamento_atual.nr_seq_gng
		from	natureza_gasto a
		where	a.nr_sequencia = nr_seq_ng_p;
		exception
		when no_data_found then

			orcamento_atual.nr_seq_gng := null;
		end;
		end;
	end if;

	/* Atualizar valores do orçamento que recebeu valor */

	criterio_atual.vl_distribuido_criterio := criterio_atual.vl_distribuido_criterio + vl_distribuido_p;
	orcamento_atual.vl_distribuido := orcamento_atual.vl_distribuido + vl_distribuido_p;
	orcamento_atual.vl_receb_distrib := orcamento_atual.vl_receb_distrib + vl_receb_distrib_p;

	lista_orcamentos[ds_idx_centro_w].orcamento(ds_idx_orcamento_custo_w) := orcamento_atual;

	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE philips_orcamento_pck.atualizar_orc_custo ( cd_estabelecimento_p bigint, cd_tabela_custo_p bigint, nr_seq_tabela_p bigint, cd_centro_controle_p bigint, cd_natureza_gasto_p bigint, nr_seq_ng_p bigint, vl_distribuido_p bigint, vl_receb_distrib_p bigint, lista_orcamentos INOUT t_orcamento) FROM PUBLIC;
