-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


--
-- dblink wrapper to call function cpoe_timeline_pck.get_horarios() as an autonomous transaction
--
CREATE EXTENSION IF NOT EXISTS dblink;

CREATE OR REPLACE FUNCTION cpoe_timeline_pck.get_horarios ( nr_atendimento_p bigint, dt_inicio_p timestamp, dt_fim_p timestamp, ds_lista_itens_p text) RETURNS SETOF T_OBJETO_ROW_DATA AS $body$
DECLARE
	-- Change this to reflect the dblink connection string
	v_conn_str  text := format('port=%s dbname=%s user=%s', current_setting('port'), current_database(), current_user);
	v_query     text;

	v_ret	T_OBJETO_ROW_DATA;
BEGIN
	v_query := 'SELECT * FROM cpoe_timeline_pck.get_horarios_atx ( ' || quote_nullable(nr_atendimento_p) || ',' || quote_nullable(dt_inicio_p) || ',' || quote_nullable(dt_fim_p) || ',' || quote_nullable(ds_lista_itens_p) || ' )';
	SELECT * INTO v_ret FROM dblink(v_conn_str, v_query) AS p (ret T_OBJETO_ROW_DATA);
	RETURN v_ret;

END;
$body$ LANGUAGE plpgsql SECURITY DEFINER;




CREATE OR REPLACE FUNCTION cpoe_timeline_pck.get_horarios_atx ( nr_atendimento_p bigint, dt_inicio_p timestamp, dt_fim_p timestamp, ds_lista_itens_p text) RETURNS SETOF T_OBJETO_ROW_DATA AS $body$
DECLARE

		
		ie_opcao_prescr_w	varchar(255);
		item_w				varchar(255);
		nr_seq_reg_item_w	cpoe_material.nr_sequencia%type;	
		ie_opcao_prescr_ww	varchar(2000);
		t_objeto_row_w		t_objeto_row;
		last_hour_w		timestamp;C01 CURSOR(nr_seq_item_p  bigint) FOR
			SELECT	distinct
					b.dt_horario,
					b.nr_prescricao,
					b.dt_suspensao,
					obter_desc_usuario(b.nm_usuario_susp) nm_usuario_susp,
					b.dt_fim_horario,
					b.dt_recusa,
					c.nr_seq_mat_cpoe nr_seq_cpoe,
					b.qt_dose qt_dose,
					d.cd_unidade_medida cd_unidade_medida,
					d.ds_dose_diferenciada,
					b.nr_sequencia nr_seq_horario,
					d.ie_dose_range,
					c.cd_material
			  from	prescr_medica a,
					prescr_mat_hor b,
					prescr_material c,
					cpoe_material d
			 where  d.nr_sequencia = c.nr_seq_mat_cpoe 
			   and	c.cd_material = d.cd_material 
			   and  c.nr_prescricao = b.nr_prescricao
			   and  c.nr_sequencia = b.nr_seq_material
			   and  c.nr_prescricao = a.nr_prescricao
			   and	d.nr_sequencia = nr_seq_item_p
			   and	b.dt_horario between dt_inicio_p and dt_fim_p
			   and	coalesce(b.ie_horario_especial,'N') = 'N' 
			   and	coalesce(c.ie_administrar,'S') = 'S' 
			   and	coalesce(d.ie_material,'N') = 'N' 
			   and	coalesce(c.ie_agrupador,1) <> 4
			   and	coalesce(b.ie_situacao,'A') = 'A'
			 order	by b.dt_horario, b.nr_prescricao;

		c01_w c01%rowtype;		
		
		c02 CURSOR(nr_seq_item_p  bigint) FOR
			SELECT  distinct b.dt_horario,
					b.nr_prescricao, 
					b.dt_suspensao, 
					obter_desc_usuario(b.nm_usuario_susp) nm_usuario_susp,
					b.dt_fim_horario, 
					c.nr_seq_proc_cpoe nr_seq_cpoe
			  from  prescr_medica a, 
					prescr_proc_hor b, 
					prescr_procedimento c 
			 where 	c.nr_prescricao = b.nr_prescricao 
			   and  c.nr_sequencia = b.nr_seq_procedimento
			   and	c.nr_prescricao = a.nr_prescricao 
			   and  c.nr_seq_proc_cpoe = nr_seq_item_p 
			   and	b.dt_horario between dt_inicio_p and dt_fim_p
			   and  coalesce(b.ie_horario_especial,'N') = 'N' 
			   and  coalesce(c.ie_administrar,'S') = 'S' 
			 order 	by b.dt_horario, b.nr_prescricao;
		
		c02_w c02%rowtype;
		
		c03 CURSOR(nr_seq_item_p  bigint) FOR
			SELECT	distinct b.dt_horario,
					b.nr_prescricao,
					b.dt_fim_horario, 
					b.dt_suspensao, 
					obter_desc_usuario(b.nm_usuario_susp) nm_usuario_susp,
					c.nr_seq_mat_cpoe nr_seq_cpoe
			  from 	prescr_medica a, 
					prescr_mat_hor b, 
					prescr_material c, 
					cpoe_material d 
			 where	d.nr_sequencia = c.nr_seq_mat_cpoe 
			   and 	c.nr_prescricao = b.nr_prescricao
			   and 	c.nr_sequencia = b.nr_seq_material
			   and 	c.nr_prescricao = a.nr_prescricao
			   and 	d.nr_sequencia = nr_seq_item_p
			   and 	b.dt_horario between dt_inicio_p and dt_fim_p
			   and 	coalesce(c.ie_agrupador,1) in (2, 5) 
			   and 	coalesce(d.ie_material,'N') = 'S' 
			 order 	by b.dt_horario, b.nr_prescricao;

		c03_w c03%rowtype;
		
		c04 CURSOR(nr_seq_item_p  bigint) FOR
			SELECT	distinct b.dt_horario,
					b.nr_prescricao, 
					c.nr_seq_dieta_cpoe nr_seq_cpoe, 
					b.dt_fim_horario, 
					b.dt_suspensao, 
					obter_desc_usuario(b.nm_usuario_susp) nm_usuario_susp
			  from	prescr_medica a, 
					prescr_mat_hor b, 
					prescr_material c 
			 where 	c.nr_prescricao = b.nr_prescricao
			   and 	c.nr_sequencia = b.nr_seq_material
			   and 	c.nr_prescricao = a.nr_prescricao
			   and 	c.nr_seq_dieta_cpoe = nr_seq_item_p
			   and 	b.dt_horario between dt_inicio_p and dt_fim_p
			   and 	c.ie_agrupador  = 16 
			 order 	by b.dt_horario, b.nr_prescricao;

		c04_w c04%rowtype;
		
		c05 CURSOR(nr_seq_item_p  bigint) FOR
			SELECT	distinct b.dt_horario,
					b.nr_prescricao, 
					c.nr_seq_dieta_cpoe nr_seq_cpoe, 
					b.dt_fim_horario, 
					b.dt_suspensao, 
					obter_desc_usuario(b.nm_usuario_susp) nm_usuario_susp
			  from	prescr_medica a, 
					prescr_dieta_hor b, 
					prescr_dieta c 
			 where 	c.nr_prescricao = b.nr_prescricao
			   and	c.nr_sequencia = b.nr_seq_dieta
			   and 	c.nr_prescricao = a.nr_prescricao
			   and	c.nr_seq_dieta_cpoe = nr_seq_item_p
			   and 	b.dt_horario between dt_inicio_p and dt_fim_p
			 order 	by b.dt_horario, b.nr_prescricao;
		
		c05_w c05%rowtype;
		
		c06 CURSOR(nr_seq_item_p  bigint) FOR
			SELECT  distinct b.dt_horario,
					b.nr_prescricao, 
					b.dt_suspensao, 
					obter_desc_usuario(b.nm_usuario_susp) nm_usuario_susp,
					b.dt_fim_horario, 
					c.nr_seq_dieta_cpoe nr_seq_cpoe 
			  from	prescr_medica a, 
					prescr_mat_hor b, 
					prescr_material c 
			 where	c.nr_prescricao = b.nr_prescricao
			   and	c.nr_sequencia = b.nr_seq_material
			   and 	c.nr_prescricao = a.nr_prescricao
			   and	c.nr_seq_dieta_cpoe = nr_seq_item_p
			   and	b.dt_horario between dt_inicio_p and dt_fim_p
			 order 	by b.dt_horario, b.nr_prescricao;		
		
		c06_w c06%rowtype;
		
		c07 CURSOR(nr_seq_item_p  bigint) FOR
			SELECT	distinct b.dt_horario,
					b.nr_prescricao,
					b.dt_suspensao, 
					obter_desc_usuario(b.nm_usuario_susp) nm_usuario_susp,
					b.dt_fim_horario, 
					c.nr_seq_rec_cpoe nr_seq_cpoe
			  from	prescr_medica a, 
					prescr_rec_hor b, 
					prescr_recomendacao c 
			 where 	c.nr_prescricao = b.nr_prescricao
			   and	c.nr_sequencia = b.nr_seq_recomendacao
			   and 	c.nr_prescricao = a.nr_prescricao 
			   and 	c.nr_seq_rec_cpoe = nr_seq_item_p
			   and 	b.dt_horario between dt_inicio_p and dt_fim_p
			   and 	coalesce(b.ie_horario_especial,'N') = 'N' 
			 order 	by b.dt_horario, b.nr_prescricao;
		
		c07_w c07%rowtype;
		
		c08 CURSOR(nr_seq_item_p  bigint) FOR
			SELECT	distinct b.dt_horario,
					b.dt_suspensao, 
					obter_desc_usuario(b.nm_usuario_susp) nm_usuario_susp,
					b.dt_fim_horario, 
					a.nr_prescricao, 
					c.nr_seq_cpoe_interv  nr_seq_cpoe
              from	pe_prescricao a, 
                    pe_prescr_proc_hor b, 
                    pe_prescr_proc c 
             where	a.nr_sequencia  = c.nr_seq_prescr 
               and	c.nr_seq_prescr = b.nr_seq_pe_prescr 
               and  c.nr_sequencia  = b.nr_seq_pe_proc 
               and  a.nr_atendimento = nr_atendimento_p 
               and  c.nr_seq_cpoe_interv = nr_seq_item_p
               and  b.dt_horario between dt_inicio_p and dt_fim_p
               and  (a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '') 
               and  coalesce(b.ie_situacao,'A')  = 'A' 
               and  coalesce(b.ie_horario_especial,'N') = 'N' 
             order by b.dt_horario, a.nr_prescricao;
		
		c08_w c08%rowtype;
		
		c09 CURSOR(nr_seq_item_p  bigint) FOR
			SELECT	distinct b.dt_horario,
					b.nr_prescricao,
					b.dt_suspensao,
					obter_desc_usuario(b.nm_usuario_susp) nm_usuario_susp,
					b.dt_fim_horario,
					c.nr_seq_proc_cpoe nr_seq_cpoe
			  from	prescr_medica a,
					prescr_proc_hor b,
					prescr_procedimento c  
			 where	c.nr_prescricao = b.nr_prescricao  
			   and  c.nr_sequencia = b.nr_seq_procedimento
			   and 	c.nr_prescricao = a.nr_prescricao
			   and  c.nr_seq_proc_cpoe = nr_seq_item_p
			   and  b.dt_horario between dt_inicio_p and dt_fim_p
			   and  coalesce(IE_TIPO_PROCED,'AP') IN ('APC', 'APH', 'AP') 
			   and  coalesce(c.ie_administrar,'S') = 'S'  
			 order 	by b.dt_horario, b.nr_prescricao;

		c09_w c09%rowtype;			

		
	
BEGIN
		ie_opcao_prescr_ww := replace(ds_lista_itens_p, ' ', '');

		while(ie_opcao_prescr_ww IS NOT NULL AND ie_opcao_prescr_ww::text <> '') loop			
			
			if (position(';' in ie_opcao_prescr_ww) = 0) and (ie_opcao_prescr_ww IS NOT NULL AND ie_opcao_prescr_ww::text <> '') then
				ie_opcao_prescr_ww	:= ie_opcao_prescr_ww||';';
			end if;
			
			item_w := substr(ie_opcao_prescr_ww, 1, position(';' in ie_opcao_prescr_ww) - 1);
			ie_opcao_prescr_w := substr(item_w, 1, position(',' in item_w) - 1);
			nr_seq_reg_item_w := (substr(item_w, position(',' in item_w) + 1, length(item_w)))::numeric;
			ie_opcao_prescr_ww := substr(ie_opcao_prescr_ww, position(';' in ie_opcao_prescr_ww) + 1, length(ie_opcao_prescr_ww));
			
			if (ie_opcao_prescr_w <> 'DI') and (ie_opcao_prescr_w <> 'G') and (ie_opcao_prescr_w <> 'H') and (ie_opcao_prescr_w <> 'S') and (ie_opcao_prescr_w <> 'E') and (ie_opcao_prescr_w <> 'J') then
				
				last_hour_w := null;
			
				case trim(both ie_opcao_prescr_w)
					when 'DI' then	
						null;--gravar_log_tasy(10007,'tst - sera retirado dps','teobenatti');
					when 'G' then	
						null;--gravar_log_tasy(10007,'tst - sera retirado dps','teobenatti');
					when 'H' then	
						null;--gravar_log_tasy(10007,'tst - sera retirado dps','teobenatti');
					when 'MA' then	--Material
						begin
							for c03_w in c03(nr_seq_reg_item_w) loop
							begin
								t_objeto_row_w.dt_horario		:=  c03_w.dt_horario;
								t_objeto_row_w.nr_prescricao	:=  c03_w.nr_prescricao;
								t_objeto_row_w.dt_suspensao		:=  c03_w.dt_suspensao;
								t_objeto_row_w.nm_usuario_susp	:=  c03_w.nm_usuario_susp;
								t_objeto_row_w.dt_fim_horario	:=  c03_w.dt_fim_horario;
								t_objeto_row_w.nr_sequencia		:=  c03_w.nr_seq_cpoe;
								t_objeto_row_w.ie_tipo_item		:=  'MA';
								t_objeto_row_w.qt_dose			:=  0;
								t_objeto_row_w.cd_unidade_medida :=  null;
								t_objeto_row_w.ds_dose_diferenciada :=  null;
								RETURN NEXT t_objeto_row_w;
							end;
							end loop;
						exception
						when others then
							CALL gravar_log_cpoe(substr('CPOE_TIMELINE_PCK-Mat: '||
								to_char(dt_inicio_p,'dd/mm/yyyy hh24:mi:ss') ||' - '|| to_char(dt_fim_p,'dd/mm/yyyy hh24:mi:ss') || 
								' ERRO: ' ||to_char(sqlerrm),1,2000), nr_atendimento_p);
							commit;
						end;
					when 'M' then	--Medicamento
						begin
							for c01_w in c01(nr_seq_reg_item_w) loop
							begin
							
								if (coalesce(last_hour_w::text, '') = '') then
									select 	max(b.dt_horario)
									into STRICT	last_hour_w
									from 	prescr_material a,
										prescr_mat_hor b
									where 	a.nr_prescricao = b.nr_prescricao
									and 	a.nr_sequencia = b.nr_seq_material
									and 	a.nr_seq_mat_cpoe = c01_w.nr_seq_cpoe
									and 	a.cd_material = c01_w.cd_material;
								end if;
							
								t_objeto_row_w.dt_horario		:=  c01_w.dt_horario;
								t_objeto_row_w.nr_prescricao	:=  c01_w.nr_prescricao;
								t_objeto_row_w.dt_suspensao		:=  c01_w.dt_suspensao;
								t_objeto_row_w.nm_usuario_susp	:=  c01_w.nm_usuario_susp;
								t_objeto_row_w.dt_fim_horario	:=  c01_w.dt_fim_horario;
								t_objeto_row_w.dt_recusa	    :=  c01_w.dt_recusa;
								t_objeto_row_w.nr_sequencia		:=  c01_w.nr_seq_cpoe;
								t_objeto_row_w.ie_tipo_item		:=  'M';
								t_objeto_row_w.qt_dose			:=  c01_w.qt_dose;
								t_objeto_row_w.cd_unidade_medida :=  c01_w.cd_unidade_medida;
								t_objeto_row_w.ds_dose_diferenciada :=  c01_w.ds_dose_diferenciada;
								t_objeto_row_w.nr_seq_horario :=  c01_w.nr_seq_horario;
								t_objeto_row_w.ie_dose_range := c01_w.ie_dose_range;
								t_objeto_row_w.last_hour :=  last_hour_w;
								RETURN NEXT t_objeto_row_w;
							end;
							end loop;
						exception
						when others then
							CALL gravar_log_cpoe(substr('CPOE_TIMELINE_PCK-Med: '||
								to_char(dt_inicio_p,'dd/mm/yyyy hh24:mi:ss') ||' - '|| to_char(dt_fim_p,'dd/mm/yyyy hh24:mi:ss') || 
								' ERRO: ' ||to_char(sqlerrm),1,2000), nr_atendimento_p);
							commit;
						end;						
					when 'S' then	--Solucao
						null;--gravar_log_tasy(10007,'tst - sera retirado dps','teobenatti');
					when 'E' then
						null;--gravar_log_tasy(10007,'tst - sera retirado dps','teobenatti');
					when 'J' then
						null;--gravar_log_tasy(10007,'tst - sera retirado dps','teobenatti');
					when 'L' then -- Leites e Derivados
						begin
							for c04_w in c04(nr_seq_reg_item_w) loop
							begin
								t_objeto_row_w.dt_horario		:=  c04_w.dt_horario;
								t_objeto_row_w.nr_prescricao	:=  c04_w.nr_prescricao;
								t_objeto_row_w.dt_suspensao		:=  c04_w.dt_suspensao;
								t_objeto_row_w.nm_usuario_susp	:=  c04_w.nm_usuario_susp;
								t_objeto_row_w.dt_fim_horario	:=  c04_w.dt_fim_horario;
								t_objeto_row_w.nr_sequencia		:=  c04_w.nr_seq_cpoe;
								t_objeto_row_w.ie_tipo_item		:=  'L';
								t_objeto_row_w.qt_dose			:=  0;
								t_objeto_row_w.cd_unidade_medida :=  null;
								t_objeto_row_w.ds_dose_diferenciada :=  null;
								RETURN NEXT t_objeto_row_w;
							end;
							end loop;
						exception
						when others then
							CALL gravar_log_cpoe(substr('CPOE_TIMELINE_PCK-Leites: '||
								to_char(dt_inicio_p,'dd/mm/yyyy hh24:mi:ss') ||' - '|| to_char(dt_fim_p,'dd/mm/yyyy hh24:mi:ss') || 
								' ERRO: ' ||to_char(sqlerrm),1,2000), nr_atendimento_p);
							commit;
						end;
					when 'O' then --Oral
						begin
							for c05_w in c05(nr_seq_reg_item_w) loop
							begin
								t_objeto_row_w.dt_horario		:=  c05_w.dt_horario;
								t_objeto_row_w.nr_prescricao	:=  c05_w.nr_prescricao;
								t_objeto_row_w.dt_suspensao		:=  c05_w.dt_suspensao;
								t_objeto_row_w.nm_usuario_susp	:=  c05_w.nm_usuario_susp;
								t_objeto_row_w.dt_fim_horario	:=  c05_w.dt_fim_horario;
								t_objeto_row_w.nr_sequencia		:=  c05_w.nr_seq_cpoe;
								t_objeto_row_w.ie_tipo_item		:=  'O';
								t_objeto_row_w.qt_dose			:=  0;
								t_objeto_row_w.cd_unidade_medida :=  null;
								t_objeto_row_w.ds_dose_diferenciada :=  null;
								RETURN NEXT t_objeto_row_w;
							end;
							end loop;
						exception
						when others then
							CALL gravar_log_cpoe(substr('CPOE_TIMELINE_PCK-Oral: '||
								to_char(dt_inicio_p,'dd/mm/yyyy hh24:mi:ss') ||' - '|| to_char(dt_fim_p,'dd/mm/yyyy hh24:mi:ss') || 
								' ERRO: ' ||to_char(sqlerrm),1,2000), nr_atendimento_p);
							commit;
						end;
					when 'DS' then --Suplemento
						begin
							for c06_w in c06(nr_seq_reg_item_w) loop
							begin
								t_objeto_row_w.dt_horario		:=  c06_w.dt_horario;
								t_objeto_row_w.nr_prescricao	:=  c06_w.nr_prescricao;
								t_objeto_row_w.dt_suspensao		:=  c06_w.dt_suspensao;
								t_objeto_row_w.nm_usuario_susp	:=  c06_w.nm_usuario_susp;
								t_objeto_row_w.dt_fim_horario	:=  c06_w.dt_fim_horario;
								t_objeto_row_w.nr_sequencia		:=  c06_w.nr_seq_cpoe;
								t_objeto_row_w.ie_tipo_item		:=  'DS';
								t_objeto_row_w.qt_dose			:=  0;
								t_objeto_row_w.cd_unidade_medida :=  null;
								t_objeto_row_w.ds_dose_diferenciada :=  null;
								RETURN NEXT t_objeto_row_w;
							end;
							end loop;
						exception
						when others then
							CALL gravar_log_cpoe(substr('CPOE_TIMELINE_PCK-Sup: '||
								to_char(dt_inicio_p,'dd/mm/yyyy hh24:mi:ss') ||' - '|| to_char(dt_fim_p,'dd/mm/yyyy hh24:mi:ss') || 
								' ERRO: ' ||to_char(sqlerrm),1,2000), nr_atendimento_p);
							commit;
						end;
					when 'P' then -- Procedimento				
						begin
							for c02_w in c02(nr_seq_reg_item_w) loop
							begin
								t_objeto_row_w.dt_horario		:=  c02_w.dt_horario;
								t_objeto_row_w.nr_prescricao	:=  c02_w.nr_prescricao;
								t_objeto_row_w.dt_suspensao		:=  c02_w.dt_suspensao;
								t_objeto_row_w.nm_usuario_susp	:=  c02_w.nm_usuario_susp;
								t_objeto_row_w.dt_fim_horario	:=  c02_w.dt_fim_horario;
								t_objeto_row_w.nr_sequencia		:=  c02_w.nr_seq_cpoe;
								t_objeto_row_w.ie_tipo_item		:=  'P';
								t_objeto_row_w.qt_dose			:=  0;
								t_objeto_row_w.cd_unidade_medida :=  null;
								t_objeto_row_w.ds_dose_diferenciada :=  null;
								RETURN NEXT t_objeto_row_w;
							end;
							end loop;
						exception
						when others then
							CALL gravar_log_cpoe(substr('CPOE_TIMELINE_PCK-Proc: '||
								to_char(dt_inicio_p,'dd/mm/yyyy hh24:mi:ss') ||' - '|| to_char(dt_fim_p,'dd/mm/yyyy hh24:mi:ss') || 
								' ERRO: ' ||to_char(sqlerrm),1,2000), nr_atendimento_p);
							commit;
						end;
					when 'R' then --Recomendacao
						begin
							for c07_w in c07(nr_seq_reg_item_w) loop
							begin
								t_objeto_row_w.dt_horario		:=  c07_w.dt_horario;
								t_objeto_row_w.nr_prescricao	:=  c07_w.nr_prescricao;
								t_objeto_row_w.dt_suspensao		:=  c07_w.dt_suspensao;
								t_objeto_row_w.nm_usuario_susp	:=  c07_w.nm_usuario_susp;
								t_objeto_row_w.dt_fim_horario	:=  c07_w.dt_fim_horario;
								t_objeto_row_w.nr_sequencia		:=  c07_w.nr_seq_cpoe;
								t_objeto_row_w.ie_tipo_item		:=  'R';
								t_objeto_row_w.qt_dose			:=  0;
								t_objeto_row_w.cd_unidade_medida :=  null;
								t_objeto_row_w.ds_dose_diferenciada :=  null;
								RETURN NEXT t_objeto_row_w;
							end;
							end loop;
						exception
						when others then
							CALL gravar_log_cpoe(substr('CPOE_TIMELINE_PCK-Rec: '||
								to_char(dt_inicio_p,'dd/mm/yyyy hh24:mi:ss') ||' - '|| to_char(dt_fim_p,'dd/mm/yyyy hh24:mi:ss') || 
								' ERRO: ' ||to_char(sqlerrm),1,2000), nr_atendimento_p);
							commit;
						end;
					when 'I' then --Intervencao (SAE)
						begin
							for c08_w in c08(nr_seq_reg_item_w) loop
							begin
								t_objeto_row_w.dt_horario		:=  c08_w.dt_horario;
								t_objeto_row_w.nr_prescricao	:=  c08_w.nr_prescricao;
								t_objeto_row_w.dt_suspensao		:=  c08_w.dt_suspensao;
								t_objeto_row_w.nm_usuario_susp	:=  c08_w.nm_usuario_susp;
								t_objeto_row_w.dt_fim_horario	:=  c08_w.dt_fim_horario;
								t_objeto_row_w.nr_sequencia		:=  c08_w.nr_seq_cpoe;
								t_objeto_row_w.ie_tipo_item		:=  'I';
								t_objeto_row_w.qt_dose			:=  0;
								t_objeto_row_w.cd_unidade_medida :=  null;
								t_objeto_row_w.ds_dose_diferenciada :=  null;
								RETURN NEXT t_objeto_row_w;
							end;
							end loop;
						exception
						when others then
							CALL gravar_log_cpoe(substr('CPOE_TIMELINE_PCK-SAE: '||
								to_char(dt_inicio_p,'dd/mm/yyyy hh24:mi:ss') ||' - '|| to_char(dt_fim_p,'dd/mm/yyyy hh24:mi:ss') || 
								' ERRO: ' ||to_char(sqlerrm),1,2000), nr_atendimento_p);
							commit;
						end;
					when 'PA' then -- Anatomia Patologica
						begin
							for c09_w in c09(nr_seq_reg_item_w) loop
							begin
								t_objeto_row_w.dt_horario		:=  c09_w.dt_horario;
								t_objeto_row_w.nr_prescricao	:=  c09_w.nr_prescricao;
								t_objeto_row_w.dt_suspensao		:=  c09_w.dt_suspensao;
								t_objeto_row_w.nm_usuario_susp	:=  c09_w.nm_usuario_susp;
								t_objeto_row_w.dt_fim_horario	:=  c09_w.dt_fim_horario;
								t_objeto_row_w.nr_sequencia		:=  c09_w.nr_seq_cpoe;
								t_objeto_row_w.ie_tipo_item		:=  'PA';
								t_objeto_row_w.qt_dose			:=  0;
								t_objeto_row_w.cd_unidade_medida :=  null;
								t_objeto_row_w.ds_dose_diferenciada :=  null;
								RETURN NEXT t_objeto_row_w;
							end;
							end loop;
						exception
						when others then
							CALL gravar_log_cpoe(substr('CPOE_TIMELINE_PCK-Anat: '||
								to_char(dt_inicio_p,'dd/mm/yyyy hh24:mi:ss') ||' - '|| to_char(dt_fim_p,'dd/mm/yyyy hh24:mi:ss') || 
								' ERRO: ' ||to_char(sqlerrm),1,2000), nr_atendimento_p);
							commit;
						end;
					when 'DP' then	
						null;
				end case;
			end if;
		end loop;
	
	return;
	
	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION cpoe_timeline_pck.get_horarios ( nr_atendimento_p bigint, dt_inicio_p timestamp, dt_fim_p timestamp, ds_lista_itens_p text) FROM PUBLIC; -- REVOKE ALL ON FUNCTION cpoe_timeline_pck.get_horarios_atx ( nr_atendimento_p bigint, dt_inicio_p timestamp, dt_fim_p timestamp, ds_lista_itens_p text) FROM PUBLIC;
