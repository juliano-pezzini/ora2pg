-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION cpoe_timeline_pck.get_horarios_futuro ( nr_atendimento_p bigint, dt_fim_p timestamp, ds_lista_itens_p text) RETURNS SETOF T_FUTURE_ROW_DATA AS $body$
DECLARE

								
	t_future_row_w	t_future_row;
	ds_sql_w			varchar(2000) := '';
	ds_sql_restricao_w	varchar(2000) := '';
	ie_opcao_prescr_w	varchar(255);
	item_w				varchar(255);
	nr_seq_reg_item_w	cpoe_material.nr_sequencia%type;	
	ie_opcao_prescr_ww	varchar(2000) := ds_lista_itens_p;
	
	nm_tabela_cpoe_w		varchar(255);
	nm_rep_tabela_cpoe_w	varchar(255);
	nm_rep_chave_cpoe_w		varchar(255);
	nm_hor_tabela_rep_w		varchar(255);
	nm_hor_chave_rep_w		varchar(255);
	
	
BEGIN
	
		while(ie_opcao_prescr_ww IS NOT NULL AND ie_opcao_prescr_ww::text <> '') loop			
			
			if (position(';' in ie_opcao_prescr_ww) = 0) and (ie_opcao_prescr_ww IS NOT NULL AND ie_opcao_prescr_ww::text <> '') then
				ie_opcao_prescr_ww	:= ie_opcao_prescr_ww||';';
			end if;	
			
			item_w := substr(ie_opcao_prescr_ww, 1, position(';' in ie_opcao_prescr_ww) - 1);
			ie_opcao_prescr_w := substr(item_w, 1, position(',' in item_w) - 1);
			nr_seq_reg_item_w := (substr(item_w, position(',' in item_w) + 1, length(item_w)))::numeric;
			ie_opcao_prescr_ww := substr(ie_opcao_prescr_ww, position(';' in ie_opcao_prescr_ww) + 1, length(ie_opcao_prescr_ww));
	
			nm_tabela_cpoe_w 	 := null;
			nm_rep_tabela_cpoe_w := '';
			nm_rep_chave_cpoe_w  := '';
			nm_hor_tabela_rep_w  := '';
			nm_hor_chave_rep_w   := '';
			ds_sql_w := '';
			
			if (ie_opcao_prescr_w <> 'MA') and (ie_opcao_prescr_w <> 'I') and (ie_opcao_prescr_w <> 'DI') then				
				
				
				case ie_opcao_prescr_w
					when 'G' then	
						nm_tabela_cpoe_w 		:= 'cpoe_gasoterapia';
						nm_rep_tabela_cpoe_w 	:= 'prescr_gasoterapia';
						nm_rep_chave_cpoe_w 	:= 'nr_seq_gas_cpoe';
						nm_hor_tabela_rep_w 	:= 'prescr_gasoterapia_hor';
						nm_hor_chave_rep_w 		:= 'nr_seq_gasoterapia';
						t_future_row_w.ie_tipo_item	:=  'G';		
					when 'H' then	--Hemoterapia
						nm_tabela_cpoe_w 		:= 'cpoe_hemoterapia';
						nm_rep_tabela_cpoe_w 	:= 'prescr_procedimento';
						nm_rep_chave_cpoe_w 	:= 'nr_seq_proc_cpoe';
						nm_hor_tabela_rep_w 	:= 'prescr_proc_hor';
						nm_hor_chave_rep_w 		:= 'nr_seq_procedimento';
						t_future_row_w.ie_tipo_item	:=  'H';
					when 'M' then	--Medicamento	
						nm_tabela_cpoe_w 		:= 'cpoe_material';
						nm_rep_tabela_cpoe_w 	:= 'prescr_material';
						nm_rep_chave_cpoe_w 	:= 'nr_seq_mat_cpoe';
						nm_hor_tabela_rep_w 	:= 'prescr_mat_hor';
						nm_hor_chave_rep_w 		:= 'nr_seq_material';
						t_future_row_w.ie_tipo_item	:=  'M';			
					when 'S' then	--Solucao
						nm_tabela_cpoe_w 		:= 'cpoe_material';
						nm_rep_tabela_cpoe_w 	:= 'prescr_material';
						nm_rep_chave_cpoe_w 	:= 'nr_seq_mat_cpoe';
						nm_hor_tabela_rep_w 	:= 'prescr_mat_hor';
						nm_hor_chave_rep_w 		:= 'nr_seq_material';
						t_future_row_w.ie_tipo_item	:=  'S';
					when 'E' then
						nm_tabela_cpoe_w 		:= 'cpoe_dieta';
						nm_rep_tabela_cpoe_w 	:= 'prescr_material';
						nm_rep_chave_cpoe_w	 	:= 'nr_seq_dieta_cpoe';
						nm_hor_tabela_rep_w 	:= 'prescr_mat_hor';
						nm_hor_chave_rep_w 		:= 'nr_seq_material';
						ds_sql_restricao_w		:= 'and ie_tipo_dieta  = ''E''';
						t_future_row_w.ie_tipo_item	:=  'E';
					when 'J' then
						nm_tabela_cpoe_w 		:= 'cpoe_dieta';
						nm_rep_tabela_cpoe_w 	:= null;
						nm_rep_chave_cpoe_w	 	:= null;
						nm_hor_tabela_rep_w 	:= null;
						nm_hor_chave_rep_w 		:= null;
						ds_sql_restricao_w		:= 'and ie_tipo_dieta  = ''J''';
						t_future_row_w.ie_tipo_item	:=  'J';
					when 'L' then -- Leites e Derivados
						nm_tabela_cpoe_w 		:= 'cpoe_dieta';
						nm_rep_tabela_cpoe_w 	:= null;
						nm_rep_chave_cpoe_w	 	:= null;
						nm_hor_tabela_rep_w 	:= null;
						nm_hor_chave_rep_w 		:= null;
						ds_sql_restricao_w		:= 'and ie_tipo_dieta  = ''L''';
						t_future_row_w.ie_tipo_item	:=  'L';
					when 'O' then --Oral
						nm_tabela_cpoe_w 		:= 'cpoe_dieta';
						nm_rep_tabela_cpoe_w 	:= 'prescr_dieta';
						nm_rep_chave_cpoe_w	 	:= 'nr_seq_dieta_cpoe';
						nm_hor_tabela_rep_w 	:= 'prescr_dieta_hor';
						nm_hor_chave_rep_w 		:= 'nr_seq_dieta';
						ds_sql_restricao_w		:= 'and ie_tipo_dieta  = ''O''';
						t_future_row_w.ie_tipo_item	:=  'O';
					when 'DS' then --Suplemento
						nm_tabela_cpoe_w 		:= 'cpoe_dieta';
						nm_rep_tabela_cpoe_w 	:= 'prescr_material';
						nm_rep_chave_cpoe_w	 	:= 'nr_seq_dieta_cpoe';
						nm_hor_tabela_rep_w 	:= 'prescr_mat_hor';
						nm_hor_chave_rep_w 		:= 'nr_seq_material';
						ds_sql_restricao_w		:= 'and ie_tipo_dieta  = ''S''';
						t_future_row_w.ie_tipo_item	:=  'DS';
					when 'P' then -- Procedimento	
						nm_tabela_cpoe_w 		:= 'cpoe_procedimento';
						nm_rep_tabela_cpoe_w 	:= 'prescr_procedimento';
						nm_rep_chave_cpoe_w	 	:= 'nr_seq_proc_cpoe';
						nm_hor_tabela_rep_w 	:= 'prescr_proc_hor';
						nm_hor_chave_rep_w 		:= 'nr_seq_procedimento';
						t_future_row_w.ie_tipo_item	:=  'P';
					when 'R' then --Recomendacao
						nm_tabela_cpoe_w 		:= 'cpoe_recomendacao';
						nm_rep_tabela_cpoe_w 	:= 'prescr_recomendacao';
						nm_rep_chave_cpoe_w	 	:= 'nr_seq_rec_cpoe';
						nm_hor_tabela_rep_w 	:= 'prescr_rec_hor';
						nm_hor_chave_rep_w 		:= 'nr_seq_recomendacao';
						t_future_row_w.ie_tipo_item	:=  'R';
					when 'PA' then -- Anatomia Patologica
						nm_tabela_cpoe_w 		:= 'cpoe_anatomia_patologica';
						nm_rep_tabela_cpoe_w 	:= 'prescr_procedimento';
						nm_rep_chave_cpoe_w	 	:= 'nr_seq_proc_cpoe';
						nm_hor_tabela_rep_w 	:= 'prescr_proc_hor';
						nm_hor_chave_rep_w 		:= 'nr_seq_procedimento';
						t_future_row_w.ie_tipo_item	:= 'PA';
					when 'DP' then
						nm_tabela_cpoe_w 		:= 'cpoe_dieta';
						nm_rep_tabela_cpoe_w 	:= null;
						nm_rep_chave_cpoe_w	 	:= null;
						nm_hor_tabela_rep_w 	:= null;
						nm_hor_chave_rep_w 		:= null;
						ds_sql_restricao_w		:= 'and ie_tipo_dieta  in (''P'',''I'')';
						t_future_row_w.ie_tipo_item	:=  'DP';
				end case;

				if (nm_tabela_cpoe_w IS NOT NULL AND nm_tabela_cpoe_w::text <> '') then
					
					if (nm_tabela_cpoe_w <> 'cpoe_hemoterapia') then
						ds_sql_w	:= 
						' select 	max(CPOE_obter_prox_adm_grid_ang(nr_sequencia, ''M'', nm_usuario, nr_atendimento, ie_administracao, cd_intervalo, nvl(dt_prox_geracao, sysdate),  dt_inicio, dt_fim, ' ||
						'		:nm_rep_tabela_cpoe , :nm_rep_chave_cpoe, :nm_hor_tabela_rep, :nm_hor_chave_rep,null, :dt_fim, 2314))'  ||
						' from ' || nm_tabela_cpoe_w	||
						' where 	nr_sequencia = :nr_seq_reg_item '||
						' and		dt_liberacao is not null ' ||
						' and		dt_lib_suspensao is null ' ||
						ds_sql_restricao_w;
					
					else
						ds_sql_w	:=
						' select 	max(CPOE_obter_prox_adm_grid_ang(nr_sequencia, ''H'', null, null, ''P'', cd_intervalo, null,  dt_programada, dt_fim, ' ||
						'		:nm_rep_tabela_cpoe, :nm_rep_chave_cpoe, :nm_hor_tabela_rep, :nm_hor_chave_rep, null, :dt_fim, 2314))'  ||
						' from ' || nm_tabela_cpoe_w	||
						' where 	nr_sequencia = :nr_seq_reg_item ' ||
						' and		dt_liberacao is not null ' ||
						' and		dt_lib_suspensao is null ';
					end if;
					
					begin
					
						EXECUTE ds_sql_w
						into STRICT	t_future_row_w.ds_tempo_adm_grid
						using nm_rep_tabela_cpoe_w, nm_rep_chave_cpoe_w, nm_hor_tabela_rep_w, nm_hor_chave_rep_w, dt_fim_p, nr_seq_reg_item_w;
						t_future_row_w.nr_sequencia := nr_seq_reg_item_w;
						t_future_row_w.ie_tipo_item	:= ie_opcao_prescr_w;
						RETURN NEXT t_future_row_w;	
					
					exception when others then
							null;
					end;
					
					
				end if;
			end if;
		end loop;	
		
	return;
	end;	
	

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION cpoe_timeline_pck.get_horarios_futuro ( nr_atendimento_p bigint, dt_fim_p timestamp, ds_lista_itens_p text) FROM PUBLIC;
