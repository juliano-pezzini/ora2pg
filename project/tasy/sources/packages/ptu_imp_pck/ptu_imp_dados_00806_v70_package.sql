-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE ptu_imp_pck.ptu_imp_dados_00806_v70 ( nr_seq_req_ord_p ptu_req_ord_serv_servico.nr_seq_req_ord%type, nr_seq_item_p ptu_req_ord_serv_servico.nr_seq_item%type, ie_tipo_tabela_p ptu_req_ord_serv_servico.ie_tipo_tabela%type, cd_servico_p ptu_req_ord_serv_servico.cd_servico%type, qt_servico_p ptu_req_ord_serv_servico.qt_servico_aut%type, ds_opme_p ptu_req_ord_serv_servico.ds_opme%type, vl_servico_p ptu_req_ord_serv_servico.vl_servico%type, vl_uni_servico_p ptu_req_ord_serv_servico.vl_uni_servico%type, cd_anvisa_p ptu_req_ord_serv_servico.cd_anvisa%type, cd_referencia_fab_p ptu_req_ord_serv_servico.cd_referencia_fab%type, ie_tipo_anexo_p ptu_req_ord_serv_servico.ie_tipo_anexo%type, dt_provavel_p text, qt_dosagem_total_p ptu_req_ord_serv_servico.qt_dosagem_total%type, qt_unidade_medida_p ptu_req_ord_serv_servico.qt_unidade_medida%type, cd_via_administracao_p ptu_req_ord_serv_servico.cd_via_administracao%type, qt_frequencia_adm_p ptu_req_ord_serv_servico.qt_frequencia_adm%type, ie_pacote_p ptu_req_ord_serv_servico.ie_pacote%type, ie_tipo_ordem_p ptu_req_ord_serv_servico.ie_tipo_ordem%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE


/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade: Realizar a importacao dos itens do arquivo de 00806 - Pedido Ordem de Servico
-------------------------------------------------------------------------------------------------------------------

Locais de chamada direta:
[  ]  Objetos do dicionario [ x] Tasy (Delphi/Java) [  x] Portal [  ]  Relatorios [ x] Outros:
 ------------------------------------------------------------------------------------------------------------------

Pontos de atencao:
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */


qt_reg_proc_w		bigint;
cd_unimed_benef_w	ptu_requisicao_ordem_serv.cd_unimed_beneficiario%type;
qt_servico_w		ptu_req_ord_serv_servico.qt_servico_aut%type;
nr_seq_req_ord_serv_w	ptu_req_ord_serv_servico.nr_sequencia%type;
cd_servico_conversao_w	ptu_req_ord_serv_servico.cd_servico_consersao%type;
ds_opme_w		ptu_req_ord_serv_servico.ds_opme%type;
cd_estabelecimento_w	estabelecimento.cd_estabelecimento%type;
nr_seq_material_w	pls_material.nr_sequencia%type;
ie_origem_proced_w	procedimento.ie_origem_proced%type;
ie_origem_proced_ww	procedimento.ie_origem_proced%type;
nr_seq_congenere_w	pls_congenere.nr_sequencia%type;
nr_seq_prestador_w	pls_prestador.nr_sequencia%type;
ie_somente_codigo_w	pls_conversao_proc.ie_somente_codigo%type;
nr_seq_regra_w		pls_conversao_proc.nr_sequencia%type;
dt_provavel_w		ptu_req_ord_serv_servico.dt_provavel%type;
ie_tipo_tabela_w	ptu_itens_pedido_a1100.ie_tipo_tabela%type := ptu_conversao_tipo_tabela(ie_tipo_tabela_p, cd_servico_p, 'R', null);
cd_servico_w		ptu_aut_ordem_serv_servico.cd_servico%type := ptu_conversao_item_tabela(ie_tipo_tabela_p, cd_servico_p, null);


BEGIN

if (coalesce(dt_provavel_p,'X')	<> 'X') then
	dt_provavel_w	:= to_date(dt_provavel_p, 'dd/mm/rrrr');
end if;

begin
	qt_servico_w	:= (ptu_obter_qtd_env_itens_scs(null, qt_servico_p, 'R'))::numeric;
exception
when others then
	qt_servico_w	:= (replace(ptu_obter_qtd_env_itens_scs(null, qt_servico_p, 'R'),',','.'))::numeric;
end;

select	cd_unimed_beneficiario,
	nr_seq_prestador
into STRICT	cd_unimed_benef_w,
	nr_seq_prestador_w
from	ptu_requisicao_ordem_serv
where	nr_sequencia = nr_seq_req_ord_p;

select	nextval('ptu_req_ord_serv_servico_seq')
into STRICT	nr_seq_req_ord_serv_w
;

--Verifica qual o estabelecimento padrao utilizado no SCS

select	coalesce(max(cd_estabelecimento),1)
into STRICT	cd_estabelecimento_w
from	pls_parametros_scs
where	(cd_estabelecimento IS NOT NULL AND cd_estabelecimento::text <> '');

if (ie_tipo_tabela_w	in ('0','1','4')) then
	select	count(1)
	into STRICT	qt_reg_proc_w
	from	procedimento
	where	cd_procedimento	= cd_servico_w;

	if (qt_reg_proc_w	> 0) then
		select	CASE WHEN ie_tipo_tabela_p='00' THEN  4  ELSE max(ie_origem_proced) END
		into STRICT	ie_origem_proced_w
		from    procedimento
		where   cd_procedimento		= cd_servico_w
		and	ie_origem_proced	in (1,4,5,8)
		and	ie_situacao		= 'A';

		select	max(nr_sequencia)
		into STRICT	nr_seq_congenere_w
		from	pls_congenere
		where	cd_cooperativa		= cd_unimed_benef_w
		and 	ie_situacao 		= 'A';

		pls_obter_proced_conversao(	cd_servico_w, ie_origem_proced_w, nr_seq_prestador_w,
						cd_estabelecimento_w, 3, nr_seq_congenere_w,
						2,'R', null,
						null, null, null,
						null, cd_servico_conversao_w, ie_origem_proced_ww,
						nr_seq_regra_w, ie_somente_codigo_w, clock_timestamp(),
						null, null, null);

		insert	into ptu_req_ord_serv_servico(nr_sequencia, cd_servico, ds_opme,
			ie_tipo_tabela, nm_usuario, nr_seq_req_ord,
			dt_atualizacao, qt_servico_aut, nm_usuario_nrec,
			dt_atualizacao_nrec, cd_servico_consersao, ie_origem_servico,
			nr_seq_item, vl_servico, vl_uni_servico,
			cd_anvisa, cd_referencia_fab, ie_tipo_anexo,
			dt_provavel, qt_dosagem_total, qt_unidade_medida,
			cd_via_administracao, qt_frequencia_adm, ie_pacote,
			ie_tipo_ordem)
		values (nr_seq_req_ord_serv_w, cd_servico_w, ds_opme_p,
			ie_tipo_tabela_w, nm_usuario_p, nr_seq_req_ord_p,
			clock_timestamp(), qt_servico_w, nm_usuario_p,
			clock_timestamp(), cd_servico_conversao_w, coalesce(ie_origem_proced_ww, ie_origem_proced_w),
			nr_seq_item_p, vl_servico_p, vl_uni_servico_p,
			cd_anvisa_p, cd_referencia_fab_p, ie_tipo_anexo_p,
			dt_provavel_w, qt_dosagem_total_p, lpad(qt_unidade_medida_p,3,'0'),
			lpad(cd_via_administracao_p,2,'0'), qt_frequencia_adm_p, ie_pacote_p,
			ie_tipo_ordem_p);
	else
		insert	into ptu_req_ord_serv_servico(nr_sequencia, cd_servico, ds_opme,
			ie_tipo_tabela, nm_usuario, nr_seq_req_ord,
			dt_atualizacao, qt_servico_aut, nm_usuario_nrec,
			dt_atualizacao_nrec, cd_servico_consersao,
			nr_seq_item, vl_servico, vl_uni_servico,
			cd_anvisa, cd_referencia_fab, ie_tipo_anexo,
			dt_provavel, qt_dosagem_total, qt_unidade_medida,
			cd_via_administracao, qt_frequencia_adm, ie_pacote,
			ie_tipo_ordem, ie_origem_servico)
		values (nr_seq_req_ord_serv_w, cd_servico_w, ds_opme_p,
			ie_tipo_tabela_w, nm_usuario_p, nr_seq_req_ord_p,
			clock_timestamp(), qt_servico_w, nm_usuario_p,
			clock_timestamp(), cd_servico_conversao_w,
			nr_seq_item_p, vl_servico_p, vl_uni_servico_p,
			cd_anvisa_p, cd_referencia_fab_p, ie_tipo_anexo_p,
			dt_provavel_w, qt_dosagem_total_p, lpad(qt_unidade_medida_p,3,'0'),
			lpad(cd_via_administracao_p,2,'0'), qt_frequencia_adm_p, ie_pacote_p,
			ie_tipo_ordem_p, CASE WHEN ie_tipo_tabela_p='00' THEN  4  ELSE null END );

		CALL ptu_inserir_inconsistencia(	null, null, 2009,
						'',cd_estabelecimento_w, nr_seq_req_ord_p,
						'OR', '00807', nr_seq_req_ord_serv_w,
						null, null, nm_usuario_p);
	end if;
elsif (ie_tipo_tabela_w	in ('2','3','5','6')) then
	nr_seq_material_w	:= substr(pls_obter_dados_material_a900(cd_servico_w,null,'NR'),1,255);

	if (coalesce(nr_seq_material_w,0)	= 0) then
		nr_seq_material_w	:= substr(pls_obter_seq_codigo_material('',cd_servico_w),1,8);
	end if;

	if (coalesce(nr_seq_material_w,0)	<> 0) then
		ptu_gerar_mat_envio_intercamb(	cd_servico_w, 'R', ie_tipo_tabela_w,
						null, nm_usuario_p, cd_servico_conversao_w,
						ds_opme_w);

		insert	into ptu_req_ord_serv_servico(nr_sequencia, cd_servico, ds_opme,
			ie_tipo_tabela, nm_usuario, nr_seq_req_ord,
			dt_atualizacao, qt_servico_aut, nm_usuario_nrec,
			dt_atualizacao_nrec, cd_servico_consersao,
			nr_seq_item, vl_servico, vl_uni_servico,
			cd_anvisa, cd_referencia_fab, ie_tipo_anexo,
			dt_provavel, qt_dosagem_total, qt_unidade_medida,
			cd_via_administracao, qt_frequencia_adm, ie_pacote,
			ie_tipo_ordem)
		values (nr_seq_req_ord_serv_w, cd_servico_w, ds_opme_w,
			ie_tipo_tabela_w, nm_usuario_p, nr_seq_req_ord_p,
			clock_timestamp(), qt_servico_w, nm_usuario_p,
			clock_timestamp(), cd_servico_conversao_w,
			nr_seq_item_p, vl_servico_p, vl_uni_servico_p,
			cd_anvisa_p, cd_referencia_fab_p, ie_tipo_anexo_p,
			dt_provavel_w, qt_dosagem_total_p, lpad(qt_unidade_medida_p,3,'0'),
			lpad(cd_via_administracao_p,2,'0'), qt_frequencia_adm_p, ie_pacote_p,
			ie_tipo_ordem_p);

	else
		insert	into ptu_req_ord_serv_servico(nr_sequencia, cd_servico, ds_opme,
			ie_tipo_tabela, nm_usuario, nr_seq_req_ord,
			dt_atualizacao, qt_servico_aut, nm_usuario_nrec,
			dt_atualizacao_nrec,
			nr_seq_item, vl_servico, vl_uni_servico,
			cd_anvisa, cd_referencia_fab, ie_tipo_anexo,
			dt_provavel, qt_dosagem_total, qt_unidade_medida,
			cd_via_administracao, qt_frequencia_adm, ie_pacote,
			ie_tipo_ordem)
		values (nr_seq_req_ord_serv_w, cd_servico_w, ds_opme_w,
			ie_tipo_tabela_w, nm_usuario_p, nr_seq_req_ord_p,
			clock_timestamp(), qt_servico_w, nm_usuario_p,
			clock_timestamp(),
			nr_seq_item_p, vl_servico_p, vl_uni_servico_p,
			cd_anvisa_p, cd_referencia_fab_p, ie_tipo_anexo_p,
			dt_provavel_w, qt_dosagem_total_p, lpad(qt_unidade_medida_p,3,'0'),
			lpad(cd_via_administracao_p,2,'0'), qt_frequencia_adm_p, ie_pacote_p,
			ie_tipo_ordem_p);

		CALL ptu_inserir_inconsistencia(	null, null, 2009,
						'',cd_estabelecimento_w, nr_seq_req_ord_p,
						'OR', '00807', null,
						nr_seq_req_ord_serv_w, null, nm_usuario_p);

	end if;
end if;

commit;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ptu_imp_pck.ptu_imp_dados_00806_v70 ( nr_seq_req_ord_p ptu_req_ord_serv_servico.nr_seq_req_ord%type, nr_seq_item_p ptu_req_ord_serv_servico.nr_seq_item%type, ie_tipo_tabela_p ptu_req_ord_serv_servico.ie_tipo_tabela%type, cd_servico_p ptu_req_ord_serv_servico.cd_servico%type, qt_servico_p ptu_req_ord_serv_servico.qt_servico_aut%type, ds_opme_p ptu_req_ord_serv_servico.ds_opme%type, vl_servico_p ptu_req_ord_serv_servico.vl_servico%type, vl_uni_servico_p ptu_req_ord_serv_servico.vl_uni_servico%type, cd_anvisa_p ptu_req_ord_serv_servico.cd_anvisa%type, cd_referencia_fab_p ptu_req_ord_serv_servico.cd_referencia_fab%type, ie_tipo_anexo_p ptu_req_ord_serv_servico.ie_tipo_anexo%type, dt_provavel_p text, qt_dosagem_total_p ptu_req_ord_serv_servico.qt_dosagem_total%type, qt_unidade_medida_p ptu_req_ord_serv_servico.qt_unidade_medida%type, cd_via_administracao_p ptu_req_ord_serv_servico.cd_via_administracao%type, qt_frequencia_adm_p ptu_req_ord_serv_servico.qt_frequencia_adm%type, ie_pacote_p ptu_req_ord_serv_servico.ie_pacote%type, ie_tipo_ordem_p ptu_req_ord_serv_servico.ie_tipo_ordem%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;
