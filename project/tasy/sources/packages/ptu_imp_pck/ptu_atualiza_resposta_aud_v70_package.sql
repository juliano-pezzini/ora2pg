-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE ptu_imp_pck.ptu_atualiza_resposta_aud_v70 (nr_seq_resp_aud_p ptu_resposta_auditoria.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) AS $body$
DECLARE


nr_seq_guia_w		pls_guia_plano.nr_sequencia%type;
nr_seq_requisicao_w	pls_requisicao.nr_sequencia%type;
nr_seq_execucao_w	ptu_resposta_auditoria.nr_seq_execucao%type;


BEGIN

--Selec utilizado para verificar se a auditoria foi gerada na autorizacao ou na requisicao

select	a.nr_seq_guia,
	a.nr_seq_requisicao,
	a.nr_seq_execucao
into STRICT	nr_seq_guia_w,
	nr_seq_requisicao_w,
	nr_seq_execucao_w
from	ptu_resposta_auditoria a
where	a.nr_sequencia 	= nr_seq_resp_aud_p;

if (nr_seq_requisicao_w IS NOT NULL AND nr_seq_requisicao_w::text <> '') then
	--Rotina utilizada para atualizar as informacoes na OPS - Requisicao para Autorizacao e na auditoria existente

	CALL ptu_atualiza_req_auditoria( nr_seq_requisicao_w, nr_seq_resp_aud_p, nm_usuario_p,cd_estabelecimento_p );

	-- Inserir as glosas das inconsistencias PTU,  e necessario chamar esta rotina apos atualizar o status da requisicao e da guia

	CALL pls_obter_glosa_incons(nr_seq_requisicao_w, 'R', nm_usuario_p);
elsif (nr_seq_guia_w IS NOT NULL AND nr_seq_guia_w::text <> '') then
	--Rotina utilizada para atualizar as informacoes na OPS - Autorizacao e na auditoria existente

	CALL ptu_atualiza_guia_auditoria( nr_seq_guia_w, nr_seq_resp_aud_p, nm_usuario_p,cd_estabelecimento_p );

	-- Inserir as glosas das inconsistencias PTU,  e necessario chamar esta rotina apos atualizar o status da requisicao e da guia

	CALL pls_obter_glosa_incons(nr_seq_guia_w, 'G', nm_usuario_p);
end if;

-- Gerar confirmacao da transacao tipo de respota RA- Resposta de Auditoria

CALL ptu_imp_pck.ptu_gerar_confirmacao_v70(nr_seq_execucao_w, cd_estabelecimento_p, 'RA', pls_obter_versao_scs, nm_usuario_p);

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ptu_imp_pck.ptu_atualiza_resposta_aud_v70 (nr_seq_resp_aud_p ptu_resposta_auditoria.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) FROM PUBLIC;
