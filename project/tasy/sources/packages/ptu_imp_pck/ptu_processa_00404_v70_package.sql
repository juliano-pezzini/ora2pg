-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE ptu_imp_pck.ptu_processa_00404_v70 ( nr_seq_resp_aud_p ptu_resposta_auditoria.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nr_seq_confirmacao_p INOUT ptu_confirmacao.nr_sequencia%type) AS $body$
DECLARE


ie_item_existe_w	varchar(1);
ie_importar_w		varchar(1) := 'S';
cd_estabelecimento_w	estabelecimento.cd_estabelecimento%type;
nr_seq_execucao_w	ptu_resposta_auditoria.nr_sequencia%type;
nr_seq_requisicao_w	ptu_resposta_auditoria.nr_seq_requisicao%type;
nr_seq_guia_w		ptu_resposta_auditoria.nr_seq_guia%type;


BEGIN

cd_estabelecimento_w := cd_estabelecimento_p;

--Quando as transacoes sao geradas pelo WebService, nao existe estabelecimento definido, entao e verificado o estabeleicmento do parametro

if ( coalesce(cd_estabelecimento_w::text, '') = ''	) then
	cd_estabelecimento_w := ptu_obter_estab_padrao;
end if;

-- Gerar as informacoes das tabelas do PTU para as tabelas de Guia ou Requisicao  00404 - Resposta de Auditoria

CALL ptu_imp_pck.ptu_gerar_resp_auditoria_v70(nr_seq_resp_aud_p, nm_usuario_p, cd_estabelecimento_w);

begin
	select	nr_seq_requisicao,
		nr_seq_guia
	into STRICT	nr_seq_requisicao_w,
		nr_seq_guia_w
	from	ptu_resposta_auditoria
	where	nr_sequencia	= nr_seq_resp_aud_p;
exception
when others then
	nr_seq_requisicao_w	:= null;
	nr_seq_guia_w		:= null;
end;

if (nr_seq_requisicao_w IS NOT NULL AND nr_seq_requisicao_w::text <> '') then
	select	CASE WHEN ie_estagio=3 THEN  'N'  ELSE 'S' END  -- 3 = Cancelada
	into STRICT	ie_importar_w
	from	pls_requisicao
	where	nr_sequencia = nr_seq_requisicao_w;
elsif (nr_seq_guia_w IS NOT NULL AND nr_seq_guia_w::text <> '') then
	select	CASE WHEN ie_estagio=8 THEN  'N'  ELSE 'S' END  -- 8 = Cancelada
	into STRICT	ie_importar_w
	from	pls_guia_plano
	where	nr_sequencia = nr_seq_guia_w;
end if;

select	nr_seq_execucao
into STRICT	nr_seq_execucao_w
from	ptu_resposta_auditoria
where	nr_sequencia = nr_seq_resp_aud_p;

if (ie_importar_w	= 'S') then
	--Gerar as informacoes das tabelas do PTU para as tabelas de Guia ou Requisicao  00404 - Resposta de Auditoria

	ie_item_existe_w := ptu_imp_pck.ptu_gerar_resp_aud_item_v70(nr_seq_resp_aud_p, nm_usuario_p, cd_estabelecimento_w, ie_item_existe_w);

	--Gerar as inconsistencias recebidas no XML da 00404 - Resposta de Auditoria

	CALL ptu_imp_pck.ptu_gerar_incon_resp_aud_v70(nr_seq_resp_aud_p, nm_usuario_p, cd_estabelecimento_w);

	--Se algum item do arquivo XML nao for encontrado na base o sistema nao processa o pedido

	if ( ie_item_existe_w = 'S' ) then
		-- Gerar as informacoes referente as inconsistencias dos itens  00404 - Resposta de Auditoria

		CALL ptu_imp_pck.ptu_atualiza_resposta_aud_v70(nr_seq_resp_aud_p, nm_usuario_p, cd_estabelecimento_w);
	elsif ( ie_item_existe_w = 'N' ) then
		-- Tipo de respota RAI- Resposta de Auditoria Invalida

		CALL ptu_imp_pck.ptu_gerar_confirmacao_v70(nr_seq_execucao_w, cd_estabelecimento_w, 'RAI', pls_obter_versao_scs, nm_usuario_p);
	end if;
else
	CALL ptu_imp_pck.ptu_gerar_confirmacao_v70(nr_seq_execucao_w, cd_estabelecimento_w, 'RAI', pls_obter_versao_scs, nm_usuario_p);
end if;

--Retorna a sequencia da resposta de confirmacao gerada para o 00404 - Resposta de Auditoria, esta sequencia e utilizada pelo WebService para gerar o XML de resposta do pedido

select (select	max(nr_sequencia)
	from	ptu_confirmacao c
	where	c.nr_seq_execucao	= a.nr_seq_execucao
	and	c.cd_unimed_executora	= a.cd_unimed_executora) nr_seq_resp_ped_aut
into STRICT	nr_seq_confirmacao_p
from	ptu_resposta_auditoria a
where	a.nr_sequencia = nr_seq_resp_aud_p;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ptu_imp_pck.ptu_processa_00404_v70 ( nr_seq_resp_aud_p ptu_resposta_auditoria.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nr_seq_confirmacao_p INOUT ptu_confirmacao.nr_sequencia%type) FROM PUBLIC;
