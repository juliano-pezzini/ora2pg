-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


--------------------------------------------------------------------------------00361 Resposta do Status da Transacao-------------------------------------------------------------------------------------------------------------------------------------------------------------------



CREATE OR REPLACE PROCEDURE ptu_imp_pck.ptu_imp_cab_00361_v70 ( cd_transacao_p ptu_resp_pedido_status.cd_transacao%type, ie_tipo_cliente_p text, cd_unimed_exec_p ptu_resp_pedido_status.cd_unimed_executora%type, cd_unimed_benef_p ptu_resp_pedido_status.cd_unimed_beneficiario%type, nr_seq_execucao_p ptu_resp_pedido_status.nr_seq_execucao%type, nr_seq_origem_p ptu_resp_pedido_status.nr_seq_origem%type, ie_tipo_identif_p ptu_resp_pedido_status.ie_tipo_identificador%type, dt_validade_p text, nr_versao_p ptu_resp_pedido_status.nr_versao%type, ie_sexo_p ptu_resp_pedido_status.ie_sexo%type, dt_nascimento_p text, ds_observacao_p ptu_resp_pedido_status.ds_observacao%type, nr_seq_pedido_novo_p INOUT ptu_resp_pedido_status.nr_sequencia%type, nr_seq_transacao_p INOUT ptu_pedido_compl_aut.nr_seq_guia%type, ie_tipo_transacao_p INOUT text, nr_seq_guia_p INOUT ptu_resp_pedido_status.nr_seq_guia%type, nr_seq_requisicao_p INOUT ptu_resp_pedido_status.nr_seq_requisicao%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE


/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade: Importar resposta do pedido de status da transacao 00361 - Resposta do Status da Transacao

Rotina utilizada nas transacoes ptu via scs
quando for alterar, favor verificar com o analista responsavel para a realizacao de testes.
-------------------------------------------------------------------------------------------------------------------

Locais de chamada direta:
[ X ]  Objetos do dicionario [  ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatorios [ ] Outros:
 ------------------------------------------------------------------------------------------------------------------

Pontos de atencao:
Performance
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */


ie_tipo_cliente_w		ptu_resp_pedido_status.ie_tipo_cliente%type;
dt_validade_w			ptu_resp_pedido_status.dt_validade%type;
nr_seq_pedido_compl_w		ptu_controle_execucao.nr_seq_pedido_compl%type;
nr_seq_pedido_aut_w		ptu_controle_execucao.nr_seq_pedido_aut%type;
nr_seq_guia_w			ptu_pedido_compl_aut.nr_seq_guia%type;
nr_seq_requisicao_w		ptu_pedido_compl_aut.nr_seq_requisicao%type;
nr_seq_pedido_status_w		ptu_pedido_status.nr_sequencia%type;
dt_nascimento_w			ptu_resp_pedido_status.dt_nascimento%type;


BEGIN
if (coalesce(dt_validade_p,'X')	<> 'X') then
	begin
		dt_validade_w	:= to_date(dt_validade_p, 'dd/mm/rrrr');
	exception
	when others then
		dt_validade_w	:= clock_timestamp();
	end;
end if;
if (coalesce(dt_nascimento_p,'X')	<> 'X') then
	dt_nascimento_w	:= to_date(dt_nascimento_p, 'dd/mm/rrrr');
end if;

begin
	select	nr_seq_pedido_compl,
		nr_seq_pedido_aut
	into STRICT	nr_seq_pedido_compl_w,
		nr_seq_pedido_aut_w
	from	ptu_controle_execucao
	where	nr_sequencia	= nr_seq_execucao_p;
exception
when others then
	nr_seq_pedido_compl_w	:= null;
	nr_seq_pedido_aut_w	:= null;
end;

if (nr_seq_pedido_compl_w IS NOT NULL AND nr_seq_pedido_compl_w::text <> '') then
	begin
		select	nr_seq_guia,
			nr_seq_requisicao
		into STRICT	nr_seq_guia_w,
			nr_seq_requisicao_w
		from	ptu_pedido_compl_aut
		where	nr_sequencia	= nr_seq_pedido_compl_w;
	exception
	when others then
		nr_seq_guia_w		:= null;
		nr_seq_requisicao_w	:= null;
	end;
elsif (nr_seq_pedido_aut_w IS NOT NULL AND nr_seq_pedido_aut_w::text <> '') then
	begin
		select	nr_seq_guia,
			nr_seq_requisicao
		into STRICT	nr_seq_guia_w,
			nr_seq_requisicao_w
		from	ptu_pedido_autorizacao
		where	nr_sequencia	= nr_seq_pedido_aut_w;
	exception
	when others then
		nr_seq_guia_w		:= null;
		nr_seq_requisicao_w	:= null;
	end;
end if;

if (coalesce(nr_seq_requisicao_w,0)	<> 0) then
	nr_seq_transacao_p	:= nr_seq_requisicao_w;
	ie_tipo_transacao_p	:= 'R';
elsif (coalesce(nr_seq_guia_w,0)	<> 0) then
	nr_seq_transacao_p	:= nr_seq_guia_w;
	ie_tipo_transacao_p	:= 'G';
end if;

ie_tipo_cliente_w := ptu_converter_tipo_cliente(ie_tipo_cliente_p);


if (nr_seq_requisicao_w IS NOT NULL AND nr_seq_requisicao_w::text <> '') then
	select	max(nr_sequencia)
	into STRICT	nr_seq_pedido_status_w
	from	ptu_pedido_status
	where	nr_transacao_uni_exec	= nr_seq_execucao_p
	and	nr_seq_requisicao	= nr_seq_requisicao_w;
elsif (nr_seq_guia_w IS NOT NULL AND nr_seq_guia_w::text <> '') then
	select	max(nr_sequencia)
	into STRICT	nr_seq_pedido_status_w
	from	ptu_pedido_status
	where	nr_transacao_uni_exec	= nr_seq_execucao_p
	and	nr_seq_guia		= nr_seq_guia_w;
end if;

insert	into ptu_resp_pedido_status(nr_sequencia, cd_transacao, cd_unimed_beneficiario,
	cd_unimed_executora, ds_observacao, dt_atualizacao,
	dt_atualizacao_nrec, dt_validade, ie_tipo_cliente,
	ie_tipo_identificador, nm_usuario, nm_usuario_nrec,
	nr_seq_guia, nr_seq_pedido_status, nr_seq_requisicao,
	nr_seq_origem, nr_seq_execucao, nr_versao,
	dt_nascimento, ie_sexo)
values (nextval('ptu_resp_pedido_status_seq'), cd_transacao_p, cd_unimed_benef_p,
	cd_unimed_exec_p, ds_observacao_p, clock_timestamp(),
	clock_timestamp(), dt_validade_w, ie_tipo_cliente_w,
	ie_tipo_identif_p, nm_usuario_p, nm_usuario_p,
	nr_seq_guia_w, nr_seq_pedido_status_w, nr_seq_requisicao_w,
	nr_seq_origem_p, nr_seq_execucao_p, nr_versao_p,
	dt_nascimento_w, ie_sexo_p) returning nr_sequencia into nr_seq_pedido_novo_p;

if (nr_seq_requisicao_w IS NOT NULL AND nr_seq_requisicao_w::text <> '') then
	nr_seq_guia_p		:= 0;
else
	nr_seq_guia_p		:= coalesce(nr_seq_guia_w,0);
end if;

nr_seq_requisicao_p	:=	coalesce(nr_seq_requisicao_w,0);

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ptu_imp_pck.ptu_imp_cab_00361_v70 ( cd_transacao_p ptu_resp_pedido_status.cd_transacao%type, ie_tipo_cliente_p text, cd_unimed_exec_p ptu_resp_pedido_status.cd_unimed_executora%type, cd_unimed_benef_p ptu_resp_pedido_status.cd_unimed_beneficiario%type, nr_seq_execucao_p ptu_resp_pedido_status.nr_seq_execucao%type, nr_seq_origem_p ptu_resp_pedido_status.nr_seq_origem%type, ie_tipo_identif_p ptu_resp_pedido_status.ie_tipo_identificador%type, dt_validade_p text, nr_versao_p ptu_resp_pedido_status.nr_versao%type, ie_sexo_p ptu_resp_pedido_status.ie_sexo%type, dt_nascimento_p text, ds_observacao_p ptu_resp_pedido_status.ds_observacao%type, nr_seq_pedido_novo_p INOUT ptu_resp_pedido_status.nr_sequencia%type, nr_seq_transacao_p INOUT ptu_pedido_compl_aut.nr_seq_guia%type, ie_tipo_transacao_p INOUT text, nr_seq_guia_p INOUT ptu_resp_pedido_status.nr_seq_guia%type, nr_seq_requisicao_p INOUT ptu_resp_pedido_status.nr_seq_requisicao%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;
