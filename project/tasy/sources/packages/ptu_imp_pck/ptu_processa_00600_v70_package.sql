-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE ptu_imp_pck.ptu_processa_00600_v70 ( nr_seq_pedido_aut_p ptu_pedido_autorizacao.nr_sequencia%type, ie_possui_pedido_p text, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, ie_tipo_guia_p pls_requisicao.ie_tipo_guia%type, nr_seq_resp_pedido_aut_p INOUT ptu_resposta_autorizacao.nr_sequencia%type) AS $body$
DECLARE


cd_estabelecimento_w		estabelecimento.cd_estabelecimento%type;


BEGIN

cd_estabelecimento_w := cd_estabelecimento_p;

--Quando as transacoes sao geradas pelo WebService, nao existe estabelecimento definido, entao e verificado o estabeleicmento do parametro

if ( coalesce(cd_estabelecimento_w::text, '') = ''	) then
	cd_estabelecimento_w := ptu_obter_estab_padrao;
end if;

--Se ja existir um pedido de autorizacao so precisa gerar a resposta do pedido

--Esta informacao e obtida na rotina  PTU_PEDAUT_V50_WS que importa o cabecalho do pedido de autorizacao e realizada nesta rotina, pois se

--retornar S nao deve realizar a importacao de mais nenhuma informacao pelo Webservice

if ( ie_possui_pedido_p = 'N' ) then
	--Rotina utilizada para gerar a Requisicao ou Autorizacao

	CALL ptu_gerar_guia_requisicao( nr_seq_pedido_aut_p, nm_usuario_p, cd_estabelecimento_w, ie_tipo_guia_p);

	--Rotina utilizada para gerar os itens nos campos da Autorizacao ou Requisicao

	CALL ptu_gerar_itens_guia_req( nr_seq_pedido_aut_p, nm_usuario_p, cd_estabelecimento_w);

	---Rotina utilizada para gerar os dados dos anexos na Autorizacao ou Requisicao

	CALL ptu_gerar_anexo_guia_req( nr_seq_pedido_aut_p, nm_usuario_p, cd_estabelecimento_w);
end if;

CALL ptu_imp_pck.ptu_atualizar_ped_v70( nr_seq_pedido_aut_p, ie_possui_pedido_p, nm_usuario_p, cd_estabelecimento_w);

--Retorna a sequencia da resposta do  00600 - Pedido de Autorizacao, esta sequencia e utilizada para gerar o XML de resposta pelo Webservice

select (	select	max(nr_sequencia)
	from	ptu_resposta_autorizacao c
	where	c.nr_seq_execucao	= a.nr_seq_execucao
	and	c.cd_unimed_executora	= a.cd_unimed_executora) nr_seq_resp_ped_aut
into STRICT	nr_seq_resp_pedido_aut_p
from	ptu_pedido_autorizacao a
where	a.nr_sequencia = nr_seq_pedido_aut_p;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ptu_imp_pck.ptu_processa_00600_v70 ( nr_seq_pedido_aut_p ptu_pedido_autorizacao.nr_sequencia%type, ie_possui_pedido_p text, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, ie_tipo_guia_p pls_requisicao.ie_tipo_guia%type, nr_seq_resp_pedido_aut_p INOUT ptu_resposta_autorizacao.nr_sequencia%type) FROM PUBLIC;
