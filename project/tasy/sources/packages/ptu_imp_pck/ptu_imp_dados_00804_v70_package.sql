-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE ptu_imp_pck.ptu_imp_dados_00804_v70 ( nr_seq_item_p ptu_aut_ordem_serv_servico.nr_seq_item%type, ie_tipo_tabela_p ptu_aut_ordem_serv_servico.ie_tipo_tabela%type, cd_servico_p ptu_aut_ordem_serv_servico.cd_servico%type, ds_servico_p ptu_aut_ordem_serv_servico.ds_servico%type, ie_autorizado_p ptu_aut_ordem_serv_servico.ie_autorizado%type, nm_usuario_p ptu_aut_ordem_serv_servico.nm_usuario%type, qt_autorizado_p ptu_aut_ordem_serv_servico.qt_autorizado%type, nr_seq_aut_ord_serv_p ptu_aut_ordem_serv_servico.nr_seq_aut_ord_serv%type) AS $body$
DECLARE


/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade: Realizar a importacao dos itens do arquivo de  00804 - Autorizacao de Ordem de Servico
-------------------------------------------------------------------------------------------------------------------

Locais de chamada direta:
[ X ]  Objetos do dicionario [  ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatorios [ ] Outros:
 ------------------------------------------------------------------------------------------------------------------

Pontos de atencao:
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */


qt_autorizada_w		ptu_aut_ordem_serv_servico.qt_autorizado%type;
cd_servico_conversao_w	ptu_aut_ordem_serv_servico.cd_servico_conversao%type;
nr_seq_solicitante_w	ptu_autorizacao_ordem_serv.nr_transacao_solicitante%type;
cd_unimed_solicitante_w	ptu_autorizacao_ordem_serv.cd_unimed_solicitante%type;
ie_tipo_tabela_w	ptu_itens_pedido_a1100.ie_tipo_tabela%type := ptu_conversao_tipo_tabela(ie_tipo_tabela_p, cd_servico_p, 'R', null);
cd_servico_w		ptu_aut_ordem_serv_servico.cd_servico%type := ptu_conversao_item_tabela(ie_tipo_tabela_p, cd_servico_p, null);


BEGIN

select 	nr_transacao_solicitante,
	cd_unimed_solicitante
into STRICT	nr_seq_solicitante_w,
	cd_unimed_solicitante_w
from	ptu_autorizacao_ordem_serv
where	nr_sequencia = nr_seq_aut_ord_serv_p;

begin
	qt_autorizada_w		:= (ptu_obter_qtd_env_itens_scs(null, qt_autorizado_p, 'R'))::numeric;
exception
when others then
	qt_autorizada_w		:= (replace(ptu_obter_qtd_env_itens_scs(null, qt_autorizado_p, 'R'),',','.'))::numeric;
end;

begin
	select	b.cd_servico_consersao
	into STRICT	cd_servico_conversao_w
	from	ptu_requisicao_ordem_serv a,
		ptu_req_ord_serv_servico b
	where	a.nr_sequencia		= b.nr_seq_req_ord
	and	a.nr_seq_origem		= nr_seq_solicitante_w
	and	a.cd_unimed_solicitante	= cd_unimed_solicitante_w;
exception
when others then
	cd_servico_conversao_w	:= null;
end;


insert into ptu_aut_ordem_serv_servico(nr_sequencia, ie_tipo_tabela, cd_servico,
	ds_servico, qt_autorizado, cd_servico_conversao,
	nm_usuario, nm_usuario_nrec, dt_atualizacao,
	dt_atualizacao_nrec, nr_seq_aut_ord_serv, nr_seq_item,
	ie_autorizado, ie_origem_servico)
values (nextval('ptu_aut_ordem_serv_servico_seq'), ie_tipo_tabela_w, cd_servico_w,
	ds_servico_p, qt_autorizada_w, cd_servico_conversao_w,
	nm_usuario_p, nm_usuario_p, clock_timestamp(),
	clock_timestamp(), nr_seq_aut_ord_serv_p, nr_seq_item_p,
	ie_autorizado_p, CASE WHEN ie_tipo_tabela_p='00' THEN  4  ELSE null END );

commit;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ptu_imp_pck.ptu_imp_dados_00804_v70 ( nr_seq_item_p ptu_aut_ordem_serv_servico.nr_seq_item%type, ie_tipo_tabela_p ptu_aut_ordem_serv_servico.ie_tipo_tabela%type, cd_servico_p ptu_aut_ordem_serv_servico.cd_servico%type, ds_servico_p ptu_aut_ordem_serv_servico.ds_servico%type, ie_autorizado_p ptu_aut_ordem_serv_servico.ie_autorizado%type, nm_usuario_p ptu_aut_ordem_serv_servico.nm_usuario%type, qt_autorizado_p ptu_aut_ordem_serv_servico.qt_autorizado%type, nr_seq_aut_ord_serv_p ptu_aut_ordem_serv_servico.nr_seq_aut_ord_serv%type) FROM PUBLIC;
