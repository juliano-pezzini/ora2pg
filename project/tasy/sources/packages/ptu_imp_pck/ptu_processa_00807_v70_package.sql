-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE ptu_imp_pck.ptu_processa_00807_v70 ( cd_unimed_benef_p ptu_resposta_req_ord_serv.cd_unimed_beneficiario%type, cd_unimed_solic_p ptu_resposta_req_ord_serv.cd_unimed_solicitante%type, nr_seq_origem_p ptu_resposta_req_ord_serv.nr_seq_origem%type, nr_seq_resposta_p ptu_resposta_req_ord_serv.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE


/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade:  Importar resposta ordem serv_v50

Rotina utilizada nas transacoes ptu via scs homologadas com a unimed brasil.
quando for alterar, favor verificar com o analista responsavel para a realizacao de testes.
-------------------------------------------------------------------------------------------------------------------

Locais de chamada direta:
[ X ]  Objetos do dicionario [  ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatorios [ ] Outros:
 ------------------------------------------------------------------------------------------------------------------

Pontos de atencao:
Performance
---------------------------------------------------------------------------------------------------

++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */


qt_registros_neg_w	integer;
qt_registros_aprov_w	integer;


BEGIN

select	count(1)
into STRICT	qt_registros_neg_w
from	ptu_resposta_req_servico
where	nr_seq_resp_req_ord	= nr_seq_resposta_p
and	ie_status_requisicao	= 1;

select	count(1)
into STRICT	qt_registros_aprov_w
from	ptu_resposta_req_servico
where	nr_seq_resp_req_ord	= nr_seq_resposta_p
and	ie_status_requisicao	= 2;

-- Se a operadora de origem do beneficiario for diferente da operadora solicitante da ordem de servico, e caracterizada uma Triangulacao

if (cd_unimed_benef_p	<> cd_unimed_solic_p) then
	if (qt_registros_neg_w	> 0)	and (qt_registros_aprov_w	= 0) then
		-- Se a resposta da ordem de servico vier totalmente recusada, se encerra o processo

		update	ptu_requisicao_ordem_serv
		set	ie_estagio			= 4
		where	nr_transacao_solicitante	= nr_seq_origem_p
		and	cd_unimed_solicitante		= cd_unimed_solic_p;
	else
		-- Se pelo menos um item for aceito, a ordem de servico fica aguardando a transacao de autorizacao

		update	ptu_requisicao_ordem_serv
		set	ie_estagio			= 2
		where	nr_transacao_solicitante	= nr_seq_origem_p
		and	cd_unimed_solicitante		= cd_unimed_solic_p;
	end if;
-- Se a operadora de origem do beneficiario for igual a operadora solicitante da ordem de servico, e caracterizada uma transacao ponto-a-ponto

elsif (cd_unimed_benef_p	= cd_unimed_solic_p) then
	if (qt_registros_neg_w	> 0)	and (qt_registros_aprov_w	= 0) then
		-- Se a resposta da ordem de servico vier totalmente recusada, se encerra o processo

		update	ptu_requisicao_ordem_serv
		set	ie_estagio			= 4
		where	nr_transacao_solicitante	= nr_seq_origem_p
		and	cd_unimed_solicitante		= cd_unimed_solic_p;
	elsif (qt_registros_neg_w	> 0)	and (qt_registros_aprov_w	> 0) then
		-- Se a resposta da ordem de servico vier com servicos recusados e aceitos, a ordem de servico fica Parcialmente aceita

		update	ptu_requisicao_ordem_serv
		set	ie_estagio			= 5
		where	nr_transacao_solicitante	= nr_seq_origem_p
		and	cd_unimed_solicitante		= cd_unimed_solic_p;
	elsif (qt_registros_neg_w	= 0)	and (qt_registros_aprov_w	> 0) then
		-- Se a resposta da ordem de servico vier totalmente aceita, o estagio da ordem de servico fica Aceita e se encerra o processo

		update	ptu_requisicao_ordem_serv
		set	ie_estagio			= 3
		where	nr_transacao_solicitante	= nr_seq_origem_p
		and	cd_unimed_solicitante		= cd_unimed_solic_p;
	end if;
end if;

commit;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ptu_imp_pck.ptu_processa_00807_v70 ( cd_unimed_benef_p ptu_resposta_req_ord_serv.cd_unimed_beneficiario%type, cd_unimed_solic_p ptu_resposta_req_ord_serv.cd_unimed_solicitante%type, nr_seq_origem_p ptu_resposta_req_ord_serv.nr_seq_origem%type, nr_seq_resposta_p ptu_resposta_req_ord_serv.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;
