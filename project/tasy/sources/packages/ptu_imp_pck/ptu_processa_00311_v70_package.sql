-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE ptu_imp_pck.ptu_processa_00311_v70 ( nr_seq_pedido_cancel_p ptu_cancelamento.nr_sequencia%type, ie_possui_pedido_p text, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nr_seq_confirmacao_p INOUT ptu_confirmacao.nr_sequencia%type) AS $body$
DECLARE


cd_estabelecimento_w		estabelecimento.cd_estabelecimento%type;
ie_tipo_resposta_w		varchar(5);
nr_seq_origem_w			ptu_cancelamento.nr_seq_origem%type;
nr_seq_pedido_compl_w		ptu_pedido_compl_aut.nr_sequencia%type;
nr_seq_pedido_aut_w		ptu_pedido_autorizacao.nr_sequencia%type;
nr_seq_execucao_w		ptu_cancelamento.nr_seq_execucao%type;
cd_unimed_executora_w		ptu_cancelamento.cd_unimed_executora%type;
nr_seq_execucao_cancel_w	ptu_cancelamento.nr_seq_execucao%type;
nr_seq_origem_resp_w		ptu_resposta_autorizacao.nr_seq_origem%type;

BEGIN

cd_estabelecimento_w := cd_estabelecimento_p;

--Quando as transacoes sao geradas pelo WebService, nao existe estabelecimento definido, entao e verificado o estabeleicmento do parametro

if ( coalesce(cd_estabelecimento_w::text, '') = ''	) then
	cd_estabelecimento_w := ptu_obter_estab_padrao;
end if;

--Se ja existir um pedido de cancelamento o sistema nao gera nenhuma registro na base

if ( ie_possui_pedido_p = 'N' ) then
	select	nr_seq_execucao,
		cd_unimed_executora,
		nr_seq_origem,
		'CI'
	into STRICT	nr_seq_execucao_cancel_w,
		cd_unimed_executora_w,
		nr_seq_origem_w,
		ie_tipo_resposta_w
	from	ptu_cancelamento
	where	nr_sequencia = nr_seq_pedido_cancel_p;

	select	max(nr_sequencia)
	into STRICT	nr_seq_pedido_aut_w
	from	ptu_pedido_autorizacao
	where	nr_seq_execucao		= nr_seq_execucao_cancel_w
	and	cd_unimed_executora	= cd_unimed_executora_w;

	if (coalesce(nr_seq_pedido_aut_w::text, '') = '') then
		select	max(nr_sequencia)
		into STRICT	nr_seq_pedido_compl_w
		from	ptu_pedido_compl_aut
		where	nr_seq_execucao		= nr_seq_execucao_cancel_w
		and	cd_unimed_executora	= cd_unimed_executora_w;
	end if;

	if ((nr_seq_pedido_compl_w IS NOT NULL AND nr_seq_pedido_compl_w::text <> '') and nr_seq_pedido_compl_w <> 0) then
		select	max(nr_seq_execucao)
		into STRICT	nr_seq_execucao_w
		from	ptu_pedido_compl_aut
		where	nr_sequencia		= nr_seq_pedido_compl_w;

		if (nr_seq_execucao_w <> nr_seq_execucao_cancel_w) then
			nr_seq_pedido_compl_w := null;
		end if;
	elsif ((nr_seq_pedido_aut_w IS NOT NULL AND nr_seq_pedido_aut_w::text <> '') and nr_seq_pedido_aut_w <> 0) then
		select	max(nr_seq_execucao)
		into STRICT	nr_seq_execucao_w
		from	ptu_pedido_autorizacao
		where	nr_sequencia		= nr_seq_pedido_aut_w;

		if (nr_seq_execucao_w <> nr_seq_execucao_cancel_w) then
			nr_seq_pedido_aut_w := null;
		end if;
	end if;

	select	max(nr_seq_origem)
	into STRICT	nr_seq_origem_resp_w
	from	ptu_resposta_autorizacao
	where	nr_seq_execucao		= nr_seq_execucao_cancel_w
	and	cd_unimed_executora	= cd_unimed_executora_w;

	if	(((nr_seq_origem_resp_w = 0) and (coalesce(nr_seq_origem_w, 0) <> 0 )) or
		(nr_seq_origem_resp_w <> 0 AND nr_seq_origem_w <> nr_seq_origem_resp_w)) then
		nr_seq_pedido_aut_w	:= null;
		nr_seq_pedido_compl_w	:= null;
	end if;

	if ((nr_seq_pedido_aut_w IS NOT NULL AND nr_seq_pedido_aut_w::text <> '')	or	(nr_seq_pedido_compl_w IS NOT NULL AND nr_seq_pedido_compl_w::text <> '')) then
		--Rotina utilizada para gerar o cancelamento da guia ou requisicao

		ie_tipo_resposta_w	:= '';
		nr_seq_origem_w		:= null;
		ptu_gerar_cancel_guia_req( nr_seq_pedido_cancel_p, cd_estabelecimento_p, nm_usuario_p, ie_tipo_resposta_w, nr_seq_origem_w);
	end if;
	---Rotina utilizada para

	if (ie_tipo_resposta_w = 'CI') then
		nr_seq_origem_w	:= nr_seq_pedido_cancel_p;
	end if;
	CALL ptu_imp_pck.ptu_gerar_confirmacao_v70(nr_seq_origem_w, cd_estabelecimento_p, ie_tipo_resposta_w, pls_obter_versao_scs, nm_usuario_p);
end if;

--Retorna a sequencia da resposta de confirmacao gerada para o 00311 - Pedido de cancelamento, esta sequencia e utilizada pelo WebService para gerar o XML de resposta do pedido

select (select	max(nr_sequencia)
	from	ptu_confirmacao c
	where	c.nr_seq_execucao	= a.nr_seq_execucao
	and	c.cd_unimed_executora	= a.cd_unimed_executora) nr_seq_resp_ped_aut
into STRICT	nr_seq_confirmacao_p
from	ptu_cancelamento a
where	a.nr_sequencia = nr_seq_pedido_cancel_p;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ptu_imp_pck.ptu_processa_00311_v70 ( nr_seq_pedido_cancel_p ptu_cancelamento.nr_sequencia%type, ie_possui_pedido_p text, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nr_seq_confirmacao_p INOUT ptu_confirmacao.nr_sequencia%type) FROM PUBLIC;
