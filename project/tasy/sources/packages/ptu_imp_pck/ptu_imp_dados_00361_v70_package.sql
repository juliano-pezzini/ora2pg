-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE ptu_imp_pck.ptu_imp_dados_00361_v70 ( cd_transacao_p ptu_resp_pedido_status.cd_transacao%type, nr_seq_transacao_p ptu_pedido_compl_aut.nr_seq_guia%type, nr_seq_pedido_p ptu_resp_pedido_status.nr_sequencia%type, ie_tipo_transacao_p text, nr_seq_execucao_p ptu_resp_pedido_status.nr_seq_execucao%type, nr_seq_item_p ptu_resp_servico_status.nr_seq_item%type, ie_tipo_tabela_p ptu_resp_servico_status.ie_tipo_tabela%type, cd_servico_p ptu_resp_servico_status.cd_servico%type, ds_servico_p ptu_resp_servico_status.ds_servico%type, qt_autorizado_p ptu_resp_servico_status.qt_autorizado%type, ie_autorizado_p ptu_resp_servico_status.ie_autorizado%type, cd_mens_espec_1_p ptu_inconsistencia.cd_inconsistencia%type, cd_mens_espec_2_p ptu_inconsistencia.cd_inconsistencia%type, cd_mens_espec_3_p ptu_inconsistencia.cd_inconsistencia%type, cd_mens_espec_4_p ptu_inconsistencia.cd_inconsistencia%type, cd_mens_espec_5_p ptu_inconsistencia.cd_inconsistencia%type, ds_mens_espec_p ptu_intercambio_consist.ds_observacao%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) AS $body$
DECLARE


/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade: Importar servicos do pedido de resposta de status da transacao 00361 - Resposta do Status da Transacao

Rotina utilizada nas transacoes ptu via scs
quando for alterar, favor verificar com o analista responsavel para a realizacao de testes.
-------------------------------------------------------------------------------------------------------------------

Locais de chamada direta:
[ X ]  Objetos do dicionario [  ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatorios [ ] Outros:
 ------------------------------------------------------------------------------------------------------------------

Pontos de atencao:
Performance
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */


nr_seq_pedido_compl_w		ptu_controle_execucao.nr_seq_pedido_compl%type;
nr_seq_pedido_aut_w		ptu_controle_execucao.nr_seq_pedido_aut%type;
nr_seq_guia_mat_w		ptu_resp_servico_status.nr_seq_guia_mat%type;
nr_seq_guia_proc_w		ptu_resp_servico_status.nr_seq_guia_proc%type;
nr_seq_req_mat_w		ptu_resp_servico_status.nr_seq_req_mat%type;
nr_seq_req_proc_w		ptu_resp_servico_status.nr_seq_req_proc%type;
qt_autorizado_ww		ptu_resp_servico_status.qt_autorizado%type;
cd_estabelecimento_w		estabelecimento.cd_estabelecimento%type;
nr_versao_w			varchar(10);
ie_tipo_tabela_w		ptu_resp_servico_status.ie_tipo_tabela%type := ptu_conversao_tipo_tabela(ie_tipo_tabela_p, cd_servico_p, 'R', null);
cd_servico_w			ptu_resp_servico_status.cd_servico%type := ptu_conversao_item_tabela(ie_tipo_tabela_p, cd_servico_p, null);


BEGIN

if (coalesce(cd_estabelecimento_p,0) > 0) then
	cd_estabelecimento_w := cd_estabelecimento_p;
else
	cd_estabelecimento_w := ptu_val_scs_ws_pck.ptu_obter_estab_padrao;
end if;

begin
	select	nr_seq_pedido_compl,
		nr_seq_pedido_aut
	into STRICT	nr_seq_pedido_compl_w,
		nr_seq_pedido_aut_w
	from	ptu_controle_execucao
	where	nr_sequencia	= nr_seq_execucao_p;
exception
when others then
	nr_seq_pedido_compl_w	:= null;
	nr_seq_pedido_aut_w	:= null;
end;

if (nr_seq_pedido_aut_w IS NOT NULL AND nr_seq_pedido_aut_w::text <> '') then

	begin
		select	nr_versao
		into STRICT	nr_versao_w
		from	ptu_pedido_autorizacao
		where	nr_sequencia = nr_seq_pedido_aut_w;
	exception
	when others then
		nr_versao_w	:= '050';
	end;

	begin
		if ( nr_seq_item_p = 99) or ( nr_versao_w = '050') then
			select	nr_seq_guia_mat,
				nr_seq_guia_proc,
				nr_seq_req_mat,
				nr_seq_req_proc
			into STRICT	nr_seq_guia_mat_w,
				nr_seq_guia_proc_w,
				nr_seq_req_mat_w,
				nr_seq_req_proc_w
			from	ptu_pedido_aut_servico
			where	nr_seq_pedido					= nr_seq_pedido_aut_w
			and	ie_tipo_tabela					= ie_tipo_tabela_w
			and	coalesce(cd_servico_consersao,cd_servico)		= cd_servico_w
			and	((ds_opme IS NOT NULL AND ds_opme::text <> '') and (trim(both upper(elimina_acentuacao(ds_opme)))	= trim(both upper(ds_servico_p)))
			or (coalesce(ds_opme::text, '') = ''));
		else
			select	nr_seq_guia_mat,
				nr_seq_guia_proc,
				nr_seq_req_mat,
				nr_seq_req_proc
			into STRICT	nr_seq_guia_mat_w,
				nr_seq_guia_proc_w,
				nr_seq_req_mat_w,
				nr_seq_req_proc_w
			from	ptu_pedido_aut_servico
			where	nr_seq_pedido					= nr_seq_pedido_aut_w
			and	ie_tipo_tabela					= ie_tipo_tabela_w
			and	coalesce(cd_servico_consersao,cd_servico)		= cd_servico_w
			and	nr_seq_item					= nr_seq_item_p;
		end if;

	exception
	when others then
		nr_seq_guia_mat_w	:= null;
		nr_seq_guia_proc_w	:= null;
		nr_seq_req_mat_w	:= null;
		nr_seq_req_proc_w	:= null;
	end;
elsif (nr_seq_pedido_compl_w IS NOT NULL AND nr_seq_pedido_compl_w::text <> '') then

	begin
		select	nr_versao
		into STRICT	nr_versao_w
		from	ptu_pedido_compl_aut
		where	nr_sequencia = nr_seq_pedido_compl_w;
	exception
	when others then
		nr_versao_w	:= '050';
	end;

	begin
		if ( nr_seq_item_p = 99) or ( nr_versao_w = '050') then
			select	nr_seq_guia_mat,
				nr_seq_guia_proc,
				nr_seq_req_mat,
				nr_seq_req_proc
			into STRICT	nr_seq_guia_mat_w,
				nr_seq_guia_proc_w,
				nr_seq_req_mat_w,
				nr_seq_req_proc_w
			from	ptu_pedido_compl_aut_serv
			where	nr_seq_pedido					= nr_seq_pedido_compl_w
			and	ie_tipo_tabela					= ie_tipo_tabela_w
			and	coalesce(cd_servico_conversao,cd_servico)		= cd_servico_w
			and	((ds_opme IS NOT NULL AND ds_opme::text <> '') and (trim(both upper(elimina_acentuacao(ds_opme)))	= trim(both upper(ds_servico_p)))
			or (coalesce(ds_opme::text, '') = ''));
		else
			select	nr_seq_guia_mat,
				nr_seq_guia_proc,
				nr_seq_req_mat,
				nr_seq_req_proc
			into STRICT	nr_seq_guia_mat_w,
				nr_seq_guia_proc_w,
				nr_seq_req_mat_w,
				nr_seq_req_proc_w
			from	ptu_pedido_compl_aut_serv
			where	nr_seq_pedido					= nr_seq_pedido_compl_w
			and	ie_tipo_tabela					= ie_tipo_tabela_w
			and	coalesce(cd_servico_conversao,cd_servico)		= cd_servico_w
			and	nr_seq_item					= nr_seq_item_p;
		end if;

	exception
	when others then
		nr_seq_guia_mat_w	:= null;
		nr_seq_guia_proc_w	:= null;
		nr_seq_req_mat_w	:= null;
		nr_seq_req_proc_w	:= null;
	end;
end if;

begin
	qt_autorizado_ww	:= (ptu_obter_qtd_env_itens_scs(null, qt_autorizado_p, 'R'))::numeric;
exception
when others then
	qt_autorizado_ww	:= (replace(ptu_obter_qtd_env_itens_scs(null, qt_autorizado_p, 'R'),',','.'))::numeric;
end;

insert	into ptu_resp_servico_status(nr_sequencia, cd_servico, ds_servico,
	dt_atualizacao, dt_atualizacao_nrec, ie_autorizado,
	ie_tipo_tabela, nm_usuario, nm_usuario_nrec,
	nr_seq_resp_ped_status, qt_autorizado,
	nr_seq_guia_mat, nr_seq_guia_proc, nr_seq_req_mat,
	nr_seq_req_proc, nr_seq_item, ie_origem_proced)
values (nextval('ptu_resp_servico_status_seq'), cd_servico_w, ds_servico_p,
	clock_timestamp(), clock_timestamp(), ie_autorizado_p,
	ie_tipo_tabela_w, nm_usuario_p, nm_usuario_p,
	nr_seq_pedido_p, qt_autorizado_ww,
	nr_seq_guia_mat_w, nr_seq_guia_proc_w, nr_seq_req_mat_w,
	nr_seq_req_proc_w, nr_seq_item_p, CASE WHEN ie_tipo_tabela_w='00' THEN 4  ELSE null END );

if (cd_mens_espec_1_p	<> 0) then
	CALL ptu_inserir_inconsistencia(	null, null, cd_mens_espec_1_p,ds_mens_espec_p,cd_estabelecimento_w, nr_seq_transacao_p, ie_tipo_transacao_p,
					cd_transacao_p, coalesce(nr_seq_guia_proc_w,nr_seq_req_proc_w), coalesce(nr_seq_guia_mat_w,nr_seq_req_mat_w), null, nm_usuario_p);
end if;

if (cd_mens_espec_2_p	<> 0) then
	CALL ptu_inserir_inconsistencia(	null, null, cd_mens_espec_2_p,ds_mens_espec_p,cd_estabelecimento_w, nr_seq_transacao_p, ie_tipo_transacao_p,
					cd_transacao_p, coalesce(nr_seq_guia_proc_w,nr_seq_req_proc_w), coalesce(nr_seq_guia_mat_w,nr_seq_req_mat_w), null, nm_usuario_p);
end if;

if (cd_mens_espec_3_p	<> 0) then
	CALL ptu_inserir_inconsistencia(	null, null, cd_mens_espec_3_p,ds_mens_espec_p,cd_estabelecimento_w, nr_seq_transacao_p, ie_tipo_transacao_p,
					cd_transacao_p, coalesce(nr_seq_guia_proc_w,nr_seq_req_proc_w), coalesce(nr_seq_guia_mat_w,nr_seq_req_mat_w), null, nm_usuario_p);
end if;

if (cd_mens_espec_4_p	<> 0) then
	CALL ptu_inserir_inconsistencia(	null, null, cd_mens_espec_4_p,ds_mens_espec_p,cd_estabelecimento_w, nr_seq_transacao_p, ie_tipo_transacao_p,
					cd_transacao_p, coalesce(nr_seq_guia_proc_w,nr_seq_req_proc_w), coalesce(nr_seq_guia_mat_w,nr_seq_req_mat_w), null, nm_usuario_p);
end if;

if (cd_mens_espec_5_p	<> 0) then
	CALL ptu_inserir_inconsistencia(	null, null, cd_mens_espec_5_p,ds_mens_espec_p,cd_estabelecimento_w, nr_seq_transacao_p, ie_tipo_transacao_p,
					cd_transacao_p, coalesce(nr_seq_guia_proc_w,nr_seq_req_proc_w), coalesce(nr_seq_guia_mat_w,nr_seq_req_mat_w), null, nm_usuario_p);
end if;

commit;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ptu_imp_pck.ptu_imp_dados_00361_v70 ( cd_transacao_p ptu_resp_pedido_status.cd_transacao%type, nr_seq_transacao_p ptu_pedido_compl_aut.nr_seq_guia%type, nr_seq_pedido_p ptu_resp_pedido_status.nr_sequencia%type, ie_tipo_transacao_p text, nr_seq_execucao_p ptu_resp_pedido_status.nr_seq_execucao%type, nr_seq_item_p ptu_resp_servico_status.nr_seq_item%type, ie_tipo_tabela_p ptu_resp_servico_status.ie_tipo_tabela%type, cd_servico_p ptu_resp_servico_status.cd_servico%type, ds_servico_p ptu_resp_servico_status.ds_servico%type, qt_autorizado_p ptu_resp_servico_status.qt_autorizado%type, ie_autorizado_p ptu_resp_servico_status.ie_autorizado%type, cd_mens_espec_1_p ptu_inconsistencia.cd_inconsistencia%type, cd_mens_espec_2_p ptu_inconsistencia.cd_inconsistencia%type, cd_mens_espec_3_p ptu_inconsistencia.cd_inconsistencia%type, cd_mens_espec_4_p ptu_inconsistencia.cd_inconsistencia%type, cd_mens_espec_5_p ptu_inconsistencia.cd_inconsistencia%type, ds_mens_espec_p ptu_intercambio_consist.ds_observacao%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) FROM PUBLIC;
