-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

--=========================================== Procedures ===========================================
CREATE OR REPLACE PROCEDURE pfcs_pck_discharge_manager.calc_total_discharges_today ( cd_establishment_p bigint, nm_user_p text) AS $body$
DECLARE

        pfcs_panel_seq_w        pfcs_panel.nr_sequencia%type;
        ds_timezone_w           establishment_locale.ds_timezone%type;
        dt_current_day_tz_w     timestamp;
        qt_discharged_today_w   integer;

BEGIN
        ds_timezone_w := get_establishment_timezone(cd_establishment_p);
        dt_current_day_tz_w := trunc(timezone_utils.getDate(clock_timestamp(),ds_timezone_w));

		for c01_w in pfcs_pck_cursors.cur_units(cd_establishment_p) loop
			select count(enc.nr_sequencia)
			into STRICT qt_discharged_today_w
			from pfcs_encounter enc,
				pfcs_patient pat,
				unidade_atendimento uni,
				setor_atendimento sec,
				pfcs_service_request svc
			where sec.cd_setor_atendimento = c01_w.cd_unit
				and sec.ie_ocup_hospitalar <> PFCS_PCK_CONSTANTS.IE_NO
				and uni.cd_setor_atendimento = sec.cd_setor_atendimento
				and uni.nr_seq_location = svc.nr_seq_location
				and enc.nr_seq_patient = pat.nr_sequencia
				and (enc.period_start IS NOT NULL AND enc.period_start::text <> '')
				and (enc.period_end IS NOT NULL AND enc.period_end::text <> '')
				and svc.nr_seq_encounter = enc.nr_sequencia
				and svc.nr_seq_patient = pat.nr_sequencia
				and svc.cd_service = PFCS_PCK_CONSTANTS.CD_DISCHARGE
				and svc.si_status = PFCS_PCK_CONSTANTS.SI_STATUS_COMPLETED
				and svc.si_intent = PFCS_PCK_CONSTANTS.SI_INTENT_ORDER
				and timezone_utils.getDate(svc.dt_authored_on,ds_timezone_w) >= dt_current_day_tz_w;

			 := pfcs_pck.pfcs_generate_results(
				ds_reference_value_p => c01_w.ds_unit, cd_reference_value_p => c01_w.cd_unit, cd_reference_aux_p => c01_w.cd_unit_classification, vl_indicator_p => qt_discharged_today_w, nr_seq_indicator_p => PFCS_PCK_INDICATORS.NR_DM_TOTAL_DISCHARGES_TODAY, nr_seq_operational_level_p => cd_establishment_p, nm_usuario_p => nm_user_p, nr_seq_panel_p => pfcs_panel_seq_w);
		end loop;

		CALL pfcs_pck.pfcs_activate_records(
			nr_seq_indicator_p => PFCS_PCK_INDICATORS.NR_DM_TOTAL_DISCHARGES_TODAY,
			nr_seq_operational_level_p => cd_establishment_p,
			nm_usuario_p => nm_user_p);
    END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pfcs_pck_discharge_manager.calc_total_discharges_today ( cd_establishment_p bigint, nm_user_p text) FROM PUBLIC;
