-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pfcs_pck_discharge_manager.calc_care_status_delays ( cd_establishment_p bigint, nm_user_p text) AS $body$
DECLARE

        pfcs_panel_seq_w    pfcs_panel.nr_sequencia%type;
        qt_total_w          integer := 0;

BEGIN
        for c01_w in pfcs_pck_cursors.cur_units(cd_establishment_p) loop
            select count(enc.nr_sequencia)
            into STRICT qt_total_w
            from pfcs_encounter enc,
                pfcs_patient pat,
                unidade_atendimento uni,
                setor_atendimento sec,
                pfcs_procedure prc,
                pfcs_service_request svc
            where uni.nr_seq_location = coalesce(enc.nr_seq_location, pfcs_get_pat_location(pat.nr_sequencia, enc.nr_sequencia))
                and uni.cd_setor_atendimento = sec.cd_setor_atendimento
                and uni.ie_situacao = PFCS_PCK_CONSTANTS.IE_ACTIVE
                and sec.ie_situacao = PFCS_PCK_CONSTANTS.IE_ACTIVE
                and sec.cd_setor_atendimento = c01_w.cd_unit
                and enc.nr_seq_patient = pat.nr_sequencia
                and (enc.period_start IS NOT NULL AND enc.period_start::text <> '')
                and prc.nr_seq_encounter = enc.nr_sequencia
                and (prc.period_start IS NOT NULL AND prc.period_start::text <> '')
                and upper(prc.si_status) = PFCS_PCK_CONSTANTS.SI_STATUS_IN_PROGRESS
                and svc.nr_seq_encounter = enc.nr_sequencia
                and svc.nr_seq_patient = pat.nr_sequencia
                and pfcs_pck_utils.validate_inpatient_request(
                        svc.cd_service, svc.si_status,  svc.si_intent) = PFCS_PCK_CONSTANTS.IE_YES
                and prc.period_end < clock_timestamp();

                 := pfcs_pck.pfcs_generate_results(
                    ds_reference_value_p => c01_w.ds_unit, cd_reference_value_p => c01_w.cd_unit, cd_reference_aux_p => c01_w.cd_unit_classification, vl_indicator_p => qt_total_w, nr_seq_indicator_p => PFCS_PCK_INDICATORS.NR_DM_CARE_DELAYS_BY_UNIT, nr_seq_operational_level_p => cd_establishment_p, nm_usuario_p => nm_user_p, nr_seq_panel_p => pfcs_panel_seq_w);
        end loop;

        CALL pfcs_pck.pfcs_activate_records(
            nr_seq_indicator_p => PFCS_PCK_INDICATORS.NR_DM_CARE_DELAYS_BY_UNIT,
            nr_seq_operational_level_p => cd_establishment_p,
            nm_usuario_p => nm_user_p);
    END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pfcs_pck_discharge_manager.calc_care_status_delays ( cd_establishment_p bigint, nm_user_p text) FROM PUBLIC;
