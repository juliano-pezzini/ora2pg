-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pfcs_pck_discharge_manager.calc_disch_orders_expected_sum ( cd_establishment_p bigint, nm_user_p text) AS $body$
DECLARE

        ds_timezone_w               establishment_locale.ds_timezone%type;
        pfcs_panel_seq_w            pfcs_panel.nr_sequencia%type;
        qt_anticipated_discharges_w integer;
        qt_discharge_orders_w       integer;
        dt_predicted_discharge_w    timestamp;

BEGIN
        ds_timezone_w := get_establishment_timezone(cd_establishment_p);
        dt_predicted_discharge_w := trunc(timezone_utils.getDate(clock_timestamp(),ds_timezone_w));

        qt_anticipated_discharges_w := 0;
        qt_discharge_orders_w := 0;
        for c01_w in pfcs_pck_cursors.cur_units(cd_establishment_p) loop
            select count(pd.nr_sequencia)
            into STRICT qt_anticipated_discharges_w
            from pfcs_panel_detail pd,
                pfcs_detail_patient pat,
                pfcs_detail_bed bed
            where pd.ie_situation = PFCS_PCK_CONSTANTS.IE_ACTIVE
                and pd.nr_seq_indicator = PFCS_PCK_INDICATORS.NR_VC_CAPACITY
                and pd.nr_seq_operational_level = cd_establishment_p
                and bed.cd_department = to_char(c01_w.cd_unit)
                and trunc(timezone_utils.getDate(pat.dt_expected_discharge,ds_timezone_w)) = dt_predicted_discharge_w
                and pat.ie_discharge_order_status = PFCS_PCK_CONSTANTS.IE_NO
                and pat.nr_seq_detail = pd.nr_sequencia
                and bed.nr_seq_detail = pat.nr_seq_detail
                and (pat.dt_expected_discharge IS NOT NULL AND pat.dt_expected_discharge::text <> '');

            select count(pd.nr_sequencia)
            into STRICT qt_discharge_orders_w
            from pfcs_panel_detail pd,
                pfcs_detail_patient pat,
                pfcs_detail_bed bed
            where pd.ie_situation = PFCS_PCK_CONSTANTS.IE_ACTIVE
                and pd.nr_seq_indicator = PFCS_PCK_INDICATORS.NR_VC_CAPACITY
                and pd.nr_seq_operational_level = cd_establishment_p
                and bed.cd_department = to_char(c01_w.cd_unit)
                and pat.ie_discharge_order_status = PFCS_PCK_CONSTANTS.IE_YES
                and pat.nr_seq_detail = pd.nr_sequencia
                and bed.nr_seq_detail = pat.nr_seq_detail;

             := pfcs_pck.pfcs_generate_results(
                ds_reference_value_p => c01_w.ds_unit, cd_reference_value_p => c01_w.cd_unit, cd_reference_aux_p => c01_w.cd_unit_classification, vl_indicator_p => qt_anticipated_discharges_w + qt_discharge_orders_w, ie_flag_p => c01_w.ie_hospital_occupancy, nr_seq_indicator_p => PFCS_PCK_INDICATORS.NR_VC_TOTAL_DISCHARGES, nr_seq_operational_level_p => cd_establishment_p, nm_usuario_p => nm_user_p, nr_seq_panel_p => pfcs_panel_seq_w);
        end loop;

        CALL pfcs_pck.pfcs_activate_records(
            nr_seq_indicator_p => PFCS_PCK_INDICATORS.NR_VC_TOTAL_DISCHARGES,
            nr_seq_operational_level_p => cd_establishment_p,
            nm_usuario_p => nm_user_p);
    END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pfcs_pck_discharge_manager.calc_disch_orders_expected_sum ( cd_establishment_p bigint, nm_user_p text) FROM PUBLIC;
