-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pfcs_pck_discharge_manager.calc_delays_tablechart ( cd_establishment_p bigint, nm_user_p text) AS $body$
DECLARE

        cur_units_classifications CURSOR FOR
        SELECT distinct uni.cd_reference_aux cd_unit_classification
        from pfcs_panel uni
        where uni.nr_seq_indicator = PFCS_PCK_INDICATORS.NR_VC_DISCHARGE_DELAYS
            and uni.nr_seq_operational_level = cd_establishment_p;

        cur_delays CURSOR(cd_unit_classification_p  text) FOR
        SELECT dis.ds_reference_value ds_unit,
            dis.cd_reference_value cd_unit,
            dis.vl_indicator qt_discharge_delays,
            car.vl_indicator qt_care_status_delays
        from pfcs_panel dis inner join pfcs_panel car ON (
            dis.nr_seq_operational_level = car.nr_seq_operational_level
            and dis.cd_reference_value = car.cd_reference_value
            and dis.cd_reference_aux = car.cd_reference_aux
        ) where dis.nr_seq_indicator = PFCS_PCK_INDICATORS.NR_VC_DISCHARGE_DELAYS
            and car.nr_seq_indicator = PFCS_PCK_INDICATORS.NR_DM_CARE_DELAYS_BY_UNIT
            and dis.cd_reference_aux = cd_unit_classification_p
            and dis.nr_seq_operational_level = cd_establishment_p
        order by qt_discharge_delays desc, qt_care_status_delays desc;

        pfcs_panel_seq_w                pfcs_panel.nr_sequencia%type;
        nr_rank_control_w               integer;
        qt_total_discharge_delays_w     integer;
        qt_total_care_status_delays_w   integer;

BEGIN
        for c01_w in cur_units_classifications loop
            nr_rank_control_w := 0;
            qt_total_discharge_delays_w := 0;
            qt_total_care_status_delays_w := 0;

            for c02_w in cur_delays(c01_w.cd_unit_classification) loop
                qt_total_discharge_delays_w := qt_total_discharge_delays_w + c02_w.qt_discharge_delays;
                qt_total_care_status_delays_w := qt_total_care_status_delays_w + c02_w.qt_care_status_delays;
                if (nr_rank_control_w < 3) then
                     := pfcs_pck.pfcs_generate_results(
                        vl_indicator_p => c02_w.qt_discharge_delays, vl_indicator_help_p => c02_w.qt_care_status_delays, vl_indicator_assist_p => PFCS_PCK_CONSTANTS.IE_TRUE, cd_reference_aux_p => c01_w.cd_unit_classification, cd_reference_value_p => c02_w.cd_unit, ds_reference_value_p => c02_w.ds_unit, nr_seq_indicator_p => PFCS_PCK_INDICATORS.NR_DM_DELAYS, nr_seq_operational_level_p => cd_establishment_p, nm_usuario_p => nm_user_p, nr_seq_panel_p => pfcs_panel_seq_w);
                end if;
                nr_rank_control_w := nr_rank_control_w + 1;
            end loop;

             := pfcs_pck.pfcs_generate_results(
                    vl_indicator_p => qt_total_discharge_delays_w, vl_indicator_help_p => qt_total_care_status_delays_w, vl_indicator_assist_p => PFCS_PCK_CONSTANTS.IE_FALSE, cd_reference_aux_p => c01_w.cd_unit_classification, nr_seq_indicator_p => PFCS_PCK_INDICATORS.NR_DM_DELAYS, nr_seq_operational_level_p => cd_establishment_p, nm_usuario_p => nm_user_p, nr_seq_panel_p => pfcs_panel_seq_w);
        end loop;
        CALL pfcs_pck.pfcs_activate_records(
            nr_seq_indicator_p => PFCS_PCK_INDICATORS.NR_DM_DELAYS,
            nr_seq_operational_level_p => cd_establishment_p,
            nm_usuario_p => nm_user_p);
    END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pfcs_pck_discharge_manager.calc_delays_tablechart ( cd_establishment_p bigint, nm_user_p text) FROM PUBLIC;
