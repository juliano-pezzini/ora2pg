-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



    --=========================================== Functions ===========================================
CREATE OR REPLACE FUNCTION pfcs_pck_discharge_manager.get_discharges_by_noon (cd_establishment_p bigint) RETURNS bigint AS $body$
DECLARE

        ds_timezone_w               establishment_locale.ds_timezone%type;
        qt_discharges_by_noon_w     integer;
        dt_start_time_w             timestamp;
        dt_end_time_w               timestamp;
        dt_start_today_w            timestamp;

BEGIN
        ds_timezone_w := GET_ESTABLISHMENT_TIMEZONE(cd_establishment_p);
        dt_start_today_w := trunc(TIMEZONE_UTILS.getCurrentDate(ds_timezone_w));

        select  dt_start_today_w +(coalesce((max(ds_start_noon))::numeric , 6)/24) dt_start_time,
                dt_start_today_w +(coalesce((max(ds_end_noon))::numeric , 12)/24) dt_end_time
        into STRICT    dt_start_time_w,
                dt_end_time_w
        from    pfcs_general_rule;

        select count(enc.nr_sequencia)
        into STRICT qt_discharges_by_noon_w
        from pfcs_encounter enc,
            pfcs_patient pat,
            unidade_atendimento uni,
            setor_atendimento sec,
            pfcs_service_request svc
        where sec.cd_estabelecimento = cd_establishment_p
            and sec.ie_ocup_hospitalar <> PFCS_PCK_CONSTANTS.IE_NO
            and uni.cd_setor_atendimento = sec.cd_setor_atendimento
            and uni.nr_seq_location = svc.nr_seq_location
            and enc.nr_seq_patient = pat.nr_sequencia
            and (enc.period_start IS NOT NULL AND enc.period_start::text <> '')
            and (enc.period_end IS NOT NULL AND enc.period_end::text <> '')
            and svc.nr_seq_encounter = enc.nr_sequencia
            and svc.nr_seq_patient = pat.nr_sequencia
            and svc.cd_service = PFCS_PCK_CONSTANTS.CD_DISCHARGE
            and svc.si_status = PFCS_PCK_CONSTANTS.SI_STATUS_COMPLETED
            and svc.si_intent = PFCS_PCK_CONSTANTS.SI_INTENT_ORDER
            and (timezone_utils.getDate(svc.dt_authored_on, ds_timezone_w) between dt_start_time_w and dt_end_time_w);
        return qt_discharges_by_noon_w;
    END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pfcs_pck_discharge_manager.get_discharges_by_noon (cd_establishment_p bigint) FROM PUBLIC;
