-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pls_util_cta_pck.obter_select ( ie_opcao_p text, var_cur_w integer, ie_somente_dependentes_p text, ie_somente_dependente_legal_p text, nr_seq_titular_p pls_segurado_conta_v.nr_seq_titular%type) RETURNS varchar AS $body$
DECLARE


current_setting('pls_util_cta_pck.ds_sql_w')::varchar(4000)	varchar(4000);
ds_tabelas_w	varchar(4000);
ds_restricao_w	varchar(4000);


BEGIN

if (ie_somente_dependentes_p = 'N') then

	if (ie_opcao_p = 'RESTRICAO') then

		
		if (ie_somente_dependente_legal_p = 'S') then

			-- So acessar a tabela grau_parentesco se for informado para buscar os parentes legais.

			ds_tabelas_w :=		ds_tabelas_w || ',' || pls_util_pck.enter_w ||
						'	grau_parentesco	parent';

			-- restringir pelo tipo de parentesco '1'

			ds_restricao_w :=	ds_restricao_w || pls_util_pck.enter_w ||
						'and	parent.nr_sequencia = depend.nr_seq_parentesco ' || pls_util_pck.enter_w ||
						'and	parent.ie_tipo_parentesco = ''1'' ';
		end if;

		-- Este select busca o titular e os dependentes conforme especificado por parametro.

		PERFORM set_config('pls_util_cta_pck.ds_sql_w', 'select	titular.nr_sequencia ' || pls_util_pck.enter_w ||
				'from	pls_segurado titular ' || pls_util_pck.enter_w ||
				'where	titular.nr_sequencia = :nr_seq_titular ' || pls_util_pck.enter_w ||
				'union all ' || pls_util_pck.enter_w ||
				'select	depend.nr_sequencia ' || pls_util_pck.enter_w ||
				'from	pls_segurado depend ' ||
				ds_tabelas_w || pls_util_pck.enter_w ||
				'where	depend.nr_seq_titular = :nr_seq_titular ' ||
				ds_restricao_w, false);

	else
		dbms_sql.bind_variable(var_cur_w, ':nr_seq_titular', nr_seq_titular_p);
	end if;

-- Desta forma retorna apenas os dependentes.

elsif (ie_somente_dependentes_p = 'S') then

	if (ie_opcao_p = 'RESTRICAO') then


		if (ie_somente_dependente_legal_p = 'S') then

			-- So acessar a tabela grau_parentesco se for informado para buscar os parentes legais.

			ds_tabelas_w :=		ds_tabelas_w || ',' || pls_util_pck.enter_w ||
						'	grau_parentesco	parent';

			-- restringir pelo tipo de parentesco '1'

			ds_restricao_w :=	ds_restricao_w || pls_util_pck.enter_w ||
						'and	parent.nr_sequencia = depend.nr_seq_parentesco ' || pls_util_pck.enter_w ||
						'and	parent.ie_tipo_parentesco = ''1'' ';
		end if;

		-- Este select buscara todos os dependentes do beneficiario.

		PERFORM set_config('pls_util_cta_pck.ds_sql_w', 'select	depend.nr_sequencia ' || pls_util_pck.enter_w ||
				'from	pls_segurado depend ' ||
				ds_tabelas_w || pls_util_pck.enter_w ||
				'where	depend.nr_seq_titular = :nr_seq_titular ' ||
				ds_restricao_w, false);
	else
		dbms_sql.bind_variable(var_cur_w, ':nr_seq_titular', nr_seq_titular_p);
	end if;
end if;

return current_setting('pls_util_cta_pck.ds_sql_w')::varchar(4000);

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_util_cta_pck.obter_select ( ie_opcao_p text, var_cur_w integer, ie_somente_dependentes_p text, ie_somente_dependente_legal_p text, nr_seq_titular_p pls_segurado_conta_v.nr_seq_titular%type) FROM PUBLIC;
