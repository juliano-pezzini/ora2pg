-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


-- Obter as datas de inicio e fim do periodo valido para utilizar em restricoes Between. Sera retornada a data mais proxima



CREATE OR REPLACE FUNCTION pls_util_cta_pck.obter_periodo_execucao ( dt_referencia_p timestamp, dt_inicio_p timestamp, ie_incidencia_p text, qt_reincidencia_p integer default 1) RETURNS SETOF PLS_UTIL_CTA_PCK.T_DATAS_PERIODO_DATA AS $body$
DECLARE


/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade:  Obter as datas de inicio e fim de um periodo, de acordo com os paramteros especificados.
	Funcionara da seguinte forma.:

	Para obter as datas do periodo devem ser verificadas as informacoes de
		1 - data inicial :	Indicar a data a partir da qual devem ser verificados os periodos.
				A partir desta data serao obtidos os periodos subsequentes validos conforme
				especificacao dos outros parametros.
		2 - reinscidencia : 	Indicar o periodo de reincidencia:
					D - Diario
					S - Semanal
					M - Mensal.
		3 - Qt reincidencia	Indicar a frequencia de reincidencia. Usado em conjunto com a reincidencia:
					3 Semanas, 2 Dia, 10 Meses.
		4 - Data de referencia:	e a data final. Sera retornada entao como data final do periodo

	Sempre sera retornado no maximo uma linha e nenhuma caso algo de errado. Esta linha ira conter o ultimo periodo valido
	conforme a regra definida nos parametros.

++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */


dados_retorno_w		t_datas_periodo_row;

C01 CURSOR(	dt_inicio_p		timestamp,
		dt_fim_p		timestamp,
		qt_reincidencia_p	integer) FOR
	SELECT	max(a.dt_retorno) dt_retorno
	from	table(pls_manipulacao_datas_pck.obter_intervalo_datas(dt_inicio_p, dt_fim_p, 'D', 'S', qt_reincidencia_p)) a
	where	a.dt_retorno <= dt_fim_p;

C02 CURSOR(	dt_inicio_p		timestamp,
		dt_fim_p		timestamp,
		qt_reincidencia_p	integer) FOR
	SELECT	max(a.dt_retorno) dt_retorno
	from	table(pls_manipulacao_datas_pck.obter_intervalo_datas(dt_inicio_p, dt_fim_p, 'S', 'S', qt_reincidencia_p)) a
	where	a.dt_retorno <= dt_fim_p;

C03 CURSOR(	dt_inicio_p		timestamp,
		dt_fim_p		timestamp,
		qt_reincidencia_p	integer) FOR
	SELECT	max(a.dt_retorno) dt_retorno
	from	table(pls_manipulacao_datas_pck.obter_intervalo_datas(dt_inicio_p, dt_fim_p, 'M', 'S', qt_reincidencia_p)) a
	where	a.dt_retorno <= dt_fim_p;

BEGIN

-- Se nao tiver informacoes das datas nem retorna nada.

if (dt_inicio_p IS NOT NULL AND dt_inicio_p::text <> '') and (dt_referencia_p IS NOT NULL AND dt_referencia_p::text <> '') then

	-- Verificar a incidencia da regra. Se for para ser por Dia, Semana ou Mes.

	if (ie_incidencia_p = 'D') then

		-- Obter a data inicial do periodo que deve ser verificado para esta

		for	r_C01_w in C01( dt_inicio_p, dt_referencia_p, qt_reincidencia_p) loop

			-- Gravar a data inicial e a data final para o retorno.

			dados_retorno_w.dt_inicio	:= r_C01_w.dt_retorno;
			dados_retorno_w.dt_fim		:= dt_referencia_p;

			RETURN NEXT dados_retorno_w;
		end loop; -- C01
	elsif (ie_incidencia_p = 'S') then

		-- Obter a data inicial do periodo que deve ser verificado para esta

		for	r_C02_w in C02( dt_inicio_p, dt_referencia_p, qt_reincidencia_p) loop

			-- Gravar a data inicial e a data final para o retorno.

			dados_retorno_w.dt_inicio	:= r_C02_w.dt_retorno;
			dados_retorno_w.dt_fim		:= dt_referencia_p;

			RETURN NEXT dados_retorno_w;
		end loop; -- C02
	elsif (ie_incidencia_p = 'M') then

		-- Obter a data inicial do periodo que deve ser verificado para esta

		for	r_C03_w in C03( dt_inicio_p, dt_referencia_p, qt_reincidencia_p) loop

			-- Gravar a data inicial e a data final para o retorno.

			dados_retorno_w.dt_inicio	:= r_C03_w.dt_retorno;
			dados_retorno_w.dt_fim		:= dt_referencia_p;

			RETURN NEXT dados_retorno_w;
		end loop; -- C03
	end if;
end if;
-- Retorna as datas que foram adicionadas ao retorno.

return;
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pls_util_cta_pck.obter_periodo_execucao ( dt_referencia_p timestamp, dt_inicio_p timestamp, ie_incidencia_p text, qt_reincidencia_p integer default 1) FROM PUBLIC;
