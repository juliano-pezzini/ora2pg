-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_sib_dados_benef_pck.carregar_dados_proposta ( nr_seq_benef_proposta_p pls_proposta_beneficiario.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) AS $body$
BEGIN
CALL CALL CALL CALL CALL pls_sib_dados_benef_pck.carregar_parametros(cd_estabelecimento_p);

PERFORM set_config('pls_sib_dados_benef_pck.cd_cco', null, false);
PERFORM set_config('pls_sib_dados_benef_pck.cd_beneficiario', null, false);
PERFORM set_config('pls_sib_dados_benef_pck.nr_plano_portabilidade', null, false);
PERFORM set_config('pls_sib_dados_benef_pck.ie_cpt', null, false);
PERFORM set_config('pls_sib_dados_benef_pck.cd_motivo_cancelamento', null, false);
PERFORM set_config('pls_sib_dados_benef_pck.nr_seq_segurado', null, false);
PERFORM set_config('pls_sib_dados_benef_pck.dt_rescisao', null, false);
PERFORM set_config('pls_sib_dados_benef_pck.dt_reativacao', null, false);
PERFORM set_config('pls_sib_dados_benef_pck.nr_seq_motivo_cancel', null, false);

select	b.dt_nascimento,
	coalesce(c.nm_pessoa_fisica,b.nm_pessoa_fisica),
	CASE WHEN b.ie_sexo='M' THEN '1' WHEN b.ie_sexo='F' THEN '3' END ,
	b.nr_cpf,
	lpad(b.nr_pis_pasep,11,'0'),
	obter_nome_mae_pf(b.cd_pessoa_fisica) current_setting('pls_sib_dados_benef_pck.nm_mae')::varchar(255),
	lpad(b.cd_declaracao_nasc_vivo,11,0),
	coalesce(pls_obter_dados_segurado(a.nr_seq_titular_contrato, 'C'), 'X'),
	substr(b.nr_cartao_nac_sus,1,15),
	CASE WHEN d.ie_regulamentacao='P' THEN d.nr_protocolo_ans  ELSE null END ,
	CASE WHEN d.ie_regulamentacao='P' THEN null  ELSE CASE WHEN current_setting('pls_sib_dados_benef_pck.ie_scpa_contrato_w')::pls_parametros.ie_scpa_contrato%type='S' THEN coalesce(g.cd_scpa,d.cd_scpa)  ELSE d.cd_scpa END  END ,
	CASE WHEN coalesce(coalesce(a.nr_seq_titular, a.nr_seq_titular_contrato)::text, '') = '' THEN  1  ELSE f.cd_sib END ,
	b.cd_pessoa_fisica,
	e.nr_seq_contrato,
	g.cd_caepf,
	a.nr_seq_parentesco,
	coalesce(a.dt_contratacao, e.dt_inicio_proposta),
	g.cd_scpa,
	CASE WHEN d.ie_regulamentacao='R' THEN 1  ELSE 0 END ,
	CASE WHEN coalesce(g.cd_caepf::text, '') = '' THEN CASE WHEN coalesce(h.nr_matricula_cei::text, '') = '' THEN g.cd_cgc_estipulante  ELSE null END   ELSE null END ,
	CASE WHEN coalesce(g.cd_caepf::text, '') = '' THEN h.nr_matricula_cei  ELSE null END ,
	d.nr_sequencia,
	d.ie_tipo_operacao
into STRICT	current_setting('pls_sib_dados_benef_pck.dt_nascimento')::timestamp,
	current_setting('pls_sib_dados_benef_pck.nm_beneficiario')::varchar(255),
	current_setting('pls_sib_dados_benef_pck.ie_sexo')::varchar(1),
	current_setting('pls_sib_dados_benef_pck.nr_cpf')::varchar(15),
	current_setting('pls_sib_dados_benef_pck.cd_pis_pasep')::varchar(11),
	current_setting('pls_sib_dados_benef_pck.nm_mae')::varchar(255),
	current_setting('pls_sib_dados_benef_pck.cd_declaracao_nasc_vivo')::varchar(11),
	current_setting('pls_sib_dados_benef_pck.cd_beneficiario_titular')::varchar(30),
	current_setting('pls_sib_dados_benef_pck.nr_cartao_nac_sus')::varchar(20),
	current_setting('pls_sib_dados_benef_pck.nr_plano_ans')::varchar(20),
	current_setting('pls_sib_dados_benef_pck.nr_plano_operadora')::varchar(20),
	current_setting('pls_sib_dados_benef_pck.cd_relacao_dependencia')::smallint,
	current_setting('pls_sib_dados_benef_pck.cd_pessoa_fisica_w')::pessoa_fisica.cd_pessoa_fisica%type,
	current_setting('pls_sib_dados_benef_pck.nr_seq_contrato_w')::pls_contrato.nr_sequencia%type,
	current_setting('pls_sib_dados_benef_pck.cd_caepf')::pls_contrato.cd_caepf%type,
	current_setting('pls_sib_dados_benef_pck.nr_seq_parentesco')::bigint,
	current_setting('pls_sib_dados_benef_pck.dt_contratacao')::timestamp,
	current_setting('pls_sib_dados_benef_pck.cd_scpa_contrato')::varchar(30),
	current_setting('pls_sib_dados_benef_pck.ie_itens_excluidos_cobertura')::smallint,
	current_setting('pls_sib_dados_benef_pck.nr_cnpj')::varchar(14),
	current_setting('pls_sib_dados_benef_pck.nr_cei')::varchar(50),
	current_setting('pls_sib_dados_benef_pck.nr_seq_plano')::bigint,
	current_setting('pls_sib_dados_benef_pck.ie_tipo_operacao')::pls_plano.ie_tipo_operacao%type
FROM pls_plano d, pls_proposta_beneficiario a
LEFT OUTER JOIN grau_parentesco f ON (a.nr_seq_parentesco = f.nr_sequencia)
, pessoa_fisica b
LEFT OUTER JOIN pls_pessoa_fisica c ON (b.cd_pessoa_fisica = c.cd_pessoa_fisica)
, pls_proposta_adesao e
LEFT OUTER JOIN pls_contrato g ON (e.nr_seq_contrato = g.nr_sequencia)
LEFT OUTER JOIN pessoa_juridica h ON (g.cd_cgc_estipulante = h.cd_cgc)
WHERE b.cd_pessoa_fisica = a.cd_beneficiario  and e.nr_sequencia = a.nr_seq_proposta and d.nr_sequencia = a.nr_seq_plano    and a.nr_sequencia = nr_seq_benef_proposta_p;

PERFORM set_config('pls_sib_dados_benef_pck.nm_beneficiario', pls_sib_dados_benef_pck.ajustar_caracteres(current_setting('pls_sib_dados_benef_pck.nm_beneficiario')::varchar(255), 'S'), false);
PERFORM set_config('pls_sib_dados_benef_pck.nm_mae', pls_sib_dados_benef_pck.ajustar_caracteres(current_setting('pls_sib_dados_benef_pck.nm_mae')::varchar(255), 'S'), false);

begin
	SELECT * FROM pls_sib_dados_benef_pck.obter_enderecos_benef(	current_setting('pls_sib_dados_benef_pck.cd_pessoa_fisica_w')::pessoa_fisica.cd_pessoa_fisica%type, current_setting('pls_sib_dados_benef_pck.nr_seq_contrato_w')::pls_contrato.nr_sequencia%type, null, current_setting('pls_sib_dados_benef_pck.ie_logradouro_sib_w')::pls_parametros.ie_logradouro_sib%type, current_setting('pls_sib_dados_benef_pck.ie_tipo_endereco')::varchar(2), current_setting('pls_sib_dados_benef_pck.ds_logradouro')::varchar(255), current_setting('pls_sib_dados_benef_pck.nr_logradouro')::varchar(5), current_setting('pls_sib_dados_benef_pck.ds_complemento')::varchar(60), current_setting('pls_sib_dados_benef_pck.ds_bairro')::varchar(60), current_setting('pls_sib_dados_benef_pck.cd_municipio_ibge')::varchar(7), current_setting('pls_sib_dados_benef_pck.cd_municipio_ibge_resid')::varchar(6), current_setting('pls_sib_dados_benef_pck.cd_cep')::varchar(8), current_setting('pls_sib_dados_benef_pck.ie_reside_exterior')::smallint) INTO STRICT current_setting('pls_sib_dados_benef_pck.ie_tipo_endereco')::varchar(2), current_setting('pls_sib_dados_benef_pck.ds_logradouro')::varchar(255), current_setting('pls_sib_dados_benef_pck.nr_logradouro')::varchar(5), current_setting('pls_sib_dados_benef_pck.ds_complemento')::varchar(60), current_setting('pls_sib_dados_benef_pck.ds_bairro')::varchar(60), current_setting('pls_sib_dados_benef_pck.cd_municipio_ibge')::varchar(7), current_setting('pls_sib_dados_benef_pck.cd_municipio_ibge_resid')::varchar(6), current_setting('pls_sib_dados_benef_pck.cd_cep')::varchar(8), current_setting('pls_sib_dados_benef_pck.ie_reside_exterior')::smallint;
exception
when others then
	PERFORM set_config('pls_sib_dados_benef_pck.ie_tipo_endereco', null, false);
	PERFORM set_config('pls_sib_dados_benef_pck.ds_logradouro', null, false);
	PERFORM set_config('pls_sib_dados_benef_pck.nr_logradouro', null, false);
	PERFORM set_config('pls_sib_dados_benef_pck.ds_complemento', null, false);
	PERFORM set_config('pls_sib_dados_benef_pck.ds_bairro', null, false);
	PERFORM set_config('pls_sib_dados_benef_pck.cd_municipio_ibge', null, false);
	PERFORM set_config('pls_sib_dados_benef_pck.cd_municipio_ibge_resid', null, false);
	PERFORM set_config('pls_sib_dados_benef_pck.cd_cep', null, false);
	PERFORM set_config('pls_sib_dados_benef_pck.ie_reside_exterior', null, false);
end;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_sib_dados_benef_pck.carregar_dados_proposta ( nr_seq_benef_proposta_p pls_proposta_beneficiario.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) FROM PUBLIC;
