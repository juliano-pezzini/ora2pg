-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE execucao_prescricao_pck.ajustar_quantidade_proced ( nr_atendimento_p INOUT bigint, nr_prescricao_p INOUT bigint, nr_sequencia_prescricao_p INOUT bigint, cd_procedimento_p INOUT bigint, ie_origem_proced_p INOUT bigint, ie_acao_executada_p INOUT bigint, ie_auditoria_p INOUT text, dt_procedimento_p INOUT timestamp, dt_entrada_unidade_p INOUT timestamp, dt_prescricao_p timestamp default null, nr_seq_atepacu_p INOUT bigint DEFAULT NULL, tx_procedimento_p INOUT bigint DEFAULT NULL, qt_procedimento_p INOUT bigint DEFAULT NULL, nr_seq_proc_princ_p INOUT bigint DEFAULT NULL, cd_procedimento_princ_p INOUT bigint DEFAULT NULL, nr_sequencia_p INOUT bigint DEFAULT NULL, cd_medico_executor_p INOUT text DEFAULT NULL, cd_medico_p INOUT text DEFAULT NULL, ie_funcao_medico_p INOUT text DEFAULT NULL, cd_especialidade_p INOUT text DEFAULT NULL, nr_interno_conta_p INOUT bigint DEFAULT NULL, cd_atividade_prof_bpa_p INOUT text DEFAULT NULL, ie_tipo_atend_bpa_p INOUT text DEFAULT NULL, ie_grupo_atend_bpa_p INOUT text DEFAULT NULL, cd_pessoa_fisica_p INOUT text DEFAULT NULL, nr_seq_exame_p INOUT bigint DEFAULT NULL, nr_seq_proc_interno_p INOUT bigint DEFAULT NULL, cd_setor_atendimento_p INOUT bigint DEFAULT NULL, nr_seq_grupo_rec_p INOUT bigint DEFAULT NULL, nr_seq_cor_exec_p INOUT bigint DEFAULT NULL, cd_convenio_p INOUT bigint DEFAULT NULL, cd_categoria_p INOUT text DEFAULT NULL, ie_valor_informado_p INOUT text DEFAULT NULL, cd_motivo_exc_conta_p INOUT bigint DEFAULT NULL, ds_compl_motivo_excon_p INOUT text DEFAULT NULL, nr_minuto_duracao_p INOUT bigint DEFAULT NULL, nr_doc_convenio_p INOUT text DEFAULT NULL, ie_tipo_atendimento_p INOUT bigint DEFAULT NULL, nr_seq_classificacao_p INOUT bigint DEFAULT NULL, ie_via_acesso_p INOUT text DEFAULT NULL, cd_plano_convenio_p INOUT text DEFAULT NULL, dt_entrada_p INOUT timestamp DEFAULT NULL, dt_alta_p INOUT timestamp DEFAULT NULL, dt_conta_p INOUT timestamp DEFAULT NULL, ie_forma_apresentacao_p INOUT bigint DEFAULT NULL, dt_inicio_procedimento_p INOUT timestamp DEFAULT NULL, cd_unidade_medida_p INOUT text DEFAULT NULL, ds_proc_convenio_p INOUT text DEFAULT NULL, ds_proc_interno_conv_p INOUT text DEFAULT NULL, cd_cgc_prestador_p INOUT text DEFAULT NULL, cd_kit_material_p INOUT bigint DEFAULT NULL, cd_funcao_medico_p INOUT text DEFAULT NULL, nr_seq_agenda_p INOUT bigint DEFAULT NULL, ie_tipo_servico_sus_p INOUT text DEFAULT NULL, ie_tipo_ato_sus_p INOUT text DEFAULT NULL, cd_local_estoque_p INOUT bigint DEFAULT NULL, dt_inicio_real_cir_p INOUT timestamp DEFAULT NULL, ie_proc_princ_atend_p INOUT text DEFAULT NULL, ie_video_p INOUT text DEFAULT NULL, tx_medico_p INOUT bigint DEFAULT NULL, tx_anestesia_p INOUT bigint DEFAULT NULL, ie_guia_informada_p INOUT text DEFAULT NULL, cd_situacao_glosa_p INOUT text DEFAULT NULL, ie_tipo_guia_p INOUT text DEFAULT NULL, ie_emite_conta_p INOUT text DEFAULT NULL, cd_senha_p INOUT text DEFAULT NULL, cd_acao_p INOUT text DEFAULT NULL, cd_medico_req_p INOUT text DEFAULT NULL, ie_tecnica_utilizada_p INOUT text DEFAULT NULL, nr_seq_proc_p INOUT bigint DEFAULT NULL, nr_seq_audit_chamada_p bigint DEFAULT NULL, nr_seq_motivo_audit_p bigint DEFAULT NULL, cd_pessoa_usuario_p text DEFAULT NULL, ie_auto_colar_data_p text DEFAULT NULL, dt_copia_p timestamp DEFAULT NULL, dt_fim_auditoria_p timestamp DEFAULT NULL, ie_tipo_convenio_p INOUT text DEFAULT NULL, ie_mostra_wdlg_p INOUT text DEFAULT NULL, nr_seq_auditoria_p bigint DEFAULT NULL, ie_atualiza_estoque_p text DEFAULT NULL, cd_medico_barras_p text DEFAULT NULL, ie_classificacao_p text DEFAULT NULL, cd_medico_resp_p text DEFAULT NULL, ie_ajustar_wdlg_p text DEFAULT NULL, ie_funcao_med_enabled_p text DEFAULT NULL, ie_medico_exe_enabled_p text DEFAULT NULL, ie_visivel_min_duracao_p text DEFAULT NULL, ie_barras_p text DEFAULT NULL, cd_equipamento_p bigint DEFAULT NULL, nr_cirurgia_p bigint DEFAULT NULL, dt_entrada_unid_atend_p timestamp DEFAULT NULL, nr_seq_atepacu_atend_p bigint DEFAULT NULL, ie_proc_prescrito_p text DEFAULT NULL, varie_autitoria_p text DEFAULT NULL, ie_erro_p INOUT text DEFAULT NULL, nm_usuario_p INOUT text DEFAULT NULL) AS $body$
DECLARE

	
	dt_acerto_conta_w	timestamp;
	
	
BEGIN
	
	select	nextval('procedimento_paciente_seq')
	into STRICT	nr_sequencia_p
	;
		
	SELECT * FROM execucao_prescricao_pck.procedimento_pac_new_record(
				dt_inicio_real_cir_p, dt_entrada_p, cd_convenio_p, cd_categoria_p, cd_convenio_p, cd_categoria_p, cd_pessoa_usuario_p, ie_auto_colar_data_p, dt_copia_p, dt_fim_auditoria_p, ie_barras_p, dt_conta_p, cd_pessoa_fisica_p, ie_tipo_atendimento_p, ie_tipo_convenio_p, dt_procedimento_p, nr_atendimento_p, cd_setor_atendimento_p, dt_entrada_unidade_p, ie_funcao_medico_p, nr_sequencia_p, ie_proc_princ_atend_p, ie_video_p, qt_procedimento_p, tx_medico_p, tx_anestesia_p, tx_procedimento_p, ie_valor_informado_p, ie_guia_informada_p, cd_situacao_glosa_p, nm_usuario_p, nr_seq_atepacu_p, cd_convenio_p, cd_categoria_p, nr_doc_convenio_p, ie_tipo_guia_p, cd_senha_p, ie_auditoria_p, cd_cgc_prestador_p, ie_emite_conta_p, ie_origem_proced_p, ie_mostra_wdlg_p, nm_usuario_p) INTO STRICT dt_conta_p, cd_pessoa_fisica_p, ie_tipo_atendimento_p, ie_tipo_convenio_p, dt_procedimento_p, nr_atendimento_p, cd_setor_atendimento_p, dt_entrada_unidade_p, ie_funcao_medico_p, nr_sequencia_p, ie_proc_princ_atend_p, ie_video_p, qt_procedimento_p, tx_medico_p, tx_anestesia_p, tx_procedimento_p, ie_valor_informado_p, ie_guia_informada_p, cd_situacao_glosa_p, nm_usuario_p, nr_seq_atepacu_p, cd_convenio_p, cd_categoria_p, nr_doc_convenio_p, ie_tipo_guia_p, cd_senha_p, ie_auditoria_p, cd_cgc_prestador_p, ie_emite_conta_p, ie_origem_proced_p, ie_mostra_wdlg_p;
				
	SELECT * FROM execucao_prescricao_pck.procedimento_pac_before_post(	
				nr_atendimento_p, nr_prescricao_p, nr_sequencia_prescricao_p, cd_procedimento_p, ie_origem_proced_p, ie_acao_executada_p, ie_auditoria_p, dt_procedimento_p, dt_entrada_unidade_p, nr_seq_atepacu_p, tx_procedimento_p, qt_procedimento_p, nr_seq_proc_princ_p, cd_procedimento_princ_p, nr_sequencia_p, cd_medico_executor_p, ie_funcao_medico_p, cd_especialidade_p, nr_interno_conta_p, cd_atividade_prof_bpa_p, ie_tipo_atend_bpa_p, ie_grupo_atend_bpa_p, cd_pessoa_fisica_p, nr_seq_exame_p, nr_seq_proc_interno_p, cd_setor_atendimento_p, nr_seq_grupo_rec_p, nr_seq_cor_exec_p, cd_convenio_p, cd_categoria_p, ie_valor_informado_p, cd_motivo_exc_conta_p, ds_compl_motivo_excon_p, nr_minuto_duracao_p, nr_doc_convenio_p, ie_tipo_atendimento_p, nr_seq_classificacao_p, ie_via_acesso_p, cd_plano_convenio_p, dt_entrada_p, dt_alta_p, dt_conta_p, ie_forma_apresentacao_p, dt_inicio_procedimento_p, cd_unidade_medida_p, ds_proc_convenio_p, ds_proc_interno_conv_p, cd_cgc_prestador_p, cd_kit_material_p, cd_funcao_medico_p, nr_seq_agenda_p, ie_tipo_servico_sus_p, ie_tipo_ato_sus_p, cd_local_estoque_p, ie_atualiza_estoque_p, cd_medico_barras_p, ie_classificacao_p, cd_medico_resp_p, ie_ajustar_wdlg_p, ie_funcao_med_enabled_p, ie_medico_exe_enabled_p, ie_visivel_min_duracao_p, ie_barras_p, cd_equipamento_p, nr_cirurgia_p, dt_entrada_unid_atend_p, nr_seq_atepacu_atend_p, ie_proc_prescrito_p, varie_autitoria_p, ie_erro_p, nm_usuario_p) INTO STRICT 	
				nr_atendimento_p, nr_prescricao_p, nr_sequencia_prescricao_p, cd_procedimento_p, ie_origem_proced_p, ie_acao_executada_p, ie_auditoria_p, dt_procedimento_p, dt_entrada_unidade_p, nr_seq_atepacu_p, tx_procedimento_p, qt_procedimento_p, nr_seq_proc_princ_p, cd_procedimento_princ_p, nr_sequencia_p, cd_medico_executor_p, ie_funcao_medico_p, cd_especialidade_p, nr_interno_conta_p, cd_atividade_prof_bpa_p, ie_tipo_atend_bpa_p, ie_grupo_atend_bpa_p, cd_pessoa_fisica_p, nr_seq_exame_p, nr_seq_proc_interno_p, cd_setor_atendimento_p, nr_seq_grupo_rec_p, nr_seq_cor_exec_p, cd_convenio_p, cd_categoria_p, ie_valor_informado_p, cd_motivo_exc_conta_p, ds_compl_motivo_excon_p, nr_minuto_duracao_p, nr_doc_convenio_p, ie_tipo_atendimento_p, nr_seq_classificacao_p, ie_via_acesso_p, cd_plano_convenio_p, dt_entrada_p, dt_alta_p, dt_conta_p, ie_forma_apresentacao_p, dt_inicio_procedimento_p, cd_unidade_medida_p, ds_proc_convenio_p, ds_proc_interno_conv_p, cd_cgc_prestador_p, cd_kit_material_p, cd_funcao_medico_p, nr_seq_agenda_p, ie_tipo_servico_sus_p, ie_tipo_ato_sus_p, cd_local_estoque_p, ie_erro_p;		

	dt_procedimento_p := coalesce(dt_procedimento_p, clock_timestamp());
	dt_conta_p := coalesce(dt_conta_p, clock_timestamp());
	
	select	coalesce(max(dt_acerto_conta), clock_timestamp())
	into STRICT	dt_acerto_conta_w
	from	conta_paciente
	where	nr_interno_conta = nr_interno_conta_p;
	
	if (ie_erro_p = 'S') then
		goto Final;
	end if;
	
	insert into procedimento_paciente(
		nr_sequencia, 
		nr_atendimento,
		dt_entrada_unidade,
		cd_procedimento,
		ie_origem_proced,
		dt_procedimento, 
		dt_conta,
		qt_procedimento,
		dt_prescricao,
		dt_atualizacao, 
		nm_usuario, 
		cd_setor_atendimento, 
		nr_seq_atepacu,
		ie_proc_princ_atend,
		ie_video,
		tx_medico,
		tx_anestesia,
		tx_procedimento,
		ie_valor_informado,
		ie_guia_informada,
		cd_situacao_glosa,
		nm_usuario_original,
		cd_convenio,
		cd_categoria,
		ie_auditoria,
		ie_emite_conta,
		cd_cgc_prestador,
		cd_pessoa_fisica,
		ie_funcao_medico,
		nr_prescricao,
		nr_sequencia_prescricao,
		nr_seq_proc_princ,
		cd_procedimento_princ,
		cd_medico_executor,
		cd_medico,
		cd_especialidade,
		nr_interno_conta,
		cd_atividade_prof_bpa,
		ie_tipo_atend_bpa,
		ie_grupo_atend_bpa,
		nr_seq_exame,
		nr_seq_proc_interno,
		nr_seq_grupo_rec,
		nr_seq_cor_exec,
		cd_motivo_exc_conta,
		ds_compl_motivo_excon,
		nr_minuto_duracao,
		nr_doc_convenio,
		ie_via_acesso,
		dt_inicio_procedimento,
		cd_funcao,
		ie_tipo_servico_sus,
		ie_tipo_ato_sus,
		cd_acao,
		cd_medico_req,
		ie_tecnica_utilizada,
		dt_acerto_conta,
		qt_devolvida,
		ie_tipo_guia)
	values (
		nr_sequencia_p,
		nr_atendimento_p,
		dt_entrada_unidade_p,
		cd_procedimento_p,
		ie_origem_proced_p,
		dt_procedimento_p, 
		dt_conta_p,
		qt_procedimento_p, 
		dt_prescricao_p,
		clock_timestamp(), 
		nm_usuario_p, 
		cd_setor_atendimento_p, 
		nr_seq_atepacu_p,
		ie_proc_princ_atend_p,
		ie_video_p,
		tx_medico_p,
		tx_anestesia_p,
		tx_procedimento_p,
		ie_valor_informado_p,
		ie_guia_informada_p,
		cd_situacao_glosa_p,
		nm_usuario_p,
		cd_convenio_p,
		cd_categoria_p,
		ie_auditoria_p,
		ie_emite_conta_p,
		cd_cgc_prestador_p,
		cd_pessoa_fisica_p,
		ie_funcao_medico_p,
		nr_prescricao_p,
		nr_sequencia_prescricao_p,
		nr_seq_proc_princ_p,
		cd_procedimento_princ_p,
		cd_medico_executor_p,
		cd_medico_p,
		cd_especialidade_p,
		nr_interno_conta_p,
		cd_atividade_prof_bpa_p,
		ie_tipo_atend_bpa_p,
		ie_grupo_atend_bpa_p,
		nr_seq_exame_p,
		nr_seq_proc_interno_p,
		nr_seq_grupo_rec_p,
		nr_seq_cor_exec_p,
		cd_motivo_exc_conta_p,
		ds_compl_motivo_excon_p,
		nr_minuto_duracao_p,
		nr_doc_convenio_p,
		ie_via_acesso_p,
		dt_inicio_procedimento_p,
		24,
		ie_tipo_servico_sus_p,
		ie_tipo_ato_sus_p,
		cd_acao_p,
		cd_medico_req_p,
		ie_tecnica_utilizada_p,
		dt_acerto_conta_w,
		0,
		ie_tipo_guia_p);
		
	SELECT * FROM execucao_prescricao_pck.procedimento_pac_after_post(
			nr_atendimento_p, nr_prescricao_p, nr_sequencia_prescricao_p, cd_procedimento_p, ie_origem_proced_p, ie_acao_executada_p, dt_procedimento_p, dt_entrada_unidade_p, nr_seq_atepacu_p, qt_procedimento_p, nr_seq_proc_princ_p, nr_sequencia_p, cd_medico_executor_p, nr_interno_conta_p, cd_pessoa_fisica_p, nr_seq_proc_interno_p, cd_setor_atendimento_p, cd_convenio_p, cd_categoria_p, nr_doc_convenio_p, ie_tipo_atendimento_p, cd_local_estoque_p, nr_seq_cor_exec_p, nr_cirurgia_p, nr_seq_audit_chamada_p, nr_seq_motivo_audit_p, ie_tipo_convenio_p, ie_barras_p, ie_erro_p, nm_usuario_p) INTO STRICT
			nr_atendimento_p, nr_prescricao_p, nr_sequencia_prescricao_p, cd_procedimento_p, ie_origem_proced_p, ie_acao_executada_p, dt_procedimento_p, dt_entrada_unidade_p, nr_seq_atepacu_p, qt_procedimento_p, nr_seq_proc_princ_p, nr_sequencia_p, cd_medico_executor_p, nr_interno_conta_p, cd_pessoa_fisica_p, nr_seq_proc_interno_p, cd_setor_atendimento_p, cd_convenio_p, cd_categoria_p, nr_doc_convenio_p, ie_tipo_atendimento_p, cd_local_estoque_p, ie_erro_p;	
	
	<<Final>>
	
	PERFORM set_config('execucao_prescricao_pck.qt_existe_w', 0, false);
	
	end;
	

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE execucao_prescricao_pck.ajustar_quantidade_proced ( nr_atendimento_p INOUT bigint, nr_prescricao_p INOUT bigint, nr_sequencia_prescricao_p INOUT bigint, cd_procedimento_p INOUT bigint, ie_origem_proced_p INOUT bigint, ie_acao_executada_p INOUT bigint, ie_auditoria_p INOUT text, dt_procedimento_p INOUT timestamp, dt_entrada_unidade_p INOUT timestamp, dt_prescricao_p timestamp default null, nr_seq_atepacu_p INOUT bigint DEFAULT NULL, tx_procedimento_p INOUT bigint DEFAULT NULL, qt_procedimento_p INOUT bigint DEFAULT NULL, nr_seq_proc_princ_p INOUT bigint DEFAULT NULL, cd_procedimento_princ_p INOUT bigint DEFAULT NULL, nr_sequencia_p INOUT bigint DEFAULT NULL, cd_medico_executor_p INOUT text DEFAULT NULL, cd_medico_p INOUT text DEFAULT NULL, ie_funcao_medico_p INOUT text DEFAULT NULL, cd_especialidade_p INOUT text DEFAULT NULL, nr_interno_conta_p INOUT bigint DEFAULT NULL, cd_atividade_prof_bpa_p INOUT text DEFAULT NULL, ie_tipo_atend_bpa_p INOUT text DEFAULT NULL, ie_grupo_atend_bpa_p INOUT text DEFAULT NULL, cd_pessoa_fisica_p INOUT text DEFAULT NULL, nr_seq_exame_p INOUT bigint DEFAULT NULL, nr_seq_proc_interno_p INOUT bigint DEFAULT NULL, cd_setor_atendimento_p INOUT bigint DEFAULT NULL, nr_seq_grupo_rec_p INOUT bigint DEFAULT NULL, nr_seq_cor_exec_p INOUT bigint DEFAULT NULL, cd_convenio_p INOUT bigint DEFAULT NULL, cd_categoria_p INOUT text DEFAULT NULL, ie_valor_informado_p INOUT text DEFAULT NULL, cd_motivo_exc_conta_p INOUT bigint DEFAULT NULL, ds_compl_motivo_excon_p INOUT text DEFAULT NULL, nr_minuto_duracao_p INOUT bigint DEFAULT NULL, nr_doc_convenio_p INOUT text DEFAULT NULL, ie_tipo_atendimento_p INOUT bigint DEFAULT NULL, nr_seq_classificacao_p INOUT bigint DEFAULT NULL, ie_via_acesso_p INOUT text DEFAULT NULL, cd_plano_convenio_p INOUT text DEFAULT NULL, dt_entrada_p INOUT timestamp DEFAULT NULL, dt_alta_p INOUT timestamp DEFAULT NULL, dt_conta_p INOUT timestamp DEFAULT NULL, ie_forma_apresentacao_p INOUT bigint DEFAULT NULL, dt_inicio_procedimento_p INOUT timestamp DEFAULT NULL, cd_unidade_medida_p INOUT text DEFAULT NULL, ds_proc_convenio_p INOUT text DEFAULT NULL, ds_proc_interno_conv_p INOUT text DEFAULT NULL, cd_cgc_prestador_p INOUT text DEFAULT NULL, cd_kit_material_p INOUT bigint DEFAULT NULL, cd_funcao_medico_p INOUT text DEFAULT NULL, nr_seq_agenda_p INOUT bigint DEFAULT NULL, ie_tipo_servico_sus_p INOUT text DEFAULT NULL, ie_tipo_ato_sus_p INOUT text DEFAULT NULL, cd_local_estoque_p INOUT bigint DEFAULT NULL, dt_inicio_real_cir_p INOUT timestamp DEFAULT NULL, ie_proc_princ_atend_p INOUT text DEFAULT NULL, ie_video_p INOUT text DEFAULT NULL, tx_medico_p INOUT bigint DEFAULT NULL, tx_anestesia_p INOUT bigint DEFAULT NULL, ie_guia_informada_p INOUT text DEFAULT NULL, cd_situacao_glosa_p INOUT text DEFAULT NULL, ie_tipo_guia_p INOUT text DEFAULT NULL, ie_emite_conta_p INOUT text DEFAULT NULL, cd_senha_p INOUT text DEFAULT NULL, cd_acao_p INOUT text DEFAULT NULL, cd_medico_req_p INOUT text DEFAULT NULL, ie_tecnica_utilizada_p INOUT text DEFAULT NULL, nr_seq_proc_p INOUT bigint DEFAULT NULL, nr_seq_audit_chamada_p bigint DEFAULT NULL, nr_seq_motivo_audit_p bigint DEFAULT NULL, cd_pessoa_usuario_p text DEFAULT NULL, ie_auto_colar_data_p text DEFAULT NULL, dt_copia_p timestamp DEFAULT NULL, dt_fim_auditoria_p timestamp DEFAULT NULL, ie_tipo_convenio_p INOUT text DEFAULT NULL, ie_mostra_wdlg_p INOUT text DEFAULT NULL, nr_seq_auditoria_p bigint DEFAULT NULL, ie_atualiza_estoque_p text DEFAULT NULL, cd_medico_barras_p text DEFAULT NULL, ie_classificacao_p text DEFAULT NULL, cd_medico_resp_p text DEFAULT NULL, ie_ajustar_wdlg_p text DEFAULT NULL, ie_funcao_med_enabled_p text DEFAULT NULL, ie_medico_exe_enabled_p text DEFAULT NULL, ie_visivel_min_duracao_p text DEFAULT NULL, ie_barras_p text DEFAULT NULL, cd_equipamento_p bigint DEFAULT NULL, nr_cirurgia_p bigint DEFAULT NULL, dt_entrada_unid_atend_p timestamp DEFAULT NULL, nr_seq_atepacu_atend_p bigint DEFAULT NULL, ie_proc_prescrito_p text DEFAULT NULL, varie_autitoria_p text DEFAULT NULL, ie_erro_p INOUT text DEFAULT NULL, nm_usuario_p INOUT text DEFAULT NULL) FROM PUBLIC;
