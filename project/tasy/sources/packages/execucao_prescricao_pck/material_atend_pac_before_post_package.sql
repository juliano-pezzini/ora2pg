-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE execucao_prescricao_pck.material_atend_pac_before_post ( ie_acao_executada_p bigint, nr_sequencia_p bigint, nr_atendimento_p bigint, nr_doc_convenio_p text, ie_barras_p text, dt_atendimento_p timestamp, cd_setor_atendimento_p bigint, cd_setor_atend_user_p bigint, cd_cgc_fornecedor_p text, cd_cgc_prestador_p text, nr_seq_atepacu_p bigint, cd_local_estoque_p bigint, cd_acao_p text, nr_sequencia_prescricao_p bigint, nr_prescricao_p bigint, nr_serie_material_p text, dt_entrada_p timestamp, dt_alta_p timestamp, nr_seq_baixa_param_p bigint, cd_convenio_cat_p bigint, cd_plano_cat_p text, cd_categoria_cat_p text, ie_tipo_atendimento_p bigint, ie_conta_paciente_p text, ie_atualiza_estoque_p text, dt_entrada_unidade_p timestamp, cd_unidade_medida_p text, cd_medico_prescritor_p text, ie_auditoria_p INOUT text, cd_material_p INOUT bigint, cd_material_exec_p INOUT bigint, cd_convenio_p INOUT bigint, cd_categoria_p INOUT text, qt_material_p INOUT bigint, nr_interno_conta_p INOUT bigint, ie_valor_informado_p INOUT text, cd_motivo_exc_conta_p INOUT bigint, ds_compl_motivo_excon_p INOUT text, cd_proced_referencia_p INOUT text, nr_seq_proc_princ_p INOUT bigint, ds_observacao_p INOUT text, nr_seq_tipo_baixa_p INOUT bigint, ie_erro_p INOUT text, nm_usuario_p text, ie_acao_justif_p INOUT text) AS $body$
DECLARE

												
	ie_abortado_w	varchar(1) := 'N';
	
BEGIN
	
	obter_param_usuario(24, 282, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, current_setting('execucao_prescricao_pck.ie_excluir_apos_alta_w')::varchar(1));
	obter_param_usuario(24, 121, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, current_setting('execucao_prescricao_pck.ie_qtde_zerada_w')::varchar(1));
	obter_param_usuario(24, 267, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, current_setting('execucao_prescricao_pck.ie_exige_guia_w')::varchar(1));
	obter_param_usuario(24, 221, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, current_setting('execucao_prescricao_pck.ie_alterar_item_aud_w')::varchar(1));
	obter_param_usuario(24, 159, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, current_setting('execucao_prescricao_pck.qt_tempo_limite_w')::bigint);
	obter_param_usuario(24, 272, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, current_setting('execucao_prescricao_pck.ie_somente_mesmo_mes_w')::varchar(1));
	obter_param_usuario(24, 105, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, current_setting('execucao_prescricao_pck.ie_consiste_regra_uso_mat_w')::varchar(1));
	obter_param_usuario(24, 223, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, current_setting('execucao_prescricao_pck.ie_permite_alterar_data_w')::varchar(1));
	obter_param_usuario(24, 144, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, current_setting('execucao_prescricao_pck.ie_consiste_glosa_particular_w')::varchar(1));
	obter_param_usuario(24, 217, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, current_setting('execucao_prescricao_pck.ds_mensagem_parametro_w')::varchar(255));
	obter_param_usuario(24, 149, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, current_setting('execucao_prescricao_pck.ie_msg_glosa_exclusao_w')::varchar(1));
	obter_param_usuario(24, 88, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, current_setting('execucao_prescricao_pck.ie_permite_fracionado_w')::varchar(1));
	obter_param_usuario(24, 166, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, current_setting('execucao_prescricao_pck.ie_parametro_166_w')::varchar(1));
	obter_param_usuario(24, 169, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, current_setting('execucao_prescricao_pck.ie_parametro_169_w')::varchar(1));
	obter_param_usuario(24, 24, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, current_setting('execucao_prescricao_pck.ie_parametro_24_w')::varchar(1));
		
  if (current_setting('execucao_prescricao_pck.qt_tempo_limite_w')::bigint > 9999) then
    PERFORM set_config('execucao_prescricao_pck.qt_tempo_limite_w', 9999, false);
  end if;
    
	if (ie_acao_executada_p = 3) then
		CALL excluir_glosa_valor_mat(nr_sequencia_p,	nm_usuario_p);
		CALL exclui_item_integracao_opme(nr_sequencia_p);
	end if;
	
	if (current_setting('execucao_prescricao_pck.ie_excluir_apos_alta_w')::varchar(1) <> 'S') then
		
		select	max(dt_alta_medico)
		into STRICT	current_setting('execucao_prescricao_pck.dt_alta_medico_w')::timestamp
		from	atendimento_paciente
		where	nr_atendimento = nr_atendimento_p;
		
		if (current_setting('execucao_prescricao_pck.dt_alta_medico_w')::(timestamp IS NOT NULL AND timestamp::text <> '')) then
			ie_erro_p := 'S';
			CALL execucao_prescricao_pck.gerar_w_execucao_proc_mat(nr_atendimento_p, wheb_mensagem_pck.get_texto(180034), wheb_mensagem_pck.get_texto(1046161, 'NR_PARAMETRO='||'282;DS_REGRA='||''), 'S', null, cd_material_p, null, nm_usuario_p);
			goto Final;
		end if;
		
	end if;
	
	if (qt_material_p = 0) and (current_setting('execucao_prescricao_pck.ie_qtde_zerada_w')::varchar(1) = 'N') and (cd_material_p > 0) then
		ie_erro_p := 'S';
		CALL execucao_prescricao_pck.gerar_w_execucao_proc_mat(nr_atendimento_p, wheb_mensagem_pck.get_texto(180036), wheb_mensagem_pck.get_texto(1046161, 'NR_PARAMETRO='||'121;DS_REGRA='||''), 'S', null, cd_material_p, null, nm_usuario_p);
		goto Final;
	end if;
	
	if (current_setting('execucao_prescricao_pck.ie_exige_guia_w')::varchar(1) in ('S', 'A')) and (coalesce(nr_doc_convenio_p::text, '') = '') and (ie_barras_p = 'N') and (cd_material_p > 0) then
		ie_erro_p := 'S';
		CALL execucao_prescricao_pck.gerar_w_execucao_proc_mat(nr_atendimento_p, wheb_mensagem_pck.get_texto(180039), wheb_mensagem_pck.get_texto(1046161, 'NR_PARAMETRO='||'267;DS_REGRA='||''), 'S', null, cd_material_p, null, nm_usuario_p);
		goto Final;
	end if;
	
	if (cd_material_p = 0) then
		ie_erro_p := 'S';
		CALL execucao_prescricao_pck.gerar_w_execucao_proc_mat(nr_atendimento_p, wheb_mensagem_pck.get_texto(180042), null, 'S', null, null, null, nm_usuario_p);
		goto Final;
	end if;

	if (current_setting('execucao_prescricao_pck.ie_alterar_item_aud_w')::varchar(1) = 'N') and (ie_acao_executada_p = 2) and (ie_auditoria_p in ('S', 'A')) then
		ie_erro_p := 'S';
		CALL execucao_prescricao_pck.gerar_w_execucao_proc_mat(nr_atendimento_p, wheb_mensagem_pck.get_texto(180043), wheb_mensagem_pck.get_texto(1046161, 'NR_PARAMETRO='||'221;DS_REGRA='||''), 'S', null, cd_material_p, null, nm_usuario_p);
		goto Final;
	end if;
	
	if (coalesce(current_setting('execucao_prescricao_pck.qt_tempo_limite_w')::bigint, 0) > 0) and (dt_atendimento_p IS NOT NULL AND dt_atendimento_p::text <> '') and
		(dt_atendimento_p <= (clock_timestamp() - coalesce(current_setting('execucao_prescricao_pck.qt_tempo_limite_w')::bigint, 0))) then
		ie_erro_p := 'S';
		CALL execucao_prescricao_pck.gerar_w_execucao_proc_mat(nr_atendimento_p, wheb_mensagem_pck.get_texto(180045), wheb_mensagem_pck.get_texto(1046161, 'NR_PARAMETRO='||'159;DS_REGRA='||''), 'S', null, cd_material_p, null, nm_usuario_p);
		goto Final;
	end if;
	
	if (current_setting('execucao_prescricao_pck.ie_somente_mesmo_mes_w')::varchar(1) = 'S') and (dt_atendimento_p IS NOT NULL AND dt_atendimento_p::text <> '') and (trunc(to_date(dt_atendimento_p, 'dd/mm/yyyy hh24:mi:ss'), 'month') <> trunc(clock_timestamp(), 'month')) then
		ie_erro_p := 'S';
		CALL execucao_prescricao_pck.gerar_w_execucao_proc_mat(nr_atendimento_p, wheb_mensagem_pck.get_texto(180046), wheb_mensagem_pck.get_texto(1046161, 'NR_PARAMETRO='||'272;DS_REGRA='||''), 'S', null, cd_material_p, null, nm_usuario_p);
		goto Final;
	end if;
	
	if (current_setting('execucao_prescricao_pck.ie_consiste_regra_uso_mat_w')::varchar(1) <> 'N') and (ie_acao_executada_p in (1,2)) then
		
		select	a.cd_convenio,
			a.cd_plano_convenio,
			b.ie_tipo_atendimento,
			a.cd_categoria
		into STRICT	current_setting('execucao_prescricao_pck.cd_convenio_w')::convenio.cd_convenio%type,
			current_setting('execucao_prescricao_pck.cd_plano_convenio_w')::atend_categoria_convenio.cd_plano_convenio%type,
			current_setting('execucao_prescricao_pck.ie_tipo_atendimento_w')::atendimento_paciente.ie_tipo_atendimento%type,
			current_setting('execucao_prescricao_pck.cd_categoria_w')::categoria_convenio.cd_categoria%type
		from	atendimento_paciente b,
			atend_categoria_convenio a
		where	a.nr_atendimento  = b.nr_atendimento
		and	obter_atecaco_atendimento(a.nr_atendimento)  = a.nr_seq_interno		
		and	a.nr_atendimento  = nr_atendimento_p;
		
		obter_regra_uso_mat(
				nr_atendimento_p,
				cd_material_p,
				qt_material_p,
				cd_setor_atendimento_p,
				current_setting('execucao_prescricao_pck.ie_acao_excesso_w')::varchar(5),
				current_setting('execucao_prescricao_pck.qt_excedida_w')::double,
				current_setting('execucao_prescricao_pck.nr_seq_regra_uso_w')::bigint,
				current_setting('execucao_prescricao_pck.ds_mensagem_w')::varchar(255),
				current_setting('execucao_prescricao_pck.cd_categoria_w')::categoria_convenio.cd_categoria%type,
				current_setting('execucao_prescricao_pck.cd_plano_convenio_w')::atend_categoria_convenio.cd_plano_convenio%type,
				cd_cgc_fornecedor_p,
				cd_cgc_prestador_p,
				dt_atendimento_p,
				nr_sequencia_p);
				
		if (current_setting('execucao_prescricao_pck.ie_acao_excesso_w')::varchar(5) = 'P') then
			nr_interno_conta_p := null;
			if (current_setting('execucao_prescricao_pck.qt_excedida_w')::double >= qt_material_p) then
				nr_interno_conta_p := null;
				
				obter_convenio_particular_pf(
								wheb_usuario_pck.get_cd_estabelecimento,
								cd_convenio_p,
								null,
								dt_atendimento_p,
								cd_convenio_p,
								cd_categoria_p);

			else

				qt_material_p := qt_material_p - current_setting('execucao_prescricao_pck.qt_excedida_w')::double;
				
				obter_convenio_particular_pf(
								wheb_usuario_pck.get_cd_estabelecimento,
								cd_convenio_p,
								null,
								dt_atendimento_p,
								cd_convenio_p,
								cd_categoria_p);
				
				inserir_material_atend_pac(
								nr_atendimento_p,
								null,
								cd_material_p,
								dt_atendimento_p,
								cd_convenio_p,
								cd_categoria_p,
								nr_seq_atepacu_p,
								nm_usuario_p,
								current_setting('execucao_prescricao_pck.qt_excedida_w')::double,
								cd_local_estoque_p,
								cd_acao_p,
								null,
								current_setting('execucao_prescricao_pck.nr_sequencia_mat_pac_w')::material_atend_paciente.nr_sequencia%type,
								null,
								null,
								cd_material_exec_p);
								
				CALL atualiza_preco_material(current_setting('execucao_prescricao_pck.nr_sequencia_mat_pac_w')::material_atend_paciente.nr_sequencia%type, nm_usuario_p);
				
			end if;
			
			CALL execucao_prescricao_pck.gerar_w_execucao_proc_mat(nr_atendimento_p, wheb_mensagem_pck.get_texto(181712, 'DS_MSG='||current_setting('execucao_prescricao_pck.ds_mensagem_w')::varchar(255)), wheb_mensagem_pck.get_texto(1046161, 'NR_PARAMETRO='||'105;DS_REGRA='||current_setting('execucao_prescricao_pck.nr_seq_regra_uso_w')::bigint),
					'N', null, cd_material_p, null, nm_usuario_p);
		
		elsif (current_setting('execucao_prescricao_pck.ie_acao_excesso_w')::varchar(5) = 'Z') then
			
			if (current_setting('execucao_prescricao_pck.qt_excedida_w')::double >= qt_material_p) then
				
				ie_valor_informado_p := 'S';
			else
			
				qt_material_p := qt_material_p - current_setting('execucao_prescricao_pck.qt_excedida_w')::double;
			
				inserir_material_atend_pac(
								nr_atendimento_p,
								null,
								cd_material_p,
								dt_atendimento_p,
								cd_convenio_p,
								cd_categoria_p,
								nr_seq_atepacu_p,
								nm_usuario_p,
								current_setting('execucao_prescricao_pck.qt_excedida_w')::double,
								cd_local_estoque_p,
								cd_acao_p,
								'S',
								current_setting('execucao_prescricao_pck.nr_sequencia_mat_pac_w')::material_atend_paciente.nr_sequencia%type,
								null,
								null,
								cd_material_exec_p);
				
				CALL atualiza_preco_material(current_setting('execucao_prescricao_pck.nr_sequencia_mat_pac_w')::material_atend_paciente.nr_sequencia%type, nm_usuario_p);
			
			end if;
		
		elsif (current_setting('execucao_prescricao_pck.ie_acao_excesso_w')::varchar(5) = 'M') and (current_setting('execucao_prescricao_pck.ds_mensagem_w')::(varchar(255) IS NOT NULL AND (varchar(255))::text <> '')) then
						
			CALL execucao_prescricao_pck.gerar_w_execucao_proc_mat(nr_atendimento_p, current_setting('execucao_prescricao_pck.ds_mensagem_w')::varchar(255), wheb_mensagem_pck.get_texto(1046161, 'NR_PARAMETRO='||'105;DS_REGRA='||current_setting('execucao_prescricao_pck.nr_seq_regra_uso_w')::bigint), 'N', null, cd_material_p, null, nm_usuario_p);
		elsif (current_setting('execucao_prescricao_pck.ie_acao_excesso_w')::varchar(5) = 'J') then
			if (current_setting('execucao_prescricao_pck.qt_excedida_w')::double > 0) then
				PERFORM set_config('execucao_prescricao_pck.ie_acao_justif_w', current_setting('execucao_prescricao_pck.ie_acao_excesso_w')::varchar(5), false);				
				ie_acao_justif_p:= current_setting('execucao_prescricao_pck.ie_acao_excesso_w')::varchar(5);		
			end if;
		elsif (current_setting('execucao_prescricao_pck.ie_acao_excesso_w')::varchar(5) = 'E') then
			
			if (current_setting('execucao_prescricao_pck.qt_excedida_w')::double > 0) then
				qt_material_p := qt_material_p - current_setting('execucao_prescricao_pck.qt_excedida_w')::double;

				select	max(cd_motivo_exc_conta)
				into STRICT	cd_motivo_exc_conta_p
				from	parametro_faturamento
				where	cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento;
				
				if (qt_material_p = 0) then
					qt_material_p := current_setting('execucao_prescricao_pck.qt_excedida_w')::double;
					ds_compl_motivo_excon_p := wheb_mensagem_pck.get_texto(181763);
					nr_interno_conta_p := null;
				else
										
					inserir_material_atend_pac(
								nr_atendimento_p,
								null,
								cd_material_p,
								dt_atendimento_p,
								cd_convenio_p,
								cd_categoria_p,
								nr_seq_atepacu_p,
								nm_usuario_p,
								current_setting('execucao_prescricao_pck.qt_excedida_w')::double,
								cd_local_estoque_p,
								cd_acao_p,
								'S',
								current_setting('execucao_prescricao_pck.nr_sequencia_mat_pac_w')::material_atend_paciente.nr_sequencia%type,
								nr_sequencia_prescricao_p,
								nr_prescricao_p,
								cd_material_exec_p);

					CALL atualiza_preco_material(current_setting('execucao_prescricao_pck.nr_sequencia_mat_pac_w')::material_atend_paciente.nr_sequencia%type, nm_usuario_p);
					
					CALL excluir_matproc_conta(
									current_setting('execucao_prescricao_pck.nr_sequencia_mat_pac_w')::material_atend_paciente.nr_sequencia%type,
									nr_interno_conta_p,
									cd_motivo_exc_conta_p,
									wheb_mensagem_pck.get_texto(181783),
									'M',
									nm_usuario_p);
					
				end if;
			end if;

		elsif (coalesce(current_setting('execucao_prescricao_pck.ie_acao_excesso_w')::varchar(5), 'XXX') <> 'P') and (current_setting('execucao_prescricao_pck.ds_mensagem_w')::(varchar(255) IS NOT NULL AND (varchar(255))::text <> '')) then
			if (current_setting('execucao_prescricao_pck.ie_consiste_regra_uso_mat_w')::varchar(1) = 'S') then
				ie_erro_p := 'S';
				CALL execucao_prescricao_pck.gerar_w_execucao_proc_mat(nr_atendimento_p, current_setting('execucao_prescricao_pck.ds_mensagem_w')::varchar(255), wheb_mensagem_pck.get_texto(1046161, 'NR_PARAMETRO='||'105;DS_REGRA='||current_setting('execucao_prescricao_pck.nr_seq_regra_uso_w')::bigint), 'S', null, cd_material_p, null, nm_usuario_p);
				goto Final;
			elsif (current_setting('execucao_prescricao_pck.ie_consiste_regra_uso_mat_w')::varchar(1) = 'Q') then
				PERFORM set_config('execucao_prescricao_pck.ie_consiste_regra_uso_mat_w', 'Q', false);
               /* } else if ("Q".equalsIgnoreCase(Funcoes.validaString(parametrosExternos.get("IE_CONSISTE_REGRA_QTDE")))) { //"Q".equalsIgnoreCase(getParametroStr(105))
                    retornoDoServidor.put("IE_ACAO", "Q"); // verificacao a ser feita no cliente                
                    retornoDoServidor.put("DS_MSG", Funcoes.validaString(procedure.get("DS_MENSAGEM_P")));}*/

			end if;
		end if;
	end if;

	if (ie_acao_executada_p in (1,2)) and (coalesce(nr_serie_material_p::text, '') = '') then
		
		PERFORM set_config('execucao_prescricao_pck.ie_controla_serie_w', obter_se_mat_controla_serie(wheb_usuario_pck.get_cd_estabelecimento, cd_material_p), false);
		
		if (current_setting('execucao_prescricao_pck.ie_controla_serie_w')::varchar(1) = 'O') then
			ie_erro_p := 'S';
			CALL execucao_prescricao_pck.gerar_w_execucao_proc_mat(nr_atendimento_p, wheb_mensagem_pck.get_texto(180066), null, 'S', null, cd_material_p, null, nm_usuario_p);
			goto Final;
		end if;
	end if;
	
	if (ie_acao_executada_p in (1,2)) and (current_setting('execucao_prescricao_pck.ie_permite_alterar_data_w')::varchar(1) <> 'S') and (qt_material_p > 0) then
		ie_erro_p := execucao_prescricao_pck.valida_data(nr_atendimento_p, cd_material_p, dt_atendimento_p, dt_entrada_p, dt_alta_p, nm_usuario_p, ie_erro_p);
		if (ie_erro_p = 'S') then
			goto Final;
		end if;
	end if;
	
	if (coalesce(cd_material_exec_p::text, '') = '') then
		cd_material_exec_p := cd_material_p;
	end if;	
	
	if (ie_acao_executada_p in (1,2)) and (coalesce(cd_proced_referencia_p::text, '') = '') and (nr_seq_proc_princ_p IS NOT NULL AND nr_seq_proc_princ_p::text <> '') then
		select	max(cd_procedimento)
		into STRICT	cd_proced_referencia_p
		from	procedimento_paciente
		where	nr_sequencia = nr_seq_proc_princ_p;
	end if;
	
	if (coalesce(ds_observacao_p::text, '') = '') then
		ds_observacao_p := SUBSTR(wheb_mensagem_pck.get_texto(181817, 'CD_PERFIL='|| obter_perfil_ativo|| ';CD_FUNCAO='||'24 - SP.: ' || cd_setor_atendimento_p || ' SU.: '|| cd_setor_atend_user_p),1,255);
	end if;
	
	if (coalesce(nr_seq_tipo_baixa_p::text, '') = '') and (nr_seq_baixa_param_p IS NOT NULL AND nr_seq_baixa_param_p::text <> '') then
		nr_seq_tipo_baixa_p	:= nr_seq_baixa_param_p;
	end if;
	
	begin
	Consiste_Mat_Plano_Convenio(
						cd_convenio_cat_p,
						cd_plano_cat_p,
						cd_material_p,
						nr_atendimento_p,
						cd_setor_atendimento_p,
						current_setting('execucao_prescricao_pck.ds_retorno_mat_plano_w')::varchar(255),
						current_setting('execucao_prescricao_pck.ie_bloqueia_agenda_w')::varchar(1),
						current_setting('execucao_prescricao_pck.ie_regra_w')::varchar(10),
						current_setting('execucao_prescricao_pck.nr_seq_regra_w')::bigint,
						qt_material_p,
						dt_atendimento_p,
						null,
						wheb_usuario_pck.get_cd_estabelecimento,
						cd_categoria_cat_p,
						null);
	exception
	when others then
		null;
	end;
	
	if (current_setting('execucao_prescricao_pck.nr_seq_regra_w')::(bigint IS NOT NULL AND bigint::text <> '')) then
		select  max(ds_observacao)
		into STRICT	current_setting('execucao_prescricao_pck.ds_observacao_w')::regra_convenio_plano_mat.ds_observacao%type
		from	regra_convenio_plano_mat
		where	nr_sequencia = current_setting('execucao_prescricao_pck.nr_seq_regra_w')::bigint;
		
		if (current_setting('execucao_prescricao_pck.ds_observacao_w')::regra_convenio_plano_mat.ds_observacao%(type IS NOT NULL AND type::text <> '')) then
			ds_observacao_p := SUBSTR(ds_observacao_p || '"'|| current_setting('execucao_prescricao_pck.ds_observacao_w')::regra_convenio_plano_mat.ds_observacao%type || '"',1,255);
		end if;
	end if;
	
	if (current_setting('execucao_prescricao_pck.ie_regra_w')::varchar(10) = '8') and (current_setting('execucao_prescricao_pck.ds_retorno_mat_plano_w')::(varchar(255) IS NOT NULL AND (varchar(255))::text <> '')) and (current_setting('execucao_prescricao_pck.ie_bloqueia_agenda_w')::varchar(1) = 'S') then
		ie_erro_p := 'S';
		CALL execucao_prescricao_pck.gerar_w_execucao_proc_mat(nr_atendimento_p, wheb_mensagem_pck.get_texto(181919, 'CD_MAT='||cd_material_p ||' - '|| current_setting('execucao_prescricao_pck.ds_retorno_mat_plano_w')::varchar(255)), null, 'S', null, cd_material_p, null, nm_usuario_p);
		goto Final;
	end if;
	
	if (current_setting('execucao_prescricao_pck.ie_consiste_glosa_particular_w')::varchar(1) = 'S') and (ie_acao_executada_p in (1,2)) then
		SELECT * FROM execucao_prescricao_pck.obter_glosa_mat_proc(
			'M', nr_atendimento_p, ie_tipo_atendimento_p, dt_atendimento_p, null, null, null, null, null, null, null, nr_sequencia_p, qt_material_p, cd_convenio_p, cd_categoria_p, cd_material_p, current_setting('execucao_prescricao_pck.cd_motivo_exc_out_w')::bigint, current_setting('execucao_prescricao_pck.ie_glosa_out_w')::varchar(10)) INTO STRICT qt_material_p, cd_convenio_p, cd_categoria_p, cd_material_p, current_setting('execucao_prescricao_pck.cd_motivo_exc_out_w')::bigint, current_setting('execucao_prescricao_pck.ie_glosa_out_w')::varchar(10);
		
		if (current_setting('execucao_prescricao_pck.ie_glosa_out_w')::(varchar(10) IS NOT NULL AND (varchar(10))::text <> '')) and (current_setting('execucao_prescricao_pck.ie_glosa_out_w')::varchar(10) in ('G', 'T', 'D', 'T')) then
			if (current_setting('execucao_prescricao_pck.ds_mensagem_parametro_w')::(varchar(255) IS NOT NULL AND (varchar(255))::text <> '')) then
				CALL execucao_prescricao_pck.gerar_w_execucao_proc_mat(nr_atendimento_p, wheb_mensagem_pck.get_texto(181852, 'DS_MSG='|| current_setting('execucao_prescricao_pck.ds_mensagem_parametro_w')::varchar(255)), wheb_mensagem_pck.get_texto(1046161, 'NR_PARAMETRO='||'144/217;DS_REGRA='||''), 'N', null, cd_material_p, null, nm_usuario_p);
			else
				CALL execucao_prescricao_pck.gerar_w_execucao_proc_mat(nr_atendimento_p, wheb_mensagem_pck.get_texto(181853), wheb_mensagem_pck.get_texto(1046161, 'NR_PARAMETRO='||'144;DS_REGRA='||''), 'N', null, cd_material_p, null, nm_usuario_p);
			end if;
		end if;
		
		if (current_setting('execucao_prescricao_pck.ie_msg_glosa_exclusao_w')::varchar(1) = 'S') and (current_setting('execucao_prescricao_pck.ie_glosa_out_w')::varchar(10) = 'E') and (current_setting('execucao_prescricao_pck.cd_motivo_exc_out_w')::(bigint IS NOT NULL AND bigint::text <> '')) then
			
			select	max(ds_motivo_exc_conta)
			into STRICT	current_setting('execucao_prescricao_pck.ds_motivo_exc_conta_w')::motivo_exc_conta.ds_motivo_exc_conta%type
			from	motivo_exc_conta
			where	cd_motivo_exc_conta = current_setting('execucao_prescricao_pck.cd_motivo_exc_out_w')::bigint;
			
			CALL execucao_prescricao_pck.gerar_w_execucao_proc_mat(nr_atendimento_p, wheb_mensagem_pck.get_texto(181871, 'DS_MOTIVO='||current_setting('execucao_prescricao_pck.ds_motivo_exc_conta_w')::motivo_exc_conta.ds_motivo_exc_conta%type), null, 'N', null, cd_material_p, null, nm_usuario_p);
		end if;
	end if;
	
	/*
		if	(ie_permite_fracionado_w = 'N') and
			() then
if (DataSet.Active) and
   (DMGeral_dm.Obter_Parametro(24, 88) = 'N') and
   (Uvar.Varcd_funcao_ativa = 24) and
   (Atepac_qm.Material_Atend_Paciente_q.FieldByName('qt_material').AsFloat <> round(Atepac_qm.Material_Atend_Paciente_q.FieldByName('qt_material').AsFloat)) then
   begin
   AtePac_qm.Material_Atend_Paciente_q.cancel;
   Exibir_Erro_Abortar('Nao e possivel executar uma quantidade fracionada Parametro [88]');
   end;
		
		end if;
		*/

	if (ie_acao_executada_p = 1) and (current_setting('execucao_prescricao_pck.ie_parametro_166_w')::varchar(1) = 'S') and (ie_conta_paciente_p = 'N') and (ie_atualiza_estoque_p = 'S') then
		CALL gerar_prescricao_estoque(
					wheb_usuario_pck.get_cd_estabelecimento,
					nr_atendimento_p,
					dt_entrada_unidade_p,
					cd_material_p,
					dt_atendimento_p,
					'1',
					cd_local_estoque_p,
					qt_material_p,
					cd_setor_atendimento_p,
					cd_unidade_medida_p,
					nm_usuario_p,
					'I',
					null,
					null,
					null,
					0,
					null,
					null,
					0,
					0,
					null,
					0,
					null,
					null,
					null);
	/*
	DataSet.Cancel;
	Abort;
	*/

	end if;
	
	if (current_setting('execucao_prescricao_pck.ie_parametro_169_w')::varchar(1) = 'N') then
		select	count(1)
		into STRICT	current_setting('execucao_prescricao_pck.qt_existe_w')::bigint
		from	conversao_material_convenio
		where	cd_convenio = cd_convenio_p;
		if (current_setting('execucao_prescricao_pck.qt_existe_w')::bigint > 0) then
			if (coalesce(obter_codigo_item_convenio(cd_convenio_p, 2, cd_material_p, null, 'N', null, null, null), cd_material_p) = cd_material_p) then
				ie_erro_p := 'S';
				CALL execucao_prescricao_pck.gerar_w_execucao_proc_mat(nr_atendimento_p, wheb_mensagem_pck.get_texto(181898), wheb_mensagem_pck.get_texto(1046161, 'NR_PARAMETRO='||'169;DS_REGRA='||''), 'S', null, cd_material_p, null, nm_usuario_p);
				goto Final;
			end if;
		end if;
	end if;
	
	PERFORM set_config('execucao_prescricao_pck.ie_atualiza_auditoria_w', 'N', false);
	
	if (ie_acao_executada_p = 1) and (ie_auditoria_p = 'S') then
		select	coalesce(max(ie_calcular_mat_auditado), 'S')
		into STRICT	current_setting('execucao_prescricao_pck.ie_calcular_mat_auditado_w')::parametro_faturamento.ie_calcular_mat_auditado%type
		from	parametro_faturamento
		where	cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento;
		
		if (current_setting('execucao_prescricao_pck.ie_calcular_mat_auditado_w')::parametro_faturamento.ie_calcular_mat_auditado%type = 'N') then
			ie_auditoria_p := 'N';
			PERFORM set_config('execucao_prescricao_pck.ie_atualiza_auditoria_w', 'S', false);
		end if;
	end if;
	
	if (coalesce(cd_medico_prescritor_p::text, '') = '') and (obter_regra_medico_prescr_mat(null, cd_convenio_p, cd_material_p, cd_setor_atendimento_p) = 'S') then
		ie_erro_p := 'S';
		CALL execucao_prescricao_pck.gerar_w_execucao_proc_mat(nr_atendimento_p, wheb_mensagem_pck.get_texto(181907), null, 'S', null, cd_material_p, null, nm_usuario_p);
		goto Final;
	end if;
	
	if (ie_acao_executada_p in (1,2)) and
		((current_setting('execucao_prescricao_pck.ie_parametro_24_w')::varchar(1) = 'S') or
		((current_setting('execucao_prescricao_pck.ie_parametro_24_w')::varchar(1) = 'E') and (ie_tipo_atendimento_p = 7))) and (coalesce(nr_seq_proc_princ_p::text, '') = '') then
		ie_erro_p := 'S';
		CALL execucao_prescricao_pck.gerar_w_execucao_proc_mat(nr_atendimento_p, wheb_mensagem_pck.get_texto(180468), wheb_mensagem_pck.get_texto(1046161, 'NR_PARAMETRO='||'24;DS_REGRA='||''), 'S', null, cd_material_p, null, nm_usuario_p);
		goto Final;
	end if;
	
	<<Final>>
	
	PERFORM set_config('execucao_prescricao_pck.qt_existe_w', 0, false);
	
	end;
	

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE execucao_prescricao_pck.material_atend_pac_before_post ( ie_acao_executada_p bigint, nr_sequencia_p bigint, nr_atendimento_p bigint, nr_doc_convenio_p text, ie_barras_p text, dt_atendimento_p timestamp, cd_setor_atendimento_p bigint, cd_setor_atend_user_p bigint, cd_cgc_fornecedor_p text, cd_cgc_prestador_p text, nr_seq_atepacu_p bigint, cd_local_estoque_p bigint, cd_acao_p text, nr_sequencia_prescricao_p bigint, nr_prescricao_p bigint, nr_serie_material_p text, dt_entrada_p timestamp, dt_alta_p timestamp, nr_seq_baixa_param_p bigint, cd_convenio_cat_p bigint, cd_plano_cat_p text, cd_categoria_cat_p text, ie_tipo_atendimento_p bigint, ie_conta_paciente_p text, ie_atualiza_estoque_p text, dt_entrada_unidade_p timestamp, cd_unidade_medida_p text, cd_medico_prescritor_p text, ie_auditoria_p INOUT text, cd_material_p INOUT bigint, cd_material_exec_p INOUT bigint, cd_convenio_p INOUT bigint, cd_categoria_p INOUT text, qt_material_p INOUT bigint, nr_interno_conta_p INOUT bigint, ie_valor_informado_p INOUT text, cd_motivo_exc_conta_p INOUT bigint, ds_compl_motivo_excon_p INOUT text, cd_proced_referencia_p INOUT text, nr_seq_proc_princ_p INOUT bigint, ds_observacao_p INOUT text, nr_seq_tipo_baixa_p INOUT bigint, ie_erro_p INOUT text, nm_usuario_p text, ie_acao_justif_p INOUT text) FROM PUBLIC;
