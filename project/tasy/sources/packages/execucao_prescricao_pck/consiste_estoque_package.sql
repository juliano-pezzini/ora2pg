-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION execucao_prescricao_pck.consiste_estoque ( cd_local_estoque_barras_p bigint, cd_kit_p bigint, cd_setor_atend_unidade_p bigint, cd_material_p bigint, ie_atualiza_estoque_p text, qt_material_p bigint, cd_cgc_fornecedor_p text, nr_seq_lote_fornec_p bigint, nr_atendimento_p bigint, nm_usuario_p text) RETURNS varchar AS $body$
DECLARE

	
	ie_local_invalido_w		varchar(1) := 'N';
	current_setting('execucao_prescricao_pck.ie_parametro_239_w')::varchar(1)		varchar(1);
	ie_baixa_estoque_w		varchar(1);
	ie_local_valido_w		varchar(1);
	ie_estoque_disp_w		varchar(1);
	current_setting('execucao_prescricao_pck.ds_mensagem_w')::varchar(255)			varchar(255) := '';
	
	
BEGIN
	
	obter_param_usuario(24, 239, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, current_setting('execucao_prescricao_pck.ie_parametro_239_w')::varchar(1));
	obter_param_usuario(24, 13, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, current_setting('execucao_prescricao_pck.ie_parametro_13_w')::varchar(1));

	select	count(1)
	into STRICT	current_setting('execucao_prescricao_pck.qt_existe_w')::bigint
	from	regra_setor_estoque_kit
	where	cd_setor_atendimento = cd_setor_atend_unidade_p;

	if (cd_kit_p <> 0) and
		((current_setting('execucao_prescricao_pck.ie_parametro_239_w')::varchar(1) = 'B') or
		((current_setting('execucao_prescricao_pck.ie_parametro_239_w')::varchar(1) = 'R') and (current_setting('execucao_prescricao_pck.qt_existe_w')::bigint > 0))) then
		ie_baixa_estoque_w := 'N';
	else
		select	coalesce(max(ie_baixa_estoque),'S')
		into STRICT	ie_baixa_estoque_w
		from	componente_kit
		where	cd_kit_material = cd_kit_p
		and		cd_material     = cd_material_p;
	end if;
	
	if (cd_local_estoque_barras_p IS NOT NULL AND cd_local_estoque_barras_p::text <> '') and
		((ie_atualiza_estoque_p = 'S') or (substr(obter_se_material_baixa_prescr(wheb_usuario_pck.get_cd_estabelecimento, cd_local_estoque_barras_p, cd_material_p),1,1) = 'S')) and (ie_baixa_estoque_w = 'S') then
		begin
		obter_local_valido(
					wheb_usuario_pck.get_cd_estabelecimento,
					cd_local_estoque_barras_p,
					cd_material_p,
					'',
					ie_local_valido_w);
		if (ie_local_valido_w = 'N') then
			ie_local_invalido_w := 'N';
			PERFORM set_config('execucao_prescricao_pck.ds_mensagem_w', wheb_mensagem_pck.get_texto(318146), false);
		elsif (current_setting('execucao_prescricao_pck.ie_parametro_13_w')::varchar(1) <> 'S') and (substr(obter_se_baixa_estoque_pac(cd_setor_atend_unidade_p, cd_material_p),1,2) = 'S') then
			obter_disp_estoque(	
							cd_material_p,
							cd_local_estoque_barras_p,
							wheb_usuario_pck.get_cd_estabelecimento,
							0,
							qt_material_p,
							cd_cgc_fornecedor_p,
							ie_estoque_disp_w,
							nr_seq_lote_fornec_p);
			if (ie_estoque_disp_w = 'N') then
				PERFORM set_config('execucao_prescricao_pck.ds_mensagem_w', wheb_mensagem_pck.get_texto(182527, 'CD='|| cd_material_p), false);
				
				if (obter_se_material_bloqueio_inv(wheb_usuario_pck.get_cd_estabelecimento, cd_material_p, cd_local_estoque_barras_p) = 'S') then
					PERFORM set_config('execucao_prescricao_pck.ds_mensagem_w', wheb_mensagem_pck.get_texto(182506, 'CD='|| cd_material_p), false);
				end if;
			end if;
		end if;
		
		exception
		when others then
			PERFORM set_config('execucao_prescricao_pck.ds_mensagem_w', wheb_mensagem_pck.get_texto(181585, 'CD='|| cd_material_p), false);			
		end;
	end if;
	
	if (current_setting('execucao_prescricao_pck.ds_mensagem_w')::(varchar(255) IS NOT NULL AND (varchar(255))::text <> '')) then
		CALL gerar_log_atend_estoque_hist(
						nm_usuario_p,
						nr_atendimento_p,
						cd_material_p,
						current_setting('execucao_prescricao_pck.ds_mensagem_w')::varchar(255));
	end if;
	
	return current_setting('execucao_prescricao_pck.ds_mensagem_w')::varchar(255);
	
	end;
	

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION execucao_prescricao_pck.consiste_estoque ( cd_local_estoque_barras_p bigint, cd_kit_p bigint, cd_setor_atend_unidade_p bigint, cd_material_p bigint, ie_atualiza_estoque_p text, qt_material_p bigint, cd_cgc_fornecedor_p text, nr_seq_lote_fornec_p bigint, nr_atendimento_p bigint, nm_usuario_p text) FROM PUBLIC;
