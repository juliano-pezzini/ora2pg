-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE execucao_prescricao_pck.consiste_preco ( ie_tipo_p bigint, nr_atendimento_p bigint, cd_convenio_p bigint, cd_categoria_p text, cd_funcao_medico_p text, nr_seq_exame_p bigint, dt_conta_p timestamp, cd_setor_atendimento_p bigint, cd_procedimento_p bigint, ie_origem_proced_p bigint, ie_tipo_atendimento_p bigint, nr_seq_proc_interno_p bigint, nr_seq_grupo_rec_p bigint, dt_execucao_p timestamp, nr_seq_classificacao_p bigint, ie_acao_executada_p bigint, ie_funcao_medico_p text, cd_medico_executor_p text, nm_usuario_p text, ie_erro_p INOUT text) AS $body$
DECLARE

	nr_anos_w	integer;
	nr_seq_origem_w	bigint;
	vl_procedimento_w	procedimento_paciente.vl_procedimento%type;
	
	
BEGIN
	
	select	max(nr_anos)
	into STRICT	nr_anos_w
	from	atendimento_paciente_v
	where	nr_atendimento = nr_atendimento_p;
	
	if (ie_tipo_p = 1) then
		PERFORM set_config('execucao_prescricao_pck.qt_existe_w', 0, false);
	elsif (ie_tipo_p = 2) then
		nr_seq_origem_w := obter_dados_categ_conv(nr_atendimento_p, 'OC');
		if (coalesce(nr_seq_origem_w::text, '') = '') then
			nr_seq_origem_w := 0;
		end if;
		define_preco_procedimento(get_estabelecimento, cd_convenio_p, cd_categoria_p, dt_conta_p, cd_procedimento_p,
			0, ie_tipo_atendimento_p, cd_setor_atendimento_p, cd_medico_executor_p, cd_funcao_medico_p, null, nr_seq_exame_p,
			nr_seq_proc_interno_p, null, null, null, null, null, vl_procedimento_w, current_setting('execucao_prescricao_pck.nr_sem_ret_proc_w')::bigint, current_setting('execucao_prescricao_pck.nr_sem_ret_proc_w')::bigint, current_setting('execucao_prescricao_pck.nr_sem_ret_proc_w')::bigint,
			current_setting('execucao_prescricao_pck.nr_sem_ret_proc_w')::bigint, current_setting('execucao_prescricao_pck.nr_sem_ret_proc_w')::bigint, current_setting('execucao_prescricao_pck.nr_sem_ret_proc_w')::bigint, current_setting('execucao_prescricao_pck.nr_sem_ret_proc_w')::bigint, current_setting('execucao_prescricao_pck.nr_sem_ret_proc_w')::bigint, current_setting('execucao_prescricao_pck.nr_sem_ret_proc_w')::bigint, current_setting('execucao_prescricao_pck.nr_sem_ret_proc_w')::bigint,
			current_setting('execucao_prescricao_pck.nr_sem_ret_proc_w')::bigint, current_setting('execucao_prescricao_pck.nr_sem_ret_proc_w')::bigint, current_setting('execucao_prescricao_pck.nr_sem_ret_proc_w')::bigint, current_setting('execucao_prescricao_pck.nr_sem_ret_proc_w')::bigint, current_setting('execucao_prescricao_pck.ds_sem_ret_proc_w')::varchar(255), current_setting('execucao_prescricao_pck.nr_sem_ret_proc_w')::bigint, null,
			null, null, null, null, null, null, null, null, null, null, null, null, null, null, nr_seq_grupo_rec_p, null, nr_seq_origem_w, null, null);
			
		if (vl_procedimento_w <= 0) then
			ie_erro_p := 'S';
			CALL execucao_prescricao_pck.gerar_w_execucao_proc_mat(nr_atendimento_p, wheb_mensagem_pck.get_texto(177938), null, 'S', cd_procedimento_p, null, ie_origem_proced_p, nm_usuario_p);
		end if;
	elsif (ie_tipo_p = 3) then
		nr_seq_origem_w := obter_dados_categ_conv(nr_atendimento_p, 'OC');
		if (coalesce(nr_seq_origem_w::text, '') = '') then
			nr_seq_origem_w := 0;
		end if;
		
		define_preco_servico(get_estabelecimento, cd_convenio_p, cd_categoria_p, dt_execucao_p, cd_procedimento_p, cd_setor_atendimento_p,
			ie_tipo_atendimento_p, 0, null, null, null, null, null, vl_procedimento_w, current_setting('execucao_prescricao_pck.nr_sem_ret_proc_w')::bigint, null, null, null, null, null, null, null,
			null, null, null, nr_seq_grupo_rec_p, nr_seq_origem_w, null, null);	
		if (vl_procedimento_w <= 0) then
			ie_erro_p := 'S';
			CALL execucao_prescricao_pck.gerar_w_execucao_proc_mat(nr_atendimento_p, wheb_mensagem_pck.get_texto(177939), null, 'S', cd_procedimento_p, null, ie_origem_proced_p, nm_usuario_p);
		end if;
	end if;
	end;
	

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE execucao_prescricao_pck.consiste_preco ( ie_tipo_p bigint, nr_atendimento_p bigint, cd_convenio_p bigint, cd_categoria_p text, cd_funcao_medico_p text, nr_seq_exame_p bigint, dt_conta_p timestamp, cd_setor_atendimento_p bigint, cd_procedimento_p bigint, ie_origem_proced_p bigint, ie_tipo_atendimento_p bigint, nr_seq_proc_interno_p bigint, nr_seq_grupo_rec_p bigint, dt_execucao_p timestamp, nr_seq_classificacao_p bigint, ie_acao_executada_p bigint, ie_funcao_medico_p text, cd_medico_executor_p text, nm_usuario_p text, ie_erro_p INOUT text) FROM PUBLIC;
