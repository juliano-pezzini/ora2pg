-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE execucao_prescricao_pck.devolucao_material_barras ( nr_atendimento_p INOUT bigint, cd_kit_p INOUT bigint, cd_local_estoque_barras_p INOUT bigint, cd_setor_atend_unidade_p INOUT bigint, cd_material_p INOUT bigint, cd_material_exec_p INOUT bigint, ie_atualiza_estoque_p INOUT text, qt_material_p INOUT bigint, cd_cgc_fornecedor_p INOUT text, nr_seq_lote_fornec_p INOUT bigint, dt_atendimento_p INOUT timestamp, ie_conta_paciente_p INOUT text, cd_tipo_baixa_p INOUT text, dt_entrada_unidade_p INOUT timestamp, nr_seq_atepacu_p INOUT bigint, vl_unitario_p INOUT bigint, qt_ajuste_conta_p INOUT bigint, ie_valor_informado_p INOUT text, ie_guia_informada_p INOUT text, ie_auditoria_p INOUT text, nm_usuario_original_p INOUT text, nr_seq_proc_princ_p INOUT bigint, cd_situacao_glosa_p INOUT bigint, cd_acao_p INOUT text, nr_interno_conta_p INOUT bigint, nr_interno_chamada_p INOUT bigint, cd_motivo_exc_conta_p INOUT bigint, ds_compl_motivo_excon_p INOUT text, cd_proced_referencia_p INOUT text, ds_observacao_p INOUT text, nr_seq_tipo_baixa_p INOUT bigint, nr_doc_convenio_p INOUT bigint, ds_result_p INOUT text, dt_conta_p INOUT timestamp, nr_seq_cor_exec_p INOUT bigint, cd_motivo_devolucao_p INOUT bigint, qt_executada_p INOUT bigint, nr_doc_interno_p INOUT bigint, nr_seq_devol_exec_p INOUT bigint, qt_devolvida_p INOUT bigint, cd_convenio_p INOUT bigint, cd_categoria_p INOUT text, --nr_seq_motivo_audit_p		in out number,

											--nr_seq_audit_chamada_p		in out number,
 nr_seq_kit_estoque_p bigint, dt_fim_auditoria_p timestamp default null, nr_seq_doacao_chamada_p bigint DEFAULT NULL, nr_seq_reserva_chamada_p bigint DEFAULT NULL, nr_seq_transfusao_chamada_p bigint DEFAULT NULL, nm_usuario_atend_far_p text DEFAULT NULL, nm_usuario_atend_enf_p text DEFAULT NULL, cd_plano_cat_p text DEFAULT NULL, cd_cgc_prestador_p text DEFAULT NULL, cd_local_estoque_p bigint DEFAULT NULL, nr_sequencia_prescricao_p bigint DEFAULT NULL, nr_prescricao_p bigint DEFAULT NULL, nr_serie_material_p text DEFAULT NULL, dt_entrada_p timestamp default null, nr_seq_baixa_param_p bigint DEFAULT NULL, ie_tipo_atendimento_p bigint DEFAULT NULL, cd_unidade_medida_p text DEFAULT NULL, cd_medico_prescritor_p text DEFAULT NULL, cd_setor_atend_user_p bigint DEFAULT NULL, nr_seq_proc_chamada_p bigint DEFAULT NULL, ie_barras_p text DEFAULT NULL, nm_usuario_retirada_p text DEFAULT NULL, dt_alta_p timestamp default null, ds_justificativa_p text DEFAULT NULL, nr_seq_proc_princ_mat_p bigint DEFAULT NULL, nm_usuario_p text DEFAULT NULL) AS $body$
DECLARE

	
	current_setting('execucao_prescricao_pck.cd_local_estoque_w')::local_estoque.cd_local_estoque%type movimento_estoque.cd_local_estoque%type;
	ie_parametro_75_w		varchar(1);
	ds_material_w			varchar(255);
	ie_estoque_lote_w		material_estab.ie_estoque_lote%type;
	
	
BEGIN
	
	PERFORM set_config('execucao_prescricao_pck.ds_erro_w', null, false);
	
	if (cd_local_estoque_p = 0) then
		PERFORM set_config('execucao_prescricao_pck.cd_local_estoque_w', null, false);
	else
		PERFORM set_config('execucao_prescricao_pck.cd_local_estoque_w', cd_local_estoque_p, false);
	end if;
	
	obter_param_usuario(24, 75, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, ie_parametro_75_w);
	
	if (ie_parametro_75_w <> 'N') then
		consistir_qt_devol_mat_conta(nr_atendimento_p, nr_seq_atepacu_p, cd_material_p, (qt_material_p*-1), cd_setor_atend_unidade_p, ie_parametro_75_w, current_setting('execucao_prescricao_pck.ds_erro_w')::varchar(2000));
		if (current_setting('execucao_prescricao_pck.ds_erro_w')::(varchar(2000) IS NOT NULL AND (varchar(2000))::text <> '')) then
			select	max(ds_material)
			into STRICT	ds_material_w
			from	material
			where	cd_material = cd_material_p;			
			CALL execucao_prescricao_pck.gerar_w_execucao_proc_mat(nr_atendimento_p, current_setting('execucao_prescricao_pck.ds_erro_w')::varchar(2000), wheb_mensagem_pck.get_texto(181406, 'DS_MATERIAL='||ds_material_w), 'S', null, cd_material_p, null, nm_usuario_p);
			goto Final;
		end if;
	end if;
	
	select	coalesce(max(b.ie_estoque_lote),'N')
	into STRICT	ie_estoque_lote_w
	from	material a,
			material_estab b
	where 	a.cd_material = b.cd_material
	and 	a.cd_material = cd_material_p
	and 	b.cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento;

	if (nr_seq_lote_fornec_p IS NOT NULL AND nr_seq_lote_fornec_p::text <> '') and (coalesce(cd_cgc_fornecedor_p::text, '') = '') and (ie_estoque_lote_w = 'S') then
        select obter_dados_lote_fornec(nr_seq_lote_fornec_p,'CF')
        into STRICT cd_cgc_fornecedor_p
;
    end if;

	select	nextval('material_atend_paciente_seq')
	into STRICT	current_setting('execucao_prescricao_pck.nr_sequencia_w')::bigint
	;
	
	SELECT * FROM execucao_prescricao_pck.material_atend_pac_new_record(
				nr_atendimento_p, dt_atendimento_p, dt_entrada_unidade_p, nr_seq_atepacu_p, cd_setor_atend_unidade_p, cd_convenio_p, cd_categoria_p, current_setting('execucao_prescricao_pck.nr_doc_convenio_w')::atend_categoria_convenio.nr_doc_convenio%type, current_setting('execucao_prescricao_pck.ie_tipo_guia_w')::atend_categoria_convenio.ie_tipo_guia%type, current_setting('execucao_prescricao_pck.cd_senha_w')::atend_categoria_convenio.cd_senha%type, cd_acao_p, vl_unitario_p, qt_ajuste_conta_p, ie_valor_informado_p, ie_guia_informada_p, ie_auditoria_p, nm_usuario_original_p, nr_seq_proc_princ_p, cd_situacao_glosa_p, dt_conta_p, current_setting('execucao_prescricao_pck.nr_sequencia_w')::bigint, cd_convenio_p, nr_seq_proc_chamada_p, cd_categoria_p, cd_material_p, 'S', dt_alta_p, dt_atendimento_p, dt_fim_auditoria_p, nm_usuario_p, current_setting('execucao_prescricao_pck.ie_erro_w')::varchar(1)) INTO STRICT
				nr_atendimento_p, dt_atendimento_p, dt_entrada_unidade_p, nr_seq_atepacu_p, cd_setor_atend_unidade_p, cd_convenio_p, cd_categoria_p, current_setting('execucao_prescricao_pck.nr_doc_convenio_w')::atend_categoria_convenio.nr_doc_convenio%type, current_setting('execucao_prescricao_pck.ie_tipo_guia_w')::atend_categoria_convenio.ie_tipo_guia%type, current_setting('execucao_prescricao_pck.cd_senha_w')::atend_categoria_convenio.cd_senha%type, cd_acao_p, vl_unitario_p, qt_ajuste_conta_p, ie_valor_informado_p, ie_guia_informada_p, ie_auditoria_p, nm_usuario_original_p, nr_seq_proc_princ_p, cd_situacao_glosa_p, dt_conta_p, current_setting('execucao_prescricao_pck.ie_erro_w')::varchar(1);
				
	select	count(1)
	into STRICT	current_setting('execucao_prescricao_pck.qt_existe_w')::bigint
	from	w_execucao_proc_mat
	where	nr_atendimento = nr_atendimento_p
	and		cd_material = cd_material_p
	and		nm_usuario	= nm_usuario_p
	and		ie_aborta = 'S';
	
	if (current_setting('execucao_prescricao_pck.qt_existe_w')::bigint > 0) then
		goto Final;
	end if;
	
	if (coalesce(nr_interno_chamada_p, 0) > 0) then
		nr_interno_conta_p := nr_interno_chamada_p;
	end if;
	
	if (coalesce(nr_prescricao_p, 0) > 0) then
		if (current_setting('execucao_prescricao_pck.ie_parametro_142_w')::varchar(1) = 'S') then
			select	max(nr_doc_conv)
			into STRICT	current_setting('execucao_prescricao_pck.nr_doc_convenio_w')::atend_categoria_convenio.nr_doc_convenio%type
			from	prescr_medica
			where	nr_prescricao = nr_prescricao_p;
		elsif (current_setting('execucao_prescricao_pck.ie_parametro_142_w')::varchar(1) = 'P') then
			select	max(nr_doc_convenio)
			into STRICT	current_setting('execucao_prescricao_pck.nr_doc_convenio_w')::atend_categoria_convenio.nr_doc_convenio%type
			from	prescr_procedimento
			where	nr_prescricao = nr_prescricao_p;
		elsif (current_setting('execucao_prescricao_pck.ie_parametro_142_w')::varchar(1) = 'P') then
			select	max(a.nr_doc_convenio)
			into STRICT	current_setting('execucao_prescricao_pck.nr_doc_convenio_w')::atend_categoria_convenio.nr_doc_convenio%type
			from	procedimento_paciente a
			where	a.nr_sequencia = nr_seq_proc_chamada_p;
		end if;
	end if;
	
	if (current_setting('execucao_prescricao_pck.ie_parametro_54_w')::varchar(1) <> 'N') then
		PERFORM set_config('execucao_prescricao_pck.nr_prescricao_w', nr_prescricao_p, false);
		PERFORM set_config('execucao_prescricao_pck.nr_sequencia_prescricao_w', nr_sequencia_prescricao_p, false);
	end if;	
	
	if (nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '') then
		PERFORM set_config('execucao_prescricao_pck.cd_material_prescricao_w', cd_material_p, false);
	else
		PERFORM set_config('execucao_prescricao_pck.cd_material_prescricao_w', null, false);
	end if;
	
	if (coalesce(nr_doc_convenio_p, 0) > 0) then
		PERFORM set_config('execucao_prescricao_pck.nr_doc_convenio_w', nr_doc_convenio_p, false);
	end if;
	
	if (current_setting('execucao_prescricao_pck.ie_parametro_249_w')::varchar(1) = 'S') and (nm_usuario_retirada_p IS NOT NULL AND nm_usuario_retirada_p::text <> '') then
		PERFORM set_config('execucao_prescricao_pck.nm_usuario_retirada_w', nm_usuario_retirada_p, false);
	end if;
	
	if (coalesce(cd_kit_p,0) <> 0) then
		ds_observacao_p := wheb_mensagem_pck.get_texto(182619, 'CD_PERFIL_ATIVO='||obter_perfil_ativo||';CD_FUNCAO_ATIVA=24;CD_SETOR='||cd_setor_atend_unidade_p||';CD_SETOR_ATENDIMENTO='||cd_setor_atend_user_p||';CD_KIT='||cd_kit_p);		
	end if;
	
	if (current_setting('execucao_prescricao_pck.ie_parametro_155_w')::varchar(1) <> 'N') and (nr_seq_proc_princ_mat_p IS NOT NULL AND nr_seq_proc_princ_mat_p::text <> '') then
		PERFORM set_config('execucao_prescricao_pck.nr_seq_proc_princ_w', nr_seq_proc_princ_mat_p, false);
		if (current_setting('execucao_prescricao_pck.ie_parametro_82_w')::varchar(1) = 'S') and (current_setting('execucao_prescricao_pck.nr_doc_convenio_w')::atend_categoria_convenio.nr_doc_convenio%coalesce(type::text, '') = '') then
			if (substr(obter_doc_conv_prescr_proc(nr_seq_proc_princ_mat_p),1,30) is not null) then
				PERFORM set_config('execucao_prescricao_pck.nr_doc_convenio_w', substr(obter_doc_conv_prescr_proc(nr_seq_proc_princ_mat_p),1,30), false);
			end if;
		end if;
	end if;
	
	select	max(ie_via_aplicacao)
	into STRICT	current_setting('execucao_prescricao_pck.ie_via_aplicacao_w')::material_atend_paciente.ie_via_aplicacao%type
	from	material
	where	cd_material = cd_material_p;
	
	SELECT * FROM execucao_prescricao_pck.material_atend_pac_before_post(	
						1, current_setting('execucao_prescricao_pck.nr_sequencia_w')::bigint, nr_atendimento_p, current_setting('execucao_prescricao_pck.nr_doc_convenio_w')::atend_categoria_convenio.nr_doc_convenio%type, 'S', dt_atendimento_p, cd_setor_atend_unidade_p, cd_setor_atend_user_p, cd_cgc_fornecedor_p, cd_cgc_prestador_p, nr_seq_atepacu_p, current_setting('execucao_prescricao_pck.cd_local_estoque_w')::local_estoque.cd_local_estoque%type, cd_acao_p, nr_sequencia_prescricao_p, nr_prescricao_p, nr_serie_material_p, dt_entrada_p, dt_alta_p, nr_seq_baixa_param_p, cd_convenio_p, cd_plano_cat_p, cd_categoria_p, ie_tipo_atendimento_p, ie_conta_paciente_p, ie_atualiza_estoque_p, dt_entrada_unidade_p, cd_unidade_medida_p, cd_medico_prescritor_p, ie_auditoria_p, cd_material_p, cd_material_exec_p, cd_convenio_p, cd_categoria_p, qt_material_p, nr_interno_conta_p, ie_valor_informado_p, cd_motivo_exc_conta_p, ds_compl_motivo_excon_p, cd_proced_referencia_p, nr_seq_proc_princ_p, ds_observacao_p, nr_seq_tipo_baixa_p, current_setting('execucao_prescricao_pck.ie_erro_w')::varchar(1), nm_usuario_p, current_setting('execucao_prescricao_pck.ie_acao_justif_w')::varchar(1)) INTO STRICT ie_auditoria_p, cd_material_p, cd_material_exec_p, cd_convenio_p, cd_categoria_p, qt_material_p, nr_interno_conta_p, ie_valor_informado_p, cd_motivo_exc_conta_p, ds_compl_motivo_excon_p, cd_proced_referencia_p, nr_seq_proc_princ_p, ds_observacao_p, nr_seq_tipo_baixa_p, current_setting('execucao_prescricao_pck.ie_erro_w')::varchar(1), current_setting('execucao_prescricao_pck.ie_acao_justif_w')::varchar(1);

	select	count(1)
	into STRICT	current_setting('execucao_prescricao_pck.qt_existe_w')::bigint
	from	w_execucao_proc_mat
	where	nr_atendimento = nr_atendimento_p
	and		cd_material = cd_material_p
	and		nm_usuario	= nm_usuario_p
	and		ie_aborta = 'S';
	
	if (current_setting('execucao_prescricao_pck.qt_existe_w')::bigint > 0) then
		goto Final;
	end if;

	insert into material_atend_paciente(
			nr_sequencia,
			cd_material,
			cd_material_exec,
			nr_atendimento,
			dt_entrada_unidade,
			dt_atendimento,
			dt_conta,
			cd_unidade_medida,
			qt_material,
			dt_atualizacao,
			nm_usuario,
			cd_acao,
			nr_seq_atepacu,
			nm_usuario_retirante,
			nr_doc_convenio,
			nr_prescricao,
			nr_sequencia_prescricao,
			cd_material_prescricao,
			nr_interno_conta,
			cd_medico_prescritor,
			cd_cgc_fornecedor,
			nr_seq_cor_exec,
			cd_setor_atendimento,
			nr_seq_lote_fornec,
			cd_kit_material,
			ds_observacao,
			nr_seq_proc_princ,
			nm_usuario_atend_enf,
			nm_usuario_atend_far,
			nr_seq_doacao,
			nr_seq_reserva,
			nr_seq_transfusao,
			ds_justificativa,
			ie_via_aplicacao,
			cd_motivo_devolucao,
			qt_executada,
			nr_doc_interno,
			nr_seq_devol_exec,
			cd_local_estoque,
			qt_devolvida,
			nr_seq_kit_estoque,
			cd_convenio,
			cd_categoria)
	values (	current_setting('execucao_prescricao_pck.nr_sequencia_w')::bigint,
			cd_material_p,
			cd_material_exec_p,
			nr_atendimento_p,
			dt_entrada_unidade_p,
			dt_atendimento_p,
			dt_conta_p,
			cd_unidade_medida_p,
			qt_material_p,
			clock_timestamp(),
			nm_usuario_p,
			cd_acao_p,
			nr_seq_atepacu_p,
			current_setting('execucao_prescricao_pck.nm_usuario_retirada_w')::material_atend_paciente.nm_usuario_retirante%type,
			current_setting('execucao_prescricao_pck.nr_doc_convenio_w')::atend_categoria_convenio.nr_doc_convenio%type,
			current_setting('execucao_prescricao_pck.nr_prescricao_w')::prescr_medica.nr_prescricao%type,
			current_setting('execucao_prescricao_pck.nr_sequencia_prescricao_w')::prescr_material.nr_sequencia%type,
			current_setting('execucao_prescricao_pck.cd_material_prescricao_w')::material_atend_paciente.cd_material_prescricao%type,
			nr_interno_conta_p,
			cd_medico_prescritor_p,
			cd_cgc_fornecedor_p,
			nr_seq_cor_exec_p,
			cd_setor_atend_unidade_p,
			nr_seq_lote_fornec_p,
			cd_kit_p,
			SUBSTR(ds_observacao_p,1,255),
			current_setting('execucao_prescricao_pck.nr_seq_proc_princ_w')::material_atend_paciente.nr_seq_proc_princ%type,
			nm_usuario_atend_enf_p,
			nm_usuario_atend_far_p,
			nr_seq_doacao_chamada_p,
			nr_seq_reserva_chamada_p,
			nr_seq_transfusao_chamada_p,
			ds_justificativa_p,
			current_setting('execucao_prescricao_pck.ie_via_aplicacao_w')::material_atend_paciente.ie_via_aplicacao%type,
			cd_motivo_devolucao_p,
			qt_executada_p,
			nr_doc_interno_p,
			nr_seq_devol_exec_p,
			current_setting('execucao_prescricao_pck.cd_local_estoque_w')::local_estoque.cd_local_estoque%type,
			qt_devolvida_p,
			nr_seq_kit_estoque_p,
			cd_convenio_p,
			cd_categoria_p);
			
	SELECT * FROM execucao_prescricao_pck.material_atend_pac_after_post(
				current_setting('execucao_prescricao_pck.nr_sequencia_w')::bigint, 1, nr_atendimento_p, cd_material_p, nr_interno_conta_p, 'N', 'S', null, null, --nr_seq_audit_chamada_p,

				--nr_seq_motivo_audit_p,

				qt_material_p, ie_auditoria_p, nr_seq_cor_exec_p, current_setting('execucao_prescricao_pck.ie_selecao_lanc_autom_w')::varchar(1), current_setting('execucao_prescricao_pck.ie_necessita_justificativa_w')::varchar(1), nm_usuario_p) INTO STRICT 

				qt_material_p, ie_auditoria_p, nr_seq_cor_exec_p, current_setting('execucao_prescricao_pck.ie_selecao_lanc_autom_w')::varchar(1), current_setting('execucao_prescricao_pck.ie_necessita_justificativa_w')::varchar(1);
	
	<<Final>>
	
	PERFORM set_config('execucao_prescricao_pck.qt_existe_w', 0, false);
	
	end;


$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE execucao_prescricao_pck.devolucao_material_barras ( nr_atendimento_p INOUT bigint, cd_kit_p INOUT bigint, cd_local_estoque_barras_p INOUT bigint, cd_setor_atend_unidade_p INOUT bigint, cd_material_p INOUT bigint, cd_material_exec_p INOUT bigint, ie_atualiza_estoque_p INOUT text, qt_material_p INOUT bigint, cd_cgc_fornecedor_p INOUT text, nr_seq_lote_fornec_p INOUT bigint, dt_atendimento_p INOUT timestamp, ie_conta_paciente_p INOUT text, cd_tipo_baixa_p INOUT text, dt_entrada_unidade_p INOUT timestamp, nr_seq_atepacu_p INOUT bigint, vl_unitario_p INOUT bigint, qt_ajuste_conta_p INOUT bigint, ie_valor_informado_p INOUT text, ie_guia_informada_p INOUT text, ie_auditoria_p INOUT text, nm_usuario_original_p INOUT text, nr_seq_proc_princ_p INOUT bigint, cd_situacao_glosa_p INOUT bigint, cd_acao_p INOUT text, nr_interno_conta_p INOUT bigint, nr_interno_chamada_p INOUT bigint, cd_motivo_exc_conta_p INOUT bigint, ds_compl_motivo_excon_p INOUT text, cd_proced_referencia_p INOUT text, ds_observacao_p INOUT text, nr_seq_tipo_baixa_p INOUT bigint, nr_doc_convenio_p INOUT bigint, ds_result_p INOUT text, dt_conta_p INOUT timestamp, nr_seq_cor_exec_p INOUT bigint, cd_motivo_devolucao_p INOUT bigint, qt_executada_p INOUT bigint, nr_doc_interno_p INOUT bigint, nr_seq_devol_exec_p INOUT bigint, qt_devolvida_p INOUT bigint, cd_convenio_p INOUT bigint, cd_categoria_p INOUT text,  nr_seq_kit_estoque_p bigint, dt_fim_auditoria_p timestamp default null, nr_seq_doacao_chamada_p bigint DEFAULT NULL, nr_seq_reserva_chamada_p bigint DEFAULT NULL, nr_seq_transfusao_chamada_p bigint DEFAULT NULL, nm_usuario_atend_far_p text DEFAULT NULL, nm_usuario_atend_enf_p text DEFAULT NULL, cd_plano_cat_p text DEFAULT NULL, cd_cgc_prestador_p text DEFAULT NULL, cd_local_estoque_p bigint DEFAULT NULL, nr_sequencia_prescricao_p bigint DEFAULT NULL, nr_prescricao_p bigint DEFAULT NULL, nr_serie_material_p text DEFAULT NULL, dt_entrada_p timestamp default null, nr_seq_baixa_param_p bigint DEFAULT NULL, ie_tipo_atendimento_p bigint DEFAULT NULL, cd_unidade_medida_p text DEFAULT NULL, cd_medico_prescritor_p text DEFAULT NULL, cd_setor_atend_user_p bigint DEFAULT NULL, nr_seq_proc_chamada_p bigint DEFAULT NULL, ie_barras_p text DEFAULT NULL, nm_usuario_retirada_p text DEFAULT NULL, dt_alta_p timestamp default null, ds_justificativa_p text DEFAULT NULL, nr_seq_proc_princ_mat_p bigint DEFAULT NULL, nm_usuario_p text DEFAULT NULL) FROM PUBLIC;
