-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE execucao_prescricao_pck.baixar_material_barras ( nr_atendimento_p INOUT bigint, cd_kit_p INOUT bigint, cd_local_estoque_barras_p INOUT bigint, cd_setor_atend_unidade_p INOUT bigint, cd_material_p INOUT bigint, cd_material_exec_p INOUT bigint, ie_atualiza_estoque_p INOUT text, qt_material_p INOUT bigint, cd_cgc_fornecedor_p INOUT text, nr_seq_lote_fornec_p INOUT bigint, dt_atendimento_p INOUT timestamp, ie_conta_paciente_p INOUT text, cd_tipo_baixa_p INOUT text, dt_entrada_unidade_p INOUT timestamp, nr_seq_atepacu_p INOUT bigint, vl_unitario_p INOUT bigint, qt_ajuste_conta_p INOUT bigint, ie_valor_informado_p INOUT text, ie_guia_informada_p INOUT text, ie_auditoria_p INOUT text, nm_usuario_original_p INOUT text, nr_seq_proc_princ_p INOUT bigint, cd_situacao_glosa_p INOUT bigint, cd_acao_p INOUT text, nr_interno_conta_p INOUT bigint, nr_interno_chamada_p INOUT bigint, cd_motivo_exc_conta_p INOUT bigint, ds_compl_motivo_excon_p INOUT text, cd_proced_referencia_p INOUT text, ds_observacao_p INOUT text, nr_seq_tipo_baixa_p INOUT bigint, nr_doc_convenio_p INOUT bigint, ie_acao_justif_p INOUT text, nr_seq_mat_atend_pac_p INOUT bigint, nr_doc_interno_p bigint, ds_result_p INOUT text, dt_conta_p INOUT timestamp, dt_fim_auditoria_p timestamp default null, nr_seq_doacao_chamada_p bigint DEFAULT NULL, nr_seq_reserva_chamada_p bigint DEFAULT NULL, nr_seq_transfusao_chamada_p bigint DEFAULT NULL, nm_usuario_atend_far_p text DEFAULT NULL, nm_usuario_atend_enf_p text DEFAULT NULL, cd_plano_cat_p text DEFAULT NULL, cd_cgc_prestador_p text DEFAULT NULL, cd_local_estoque_p bigint DEFAULT NULL, nr_sequencia_prescricao_p bigint DEFAULT NULL, nr_prescricao_p INOUT bigint DEFAULT NULL, nr_serie_material_p text DEFAULT NULL, dt_entrada_p timestamp DEFAULT NULL, nr_seq_baixa_param_p bigint DEFAULT NULL, ie_tipo_atendimento_p bigint DEFAULT NULL, cd_unidade_medida_p text DEFAULT NULL, cd_medico_prescritor_p text DEFAULT NULL, cd_setor_atend_user_p bigint DEFAULT NULL, cd_convenio_wlcb_p bigint DEFAULT NULL, nr_seq_proc_chamada_p bigint DEFAULT NULL, cd_categoria_wlcb_p text DEFAULT NULL, ie_barras_p text DEFAULT NULL, nm_usuario_retirada_p text DEFAULT NULL, dt_alta_p timestamp default null, ds_justificativa_p text DEFAULT NULL, nr_seq_proc_princ_mat_p bigint DEFAULT NULL, ds_validade_p text DEFAULT NULL, nr_receita_p bigint DEFAULT NULL, nm_usuario_p text DEFAULT NULL) AS $body$
DECLARE


	current_setting('execucao_prescricao_pck.nr_sequencia_w')::bigint			material_atend_paciente.nr_sequencia%type;
	nr_doc_interno_w		material_atend_paciente.nr_doc_interno%type;
	qt_diferenca_w			bigint := 0;
	ie_continua				varchar(1)	:= 'S';
	current_setting('execucao_prescricao_pck.nr_seq_regra_w')::bigint			bigint;
	qt_estoque_proprio_w	double precision;
	qt_estoque_consignado_w	double precision;
	ie_tipo_saldo_w			varchar(1);
	total_consignado		double precision;
	cd_fornec_consignado_w	varchar(14) := cd_cgc_fornecedor_p;
	cd_fornecedor_w			varchar(14);
	qt_material_w			double precision := qt_material_p;
	ie_consignado_w			varchar(1);
	cd_unidade_medida_consumo_w	unidade_medida.cd_unidade_medida%type;
	cd_local_regra_w		varchar(15);

	ie_estoque_lote_w		material_estab.ie_estoque_lote%type := 'X';
	ie_mat_consig_lote_w	bigint;
	qt_saldo_estoque_w		double precision;
	cd_material_estoque_w 	material.cd_material_estoque%type;
	
	
BEGIN
	select	coalesce(max(IE_REGRA_SALDO_CONSIG),0)
	into STRICT	current_setting('execucao_prescricao_pck.nr_seq_regra_w')::bigint
	from	parametro_estoque
	where	cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento;
	
	select	max(a.ie_consignado),
			max(b.ie_estoque_lote),
			max(a.cd_unidade_medida_consumo)
	into STRICT	ie_consignado_w,
			ie_estoque_lote_w,
			cd_unidade_medida_consumo_w
	from	material a,
			material_estab b
	where	a.cd_material = cd_material_p
	and		b.cd_material = a.cd_material
	and 	b.cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento;

	if ie_estoque_lote_w = 'S' and ie_consignado_w = '2' then
	
		select max(t.cd_material_estoque)
		  into STRICT cd_material_estoque_w
		  from material t
		 where t.cd_material = cd_material_p;
		
		select coalesce(max(nr_seq_lote),0),
			max(cd_fornecedor)
		into STRICT ie_mat_consig_lote_w,
			cd_fornecedor_w
		from fornecedor_mat_consig_lote
		where cd_material = coalesce(cd_material_estoque_w, cd_material_p)
		and nr_seq_lote  = nr_seq_lote_fornec_p
		and cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento
		and cd_local_estoque = cd_local_estoque_p
		and dt_mesano_referencia = PKG_DATE_UTILS.start_of(clock_timestamp(), 'month', 0);

		if (ie_mat_consig_lote_w > 0) then
			qt_saldo_estoque_w := obter_saldo_disp_consig(wheb_usuario_pck.get_cd_estabelecimento,
				cd_fornec_consignado_w, cd_material_p, cd_local_estoque_p, nr_seq_lote_fornec_p);

			if (qt_saldo_estoque_w < obter_quantidade_convertida(cd_material_p, qt_material_p, cd_unidade_medida_consumo_w, 'UME')) then
				cd_fornec_consignado_w := null;
			end if;
		else
			cd_fornec_consignado_w := null;
		end if;

		PERFORM set_config('execucao_prescricao_pck.nr_seq_regra_w', 0, false);	
		
	elsif	((ie_consignado_w = '2') and (current_setting('execucao_prescricao_pck.nr_seq_regra_w')::bigint > 0)) then
		obter_fornec_consig_ambos(wheb_usuario_pck.get_cd_estabelecimento, cd_material_p,
				nr_seq_lote_fornec_p, cd_local_estoque_p, ie_tipo_saldo_w, cd_fornec_consignado_w);

	elsif (ie_consignado_w = '1' and (nr_seq_lote_fornec_p IS NOT NULL AND nr_seq_lote_fornec_p::text <> '') and coalesce(cd_fornec_consignado_w::text, '') = '') then

	obter_fornecedor_consignado(cd_material_p, trunc(clock_timestamp(), 'mm'), current_setting('execucao_prescricao_pck.cd_local_estoque_w')::local_estoque.cd_local_estoque%type, wheb_usuario_pck.get_cd_estabelecimento,
		qt_material_w, 'E', nr_atendimento_p, cd_fornec_consignado_w, ds_observacao_p, nr_seq_lote_fornec_p);
	
	end if;
	
	
	while(qt_diferenca_w > 0 or ie_continua = 'S') loop
		begin
		if	((ie_consignado_w = '2') and (current_setting('execucao_prescricao_pck.nr_seq_regra_w')::bigint > 0) and (coalesce(cd_fornec_consignado_w::text, '') = '')) then
		begin
							
			if (ie_tipo_saldo_w = 'N')then
			begin
				qt_estoque_proprio_w :=	obter_saldo_disp_estoque(wheb_usuario_pck.get_cd_estabelecimento,
																cd_material_p,
																cd_local_estoque_p,
																PKG_DATE_UTILS.start_of(clock_timestamp(), 'month', 0),
																nr_seq_lote_fornec_p);
					
					if (qt_material_w > qt_estoque_proprio_w and qt_estoque_proprio_w > 0)then
					begin							
						qt_diferenca_w 	:= qt_material_w - qt_estoque_proprio_w;
						qt_material_w 	:= qt_estoque_proprio_w;
						ie_continua 	:= 'S';	
					end;
					else
						ie_continua := 'N';
					end if;	
			end;
			elsif (ie_tipo_saldo_w = 'C')then
			begin
				select	coalesce(sum(qt_estoque),0)
				into STRICT	qt_estoque_consignado_w
				from	fornecedor_mat_consignado a
				where	a.cd_estabelecimento	= wheb_usuario_pck.get_cd_estabelecimento
				and	a.cd_local_estoque	= cd_local_estoque_p
				and	a.cd_material		= cd_material_p
				and	a.cd_fornecedor		= cd_fornec_consignado_w
				and	a.dt_mesano_referencia	=
					(SELECT max(dt_mesano_referencia)
					from	fornecedor_mat_consignado b,
						Parametro_estoque p
					where	p.cd_estabelecimento	= wheb_usuario_pck.get_cd_estabelecimento
					and	b.cd_estabelecimento	= wheb_usuario_pck.get_cd_estabelecimento
					and	b.cd_local_estoque		= cd_local_estoque_p
					and	b.cd_material		= cd_material_p
					and	b.cd_fornecedor		= cd_fornec_consignado_w
					and	b.dt_mesano_referencia	>= p.dt_mesano_vigente);					
			
				if (qt_material_w > qt_estoque_consignado_w and qt_estoque_consignado_w <> 0)then
				begin
					qt_diferenca_w 	:= qt_material_w - qt_estoque_consignado_w;
					qt_material_w 	:= qt_estoque_consignado_w;
					ie_continua 	:= 'S';						
				end;
				else
				begin
					ie_continua 	:= 'N';
					qt_diferenca_w 	:= 0;
				end;
				end if;
			end;
			end if;
		end;
		elsif ((ie_consignado_w = '2') and (current_setting('execucao_prescricao_pck.nr_seq_regra_w')::bigint > 0) and (cd_fornec_consignado_w IS NOT NULL AND cd_fornec_consignado_w::text <> '')) then
			begin
			ie_tipo_saldo_w := 'C';
			
			select	coalesce(sum(qt_estoque),0)
			into STRICT	qt_estoque_consignado_w
			from	fornecedor_mat_consignado a
			where	a.cd_estabelecimento	= wheb_usuario_pck.get_cd_estabelecimento
			and	a.cd_local_estoque	= cd_local_estoque_p
			and	a.cd_material		= cd_material_p
			and	a.cd_fornecedor		= cd_fornec_consignado_w
			and	a.dt_mesano_referencia	=
				(SELECT max(dt_mesano_referencia)
				from	fornecedor_mat_consignado b,
					Parametro_estoque p
				where	p.cd_estabelecimento	= wheb_usuario_pck.get_cd_estabelecimento
				and	b.cd_estabelecimento	= wheb_usuario_pck.get_cd_estabelecimento
				and	b.cd_local_estoque		= cd_local_estoque_p
				and	b.cd_material		= cd_material_p
				and	b.cd_fornecedor		= cd_fornec_consignado_w
				and	b.dt_mesano_referencia	>= p.dt_mesano_vigente);					
			
			if (qt_material_w > qt_estoque_consignado_w and qt_estoque_consignado_w <> 0)then
			begin
				qt_diferenca_w 	:= qt_material_w - qt_estoque_consignado_w;
				qt_material_w 	:= qt_estoque_consignado_w;
				ie_continua 	:= 'S';						
			end;
			else
			begin
				ie_continua 	:= 'N';
				qt_diferenca_w 	:= 0;
			end;
			end if;
			end;
		end if;
				
		begin		
		PERFORM set_config('execucao_prescricao_pck.cd_kit_material_w', null, false);
		
		if (nr_seq_lote_fornec_p = 0) then
			nr_seq_lote_fornec_p := null;
		end if;
		if (nr_prescricao_p = 0) then
			nr_prescricao_p := null;
		end if;
		
		obter_param_usuario(24, 239, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, current_setting('execucao_prescricao_pck.ie_parametro_239_w')::varchar(1));
		obter_param_usuario(24, 184, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, current_setting('execucao_prescricao_pck.ie_parametro_184_w')::varchar(1));
		obter_param_usuario(24, 14, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, current_setting('execucao_prescricao_pck.ie_parametro_14_w')::varchar(10));
		obter_param_usuario(24, 159, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, current_setting('execucao_prescricao_pck.ie_parametro_159_w')::varchar(1));
		obter_param_usuario(24, 258, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, current_setting('execucao_prescricao_pck.ie_parametro_258_w')::varchar(1));
		obter_param_usuario(24, 142, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, current_setting('execucao_prescricao_pck.ie_parametro_142_w')::varchar(1));
		obter_param_usuario(24, 54, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, current_setting('execucao_prescricao_pck.ie_parametro_54_w')::varchar(1));
		obter_param_usuario(24, 249, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, current_setting('execucao_prescricao_pck.ie_parametro_249_w')::varchar(1));
		obter_param_usuario(24, 150, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, current_setting('execucao_prescricao_pck.ie_parametro_150_w')::varchar(1));
		obter_param_usuario(24, 155, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, current_setting('execucao_prescricao_pck.ie_parametro_155_w')::varchar(1));
		obter_param_usuario(24, 82, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, current_setting('execucao_prescricao_pck.ie_parametro_82_w')::varchar(1));
		obter_param_usuario(24, 216, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, current_setting('execucao_prescricao_pck.ie_parametro_216_w')::varchar(1));
		
		if (upper(current_setting('execucao_prescricao_pck.ie_parametro_14_w')::varchar(10)) = 'REGRA') then
			cd_local_regra_w := obter_local_tipo_baixa_prescr(cd_material_p, cd_setor_atend_unidade_p, 'L');
			
			if (cd_local_regra_w <> 'B') and (coalesce(somente_numero(cd_local_regra_w), 0) > 0) then
				cd_local_estoque_barras_p 	:= somente_numero(cd_local_regra_w);
				nr_seq_tipo_baixa_p				:= obter_local_tipo_baixa_prescr(cd_material_p, cd_setor_atend_unidade_p,'S');
				
				select	max(ie_conta_paciente),
					max(ie_atualiza_estoque)
				into STRICT	ie_conta_paciente_p,
					ie_atualiza_estoque_p
				from	tipo_baixa_prescricao
				where	nr_sequencia = nr_seq_tipo_baixa_p;
				
			end if;
		end if;

		ds_result_p := 'N';
		
		PERFORM set_config('execucao_prescricao_pck.ds_mensagem_w', execucao_prescricao_pck.consiste_estoque(
								cd_local_estoque_barras_p,
								cd_kit_p,
								cd_setor_atend_unidade_p,
								cd_material_p,
								ie_atualiza_estoque_p,
								qt_material_w,
								cd_fornec_consignado_w,
								nr_seq_lote_fornec_p,
								nr_atendimento_p,
								nm_usuario_p), false);
		
		select	count(1)
		into STRICT	current_setting('execucao_prescricao_pck.qt_existe_w')::bigint
		from	regra_setor_estoque_kit
		where	cd_setor_atendimento = cd_setor_atend_unidade_p;
		
		if (cd_kit_p IS NOT NULL AND cd_kit_p::text <> '') and (cd_kit_p <> 0) and
			((current_setting('execucao_prescricao_pck.ie_parametro_239_w')::varchar(1) = 'B') or ((current_setting('execucao_prescricao_pck.ie_parametro_239_w')::varchar(1) = 'R') and (current_setting('execucao_prescricao_pck.qt_existe_w')::bigint > 0))) then
			PERFORM set_config('execucao_prescricao_pck.ie_baixa_est_kit_w', 'N', false);
		else
			select	coalesce(max(ie_baixa_estoque),'S')
			into STRICT	current_setting('execucao_prescricao_pck.ie_baixa_est_kit_w')::varchar(1)
			from	componente_kit
			where	cd_kit_material = cd_kit_p
			and		cd_material = cd_material_p;
		end if;
		

		if (current_setting('execucao_prescricao_pck.ds_mensagem_w')::(varchar(255) IS NOT NULL AND (varchar(255))::text <> '')) then
			CALL execucao_prescricao_pck.gerar_w_execucao_proc_mat(nr_atendimento_p, current_setting('execucao_prescricao_pck.ds_mensagem_w')::varchar(255), current_setting('execucao_prescricao_pck.ds_mensagem_w')::varchar(255), 'S', null, cd_material_p, null, nm_usuario_p);
			goto Final;
		elsif (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') then
			
			PERFORM set_config('execucao_prescricao_pck.cd_local_estoque_w', null, false);
			
			if	((ie_atualiza_estoque_p = 'S') or (substr(obter_se_material_baixa_prescr(wheb_usuario_pck.get_cd_estabelecimento, cd_local_estoque_barras_p, cd_material_p),1,2) = 'S')) and (current_setting('execucao_prescricao_pck.ie_baixa_est_kit_w')::varchar(1) = 'S') and (cd_local_estoque_barras_p IS NOT NULL AND cd_local_estoque_barras_p::text <> '') then
				PERFORM set_config('execucao_prescricao_pck.cd_local_estoque_w', cd_local_estoque_barras_p, false);
			end if;
			
			if (ie_atualiza_estoque_p = 'S') and (coalesce(cd_local_estoque_barras_p, 0) = 0) and (current_setting('execucao_prescricao_pck.ie_parametro_184_w')::varchar(1) = 'S') then
				CALL execucao_prescricao_pck.gerar_w_execucao_proc_mat(nr_atendimento_p, wheb_mensagem_pck.get_texto(181688, 'ie_local_estoque='||current_setting('execucao_prescricao_pck.ie_parametro_14_w')::varchar(10)), wheb_mensagem_pck.get_texto(1046161, 'NR_PARAMETRO='||'184;DS_REGRA='||''), 'S', null, cd_material_p, null, nm_usuario_p);
				goto Final;
			end if;
		
			select	coalesce(max(ie_entra_conta),'S')
			into STRICT	current_setting('execucao_prescricao_pck.ie_entra_conta_w')::varchar(1)
			from	componente_kit
			where	cd_material = cd_material_p
			and		cd_kit_material = cd_kit_p;
			
			if (current_setting('execucao_prescricao_pck.ie_entra_conta_w')::varchar(1) = 'S') then

				if (current_setting('execucao_prescricao_pck.ie_parametro_159_w')::varchar(1) = 'S') and (coalesce(nr_seq_lote_fornec_p, 0) > 0) and (substr(obter_se_mat_lote_validade(nr_atendimento_p, cd_material_p, dt_atendimento_p),1,2) = 'S') then
					CALL execucao_prescricao_pck.gerar_w_execucao_proc_mat(nr_atendimento_p, wheb_mensagem_pck.get_texto(181703, 'CD_MATERIAL='||cd_material_p||';MATERIAL='||substr(obter_desc_material(cd_material_p),1,80)),
																wheb_mensagem_pck.get_texto(1046161, 'NR_PARAMETRO='||'159;DS_REGRA='||''), 'N', null, cd_material_p, null, nm_usuario_p);
				end if;
				
				if (current_setting('execucao_prescricao_pck.ie_parametro_258_w')::varchar(1) = 'T') and (ie_conta_paciente_p = 'N') then
					CALL inserir_mat_atend_pac_justif(
										nr_atendimento_p,
										cd_material_p,
										ds_justificativa_p,
										cd_tipo_baixa_p,
										nm_usuario_p);
				end if;
				
				if (ie_conta_paciente_p = 'S') or (coalesce(cd_kit_p, 0) > 0) then
					
					select	nextval('material_atend_paciente_seq')
					into STRICT	current_setting('execucao_prescricao_pck.nr_sequencia_w')::bigint
					;

					nr_seq_mat_atend_pac_p:= current_setting('execucao_prescricao_pck.nr_sequencia_w')::bigint;
					
					SELECT * FROM execucao_prescricao_pck.material_atend_pac_new_record(
								nr_atendimento_p, dt_atendimento_p, dt_entrada_unidade_p, nr_seq_atepacu_p, cd_setor_atend_unidade_p, current_setting('execucao_prescricao_pck.cd_convenio_w')::convenio.cd_convenio%type, current_setting('execucao_prescricao_pck.cd_categoria_w')::categoria_convenio.cd_categoria%type, current_setting('execucao_prescricao_pck.nr_doc_convenio_w')::atend_categoria_convenio.nr_doc_convenio%type, current_setting('execucao_prescricao_pck.ie_tipo_guia_w')::atend_categoria_convenio.ie_tipo_guia%type, current_setting('execucao_prescricao_pck.cd_senha_w')::atend_categoria_convenio.cd_senha%type, cd_acao_p, vl_unitario_p, qt_ajuste_conta_p, ie_valor_informado_p, ie_guia_informada_p, ie_auditoria_p, nm_usuario_original_p, nr_seq_proc_princ_p, cd_situacao_glosa_p, dt_conta_p, current_setting('execucao_prescricao_pck.nr_sequencia_w')::bigint, cd_convenio_wlcb_p, nr_seq_proc_chamada_p, cd_categoria_wlcb_p, cd_material_p, 'S', dt_alta_p, dt_atendimento_p, dt_fim_auditoria_p, nm_usuario_p, current_setting('execucao_prescricao_pck.ie_erro_w')::varchar(1)) INTO STRICT
								nr_atendimento_p, dt_atendimento_p, dt_entrada_unidade_p, nr_seq_atepacu_p, cd_setor_atend_unidade_p, current_setting('execucao_prescricao_pck.cd_convenio_w')::convenio.cd_convenio%type, current_setting('execucao_prescricao_pck.cd_categoria_w')::categoria_convenio.cd_categoria%type, current_setting('execucao_prescricao_pck.nr_doc_convenio_w')::atend_categoria_convenio.nr_doc_convenio%type, current_setting('execucao_prescricao_pck.ie_tipo_guia_w')::atend_categoria_convenio.ie_tipo_guia%type, current_setting('execucao_prescricao_pck.cd_senha_w')::atend_categoria_convenio.cd_senha%type, cd_acao_p, vl_unitario_p, qt_ajuste_conta_p, ie_valor_informado_p, ie_guia_informada_p, ie_auditoria_p, nm_usuario_original_p, nr_seq_proc_princ_p, cd_situacao_glosa_p, dt_conta_p, current_setting('execucao_prescricao_pck.ie_erro_w')::varchar(1);
								
					select	count(1)
					into STRICT	current_setting('execucao_prescricao_pck.qt_existe_w')::bigint
					from	w_execucao_proc_mat
					where	nr_atendimento = nr_atendimento_p
					and		cd_material = cd_material_p
					and		nm_usuario	= nm_usuario_p
					and		ie_aborta = 'S';
					
					if (current_setting('execucao_prescricao_pck.qt_existe_w')::bigint > 0) then
						goto Final;
					end if;
					
					if (coalesce(nr_interno_chamada_p, 0) > 0) then
						nr_interno_conta_p := nr_interno_chamada_p;
					end if;
					
					if (coalesce(nr_prescricao_p, 0) > 0) then
						if (current_setting('execucao_prescricao_pck.ie_parametro_142_w')::varchar(1) = 'S') then
							select	max(nr_doc_conv)
							into STRICT	current_setting('execucao_prescricao_pck.nr_doc_convenio_w')::atend_categoria_convenio.nr_doc_convenio%type
							from	prescr_medica
							where	nr_prescricao = nr_prescricao_p;
						elsif (current_setting('execucao_prescricao_pck.ie_parametro_142_w')::varchar(1) = 'P') then
							select	max(nr_doc_convenio)
							into STRICT	current_setting('execucao_prescricao_pck.nr_doc_convenio_w')::atend_categoria_convenio.nr_doc_convenio%type
							from	prescr_procedimento
							where	nr_prescricao = nr_prescricao_p;
						elsif (current_setting('execucao_prescricao_pck.ie_parametro_142_w')::varchar(1) = 'P') then
							select	max(a.nr_doc_convenio)
							into STRICT	current_setting('execucao_prescricao_pck.nr_doc_convenio_w')::atend_categoria_convenio.nr_doc_convenio%type
							from	procedimento_paciente a
							where	a.nr_sequencia = nr_seq_proc_chamada_p;
						end if;
					end if;
					
					if (current_setting('execucao_prescricao_pck.ie_parametro_54_w')::varchar(1) <> 'N') then
						PERFORM set_config('execucao_prescricao_pck.nr_prescricao_w', nr_prescricao_p, false);
						PERFORM set_config('execucao_prescricao_pck.nr_sequencia_prescricao_w', nr_sequencia_prescricao_p, false);
					end if;				
					
					if (current_setting('execucao_prescricao_pck.nr_prescricao_w')::prescr_medica.nr_prescricao%(type IS NOT NULL AND type::text <> '')) then
						PERFORM set_config('execucao_prescricao_pck.cd_material_prescricao_w', cd_material_p, false);
					else
						PERFORM set_config('execucao_prescricao_pck.cd_material_prescricao_w', null, false);
					end if;
					
					if (coalesce(nr_doc_interno_p, 0) > 0) then
						nr_doc_interno_w := nr_doc_interno_p;
					end if;
					
					if (current_setting('execucao_prescricao_pck.ie_parametro_249_w')::varchar(1) in ('S', 'B')) and (nm_usuario_retirada_p IS NOT NULL AND nm_usuario_retirada_p::text <> '') then
						PERFORM set_config('execucao_prescricao_pck.nm_usuario_retirada_w', nm_usuario_retirada_p, false);
					end if;
					
					if (coalesce(cd_kit_p,0) <> 0) then
						ds_observacao_p := wheb_mensagem_pck.get_texto(182619, 'CD_PERFIL_ATIVO='||obter_perfil_ativo||';CD_FUNCAO_ATIVA=24;CD_SETOR='||cd_setor_atend_unidade_p||';CD_SETOR_ATENDIMENTO='||cd_setor_atend_user_p||';CD_KIT='||cd_kit_p);
						
						if (current_setting('execucao_prescricao_pck.ie_parametro_150_w')::varchar(1) = 'S') then
							PERFORM set_config('execucao_prescricao_pck.cd_kit_material_w', cd_kit_p, false);
						end if;
					end if;
					
					if (current_setting('execucao_prescricao_pck.ie_parametro_155_w')::varchar(1) <> 'N') and (nr_seq_proc_princ_mat_p IS NOT NULL AND nr_seq_proc_princ_mat_p::text <> '') then
						PERFORM set_config('execucao_prescricao_pck.nr_seq_proc_princ_w', nr_seq_proc_princ_mat_p, false);
						if (current_setting('execucao_prescricao_pck.ie_parametro_82_w')::varchar(1) = 'S') and (current_setting('execucao_prescricao_pck.nr_doc_convenio_w')::atend_categoria_convenio.nr_doc_convenio%coalesce(type::text, '') = '') then
							if (substr(obter_doc_conv_prescr_proc(nr_seq_proc_princ_mat_p),1,30) is not null) then
								PERFORM set_config('execucao_prescricao_pck.nr_doc_convenio_w', substr(obter_doc_conv_prescr_proc(nr_seq_proc_princ_mat_p),1,30), false);
							end if;
						end if;
					end if;
					
					select	max(ie_via_aplicacao)
					into STRICT	current_setting('execucao_prescricao_pck.ie_via_aplicacao_w')::material_atend_paciente.ie_via_aplicacao%type
					from	material
					where	cd_material = cd_material_p;
					
					if	((ie_consignado_w = '2') and (current_setting('execucao_prescricao_pck.nr_seq_regra_w')::bigint > 0) and (ie_barras_p = 'N'))then
						PERFORM set_config('execucao_prescricao_pck.nr_seq_cor_exec_w', 95, false);
					else
						PERFORM set_config('execucao_prescricao_pck.nr_seq_cor_exec_w', 96, false);
					end if;
					
					
					SELECT * FROM execucao_prescricao_pck.material_atend_pac_before_post(	
										1, current_setting('execucao_prescricao_pck.nr_sequencia_w')::bigint, nr_atendimento_p, current_setting('execucao_prescricao_pck.nr_doc_convenio_w')::atend_categoria_convenio.nr_doc_convenio%type, 'S', dt_atendimento_p, cd_setor_atend_unidade_p, cd_setor_atend_user_p, cd_fornec_consignado_w, cd_cgc_prestador_p, nr_seq_atepacu_p, current_setting('execucao_prescricao_pck.cd_local_estoque_w')::local_estoque.cd_local_estoque%type, cd_acao_p, current_setting('execucao_prescricao_pck.nr_sequencia_prescricao_w')::prescr_material.nr_sequencia%type, current_setting('execucao_prescricao_pck.nr_prescricao_w')::prescr_medica.nr_prescricao%type, nr_serie_material_p, dt_entrada_p, dt_alta_p, nr_seq_baixa_param_p, current_setting('execucao_prescricao_pck.cd_convenio_w')::convenio.cd_convenio%type, cd_plano_cat_p, current_setting('execucao_prescricao_pck.cd_categoria_w')::categoria_convenio.cd_categoria%type, ie_tipo_atendimento_p, ie_conta_paciente_p, ie_atualiza_estoque_p, dt_entrada_unidade_p, cd_unidade_medida_p, cd_medico_prescritor_p, ie_auditoria_p, cd_material_p, cd_material_exec_p, current_setting('execucao_prescricao_pck.cd_convenio_w')::convenio.cd_convenio%type, current_setting('execucao_prescricao_pck.cd_categoria_w')::categoria_convenio.cd_categoria%type, qt_material_w, nr_interno_conta_p, ie_valor_informado_p, cd_motivo_exc_conta_p, ds_compl_motivo_excon_p, cd_proced_referencia_p, nr_seq_proc_princ_p, ds_observacao_p, nr_seq_tipo_baixa_p, current_setting('execucao_prescricao_pck.ie_erro_w')::varchar(1), nm_usuario_p, ie_acao_justif_p) INTO STRICT ie_auditoria_p, cd_material_p, cd_material_exec_p, current_setting('execucao_prescricao_pck.cd_convenio_w')::convenio.cd_convenio%type, current_setting('execucao_prescricao_pck.cd_categoria_w')::categoria_convenio.cd_categoria%type, qt_material_w, nr_interno_conta_p, ie_valor_informado_p, cd_motivo_exc_conta_p, ds_compl_motivo_excon_p, cd_proced_referencia_p, nr_seq_proc_princ_p, ds_observacao_p, nr_seq_tipo_baixa_p, current_setting('execucao_prescricao_pck.ie_erro_w')::varchar(1), ie_acao_justif_p;
										
										
					select	count(1)
					into STRICT	current_setting('execucao_prescricao_pck.qt_existe_w')::bigint
					from	w_execucao_proc_mat
					where	nr_atendimento = nr_atendimento_p
					and		cd_material = cd_material_p
					and		nm_usuario	= nm_usuario_p
					and		ie_aborta = 'S';
					
					if (current_setting('execucao_prescricao_pck.qt_existe_w')::bigint > 0) then
						goto Final;
					end if;
					
					insert into material_atend_paciente(
							nr_sequencia,
							cd_material,
							cd_material_exec,
							nr_atendimento,
							dt_entrada_unidade,
							dt_atendimento,
							dt_conta,
							cd_unidade_medida,
							qt_material,
							dt_atualizacao,
							nm_usuario,
							cd_acao,
							nr_seq_atepacu,
							nm_usuario_retirante,
							nr_doc_convenio,
							nr_prescricao,
							nr_sequencia_prescricao,
							cd_material_prescricao,
							nr_interno_conta,
							cd_medico_prescritor,
							cd_cgc_fornecedor,
							nr_seq_cor_exec,
							cd_setor_atendimento,
							qt_executada,
							nr_seq_lote_fornec,
							cd_kit_material,
							ds_observacao,
							nr_seq_proc_princ,
							nm_usuario_atend_enf,
							nm_usuario_atend_far,
							nr_seq_doacao,
							nr_seq_reserva,
							nr_seq_transfusao,
							ds_justificativa,
							ie_via_aplicacao,
							cd_convenio,
							cd_categoria,
							cd_local_estoque,
							cd_motivo_exc_conta,
							ds_compl_motivo_excon,
							nr_doc_interno,
							nr_serie_material,
							ie_tipo_guia,
							nr_receita,
							nr_seq_tipo_baixa)
					values (	current_setting('execucao_prescricao_pck.nr_sequencia_w')::bigint,
							cd_material_p,
							cd_material_p,
							nr_atendimento_p,
							dt_entrada_unidade_p,
							dt_atendimento_p,
							dt_conta_p,
							cd_unidade_medida_p,
							qt_material_w,
							clock_timestamp(),
							nm_usuario_p,
							cd_acao_p,
							nr_seq_atepacu_p,
							current_setting('execucao_prescricao_pck.nm_usuario_retirada_w')::material_atend_paciente.nm_usuario_retirante%type,
							current_setting('execucao_prescricao_pck.nr_doc_convenio_w')::atend_categoria_convenio.nr_doc_convenio%type,
							current_setting('execucao_prescricao_pck.nr_prescricao_w')::prescr_medica.nr_prescricao%type,
							current_setting('execucao_prescricao_pck.nr_sequencia_prescricao_w')::prescr_material.nr_sequencia%type,
							current_setting('execucao_prescricao_pck.cd_material_prescricao_w')::material_atend_paciente.cd_material_prescricao%type,
							nr_interno_conta_p,
							cd_medico_prescritor_p,
							cd_fornec_consignado_w,
							current_setting('execucao_prescricao_pck.nr_seq_cor_exec_w')::material_atend_paciente.nr_seq_cor_exec%type,
							cd_setor_atend_unidade_p,
							qt_material_w,
							nr_seq_lote_fornec_p,
							current_setting('execucao_prescricao_pck.cd_kit_material_w')::kit_material.cd_kit_material%type,
							SUBSTR(ds_observacao_p,1,255),
							current_setting('execucao_prescricao_pck.nr_seq_proc_princ_w')::material_atend_paciente.nr_seq_proc_princ%type,
							nm_usuario_atend_enf_p,
							nm_usuario_atend_far_p,
							nr_seq_doacao_chamada_p,
							nr_seq_reserva_chamada_p,
							nr_seq_transfusao_chamada_p,
							ds_justificativa_p,
							current_setting('execucao_prescricao_pck.ie_via_aplicacao_w')::material_atend_paciente.ie_via_aplicacao%type,
							current_setting('execucao_prescricao_pck.cd_convenio_w')::convenio.cd_convenio%type,
							current_setting('execucao_prescricao_pck.cd_categoria_w')::categoria_convenio.cd_categoria%type,
							current_setting('execucao_prescricao_pck.cd_local_estoque_w')::local_estoque.cd_local_estoque%type,
							cd_motivo_exc_conta_p,
							ds_compl_motivo_excon_p,
							nr_doc_interno_w,
							nr_serie_material_p,
							current_setting('execucao_prescricao_pck.ie_tipo_guia_w')::atend_categoria_convenio.ie_tipo_guia%type,
							nr_receita_p,
							nr_seq_tipo_baixa_p);
						
					SELECT * FROM execucao_prescricao_pck.material_atend_pac_after_post(
								current_setting('execucao_prescricao_pck.nr_sequencia_w')::bigint, 1, nr_atendimento_p, cd_material_p, nr_interno_conta_p, 'S', 'N', null, null, qt_material_p, ie_auditoria_p, current_setting('execucao_prescricao_pck.nr_seq_cor_exec_w')::material_atend_paciente.nr_seq_cor_exec%type, current_setting('execucao_prescricao_pck.ie_selecao_lanc_autom_w')::varchar(1), current_setting('execucao_prescricao_pck.ie_necessita_justificativa_w')::varchar(1), nm_usuario_p) INTO STRICT qt_material_p, ie_auditoria_p, current_setting('execucao_prescricao_pck.nr_seq_cor_exec_w')::material_atend_paciente.nr_seq_cor_exec%type, current_setting('execucao_prescricao_pck.ie_selecao_lanc_autom_w')::varchar(1), current_setting('execucao_prescricao_pck.ie_necessita_justificativa_w')::varchar(1);
															
				elsif (ie_atualiza_estoque_p = 'S') and (current_setting('execucao_prescricao_pck.cd_local_estoque_w')::local_estoque.cd_local_estoque%(type IS NOT NULL AND type::text <> '')) then
					
					CALL gerar_prescricao_estoque(
								wheb_usuario_pck.get_cd_estabelecimento,
								nr_atendimento_p,
								dt_entrada_unidade_p,
								cd_material_p,
								dt_atendimento_p,
								'1',
								current_setting('execucao_prescricao_pck.cd_local_estoque_w')::local_estoque.cd_local_estoque%type,
								qt_material_p,
								cd_setor_atend_unidade_p,
								cd_unidade_medida_p,
								nm_usuario_p,
								'I',
								null,
								null,
								null,
								0,
								null,
								null,
								nr_seq_lote_fornec_p,
								null,
								null,
								null,
								null,
								null,
								null);
				end if;
				
				if (current_setting('execucao_prescricao_pck.ie_parametro_150_w')::varchar(1) = 'S') and (coalesce(cd_kit_p, 0) <> 0) and (current_setting('execucao_prescricao_pck.cd_local_estoque_w')::local_estoque.cd_local_estoque%(type IS NOT NULL AND type::text <> '')) and (current_setting('execucao_prescricao_pck.ie_baixa_est_kit_w')::varchar(1)   = 'S') then
					
					CALL gerar_prescricao_estoque(
								wheb_usuario_pck.get_cd_estabelecimento,
								nr_atendimento_p,
								dt_entrada_unidade_p,
								cd_material_p,
								dt_atendimento_p,
								'1',
								current_setting('execucao_prescricao_pck.cd_local_estoque_w')::local_estoque.cd_local_estoque%type,
								qt_material_p,
								cd_setor_atend_unidade_p,
								cd_unidade_medida_p,
								nm_usuario_p,
								'I',
								null,
								null,
								null,
								0,
								null,
								null,
								nr_seq_lote_fornec_p,
								0,
								null,
								0,
								null,
								null,
								null);
				end if;
				
				update	material_atend_paciente
				set		dt_atualizacao_estoque = clock_timestamp()
				where	nr_sequencia = current_setting('execucao_prescricao_pck.nr_sequencia_w')::bigint;
				
				ds_result_p := 'S';

			else
				begin
				if (current_setting('execucao_prescricao_pck.cd_local_estoque_w')::local_estoque.cd_local_estoque%(type IS NOT NULL AND type::text <> '')) then
				
					CALL gerar_prescricao_estoque(
								wheb_usuario_pck.get_cd_estabelecimento,
								nr_atendimento_p,
								dt_entrada_unidade_p,
								cd_material_p,
								dt_atendimento_p,
								'1',
								current_setting('execucao_prescricao_pck.cd_local_estoque_w')::local_estoque.cd_local_estoque%type,
								qt_material_p,
								cd_setor_atend_unidade_p,
								cd_unidade_medida_p,
								nm_usuario_p,
								'I',
								null,
								null,
								null,
								0,
								null,
								null,
								nr_seq_lote_fornec_p,
								0,
								null,
								0,
								null,
								null,
								null);
								
				end if;
				
				ds_result_p := 'S';
				end;
			end if;
			
			if (current_setting('execucao_prescricao_pck.ie_parametro_54_w')::varchar(1) = 'Q') and (nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '') and (nr_sequencia_prescricao_p IS NOT NULL AND nr_sequencia_prescricao_p::text <> '') then
				select	max(a.qt_total_dispensar),
						sum(b.qt_material)
				into STRICT	current_setting('execucao_prescricao_pck.qt_total_dispensar_w')::prescr_material.qt_total_dispensar%type,
						current_setting('execucao_prescricao_pck.qt_dispensar_w')::prescr_material.qt_material%type
				from	material_atend_paciente b,
						prescr_material a
				where	a.nr_prescricao = nr_prescricao_p
				and		a.nr_sequencia = nr_sequencia_prescricao_p
				and		a.nr_prescricao = b.nr_prescricao
				and		a.nr_sequencia = b.nr_sequencia_prescricao;
				
				if (current_setting('execucao_prescricao_pck.qt_total_dispensar_w')::prescr_material.qt_total_dispensar%type <= current_setting('execucao_prescricao_pck.qt_dispensar_w')::prescr_material.qt_material%type) then
					update	prescr_material
					set		dt_baixa = clock_timestamp(),
							cd_motivo_baixa = 1
					where	nr_prescricao   = nr_prescricao_p
					and		nr_sequencia    = nr_sequencia_prescricao_p
					and    cd_motivo_baixa = 0;
				end if;		
			end if;
			
			select	max(a.nr_ordem_compra)
			into STRICT	current_setting('execucao_prescricao_pck.nr_ordem_compra_w')::ordem_compra.nr_ordem_compra%type
			from	ordem_compra a, ordem_compra_item b
			where	a.nr_atendimento = b.nr_atendimento
			and		a.nr_atendimento = nr_atendimento_p
			and		b.cd_material = cd_material_p;
			
			if (current_setting('execucao_prescricao_pck.nr_ordem_compra_w')::ordem_compra.nr_ordem_compra%type > 0) then
				if (nr_seq_lote_fornec_p IS NOT NULL AND nr_seq_lote_fornec_p::text <> '') then
					select	max(ds_lote_fornec)
					into STRICT	current_setting('execucao_prescricao_pck.ds_lote_fornec_w')::material_lote_fornec.ds_lote_fornec%type
					from	material_lote_fornec
					where	nr_sequencia = nr_seq_lote_fornec_p;
				end if;
				
				update	ordem_compra_item
				set		ds_observacao = substr(ds_observacao || wheb_mensagem_pck.get_texto(182911, 'DS_SERIE='||nr_serie_material_p||';NR_LOTE_MATERIAL='||current_setting('execucao_prescricao_pck.ds_lote_fornec_w')::material_lote_fornec.ds_lote_fornec%type) ,1,255)
				where	nr_ordem_compra = current_setting('execucao_prescricao_pck.nr_ordem_compra_w')::ordem_compra.nr_ordem_compra%type
				and		cd_material = cd_material_p;
				
			end if;
			
			if (current_setting('execucao_prescricao_pck.ie_parametro_216_w')::varchar(1) in ('S', 'V', 'A')) then
				CALL gerar_w_relat_barras_execpresc(cd_material_p, ds_validade_p, cd_unidade_medida_p, qt_material_p, nm_usuario_p);
			end if;
		end if;
		
		exception
		when others then	
			CALL execucao_prescricao_pck.gerar_w_execucao_proc_mat(nr_atendimento_p, wheb_mensagem_pck.get_texto(359570), substr(sqlerrm(SQLSTATE),1,2000), 'S', null, cd_material_p, null, nm_usuario_p);
		end;		
		
		<<Final>>
		
		PERFORM set_config('execucao_prescricao_pck.qt_existe_w', 0, false);

		if ((ie_consignado_w = '2' and current_setting('execucao_prescricao_pck.nr_seq_regra_w')::bigint > 0) and qt_diferenca_w > 0 and ((ie_tipo_saldo_w = 'N') or (ie_tipo_saldo_w = 'C')) and ie_continua = 'S')then
		begin
			qt_material_w := qt_diferenca_w;
			cd_fornec_consignado_w := null;
		end;
		else
			qt_diferenca_w := 0;
			ie_continua := 'N';
		end if;		
		end;
	end loop;
	
	end;


$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE execucao_prescricao_pck.baixar_material_barras ( nr_atendimento_p INOUT bigint, cd_kit_p INOUT bigint, cd_local_estoque_barras_p INOUT bigint, cd_setor_atend_unidade_p INOUT bigint, cd_material_p INOUT bigint, cd_material_exec_p INOUT bigint, ie_atualiza_estoque_p INOUT text, qt_material_p INOUT bigint, cd_cgc_fornecedor_p INOUT text, nr_seq_lote_fornec_p INOUT bigint, dt_atendimento_p INOUT timestamp, ie_conta_paciente_p INOUT text, cd_tipo_baixa_p INOUT text, dt_entrada_unidade_p INOUT timestamp, nr_seq_atepacu_p INOUT bigint, vl_unitario_p INOUT bigint, qt_ajuste_conta_p INOUT bigint, ie_valor_informado_p INOUT text, ie_guia_informada_p INOUT text, ie_auditoria_p INOUT text, nm_usuario_original_p INOUT text, nr_seq_proc_princ_p INOUT bigint, cd_situacao_glosa_p INOUT bigint, cd_acao_p INOUT text, nr_interno_conta_p INOUT bigint, nr_interno_chamada_p INOUT bigint, cd_motivo_exc_conta_p INOUT bigint, ds_compl_motivo_excon_p INOUT text, cd_proced_referencia_p INOUT text, ds_observacao_p INOUT text, nr_seq_tipo_baixa_p INOUT bigint, nr_doc_convenio_p INOUT bigint, ie_acao_justif_p INOUT text, nr_seq_mat_atend_pac_p INOUT bigint, nr_doc_interno_p bigint, ds_result_p INOUT text, dt_conta_p INOUT timestamp, dt_fim_auditoria_p timestamp default null, nr_seq_doacao_chamada_p bigint DEFAULT NULL, nr_seq_reserva_chamada_p bigint DEFAULT NULL, nr_seq_transfusao_chamada_p bigint DEFAULT NULL, nm_usuario_atend_far_p text DEFAULT NULL, nm_usuario_atend_enf_p text DEFAULT NULL, cd_plano_cat_p text DEFAULT NULL, cd_cgc_prestador_p text DEFAULT NULL, cd_local_estoque_p bigint DEFAULT NULL, nr_sequencia_prescricao_p bigint DEFAULT NULL, nr_prescricao_p INOUT bigint DEFAULT NULL, nr_serie_material_p text DEFAULT NULL, dt_entrada_p timestamp DEFAULT NULL, nr_seq_baixa_param_p bigint DEFAULT NULL, ie_tipo_atendimento_p bigint DEFAULT NULL, cd_unidade_medida_p text DEFAULT NULL, cd_medico_prescritor_p text DEFAULT NULL, cd_setor_atend_user_p bigint DEFAULT NULL, cd_convenio_wlcb_p bigint DEFAULT NULL, nr_seq_proc_chamada_p bigint DEFAULT NULL, cd_categoria_wlcb_p text DEFAULT NULL, ie_barras_p text DEFAULT NULL, nm_usuario_retirada_p text DEFAULT NULL, dt_alta_p timestamp default null, ds_justificativa_p text DEFAULT NULL, nr_seq_proc_princ_mat_p bigint DEFAULT NULL, ds_validade_p text DEFAULT NULL, nr_receita_p bigint DEFAULT NULL, nm_usuario_p text DEFAULT NULL) FROM PUBLIC;
