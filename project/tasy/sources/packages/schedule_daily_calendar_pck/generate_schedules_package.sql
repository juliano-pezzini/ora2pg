-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION schedule_daily_calendar_pck.generate_schedules (ie_param_306 text, ie_param_28 text, ie_param_35 text, ie_param_158 text, cd_classif_agenda bigint, cd_setor_exclusivo bigint) RETURNS varchar AS $body$
DECLARE

	cd_schedules_w varchar(4000) := '';
	ds_agenda_w varchar(200);
	cd_agenda_w bigint;

	cd_estabelecimento_w estabelecimento.cd_estabelecimento%type := wheb_usuario_pck.get_cd_estabelecimento;
	nm_usuario_w usuario.nm_usuario%type := wheb_usuario_pck.get_nm_usuario;

  c01 CURSOR FOR
  SELECT	a.cd_agenda cd,
          a.ds_agenda ds
  FROM	agenda a
  WHERE	a.ie_situacao = 'A'
  AND		a.cd_tipo_agenda = 1
  AND		((ie_param_306 = 'N') OR (((ie_param_28 = 'S') AND cd_setor_exclusivo IN (SELECT cd_setor_atendimento FROM usuario_setor_v WHERE nm_usuario = nm_usuario_w))
  OR (ie_param_28 = 'N') AND coalesce(cd_setor_exclusivo::text, '') = ''))
  AND		((ie_param_35 = 'S' AND cd_estabelecimento = cd_estabelecimento_w)
  OR		((ie_param_35 = 'N') AND (cd_estabelecimento IN (SELECT x.cd_estabelecimento
															FROM usuario_estabelecimento_v x
															WHERE  x.nm_usuario_param = nm_usuario_w))))
  AND		((ie_param_158 = 'N') OR (obter_se_perm_agecirur(a.cd_pessoa_fisica, obter_pf_usuario(nm_usuario_w,'C'), Obter_perfil_Ativo(), a.cd_agenda) <> 'N'))			and ( coalesce(cd_classif_agenda::text, '') = '' or a.NR_SEQ_CLASSIF = cd_classif_agenda)		and (coalesce(cd_setor_exclusivo::text, '') = '' or obter_se_contido_char(obter_setor_agenda(a.cd_agenda), cd_setor_exclusivo) = 'S')
  ORDER BY a.NR_SEQ_APRESENT,ds;

BEGIN

	open c01;
	loop
	fetch c01 into cd_agenda_w,ds_agenda_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin
      cd_schedules_w := cd_schedules_w || cd_agenda_w || ',';
		end;
	end loop;
	close c01;
  if length(cd_schedules_w) = 0 then
    RETURN '';
  else
    RETURN cd_schedules_w;
  end if;
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION schedule_daily_calendar_pck.generate_schedules (ie_param_306 text, ie_param_28 text, ie_param_35 text, ie_param_158 text, cd_classif_agenda bigint, cd_setor_exclusivo bigint) FROM PUBLIC;
