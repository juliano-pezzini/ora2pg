-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_consulta_analise_pos_pck.pls_gerar_w_item_an_novo_pos ( nr_seq_analise_p bigint, nr_nivel_p bigint, nr_seq_grupo_p bigint, ie_minha_analise_p text, ie_pendentes_p text, nm_usuario_p text, nr_id_transacao_p INOUT w_pls_analise_item.nr_id_transacao%type) AS $body$
DECLARE


	vl_total_liberado_fat_w		w_pls_analise_total.vl_total_liberado_fat%type;
	vl_total_glosado_fat_w		w_pls_analise_total.vl_total_glosado_fat%type;

	/* Vetor das contas */

	C02 CURSOR FOR
		SELECT	b.nr_sequencia nr_sequencia,
			b.nr_seq_guia nr_seq_guia,
			b.nr_seq_protocolo nr_seq_protocolo,
			b.nr_seq_prestador nr_seq_prestador,
			b.nr_seq_prestador_exec nr_seq_prestador_exec,
			b.dt_emissao dt_emissao,
			b.dt_atendimento_referencia dt_atendimento_referencia,
			b.nr_seq_cbo_saude nr_seq_cbo_saude,
			b.cd_medico_executor cd_medico_executor,
			b.cd_guia cd_guia,
			b.ie_tipo_guia ie_tipo_guia,
			b.cd_estabelecimento cd_estabelecimento,
			b.ie_tipo_conta
		from	pls_conta b
		where	b.nr_sequencia in ( 	SELECT 	p.nr_seq_conta
						from	pls_conta_pos_proc p
						where	p.nr_seq_analise = nr_seq_analise_w
						
union all

						select	m.nr_seq_conta
						from	pls_conta_pos_mat m
						where	m.nr_seq_analise = nr_seq_analise_w)
		
union

		select	b.nr_sequencia nr_sequencia,
			b.nr_seq_guia nr_seq_guia,
			b.nr_seq_protocolo nr_seq_protocolo,
			b.nr_seq_prestador nr_seq_prestador,
			b.nr_seq_prestador_exec nr_seq_prestador_exec,
			b.dt_emissao dt_emissao,
			b.dt_atendimento_referencia dt_atendimento_referencia,
			b.nr_seq_cbo_saude nr_seq_cbo_saude,
			b.cd_medico_executor cd_medico_executor,
			b.cd_guia cd_guia,
			b.ie_tipo_guia ie_tipo_guia,
			b.cd_estabelecimento cd_estabelecimento,
			b.ie_tipo_conta
		from	pls_conta 	b,
			pls_conta 	c
		where	b.nr_sequencia		= c.nr_seq_conta_referencia
		and	c.nr_sequencia in ( 	select	nr_seq_conta
						from	pls_conta_pos_proc p
						where	p.nr_seq_analise = nr_seq_analise_w
						
union all

						select	nr_seq_conta
						from	pls_conta_pos_mat m
						where	m.nr_seq_analise = nr_seq_analise_w
					)
		and	not exists (	select	1
						from	pls_conta_pos_proc p
						where	p.nr_seq_conta	= b.nr_sequencia
						
union all

						select 	1
						from	pls_conta_pos_mat m
						where	m.nr_seq_conta = b.nr_sequencia)
		group by
			b.nr_sequencia,
			b.nr_seq_guia,
			b.nr_seq_protocolo,
			b.nr_seq_prestador,
			b.nr_seq_prestador_exec,
			b.dt_emissao,
			b.dt_atendimento_referencia,
			b.nr_seq_cbo_saude,
			b.cd_medico_executor,
			b.cd_guia,
			b.ie_tipo_guia,
			b.cd_estabelecimento,
			b.ie_tipo_conta;

	
BEGIN
	if ( coalesce(nr_id_transacao_p,0) = 0) then
		select 	nextval('pls_id_analise_seq')
		into STRICT	nr_id_transacao_p
		;
	else
		delete	FROM w_pls_analise_item
		where 	nr_id_transacao	= nr_id_transacao_p;

		delete 	FROM w_pls_analise_total
		where	nr_id_transacao	= nr_id_transacao_p;

		delete 	FROM w_pls_analise_glosa_ocor
		where	nr_id_transacao	= nr_id_transacao_p;

	end if;

	CALL CALL pls_consulta_analise_pos_pck.pls_iniciar_dados_analise(nr_seq_analise_p);

	pls_gerar_w_analise_pos_cab(nr_seq_analise_p, nr_seq_grupo_p, nm_usuario_p, nr_id_transacao_p);

	PERFORM set_config('pls_consulta_analise_pos_pck.nr_nivel_w', nr_nivel_p, false);
	PERFORM set_config('pls_consulta_analise_pos_pck.nr_seq_item_w', 1, false);

	open C02;
	loop
	fetch C02 into
		current_setting('pls_consulta_analise_pos_pck.nr_seq_conta_w')::bigint,
		current_setting('pls_consulta_analise_pos_pck.nr_seq_guia_w')::bigint,
		current_setting('pls_consulta_analise_pos_pck.nr_seq_protocolo_w')::bigint,
		current_setting('pls_consulta_analise_pos_pck.nr_seq_prestador_solic_w')::bigint,
		current_setting('pls_consulta_analise_pos_pck.nr_seq_prestador_exec_w')::bigint,
		current_setting('pls_consulta_analise_pos_pck.dt_emissao_conta_w')::timestamp,
		current_setting('pls_consulta_analise_pos_pck.dt_atendimento_referencia_w')::timestamp,
		current_setting('pls_consulta_analise_pos_pck.nr_seq_cbo_saude_w')::bigint,
		current_setting('pls_consulta_analise_pos_pck.cd_medico_executor_w')::varchar(20),
		current_setting('pls_consulta_analise_pos_pck.cd_guia_conta_w')::varchar(30),
		current_setting('pls_consulta_analise_pos_pck.ie_tipo_guia_conta_w')::varchar(20),
		current_setting('pls_consulta_analise_pos_pck.cd_estabelecimento_w')::pls_conta.cd_estabelecimento%type,
		current_setting('pls_consulta_analise_pos_pck.ie_tipo_conta_w')::pls_conta.ie_tipo_conta%type;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin

		PERFORM set_config('pls_consulta_analise_pos_pck.nm_prestador_solic_w', pls_obter_dados_prestador(current_setting('pls_consulta_analise_pos_pck.nr_seq_prestador_solic_w')::bigint,'N'), false);
		PERFORM set_config('pls_consulta_analise_pos_pck.nm_prestador_exec_w', pls_obter_dados_prestador(current_setting('pls_consulta_analise_pos_pck.nr_seq_prestador_exec_w')::bigint,'N'), false);
		PERFORM set_config('pls_consulta_analise_pos_pck.cd_prestador_exec_w', pls_obter_dados_prestador(current_setting('pls_consulta_analise_pos_pck.nr_seq_prestador_exec_w')::bigint,'CD'), false);

		if (current_setting('pls_consulta_analise_pos_pck.nr_seq_guia_w')::(bigint IS NOT NULL AND bigint::text <> '')) then
			select	a.ie_tipo_guia,
				obter_valor_dominio(1746,a.ie_tipo_guia),
				cd_guia,
				CASE WHEN ie_status=1 THEN  'S'  ELSE 'N' END
			into STRICT	current_setting('pls_consulta_analise_pos_pck.ie_tipo_guia_w')::varchar(2),
				current_setting('pls_consulta_analise_pos_pck.ds_tipo_guia_w')::varchar(255),
				current_setting('pls_consulta_analise_pos_pck.cd_guia_w')::varchar(30),
				current_setting('pls_consulta_analise_pos_pck.ie_autorizado_w')::varchar(3)
			from	pls_guia_plano a
			where	nr_sequencia = current_setting('pls_consulta_analise_pos_pck.nr_seq_guia_w')::bigint;

			PERFORM set_config('pls_consulta_analise_pos_pck.ds_tipo_guia_w', obter_valor_dominio(1746,current_setting('pls_consulta_analise_pos_pck.ie_tipo_guia_conta_w')::varchar(20)), false);
			PERFORM set_config('pls_consulta_analise_pos_pck.ie_tipo_guia_w', current_setting('pls_consulta_analise_pos_pck.ie_tipo_guia_conta_w')::varchar(20), false);
		else
			PERFORM set_config('pls_consulta_analise_pos_pck.cd_guia_w', current_setting('pls_consulta_analise_pos_pck.cd_guia_conta_w')::varchar(30), false);
			PERFORM set_config('pls_consulta_analise_pos_pck.ds_tipo_guia_w', obter_valor_dominio(1746,current_setting('pls_consulta_analise_pos_pck.ie_tipo_guia_conta_w')::varchar(20)), false);
			PERFORM set_config('pls_consulta_analise_pos_pck.ie_tipo_guia_w', current_setting('pls_consulta_analise_pos_pck.ie_tipo_guia_conta_w')::varchar(20), false);
		end if;

		if (current_setting('pls_consulta_analise_pos_pck.ie_tipo_conta_w')::pls_conta.ie_tipo_conta%type	= 'I') then
			PERFORM set_config('pls_consulta_analise_pos_pck.cd_guia_w', current_setting('pls_consulta_analise_pos_pck.cd_guia_conta_w')::varchar(30), false);
		end if;

		if (current_setting('pls_consulta_analise_pos_pck.nr_seq_cbo_saude_w')::(bigint IS NOT NULL AND bigint::text <> '')) then
			select	max(a.ds_cbo)
			into STRICT	current_setting('pls_consulta_analise_pos_pck.ds_espec_cbo_w')::varchar(255)
			from	cbo_saude	a
			where	a.nr_sequencia	= current_setting('pls_consulta_analise_pos_pck.nr_seq_cbo_saude_w')::bigint;
		end if;

		if (current_setting('pls_consulta_analise_pos_pck.cd_medico_executor_w')::(varchar(20) IS NOT NULL AND (varchar(20))::text <> '')) then
			select	substr(nm_pessoa_fisica,1,255)
			into STRICT	current_setting('pls_consulta_analise_pos_pck.ds_medico_executor_w')::varchar(255)
			from	pessoa_fisica
			where	cd_pessoa_fisica	= current_setting('pls_consulta_analise_pos_pck.cd_medico_executor_w')::varchar(20);
		end if;

		select	count(1)
		into STRICT	current_setting('pls_consulta_analise_pos_pck.qt_item_sem_id_w')::integer
		from (SELECT	a.nr_sequencia
			from	pls_conta_proc 		a,
				pls_conta_pos_proc	b
			where	b.nr_seq_analise 	= nr_seq_analise_p
			and	b.nr_seq_conta_proc	= a.nr_sequencia
			and	coalesce(a.nr_id_analise::text, '') = ''
			
union all

			SELECT	b.nr_sequencia
			from	pls_conta_mat		b,
				pls_conta_pos_mat	c
			where	c.nr_seq_analise	= nr_seq_analise_p
			and	c.nr_seq_conta_mat	= b.nr_sequencia
			and	coalesce(nr_id_analise::text, '') = '') alias4;

		if (current_setting('pls_consulta_analise_pos_pck.qt_item_sem_id_w')::integer > 0) then
			/* gera o id para os itens que não possuem o mesmo*/

			CALL pls_analise_atualizar_id_itens(current_setting('pls_consulta_analise_pos_pck.nr_seq_conta_w')::bigint,nm_usuario_p,current_setting('pls_consulta_analise_pos_pck.cd_estabelecimento_w')::pls_conta.cd_estabelecimento%type,'S');
		end if;

		/*Essas rotinas serão implementadas em OS's específicas*/

		--Montagem de informações na tela da análise para título, procedimentos, materiais e os agrupamentos, considerando a nova geração de pós-estabelecido.
		--Essas rotinas abaixo utilizam tabelas da nova geração de pós, não podendo ser utilizadas na antiga forma de geração.
		CALL pls_gerar_w_analise_pos_titulo(nr_seq_analise_p,current_setting('pls_consulta_analise_pos_pck.nr_seq_conta_w')::bigint,nm_usuario_p);
		pls_gerar_w_an_pos_agrupamento(nr_seq_analise_p, current_setting('pls_consulta_analise_pos_pck.nr_seq_conta_w')::bigint, nr_seq_grupo_p, ie_minha_analise_p, ie_pendentes_p, nm_usuario_p);
		pls_gerar_w_analise_pos_proced(nr_seq_analise_p, current_setting('pls_consulta_analise_pos_pck.nr_seq_conta_w')::bigint, nr_seq_grupo_p, ie_minha_analise_p, ie_pendentes_p, nm_usuario_p);
		pls_gerar_w_an_pos_materiais(nr_seq_analise_p, current_setting('pls_consulta_analise_pos_pck.nr_seq_conta_w')::bigint, nr_seq_grupo_p, ie_minha_analise_p, ie_pendentes_p, nm_usuario_p);

		end;
	end loop;
	close C02;

	CALL pls_ordenar_w_analise_item(nr_seq_analise_p,nm_usuario_p, null);

	select sum(vl_pos_materiais) + sum(vl_pos_procedimentos)
	into STRICT	vl_total_liberado_fat_w
	from
	(	SELECT 	sum(vl_materiais) + sum(vl_lib_taxa_material) 	vl_pos_materiais,
			0 						vl_pos_procedimentos
		from	pls_conta_pos_mat
		where	nr_seq_analise = nr_seq_analise_p
		
union all

		SELECT 	0 						vl_pos_materiais,
		(	sum(vl_medico) + sum(vl_custo_operacional) +
			sum(vl_materiais) + sum(vl_lib_taxa_servico) +
			sum(vl_lib_taxa_co) + sum(vl_lib_taxa_material))vl_pos_procedimentos
		from	pls_conta_pos_proc
		where	nr_seq_analise = nr_seq_analise_p
	) alias11;

	select sum(vl_glosa_materiais) + sum(vl_glosa_procedimentos)
	into STRICT	vl_total_glosado_fat_w
	from
	(	SELECT 	sum(vl_glosa_material_fat) + sum(vl_glosa_taxa_material) vl_glosa_materiais,
			0 							 vl_glosa_procedimentos
		from	pls_conta_pos_mat
		where	nr_seq_analise = nr_seq_analise_p
		
union all

		SELECT 	0 							vl_glosa_materiais,
		(	sum(vl_glosa_co_fat) + sum(vl_glosa_hi_fat) +
			sum(vl_glosa_material_fat) + sum(vl_glosa_taxa_co) +
			sum(vl_glosa_taxa_material) + sum(vl_glosa_taxa_servico))vl_glosa_procedimentos
		from	pls_conta_pos_proc
		where	nr_seq_analise = nr_seq_analise_p
	) alias11;

	insert into w_pls_analise_total(nr_sequencia,
			nm_usuario,
			dt_atualizacao,
			nm_usuario_nrec,
			dt_atualizacao_nrec,
			nr_seq_analise,
			vl_total_liberado,
			vl_total_glosado,
			vl_total_apresentado,
			vl_total_calculado,
			vl_total_taxa,
			vl_total_liberado_fat,
			vl_total_glosado_fat)
		values (nextval('w_pls_analise_total_seq'),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nr_seq_analise_p,
			current_setting('pls_consulta_analise_pos_pck.vl_total_liberado_w')::double,
			current_setting('pls_consulta_analise_pos_pck.vl_total_glosado_w')::double,
			current_setting('pls_consulta_analise_pos_pck.vl_total_apresentado_w')::double,
			0,
			0,
			vl_total_liberado_fat_w,
			vl_total_glosado_fat_w);

	commit;

	end;

	--Antiga geração de pós-estabelecido
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_consulta_analise_pos_pck.pls_gerar_w_item_an_novo_pos ( nr_seq_analise_p bigint, nr_nivel_p bigint, nr_seq_grupo_p bigint, ie_minha_analise_p text, ie_pendentes_p text, nm_usuario_p text, nr_id_transacao_p INOUT w_pls_analise_item.nr_id_transacao%type) FROM PUBLIC;
