-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

  --
CREATE OR REPLACE FUNCTION pkg_bsi_report.get_goal_compliance (P_NR_ATEND bigint, P_NR_SEQ_ATEND_DISP bigint, P_ESTAB bigint, P_DT_ATEND timestamp, P_GOAL bigint) RETURNS bigint AS $body$
DECLARE


    NR bigint;

  
BEGIN

    SELECT COUNT(1)
      INTO STRICT NR
      FROM DISPOSITIVO_INF_ADIC D
     WHERE D.NR_SEQ_ATEND_DISP = P_NR_SEQ_ATEND_DISP
       AND D.NR_SEQ_INF_ADIC = PKG_REPORT_DATA.GET_DEVICE_INFO(P_GOAL);

    IF NR <> 0 THEN

      SELECT CASE WHEN COUNT(1)=0 THEN  0  ELSE 1 END 
        INTO STRICT NR
        FROM TOF_META_ATEND M
       WHERE M.NR_ATENDIMENTO = P_NR_ATEND
         AND M.NR_SEQ_META = PKG_REPORT_DATA.GET_CARE_GOAL(P_GOAL)
         AND IE_STATUS = 'A'
         AND TRUNC(PKG_ATEND_PAC_UNID.GET_ESTAB_DT(P_ESTAB, M.DT_INICIO), 'DD') = P_DT_ATEND;

    END IF;
    
    RETURN NR;

  END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pkg_bsi_report.get_goal_compliance (P_NR_ATEND bigint, P_NR_SEQ_ATEND_DISP bigint, P_ESTAB bigint, P_DT_ATEND timestamp, P_GOAL bigint) FROM PUBLIC;
