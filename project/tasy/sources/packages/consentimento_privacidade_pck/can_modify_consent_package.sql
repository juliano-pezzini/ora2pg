-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


    /*
     * Function to validate if user can modify the consent based in the permissions of the user, the profile and the function where consent is shown
     */
CREATE OR REPLACE FUNCTION consentimento_privacidade_pck.can_modify_consent ( nm_usuario_p usuario.nm_usuario%type, cd_perfil_p usuario_perfil.cd_perfil%type, ie_function_current_p text, ie_tipo_consentimento_p pessoa_fisica_privac_item.ie_tipo_consentimento%type, ie_tipo_documento_p pessoa_fisica_privac_item.ie_tipo_documento%type ) RETURNS varchar AS $body$
DECLARE

        acc_cad_com_pessoa varchar(1);
        acc_cad_sim_pessoa varchar(1);
        acc_cad_funcionario varchar(1);
        acc_cad_medico varchar(1);
        acc_cad_ops_pessoa varchar(1);

	ie_function_p varchar(10);
	return_value_string varchar(10);	
	return_value boolean;


BEGIN

        -- By default the user cannot modify the consent
        return_value := false;

        -- Get original function of the consent, NONE is only to review permissions
        if ( ie_tipo_consentimento_p = 'CTC' ) then	
		select	ie_function
		into STRICT 	ie_function_p 
		from 	privacy_consent_customer
		where 	nr_sequencia = ie_tipo_documento_p;
        else	if ( ie_tipo_consentimento_p = 'SEA' or
			ie_tipo_consentimento_p = 'CMD' or 
			ie_tipo_consentimento_p = 'CNC' ) then

			if ( ie_function_current_p = 'CCP' or 
					ie_function_current_p = 'CSP' ) then
				ie_function_p := 'ALL';
			else
				ie_function_p := 'NONE';
			end if;
		else
			if ( ie_tipo_consentimento_p = 'CCC' or
				ie_tipo_consentimento_p = 'MCM' or 
				ie_tipo_consentimento_p = 'ERM' ) then

				ie_function_p := 'CM';
			else
				if ( ie_tipo_consentimento_p = 'EAE' or
						ie_tipo_consentimento_p = 'EPM' or
						ie_tipo_consentimento_p = 'SAE' or
						ie_tipo_consentimento_p = 'SPM' or 
						ie_tipo_consentimento_p = 'MAE' or
						ie_tipo_consentimento_p = 'MPM' ) then

					if ( ie_function_current_p = 'CCP' or
							ie_function_current_p = 'CSP' or
							ie_function_current_p = 'CF'  or 
							ie_function_current_p = 'CM' ) then

						ie_function_p := 'ALL';
					else
						ie_function_p := 'NONE';
					end if;
				else
					ie_function_p := 'NONE';
				end if;
			end if;
		end if;
	end if;

        if ( ie_function_current_p = ie_function_p or
		  ie_function_p = 'ALL' ) then
            -- If current function is same than consent's function or it was set to ALL, user can modify the consent
            return_value := true;
	else
	        -- Verify if user has permission to modify this function
	        select  ie_cad_com_pessoa,
			ie_cad_sim_pessoa,
			ie_cad_funcionario,
			ie_cad_medico,
			ie_cad_ops_pessoa
		into STRICT	acc_cad_com_pessoa,
			acc_cad_sim_pessoa,
			acc_cad_funcionario, 
			acc_cad_medico, 
			acc_cad_ops_pessoa
		from (	-- Get Data from input client.
			with 	table_profile_perm as (
					SELECT 	ie_cad_com_pessoa,
						ie_cad_sim_pessoa, 
						ie_cad_funcionario,  
						ie_cad_medico,
						ie_cad_ops_pessoa,
						2 as type_priority
					from	privacy_cons_perm_prof 
					where 	cd_perfil = cd_perfil_p 
					and 	ie_function = ie_function_current_p
				),
				table_user_perm as (
					SELECT	ie_cad_com_pessoa,  
						ie_cad_sim_pessoa, 
						ie_cad_funcionario, 
						ie_cad_medico, 
						ie_cad_ops_pessoa,
						1 as type_priority
					from 	privacy_cons_perm_user 
					where 	nm_usuario_perm = nm_usuario_p 
					and 	ie_function = ie_function_current_p
				)
			-- Verify the user's permissions, they overwrite the profile permissions
			select	coalesce(ie_cad_com_pessoa,'I') as ie_cad_com_pessoa,  
				coalesce(ie_cad_sim_pessoa,'I') as ie_cad_sim_pessoa, 
				coalesce(ie_cad_funcionario,'I') as ie_cad_funcionario, 
				coalesce(ie_cad_medico,'I') as ie_cad_medico, 
				coalesce(ie_cad_ops_pessoa,'I') as ie_cad_ops_pessoa,
				type_priority
			from 	table_user_perm
			
union

			-- Verify the profile's permissions
			select	coalesce(ie_cad_com_pessoa,'I') as ie_cad_com_pessoa,  
				coalesce(ie_cad_sim_pessoa,'I') as ie_cad_sim_pessoa, 
				coalesce(ie_cad_funcionario,'I') as ie_cad_funcionario, 
				coalesce(ie_cad_medico,'I') as ie_cad_medico, 
				coalesce(ie_cad_ops_pessoa,'I') as ie_cad_ops_pessoa,
				type_priority 
			from 	table_profile_perm
			
union
 
			-- When no data found from queries above.
			select 	'I' as ie_cad_com_pessoa, 
				'I' as ie_cad_sim_pessoa,
				'I' as ie_cad_funcionario,
				'I' as ie_cad_medico,
				'I' as ie_cad_ops_pessoa,
				3   as type_priority	
			
			order by 6 ) alias12 LIMIT 1;

		-- Verify default consents valid for Master Index and Simplified Record
		if ( ie_tipo_consentimento_p = 'SEA' or 
			ie_tipo_consentimento_p = 'CMD' or 
			ie_tipo_consentimento_p = 'CNC' ) then
			return_value := ie_function_current_p = 'CCP' or ie_function_current_p = 'CSP' or acc_cad_com_pessoa = 'A' or acc_cad_sim_pessoa = 'A';
		else
			-- Verify default consents valid for Record Physician
			if ( ie_tipo_consentimento_p = 'CCC' or
				ie_tipo_consentimento_p = 'MCM' or 
				ie_tipo_consentimento_p = 'ERM' ) then
				return_value := ie_function_current_p = 'CM' or acc_cad_medico = 'A';
			else
				-- Verify default consents valid for Type Mail
				if ( ie_tipo_consentimento_p = 'EAE' or
					ie_tipo_consentimento_p = 'EPM' or
					ie_tipo_consentimento_p = 'SAE' or
					ie_tipo_consentimento_p = 'SPM' or
					ie_tipo_consentimento_p = 'MAE' or
					ie_tipo_consentimento_p = 'MPM' ) then
					-- Validate current funtion
					return_value := ie_function_current_p = 'CCP' or ie_function_current_p = 'CSP' or ie_function_current_p = 'CF' or ie_function_current_p = 'CM';
					-- Validate access of user
					return_value := return_value or acc_cad_com_pessoa = 'A' or acc_cad_sim_pessoa = 'A' or acc_cad_funcionario = 'A' or acc_cad_medico = 'A';
				else
					-- Verify consents defined by customer:
					-- Validate if Master person index
					return_value := ie_function_p = 'CCP' and acc_cad_com_pessoa = 'A';
					-- Validate if Simplified register of people
					return_value := return_value or (ie_function_p = 'CSP' and acc_cad_sim_pessoa = 'A');
					-- Validate if Employees record
					return_value := return_value or (ie_function_p = 'CF' and acc_cad_funcionario = 'A');
					-- Validate if Physician record
					return_value := return_value or (ie_function_p = 'CM' and acc_cad_medico = 'A');
					-- Validate HPMS - Person  registration
					return_value := return_value or (ie_function_p = 'COPS' and acc_cad_ops_pessoa = 'A');
				end if;
			end if;		
		end if;
	end if;

        if return_value then
            return_value_string := 'true';
        else
            return_value_string := 'false';
        end if;
	return return_value_string;
    END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION consentimento_privacidade_pck.can_modify_consent ( nm_usuario_p usuario.nm_usuario%type, cd_perfil_p usuario_perfil.cd_perfil%type, ie_function_current_p text, ie_tipo_consentimento_p pessoa_fisica_privac_item.ie_tipo_consentimento%type, ie_tipo_documento_p pessoa_fisica_privac_item.ie_tipo_documento%type ) FROM PUBLIC;
