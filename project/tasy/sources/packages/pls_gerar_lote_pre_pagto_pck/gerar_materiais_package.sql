-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_gerar_lote_pre_pagto_pck.gerar_materiais ( nr_seq_lote_p pls_lote_serv_pre_pgto.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE

					
nr_seq_fat_item_w 		pls_fat_conta_item.nr_sequencia%type;
ie_somente_codigo_w		pls_regra_conv_mat_interc.ie_somente_codigo%type;
nr_seq_material_w		pls_material.nr_sequencia%type;
ie_tipo_despesa_w		pls_material.ie_tipo_despesa%type;
cd_servico_mat_w		varchar(50);
ie_tipo_tabela_w		smallint;
	
C01 CURSOR FOR
	SELECT	b.nr_seq_conta,
			b.nr_sequencia
	from	pls_faturamento_prot a,
			pls_faturamento_conta b
	where	a.nr_sequencia = b.nr_seq_protocolo
	and 	a.nr_seq_lote_serv_pre_pgto = nr_seq_lote_p;
	
C02 CURSOR( nr_seq_conta_pc	pls_conta_mat.nr_seq_conta%type)FOR
	SELECT	a.cd_material_imp,
			( 	SELECT max(y.cd_material_tuss)
				from	pls_material x,
						tuss_material_item y
				where	y.nr_sequencia  = x.nr_seq_tuss_mat_item
				and 	x.nr_sequencia = a.nr_seq_material) cd_material_tuss,
			a.cd_ref_fabricante,
			coalesce(a.cd_tipo_tabela_imp, '20') cd_tipo_tabela,
			a.cd_unidade_medida,
			substr(obter_descricao_padrao('PLS_MATERIAL','DS_MATERIAL',a.nr_seq_material),1,255) ds_material,
			a.dt_atendimento_referencia dt_mat,
			a.dt_inicio_atend,
			a.dt_fim_atend,
			a.ie_tipo_despesa_imp,
			a.ie_tipo_despesa,
			a.nr_registro_anvisa,
			a.nr_seq_prest_fornec nr_prest_fornec,
			a.nr_seq_material,
			a.qt_material,
			a.tx_reducao_acrescimo,
			a.vl_material,
			a.vl_unitario,
			a.cd_tipo_tabela_imp,
			a.ie_tipo_cobertura,
			pls_obter_seq_codigo_material(nr_seq_material,'') cd_material_ops,
			a.nr_sequencia
	from	pls_conta_mat a
	where 	a.nr_seq_conta = nr_seq_conta_pc;
		
BEGIN

	for r_c01_w in C01 loop
	
		for r_c02_w in C02(r_c01_w.nr_seq_conta) loop
		
			ie_tipo_despesa_w := null;
			ie_tipo_tabela_w := 0;
			if (r_c02_w.ie_tipo_despesa  = 1) then
				ie_tipo_tabela_w	:= 0;
			elsif (r_c02_w.ie_tipo_despesa = 2) then
				ie_tipo_tabela_w	:= 1;
			elsif (r_c02_w.ie_tipo_despesa = 3) then
				ie_tipo_tabela_w	:= 1;
			elsif (r_c02_w.ie_tipo_despesa = 4) then
				ie_tipo_tabela_w	:= 2;
			end if;
		
			ptu_obter_material_conversao(	r_c02_w.cd_material_ops, ie_tipo_tabela_w, r_c02_w.dt_mat,
						'R', '7', null, 
						null, nr_seq_material_w, cd_servico_mat_w,
						ie_somente_codigo_w );

				
			--Se ocorreu uma conversao, entao determinou que o item e um material.

			if (nr_seq_material_w IS NOT NULL AND nr_seq_material_w::text <> '') then
			
				select max(ie_tipo_despesa)
				into STRICT	ie_tipo_despesa_w
				from	pls_material
				where	nr_sequencia = nr_seq_material_w;
				
			end if;

			insert into pls_fat_conta_item(
				cd_procedimento, cd_procedimento_conv, cd_ref_fabricante,
				cd_tipo_tabela_conv, cd_unidade_medida, ds_procedimento,           
				dt_atualizacao, dt_atualizacao_nrec, dt_execucao,               
				dt_fim, dt_inicio, ie_origem_proced_conv,     
				ie_tecnica_utilizada, ie_tecnica_utilizada_conv, ie_tipo_despesa,           
				ie_tipo_despesa_conv, ie_tipo_item, ie_tipo_item_conv,         
				ie_via_acesso, ie_via_acesso_conv, nm_usuario,                
				nm_usuario_nrec, nr_aut_funcionamento, nr_registro_anvisa,        
				nr_seq_conta, nr_seq_fornec_mat_conv, nr_seq_material_conv,      
				nr_sequencia, qt_executado, tx_item_via_acesso_conv,   
				tx_reducao_acrescimo, vl_total, vl_unitario,
				cd_tipo_tabela)
			values (
				coalesce( cd_servico_mat_w, r_c02_w.cd_material_tuss), coalesce(r_c02_w.cd_material_imp, r_c02_w.cd_material_tuss), r_c02_w.cd_ref_fabricante,
				r_c02_w.cd_tipo_tabela, r_c02_w.cd_unidade_medida, r_c02_w.ds_material,
				clock_timestamp(), clock_timestamp(), r_c02_w.dt_mat,
				r_c02_w.dt_fim_atend, r_c02_w.dt_inicio_atend, null,
				null, null, r_c02_w.ie_tipo_despesa_imp,
				coalesce(ie_tipo_despesa_w, r_c02_w.ie_tipo_despesa), 'OD', 'OD',
				null, null, nm_usuario_p,
				nm_usuario_p, null, r_c02_w.nr_registro_anvisa,
				r_c01_w.nr_sequencia, r_c02_w.nr_prest_fornec, coalesce(nr_seq_material_w, r_c02_w.nr_seq_material), 
				nextval('pls_fat_conta_item_seq'), r_c02_w.qt_material, null,
				r_c02_w.tx_reducao_acrescimo, r_c02_w.vl_material, r_c02_w.vl_unitario, 
				r_c02_w.cd_tipo_tabela_imp
			) returning nr_sequencia into nr_seq_fat_item_w;

			insert into pls_fat_conta_mat(		
				cd_material_conv, cd_ref_fabricante, cd_tipo_tabela_conv,       
				cd_unidade_medida, dt_atualizacao, dt_atualizacao_nrec,       
				dt_execucao_conv, dt_fim, dt_inicio,                 
				ie_tipo_cobertura, ie_tipo_despesa_conv, nm_usuario,                
				nm_usuario_nrec, nr_aut_funcionamento, nr_registro_anvisa,        
				nr_seq_item_conta, nr_seq_material_conv, nr_sequencia,              
				qt_executado, tx_reducao_acrescimo, vl_total,                  
				vl_unitario, nr_seq_conta_mat
			)
			values (
				coalesce( cd_servico_mat_w, r_c02_w.cd_material_tuss), r_c02_w.cd_ref_fabricante, r_c02_w.cd_tipo_tabela,
				r_c02_w.cd_unidade_medida, clock_timestamp(), clock_timestamp(),
				r_c02_w.dt_mat, r_c02_w.dt_fim_atend, r_c02_w.dt_inicio_atend,
				r_c02_w.ie_tipo_cobertura, coalesce(ie_tipo_despesa_w, r_c02_w.ie_tipo_despesa), nm_usuario_p,
				nm_usuario_p, null, r_c02_w.nr_registro_anvisa,
				nr_seq_fat_item_w, coalesce(nr_seq_material_w, r_c02_w.nr_seq_material), nextval('pls_fat_conta_mat_seq'),
				r_c02_w.qt_material, r_c02_w.tx_reducao_acrescimo, r_c02_w.vl_material, 
				r_c02_w.vl_unitario, r_c02_w.nr_sequencia
			);
				
		end loop;

	end loop;


END;	

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_lote_pre_pagto_pck.gerar_materiais ( nr_seq_lote_p pls_lote_serv_pre_pgto.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;
