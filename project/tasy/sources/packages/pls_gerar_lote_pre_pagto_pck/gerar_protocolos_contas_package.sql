-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_gerar_lote_pre_pagto_pck.gerar_protocolos_contas ( nr_seq_lote_p pls_lote_serv_pre_pgto.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE


dt_geracao_lote_w			pls_lote_serv_pre_pgto.dt_geracao_lote%type;
nr_seq_congenere_lote_w		pls_lote_serv_pre_pgto.nr_seq_congenere%type;
dt_inicio_pagto_w			pls_lote_serv_pre_pgto.dt_inicio%type;
dt_fim_pagto_w				pls_lote_serv_pre_pgto.dt_inicio%type;
ds_nome_congenere_w			pessoa_juridica.ds_razao_social%type;
nr_seq_prot_fat_w			pls_faturamento_prot.nr_sequencia%type;
nr_seq_conta_fat_w			pls_faturamento_conta.nr_sequencia%type;

C00 CURSOR FOR
	SELECT	d.nr_seq_conta_proc
	from	pls_conta			a,
			pls_conta_medica_resumo		d,
			pls_segurado			b,
			pls_lote_pagamento		e,
			pls_intercambio			c
	where	d.nr_seq_conta			= a.nr_sequencia
	and	a.nr_seq_segurado			= b.nr_sequencia
	and	d.nr_seq_lote_pgto			= e.nr_sequencia
	and	b.nr_seq_intercambio		= c.nr_sequencia
	and	b.ie_tipo_repasse			= 'P'
	and	e.ie_status					= 'D'
	and	e.dt_mes_competencia		between dt_inicio_pagto_w and fim_dia(dt_fim_pagto_w)
	and	((c.nr_seq_congenere		= nr_seq_congenere_lote_w) or (coalesce(nr_seq_congenere_lote_w::text, '') = ''))
	and	(e.dt_geracao_titulos IS NOT NULL AND e.dt_geracao_titulos::text <> '')
	and	coalesce(d.nr_seq_serv_pre_pgto, 0) = 0
	and	coalesce(d.nr_seq_lote_pgto, 0) <> 0
	
union all

	SELECT	d.nr_seq_conta_proc
	from	pls_conta			a,
			pls_conta_medica_resumo		d,
			pls_segurado				b,
			pls_lote_pagamento			e,
			pls_pagamento_prestador		f,
			pls_intercambio				c,
			pls_prestador				g
	where	d.nr_seq_conta			= a.nr_sequencia
	and	a.nr_seq_segurado			= b.nr_sequencia
	and	d.nr_seq_lote_pgto			= e.nr_sequencia
	and	f.NR_SEQ_LOTE				= e.nr_sequencia
	and	b.nr_seq_intercambio		= c.nr_sequencia
	and	f.nr_seq_prestador			= g.nr_sequencia
	and	b.ie_tipo_repasse			= 'P'
	and	e.ie_status					= 'D'
	and	e.dt_mes_competencia between dt_inicio_pagto_w and fim_dia(dt_fim_pagto_w)
	and	((c.nr_seq_congenere		= nr_seq_congenere_lote_w) or (coalesce(nr_seq_congenere_lote_w::text, '') = ''))
	and	(e.DT_GERACAO_VENCIMENTOS IS NOT NULL AND e.DT_GERACAO_VENCIMENTOS::text <> '')
	and	coalesce(d.nr_seq_serv_pre_pgto, 0) = 0
	and	coalesce(d.nr_seq_lote_pgto, 0) <> 0
	
union all

	select	d.nr_seq_conta_proc
	from	pls_conta			a,
			pls_conta_medica_resumo		d,
			pls_segurado			b,
			pls_pp_lote		e,
			pls_intercambio			c
	where	d.nr_seq_conta			= a.nr_sequencia
	and	a.nr_seq_segurado			= b.nr_sequencia
	and	d.nr_seq_pp_lote			= e.nr_sequencia
	and	b.nr_seq_intercambio		= c.nr_sequencia
	and	b.ie_tipo_repasse			= 'P'
	and	e.ie_status					= 'D'
	and	e.dt_mes_competencia		between dt_inicio_pagto_w and fim_dia(dt_fim_pagto_w)
	and	((c.nr_seq_congenere		= nr_seq_congenere_lote_w) or (coalesce(nr_seq_congenere_lote_w::text, '') = ''))
	and	(e.dt_geracao_titulo IS NOT NULL AND e.dt_geracao_titulo::text <> '')
	and	coalesce(d.nr_seq_serv_pre_pgto, 0) = 0
	and	coalesce(d.nr_seq_pp_lote, 0) <> 0
	
union all

	select	d.nr_seq_conta_proc
	from	pls_conta				a,
			pls_conta_medica_resumo	d,
			pls_segurado			b,
			pls_pp_lote				e,
			pls_pp_prestador		f,
			pls_intercambio			c,
			pls_prestador			g
	where	d.nr_seq_conta			= a.nr_sequencia
	and	a.nr_seq_segurado			= b.nr_sequencia
	and	d.nr_seq_pp_lote			= e.nr_sequencia
	and	f.NR_SEQ_LOTE				= e.nr_sequencia
	and	b.nr_seq_intercambio		= c.nr_sequencia
	and	f.nr_seq_prestador			= g.nr_sequencia
	and	b.ie_tipo_repasse			= 'P'
	and	e.ie_status					= 'D'
	and	e.dt_mes_competencia between dt_inicio_pagto_w and fim_dia(dt_fim_pagto_w)
	and	((c.nr_seq_congenere		= nr_seq_congenere_lote_w) or (coalesce(nr_seq_congenere_lote_w::text, '') = ''))
	and	(e.dt_fechamento IS NOT NULL AND e.dt_fechamento::text <> '')  --no pagamento novo o dt_fechamento e equivalente ao dt_geracao_vencimentos
	and	coalesce(d.nr_seq_serv_pre_pgto, 0) = 0
	and	coalesce(d.nr_seq_pp_lote, 0) <> 0
	group by d.nr_seq_conta_proc;
	
C01 CURSOR FOR
	SELECT	d.nr_seq_conta_mat
	from	pls_conta			a,
			pls_conta_medica_resumo		d,
			pls_segurado			b,
			pls_lote_pagamento		e,
			pls_intercambio			c
	where	d.nr_seq_conta			= a.nr_sequencia
	and	a.nr_seq_segurado			= b.nr_sequencia
	and	d.nr_seq_lote_pgto			= e.nr_sequencia
	and	b.nr_seq_intercambio		= c.nr_sequencia
	and	b.ie_tipo_repasse			= 'P'
	and	e.ie_status					= 'D'
	and	e.dt_mes_competencia between dt_inicio_pagto_w and fim_dia(dt_fim_pagto_w)
	and	((c.nr_seq_congenere		= nr_seq_congenere_lote_w) or (coalesce(nr_seq_congenere_lote_w::text, '') = ''))
	and	(e.dt_geracao_titulos IS NOT NULL AND e.dt_geracao_titulos::text <> '')
	and	coalesce(d.nr_seq_serv_pre_pgto, 0) = 0
	and	coalesce(d.nr_seq_lote_pgto, 0) <> 0
	
union all

	SELECT	d.nr_seq_conta_mat
	from	pls_conta					a,
			pls_conta_medica_resumo		d,
			pls_segurado				b,
			pls_lote_pagamento			e,
			pls_pagamento_prestador		f,
			pls_intercambio				c,
			pls_prestador				g
	where	d.nr_seq_conta		= a.nr_sequencia
	and	a.nr_seq_segurado		= b.nr_sequencia
	and	d.nr_seq_lote_pgto		= e.nr_sequencia
	and	f.NR_SEQ_LOTE			= e.nr_sequencia
	and	b.nr_seq_intercambio	= c.nr_sequencia
	and	f.nr_seq_prestador		= g.nr_sequencia
	and	b.ie_tipo_repasse		= 'P'
	and	e.ie_status				= 'D'
	and	e.dt_mes_competencia between dt_inicio_pagto_w and fim_dia(dt_fim_pagto_w)
	and	((c.nr_seq_congenere	= nr_seq_congenere_lote_w) or (coalesce(nr_seq_congenere_lote_w::text, '') = ''))
	and	(e.DT_GERACAO_VENCIMENTOS IS NOT NULL AND e.DT_GERACAO_VENCIMENTOS::text <> '')
	and	coalesce(d.nr_seq_serv_pre_pgto, 0) = 0
	and	coalesce(d.nr_seq_lote_pgto, 0) <> 0
	
union all

	select	d.nr_seq_conta_mat
	from	pls_conta			a,
			pls_conta_medica_resumo		d,
			pls_segurado			b,
			pls_pp_lote		e,
			pls_intercambio			c
	where	d.nr_seq_conta			= a.nr_sequencia
	and	a.nr_seq_segurado			= b.nr_sequencia
	and	d.nr_seq_pp_lote			= e.nr_sequencia
	and	b.nr_seq_intercambio		= c.nr_sequencia
	and	b.ie_tipo_repasse			= 'P'
	and	e.ie_status					= 'D'
	and	e.dt_mes_competencia between dt_inicio_pagto_w and fim_dia(dt_fim_pagto_w)
	and	((c.nr_seq_congenere		= nr_seq_congenere_lote_w) or (coalesce(nr_seq_congenere_lote_w::text, '') = ''))
	and	(e.dt_geracao_titulo IS NOT NULL AND e.dt_geracao_titulo::text <> '')
	and	coalesce(d.nr_seq_serv_pre_pgto, 0) = 0
	and	coalesce(d.nr_seq_pp_lote, 0) <> 0
	
union all

	select	d.nr_seq_conta_mat
	from	pls_conta					a,
			pls_conta_medica_resumo		d,
			pls_segurado				b,
			pls_pp_lote					e,
			pls_pp_prestador			f,
			pls_intercambio				c,
			pls_prestador				g
	where	d.nr_seq_conta		= a.nr_sequencia
	and	a.nr_seq_segurado		= b.nr_sequencia
	and	d.nr_seq_pp_lote		= e.nr_sequencia
	and	f.NR_SEQ_LOTE			= e.nr_sequencia
	and	b.nr_seq_intercambio	= c.nr_sequencia
	and	f.nr_seq_prestador		= g.nr_sequencia
	and	b.ie_tipo_repasse		= 'P'
	and	e.ie_status				= 'D'
	and	e.dt_mes_competencia between dt_inicio_pagto_w and fim_dia(dt_fim_pagto_w)
	and	((c.nr_seq_congenere	= nr_seq_congenere_lote_w) or (coalesce(nr_seq_congenere_lote_w::text, '') = ''))
	and	(e.dt_fechamento IS NOT NULL AND e.dt_fechamento::text <> '')   --no pagamento novo o dt_fechamento e equivalente ao dt_geracao_vencimentos
	and	coalesce(d.nr_seq_serv_pre_pgto, 0) = 0
	and	coalesce(d.nr_seq_pp_lote, 0) <> 0
	group by d.nr_seq_conta_mat;
	
C02 CURSOR(	nr_seq_conta_proc_pc	pls_conta_proc.nr_sequencia%type) FOR
	SELECT 	a.nr_seq_conta,
			a.nr_seq_protocolo,
			a.cd_pessoa_fisica_prest_prot,
			a.cd_cgc_prest_prot,
			b.cd_versao_tiss,
			b.dt_mes_competencia,
			b.ie_guia_fisica,
			b.cd_ans,
			(	SELECT	max(cd_ans)
				from 	pls_congenere 
				where 	nr_sequencia = b.nr_seq_congenere_prot) cd_ans_destino,
			( 	select 	max(cd_cbo) 
				from 	cbo_saude 
				where 	nr_sequencia = b.nr_seq_cbo_saude) cd_cbo_saude_exec,
			( 	select 	max(cd_cbo) 
				from 	cbo_saude 
				where 	nr_sequencia = b.nr_seq_cbo_saude) cd_cbo_saude_solic,
			(	select max(cd_cgc) from pls_prestador where nr_sequencia = b.nr_seq_prestador_exec) cd_cgc_prest_exec,
			(	select max(cd_pessoa_fisica) from pls_prestador where nr_sequencia = b.nr_seq_prestador_exec) cd_cpf_prest_exec,
			(	select max(cd_cgc) from pls_prestador where nr_sequencia = b.nr_seq_prestador_solic) cd_cgc_prest_solic,
			(	select max(cd_pessoa_fisica) from pls_prestador where nr_sequencia = b.nr_seq_prestador_solic) cd_cpf_prest_solic,
			b.cd_guia,
			b.cd_guia_prestador,
			b.cd_guia_referencia,
			b.cd_cnes,
			b.cd_senha,
			b.cd_usuario_plano,
			b.dt_atendimento,
			b.dt_autorizacao,
			b.dt_emissao,
			b.dt_inicio_faturamento,
			b.dt_fim_faturamento,
			b.dt_validade_senha,
			b.ie_carater_internacao ie_carater_atendimento, 
			b.ie_indicacao_acidente,
			b.ie_motivo_encerramento,
			b.ie_recem_nascido,
			b.ie_regime_internacao,
			(	select	max(cd_tiss)
				from	pls_tipo_atendimento
				where	nr_sequencia = b.nr_seq_tipo_atendimento) ie_tipo_atendimento,
			b.ie_tipo_consulta,
			b.ie_tipo_faturamento,
			(
				select	max(a.cd_tiss)
				from	pls_clinica a
				where	a.nr_sequencia = b.nr_seq_clinica ) ie_tipo_internacao,
			b.ie_tipo_guia,
			substr(pls_obter_dados_prestador(b.nr_seq_prestador_exec,'N'),1,255) nm_hospital_exec,
			pls_obter_dados_medico(b.cd_medico_executor, 'NM') nm_medico_exec,
			pls_obter_dados_medico(b.cd_medico_solicitante, 'NM') nm_medico_solic,
			pls_obter_dados_prestador(b.nr_seq_prestador_exec, 'N') nm_prestador_exec,
			substr(pls_obter_dados_segurado(b.nr_seq_segurado,'N'),1,255) nm_benef,
			b.nr_seq_segurado,
			b.nr_crm_exec,
			b.nr_crm_solic_imp,
			b.nr_seq_saida_int nr_seq_motivo_encerramento,
			b.sg_conselho_exec,
			b.sg_conselho_solic,
			b.uf_crm_exec,
			b.uf_crm_solic_imp,
			b.vl_diarias,
			b.vl_gases,
			b.vl_materiais,
			b.vl_medicamentos,
			b.vl_opm,
			b.vl_procedimentos,
			b.vl_taxas,
			b.vl_total,
			b.ie_cobertura_especial,
			b.ie_regime_atendimento,
			b.ie_saude_ocupacional
	from	pls_conta_proc_v a,
			pls_conta_v b
	where	a.nr_sequencia = nr_seq_conta_proc_pc
	and 	a.nr_seq_conta = b.nr_sequencia;
	
	--pls_obter_seq_mot_saida_tiss(b.ie_motivo_encerramento, a.cd_versao_tiss, cd_estabelecimento_p) nr_seq_motivo_encerramento,

	
C03 CURSOR(	nr_seq_conta_mat_pc	pls_conta_mat.nr_sequencia%type) FOR
	SELECT 	a.nr_seq_conta,
			a.nr_seq_protocolo,
			a.cd_pessoa_fisica_prest_prot,
			a.cd_cgc_prest_prot,
			b.cd_versao_tiss,
			b.dt_mes_competencia,
			b.ie_guia_fisica,
			b.cd_ans,
			(	SELECT	max(cd_ans)
				from 	pls_congenere 
				where 	nr_sequencia = b.nr_seq_congenere_prot) cd_ans_destino,
			( 	select 	max(cd_cbo) 
				from 	cbo_saude 
				where 	nr_sequencia = b.nr_seq_cbo_saude) cd_cbo_saude_exec,
			( 	select 	max(cd_cbo) 
				from 	cbo_saude 
				where 	nr_sequencia = b.nr_seq_cbo_saude) cd_cbo_saude_solic,
			(	select max(cd_cgc) from pls_prestador where nr_sequencia = b.nr_seq_prestador_exec) cd_cgc_prest_exec,
			(	select max(cd_pessoa_fisica) from pls_prestador where nr_sequencia = b.nr_seq_prestador_exec) cd_cpf_prest_exec,
			(	select max(cd_cgc) from pls_prestador where nr_sequencia = b.nr_seq_prestador_solic) cd_cgc_prest_solic,
			(	select max(cd_pessoa_fisica) from pls_prestador where nr_sequencia = b.nr_seq_prestador_solic) cd_cpf_prest_solic,
			b.cd_guia,
			b.cd_guia_prestador,
			b.cd_guia_referencia,
			b.cd_cnes,
			b.cd_senha,
			b.cd_usuario_plano,
			b.dt_atendimento,
			b.dt_autorizacao,
			b.dt_emissao,
			b.dt_inicio_faturamento,
			b.dt_fim_faturamento,
			b.dt_validade_senha,
			b.ie_carater_internacao ie_carater_atendimento, 
			b.ie_indicacao_acidente,
			b.ie_motivo_encerramento,
			b.ie_recem_nascido,
			b.ie_regime_internacao,
			(	select	max(cd_tiss)
				from	pls_tipo_atendimento
				where	nr_sequencia			= b.nr_seq_tipo_atendimento) ie_tipo_atendimento,
			b.ie_tipo_consulta,
			b.ie_tipo_faturamento,
			(
				select	max(a.cd_tiss)
				from	pls_clinica a
				where	a.nr_sequencia = b.nr_seq_clinica ) ie_tipo_internacao,
			b.ie_tipo_guia,
			substr(pls_obter_dados_prestador(b.nr_seq_prestador_exec,'N'),1,255) nm_hospital_exec,
			pls_obter_dados_medico(b.cd_medico_executor, 'NM') nm_medico_exec,
			pls_obter_dados_medico(b.cd_medico_solicitante, 'NM') nm_medico_solic,
			pls_obter_dados_prestador(b.nr_seq_prestador_exec, 'N') nm_prestador_exec,
			substr(pls_obter_dados_segurado(b.nr_seq_segurado,'N'),1,255) nm_benef,
			b.nr_crm_exec,
			b.nr_crm_solic_imp,
			b.nr_seq_saida_int nr_seq_motivo_encerramento,
			b.sg_conselho_exec,
			b.sg_conselho_solic,
			b.uf_crm_exec,
			b.uf_crm_solic_imp,
			b.vl_diarias,
			b.vl_gases,
			b.vl_materiais,
			b.vl_medicamentos,
			b.vl_opm,
			b.vl_procedimentos,
			b.vl_taxas,
			b.vl_total,
			b.ie_cobertura_especial,
			b.ie_regime_atendimento,
			b.ie_saude_ocupacional
	from	pls_conta_mat_v a,
			pls_conta_v b
	where	a.nr_sequencia = nr_seq_conta_mat_pc
	and 	a.nr_seq_conta = b.nr_sequencia;

BEGIN

select	dt_geracao_lote,
		nr_seq_congenere,
		trunc(dt_inicio,'month'),
		last_day(dt_inicio)
into STRICT	dt_geracao_lote_w,
		nr_seq_congenere_lote_w,
		dt_inicio_pagto_w,
		dt_fim_pagto_w
from	pls_lote_serv_pre_pgto
where	nr_sequencia	= nr_seq_lote_p;

-- Data final nunca pode ser maior que a data atual

if (dt_fim_pagto_w > clock_timestamp()) then
	dt_fim_pagto_w := clock_timestamp();
end if;

for r_c00_w in C00 loop

	for r_c02_w in C02(r_c00_w.nr_seq_conta_proc) loop
	
		select 	max(nr_sequencia)
		into STRICT	nr_seq_prot_fat_w
		from	pls_faturamento_prot
		where 	nr_seq_protocolo = r_c02_w.nr_seq_protocolo
		and 	nr_seq_lote_serv_pre_pgto = nr_seq_lote_p;
	
		if (coalesce(nr_seq_prot_fat_w::text, '') = '') then
				
			--Para exportacao nao ira codigo de outorgante e seq_prestador_inter e sim a identificacao do cd_ans e cgc ou cpf prestador

			insert into pls_faturamento_prot(
				cd_ans, cd_ans_destino, cd_cgc_prestador,
				cd_cpf_prestador, cd_estabelecimento, cd_versao_tiss,         
				ds_hash, dt_atualizacao, dt_atualizacao_nrec,    
				dt_integracao, dt_mes_competencia_conv, dt_recebimento_conv,    
				ie_guia_fisica_conv, ie_tipo_faturamento, nm_usuario,             
				nm_usuario_nrec, nr_seq_fat_arquivo, nr_seq_outorgante,      
				nr_seq_prest_inter, nr_seq_protocolo, nr_sequencia,
				nr_seq_lote_serv_pre_pgto)
			values ( r_c02_w.cd_ans, r_c02_w.cd_ans_destino, r_c02_w.cd_cgc_prest_prot,
				r_c02_w.cd_pessoa_fisica_prest_prot, cd_estabelecimento_p, r_c02_w.cd_versao_tiss,
				null, clock_timestamp(), clock_timestamp(),
				null, r_c02_w.dt_mes_competencia,null,
				r_c02_w.ie_guia_fisica, 'PRE', nm_usuario_p,
				nm_usuario_p, null, null,
				null, r_c02_w.nr_seq_protocolo, nextval('pls_faturamento_prot_seq'),
				nr_seq_lote_p) returning nr_sequencia into  nr_seq_prot_fat_w;		
	
		end if;
		
		select max(nr_sequencia)
		into STRICT	nr_seq_conta_fat_w
		from	pls_faturamento_conta
		where 	nr_seq_conta = r_c02_w.nr_seq_conta
		and 	nr_seq_protocolo = nr_seq_prot_fat_w;
				
		if (coalesce(nr_seq_conta_fat_w::text, '') = '') then
			
			insert into pls_faturamento_conta(
						cd_cbo_saude_exec_imp, cd_cbo_saude_solic_imp, cd_cgc_prest_exec,
						cd_cgc_prest_solic, cd_cgc_prest_solic_conv, cd_cnes,                               
						cd_cnes_hosp_exec, cd_cnpj_hosp_exec, cd_cpf_prest_exec,                                      
						cd_cpf_prest_solic, cd_guia_operadora, cd_guia_prestador,                                      
						cd_guia_principal, cd_medico_executor_imp, cd_medico_solicitante_imp,                             
						cd_senha, cd_usuario_plano, dt_atendimento,                                         
						dt_atualizacao, dt_atualizacao_nrec, dt_autorizacao,                        
						dt_emissao_guia, dt_fim_faturamento, dt_inicio_faturamento,                 
						dt_validade_senha, ie_carater_atendimento, ie_indicacao_acidente,                 
						ie_motivo_encerramento, ie_recem_nascido, ie_recem_nascido_imp,                  
						ie_regime_internacao, ie_tipo_atendimento, ie_tipo_consulta,                      
						ie_tipo_faturamento, ie_tipo_guia, ie_tipo_internacao,                    
						ie_tipo_internacao_conv, nm_hosp_exec, nm_medico_executor_imp,                
						nm_medico_solic_imp, nm_prestador_exec_imp, nm_prestador_imp,                      
						nm_segurado_imp, nm_usuario, nm_usuario_nrec,                       
						nr_crm_exec_imp, nr_crm_solic_imp, nr_seq_conta,                          
						nr_seq_motivo_encerramento, nr_seq_prest_inter, nr_seq_prest_solic_inter,              
						nr_seq_protocolo, nr_seq_segurado_conv, nr_seq_tipo_atend_conv,                
						nr_sequencia, sg_conselho_exec_imp, sg_conselho_solic_imp,                 
						uf_crm_exec_imp, uf_crm_solic_imp, vl_diarias_imp,                        
						vl_gases_imp, vl_materiais_imp, vl_medicamentos_imp,                   
						vl_opm_imp, vl_procedimentos_imp, vl_taxas_imp,                          
						vl_total_imp, ie_cobertura_especial, ie_regime_atendimento, ie_saude_ocupacional )
			values (	r_c02_w.cd_cbo_saude_exec, r_c02_w.cd_cbo_saude_solic, r_c02_w.cd_cgc_prest_exec,
			r_c02_w.cd_cgc_prest_solic, r_c02_w.cd_cgc_prest_solic, r_c02_w.cd_cnes,
			r_c02_w.cd_cnes, null, r_c02_w.cd_cpf_prest_exec,
			r_c02_w.cd_cpf_prest_solic, r_c02_w.cd_guia, r_c02_w.cd_guia_prestador,
			r_c02_w.cd_guia_referencia, null, null,
			r_c02_w.cd_senha, r_c02_w.cd_usuario_plano, r_c02_w.dt_atendimento,
			clock_timestamp(), clock_timestamp(), r_c02_w.dt_autorizacao, 
			r_c02_w.dt_emissao, r_c02_w.dt_fim_faturamento, r_c02_w.dt_inicio_faturamento,
			r_c02_w.dt_validade_senha, r_c02_w.ie_carater_atendimento, r_c02_w. ie_indicacao_acidente,
			r_c02_w.ie_motivo_encerramento, r_c02_w.ie_recem_nascido, null,
			r_c02_w.ie_regime_internacao, r_c02_w.ie_tipo_atendimento, r_c02_w.ie_tipo_consulta,
			r_c02_w.ie_tipo_faturamento, r_c02_w.ie_tipo_guia, r_c02_w.ie_tipo_internacao,
			null, r_c02_w.nm_hospital_exec, r_c02_w.nm_medico_exec,
			r_c02_w.nm_medico_solic, r_c02_w.nm_prestador_exec, null,
			r_c02_w.nm_benef, nm_usuario_p, nm_usuario_p,
			r_c02_w.nr_crm_exec, r_c02_w.nr_crm_solic_imp, r_c02_w.nr_seq_conta,
			r_c02_w.nr_seq_motivo_encerramento, null, null,
			nr_seq_prot_fat_w, r_c02_w.nr_seq_segurado, null,
			nextval('pls_faturamento_conta_seq'), r_c02_w.sg_conselho_exec, r_c02_w.sg_conselho_solic, 
			r_c02_w.uf_crm_exec, r_c02_w.uf_crm_solic_imp, r_c02_w.vl_diarias,
			r_c02_w.vl_gases, r_c02_w.vl_materiais, r_c02_w.vl_medicamentos, r_c02_w.vl_opm,
			r_c02_w.vl_procedimentos, r_c02_w.vl_taxas, r_c02_w.vl_total,
			r_c02_w.ie_cobertura_especial, r_c02_w.ie_regime_atendimento, r_c02_w.ie_saude_ocupacional
			) returning nr_sequencia into nr_seq_conta_fat_w;
	
		end if;

	end loop;

end loop;

for r_c01_w in C01 loop

	for r_c03_w in C03(r_c01_w.nr_seq_conta_mat) loop
	
		select 	max(nr_sequencia)
		into STRICT	nr_seq_prot_fat_w
		from	pls_faturamento_prot
		where 	nr_seq_protocolo = r_c03_w.nr_seq_protocolo
		and 	nr_seq_lote_serv_pre_pgto = nr_seq_lote_p;
		
		if (coalesce(nr_seq_prot_fat_w::text, '') = '') then
				
			--Para exportacao nao ira codigo de outorgante e seq_prestador_inter e sim a identificacao do cd_ans e cgc ou cpf prestador

			insert into pls_faturamento_prot(
				cd_ans, cd_ans_destino, cd_cgc_prestador,
				cd_cpf_prestador, cd_estabelecimento, cd_versao_tiss,         
				ds_hash, dt_atualizacao, dt_atualizacao_nrec,    
				dt_integracao, dt_mes_competencia_conv, dt_recebimento_conv,    
				ie_guia_fisica_conv, ie_tipo_faturamento, nm_usuario,             
				nm_usuario_nrec, nr_seq_fat_arquivo, nr_seq_outorgante,      
				nr_seq_prest_inter, nr_seq_protocolo, nr_sequencia,
				nr_seq_lote_serv_pre_pgto)
			values ( r_c03_w.cd_ans, r_c03_w.cd_ans_destino, r_c03_w.cd_cgc_prest_prot,
				r_c03_w.cd_pessoa_fisica_prest_prot, cd_estabelecimento_p, r_c03_w.cd_versao_tiss,
				null, clock_timestamp(), clock_timestamp(),
				null, r_c03_w.dt_mes_competencia,null,
				r_c03_w.ie_guia_fisica, 'PRE', nm_usuario_p,
				nm_usuario_p, null, null,
				null, r_c03_w.nr_seq_protocolo, nextval('pls_faturamento_prot_seq'),
				nr_seq_lote_p) returning nr_sequencia into nr_seq_prot_fat_w;
	
		end if;
	
		select max(nr_sequencia)
		into STRICT	nr_seq_conta_fat_w
		from	pls_faturamento_conta
		where 	nr_seq_conta = r_c03_w.nr_seq_conta
		and 	nr_seq_protocolo = nr_seq_prot_fat_w;
				
		if (coalesce(nr_seq_conta_fat_w::text, '') = '') then
			
			insert into pls_faturamento_conta(
						cd_cbo_saude_exec_imp, cd_cbo_saude_solic_imp, cd_cgc_prest_exec,
						cd_cgc_prest_solic, cd_cgc_prest_solic_conv, cd_cnes,                               
						cd_cnes_hosp_exec, cd_cnpj_hosp_exec, cd_cpf_prest_exec,                                      
						cd_cpf_prest_solic, cd_guia_operadora, cd_guia_prestador,                                      
						cd_guia_principal, cd_medico_executor_imp, cd_medico_solicitante_imp,                             
						cd_senha, cd_usuario_plano, dt_atendimento,                                         
						dt_atualizacao, dt_atualizacao_nrec, dt_autorizacao,                        
						dt_emissao_guia, dt_fim_faturamento, dt_inicio_faturamento,                 
						dt_validade_senha, ie_carater_atendimento, ie_indicacao_acidente,                 
						ie_motivo_encerramento, ie_recem_nascido, ie_recem_nascido_imp,                  
						ie_regime_internacao, ie_tipo_atendimento, ie_tipo_consulta,                      
						ie_tipo_faturamento, ie_tipo_guia, ie_tipo_internacao,                    
						ie_tipo_internacao_conv, nm_hosp_exec, nm_medico_executor_imp,                
						nm_medico_solic_imp, nm_prestador_exec_imp, nm_prestador_imp,                      
						nm_segurado_imp, nm_usuario, nm_usuario_nrec,                       
						nr_crm_exec_imp, nr_crm_solic_imp, nr_seq_conta,                          
						nr_seq_motivo_encerramento, nr_seq_prest_inter, nr_seq_prest_solic_inter,              
						nr_seq_protocolo, nr_seq_segurado_conv, nr_seq_tipo_atend_conv,                
						nr_sequencia, sg_conselho_exec_imp, sg_conselho_solic_imp,                 
						uf_crm_exec_imp, uf_crm_solic_imp, vl_diarias_imp,                        
						vl_gases_imp, vl_materiais_imp, vl_medicamentos_imp,                   
						vl_opm_imp, vl_procedimentos_imp, vl_taxas_imp,                          
						vl_total_imp, ie_cobertura_especial, ie_regime_atendimento, ie_saude_ocupacional )
			values (	r_c03_w.cd_cbo_saude_exec, r_c03_w.cd_cbo_saude_solic, r_c03_w.cd_cgc_prest_exec,
			r_c03_w.cd_cgc_prest_solic, r_c03_w.cd_cgc_prest_solic, r_c03_w.cd_cnes,
			r_c03_w.cd_cnes, null, r_c03_w.cd_cpf_prest_exec,
			r_c03_w.cd_cpf_prest_solic, r_c03_w.cd_guia, r_c03_w.cd_guia_prestador,
			r_c03_w.cd_guia_referencia, null, null,
			r_c03_w.cd_senha, r_c03_w.cd_usuario_plano, r_c03_w.dt_atendimento,
			clock_timestamp(), clock_timestamp(), r_c03_w.dt_autorizacao, 
			r_c03_w.dt_emissao, r_c03_w.dt_fim_faturamento, r_c03_w.dt_inicio_faturamento,
			r_c03_w.dt_validade_senha, r_c03_w.ie_carater_atendimento, r_c03_w. ie_indicacao_acidente,
			r_c03_w.ie_motivo_encerramento, r_c03_w.ie_recem_nascido, null,
			r_c03_w.ie_regime_internacao, r_c03_w.ie_tipo_atendimento, r_c03_w.ie_tipo_consulta,
			r_c03_w.ie_tipo_faturamento, r_c03_w.ie_tipo_guia, r_c03_w.ie_tipo_internacao,
			null, r_c03_w.nm_hospital_exec, r_c03_w.nm_medico_exec,
			r_c03_w.nm_medico_solic, r_c03_w.nm_prestador_exec, null,
			r_c03_w.nm_benef, nm_usuario_p, nm_usuario_p,
			r_c03_w.nr_crm_exec, r_c03_w.nr_crm_solic_imp, r_c03_w.nr_seq_conta,
			r_c03_w.nr_seq_motivo_encerramento, null, null,
			nr_seq_prot_fat_w, null, null,
			nextval('pls_faturamento_conta_seq'), r_c03_w.sg_conselho_exec, r_c03_w.sg_conselho_solic, 
			r_c03_w.uf_crm_exec, r_c03_w.uf_crm_solic_imp, r_c03_w.vl_diarias,
			r_c03_w.vl_gases, r_c03_w.vl_materiais, r_c03_w.vl_medicamentos, r_c03_w.vl_opm,
			r_c03_w.vl_procedimentos, r_c03_w.vl_taxas, r_c03_w.vl_total,
			r_c03_w.ie_cobertura_especial, r_c03_w.ie_regime_atendimento, r_c03_w.ie_saude_ocupacional
			) returning nr_sequencia into nr_seq_conta_fat_w;
			
		end if;
	
	end loop;

end loop;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_lote_pre_pagto_pck.gerar_protocolos_contas ( nr_seq_lote_p pls_lote_serv_pre_pgto.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;
