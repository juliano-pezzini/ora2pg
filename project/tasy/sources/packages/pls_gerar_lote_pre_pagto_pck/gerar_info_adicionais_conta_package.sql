-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_gerar_lote_pre_pagto_pck.gerar_info_adicionais_conta ( nr_seq_lote_p pls_lote_serv_pre_pgto.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE


C01 CURSOR FOR
	SELECT	b.nr_seq_conta,
			b.nr_sequencia
	from	pls_faturamento_prot a,
			pls_faturamento_conta b
	where	a.nr_sequencia = b.nr_seq_protocolo
	and 	a.nr_seq_lote_serv_pre_pgto = nr_seq_lote_p;
	
C02 CURSOR(	nr_seq_conta_pc	pls_conta.nr_sequencia%type) FOR
	SELECT	nr_decl_nasc_vivo,
			nr_decl_nasc_vivo_imp,
			ie_indicador_dorn,
			ie_indicador_dorn_imp
	from	pls_diagnostico_nasc_vivo
	where	nr_seq_conta = nr_seq_conta_pc;
	
C03 CURSOR(	nr_seq_conta_pc	pls_conta.nr_sequencia%type) FOR
	SELECT	nr_declaracao_obito,
			nr_declaracao_obito_imp,
			ie_indicador_dorn,
			ie_indicador_dorn_imp,
			cd_doenca,
			cd_doenca_imp
	from	pls_diagnost_conta_obito
	where	nr_seq_conta = nr_seq_conta_pc;
	
C04 CURSOR(	nr_seq_conta_pc	pls_conta.nr_sequencia%type) FOR
	SELECT	ie_classificacao,
			ie_classificacao_imp,
			cd_doenca,
			cd_doenca_imp
	from	pls_diagnostico_conta
	where	nr_seq_conta = nr_seq_conta_pc;
	
BEGIN

	--Navegacao entre contas vinculadas ao lote gerado

	for r_c01_w in C01 loop
	
		--Declaracao de nascidos vivos da conta.

		for r_c02_w in C02(r_c01_w.nr_seq_conta) loop

			insert into pls_fat_decl_conta_vivo(	nr_sequencia, nr_seq_conta, nr_declaracao,
				nm_usuario_nrec, nm_usuario, ie_indicador_dorn, 
				dt_atualizacao_nrec, dt_atualizacao)
			values (nextval('pls_fat_decl_conta_vivo_seq'), r_c01_w.nr_sequencia, coalesce(r_c02_w.nr_decl_nasc_vivo, r_c02_w.nr_decl_nasc_vivo_imp),
					nm_usuario_p, nm_usuario_p, coalesce(r_c02_w.ie_indicador_dorn, r_c02_w.ie_indicador_dorn_imp),
					clock_timestamp(), clock_timestamp()
			);
		end loop;
		
		--Declaracao de obitos  da conta.

		for r_c03_w in C03(r_c01_w.nr_seq_conta) loop
			
			insert into pls_fat_decl_conta_obito(	cd_doenca_obito, cd_doenca_obito_conv, dt_atualizacao,
				dt_atualizacao_nrec, ie_indicador_dorn, nm_usuario,          
				nm_usuario_nrec, nr_declaracao, nr_seq_conta,        
				nr_sequencia)
			values ( coalesce(r_c03_w.cd_doenca, r_c03_w.cd_doenca_imp), null, clock_timestamp(),
					clock_timestamp(), coalesce(r_c03_w.ie_indicador_dorn, r_c03_w.ie_indicador_dorn_imp), nm_usuario_p,
					nm_usuario_p, coalesce(r_c03_w.nr_declaracao_obito, r_c03_w.nr_declaracao_obito_imp), r_c01_w.nr_sequencia,
					nextval('pls_fat_decl_conta_obito_seq'));
		end loop;
		
		for r_c04_w in C04(r_c01_w.nr_seq_conta)  loop
		
			insert into pls_fat_diagnostico_conta(
							cd_doenca, cd_doenca_conv, dt_atualizacao,           
							dt_atualizacao_nrec, ie_classificacao_conv, nm_usuario,               
							nm_usuario_nrec, nr_seq_conta, nr_sequencia)
			values (		coalesce(r_c04_w.cd_doenca, r_c04_w.cd_doenca_imp), null, clock_timestamp(),
						clock_timestamp(), coalesce(r_c04_w.ie_classificacao, r_c04_w.ie_classificacao_imp), nm_usuario_p,
						nm_usuario_p, r_c01_w.nr_sequencia,nextval('pls_fat_diagnostico_conta_seq')
			);
		
		
		end loop;
		
		
	end loop;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_lote_pre_pagto_pck.gerar_info_adicionais_conta ( nr_seq_lote_p pls_lote_serv_pre_pgto.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;
