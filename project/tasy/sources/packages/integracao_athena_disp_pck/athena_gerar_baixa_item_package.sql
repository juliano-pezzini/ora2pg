-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE integracao_athena_disp_pck.athena_gerar_baixa_item ( cd_estabelecimento_p bigint, cd_local_estoque_p bigint, cd_operacao_estoque_p bigint, cd_material_p bigint, qt_material_p bigint, cd_barras_p text, nm_usuario_p text, ds_erro_p INOUT text) AS $body$
DECLARE

		
	cd_estabelecimento_w	estabelecimento.cd_estabelecimento%type;
	cd_unidade_medida_w		unidade_medida.cd_unidade_medida%type;
	/* parametros converte_codigo_barras */


	cd_material_w               integer := cd_material_p;
	qt_mat_barras_w             double precision := null;
	qt_material_ww				double precision := null;
	nr_seq_lote_w               bigint := null;
	nr_seq_lote_agrup_w         bigint := null;
	cd_kit_mat_w                bigint;
	ds_validade_w               varchar(255);
	ds_material_w               varchar(255);
	cd_unid_med_w               varchar(30);
	nr_etiqueta_lp_w            varchar(255);
	ds_erro_w                   varchar(255);
	/* parametros converte_codigo_barras */
	
	
	
BEGIN
	
	if (cd_barras_p IS NOT NULL AND cd_barras_p::text <> '') then
		converte_codigo_barras(cd_barras_p, coalesce(cd_estabelecimento_p,1), NULL, 'N', cd_material_w, qt_material_ww, nr_seq_lote_w, nr_seq_lote_agrup_w,
		cd_kit_mat_w, ds_validade_w, ds_material_w, cd_unid_med_w, nr_etiqueta_lp_w, ds_erro_w);
	end if;	

	select	max(cd_unidade_medida_estoque)
	into STRICT	cd_unidade_medida_w
	from	material
	where	cd_material = cd_material_p;
	
	if (coalesce(ds_erro_w::text, '') = '') then
		
		begin		
		insert into movimento_estoque(
			nr_movimento_estoque,	
			cd_estabelecimento,
			cd_local_estoque,		
			dt_movimento_estoque,
			cd_operacao_estoque,	
			cd_acao,
			cd_material,			
			cd_unidade_med_mov,
			qt_movimento,			
			dt_mesano_referencia,
			dt_atualizacao,			
			nm_usuario,
			ie_origem_documento,	
			cd_unidade_medida_estoque,
			cd_setor_atendimento,	
			qt_estoque,
			cd_centro_custo,		
			nr_seq_lote_fornec, 	
			ds_observacao)
		values (
			nextval('movimento_estoque_seq'),
			coalesce(cd_estabelecimento_p,1),
			cd_local_estoque_p,
			clock_timestamp(),
			cd_operacao_estoque_p,
			'1',
			cd_material_w,
			cd_unidade_medida_w,
			qt_material_p,
			trunc(clock_timestamp(), 'mm'),
			clock_timestamp(),
			nm_usuario_p,
			'11',
			cd_unidade_medida_w,
			null,
			qt_material_p,
			null,					
			nr_seq_lote_w,						
			null);
			
		commit;
			
		exception
		when others then
			ds_erro_p := substr(sqlerrm(SQLSTATE), 1, 2000);
		end;
	else
		ds_erro_p := ds_erro_w;
	end if;
	
	end;
	


$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE integracao_athena_disp_pck.athena_gerar_baixa_item ( cd_estabelecimento_p bigint, cd_local_estoque_p bigint, cd_operacao_estoque_p bigint, cd_material_p bigint, qt_material_p bigint, cd_barras_p text, nm_usuario_p text, ds_erro_p INOUT text) FROM PUBLIC;
