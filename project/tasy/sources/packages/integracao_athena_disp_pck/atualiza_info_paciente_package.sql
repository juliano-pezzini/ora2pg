-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE integracao_athena_disp_pck.atualiza_info_paciente ( cd_pessoa_fisica_p bigint, nm_usuario_p text ) AS $body$
DECLARE


        ie_setor_w              varchar(1) := 'N';
        ds_param_integ_hl7_w    varchar(4000) := '';
        nr_atendimento_w        atendimento_paciente.nr_atendimento%TYPE;
        cd_setor_w              setor_atendimento.cd_setor_atendimento%TYPE;

BEGIN
        BEGIN
            
            BEGIN
				
				nr_atendimento_w := obter_ultimo_atendimento(cd_pessoa_fisica_p);
				cd_setor_w := obter_setor_atendimento(nr_atendimento_w);

                SELECT CASE WHEN COUNT(*)=0 THEN  'N'  ELSE 'S' END
                INTO STRICT ie_setor_w
                FROM far_setores_integracao
                WHERE nr_seq_empresa_int = current_setting('integracao_athena_disp_pck.nr_seq_empresa_integracao_w')::far_setores_integracao.nr_seq_empresa_int%type
                AND cd_setor_atendimento = cd_setor_w  LIMIT 1;
            EXCEPTION
                WHEN OTHERS THEN
                    ie_setor_w := 'N';
            END;

            IF ( ie_setor_w = 'S' ) THEN
                ds_param_integ_hl7_w := 'cd_pessoa_fisica=' || cd_pessoa_fisica_p || obter_separador_bv;
                CALL gravar_agend_integracao(919, ds_param_integ_hl7_w);
            END IF;

		EXCEPTION
			WHEN OTHERS THEN
				ie_setor_w := 'N';
		END;

    END;


$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE integracao_athena_disp_pck.atualiza_info_paciente ( cd_pessoa_fisica_p bigint, nm_usuario_p text ) FROM PUBLIC;
