-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION cpoe_obter_mat_nutrientes.put_item ( cd_material_p bigint, qt_dose_p bigint, cd_unidade_medida_p text) RETURNS SETOF T_OBJETO_NUTRIENTES AS $body$
DECLARE


    t_objeto_row_w					t_nutrientes;
    qt_conversao_w          bigint := OBTER_CONVERSAO_ML(cd_material_p, qt_dose_p, cd_unidade_medida_p);
    qt_dose_result_w        bigint;
    nr_casas_diluicao_w     bigint;

  	c01 CURSOR FOR 
    SELECT  a.ds_elemento, 
            obter_desc_unidade_medida(a.cd_unidade_medida) ds_unidade_medida, 
            b.qt_conv_unid_cons, 
            b.qt_conversao_ml
    from    nut_elemento a,
      nut_elem_material b
    where   a.nr_sequencia = b.nr_seq_elemento
    and a.ie_situacao = 'A'
    and b.ie_situacao = 'A'
    and coalesce(b.ie_tipo, 'NPT') = 'NPT'
    and b.cd_material = cd_material_p
    and	coalesce(ie_medic_solucao, 'N') = 'S';

BEGIN

  select max(p.nr_casas_diluicao) into STRICT nr_casas_diluicao_W from parametro_medico p where p.cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento;

  for c01_w in c01
		loop
			t_objeto_row_w.ds_elemento :=  c01_w.ds_elemento;
			t_objeto_row_w.ds_unidade_medida :=  c01_w.ds_unidade_medida;
			t_objeto_row_w.qt_conv_unid_cons :=  c01_w.qt_conv_unid_cons;
      t_objeto_row_w.qt_conversao_ml :=  c01_w.qt_conversao_ml;

      qt_dose_result_w := (qt_conversao_w / c01_w.qt_conversao_ml) * c01_w.qt_conv_unid_cons;

      t_objeto_row_w.qt_dose_result_round := round(qt_dose_result_w, coalesce(nr_casas_diluicao_w, 0));
      t_objeto_row_w.ds_qt_dose_conversao := concat(concat(t_objeto_row_w.qt_dose_result_round, ' '), t_objeto_row_w.ds_unidade_medida);

			RETURN NEXT t_objeto_row_w;
		end loop;

  return;

  END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION cpoe_obter_mat_nutrientes.put_item ( cd_material_p bigint, qt_dose_p bigint, cd_unidade_medida_p text) FROM PUBLIC;
