-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pls_env_aviso_ven_doc_pres_pck.retorna_sql_cursor_documento ( dados_regra_aviso_p pls_env_aviso_ven_doc_pres_pck.dados_regra_aviso, bind_sql_valor_p INOUT sql_pck.t_dado_bind) AS $body$
DECLARE

					
sql_cursor_w		varchar(4000);


BEGIN

sql_cursor_w :=	'	select	b.nr_seq_prestador, ' || pls_util_pck.enter_w ||
		'		b.dt_fim_vigencia, ' || pls_util_pck.enter_w || 
		'		b.nr_documento, ' || pls_util_pck.enter_w || 
		'		substr(pls_obter_nome_documento(b.nr_seq_tipo_documento), 1, 255), ' || pls_util_pck.enter_w || 
		'		b.nr_sequencia ' || pls_util_pck.enter_w || 
		'	from	pls_prestador_tipo_doc b,' || pls_util_pck.enter_w || 
		'		pls_prestador a' || pls_util_pck.enter_w || 
		'	where	1 = 1 ' || pls_util_pck.enter_w || 
		'	and	a.nr_sequencia = b.nr_seq_prestador' || pls_util_pck.enter_w || 
		'	and	a.ie_situacao = ''A''' || pls_util_pck.enter_w || 
		'	and	b.dt_fim_vigencia is not null ' || pls_util_pck.enter_w;
		
if (dados_regra_aviso_p.nr_seq_prestador IS NOT NULL AND dados_regra_aviso_p.nr_seq_prestador::text <> '') then
	sql_cursor_w :=	sql_cursor_w ||	'	and	b.nr_seq_prestador = :nr_seq_prestador ' || pls_util_pck.enter_w;
	bind_sql_valor_p := sql_pck.bind_variable(':nr_seq_prestador', dados_regra_aviso_p.nr_seq_prestador, bind_sql_valor_p);
end if;

if (dados_regra_aviso_p.nr_seq_grupo_prestador IS NOT NULL AND dados_regra_aviso_p.nr_seq_grupo_prestador::text <> '') then
	sql_cursor_w :=	sql_cursor_w ||	'	and	exists (select	1 ' || pls_util_pck.enter_w ||
					'			from	pls_preco_prestador x ' || pls_util_pck.enter_w || 
					'			where	x.nr_seq_grupo		= :nr_seq_grupo_prestador ' || pls_util_pck.enter_w || 
					'			and	(x.nr_seq_prestador	= a.nr_sequencia or x.nr_seq_prestador is null) ' || pls_util_pck.enter_w ||
					'			and	(x.nr_seq_classificacao	= a.nr_seq_classificacao or x.nr_seq_classificacao is null)) ' || pls_util_pck.enter_w;
	bind_sql_valor_p := sql_pck.bind_variable(':nr_seq_grupo_prestador', dados_regra_aviso_p.nr_seq_grupo_prestador, bind_sql_valor_p);
end if;

if (dados_regra_aviso_p.nr_seq_prest_tipo_prest IS NOT NULL AND dados_regra_aviso_p.nr_seq_prest_tipo_prest::text <> '') then
	sql_cursor_w :=	sql_cursor_w ||	'	and	b.nr_seq_prestador = :nr_seq_prest_tipo_prest ' || pls_util_pck.enter_w;
	bind_sql_valor_p := sql_pck.bind_variable(':nr_seq_prest_tipo_prest', dados_regra_aviso_p.nr_seq_prest_tipo_prest, bind_sql_valor_p);
end if;

if (dados_regra_aviso_p.ie_aviso_continuo = 'S') or (dados_regra_aviso_p.ie_aviso_continuo_pos = 'S') then
	sql_cursor_w :=	sql_cursor_w ||	 '	and    (((b.dt_fim_vigencia - trunc(sysdate)) between 0 and :qt_dia_antecedente) or ' ||  pls_util_pck.enter_w;
	sql_cursor_w :=	sql_cursor_w ||	 '		(:ie_aviso_continuo_pos = ''S'' and b.dt_fim_vigencia < trunc(sysdate))) '||  pls_util_pck.enter_w;
	bind_sql_valor_p := sql_pck.bind_variable(':qt_dia_antecedente', dados_regra_aviso_p.qt_dia_antecedente, bind_sql_valor_p);
	bind_sql_valor_p := sql_pck.bind_variable(':ie_aviso_continuo_pos', dados_regra_aviso_p.ie_aviso_continuo_pos, bind_sql_valor_p);	
elsif (dados_regra_aviso_p.ie_aviso_continuo = 'N') then
	sql_cursor_w :=	sql_cursor_w ||	 '	and     (b.dt_fim_vigencia - trunc(sysdate)) = :qt_dia_antecedente ' ||  pls_util_pck.enter_w;
	bind_sql_valor_p := sql_pck.bind_variable(':qt_dia_antecedente', dados_regra_aviso_p.qt_dia_antecedente, bind_sql_valor_p);
end if;

if (dados_regra_aviso_p.nr_seq_tipo_documento IS NOT NULL AND dados_regra_aviso_p.nr_seq_tipo_documento::text <> '') then
	sql_cursor_w :=	sql_cursor_w ||	'	and	b.nr_seq_tipo_documento = :nr_seq_tipo_documento ' || pls_util_pck.enter_w;
	bind_sql_valor_p := sql_pck.bind_variable(':nr_seq_tipo_documento', dados_regra_aviso_p.nr_seq_tipo_documento, bind_sql_valor_p);
end if;

sql_cursor_w :=	sql_cursor_w ||	 '	order by b.nr_seq_prestador ' ||  pls_util_pck.enter_w;

return;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_env_aviso_ven_doc_pres_pck.retorna_sql_cursor_documento ( dados_regra_aviso_p pls_env_aviso_ven_doc_pres_pck.dados_regra_aviso, bind_sql_valor_p INOUT sql_pck.t_dado_bind) FROM PUBLIC;
