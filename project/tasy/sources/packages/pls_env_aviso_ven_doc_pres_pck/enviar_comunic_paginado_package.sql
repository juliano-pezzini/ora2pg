-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_env_aviso_ven_doc_pres_pck.enviar_comunic_paginado ( ds_assunto_p text, ds_cabecalho_p text, tb_mensagem_p dbms_sql.varchar2_table, cd_perfil_p text, nm_usuario_p usuario.nm_usuario%type, nm_usuario_dest_p usuario.nm_usuario%type, qt_tamanho_paginacao_p integer) AS $body$
DECLARE


i				integer;
ds_mensagem_w			varchar(32000);
qt_tamanho_paginacao_w		integer;

BEGIN
	-- valida se deve enviar o email
	if (tb_mensagem_p.count > 0) then
		
		qt_tamanho_paginacao_w := coalesce(qt_tamanho_paginacao_p, 5000);
		
		-- Inicializa com o cabecalho
		ds_mensagem_w := ds_cabecalho_p;
		
		for i in tb_mensagem_p.first..tb_mensagem_p.last loop
		
			ds_mensagem_w := ds_mensagem_w|| pls_util_pck.enter_w || tb_mensagem_p(i);
			
			-- se chegou no limite de paginacao, entao envia o conteudo e zera tudo
			if (length(ds_mensagem_w) >= qt_tamanho_paginacao_w) then
			
				CALL gerar_comunic_padrao(	clock_timestamp(),
							ds_assunto_p,
							ds_mensagem_w,
							nm_usuario_dest_p,
							'N',
							nm_usuario_dest_p,
							'N',
							null,
							cd_perfil_p,
							null,
							null,
							clock_timestamp(),
							null,
							null);
				-- Inicializa com o cabecalho
				ds_mensagem_w := ds_cabecalho_p;
			end if;
		end loop;
		
		-- no final, verifica se sobrou algo alem do cabecalho
		if (ds_mensagem_w IS NOT NULL AND ds_mensagem_w::text <> '') and (ds_mensagem_w != ds_cabecalho_p) then
		
			CALL gerar_comunic_padrao(	clock_timestamp(),
							ds_assunto_p,
							ds_mensagem_w,
							nm_usuario_dest_p,
							'N',
							nm_usuario_dest_p,
							'N',
							null,
							cd_perfil_p,
							null,
							null,
							clock_timestamp(),
							null,
							null);
		end if;
	end if;
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_env_aviso_ven_doc_pres_pck.enviar_comunic_paginado ( ds_assunto_p text, ds_cabecalho_p text, tb_mensagem_p dbms_sql.varchar2_table, cd_perfil_p text, nm_usuario_p usuario.nm_usuario%type, nm_usuario_dest_p usuario.nm_usuario%type, qt_tamanho_paginacao_p integer) FROM PUBLIC;
