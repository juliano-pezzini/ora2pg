-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_env_aviso_ven_doc_pres_pck.enviar_ci_notific_portal ( nr_seq_prest_doc_venc_p pls_prestador_doc_venc.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE

/* ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade:	Gera uma CI caso seja configurada na regra de comunicacao, 
---------------------------------------------------------------------------------------------------------------------------------
Locais de chamada direta: 
[X]  Objetos do dicionario [  ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatorios [  ] Outros:
 --------------------------------------------------------------------------------------------------------------------------------
 Alteracoes:	
 
 OPCOES
'ST'	- Status
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
nm_usuario_alerta_w	pls_regra_com_prest_dest.nm_usuario_portal%type := '';
nm_prestador_w		varchar(500);

BEGIN

if (nr_seq_prest_doc_venc_p IS NOT NULL AND nr_seq_prest_doc_venc_p::text <> '') then

	select	max(a.nm_usuario_portal)
	into STRICT	nm_usuario_alerta_w
	from	pls_regra_com_prest_dest	a,
		pls_prestador_doc_venc		b
	where	b.nr_seq_regra_prest_dest	= a.nr_sequencia
	and	b.nr_sequencia			= nr_seq_prest_doc_venc_p;
	
	select	substr(pls_obter_dados_prestador(b.nr_seq_prestador, 'N'), 1, 255)
	into STRICT	nm_prestador_w
	from	pls_prestador_doc_venc	a,
		pls_prestador_tipo_doc	b
	where	b.nr_sequencia	= a.nr_seq_prest_tipo_doc
	and	a.nr_sequencia	= nr_seq_prest_doc_venc_p;
	
	if (nm_usuario_alerta_w IS NOT NULL AND nm_usuario_alerta_w::text <> '') then
	
		CALL gerar_comunic_padrao(	clock_timestamp(),
					wheb_mensagem_pck.get_texto(1106875), /*Envio de documentacao por prestador*/
					wheb_mensagem_pck.get_texto(1106877, 'NM_PRESTADOR=' || nm_prestador_w || ';NM_USUARIO=' || nm_usuario_p), -- 'Envio de documentacao do prestador ' || nm_prestador_w || ', efetuado pelo usuario ' || nm_usuario_p
					nm_usuario_p,
					'N',
					nm_usuario_alerta_w,
					'N',
					null,
					null,
					null,
					null,
					clock_timestamp(),
					null,
					null);
		commit;
	end if;
end if;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_env_aviso_ven_doc_pres_pck.enviar_ci_notific_portal ( nr_seq_prest_doc_venc_p pls_prestador_doc_venc.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;
