-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


CREATE TYPE FIX_REC AS (
      nm_tabela varchar(400),
      constraint_columns_list varchar(4000)
    );


CREATE OR REPLACE PROCEDURE sequence_pck.update_data_sequence () AS $body$
DECLARE

    l_sql varchar(32767);
    l_max_value bigint;
    eCursor EmptyCursorType;

    rec fix_rec;

BEGIN
  
    open eCursor for EXECUTE 'select nm_tabela, constraint_columns_list
                                       from   fix_sequences
                                       where  constraint_number_of_columns = 1';
    loop
        fetch eCursor into rec;
        EXIT WHEN NOT FOUND; /* apply on eCursor */

        l_sql := 'select nvl(max(' || rec.constraint_columns_list || '),0) from ' || rec.nm_tabela;
        EXECUTE l_sql into STRICT l_max_value;
        EXECUTE 'update fix_sequences set table_pk_max_value = :l_max_value where nm_tabela = :nm_tabela' using l_max_value, rec.nm_tabela;
        CALL cleanupdb_pck.add_progress(current_setting('sequence_pck.const_cleanupdb')::varchar(20),1);
    end loop;
  end;


$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE sequence_pck.update_data_sequence () FROM PUBLIC;
