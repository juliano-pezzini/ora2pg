-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE ctb_contab_onl_lote_fin_pck.ctb_reprocessar_contabilizacao ( nr_sequencia_p ctb_documento.nr_sequencia%type, nm_usuario_p text) AS $body$
DECLARE


/*
Rotina que efetua o reprocessamento atraves do Menu direito - Documentos Pendentes
*/

ctb_doc_w           ctb_documento%rowtype;
qt_movimento_w      bigint;
nr_lote_contabil_w  lote_contabil.nr_lote_contabil%type;


BEGIN
begin
select  a.*
into STRICT    ctb_doc_w
from    ctb_documento a
where   a.nr_sequencia = nr_sequencia_p;
exception
    when others then
        ctb_doc_w := null;
end;

if (ctb_doc_w.cd_tipo_lote_contabil in (2,51)) then
    if (ctb_online_pck.get_modo_lote(ctb_doc_w.cd_tipo_lote_contabil,ctb_doc_w.cd_estabelecimento) = 'S') then
        CALL ctb_contab_onl_lote_nf_pck.ctb_reprocessa_nota_fiscal(ctb_doc_w.nr_documento,
                                                              ctb_doc_w.cd_tipo_lote_contabil,
                                                              ctb_doc_w.cd_estabelecimento,
                                                              nm_usuario_p);
    end if;
elsif (ctb_doc_w.cd_tipo_lote_contabil in (23,24,27,33,35,36,37,38,39,40,41,42,43,44,49,50,57)) then
    CALL pls_contab_onl_lote_fin_pck.contabiliza_documento(ctb_doc_w,ctb_doc_w.nm_usuario);
elsif (ctb_doc_w.cd_tipo_lote_contabil = 6) then
    if (ctb_doc_w.nm_tabela = 'CONTA_PACIENTE') then
        select a.nr_lote_contabil
        into STRICT   nr_lote_contabil_w
        from   conta_paciente a
        where  a.nr_interno_conta = ctb_doc_w.nr_documento;

        if (coalesce(nr_lote_contabil_w,0) <> 0) then
            CALL ctb_contab_onl_lote_receita(nr_seq_protocolo_p  =>  null,
                                        nr_interno_conta_p  =>  ctb_doc_w.nr_documento,
                                        nm_usuario_p        =>  nm_usuario_p,
                                        ie_operacao_p       =>  2,
                                        ie_commit_p         =>  'N',
                                        dt_referencia_p     =>  null);
        end if;

        CALL ctb_contab_onl_lote_receita(nr_seq_protocolo_p  =>  null,
                                    nr_interno_conta_p  =>  ctb_doc_w.nr_documento,
                                    nm_usuario_p        =>  nm_usuario_p,
                                    ie_operacao_p       =>  1,
                                    dt_referencia_p         =>  null);


    elsif (ctb_doc_w.nm_tabela = 'PROTOCOLO_CONVENIO') then
        select max(a.nr_lote_contabil)
        into STRICT   nr_lote_contabil_w
        from   conta_paciente a
        where  a.nr_seq_protocolo = ctb_doc_w.nr_documento;

        if (coalesce(nr_lote_contabil_w,0) <> 0) then
            CALL ctb_contab_onl_lote_receita(nr_seq_protocolo_p  =>  ctb_doc_w.nr_documento,
                                        nr_interno_conta_p  =>  null,
                                        nm_usuario_p        =>  nm_usuario_p,
                                        ie_operacao_p       =>  2,
                                        ie_commit_p         =>  'N',
                                        dt_referencia_p     =>  null);
        end if;

        CALL ctb_contab_onl_lote_receita(nr_seq_protocolo_p  =>  ctb_doc_w.nr_documento,
                                    nr_interno_conta_p  =>  null,
                                    nm_usuario_p        =>  nm_usuario_p,
                                    ie_operacao_p       =>  1,
                                    dt_referencia_p         =>  null);
    end if;
elsif (ctb_doc_w.cd_tipo_lote_contabil = 14 and ctb_doc_w.nm_tabela <> 'REPASSE_TERCEIRO_ITEM') then
    if (ctb_doc_w.nm_tabela = 'PROTOCOLO_CONVENIO') then
        select max(a.nr_lote_repasse)
        into STRICT   nr_lote_contabil_w
        from   conta_paciente a
        where  a.nr_seq_protocolo = ctb_doc_w.nr_documento;

        if (coalesce(nr_lote_contabil_w,0) <> 0) then
            CALL ctb_contab_onl_repasse(ctb_doc_w.nr_documento,null,null,nm_usuario_p,2,'N','N');
        end if;
        CALL ctb_contab_onl_repasse(ctb_doc_w.nr_documento,null,null,nm_usuario_p);

    elsif (ctb_doc_w.nm_tabela = 'CONTA_PACIENTE') then
        select a.nr_lote_repasse
        into STRICT   nr_lote_contabil_w
        from   conta_paciente a
        where  a.nr_interno_conta = ctb_doc_w.nr_documento;

        if (coalesce(nr_lote_contabil_w,0) <> 0) then
            CALL ctb_contab_onl_repasse(null,ctb_doc_w.nr_documento,null,nm_usuario_p,2,'N','N');
        end if;
        CALL ctb_contab_onl_repasse(null,ctb_doc_w.nr_documento,null,nm_usuario_p);

    end if;
elsif (ctb_doc_w.nr_sequencia IS NOT NULL AND ctb_doc_w.nr_sequencia::text <> '') then
    CALL ctb_contab_onl_lote_fin_pck.ctb_contabiliza_documento(ctb_doc_w,nm_usuario_p);
end if;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ctb_contab_onl_lote_fin_pck.ctb_reprocessar_contabilizacao ( nr_sequencia_p ctb_documento.nr_sequencia%type, nm_usuario_p text) FROM PUBLIC;
