-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION cpoe_setor_pck.cpoe_get_list_department ( nr_seq_proc_interno_p bigint, cd_setor_atendimento_p bigint, ie_tipo_atendimento_p bigint, cd_convenio_p bigint, nr_atendimento_p bigint, nr_seq_rotina_p bigint, nm_usuario_p text) RETURNS SETOF T_OBJETO_SETOR_ATENDIMENTO AS $body$
DECLARE

	
		t_objeto_row_w					t_setor_atendimento;
		cd_setor_atendimento_w			integer;
		cd_estabelecimento_w			smallint;
		ie_tipo_convenio_w				smallint;
		nr_seq_agrupamento_w			bigint;
		cd_medico_w						varchar(10);
		qt_size_w						bigint := 0;
		ie_proced_principal_w 			varchar(1) := 'S';
		cd_procedimento_w				procedimento.cd_procedimento%type;
		ie_origem_proced_w				procedimento.ie_origem_proced%type;
		
		c01 CURSOR FOR
		SELECT d.cd_setor_atendimento, d.ds_setor_atendimento
		from    proc_interno a,
			exame_laboratorio b,
			exame_lab_setor c,
			setor_atendimento d
		where a.nr_sequencia = nr_seq_proc_interno_p
		and ((a.nr_seq_exame_lab = b.nr_seq_exame) or (a.nr_sequencia = b.nr_seq_proc_interno))
		and b.nr_seq_exame =  c.nr_seq_exame
		and c.cd_setor_atendimento = d.cd_setor_atendimento;
		
		C02 CURSOR FOR
		SELECT	cd_setor_atendimento
		from	proc_interno_setor
		where	nr_seq_proc_interno	= nr_seq_proc_interno_p
		and	((cd_setor_origem	= cd_setor_atendimento_p) or (coalesce(cd_setor_atendimento_p::text, '') = '') or (coalesce(cd_setor_origem::text, '') = ''))
		and (coalesce(cd_estabelecimento,coalesce(cd_estabelecimento_w,1))	= coalesce(cd_estabelecimento_w,1))
		and 	coalesce(ie_tipo_atendimento, coalesce(ie_tipo_atendimento_p,0)) = coalesce(ie_tipo_atendimento_p,0)
		and	coalesce(cd_perfil,obter_perfil_ativo) = obter_perfil_ativo
		AND ((coalesce(ie_somente_principal,'N') = 'N') OR
			((coalesce(ie_somente_principal,'N') = 'S') AND (ie_proced_principal_w = 'S')))
		and 	coalesce(ie_tipo_convenio, coalesce(ie_tipo_convenio_w,0)) = coalesce(ie_tipo_convenio_w,0)
		and	coalesce(nr_seq_agrupamento, coalesce(nr_seq_agrupamento_w,0)) = coalesce(nr_seq_agrupamento_w,0)
		and		((coalesce(cd_especialidade::text, '') = '') or (obter_se_especialidade_medico(cd_medico_w,cd_especialidade) = 'S'))
		order by
			nr_prioridade desc,
			coalesce(cd_setor_origem,0),
			coalesce(ie_tipo_atendimento,0),
			coalesce(ie_tipo_convenio_w,0),
			coalesce(nr_seq_agrupamento,0);
			
		c03 CURSOR FOR
		SELECT a.cd_setor_exclusivo cd_setor_atendimento
		from procedimento a,
			proc_interno b
		where   b.nr_sequencia          = nr_seq_proc_interno_p
		and     a.cd_procedimento       = b.cd_procedimento
		and     a.ie_origem_proced      = b.ie_origem_proced
		and     b.ie_origem_proced   	= ie_origem_proced_w
		and		coalesce(a.cd_setor_exclusivo,0)	<> 0;
			
		c04 CURSOR FOR
		SELECT a.cd_setor_atendimento, a.ds_setor_atendimento
		from setor_atendimento a,
			proc_interno b
		where a.ie_situacao = 'A'
		and	b.nr_sequencia = nr_seq_proc_interno_p
		and obter_se_gerar_setor_rotina(wheb_usuario_pck.get_cd_estabelecimento,
                               924, 
                                b.cd_procedimento,
                                b.ie_origem_proced, 
                                b.nr_sequencia,
                                obter_nr_seq_exame(b.nr_sequencia, nr_atendimento_p, nr_seq_rotina_p),
                                obter_setor_atual_paciente(nr_atendimento_p),
                                nm_usuario_p) = 'S';

		
BEGIN

		for c01_w in C01
		loop
			t_objeto_row_w.cd_setor_atendimento :=  c01_w.cd_setor_atendimento;
			t_objeto_row_w.ds_setor_atendimento :=  c01_w.ds_setor_atendimento;
			qt_size_w := qt_size_w + 1;
			RETURN NEXT t_objeto_row_w;
		end loop;
		
		if (qt_size_w <= 0) then
			cd_estabelecimento_w := wheb_usuario_pck.get_cd_estabelecimento;
		
			select	max(ie_tipo_convenio)
			into STRICT	ie_tipo_convenio_w
			from	convenio
			where	cd_convenio 	= cd_convenio_p;

			select	coalesce(max(nr_seq_agrupamento),0)
			into STRICT	nr_seq_agrupamento_w
			from	setor_atendimento
			where	cd_setor_atendimento = cd_setor_atendimento_p;

			select	max(a.cd_pessoa_fisica)
			into STRICT	cd_medico_w
			from	medico a,
					usuario b
			where	a.cd_pessoa_fisica	= b.cd_pessoa_fisica
			and		b.nm_usuario		= wheb_usuario_pck.get_nm_usuario;
			
			for c02_w in C02
			loop
				t_objeto_row_w.cd_setor_atendimento :=  c02_w.cd_setor_atendimento;
				t_objeto_row_w.ds_setor_atendimento :=  obter_desc_setor_atend(c02_w.cd_setor_atendimento);
				qt_size_w := qt_size_w + 1;
				RETURN NEXT t_objeto_row_w;
			end loop;
			
			if (qt_size_w <= 0) then
				Obter_Proc_Tab_Interno(nr_seq_proc_interno_p, 0, nr_atendimento_p, 0, cd_procedimento_w, ie_origem_proced_w);
				for c03_w in C03
				loop
					t_objeto_row_w.cd_setor_atendimento :=  c03_w.cd_setor_atendimento;
					t_objeto_row_w.ds_setor_atendimento :=  obter_desc_setor_atend(c03_w.cd_setor_atendimento);		
					qt_size_w := qt_size_w + 1;
					RETURN NEXT t_objeto_row_w;
				end loop;
				
				if (qt_size_w <= 0) then
					for c04_w in C04
					loop
						t_objeto_row_w.cd_setor_atendimento :=  c04_w.cd_setor_atendimento;
						t_objeto_row_w.ds_setor_atendimento :=  c04_w.ds_setor_atendimento;				
						RETURN NEXT t_objeto_row_w;
					end loop;
					
				end if;
				
			end if;
			
		end if;
		
		return;
	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION cpoe_setor_pck.cpoe_get_list_department ( nr_seq_proc_interno_p bigint, cd_setor_atendimento_p bigint, ie_tipo_atendimento_p bigint, cd_convenio_p bigint, nr_atendimento_p bigint, nr_seq_rotina_p bigint, nm_usuario_p text) FROM PUBLIC;
