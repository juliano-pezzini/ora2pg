-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION philips_management_pck.obter_aloc_por_area_detalhe (ie_area_p text,dt_inicio_p timestamp, dt_fim_p timestamp, nm_recurso_p text default '') RETURNS SETOF T_ALOCACAO_DETALHE_TB AS $body$
DECLARE


        alocacao_detalhe_tb_w t_alocacao_detalhe_tb;
        len bigint := 0;

BEGIN

        alocacao_detalhe_tb_w := philips_management_pck.obter_calendario_recurso_det(ie_area_p, dt_inicio_p, dt_fim_p, nm_recurso_p );

        for j in 1 .. alocacao_detalhe_tb_w.count loop
            
            -- se recurso alocado em projeto, lista projetos
            for r_projeto in current_setting('philips_management_pck.c_projetos')::CURSOR((alocacao_detalhe_tb_w[j].nm_usuario_grupo, alocacao_detalhe_tb_w[j].workday)
            loop
                alocacao_detalhe_tb_w[j].ds_alocacao :=  
                    alocacao_detalhe_tb_w[j].ds_alocacao ||
                    r_projeto.ie_tipo_projeto || ' ' || 
                    r_projeto.nr_seq_proj || '(' ||
                    r_projeto.pr_alocacao*100 || '%' ||
                    r_projeto.dt_atualizacao || ')' || chr(10);
            end loop;

            -- se recurso ausente, lista ausencia
            for r_ausencia in current_setting('philips_management_pck.c_ausencias')::CURSOR((alocacao_detalhe_tb_w[j].nm_usuario_grupo,alocacao_detalhe_tb_w[j].workday)
            loop
                alocacao_detalhe_tb_w[j].ds_alocacao :=
                    alocacao_detalhe_tb_w[j].ds_alocacao ||
                    r_ausencia.ds_motivo_ausencia||chr(10);
            end loop;

            -- to do: se recurso emprestado, lista emprestimo concatenado com percentual emprestimo
            --  rec.ds_alocacao := <registros emprestimo>||chr(10);
            len := length(alocacao_detalhe_tb_w[j].ds_alocacao);

            coalesce(if (alocacao_detalhe_tb_w[j].ds_alocacao)::text, '') = '' then
                if alocacao_detalhe_tb_w[j].ie_area_gerencia = 'DES' then 
                    alocacao_detalhe_tb_w[j].ds_alocacao := 'Operation (100%)';
                else
                    alocacao_detalhe_tb_w[j].ds_alocacao := 'Available';
                end if;
            else
                -- retirar a ultima quebra de linha
                alocacao_detalhe_tb_w[j].ds_alocacao := substr(alocacao_detalhe_tb_w[j].ds_alocacao,1,len-1);
            end if;

            RETURN NEXT  alocacao_detalhe_tb_w(j);

        end loop;

        return;

    END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION philips_management_pck.obter_aloc_por_area_detalhe (ie_area_p text,dt_inicio_p timestamp, dt_fim_p timestamp, nm_recurso_p text default '') FROM PUBLIC;
