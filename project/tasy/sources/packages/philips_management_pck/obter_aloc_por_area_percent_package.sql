-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION philips_management_pck.obter_aloc_por_area_percent (ie_area_p text,dt_inicio_p timestamp, dt_fim_p timestamp, nm_recurso_p text default '') RETURNS SETOF T_ALOCACAO_TB AS $body$
DECLARE


        alocacao_tb_w t_alocacao_tb;
        percent_alocacao_w bigint;


BEGIN

        alocacao_tb_w := philips_management_pck.obter_calendario_recurso(ie_area_p ,dt_inicio_p , dt_fim_p, nm_recurso_p  );

        for j in 1 .. alocacao_tb_w.count loop

            -- inicializa recurso como sem alocacao
            alocacao_tb_w[j].nr_seq_projeto :=  null;
            percent_alocacao_w := 0;

            -- se recurso alocado em projeto, lista projetos
            for r_projeto in current_setting('philips_management_pck.c_projetos')::CURSOR((alocacao_tb_w[j].nm_usuario_grupo, alocacao_tb_w[j].workday)
            loop
                alocacao_tb_w[j].nr_seq_projeto :=  r_projeto.nr_seq_proj;
                alocacao_tb_w[j].pr_alocacao :=  r_projeto.pr_alocacao;
                alocacao_tb_w[j].dt_atualizacao :=  r_projeto.dt_atualizacao;

                percent_alocacao_w := r_projeto.pr_alocacao;

                RETURN NEXT  alocacao_tb_w(j );

            end loop;

            if percent_alocacao_w = 0 then
                -- se recurso ausente, lista ausencia
                for r_ausencia in current_setting('philips_management_pck.c_ausencias')::CURSOR((alocacao_tb_w[j].nm_usuario_grupo,alocacao_tb_w[j].workday)
                loop
                    alocacao_tb_w[j].nr_seq_projeto :=  -5;
                    alocacao_tb_w[j].pr_alocacao := -5;
                    alocacao_tb_w[j].dt_atualizacao :=  null;
                end loop;

            end if;

            -- alocado na operacao
            if alocacao_tb_w[j].ie_area_gerencia = 'DES' then 
               alocacao_tb_w[j].nr_seq_projeto :=  -1;
               alocacao_tb_w[j].pr_alocacao :=  -1;
               alocacao_tb_w[j].dt_atualizacao :=  null;
            end if;

            -- se recurso sem alocacao
            if percent_alocacao_w = 0 then
                    RETURN NEXT  alocacao_tb_w(j );
            end if;

        end loop;

        return;

    END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION philips_management_pck.obter_aloc_por_area_percent (ie_area_p text,dt_inicio_p timestamp, dt_fim_p timestamp, nm_recurso_p text default '') FROM PUBLIC;
