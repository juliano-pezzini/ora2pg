-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION medical_net_pck.process_edifact_bgm (edifact_message_p text) RETURNS R_GET_BGM AS $body$
DECLARE

	ds_specialty_w		varchar(50);
	ds_admitDate_w		varchar(10);
	ds_insuranceCode_w	varchar(24);
	ds_birthDate_w		varchar(10);
	r_bgm_w			r_get_bgm;

	
BEGIN
	$if dbms_db_version.version >= 12 $then
	SELECT	max(edifact.specialty), max(edifact.admitDate), max(edifact.insuranceCode), max(edifact.birthDate)
	INTO STRICT	ds_specialty_w, ds_admitDate_w, ds_insuranceCode_w, ds_birthDate_w
	FROM	JSON_TABLE(edifact_message_p, '$'
	COLUMNS(
		NESTED PATH '$.EDIFACT'
		COLUMNS(
			NESTED PATH '$.BGM'
			COLUMNS(
				specialty VARCHAR2(100) PATH '$."2"',
				admitDate VARCHAR2(100) PATH '$."5"',
				insuranceCode VARCHAR2(100) PATH '$."7"',
				birthDate VARCHAR2(100) PATH '$."8"'
			)
		)
	)
	) AS edifact;

	r_bgm_w.specialty	:=	ds_specialty_w;
	r_bgm_w.reportDate	:=	ds_admitDate_w;
	r_bgm_w.insuranceNumber	:=	ds_insuranceCode_w;
	r_bgm_w.birthDate	:=	ds_birthDate_w;
	$end
	return r_bgm_w;
	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION medical_net_pck.process_edifact_bgm (edifact_message_p text) FROM PUBLIC;
