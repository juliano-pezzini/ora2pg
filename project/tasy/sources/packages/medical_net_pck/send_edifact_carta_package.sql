-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE medical_net_pck.send_edifact_carta (nr_seq_carta_p bigint, ie_medicalnet_id_p text) AS $body$
DECLARE

	ds_edifact_w	varchar(30000);
	ds_unb_w	varchar(300);
	ds_unh_w	varchar(300);
	ds_bgm_w	varchar(300);
	ds_ftx_w	varchar(1000);
	ds_nad_w	varchar(300);
	ds_unt_w	varchar(300);
	
	ds_sender_w	varchar(30);
	ds_receiver_w	varchar(30);
	dt_message_w	timestamp;
	
	ds_referenceNumber_w	varchar(30);
	
	ds_specialty_w		varchar(10);
	dt_carta_w		timestamp;
	ds_socialSecurity_w	varchar(12);
	dt_birth_w		timestamp;
	
	ds_carta0_w		varchar(70);
	ds_carta1_w		varchar(70);
	ds_carta2_w		varchar(70);
	ds_carta3_w		varchar(70);
	ds_carta4_w		varchar(70);
	
	ds_surname_w		varchar(50);
	ds_givenName_w		varchar(50);
	ds_title_w		varchar(20);
	ds_street_w		varchar(120);
	ds_caseNumber_w		varchar(50);
	ds_city_w		varchar(120);
	ds_zipCode_w		varchar(20);
	count_segmentos_w	bigint;
	nr_especialidade_w	bigint;
	
	carta_medica_w			carta_medica%rowtype;
	pessoa_fisica_w			pessoa_fisica%rowtype;
	person_name_w			person_name%rowtype;
	medico_especialidade_w		medico_especialidade%rowtype;
	compl_pessoa_fisica_w		compl_pessoa_fisica%rowtype;
	pessoa_titular_convenio_w	pessoa_titular_convenio%rowtype;
	log_mensagem_mednet_w		log_mensagem_mednet%rowtype;
	destinatario_carta_medica_w	destinatario_carta_medica%rowtype;
		
	
BEGIN
	
	select	cd_medico_responsavel,
		nr_seq_carta_mae,
		cd_pessoa_fisica,
		nr_versao,
		dt_liberacao,
		ds_carta,
		nr_episodio,
		nr_atendimento
	into STRICT	carta_medica_w.cd_medico_responsavel,
		carta_medica_w.nr_seq_carta_mae,
		carta_medica_w.cd_pessoa_fisica,
		carta_medica_w.nr_versao,
		carta_medica_w.dt_liberacao,
		carta_medica_w.ds_carta,
		carta_medica_w.nr_episodio,
		carta_medica_w.nr_atendimento
	from	carta_medica
	where	nr_sequencia = nr_seq_carta_p;
	
	begin
	select	cd_especialidade, ie_medicalnet_id
	into STRICT	nr_especialidade_w, ds_sender_w
	from	medico_especialidade
	where	cd_pessoa_fisica = carta_medica_w.cd_medico_responsavel;
	exception
	when others then
		ds_sender_w	:=	null;
	end;
	
	begin
	select	*
	into STRICT	destinatario_carta_medica_w
	from	destinatario_carta_medica
	where	nr_seq_carta_mae = carta_medica_w.nr_seq_carta_mae;
	exception
	when others then
		destinatario_carta_medica_w	:=	null;
	end;

	begin
	select	*
	into STRICT	medico_especialidade_w
	from	medico_especialidade
	where 	cd_pessoa_fisica = destinatario_carta_medica_w.cd_pessoa_fisica;
	exception
	when others then
		medico_especialidade_w	:=	null;
	end;
	
	begin
	select	*
	into STRICT	pessoa_fisica_w
	from	pessoa_fisica
	where	cd_pessoa_fisica = destinatario_carta_medica_w.cd_pessoa_fisica;
	exception
	when others then
		pessoa_fisica_w	:=	null;
	end;
	
	begin
	select	*
	into STRICT	person_name_w
	from	person_name
	where	nr_sequencia = pessoa_fisica_w.nr_seq_person_name;
	exception
	when others then
		person_name_w	:=	null;
	end;

	begin
	select	*
	into STRICT	compl_pessoa_fisica_w
	from	compl_pessoa_fisica
	where	cd_pessoa_fisica = pessoa_fisica_w.cd_pessoa_fisica;
	exception
	when others then
		compl_pessoa_fisica_w	:=	null;
	end;
	
	begin
	select	*
	into STRICT 	pessoa_titular_convenio_w
	from 	pessoa_titular_convenio
	where	cd_pessoa_fisica = pessoa_fisica_w.cd_pessoa_fisica
	and	coalesce(dt_inicio_vigencia::text, '') = ''
	and	dt_validade_carteira < clock_timestamp();
	exception
	when others then
		pessoa_titular_convenio_w	:=	null;
	end;
	
	begin
	select	cd_externo
	into STRICT	ds_specialty_w
	from	conversao_meio_externo
	where	nm_tabela='MEDICO_ESPECIALIDADE'
	and	ie_sistema_externo = 'MNET' 
	and	cd_interno = to_char(nr_especialidade_w);
	exception
	when others then
		ds_specialty_w	:=	null;
	end;
	
	select	coalesce(get_personal_title(pessoa_fisica_w.nr_seq_forma_trat, 'A'),'')
	into STRICT	ds_title_w
	;
	
	ds_receiver_w		:=	ie_medicalnet_id_p;
	dt_message_w		:=	clock_timestamp();
	ds_referenceNumber_w	:=	carta_medica_w.cd_pessoa_fisica||'_'||carta_medica_w.nr_seq_carta_mae||'_'||carta_medica_w.nr_versao;
	dt_carta_w		:=	carta_medica_w.dt_liberacao;
	ds_socialSecurity_w	:=	substr(pessoa_fisica_w.NR_INSS,1,4)|| to_char(pessoa_fisica_w.dt_nascimento, 'DDMMYYYY');
	dt_birth_w		:=	pessoa_fisica_w.dt_nascimento;
	ds_carta0_w		:=	substr(carta_medica_w.ds_carta,1,70);
	ds_carta1_w		:=	substr(carta_medica_w.ds_carta,71,70);
	ds_carta2_w		:=	substr(carta_medica_w.ds_carta,141,70);
	ds_carta3_w		:=	substr(carta_medica_w.ds_carta,211,70);
	ds_carta4_w		:=	substr(carta_medica_w.ds_carta,281,70);
	ds_surname_w		:=	person_name_w.ds_family_name;
	ds_givenName_w		:=	person_name_w.ds_given_name;
	ds_street_w		:=	compl_pessoa_fisica_w.ds_endereco;
	ds_caseNumber_w		:=	carta_medica_w.nr_episodio;
	ds_city_w		:=	compl_pessoa_fisica_w.ds_municipio;
	ds_zipCode_w		:=	compl_pessoa_fisica_w.cd_cep;

	count_segmentos_w	:=	6;
	
	ds_unb_w	:=	'UNB+ANSI:1+'||ds_sender_w||'+'||ds_receiver_w||'+'||TO_CHAR(dt_message_w, 'YYMMDD')||'+'||TO_CHAR(dt_message_w, 'HHmm')||'+1'||chr(39);
	ds_unh_w	:=	'UNH+'||ds_referenceNumber_w||'+MEDRPT:1:901:UN'||chr(39);
	ds_bgm_w	:=	'BGM+'||ds_specialty_w||'+++'||to_char(dt_carta_w,'YYYYMMDD')||'++'||ds_socialSecurity_w||'+'||to_char(dt_birth_w, 'YYYYMMDD')||chr(39);
	ds_ftx_w	:=	'FTX+BFD++'||ds_carta0_w||':'||ds_carta1_w||':'||ds_carta2_w||':'||ds_carta3_w||':'||ds_carta4_w||chr(39);
	ds_nad_w	:=	'NAD+PAT++'||ds_surname_w||':'||ds_givenName_w||':'||ds_title_w||':'||ds_street_w||':'||ds_caseNumber_w||'+++'||ds_city_w||'++'||ds_zipCode_w||chr(39);
	ds_unt_w	:=	'UNT+'||count_segmentos_w||'+'||ds_referenceNumber_w||chr(39);
	
	
	ds_edifact_w	:=	ds_unb_w||ds_unh_w||ds_bgm_w||ds_ftx_w||ds_nad_w||ds_unt_w;
	
	log_mensagem_mednet_w.cd_convenio		:=	pessoa_titular_convenio_w.cd_convenio;
	log_mensagem_mednet_w.cd_pessoa_fisica		:=	pessoa_fisica_w.cd_pessoa_fisica;
	log_mensagem_mednet_w.ds_edifact		:=	ds_edifact_w;
	log_mensagem_mednet_w.ds_json			:=	edifact_json_converter(ds_edifact_w);
	log_mensagem_mednet_w.dt_atualizacao		:=	clock_timestamp();
	log_mensagem_mednet_w.dt_atualizacao_nrec	:=	clock_timestamp();
	log_mensagem_mednet_w.dt_nascimento		:=	dt_birth_w;
	log_mensagem_mednet_w.dt_resultado		:=	dt_carta_w;
	log_mensagem_mednet_w.ie_envio_receb		:=	'E';
	log_mensagem_mednet_w.ie_medicalnet_dest	:=	ds_receiver_w;
	log_mensagem_mednet_w.ie_medicalnet_rem		:=	ds_sender_w;
	log_mensagem_mednet_w.ie_status			:=	'P';
	log_mensagem_mednet_w.nm_usuario		:=	'Tasy';
	log_mensagem_mednet_w.nm_usuario_nrec		:=	'Tasy';
	log_mensagem_mednet_w.nr_atendimento		:=	carta_medica_w.nr_atendimento;
	log_mensagem_mednet_w.nr_episodio		:=	ds_caseNumber_w;
	log_mensagem_mednet_w.nr_seq_carta		:=	nr_seq_carta_p;
	--log_mensagem_mednet_w.nr_seq_laudo		:=	nr_seq_laudo_p;
	select	nextval('log_mensagem_mednet_seq')
	into STRICT	log_mensagem_mednet_w.nr_sequencia
	;

	begin
	insert into log_mensagem_mednet values (log_mensagem_mednet_w.*);
	exception
	when others then
		log_mensagem_mednet_w	:=	null;
	end;
	commit;
	
	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE medical_net_pck.send_edifact_carta (nr_seq_carta_p bigint, ie_medicalnet_id_p text) FROM PUBLIC;
