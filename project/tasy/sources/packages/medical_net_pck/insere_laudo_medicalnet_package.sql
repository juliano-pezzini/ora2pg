-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE medical_net_pck.insere_laudo_medicalnet ( nr_prescricao_p bigint, nr_seq_presc_proc_p bigint, nr_seq_laudo_p bigint, dt_laudo_p timestamp, qt_imagem_p bigint, ds_caminho_arquivo_p text, nm_usuario_p text, ds_titulo_laudo_p text, ds_laudo_p text) AS $body$
DECLARE


	cd_setor_execucao_w	procedimento_paciente.cd_setor_atendimento%type;
	nr_seq_proced_w		procedimento_paciente.nr_sequencia%type;
	cd_pessoa_fisica_w                prescr_medica.cd_pessoa_fisica%type;
	nr_laudo_w		bigint;
	dt_procedimento_w	timestamp;
	dt_entrada_unidade_w	timestamp;
	ie_html			varchar(1);

	laudo_paciente_w		laudo_paciente%rowtype;
	procedimento_paciente_w		procedimento_paciente%rowtype;
	atendimento_paciente_w		atendimento_paciente%rowtype;

	
BEGIN
	
	select	max(nr_sequencia)
	into STRICT	nr_seq_proced_w
	from	procedimento_paciente
	left	join conta_paciente on procedimento_paciente.nr_interno_conta = conta_paciente.nr_interno_conta
	where	coalesce(conta_paciente.ie_cancelamento, 'N') = 'N' 
	and	nr_prescricao = nr_prescricao_p
	and	procedimento_paciente.qt_procedimento > 0;

	select	*
	into STRICT	procedimento_paciente_w
	from	procedimento_paciente a
	where	a.nr_sequencia = nr_seq_proced_w;

	select	coalesce(max(nr_laudo), 0) + 1 
	into STRICT	nr_laudo_w 
	from	laudo_paciente 
	where	nr_atendimento = procedimento_paciente_w.nr_atendimento;
	
	select max(cd_pessoa_fisica)
	into STRICT   cd_pessoa_fisica_w 
	from   prescr_medica 
	where  nr_prescricao = nr_prescricao_p;
	
	
	select	*
	into STRICT	atendimento_paciente_w
	from	atendimento_paciente 
	where	nr_atendimento = procedimento_paciente_w.nr_atendimento;
	
	


	laudo_paciente_w.nr_sequencia	:=	nr_seq_laudo_p;
	dt_entrada_unidade_w		:=	procedimento_paciente_w.dt_entrada_unidade;


	laudo_paciente_w.dt_atualizacao		:=	clock_timestamp();
	laudo_paciente_w.ds_arquivo		:=	ds_caminho_arquivo_p;
	laudo_paciente_w.dt_laudo		:=	dt_laudo_p;
	laudo_paciente_w.nr_laudo		:=	nr_laudo_w;
	laudo_paciente_w.qt_imagem		:=	qt_imagem_p;
	laudo_paciente_w.nm_usuario		:=	nm_usuario_p;
	laudo_paciente_w.ds_titulo_laudo	:=	ds_titulo_laudo_p;
	laudo_paciente_w.ds_laudo		:=	ds_laudo_p;
	laudo_paciente_w.dt_entrada_unidade	:=	dt_entrada_unidade_w;
	laudo_paciente_w.nr_atendimento		:=	procedimento_paciente_w.nr_atendimento;
	laudo_paciente_w.nr_seq_proc		:=	nr_seq_proced_w;
	laudo_paciente_w.nr_prescricao		:=	nr_prescricao_p;
	laudo_paciente_w.nr_seq_prescricao	:=	nr_seq_presc_proc_p;
	laudo_paciente_w.dt_exame		:=	dt_laudo_p;
	laudo_paciente_w.nm_usuario_digitacao	:=	'MedicalNet';
	laudo_paciente_w.nm_usuario_aprovacao	:=	'MedicalNet';
	laudo_paciente_w.nm_usuario_liberacao	:=	'MedicalNet';
	laudo_paciente_w.dt_liberacao		:=	clock_timestamp();
	laudo_paciente_w.dt_inicio_digitacao	:=	clock_timestamp();
        laudo_paciente_w.dt_aprovacao		:=	clock_timestamp();
        laudo_paciente_w.dt_fim_digitacao	:=	clock_timestamp();
	laudo_paciente_w.cd_pessoa_fisica	:=	cd_pessoa_fisica_w;
	laudo_paciente_w.cd_setor_execucao	:=	procedimento_paciente_w.cd_setor_atendimento;
	laudo_paciente_w.cd_medico_resp		:=	atendimento_paciente_w.cd_medico_resp;
	laudo_paciente_w.ie_formato		:=	3;

	begin
	insert into	laudo_paciente values (laudo_paciente_w.*);
	exception
	when others then
		laudo_paciente_w	:=	null;
	end;
	
	if (laudo_paciente_w.nr_sequencia IS NOT NULL AND laudo_paciente_w.nr_sequencia::text <> '') then
		update	procedimento_paciente
		set	nr_laudo = nr_seq_laudo_p
		where	nr_prescricao = nr_prescricao_p
		and	nr_sequencia_prescricao = nr_seq_presc_proc_p;

		update	prescr_procedimento
		set	ie_status_execucao = '40',
			nm_usuario = nm_usuario_p
		where	nr_prescricao = nr_prescricao_p
		and	nr_sequencia = nr_seq_presc_proc_p;
	end if;
	
	commit;
	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE medical_net_pck.insere_laudo_medicalnet ( nr_prescricao_p bigint, nr_seq_presc_proc_p bigint, nr_seq_laudo_p bigint, dt_laudo_p timestamp, qt_imagem_p bigint, ds_caminho_arquivo_p text, nm_usuario_p text, ds_titulo_laudo_p text, ds_laudo_p text) FROM PUBLIC;
