-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE PROCEDURE comunic_interna_pck.carregar_estab_usuario () AS $body$
DECLARE
  i 			smallint := 1;
  C01			integer;
  ds_comando_w		varchar(2000);
  retorno_w		integer;
  cd_estabelecimento_w 	integer[];
  nm_usuario_w text;
BEGIN

  nm_usuario_w := current_setting('comunic_interna_pck.nm_usuario_w');

select ARRAY_AGG(estabs.cd_estabelecimento)
into cd_estabelecimento_w
from (
      SELECT	cd_estabelecimento 
			 FROM		usuario 
			 WHERE		nm_usuario = nm_usuario_w 
			 UNION 
			 SELECT	cd_estabelecimento 
			 FROM		usuario_estabelecimento 
			 WHERE		nm_usuario_param = nm_usuario_w 
	) estabs
       ;

	perform set_config('comunic_interna_pck.estabelecimentos_usuario_w', cd_estabelecimento_w::text, false);

/* Após recarregar os dados, seta o estabelecimento para que não precise atualizar */

/* até que seja mudado de estabelecimento novamente */

PERFORM set_config('comunic_interna_pck.cd_estabelecimento_ant_w', current_setting('comunic_interna_pck.cd_estabelecimento_atual_w'), false);

end;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE comunic_interna_pck.carregar_estab_usuario () FROM PUBLIC;
