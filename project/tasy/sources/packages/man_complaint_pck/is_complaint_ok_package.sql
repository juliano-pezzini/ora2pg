-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION man_complaint_pck.is_complaint_ok (nr_seq_ordem_serv_p bigint) RETURNS varchar AS $body$
DECLARE

		
		nr_seq_ordem_serv_w	man_ordem_servico.nr_sequencia%type;
		ie_classificacao_w	man_ordem_servico.ie_classificacao%type;
		ie_plataforma_w		man_ordem_servico.ie_plataforma%type;
		ie_terceiro_w		varchar(1);
		ie_hist_analise_risco_w	varchar(1);
		ds_retorno_w		varchar(4000);
		nr_seq_localizacao_w	man_localizacao.nr_sequencia%type;
		dt_ordem_servico_w	man_ordem_servico.dt_ordem_servico%type;
		ie_existe_status_w	varchar(1);
		
	
BEGIN
	
	select	max(mos.nr_sequencia),
		max(mos.nr_seq_localizacao),
		max(mos.dt_ordem_servico)
	into STRICT	nr_seq_ordem_serv_w,
		nr_seq_localizacao_w,
		dt_ordem_servico_w
	from	man_ordem_servico mos
	where	mos.nr_sequencia = nr_seq_ordem_serv_p;
	
	select	coalesce(max('S'), 'N')
	into STRICT	ie_existe_status_w
	from	man_localizacao_status mls
	where	mls.nr_seq_localizacao = nr_seq_localizacao_w
	and	dt_ordem_servico_w between trunc(mls.dt_inicio) and fim_dia(coalesce(mls.dt_fim, clock_timestamp()));
	
	if (coalesce(nr_seq_ordem_serv_w::text, '') = '') then
		begin
			CALL wheb_mensagem_pck.exibir_mensagem_abort(1088830);
		end;
	end if;

	select	max(mos.ie_classificacao),
		max(mos.ie_plataforma),
		man_obter_se_loc_terceiro(max(mos.nr_seq_localizacao))
	into STRICT	ie_classificacao_w,
		ie_plataforma_w,
		ie_terceiro_w
	from	man_ordem_servico mos
	where	mos.nr_sequencia = nr_seq_ordem_serv_w;

	if (	ie_classificacao_w	= 'E'
		and	ie_plataforma_w		= 'H'
		and	ie_terceiro_w		= 'S'
		and	ie_existe_status_w	= 'N') then
		begin

			select	coalesce(max('S'), 'N')
			into STRICT	ie_hist_analise_risco_w
			from	man_ordem_serv_tecnico most
			where	most.nr_seq_ordem_serv = nr_seq_ordem_serv_w
			and	most.nr_seq_tipo in (212, 213);
			
			if (ie_hist_analise_risco_w = 'S') then
				begin
					select	coalesce(max('S'), 'N')
					into STRICT	ie_hist_analise_risco_w
					from	man_ordem_serv_tecnico most
					where	most.nr_seq_ordem_serv = nr_seq_ordem_serv_w
					and	most.nr_seq_tipo in (215);
					
					if (ie_hist_analise_risco_w = 'S') then
						begin
							select	coalesce(max('S'), 'N')
							into STRICT	ie_hist_analise_risco_w
							from	man_ordem_serv_tecnico most
							where	most.nr_seq_ordem_serv = nr_seq_ordem_serv_w
							and	most.nr_seq_tipo in (216, 217);
							
							if (ie_hist_analise_risco_w = 'S') then
								begin
									ds_retorno_w := 'S';
								end;
							else
								ds_retorno_w := 'N';
							end if;
						end;
					else
						ds_retorno_w := 'S';
					end if;
				end;
			else
				ds_retorno_w := 'N';
			end if;
		end;
	else
		ds_retorno_w := 'S';
	end if;
		
	return ds_retorno_w;
	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION man_complaint_pck.is_complaint_ok (nr_seq_ordem_serv_p bigint) FROM PUBLIC;
