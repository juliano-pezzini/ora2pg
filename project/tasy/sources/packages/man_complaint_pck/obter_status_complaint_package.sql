-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

	
	--Caso realizar algum ajuste aqui deve ser feito o mesmo ajuste na trigger man_ordem_servico_atual pois a function obter_status_complaint estava gerando mutante na mesma



CREATE OR REPLACE FUNCTION man_complaint_pck.obter_status_complaint (nr_seq_ordem_serv_p bigint) RETURNS varchar AS $body$
DECLARE

	    qt_hist_risco_w			bigint;
		qt_hist_decisao_w		bigint;
		qt_hist_info_pergunta_w	bigint;
		qt_hist_info_resposta_w	bigint;
		qt_hist_complaint_w		bigint;
		cd_trackwise_id_w		man_ordem_servico.cd_trackwise_id%type;
		ie_complaint_w			man_ordem_servico.ie_complaint%type;
		ie_complaint_eval_w		man_ordem_servico.ie_complaint%type;		
		ds_retorno_w			varchar(50) := 'Not defined';
	
BEGIN

		select  count(x.nr_sequencia) 
		into STRICT    qt_hist_risco_w
		from    man_ordem_serv_tecnico x 
		where   nr_seq_tipo in ( 233, 236 ) -- Potential Security or Privacy Event or Potential Paciente Harmed Event
		and     x.nr_seq_ordem_serv = nr_seq_ordem_serv_p 
		and     (x.dt_liberacao IS NOT NULL AND x.dt_liberacao::text <> '');

		select  count(x.nr_sequencia)
		into STRICT    qt_hist_decisao_w
		from    man_ordem_serv_tecnico x 
		where   nr_seq_tipo in ( 216, 217 ) -- invest need , no invest need 
		and     x.nr_seq_ordem_serv = nr_seq_ordem_serv_p 
		and     (x.dt_liberacao IS NOT NULL AND x.dt_liberacao::text <> '');

		select  count(x.nr_sequencia)
		into STRICT    qt_hist_info_pergunta_w
		from    man_ordem_serv_tecnico x 
		where   nr_seq_tipo in ( 218 ) -- request for info
		and     x.nr_seq_ordem_serv = nr_seq_ordem_serv_p 
		and     (x.dt_liberacao IS NOT NULL AND x.dt_liberacao::text <> '');

		select  count(x.nr_sequencia)
		into STRICT    qt_hist_info_resposta_w
		from    man_ordem_serv_tecnico x 
		where   nr_seq_tipo in ( 214 ) -- request for info
		and     x.nr_seq_ordem_serv = nr_seq_ordem_serv_p 
		and     (x.dt_liberacao IS NOT NULL AND x.dt_liberacao::text <> '');
		
		select  count(x.nr_sequencia)
		into STRICT    qt_hist_complaint_w
		from    man_ordem_serv_tecnico x
		where   nr_seq_tipo = 215 -- complaint
		and     x.nr_seq_ordem_serv = nr_seq_ordem_serv_p
		and     (x.dt_liberacao IS NOT NULL AND x.dt_liberacao::text <> '');		
		
		select	max(cd_trackwise_id)
		into STRICT 	cd_trackwise_id_w
		from 	man_ordem_servico
		where 	nr_sequencia = nr_seq_ordem_serv_p;
		
		SELECT	man_complaint_pck.obter_se_os_complaint(nr_seq_ordem_serv_p)
		into STRICT	ie_complaint_w
		;
		
		select	man_complaint_pck.obter_se_os_complaint_eval(nr_seq_ordem_serv_p)
		into STRICT	ie_complaint_eval_w
		;

		if (ie_complaint_eval_w = 'N') then
			ds_retorno_w := 'WFE';--'Waiting for evaluation'

		elsif (qt_hist_info_pergunta_w > qt_hist_info_resposta_w) then
			ds_retorno_w := 'WFI';--'Waiting for information'

		elsif (ie_complaint_w = 'S') and (coalesce(cd_trackwise_id_w::text, '') = '') and (qt_hist_risco_w > 0) then
			ds_retorno_w := 'WT';--'Waiting Triage/Pending Analysis on the filter Server Order Management' 

		elsif (ie_complaint_w = 'S') and (cd_trackwise_id_w IS NOT NULL AND cd_trackwise_id_w::text <> '') and
			((qt_hist_decisao_w = 0) or (qt_hist_decisao_w > 0 AND qt_hist_decisao_w < qt_hist_complaint_w)) then
			ds_retorno_w := 'WD';--'Waiting Decision/Pending resolution on the filter Server Order Management' 

		elsif (cd_trackwise_id_w IS NOT NULL AND cd_trackwise_id_w::text <> '') and (qt_hist_decisao_w > 0) then
			ds_retorno_w := 'CD';--'Complaint documented'

		elsif (ie_complaint_w = 'N') then
			ds_retorno_w := 'NC';--'Not a Complaint'

		end if;

		return ds_retorno_w;
	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION man_complaint_pck.obter_status_complaint (nr_seq_ordem_serv_p bigint) FROM PUBLIC;
