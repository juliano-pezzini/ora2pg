-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE hpms_proposal_request_pck.validar_se_benef_ativo ( nr_seq_proposta_online_p pls_proposta_online.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, ie_existe_benef_p INOUT text, ds_msg_retorno_p INOUT text) AS $body$
DECLARE

					
/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finality: Validar se existe beneficiario ativo na operadora com o mesmo CPF dos beneficiarios da proposta.
Verifica o parametro Validar se pessoa ativa na operadora na 
OPS - Gestao de Operadora - Parametros da operadora - Solicitacao de proposta online.
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */


ie_validar_benef_w	pls_param_proposta_online.ie_validar_benef%type;
nr_cpf_w		pls_proposta_benef_online.nr_cpf%type;
ie_situacao_benef_w	varchar(255);
ds_segurados_exits_w	varchar(2000)	:= current_setting('hpms_proposal_request_pck.enter_w')::varchar(2);
ie_existe_benef_w	varchar(1)	:= 'N';
ds_msg_retorno_w	varchar(4000)	:= '';

C01 CURSOR FOR
	SELECT	nr_sequencia nr_seq_prop_benef,
		nm_pessoa_fisica,
		nr_cpf
	from	pls_proposta_benef_online
	where	nr_seq_prop_online 	= nr_seq_proposta_online_p
	order 	by nr_sequencia;
	
C02 CURSOR(	nr_cpf_pc	pls_proposta_benef_online.nr_cpf%type) FOR
	SELECT	b.nr_sequencia nr_seq_segurado
	from	pessoa_fisica a,
		pls_segurado b
	where	a.cd_pessoa_fisica	= b.cd_pessoa_fisica
	and	a.nr_cpf		= nr_cpf_pc;
	
BEGIN

begin
	select	ie_validar_benef
	into STRICT	ie_validar_benef_w
	from	pls_param_proposta_online
	where	cd_estabelecimento = cd_estabelecimento_p;
exception
when others then
	ie_validar_benef_w	:= 'N';
end;

if (ie_validar_benef_w = 'S') then	
	for C01_w in C01 loop
		begin
			for C02_w in C02(C01_w.nr_cpf) loop
				begin
					ie_situacao_benef_w	:= pls_obter_dados_segurado(C02_w.nr_seq_segurado, 'CS');
			
					if (ie_situacao_benef_w <> 'I') then
						ie_existe_benef_w	:= 'S';
						ds_segurados_exits_w 	:= ds_segurados_exits_w || current_setting('hpms_proposal_request_pck.enter_w')::varchar(2) || C01_w.nm_pessoa_fisica;
						exit;
					end if;
				end;
			end loop;
		end;
	end loop;
	
	if (ie_existe_benef_w =  'S') then
		--Beneficiario(s) ativo(s) na operadora. Favor verificar. #@DS_SEGURADOS#@

		ds_msg_retorno_w	:= wheb_mensagem_pck.get_texto(1150604,'DS_SEGURADOS=' || ds_segurados_exits_w);
	end if;
end if;

ie_existe_benef_p	:= ie_existe_benef_w;
ds_msg_retorno_p	:= ds_msg_retorno_w;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE hpms_proposal_request_pck.validar_se_benef_ativo ( nr_seq_proposta_online_p pls_proposta_online.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, ie_existe_benef_p INOUT text, ds_msg_retorno_p INOUT text) FROM PUBLIC;
