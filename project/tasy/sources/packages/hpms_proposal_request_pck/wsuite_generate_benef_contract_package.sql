-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE hpms_proposal_request_pck.wsuite_generate_benef_contract ( nr_seq_proposta_p pls_proposta_online.nr_sequencia%type, nr_seq_contrato_p pls_contrato.nr_sequencia%type, dt_contratacao_prev_p pls_contrato.dt_contrato%type, nm_usuario_p text) AS $body$
DECLARE


/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade:
Insert beneficiaries in the contract
-------------------------------------------------------------------------------------------------------------------

Locais de chamada direta: 
[ x ]  Objetos do dicionario [ ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatorios [ ] Outros:
 ------------------------------------------------------------------------------------------------------------------

Pontos de atencao:
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */


nr_seq_pagador_w		pls_contrato_pagador.nr_sequencia%type;
nr_seq_segurado_w		pls_segurado.nr_sequencia%type;
nr_seq_titular_w		pls_segurado.nr_sequencia%type;
ie_tipo_operacao_w		pls_contrato.ie_tipo_operacao%type;
dt_contratacao_w		pls_segurado.dt_contratacao%type;
nr_seq_vinculo_sca_w		pls_sca_vinculo.nr_sequencia%type;
nr_seq_tabela_w			pls_contrato_plano.nr_seq_tabela%type;

C01 CURSOR FOR
	SELECT	CASE WHEN b.ie_tipo_benef='T' THEN  1 WHEN b.ie_tipo_benef='D' THEN  2 END  ie_titularidade,
		b.ie_tipo_benef,
		a.dt_confirmacao,
		a.cd_estabelecimento,
		a.nr_seq_plano,
		b.nr_seq_parentesco,
		b.nr_sequencia nr_seq_prop_benef_online,
		b.cd_pessoa_fisica,
		a.nr_seq_vendedor_canal
	from	pls_proposta_online a,
		pls_proposta_benef_online b
	where	b.nr_seq_prop_online	= a.nr_sequencia
	and	a.nr_sequencia		= nr_seq_proposta_p
	and	b.ie_tipo_benef		<> 'R'
	order	by ie_titularidade;

C02 CURSOR(	nr_seq_prop_benef_online_pc	pls_proposta_benef_online.nr_sequencia%type) FOR
	SELECT	ds_diretorio,
		ds_anexo,
		dt_criacao
	from	pls_proposta_anexo_online
	where	nr_seq_prop_benef_online	= nr_seq_prop_benef_online_pc;

C03 CURSOR FOR
	SELECT	nr_seq_plano,
		nr_seq_tabela
	from	pls_sca_vinculo
	where	nr_seq_proposta_online	= nr_seq_proposta_p;
	
c04 CURSOR(	nr_seq_prop_benef_online_pc	pls_proposta_benef_online.nr_sequencia%type) FOR
	SELECT	c.nr_sequencia
	from	pls_analise_adesao b,
		pls_carencia c
	where	b.nr_sequencia = c.nr_seq_analise_adesao
	and	b.nr_seq_prop_benef_online = nr_seq_prop_benef_online_pc
	and	c.ie_cpt = 'S';

BEGIN

select	max(nr_sequencia)
into STRICT	nr_seq_pagador_w
from	pls_contrato_pagador
where	nr_seq_contrato	= nr_seq_contrato_p
and	ie_tipo_pagador = 'P';

select	max(nr_seq_tabela)
into STRICT	nr_seq_tabela_w
from	pls_contrato_plano
where	nr_seq_contrato = nr_seq_contrato_p;

select	max(ie_tipo_operacao)
into STRICT	ie_tipo_operacao_w
from	pls_contrato
where	nr_sequencia	= nr_seq_contrato_p;


for C01_w in C01 loop
	begin
	
	insert	into pls_segurado(nr_sequencia, dt_atualizacao, nm_usuario,
		dt_atualizacao_nrec, nm_usuario_nrec, cd_pessoa_fisica,
		nr_seq_titular, nr_seq_contrato, nr_seq_pagador,
		nr_seq_plano, dt_contratacao, nr_seq_parentesco,
		ie_tipo_segurado, ie_situacao_atend, cd_estabelecimento,
		nr_seq_tabela, nr_seq_vendedor_canal, dt_inclusao_operadora,
		nr_seq_motivo_inclusao, nr_seq_prop_benef_online)
	values (nextval('pls_segurado_seq'), clock_timestamp(), nm_usuario_p,
		clock_timestamp(), nm_usuario_p, C01_w.cd_pessoa_fisica,
		nr_seq_titular_w, nr_seq_contrato_p, nr_seq_pagador_w,
		C01_w.nr_seq_plano, coalesce(dt_contratacao_prev_p, C01_w.dt_confirmacao), C01_w.nr_seq_parentesco,
		ie_tipo_operacao_w, 'A', C01_w.cd_estabelecimento,
		nr_seq_tabela_w, C01_w.nr_seq_vendedor_canal, coalesce(dt_contratacao_prev_p, C01_w.dt_confirmacao),
		current_setting('hpms_proposal_request_pck.nr_seq_motivo_inclusao_w')::pls_param_proposta_online.nr_seq_motivo_inclusao%type, c01_w.nr_seq_prop_benef_online) returning nr_sequencia, dt_contratacao into nr_seq_segurado_w, dt_contratacao_w;

	if (C01_w.ie_tipo_benef = 'T') then
		nr_seq_titular_w	:= nr_seq_segurado_w;
	end if;
	
	if (current_setting('hpms_proposal_request_pck.ie_copiar_carencia_w')::pls_param_proposta_online.ie_gerar_contrato%type = 'S') then
		CALL pls_copiar_carencia(C01_w.nr_seq_plano,null,nr_seq_segurado_w,'N',nm_usuario_p);
	end if;	
	
	for C02_w in C02(C01_w.nr_seq_prop_benef_online) loop
		begin
		
		insert into pls_segurado_doc_arq(nr_sequencia, nr_seq_segurado, cd_estabelecimento,
			dt_atualizacao, nm_usuario, dt_atualizacao_nrec,
			nm_usuario_nrec, ds_arquivo, ie_origem_anexo,
			nr_seq_tipo_documento, ie_apresenta_portal, nm_arquivo,
			dt_documento, ds_observacao)
		values (nextval('pls_segurado_doc_arq_seq'), nr_seq_segurado_w, C01_w.cd_estabelecimento,
			clock_timestamp(), nm_usuario_p, clock_timestamp(),
			nm_usuario_p, C02_w.ds_diretorio, 'P',
			null, 'N', C02_w.ds_anexo,
			C02_w.dt_criacao, wheb_mensagem_pck.get_texto(1107262));
		end;
	end loop;
	
	for r_c03_w in C03 loop
		begin
		insert into pls_sca_vinculo(nr_sequencia, nm_usuario, dt_atualizacao,
			nm_usuario_nrec, dt_atualizacao_nrec, nr_seq_segurado,
			nr_seq_plano, nr_seq_tabela)
		values (nextval('pls_sca_vinculo_seq'), nm_usuario_p, clock_timestamp(),
			nm_usuario_p, clock_timestamp(), nr_seq_segurado_w,
			r_c03_w.nr_seq_plano, r_c03_w.nr_seq_tabela)
			returning nr_sequencia into nr_seq_vinculo_sca_w;
		
		CALL pls_duplicar_tabela_preco_sca(nr_seq_contrato_p, nr_seq_vinculo_sca_w, r_c03_w.nr_seq_tabela, 'N', nm_usuario_p);
		end;
	end loop;
	
	for r_c04_w in C04(C01_w.nr_seq_prop_benef_online) loop
		begin
		insert	into	pls_carencia(	nr_sequencia, nm_usuario, dt_atualizacao,
				nm_usuario_nrec, dt_atualizacao_nrec, nr_seq_segurado,
				nr_seq_tipo_carencia, dt_inicio_vigencia, qt_dias,
				ds_observacao, ie_cpt, dt_fim_vigencia)
			(SELECT	nextval('pls_carencia_seq'), nm_usuario_p, clock_timestamp(),
				nm_usuario_p, clock_timestamp(), nr_seq_segurado_w,
				x.nr_seq_tipo_carencia, coalesce(x.dt_inicio_vigencia,dt_contratacao_w), x.qt_dias,
				x.ds_observacao, x.ie_cpt, fim_dia(coalesce(x.dt_inicio_vigencia,dt_contratacao_w)+x.qt_dias)
			from	pls_carencia x
			where	x.nr_sequencia = r_c04_w.nr_sequencia);
		end;
	end loop;
	
	end;
end loop;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE hpms_proposal_request_pck.wsuite_generate_benef_contract ( nr_seq_proposta_p pls_proposta_online.nr_sequencia%type, nr_seq_contrato_p pls_contrato.nr_sequencia%type, dt_contratacao_prev_p pls_contrato.dt_contrato%type, nm_usuario_p text) FROM PUBLIC;
