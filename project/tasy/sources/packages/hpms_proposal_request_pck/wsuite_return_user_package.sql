-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE hpms_proposal_request_pck.wsuite_return_user (nr_seq_proposta_onl_p pls_proposta_online.nr_sequencia%type, ds_observacao_p pls_proposta_hist_online.ds_historico%type, ds_email_p pls_proposta_online.ds_email%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) AS $body$
DECLARE


nr_seq_tipo_historico_w		pls_tipo_hist_prop.nr_sequencia%type;
qt_solicitacao_comp_recusada_w	bigint;
qt_inconsistencia_pendente_w bigint;


BEGIN

select	count(1)
into STRICT	qt_solicitacao_comp_recusada_w
from	pls_proposta_anexo_online
where	nr_seq_prop_online = nr_seq_proposta_onl_p
and	(nr_seq_motivo_recusa IS NOT NULL AND nr_seq_motivo_recusa::text <> '');

select	count(1)
into STRICT	qt_inconsistencia_pendente_w
from	pls_proposta_on_inconsist
where	coalesce(dt_liberacao::text, '') = ''
and	nr_seq_proposta = nr_seq_proposta_onl_p;

if (qt_solicitacao_comp_recusada_w = 0 and qt_inconsistencia_pendente_w = 0) then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(1093668); -- Somente e permitido solicitar complemento ao usuario se existir algum anexo recusado na proposta.
end if;

select	max(nr_sequencia)
into STRICT	nr_seq_tipo_historico_w
from	pls_tipo_hist_prop
where	cd_estabelecimento = cd_estabelecimento_p
and	coalesce(ie_solicitacao_complemento,'N') = 'S'
and	ie_situacao = 'A';

if (coalesce(nr_seq_tipo_historico_w::text, '') = '') then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(1086699); --Favor cadastrar um tipo de historico com a opcao "Solicitacao de complemento ao usuario" marcada
end if;

insert into pls_proposta_hist_online(nr_sequencia, dt_atualizacao, nm_usuario,
	ie_tipo_historico, ds_historico, nr_seq_prop_online,
	dt_criacao, dt_liberacao, nr_seq_tipo_hist,
	dt_atualizacao_nrec, nm_usuario_nrec)
values (nextval('pls_proposta_hist_online_seq'), clock_timestamp(), nm_usuario_p,
	'SC', ds_observacao_p, nr_seq_proposta_onl_p,
	clock_timestamp(), clock_timestamp(), nr_seq_tipo_historico_w,
	clock_timestamp(), nm_usuario_p);

update	pls_proposta_online
set	ie_estagio	= 'AC',
	ie_status	= 'U',
	nm_usuario	= nm_usuario_p,
	dt_atualizacao	= clock_timestamp()
where	nr_sequencia	= nr_seq_proposta_onl_p;

CALL hpms_proposal_request_pck.enviar_email_proposta(ds_email_p, nr_seq_proposta_onl_p, '1', nm_usuario_p, cd_estabelecimento_p);

commit;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE hpms_proposal_request_pck.wsuite_return_user (nr_seq_proposta_onl_p pls_proposta_online.nr_sequencia%type, ds_observacao_p pls_proposta_hist_online.ds_historico%type, ds_email_p pls_proposta_online.ds_email%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) FROM PUBLIC;
