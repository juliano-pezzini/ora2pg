-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE hpms_proposal_request_pck.generate_document ( nr_seq_proposta_online_p pls_proposta_online.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE


nr_seq_documento_w	pls_contrato_documento.nr_sequencia%type;
nr_seq_doc_texto_w	pls_contrato_doc_texto.nr_sequencia%type;

C01 CURSOR FOR
	SELECT	a.nr_sequencia nr_seq_instrumento,
		a.ds_instrumento,
		b.nr_sequencia nr_seq_plano
	from	pls_instrumento a,
		pls_plano b,
		pls_proposta_online c
	where	b.nr_sequencia = a.nr_seq_plano
	and	b.nr_sequencia = c.nr_seq_plano
	and	c.nr_sequencia = nr_seq_proposta_online_p
	and	trunc(c.dt_criacao,'dd') >= trunc(coalesce(a.dt_inicio_vigencia,c.dt_criacao),'dd')
	and	trunc(c.dt_criacao,'dd') <= trunc(coalesce(a.dt_fim_vigencia,c.dt_criacao),'dd')
	and	a.ie_situacao	= 'A'
	order by	
		a.nr_sequencia;

C02 CURSOR(	nr_seq_instrumento_pc	pls_instrumento.nr_sequencia%type) FOR
	SELECT	nr_sequencia nr_seq_plano_instr,
		cd_classificacao,
		nm_dispositivo,
		ie_gerar_titulo,
		ie_quebra_pagina,
		nr_seq_tipo_tema
	from	pls_plano_instrumento
	where	nr_seq_instrumento	= nr_seq_instrumento_pc
	and	coalesce(ie_permite_inclusao_termo,'S') = 'S';

BEGIN

delete	FROM pls_contrato_doc_texto
where	nr_seq_documento in (	SELECT	nr_sequencia
				from	pls_contrato_documento
				where	nr_seq_solic_prop_online = nr_seq_proposta_online_p);

delete	FROM pls_contrato_documento
where	nr_seq_solic_prop_online = nr_seq_proposta_online_p;

for r_c01_w in c01 loop
	begin
	
	insert into pls_contrato_documento(nr_sequencia,dt_atualizacao,nm_usuario,
		dt_atualizacao_nrec,nm_usuario_nrec,nr_seq_solic_prop_online,
		nr_seq_instrumento,ds_documento,nr_seq_plano)
	values (nextval('pls_contrato_documento_seq'),clock_timestamp(),nm_usuario_p,
		clock_timestamp(),nm_usuario_p,nr_seq_proposta_online_p,
		r_c01_w.nr_seq_instrumento,r_c01_w.ds_instrumento,r_c01_w.nr_seq_plano)
	returning nr_sequencia into nr_seq_documento_w;

	for r_c02_w in c02(r_c01_w.nr_seq_instrumento) loop
		begin
		
		insert into pls_contrato_doc_texto(	nr_sequencia,dt_atualizacao,nm_usuario,
				dt_atualizacao_nrec,nm_usuario_nrec,nr_seq_documento,
				cd_classificacao,ds_dispositivo,ie_converte_macro,
				ie_imprimir_titulo,ie_quebra_pagina,nr_seq_tipo_tema)
		values (	nextval('pls_contrato_doc_texto_seq'),clock_timestamp(),nm_usuario_p,
				clock_timestamp(),nm_usuario_p,nr_seq_documento_w,
				r_c02_w.cd_classificacao,r_c02_w.nm_dispositivo,'N',
				r_c02_w.ie_gerar_titulo,r_c02_w.ie_quebra_pagina,r_c02_w.nr_seq_tipo_tema)
		returning nr_sequencia into nr_seq_doc_texto_w;
		
		CALL copia_campo_long_de_para('PLS_PLANO_INSTRUMENTO','DS_TEMA','where nr_sequencia = :nr_sequencia','nr_sequencia='||r_c02_w.nr_seq_plano_instr,
					'PLS_CONTRATO_DOC_TEXTO','DS_TEMA','where nr_sequencia = :nr_sequencia','nr_sequencia='||nr_seq_doc_texto_w);
		
		CALL pls_gerar_texto_macro(nr_seq_doc_texto_w, null, nr_seq_proposta_online_p, nm_usuario_p, 'O');
		end;
	end loop;
	
	end;
end loop;

commit;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE hpms_proposal_request_pck.generate_document ( nr_seq_proposta_online_p pls_proposta_online.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;
