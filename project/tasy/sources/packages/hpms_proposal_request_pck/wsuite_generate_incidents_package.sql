-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE hpms_proposal_request_pck.wsuite_generate_incidents ( nr_seq_analise_p pls_analise_adesao.nr_sequencia%type, nm_usuario_p text) AS $body$
DECLARE


/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade:
Create incidents of subscription analysis
-------------------------------------------------------------------------------------------------------------------

Locais de chamada direta: 
[  x]  Objetos do dicionario [ ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatorios [ ] Outros:
 ------------------------------------------------------------------------------------------------------------------

Pontos de atencao:
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
 

qt_idade_w		bigint;
qt_total_vidas_w	bigint;
nr_seq_prop_benef_w	pls_proposta_benef_online.nr_sequencia%type;
nr_seq_proposta_w	pls_proposta_online.nr_sequencia%type;
cd_estabelecimento_w	estabelecimento.cd_estabelecimento%type;

C01 CURSOR FOR
	SELECT	nr_sequencia nr_seq_regra_ocorrencia
	from	pls_regra_analise_adesao
	where	qt_idade_w between coalesce(qt_idade_inicial,qt_idade_w) and coalesce(qt_idade_final,qt_idade_w)
	and	qt_total_vidas_w between coalesce(qt_minima_vidas,qt_total_vidas_w) and coalesce(qt_maxima_vidas,qt_total_vidas_w)
	and	((ie_tipo_contratacao	= 'I' ) or (coalesce(ie_tipo_contratacao::text, '') = ''))
	and	ie_situacao	= 'A';


BEGIN

select	substr(obter_dados_pf(cd_pessoa_fisica, 'I'),1,40),
	nr_seq_prop_benef_online,
	nr_seq_prop_online,
	cd_estabelecimento
into STRICT	qt_idade_w,
	nr_seq_prop_benef_w,
	nr_seq_proposta_w,
	cd_estabelecimento_w
from	pls_analise_adesao
where	nr_sequencia	= nr_seq_analise_p;

select	count(1)
into STRICT	qt_total_vidas_w
from	pls_proposta_benef_online
where	nr_seq_prop_online	= nr_seq_proposta_w;

for C01_w in C01 loop
	begin
	insert	into pls_analise_ocorrencia(nr_sequencia, dt_atualizacao, nm_usuario,
		dt_atualizacao_nrec, nm_usuario_nrec, cd_estabelecimento,
		nr_seq_analise, nr_seq_regra_ocorrencia)
	values (nextval('pls_analise_ocorrencia_seq'), clock_timestamp(), nm_usuario_p,
		clock_timestamp(), nm_usuario_p, cd_estabelecimento_w,
		nr_seq_analise_p, C01_w.nr_seq_regra_ocorrencia);
	end;
end loop;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE hpms_proposal_request_pck.wsuite_generate_incidents ( nr_seq_analise_p pls_analise_adesao.nr_sequencia%type, nm_usuario_p text) FROM PUBLIC;
