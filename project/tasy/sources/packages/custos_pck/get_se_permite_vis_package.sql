-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION custos_pck.get_se_permite_vis (nr_seq_tabela_p tabela_custo.nr_sequencia%type, cd_centro_controle_p centro_controle.cd_centro_controle%type, cd_estab_centro_p centro_controle.cd_estabelecimento%type, cd_estab_filtro_p estabelecimento.cd_estabelecimento%type, cd_funcao_p regra_nivel_acesso_empresa.cd_funcao%type, cd_perfil_p regra_nivel_acesso_empresa.cd_perfil%type, nm_usuario_p usuario.nm_usuario%type) RETURNS bigint AS $body$
DECLARE


cd_empresa_w                  empresa.cd_empresa%type;
cd_estab_filtro_w             estabelecimento.cd_estabelecimento%type;
ie_nivel_acesso_w             smallint;
ie_mostrar_registro_w         smallint;


BEGIN
ie_mostrar_registro_w         := 0;


if (coalesce(nr_seq_tabela_p,0) != 0) then
    begin
    cd_estab_filtro_w       := coalesce(cd_estab_filtro_p,0);
    ie_nivel_acesso_w       := custos_pck.get_nivel_tabela(nr_seq_tabela_p);

if (ie_nivel_acesso_w = 1) then /*Tabela por estabelecimento*/

    begin
    select  coalesce(max(1), 0)
    into STRICT    ie_mostrar_registro_w

    where   exists (SELECT  1
            from    tabela_custo_acesso_v a
            where   a.nr_sequencia          = nr_seq_tabela_p
            and     a.ie_nivel_acesso       = 1
            and     a.cd_estabelecimento    = cd_estab_centro_p
            and     a.cd_estabelecimento    = cd_estab_filtro_p);
    end;
elsif (ie_nivel_acesso_w = 2) then
    begin
    cd_empresa_w            := obter_empresa_estab(cd_estab_centro_p);
    select  coalesce(max(1), 0)
    into STRICT    ie_mostrar_registro_w

    where   exists (SELECT  1
            from    tabela_custo_acesso_v a
            where   a.nr_sequencia          = nr_seq_tabela_p
            and     a.ie_nivel_acesso       = 2
            and     a.cd_empresa            = cd_empresa_w
            and     a.cd_estabelecimento    = cd_estab_centro_p
            and (a.cd_estabelecimento    = cd_estab_filtro_w or cd_estab_filtro_w = 0));
    end;
elsif (ie_nivel_acesso_w = 3) then
    begin
    cd_empresa_w            := obter_empresa_estab(cd_estab_centro_p);
    select  coalesce(max(1), 0)
    into STRICT    ie_mostrar_registro_w

    where   exists (SELECT  1
            from    tabela_custo_acesso_v a
            where   a.nr_sequencia          = nr_seq_tabela_p
            and     a.ie_nivel_acesso       = 3
            and     a.cd_empresa            = cd_empresa_w
            and     a.cd_estabelecimento    = cd_estab_centro_p
            and (a.cd_estabelecimento    = cd_estab_filtro_w or cd_estab_filtro_w = 0));
    end;
end if;
end;
end if;
return null;
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION custos_pck.get_se_permite_vis (nr_seq_tabela_p tabela_custo.nr_sequencia%type, cd_centro_controle_p centro_controle.cd_centro_controle%type, cd_estab_centro_p centro_controle.cd_estabelecimento%type, cd_estab_filtro_p estabelecimento.cd_estabelecimento%type, cd_funcao_p regra_nivel_acesso_empresa.cd_funcao%type, cd_perfil_p regra_nivel_acesso_empresa.cd_perfil%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;
