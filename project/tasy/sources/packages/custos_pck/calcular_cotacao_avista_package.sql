-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE custos_pck.calcular_cotacao_avista ( cd_estabelecimento_p bigint, cd_tabela_custo_p bigint, nr_seq_tabela_p bigint, nm_usuario_p text) AS $body$
DECLARE



ds_erro_w               varchar(2000);
pr_taxa_financ_w        double precision    := 0;
vl_cotado_consumo_w     double precision    := 0;
vl_presente_w           double precision    := 0;

c01 CURSOR(
        nr_seq_tabela_pc  tabela_parametro.nr_seq_tabela%type
        )FOR
        SELECT  x.cd_material,
                x.vl_cotado,
                x.cd_estabelecimento,
                x.qt_dias_prazo,
                x.pr_frete,
                x.qt_conv_compra_estoque,
                x.qt_conv_estoque_consumo
        from (  SELECT  a.cd_material cd_material,
                        a.vl_cotado_compra vl_cotado,
                        a.cd_estabelecimento cd_estabelecimento,
                        coalesce(a.qt_dias_prazo, 1) qt_dias_prazo,
                        coalesce(a.pr_frete, 0) pr_frete,
                        coalesce(b.qt_conv_compra_estoque, 1) qt_conv_compra_estoque,
                        coalesce(b.qt_conv_estoque_consumo, 1) qt_conv_estoque_consumo
                from    material b,
                        custo_material a
                where   a.nr_seq_tabela     = nr_seq_tabela_pc
                and     a.cd_material       = b.cd_material
                and     (a.vl_cotado_compra IS NOT NULL AND a.vl_cotado_compra::text <> '')
                and     a.ie_origem_custo   = 'C'
                and     exists ( select  1
                                from    tabela_custo_acesso_v tca
                                where   tca.nr_sequencia        = nr_seq_tabela_pc
                                and     tca.cd_estabelecimento  = a.cd_estabelecimento))
  x;

type vetor_c01 is table of c01%rowtype index by integer;
vetor_c01_w    vetor_c01;

type vetor_vl_presente is table of custo_material.vl_presente%type index by integer;
v_vl_presente_w   vetor_vl_presente;

type vetor_cotado_consumo is table of custo_material.vl_cotado_consumo%type index by integer;
v_cotado_consumo_w   vetor_cotado_consumo;

type vetor_cd_estabelecimento is table of custo_material.cd_estabelecimento%type index by integer;
v_cd_estabelecimento_w   vetor_cd_estabelecimento;

type vetor_cd_material is table of custo_material.cd_material%type index by integer;
v_cd_material_w   vetor_cd_material;




BEGIN

select  coalesce(max(qt_parametro), 0)
into STRICT    pr_taxa_financ_w
from    tabela_parametro
where   nr_seq_tabela       = nr_seq_tabela_p
and     nr_seq_parametro    = 1;

open c01(
        nr_seq_tabela_pc    => nr_seq_tabela_p
        );
        loop fetch c01 bulk collect into vetor_c01_w limit 1000;
        exit when vetor_c01_w.count = 0;
             for i in vetor_c01_w.first .. vetor_c01_w.last loop
             begin
                     
             if (vetor_c01_w[i].qt_dias_prazo > 1000) then
                   vetor_c01_w[i].qt_dias_prazo     := 1;
             end if;

             vl_cotado_consumo_w := 0;
             vl_presente_w       := 0;

             begin
             vl_cotado_consumo_w := round((vetor_c01_w[i].vl_cotado / vetor_c01_w[i].qt_conv_compra_estoque / vetor_c01_w[i].qt_conv_estoque_consumo)::numeric,4);
             vl_presente_w       := round(vl_cotado_consumo_w * (1 + vetor_c01_w[i].pr_frete/100),4);
             vl_presente_w       := round(vl_presente_w / (1 + pr_taxa_financ_w /100)**(vetor_c01_w[i].qt_dias_prazo/30),4);
             exception when others then
                       ds_erro_w   := sqlerrm(SQLSTATE);
                       CALL wheb_mensagem_pck.exibir_mensagem_abort(nr_seq_mensagem_p => 192969,vl_macros_p => 'CD_MATERIAL_W='||vetor_c01_w[i].cd_material);
             end;

             v_vl_presente_w(i)           := vl_presente_w;
             v_cotado_consumo_w(i)        := vl_cotado_consumo_w;
             v_cd_estabelecimento_w(i)    := vetor_c01_w[i].cd_estabelecimento;
             v_cd_material_w(i)           := vetor_c01_w[i].cd_material;

             end;
             end loop;

             forall indice in v_vl_presente_w.first .. v_vl_presente_w.last
                 update  custo_material
                 set     vl_presente         = v_vl_presente_w(indice),
                         vl_cotado_consumo   = v_cotado_consumo_w(indice),
                         dt_atualizacao      = clock_timestamp(),
                         nm_usuario          = nm_usuario_p
                 where   cd_estabelecimento  = v_cd_estabelecimento_w(indice)
                 and     nr_seq_tabela       = nr_seq_tabela_p
                 and     cd_material         = v_cd_material_w(indice);

             commit;
             v_vl_presente_w.delete;
             v_cotado_consumo_w.delete;
             v_cd_estabelecimento_w.delete;
             v_cd_material_w.delete;
        end loop;
close c01;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE custos_pck.calcular_cotacao_avista ( cd_estabelecimento_p bigint, cd_tabela_custo_p bigint, nr_seq_tabela_p bigint, nm_usuario_p text) FROM PUBLIC;
