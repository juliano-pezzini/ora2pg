-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE custos_pck.calcular_custo_padrao ( cd_estabelecimento_p bigint, cd_tabela_custo_p bigint, nr_ficha_inicial_p bigint, nr_ficha_final_p bigint, nr_seq_tabela_p bigint, nm_usuario_p text) AS $body$
DECLARE


dt_atualizacao_w                 timestamp            := clock_timestamp();
nr_ficha_tecnica_w               custo_padrao_comp.nr_ficha_tecnica%type := 0;
nr_nivel_estrutura_w             ficha_tecnica.nr_nivel_estrutura%type := 0;
cd_procedimento_w                bigint      := 0;
ie_origem_proced_w               ficha_tecnica_componente.ie_origem_proced%type := 0;
cd_material_w                    ficha_tecnica.cd_material%type := 0;
qt_lote_padrao_w                 double precision    := 0;
---                                                       

ie_tipo_componente_w             varchar(1)     := '0';
cd_tipo_gasto_w                  varchar(1)     := '0';
cd_taxa_calculo_w                varchar(1)     := 'C';
cd_gng_materiais_w               integer       := 0;
cd_gng_serv_terc_w               integer       := 0;

                                 
cd_tabela_taxa_custo_w           tabela_parametro.cd_tabela_custo%type := 0;
cd_tabela_custo_proc_w           tabela_parametro.cd_tabela_custo%type := 0;
cd_tabela_custo_mat_w            tabela_parametro.cd_tabela_custo%type := 0;
dt_ficha_tecnica_w               timestamp;

cd_material_comp_w               custo_material.cd_material%type := 0;
cd_procedimento_comp_w           bigint      := 0;
ie_origem_proced_comp_w          ficha_tecnica.ie_origem_proced%type := 0;
cd_centro_controle_comp_w        ficha_tecnica_componente.cd_centro_controle%type := 0;
nr_seq_componente_w              custo_padrao_comp.nr_seq_componente%type := 0;
qt_fixa_w                        double precision    := 0;
qt_fixa_comp_w                   double precision    := 0;
qt_variavel_w                    double precision    := 0;
vl_custo_unit_var_w              double precision    := 0;
vl_custo_unit_fixo_w             double precision    := 0;
vl_custo_componente_w            double precision    := 0;
vl_selecionado_w                 double precision    := 0;
---                                                       

vl_custo_fixo_w                  double precision    := 0;
vl_custo_variavel_w              double precision    := 0;
ie_situacao_calculo_w            varchar(1)      := 'C';
ie_situacao_calculo_comp_w       varchar(1)      := 'C';
nr_seq_gng_mat_w                 bigint;
nr_seq_gng_serv_terc_w           bigint;
cd_empresa_w                     bigint;
qt_contador_w                    bigint      := 0;
nr_seq_exame_comp_w              bigint;
nr_seq_proc_interno_comp_w       bigint;
dt_mes_referencia_w              timestamp;
nr_seq_tabela_taxa_custo_w       bigint;
nr_seq_tabela_custo_proc_w       bigint;
nr_seq_tabela_custo_mat_w        bigint;
nr_indice_vetor_w                integer;
custo_padrao_comp_seq_w          custo_padrao_comp.nr_sequencia%type;

cd_estabelecimento_w            tabela_custo.cd_estabelecimento%type;

c00 CURSOR FOR
       SELECT  distinct cd_estabelecimento
       from    tabela_custo_acesso_v tca
       where   tca.nr_sequencia    = nr_seq_tabela_p;


c01 CURSOR(
       cd_estabelecimento_pc    ficha_tecnica.cd_estabelecimento%type,
       nr_ficha_inicial_pc      ficha_tecnica.nr_ficha_tecnica%type,
       nr_ficha_final_pc        ficha_tecnica.nr_ficha_tecnica%type
       ) FOR
      SELECT  nr_ficha_tecnica,
              nr_nivel_estrutura,
              cd_procedimento,
              ie_origem_proced,
              cd_material,
              qt_lote_padrao
      from    ficha_tecnica
      where   cd_estabelecimento   = cd_estabelecimento_pc
      and     nr_ficha_tecnica between nr_ficha_inicial_pc and nr_ficha_final_pc
      and     ie_situacao          = 'A'
      order by
              nr_nivel_estrutura,
              cd_material,
              cd_procedimento
      desc;

type vetor_c01 is table of c01%rowtype index by integer;
v_c01_w    vetor_c01;


type vetor_custo_padrao is table of custo_padrao%rowtype index by integer;
v_custo_padrao_w  vetor_custo_padrao;

c02 CURSOR(
       nr_ficha_tecnica_pc      ficha_tecnica_componente.nr_ficha_tecnica%type,
       dt_ficha_tecnica_pc      ficha_tecnica_componente.dt_alteracao%type,
       dt_mes_referencia_pc     timestamp,
       cd_estabelecimento_pc    ficha_tecnica_componente.cd_estabelecimento%type
       ) FOR
       SELECT  cd_material,
               cd_procedimento,
               ie_origem_proced,
               cd_centro_controle,
               ie_tipo_componente,
               nr_seq_componente,
               coalesce(qt_fixa,0) qt_fixa,
               coalesce(qt_variavel,0) qt_variavel,
               nr_seq_exame,
               nr_seq_proc_interno
       from    ficha_tecnica_componente
       where   nr_ficha_tecnica    = nr_ficha_tecnica_pc
       and     ie_situacao         = 'A'
       and     dt_alteracao        <= dt_ficha_tecnica_pc
       and     obter_se_periodo_vigente(dt_inicio_vigencia, dt_fim_vigencia, dt_mes_referencia_pc) = 'S'
       and     cd_estabelecimento  =   cd_estabelecimento_pc
       order by
               ie_tipo_componente,
               nr_seq_componente;

type vetor_c02 is table of c02%rowtype index by integer;
v_c02_w    vetor_c02;

c03 CURSOR(
          nr_seq_tabela_taxa_custo_pc  taxa_custo.nr_seq_tabela%type,
          cd_centro_controle_comp_pc   taxa_custo.cd_centro_controle%type,
          cd_estabelecimento_pc        taxa_custo.cd_estabelecimento%type,
          cd_empresa_pc                grupo_natureza_gasto.cd_empresa%type
         ) FOR
         SELECT  x.cd_grupo_natureza_gasto,
                 x.nr_sequencia,
                 x.vl_taxa_custo,
                 x.vl_taxa_atend,
                 x.vl_taxa_pratica,
                 x.vl_taxa_teorica,
                 x.ie_tipo_gasto,
                 nextval('custo_padrao_comp_seq') custo_padrao_comp_seq
         from (   SELECT  b.cd_grupo_natureza_gasto,
                         b.nr_sequencia,
                         a.vl_taxa_custo,
                         a.vl_taxa_atend,
                         a.vl_taxa_pratica,
                         a.vl_taxa_teorica,
                         b.ie_tipo_gasto
                from     taxa_custo a,
                         grupo_natureza_gasto b
                where    a.nr_seq_tabela       = nr_seq_tabela_taxa_custo_pc
                and      a.cd_centro_controle  = cd_centro_controle_comp_pc
                and      a.nr_seq_gng          = b.nr_sequencia
                and      a.cd_estabelecimento  = coalesce(b.cd_estabelecimento,cd_estabelecimento_pc)
                and      b.cd_empresa          = cd_empresa_pc)
         x;

type vetor_c03 is table of c03%rowtype index by integer;
v_c03_w    vetor_c03;

type vetor_custo_padrao_comp is table of custo_padrao_comp%rowtype index by integer;
v_custo_padrao_comp_w  vetor_custo_padrao_comp;

BEGIN
qt_contador_w   := qt_contador_w + 1;
CALL gravar_processo_longo(wheb_mensagem_pck.get_texto(298615),'CALCULAR_CUSTO_PADRAO',qt_contador_w);
cd_empresa_w    := obter_empresa_estab(cd_estabelecimento_p);

delete  from custo_padrao_comp
where   nr_seq_tabela = nr_seq_tabela_p;

delete  from custo_padrao
where   nr_seq_tabela = nr_seq_tabela_p;

select  coalesce(max(cd_tabela_parametro),0),
        coalesce(max(nr_seq_tabela_param),0)
into STRICT    cd_tabela_custo_mat_w,
        nr_seq_tabela_custo_mat_w
from    tabela_parametro
where   nr_seq_tabela       = nr_seq_tabela_p
and     nr_seq_parametro    = 2;

select  coalesce(max(cd_tabela_parametro),0),
        coalesce(max(nr_seq_tabela_param),0)
into STRICT    cd_tabela_Taxa_Custo_w,
        nr_seq_tabela_taxa_custo_w
from    tabela_parametro
where   nr_seq_tabela       = nr_seq_tabela_p
and     nr_seq_parametro    = 3;

select  coalesce(max(cd_tabela_parametro),0),
        coalesce(max(nr_seq_tabela_param),0)
into STRICT    cd_tabela_custo_Proc_w,
        nr_seq_tabela_custo_proc_w
from    tabela_parametro
where   nr_seq_tabela       = nr_seq_tabela_p
and     nr_seq_parametro    = 4;

select  coalesce(max(dt_parametro), clock_timestamp())
into STRICT    dt_ficha_tecnica_w
from    tabela_parametro
where   nr_seq_tabela       = nr_seq_tabela_p
and     nr_seq_parametro    = 5;

select  max(dt_mes_referencia)
into STRICT    dt_mes_referencia_w
from    tabela_custo
where   nr_sequencia       = nr_seq_tabela_p;


qt_contador_w  := qt_contador_w + 1;

CALL gravar_processo_longo(wheb_mensagem_pck.get_texto(298798),'CALCULAR_CUSTO_PADRAO',qt_contador_w);

open c00;
loop
fetch c00 into
      cd_estabelecimento_w;
EXIT WHEN NOT FOUND; /* apply on c00 */

      select  max(nr_seq_gng_mat),
              max(nr_seq_gng_serv_terc),
              coalesce(max(cd_gng_materiais),0),
              coalesce(max(cd_gng_servicos_terc),0)
      into STRICT    nr_seq_gng_mat_w,
              nr_seq_gng_serv_terc_w,
              cd_gng_materiais_w,
              cd_gng_serv_terc_w
      from    parametro_custo
      where   cd_estabelecimento = cd_estabelecimento_w;

      cd_empresa_w := obter_empresa_estab(cd_estabelecimento_w);

      open c01(
              cd_estabelecimento_pc     => cd_estabelecimento_w,
              nr_ficha_inicial_pc       => nr_ficha_inicial_p,
              nr_ficha_final_pc         => nr_ficha_final_p
              );
             loop fetch c01 bulk collect into v_c01_w limit 1000;
             exit when v_c01_w.count = 0;
                 for i in v_c01_w.first .. v_c01_w.last loop

                 qt_contador_w           := qt_contador_w + 1;
                 vl_custo_fixo_w         := 0;
                 vl_custo_variavel_w     := 0;
                 ie_situacao_calculo_w   := 'C';
                 CALL gravar_processo_longo(wheb_mensagem_pck.get_texto(298798),'CALCULAR_CUSTO_PADRAO',qt_contador_w);

                 nr_ficha_tecnica_w     := v_c01_w[i].nr_ficha_tecnica;
                 nr_nivel_estrutura_w   := v_c01_w[i].nr_nivel_estrutura;
                 cd_procedimento_w      := v_c01_w[i].cd_procedimento;
                 ie_origem_proced_w     := v_c01_w[i].ie_origem_proced;
                 cd_material_w          := v_c01_w[i].cd_material;
                 qt_lote_padrao_w       := v_c01_w[i].qt_lote_padrao;

                 v_custo_padrao_w[i].cd_estabelecimento  := cd_estabelecimento_w;
                 v_custo_padrao_w[i].cd_tabela_custo     := cd_tabela_custo_p;
                 v_custo_padrao_w[i].nr_ficha_tecnica    := nr_ficha_tecnica_w;
                 v_custo_padrao_w[i].nm_usuario          := nm_usuario_p;
                 v_custo_padrao_w[i].dt_atualizacao      := dt_atualizacao_w;
                 v_custo_padrao_w[i].ie_situacao_calculo := ie_situacao_calculo_w;
                 v_custo_padrao_w[i].vl_custo_fixo       := vl_custo_fixo_w;
                 v_custo_padrao_w[i].vl_custo_variavel   := vl_custo_variavel_w;
                 v_custo_padrao_w[i].nr_seq_tabela       := nr_seq_tabela_p;

                 open c02(
                         nr_ficha_tecnica_pc     => nr_ficha_tecnica_w,
                         dt_ficha_tecnica_pc     => dt_ficha_tecnica_w,
                         dt_mes_referencia_pc    => dt_mes_referencia_w,
                         cd_estabelecimento_pc   => cd_estabelecimento_w
                         );
                        loop fetch c02 bulk collect into v_c02_w limit 1000;
                        exit when v_c02_w.count = 0;
                            for j in v_c02_w.first .. v_c02_w.last loop

                            vl_custo_unit_fixo_w        := 0;
                            vl_custo_unit_var_w         := 0;

                            cd_material_comp_w          :=  v_c02_w[j].cd_material;
                            cd_procedimento_comp_w      :=  v_c02_w[j].cd_procedimento;
                            ie_origem_proced_comp_w     :=  v_c02_w[j].ie_origem_proced;
                            cd_centro_controle_comp_w   :=  v_c02_w[j].cd_centro_controle;
                            ie_tipo_componente_w        :=  v_c02_w[j].ie_tipo_componente;
                            nr_seq_componente_w         :=  v_c02_w[j].nr_seq_componente;
                            qt_fixa_w                   :=  v_c02_w[j].qt_fixa;
                            qt_variavel_w               :=  v_c02_w[j].qt_variavel;
                            nr_seq_exame_comp_w         :=  v_c02_w[j].nr_seq_exame;
                            nr_seq_proc_interno_comp_w  :=  v_c02_w[j].nr_seq_proc_interno;


                            if (ie_tipo_componente_w = '1') then
                                   begin
                                   select  coalesce(b.vl_custo_variavel,0),
                                           coalesce(b.vl_custo_fixo,0)
                                   into STRICT    vl_custo_unit_var_w,
                                           vl_custo_unit_fixo_w
                                   from    custo_padrao b,
                                           ficha_tecnica a
                                   where   a.cd_estabelecimento  = cd_estabelecimento_w
                                   and     a.cd_material         = cd_material_comp_w
                                   and     a.cd_estabelecimento  = b.cd_estabelecimento
                                   and     a.nr_ficha_tecnica    = b.nr_ficha_tecnica
                                   and     b.nr_seq_tabela       = nr_seq_tabela_p;
                                   exception when others then
                                             begin
                                             select    dividir(coalesce(vl_presente,0),CASE WHEN coalesce(nr_fator_conversao,0)=0 THEN 1  ELSE nr_fator_conversao END )
                                             into STRICT      vl_custo_unit_var_w
                                             from      custo_material
                                             where     nr_seq_tabela   = nr_seq_tabela_custo_mat_w
                                             and       cd_material     = cd_material_comp_w;
                                             exception when others then
                                                       vl_custo_unit_var_w := 0;
                                             end;
                                   end;

                                   if (vl_custo_unit_var_w <> 0) then
                                           ie_situacao_calculo_comp_w      := 'C';
                                   else
                                           ie_situacao_calculo_comp_w      := 'I';
                                   end if;

                                   qt_fixa_comp_w :=  (qt_fixa_w / qt_lote_padrao_w);

                                   if (vl_custo_unit_var_w <> 0) or (ie_situacao_calculo_comp_w = 'I') then
                                           vl_custo_componente_w   := vl_custo_unit_var_w * (qt_variavel_w + qt_fixa_comp_W);
                                           nr_indice_vetor_w       := v_custo_padrao_comp_w.count + 1;

                                           select nextval('custo_padrao_comp_seq')
                                           into STRICT   custo_padrao_comp_seq_w
;

                                           v_custo_padrao_comp_w[nr_indice_vetor_w].nr_sequencia             := custo_padrao_comp_seq_w;
                                           v_custo_padrao_comp_w[nr_indice_vetor_w].cd_estabelecimento       := cd_estabelecimento_w;
                                           v_custo_padrao_comp_w[nr_indice_vetor_w].cd_tabela_custo          := cd_tabela_custo_p;
                                           v_custo_padrao_comp_w[nr_indice_vetor_w].nr_ficha_tecnica         := nr_ficha_tecnica_w;
                                           v_custo_padrao_comp_w[nr_indice_vetor_w].nr_seq_componente        := nr_seq_componente_w;
                                           v_custo_padrao_comp_w[nr_indice_vetor_w].cd_tipo_gasto            := 'V';
                                           v_custo_padrao_comp_w[nr_indice_vetor_w].cd_grupo_natureza_gasto  := cd_gng_materiais_w;
                                           v_custo_padrao_comp_w[nr_indice_vetor_w].nr_seq_gng               := nr_seq_gng_mat_w;
                                           v_custo_padrao_comp_w[nr_indice_vetor_w].nm_usuario               := nm_usuario_p;
                                           v_custo_padrao_comp_w[nr_indice_vetor_w].dt_atualizacao           := dt_atualizacao_w;
                                           v_custo_padrao_comp_w[nr_indice_vetor_w].ie_situacao_calculo      := ie_situacao_calculo_comp_w;
                                           v_custo_padrao_comp_w[nr_indice_vetor_w].vl_custo_unitario        := vl_custo_unit_var_w;
                                           v_custo_padrao_comp_w[nr_indice_vetor_w].vl_custo_componente      := vl_custo_componente_w;
                                           v_custo_padrao_comp_w[nr_indice_vetor_w].nr_seq_tabela            := nr_seq_tabela_p;

                                           vl_custo_variavel_w := vl_custo_variavel_w + vl_custo_componente_w;

                                           if (ie_situacao_calculo_comp_w = 'I') then
                                                  v_custo_padrao_w[i].ie_situacao_calculo := 'I';
                                           end if;
                                   end if;

                                   if (vl_custo_unit_fixo_w <> 0) or (ie_situacao_calculo_comp_w = 'I') then
                                           vl_custo_componente_w   := vl_custo_unit_fixo_w * (qt_variavel_w + qt_fixa_comp_W);
                                           nr_indice_vetor_w       := v_custo_padrao_comp_w.count + 1;

                                           select nextval('custo_padrao_comp_seq')
                                           into STRICT   custo_padrao_comp_seq_w
;

                                           v_custo_padrao_comp_w[nr_indice_vetor_w].nr_sequencia             := custo_padrao_comp_seq_w;
                                           v_custo_padrao_comp_w[nr_indice_vetor_w].cd_estabelecimento       := cd_estabelecimento_w;
                                           v_custo_padrao_comp_w[nr_indice_vetor_w].cd_tabela_custo          := cd_tabela_custo_p;
                                           v_custo_padrao_comp_w[nr_indice_vetor_w].nr_ficha_tecnica         := nr_ficha_tecnica_w;
                                           v_custo_padrao_comp_w[nr_indice_vetor_w].nr_seq_componente        := nr_seq_componente_w;
                                           v_custo_padrao_comp_w[nr_indice_vetor_w].cd_tipo_gasto            := 'F';
                                           v_custo_padrao_comp_w[nr_indice_vetor_w].cd_grupo_natureza_gasto  := cd_gng_materiais_w;
                                           v_custo_padrao_comp_w[nr_indice_vetor_w].nr_seq_gng               := nr_seq_gng_mat_w;
                                           v_custo_padrao_comp_w[nr_indice_vetor_w].nm_usuario               := nm_usuario_p;
                                           v_custo_padrao_comp_w[nr_indice_vetor_w].dt_atualizacao           := dt_atualizacao_w;
                                           v_custo_padrao_comp_w[nr_indice_vetor_w].ie_situacao_calculo      := ie_situacao_calculo_comp_w;
                                           v_custo_padrao_comp_w[nr_indice_vetor_w].vl_custo_unitario        := vl_custo_unit_fixo_w;
                                           v_custo_padrao_comp_w[nr_indice_vetor_w].vl_custo_componente      := vl_custo_componente_w;
                                           v_custo_padrao_comp_w[nr_indice_vetor_w].nr_seq_tabela            := nr_seq_tabela_p;

                                           vl_custo_fixo_w := vl_custo_fixo_w + vl_custo_componente_w;

                                           if (ie_situacao_calculo_comp_w = 'I') then
                                                   v_custo_padrao_w[i].ie_situacao_calculo := 'I';
                                           end if;
                                   end if;
                            end if;
                                   /*Servicos de Terceiros*/


                            if (ie_tipo_componente_w = '2') then
                                    if (coalesce(cd_procedimento_comp_w,0) <> 0) then
                                           begin
                                           select  coalesce(b.vl_custo_variavel,0),
                                                   coalesce(b.vl_custo_fixo,0)
                                           into STRICT    vl_custo_unit_var_w,
                                                   vl_custo_unit_fixo_w
                                           from    custo_padrao b,
                                                   ficha_tecnica a
                                           where   a.cd_estabelecimento       = cd_estabelecimento_w
                                           and     a.cd_procedimento          = cd_procedimento_comp_w
                                           and     a.ie_origem_proced         = ie_origem_proced_comp_w
                                           and     a.cd_estabelecimento       = b.cd_estabelecimento
                                           and     a.nr_ficha_tecnica         = b.nr_ficha_tecnica
                                           and     b.nr_seq_tabela            = nr_seq_tabela_p
                                           and     a.nr_nivel_estrutura       < nr_nivel_estrutura_w;
                                           exception when others then
                                                     begin
                                                     select  vl_presente
                                                     into STRICT    vl_custo_unit_var_w
                                                     from    custo_procedimento
                                                     where   nr_seq_tabela     = nr_seq_tabela_custo_Proc_w
                                                     and     cd_procedimento   = cd_procedimento_comp_w
                                                     and     ie_origem_proced  = ie_origem_proced_comp_w;
                                                     exception when others then
                                                               vl_custo_unit_var_w := 0;
                                                     end;
                                          end;

                                    elsif (coalesce(nr_seq_proc_interno_comp_w,0) <> 0) then
                                              begin
                                              select  coalesce(b.vl_custo_variavel,0),
                                                      coalesce(b.vl_custo_fixo,0)
                                              into STRICT    vl_custo_unit_var_w,
                                                      vl_custo_unit_fixo_w
                                              from    custo_padrao b,
                                                      ficha_tecnica a
                                              where   a.cd_estabelecimento    = cd_estabelecimento_w
                                              and     a.nr_seq_proc_interno   = nr_seq_proc_interno_comp_w
                                              and     a.cd_estabelecimento    = b.cd_estabelecimento
                                              and     a.nr_ficha_tecnica      = b.nr_ficha_tecnica
                                              and     b.nr_seq_tabela         = nr_seq_tabela_p
                                              and     a.nr_nivel_estrutura    < nr_nivel_estrutura_w;
                                              exception when others then
                                                        begin
                                                        select  vl_presente
                                                        into STRICT    vl_custo_unit_var_w
                                                        from    custo_procedimento
                                                        where   nr_seq_tabela       = nr_seq_tabela_custo_proc_w
                                                        and     nr_seq_proc_interno = nr_seq_proc_interno_comp_w;
                                                        exception when others then
                                                                  vl_custo_unit_var_w := 0;
                                                        end;
                                              end;
                                    elsif (coalesce(nr_seq_exame_comp_w,0) <> 0) then
                                             begin

                                             select  coalesce(b.vl_custo_variavel,0),
                                                     coalesce(b.vl_custo_fixo,0)
                                             into STRICT    vl_custo_unit_var_w,
                                                     vl_custo_unit_fixo_w
                                             from    custo_padrao b,
                                                     ficha_tecnica a
                                             where   a.cd_estabelecimento    = cd_estabelecimento_w
                                             and     a.nr_seq_exame          = nr_seq_exame_comp_w
                                             and     a.cd_estabelecimento    = b.cd_estabelecimento
                                             and     a.nr_ficha_tecnica      = b.nr_ficha_tecnica
                                             and     b.nr_seq_tabela         = nr_seq_tabela_p
                                             and     a.nr_nivel_estrutura    < nr_nivel_estrutura_w;
                                             exception when others then
                                                       begin
                                                       select  vl_presente
                                                       into STRICT    vl_custo_unit_var_w
                                                       from    custo_procedimento
                                                       where   nr_seq_tabela       = nr_seq_tabela_custo_proc_w
                                                       and     nr_seq_exame        = nr_seq_exame_comp_w;
                                                       exception when others then
                                                                 vl_custo_unit_var_w     := 0;
                                                       end;
                                             end;
                                     end if;

                                    if (vl_custo_unit_var_w <> 0) or (vl_custo_unit_fixo_w <> 0) then
                                           ie_situacao_calculo_comp_w      := 'C';
                                    else
                                           ie_situacao_calculo_comp_w      := 'I';
                                    end if;

                                    if (vl_custo_unit_var_w <> 0) or (ie_situacao_calculo_comp_w = 'I') then
                                           qt_fixa_comp_w          := (qt_fixa_w / qt_lote_padrao_w);
                                           vl_custo_componente_w   := vl_custo_unit_var_w * (qt_variavel_w + qt_fixa_comp_w);
                                           nr_indice_vetor_w       := v_custo_padrao_comp_w.count + 1;

                                           select nextval('custo_padrao_comp_seq')
                                           into STRICT   custo_padrao_comp_seq_w
;

                                           v_custo_padrao_comp_w[nr_indice_vetor_w].nr_sequencia             := custo_padrao_comp_seq_w;
                                           v_custo_padrao_comp_w[nr_indice_vetor_w].cd_estabelecimento       := cd_estabelecimento_w;
                                           v_custo_padrao_comp_w[nr_indice_vetor_w].cd_tabela_custo          := cd_tabela_custo_p;
                                           v_custo_padrao_comp_w[nr_indice_vetor_w].nr_ficha_tecnica         := nr_ficha_tecnica_w;
                                           v_custo_padrao_comp_w[nr_indice_vetor_w].nr_seq_componente        := nr_seq_componente_w;
                                           v_custo_padrao_comp_w[nr_indice_vetor_w].cd_tipo_gasto            := 'V';
                                           v_custo_padrao_comp_w[nr_indice_vetor_w].cd_grupo_natureza_gasto  := cd_gng_serv_terc_w;
                                           v_custo_padrao_comp_w[nr_indice_vetor_w].nr_seq_gng               := nr_seq_gng_serv_terc_w;
                                           v_custo_padrao_comp_w[nr_indice_vetor_w].nm_usuario               := nm_usuario_p;
                                           v_custo_padrao_comp_w[nr_indice_vetor_w].dt_atualizacao           := dt_atualizacao_w;
                                           v_custo_padrao_comp_w[nr_indice_vetor_w].ie_situacao_calculo      := ie_situacao_calculo_comp_w;
                                           v_custo_padrao_comp_w[nr_indice_vetor_w].vl_custo_unitario        := vl_custo_unit_var_w;
                                           v_custo_padrao_comp_w[nr_indice_vetor_w].vl_custo_componente      := vl_custo_componente_w;
                                           v_custo_padrao_comp_w[nr_indice_vetor_w].nr_seq_tabela            := nr_seq_tabela_p;

                                          
                                           vl_custo_variavel_w := vl_custo_variavel_w + vl_custo_componente_w;
                                           if (ie_situacao_calculo_comp_w = 'I') then
                                                   v_custo_padrao_w[i].ie_situacao_calculo := 'I';
                                           end if;
                                    end if;

                                    if (vl_custo_unit_fixo_w <> 0) or (ie_situacao_calculo_comp_w = 'I') then
                                           qt_fixa_comp_w          := (qt_fixa_w / qt_lote_padrao_w);
                                           vl_custo_componente_w   := vl_custo_unit_fixo_w * (qt_variavel_w + qt_fixa_comp_W);
                                           nr_indice_vetor_w       := v_custo_padrao_comp_w.count + 1;

                                           select nextval('custo_padrao_comp_seq')
                                           into STRICT   custo_padrao_comp_seq_w
;

                                           v_custo_padrao_comp_w[nr_indice_vetor_w].nr_sequencia             := custo_padrao_comp_seq_w;
                                           v_custo_padrao_comp_w[nr_indice_vetor_w].cd_estabelecimento       := cd_estabelecimento_w;
                                           v_custo_padrao_comp_w[nr_indice_vetor_w].cd_tabela_custo          := cd_tabela_custo_p;
                                           v_custo_padrao_comp_w[nr_indice_vetor_w].nr_ficha_tecnica         := nr_ficha_tecnica_w;
                                           v_custo_padrao_comp_w[nr_indice_vetor_w].nr_seq_componente        := nr_seq_componente_w;
                                           v_custo_padrao_comp_w[nr_indice_vetor_w].cd_tipo_gasto            := 'F';
                                           v_custo_padrao_comp_w[nr_indice_vetor_w].cd_grupo_natureza_gasto  := cd_gng_serv_terc_w;
                                           v_custo_padrao_comp_w[nr_indice_vetor_w].nr_seq_gng               := nr_seq_gng_serv_terc_w;
                                           v_custo_padrao_comp_w[nr_indice_vetor_w].nm_usuario               := nm_usuario_p;
                                           v_custo_padrao_comp_w[nr_indice_vetor_w].dt_atualizacao           := dt_atualizacao_w;
                                           v_custo_padrao_comp_w[nr_indice_vetor_w].ie_situacao_calculo      := ie_situacao_calculo_comp_w;
                                           v_custo_padrao_comp_w[nr_indice_vetor_w].vl_custo_unitario        := vl_custo_unit_fixo_w;
                                           v_custo_padrao_comp_w[nr_indice_vetor_w].vl_custo_componente      := vl_custo_componente_w;
                                           v_custo_padrao_comp_w[nr_indice_vetor_w].nr_seq_tabela            := nr_seq_tabela_p;

                                           vl_custo_fixo_w     := vl_custo_fixo_w + vl_custo_componente_w;

                                           if (ie_situacao_calculo_comp_w = 'I') then
                                                   v_custo_padrao_w[i].ie_situacao_calculo := 'I';
                                           end if;

                                    end if;
                            end if;
                            if (ie_tipo_componente_w = '3') then
                                  select  coalesce(ie_tx_custo_padrao,'C')
                                  into STRICT    cd_taxa_calculo_w
                                  from    parametro_custo
                                  where   cd_estabelecimento = cd_estabelecimento_w;

                                  open c03(
                                          nr_seq_tabela_taxa_custo_pc => nr_seq_tabela_taxa_custo_w,
                                          cd_centro_controle_comp_pc  => cd_centro_controle_comp_w,
                                          cd_estabelecimento_pc       => cd_estabelecimento_w,
                                          cd_empresa_pc               => cd_empresa_w
                                          );
                                          loop fetch c03 bulk collect into v_c03_w limit 1000;
                                          exit when v_c03_w.count = 0;
                                               for k in v_c03_w.first .. v_c03_w.last loop

                                                if (cd_taxa_calculo_w = 'C') then
                                                       vl_selecionado_w := v_c03_w[k].vl_taxa_custo;

                                                elsif (cd_taxa_calculo_w = 'A') then
                                                       vl_selecionado_w := v_c03_w[k].vl_taxa_atend;

                                                elsif (cd_taxa_calculo_w = 'P') then
                                                       vl_selecionado_w := v_c03_w[k].vl_taxa_pratica;

                                                elsif (cd_taxa_calculo_w = 'O') then
                                                       vl_selecionado_w := v_c03_w[k].vl_taxa_teorica;
                                                end if;

                                                qt_fixa_comp_w              := (qt_fixa_w / qt_lote_padrao_w);
                                                vl_custo_componente_w       := vl_selecionado_w * (qt_variavel_w + qt_fixa_comp_W);
                                                ie_situacao_calculo_comp_w  := cd_taxa_calculo_w;
                                                nr_indice_vetor_w           := v_custo_padrao_comp_w.count + 1;

                                                v_custo_padrao_comp_w[nr_indice_vetor_w].nr_sequencia              := v_c03_w[k].custo_padrao_comp_seq;
                                                v_custo_padrao_comp_w[nr_indice_vetor_w].cd_estabelecimento        := cd_estabelecimento_w;
                                                v_custo_padrao_comp_w[nr_indice_vetor_w].cd_tabela_custo           := cd_tabela_custo_p;
                                                v_custo_padrao_comp_w[nr_indice_vetor_w].nr_ficha_tecnica          := nr_ficha_tecnica_w;
                                                v_custo_padrao_comp_w[nr_indice_vetor_w].nr_seq_componente         := nr_seq_componente_w;
                                                v_custo_padrao_comp_w[nr_indice_vetor_w].cd_tipo_gasto             := v_c03_w[k].ie_tipo_gasto;
                                                v_custo_padrao_comp_w[nr_indice_vetor_w].cd_grupo_natureza_gasto   := v_c03_w[k].cd_grupo_natureza_gasto;
                                                v_custo_padrao_comp_w[nr_indice_vetor_w].nr_seq_gng                := v_c03_w[k].nr_sequencia;
                                                v_custo_padrao_comp_w[nr_indice_vetor_w].nm_usuario                := nm_usuario_p;
                                                v_custo_padrao_comp_w[nr_indice_vetor_w].dt_atualizacao            := dt_atualizacao_w;
                                                v_custo_padrao_comp_w[nr_indice_vetor_w].ie_situacao_calculo       := ie_situacao_calculo_comp_w;
                                                v_custo_padrao_comp_w[nr_indice_vetor_w].vl_custo_unitario         := vl_selecionado_w;
                                                v_custo_padrao_comp_w[nr_indice_vetor_w].vl_custo_componente       := vl_custo_componente_w;
                                                v_custo_padrao_comp_w[nr_indice_vetor_w].nr_seq_tabela             := nr_seq_tabela_p;

                                                if (cd_tipo_gasto_w = 'V') then
                                                       vl_custo_variavel_w := vl_custo_variavel_w + vl_custo_componente_w;
                                                else
                                                       vl_custo_fixo_w     := vl_custo_fixo_w + vl_custo_componente_w;
                                                end if;
                                                if (ie_situacao_calculo_comp_w = 'I') then
                                                       v_custo_padrao_w[i].ie_situacao_calculo := 'I';
                                                end if;

                                                end loop;
                                         end loop;
                                  close c03;
                            end if;
                        end loop;

                        if (coalesce(vl_custo_variavel_w,0) = 0) and (coalesce(vl_custo_fixo_w,0) = 0) then
                               v_custo_padrao_w[i].ie_situacao_calculo := 'I';
                        end if;

                        v_custo_padrao_w[i].vl_custo_variavel := vl_custo_variavel_w;
                        v_custo_padrao_w[i].vl_custo_fixo := vl_custo_fixo_w;

                        if (v_custo_padrao_comp_w.count >= 1000) then

                               if (v_custo_padrao_w.count > 0) then
                                       forall indice in v_custo_padrao_w.first .. v_custo_padrao_w.last
                                       insert into custo_padrao values v_custo_padrao_w(indice);
                                       commit;
                                       v_custo_padrao_w.delete;
                               end if;

                               forall indice in v_custo_padrao_comp_w.first .. v_custo_padrao_comp_w.last
                               insert into custo_padrao_comp values v_custo_padrao_comp_w(indice);
                               commit;
                               v_custo_padrao_comp_w.delete;
                        end if;

                    end loop;
                 close c02;


                 if (v_custo_padrao_w.count > 0) then
                         forall indice in v_custo_padrao_w.first .. v_custo_padrao_w.last
                         insert into custo_padrao values v_custo_padrao_w(indice);
                         commit;
                         v_custo_padrao_w.delete;
                 end if;

                 if (v_custo_padrao_comp_w.count > 0) then
                         forall indice in v_custo_padrao_comp_w.first .. v_custo_padrao_comp_w.last
                         insert into custo_padrao_comp values v_custo_padrao_comp_w(indice);
                         commit;
                         v_custo_padrao_comp_w.delete;
                 end if;

                 end loop;
             end loop;
      close c01;

      insert into custo_material(cd_estabelecimento,
                   cd_tabela_custo,
                   cd_material,
                   nm_usuario,
                   dt_atualizacao,
                   ie_origem_custo,
                   qt_dias_prazo,
                   vl_cotado_compra,
                   vl_cotado_consumo,
                   pr_frete,
                   vl_presente,
                   nr_seq_tabela,
                   nm_usuario_nrec,
                   dt_atualizacao_nrec)
                   SELECT  distinct
                           cd_estabelecimento_p,
                           cd_tabela_custo_mat_w,
                           cd_material,
                           nm_usuario_p,
                           dt_atualizacao_w,
                           'C',
                           null,
                           null,
                           null,
                           null,
                           null,
                           nr_seq_tabela_custo_mat_w,
                           nm_usuario_p,
                           dt_atualizacao_w
                   from    custo_padrao_comp_v m
                   where   m.cd_estabelecimento    = cd_estabelecimento_w
                   and     m.nr_seq_tabela         = nr_seq_tabela_p
                   and     m.ie_situacao_calculo   = 'I'
                   and     (m.cd_material IS NOT NULL AND m.cd_material::text <> '')
                   and     not exists (    SELECT  c.cd_material
                                           from    custo_material c
                                           where   c.nr_seq_tabela     = nr_seq_tabela_custo_mat_w
                                           and     c.cd_material       = m.cd_material);

end loop;
close c00;

commit;
qt_contador_w   := qt_contador_w + 1;
CALL gravar_processo_longo(wheb_mensagem_pck.get_texto(298798),'CALCULAR_CUSTO_PADRAO',qt_contador_w);

commit;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE custos_pck.calcular_custo_padrao ( cd_estabelecimento_p bigint, cd_tabela_custo_p bigint, nr_ficha_inicial_p bigint, nr_ficha_final_p bigint, nr_seq_tabela_p bigint, nm_usuario_p text) FROM PUBLIC;
