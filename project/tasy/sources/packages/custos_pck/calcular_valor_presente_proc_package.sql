-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE custos_pck.calcular_valor_presente_proc ( cd_estabelecimento_p bigint, cd_tabela_custo_p bigint, nr_seq_tabela_p bigint, nm_usuario_p text) AS $body$
DECLARE


dt_atualizacao_w    timestamp            := clock_timestamp();
nr_sequencia_w      bigint;
vl_cotado_w         double precision    := 0;
vl_presente_w       double precision    := 0;
qt_dias_prazo_w     double precision    := 0;
pr_taxa_financ_w    double precision    := 0;

c01 CURSOR FOR
       SELECT  a.nr_sequencia,
               a.vl_cotado,
               coalesce(a.qt_dias_prazo, 1)
       from    custo_procedimento a
       where   a.nr_seq_tabela = nr_seq_tabela_p;


BEGIN

select  coalesce(qt_parametro,0)
into STRICT    pr_taxa_financ_w
from    tabela_parametro
where   nr_seq_tabela       = nr_seq_tabela_p
and     nr_seq_parametro    = 1;

open c01;
loop
fetch c01 into
    nr_sequencia_w,
    vl_cotado_w,
    qt_dias_prazo_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
    begin
    vl_presente_w       := dividir(vl_cotado_w, (1 + pr_taxa_financ_w /100)**(qt_dias_prazo_w/30));
    update  custo_procedimento
    set     vl_presente     = vl_presente_w,
            dt_atualizacao  = dt_atualizacao_w,
            nm_usuario      = nm_usuario_p
    where   nr_sequencia    = nr_sequencia_w;
    end;
end loop;
close c01;
commit;
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE custos_pck.calcular_valor_presente_proc ( cd_estabelecimento_p bigint, cd_tabela_custo_p bigint, nr_seq_tabela_p bigint, nm_usuario_p text) FROM PUBLIC;
