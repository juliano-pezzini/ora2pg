-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE ctb_uuid_pck.atualizar_uuid_documento (nr_seq_nota_fiscal_p nota_fiscal.nr_sequencia%type, nr_nfe_imp_p nota_fiscal.nr_nfe_imp%type, nr_interno_conta_p conta_paciente.nr_interno_conta%type) AS $body$
BEGIN

--Contas a receber(5)
update  ctb_movimento a
set     a.nr_documento = nr_nfe_imp_p
where   a.nr_sequencia in (
                        SELECT  b.nr_seq_ctb_movto
                        from    movimento_contabil_doc b,
                                titulo_receber c
                        where   b.nr_documento = c.nr_titulo
                        and     b.nr_seq_info in (14,53,3,34,55,43,48)
                        and     c.nr_seq_nf_saida = nr_seq_nota_fiscal_p

union all

                        SELECT  b.nr_seq_ctb_movto
                        from    movimento_contabil_doc b,
                                titulo_receber c
                        where   b.nr_seq_doc_compl = c.nr_titulo
                        and     b.nr_seq_info in (45,51,52)
                        and     c.nr_seq_nf_saida = nr_seq_nota_fiscal_p
                        
union all

                        select  b.nr_seq_ctb_movto
                        from    movimento_contabil_doc b,
                                titulo_receber c,
                                titulo_receber_liq d,
                                titulo_rec_liq_cc e
                        where   b.nr_documento = e.nr_sequencia
                        and     b.nr_seq_doc_compl = d.nr_sequencia
                        and     c.nr_titulo = e.nr_titulo
                        and     c.nr_titulo = d.nr_titulo
                        and     d.nr_sequencia = e.nr_seq_baixa
                        and     b.nr_seq_info in (49,50)
                        and     c.nr_seq_nf_saida = nr_seq_nota_fiscal_p
                        );

--Contas a pagar(7)
update  ctb_movimento a
set     a.nr_documento = nr_nfe_imp_p
where   a.nr_sequencia in (
                        SELECT  b.nr_seq_ctb_movto
                        from    movimento_contabil_doc b,
                                titulo_pagar c
                        where   b.nr_documento = c.nr_titulo
                        and     b.nr_seq_info in (2,15,16)
                        and     c.nr_seq_nota_fiscal = nr_seq_nota_fiscal_p

union all

                        SELECT  b.nr_seq_ctb_movto
                        from    movimento_contabil_doc b,
                                titulo_pagar c
                        where   b.nr_documento = c.nr_titulo
                        and     b.nr_seq_info = 13
                        and     b.nm_tabela in ('TITULO_PAGAR_BAIXA_CONTAB_V',
                                                'TITULO_PAGAR_BAIXA_CC_CONTAB_V',
                                                'TITULO_PAGAR_BAIXA',
                                                'TITULO_PAGAR',
                                                'TITULO_PAGAR_BAIXA')
                        and     c.nr_seq_nota_fiscal = nr_seq_nota_fiscal_p
                        
union all

                        select  b.nr_seq_ctb_movto
                        from    movimento_contabil_doc b,
                                titulo_pagar c,
                                titulo_pagar_baixa_cc e
                        where   b.nr_documento = e.nr_sequencia
                        and     e.nr_titulo = c.nr_titulo
                        and     b.nr_seq_info = 13
                        and     b.nm_tabela = 'TITULO_PAGAR_BAIXA_CC'
                        and     c.nr_seq_nota_fiscal = nr_seq_nota_fiscal_p
                        );

--Receitas(6)
if (nr_interno_conta_p IS NOT NULL AND nr_interno_conta_p::text <> '') then
    update  ctb_movimento a
    set     a.nr_documento = nr_nfe_imp_p
    where   a.nr_sequencia in (
                            SELECT  b.nr_seq_ctb_movto
                            from    movimento_contabil_doc b
                            where   b.nr_seq_doc_compl = nr_interno_conta_p
                            and     b.nr_seq_info = 7

union all

                            SELECT  b.nr_seq_ctb_movto
                            from    movimento_contabil_doc b
                            where   b.nr_seq_doc_compl = nr_interno_conta_p
                            and     b.nr_seq_info = 6
                            );


    update  ctb_movimento a
    set     a.nr_documento = nr_nfe_imp_p
    where   a.nr_sequencia in (
                            SELECT  b.nr_seq_ctb_movto
                            from    movimento_contabil_doc b,
                                    nota_fiscal_trib c
                            where   b.nr_documento = nr_seq_nota_fiscal_p
                            and     b.nr_seq_info = 1
                            );
end if;

--Notas fiscais(2)
update  ctb_movimento a
set     a.nr_documento = nr_nfe_imp_p
where   a.nr_seq_agrupamento = nr_seq_nota_fiscal_p
and     exists (
                SELECT  1
                from    lote_contabil x
                where   x.nr_lote_contabil = a.nr_lote_contabil
                and     x.cd_tipo_lote_contabil = 2);
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ctb_uuid_pck.atualizar_uuid_documento (nr_seq_nota_fiscal_p nota_fiscal.nr_sequencia%type, nr_nfe_imp_p nota_fiscal.nr_nfe_imp%type, nr_interno_conta_p conta_paciente.nr_interno_conta%type) FROM PUBLIC;
