-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE gerar_esocial_dados_pck.gerar_esocial_dados_depend (nr_seq_lote_p bigint, ie_tipo_operacao_p text, cd_pessoa_fisica_p text, nm_usuario_p text) AS $body$
DECLARE


                nr_seq_dependente_w                     pessoa_fisica_dependente.nr_sequencia%type;
                nm_dependente_w                         pessoa_fisica_dependente.nm_dependente%type;
                ie_grau_parentesco_w                    pessoa_fisica_dependente.ie_grau_parentesco%type;
                ie_grau_instrucao_w                     pessoa_fisica_dependente.ie_grau_instrucao%type;
		cd_dependente_w                     	pessoa_fisica_dependente.cd_pessoa_dependente%type;
                current_setting('gerar_esocial_dados_pck.ie_sexo_w')::esocial_dados_prestador.ie_sexo%type                               pessoa_fisica.ie_sexo%type;
		nm_mae_w				esocial_dados_dependente.nm_mae%type;

		c_dependentes CURSOR FOR
			SELECT  coalesce(a.nm_dependente, substr(obter_nome_pf(a.cd_pessoa_dependente),1,255)) nm_dependente, --?
				coalesce(a.dt_nascimento, b.dt_nascimento) dt_nascimento,
				a.ie_grau_parentesco ie_grau_parentesco,
				coalesce(a.ie_grau_instrucao, b.ie_grau_instrucao) ie_grau_instrucao,
				a.cd_pessoa_dependente cd_dependente,
				b.ie_sexo ie_sexo,
				coalesce(a.nr_cpf, b.nr_cpf) nr_cpf,
				b.ie_estado_civil ie_estado_civil,
				(SELECT         d.nm_pessoa_fisica
				from            pessoa_fisica d
				where 		b.cd_pessoa_mae 	= d.cd_pessoa_fisica) nm_mae
			FROM pessoa_fisica_dependente a
LEFT OUTER JOIN pessoa_fisica b ON (a.cd_pessoa_dependente = b.cd_pessoa_fisica)
WHERE a.cd_pessoa_fisica 	= cd_pessoa_fisica_p;
			

BEGIN
		nr_seq_dependente_w := 0;
                open c_dependentes;
                loop
                fetch c_dependentes into
                        nm_dependente_w,
                        current_setting('gerar_esocial_dados_pck.dt_nascimento_w')::pessoa_fisica.dt_nascimento%type,
                        ie_grau_parentesco_w,
                        ie_grau_instrucao_w,
			cd_dependente_w,
                        current_setting('gerar_esocial_dados_pck.ie_sexo_w')::esocial_dados_prestador.ie_sexo%type,
                        current_setting('gerar_esocial_dados_pck.nr_cpf_w')::pessoa_fisica.nr_cpf%type,
                        current_setting('gerar_esocial_dados_pck.ie_estado_civil_w')::pessoa_fisica.ie_estado_civil%type,
			nm_mae_w;
                EXIT WHEN NOT FOUND; /* apply on c_dependentes */
		if (coalesce(current_setting('gerar_esocial_dados_pck.nr_seq_regra_w')::esocial_regra.nr_sequencia%type,0) <> 0) then
			nr_seq_dependente_w := nr_seq_dependente_w + 1;
			
			insert into esocial_dados_dependente(
					nr_sequencia,
					dt_atualizacao,
					nm_usuario,
					dt_atualizacao_nrec,
					nm_usuario_nrec,
					nr_seq_esocial_lote,
					ie_tipo_operacao,
					cd_empresa,
					ie_tipo_colab,
					cd_cadastro_colab,
					cd_dependente,
					nr_seq_dependente,
					nm_dependente,
					dt_nascimento, 
					nm_mae,
					ie_grau_parentesco,
					ie_tipo_dependente,
					ie_sexo,
					nr_cpf,
					ie_estado_civil,
					ie_grau_instrucao,
					ie_aviso_vacina
					)
				values (
					nextval('esocial_dados_dependente_seq'),
					clock_timestamp(),
					nm_usuario_p,
					clock_timestamp(),
					nm_usuario_p,
					nr_seq_lote_p,
					'I', --ie_tipo_operacao_p
					current_setting('gerar_esocial_dados_pck.cd_empresa_w')::esocial_lote.cd_empresa%type,
					2,
					CASE WHEN ie_tipo_operacao_p='I' THEN 0  ELSE current_setting('gerar_esocial_dados_pck.cd_externo_esocial_w')::pls_prestador.cd_externo_esocial%type END ,
					cd_dependente_w,
					nr_seq_dependente_w,
					nm_dependente_w,
					current_setting('gerar_esocial_dados_pck.dt_nascimento_w')::pessoa_fisica.dt_nascimento%type,
					nm_mae_w,
					ie_grau_parentesco_w,
					ie_grau_parentesco_w,
					current_setting('gerar_esocial_dados_pck.ie_sexo_w')::esocial_dados_prestador.ie_sexo%type,
					current_setting('gerar_esocial_dados_pck.nr_cpf_w')::pessoa_fisica.nr_cpf%type,
					current_setting('gerar_esocial_dados_pck.ie_estado_civil_w')::pessoa_fisica.ie_estado_civil%type,
					ie_grau_instrucao_w,
					current_setting('gerar_esocial_dados_pck.ie_aviso_vacina_w')::esocial_dados_dependente.ie_aviso_vacina%type
					);
					commit;
		end if;
	end loop;

	
	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_esocial_dados_pck.gerar_esocial_dados_depend (nr_seq_lote_p bigint, ie_tipo_operacao_p text, cd_pessoa_fisica_p text, nm_usuario_p text) FROM PUBLIC;
