-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE gerar_esocial_dados_pck.carregar_esocial_conv_ext_pres ( nr_seq_prestador_p bigint) AS $body$
DECLARE


	c01 CURSOR FOR
		SELECT	nm_atributo,
			cd_externo
		from	conversao_meio_externo
		where	upper(ie_sistema_externo) = 'ESOCIAL'
		and 	upper(nm_tabela) = 'ESOCIAL_DADOS_PRESTADOR';

	c01_w		c01%rowtype;

	
BEGIN

	open c01;
	loop
	fetch c01 into
		c01_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin

		if (c01_w.nm_atributo = 'CD_CARGO') then
			PERFORM set_config('gerar_esocial_dados_pck.cd_cargo_w', c01_w.cd_externo, false);
		elsif (c01_w.nm_atributo = 'CD_ESCALA') then
			PERFORM set_config('gerar_esocial_dados_pck.cd_escala_w', c01_w.cd_externo, false);
		elsif (c01_w.nm_atributo = 'CD_FILIAL_COLAB') then
			PERFORM set_config('gerar_esocial_dados_pck.cd_filial_colab_w', c01_w.cd_externo, false);
		elsif (c01_w.nm_atributo = 'CD_LOCAL') then
			PERFORM set_config('gerar_esocial_dados_pck.cd_local_w', c01_w.cd_externo, false);
		elsif (c01_w.nm_atributo = 'CD_ALT_CARGO') then
			PERFORM set_config('gerar_esocial_dados_pck.cd_alt_cargo_w', c01_w.cd_externo, false);
		elsif (c01_w.nm_atributo = 'CD_TURMA_ESCALA') then
			PERFORM set_config('gerar_esocial_dados_pck.cd_turma_escala_w', c01_w.cd_externo, false);
		elsif (c01_w.nm_atributo = 'CD_CONTA_FINANCEIRA') then
			PERFORM set_config('gerar_esocial_dados_pck.cd_conta_financeira_w', c01_w.cd_externo, false);
		elsif (c01_w.nm_atributo = 'CD_SINDICATO') then
			PERFORM set_config('gerar_esocial_dados_pck.cd_sindicato_w', c01_w.cd_externo, false);
		elsif (c01_w.nm_atributo = 'CD_HORA_BASE_COLAB') then
			PERFORM set_config('gerar_esocial_dados_pck.cd_hora_base_colab_w', c01_w.cd_externo, false);
		elsif (c01_w.nm_atributo = 'CD_HORA_SABADO') then
			PERFORM set_config('gerar_esocial_dados_pck.cd_hora_sabado_w', c01_w.cd_externo, false);
		elsif (c01_w.nm_atributo = 'NR_HORAS_SEMANAL') then
			PERFORM set_config('gerar_esocial_dados_pck.nr_horas_semanal_w', c01_w.cd_externo, false);
		elsif (c01_w.nm_atributo = 'NR_HORAS_DSR') then
			PERFORM set_config('gerar_esocial_dados_pck.nr_horas_dsr_w', c01_w.cd_externo, false);
		elsif (c01_w.nm_atributo = 'CD_CENTRO_CUSTO') then
			PERFORM set_config('gerar_esocial_dados_pck.cd_centro_custo_w', c01_w.cd_externo, false);
		elsif (c01_w.nm_atributo = 'CD_VINCULO_COLAB') then
			PERFORM set_config('gerar_esocial_dados_pck.cd_vinculo_colab_w', c01_w.cd_externo, false);
		elsif (c01_w.nm_atributo = 'IE_CATEGORIA_CONTRIBUINTE') then
			PERFORM set_config('gerar_esocial_dados_pck.ie_categoria_contribuinte_w', c01_w.cd_externo, false);
		end if;

		end;
	end loop;
	close c01;

	PERFORM set_config('gerar_esocial_dados_pck.cd_banco_w', null, false);
	PERFORM set_config('gerar_esocial_dados_pck.cd_agencia_bancaria_w', null, false);
	PERFORM set_config('gerar_esocial_dados_pck.ie_sexo_w', null, false);
	PERFORM set_config('gerar_esocial_dados_pck.cd_grau_instrucao_w', null, false);


	begin

	select	max(b.cd_banco),
		max(b.cd_agencia_bancaria),
		max(c.ie_sexo),
		CASE WHEN max(c.ie_grau_instrucao)=1 THEN  1 WHEN max(c.ie_grau_instrucao)=11 THEN  1 WHEN max(c.ie_grau_instrucao)=2 THEN  5 WHEN max(c.ie_grau_instrucao)=3 THEN  7 WHEN max(c.ie_grau_instrucao)=4 THEN  9 WHEN max(c.ie_grau_instrucao)=5 THEN  11 WHEN max(c.ie_grau_instrucao)=6 THEN  12 WHEN max(c.ie_grau_instrucao)=8 THEN  6 WHEN max(c.ie_grau_instrucao)=9 THEN  8 WHEN max(c.ie_grau_instrucao)=10 THEN  3 WHEN max(c.ie_grau_instrucao)=12 THEN  10 WHEN max(c.ie_grau_instrucao)=13 THEN  13 WHEN max(c.ie_grau_instrucao)=15 THEN  7 END
	into STRICT	current_setting('gerar_esocial_dados_pck.cd_banco_w')::esocial_dados_prestador.cd_banco%type,
		current_setting('gerar_esocial_dados_pck.cd_agencia_bancaria_w')::esocial_dados_prestador.cd_agencia_bancaria%type,
		current_setting('gerar_esocial_dados_pck.ie_sexo_w')::esocial_dados_prestador.ie_sexo%type,
		current_setting('gerar_esocial_dados_pck.cd_grau_instrucao_w')::esocial_dados_prestador.cd_grau_instrucao%type
	from	pls_prestador a,
		pls_prestador_pagto b,
		pessoa_fisica c
	where	a.nr_sequencia 		= b.nr_seq_prestador
	and 	a.cd_pessoa_fisica 	= c.cd_pessoa_fisica
	and 	a.nr_Sequencia 		= nr_seq_prestador_p
	and	clock_timestamp()	between b.dt_inicio_vigencia and coalesce(b.dt_fim_vigencia, clock_timestamp());

	exception
	when others then
		PERFORM set_config('gerar_esocial_dados_pck.cd_banco_w', null, false);
		PERFORM set_config('gerar_esocial_dados_pck.cd_agencia_bancaria_w', null, false);
	end;

	begin

	select	max(c.ie_sexo),
		CASE WHEN max(c.ie_grau_instrucao)=1 THEN  1 WHEN max(c.ie_grau_instrucao)=11 THEN  1 WHEN max(c.ie_grau_instrucao)=2 THEN  5 WHEN max(c.ie_grau_instrucao)=3 THEN  7 WHEN max(c.ie_grau_instrucao)=4 THEN  9 WHEN max(c.ie_grau_instrucao)=5 THEN  11 WHEN max(c.ie_grau_instrucao)=6 THEN  12 WHEN max(c.ie_grau_instrucao)=8 THEN  6 WHEN max(c.ie_grau_instrucao)=9 THEN  8 WHEN max(c.ie_grau_instrucao)=10 THEN  3 WHEN max(c.ie_grau_instrucao)=12 THEN  10 WHEN max(c.ie_grau_instrucao)=13 THEN  13 WHEN max(c.ie_grau_instrucao)=15 THEN  7 END
	into STRICT	current_setting('gerar_esocial_dados_pck.ie_sexo_w')::esocial_dados_prestador.ie_sexo%type,
		current_setting('gerar_esocial_dados_pck.cd_grau_instrucao_w')::esocial_dados_prestador.cd_grau_instrucao%type
	from	pls_prestador a,
		pessoa_fisica c
	where	a.cd_pessoa_fisica 	= c.cd_pessoa_fisica
	and 	a.nr_Sequencia 		= nr_seq_prestador_p;

	exception
	when others then
		PERFORM set_config('gerar_esocial_dados_pck.ie_sexo_w', null, false);
		PERFORM set_config('gerar_esocial_dados_pck.cd_grau_instrucao_w', null, false);
	end;


	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_esocial_dados_pck.carregar_esocial_conv_ext_pres ( nr_seq_prestador_p bigint) FROM PUBLIC;
