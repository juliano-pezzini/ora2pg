-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE gerar_esocial_dados_pck.gerar_esocial_dados_retenc ( nr_seq_lote_p bigint, nr_seq_prestador_p bigint, ie_tipo_operacao_p text, cd_pessoa_fisica_p text, nm_usuario_p text) AS $body$
DECLARE


		cd_cgc_w					pessoa_fisica_trib.ds_emp_retencao%type;
		dt_inicio_vigencia_w				pessoa_fisica_trib.dt_inicio_vigencia%type;
		vl_base_trib_inss_w				pessoa_fisica_trib.vl_base_calculo%type;
		vl_trib_inss_w					pessoa_fisica_trib.vl_tributo%type;
		nr_seq_base_calculo_w				pessoa_fisica_trib.nr_sequencia%type;
		ie_empreendedor_individual_w			pessoa_juridica.ie_empreendedor_individual%type;
	
		c_retencao CURSOR FOR
		SELECT 	a.ds_emp_retencao		cd_cgc,
			a.dt_inicio_vigencia 		dt_inicio_vigencia,
			a.vl_base_calculo		vl_base_calculo,
			a.vl_tributo			vl_tributo
		from	pessoa_fisica_trib 		a,
			pessoa_fisica 			b
		where	a.cd_pessoa_fisica 		= b.cd_pessoa_fisica
		and	a.cd_pessoa_fisica 		= cd_pessoa_fisica_p;

	
BEGIN
		nr_seq_base_calculo_w := 0;
		open c_retencao;
		loop
			fetch c_retencao into
				cd_cgc_w,
				dt_inicio_vigencia_w,
				vl_base_trib_inss_w,
				vl_trib_inss_w;
			EXIT WHEN NOT FOUND; /* apply on c_retencao */

			cd_cgc_w := somente_numero(substr(cd_cgc_w, 1, 14));
			if (length(cd_cgc_w) <> 14) then
				cd_cgc_w := null;
			end if;

			select 	max(a.ie_empreendedor_individual)
			into STRICT 	ie_empreendedor_individual_w
			from	pessoa_juridica a
			where	a.cd_cgc 	= cd_cgc_w;
			if (coalesce(current_setting('gerar_esocial_dados_pck.nr_seq_regra_w')::esocial_regra.nr_sequencia%type,0) <> 0) then
				nr_seq_base_calculo_w := nr_seq_base_calculo_w + 1;
				insert into esocial_dados_retencao(
				nr_sequencia,
				cd_cadastro_colab,
				cd_cgc,
				cd_colab_esocial,
				cd_empresa,
				dt_atualizacao,
				dt_atualizacao_nrec,
				dt_competencia,
				ie_empreendedor_individual,
				ie_tipo_colaborador, -- Feito conforme esta no prestador
				ie_tipo_inscricao,
				nm_usuario,
				nm_usuario_nrec,
				nr_seq_base_calculo,
				nr_seq_esocial_lote,
				nr_seq_prestador,
				vl_base_trib_inss,
				vl_base_trib_inss_13,
				vl_trib_inss,
				vl_trib_inss_13
				) values (
				nextval('esocial_dados_retencao_seq'),
				CASE WHEN ie_tipo_operacao_p='I' THEN 0  ELSE current_setting('gerar_esocial_dados_pck.cd_externo_esocial_w')::pls_prestador.cd_externo_esocial%type END ,
				cd_cgc_w,
				current_setting('gerar_esocial_dados_pck.cd_categoria_colab_w')::esocial_regra.cd_categoria_colab%type,
				current_setting('gerar_esocial_dados_pck.cd_empresa_w')::esocial_lote.cd_empresa%type,
				clock_timestamp(),
				clock_timestamp(),
				dt_inicio_vigencia_w,
				ie_empreendedor_individual_w,
				coalesce(current_setting('gerar_esocial_dados_pck.cd_vinculo_colab_w')::esocial_dados_prestador.cd_vinculo_colab%type, 0),	--Feito conforme esta no prestador
				1,
				nm_usuario_p,
				nm_usuario_p,
				nr_seq_base_calculo_w,
				nr_seq_lote_p,
				nr_seq_prestador_p,
				vl_base_trib_inss_w,
				0,
				vl_trib_inss_w,
				0
				);
			end if;
		end loop;
	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_esocial_dados_pck.gerar_esocial_dados_retenc ( nr_seq_lote_p bigint, nr_seq_prestador_p bigint, ie_tipo_operacao_p text, cd_pessoa_fisica_p text, nm_usuario_p text) FROM PUBLIC;
