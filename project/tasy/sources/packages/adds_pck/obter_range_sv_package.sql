-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION adds_pck.obter_range_sv ( nr_seq_adds_sv_p bigint, nr_atendimento_p bigint default null) RETURNS SETOF T_RANGE_ROW_DATA AS $body$
DECLARE


C01 CURSOR FOR
	SELECT	nr_sequencia,
		nm_range,
		vl_minimo,
		vl_maximo,
		ie_score,
		ie_valor,
		nr_seq_apres,
		ds_cor
	from	adds_sv_item
	where	nr_seq_adds_sv	= nr_seq_adds_sv_p
	and 	coalesce(nr_atendimento::text, '') = ''
	and 	not exists (SELECT 1 from adds_sv_item x where x.nr_seq_adds_sv = nr_seq_adds_sv_p and x.nr_atendimento = nr_atendimento_p)
	
union all

	select	nr_sequencia,
		nm_range,
		vl_minimo,
		vl_maximo,
		ie_score,
		ie_valor,
		nr_seq_apres,
		ds_cor
	from	adds_sv_item
	where	nr_seq_adds_sv	= nr_seq_adds_sv_p
	and 	nr_atendimento 	= nr_atendimento_p
	order by nr_seq_apres desc;

t_range_row_w			t_range_row;
BEGIN

for r_c01 in c01 loop
	begin
	t_range_row_w.nr_seq_adds_sv_item	:= r_c01.nr_sequencia;
	t_range_row_w.ds_range			:= r_c01.nm_range;
	t_range_row_w.qt_min			:= r_c01.vl_minimo;
	t_range_row_w.qt_max			:= r_c01.vl_maximo;
	t_range_row_w.ie_score			:= r_c01.ie_score;
	t_range_row_w.ie_valor			:= r_c01.ie_valor;

	if (r_c01.ie_valor IS NOT NULL AND r_c01.ie_valor::text <> '') and (coalesce(r_c01.vl_minimo::text, '') = '' and coalesce(r_c01.vl_maximo::text, '') = '') then
		t_range_row_w.qt_min		:= r_c01.ie_valor;
		t_range_row_w.qt_max		:= r_c01.ie_valor;
	end if;

	t_range_row_w.ds_color			:= coalesce(r_c01.ds_cor, adds_pck.obter_color_score( r_c01.ie_score ));
	RETURN NEXT t_range_row_w;

	end;
end loop;

return;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION adds_pck.obter_range_sv ( nr_seq_adds_sv_p bigint, nr_atendimento_p bigint default null) FROM PUBLIC;
