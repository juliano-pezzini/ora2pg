-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION adds_pck.obter_sinal_vital ( nr_atendimento_p bigint, dt_inicio_p timestamp, dt_fim_p timestamp, nr_seq_sinal_vital_p bigint, nr_seq_adds_sv_p bigint default null, ie_trunc_date_p text default 'S') RETURNS SETOF T_SV_ROW_DATA AS $body$
DECLARE


t_sv_row_w			t_sv_row;
dt_inicio_w			timestamp	:= trunc(dt_inicio_p);
dt_fim_w			timestamp	:= fim_dia(dt_fim_p);
nr_age_years_w bigint := 0;


C01 CURSOR FOR
	SELECT	a.dt_sinal_vital,
		a.qt_temp,
		a.qt_escala_dor,
		a.qt_freq_resp,
		a.qt_pa_diastolica,
		a.qt_pa_sistolica,
		a.qt_pam,
		null ie_padrao_resp,
		a.qt_saturacao_o2,
		a.qt_o2_suplementar,
		a.ie_nivel_consciencia,
		a.ie_nivel_consciencia_ped,
		a.qt_enchimento_capilar ,
		coalesce(a.qt_freq_cardiaca,a.qt_spo2r) qt_freq_cardiaca,
		a.nr_sequencia,
		null qt_fluxo_oxigenio,
    a.nr_distress,
    null QT_PA_SIST_AP,
    null QT_PA_DIAST_AP,
    null QT_PA_MEDIA_AP
	from	atendimento_sinal_vital a
	where	a.nr_atendimento = nr_atendimento_p
	and	a.dt_sinal_vital between dt_inicio_w and dt_fim_w
	and	(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
	and	coalesce(a.dt_inativacao::text, '') = ''
	
union

  	SELECT	a.dt_monitorizacao dt_sinal_vital,
		null,
		null,
		null,
		null,
		null,
		null,
		a.ie_padrao_resp,
		null,
		null,
		null,
    null,
		null,
		null,
		a.nr_sequencia,
		a.qt_fluxo_oxigenio,
    null,
    null QT_PA_SIST_AP,
    null QT_PA_DIAST_AP,
    null QT_PA_MEDIA_AP
	from	atendimento_monit_resp a
	where	a.nr_atendimento = nr_atendimento_p
	and	a.dt_monitorizacao between  dt_inicio_w and dt_fim_w
	and	(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
	and	coalesce(a.dt_inativacao::text, '') = ''

  
union

  
   select	a.DT_MONITORACAO dt_sinal_vital,
		null,
		null,
		null,
		null,
		null,
		null,
		null,
		null,
		null,
		null,
    null,
		null,
		null,
		a.nr_sequencia,
		null,
    null,
    a.QT_PA_SIST_AP,
    a.QT_PA_DIAST_AP,
    a.QT_PA_MEDIA_AP
	from	ATEND_MONIT_HEMOD a
	where	a.nr_atendimento = nr_atendimento_p
	and	a.DT_MONITORACAO between  dt_inicio_w and dt_fim_w
	and	(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
	and	coalesce(a.dt_inativacao::text, '') = '';

BEGIN

if (ie_trunc_date_p	= 'N') then
	dt_inicio_w	:= dt_inicio_p;
	dt_fim_w	:= dt_fim_p;
end if;

select obter_idade(dt_nascimento,clock_timestamp(),'A') into STRICT nr_age_years_w
from pessoa_fisica
where cd_pessoa_fisica = obter_pessoa_atendimento(nr_atendimento_p,'C');

for r_c01 in c01 loop
	begin

	t_sv_row_w.dt_sinal_vital		:= r_c01.dt_sinal_vital;
	t_sv_row_w.nr_sequencia			:= r_c01.nr_sequencia;
	t_sv_row_w.qt_valor			:= null;
	t_sv_row_w.qt_y_min			:= null;
	t_sv_row_w.qt_y_max			:= null;
	t_sv_row_w.nr_seq_sinal_vital 		:= nr_seq_sinal_vital_p;

	if (nr_seq_sinal_vital_p	= 17) and (r_c01.qt_temp IS NOT NULL AND r_c01.qt_temp::text <> '') then --Temperature
		t_sv_row_w.qt_valor		:= r_c01.qt_temp;
	elsif (nr_seq_sinal_vital_p	= 16) and (r_c01.qt_freq_resp IS NOT NULL AND r_c01.qt_freq_resp::text <> '') then --Respiratory rate
		t_sv_row_w.qt_valor		:= r_c01.qt_freq_resp;
	elsif (nr_seq_sinal_vital_p	= 44) and (r_c01.qt_escala_dor IS NOT NULL AND r_c01.qt_escala_dor::text <> '') then --Pain Scale
		t_sv_row_w.qt_valor		:= r_c01.qt_escala_dor;
	elsif (nr_seq_sinal_vital_p	= 15) and (r_c01.qt_freq_cardiaca IS NOT NULL AND r_c01.qt_freq_cardiaca::text <> '') then --Heart rate
		t_sv_row_w.qt_valor		:= r_c01.qt_freq_cardiaca;
	elsif (nr_seq_sinal_vital_p	= 363) and (r_c01.qt_pa_diastolica IS NOT NULL AND r_c01.qt_pa_diastolica::text <> '') and (r_c01.qt_pa_sistolica IS NOT NULL AND r_c01.qt_pa_sistolica::text <> '')	then --Max/min blood pressure (mmHg)
		t_sv_row_w.qt_valor		:= r_c01.qt_pa_sistolica;
		t_sv_row_w.qt_y_min		:= r_c01.qt_pa_diastolica;
		t_sv_row_w.qt_y_max		:= r_c01.qt_pa_sistolica;
		t_sv_row_w.ds_hint		:= r_c01.qt_pa_sistolica ||' / '||r_c01.qt_pa_diastolica || ' (mmHg)';
	elsif (nr_seq_sinal_vital_p = 217) and (r_c01.qt_o2_suplementar IS NOT NULL AND r_c01.qt_o2_suplementar::text <> '') then -- O2 supply
		t_sv_row_w.qt_valor		:= r_c01.qt_o2_suplementar;
	elsif (nr_seq_sinal_vital_p = 54) and (r_c01.qt_saturacao_o2 IS NOT NULL AND r_c01.qt_saturacao_o2::text <> '') then -- O2 saturation
		t_sv_row_w.qt_valor		:= r_c01.qt_saturacao_o2;
	elsif (nr_seq_sinal_vital_p = 357) and (r_c01.qt_enchimento_capilar IS NOT NULL AND r_c01.qt_enchimento_capilar::text <> '') then -- Capillary Refill
		t_sv_row_w.qt_valor		:= r_c01.qt_enchimento_capilar;
	elsif (nr_seq_sinal_vital_p = 232) and ((r_c01.ie_nivel_consciencia IS NOT NULL AND r_c01.ie_nivel_consciencia::text <> '') or (r_c01.ie_nivel_consciencia_ped IS NOT NULL AND r_c01.ie_nivel_consciencia_ped::text <> '')) then -- Conciousness level
    if (nr_age_years_w > 18) then
    	  	t_sv_row_w.qt_valor		:= r_c01.ie_nivel_consciencia;
          t_sv_row_w.ds_hint		:= substr(obter_valor_dominio(3342,r_c01.ie_nivel_consciencia),1,255);
    else
    		 t_sv_row_w.qt_valor		:= r_c01.ie_nivel_consciencia_ped;
          t_sv_row_w.ds_hint		:= substr(obter_valor_dominio(8921,r_c01.ie_nivel_consciencia_ped),1,255);
    end if;
	elsif (nr_seq_sinal_vital_p = 367) and (r_c01.ie_padrao_resp IS NOT NULL AND r_c01.ie_padrao_resp::text <> '') then -- Respiratory effort
		t_sv_row_w.qt_valor		:= r_c01.ie_padrao_resp;
		t_sv_row_w.ds_hint		:= substr(obter_valor_dominio(2434,r_c01.ie_padrao_resp),1,255);
 	elsif (nr_seq_sinal_vital_p = 393) and (r_c01.nr_distress IS NOT NULL AND r_c01.nr_distress::text <> '') then -- Respiratory distress
		t_sv_row_w.qt_valor		:= r_c01.nr_distress;
		t_sv_row_w.ds_hint		:= substr(obter_valor_dominio(9523,r_c01.nr_distress),1,255);
	elsif (nr_seq_sinal_vital_p = 96) and (r_c01.qt_fluxo_oxigenio IS NOT NULL AND r_c01.qt_fluxo_oxigenio::text <> '') then -- O2 flow
		t_sv_row_w.qt_valor		:= r_c01.qt_fluxo_oxigenio;
	elsif (nr_seq_sinal_vital_p = 14) and (r_c01.qt_pa_sistolica IS NOT NULL AND r_c01.qt_pa_sistolica::text <> '') then -- Systolic BP
		t_sv_row_w.qt_valor		:= r_c01.qt_pa_sistolica;
		t_sv_row_w.ds_hint		:= r_c01.qt_pa_sistolica ||' / '||r_c01.qt_pa_diastolica || ' (mmHg)';
		t_sv_row_w.qt_y_min		:= r_c01.qt_pa_diastolica;
		t_sv_row_w.qt_y_max		:= r_c01.qt_pa_sistolica;
	elsif (nr_seq_sinal_vital_p = 23) and (r_c01.qt_pa_diastolica IS NOT NULL AND r_c01.qt_pa_diastolica::text <> '') then -- Diastolic BP
		t_sv_row_w.qt_valor		:= r_c01.qt_pa_diastolica;
		t_sv_row_w.ds_hint		:= r_c01.qt_pa_sistolica ||' / '||r_c01.qt_pa_diastolica || ' (mmHg)';
		t_sv_row_w.qt_y_min		:= r_c01.qt_pa_diastolica;
		t_sv_row_w.qt_y_max		:= r_c01.qt_pa_sistolica;
  elsif (nr_seq_sinal_vital_p = 395) and (r_c01.QT_PA_SIST_AP IS NOT NULL AND r_c01.QT_PA_SIST_AP::text <> '') then -- Systolic Pulomnary  BP
		t_sv_row_w.qt_valor		:= r_c01.QT_PA_SIST_AP;
		t_sv_row_w.ds_hint		:= r_c01.QT_PA_SIST_AP ||' / '||r_c01.QT_PA_DIAST_AP || ' (mmHg)';
		t_sv_row_w.qt_y_min		:= r_c01.QT_PA_DIAST_AP;
		t_sv_row_w.qt_y_max		:= r_c01.QT_PA_SIST_AP;
	elsif (nr_seq_sinal_vital_p = 60) and (r_c01.QT_PA_DIAST_AP IS NOT NULL AND r_c01.QT_PA_DIAST_AP::text <> '') then -- Diastolic Pulomnary  BP
		t_sv_row_w.qt_valor		:= r_c01.QT_PA_DIAST_AP;
		t_sv_row_w.ds_hint		:= r_c01.QT_PA_SIST_AP ||' / '||r_c01.QT_PA_DIAST_AP || ' (mmHg)';
		t_sv_row_w.qt_y_min		:= r_c01.QT_PA_DIAST_AP;
		t_sv_row_w.qt_y_max		:= r_c01.QT_PA_SIST_AP;
  elsif (nr_seq_sinal_vital_p	= 396) and (r_c01.QT_PA_SIST_AP IS NOT NULL AND r_c01.QT_PA_SIST_AP::text <> '') and (r_c01.QT_PA_DIAST_AP IS NOT NULL AND r_c01.QT_PA_DIAST_AP::text <> '')	then -- Pulomnary  blood pressure
		t_sv_row_w.qt_valor		:= r_c01.QT_PA_SIST_AP;
		t_sv_row_w.qt_y_min		:= r_c01.QT_PA_DIAST_AP;
		t_sv_row_w.qt_y_max		:= r_c01.QT_PA_SIST_AP;
		t_sv_row_w.ds_hint		:= r_c01.QT_PA_SIST_AP ||' / '||r_c01.QT_PA_DIAST_AP || ' (mmHg)';

	end if;

	if (t_sv_row_w.qt_valor IS NOT NULL AND t_sv_row_w.qt_valor::text <> '') or (t_sv_row_w.qt_y_min IS NOT NULL AND t_sv_row_w.qt_y_min::text <> '' AND t_sv_row_w.qt_y_max IS NOT NULL AND t_sv_row_w.qt_y_max::text <> '') then

		if (nr_seq_adds_sv_p IS NOT NULL AND nr_seq_adds_sv_p::text <> '') then
			t_sv_row_w.ie_score_adds	:= adds_pck.obter_score_sv(	t_sv_row_w.qt_valor,
										t_sv_row_w.qt_valor,
										nr_seq_adds_sv_p,
										nr_atendimento_p);
		end if;
		RETURN NEXT t_sv_row_w;
	end if;

	end;
end loop;

return;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION adds_pck.obter_sinal_vital ( nr_atendimento_p bigint, dt_inicio_p timestamp, dt_fim_p timestamp, nr_seq_sinal_vital_p bigint, nr_seq_adds_sv_p bigint default null, ie_trunc_date_p text default 'S') FROM PUBLIC;
