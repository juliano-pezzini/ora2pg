-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

 --log_regra_bloq_agenda_pess;
  
  -- Informacoes Usuario
  
  -- Informacoes do Paciente
  
  -- Consulta Calendario
  
  -- Vetores Performance
  
  -- parametros
  
  -- parametros_agenda
  

  /*-------------------------------------------------------------------
  -- Objeto: define_preco_procedimento_vet
  -- Modulo: Agenda Integrada
  -- Objetivo: Gerar vetor de preco dos procedimentos
  --
  -- Execucao:
  -- Analista:
  -- Desenvolvimento: Maxwell da Silva Oliveira
  -- Historico de Modificacoes
  -- Pessoa      Data       Comentarios
  -- ---------   ------     -------------------------------------------*/
  PROCEDURE define_preco_procedimento_vet(cd_estabelecimento_p      NUMBER,
                                          cd_convenio_p             NUMBER,
                                          cd_categoria_p            VARCHAR2,
                                          dt_conta_p                DATE,
                                          cd_procedimento_p         NUMBER,
                                          cd_tipo_acomodacao_p      NUMBER,
                                          ie_tipo_atendimento_p     NUMBER,
                                          cd_setor_atendimento_p    NUMBER,
                                          cd_medico_p               VARCHAR2,
                                          cd_funcao_medico_p        NUMBER,
                                          qt_idade_p                NUMBER,
                                          nr_seq_exame_lab_p        NUMBER,
                                          nr_seq_proc_interno_p     NUMBER,
                                          cd_usuario_convenio_p     VARCHAR2,
                                          cd_plano_p                VARCHAR2,
                                          ie_clinica_p              NUMBER,
                                          cd_empresa_ref_p          NUMBER,
                                          ie_sexo_p                 VARCHAR2,
                                          vl_procedimento_p         OUT NUMBER,
                                          vl_custo_operacional_p    OUT NUMBER,
                                          vl_anestesista_p          OUT NUMBER,
                                          vl_medico_p               OUT NUMBER,
                                          vl_auxiliares_p           OUT NUMBER,
                                          vl_materiais_p            OUT NUMBER,
                                          vl_pto_procedimento_p     OUT NUMBER,
                                          vl_pto_custo_operac_p     OUT NUMBER,
                                          vl_pto_anestesista_p      OUT NUMBER,
                                          vl_pto_medico_p           OUT NUMBER,
                                          vl_pto_auxiliares_p       OUT NUMBER,
                                          vl_pto_materiais_p        OUT NUMBER,
                                          qt_porte_anestesico_p     OUT NUMBER,
                                          qt_pontos_p               OUT NUMBER,
                                          cd_edicao_amb_p           OUT NUMBER,
                                          ie_valor_informado_p      IN OUT NOCOPY VARCHAR2,
                                          nr_seq_ajuste_proc_p      OUT NUMBER,
                                          nr_sequencia_p            NUMBER,
                                          ie_atend_retorno_p        VARCHAR2,
                                          qt_dias_internacao_p      NUMBER,
                                          ie_video_p                VARCHAR2,
                                          ie_beira_leito_p          VARCHAR2,
                                          ie_spect_p                VARCHAR2,
                                          cd_cgc_prestador_p        VARCHAR2,
                                          cd_equipamento_p          NUMBER,
                                          nr_seq_tipo_acidente_p    NUMBER,
                                          cd_especialidade_medica_p NUMBER,
                                          cd_procedencia_p          VARCHAR2,
                                          nr_seq_cobertura_p        NUMBER,
                                          nr_seq_classif_atend_p    NUMBER,
                                          ie_carater_inter_sus_p    VARCHAR2,
                                          cd_dependente_p           NUMBER,
                                          nr_seq_grupo_rec_p        NUMBER,
                                          ie_origem_proced_p        NUMBER DEFAULT NULL,
                                          nr_seq_origem_p           NUMBER,
                                          nr_seq_classif_medico_p   NUMBER,
                                          ie_calcular_anest_p       VARCHAR2 DEFAULT NULL) IS

    data_w NUMBER := to_number(to_char(dt_conta_p, 'J'));

    --cd_procedimento_w      NUMBER := nvl(cd_procedimento_p, 0);
    cd_tipo_acomodacao_w   NUMBER := nvl(cd_tipo_acomodacao_p, 0);
    ie_tipo_atendimento_w  NUMBER := nvl(ie_tipo_atendimento_p, 0);
    cd_setor_atendimento_w NUMBER := nvl(cd_setor_atendimento_p, 0);
    cd_medico_w            NUMBER := nvl(cd_medico_p, 0);
    cd_funcao_medico_w     NUMBER := nvl(cd_funcao_medico_p, 0);
    nr_seq_exame_lab_w     NUMBER := nvl(nr_seq_exame_lab_p, 0);
    nr_seq_proc_interno_w  NUMBER := nvl(nr_seq_proc_interno_p, 0);
	cd_procedimento_index_w	VARCHAR2(15) := nvl(cd_procedimento_p, 0);

  BEGIN
  
    preco_procedimento_w(cd_estabelecimento_p)(cd_convenio_p)(data_w)(cd_procedimento_index_w)(cd_tipo_acomodacao_w)(ie_tipo_atendimento_w)(cd_setor_atendimento_w)(cd_medico_w)(cd_funcao_medico_w)(nr_seq_exame_lab_w)(nr_seq_proc_interno_w).ie_ok := 0;

    IF preco_procedimento_w(cd_estabelecimento_p) (cd_convenio_p) (data_w) (cd_procedimento_index_w) (cd_tipo_acomodacao_w) (ie_tipo_atendimento_w) (cd_setor_atendimento_w) (cd_medico_w)
     (cd_funcao_medico_w) (nr_seq_exame_lab_w)(nr_seq_proc_interno_w).ie_exec IS NULL THEN

      define_preco_procedimento(cd_estabelecimento_p,
                                cd_convenio_p,
                                cd_categoria_p,
                                dt_conta_p,
                                cd_procedimento_p,
                                cd_tipo_acomodacao_p,
                                ie_tipo_atendimento_p,
                                cd_setor_atendimento_p,
                                cd_medico_p,
                                cd_funcao_medico_p,
                                qt_idade_p,
                                nr_seq_exame_lab_p,
                                nr_seq_proc_interno_p,
                                cd_usuario_convenio_p,
                                cd_plano_p,
                                ie_clinica_p,
                                cd_empresa_ref_p,
                                ie_sexo_p,
                                vl_procedimento_p,
                                vl_custo_operacional_p,
                                vl_anestesista_p,
                                vl_medico_p,
                                vl_auxiliares_p,
                                vl_materiais_p,
                                vl_pto_procedimento_p,
                                vl_pto_custo_operac_p,
                                vl_pto_anestesista_p,
                                vl_pto_medico_p,
                                vl_pto_auxiliares_p,
                                vl_pto_materiais_p,
                                qt_porte_anestesico_p,
                                qt_pontos_p,
                                cd_edicao_amb_p,
                                ie_valor_informado_p,
                                nr_seq_ajuste_proc_p,
                                nr_sequencia_p,
                                ie_atend_retorno_p,
                                qt_dias_internacao_p,
                                ie_video_p,
                                ie_beira_leito_p,
                                ie_spect_p,
                                cd_cgc_prestador_p,
                                cd_equipamento_p,
                                nr_seq_tipo_acidente_p,
                                cd_especialidade_medica_p,
                                cd_procedencia_p,
                                nr_seq_cobertura_p,
                                nr_seq_classif_atend_p,
                                ie_carater_inter_sus_p,
                                cd_dependente_p,
                                nr_seq_grupo_rec_p,
                                ie_origem_proced_p,
                                nr_seq_origem_p,
                                nr_seq_classif_medico_p,
                                ie_calcular_anest_p);

      preco_procedimento_w(cd_estabelecimento_p)(cd_convenio_p)(data_w)(cd_procedimento_index_w)(cd_tipo_acomodacao_w)(ie_tipo_atendimento_w)(cd_setor_atendimento_w)(cd_medico_w)(cd_funcao_medico_w)(nr_seq_exame_lab_w)(nr_seq_proc_interno_w).ie_exec := 'S';
      preco_procedimento_w(cd_estabelecimento_p)(cd_convenio_p)(data_w)(cd_procedimento_index_w)(cd_tipo_acomodacao_w)(ie_tipo_atendimento_w)(cd_setor_atendimento_w)(cd_medico_w)(cd_funcao_medico_w)(nr_seq_exame_lab_w)(nr_seq_proc_interno_w).vl_procedimento := vl_procedimento_p;
      preco_procedimento_w(cd_estabelecimento_p)(cd_convenio_p)(data_w)(cd_procedimento_index_w)(cd_tipo_acomodacao_w)(ie_tipo_atendimento_w)(cd_setor_atendimento_w)(cd_medico_w)(cd_funcao_medico_w)(nr_seq_exame_lab_w)(nr_seq_proc_interno_w).vl_custo_operacional := vl_custo_operacional_p;
      preco_procedimento_w(cd_estabelecimento_p)(cd_convenio_p)(data_w)(cd_procedimento_index_w)(cd_tipo_acomodacao_w)(ie_tipo_atendimento_w)(cd_setor_atendimento_w)(cd_medico_w)(cd_funcao_medico_w)(nr_seq_exame_lab_w)(nr_seq_proc_interno_w).vl_anestesista := vl_anestesista_p;
      preco_procedimento_w(cd_estabelecimento_p)(cd_convenio_p)(data_w)(cd_procedimento_index_w)(cd_tipo_acomodacao_w)(ie_tipo_atendimento_w)(cd_setor_atendimento_w)(cd_medico_w)(cd_funcao_medico_w)(nr_seq_exame_lab_w)(nr_seq_proc_interno_w).vl_medico := vl_medico_p;
      preco_procedimento_w(cd_estabelecimento_p)(cd_convenio_p)(data_w)(cd_procedimento_index_w)(cd_tipo_acomodacao_w)(ie_tipo_atendimento_w)(cd_setor_atendimento_w)(cd_medico_w)(cd_funcao_medico_w)(nr_seq_exame_lab_w)(nr_seq_proc_interno_w).vl_auxiliares := vl_auxiliares_p;
      preco_procedimento_w(cd_estabelecimento_p)(cd_convenio_p)(data_w)(cd_procedimento_index_w)(cd_tipo_acomodacao_w)(ie_tipo_atendimento_w)(cd_setor_atendimento_w)(cd_medico_w)(cd_funcao_medico_w)(nr_seq_exame_lab_w)(nr_seq_proc_interno_w).vl_materiais := vl_materiais_p;
      preco_procedimento_w(cd_estabelecimento_p)(cd_convenio_p)(data_w)(cd_procedimento_index_w)(cd_tipo_acomodacao_w)(ie_tipo_atendimento_w)(cd_setor_atendimento_w)(cd_medico_w)(cd_funcao_medico_w)(nr_seq_exame_lab_w)(nr_seq_proc_interno_w).vl_pto_procedimento := vl_pto_procedimento_p;
      preco_procedimento_w(cd_estabelecimento_p)(cd_convenio_p)(data_w)(cd_procedimento_index_w)(cd_tipo_acomodacao_w)(ie_tipo_atendimento_w)(cd_setor_atendimento_w)(cd_medico_w)(cd_funcao_medico_w)(nr_seq_exame_lab_w)(nr_seq_proc_interno_w).vl_pto_custo_operac := vl_pto_custo_operac_p;
      preco_procedimento_w(cd_estabelecimento_p)(cd_convenio_p)(data_w)(cd_procedimento_index_w)(cd_tipo_acomodacao_w)(ie_tipo_atendimento_w)(cd_setor_atendimento_w)(cd_medico_w)(cd_funcao_medico_w)(nr_seq_exame_lab_w)(nr_seq_proc_interno_w).vl_pto_anestesista := vl_pto_anestesista_p;
      preco_procedimento_w(cd_estabelecimento_p)(cd_convenio_p)(data_w)(cd_procedimento_index_w)(cd_tipo_acomodacao_w)(ie_tipo_atendimento_w)(cd_setor_atendimento_w)(cd_medico_w)(cd_funcao_medico_w)(nr_seq_exame_lab_w)(nr_seq_proc_interno_w).vl_pto_medico := vl_pto_medico_p;
      preco_procedimento_w(cd_estabelecimento_p)(cd_convenio_p)(data_w)(cd_procedimento_index_w)(cd_tipo_acomodacao_w)(ie_tipo_atendimento_w)(cd_setor_atendimento_w)(cd_medico_w)(cd_funcao_medico_w)(nr_seq_exame_lab_w)(nr_seq_proc_interno_w).vl_pto_auxiliares := vl_pto_auxiliares_p;
      preco_procedimento_w(cd_estabelecimento_p)(cd_convenio_p)(data_w)(cd_procedimento_index_w)(cd_tipo_acomodacao_w)(ie_tipo_atendimento_w)(cd_setor_atendimento_w)(cd_medico_w)(cd_funcao_medico_w)(nr_seq_exame_lab_w)(nr_seq_proc_interno_w).vl_pto_materiais := vl_pto_materiais_p;
      preco_procedimento_w(cd_estabelecimento_p)(cd_convenio_p)(data_w)(cd_procedimento_index_w)(cd_tipo_acomodacao_w)(ie_tipo_atendimento_w)(cd_setor_atendimento_w)(cd_medico_w)(cd_funcao_medico_w)(nr_seq_exame_lab_w)(nr_seq_proc_interno_w).qt_porte_anestesico := qt_porte_anestesico_p;
      preco_procedimento_w(cd_estabelecimento_p)(cd_convenio_p)(data_w)(cd_procedimento_index_w)(cd_tipo_acomodacao_w)(ie_tipo_atendimento_w)(cd_setor_atendimento_w)(cd_medico_w)(cd_funcao_medico_w)(nr_seq_exame_lab_w)(nr_seq_proc_interno_w).qt_pontos := qt_pontos_p;
      preco_procedimento_w(cd_estabelecimento_p)(cd_convenio_p)(data_w)(cd_procedimento_index_w)(cd_tipo_acomodacao_w)(ie_tipo_atendimento_w)(cd_setor_atendimento_w)(cd_medico_w)(cd_funcao_medico_w)(nr_seq_exame_lab_w)(nr_seq_proc_interno_w).cd_edicao_amb := cd_edicao_amb_p;
      preco_procedimento_w(cd_estabelecimento_p)(cd_convenio_p)(data_w)(cd_procedimento_index_w)(cd_tipo_acomodacao_w)(ie_tipo_atendimento_w)(cd_setor_atendimento_w)(cd_medico_w)(cd_funcao_medico_w)(nr_seq_exame_lab_w)(nr_seq_proc_interno_w).ie_valor_informado := ie_valor_informado_p;
      preco_procedimento_w(cd_estabelecimento_p)(cd_convenio_p)(data_w)(cd_procedimento_index_w)(cd_tipo_acomodacao_w)(ie_tipo_atendimento_w)(cd_setor_atendimento_w)(cd_medico_w)(cd_funcao_medico_w)(nr_seq_exame_lab_w)(nr_seq_proc_interno_w).nr_seq_ajuste_proc := nr_seq_ajuste_proc_p;
    ELSE
      vl_procedimento_p      := preco_procedimento_w(cd_estabelecimento_p) (cd_convenio_p) (data_w) (cd_procedimento_index_w) (cd_tipo_acomodacao_w) (ie_tipo_atendimento_w) (cd_setor_atendimento_w)
                                (cd_medico_w) (cd_funcao_medico_w) (nr_seq_exame_lab_w)(nr_seq_proc_interno_w).vl_procedimento;
      vl_custo_operacional_p := preco_procedimento_w(cd_estabelecimento_p) (cd_convenio_p) (data_w) (cd_procedimento_index_w) (cd_tipo_acomodacao_w) (ie_tipo_atendimento_w) (cd_setor_atendimento_w)
                                (cd_medico_w) (cd_funcao_medico_w) (nr_seq_exame_lab_w)(nr_seq_proc_interno_w).vl_custo_operacional;
      vl_anestesista_p       := preco_procedimento_w(cd_estabelecimento_p) (cd_convenio_p) (data_w) (cd_procedimento_index_w) (cd_tipo_acomodacao_w) (ie_tipo_atendimento_w) (cd_setor_atendimento_w)
                                (cd_medico_w) (cd_funcao_medico_w) (nr_seq_exame_lab_w)(nr_seq_proc_interno_w).vl_anestesista;
      vl_medico_p            := preco_procedimento_w(cd_estabelecimento_p) (cd_convenio_p) (data_w) (cd_procedimento_index_w) (cd_tipo_acomodacao_w) (ie_tipo_atendimento_w) (cd_setor_atendimento_w)
                                (cd_medico_w) (cd_funcao_medico_w) (nr_seq_exame_lab_w)(nr_seq_proc_interno_w).vl_medico;
      vl_auxiliares_p        := preco_procedimento_w(cd_estabelecimento_p) (cd_convenio_p) (data_w) (cd_procedimento_index_w) (cd_tipo_acomodacao_w) (ie_tipo_atendimento_w) (cd_setor_atendimento_w)
                                (cd_medico_w) (cd_funcao_medico_w) (nr_seq_exame_lab_w)(nr_seq_proc_interno_w).vl_auxiliares;
      vl_materiais_p         := preco_procedimento_w(cd_estabelecimento_p) (cd_convenio_p) (data_w) (cd_procedimento_index_w) (cd_tipo_acomodacao_w) (ie_tipo_atendimento_w) (cd_setor_atendimento_w)
                                (cd_medico_w) (cd_funcao_medico_w) (nr_seq_exame_lab_w)(nr_seq_proc_interno_w).vl_materiais;
      vl_pto_procedimento_p  := preco_procedimento_w(cd_estabelecimento_p) (cd_convenio_p) (data_w) (cd_procedimento_index_w) (cd_tipo_acomodacao_w) (ie_tipo_atendimento_w) (cd_setor_atendimento_w)
                                (cd_medico_w) (cd_funcao_medico_w) (nr_seq_exame_lab_w)(nr_seq_proc_interno_w).vl_pto_procedimento;
      vl_pto_custo_operac_p  := preco_procedimento_w(cd_estabelecimento_p) (cd_convenio_p) (data_w) (cd_procedimento_index_w) (cd_tipo_acomodacao_w) (ie_tipo_atendimento_w) (cd_setor_atendimento_w)
                                (cd_medico_w) (cd_funcao_medico_w) (nr_seq_exame_lab_w)(nr_seq_proc_interno_w).vl_pto_custo_operac;
      vl_pto_anestesista_p   := preco_procedimento_w(cd_estabelecimento_p) (cd_convenio_p) (data_w) (cd_procedimento_index_w) (cd_tipo_acomodacao_w) (ie_tipo_atendimento_w) (cd_setor_atendimento_w)
                                (cd_medico_w) (cd_funcao_medico_w) (nr_seq_exame_lab_w)(nr_seq_proc_interno_w).vl_pto_anestesista;
      vl_pto_medico_p        := preco_procedimento_w(cd_estabelecimento_p) (cd_convenio_p) (data_w) (cd_procedimento_index_w) (cd_tipo_acomodacao_w) (ie_tipo_atendimento_w) (cd_setor_atendimento_w)
                                (cd_medico_w) (cd_funcao_medico_w) (nr_seq_exame_lab_w)(nr_seq_proc_interno_w).vl_pto_medico;
      vl_pto_auxiliares_p    := preco_procedimento_w(cd_estabelecimento_p) (cd_convenio_p) (data_w) (cd_procedimento_index_w) (cd_tipo_acomodacao_w) (ie_tipo_atendimento_w) (cd_setor_atendimento_w)
                                (cd_medico_w) (cd_funcao_medico_w) (nr_seq_exame_lab_w)(nr_seq_proc_interno_w).vl_pto_auxiliares;
      vl_pto_materiais_p     := preco_procedimento_w(cd_estabelecimento_p) (cd_convenio_p) (data_w) (cd_procedimento_index_w) (cd_tipo_acomodacao_w) (ie_tipo_atendimento_w) (cd_setor_atendimento_w)
                                (cd_medico_w) (cd_funcao_medico_w) (nr_seq_exame_lab_w)(nr_seq_proc_interno_w).vl_pto_materiais;
      qt_porte_anestesico_p  := preco_procedimento_w(cd_estabelecimento_p) (cd_convenio_p) (data_w) (cd_procedimento_index_w) (cd_tipo_acomodacao_w) (ie_tipo_atendimento_w) (cd_setor_atendimento_w)
                                (cd_medico_w) (cd_funcao_medico_w) (nr_seq_exame_lab_w)(nr_seq_proc_interno_w).qt_porte_anestesico;
      qt_pontos_p            := preco_procedimento_w(cd_estabelecimento_p) (cd_convenio_p) (data_w) (cd_procedimento_index_w) (cd_tipo_acomodacao_w) (ie_tipo_atendimento_w) (cd_setor_atendimento_w)
                                (cd_medico_w) (cd_funcao_medico_w) (nr_seq_exame_lab_w)(nr_seq_proc_interno_w).qt_pontos;
      cd_edicao_amb_p        := preco_procedimento_w(cd_estabelecimento_p) (cd_convenio_p) (data_w) (cd_procedimento_index_w) (cd_tipo_acomodacao_w) (ie_tipo_atendimento_w) (cd_setor_atendimento_w)
                                (cd_medico_w) (cd_funcao_medico_w) (nr_seq_exame_lab_w)(nr_seq_proc_interno_w).cd_edicao_amb;
      ie_valor_informado_p   := preco_procedimento_w(cd_estabelecimento_p) (cd_convenio_p) (data_w) (cd_procedimento_index_w) (cd_tipo_acomodacao_w) (ie_tipo_atendimento_w) (cd_setor_atendimento_w)
                                (cd_medico_w) (cd_funcao_medico_w) (nr_seq_exame_lab_w)(nr_seq_proc_interno_w).ie_valor_informado;
      nr_seq_ajuste_proc_p   := preco_procedimento_w(cd_estabelecimento_p) (cd_convenio_p) (data_w) (cd_procedimento_index_w) (cd_tipo_acomodacao_w) (ie_tipo_atendimento_w) (cd_setor_atendimento_w)
                                (cd_medico_w) (cd_funcao_medico_w) (nr_seq_exame_lab_w)(nr_seq_proc_interno_w).nr_seq_ajuste_proc;
    END IF;
  END;

  ---------
  /*
  Rotina de Apoio  da define_preco_procedimento_vet
  */
CREATE OR REPLACE FUNCTION smart_schedule_data_process.ageint_obter_valor_item_vet (cd_convenio_p bigint, cd_categoria_p text, cd_plano_p text, nr_seq_proc_interno_p bigint, cd_estabelecimento_p bigint, qt_idade_p bigint, ie_tipo_atendimento_p bigint, ie_sexo_p text, cd_pessoa_fisica_p text, dt_nascimento_p timestamp, nr_seq_cobertura_p bigint, dt_inicio_agendamento_p timestamp, cd_usuario_convenio_p text, cd_medico_p text DEFAULT NULL, cd_especialidade_p bigint DEFAULT NULL) RETURNS bigint AS $body$
DECLARE


    current_setting('smart_schedule_data_process.nr_seq_proc_interno_w')::bigint bigint;
    qt_pontos_w           preco_amb.qt_pontuacao%TYPE;
    current_setting('smart_schedule_data_process.cd_procedimento_w')::agenda_integrada_item.cd_procedimento%TYPE     bigint;
    current_setting('smart_schedule_data_process.ie_origem_proced_w')::agenda_integrada_item.ie_origem_proced%TYPE    bigint;
    vl_procedimento_w     double precision;
    vl_item_w             double precision;
    vl_aux_w              double precision;

    ds_aux_w             varchar(255);
    current_setting('smart_schedule_data_process.ds_retorno_w')::varchar(4000)         varchar(255);
    ie_bloqueia_agenda_w varchar(255);
    current_setting('smart_schedule_data_process.ie_regra_w')::integer           integer;
    current_setting('smart_schedule_data_process.cd_convenio_w')::integer        integer;
    cd_convenio_ww       integer;
    current_setting('smart_schedule_data_process.cd_categoria_w')::varchar(10)       varchar(10);
    current_setting('smart_schedule_data_process.cd_plano_w')::agenda_integrada.cd_plano%TYPE           varchar(10);
    ie_tipo_convenio_w   smallint;
    current_setting('smart_schedule_data_process.dt_nascimento_w')::agenda_integrada.dt_nascimento%TYPE      timestamp;
    current_setting('smart_schedule_data_process.ie_sexo_w')::varchar(1)            varchar(2);
    current_setting('smart_schedule_data_process.qt_idade_w')::bigint           smallint;
    current_setting('smart_schedule_data_process.ie_glosa_w')::varchar(1)           varchar(1);
    cd_edicao_amb_w      integer;
    vl_lanc_autom_w      double precision;

    vl_custo_operacional_w double precision;
    vl_anestesista_w       double precision;
    vl_medico_w            double precision;
    vl_auxiliares_w        double precision;
    vl_materiais_w         double precision;

    current_setting('smart_schedule_data_process.nr_seq_regra_w')::bigint bigint;

    ie_resp_autor_w    varchar(10);
    dt_transferencia_w timestamp;
    ie_edicao_w        varchar(1);
    cd_edicao_ajuste_w bigint;
    qt_item_edicao_w   bigint;
    ie_pacote_item_w   varchar(1);

    current_setting('smart_schedule_data_process.ds_erro_w')::varchar(4000) varchar(255);

    ds_irrelavante_w             varchar(255);
    nr_seq_ajuste_proc_w         bigint;
    pr_glosa_w                   double precision;
    vl_glosa_w                   double precision;
    ie_regra_arredondamento_tx_w varchar(1) := 'N';
    ie_tipo_rounded_w            varchar(1);
    ie_regra_arred_ipe_w         varchar(1) := 'N';
    vl_retorno_w                 double precision;

    ie_excluir_valor      varchar(1) := 'N';
    current_setting('smart_schedule_data_process.ie_tipo_atendimento_w')::smallint bigint;
	cd_procedimento_index_w	varchar(15);


BEGIN

    PERFORM set_config('smart_schedule_data_process.nr_seq_proc_interno_w', nr_seq_proc_interno_p, false);

    PERFORM set_config('smart_schedule_data_process.ie_sexo_w', ie_sexo_p, false);
    PERFORM set_config('smart_schedule_data_process.dt_nascimento_w', dt_nascimento_p, false);
    PERFORM set_config('smart_schedule_data_process.qt_idade_w', qt_idade_p, false);
    cd_convenio_ww        := cd_convenio_p;
    PERFORM set_config('smart_schedule_data_process.cd_categoria_w', cd_categoria_p, false);
    PERFORM set_config('smart_schedule_data_process.cd_plano_w', cd_plano_p, false);
    PERFORM set_config('smart_schedule_data_process.ie_tipo_atendimento_w', coalesce(ie_tipo_atendimento_p, 0), false);

    SELECT MAX(ie_tipo_convenio) INTO STRICT ie_tipo_convenio_w FROM convenio WHERE cd_convenio = cd_convenio_ww;

    IF ie_tipo_convenio_w <> 1 THEN
      RETURN 0;
    END IF;

    IF (current_setting('smart_schedule_data_process.dt_nascimento_w')::agenda_integrada.dt_nascimento%(TYPE IS NOT NULL AND TYPE::text <> '')) THEN
      PERFORM set_config('smart_schedule_data_process.qt_idade_w', obter_idade(current_setting('smart_schedule_data_process.dt_nascimento_w')::agenda_integrada.dt_nascimento%TYPE, clock_timestamp(), 'A'), false);
    END IF;

    current_setting('smart_schedule_data_process.proc_tab_interno_conv_w')::proc_tab_int_conv_table(nr_seq_proc_interno_p)(cd_estabelecimento_p)(cd_convenio_ww).ie_ok := 0;
    IF current_setting('smart_schedule_data_process.proc_tab_interno_conv_w')::proc_tab_int_conv_table(nr_seq_proc_interno_p) (cd_estabelecimento_p)(cd_convenio_ww)coalesce(.ie_exec::text, '') = '' THEN
      obter_proc_tab_interno_conv(nr_seq_proc_interno_p,
                                  cd_estabelecimento_p,
                                  cd_convenio_ww,
                                  current_setting('smart_schedule_data_process.cd_categoria_w')::varchar(10),
                                  current_setting('smart_schedule_data_process.cd_plano_w')::agenda_integrada.cd_plano%TYPE,
                                  NULL,
                                  current_setting('smart_schedule_data_process.cd_procedimento_w')::agenda_integrada_item.cd_procedimento%TYPE,
                                  current_setting('smart_schedule_data_process.ie_origem_proced_w')::agenda_integrada_item.ie_origem_proced%TYPE,
                                  NULL,
                                  clock_timestamp(),
                                  NULL,
                                  NULL,
                                  NULL,
                                  NULL,
                                  NULL,
                                  NULL,
                                  NULL,
                                  NULL);

      current_setting('smart_schedule_data_process.proc_tab_interno_conv_w')::proc_tab_int_conv_table(nr_seq_proc_interno_p)(cd_estabelecimento_p)(cd_convenio_ww).ie_exec := 'S';
      current_setting('smart_schedule_data_process.proc_tab_interno_conv_w')::proc_tab_int_conv_table(nr_seq_proc_interno_p)(cd_estabelecimento_p)(cd_convenio_ww).cd_procedimento := current_setting('smart_schedule_data_process.cd_procedimento_w')::agenda_integrada_item.cd_procedimento%TYPE;
      current_setting('smart_schedule_data_process.proc_tab_interno_conv_w')::proc_tab_int_conv_table(nr_seq_proc_interno_p)(cd_estabelecimento_p)(cd_convenio_ww).ie_origem_proced := current_setting('smart_schedule_data_process.ie_origem_proced_w')::agenda_integrada_item.ie_origem_proced%TYPE;
    ELSE
      PERFORM set_config('smart_schedule_data_process.cd_procedimento_w', current_setting('smart_schedule_data_process.proc_tab_interno_conv_w')::proc_tab_int_conv_table(nr_seq_proc_interno_p) (cd_estabelecimento_p)(cd_convenio_ww).cd_procedimento, false);
      PERFORM set_config('smart_schedule_data_process.ie_origem_proced_w', current_setting('smart_schedule_data_process.proc_tab_interno_conv_w')::proc_tab_int_conv_table(nr_seq_proc_interno_p) (cd_estabelecimento_p)(cd_convenio_ww).ie_origem_proced, false);

    END IF;

    current_setting('smart_schedule_data_process.cons_plano_mat_proc_w')::cons_plano_mat_proc_table(nr_seq_proc_interno_p)(cd_estabelecimento_p)(cd_convenio_ww).ie_ok := 0;
    IF current_setting('smart_schedule_data_process.cons_plano_mat_proc_w')::cons_plano_mat_proc_table(nr_seq_proc_interno_p) (cd_estabelecimento_p)(cd_convenio_ww)coalesce(.ie_exec::text, '') = '' THEN
      consiste_plano_mat_proc(cd_estabelecimento_p   => cd_estabelecimento_p,
                              cd_convenio_p          => cd_convenio_ww,
                              cd_categoria_p         => current_setting('smart_schedule_data_process.cd_categoria_w')::varchar(10),
                              cd_plano_p             => current_setting('smart_schedule_data_process.cd_plano_w')::agenda_integrada.cd_plano%TYPE,
                              cd_material_p          => NULL,
                              cd_procedimento_p      => current_setting('smart_schedule_data_process.cd_procedimento_w')::agenda_integrada_item.cd_procedimento%TYPE,
                              ie_origem_proced_p     => current_setting('smart_schedule_data_process.ie_origem_proced_w')::agenda_integrada_item.ie_origem_proced%TYPE,
                              nr_atendimento_p       => NULL,
                              ie_tipo_atendimento_p  => coalesce(ie_tipo_atendimento_p, 0),
                              cd_tipo_acomodacao_p   => 0,
                              cd_setor_atendimento_p => 0,
                              nr_seq_exame_p         => NULL,
                              nr_seq_proc_interno_p  => nr_seq_proc_interno_p,
                              ----- Out -----
                              ds_retorno_p         => current_setting('smart_schedule_data_process.ds_retorno_w')::varchar(4000),
                              ie_bloqueia_agenda_p => ie_bloqueia_agenda_w,
                              ie_regra_p           => current_setting('smart_schedule_data_process.ie_regra_w')::integer,
                              nr_seq_regra_p       => current_setting('smart_schedule_data_process.nr_seq_regra_w')::bigint);
      current_setting('smart_schedule_data_process.cons_plano_mat_proc_w')::cons_plano_mat_proc_table(nr_seq_proc_interno_p)(cd_estabelecimento_p)(cd_convenio_ww).ie_exec := 'S';
      current_setting('smart_schedule_data_process.cons_plano_mat_proc_w')::cons_plano_mat_proc_table(nr_seq_proc_interno_p)(cd_estabelecimento_p)(cd_convenio_ww).ds_retorno := current_setting('smart_schedule_data_process.ds_retorno_w')::varchar(4000);
      current_setting('smart_schedule_data_process.cons_plano_mat_proc_w')::cons_plano_mat_proc_table(nr_seq_proc_interno_p)(cd_estabelecimento_p)(cd_convenio_ww).ie_bloqueia_agenda := ie_bloqueia_agenda_w;
      current_setting('smart_schedule_data_process.cons_plano_mat_proc_w')::cons_plano_mat_proc_table(nr_seq_proc_interno_p)(cd_estabelecimento_p)(cd_convenio_ww).ie_regra := current_setting('smart_schedule_data_process.ie_regra_w')::integer;
      current_setting('smart_schedule_data_process.cons_plano_mat_proc_w')::cons_plano_mat_proc_table(nr_seq_proc_interno_p)(cd_estabelecimento_p)(cd_convenio_ww).nr_seq_regra := current_setting('smart_schedule_data_process.nr_seq_regra_w')::bigint;
    ELSE
      PERFORM set_config('smart_schedule_data_process.ie_regra_w', current_setting('smart_schedule_data_process.cons_plano_mat_proc_w')::cons_plano_mat_proc_table(nr_seq_proc_interno_p) (cd_estabelecimento_p)(cd_convenio_ww).ie_regra, false);
      PERFORM set_config('smart_schedule_data_process.nr_seq_regra_w', current_setting('smart_schedule_data_process.cons_plano_mat_proc_w')::cons_plano_mat_proc_table(nr_seq_proc_interno_p) (cd_estabelecimento_p)(cd_convenio_ww).nr_seq_regra, false);

    END IF;
	
	cd_procedimento_index_w := current_setting('smart_schedule_data_process.cd_procedimento_w')::agenda_integrada_item.cd_procedimento%TYPE;
	
    current_setting('smart_schedule_data_process.consiste_plano_conv_w')::consiste_plano_conv_table(cd_estabelecimento_p)(cd_convenio_ww)(cd_procedimento_index_w)(current_setting('smart_schedule_data_process.ie_origem_proced_w')::agenda_integrada_item.ie_origem_proced%TYPE)(current_setting('smart_schedule_data_process.ie_tipo_atendimento_w')::smallint).ie_ok := 0;
    IF current_setting('smart_schedule_data_process.consiste_plano_conv_w')::consiste_plano_conv_table(cd_estabelecimento_p) (cd_convenio_ww) (cd_procedimento_index_w) (current_setting('smart_schedule_data_process.ie_origem_proced_w')::agenda_integrada_item.ie_origem_proced%TYPE)(current_setting('smart_schedule_data_process.ie_tipo_atendimento_w')::smallint)coalesce(.ie_exec::text, '') = '' THEN
      ageint_consiste_plano_conv(nr_atendimento_p          => NULL,
                                 cd_convenio_p             => cd_convenio_ww,
                                 cd_procedimento_p         => current_setting('smart_schedule_data_process.cd_procedimento_w')::agenda_integrada_item.cd_procedimento%TYPE,
                                 ie_origem_proced_p        => current_setting('smart_schedule_data_process.ie_origem_proced_w')::agenda_integrada_item.ie_origem_proced%TYPE,
                                 dt_procedimento_p         => clock_timestamp(),
                                 qt_procedimento_p         => 1,
                                 ie_tipo_atendimento_p     => coalesce(ie_tipo_atendimento_p, 0),
                                 cd_plano_p                => current_setting('smart_schedule_data_process.cd_plano_w')::agenda_integrada.cd_plano%TYPE,
                                 cd_autorizacao_p          => NULL,
                                 ds_erro_p                 => current_setting('smart_schedule_data_process.ds_erro_w')::varchar(4000),
                                 cd_setor_atendimento_p    => 0,
                                 nr_seq_exame_p            => NULL,
                                 ie_regra_p                => current_setting('smart_schedule_data_process.ie_regra_w')::integer,
                                 nr_seq_agenda_p           => NULL,
                                 nr_seq_regra_p            => current_setting('smart_schedule_data_process.nr_seq_regra_w')::bigint,
                                 nr_seq_proc_interno_p     => nr_seq_proc_interno_p,
                                 cd_categoria_p            => current_setting('smart_schedule_data_process.cd_categoria_w')::varchar(10),
                                 cd_estabelecimento_p      => cd_estabelecimento_p,
                                 cd_setor_entrega_prescr_p => NULL,
                                 ie_sexo_p                 => current_setting('smart_schedule_data_process.ie_sexo_w')::varchar(1),
                                 ie_glosa_p                => current_setting('smart_schedule_data_process.ie_glosa_w')::varchar(1),
                                 cd_edicao_ajuste_p        => cd_edicao_ajuste_w,
                                 nr_seq_cobertura_p        => nr_seq_cobertura_p,
                                 cd_convenio_glosa_p       => ds_irrelavante_w,
                                 cd_categoria_glosa_p      => ds_irrelavante_w,
                                 cd_paciente_p             => cd_pessoa_fisica_p,
                                 cd_empresa_p              => NULL,
                                 pr_glosa_p                => pr_glosa_w,
                                 vl_glosa_p                => vl_glosa_w);

      current_setting('smart_schedule_data_process.consiste_plano_conv_w')::consiste_plano_conv_table(cd_estabelecimento_p)(cd_convenio_ww)(cd_procedimento_index_w)(current_setting('smart_schedule_data_process.ie_origem_proced_w')::agenda_integrada_item.ie_origem_proced%TYPE)(current_setting('smart_schedule_data_process.ie_tipo_atendimento_w')::smallint).ie_exec := 'S';
      current_setting('smart_schedule_data_process.consiste_plano_conv_w')::consiste_plano_conv_table(cd_estabelecimento_p)(cd_convenio_ww)(cd_procedimento_index_w)(current_setting('smart_schedule_data_process.ie_origem_proced_w')::agenda_integrada_item.ie_origem_proced%TYPE)(current_setting('smart_schedule_data_process.ie_tipo_atendimento_w')::smallint).ds_erro := current_setting('smart_schedule_data_process.ds_erro_w')::varchar(4000);
      current_setting('smart_schedule_data_process.consiste_plano_conv_w')::consiste_plano_conv_table(cd_estabelecimento_p)(cd_convenio_ww)(cd_procedimento_index_w)(current_setting('smart_schedule_data_process.ie_origem_proced_w')::agenda_integrada_item.ie_origem_proced%TYPE)(current_setting('smart_schedule_data_process.ie_tipo_atendimento_w')::smallint).ie_regra := current_setting('smart_schedule_data_process.ie_regra_w')::integer;
      current_setting('smart_schedule_data_process.consiste_plano_conv_w')::consiste_plano_conv_table(cd_estabelecimento_p)(cd_convenio_ww)(cd_procedimento_index_w)(current_setting('smart_schedule_data_process.ie_origem_proced_w')::agenda_integrada_item.ie_origem_proced%TYPE)(current_setting('smart_schedule_data_process.ie_tipo_atendimento_w')::smallint).nr_seq_regra := current_setting('smart_schedule_data_process.ie_regra_w')::integer;
      current_setting('smart_schedule_data_process.consiste_plano_conv_w')::consiste_plano_conv_table(cd_estabelecimento_p)(cd_convenio_ww)(cd_procedimento_index_w)(current_setting('smart_schedule_data_process.ie_origem_proced_w')::agenda_integrada_item.ie_origem_proced%TYPE)(current_setting('smart_schedule_data_process.ie_tipo_atendimento_w')::smallint).ie_glosa := current_setting('smart_schedule_data_process.ie_glosa_w')::varchar(1);
      current_setting('smart_schedule_data_process.consiste_plano_conv_w')::consiste_plano_conv_table(cd_estabelecimento_p)(cd_convenio_ww)(cd_procedimento_index_w)(current_setting('smart_schedule_data_process.ie_origem_proced_w')::agenda_integrada_item.ie_origem_proced%TYPE)(current_setting('smart_schedule_data_process.ie_tipo_atendimento_w')::smallint).cd_edicao_ajuste := cd_edicao_ajuste_w;
      current_setting('smart_schedule_data_process.consiste_plano_conv_w')::consiste_plano_conv_table(cd_estabelecimento_p)(cd_convenio_ww)(cd_procedimento_index_w)(current_setting('smart_schedule_data_process.ie_origem_proced_w')::agenda_integrada_item.ie_origem_proced%TYPE)(current_setting('smart_schedule_data_process.ie_tipo_atendimento_w')::smallint).cd_convenio_glosa := '';
      current_setting('smart_schedule_data_process.consiste_plano_conv_w')::consiste_plano_conv_table(cd_estabelecimento_p)(cd_convenio_ww)(cd_procedimento_index_w)(current_setting('smart_schedule_data_process.ie_origem_proced_w')::agenda_integrada_item.ie_origem_proced%TYPE)(current_setting('smart_schedule_data_process.ie_tipo_atendimento_w')::smallint).cd_categoria_glosa := '';
      current_setting('smart_schedule_data_process.consiste_plano_conv_w')::consiste_plano_conv_table(cd_estabelecimento_p)(cd_convenio_ww)(cd_procedimento_index_w)(current_setting('smart_schedule_data_process.ie_origem_proced_w')::agenda_integrada_item.ie_origem_proced%TYPE)(current_setting('smart_schedule_data_process.ie_tipo_atendimento_w')::smallint).pr_glosa := pr_glosa_w;
      current_setting('smart_schedule_data_process.consiste_plano_conv_w')::consiste_plano_conv_table(cd_estabelecimento_p)(cd_convenio_ww)(cd_procedimento_index_w)(current_setting('smart_schedule_data_process.ie_origem_proced_w')::agenda_integrada_item.ie_origem_proced%TYPE)(current_setting('smart_schedule_data_process.ie_tipo_atendimento_w')::smallint).vl_glosa := vl_glosa_w;

    ELSE

      PERFORM set_config('smart_schedule_data_process.ie_regra_w', current_setting('smart_schedule_data_process.consiste_plano_conv_w')::consiste_plano_conv_table(cd_estabelecimento_p) (cd_convenio_ww) (cd_procedimento_index_w) (current_setting('smart_schedule_data_process.ie_origem_proced_w')::agenda_integrada_item.ie_origem_proced%TYPE)(current_setting('smart_schedule_data_process.ie_tipo_atendimento_w')::smallint).ie_regra, false);
      PERFORM set_config('smart_schedule_data_process.nr_seq_regra_w', current_setting('smart_schedule_data_process.consiste_plano_conv_w')::consiste_plano_conv_table(cd_estabelecimento_p) (cd_convenio_ww) (cd_procedimento_index_w) (current_setting('smart_schedule_data_process.ie_origem_proced_w')::agenda_integrada_item.ie_origem_proced%TYPE)(current_setting('smart_schedule_data_process.ie_tipo_atendimento_w')::smallint).nr_seq_regra, false);
      PERFORM set_config('smart_schedule_data_process.ie_glosa_w', current_setting('smart_schedule_data_process.consiste_plano_conv_w')::consiste_plano_conv_table(cd_estabelecimento_p) (cd_convenio_ww) (cd_procedimento_index_w) (current_setting('smart_schedule_data_process.ie_origem_proced_w')::agenda_integrada_item.ie_origem_proced%TYPE)(current_setting('smart_schedule_data_process.ie_tipo_atendimento_w')::smallint).ie_glosa, false);
      cd_edicao_ajuste_w := current_setting('smart_schedule_data_process.consiste_plano_conv_w')::consiste_plano_conv_table(cd_estabelecimento_p) (cd_convenio_ww) (cd_procedimento_index_w) (current_setting('smart_schedule_data_process.ie_origem_proced_w')::agenda_integrada_item.ie_origem_proced%TYPE)(current_setting('smart_schedule_data_process.ie_tipo_atendimento_w')::smallint).cd_edicao_ajuste;
      pr_glosa_w         := current_setting('smart_schedule_data_process.consiste_plano_conv_w')::consiste_plano_conv_table(cd_estabelecimento_p) (cd_convenio_ww) (cd_procedimento_index_w) (current_setting('smart_schedule_data_process.ie_origem_proced_w')::agenda_integrada_item.ie_origem_proced%TYPE)(current_setting('smart_schedule_data_process.ie_tipo_atendimento_w')::smallint).pr_glosa;
      vl_glosa_w         := current_setting('smart_schedule_data_process.consiste_plano_conv_w')::consiste_plano_conv_table(cd_estabelecimento_p) (cd_convenio_ww) (cd_procedimento_index_w) (current_setting('smart_schedule_data_process.ie_origem_proced_w')::agenda_integrada_item.ie_origem_proced%TYPE)(current_setting('smart_schedule_data_process.ie_tipo_atendimento_w')::smallint).vl_glosa;
    END IF;

    current_setting('smart_schedule_data_process.obter_se_proc_conv_w')::obter_se_proc_conv_table(cd_estabelecimento_p)(cd_convenio_ww)(cd_procedimento_index_w)(current_setting('smart_schedule_data_process.ie_origem_proced_w')::agenda_integrada_item.ie_origem_proced%TYPE)(current_setting('smart_schedule_data_process.ie_tipo_atendimento_w')::smallint).ie_ok := 0;
    IF current_setting('smart_schedule_data_process.obter_se_proc_conv_w')::obter_se_proc_conv_table(cd_estabelecimento_p) (cd_convenio_ww) (cd_procedimento_index_w) (current_setting('smart_schedule_data_process.ie_origem_proced_w')::agenda_integrada_item.ie_origem_proced%TYPE)(current_setting('smart_schedule_data_process.ie_tipo_atendimento_w')::smallint)coalesce(.ie_exec::text, '') = '' THEN
      ie_edicao_w := obter_se_proc_conv(cd_estabelecimento_p, cd_convenio_ww, current_setting('smart_schedule_data_process.cd_categoria_w')::varchar(10), clock_timestamp(), current_setting('smart_schedule_data_process.cd_procedimento_w')::agenda_integrada_item.cd_procedimento%TYPE, current_setting('smart_schedule_data_process.ie_origem_proced_w')::agenda_integrada_item.ie_origem_proced%TYPE, current_setting('smart_schedule_data_process.nr_seq_proc_interno_w')::bigint, ie_tipo_atendimento_p);
      current_setting('smart_schedule_data_process.obter_se_proc_conv_w')::obter_se_proc_conv_table(cd_estabelecimento_p)(cd_convenio_ww)(cd_procedimento_index_w)(current_setting('smart_schedule_data_process.ie_origem_proced_w')::agenda_integrada_item.ie_origem_proced%TYPE)(current_setting('smart_schedule_data_process.ie_tipo_atendimento_w')::smallint).ie_edicao := ie_edicao_w;
      current_setting('smart_schedule_data_process.obter_se_proc_conv_w')::obter_se_proc_conv_table(cd_estabelecimento_p)(cd_convenio_ww)(cd_procedimento_index_w)(current_setting('smart_schedule_data_process.ie_origem_proced_w')::agenda_integrada_item.ie_origem_proced%TYPE)(current_setting('smart_schedule_data_process.ie_tipo_atendimento_w')::smallint).ie_exec := 'S';
    ELSE
      ie_edicao_w := current_setting('smart_schedule_data_process.obter_se_proc_conv_w')::obter_se_proc_conv_table(cd_estabelecimento_p) (cd_convenio_ww) (cd_procedimento_index_w) (current_setting('smart_schedule_data_process.ie_origem_proced_w')::agenda_integrada_item.ie_origem_proced%TYPE)(current_setting('smart_schedule_data_process.ie_tipo_atendimento_w')::smallint).ie_edicao;
    END IF;

    current_setting('smart_schedule_data_process.obter_se_pacote_c_w')::obter_se_pacote_c_table(cd_estabelecimento_p)(cd_convenio_ww)(cd_procedimento_index_w)(current_setting('smart_schedule_data_process.ie_origem_proced_w')::agenda_integrada_item.ie_origem_proced%TYPE)(current_setting('smart_schedule_data_process.ie_tipo_atendimento_w')::smallint).ie_ok := 0;
    IF current_setting('smart_schedule_data_process.obter_se_pacote_c_w')::obter_se_pacote_c_table(cd_estabelecimento_p) (cd_convenio_ww) (cd_procedimento_index_w) (current_setting('smart_schedule_data_process.ie_origem_proced_w')::agenda_integrada_item.ie_origem_proced%TYPE)(current_setting('smart_schedule_data_process.ie_tipo_atendimento_w')::smallint)coalesce(.ie_exec::text, '') = '' THEN
      ie_pacote_item_w := obter_se_pacote_convenio(current_setting('smart_schedule_data_process.cd_procedimento_w')::agenda_integrada_item.cd_procedimento%TYPE, current_setting('smart_schedule_data_process.ie_origem_proced_w')::agenda_integrada_item.ie_origem_proced%TYPE, cd_convenio_ww, cd_estabelecimento_p);
      current_setting('smart_schedule_data_process.obter_se_pacote_c_w')::obter_se_pacote_c_table(cd_estabelecimento_p)(cd_convenio_ww)(cd_procedimento_index_w)(current_setting('smart_schedule_data_process.ie_origem_proced_w')::agenda_integrada_item.ie_origem_proced%TYPE)(current_setting('smart_schedule_data_process.ie_tipo_atendimento_w')::smallint).ie_pacote_item := ie_pacote_item_w;
      current_setting('smart_schedule_data_process.obter_se_pacote_c_w')::obter_se_pacote_c_table(cd_estabelecimento_p)(cd_convenio_ww)(cd_procedimento_index_w)(current_setting('smart_schedule_data_process.ie_origem_proced_w')::agenda_integrada_item.ie_origem_proced%TYPE)(current_setting('smart_schedule_data_process.ie_tipo_atendimento_w')::smallint).ie_exec := 'S';
    ELSE
      ie_pacote_item_w := current_setting('smart_schedule_data_process.obter_se_pacote_c_w')::obter_se_pacote_c_table(cd_estabelecimento_p) (cd_convenio_ww) (cd_procedimento_index_w) (current_setting('smart_schedule_data_process.ie_origem_proced_w')::agenda_integrada_item.ie_origem_proced%TYPE)(current_setting('smart_schedule_data_process.ie_tipo_atendimento_w')::smallint).ie_pacote_item;
    END IF;

    IF (ie_edicao_w = 'N') AND (coalesce(cd_edicao_ajuste_w, 0) = 0) AND (coalesce(current_setting('smart_schedule_data_process.ie_glosa_w')::varchar(1), 'L') = 'L') AND (ie_pacote_item_w = 'N') THEN

      PERFORM set_config('smart_schedule_data_process.ie_glosa_w', 'T', false);
    END IF;

    IF current_setting('smart_schedule_data_process.ie_glosa_w')::varchar(1) = 'E' AND
       coalesce(current_setting('smart_schedule_data_process.ie_param_444_w')::varchar(1), 'N') = 'N' AND
       ie_tipo_convenio_w = '1' THEN
      ie_excluir_valor := 'S';
    END IF;

    IF (ie_edicao_w = 'N') AND (coalesce(cd_edicao_ajuste_w, 0) > 0) AND (coalesce(current_setting('smart_schedule_data_process.ie_glosa_w')::varchar(1), 'L') = 'L') AND (ie_pacote_item_w = 'N') THEN

      SELECT COUNT(*)
        INTO STRICT qt_item_edicao_w
        FROM preco_amb
       WHERE cd_edicao_amb = cd_edicao_ajuste_w
         AND cd_procedimento = current_setting('smart_schedule_data_process.cd_procedimento_w')::agenda_integrada_item.cd_procedimento%TYPE
         AND ie_origem_proced = current_setting('smart_schedule_data_process.ie_origem_proced_w')::agenda_integrada_item.ie_origem_proced%TYPE;

      IF (qt_item_edicao_w = 0) THEN
        PERFORM set_config('smart_schedule_data_process.ie_glosa_w', 'G', false);
      END IF;
    END IF;

    IF (current_setting('smart_schedule_data_process.ie_regra_w')::integer IN (3, 6, 7)) THEN

      SELECT coalesce(MAX(ie_resp_autor), 'H') INTO STRICT ie_resp_autor_w FROM regra_convenio_plano WHERE nr_sequencia = current_setting('smart_schedule_data_process.nr_seq_regra_w')::bigint;

    END IF;

    IF (ie_excluir_valor = 'S') OR
       (((((coalesce(current_setting('smart_schedule_data_process.ie_regra_w')::integer, 0) NOT IN (1, 2, 5)) OR (coalesce(current_setting('smart_schedule_data_process.ie_glosa_w')::varchar(1), '') NOT IN ('T', 'E', 'R', 'B', 'H', 'Z', ''))) AND (ie_tipo_convenio_w <> 1) AND (current_setting('smart_schedule_data_process.ie_calc_glosa_atend_w')::varchar(1) = 'N')) OR
       ((current_setting('smart_schedule_data_process.ie_calc_glosa_atend_w')::varchar(1) = 'S') AND (ie_tipo_convenio_w <> 1) AND ((coalesce(current_setting('smart_schedule_data_process.ie_glosa_w')::varchar(1), '') NOT IN ('T', 'G', 'R')) OR (current_setting('smart_schedule_data_process.ie_glosa_w')::coalesce(varchar(1)::text, '') = '')))) AND (current_setting('smart_schedule_data_process.ie_calcula_glosa_w')::parametro_agenda_integrada.ie_calcula_glosa%TYPE = 'N' OR (current_setting('smart_schedule_data_process.ie_calcula_glosa_w')::parametro_agenda_integrada.ie_calcula_glosa%TYPE = 'S' AND (coalesce(current_setting('smart_schedule_data_process.ie_glosa_w')::varchar(1), '') NOT IN ('P', 'R') OR (current_setting('smart_schedule_data_process.ie_glosa_w')::coalesce(varchar(1)::text, '') = ''))))) THEN

      vl_procedimento_w := 0;
    ELSE
      IF (current_setting('smart_schedule_data_process.ie_glosa_w')::varchar(1) IN ('P', 'R') AND current_setting('smart_schedule_data_process.ie_calcula_glosa_w')::parametro_agenda_integrada.ie_calcula_glosa%TYPE = 'S') THEN

        define_preco_procedimento_vet(cd_estabelecimento_p,
                                      cd_convenio_ww,
                                      current_setting('smart_schedule_data_process.cd_categoria_w')::varchar(10),
                                      coalesce(dt_transferencia_w, dt_inicio_agendamento_p),
                                      current_setting('smart_schedule_data_process.cd_procedimento_w')::agenda_integrada_item.cd_procedimento%TYPE,
                                      0,
                                      coalesce(ie_tipo_atendimento_p, 0),
                                      0,
                                      cd_medico_p, --medico
                                      0,
                                      0,
                                      0,
                                      current_setting('smart_schedule_data_process.nr_seq_proc_interno_w')::bigint,
                                      NULL, --usuario convenio
                                      current_setting('smart_schedule_data_process.cd_plano_w')::agenda_integrada.cd_plano%TYPE,
                                      0,
                                      0,
                                      NULL,
                                      vl_procedimento_w,
                                      vl_custo_operacional_w,
                                      vl_anestesista_w,
                                      vl_medico_w,
                                      vl_auxiliares_w,
                                      vl_materiais_w,
                                      vl_aux_w,
                                      vl_aux_w,
                                      vl_aux_w,
                                      vl_aux_w,
                                      vl_aux_w,
                                      vl_aux_w,
                                      vl_aux_w,
                                      qt_pontos_w,
                                      cd_edicao_amb_w,
                                      ds_aux_w,
                                      nr_seq_ajuste_proc_w,
                                      0,
                                      NULL,
                                      0,
                                      'N',
                                      NULL,
                                      NULL,
                                      NULL,
                                      NULL,
                                      NULL,
                                      cd_especialidade_p,
                                      NULL,
                                      NULL,
                                      NULL,
                                      NULL,
                                      NULL,
                                      NULL,
                                      NULL,
                                      NULL,
                                      NULL,
                                      NULL);

        IF (current_setting('smart_schedule_data_process.ie_glosa_w')::varchar(1) = 'P') THEN
          vl_glosa_w := vl_procedimento_w * pr_glosa_w / 100;

          /* ROTINA DE ARREDONDAMENTO, USADO PELO CONVENIO IPE   --->>    INICIO  <<----- */

          SELECT coalesce(MAX(ie_regra_arredondamento_tx), 'N') INTO STRICT ie_regra_arredondamento_tx_w FROM parametro_faturamento WHERE cd_estabelecimento = cd_estabelecimento_p;

          IF (ie_regra_arredondamento_tx_w = 'S') THEN

            SELECT MAX(ie_arredondamento)
              INTO STRICT ie_tipo_rounded_w
              FROM convenio_estabelecimento
             WHERE cd_convenio = current_setting('smart_schedule_data_process.cd_convenio_w')::integer
               AND cd_estabelecimento = cd_estabelecimento_p;

            IF (ie_tipo_rounded_w = 'R') THEN

              SELECT obter_regra_arredondamento(cd_convenio_ww, current_setting('smart_schedule_data_process.cd_categoria_w')::varchar(10), current_setting('smart_schedule_data_process.cd_procedimento_w')::agenda_integrada_item.cd_procedimento%TYPE, current_setting('smart_schedule_data_process.ie_origem_proced_w')::agenda_integrada_item.ie_origem_proced%TYPE, cd_estabelecimento_p, coalesce(clock_timestamp(), clock_timestamp()), 'P', 1)
                INTO STRICT ie_tipo_rounded_w
;

              ie_regra_arred_ipe_w := 'S';

            END IF;

            IF (ie_tipo_rounded_w IS NOT NULL AND ie_tipo_rounded_w::text <> '') AND (ie_regra_arred_ipe_w = 'S') THEN

              arredondamento(vl_glosa_w, 2, ie_tipo_rounded_w);

            END IF;

          END IF;

          IF (vl_glosa_w > 0) THEN
            vl_procedimento_w := vl_procedimento_w - vl_glosa_w;
          END IF;
        ELSE
          vl_procedimento_w := vl_glosa_w;
        END IF;
      ELSE

        IF (ie_tipo_convenio_w <> 1) THEN
          SELECT MAX(cd_convenio_partic),
                 MAX(cd_categoria_partic)
            INTO STRICT current_setting('smart_schedule_data_process.cd_convenio_w')::integer,
                 current_setting('smart_schedule_data_process.cd_categoria_w')::varchar(10)
            FROM parametro_faturamento
           WHERE cd_estabelecimento = cd_estabelecimento_p;

          IF (current_setting('smart_schedule_data_process.cd_convenio_w')::(integer IS NOT NULL AND integer::text <> '')) THEN
            SELECT MAX(cd_plano)
              INTO STRICT current_setting('smart_schedule_data_process.cd_plano_w')::agenda_integrada.cd_plano%TYPE
              FROM convenio_plano
             WHERE cd_convenio = current_setting('smart_schedule_data_process.cd_convenio_w')::integer
               AND ie_situacao = 'A';
          END IF;
        END IF;

        IF (current_setting('smart_schedule_data_process.cd_convenio_w')::coalesce(integer::text, '') = '') THEN
          PERFORM set_config('smart_schedule_data_process.cd_convenio_w', cd_convenio_ww, false);
          PERFORM set_config('smart_schedule_data_process.cd_categoria_w', current_setting('smart_schedule_data_process.cd_categoria_w')::varchar(10), false);
          PERFORM set_config('smart_schedule_data_process.cd_plano_w', current_setting('smart_schedule_data_process.cd_plano_w')::agenda_integrada.cd_plano%TYPE, false);
        END IF;

        define_preco_procedimento_vet(cd_estabelecimento_p,
                                      current_setting('smart_schedule_data_process.cd_convenio_w')::integer,
                                      current_setting('smart_schedule_data_process.cd_categoria_w')::varchar(10),
                                      coalesce(dt_transferencia_w, dt_inicio_agendamento_p),
                                      current_setting('smart_schedule_data_process.cd_procedimento_w')::agenda_integrada_item.cd_procedimento%TYPE,
                                      0,
                                      coalesce(ie_tipo_atendimento_p, 0),
                                      0,
                                      cd_medico_p, --medico
                                      0,
                                      0,
                                      0,
                                      current_setting('smart_schedule_data_process.nr_seq_proc_interno_w')::bigint,
                                      NULL, --usuario convenio
                                      current_setting('smart_schedule_data_process.cd_plano_w')::agenda_integrada.cd_plano%TYPE,
                                      0,
                                      0,
                                      NULL,
                                      vl_procedimento_w,
                                      vl_custo_operacional_w,
                                      vl_anestesista_w,
                                      vl_medico_w,
                                      vl_auxiliares_w,
                                      vl_materiais_w,
                                      vl_aux_w,
                                      vl_aux_w,
                                      vl_aux_w,
                                      vl_aux_w,
                                      vl_aux_w,
                                      vl_aux_w,
                                      vl_aux_w,
                                      qt_pontos_w,
                                      cd_edicao_amb_w,
                                      ds_aux_w,
                                      nr_seq_ajuste_proc_w,
                                      0,
                                      NULL,
                                      0,
                                      'N',
                                      NULL,
                                      NULL,
                                      NULL,
                                      NULL,
                                      NULL,
                                      cd_especialidade_p,
                                      NULL,
                                      NULL,
                                      NULL,
                                      NULL,
                                      NULL,
                                      NULL,
                                      NULL,
                                      NULL,
                                      NULL,
                                      NULL);

        IF (current_setting('smart_schedule_data_process.ie_calcula_lanc_auto_w')::varchar(1) <> 'N') THEN
          ageint_calcular_lanc_aut(cd_estabelecimento_p,
                                   current_setting('smart_schedule_data_process.cd_convenio_w')::integer,
                                   current_setting('smart_schedule_data_process.cd_categoria_w')::varchar(10),
                                   clock_timestamp(),
                                   NULL,
                                   current_setting('smart_schedule_data_process.cd_procedimento_w')::agenda_integrada_item.cd_procedimento%TYPE,
                                   current_setting('smart_schedule_data_process.ie_origem_proced_w')::agenda_integrada_item.ie_origem_proced%TYPE,
                                   NULL,
                                   NULL,
                                   current_setting('smart_schedule_data_process.qt_idade_w')::bigint,
                                   NULL,
                                   0,
                                   current_setting('smart_schedule_data_process.nr_seq_proc_interno_w')::bigint,
                                   ie_tipo_atendimento_p,
                                   NULL,
                                   cd_usuario_convenio_p,
                                   current_setting('smart_schedule_data_process.cd_plano_w')::agenda_integrada.cd_plano%TYPE,
                                   NULL,
                                   NULL,
                                   4,
                                   NULL,
                                   cd_edicao_amb_w,
                                   vl_lanc_autom_w);
        END IF;
      END IF;
    END IF;

    IF (current_setting('smart_schedule_data_process.ie_vl_particular_w')::varchar(1) = 'S') THEN
      obter_convenio_particular(cd_estabelecimento_p, current_setting('smart_schedule_data_process.cd_convenio_w')::integer, current_setting('smart_schedule_data_process.cd_categoria_w')::varchar(10));

      define_preco_procedimento_vet(cd_estabelecimento_p,
                                    current_setting('smart_schedule_data_process.cd_convenio_w')::integer,
                                    current_setting('smart_schedule_data_process.cd_categoria_w')::varchar(10),
                                    coalesce(dt_transferencia_w, dt_inicio_agendamento_p),
                                    current_setting('smart_schedule_data_process.cd_procedimento_w')::agenda_integrada_item.cd_procedimento%TYPE,
                                    0,
                                    coalesce(ie_tipo_atendimento_p, 0),
                                    0,
                                    cd_medico_p, --medico
                                    0,
                                    0,
                                    0,
                                    current_setting('smart_schedule_data_process.nr_seq_proc_interno_w')::bigint,
                                    NULL, --usuario convenio
                                    NULL,
                                    0,
                                    0,
                                    NULL,
                                    vl_procedimento_w,
                                    vl_custo_operacional_w,
                                    vl_anestesista_w,
                                    vl_medico_w,
                                    vl_auxiliares_w,
                                    vl_materiais_w,
                                    vl_aux_w,
                                    vl_aux_w,
                                    vl_aux_w,
                                    vl_aux_w,
                                    vl_aux_w,
                                    vl_aux_w,
                                    vl_aux_w,
                                    qt_pontos_w,
                                    cd_edicao_amb_w,
                                    ds_aux_w,
                                    nr_seq_ajuste_proc_w,
                                    0,
                                    NULL,
                                    0,
                                    'N',
                                    NULL,
                                    NULL,
                                    NULL,
                                    NULL,
                                    NULL,
                                    cd_especialidade_p,
                                    NULL,
                                    NULL,
                                    NULL,
                                    NULL,
                                    NULL,
                                    NULL,
                                    NULL,
                                    NULL,
                                    NULL,
                                    NULL);
    END IF;

    IF (current_setting('smart_schedule_data_process.ie_calcula_lanc_auto_w')::varchar(1) = 'S') THEN
      vl_item_w := vl_procedimento_w + coalesce(vl_lanc_autom_w, 0);
    ELSE
      vl_item_w := vl_procedimento_w;
    END IF;

    vl_retorno_w := vl_item_w;

    RETURN vl_retorno_w;
  END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION smart_schedule_data_process.ageint_obter_valor_item_vet (cd_convenio_p bigint, cd_categoria_p text, cd_plano_p text, nr_seq_proc_interno_p bigint, cd_estabelecimento_p bigint, qt_idade_p bigint, ie_tipo_atendimento_p bigint, ie_sexo_p text, cd_pessoa_fisica_p text, dt_nascimento_p timestamp, nr_seq_cobertura_p bigint, dt_inicio_agendamento_p timestamp, cd_usuario_convenio_p text, cd_medico_p text DEFAULT NULL, cd_especialidade_p bigint DEFAULT NULL) FROM PUBLIC;
