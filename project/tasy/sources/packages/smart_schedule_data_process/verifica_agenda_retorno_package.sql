-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE smart_schedule_data_process.verifica_agenda_retorno (dt_agenda_p timestamp, cd_pessoa_fisica_p text, cd_convenio_p bigint, nm_usuario_p text, cd_agenda_p bigint, nr_seq_ageint_item_p bigint, cd_medico_p text, ie_retorno_p INOUT text, ie_bloq_agen_p INOUT text, ie_classif_retorno_p INOUT text) AS $body$
DECLARE


      current_setting('smart_schedule_data_process.ie_retorno_w')::varchar(1)              varchar(1) := 'N';
      ds_hash_params_w          varchar(300);
      current_setting('smart_schedule_data_process.ds_retorno_w')::varchar(4000)              varchar(4000);
      current_setting('smart_schedule_data_process.ie_classif_retorno_w')::varchar(10)      varchar(10);
      nr_atendimento_consulta_w bigint;
      nr_seq_regra_msg_w        bigint;
      ds_msg_regra_w            varchar(2000);
      current_setting('smart_schedule_data_process.ie_bloq_agen_w')::varchar(1)            varchar(1);


BEGIN
      ds_hash_params_w := 'dt_agenda_p=' || to_char(dt_agenda_p, 'dd/mm/yyyy') || ',cd_pessoa_fisica_p=' || cd_pessoa_fisica_p || ',cd_convenio_p=' || cd_convenio_p || ',cd_agenda_p=' || cd_agenda_p ||
                          ',nr_seq_ageint_item_p=' || nr_seq_ageint_item_p || ',cd_medico_p=' || cd_medico_p;

      IF (current_setting('smart_schedule_data_process.vetor_agenda_retorno_w')::vetor_agenda_retorno.exists(ds_hash_params_w)) THEN
        PERFORM set_config('smart_schedule_data_process.ie_retorno_w', current_setting('smart_schedule_data_process.vetor_agenda_retorno_w')::vetor_agenda_retorno[ds_hash_params_w].ie_retorno, false);
        PERFORM set_config('smart_schedule_data_process.ie_bloq_agen_w', current_setting('smart_schedule_data_process.vetor_agenda_retorno_w')::vetor_agenda_retorno[ds_hash_params_w].ie_bloq_agen, false);
        PERFORM set_config('smart_schedule_data_process.ie_classif_retorno_w', current_setting('smart_schedule_data_process.vetor_agenda_retorno_w')::vetor_agenda_retorno[ds_hash_params_w].ie_classif_retorno, false);
      ELSE
        identifica_agenda_retorno(dt_agenda_p,
                                  cd_pessoa_fisica_p,
                                  cd_convenio_p,
                                  nm_usuario_p,
                                  cd_agenda_p,
                                  nr_seq_ageint_item_p,
                                  current_setting('smart_schedule_data_process.ds_retorno_w')::varchar(4000),
                                  current_setting('smart_schedule_data_process.ie_classif_retorno_w')::varchar(10),
                                  nr_atendimento_consulta_w,
                                  nr_seq_regra_msg_w,
                                  ds_msg_regra_w,
                                  current_setting('smart_schedule_data_process.ie_bloq_agen_w')::varchar(1),
                                  cd_medico_p);

        IF ((current_setting('smart_schedule_data_process.ie_bloq_agen_w')::varchar(1) <> 'S') OR (coalesce(nr_seq_regra_msg_w::text, '') = '') OR (current_setting('smart_schedule_data_process.ds_retorno_w')::coalesce(varchar(4000)::text, '') = '')) THEN
          PERFORM set_config('smart_schedule_data_process.ie_bloq_agen_w', 'N', false);
        END IF;

        IF (current_setting('smart_schedule_data_process.ds_retorno_w')::(varchar(4000) IS NOT NULL AND (varchar(4000))::text <> '')) THEN
          PERFORM set_config('smart_schedule_data_process.ie_retorno_w', 'S', false);
        END IF;

        current_setting('smart_schedule_data_process.vetor_agenda_retorno_w')::vetor_agenda_retorno[ds_hash_params_w].ie_retorno := current_setting('smart_schedule_data_process.ie_retorno_w')::varchar(1);
        current_setting('smart_schedule_data_process.vetor_agenda_retorno_w')::vetor_agenda_retorno[ds_hash_params_w].ie_bloq_agen := current_setting('smart_schedule_data_process.ie_bloq_agen_w')::varchar(1);
        current_setting('smart_schedule_data_process.vetor_agenda_retorno_w')::vetor_agenda_retorno[ds_hash_params_w].ie_classif_retorno := current_setting('smart_schedule_data_process.ie_classif_retorno_w')::varchar(10);
      END IF;

      ie_retorno_p         := current_setting('smart_schedule_data_process.ie_retorno_w')::varchar(1);
      ie_bloq_agen_p       := current_setting('smart_schedule_data_process.ie_bloq_agen_w')::varchar(1);
      ie_classif_retorno_p := current_setting('smart_schedule_data_process.ie_classif_retorno_w')::varchar(10);
    END;


$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE smart_schedule_data_process.verifica_agenda_retorno (dt_agenda_p timestamp, cd_pessoa_fisica_p text, cd_convenio_p bigint, nm_usuario_p text, cd_agenda_p bigint, nr_seq_ageint_item_p bigint, cd_medico_p text, ie_retorno_p INOUT text, ie_bloq_agen_p INOUT text, ie_classif_retorno_p INOUT text) FROM PUBLIC;
