-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

-- insere as inconsistencias
CREATE OR REPLACE PROCEDURE ptu_a1200_imp_pck.insere_inconsistencias ( t_inconsistencia_p t_inconsistencia_type, nr_seq_ptu_pacote_p ptu_pacote.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nr_sequencia_p bigint, nm_tabela_p text) AS $body$
DECLARE


l_index varchar(50);
		

BEGIN	
	l_index := t_inconsistencia_p.FIRST;
	
	while (l_index IS NOT NULL AND l_index::text <> '') loop
	
		insert into ptu_pacote_inc(	nr_sequencia,
						nr_seq_ptu_pacote, 
						cd_estabelecimento, 
						dt_atualizacao, 
						nm_usuario, 
						ds_inconsistencia,
						nr_seq_pacote_reg,
						nr_seq_pacote_servico,
						nr_seq_pacote_prest)
		values (	nextval('ptu_pacote_inc_seq'),
				nr_seq_ptu_pacote_p, 
				cd_estabelecimento_p,
				clock_timestamp(),
				nm_usuario_p, 			 
				obter_desc_expressao(t_inconsistencia_p(l_index)),
				CASE WHEN nm_tabela_p='ptu_pacote_reg' THEN      nr_sequencia_p  ELSE null END ,
				CASE WHEN nm_tabela_p='ptu_pacote_servico' THEN  nr_sequencia_p  ELSE null END ,
				CASE WHEN nm_tabela_p='ptu_pacote_prest' THEN    nr_sequencia_p  ELSE null END );
		
		
		if (nm_tabela_p = 'ptu_pacote_reg') then
		
			update 	ptu_pacote_reg set ie_inconsistencia = 'S'
			where 	nr_sequencia = nr_sequencia_p;
			
		elsif (nm_tabela_p = 'ptu_pacote_servico') then
			
			update 	ptu_pacote_servico set ie_inconsistencia = 'S'
			where 	nr_sequencia = nr_sequencia_p;
			
		elsif (nm_tabela_p = 'ptu_pacote_prest') then
		
			update 	ptu_pacote_prest set ie_inconsistencia = 'S'
			where 	nr_sequencia = nr_sequencia_p;
			
		end if;
		
		l_index := t_inconsistencia_p.next(l_index);
		
	end loop;
	
	update ptu_pacote set ie_inconsistencia = 'S' where nr_sequencia = nr_seq_ptu_pacote_p;
	
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ptu_a1200_imp_pck.insere_inconsistencias ( t_inconsistencia_p t_inconsistencia_type, nr_seq_ptu_pacote_p ptu_pacote.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nr_sequencia_p bigint, nm_tabela_p text) FROM PUBLIC;
