-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


	/**
	+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	Information for female 
	unique_key_p - encounter_number
	-- It contains the patient's  pregnancy information and aid classification, fetched from EPC/patient registration. 
	+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	**/
CREATE OR REPLACE PROCEDURE carestream_japan_l10n_pck.patient_pregnant_info (unique_key_p text, message_data INOUT text) AS $body$
DECLARE

    c10 CURSOR FOR
    SELECT
            CASE
                WHEN( coalesce(b.ie_paciente_gravida, 'N') = 'S'
                       OR coalesce(a.ie_pac_gravida, 'N') = 'S' ) THEN
                    '2'
                WHEN( coalesce(b.ie_paciente_gravida, 'N') = 'N'
                       OR coalesce(a.ie_pac_gravida, 'N') = 'N' ) THEN
                    '0'
                ELSE
                    '1'
            END pregnant_flag,

            case
                when(a.qt_sem_ig_cronologica IS NOT NULL AND a.qt_sem_ig_cronologica::text <> '') then
                    lpad(a.qt_sem_ig_cronologica, 2, 0)
                when(b.qt_ig_semana IS NOT NULL AND b.qt_ig_semana::text <> '') then
                    lpad(b.qt_ig_semana, 2, 0)
                else
                ' '
                end pregnant_week_count,
            CASE WHEN coalesce(b.nr_seq_forma_chegada::text, '') = '' THEN ' '  ELSE b.nr_seq_forma_chegada END  aid_classification
        FROM historico_saude_mulher   a,
            atendimento_paciente     b
        WHERE
            a.cd_pessoa_fisica = b.cd_pessoa_fisica
            AND ( ( coalesce(a.dt_fim_gestacao::text, '') = '' )
                  OR ( a.dt_fim_gestacao > clock_timestamp() ) )
            AND b.nr_atendimento = unique_key_p
            AND a.nr_sequencia = ( SELECT MAX(a.nr_sequencia)
                                    FROM historico_saude_mulher a
                                    WHERE cd_pessoa_fisica = obter_pessoa_atendimento(unique_key_p, 'C'));

        r_c10 c10%ROWTYPE;
	
BEGIN
    
        PERFORM set_config('carestream_japan_l10n_pck.ds_line_w', null, false);
        open c10;
		fetch c10 into r_c10;
        if (c10%NOTFOUND) then
            CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_japan_l10n_pck.append_text('0', 1); -- PREGNANT_FLG
            CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_japan_l10n_pck.append_text(' ', 2); -- PREGNANT_MNT
        else
              CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_japan_l10n_pck.append_text(r_c10.PREGNANT_FLAG, 1); -- PREGNANT_FLG
			  CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_japan_l10n_pck.append_text(r_c10.PREGNANT_WEEK_COUNT, 2); -- PREGNANT_MNT
        end if;
        close c10;
		message_data := current_setting('carestream_japan_l10n_pck.ds_line_w')::varchar(32767);		
	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE carestream_japan_l10n_pck.patient_pregnant_info (unique_key_p text, message_data INOUT text) FROM PUBLIC;
