-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


	/**
	+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	Patient Basic Information 
	unique_key_p - encounter number
	+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	**/
CREATE OR REPLACE PROCEDURE carestream_japan_l10n_pck.patient_basic_info (unique_key_p text, message_data INOUT text) AS $body$
DECLARE


	c02 CURSOR FOR
        SELECT a.* , CASE WHEN coalesce(a.patient_height::text, '') = '' THEN ' '  ELSE a.patient_height END  patient_height_cms , 
            CASE WHEN coalesce(a.patient_weight::text, '') = '' THEN ' '  ELSE a.patient_weight END  patient_weight_kg,
            CASE WHEN coalesce(a.patient_weight::text, '') = '' THEN ' '  ELSE '1' END  weight_unit,  -- always sending in kg
            coalesce(lpad(a.cd_room,4,'0'), ' ') room_code,
            coalesce(a.height_record_date, record_update_date) patient_height_record_date,
            coalesce(a.weight_record_date, record_update_date) patient_weight_record_date
             from ( SELECT
                obter_prontuario_paciente(a.patient_id) patient_mrn,
                a.patient_id patient_id,
                b.encounter_id encounter_number,
                (select p.DS_GIVEN_NAME || ' ' || p.DS_FAMILY_NAME from person_name p where p.DS_TYPE = 'translated' and p.nr_sequencia = c.nr_seq_person_name and c.cd_pessoa_fisica = a.patient_id) patient_name_kana,
                coalesce(a.patient_name, ' ') patient_name_kanji,
                coalesce(CASE WHEN a.sex_id='I' THEN 'U' WHEN a.sex_id='D' THEN 'O'  ELSE a.sex_id END , ' ') patient_sex,
                coalesce(to_char(a.date_of_birth,'YYYYMMDD'), ' ') patient_birth_date,
                case
                when(a.death_date IS NOT NULL AND a.death_date::text <> '') then '9'
                when(get_status_bed_patient(b.encounter_id, a.patient_id) = 'R') then '2'
                when(b.encouter_admit_date IS NOT NULL AND b.encouter_admit_date::text <> '') then '1'
                else ' '
                end  patient_status,
                coalesce(lpad(CASE WHEN b.type_encounter_id=1 THEN b.room_id END ,4,'0'), ' ') cd_room,
                CASE WHEN b.type_encounter_id=1 THEN b.room_id  ELSE ' ' END  room_name,
                coalesce(a.postal_code,' ') postal_code,
                coalesce(substr( a.street_name ||','|| a.patient_address || ',' || a.city_name || ',' || a.state_description || ',' ||  a.country_desc , 1,80) ,' ') patient_address,
                coalesce(a.home_phone_number,' ') phone_number,
                coalesce(a.abo_system,' ') blood_group,
                coalesce(a.rh_system,' ') blood_group_rh,
                coalesce(obter_sinal_vital(b.encounter_id,'ALTURA'), a.height_cm) patient_height,
                (select to_char(x.dt_sinal_vital ,'YYYYMMDD') from atendimento_sinal_vital x
                    where x.nr_sequencia = (select	coalesce(max(nr_sequencia),-1)
                                            from	atendimento_sinal_vital
                                            where	(qt_altura_cm IS NOT NULL AND qt_altura_cm::text <> '')
                                            and	nr_atendimento	= unique_key_p
                                            and	coalesce(ie_situacao,'A') = 'A'
                                            and	coalesce(IE_RN,'N')	= 'N')) height_record_date,
                coalesce(obter_sinal_vital(b.encounter_id,'PESO'), a.weight_kg) patient_weight,
                (select to_char(x.dt_sinal_vital ,'YYYYMMDD') from atendimento_sinal_vital x
                    where x.nr_sequencia = (select	coalesce(max(nr_sequencia),-1)
                                            from	atendimento_sinal_vital
                                            where	(qt_peso IS NOT NULL AND qt_peso::text <> '')
                                            and	nr_atendimento	= unique_key_p
                                            and	coalesce(ie_situacao,'A') = 'A'
                                            and	coalesce(IE_RN,'N')	= 'N')) weight_record_date,
                coalesce(to_char(c.dt_atualizacao ,'YYYYMMDD'), ' ') record_update_date   
		from bft_patient_v a, bft_encounter_v b ,  pessoa_fisica c
        where a.patient_id = b.patient_id
            and c.cd_pessoa_fisica = a.patient_id
			and b.encounter_id = unique_key_p  LIMIT 1)a;

		
BEGIN 	
            PERFORM set_config('carestream_japan_l10n_pck.ds_line_w', null, false);
			for r_c02 in c02 loop
				begin
					CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_japan_l10n_pck.append_text(r_c02.patient_mrn, 10, 'L', '0'); -- PT_ID
					CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_japan_l10n_pck.append_text(r_c02.PATIENT_NAME_KANA, 23, 'R', ' '); -- PT_KN_NAME
					CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_japan_l10n_pck.append_text(r_c02.PATIENT_NAME_KANJI, 20, 'R', ' '); -- PT_KJ_NAME
					CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_japan_l10n_pck.append_text(r_c02.PATIENT_SEX, 1); -- PT_SEX
					CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_japan_l10n_pck.append_text(r_c02.PATIENT_BIRTH_DATE, 8); -- PT_BIRTH
					CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_japan_l10n_pck.append_text(r_c02.PATIENT_STATUS,1); -- PT_STATUS
					CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_japan_l10n_pck.append_text(r_c02.ROOM_CODE, 4); -- ROOM_CD
					CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_japan_l10n_pck.append_text(r_c02.ROOM_NAME, 20, 'R', ' '); -- ROOM_NAME
					CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_japan_l10n_pck.append_text(r_c02.POSTAL_CODE , 8); -- PT_ZIP
					CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_japan_l10n_pck.append_text(r_c02.PATIENT_ADDRESS, 80, 'R', ' '); -- PT_ADDR 
					CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_japan_l10n_pck.append_text(' ', 8); -- PT_ADDR_CD
					CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_japan_l10n_pck.append_text(r_c02.PHONE_NUMBER, 18 ); -- PT_TEL
					CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_japan_l10n_pck.append_text('1' , 1); -- FILLER_1
					CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_japan_l10n_pck.append_text(' ', 22); -- FILLER_2, FILLER_3, FILLER_4
					CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_japan_l10n_pck.append_text(r_c02.BLOOD_GROUP, 2); -- BLOOD_GROUP
					CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_japan_l10n_pck.append_text(r_c02.BLOOD_GROUP_RH, 1); -- BLOOD_GROUP_RH
					CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_japan_l10n_pck.append_text(r_c02.patient_height_cms, 8,'R'); -- PATIENT_HEIGHT
                    CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_japan_l10n_pck.append_text(r_c02.patient_height_record_date, 8); -- PATIENT_HEIGHT_RECORD_DATE
					CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_japan_l10n_pck.append_text(r_c02.patient_weight_kg, 8, 'R'); -- PATIENT_WEIGHT
                    CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_japan_l10n_pck.append_text(r_c02.patient_weight_record_date, 8); -- PATIENT_WEIGHT_RECORD_DATE
					CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_japan_l10n_pck.append_text(r_c02.WEIGHT_UNIT, 1); -- WEIGHT_UNIT
					CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_japan_l10n_pck.append_text(' ', 20); -- FILLER_5
				end;
			end loop;

            message_data := current_setting('carestream_japan_l10n_pck.ds_line_w')::varchar(32767);

	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE carestream_japan_l10n_pck.patient_basic_info (unique_key_p text, message_data INOUT text) FROM PUBLIC;
