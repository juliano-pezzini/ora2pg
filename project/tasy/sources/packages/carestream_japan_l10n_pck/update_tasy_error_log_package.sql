-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


   
     /** 
	+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	Update the tasy log to error status if file is present in respective error folder
	+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
   **/
 


CREATE OR REPLACE PROCEDURE carestream_japan_l10n_pck.update_tasy_error_log (file_name_p text, file_like_p text, nr_seq_event_p text) AS $body$
DECLARE

       nr_seq_int_call_log_w integration_call_log.nr_sequencia%type;
       nm_interface_w	integration_call_log.nm_interface%type;
       nm_message_w		integration_call_log.nm_message%type;
       ds_error_w		integration_message_log.ds_error%type;
       ie_message_type_w integration_call_log.ie_message_type%type;
       nr_seq_evento_int_w integration_call_log.nr_seq_evento_int%type;
       cd_event_parent_seq_w integration_call_log.cd_event_parent_seq%type;
       ds_notes_w        integration_call_log.ds_notes%type;
       message_data_w varchar(32767);

BEGIN
    if (file_name_p like file_like_p||'%')then
        select nr_sequencia, 
               nm_message, 
               nm_interface, 
               ie_message_type,
               cd_event_parent_seq,
               nr_seq_evento_int,
               ds_notes
        into STRICT   nr_seq_int_call_log_w,
               nm_message_w,
               nm_interface_w,
               ie_message_type_w,
               cd_event_parent_seq_w,
               nr_seq_evento_int_w,
               ds_notes_w
        from  integration_call_log where nr_sequencia = (  SELECT max(nr_seq_int_call_log)
                                                           from integration_message_log a 
                                                           where a.ds_message_id = file_name_p);

        message_data_w := carestream_japan_l10n_pck.read_file(file_name_p, file_like_p, nr_seq_event_p, message_data_w);

        ds_error_w := 'Error occured in file' || file_name_p ||' , Time of Error' || clock_timestamp();

        record_integration_call_log('carestream_tasy', 'carestream_tasy', clock_timestamp()	, nm_interface_w, nm_message_w,
                                    'E', ie_message_type_w, null, ds_notes_w, message_data_w, 
                                    ds_error_w, file_name_p, nr_seq_int_call_log_w, cd_event_parent_seq_w, nr_seq_evento_int_w);
   end if;
   END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE carestream_japan_l10n_pck.update_tasy_error_log (file_name_p text, file_like_p text, nr_seq_event_p text) FROM PUBLIC;
