-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


	/**
	+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	Disabilities / Physical motility information  OCCURS(n)
	unique_key - patient id
	+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	**/
	


CREATE OR REPLACE PROCEDURE carestream_japan_l10n_pck.patient_disabilities_info (unique_key_p text, message_data INOUT text) AS $body$
DECLARE

	c04 CURSOR FOR
		SELECT
            coalesce(count(*) over (), '0') total_count_row,
            CASE WHEN coalesce(a.nr_seq_tipo_def::text, '') = '' THEN  ' '  ELSE a.nr_seq_tipo_def END  disability_code,
            coalesce(to_char(a.dt_atualizacao, 'YYYYMMDD'), ' ') disability_diagnosis_date,
            coalesce(b.ds_deficiencia, ' ') disability_name,
            CASE WHEN a.ie_situacao='A' THEN  '+' WHEN a.ie_situacao='I' THEN  '-'  ELSE ' ' END  disability_status
        from
            pf_tipo_deficiencia   a,
            tipo_deficiencia      b
        where
            b.nr_sequencia = a.nr_seq_tipo_def
            and a.cd_pessoa_fisica = unique_key_p
            and (a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
            and coalesce(a.dt_inativacao::text, '') = '';

        r_count c04%ROWTYPE;

        
BEGIN 
        
        PERFORM set_config('carestream_japan_l10n_pck.ds_line_w', null, false);
        open c04;
		fetch c04 into r_count;
        if (c04%NOTFOUND) then
         CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_japan_l10n_pck.append_text(0, 5, 'L', '0'); -- SG_NUM
         else
         CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_japan_l10n_pck.append_text(r_count.total_count_row, 5, 'L', '0'); -- SG_NUM
         end if;
        close c04;

		for r_c04 in c04 loop
            begin
                CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_japan_l10n_pck.append_text(r_c04.DISABILITY_CODE, 4, 'L', '0'); --  SG_CD
                CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_japan_l10n_pck.append_text(r_c04.disability_diagnosis_date, 8); -- LAST_IN_DATE
                CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_japan_l10n_pck.append_text(r_c04.disability_name, 20, 'R', ' '); -- SG_NAME
                CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_japan_l10n_pck.append_text(r_c04.disability_status, 1); -- VALUE
            end;
        end loop;
		message_data := current_setting('carestream_japan_l10n_pck.ds_line_w')::varchar(32767);
	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE carestream_japan_l10n_pck.patient_disabilities_info (unique_key_p text, message_data INOUT text) FROM PUBLIC;
