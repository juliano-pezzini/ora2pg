-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE carestream_japan_l10n_pck.update_exam_execution_status (nr_prescricao_p bigint, nr_sequencia_p bigint, ie_status_report_p text, nm_usuario_p text) AS $body$
DECLARE


    nr_prescricao_w prescr_procedimento.nr_prescricao%TYPE;
    nr_sequencia_w bigint;
    ie_status_report_w smallint;
    is_record_compl_exis_w  varchar(1);

    
BEGIN

        select CASE WHEN count(*)=0 THEN  'N'  ELSE 'S' END 
        into STRICT   is_record_compl_exis_w
        from   prescr_procedimento a,
               prescr_procedimento_compl b
        where  a.nr_prescricao = nr_prescricao_p 
        and    a.nr_sequencia =  nr_sequencia_p
        and    a.nr_seq_proc_compl = b.nr_sequencia;

        if (is_record_compl_exis_w <> 'S') then

            select nextval('prescr_procedimento_compl_seq')
            into STRICT 	nr_sequencia_w
;

            insert into prescr_procedimento_compl( nr_sequencia,
                dt_atualizacao,
                nm_usuario,
                dt_atualizacao_nrec,
                nm_usuario_nrec,
                ie_status_report ) 
            values ( 
                nr_sequencia_w,
                clock_timestamp(),
                nm_usuario_p,
                clock_timestamp(),
                nm_usuario_p,
                ie_status_report_p);

                update prescr_procedimento
                set nr_seq_proc_compl = nr_sequencia_w,
                    nm_usuario = nm_usuario_p,
                    dt_atualizacao = clock_timestamp()
                where nr_prescricao = nr_prescricao_p 
                and nr_sequencia = nr_sequencia_p;
                
        else
            select a.nr_seq_proc_compl
            into STRICT   nr_sequencia_w
            from   prescr_procedimento a
            where  a.nr_prescricao = nr_prescricao_p 
            and    a.nr_sequencia =  nr_sequencia_p;

            update prescr_procedimento_compl
            set	   ie_status_report = ie_status_report_p,
                    nm_usuario = nm_usuario_p,
                    dt_atualizacao = clock_timestamp()
            where  nr_sequencia = nr_sequencia_w;
        end if;
        commit;
    END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE carestream_japan_l10n_pck.update_exam_execution_status (nr_prescricao_p bigint, nr_sequencia_p bigint, ie_status_report_p text, nm_usuario_p text) FROM PUBLIC;
