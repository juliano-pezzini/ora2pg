-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


	/**
	+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	Allergy information  OCCURS(n)
	unique_key_p - patient id
	+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	**/
	


CREATE OR REPLACE PROCEDURE carestream_japan_l10n_pck.patient_allergy_info (unique_key_p text, message_data INOUT text) AS $body$
DECLARE


	c03 CURSOR FOR
		SELECT coalesce(a.total_count_row,'0') total_count_row, 
               CASE WHEN coalesce(a.allergy_group::text, '') = '' THEN ' '  ELSE a.allergy_group END  allergy_group,
               coalesce(to_char(a.allergy_diagnosis_date, 'YYYYMMDD'),' ') allergy_diagnosis_date,
               coalesce(a.allergy_code,' ') allergy_code,
               coalesce(a.allergy_name,' ') allergy_name,
               a.allergy_current_status allergy_current_status,
               coalesce(a.notes,' ') notes
               from
        (SELECT 
           count(*) over () total_count_row,
            a.dt_registro allergy_diagnosis_date,
            a.nr_seq_tipo allergy_group,
			b.ds_tipo_alergia ds_allergy_group,
			coalesce(substr(coalesce(coalesce(coalesce(coalesce(a.nr_seq_dcb,
                a.cd_material),
                a.cd_classe_mat),
                a.nr_seq_ficha_tecnica),a.nr_seq_familia),1,255), a.cd_doenca) allergy_code,

			coalesce(substr(coalesce(coalesce(coalesce(coalesce(obter_desc_dcb(a.nr_seq_dcb),
						substr(obter_desc_material(a.cd_material),1,254)),
						substr(obter_desc_classe_mat(a.cd_classe_mat),1,255)),
						obter_desc_ficha_tecnica(a.nr_seq_ficha_tecnica)),obter_desc_familia_mat(a.nr_seq_familia)),1,255), obter_desc_cid_doenca(a.cd_doenca)) allergy_name,
			a.ds_observacao notes,
			case
			when(coalesce(dt_fim::text, '') = '' and ie_confirmacao = 'C') then '+'
			when ((a.dt_fim IS NOT NULL AND a.dt_fim::text <> '') and (clock_timestamp() between coalesce(a.dt_inicio,clock_timestamp() - interval '1 days') and a.dt_fim)) then '-'
			when(coalesce(ie_confirmacao, 'S') = 'S') then ' '
			end  allergy_current_status
		from	paciente_alergia a 
				left outer join tipo_alergia b
		on  	a.nr_seq_tipo = b.nr_sequencia
		where		coalesce(a.dt_inativacao::text, '') = ''
			and     (a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
			and     cd_pessoa_fisica = unique_key_p)a;
        r_count c03%ROWTYPE;


BEGIN 
        PERFORM set_config('carestream_japan_l10n_pck.ds_line_w', null, false);

        open c03;
		fetch c03 into r_count;
            if (c03%NOTFOUND) then
                CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_japan_l10n_pck.append_text(0, 5, 'L', '0'); -- ALG_NUM
             else
                CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_japan_l10n_pck.append_text(r_count.total_count_row, 5, 'L', '0'); -- ALG_NUM
         end if;
        close c03;

		for r_c03 in c03 loop
            begin
                CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_japan_l10n_pck.append_text(r_c03.allergy_group, 4, 'L', '0'); -- ALG_GRP
                CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_japan_l10n_pck.append_text(r_c03.allergy_code, 4, 'L', '0'); -- ALG_CD
                CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_japan_l10n_pck.append_text(r_c03.allergy_diagnosis_date, 8); -- LAST_IN_DATE
                CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_japan_l10n_pck.append_text(r_c03.allergy_name, 20, 'R', ' '); -- ALG_NAME
                CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_japan_l10n_pck.append_text(r_c03.allergy_current_status, 1); -- VALUE
                CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_japan_l10n_pck.append_text(r_c03.notes,100); -- PT_STATUS 
            end;
        end loop;

		message_data := current_setting('carestream_japan_l10n_pck.ds_line_w')::varchar(32767);

	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE carestream_japan_l10n_pck.patient_allergy_info (unique_key_p text, message_data INOUT text) FROM PUBLIC;
