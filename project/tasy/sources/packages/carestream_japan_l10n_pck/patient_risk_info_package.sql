-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


	/**
	+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	Risk factor information OCCURS(n)
	unique_key_p - patient_id
	+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	**/
CREATE OR REPLACE PROCEDURE carestream_japan_l10n_pck.patient_risk_info (unique_key_p text, message_data INOUT text) AS $body$
DECLARE

	c07 CURSOR FOR
	SELECT count(*) over () total_count_row,
		CASE WHEN coalesce(a.nr_seq_fator_risco::text, '') = '' THEN  ' '  ELSE a.nr_seq_fator_risco END  risk_code,
		coalesce(to_char(a.dt_registro, 'YYYYMMDD'), ' ')risk_reg_date, 
		coalesce(b.ds_fator_risco,' ') risk_name,
		case
			when(coalesce(a.dt_inativacao::text, '') = '' and (coalesce(a.dt_fim_risco::text, '') = '' or a.dt_fim_risco > clock_timestamp())) then '+'
			when(coalesce(a.dt_inativacao::text, '') = '' and  a.dt_fim_risco <= clock_timestamp()) then '-'
            else ' '
			end risk_status
		from cih_pac_fat_risco a left outer join  cih_fator_risco b
		on a.nr_seq_fator_risco = b.nr_sequencia
		where (a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
		and coalesce(a.dt_inativacao::text, '') = ''
		and a.cd_pessoa_fisica = unique_key_p;

        r_count c07%ROWTYPE;

BEGIN 
        
            PERFORM set_config('carestream_japan_l10n_pck.ds_line_w', null, false);

            open c07;
                fetch c07 into r_count;
                if (c07%NOTFOUND) then
                    CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_japan_l10n_pck.append_text(0, 5, 'L', '0'); -- RISK_NUM
                 else
                    CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_japan_l10n_pck.append_text(r_count.total_count_row, 5, 'L', '0'); -- RISK_NUM
                 end if;
            close c07;	
        for r_c07 in c07 loop
            begin
                CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_japan_l10n_pck.append_text(r_c07.risk_code, 4, 'L', '0'); --  RISK_CD
                CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_japan_l10n_pck.append_text(r_c07.risk_reg_date, 8); -- LAST_IN_DATE
                CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_japan_l10n_pck.append_text(r_c07.risk_name, 20, 'R', ' '); -- RISK_NAME
                CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_japan_l10n_pck.append_text(r_c07.risk_status, 1); -- VALUE
            end;
        end loop;
		message_data := current_setting('carestream_japan_l10n_pck.ds_line_w')::varchar(32767);
	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE carestream_japan_l10n_pck.patient_risk_info (unique_key_p text, message_data INOUT text) FROM PUBLIC;
