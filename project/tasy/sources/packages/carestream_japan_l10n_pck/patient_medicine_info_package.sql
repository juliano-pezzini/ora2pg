-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


	/**
	+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	Pre-exam administered medicine information  OCCURS  (n)  
	-- It contains the count of patient's  Pre-exam administered medicine related information , fetched from EPC/CPOE. 
	+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	**/
CREATE OR REPLACE PROCEDURE carestream_japan_l10n_pck.patient_medicine_info (unique_key_p text, order_seq_p text , message_data INOUT text) AS $body$
DECLARE


	c09 CURSOR FOR
	    SELECT  count(*) over () total_count_row,
                coalesce(a.cd_material, '0') medicine_code,
                coalesce(obter_desc_material(a.cd_material), ' ') medicine_name,
                coalesce(a.qt_dose, '0') medicine_dosage,
                coalesce(a.cd_unidade_medida_dose, ' ') medicine_unit_code,
                coalesce(obter_dados_unid_medida(a.cd_unidade_medida_dose,'DS'), ' ') medicine_display_unit
		from    prescr_material a, prescr_procedimento b 
        where   a.nr_prescricao = unique_key_p 
        and     b.nr_sequencia  = order_seq_p
        and     a.nr_prescricao = b.nr_prescricao 
        and     a.nr_sequencia_proc = b.nr_sequencia;

        r_count c09%ROWTYPE;

        
BEGIN 
        
        PERFORM set_config('carestream_japan_l10n_pck.ds_line_w', null, false);
        open c09;
		fetch c09 into r_count;
        if (c09%NOTFOUND) then
         CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_japan_l10n_pck.append_text(0, 5, 'L', '0'); -- ALG_NUM
         else
         CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_japan_l10n_pck.append_text(r_count.total_count_row, 5, 'L', '0'); -- ALG_NUM
         end if;
        close c09;

        for r_c09 in c09 loop
            begin
                CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_japan_l10n_pck.append_text(r_c09.medicine_code, 4, 'L', '0'); --  YKH_ID
                CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_japan_l10n_pck.append_text(r_c09.medicine_name, 60, 'R', ' '); -- YKH_HYOJI_1
                CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_japan_l10n_pck.append_text(r_c09.medicine_dosage, 5); -- YOURYO
				CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_japan_l10n_pck.append_text(r_c09.medicine_unit_code, 2); -- TANI_CD
                CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_japan_l10n_pck.append_text(r_c09.medicine_display_unit, 4); -- DSP_TANI
            end;
        end loop;
		message_data := current_setting('carestream_japan_l10n_pck.ds_line_w')::varchar(32767);
	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE carestream_japan_l10n_pck.patient_medicine_info (unique_key_p text, order_seq_p text , message_data INOUT text) FROM PUBLIC;
