-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_rec_glosa_emp_pck.gerar_lote_recurso ( nr_seq_demost_analise_p pls_dma_demons_analise.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE

/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade:	Gera os lotes de recurso com base em um demonstrativo de analise ja importado

	Essa rotina vai apenas chamar outras rotinas, e nao devera conter regras de negocio aqui.
	
	
	Inicialmente sera chamada a rotina para validar se a geracao pode ser realizada,
	depois entao serao chamadas as rotinas que vao de fato realizar todo o processo,
	e por fim entao e realizado o commit.
-------------------------------------------------------------------------------------------------------------------

Locais de chamada direta: 
[]  Objetos do dicionario [X] Tasy (Delphi/Java) [  ] Portal [  ]  Relatorios [ ] Outros:
-------------------------------------------------------------------------------------------------------------------

Pontos de atencao:
Alteracoes:
-------------------------------------------------------------------------------------------------------------------

++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */


BEGIN

begin

	-- Comeca ja gravando a data de geracao no demonstrativo

	CALL pls_rec_glosa_emp_pck.grava_dt_geracao_rec(nr_seq_demost_analise_p, clock_timestamp(), nm_usuario_p, 'S');

	-- Valida as informacoes basicas

	CALL pls_rec_glosa_emp_pck.validar_geracao_lote_rec(nr_seq_demost_analise_p);

	-- A geracao do lote de recurso pode ser particionada, devido a analise de demonstrativo poder

	-- possuir para um prestador, o lote de protocolo diferente. O lote de protocolo no caso faz o vinculo

	-- entre o demonstrativo recebido e o faturamento emitido, portanto para cada faturamento diferente,

	-- sera gerado um lote de recurso diferente.

	-- Para permitir um melhor controle, o protocolo ja e gerado na rotina que gera tambem o lote.

	CALL pls_rec_glosa_emp_pck.gerar_lote_prot_recurso(nr_seq_demost_analise_p, nm_usuario_p);

	-- Gera as glosas dos protocolos

	CALL pls_rec_glosa_emp_pck.gerar_glosas_protocolo(nr_seq_demost_analise_p, nm_usuario_p);

	-- Gera as guias

	CALL pls_rec_glosa_emp_pck.gerar_guia_recurso(nr_seq_demost_analise_p, nm_usuario_p);

	-- Gera as glosas para as guias

	CALL pls_rec_glosa_emp_pck.gerar_glosa_guia_recurso(nr_seq_demost_analise_p, nm_usuario_p);

	-- Gera os procedimentos

	CALL pls_rec_glosa_emp_pck.gerar_proc_recurso(nr_seq_demost_analise_p, nm_usuario_p);

	-- Gera as glosas dos procedimentos

	CALL pls_rec_glosa_emp_pck.gerar_glosa_proc_recurso(nr_seq_demost_analise_p, nm_usuario_p);

	-- Gera os materiais

	CALL pls_rec_glosa_emp_pck.gerar_mat_recurso(nr_seq_demost_analise_p, nm_usuario_p);

	-- Gera a glosa dos materiais

	CALL pls_rec_glosa_emp_pck.gerar_glosa_mat_recurso(nr_seq_demost_analise_p, nm_usuario_p);
	
	-- Gera os valores de glosa da guia, acaso seja recursado a nivel de item

	CALL pls_rec_glosa_emp_pck.gera_vl_glosa_rec_guia(nr_seq_demost_analise_p, nm_usuario_p);

	commit;
exception

	when others then
		-- desfaz tudo

		rollback;
		--desmarca a data de geracao

		CALL pls_rec_glosa_emp_pck.grava_dt_geracao_rec(nr_seq_demost_analise_p, null, nm_usuario_p, 'S');
		
		-- Mensagem padrao

		CALL CALL pls_rec_glosa_emp_pck.exibe_msg_erro_padrao();
end;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_rec_glosa_emp_pck.gerar_lote_recurso ( nr_seq_demost_analise_p pls_dma_demons_analise.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;
