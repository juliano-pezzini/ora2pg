-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_rec_glosa_emp_pck.gera_vl_glosa_rec_guia ( nr_seq_demost_analise_p pls_dma_demons_analise.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE

_ora2pg_r RECORD;
/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade:	Gera os valores totais das guias recursadas.

	Essa rotina e necessaria pois o Schema TISS permite um valor por glosa a nivel
	de guia, no entanto, quando transportamos o lote de recurso para um formato
	mais amigavel para o usuario, o valor da glosa pode ser oriunda dos itens, e nao 
	apenas da guia.
	
	Para isto a rotina busca apenas as guias que nao tem valor de glosa informada
	diretamente dela (vindo da importacao do demonstrativo de analise), e aplica 
	a somatoria dos itens.
	
	Quando a guia possuir um valor de glosa oriunda do demonstrativo de analise,
	este sera o prioritario.
	
	
-------------------------------------------------------------------------------------------------------------------

Locais de chamada direta: 
[X]  Objetos do dicionario [ ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatorios [ ] Outros:
-------------------------------------------------------------------------------------------------------------------

Pontos de atencao:
Alteracoes:
-------------------------------------------------------------------------------------------------------------------

++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */


-- tabelas virtuais

tb_nr_sequencia_w	dbms_sql.number_table;
tb_vl_acatado_w		dbms_sql.number_table;
tb_vl_recursado_w	dbms_sql.number_table;
tb_vl_glosado_w		dbms_sql.number_table;

-- Carrega as guias que precisam ser atualizadas

c01 CURSOR(	nr_seq_demost_analise_pc	pls_dma_demons_analise.nr_sequencia%type) FOR

	SELECT	t.nr_seq_grg_guia,
		sum(t.vl_glosado_item) vl_glosado,
		t.vl_acatado,
		t.vl_recursado
	from (	SELECT	c.nr_sequencia nr_seq_grg_guia,
			d.vl_glosado vl_glosado_item,
			c.vl_acatado,
			c.vl_recursado
		from	pls_grg_lote		a,
			pls_grg_protocolo	b,
			pls_grg_guia		c,
			pls_grg_guia_proc	d
		where	b.nr_seq_grg_lote	= a.nr_sequencia
		and	c.nr_seq_grg_protocolo	= b.nr_sequencia
		and	d.nr_seq_grg_guia	= c.nr_sequencia
		and	a.nr_seq_dma_analise	= nr_seq_demost_analise_pc
		
union all

		select	c.nr_sequencia nr_seq_grg_guia,
			d.vl_glosado vl_glosado_item,
			c.vl_acatado,
			c.vl_recursado
		from	pls_grg_lote		a,
			pls_grg_protocolo	b,
			pls_grg_guia		c,
			pls_grg_guia_mat	d
		where	b.nr_seq_grg_lote	= a.nr_sequencia
		and	c.nr_seq_grg_protocolo	= b.nr_sequencia
		and	d.nr_seq_grg_guia	= c.nr_sequencia
		and	a.nr_seq_dma_analise	= nr_seq_demost_analise_pc )t
	group by t.nr_seq_grg_guia, t.vl_acatado, t.vl_recursado;

BEGIN

begin
	open c01(nr_seq_demost_analise_p);
	loop
	fetch c01 bulk collect into	tb_nr_sequencia_w,
					tb_vl_glosado_w,
					tb_vl_acatado_w,
					tb_vl_recursado_w limit pls_util_pck.qt_registro_transacao_w;
	exit when tb_nr_sequencia_w.count = 0;
	
		SELECT * FROM pls_rec_glosa_emp_pck.atual_valores_rec_guia(	tb_nr_sequencia_w, tb_vl_acatado_w, tb_vl_recursado_w, tb_vl_glosado_w, nm_usuario_p, 'N', 'S') INTO STRICT _ora2pg_r;
 	tb_nr_sequencia_w := _ora2pg_r.tb_nr_sequencia_p; tb_vl_acatado_w := _ora2pg_r.tb_vl_acatado_p; tb_vl_recursado_w := _ora2pg_r.tb_vl_recursado_p; tb_vl_glosado_w := _ora2pg_r.tb_vl_glosado_p;
	
	end loop;
	
exception

	when others then
	
		if (c01%isopen) then
		
			close c01;
		end if;
		
		rollback;
		-- Mensagem padrao

		CALL CALL pls_rec_glosa_emp_pck.exibe_msg_erro_padrao();

end;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_rec_glosa_emp_pck.gera_vl_glosa_rec_guia ( nr_seq_demost_analise_p pls_dma_demons_analise.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;
