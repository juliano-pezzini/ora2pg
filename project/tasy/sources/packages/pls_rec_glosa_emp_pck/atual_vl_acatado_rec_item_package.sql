-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_rec_glosa_emp_pck.atual_vl_acatado_rec_item ( nr_seq_item_p pls_grg_guia_proc.nr_sequencia%type, ie_tipo_item_p text, ie_origem_acao_p pls_grg_guia_proc.ie_origem_acao%type, vl_acatado_p pls_grg_guia_proc.vl_acatado%type, vl_recursado_p pls_grg_guia_proc.vl_recursado%type, vl_glosado_p pls_grg_guia_proc.vl_glosado%type, ds_justificativa_p pls_grg_guia_proc_glosa.ds_justificativa%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE

/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade:	Atualiza o valor acatado e recursado de um item do recurso, conforme o tipo do item.

	Rotina feita apenas para atender a chamadas individuais dos itens pela aplicacao,
	ela possui validacoes que dificultam a sua utilizacao com processo em lote
	
	ie_tipo_item_p:
	'P' - Procedimento
	'M' - Material

-------------------------------------------------------------------------------------------------------------------

Locais de chamada direta: 
[]  Objetos do dicionario [X] Tasy (Delphi/Java) [  ] Portal [  ]  Relatorios [ ] Outros:
-------------------------------------------------------------------------------------------------------------------

Pontos de atencao:
	
Alteracoes:
-------------------------------------------------------------------------------------------------------------------

++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */


qt_glosas_itens_w	integer;

BEGIN					

if (coalesce(vl_glosado_p, 0) < coalesce(vl_acatado_p,0)) then

	CALL wheb_mensagem_pck.exibir_mensagem_abort(843129);	
end if;

if (coalesce(vl_acatado_p, 0) < 0) then

	CALL wheb_mensagem_pck.exibir_mensagem_abort(843130);
end if;

if (coalesce(vl_recursado_p, 0) < 0) then

	CALL wheb_mensagem_pck.exibir_mensagem_abort(843131);
end if;

-- Justificativa necessaria quando for recursar

if	((coalesce(vl_recursado_p, 0) > 0) and (coalesce(ds_justificativa_p::text, '') = '')) then

	CALL wheb_mensagem_pck.exibir_mensagem_abort(876886);
end if;



-- verifica se tem alguma glosa informada para o item

select	sum(t.contador)
into STRICT	qt_glosas_itens_w
from (	SELECT	count(1) contador
	from	pls_grg_guia_proc_glosa	a
	where	a.nr_seq_grg_proc	= nr_seq_item_p
	and	ie_tipo_item_p		= 'P'
	
union all

	-- agora conta os materiais

	SELECT	count(1) contador
	from	pls_grg_guia_mat_glosa	a
	where	a.nr_seq_grg_mat	= nr_seq_item_p
	and	ie_tipo_item_p		= 'M' ) t;

if (coalesce(qt_glosas_itens_w, 0) = 0) then

	CALL wheb_mensagem_pck.exibir_mensagem_abort(854685);
end if;


if (ie_tipo_item_p = 'P') then

	update	pls_grg_guia_proc
	set	vl_acatado		= vl_acatado_p,
		vl_recursado		= vl_recursado_p,
		ie_origem_acao		= ie_origem_acao_p,
		nm_usuario_nrec		= nm_usuario_p,
		dt_atualizacao_nrec	= clock_timestamp()
	where	nr_sequencia		= nr_seq_item_p;
	
	update	pls_grg_guia_proc_glosa
	set	ds_justificativa	= ds_justificativa_p,
		nm_usuario_nrec		= nm_usuario_p,
		dt_atualizacao_nrec	= clock_timestamp()
	where	nr_seq_grg_proc		= nr_seq_item_p;
	
	commit;
elsif (ie_tipo_item_p = 'M') then

	update	pls_grg_guia_mat
	set	vl_acatado	= vl_acatado_p,
		vl_recursado	= vl_recursado_p,
		ie_origem_acao	= ie_origem_acao_p,
		nm_usuario_nrec	= nm_usuario_p,
		dt_atualizacao_nrec	= clock_timestamp()
	where	nr_sequencia	= nr_seq_item_p;
	
	update	pls_grg_guia_mat_glosa
	set	ds_justificativa	= ds_justificativa_p,
		nm_usuario_nrec		= nm_usuario_p,
		dt_atualizacao_nrec	= clock_timestamp()
	where	nr_seq_grg_mat		= nr_seq_item_p;
	
	commit;
end if;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_rec_glosa_emp_pck.atual_vl_acatado_rec_item ( nr_seq_item_p pls_grg_guia_proc.nr_sequencia%type, ie_tipo_item_p text, ie_origem_acao_p pls_grg_guia_proc.ie_origem_acao%type, vl_acatado_p pls_grg_guia_proc.vl_acatado%type, vl_recursado_p pls_grg_guia_proc.vl_recursado%type, vl_glosado_p pls_grg_guia_proc.vl_glosado%type, ds_justificativa_p pls_grg_guia_proc_glosa.ds_justificativa%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;
