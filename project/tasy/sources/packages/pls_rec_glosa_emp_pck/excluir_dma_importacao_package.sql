-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_rec_glosa_emp_pck.excluir_dma_importacao ( nr_seq_demost_analise_p pls_dma_demons_analise.nr_sequencia%type) AS $body$
DECLARE

/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade:	Exclui o demonstrativo de analise importado

-------------------------------------------------------------------------------------------------------------------

Locais de chamada direta: 
[]  Objetos do dicionario [X] Tasy (Delphi/Java) [  ] Portal [  ]  Relatorios [ ] Outros:
-------------------------------------------------------------------------------------------------------------------

Pontos de atencao:
Alteracoes:
-------------------------------------------------------------------------------------------------------------------

++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */


BEGIN

-- Valida se pode mesmo escluir

CALL pls_rec_glosa_emp_pck.valida_excluir_dma_imp(nr_seq_demost_analise_p);


-- Apaga as glosas dos itens (proc e mat estao na mesma tabela, de acordo com o schema tiss)

delete	FROM pls_dma_proc_glosa_imp	x
where	exists (	SELECT	1
			from	pls_dma_demons_analise		a,
				pls_dma_cabecalho_imp		b,
				pls_dma_prestador_imp		c,
				pls_dma_protocolo_imp		d,
				pls_dma_guia_imp		e,
				pls_dma_procedimento_imp	f
			where	b.nr_seq_dma_analise		= a.nr_sequencia
			and	c.nr_seq_dma_cabecalho		= b.nr_sequencia
			and	d.nr_seq_dma_prestador		= c.nr_sequencia
			and	e.nr_seq_dma_protocolo		= d.nr_sequencia
			and	f.nr_seq_dma_guia		= e.nr_sequencia
			and	x.nr_seq_dma_procedimento	= f.nr_sequencia
			and	a.nr_sequencia			= nr_seq_demost_analise_p);

-- Apaga os itens (proc e mat estao na mesma tabela, de acordo com o schema tiss)

delete	FROM pls_dma_procedimento_imp	x
where	exists (	SELECT	1
			from	pls_dma_demons_analise		a,
				pls_dma_cabecalho_imp		b,
				pls_dma_prestador_imp		c,
				pls_dma_protocolo_imp		d,
				pls_dma_guia_imp		e
			where	b.nr_seq_dma_analise		= a.nr_sequencia
			and	c.nr_seq_dma_cabecalho		= b.nr_sequencia
			and	d.nr_seq_dma_prestador		= c.nr_sequencia
			and	e.nr_seq_dma_protocolo		= d.nr_sequencia
			and	x.nr_seq_dma_guia		= e.nr_sequencia
			and	a.nr_sequencia			= nr_seq_demost_analise_p);
			
			
-- Apaga as glosas da guia

delete	FROM pls_dma_guia_glosa_imp	x
where	exists (	SELECT	1
			from	pls_dma_demons_analise		a,
				pls_dma_cabecalho_imp		b,
				pls_dma_prestador_imp		c,
				pls_dma_protocolo_imp		d,
				pls_dma_guia_imp		e
			where	b.nr_seq_dma_analise		= a.nr_sequencia
			and	c.nr_seq_dma_cabecalho		= b.nr_sequencia
			and	d.nr_seq_dma_prestador		= c.nr_sequencia
			and	e.nr_seq_dma_protocolo		= d.nr_sequencia
			and	x.nr_seq_dma_guia		= e.nr_sequencia
			and	a.nr_sequencia			= nr_seq_demost_analise_p);
			
-- Apaga as guias

delete	FROM pls_dma_guia_imp	x
where	exists (	SELECT	1
			from	pls_dma_demons_analise		a,
				pls_dma_cabecalho_imp		b,
				pls_dma_prestador_imp		c,
				pls_dma_protocolo_imp		d
			where	b.nr_seq_dma_analise		= a.nr_sequencia
			and	c.nr_seq_dma_cabecalho		= b.nr_sequencia
			and	d.nr_seq_dma_prestador		= c.nr_sequencia
			and	x.nr_seq_dma_protocolo		= d.nr_sequencia
			and	a.nr_sequencia			= nr_seq_demost_analise_p);

-- Apaga as glosas do protocolo

delete	FROM pls_dma_prot_glosa_imp	x
where	exists (	SELECT	1
			from	pls_dma_demons_analise		a,
				pls_dma_cabecalho_imp		b,
				pls_dma_prestador_imp		c,
				pls_dma_protocolo_imp		d
			where	b.nr_seq_dma_analise		= a.nr_sequencia
			and	c.nr_seq_dma_cabecalho		= b.nr_sequencia
			and	d.nr_seq_dma_prestador		= c.nr_sequencia
			and	x.nr_seq_dma_protocolo		= d.nr_sequencia
			and	a.nr_sequencia			= nr_seq_demost_analise_p);

-- Apaga os protocolo

delete	FROM pls_dma_protocolo_imp	x
where	exists (	SELECT	1
			from	pls_dma_demons_analise		a,
				pls_dma_cabecalho_imp		b,
				pls_dma_prestador_imp		c
			where	b.nr_seq_dma_analise		= a.nr_sequencia
			and	c.nr_seq_dma_cabecalho		= b.nr_sequencia
			and	x.nr_seq_dma_prestador		= c.nr_sequencia
			and	a.nr_sequencia			= nr_seq_demost_analise_p);
			
-- Apaga os prestdores

delete	FROM pls_dma_prestador_imp	x
where	exists (	SELECT	1
			from	pls_dma_demons_analise		a,
				pls_dma_cabecalho_imp		b
			where	b.nr_seq_dma_analise		= a.nr_sequencia
			and	x.nr_seq_dma_cabecalho		= b.nr_sequencia
			and	a.nr_sequencia			= nr_seq_demost_analise_p);
			
-- Apaga o cabecalho

delete	FROM pls_dma_cabecalho_imp	x
where	exists (	SELECT	1
			from	pls_dma_demons_analise		a
			where	x.nr_seq_dma_analise		= a.nr_sequencia
			and	a.nr_sequencia			= nr_seq_demost_analise_p);
			
-- Apaga as mensagem de erro

delete	FROM pls_dma_mensagem_erro	x
where	exists (	SELECT	1
			from	pls_dma_demons_analise		a
			where	x.nr_seq_dma_analise		= a.nr_sequencia
			and	a.nr_sequencia			= nr_seq_demost_analise_p);


-- Apaga as mensagem de erro

delete	FROM pls_dma_demons_analise	x
where	x.nr_sequencia		= nr_seq_demost_analise_p;
			
commit;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_rec_glosa_emp_pck.excluir_dma_importacao ( nr_seq_demost_analise_p pls_dma_demons_analise.nr_sequencia%type) FROM PUBLIC;
