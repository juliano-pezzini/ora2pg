-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION reg_documento_pck.get_controle_acesso_usuario ( nr_seq_repositorio_p repositorio_reg_documento.nr_sequencia%type default null) RETURNS varchar AS $body$
DECLARE


	c01 CURSOR(
				nm_usuario_wc		usuario.nm_usuario%type,
				cd_setor_atendimento_wc	setor_atendimento.cd_setor_atendimento%type,
				cd_perfil_wc		perfil.cd_perfil%type
			) FOR
		SELECT	rra.ie_nivel_acesso
		from	reg_repositorio_acesso rra
		where	rra.nr_seq_repositorio = nr_seq_repositorio_p
		and	coalesce(rra.cd_perfil, cd_perfil_wc) = cd_perfil_wc
		and	coalesce(rra.cd_setor_atendimento, cd_setor_atendimento_wc) = cd_setor_atendimento_wc
		and	coalesce(rra.nm_usuario_lib, nm_usuario_wc) = nm_usuario_wc
		and	clock_timestamp() between rra.dt_inicio_vigencia and coalesce(rra.dt_fim_vigencia, clock_timestamp())
		order by	coalesce(rra.nm_usuario_lib, 'X') desc,
				coalesce(rra.cd_setor_atendimento, 0) desc,
				coalesce(rra.cd_perfil, 0) desc;

	ie_nivel_acesso_w	reg_repositorio_acesso.ie_nivel_acesso%type := 'N';
	nm_usuario_w		usuario.nm_usuario%type;
	cd_setor_atendimento_w	setor_atendimento.cd_setor_atendimento%type;
	cd_perfil_w		perfil.cd_perfil%type;
	
	qt_regra_w		bigint;
	
	
BEGIN
		
		select	count(1)
		into STRICT	qt_regra_w
		from	reg_repositorio_acesso rra
		where	rra.nr_seq_repositorio = nr_seq_repositorio_p;
	
		if (qt_regra_w < 1) then
			begin
				ie_nivel_acesso_w := 'S';
			end;
		else
			begin
				select	wheb_usuario_pck.get_nm_usuario,
					wheb_usuario_pck.get_cd_setor_atendimento,
					wheb_usuario_pck.get_cd_perfil
				into STRICT	nm_usuario_w,
					cd_setor_atendimento_w,
					cd_perfil_w
				;

				for reg01 in c01(nm_usuario_w, cd_setor_atendimento_w, cd_perfil_w) loop
				begin
					ie_nivel_acesso_w := reg01.ie_nivel_acesso;
				end;
				end loop;
			end;
		end if;
		
		return ie_nivel_acesso_w;
	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION reg_documento_pck.get_controle_acesso_usuario ( nr_seq_repositorio_p repositorio_reg_documento.nr_sequencia%type default null) FROM PUBLIC;
