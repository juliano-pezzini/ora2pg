-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE reg_documento_pck.aprovar_solicitacao ( nr_seq_sol_acesso_p reg_sol_acesso_repositorio.nr_sequencia%type, ie_nivel_acesso_p reg_repositorio_acesso.ie_nivel_acesso%type, ie_vis_doc_privado_p reg_repositorio_acesso.ie_visualiza_doc_privado%type, nm_usuario_p text, dt_fim_vigencia_p timestamp ) AS $body$
DECLARE

		
		cd_perfil_w 		usuario.cd_perfil_inicial%type;
		cd_setor_atendimento_w 	usuario.cd_setor_atendimento%type;
		nr_seq_rep_w		reg_repositorio_acesso.nr_seq_repositorio%type;
		nm_usuario_lib_w 	usuario.nm_usuario%type;
		
		
BEGIN
		
			select a.cd_perfil_inicial, a.cd_setor_atendimento, a.nm_usuario, b.nr_seq_repositorio
			into STRICT cd_perfil_w, cd_setor_atendimento_w, nm_usuario_lib_w, nr_seq_rep_w
			from usuario a
			inner join reg_sol_acesso_repositorio b on
				b.nr_sequencia = nr_seq_sol_acesso_p
			where a.nm_usuario = b.nm_usuario_solicitante;
		
			update 	reg_sol_acesso_repositorio
			set	nm_usuario   = nm_usuario_p,
				dt_aprovacao = clock_timestamp(),
				dt_atualizacao = clock_timestamp()
			where 	nr_sequencia = nr_seq_sol_acesso_p;
		
			insert into reg_repositorio_acesso(
				cd_perfil,
				cd_setor_atendimento,
				dt_atualizacao,
				dt_atualizacao_nrec,
				dt_fim_vigencia,
				dt_inicio_vigencia,
				ie_nivel_acesso,
				ie_visualiza_doc_privado,
				nm_usuario,
				nm_usuario_lib,
				nm_usuario_nrec,
				nr_seq_repositorio,
				nr_sequencia)
			values (
				cd_perfil_w,
				cd_setor_atendimento_w,
				clock_timestamp(),
				clock_timestamp(),
				dt_fim_vigencia_p,
				clock_timestamp(),
				ie_nivel_acesso_p,
				ie_vis_doc_privado_p,
				nm_usuario_p,
				nm_usuario_lib_w,
				nm_usuario_p,
				nr_seq_rep_w,
				nextval('reg_repositorio_acesso_seq')
			);
			
			commit;

	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE reg_documento_pck.aprovar_solicitacao ( nr_seq_sol_acesso_p reg_sol_acesso_repositorio.nr_sequencia%type, ie_nivel_acesso_p reg_repositorio_acesso.ie_nivel_acesso%type, ie_vis_doc_privado_p reg_repositorio_acesso.ie_visualiza_doc_privado%type, nm_usuario_p text, dt_fim_vigencia_p timestamp ) FROM PUBLIC;
