-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE reg_documento_pck.enviar_aviso_revisores ( nr_seq_documento_p bigint, ie_opcao_p text ) AS $body$
DECLARE


	ds_email_destino_w		varchar(255);
	ds_email_destino_autor_w	varchar(255);
	ds_titulo_email_autor_w		varchar(255);
	ds_mensagem_email_w		varchar(800);
	ds_msg_autor_email_w		varchar(800);
	ds_titulo_email_w		varchar(255);
	ds_acao_email_w			varchar(255);
	ds_acao_email_autor_w		varchar(255);
	ds_titulo_doc_w			reg_documento.ds_titulo%type;

	
BEGIN

	if (nr_seq_documento_p IS NOT NULL AND nr_seq_documento_p::text <> '') then

		select	ds_titulo
		into STRICT	ds_titulo_doc_w
		from	reg_documento
		where	nr_sequencia = nr_seq_documento_p;

		select	obter_email_nm_usuario_pf(a.nm_usuario_revisor) ds_email
		into STRICT	ds_email_destino_autor_w
		from	reg_doc_revisor a
		where	a.ie_tipo_revisor = 'C' --autor
		and	a.nr_seq_documento = nr_seq_documento_p;

		case
		when ie_opcao_p = 'R' then

			select	obter_email_nm_usuario_pf(a.nm_usuario_revisor) ds_email
			into STRICT	ds_email_destino_w
			from	reg_doc_revisor a
			where	a.ie_tipo_revisor = 'R' --revisor
			and	a.nr_seq_documento = nr_seq_documento_p;
			
			ds_acao_email_w := lower(Wheb_Mensagem_Pck.Get_Texto(1128455));
			
			ds_titulo_email_w := Wheb_Mensagem_Pck.Get_Texto(1128452);
			ds_titulo_email_w := REPLACE(ds_titulo_email_w, '@IE_ACAO', ds_acao_email_w);

			ds_mensagem_email_w := Wheb_Mensagem_Pck.Get_Texto(1128453);
			ds_mensagem_email_w := REPLACE(ds_mensagem_email_w, '@IE_ACAO', ds_acao_email_w);
			ds_mensagem_email_w := REPLACE(ds_mensagem_email_w, '@DS_DOCUMENTO', ds_titulo_doc_w);

			if (ds_email_destino_w IS NOT NULL AND ds_email_destino_w::text <> '') then
				/* Enviar o e-mail para o revisor*/

				CALL enviar_email(	ds_assunto_p 		=> ds_titulo_email_w,
						ds_mensagem_p 		=> ds_mensagem_email_w,
						ds_email_origem_p 	=> 'support.informatics@philips.com',
						ds_email_destino_p 	=> ds_email_destino_w,
						nm_usuario_p 		=> 'Tasy',
						ie_prioridade_p 	=> '' );
			end if;
		when ie_opcao_p  = 'P' then

			select	obter_email_nm_usuario_pf(a.nm_usuario_revisor) ds_email
			into STRICT	ds_email_destino_w
			from	reg_doc_revisor a
			where	a.ie_tipo_revisor = 'A' --aprovador
			and	a.nr_seq_documento = nr_seq_documento_p;
			
			ds_acao_email_w := lower(Wheb_Mensagem_Pck.Get_Texto(1128454));
			
			ds_titulo_email_w := Wheb_Mensagem_Pck.Get_Texto(1128452);
			ds_titulo_email_w := REPLACE(ds_titulo_email_w, '@IE_ACAO', ds_acao_email_w);

			ds_mensagem_email_w := Wheb_Mensagem_Pck.Get_Texto(1128453);
			ds_mensagem_email_w := REPLACE(ds_mensagem_email_w, '@IE_ACAO', ds_acao_email_w);
			ds_mensagem_email_w := REPLACE(ds_mensagem_email_w, '@DS_DOCUMENTO', ds_titulo_doc_w);
			
			ds_acao_email_autor_w := lower(Wheb_Mensagem_Pck.Get_Texto(1128460));
		
			ds_titulo_email_autor_w := Wheb_Mensagem_Pck.Get_Texto(1128458);
			ds_titulo_email_autor_w := REPLACE(ds_titulo_email_autor_w, '@IE_ACAO', ds_acao_email_autor_w);

			ds_msg_autor_email_w := Wheb_Mensagem_Pck.Get_Texto(1128459);
			ds_msg_autor_email_w := REPLACE(ds_msg_autor_email_w, '@IE_ACAO', ds_acao_email_autor_w);
			ds_msg_autor_email_w := REPLACE(ds_msg_autor_email_w, '@DS_DOCUMENTO', ds_titulo_doc_w);

			if (ds_email_destino_w IS NOT NULL AND ds_email_destino_w::text <> '') then
				/* Enviar o e-mail para o aprovador*/

				CALL enviar_email(	ds_assunto_p 		=> ds_titulo_email_w,
						ds_mensagem_p 		=> ds_mensagem_email_w,
						ds_email_origem_p 	=> 'support.informatics@philips.com',
						ds_email_destino_p 	=> ds_email_destino_w,
						nm_usuario_p 		=> 'Tasy',
						ie_prioridade_p 	=> '' );

			end if;

			if (ds_email_destino_autor_w IS NOT NULL AND ds_email_destino_autor_w::text <> '') then

				/* Enviar o e-mail para o autor*/

				CALL enviar_email(	ds_assunto_p 		=> ds_titulo_email_autor_w,
						ds_mensagem_p 		=> ds_msg_autor_email_w,
						ds_email_origem_p 	=> 'support.informatics@philips.com',
						ds_email_destino_p 	=> ds_email_destino_autor_w,
						nm_usuario_p 		=> 'Tasy',
						ie_prioridade_p 	=> '' );
			end if;
		when ie_opcao_p  = 'S' then
		
			ds_acao_email_autor_w := lower(Wheb_Mensagem_Pck.Get_Texto(1128461));
		
			ds_titulo_email_autor_w := Wheb_Mensagem_Pck.Get_Texto(1128458);
			ds_titulo_email_autor_w := REPLACE(ds_titulo_email_autor_w, '@IE_ACAO', ds_acao_email_autor_w);

			ds_msg_autor_email_w := Wheb_Mensagem_Pck.Get_Texto(1128459);
			ds_msg_autor_email_w := REPLACE(ds_msg_autor_email_w, '@IE_ACAO', ds_acao_email_autor_w);
			ds_msg_autor_email_w := REPLACE(ds_msg_autor_email_w, '@DS_DOCUMENTO', ds_titulo_doc_w);

			if (ds_email_destino_autor_w IS NOT NULL AND ds_email_destino_autor_w::text <> '') then
				/* Enviar o e-mail para o autor*/

				CALL enviar_email(	ds_assunto_p 		=> ds_titulo_email_autor_w,
						ds_mensagem_p 		=> ds_msg_autor_email_w,
						ds_email_origem_p 	=> 'support.informatics@philips.com',
						ds_email_destino_p 	=> ds_email_destino_autor_w,
						nm_usuario_p 		=> 'Tasy',
						ie_prioridade_p 	=> '' );
			end if;
		end case;

	end if;

	commit;

	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE reg_documento_pck.enviar_aviso_revisores ( nr_seq_documento_p bigint, ie_opcao_p text ) FROM PUBLIC;
