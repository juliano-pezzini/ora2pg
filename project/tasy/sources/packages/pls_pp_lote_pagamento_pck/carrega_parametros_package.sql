-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_pp_lote_pagamento_pck.carrega_parametros ( nr_seq_lote_p pls_pp_lote.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) AS $body$
BEGIN

-- se a data da ultima solicitacao nao estiver registrada ou 

-- se ja se passou 67 segundos deste a ultima solicitacao ou

-- se a origem for diferente da ultima solicitada ou

-- se o estabelecimento anterior for diferente do ultimo solicitado

-- executa o comando para preencher os valores dos parametros

if	((current_setting('pls_pp_lote_pagamento_pck.dt_solicitacao_ult_w')::coalesce(timestamp::text, '') = '') or
	(current_setting('pls_pp_lote_pagamento_pck.dt_solicitacao_ult_w')::timestamp <= (clock_timestamp() - interval '67 seconds')) or (coalesce(current_setting('pls_pp_lote_pagamento_pck.cd_estabelecimento_ult_w')::estabelecimento.cd_estabelecimento%type, -1) != coalesce(cd_estabelecimento_p, -2))) then
	
	PERFORM set_config('pls_pp_lote_pagamento_pck.cd_estabelecimento_ult_w', cd_estabelecimento_p, false);
	PERFORM set_config('pls_pp_lote_pagamento_pck.dt_solicitacao_ult_w', clock_timestamp(), false);
	
	select	max(a.dt_referencia_inicio),
		fim_dia(max(a.dt_referencia_fim)),
		max(a.cd_condicao_pagamento),
		max(coalesce(a.dt_vencimento_lote, a.dt_mes_competencia)),
		max(a.dt_vencimento_lote),
		max(a.dt_mes_competencia),
		max(a.nr_dia_venc_lote),
		coalesce(max(a.ie_recurso_proprio), 'N')
	into STRICT	current_setting('pls_pp_lote_pagamento_pck.dt_referencia_lote_ini_w')::pls_pp_lote.dt_referencia_inicio%type,
		current_setting('pls_pp_lote_pagamento_pck.dt_referencia_lote_fim_w')::pls_pp_lote.dt_referencia_fim%type,
		current_setting('pls_pp_lote_pagamento_pck.cd_cond_pgto_lote_w')::pls_pp_lote.cd_condicao_pagamento%type,
		current_setting('pls_pp_lote_pagamento_pck.dt_ref_vencimento_lote_w')::timestamp,
		current_setting('pls_pp_lote_pagamento_pck.dt_venc_lote_w')::pls_pp_lote.dt_vencimento_lote%type,
		current_setting('pls_pp_lote_pagamento_pck.dt_mes_comp_lote_w')::pls_pp_lote.dt_mes_competencia%type,
		current_setting('pls_pp_lote_pagamento_pck.nr_dia_venc_lote_w')::pls_pp_lote.nr_dia_venc_lote%type,
		current_setting('pls_pp_lote_pagamento_pck.ie_recurso_proprio_w')::pls_pp_lote.ie_recurso_proprio%type
	from	pls_pp_lote a
	where	a.nr_sequencia = nr_seq_lote_p;

	-- se tiver estabelecimento filtra por estabelecimento

	-- caso contrario pega o registro maximo da tabela

	-- Busca parametrizacao em 'OPS - Gestao de Operadora > Parametros da OPS > Pagamento producao' campo 'Data referencia titulo'

	-- Os valores pode ser:	E = Data de emissao	V = Data de vencimento

	if (cd_estabelecimento_p IS NOT NULL AND cd_estabelecimento_p::text <> '') then

		select	coalesce(max(ie_data_tributos),'R'),
			coalesce(max(ie_data_ref_titulo), 'E'),
			coalesce(max(ie_saldo_negativo), 'PP'),
			max(nr_seq_evento_prox_pgto),
			coalesce(max(ie_evento_orig_prox_pagto), 'N'),
			max(nr_seq_evento_trib_lm),
			max(nr_seq_evento_trib_prov),
			max(cd_tipo_receb_pgto),
			max(nr_seq_trans_fin_rec_pgto),
			max(cd_tipo_baixa_pgto),
			max(nr_seq_trans_fin_pag_pgto),
			max(ie_forma_pagamento)
		into STRICT	current_setting('pls_pp_lote_pagamento_pck.ie_data_tributos_w')::pls_parametro_pagamento.ie_data_tributos%type,
			current_setting('pls_pp_lote_pagamento_pck.ie_data_ref_titulo_w')::pls_parametro_pagamento.ie_data_ref_titulo%type,
			current_setting('pls_pp_lote_pagamento_pck.ie_acao_pgto_neg_param_w')::pls_parametro_pagamento.ie_saldo_negativo%type,
			current_setting('pls_pp_lote_pagamento_pck.nr_seq_evento_prox_pgto_w')::pls_parametro_pagamento.nr_seq_evento_prox_pgto%type,
			current_setting('pls_pp_lote_pagamento_pck.ie_evento_orig_prox_pagto_w')::pls_parametro_pagamento.ie_evento_orig_prox_pagto%type,
			current_setting('pls_pp_lote_pagamento_pck.nr_seq_evento_trib_lm_w')::pls_parametro_pagamento.nr_seq_evento_trib_lm%type,
			current_setting('pls_pp_lote_pagamento_pck.nr_seq_evento_trib_prov_w')::pls_parametro_pagamento.nr_seq_evento_trib_prov%type,
			current_setting('pls_pp_lote_pagamento_pck.cd_tipo_receb_pgto_w')::pls_parametro_pagamento.cd_tipo_receb_pgto%type,
			current_setting('pls_pp_lote_pagamento_pck.nr_seq_trans_fin_rec_pgto_w')::pls_parametro_pagamento.nr_seq_trans_fin_rec_pgto%type,
			current_setting('pls_pp_lote_pagamento_pck.cd_tipo_baixa_pgto_w')::pls_parametro_pagamento.cd_tipo_baixa_pgto%type,
			current_setting('pls_pp_lote_pagamento_pck.nr_seq_trans_fin_pag_pgto_w')::pls_parametro_pagamento.nr_seq_trans_fin_pag_pgto%type,
			current_setting('pls_pp_lote_pagamento_pck.ie_forma_pagamento_w')::pls_parametro_pagamento.ie_forma_pagamento%type
		from	pls_parametro_pagamento
		where	cd_estabelecimento = cd_estabelecimento_p;
	else

		select	coalesce(max(ie_data_tributos),'R'),
			coalesce(max(ie_data_ref_titulo), 'E'),
			coalesce(max(ie_saldo_negativo), 'PP'),
			max(nr_seq_evento_prox_pgto),
			coalesce(max(ie_evento_orig_prox_pagto), 'N'),
			max(nr_seq_evento_trib_lm),
			max(nr_seq_evento_trib_prov),
			max(cd_tipo_receb_pgto),
			max(nr_seq_trans_fin_rec_pgto),
			max(cd_tipo_baixa_pgto),
			max(nr_seq_trans_fin_pag_pgto),
			max(ie_forma_pagamento)
		into STRICT	current_setting('pls_pp_lote_pagamento_pck.ie_data_tributos_w')::pls_parametro_pagamento.ie_data_tributos%type,
			current_setting('pls_pp_lote_pagamento_pck.ie_data_ref_titulo_w')::pls_parametro_pagamento.ie_data_ref_titulo%type,
			current_setting('pls_pp_lote_pagamento_pck.ie_acao_pgto_neg_param_w')::pls_parametro_pagamento.ie_saldo_negativo%type,
			current_setting('pls_pp_lote_pagamento_pck.nr_seq_evento_prox_pgto_w')::pls_parametro_pagamento.nr_seq_evento_prox_pgto%type,
			current_setting('pls_pp_lote_pagamento_pck.ie_evento_orig_prox_pagto_w')::pls_parametro_pagamento.ie_evento_orig_prox_pagto%type,
			current_setting('pls_pp_lote_pagamento_pck.nr_seq_evento_trib_lm_w')::pls_parametro_pagamento.nr_seq_evento_trib_lm%type,
			current_setting('pls_pp_lote_pagamento_pck.nr_seq_evento_trib_prov_w')::pls_parametro_pagamento.nr_seq_evento_trib_prov%type,
			current_setting('pls_pp_lote_pagamento_pck.cd_tipo_receb_pgto_w')::pls_parametro_pagamento.cd_tipo_receb_pgto%type,
			current_setting('pls_pp_lote_pagamento_pck.nr_seq_trans_fin_rec_pgto_w')::pls_parametro_pagamento.nr_seq_trans_fin_rec_pgto%type,
			current_setting('pls_pp_lote_pagamento_pck.cd_tipo_baixa_pgto_w')::pls_parametro_pagamento.cd_tipo_baixa_pgto%type,
			current_setting('pls_pp_lote_pagamento_pck.nr_seq_trans_fin_pag_pgto_w')::pls_parametro_pagamento.nr_seq_trans_fin_pag_pgto%type,
			current_setting('pls_pp_lote_pagamento_pck.ie_forma_pagamento_w')::pls_parametro_pagamento.ie_forma_pagamento%type
		from	pls_parametro_pagamento;
	end if;
end if;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_pp_lote_pagamento_pck.carrega_parametros ( nr_seq_lote_p pls_pp_lote.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) FROM PUBLIC;
