-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pls_pp_lote_pagamento_pck.obter_nr_seq_prest_maior_vl ( nr_seq_lote_p pls_pp_item_lote.nr_seq_lote%type, nr_seq_prest_p pls_prestador.nr_sequencia%type, cd_pessoa_p text) RETURNS bigint AS $body$
DECLARE


nr_seq_prest_w		pls_prestador.nr_sequencia%type;
qt_prest_pess_w		integer;

c01 CURSOR(	nr_seq_lote_pc	pls_pp_item_lote.nr_seq_lote%type,
		cd_pessoa_pc	text) FOR
	SELECT	nr_seq_prestador,
		vl_liquido
	from (
		SELECT	a.nr_seq_prestador,
			a.vl_liquido
		from	pls_prestador b,
			pls_pp_prestador a
		where	b.cd_pessoa_fisica = cd_pessoa_pc
		and	a.nr_seq_prestador = b.nr_sequencia
		and	a.nr_seq_lote = nr_seq_lote_pc
		
union all

		select	a.nr_seq_prestador,
			a.vl_liquido
		from	pls_prestador b,
			pls_pp_prestador a
		where	b.cd_cgc = cd_pessoa_pc
		and	a.nr_seq_prestador = b.nr_sequencia
		and	a.nr_seq_lote = nr_seq_lote_pc
	) alias1
	order by vl_liquido desc;
BEGIN
-- inicia a variavel

qt_prest_pess_w := 0;

-- se for passado um prestador so verifica se a sequencia pertence a pessoa, caso pertenca retorna o mesmo prestador

if (nr_seq_prest_p IS NOT NULL AND nr_seq_prest_p::text <> '') then

	select	sum(qtde)
	into STRICT	qt_prest_pess_w
	from (
		SELECT	count(1) qtde
		from	pls_prestador a
		where	a.cd_pessoa_fisica = cd_pessoa_p
		and	a.nr_sequencia = nr_seq_prest_p
		
union all

		SELECT	count(1) qtde
		from	pls_prestador a
		where	a.cd_cgc = cd_pessoa_p
		and	a.nr_sequencia = nr_seq_prest_p
	) alias4;

	-- se encontrou um registro entao retorna a mesma sequencia que foi passada de parametro

	if (qt_prest_pess_w > 0) then
	
		nr_seq_prest_w := nr_seq_prest_p;
	end if;
end if;

-- so entra aqui se ainda nao encontrou o prestador

if (coalesce(nr_seq_prest_w::text, '') = '') then
	-- retorna todos os prestadores relacionados ao codigo de pessoa passado, ordenado pelo maior valor

	for r_c01_w in c01(nr_seq_lote_p, cd_pessoa_p) loop

		nr_seq_prest_w := r_c01_w.nr_seq_prestador;
		-- retorna o primeiro que encontrar

		exit;
	end loop;
end if;

return nr_seq_prest_w;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pls_pp_lote_pagamento_pck.obter_nr_seq_prest_maior_vl ( nr_seq_lote_p pls_pp_item_lote.nr_seq_lote%type, nr_seq_prest_p pls_prestador.nr_sequencia%type, cd_pessoa_p text) FROM PUBLIC;
