-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


-- Esta procedure verifica todas os lotes que estao com o status 'Gerando' e verifica se a sessao da mesma esta ativa, caso esteja inativa seta o status para 'Erro ao gerar o lote'



CREATE OR REPLACE PROCEDURE pls_pp_lote_pagamento_pck.gerencia_lote_status_sessao () AS $body$
DECLARE


c_lote CURSOR FOR
	SELECT	nr_sequencia,
		pls_util_pck.obter_se_sessao_ativa(nm_id_sid,nm_id_serial) ie_ativo
	from	pls_pp_lote
	where	ie_status = 'G'
	and	(nm_id_sid IS NOT NULL AND nm_id_sid::text <> '')
	and	(nm_id_serial IS NOT NULL AND nm_id_serial::text <> '');
	
BEGIN

for r_lote_w in c_lote loop
	if (r_lote_w.ie_ativo = 'N') then
		update	pls_pp_lote
		set	ie_status = 'E',
			nm_id_sid  = NULL,
			nm_id_serial  = NULL
		where	nr_sequencia = r_lote_w.nr_sequencia;
	end if;
end loop;
commit;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_pp_lote_pagamento_pck.gerencia_lote_status_sessao () FROM PUBLIC;
