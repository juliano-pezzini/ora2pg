-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


-- exclui todos os eventos de titulo a receber do lote



CREATE OR REPLACE PROCEDURE pls_pp_lote_pagamento_pck.desfazer_item_tit_rec ( nr_seq_lote_p pls_pp_lote.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE


tb_sequencia_w		pls_util_cta_pck.t_number_table;
tb_vl_item_w		pls_util_cta_pck.t_number_table;
tb_nr_tit_receber_w	pls_util_cta_pck.t_number_table;
tb_nr_seq_baixa_w	pls_util_cta_pck.t_number_table;

c01 CURSOR(	nr_seq_lote_pc	pls_pp_lote.nr_sequencia%type) FOR
	SELECT 	nr_sequencia,
		vl_item,
		nr_titulo_receber
	from	pls_pp_item_lote
	where	nr_seq_lote = nr_seq_lote_pc
	and	ie_tipo_item = '4';
	
BEGIN

-- percorre o cursor e apaga os itens retornados

open c01( nr_seq_lote_p );
loop
	fetch c01 bulk collect into tb_sequencia_w, tb_vl_item_w, tb_nr_tit_receber_w
	limit pls_util_pck.qt_registro_transacao_w;
	exit when tb_sequencia_w.count = 0;

	-- faz a baixa dos titulos que entraram no pagamento e atualiza a observacao

	for i in tb_nr_tit_receber_w.first..tb_nr_tit_receber_w.last loop

		CALL baixa_titulo_receber(	cd_estabelecimento_p, current_setting('pls_pp_lote_pagamento_pck.cd_tipo_receb_pgto_w')::pls_parametro_pagamento.cd_tipo_receb_pgto%type,
					tb_nr_tit_receber_w(i), current_setting('pls_pp_lote_pagamento_pck.nr_seq_trans_fin_rec_pgto_w')::pls_parametro_pagamento.nr_seq_trans_fin_rec_pgto%type,
					tb_vl_item_w(i), clock_timestamp(),
					nm_usuario_p, 0,
					null, null,
					0, 0);

		-- busca a sequencia da baixa que foi inserida

		select	coalesce(max(nr_sequencia),0)
		into STRICT	tb_nr_seq_baixa_w(i)
		from	titulo_receber_liq
		where	nr_titulo = tb_nr_tit_receber_w(i);

		CALL atualizar_saldo_tit_rec(tb_nr_tit_receber_w(i), nm_usuario_p);
	end loop;

	-- coloca uma observacao no titulo para identificar o motivo do estorno da baixa

	forall i in tb_nr_tit_receber_w.first..tb_nr_tit_receber_w.last
		update	titulo_receber_liq
		set	ds_observacao = wheb_mensagem_pck.get_texto(1107363, 'NR_SEQ_LOTE=' || nr_seq_lote_p)
		where	nr_sequencia = tb_nr_seq_baixa_w(i)
		and	nr_titulo = tb_nr_tit_receber_w(i);
	commit;
end loop;
close c01;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_pp_lote_pagamento_pck.desfazer_item_tit_rec ( nr_seq_lote_p pls_pp_lote.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;
