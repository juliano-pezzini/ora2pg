-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pls_ocor_imp_pck.obter_restricao_reg_selecao ( ie_considera_selecao_p boolean, ie_tipo_tabela_select_p text, nr_id_transacao_p pls_oc_cta_selecao_imp.nr_id_transacao%type, nr_seq_filtro_p pls_oc_cta_filtro.nr_sequencia%type, ie_incidencia_filtro_p text, ie_processo_excecao_p text, ie_incidencia_selecao_p text, valor_bind_p INOUT sql_pck.t_dado_bind, ds_campo_p INOUT text, ds_tabela_p INOUT text) AS $body$
DECLARE


ds_restricao_w		varchar(1000);
ds_alias_conta_w	varchar(10);
ds_alias_proc_w		varchar(10);
ds_alias_mat_w		varchar(10);


BEGIN
-- Retornar as restriaaes padrao para um exists que a feito para saber quais registros

-- devem ser considerados durante o processamento dos filtros


ds_restricao_w := null;
ds_alias_conta_w := pls_ocor_imp_pck.obter_alias_tabela('pls_conta_imp');
ds_alias_proc_w := pls_ocor_imp_pck.obter_alias_tabela('pls_conta_proc_imp');
ds_alias_mat_w := pls_ocor_imp_pck.obter_alias_tabela('pls_conta_mat_imp');

-- transaaao filtra sempre				

ds_restricao_w := 	ds_restricao_w || pls_util_pck.enter_w ||
			'and sel.nr_id_transacao = :nr_id_transacao ';
valor_bind_p := sql_pck.bind_variable(	':nr_id_transacao', nr_id_transacao_p, valor_bind_p);

-- se for regra ou filtro de exceaao, seleciona somente o que estiver marcado com o ie_excecao

if (ie_processo_excecao_p = 'S') then
	
	ds_restricao_w :=	ds_restricao_w || pls_util_pck.enter_w ||
				'and	sel.ie_excecao = ''S'' ';
else
	-- aplica a filtragem pelo filtro

	if (nr_seq_filtro_p IS NOT NULL AND nr_seq_filtro_p::text <> '') then
		
		ds_restricao_w := 	ds_restricao_w || pls_util_pck.enter_w ||
					'and	sel.nr_seq_filtro = :nr_seq_filtro';
		valor_bind_p := sql_pck.bind_variable(	':nr_seq_filtro', nr_seq_filtro_p, valor_bind_p);
	end if;
	
	ds_restricao_w := 	ds_restricao_w || pls_util_pck.enter_w ||
				'and	sel.ie_valido = ''S'' ';
end if;

-- procedimento

if	((ie_incidencia_filtro_p = 'P' and ie_processo_excecao_p = 'S') or (ie_incidencia_selecao_p = 'P')) then
	
	 ds_restricao_w := 	ds_restricao_w || pls_util_pck.enter_w ||
				'and	sel.nr_seq_conta_proc = ' || ds_alias_proc_w || '.nr_sequencia ';
-- material

elsif	((ie_incidencia_filtro_p = 'M' and ie_processo_excecao_p = 'S') or (ie_incidencia_selecao_p = 'M')) then
	
	 ds_restricao_w := 	ds_restricao_w || pls_util_pck.enter_w ||
				'and	sel.nr_seq_conta_mat = ' || ds_alias_mat_w || '.nr_sequencia ';
-- procedimento ou material

elsif (ie_incidencia_selecao_p = 'PM' and ie_processo_excecao_p = 'N') then
	
	-- procedimento

	if (ie_tipo_tabela_select_p = 'PROC') then
		ds_restricao_w := 	ds_restricao_w || pls_util_pck.enter_w ||
					'and	sel.nr_seq_conta_proc = ' || ds_alias_proc_w || '.nr_sequencia ';
	-- material

	elsif (ie_tipo_tabela_select_p = 'MAT') then
		ds_restricao_w := 	ds_restricao_w || pls_util_pck.enter_w ||
					'and	sel.nr_seq_conta_mat = ' || ds_alias_mat_w || '.nr_sequencia ';
	end if;
-- conta

else
	ds_restricao_w := 	ds_restricao_w || pls_util_pck.enter_w ||
				'and	sel.nr_seq_conta = ' || ds_alias_conta_w || '.nr_sequencia ';
end if;

-- se for para considerar os registros validos na tabela de seleaao, devolve o comando

if (ie_considera_selecao_p) then	
	
	ds_tabela_p := 	ds_tabela_p || ', ' || pls_util_pck.enter_w ||
			'pls_oc_cta_selecao_imp sel' || pls_util_pck.enter_w;
	
	ds_campo_p := 	ds_campo_p || ', ' || pls_util_pck.enter_w ||
			'sel.nr_sequencia nr_seq_selecao' || pls_util_pck.enter_w;

else
	-- se nao for para restringir pelos registros da seleaao, apenas coloca um subselect para retornar a sequancia do registro que sera atualizado na tabela de seleaao

	ds_campo_p := 	ds_campo_p || ', ' || pls_util_pck.enter_w ||
			'(select	sel.nr_sequencia' || pls_util_pck.enter_w ||
			' from 		pls_oc_cta_selecao_imp sel' || pls_util_pck.enter_w ||
			'where		1 = 1' || pls_util_pck.enter_w ||
			ds_restricao_w || pls_util_pck.enter_w ||
			') nr_seq_selecao ';

	-- se fica no subselect entao zera a restriaao pois a mesma ja foi aplicada acima

	ds_restricao_w := null;
end if;

return;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pls_ocor_imp_pck.obter_restricao_reg_selecao ( ie_considera_selecao_p boolean, ie_tipo_tabela_select_p text, nr_id_transacao_p pls_oc_cta_selecao_imp.nr_id_transacao%type, nr_seq_filtro_p pls_oc_cta_filtro.nr_sequencia%type, ie_incidencia_filtro_p text, ie_processo_excecao_p text, ie_incidencia_selecao_p text, valor_bind_p INOUT sql_pck.t_dado_bind, ds_campo_p INOUT text, ds_tabela_p INOUT text) FROM PUBLIC;
