-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pls_ocor_imp_pck.obter_restricao_beneficiario ( nr_seq_segurado_p pls_oc_cta_filtro_benef.nr_sequencia%type, cd_convenio_p pls_oc_cta_filtro_benef.cd_convenio%type, ie_local_cadastro_p pls_oc_cta_filtro_benef.ie_local_cadastro%type, ie_tipo_segurado_p pls_oc_cta_filtro_benef.ie_tipo_segurado%type, cd_categoria_p pls_oc_cta_filtro_benef.cd_categoria%type, qt_idade_min_p pls_oc_cta_filtro_benef.qt_idade_min%type, qt_idade_max_p pls_oc_cta_filtro_benef.qt_idade_max%type, ie_sexo_p pls_oc_cta_filtro_benef.ie_sexo%type, ie_pcmso_p pls_oc_cta_filtro_benef.ie_pcmso%type, ie_unid_tempo_idade_p pls_oc_cta_filtro_benef.ie_unid_tempo_idade%type, ie_titularidade_p pls_oc_cta_filtro_benef.ie_titularidade%type, valor_bind_p INOUT sql_pck.t_dado_bind, ds_tabelas_p INOUT text) AS $body$
DECLARE

					
ds_alias_conta_w	varchar(5);
ds_alias_seg_w		varchar(5);

ds_restricao_w		varchar(1000);
ds_tabelas_w		varchar(1000);
ie_valor_filtro_w	boolean := false;



BEGIN
-- Monta as restriaaes e binds dos campos de filtro de beneficiario

ds_restricao_w := null;
ds_tabelas_w := null;

-- obtam o alias da tabela 

ds_alias_conta_w := pls_ocor_imp_pck.obter_alias_tabela('pls_conta_imp');
ds_alias_seg_w := 'seg';

--Sequancia do segurado

if (nr_seq_segurado_p IS NOT NULL AND nr_seq_segurado_p::text <> '') then
	ds_restricao_w := 	ds_restricao_w || pls_util_pck.enter_w ||
				'and	' || ds_alias_seg_w || '.nr_sequencia = :nr_seq_segurado_pc ';
	
	valor_bind_p := sql_pck.bind_variable(	':nr_seq_segurado_pc', nr_seq_segurado_p, valor_bind_p);
	ie_valor_filtro_w := true;
end if;

-- Cadigo do convanio

if (cd_convenio_p IS NOT NULL AND cd_convenio_p::text <> '') then
	ds_restricao_w := 	ds_restricao_w || pls_util_pck.enter_w ||
				'and	' || ds_alias_conta_w || '.cd_convenio_conv = :cd_convenio_pc ';
	
	valor_bind_p := sql_pck.bind_variable(	':cd_convenio_pc', cd_convenio_p, valor_bind_p);
end if;				

--Local de cadastro

if (ie_local_cadastro_p IS NOT NULL AND ie_local_cadastro_p::text <> '') then
	ds_restricao_w	:= ds_restricao_w || pls_util_pck.enter_w ||
				'and	' || ds_alias_seg_w || '.ie_local_cadastro = :ie_local_cadastro_pc ';
				
	valor_bind_p := sql_pck.bind_variable(	':ie_local_cadastro_pc', ie_local_cadastro_p, valor_bind_p);
	ie_valor_filtro_w := true;	
end if;	

-- Tipo de beneficiario

if (ie_tipo_segurado_p IS NOT NULL AND ie_tipo_segurado_p::text <> '') then
	ds_restricao_w	:= ds_restricao_w || pls_util_pck.enter_w ||
				'and	' || ds_alias_seg_w || '.ie_tipo_segurado = :ie_tipo_segurado_pc ';
				
	valor_bind_p := sql_pck.bind_variable(	':ie_tipo_segurado_pc', ie_tipo_segurado_p, valor_bind_p);
	ie_valor_filtro_w := true;
end if;

---Categoria de convanio

if (cd_categoria_p IS NOT NULL AND cd_categoria_p::text <> '') then
	ds_restricao_w := 	ds_restricao_w || pls_util_pck.enter_w ||
				'and	' || ds_alias_conta_w || '.cd_categoria_conv = :cd_categoria_pc ';
	
	valor_bind_p := sql_pck.bind_variable(	':cd_categoria_pc', cd_categoria_p, valor_bind_p);
end if;

--Idade manima ou maxima

if	((qt_idade_min_p IS NOT NULL AND qt_idade_min_p::text <> '') or (qt_idade_max_p IS NOT NULL AND qt_idade_max_p::text <> '')) then

	--Verifica unidade de medida (Ano/Mas)

	if	((ie_unid_tempo_idade_p = 'A') or (coalesce(ie_unid_tempo_idade_p::text, '') = '')) then
		begin
		--Aplica restriaaa idade manima

		if (qt_idade_min_p IS NOT NULL AND qt_idade_min_p::text <> '') then
			ds_restricao_w := 	ds_restricao_w || pls_util_pck.enter_w ||
						'and	' || ds_alias_conta_w || '.qt_idade_conta_anos_conv >= :qt_idade_min_pc ';
		
			valor_bind_p := sql_pck.bind_variable(	':qt_idade_min_pc', qt_idade_min_p, valor_bind_p);
		end if;
		--Aplica restriaaa idade maxima

		if (qt_idade_max_p IS NOT NULL AND qt_idade_max_p::text <> '') then
			ds_restricao_w := 	ds_restricao_w || pls_util_pck.enter_w ||
						'and	' || ds_alias_conta_w || '.qt_idade_conta_anos_conv <= :qt_idade_max_pc ';
		
			valor_bind_p := sql_pck.bind_variable(	':qt_idade_max_pc', qt_idade_max_p, valor_bind_p);
		end if;
		end;
	elsif (ie_unid_tempo_idade_p = 'M') then
		begin
		--Aplica restriaaa idade manima

		if (qt_idade_min_p IS NOT NULL AND qt_idade_min_p::text <> '') then
			ds_restricao_w := 	ds_restricao_w || pls_util_pck.enter_w ||
						'and	' || ds_alias_conta_w || '.qt_idade_conta_meses_conv >= :qt_idade_min_pc ';
		
			valor_bind_p := sql_pck.bind_variable(	':qt_idade_min_pc', qt_idade_min_p, valor_bind_p);
		end if;
		--Aplica restriaaa idade maxima

		if (qt_idade_max_p IS NOT NULL AND qt_idade_max_p::text <> '') then
			ds_restricao_w := 	ds_restricao_w || pls_util_pck.enter_w ||
						'and	' || ds_alias_conta_w || '.qt_idade_conta_meses_conv <= :qt_idade_max_pc ';
		
			valor_bind_p := sql_pck.bind_variable(	':qt_idade_max_pc', qt_idade_max_p, valor_bind_p);
		end if;
		end;
	end if;
	
end if;

---Sexo do beneficiario

if (ie_sexo_p IS NOT NULL AND ie_sexo_p::text <> '') then
	ds_restricao_w	:= ds_restricao_w || pls_util_pck.enter_w ||
				'and	' || ds_alias_conta_w || '.ie_sexo_conv = :ie_sexo_pc ';
				
	valor_bind_p := sql_pck.bind_variable(	':ie_sexo_pc', ie_sexo_p, valor_bind_p);
end if;

--PCMSO

if (ie_pcmso_p = 'S') then
	ds_restricao_w := ds_restricao_w || ' and ' || ds_alias_seg_w || '.ie_pcmso = :ie_pcmso_pc ' || pls_util_pck.enter_w;
	
	valor_bind_p := sql_pck.bind_variable(	':ie_pcmso_pc', ie_pcmso_p, valor_bind_p);
	ie_valor_filtro_w := true;
end if;

-- Titularidade

if (ie_titularidade_p <> 'A') then
	ds_restricao_w := 	ds_restricao_w || pls_util_pck.enter_w ||
				'and	decode(' || ds_alias_seg_w || '.nr_seq_titular, null, ''T'', ''D'') = :ie_titularidade ';
				
	valor_bind_p := sql_pck.bind_variable(	':ie_titularidade', ie_titularidade_p, valor_bind_p);
end if;

--Caso seja cadastrado um filtro para beneficiario em branco nao precisa relacionar a tabela pls_segurado

if (ie_valor_filtro_w = true) then
	--Monta Ligaaao da tabela PLS_SEGURADO

	ds_tabelas_w	:= ds_tabelas_w || ', ' || pls_util_pck.enter_w ||
				'	pls_segurado ' || ds_alias_seg_w;

	ds_restricao_w	:= ds_restricao_w || 'and ' || ds_alias_seg_w || '.nr_sequencia = ' || ds_alias_conta_w || '.nr_seq_segurado_conv ' || pls_util_pck.enter_w;
end if;

ds_tabelas_p	:= ds_tabelas_w;

return;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pls_ocor_imp_pck.obter_restricao_beneficiario ( nr_seq_segurado_p pls_oc_cta_filtro_benef.nr_sequencia%type, cd_convenio_p pls_oc_cta_filtro_benef.cd_convenio%type, ie_local_cadastro_p pls_oc_cta_filtro_benef.ie_local_cadastro%type, ie_tipo_segurado_p pls_oc_cta_filtro_benef.ie_tipo_segurado%type, cd_categoria_p pls_oc_cta_filtro_benef.cd_categoria%type, qt_idade_min_p pls_oc_cta_filtro_benef.qt_idade_min%type, qt_idade_max_p pls_oc_cta_filtro_benef.qt_idade_max%type, ie_sexo_p pls_oc_cta_filtro_benef.ie_sexo%type, ie_pcmso_p pls_oc_cta_filtro_benef.ie_pcmso%type, ie_unid_tempo_idade_p pls_oc_cta_filtro_benef.ie_unid_tempo_idade%type, ie_titularidade_p pls_oc_cta_filtro_benef.ie_titularidade%type, valor_bind_p INOUT sql_pck.t_dado_bind, ds_tabelas_p INOUT text) FROM PUBLIC;
