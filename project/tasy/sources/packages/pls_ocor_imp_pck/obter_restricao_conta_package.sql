-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pls_ocor_imp_pck.obter_restricao_conta ( nr_seq_grupo_doenca_p pls_oc_cta_filtro_conta.nr_seq_grupo_doenca%type, cd_doenca_cid_p pls_oc_cta_filtro_conta.cd_doenca_cid%type, ie_tipo_guia_p pls_oc_cta_filtro_conta.ie_tipo_guia%type, nr_seq_tipo_atendimento_p pls_oc_cta_filtro_conta.nr_seq_tipo_atendimento%type, nr_seq_saida_int_p pls_oc_cta_filtro_conta.nr_seq_saida_int%type, ie_regime_internacao_p pls_oc_cta_filtro_conta.ie_regime_internacao%type, ie_tipo_conulta_p pls_oc_cta_filtro_conta.ie_tipo_consulta%type, ie_carater_internacao_p pls_oc_cta_filtro_conta.ie_carater_internacao%type, nr_seq_clinica_p pls_oc_cta_filtro_conta.nr_seq_clinica%type, ie_indicador_dorn_p pls_oc_cta_filtro_conta.ie_indicador_dorn%type, ie_tipo_internado_p pls_oc_cta_filtro_conta.ie_tipo_internado%type, ie_vinc_internacao_p pls_oc_cta_filtro_conta.ie_vinc_internacao%type, ie_recem_nascido_p pls_oc_cta_filtro_conta.ie_recem_nascido%type, ie_indicacao_acidente_p pls_oc_cta_filtro_conta.ie_indicacao_acidente%type, ie_tipo_faturamento_p pls_oc_cta_filtro_conta.ie_tipo_faturamento%type, ie_regime_atendimento_p pls_conta.ie_regime_atendimento%type, ie_saude_ocupacional_p pls_conta.ie_saude_ocupacional%type, valor_bind_p INOUT sql_pck.t_dado_bind) AS $body$
DECLARE


ds_alias_prot_w		varchar(5);
ds_alias_conta_w	varchar(5);

ds_restricao_w		varchar(1000);


BEGIN
-- Monta as restriaaes e binds dos campos de filtro de conta

ds_restricao_w := null;

-- obtam o alias da tabela 

ds_alias_prot_w := pls_ocor_imp_pck.obter_alias_tabela('pls_protocolo_conta_imp');
ds_alias_conta_w := pls_ocor_imp_pck.obter_alias_tabela('pls_conta_imp');

--Grupo Doenaa

if (nr_seq_grupo_doenca_p IS NOT NULL AND nr_seq_grupo_doenca_p::text <> '') then

	ds_restricao_w :=	ds_restricao_w || pls_util_pck.enter_w ||
					'and	exists ( ' || pls_util_pck.enter_w || 
					'		select	1 ' || pls_util_pck.enter_w || 
					'		from	pls_diagnostico_conta_imp diag, ' || pls_util_pck.enter_w || 
					'			pls_preco_doenca	grupo ' || pls_util_pck.enter_w || 
					'		where	diag.nr_seq_conta	= ' || ds_alias_conta_w || '.nr_sequencia ' || pls_util_pck.enter_w || 
					'		and	grupo.nr_seq_grupo	= :nr_seq_grupo_pc' || pls_util_pck.enter_w || 
					'		and	diag.cd_doenca_conv	= grupo.cd_doenca_cid ' || pls_util_pck.enter_w || 
					'	) ';
					
	valor_bind_p := sql_pck.bind_variable(	':nr_seq_grupo_pc', nr_seq_grupo_doenca_p, valor_bind_p);
end if;

-- CID

if (cd_doenca_cid_p IS NOT NULL AND cd_doenca_cid_p::text <> '') then
	ds_restricao_w :=	ds_restricao_w || pls_util_pck.enter_w ||
					'and	exists ( ' || pls_util_pck.enter_w || 
					'		select	1 ' || pls_util_pck.enter_w || 
					'		from	pls_diagnostico_conta_imp diag ' || pls_util_pck.enter_w || 
					'		where	diag.nr_seq_conta = ' || ds_alias_conta_w || '.nr_sequencia ' || pls_util_pck.enter_w || 
					'		and	diag.cd_doenca_conv = :cd_doenca_cid_pc' || pls_util_pck.enter_w || 
					'	) ';
					
	valor_bind_p := sql_pck.bind_variable(	':cd_doenca_cid_pc', cd_doenca_cid_p, valor_bind_p);
end if;

--Tipo de guia

if (ie_tipo_guia_p IS NOT NULL AND ie_tipo_guia_p::text <> '') then
	ds_restricao_w	:=	ds_restricao_w || pls_util_pck.enter_w ||
					'and ' || ds_alias_prot_w || '.ie_tipo_guia = :ie_tipo_guia_pc';
					
	valor_bind_p := sql_pck.bind_variable(	':ie_tipo_guia_pc', ie_tipo_guia_p, valor_bind_p);
end if;

--Tipo atendimento

if (nr_seq_tipo_atendimento_p IS NOT NULL AND nr_seq_tipo_atendimento_p::text <> '') then
	ds_restricao_w :=	ds_restricao_w || pls_util_pck.enter_w ||
					'and	' || ds_alias_conta_w || '.nr_seq_tipo_atend_conv = :nr_seq_tipo_atendimento_pc';
					
	valor_bind_p := sql_pck.bind_variable(	':nr_seq_tipo_atendimento_pc', nr_seq_tipo_atendimento_p, valor_bind_p);
end if;

--Regime de atendimento

if (ie_regime_atendimento_p IS NOT NULL AND ie_regime_atendimento_p::text <> '') then
	ds_restricao_w :=	ds_restricao_w || pls_util_pck.enter_w ||
					'and	' || ds_alias_conta_w || '.ie_regime_atendimento = :nr_seq_tipo_atendimento_pc';
					
	valor_bind_p := sql_pck.bind_variable(	':ie_regime_atendimento_pc', ie_regime_atendimento_p, valor_bind_p);
end if;


--Saude ocupacional

if (ie_saude_ocupacional_p IS NOT NULL AND ie_saude_ocupacional_p::text <> '') then
	ds_restricao_w :=	ds_restricao_w || pls_util_pck.enter_w ||
					'and	' || ds_alias_conta_w || '.ie_saude_ocupacional = :ie_saude_ocupacional_pc';
					
	valor_bind_p := sql_pck.bind_variable(	':ie_saude_ocupacional_pc', ie_saude_ocupacional_p, valor_bind_p);
end if;

--Motivo saada internaaao

if (nr_seq_saida_int_p IS NOT NULL AND nr_seq_saida_int_p::text <> '') then
	ds_restricao_w :=	ds_restricao_w || pls_util_pck.enter_w ||
					'and	exists	(	select	1 '	|| pls_util_pck.enter_w || 
					'		from	pls_motivo_saida pms	'	|| pls_util_pck.enter_w || 
					'		where	pms.nr_sequencia = :nr_seq_saida_int_pc'	|| pls_util_pck.enter_w || 
					'		and	pms.cd_tiss = '	|| ds_alias_conta_w || '.ie_motivo_encerramento)';
	
	valor_bind_p := sql_pck.bind_variable(	':nr_seq_saida_int_pc', nr_seq_saida_int_p, valor_bind_p);	
end if;

--Regime internaaao

if (ie_regime_internacao_p IS NOT NULL AND ie_regime_internacao_p::text <> '') then
	ds_restricao_w :=	ds_restricao_w || pls_util_pck.enter_w ||
					'and	' || ds_alias_conta_w || '.ie_regime_internacao = :ie_regime_internacao_pc';

	valor_bind_p := sql_pck.bind_variable(	':ie_regime_internacao_pc', ie_regime_internacao_p, valor_bind_p);	
end if;								

--Tipo consulta

if (ie_tipo_conulta_p IS NOT NULL AND ie_tipo_conulta_p::text <> '') then
	ds_restricao_w :=	ds_restricao_w || pls_util_pck.enter_w ||
					'and	' || ds_alias_conta_w || '.ie_tipo_consulta = :ie_tipo_consulta_pc';
					
	valor_bind_p := sql_pck.bind_variable(	':ie_tipo_consulta_pc', ie_tipo_conulta_p, valor_bind_p);
end if;

-- Carater Internaaao

-- Caso tenha algo no filtro ie_carater_internacao busco os campos para depois verificar se entra ou nao na regra, se estiver null retorno null nos campos

if (ie_carater_internacao_p IS NOT NULL AND ie_carater_internacao_p::text <> '') then
	ds_restricao_w :=	ds_restricao_w || pls_util_pck.enter_w ||
					'and	' || ds_alias_conta_w || '.ie_carater_atendimento_conv = :ie_carater_internacao_pc';
					
	valor_bind_p := sql_pck.bind_variable(	':ie_carater_internacao_pc', ie_carater_internacao_p, valor_bind_p);
end if;

--Indicaaao Clanica

if (nr_seq_clinica_p IS NOT NULL AND nr_seq_clinica_p::text <> '') then
	ds_restricao_w :=	ds_restricao_w || pls_util_pck.enter_w ||
					'and	' || ds_alias_conta_w || '.ie_tipo_internacao_conv = :nr_seq_clinica_pc';
					
	valor_bind_p := sql_pck.bind_variable(	':nr_seq_clinica_pc', nr_seq_clinica_p, valor_bind_p);	
end if;

-- Indica se a declaraaao de abito a do recam-nato durante a internaaao da mae

if (ie_indicador_dorn_p = 'S') then
	ds_restricao_w :=	ds_restricao_w || pls_util_pck.enter_w ||
					' and exists  (	select	1' || pls_util_pck.enter_w || 
					'		from	pls_decl_conta_obito_imp x' || pls_util_pck.enter_w || 
					'		where	x.nr_seq_conta = ' || ds_alias_conta_w || '.nr_sequencia' || pls_util_pck.enter_w || 
					' 		and    	x.ie_indicador_dorn = ''S''' || pls_util_pck.enter_w || 
					'		and	x.nr_declaracao is null )';
end if;

-- Tipo internaaao

if (ie_tipo_internado_p IS NOT NULL AND ie_tipo_internado_p::text <> '') then
	ds_restricao_w :=	ds_restricao_w || pls_util_pck.enter_w ||
						'and	' || ds_alias_conta_w || '.ie_tipo_internado_conv = :ie_tipo_internado_pc';
	
	valor_bind_p := sql_pck.bind_variable(	':ie_tipo_internado_pc', ie_tipo_internado_p, valor_bind_p);
end if;

--Se vinculado a um atendimento de internaaao

if (ie_vinc_internacao_p = 'S') then
	ds_restricao_w :=	ds_restricao_w || pls_util_pck.enter_w ||
						'and	' || ds_alias_conta_w || '.ie_vinc_internacao_conv = ''S'' ';
end if;

--Identifica se conta a de recam nascido

if (ie_recem_nascido_p = 'S') then
	ds_restricao_w :=	ds_restricao_w || pls_util_pck.enter_w ||
						'and	' || ds_alias_conta_w || '.ie_recem_nascido = :ie_recem_nascido_pc';
	valor_bind_p := sql_pck.bind_variable(':ie_recem_nascido_pc', ie_recem_nascido_p, valor_bind_p);
end if;

if (ie_indicacao_acidente_p IS NOT NULL AND ie_indicacao_acidente_p::text <> '') then
	begin
	ds_restricao_w :=	ds_restricao_w || pls_util_pck.enter_w ||
						'and	' || ds_alias_conta_w || '.ie_indicacao_acidente = :ie_indicacao_acidente_pc';
	valor_bind_p := sql_pck.bind_variable(':ie_indicacao_acidente_pc', ie_indicacao_acidente_p, valor_bind_p);
	end;
end if;

if (ie_tipo_faturamento_p IS NOT NULL AND ie_tipo_faturamento_p::text <> '') then
	begin
	ds_restricao_w :=	ds_restricao_w || pls_util_pck.enter_w ||
						'and	' || ds_alias_conta_w || '.ie_tipo_faturamento = :ie_tipo_faturamento_p';
	valor_bind_p := sql_pck.bind_variable(':ie_tipo_faturamento_p', ie_tipo_faturamento_p, valor_bind_p);
	end;
end if;

return;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pls_ocor_imp_pck.obter_restricao_conta ( nr_seq_grupo_doenca_p pls_oc_cta_filtro_conta.nr_seq_grupo_doenca%type, cd_doenca_cid_p pls_oc_cta_filtro_conta.cd_doenca_cid%type, ie_tipo_guia_p pls_oc_cta_filtro_conta.ie_tipo_guia%type, nr_seq_tipo_atendimento_p pls_oc_cta_filtro_conta.nr_seq_tipo_atendimento%type, nr_seq_saida_int_p pls_oc_cta_filtro_conta.nr_seq_saida_int%type, ie_regime_internacao_p pls_oc_cta_filtro_conta.ie_regime_internacao%type, ie_tipo_conulta_p pls_oc_cta_filtro_conta.ie_tipo_consulta%type, ie_carater_internacao_p pls_oc_cta_filtro_conta.ie_carater_internacao%type, nr_seq_clinica_p pls_oc_cta_filtro_conta.nr_seq_clinica%type, ie_indicador_dorn_p pls_oc_cta_filtro_conta.ie_indicador_dorn%type, ie_tipo_internado_p pls_oc_cta_filtro_conta.ie_tipo_internado%type, ie_vinc_internacao_p pls_oc_cta_filtro_conta.ie_vinc_internacao%type, ie_recem_nascido_p pls_oc_cta_filtro_conta.ie_recem_nascido%type, ie_indicacao_acidente_p pls_oc_cta_filtro_conta.ie_indicacao_acidente%type, ie_tipo_faturamento_p pls_oc_cta_filtro_conta.ie_tipo_faturamento%type, ie_regime_atendimento_p pls_conta.ie_regime_atendimento%type, ie_saude_ocupacional_p pls_conta.ie_saude_ocupacional%type, valor_bind_p INOUT sql_pck.t_dado_bind) FROM PUBLIC;
