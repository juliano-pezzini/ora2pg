-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_ocor_imp_pck.aplica_filtro_padrao ( ie_incidencia_selecao_regra_p text, ie_processo_excecao_p text, ie_regra_excecao_p pls_oc_cta_combinada.ie_excecao%type, nr_seq_combinada_p pls_oc_cta_combinada.nr_sequencia%type, nr_seq_ocorrencia_p pls_ocorrencia.nr_sequencia%type, dt_inicio_vigencia_p pls_oc_cta_combinada.dt_inicio_vigencia%type, dt_fim_vigencia_p pls_oc_cta_combinada.dt_fim_vigencia%type, nr_id_transacao_p pls_oc_cta_selecao_imp.nr_id_transacao%type, nr_seq_lote_protocolo_p pls_protocolo_conta_imp.nr_seq_lote_protocolo%type, nr_seq_protocolo_p pls_protocolo_conta_imp.nr_sequencia%type, nr_seq_conta_p pls_conta_imp.nr_sequencia%type, nr_seq_conta_proc_p pls_conta_proc_imp.nr_sequencia%type, nr_seq_conta_mat_p pls_conta_mat_imp.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE


ds_select_w		varchar(15000);
valor_bind_w		sql_pck.t_dado_bind;
cursor_w		sql_pck.t_cursor;				
				
tb_seq_conta_w		pls_util_cta_pck.t_number_table;
tb_seq_conta_proc_w	pls_util_cta_pck.t_number_table;
tb_seq_conta_mat_w	pls_util_cta_pck.t_number_table;
tb_guia_referencia_w	pls_util_cta_pck.t_varchar2_table_20;
tb_seq_segurado_w	pls_util_cta_pck.t_number_table;
tb_seq_selecao_w	pls_util_cta_pck.t_number_table;
tb_dt_item_w		pls_util_cta_pck.t_date_table;
tb_dt_item_hora_ini_w	pls_util_cta_pck.t_date_table;
tb_dt_item_hora_fim_w	pls_util_cta_pck.t_date_table;
tb_ie_origem_proced_w	pls_util_cta_pck.t_number_table;
tb_cd_procedimento_w	pls_util_cta_pck.t_number_table;
tb_nr_seq_material_w	pls_util_cta_pck.t_number_table;
	

BEGIN
-- Responsavel por gravar na tabela de seleaao todos os registros necessarios para o

-- processamento de regras que nao utilizam fitros, que contam apenas validaaaes. 


-- Deve ser passado uma regra valida para que a alteraaao seja feita.

if (nr_id_transacao_p IS NOT NULL AND nr_id_transacao_p::text <> '') then
	
	begin
		-- Montar o select padrao juntamente as restriaaes.

		valor_bind_w := pls_ocor_imp_pck.obter_select_filtro(	false, ie_incidencia_selecao_regra_p, null, ie_processo_excecao_p, nr_seq_ocorrencia_p, nr_id_transacao_p, null, nr_seq_lote_protocolo_p, nr_seq_protocolo_p, nr_seq_conta_p, nr_seq_conta_proc_p, nr_seq_conta_mat_p, dt_inicio_vigencia_p, dt_fim_vigencia_p, null, null, null, null, null, null, null, null, null, cd_estabelecimento_p, valor_bind_w);

		-- executa o comando sql com os respectivos binds

		valor_bind_w := sql_pck.executa_sql_cursor(ds_select_w, valor_bind_w);
		
		loop
			fetch cursor_w bulk collect into	tb_seq_conta_w, tb_seq_conta_proc_w,
								tb_seq_conta_mat_w, tb_guia_referencia_w,
								tb_seq_segurado_w, tb_dt_item_w,
								tb_dt_item_hora_ini_w, tb_dt_item_hora_fim_w,
								tb_ie_origem_proced_w, tb_cd_procedimento_w,
								tb_nr_seq_material_w, tb_seq_selecao_w
			limit pls_util_pck.qt_registro_transacao_w;
			exit when tb_seq_conta_w.count = 0;
			
			-- Insere todos os registros das listas na tabela de seleaao

			CALL CALL CALL CALL CALL pls_ocor_imp_pck.gerencia_selecao_filtro(	'FP', ie_regra_excecao_p,
							null, nr_id_transacao_p,
							'S', tb_seq_conta_w,
							tb_seq_conta_proc_w, tb_seq_conta_mat_w,
							tb_guia_referencia_w, tb_seq_segurado_w,
							tb_dt_item_w, tb_dt_item_hora_ini_w,
							tb_dt_item_hora_fim_w, tb_ie_origem_proced_w,
							tb_cd_procedimento_w, tb_nr_seq_material_w,
							tb_seq_selecao_w);
		end loop;
		close cursor_w;
		
	exception
	when others then
		if (cursor_w%isopen) then
			close cursor_w;
		end if;
		-- Exibir a mensagem padrao para as ocorrancias combinadas quando temos algum problema e salvar o log no banco.

		CALL CALL CALL CALL CALL CALL pls_ocor_imp_pck.trata_erro_sql_dinamico(	nr_seq_combinada_p, nr_seq_ocorrencia_p,
						ds_select_w, nr_id_transacao_p,
						nm_usuario_p, 'S');
	end;
end if;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_ocor_imp_pck.aplica_filtro_padrao ( ie_incidencia_selecao_regra_p text, ie_processo_excecao_p text, ie_regra_excecao_p pls_oc_cta_combinada.ie_excecao%type, nr_seq_combinada_p pls_oc_cta_combinada.nr_sequencia%type, nr_seq_ocorrencia_p pls_ocorrencia.nr_sequencia%type, dt_inicio_vigencia_p pls_oc_cta_combinada.dt_inicio_vigencia%type, dt_fim_vigencia_p pls_oc_cta_combinada.dt_fim_vigencia%type, nr_id_transacao_p pls_oc_cta_selecao_imp.nr_id_transacao%type, nr_seq_lote_protocolo_p pls_protocolo_conta_imp.nr_seq_lote_protocolo%type, nr_seq_protocolo_p pls_protocolo_conta_imp.nr_sequencia%type, nr_seq_conta_p pls_conta_imp.nr_sequencia%type, nr_seq_conta_proc_p pls_conta_proc_imp.nr_sequencia%type, nr_seq_conta_mat_p pls_conta_mat_imp.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;
