-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pls_ocor_imp_pck.obter_restricao_prestador ( ie_tipo_prestador_p pls_oc_cta_filtro_prest.ie_tipo_prestador%type, nr_seq_grupo_prestador_p pls_oc_cta_filtro_prest.nr_seq_grupo_prestador%type, nr_seq_classificacao_p pls_oc_cta_filtro_prest.nr_seq_classificacao%type, nr_seq_prestador_p pls_oc_cta_filtro_prest.nr_seq_prestador%type, cd_prestador_p pls_oc_cta_filtro_prest.cd_prestador%type, nr_seq_tipo_prestador_p pls_oc_cta_filtro_prest.nr_seq_tipo_prestador%type, cd_especialidade_medica_p pls_oc_cta_filtro_prest.cd_especialidade_medica%type, ie_tipo_pesssoa_prest_p pls_oc_cta_filtro_prest.ie_tipo_pesssoa_prest%type, valor_bind_p INOUT sql_pck.t_dado_bind) AS $body$
DECLARE


dados_restricao_w	varchar(2500);
ds_restricao_prest_w	varchar(2500);
ds_alias_w		varchar(10);
ds_alias_cta_w		varchar(10);
ds_alias_prot_cta_w	varchar(10);


BEGIN
-- Inicializar o retorno

dados_restricao_w    := null;
ds_restricao_prest_w := null;
ds_alias_w          := 'prest';
ds_alias_cta_w      := pls_ocor_imp_pck.obter_alias_tabela('pls_conta_imp');
ds_alias_prot_cta_w := pls_ocor_imp_pck.obter_alias_tabela('pls_protocolo_conta_imp');

dados_restricao_w := dados_restricao_w || ' and exists( select 1 ' || pls_util_pck.enter_w ||
					'  		from	pls_prestador ' || ds_alias_w || pls_util_pck.enter_w;
					
-- monta a restriaao inicial de acordo com o tipo do prestador

case(ie_tipo_prestador_p)

	when 'E' then
	
		dados_restricao_w := dados_restricao_w || '		where 	' || ds_alias_w || '.nr_sequencia = ' || ds_alias_cta_w || '.nr_seq_prest_exec_conv ' || pls_util_pck.enter_w;
	when 'A' then
	
		dados_restricao_w := dados_restricao_w || '		where 	' || ds_alias_w || '.nr_sequencia = ' || ds_alias_prot_cta_w || '.nr_seq_prestador_conv ' || pls_util_pck.enter_w;
	when 'S' then
	
		dados_restricao_w := dados_restricao_w || '		where 	' || ds_alias_w || '.nr_sequencia = ' || ds_alias_cta_w || '.nr_seq_prest_solic_conv ' || pls_util_pck.enter_w;
	else
		dados_restricao_w := null;
end case;

-- Grupo de prestadores

if (nr_seq_grupo_prestador_p IS NOT NULL AND nr_seq_grupo_prestador_p::text <> '') then
	
	ds_restricao_prest_w := ds_restricao_prest_w || '	and	(select count(1) ' || pls_util_pck.enter_w ||
							' 		from table(pls_grupos_pck.obter_prestadores_grupo( ' || pls_util_pck.enter_w ||
							' 		:nr_seq_grupo_prest_pc, ' || ds_alias_w || '.nr_sequencia))) > 0 ' || pls_util_pck.enter_w;
	valor_bind_p := sql_pck.bind_variable(':nr_seq_grupo_prest_pc', nr_seq_grupo_prestador_p, valor_bind_p);
end if;

-- Classificaaao do prestador

if (nr_seq_classificacao_p IS NOT NULL AND nr_seq_classificacao_p::text <> '') then
	
	ds_restricao_prest_w :=	ds_restricao_prest_w || '	and	' || ds_alias_w || '.nr_seq_classificacao = :nr_seq_classificacao_pc ' || pls_util_pck.enter_w;
	valor_bind_p := sql_pck.bind_variable(	':nr_seq_classificacao_pc', nr_seq_classificacao_p, valor_bind_p);
end if;

-- Seq prestador

if (nr_seq_prestador_p IS NOT NULL AND nr_seq_prestador_p::text <> '') then
	
	ds_restricao_prest_w :=	ds_restricao_prest_w || '	and	' || ds_alias_w || '.nr_sequencia = :nr_seq_prestador_pc' || pls_util_pck.enter_w;
	valor_bind_p := sql_pck.bind_variable(	':nr_seq_prestador_pc', nr_seq_prestador_p, valor_bind_p);
end if;

-- Cadigo prestador

if (cd_prestador_p IS NOT NULL AND cd_prestador_p::text <> '') then
	
	ds_restricao_prest_w :=	ds_restricao_prest_w || '	and	' || ds_alias_w || '.cd_prestador = :cd_prestador_pc' || pls_util_pck.enter_w;
	valor_bind_p := sql_pck.bind_variable(	':cd_prestador_pc', cd_prestador_p, valor_bind_p);
end if;

-- Tipo de prestador

if (nr_seq_tipo_prestador_p IS NOT NULL AND nr_seq_tipo_prestador_p::text <> '') then

	ds_restricao_prest_w :=	ds_restricao_prest_w || '	and	' || ds_alias_w || '.nr_seq_tipo_prestador = :nr_seq_tipo_prest_pc ' || pls_util_pck.enter_w;
	valor_bind_p := sql_pck.bind_variable(	':nr_seq_tipo_prest_pc', nr_seq_tipo_prestador_p, valor_bind_p);
end if;

-- Especialidade prestador

if (cd_especialidade_medica_p IS NOT NULL AND cd_especialidade_medica_p::text <> '') then
	
	ds_restricao_prest_w :=	ds_restricao_prest_w || '	and exists(	select	1 ' || pls_util_pck.enter_w ||
							'		from	pls_prestador_med_espec espec ' || pls_util_pck.enter_w ||
							'		where	espec.nr_seq_prestador = ' || ds_alias_w || '.nr_sequencia ' || pls_util_pck.enter_w ||
							'		and	espec.cd_especialidade = :cd_especial_prest_pc ' || pls_util_pck.enter_w ||
							'		and	' || ds_alias_cta_w || '.dt_atendimento_conv between '||
									' espec.dt_inicio_vigencia_ref and espec.dt_fim_vigencia_ref ) ';
	valor_bind_p := sql_pck.bind_variable(	':cd_especial_prest_pc', cd_especialidade_medica_p, valor_bind_p);
end if;

-- Tipo pessoa prestador

if (ie_tipo_pesssoa_prest_p <> 'A') then
	if (ie_tipo_pesssoa_prest_p = 'PF') then
		ds_restricao_prest_w :=	ds_restricao_prest_w || pls_util_pck.enter_w ||
					'and	' || ds_alias_w || '.cd_pessoa_fisica is not null  ';
	elsif (ie_tipo_pesssoa_prest_p = 'PJ') then
		ds_restricao_prest_w :=	ds_restricao_prest_w || pls_util_pck.enter_w ||
					'and	' || ds_alias_w || '.cd_cgc is not null  ';
	end if;
end if;

-- verifica se existe algum filtro que utiliza o exists, caso nao existir devolve como null

if (ds_restricao_prest_w IS NOT NULL AND ds_restricao_prest_w::text <> '') then

	dados_restricao_w := dados_restricao_w || ds_restricao_prest_w || ' ) ' || pls_util_pck.enter_w;
else
	dados_restricao_w := null;
end if;

return;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pls_ocor_imp_pck.obter_restricao_prestador ( ie_tipo_prestador_p pls_oc_cta_filtro_prest.ie_tipo_prestador%type, nr_seq_grupo_prestador_p pls_oc_cta_filtro_prest.nr_seq_grupo_prestador%type, nr_seq_classificacao_p pls_oc_cta_filtro_prest.nr_seq_classificacao%type, nr_seq_prestador_p pls_oc_cta_filtro_prest.nr_seq_prestador%type, cd_prestador_p pls_oc_cta_filtro_prest.cd_prestador%type, nr_seq_tipo_prestador_p pls_oc_cta_filtro_prest.nr_seq_tipo_prestador%type, cd_especialidade_medica_p pls_oc_cta_filtro_prest.cd_especialidade_medica%type, ie_tipo_pesssoa_prest_p pls_oc_cta_filtro_prest.ie_tipo_pesssoa_prest%type, valor_bind_p INOUT sql_pck.t_dado_bind) FROM PUBLIC;
