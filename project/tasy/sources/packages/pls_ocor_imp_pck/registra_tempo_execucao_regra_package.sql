-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_ocor_imp_pck.registra_tempo_execucao_regra ( nr_seq_lote_protocolo_p pls_protocolo_conta_imp.nr_seq_lote_protocolo%type, nr_seq_protocolo_p pls_protocolo_conta.nr_sequencia%type, nr_seq_conta_p pls_conta.nr_sequencia%type, nr_seq_conta_proc_p pls_conta_proc.nr_sequencia%type, nr_seq_conta_mat_p pls_conta_mat.nr_sequencia%type, nr_seq_combinada_p pls_oc_cta_combinada.nr_sequencia%type, nr_seq_ocorrencia_p pls_ocorrencia.nr_sequencia%type, dt_inicio_processo_p pls_oc_cta_log_tempo_imp.dt_inicio_processo%type, dt_fim_processo_p pls_oc_cta_log_tempo_imp.dt_fim_processo%type, nm_usuario_p usuario.nm_usuario%type, ie_processo_final_p text) AS $body$
DECLARE
_ora2pg_r RECORD;
BEGIN

-- sa alimenta as variaveis se nao for o processo final

if (ie_processo_final_p = 'N') then
	-- variaveis globais protegidas da package

	current_setting('pls_ocor_imp_pck.tb_ter_nm_usuario_w')::pls_util_cta_pck.t_varchar2_table_15(current_setting('pls_ocor_imp_pck.nr_indice_ter_w')::integer) := nm_usuario_p;
	current_setting('pls_ocor_imp_pck.tb_ter_nr_seq_lote_w')::pls_util_cta_pck.t_number_table(current_setting('pls_ocor_imp_pck.nr_indice_ter_w')::integer) := nr_seq_lote_protocolo_p;
	current_setting('pls_ocor_imp_pck.tb_ter_nr_seq_protocolo_w')::pls_util_cta_pck.t_number_table(current_setting('pls_ocor_imp_pck.nr_indice_ter_w')::integer) := nr_seq_protocolo_p;
	current_setting('pls_ocor_imp_pck.tb_ter_nr_seq_conta_w')::pls_util_cta_pck.t_number_table(current_setting('pls_ocor_imp_pck.nr_indice_ter_w')::integer) := nr_seq_conta_p;
	current_setting('pls_ocor_imp_pck.tb_ter_nr_seq_conta_proc_w')::pls_util_cta_pck.t_number_table(current_setting('pls_ocor_imp_pck.nr_indice_ter_w')::integer) := nr_seq_conta_proc_p;
	current_setting('pls_ocor_imp_pck.tb_ter_nr_seq_conta_mat_w')::pls_util_cta_pck.t_number_table(current_setting('pls_ocor_imp_pck.nr_indice_ter_w')::integer) := nr_seq_conta_mat_p;
	current_setting('pls_ocor_imp_pck.tb_ter_nr_seq_regra_comb_w')::pls_util_cta_pck.t_number_table(current_setting('pls_ocor_imp_pck.nr_indice_ter_w')::integer) := nr_seq_combinada_p;
	current_setting('pls_ocor_imp_pck.tb_ter_nr_seq_ocorrencia_w')::pls_util_cta_pck.t_number_table(current_setting('pls_ocor_imp_pck.nr_indice_ter_w')::integer) := nr_seq_ocorrencia_p;
	current_setting('pls_ocor_imp_pck.tb_ter_dt_inicio_processo_w')::pls_util_cta_pck.t_date_table(current_setting('pls_ocor_imp_pck.nr_indice_ter_w')::integer) := dt_inicio_processo_p;
	current_setting('pls_ocor_imp_pck.tb_ter_dt_fim_processo_w')::pls_util_cta_pck.t_date_table(current_setting('pls_ocor_imp_pck.nr_indice_ter_w')::integer) := dt_fim_processo_p;
	current_setting('pls_ocor_imp_pck.tb_ter_ds_tempo_execucao_w')::pls_util_cta_pck.t_varchar2_table_50(current_setting('pls_ocor_imp_pck.nr_indice_ter_w')::integer) := pls_manipulacao_datas_pck.obter_tempo_execucao_format( dt_inicio_processo_p
													    , dt_fim_processo_p);
end if;

-- se atingiu a quantidade ou a o processo final grava os dados na tabela 

if (current_setting('pls_ocor_imp_pck.nr_indice_ter_w')::integer >= pls_util_pck.qt_registro_transacao_w or ie_processo_final_p = 'S') then
	
	if (current_setting('pls_ocor_imp_pck.tb_ter_dt_inicio_processo_w')::pls_util_cta_pck.t_date_table.count > 0) then
	
		forall i in current_setting('pls_ocor_imp_pck.tb_ter_dt_inicio_processo_w')::pls_util_cta_pck.t_date_table.first .. current_setting('pls_ocor_imp_pck.tb_ter_dt_inicio_processo_w')::pls_util_cta_pck.t_date_table.last
		
			insert into pls_oc_cta_log_tempo_imp(	
				nr_sequencia, dt_atualizacao, nm_usuario,
				dt_atualizacao_nrec, nm_usuario_nrec, nr_seq_lote_conta,
				nr_seq_protocolo, nr_seq_conta, nr_seq_conta_proc,
				nr_seq_conta_mat, nr_seq_regra_comb, nr_seq_ocorrencia,
				dt_inicio_processo, dt_fim_processo, ds_tempo_execucao
			) values (
				nextval('pls_oc_cta_log_tempo_imp_seq'), clock_timestamp(), current_setting('pls_ocor_imp_pck.tb_ter_nm_usuario_w')::pls_util_cta_pck.t_varchar2_table_15(i),
				clock_timestamp(), current_setting('pls_ocor_imp_pck.tb_ter_nm_usuario_w')::pls_util_cta_pck.t_varchar2_table_15(i), current_setting('pls_ocor_imp_pck.tb_ter_nr_seq_lote_w')::pls_util_cta_pck.t_number_table(i),
				current_setting('pls_ocor_imp_pck.tb_ter_nr_seq_protocolo_w')::pls_util_cta_pck.t_number_table(i), current_setting('pls_ocor_imp_pck.tb_ter_nr_seq_conta_w')::pls_util_cta_pck.t_number_table(i), current_setting('pls_ocor_imp_pck.tb_ter_nr_seq_conta_proc_w')::pls_util_cta_pck.t_number_table(i),
				current_setting('pls_ocor_imp_pck.tb_ter_nr_seq_conta_mat_w')::pls_util_cta_pck.t_number_table(i), current_setting('pls_ocor_imp_pck.tb_ter_nr_seq_regra_comb_w')::pls_util_cta_pck.t_number_table(i), current_setting('pls_ocor_imp_pck.tb_ter_nr_seq_ocorrencia_w')::pls_util_cta_pck.t_number_table(i),
				current_setting('pls_ocor_imp_pck.tb_ter_dt_inicio_processo_w')::pls_util_cta_pck.t_date_table(i), current_setting('pls_ocor_imp_pck.tb_ter_dt_fim_processo_w')::pls_util_cta_pck.t_date_table(i), current_setting('pls_ocor_imp_pck.tb_ter_ds_tempo_execucao_w')::pls_util_cta_pck.t_varchar2_table_50(i)
			);
		commit;
	end if;
	-- limpa as variaveis

	SELECT * FROM pls_ocor_imp_pck.limpa_dados_tempo_exec(	current_setting('pls_ocor_imp_pck.tb_ter_nm_usuario_w')::pls_util_cta_pck.t_varchar2_table_15, current_setting('pls_ocor_imp_pck.tb_ter_nr_seq_lote_w')::pls_util_cta_pck.t_number_table, current_setting('pls_ocor_imp_pck.tb_ter_nr_seq_protocolo_w')::pls_util_cta_pck.t_number_table, current_setting('pls_ocor_imp_pck.tb_ter_nr_seq_conta_w')::pls_util_cta_pck.t_number_table, current_setting('pls_ocor_imp_pck.tb_ter_nr_seq_conta_proc_w')::pls_util_cta_pck.t_number_table, current_setting('pls_ocor_imp_pck.tb_ter_nr_seq_conta_mat_w')::pls_util_cta_pck.t_number_table, current_setting('pls_ocor_imp_pck.tb_ter_nr_seq_regra_comb_w')::pls_util_cta_pck.t_number_table, current_setting('pls_ocor_imp_pck.tb_ter_nr_seq_ocorrencia_w')::pls_util_cta_pck.t_number_table, current_setting('pls_ocor_imp_pck.tb_ter_dt_inicio_processo_w')::pls_util_cta_pck.t_date_table, current_setting('pls_ocor_imp_pck.tb_ter_dt_fim_processo_w')::pls_util_cta_pck.t_date_table, current_setting('pls_ocor_imp_pck.tb_ter_ds_tempo_execucao_w')::pls_util_cta_pck.t_varchar2_table_50, current_setting('pls_ocor_imp_pck.nr_indice_ter_w')::integer) INTO STRICT _ora2pg_r;
 	current_setting('pls_ocor_imp_pck.tb_ter_nm_usuario_w')::pls_util_cta_pck.t_varchar2_table_15 := _ora2pg_r.tb_ter_nm_usuario_p; current_setting('pls_ocor_imp_pck.tb_ter_nr_seq_lote_w')::pls_util_cta_pck.t_number_table := _ora2pg_r.tb_ter_nr_seq_lote_p; current_setting('pls_ocor_imp_pck.tb_ter_nr_seq_protocolo_w')::pls_util_cta_pck.t_number_table := _ora2pg_r.tb_ter_nr_seq_protocolo_p; current_setting('pls_ocor_imp_pck.tb_ter_nr_seq_conta_w')::pls_util_cta_pck.t_number_table := _ora2pg_r.tb_ter_nr_seq_conta_p; current_setting('pls_ocor_imp_pck.tb_ter_nr_seq_conta_proc_w')::pls_util_cta_pck.t_number_table := _ora2pg_r.tb_ter_nr_seq_conta_proc_p; current_setting('pls_ocor_imp_pck.tb_ter_nr_seq_conta_mat_w')::pls_util_cta_pck.t_number_table := _ora2pg_r.tb_ter_nr_seq_conta_mat_p; current_setting('pls_ocor_imp_pck.tb_ter_nr_seq_regra_comb_w')::pls_util_cta_pck.t_number_table := _ora2pg_r.tb_ter_nr_seq_regra_comb_p; current_setting('pls_ocor_imp_pck.tb_ter_nr_seq_ocorrencia_w')::pls_util_cta_pck.t_number_table := _ora2pg_r.tb_ter_nr_seq_ocorrencia_p; current_setting('pls_ocor_imp_pck.tb_ter_dt_inicio_processo_w')::pls_util_cta_pck.t_date_table := _ora2pg_r.tb_ter_dt_inicio_processo_p; current_setting('pls_ocor_imp_pck.tb_ter_dt_fim_processo_w')::pls_util_cta_pck.t_date_table := _ora2pg_r.tb_ter_dt_fim_processo_p; current_setting('pls_ocor_imp_pck.tb_ter_ds_tempo_execucao_w')::pls_util_cta_pck.t_varchar2_table_50 := _ora2pg_r.tb_ter_ds_tempo_execucao_p; current_setting('pls_ocor_imp_pck.nr_indice_ter_w')::integer := _ora2pg_r.nr_indice_ter_p;
else
	PERFORM set_config('pls_ocor_imp_pck.nr_indice_ter_w', current_setting('pls_ocor_imp_pck.nr_indice_ter_w')::integer + 1, false);
end if;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_ocor_imp_pck.registra_tempo_execucao_regra ( nr_seq_lote_protocolo_p pls_protocolo_conta_imp.nr_seq_lote_protocolo%type, nr_seq_protocolo_p pls_protocolo_conta.nr_sequencia%type, nr_seq_conta_p pls_conta.nr_sequencia%type, nr_seq_conta_proc_p pls_conta_proc.nr_sequencia%type, nr_seq_conta_mat_p pls_conta_mat.nr_sequencia%type, nr_seq_combinada_p pls_oc_cta_combinada.nr_sequencia%type, nr_seq_ocorrencia_p pls_ocorrencia.nr_sequencia%type, dt_inicio_processo_p pls_oc_cta_log_tempo_imp.dt_inicio_processo%type, dt_fim_processo_p pls_oc_cta_log_tempo_imp.dt_fim_processo%type, nm_usuario_p usuario.nm_usuario%type, ie_processo_final_p text) FROM PUBLIC;
