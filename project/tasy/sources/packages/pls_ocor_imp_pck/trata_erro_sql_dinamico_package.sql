-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_ocor_imp_pck.trata_erro_sql_dinamico ( nr_seq_combinada_p pls_oc_cta_combinada.nr_sequencia%type, nr_seq_ocorrencia_p pls_ocorrencia.nr_sequencia%type, ds_select_p text, nr_id_transacao_p pls_oc_cta_selecao_imp.nr_id_transacao%type, nm_usuario_p usuario.nm_usuario%type, ie_grava_log_p text) AS $body$
DECLARE


ds_log_w	pls_oc_cta_log_erro_imp.ds_log%type;


BEGIN
-- Desfazer qualquer alteraaao anterior;

rollback;

-- Limpar a tabela de seleaao.

CALL CALL CALL CALL CALL pls_ocor_imp_pck.limpar_transacao(nr_id_transacao_p);

-- como isso a chamado varias vezes dentro das rotinas feito tratamento via parametro

-- e grava somente no tratamento de exceaao da pls_oc_cta_gerar_combinada_imp

if (ie_grava_log_p = 'S') then
	
	-- Se nao foi preenchido ainda entao preenche com o atual.

	if (current_setting('pls_ocor_imp_pck.ds_sql_erro_w')::coalesce(varchar(32000)::text, '') = '') then
		
		-- obter o callstack

		PERFORM set_config('pls_ocor_imp_pck.ds_stack_w', dbms_utility.format_call_stack, false);
		PERFORM set_config('pls_ocor_imp_pck.ds_err_stack_w', dbms_utility.format_error_backtrace, false);
		PERFORM set_config('pls_ocor_imp_pck.ds_sql_erro_w', ds_select_p, false);
		PERFORM set_config('pls_ocor_imp_pck.ds_sqlerrm_w', sqlerrm, false);
	end if;

	-- Obter o log a ser gravado

	ds_log_w	:= substr(
				'Ocorrencia: ' || nr_seq_ocorrencia_p || pls_util_pck.enter_w ||
				'Regra: ' || nr_seq_combinada_p || pls_util_pck.enter_w ||
				'Erro: ' || current_setting('pls_ocor_imp_pck.ds_sqlerrm_w')::varchar(4000) || pls_util_pck.enter_w || pls_util_pck.enter_w ||
				'SQL: ' || pls_util_pck.enter_w ||
				current_setting('pls_ocor_imp_pck.ds_sql_erro_w')::varchar(32000) || pls_util_pck.enter_w || pls_util_pck.enter_w ||
				'Stack:' || pls_util_pck.enter_w ||
				current_setting('pls_ocor_imp_pck.ds_stack_w')::varchar(4000) || pls_util_pck.enter_w ||
				'Error Back Trace: ' || pls_util_pck.enter_w ||
				current_setting('pls_ocor_imp_pck.ds_err_stack_w')::varchar(4000), 1, 4000);
	
	-- Anula os dados para a praxima execuaao.

	PERFORM set_config('pls_ocor_imp_pck.ds_sql_erro_w', null, false);
	PERFORM set_config('pls_ocor_imp_pck.ds_stack_w', null, false);
	PERFORM set_config('pls_ocor_imp_pck.ds_err_stack_w', null, false);
	
	-- Grava o log na tabela;

	insert into pls_oc_cta_log_erro_imp(nr_sequencia,
		nm_usuario,
		dt_atualizacao,
		nr_id_transacao,
		ds_log)
	values (nextval('pls_oc_cta_log_erro_imp_seq'),
		nm_usuario_p,
		clock_timestamp(),
		nr_id_transacao_p,
		ds_log_w);
	commit;	
else
	-- Se nao salva o erro para usar depois,

	PERFORM set_config('pls_ocor_imp_pck.ds_sql_erro_w', ds_select_p, false);
	-- obter o callstack

	PERFORM set_config('pls_ocor_imp_pck.ds_stack_w', dbms_utility.format_call_stack, false);
	PERFORM set_config('pls_ocor_imp_pck.ds_err_stack_w', dbms_utility.format_error_backtrace, false);
	PERFORM set_config('pls_ocor_imp_pck.ds_sqlerrm_w', sqlerrm, false);
end if;
	
CALL wheb_mensagem_pck.exibir_mensagem_abort(355574,	'OCOR=' || nr_seq_ocorrencia_p ||
						';REGRA=' || nr_seq_combinada_p || 
						';ERRO=' || current_setting('pls_ocor_imp_pck.ds_sql_erro_w')::varchar(32000) || ' ' || current_setting('pls_ocor_imp_pck.ds_stack_w')::varchar(4000) || ' ' || current_setting('pls_ocor_imp_pck.ds_err_stack_w')::varchar(4000) || ' ' || current_setting('pls_ocor_imp_pck.ds_sqlerrm_w')::varchar(4000));
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_ocor_imp_pck.trata_erro_sql_dinamico ( nr_seq_combinada_p pls_oc_cta_combinada.nr_sequencia%type, nr_seq_ocorrencia_p pls_ocorrencia.nr_sequencia%type, ds_select_p text, nr_id_transacao_p pls_oc_cta_selecao_imp.nr_id_transacao%type, nm_usuario_p usuario.nm_usuario%type, ie_grava_log_p text) FROM PUBLIC;
