-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pck_glucose_control.get_data_graph_unit (dt_inicio_p timestamp, dt_fim_p timestamp, cd_unidade_p text, nr_relatorio_p bigint) AS $body$
DECLARE

      c1 CURSOR FOR
        SELECT trunc(100 * sum(t.nr_normal) / sum(t.nr_normal+t.nr_hipo+t.nr_hiper), 2) valor,
               'Glucose Compliance' label,
               cd_setor_atendimento,
               to_char(to_date(dt_controle, 'YYYY-MM'), 'FMMONTH"-" yyyy', 'nls_date_language=english') mes_ano
          from w_rep_glucose_control_unit t
         where nm_usuario  = wheb_usuario_pck.get_nm_usuario
           and nr_relatorio = nr_relatorio_p
         group by cd_setor_atendimento, to_char(to_date(dt_controle, 'YYYY-MM'), 'FMMONTH"-" yyyy', 'nls_date_language=english')

union

        SELECT trunc(100 * sum(t.nr_hipo) / sum(t.nr_normal+t.nr_hipo+t.nr_hiper), 2) valor,
               'Low Glucose' label,
               cd_setor_atendimento,
               to_char(to_date(dt_controle, 'YYYY-MM'), 'FMMONTH"-" yyyy', 'nls_date_language=english') mes_ano
          from w_rep_glucose_control_unit t
         where nm_usuario  = wheb_usuario_pck.get_nm_usuario
           and nr_relatorio = nr_relatorio_p
         group by cd_setor_atendimento, to_char(to_date(dt_controle, 'YYYY-MM'), 'FMMONTH"-" yyyy', 'nls_date_language=english')
        
union

        select trunc(100 * sum(t.nr_hiper) / sum(t.nr_normal+t.nr_hipo+t.nr_hiper), 2) valor,
               'High Glucose' label,
               cd_setor_atendimento,
               to_char(to_date(dt_controle, 'YYYY-MM'), 'FMMONTH"-" yyyy', 'nls_date_language=english') mes_ano
          from w_rep_glucose_control_unit t
         where nm_usuario  = wheb_usuario_pck.get_nm_usuario
           and nr_relatorio = nr_relatorio_p
         group by cd_setor_atendimento, to_char(to_date(dt_controle, 'YYYY-MM'), 'FMMONTH"-" yyyy', 'nls_date_language=english');
      r1 c1%rowtype;

BEGIN
      --Limpa tabela W
      delete FROM w_grp_glucose_control_unit
       where nm_usuario  = wheb_usuario_pck.get_nm_usuario
         and nr_relatorio = nr_relatorio_p;

      --Abre cursor principal
      open c1;
      loop
         fetch c1
            into r1;
         EXIT WHEN NOT FOUND; /* apply on c1 */

         
         insert into w_grp_glucose_control_unit(nm_usuario,
             dt_atualizacao,
             nr_relatorio,
             valor,
             label,
             cd_setor_atendimento,
             nr_mes_ano)
         values (wheb_usuario_pck.get_nm_usuario,
             clock_timestamp(),
             nr_relatorio_p,
             r1.valor,
             r1.label,
             r1.cd_setor_atendimento,
             r1.mes_ano);

      end loop;
      close c1;

      --
      commit;
   END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pck_glucose_control.get_data_graph_unit (dt_inicio_p timestamp, dt_fim_p timestamp, cd_unidade_p text, nr_relatorio_p bigint) FROM PUBLIC;
