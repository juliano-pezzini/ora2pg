-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pck_glucose_control.get_data_graph (dt_inicio_p timestamp, dt_fim_p timestamp, cd_unidade_p text, nr_relatorio_p bigint) AS $body$
DECLARE

      c1 CURSOR FOR
        SELECT trunc(100 * sum(t.nr_normal) / sum(t.nr_normal+t.nr_hipo+t.nr_hiper), 2) valor,
               'Glucose Compliance' label
          from w_rep_glucose_control t
         where nm_usuario  = wheb_usuario_pck.get_nm_usuario
           and nr_relatorio = nr_relatorio_p

union

        SELECT trunc(100 * sum(t.nr_hipo) / sum(t.nr_normal+t.nr_hipo+t.nr_hiper), 2) valor,
               'Low Glucose' label
          from w_rep_glucose_control t
         where nm_usuario  = wheb_usuario_pck.get_nm_usuario
           and nr_relatorio = nr_relatorio_p
        
union

        select trunc(100 * sum(t.nr_hiper) / sum(t.nr_normal+t.nr_hipo+t.nr_hiper), 2) valor,
               'High Glucose' label
          from w_rep_glucose_control t
         where nm_usuario  = wheb_usuario_pck.get_nm_usuario
           and nr_relatorio = nr_relatorio_p;
        /*select perc as valor, 
               ds_resultado as label
          from (select dt_controle, 
                       sum(perc) perc, 
                       ds_resultado
                  from (select dt_controle,
                               trim(nvl(to_char(trunc((sum(qtd) / decode(total,0,1,total)) * 100, 2), '999G999G990D00'),0)) perc,
                               ds_resultado
                          from (select to_char(rg.dt_controle, 'YYYY-MM') dt_controle,
                                       rg.nr_atendimento,
                                       sum(rg.qtd) qtd,
                                       (select sum(r.qtd) total
                                          from rel_resultado_glicemia_v r
                                         where to_char(r.dt_controle, 'YYYY-MM') = to_char(rg.dt_controle, 'YYYY-MM')
                                           and r.nr_atendimento = rg.nr_atendimento
                                         group by to_char(r.dt_controle, 'YYYY-MM')) total,
                                       rg.ds_resultado
                                  from rel_resultado_glicemia_v rg
                                 where rg.dt_controle between dt_inicio_p and fim_dia(dt_fim_p)
                                   and rg.ds_resultado = 'Glucose Compliance'
                                   and ((cd_unidade_p is null) or (obter_se_contido(obter_setor_atendimento(rg.nr_atendimento), cd_unidade_p) = 'S'))
                                   and rg.nr_seq_protocolo = PKG_REPORT_DATA.GET_PROTOCOL(4)
                                 group by rg.nr_atendimento,
                                          rg.dt_controle,
                                          rg.ds_resultado
                                union all
                                select to_char(rg.dt_controle, 'YYYY-MM') dt_controle,
                                       rg.nr_atendimento,
                                       sum(rg.qtd) qtd,
                                       (select sum(r.qtd) total
                                          from rel_resultado_glicemia_v r
                                         where to_char(r.dt_controle, 'YYYY-MM') = to_char(rg.dt_controle, 'YYYY-MM')
                                           and r.nr_atendimento = rg.nr_atendimento
                                         group by to_char(r.dt_controle, 'YYYY-MM')) total,
                                       rg.ds_resultado
                                  from rel_resultado_glicemia_v rg
                                 where rg.dt_controle between dt_inicio_p and fim_dia(dt_fim_p)
                                   and rg.ds_resultado = 'Low Glucose'
                                   and ((cd_unidade_p is null) or (obter_se_contido(obter_setor_atendimento(rg.nr_atendimento), cd_unidade_p) = 'S'))
                                   and rg.nr_seq_protocolo = PKG_REPORT_DATA.GET_PROTOCOL(4)
                                 group by rg.nr_atendimento,
                                          rg.dt_controle,
                                          rg.ds_resultado
                                union all
                                select to_char(rg.dt_controle, 'YYYY-MM') dt_controle,
                                       rg.nr_atendimento,
                                       sum(rg.qtd) qtd,
                                       (select sum(r.qtd) total
                                          from rel_resultado_glicemia_v r
                                         where to_char(r.dt_controle, 'YYYY-MM') = to_char(rg.dt_controle, 'YYYY-MM')
                                           and r.nr_atendimento = rg.nr_atendimento
                                         group by to_char(r.dt_controle, 'YYYY-MM')) total,
                                       rg.ds_resultado
                                  from rel_resultado_glicemia_v rg
                                 where rg.dt_controle between dt_inicio_p and fim_dia(dt_fim_p)
                                   and rg.ds_resultado = 'High Glucose'
                                   and ((cd_unidade_p is null) or (obter_se_contido(obter_setor_atendimento(rg.nr_atendimento), cd_unidade_p) = 'S'))
                                   and rg.nr_seq_protocolo = PKG_REPORT_DATA.GET_PROTOCOL(4)
                                 group by rg.nr_atendimento,
                                          rg.dt_controle,
                                          rg.ds_resultado)
                         group by dt_controle, total, ds_resultado
                         order by dt_controle desc)
                 group by dt_controle, ds_resultado
                 order by dt_controle desc); */
      r1 c1%rowtype;

BEGIN
      --Limpa tabela W
      delete FROM w_grp_glucose_control 
       where nm_usuario  = wheb_usuario_pck.get_nm_usuario
         and nr_relatorio = nr_relatorio_p;

      --Abre cursor principal
      open c1;
      loop
         fetch c1
            into r1;
         EXIT WHEN NOT FOUND; /* apply on c1 */

         
         insert into w_grp_glucose_control_unit(nm_usuario,
             dt_atualizacao,
             nr_relatorio,
             valor,
             label)
         values (wheb_usuario_pck.get_nm_usuario,
             clock_timestamp(),
             nr_relatorio_p,
             r1.valor,
             r1.label);

      end loop;
      close c1;

      --
      commit;
   END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pck_glucose_control.get_data_graph (dt_inicio_p timestamp, dt_fim_p timestamp, cd_unidade_p text, nr_relatorio_p bigint) FROM PUBLIC;
