-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_sib_selecao_benef_pck.remover_benef_migrado ((dt_referencia_p timestamp) is  --Essa procedure é necessária para remover os beneficiários que foram migrados. Quanod existe a migração, somente o último beneficiário é considerado
 tb_nr_seq_segurado_w pls_util_cta_pck.t_number_table) AS $body$
DECLARE

	PERFORM	t.nr_seq_segurado
	from (	SELECT	nr_seq_segurado,
			(select	max(x.nr_sequencia)
			from	pls_segurado x
			where	x.cd_cco = b.cd_cco) nr_seq_seg_migrado
		from	pls_sib_selecao_temp a,
			pls_segurado b
		where	b.nr_sequencia = a.nr_seq_segurado
		and	(b.cd_cco IS NOT NULL AND b.cd_cco::text <> '')) t
	where	t.nr_seq_segurado <> t.nr_seq_seg_migrado
	and	not exists (	select 	1
				from	pls_segurado_status x
				where	x.nr_seq_segurado = t.nr_seq_segurado
				and	x.ie_envio_sib = 5
				and	coalesce(pls_sib_obter_lote_status(x.nr_sequencia,'I')::text, '') = '');


BEGIN
open C01;
loop
	fetch C01 bulk collect into current_setting('pls_sib_selecao_benef_pck.tb_nr_seq_segurado_w')::pls_util_cta_pck.t_number_table limit 1000;
	exit when current_setting('pls_sib_selecao_benef_pck.tb_nr_seq_segurado_w')::pls_util_cta_pck.t_number_table.count = 0;
	
	forall i in current_setting('pls_sib_selecao_benef_pck.tb_nr_seq_segurado_w')::pls_util_cta_pck.t_number_table.first..tb_nr_seq_segurado_w.last
		delete from pls_sib_selecao_temp where nr_seq_segurado = current_setting('pls_sib_selecao_benef_pck.tb_nr_seq_segurado_w')::pls_util_cta_pck.t_number_table(i);
	commit;
end loop;
close C01;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_sib_selecao_benef_pck.remover_benef_migrado ((dt_referencia_p timestamp) is  tb_nr_seq_segurado_w pls_util_cta_pck.t_number_table) FROM PUBLIC;
