-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


--
-- dblink wrapper to call function tasy_sqltune_advisor_main_pck.obter_analise() as an autonomous transaction
--
CREATE EXTENSION IF NOT EXISTS dblink;

CREATE OR REPLACE FUNCTION tasy_sqltune_advisor_main_pck.obter_analise ( ds_sql_p text) RETURNS SETOF T_OBJETO_ROW_DATA AS $body$
DECLARE
	-- Change this to reflect the dblink connection string
	v_conn_str  text := format('port=%s dbname=%s user=%s', current_setting('port'), current_database(), current_user);
	v_query     text;

	v_ret	T_OBJETO_ROW_DATA;
BEGIN
	v_query := 'SELECT * FROM tasy_sqltune_advisor_main_pck.obter_analise_atx ( ' || quote_nullable(ds_sql_p) || ' )';
	SELECT * INTO v_ret FROM dblink(v_conn_str, v_query) AS p (ret T_OBJETO_ROW_DATA);
	RETURN v_ret;

END;
$body$ LANGUAGE plpgsql SECURITY DEFINER;




CREATE OR REPLACE FUNCTION tasy_sqltune_advisor_main_pck.obter_analise_atx ( ds_sql_p text) RETURNS SETOF T_OBJETO_ROW_DATA AS $body$
DECLARE

ds_task_w	varchar(255);
ds_retorno_w	text;
qt_tamanho_w	bigint;
qt_multiplo_w	bigint	:= 4000;
nr_multiplo_w	bigint;
t_objeto_row_w			t_objeto_row;
qt_offset_w	bigint	:= 1;
BEGIN

ds_task_w := tasy_sqltune_advisor_main_pck.gerar_analise_sql(ds_sql_p, ds_task_w);
ds_retorno_w	:=  DBMS_SQLTUNE.report_tuning_task(ds_task_w,'TEXT','TYPICAL');
qt_tamanho_w	:= octet_length(ds_retorno_w);

if	((trunc(qt_tamanho_w / qt_multiplo_w) * qt_multiplo_w) = qt_tamanho_w) then
	nr_multiplo_w	:= (qt_tamanho_w / qt_multiplo_w);
else
	nr_multiplo_w   := trunc(qt_tamanho_w / qt_multiplo_w) + 1;
end if;


for i in 1..nr_multiplo_w loop
	begin
	
	t_objeto_row_w.ds_linha	:=  substr(ds_retorno_w,4000,qt_offset_w);
	RETURN NEXT t_objeto_row_w;
	
	qt_offset_w	:= qt_offset_w + 4000;
	end;
end loop;

CALL tasy_sqltune_advisor_main_pck.remover_task(ds_task_w);

return;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION tasy_sqltune_advisor_main_pck.obter_analise ( ds_sql_p text) FROM PUBLIC; -- REVOKE ALL ON FUNCTION tasy_sqltune_advisor_main_pck.obter_analise_atx ( ds_sql_p text) FROM PUBLIC;
