-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_store_data_mens_pck.insert_record_mensalidade ( nm_usuario_p pls_mensalidade_segurado.nm_usuario%type, nr_seq_segurado_p pls_mensalidade_segurado.nr_seq_segurado%type, nr_seq_mensalidade_p pls_mensalidade_segurado.nr_seq_mensalidade%type, qt_idade_p pls_mensalidade_segurado.qt_idade%type, dt_mesano_referencia_p pls_mensalidade_segurado.dt_mesano_referencia%type, nr_parcela_p pls_mensalidade_segurado.nr_parcela%type, nr_seq_plano_p pls_mensalidade_segurado.nr_seq_plano%type, nr_seq_contrato_p pls_mensalidade_segurado.nr_seq_contrato%type, nr_parcela_contrato_p pls_mensalidade_segurado.nr_parcela_contrato%type, nr_seq_reajuste_p pls_mensalidade_segurado.nr_seq_reajuste%type, nr_seq_intercambio_p pls_mensalidade_segurado.nr_seq_intercambio%type, nr_seq_segurado_preco_p pls_mensalidade_segurado.nr_seq_segurado_preco%type, dt_inicio_cobertura_p pls_mensalidade_segurado.dt_inicio_cobertura%type, dt_fim_cobertura_p pls_mensalidade_segurado.dt_fim_cobertura%type, nr_seq_titular_p pls_mensalidade_segurado.nr_seq_titular%type, dt_rescisao_benef_p pls_mensalidade_segurado.dt_rescisao_benef%type, nr_seq_parentesco_p pls_mensalidade_segurado.nr_seq_parentesco%type, nr_seq_subestipulante_p pls_mensalidade_segurado.nr_seq_subestipulante%type, nr_seq_localizacao_benef_p pls_mensalidade_segurado.nr_seq_subestipulante%type ) AS $body$
DECLARE

	 
	vl_item_w	pls_mensalidade_seg_item.vl_item%type;
	
BEGIN
		CALL CALL pls_store_data_mens_pck.set_nr_seq_segurado(nr_seq_segurado_p);
		CALL CALL pls_store_data_mens_pck.set_dt_mesano_referencia(dt_mesano_referencia_p);
		CALL pls_store_data_mens_pck.set_nr_seq_segurado_preco(nr_seq_segurado_preco_p);
		CALL pls_store_data_mens_pck.set_nr_seq_mensalidade(nr_seq_mensalidade_p);
		CALL pls_store_data_mens_pck.set_nr_parcela(nr_parcela_p);
		CALL pls_store_data_mens_pck.set_nr_parcela_contrato(nr_parcela_contrato_p);
		 
		if (get_vl_max_copartic > 0) then 
			select	sum(coalesce(c.vl_item,0)) 
			into STRICT	vl_item_w 
			from	pls_mensalidade_seg_item	c, 
				pls_mensalidade_segurado	b, 
				pls_mensalidade			a 
			where	c.nr_seq_mensalidade_seg	= b.nr_sequencia 
			and	b.nr_seq_mensalidade		= a.nr_sequencia 
			and	c.ie_tipo_item			= '3' 
			and	b.nr_seq_segurado		= nr_seq_segurado_p 
			and	b.dt_mesano_referencia		= dt_mesano_referencia_p 
			and	coalesce(a.ie_cancelamento::text, '') = '';
			CALL pls_store_data_mens_pck.set_vl_coparticipacao_gerada(coalesce(vl_item_w,0));
		end if;
		 
		select	nextval('pls_mensalidade_segurado_seq') 
		into STRICT	current_setting('pls_store_data_mens_pck.nr_seq_mensalidade_seg_w')::pls_mensalidade_segurado.nr_sequencia%type 
		;
		 
		insert	into	pls_mensalidade_segurado(	nr_sequencia, dt_atualizacao, nm_usuario, dt_atualizacao_nrec, nm_usuario_nrec, 
				nr_seq_segurado, vl_mensalidade, nr_seq_mensalidade, 
				qt_idade, dt_mesano_referencia, nr_parcela, 
				nr_seq_plano, nr_seq_contrato, nr_parcela_contrato, 
				nr_seq_reajuste, nr_seq_intercambio, nr_seq_segurado_preco, 
				dt_inicio_cobertura, dt_fim_cobertura, nr_seq_titular, 
				dt_rescisao_benef,nr_seq_parentesco,nr_seq_subestipulante,nr_seq_localizacao_benef) 
		values (	current_setting('pls_store_data_mens_pck.nr_seq_mensalidade_seg_w')::pls_mensalidade_segurado.nr_sequencia%type, clock_timestamp(), nm_usuario_p, clock_timestamp(), nm_usuario_p, 
				nr_seq_segurado_p, 0, nr_seq_mensalidade_p, 
				qt_idade_p, dt_mesano_referencia_p, nr_parcela_p, 
				nr_seq_plano_p, nr_seq_contrato_p, nr_parcela_contrato_p, 
				nr_seq_reajuste_p, nr_seq_intercambio_p, nr_seq_segurado_preco_p, 
				dt_inicio_cobertura_p, dt_fim_cobertura_p, nr_seq_titular_p, 
				dt_rescisao_benef_p,nr_seq_parentesco_p,nr_seq_subestipulante_p,nr_seq_localizacao_benef_p);
	end;
	

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_store_data_mens_pck.insert_record_mensalidade ( nm_usuario_p pls_mensalidade_segurado.nm_usuario%type, nr_seq_segurado_p pls_mensalidade_segurado.nr_seq_segurado%type, nr_seq_mensalidade_p pls_mensalidade_segurado.nr_seq_mensalidade%type, qt_idade_p pls_mensalidade_segurado.qt_idade%type, dt_mesano_referencia_p pls_mensalidade_segurado.dt_mesano_referencia%type, nr_parcela_p pls_mensalidade_segurado.nr_parcela%type, nr_seq_plano_p pls_mensalidade_segurado.nr_seq_plano%type, nr_seq_contrato_p pls_mensalidade_segurado.nr_seq_contrato%type, nr_parcela_contrato_p pls_mensalidade_segurado.nr_parcela_contrato%type, nr_seq_reajuste_p pls_mensalidade_segurado.nr_seq_reajuste%type, nr_seq_intercambio_p pls_mensalidade_segurado.nr_seq_intercambio%type, nr_seq_segurado_preco_p pls_mensalidade_segurado.nr_seq_segurado_preco%type, dt_inicio_cobertura_p pls_mensalidade_segurado.dt_inicio_cobertura%type, dt_fim_cobertura_p pls_mensalidade_segurado.dt_fim_cobertura%type, nr_seq_titular_p pls_mensalidade_segurado.nr_seq_titular%type, dt_rescisao_benef_p pls_mensalidade_segurado.dt_rescisao_benef%type, nr_seq_parentesco_p pls_mensalidade_segurado.nr_seq_parentesco%type, nr_seq_subestipulante_p pls_mensalidade_segurado.nr_seq_subestipulante%type, nr_seq_localizacao_benef_p pls_mensalidade_segurado.nr_seq_subestipulante%type ) FROM PUBLIC;
