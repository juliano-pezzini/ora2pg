-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_gerencia_envio_ans_pck.gerencia_nr_lote ( nr_seq_lote_p pls_monitor_tiss_lote.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) AS $body$
DECLARE


nr_lote_w	pls_monitor_tiss_lote.nr_lote%type;

-- se gerarmos um lote para 11/2014 ele ter o nr_lote do nr_sequencia (feito via Delphi)

-- a partir do segundo lote para 11/2014, ser utilizado sempre o nr_lote do primeiro


-- busca todos os lotes para um determinado ms de competncia que j tenha os arquivos gerados

-- o ltimo registro deste select  o que ser utilizado no nr_lote no lote passado de parmetro (primeiro lote enviado do ms)

c01 CURSOR(	nr_seq_lote_pc		pls_monitor_tiss_lote.nr_sequencia%type,
		dt_inicio_pc		pls_monitor_tiss_lote.dt_mes_competencia%type,
		dt_fim_pc		pls_monitor_tiss_lote.dt_mes_competencia%type,
		cd_estabelecimento_pc	estabelecimento.cd_estabelecimento%type,
		ie_controla_estab_pc	pls_controle_estab.ie_monitoramento_ans%type) FOR
	SELECT	dt_geracao_lote,
		nr_lote
	from 	pls_monitor_tiss_lote
	where	dt_mes_competencia between dt_inicio_pc and dt_fim_pc
	and	nr_sequencia != nr_seq_lote_pc
	and	ie_status = 'LG'
	and	ie_controla_estab_pc = 'N'
	
union all

	SELECT	dt_geracao_lote,
		nr_lote
	from 	pls_monitor_tiss_lote
	where	dt_mes_competencia between dt_inicio_pc and dt_fim_pc
	and	nr_sequencia != nr_seq_lote_pc
	and	ie_status = 'LG'
	and	cd_estabelecimento = cd_estabelecimento_pc
	and	ie_controla_estab_pc = 'S'
	order by dt_geracao_lote desc;
BEGIN

nr_lote_w := null;

-- percorre todos os lotes e pega o nmero do primeiro lote que foi gerado

for r_c01_w in c01(	nr_seq_lote_p, current_setting('pls_gerencia_envio_ans_pck.dt_mes_competencia_ini_w')::pls_monitor_tiss_lote.dt_mes_competencia%type, current_setting('pls_gerencia_envio_ans_pck.dt_mes_competencia_fim_w')::pls_monitor_tiss_lote.dt_mes_competencia%type,
			cd_estabelecimento_p, current_setting('pls_gerencia_envio_ans_pck.ie_controla_estab_w')::pls_controle_estab.ie_monitoramento_ans%type) loop
	nr_lote_w := r_c01_w.nr_lote;
end loop;

-- se encontrou um lote atualiza o mesmo

if (nr_lote_w IS NOT NULL AND nr_lote_w::text <> '') then
	update	pls_monitor_tiss_lote set
		nr_lote = nr_lote_w,
		nm_usuario = nm_usuario_p,
		dt_atualizacao = clock_timestamp()
	where	nr_sequencia = nr_seq_lote_p;
	commit;
end if;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerencia_envio_ans_pck.gerencia_nr_lote ( nr_seq_lote_p pls_monitor_tiss_lote.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) FROM PUBLIC;
