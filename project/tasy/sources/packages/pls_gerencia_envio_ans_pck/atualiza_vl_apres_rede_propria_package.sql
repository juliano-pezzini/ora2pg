-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_gerencia_envio_ans_pck.atualiza_vl_apres_rede_propria ( nr_seq_lote_monitor_p pls_monitor_tiss_lote.nr_sequencia%type, ie_tipo_registro_p text) AS $body$
DECLARE


tb_nr_sequencia_w		pls_util_cta_pck.t_number_table;
tb_vl_recalculo_w		pls_util_cta_pck.t_number_table;
i				integer := 0;

C01 CURSOR(nr_seq_lote_monitor_pc  pls_monitor_tiss_lote.nr_sequencia%type) FOR
	SELECT	pls_obter_se_pgto_monit(a.nr_seq_conta) ie_rede_contratada,
		(SELECT	coalesce(sum(x.vl_recalculo), 0)
		from	pls_conta_proc_regra x
		where x.nr_sequencia = b.nr_seq_conta_proc) vl_recalculo,
		b.nr_sequencia
	from	pls_monitor_tiss_proc_val b,
		pls_monitor_tiss_cta_val a
	where a.nr_sequencia = b.nr_seq_cta_val
	and a.nr_seq_lote_monitor = nr_seq_lote_monitor_pc;

C02 CURSOR(nr_seq_lote_monitor_pc  pls_monitor_tiss_lote.nr_sequencia%type) FOR
	SELECT	pls_obter_se_pgto_monit(a.nr_seq_conta) ie_rede_contratada,
		(SELECT	coalesce(sum(x.vl_recalculo), 0)
		from	pls_conta_mat_regra x
		where x.nr_sequencia = b.nr_seq_conta_mat) vl_recalculo,
		b.nr_sequencia
	from	pls_monitor_tiss_mat_val b,
		pls_monitor_tiss_cta_val a
	where a.nr_sequencia = b.nr_seq_cta_val
	and a.nr_seq_lote_monitor = nr_seq_lote_monitor_pc;

BEGIN
if (ie_tipo_registro_p = 'P') then
	for r_C01_w in C01(nr_seq_lote_monitor_p) loop

		if (r_C01_w.ie_rede_contratada = 'N') and (r_C01_w.vl_recalculo > 0)then
			tb_nr_sequencia_w(i) := r_C01_w.nr_sequencia;
			tb_vl_recalculo_w(i) := r_C01_w.vl_recalculo;

			if (tb_nr_sequencia_w.count >= current_setting('pls_gerencia_envio_ans_pck.qt_registro_transacao_w')::integer) then
				forall j in tb_nr_sequencia_w.first .. tb_nr_sequencia_w.last

					update	pls_monitor_tiss_proc_val
					set	vl_procedimento = tb_vl_recalculo_w(j),
						vl_glosa = 0
					where	nr_sequencia = tb_nr_sequencia_w(j);

				commit;

				tb_nr_sequencia_w.delete;
				tb_vl_recalculo_w.delete;
				i := 0;
			else
				i := i + 1;
			end if;
		end if;
	end loop;

	if (tb_nr_sequencia_w.count > 0) then
		forall j in tb_nr_sequencia_w.first .. tb_nr_sequencia_w.last
			update	pls_monitor_tiss_proc_val
			set	vl_procedimento = tb_vl_recalculo_w(j),
				vl_glosa = 0
			where	nr_sequencia = tb_nr_sequencia_w(j);
		commit;

		tb_nr_sequencia_w.delete;
		tb_vl_recalculo_w.delete;
		i := 0;
	end if;
end if;

if (ie_tipo_registro_p = 'M') then
	for r_C02_w in C02(nr_seq_lote_monitor_p) loop

		if (r_C02_w.ie_rede_contratada = 'N') and (r_C02_w.vl_recalculo > 0)then
			tb_nr_sequencia_w(i) := r_C02_w.nr_sequencia;
			tb_vl_recalculo_w(i) := r_C02_w.vl_recalculo;

			if (tb_nr_sequencia_w.count >= current_setting('pls_gerencia_envio_ans_pck.qt_registro_transacao_w')::integer) then
				forall j in tb_nr_sequencia_w.first .. tb_nr_sequencia_w.last

					update	pls_monitor_tiss_mat_val
					set	vl_material = tb_vl_recalculo_w(j),
						vl_glosa = 0
					where	nr_sequencia = tb_nr_sequencia_w(j);

				commit;

				tb_nr_sequencia_w.delete;
				tb_vl_recalculo_w.delete;
				i := 0;
			else
				i := i + 1;
			end if;
		end if;
	end loop;

	if (tb_nr_sequencia_w.count > 0) then
		forall j in tb_nr_sequencia_w.first .. tb_nr_sequencia_w.last
			update	pls_monitor_tiss_mat_val
			set	vl_material = tb_vl_recalculo_w(j),
				vl_glosa = 0
			where	nr_sequencia = tb_nr_sequencia_w(j);
		commit;

		tb_nr_sequencia_w.delete;
		tb_vl_recalculo_w.delete;
		i := 0;
	end if;
end if;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerencia_envio_ans_pck.atualiza_vl_apres_rede_propria ( nr_seq_lote_monitor_p pls_monitor_tiss_lote.nr_sequencia%type, ie_tipo_registro_p text) FROM PUBLIC;
