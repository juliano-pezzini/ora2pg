-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_gerencia_envio_ans_pck.cria_chave_exclusao_cta ( nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE


_ora2pg_r RECORD;
qt_registro_w			integer;

tb_cd_ans_w			pls_util_cta_pck.t_varchar2_table_10;
tb_cd_cnes_prest_exec_w     	pls_util_cta_pck.t_varchar2_table_10;
tb_cd_cpf_cgc_prest_exec_w	pls_util_cta_pck.t_varchar2_table_15;
tb_cd_guia_operadora_w		pls_util_cta_pck.t_varchar2_table_20;
tb_cd_guia_prestador_w		pls_util_cta_pck.t_varchar2_table_20;
tb_dt_cancelamento_w		pls_util_cta_pck.t_date_table;
tb_dt_conta_fechada_w		pls_util_cta_pck.t_date_table;
tb_dt_conta_fechada_recurso_w	pls_util_cta_pck.t_date_table;
tb_dt_pagamento_previsto_w	pls_util_cta_pck.t_date_table;
tb_dt_pagamento_recurso_w	pls_util_cta_pck.t_date_table;
tb_ie_reembolso_w               pls_util_cta_pck.t_varchar2_table_20;
tb_ie_tipo_registro_w		pls_util_cta_pck.t_varchar2_table_1;
tb_nr_seq_conta_w               pls_util_cta_pck.t_number_table;
tb_ie_identif_prest_exec_w	pls_util_cta_pck.t_varchar2_table_1;
tb_dt_processamento_w		pls_util_cta_pck.t_date_table;

-- retorna todas as contas que devero ter uma nova chave de excluso criada

c01 CURSOR FOR
	SELECT 	c.*
	from	pls_cta_reenv_tmp a,
		pls_monitor_tiss_guia b,
		pls_moni_tiss_chave_guia c
	where	b.nr_seq_lote_monitor = a.nr_seq_lote_ultimo_envio
	and	b.nr_seq_conta = a.nr_seq_conta
	and	c.nr_sequencia = b.nr_seq_chave_guia;
BEGIN

qt_registro_w := 0;
for r_c01_w in c01 loop

	tb_cd_ans_w(qt_registro_w)			:= r_c01_w.cd_ans;
	tb_cd_cnes_prest_exec_w(qt_registro_w)		:= r_c01_w.cd_cnes_prest_exec;
	tb_cd_cpf_cgc_prest_exec_w(qt_registro_w)	:= r_c01_w.cd_cpf_cgc_prest_exec;
	tb_cd_guia_operadora_w(qt_registro_w)		:= r_c01_w.cd_guia_operadora;
	tb_cd_guia_prestador_w(qt_registro_w)		:= r_c01_w.cd_guia_prestador;
	tb_dt_cancelamento_w(qt_registro_w)		:= r_c01_w.dt_cancelamento;
	tb_dt_conta_fechada_w(qt_registro_w)		:= r_c01_w.dt_conta_fechada;
	tb_dt_conta_fechada_recurso_w(qt_registro_w)	:= r_c01_w.dt_conta_fechada_recurso;
	tb_dt_pagamento_previsto_w(qt_registro_w)	:= r_c01_w.dt_pagamento_previsto;
	tb_dt_pagamento_recurso_w(qt_registro_w)	:= r_c01_w.dt_pagamento_recurso;
	tb_dt_processamento_w(qt_registro_w)		:= r_c01_w.dt_processamento;
	tb_ie_identif_prest_exec_w(qt_registro_w)	:= r_c01_w.ie_identif_prest_exec;
	tb_ie_reembolso_w(qt_registro_w)		:= r_c01_w.ie_reembolso;
	tb_ie_tipo_registro_w(qt_registro_w)		:= '3';
	tb_nr_seq_conta_w(qt_registro_w)		:= r_c01_w.nr_seq_conta;

	if (qt_registro_w >= current_setting('pls_gerencia_envio_ans_pck.qt_registro_transacao_w')::integer) then
		-- manda para o banco

		CALL pls_gerencia_envio_ans_pck.atualizar_moni_tiss_chave_guia(	tb_cd_ans_w, tb_cd_cnes_prest_exec_w, tb_cd_cpf_cgc_prest_exec_w,
						tb_cd_guia_operadora_w, tb_cd_guia_prestador_w, tb_dt_cancelamento_w,
						tb_dt_conta_fechada_w, tb_dt_conta_fechada_recurso_w, tb_dt_pagamento_previsto_w,
						tb_dt_pagamento_recurso_w, tb_ie_reembolso_w,
						tb_ie_tipo_registro_w, tb_nr_seq_conta_w, tb_ie_identif_prest_exec_w,
						tb_dt_processamento_w, nm_usuario_p);

		-- Limpa as variveis do type

		SELECT * FROM pls_gerencia_envio_ans_pck.limpar_type_chave_guia(	tb_cd_ans_w, tb_cd_cnes_prest_exec_w, tb_cd_cpf_cgc_prest_exec_w, tb_cd_guia_operadora_w, tb_cd_guia_prestador_w, tb_dt_cancelamento_w, tb_dt_conta_fechada_w, tb_dt_conta_fechada_recurso_w, tb_dt_pagamento_previsto_w, tb_dt_pagamento_recurso_w, tb_ie_reembolso_w, tb_ie_tipo_registro_w, tb_nr_seq_conta_w, tb_ie_identif_prest_exec_w, tb_dt_processamento_w) INTO STRICT _ora2pg_r;
 	tb_cd_ans_w := _ora2pg_r.tb_cd_ans_p; tb_cd_cnes_prest_exec_w := _ora2pg_r.tb_cd_cnes_prest_exec_p; tb_cd_cpf_cgc_prest_exec_w := _ora2pg_r.tb_cd_cpf_cgc_prest_exec_p; tb_cd_guia_operadora_w := _ora2pg_r.tb_cd_guia_operadora_p; tb_cd_guia_prestador_w := _ora2pg_r.tb_cd_guia_prestador_p; tb_dt_cancelamento_w := _ora2pg_r.tb_dt_cancelamento_p; tb_dt_conta_fechada_w := _ora2pg_r.tb_dt_conta_fechada_p; tb_dt_conta_fechada_recurso_w := _ora2pg_r.tb_dt_conta_fechada_recurso_p; tb_dt_pagamento_previsto_w := _ora2pg_r.tb_dt_pagamento_previsto_p; tb_dt_pagamento_recurso_w := _ora2pg_r.tb_dt_pagamento_recurso_p; tb_ie_reembolso_w := _ora2pg_r.tb_ie_reembolso_p; tb_ie_tipo_registro_w := _ora2pg_r.tb_ie_tipo_registro_p; tb_nr_seq_conta_w := _ora2pg_r.tb_nr_seq_conta_p; tb_ie_identif_prest_exec_w := _ora2pg_r.tb_ie_identif_prest_exec_p; tb_dt_processamento_w := _ora2pg_r.tb_dt_processamento_p;

		qt_registro_w := 0;
	else
		qt_registro_w := qt_registro_w + 1;
	end if;
end loop;

-- se sobrar alguma coisa manda para o banco

CALL pls_gerencia_envio_ans_pck.atualizar_moni_tiss_chave_guia(	tb_cd_ans_w, tb_cd_cnes_prest_exec_w, tb_cd_cpf_cgc_prest_exec_w,
				tb_cd_guia_operadora_w, tb_cd_guia_prestador_w, tb_dt_cancelamento_w,
				tb_dt_conta_fechada_w, tb_dt_conta_fechada_recurso_w, tb_dt_pagamento_previsto_w,
				tb_dt_pagamento_recurso_w, tb_ie_reembolso_w,
				tb_ie_tipo_registro_w, tb_nr_seq_conta_w, tb_ie_identif_prest_exec_w,
				tb_dt_processamento_w, nm_usuario_p);
-- limpa as variveis do type

SELECT * FROM pls_gerencia_envio_ans_pck.limpar_type_chave_guia(	tb_cd_ans_w, tb_cd_cnes_prest_exec_w, tb_cd_cpf_cgc_prest_exec_w, tb_cd_guia_operadora_w, tb_cd_guia_prestador_w, tb_dt_cancelamento_w, tb_dt_conta_fechada_w, tb_dt_conta_fechada_recurso_w, tb_dt_pagamento_previsto_w, tb_dt_pagamento_recurso_w, tb_ie_reembolso_w, tb_ie_tipo_registro_w, tb_nr_seq_conta_w, tb_ie_identif_prest_exec_w, tb_dt_processamento_w) INTO STRICT _ora2pg_r;
 	tb_cd_ans_w := _ora2pg_r.tb_cd_ans_p; tb_cd_cnes_prest_exec_w := _ora2pg_r.tb_cd_cnes_prest_exec_p; tb_cd_cpf_cgc_prest_exec_w := _ora2pg_r.tb_cd_cpf_cgc_prest_exec_p; tb_cd_guia_operadora_w := _ora2pg_r.tb_cd_guia_operadora_p; tb_cd_guia_prestador_w := _ora2pg_r.tb_cd_guia_prestador_p; tb_dt_cancelamento_w := _ora2pg_r.tb_dt_cancelamento_p; tb_dt_conta_fechada_w := _ora2pg_r.tb_dt_conta_fechada_p; tb_dt_conta_fechada_recurso_w := _ora2pg_r.tb_dt_conta_fechada_recurso_p; tb_dt_pagamento_previsto_w := _ora2pg_r.tb_dt_pagamento_previsto_p; tb_dt_pagamento_recurso_w := _ora2pg_r.tb_dt_pagamento_recurso_p; tb_ie_reembolso_w := _ora2pg_r.tb_ie_reembolso_p; tb_ie_tipo_registro_w := _ora2pg_r.tb_ie_tipo_registro_p; tb_nr_seq_conta_w := _ora2pg_r.tb_nr_seq_conta_p; tb_ie_identif_prest_exec_w := _ora2pg_r.tb_ie_identif_prest_exec_p; tb_dt_processamento_w := _ora2pg_r.tb_dt_processamento_p;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerencia_envio_ans_pck.cria_chave_exclusao_cta ( nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;
