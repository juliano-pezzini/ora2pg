-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pls_gerencia_envio_ans_pck.obter_cbo_executor_conta (nr_seq_conta_p pls_conta.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) RETURNS varchar AS $body$
DECLARE


cd_cbo_executante_w 		pls_monitor_tiss_cta_val.cd_cbo_executante%type;
nr_versao_ptu_w			varchar(10);
nr_cbo_req_w			ptu_nota_servico.nr_cbo_exec%type;
nr_seq_nota_cobranca_w		ptu_nota_servico.nr_seq_nota_cobr%type;
cd_especialidade_w		ptu_nota_servico.cd_especialidade%type;
nr_seq_especialidade_w		especialidade_medica.cd_especialidade%type;
nr_seq_prest_inter_w		pls_conta.nr_seq_prest_inter%type;
nr_seq_cbo_saude_w		tiss_cbo_saude.nr_seq_cbo_saude%type;
nr_seq_cbo_partic_w		pls_proc_participante.nr_seq_cbo_saude%type;
nr_seq_cbo_pf_w			pessoa_fisica.nr_seq_cbo_saude%type;
ie_tipo_atendimento_w		varchar(15);
ie_tipo_guia_w			pls_conta.ie_tipo_guia%type;


BEGIN
nr_versao_ptu_w := ptu_obter_versao_dominio('A500', pls_obter_interf_ptu(cd_estabelecimento_p, null, clock_timestamp(), 'A500'));

select	max(nr_seq_cbo_saude),
	max( 	select 	pp.nr_seq_cbo_saude
		from	pls_prestador p,
			pessoa_fisica pp
		where	p.nr_sequencia = a.nr_seq_prestador_exec
		and	pp.cd_pessoa_fisica = p.cd_pessoa_fisica) nr_seq_cbo_pf,
	max(ie_tipo_guia),
	max(nr_seq_nota_cobranca),
	max(nr_seq_prest_inter),
	max(CASE WHEN a.ie_tipo_guia='4' THEN  pls_gerencia_envio_ans_pck.obter_informacao_alter_varchar(a.nr_sequencia, 'TA', pls_obter_cd_tiss_atendimento(a.nr_seq_tipo_atendimento))  ELSE '' END ) ie_tipo_atendimento
into STRICT	nr_seq_cbo_saude_w,
	nr_seq_cbo_pf_w,
	ie_tipo_guia_w,
	nr_seq_nota_cobranca_w,
	nr_seq_prest_inter_w,
	ie_tipo_atendimento_w
from	pls_conta	a
where	nr_sequencia	= nr_seq_conta_p;

-- Obter o cdigo CBO do executante, somente para guias de Consuta

if (ie_tipo_guia_w = '3' ) or
	(ie_tipo_guia_w = '4' AND ie_tipo_atendimento_w = '04') then
	-- Tratamento do A500

	if (nr_seq_nota_cobranca_w IS NOT NULL AND nr_seq_nota_cobranca_w::text <> '') then

		select	max(nr_cbo_exec)
		into STRICT	nr_cbo_req_w
		from	ptu_nota_servico
		where	nr_seq_nota_cobr	= nr_seq_nota_cobranca_w
		and	ie_tipo_tabela		= '0'
		and	nr_cbo_exec		!= '999999';

		if (coalesce(nr_cbo_req_w,0) = 0) then
			select	max(nr_cbo_exec)
			into STRICT	nr_cbo_req_w
			from	ptu_nota_servico
			where	nr_seq_nota_cobr	= nr_seq_nota_cobranca_w
			and	ie_tipo_tabela		= '0';

			if (coalesce(nr_cbo_req_w,0) = 0) then
				select	max(nr_cbo_exec)
				into STRICT	nr_cbo_req_w
				from	ptu_nota_servico
				where	nr_seq_nota_cobr	= nr_seq_nota_cobranca_w;

				if (coalesce(nr_cbo_req_w,0) = 0) then
					select	max(nr_cbo_req)
					into STRICT	nr_cbo_req_w
					from	ptu_nota_cobranca
					where	nr_sequencia	= nr_seq_nota_cobranca_w;
				end if;
			end if;
		end if;

		if (coalesce(nr_cbo_req_w, 0) > 0) then
			if (nr_versao_ptu_w IS NOT NULL AND nr_versao_ptu_w::text <> '') then
				select	max(b.cd_cbo)
				into STRICT	cd_cbo_executante_w
				from	cbo_saude_ptu	a,
					cbo_saude	b
				where	a.nr_seq_cbo_saude	= b.nr_sequencia
				and	a.cd_cbo_ptu		= to_char(nr_cbo_req_w)
				and	a.nr_versao_ptu		= nr_versao_ptu_w;
			end if;

			if (coalesce(cd_cbo_executante_w::text, '') = '') then
				select	max(cd_cbo)
				into STRICT	cd_cbo_executante_w
				from	cbo_saude
				where	cd_cbo_ptu	= to_char(nr_cbo_req_w)
				and	((ie_situacao	= 'A') or (coalesce(ie_situacao::text, '') = ''));
			end if;
		end if;

		--Seno achar o CBO no A500, busca o CBO pela especialidade

		if (coalesce(cd_cbo_executante_w::text, '') = '') then
			select	max(cd_especialidade)
			into STRICT	cd_especialidade_w
			from	ptu_nota_servico
			where	nr_seq_nota_cobr	= nr_seq_nota_cobranca_w;

			if (cd_especialidade_w IS NOT NULL AND cd_especialidade_w::text <> '') then
				select	max(cd_especialidade)
				into STRICT	nr_seq_especialidade_w
				from	especialidade_medica
				where	cd_ptu	= cd_especialidade_w;

				if (nr_seq_especialidade_w IS NOT NULL AND nr_seq_especialidade_w::text <> '') then
					select 	max(nr_seq_cbo_saude)
					into STRICT	nr_seq_cbo_saude_w
					from	tiss_cbo_saude
					where	cd_especialidade	= nr_seq_especialidade_w
					and	ie_versao		= current_setting('pls_gerencia_envio_ans_pck.cd_versao_tiss_w')::pls_monitor_tiss_lote.cd_versao_tiss%type;

					if (nr_seq_cbo_saude_w IS NOT NULL AND nr_seq_cbo_saude_w::text <> '') then
						select	max(cd_cbo)
						into STRICT	cd_cbo_executante_w
						from	cbo_saude
						where	nr_sequencia	= nr_seq_cbo_saude_w;
					end if;
				end if;
			end if;
		end if;

		if	((coalesce(nr_seq_cbo_saude_w::text, '') = '') and (coalesce(cd_cbo_executante_w::text, '') = '' )) or (cd_cbo_executante_w = '999999') then
			select	max(nr_seq_cbo_saude)
			into STRICT	nr_seq_cbo_saude_w
			from	pls_prestador_intercambio
			where	nr_sequencia = nr_seq_prest_inter_w;

			if (nr_seq_cbo_saude_w IS NOT NULL AND nr_seq_cbo_saude_w::text <> '') then
				select	max(a.cd_cbo)
				into STRICT	cd_cbo_executante_w
				from	cbo_saude a,
					cbo_saude_tiss b
				where	a.nr_sequencia 	= b.nr_seq_cbo_saude
				and	a.nr_sequencia 	= nr_seq_cbo_saude_w
				and	b.ie_versao 	= current_setting('pls_gerencia_envio_ans_pck.cd_versao_tiss_w')::pls_monitor_tiss_lote.cd_versao_tiss%type;

				if (coalesce(cd_cbo_executante_w::text, '') = '') then
					select	max(a.cd_cbo)
					into STRICT	cd_cbo_executante_w
					from	cbo_saude a
					where	a.nr_sequencia = nr_seq_cbo_saude_w;
				end if;
			end if;
		end if;

	elsif (nr_seq_cbo_saude_w IS NOT NULL AND nr_seq_cbo_saude_w::text <> '') then
		select 	max(a.cd_cbo)
		into STRICT	cd_cbo_executante_w
		from	cbo_saude a,
			cbo_saude_tiss b
		where	b.nr_seq_cbo_saude 	= a.nr_sequencia
		and	a.nr_sequencia 		= nr_seq_cbo_saude_w
		and (coalesce(b.ie_versao::text, '') = '' or b.ie_versao = current_setting('pls_gerencia_envio_ans_pck.cd_versao_tiss_w')::pls_monitor_tiss_lote.cd_versao_tiss%type);

	elsif (ie_tipo_guia_w = '4') and (ie_tipo_atendimento_w = '04') and (coalesce(nr_seq_cbo_saude_w::text, '') = '') then

		select	max(nr_seq_cbo_saude)
		into STRICT	nr_seq_cbo_partic_w
		from	pls_proc_participante a,
			pls_conta_proc b
		where	b.nr_sequencia = a.nr_seq_conta_proc
		and	b.nr_seq_conta = nr_seq_conta_p;

		if (nr_seq_cbo_partic_w IS NOT NULL AND nr_seq_cbo_partic_w::text <> '') then
			select 	max(a.cd_cbo)
			into STRICT	cd_cbo_executante_w
			from	cbo_saude a,
				cbo_saude_tiss b
			where	b.nr_seq_cbo_saude 	= a.nr_sequencia
			and	a.nr_sequencia 		= nr_seq_cbo_partic_w
			and (coalesce(b.ie_versao::text, '') = '' or b.ie_versao = current_setting('pls_gerencia_envio_ans_pck.cd_versao_tiss_w')::pls_monitor_tiss_lote.cd_versao_tiss%type);
		end if;
	end if;

end if;

--Se at aqui o cbo executor obtido for nulo e o parmetro do monitoramento apontar para buscar do prestador executor PF da conta

if ( coalesce(cd_cbo_executante_w::text, '') = '' and current_setting('pls_gerencia_envio_ans_pck.ie_cbo_prest_executor_w')::pls_monitor_tiss_param.ie_cbo_prest_executor%type = 'S') then

	select 	max(a.cd_cbo)
	into STRICT	cd_cbo_executante_w
	from	cbo_saude a
	where	a.nr_sequencia 	= nr_seq_cbo_pf_w;

end if;

return	cd_cbo_executante_w;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pls_gerencia_envio_ans_pck.obter_cbo_executor_conta (nr_seq_conta_p pls_conta.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) FROM PUBLIC;
