-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


--Function para retornar a origem da guia, conforme tabela de domnio da ANS



CREATE OR REPLACE FUNCTION pls_gerencia_envio_ans_pck.obter_origem_guia ( nr_seq_protocolo_p pls_protocolo_conta.nr_sequencia%type, nr_seq_prestador_p pls_prestador.nr_sequencia%type) RETURNS varchar AS $body$
DECLARE


ie_tipo_protocolo_w	pls_protocolo_conta.ie_tipo_protocolo%type;
ie_origem_guia_w	varchar(1) := '1';
ie_tipo_relacao_w	pls_prestador.ie_tipo_relacao%type := '0';


BEGIN

if (nr_seq_protocolo_p IS NOT NULL AND nr_seq_protocolo_p::text <> '') then

	--Conta de reembolso

	select	coalesce(ie_tipo_protocolo,'0')
	into STRICT	ie_tipo_protocolo_w
	from	pls_protocolo_conta
	where	nr_sequencia = nr_seq_protocolo_p;


	if ( ie_tipo_protocolo_w = 'R' ) then
		ie_origem_guia_w := 4;

	elsif (nr_seq_prestador_p IS NOT NULL AND nr_seq_prestador_p::text <> '') then
		select	coalesce(ie_tipo_relacao,'0')
		into STRICT	ie_tipo_relacao_w
		from	pls_prestador
		where	nr_sequencia	= nr_seq_prestador_p;

		--Rede prpria de Cooperado

		if ( ie_tipo_relacao_w = 'C' ) then
			ie_origem_guia_w :=  '2';

		--Rede referenciada ou contratada

		elsif ( ie_tipo_relacao_w in ('D','I') ) then
			ie_origem_guia_w := '1';

		--Rede prpria demais prestadores

		elsif ( ie_tipo_relacao_w = 'P' ) then
			ie_origem_guia_w := '3';
			
		elsif ( ie_tipo_relacao_w = 'E' ) then
			ie_origem_guia_w := '5';
			
		end if;
	end if;

end if;

return ie_origem_guia_w;
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 IMMUTABLE;
-- REVOKE ALL ON FUNCTION pls_gerencia_envio_ans_pck.obter_origem_guia ( nr_seq_protocolo_p pls_protocolo_conta.nr_sequencia%type, nr_seq_prestador_p pls_prestador.nr_sequencia%type) FROM PUBLIC;
