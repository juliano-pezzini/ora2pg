-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


-- Alimenta a tabela de contas aceitas no lote



CREATE OR REPLACE PROCEDURE pls_gerencia_envio_ans_pck.gera_contas_aceitas ( nr_seq_lote_ret_p pls_monitor_tiss_lote_ret.nr_sequencia%type, ie_tipo_lote_p text, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE


nr_seq_lote_monitor_w	pls_monitor_tiss_lote.nr_sequencia%type;
current_setting('pls_gerencia_envio_ans_pck.ie_tipo_lote_w')::pls_monitor_tiss_lote.ie_tipo_lote%type			pls_monitor_tiss_lote.ie_tipo_lote%type;
nr_seq_arquivo_w		pls_monitor_tiss_arquivo.nr_sequencia%type;
dados_guia_ret_w		dados_guia_ret;
tb_nr_seq_guia_w		pls_util_cta_pck.t_number_table;
cd_glosa_w				pls_monitor_tiss_glosa.cd_glosa%type;
nr_seq_guia_ret_w		pls_monitor_tiss_guia_ret.nr_sequencia%type;
tb_seq_w    pls_util_cta_pck.t_number_table;
dt_ini_w		pls_monitor_tiss_lote.dt_mes_competencia%type;
dt_fim_w		pls_monitor_tiss_lote.dt_mes_competencia%type;

C00 CURSOR(	nr_seq_arquivo_pw			pls_monitor_tiss_lote_ret.nr_seq_arquivo%type,
			nr_seq_lote_monitor_pw		pls_monitor_tiss_lote_com.nr_seq_lote_monitor%type) FOR
	SELECT	a.cd_cnes_prest_exec,
		a.cd_guia_operadora,
		a.cd_guia_prestador,
		a.ie_tipo_registro,
		a.nr_seq_prestador,
		a.nr_seq_prest_inter,
		a.cd_cpf_cgc_prest_exec,
		a.ie_identif_prest_exec,
		a.ie_reembolso,
		a.nr_seq_conta
	from	pls_monitor_tiss_guia a
	where	a.nr_seq_lote_monitor = nr_seq_lote_monitor_pw
	and	a.nr_seq_arq_monitor = nr_seq_arquivo_pw;

C01 CURSOR(	nr_seq_lote_monitor_pc		pls_monitor_tiss_lote.nr_sequencia%type,
		nr_seq_arquivo_pc		pls_monitor_tiss_arquivo.nr_sequencia%type) FOR
	SELECT	a.nr_sequencia,
		a.cd_guia_operadora,
		a.cd_guia_prestador,
		a.ie_tipo_registro,
		a.nr_seq_prestador,
		a.nr_seq_prest_inter,
		a.cd_cpf_cgc_prest_exec,
		a.ie_identif_prest_exec
	from	pls_monitor_tiss_guia a
	where	a.nr_seq_lote_monitor = nr_seq_lote_monitor_pc
	and	a.nr_seq_arq_monitor = nr_seq_arquivo_pc
	and	not exists (	SELECT	1
				from	pls_monitor_tiss_guia_ret x
				where	x.nr_seq_guia_monitor = a.nr_sequencia);

C02 CURSOR(	nr_seq_lote_monitor_pc		pls_monitor_tiss_lote.nr_sequencia%type,
		nr_seq_arquivo_pc		pls_monitor_tiss_arquivo.nr_sequencia%type) FOR
	SELECT	b.nr_seq_monitor_guia
	from	pls_monitor_tiss_guia a,
		pls_monitor_tiss_cta_val b
	where	b.nr_seq_lote_monitor = a.nr_seq_lote_monitor
	and	b.nr_seq_conta = a.nr_seq_conta
	and	a.nr_seq_lote_monitor = nr_seq_lote_monitor_pc
	and	a.nr_seq_arq_monitor = nr_seq_arquivo_pc
	and	not exists (	SELECT	1
				from	pls_monitor_tiss_guia_ret x
				where	x.nr_seq_guia_monitor = a.nr_sequencia);
				
 --ajusta para pendentes os registros agrupados de pagamento de recurso de glosa

c_reg_agrupados CURSOR FOR
	SELECT  a.nr_sequencia
	from 	pls_monitor_tiss_alt a
	where  	dt_evento between dt_ini_w and dt_fim_w
	and 	ie_status = 'AG';

BEGIN
-- Busca o sequencial do arquivo e o sequencial do lote

select	max(a.nr_seq_lote_monitor),
		max(b.nr_seq_arquivo)
into STRICT	nr_seq_lote_monitor_w,
		nr_seq_arquivo_w
from	pls_monitor_tiss_lote_com a,
	pls_monitor_tiss_lote_ret b
where	a.nr_sequencia = b.nr_seq_lote_com
and	b.nr_sequencia = nr_seq_lote_ret_p;

select	max(cd_glosa)
into STRICT	cd_glosa_w
from	pls_monitor_tiss_glosa
where	nr_seq_lote_monitor_ret	= nr_seq_lote_ret_p;

select 	trunc(a.dt_mes_competencia, 'MM'),
	fim_mes( a.dt_mes_competencia)
into STRICT	dt_ini_w,
	dt_fim_w
from	pls_monitor_tiss_lote a
where	a.nr_sequencia = nr_seq_lote_monitor_w;

	--5001 - MENSAGEM ELETRNICA FORA DO PADRO TISS

	--5002 - NO FOI POSSVEL VALIDAR O ARQUIVO XML

	--5007 - MENSAGEM INCONSISTENTE OU INCOMPLETA

	--5014 - CDIGO HASH INVLIDO. MENSAGEM PODE ESTAR CORROMPIDA

	--5025-DATA DE REGISTRO DA TRANSAO INVLIDA

	--5026-HORA DE REGISTRO DA TRANSAO INVLIDA

	if	((cd_glosa_w = '5001') or (cd_glosa_w = '5002') and (cd_glosa_w = '5007') or (cd_glosa_w = '5014') and (cd_glosa_w = '5025') or (cd_glosa_w = '5026') and (cd_glosa_w = '5044') or (cd_glosa_w = '5045') and (cd_glosa_w = '5046')) then


		if ( ie_tipo_lote_p = 'G') then
		
			for r_c00_w in c00(nr_seq_arquivo_w, nr_seq_lote_monitor_w) loop
				
				nr_seq_guia_ret_w := pls_gerencia_envio_ans_pck.gerar_guia_ret_monitor(	nr_seq_lote_ret_p, r_c00_w.cd_cnes_prest_exec, r_c00_w.cd_cpf_cgc_prest_exec, r_c00_w.cd_guia_operadora, r_c00_w.cd_guia_prestador, clock_timestamp(), r_c00_w.ie_identif_prest_exec, r_c00_w.ie_reembolso, '', nm_usuario_p, null, null, 'G', nr_seq_guia_ret_w);	

				--No caso de arquivo totalmente rejeitado, os registros referentes ao agrupamento de pagamento de recurso, necessitam

				--ser setados como Negados, para serem elegiveis de entrarem em novo lote

				 open c_reg_agrupados;
				loop
				tb_seq_w.delete;

				fetch c_reg_agrupados bulk collect into tb_seq_w
				limit current_setting('pls_gerencia_envio_ans_pck.qt_registro_transacao_w')::integer;

				exit when tb_seq_w.count = 0;

				forall i in tb_seq_w.first .. tb_seq_w.last
					update   pls_monitor_tiss_alt set
					ie_status = 'N',
					dt_atualizacao = clock_timestamp(),
					nm_usuario = nm_usuario_p
					where  nr_sequencia = tb_seq_w(i);
					commit;
				end loop;
				close c_reg_agrupados;
				commit;
											
			end loop;
		else --ie_tipo_lote_p F - fornecimento direto
			for r_c00_w in c00(nr_seq_arquivo_w, nr_seq_lote_monitor_w) loop
				
				nr_seq_guia_ret_w := pls_gerencia_envio_ans_pck.gerar_guia_ret_monitor(	nr_seq_lote_ret_p, r_c00_w.cd_cnes_prest_exec, r_c00_w.cd_cpf_cgc_prest_exec, r_c00_w.cd_guia_operadora, r_c00_w.cd_guia_prestador, clock_timestamp(), r_c00_w.ie_identif_prest_exec, r_c00_w.ie_reembolso, '', nm_usuario_p, null, r_c00_w.nr_seq_conta, 'F', nr_seq_guia_ret_w);			
			end loop;
		end if;
		
	end if;


Open C01(nr_seq_lote_monitor_w, nr_seq_arquivo_w);
loop
	-- Limpa as variveis

	dados_guia_ret_w.nr_seq_guia_monitor.delete;
	dados_guia_ret_w.cd_guia_operadora.delete;
	dados_guia_ret_w.cd_guia_prestador.delete;
	dados_guia_ret_w.ie_tipo_registro.delete;
	dados_guia_ret_w.nr_seq_prestador.delete;
	dados_guia_ret_w.nr_seq_prest_inter.delete;
	dados_guia_ret_w.cd_cpf_cgc_prest_exec.delete;
	dados_guia_ret_w.ie_identif_prest_exec.delete;

	fetch C01 bulk collect into	dados_guia_ret_w.nr_seq_guia_monitor,
					dados_guia_ret_w.cd_guia_operadora,
					dados_guia_ret_w.cd_guia_prestador,
					dados_guia_ret_w.ie_tipo_registro,
					dados_guia_ret_w.nr_seq_prestador,
					dados_guia_ret_w.nr_seq_prest_inter,
					dados_guia_ret_w.cd_cpf_cgc_prest_exec,
					dados_guia_ret_w.ie_identif_prest_exec
	limit current_setting('pls_gerencia_envio_ans_pck.qt_registro_transacao_w')::integer;

	exit when dados_guia_ret_w.nr_seq_guia_monitor.count = 0;
	
	-- Manda para o banco

	forall i in dados_guia_ret_w.nr_seq_guia_monitor.first .. dados_guia_ret_w.nr_seq_guia_monitor.last
		insert	into	pls_mon_tiss_guia_ret_act(	cd_cpf_cgc_prest_exec, cd_guia_operadora, cd_guia_prestador,
				dt_atualizacao, dt_atualizacao_nrec, ie_identif_prest_exec,
				ie_tipo_registro, nm_usuario, nm_usuario_nrec,
				nr_seq_guia_monitor, nr_seq_lote_monitor_ret, nr_seq_prestador,
				nr_seq_prest_inter, nr_sequencia)
		values (	dados_guia_ret_w.cd_cpf_cgc_prest_exec(i), dados_guia_ret_w.cd_guia_operadora(i), dados_guia_ret_w.cd_guia_prestador(i),
				clock_timestamp(), clock_timestamp(), dados_guia_ret_w.ie_identif_prest_exec(i),
				dados_guia_ret_w.ie_tipo_registro(i), nm_usuario_p, nm_usuario_p,
				dados_guia_ret_w.nr_seq_guia_monitor(i), nr_seq_lote_ret_p, dados_guia_ret_w.nr_seq_prestador(i),
				dados_guia_ret_w.nr_seq_prest_inter(i), nextval('pls_mon_tiss_guia_ret_act_seq'));
	commit;
end loop;

if (C01%ISOPEN) then
	close C01;
end if;

	--Os registros da competencia que chegarem nesse ponto como GA, significa que nao entraram nos controles para 

	--serem marcados como Negados, podendo setar como A na tabela de controle

	open c_reg_agrupados;
	loop
		tb_seq_w.delete;

	fetch c_reg_agrupados bulk collect into tb_seq_w
	limit current_setting('pls_gerencia_envio_ans_pck.qt_registro_transacao_w')::integer;

	exit when tb_seq_w.count = 0;

	forall i in tb_seq_w.first .. tb_seq_w.last
		update  pls_monitor_tiss_alt set
			ie_status = 'A',
			dt_atualizacao = clock_timestamp(),
			nm_usuario = nm_usuario_p
		where  	nr_sequencia = tb_seq_w(i);
		commit;
	end loop;
	close c_reg_agrupados;
	commit;

if (nr_seq_lote_monitor_w IS NOT NULL AND nr_seq_lote_monitor_w::text <> '') then
	select	coalesce(ie_tipo_lote,'0')
	into STRICT	current_setting('pls_gerencia_envio_ans_pck.ie_tipo_lote_w')::pls_monitor_tiss_lote.ie_tipo_lote%type
	from	pls_monitor_tiss_lote
	where	nr_sequencia = nr_seq_lote_monitor_w;

	-- Caso o lote que esteja sendo importado seja de excluso

	--  necessrio ajustar o campo "ie_registro_excludo" para 'S'

	-- esse campo  verificado ao buscar as infromaes de envios anteriores da guia

	-- evitando que o sistema busque as informaes de um registro que foi excluido na abse da ANS

	if (current_setting('pls_gerencia_envio_ans_pck.ie_tipo_lote_w')::pls_monitor_tiss_lote.ie_tipo_lote%type = '1') then

		Open C02(nr_seq_lote_monitor_w, nr_seq_arquivo_w);
		loop
			fetch C02 bulk collect into tb_nr_seq_guia_w
			limit current_setting('pls_gerencia_envio_ans_pck.qt_registro_transacao_w')::integer;

			exit when tb_nr_seq_guia_w.count = 0;

			forall i in tb_nr_seq_guia_w.first .. tb_nr_seq_guia_w.last
				update	pls_monitor_tiss_guia
				set	ie_registro_excluido = 'S'
				where	nr_sequencia = tb_nr_seq_guia_w(i);
			commit;
		end loop;

		if (C02%ISOPEN) then
			close C02;
		end if;
	end if;
end if;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerencia_envio_ans_pck.gera_contas_aceitas ( nr_seq_lote_ret_p pls_monitor_tiss_lote_ret.nr_sequencia%type, ie_tipo_lote_p text, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;
