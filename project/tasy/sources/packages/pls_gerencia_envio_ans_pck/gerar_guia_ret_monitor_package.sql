-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


-- Gerar as contas retornadas pelo arquivo de Retorno dos dados enviados para ANS



CREATE OR REPLACE PROCEDURE pls_gerencia_envio_ans_pck.gerar_guia_ret_monitor ( nr_seq_monitor_ret_p pls_monitor_tiss_lote_ret.nr_sequencia%type, cd_cnes_prest_exec_p pls_monitor_tiss_guia_ret.cd_cnes_prest_exec%type, cpf_cgc_prest_exec_p pls_monitor_tiss_guia_ret.cd_cpf_cgc_prest_exec%type, cd_guia_operadora_p pls_monitor_tiss_guia_ret.cd_guia_operadora%type, cd_guia_prestador_p pls_monitor_tiss_guia_ret.cd_guia_prestador%type, dt_processamento_p pls_monitor_tiss_guia_ret.dt_processamento%type, ie_identif_prest_exec_p pls_monitor_tiss_guia_ret.ie_identif_prest_exec%type, ie_reembolso_p pls_monitor_tiss_guia_ret.ie_reembolso%type, nr_lote_p pls_monitor_tiss_lote_ret.nr_lote%type, nm_usuario_p usuario.nm_usuario%type, ie_tipo_registro_p pls_monitor_tiss_guia_ret.ie_tipo_registro%type, nr_ident_fornec_direto_p pls_conta.nr_sequencia%type, ie_tipo_lote_p text, nr_seq_guia_ret_p INOUT pls_monitor_tiss_guia_ret.nr_sequencia%type) AS $body$
DECLARE


nr_seq_guia_monitor_w		pls_monitor_tiss_guia_ret.nr_seq_guia_monitor%type;
nr_seq_prestador_w		pls_prestador.nr_sequencia%type;
nr_seq_lote_monitor_arq_w	pls_monitor_tiss_arquivo.nr_sequencia%type;
nm_arquivo_w			pls_monitor_tiss_lote_ret.nm_arquivo%type;
nr_seq_prest_inter_w		pls_prestador_intercambio.nr_sequencia%type;


BEGIN

-- por segurana, para evitar que gere vrios erros de conta sem lote

if (nr_seq_monitor_ret_p IS NOT NULL AND nr_seq_monitor_ret_p::text <> '') then

	-- busca o nome do arquivo primeiro

	select	UPPER(replace(nm_arquivo,'ZTE','XTE'))
	into STRICT	nm_arquivo_w
	from	pls_monitor_tiss_lote_ret
	where	nr_sequencia	= nr_seq_monitor_ret_p;
	
	if (nm_arquivo_w IS NOT NULL AND nm_arquivo_w::text <> '') then
		-- busca o lote do arquivo

		select	max(b.nr_sequencia)
		into STRICT	nr_seq_lote_monitor_arq_w
		from	pls_monitor_tiss_lote a,
			pls_monitor_tiss_arquivo b
		where	a.ie_status		= 'LG'
		and	b.nr_seq_lote_monitor	= a.nr_sequencia
		and	b.nm_arquivo		= nm_arquivo_w;
	end if;

	if ( ie_tipo_lote_p = 'G') then
		
		-- se tem lote monitor identificado, busca a sequencia da guia enviada

		if (nr_seq_lote_monitor_arq_w IS NOT NULL AND nr_seq_lote_monitor_arq_w::text <> '') then
			begin
				--o nvl aqui na busca por guia prestador e guia operadora no ir comprometer, 

				--pois apenas localizar no maximo os 9000 registros do arquivo de retorno importado.

				select 	max(nr_sequencia),
						max(nr_seq_prestador),
						max(nr_seq_prest_inter)
				into STRICT	nr_seq_guia_monitor_w,
						nr_seq_prestador_w,
						nr_seq_prest_inter_w
				from (
					SELECT 	a.nr_sequencia,
							a.nr_seq_prestador,
							a.nr_seq_prest_inter
					from	pls_monitor_tiss_guia a
					where	a.nr_seq_arq_monitor	= nr_seq_lote_monitor_arq_w
					and	coalesce(UPPER(a.cd_guia_operadora),'0') 		= coalesce(UPPER(cd_guia_operadora_p), '0')
					and	a.ie_reembolso				= ie_reembolso_p
					and	coalesce(UPPER(a.cd_guia_prestador), '0')			= coalesce(UPPER(cd_guia_prestador_p), '0')
					and	a.cd_cpf_cgc_prest_exec		= cpf_cgc_prest_exec_p
					and	a.ie_identif_prest_exec		= ie_identif_prest_exec_p
					and  coalesce(cd_guia_operadora::text, '') = ''
					
union all

					SELECT 	a.nr_sequencia,
							a.nr_seq_prestador,
							a.nr_seq_prest_inter			
					from	pls_monitor_tiss_guia a
					where	a.nr_seq_arq_monitor	= nr_seq_lote_monitor_arq_w
					and	coalesce(UPPER(a.cd_guia_operadora), '0') 		= coalesce(UPPER(cd_guia_operadora_p), '0')
					and	a.ie_reembolso				= ie_reembolso_p
					and	coalesce(UPPER(a.cd_guia_prestador),'0')			= coalesce(UPPER(cd_guia_prestador_p), '0') 
					and	a.cd_cpf_cgc_prest_exec		= cpf_cgc_prest_exec_p
					and	a.ie_identif_prest_exec		= ie_identif_prest_exec_p
					and  coalesce(cd_guia_prestador_p::text, '') = ''
					
union all

					select 	a.nr_sequencia,
							a.nr_seq_prestador,
							a.nr_seq_prest_inter			
					from	pls_monitor_tiss_guia a
					where	a.nr_seq_arq_monitor	= nr_seq_lote_monitor_arq_w
					and	coalesce(upper(a.cd_guia_operadora), '0') 		= upper(cd_guia_operadora_p)
					and	a.ie_reembolso				= ie_reembolso_p
					and	coalesce(upper(a.cd_guia_prestador),'0')			= upper(cd_guia_prestador_p)
					and	a.cd_cpf_cgc_prest_exec		= cpf_cgc_prest_exec_p
					and	a.ie_identif_prest_exec		= ie_identif_prest_exec_p
					and  (cd_guia_prestador_p IS NOT NULL AND cd_guia_prestador_p::text <> '') and (cd_guia_prestador_p IS NOT NULL AND cd_guia_prestador_p::text <> '')
				) alias31;
				
			exception
			when others then	
				nr_seq_guia_monitor_w 	:= null;
				nr_seq_prestador_w	:= null;
				nr_seq_prest_inter_w	:= null;
			end;

		end if;
	-- ie_tipo_lote_p = F - Fornecimento direto

	else
		-- se tem lote monitor identificado, busca a sequencia da guia enviada

		if (nr_seq_lote_monitor_arq_w IS NOT NULL AND nr_seq_lote_monitor_arq_w::text <> '') then
			
			begin
				
				select 	max(a.nr_sequencia),
					max(a.nr_seq_prestador),
					max(a.nr_seq_prest_inter)
				into STRICT	nr_seq_guia_monitor_w,
					nr_seq_prestador_w,
					nr_seq_prest_inter_w
				from	pls_monitor_tiss_guia a
				where	a.nr_seq_arq_monitor	= nr_seq_lote_monitor_arq_w
				and 	nr_seq_conta = nr_ident_fornec_direto_p;
				
				
			exception
			when others then	
				nr_seq_guia_monitor_w 	:= null;
				nr_seq_prestador_w	:= null;
				nr_seq_prest_inter_w	:= null;
			end;
		end if;
		
	end if;
	
	insert into pls_monitor_tiss_guia_ret(
		nr_sequencia, nr_seq_lote_monitor_ret, cd_cnes_prest_exec,
		cd_cpf_cgc_prest_exec, cd_guia_operadora, cd_guia_prestador,
		dt_atualizacao, dt_atualizacao_nrec, dt_processamento,
		ie_identif_prest_exec, ie_reembolso, nm_usuario,
		nm_usuario_nrec, nr_seq_guia_monitor, nr_seq_prestador,
		ie_tipo_registro, nr_seq_prest_inter )
	values (	nextval('pls_monitor_tiss_guia_ret_seq'), nr_seq_monitor_ret_p, cd_cnes_prest_exec_p,
		cpf_cgc_prest_exec_p, cd_guia_operadora_p, cd_guia_prestador_p,
		clock_timestamp(), clock_timestamp(), dt_processamento_p,
		ie_identif_prest_exec_p, ie_reembolso_p, nm_usuario_p,
		nm_usuario_p, nr_seq_guia_monitor_w, nr_seq_prestador_w,
		ie_tipo_registro_p, nr_seq_prest_inter_w
	) returning nr_sequencia into nr_seq_guia_ret_p;

	commit;
end if;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerencia_envio_ans_pck.gerar_guia_ret_monitor ( nr_seq_monitor_ret_p pls_monitor_tiss_lote_ret.nr_sequencia%type, cd_cnes_prest_exec_p pls_monitor_tiss_guia_ret.cd_cnes_prest_exec%type, cpf_cgc_prest_exec_p pls_monitor_tiss_guia_ret.cd_cpf_cgc_prest_exec%type, cd_guia_operadora_p pls_monitor_tiss_guia_ret.cd_guia_operadora%type, cd_guia_prestador_p pls_monitor_tiss_guia_ret.cd_guia_prestador%type, dt_processamento_p pls_monitor_tiss_guia_ret.dt_processamento%type, ie_identif_prest_exec_p pls_monitor_tiss_guia_ret.ie_identif_prest_exec%type, ie_reembolso_p pls_monitor_tiss_guia_ret.ie_reembolso%type, nr_lote_p pls_monitor_tiss_lote_ret.nr_lote%type, nm_usuario_p usuario.nm_usuario%type, ie_tipo_registro_p pls_monitor_tiss_guia_ret.ie_tipo_registro%type, nr_ident_fornec_direto_p pls_conta.nr_sequencia%type, ie_tipo_lote_p text, nr_seq_guia_ret_p INOUT pls_monitor_tiss_guia_ret.nr_sequencia%type) FROM PUBLIC;
