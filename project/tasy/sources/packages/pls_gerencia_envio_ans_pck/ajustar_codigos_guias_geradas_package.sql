-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_gerencia_envio_ans_pck.ajustar_codigos_guias_geradas ( nr_seq_lote_p pls_monitor_tiss_lote.nr_sequencia%type) AS $body$
DECLARE


qt_registro_w		integer;
tb_seq_w		pls_util_cta_pck.t_number_table;
tb_cd_guia_operadora_w	pls_util_cta_pck.t_varchar2_table_20;
tb_cd_guia_prestador_w	pls_util_cta_pck.t_varchar2_table_20;
tb_cd_guia_principal_w	pls_util_cta_pck.t_varchar2_table_20;

dados_cta CURSOR(	nr_seq_lote_pc	pls_monitor_tiss_cta_val.nr_sequencia%type) FOR
	SELECT	nr_sequencia,
		cd_guia_operadora,
		cd_guia_prestador,
		cd_guia_principal
	from	pls_monitor_tiss_cta_val
	where	nr_seq_lote_monitor = nr_seq_lote_pc
	and	ie_conta_atualizada = 'S';

BEGIN

qt_registro_w := 0;

for r_dados_cta_w in dados_cta(nr_seq_lote_p) loop

	tb_seq_w(qt_registro_w)			:= r_dados_cta_w.nr_sequencia;
	tb_cd_guia_operadora_w(qt_registro_w)	:= pls_gerencia_envio_ans_pck.tratar_codigo_guia_envio(r_dados_cta_w.cd_guia_operadora);
	tb_cd_guia_prestador_w(qt_registro_w)	:= pls_gerencia_envio_ans_pck.tratar_codigo_guia_envio(r_dados_cta_w.cd_guia_prestador);
	tb_cd_guia_principal_w(qt_registro_w)	:= pls_gerencia_envio_ans_pck.tratar_codigo_guia_envio(r_dados_cta_w.cd_guia_principal);

	-- Parmetro que define se o cdigo da guia no prestador, dever receber o mesmo cdigo de guia na Operadora quando a guia do prestador estiver nula

	if (current_setting('pls_gerencia_envio_ans_pck.ie_utiliza_guia_w')::pls_monitor_tiss_param.ie_utiliza_guia_operadora%type = 'S' and coalesce(tb_cd_guia_prestador_w(qt_registro_w)::text, '') = '' ) then
		tb_cd_guia_prestador_w(qt_registro_w) := tb_cd_guia_operadora_w(qt_registro_w);
	end if;

	--Existem casos aonde a guia  digitada e no  informada, apenas a guia do prestador

	if (coalesce(tb_cd_guia_operadora_w(qt_registro_w)::text, '') = '') and ((tb_cd_guia_prestador_w(qt_registro_w) IS NOT NULL AND (tb_cd_guia_prestador_w(qt_registro_w))::text <> '')) then
		tb_cd_guia_operadora_w(qt_registro_w)	:= tb_cd_guia_prestador_w(qt_registro_w);
	end if;

	qt_registro_w := qt_registro_w + 1;

	if (qt_registro_w >= current_setting('pls_gerencia_envio_ans_pck.qt_registro_transacao_w')::integer) then

		-- atualiza

		CALL pls_gerencia_envio_ans_pck.atualizar_cd_guias_ajustadas(	tb_seq_w, tb_cd_guia_operadora_w,tb_cd_guia_prestador_w,tb_cd_guia_principal_w);
		-- Limpa as variveis

		tb_seq_w.delete;
		tb_cd_guia_operadora_w.delete;
		tb_cd_guia_prestador_w.delete;
		tb_cd_guia_principal_w.delete;
		qt_registro_w := 0;
	end if;

end loop;

CALL pls_gerencia_envio_ans_pck.atualizar_cd_guias_ajustadas(	tb_seq_w, tb_cd_guia_operadora_w,tb_cd_guia_prestador_w,tb_cd_guia_principal_w);

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerencia_envio_ans_pck.ajustar_codigos_guias_geradas ( nr_seq_lote_p pls_monitor_tiss_lote.nr_sequencia%type) FROM PUBLIC;
