-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


--Function para obter o cdigo do material TUSS que dever ser enviado para ANS



CREATE OR REPLACE FUNCTION pls_gerencia_envio_ans_pck.obter_cod_material_tuss ( nr_seq_material_p pls_material.nr_sequencia%type, nr_seq_mat_tuss_p tuss_material_item.nr_sequencia%type, dt_material_p pls_conta_mat.dt_atendimento_referencia%type) RETURNS varchar AS $body$
DECLARE



cd_material_w		pls_monitor_tiss_mat_val.cd_material%type;


BEGIN

if (current_setting('pls_gerencia_envio_ans_pck.ie_utiliza_mat_ops_w')::varchar(1) = 'S') then
	select	cd_material_ops
	into STRICT	cd_material_w
	from	pls_material
	where	nr_sequencia = nr_seq_material_p;
else
	--Se j existir material TUSS,  retornado o cdigo do material

	if (nr_seq_mat_tuss_p IS NOT NULL AND nr_seq_mat_tuss_p::text <> '') then
		select	max(cd_material_tuss)
		into STRICT	cd_material_w
		from	tuss_material_item
		where	nr_sequencia	= nr_seq_mat_tuss_p;
	else
	--Caso contrrio retorno o cdigo do material da operadora

		select	max(cd_material_tuss)
		into STRICT	cd_material_w
		from (SELECT	to_char(a.cd_material_tuss) cd_material_tuss
			from	tuss_material_item a,
				pls_material b
			where	b.nr_seq_tuss_mat_item 	= a.nr_sequencia
			and	b.nr_sequencia		= nr_seq_material_p
			and	dt_material_p between a.dt_inicio_vigencia_ref and a.dt_fim_vigencia_ref
			
union

			SELECT	cd_material_ops cd_material_tuss
			from	pls_material
			where	nr_sequencia = nr_seq_material_p LIMIT 1) alias2;
	end if;
end if;

return cd_material_w;
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pls_gerencia_envio_ans_pck.obter_cod_material_tuss ( nr_seq_material_p pls_material.nr_sequencia%type, nr_seq_mat_tuss_p tuss_material_item.nr_sequencia%type, dt_material_p pls_conta_mat.dt_atendimento_referencia%type) FROM PUBLIC;
