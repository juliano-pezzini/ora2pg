-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_gerencia_envio_ans_pck.define_cod_mat_nao_localizados ( nr_seq_lote_p pls_monitor_tiss_lote.nr_sequencia%type ) AS $body$
DECLARE



ind_w		integer := 0;
tb_nr_seq_conta_mat_w	pls_util_cta_pck.t_number_table;
tb_cd_mat_w	pls_util_cta_pck.t_varchar2_table_20;

C01 CURSOR(nr_seq_lote_pc	pls_monitor_tiss_lote.nr_sequencia%type) FOR
	SELECT	a.nr_sequencia
	from	pls_monitor_tiss_cta_val a
	where	a.nr_sequencia in ( SELECT 	y.nr_sequencia
                            from 	pls_monitor_tiss_cta_val y,
					pls_monitor_tiss_alt x
                            where 	x.ie_tipo_evento not in ('AV', 'AD','FR')
                            and 	x.ie_status in ('P', 'N')
                            and 	x.dt_evento between dt_mes_competencia_ini_w and dt_mes_competencia_fim_w
                            and  	y.nr_seq_lote_monitor = nr_seq_lote_p
                            and 	y.nr_seq_conta = x.nr_seq_conta);

C02 CURSOR(	nr_seq_cta_val_pc		pls_monitor_tiss_mat_val.nr_seq_cta_val%type) FOR
	SELECT	a.nr_sequencia,
			a.nr_seq_conta_mat,
			( SELECT cd_material_imp from pls_conta_mat where nr_sequencia = a.nr_seq_conta_mat) cd_material_imp
	from	pls_monitor_tiss_mat_val a
	where	a.nr_seq_cta_val = nr_seq_cta_val_pc
	and		coalesce(a.cd_material::text, '') = '';

BEGIN

	for r_c01_w in C01(nr_seq_lote_p) loop

		for r_c02_w in C02(r_c01_w.nr_sequencia) loop

			if (r_c02_w.cd_material_imp IS NOT NULL AND r_c02_w.cd_material_imp::text <> '') then

				tb_cd_mat_w(ind_w) := r_c02_w.cd_material_imp;
				tb_nr_seq_conta_mat_w(ind_w) := r_c02_w.nr_sequencia;

				if (ind_w >= 1000 )  then
					CALL pls_gerencia_envio_ans_pck.atualiza_cod_mat(tb_cd_mat_w, tb_nr_seq_conta_mat_w);
					ind_w := 0;
					tb_cd_mat_w.delete;
					tb_nr_seq_conta_mat_w.delete;
				else
					ind_w := ind_w + 1;
				end if;

			end if;
		end loop;
	end loop;
	CALL pls_gerencia_envio_ans_pck.atualiza_cod_mat(tb_cd_mat_w, tb_nr_seq_conta_mat_w);

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerencia_envio_ans_pck.define_cod_mat_nao_localizados ( nr_seq_lote_p pls_monitor_tiss_lote.nr_sequencia%type ) FROM PUBLIC;
