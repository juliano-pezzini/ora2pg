-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_gerencia_envio_ans_pck.consiste_registros_ret_ans ( nr_seq_arquivo_p pls_monitor_tiss_arquivo.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE


qt_total_incluido_w		pls_monitor_tiss_lote_ret.qt_total_incluido%type;
qt_total_excluido_w		pls_monitor_tiss_lote_ret.qt_total_excluido%type;
nr_seq_lote_monitor_w	pls_monitor_tiss_lote_com.nr_seq_lote_monitor%type;
nr_seq_arquivo_w		pls_monitor_tiss_lote_ret.nr_seq_arquivo%type;
current_setting('pls_gerencia_envio_ans_pck.ie_tipo_lote_w')::pls_monitor_tiss_lote.ie_tipo_lote%type			pls_monitor_tiss_lote.ie_tipo_lote%type;
dt_mes_comp_w			pls_monitor_tiss_lote.dt_mes_competencia%type;
qt_reg_w				bigint;
ds_log_w				pls_log_execucao_temp.ds%type;
ds_log_call_w			varchar(4000);


BEGIN
	


	--Busca informaes baseadas no arquivo de retorno recm importado

	select 	a.qt_total_incluido,
			a.qt_total_excluido,
			b.nr_seq_lote_monitor, 
			a.nr_seq_arquivo,
			(select trunc(dt_mes_competencia,'MM')
			 from	pls_monitor_tiss_lote
			 where 	nr_sequencia = b.nr_seq_lote_monitor) dt_mes_comp
	into STRICT	qt_total_incluido_w,
	        qt_total_excluido_w,
	        nr_seq_lote_monitor_w,
	        nr_seq_arquivo_w, 
			dt_mes_comp_w
	from  	pls_monitor_tiss_lote_ret  a,
			pls_monitor_tiss_lote_com b
	where  	a.nr_Sequencia = nr_seq_arquivo_p
	and    	a.nr_seq_lote_com = b.nr_sequencia;
	
	select 	ie_tipo_Lote
	into STRICT	current_setting('pls_gerencia_envio_ans_pck.ie_tipo_lote_w')::pls_monitor_tiss_lote.ie_tipo_lote%type
	from	pls_monitor_tiss_lote
	where 	nr_sequencia = nr_seq_lote_monitor_w;
	
	-- 0 Incluso  1 - Excluso

	if ( current_setting('pls_gerencia_envio_ans_pck.ie_tipo_lote_w')::pls_monitor_tiss_lote.ie_tipo_lote%type = 0) then
	
		--Se foi lote de incluso, a quantidade de contas incluidas atravs do arquivo que est sendo importado, dever ficar com status = 'A' na tabela de controle

		--Retornar a quantidade de contas distintas que tiveram o status atualizado para Aceito pela ANS, Dever bater com a quantidade includa no arquivo retorno

		select	count(distinct b.nr_seq_conta)--nr_sequencia
		into STRICT	qt_reg_w
		from	pls_monitor_tiss_guia a,
				pls_monitor_tiss_alt b
		where 	a.nr_seq_arq_monitor = nr_seq_arquivo_w
		and		b.ie_status = 'A'
		and 	a.nr_seq_conta = b.nr_seq_conta
		and		b.dt_evento between dt_mes_comp_w and fim_mes(dt_mes_comp_w);
		
		if ( qt_reg_w != qt_total_incluido_w) then
		
			--gera log com quantidade includa apontada no arquivo e a quantidade de diferentes contas que tiveram status alterado para Aceito pela ANS.

			
			ds_log_w := 'Lote de incluso com '||qt_total_incluido_w||' contas includas, porm, com '||qt_reg_w||' contas dentro da competncia/lote
			que esto com status aceito na pls_monitor_tiss_alt. Verificar!';
			
			ds_log_call_w := substr(	' Funo ativa : '|| obter_funcao_ativa || chr(13) ||chr(10)||
							' CallStack: '|| chr(13) || chr(10)|| dbms_utility.format_call_stack,1,1500);
			
			CALL pls_grava_log_execucao_temp( ds_log_w, 'Ps importao de retorno do monitoramento', nm_usuario_p , 'S', ds_log_call_w );
		
		end if;
	
	elsif ( current_setting('pls_gerencia_envio_ans_pck.ie_tipo_lote_w')::pls_monitor_tiss_lote.ie_tipo_lote%type = 1) then
	
		--Se foi lote de excluso, a quantidade de contas excluidas atravs do arquivo que est sendo importado, dever ficar com status que aceite reenvio de incluso na tabela de controle

		--Retornar a quantidade de contas distintas que tiveram o status atualizado para Aceito pela ANS, Dever bater com a quantidade includa no arquivo retorno

		select	count(distinct b.nr_seq_conta)--nr_sequencia
		into STRICT	qt_reg_w
		from	pls_monitor_tiss_guia a,
				pls_monitor_tiss_alt b
		where 	a.nr_seq_arq_monitor = nr_seq_arquivo_w
		and		b.ie_status in ('P','N')
		and 	a.nr_seq_conta = b.nr_seq_conta
		and		b.dt_evento between dt_mes_comp_w and fim_mes(dt_mes_comp_w);
		
		if ( qt_reg_w != qt_total_excluido_w ) then
		
			--gera log com quantidade excluda apontada no arquivo e a quantidade de diferentes contas que tiveram status alterado para possibilitar elegibilidade para entrada em novo lote de incluso.

			ds_log_w := 'Lote de excluso com '||qt_total_excluido_w||' contas excludas, porm, com '||qt_reg_w||' contas dentro da competncia/lote
			que esto com status na pls_monitor_tiss_alt que possibilite elegibilidade para novo lote de incluso. Verificar!';
			
			ds_log_call_w := substr(	' Funo ativa : '|| obter_funcao_ativa || chr(13) ||chr(10)||
							' CallStack: '|| chr(13) || chr(10)|| dbms_utility.format_call_stack,1,1500);
			
			CALL pls_grava_log_execucao_temp( ds_log_w, 'Ps importao de retorno do monitoramento', nm_usuario_p , 'S', ds_log_call_w );
		
		end if;
	
	end if;

commit;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerencia_envio_ans_pck.consiste_registros_ret_ans ( nr_seq_arquivo_p pls_monitor_tiss_arquivo.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;
