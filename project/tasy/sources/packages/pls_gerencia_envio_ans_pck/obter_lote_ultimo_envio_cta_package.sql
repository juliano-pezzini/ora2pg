-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pls_gerencia_envio_ans_pck.obter_lote_ultimo_envio_cta ( nr_seq_conta_p pls_monitor_tiss_guia.nr_seq_conta%type, nr_seq_lote_atual_p pls_monitor_tiss_lote.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) RETURNS bigint AS $body$
DECLARE


nr_seq_lote_w		pls_monitor_tiss_lote.nr_sequencia%type;

c01 CURSOR(	nr_seq_conta_pc		pls_monitor_tiss_guia.nr_seq_conta%type,
		nr_seq_lote_atual_pc	pls_monitor_tiss_lote.nr_sequencia%type,
		cd_estabelecimento_pc	estabelecimento.cd_estabelecimento%type,
		ie_controla_estab_pc	pls_controle_estab.ie_monitoramento_ans%type) FOR
	SELECT	a.nr_seq_lote_monitor,
		b.dt_geracao_lote
	from	pls_monitor_tiss_guia a,
		pls_monitor_tiss_lote b,
		pls_moni_tiss_chave_guia c
	where  	a.nr_seq_conta = nr_seq_conta_pc
	and    	a.nr_seq_lote_monitor != nr_seq_lote_atual_pc
	and	a.ie_tipo_registro = '1'
	and    	b.nr_sequencia = a.nr_seq_lote_monitor
	and    	c.nr_sequencia = a.nr_seq_chave_guia
	and	c.ie_status = 'E'
	and	ie_controla_estab_pc = 'N'
	
union all

	SELECT	a.nr_seq_lote_monitor,
		b.dt_geracao_lote
	from	pls_monitor_tiss_guia a,
		pls_monitor_tiss_lote b,
		pls_moni_tiss_chave_guia c
	where  	a.nr_seq_conta = nr_seq_conta_pc
	and    	a.nr_seq_lote_monitor != nr_seq_lote_atual_pc
	and	a.ie_tipo_registro = '1'
	and	b.cd_estabelecimento = cd_estabelecimento_pc
	and    	b.nr_sequencia = a.nr_seq_lote_monitor
	and    	c.nr_sequencia = a.nr_seq_chave_guia
	and	c.ie_status = 'E'
	and	ie_controla_estab_pc = 'S'
	order by dt_geracao_lote;

BEGIN
-- Retorna todos os lotes onde a conta foi enviada e aceita pela ANS (incluso somente)

-- O ltimo  o que ser considerado

for r_c01_w in c01(nr_seq_conta_p, nr_seq_lote_atual_p, cd_estabelecimento_p, current_setting('pls_gerencia_envio_ans_pck.ie_controla_estab_w')::pls_controle_estab.ie_monitoramento_ans%type) loop
	nr_seq_lote_w := r_c01_w.nr_seq_lote_monitor;
end loop;

return nr_seq_lote_w;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pls_gerencia_envio_ans_pck.obter_lote_ultimo_envio_cta ( nr_seq_conta_p pls_monitor_tiss_guia.nr_seq_conta%type, nr_seq_lote_atual_p pls_monitor_tiss_lote.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) FROM PUBLIC;
