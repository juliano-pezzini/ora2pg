-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


-- Gerar os procedimentos e materiais recusador no arquivo enviado para ANS



CREATE OR REPLACE PROCEDURE pls_gerencia_envio_ans_pck.gerar_proc_ret_monitor ( nr_seq_guia_ret_p pls_monitor_tiss_guia_ret.nr_sequencia%type, cd_grupo_proc_p pls_monitor_tiss_proc_ret.cd_grupo_proc%type, cd_procedimento_p pls_monitor_tiss_proc_ret.cd_procedimento%type, cd_tabela_ref_p pls_monitor_tiss_proc_ret.cd_tabela_ref%type, cd_dente_p pls_monitor_tiss_proc_ret.cd_dente%type, cd_face_dente_p pls_monitor_tiss_proc_ret.cd_face_dente%type, cd_regiao_boca_p pls_monitor_tiss_proc_ret.cd_regiao_boca%type, nm_usuario_p usuario.nm_usuario%type, nr_seq_proc_ret_p INOUT pls_monitor_tiss_proc_ret.nr_sequencia%type) AS $body$
DECLARE


ie_origem_proced_w	pls_monitor_tiss_proc_ret.ie_origem_proced%type;
cd_material_w		pls_monitor_tiss_proc_ret.cd_material%type;
cd_procedimento_w	pls_monitor_tiss_proc_ret.cd_procedimento%type;
nr_seq_material_w	pls_monitor_tiss_proc_ret.nr_seq_material%type;
ie_tipo_item_w		varchar(2);


BEGIN

if (nr_seq_guia_ret_p IS NOT NULL AND nr_seq_guia_ret_p::text <> '') then

	--18 TUSS _ Taxas hospitalares, dirias e gases medicinais

	--19 TUSS _ Materiais

	--20 TUSS - Medicamentos

	--22 TUSS _ Procedimentos e eventos em sade (medicina, odonto e demais reas de sade)

	--98 Pacote - Tabela prpria de pacote

	--00 Tabela Prpria das Operadoras


	ie_tipo_item_w := pls_gerencia_envio_ans_pck.obter_se_proc_mat_ret(nr_seq_guia_ret_p, cd_procedimento_p);

	if (ie_tipo_item_w = 'M') then
		cd_material_w 		:= cd_procedimento_p;
		nr_seq_material_w	:= pls_obter_seq_codigo_material('', cd_material_w);
	elsif (ie_tipo_item_w = 'P') then
		cd_procedimento_w 	:= cd_procedimento_p;
		ie_origem_proced_w	:= 8;
	else
		if (cd_tabela_ref_p in ('19','20')) then
			cd_material_w 		:= cd_procedimento_p;
			nr_seq_material_w	:= pls_obter_seq_codigo_material('', cd_material_w);
		else
			cd_procedimento_w 	:= cd_procedimento_p;
			ie_origem_proced_w	:= 8;

			if ( cd_tabela_ref_p = '00' ) then
				--Se no for TUSS recebe origem 4 - Tabela prpria operadora

				ie_origem_proced_w	:= 4;
			end if;
		end if;

	end if;

	insert into pls_monitor_tiss_proc_ret(
		nr_sequencia, nr_seq_guia_monitor_ret, cd_grupo_proc,
		cd_procedimento, cd_tabela_ref, dt_atualizacao,
		dt_atualizacao_nrec, ie_origem_proced, nm_usuario,
		nm_usuario_nrec, cd_material, nr_seq_material,
		cd_dente, cd_regiao_boca, cd_face_dente  )
	values (	nextval('pls_monitor_tiss_proc_ret_seq'), nr_seq_guia_ret_p, cd_grupo_proc_p,
		cd_procedimento_w, cd_tabela_ref_p, clock_timestamp(),
		clock_timestamp(), ie_origem_proced_w, nm_usuario_p,
		nm_usuario_p, cd_material_w, nr_seq_material_w,
		cd_dente_p, cd_regiao_boca_p, cd_face_dente_p
	) returning nr_sequencia into nr_seq_proc_ret_p;

	commit;
end if;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerencia_envio_ans_pck.gerar_proc_ret_monitor ( nr_seq_guia_ret_p pls_monitor_tiss_guia_ret.nr_sequencia%type, cd_grupo_proc_p pls_monitor_tiss_proc_ret.cd_grupo_proc%type, cd_procedimento_p pls_monitor_tiss_proc_ret.cd_procedimento%type, cd_tabela_ref_p pls_monitor_tiss_proc_ret.cd_tabela_ref%type, cd_dente_p pls_monitor_tiss_proc_ret.cd_dente%type, cd_face_dente_p pls_monitor_tiss_proc_ret.cd_face_dente%type, cd_regiao_boca_p pls_monitor_tiss_proc_ret.cd_regiao_boca%type, nm_usuario_p usuario.nm_usuario%type, nr_seq_proc_ret_p INOUT pls_monitor_tiss_proc_ret.nr_sequencia%type) FROM PUBLIC;
