-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pls_gerencia_envio_ans_pck.obter_restricao_lote_exclusao (nr_seq_lote_p pls_monitor_tiss_lote.nr_sequencia%type) RETURNS varchar AS $body$
DECLARE


dt_inicio_exclusao_w		pls_monitor_tiss_lote.dt_mes_competencia%type;
dt_fim_exclusao_w		pls_monitor_tiss_lote.dt_mes_competencia%type;
nr_seq_lote_monitor_w		pls_monitor_tiss_lote.nr_sequencia%type;
ie_lote_w			pls_lote_ans_filtro.ie_lote%type;
ie_conta_w			pls_lote_ans_filtro.ie_conta%type;
ie_glosa_w			pls_lote_ans_filtro.ie_glosa%type;
ie_lote_retorno_w		pls_lote_ans_filtro.ie_lote_retorno%type;
ie_guia_w			pls_lote_ans_filtro.ie_guia%type;
nr_seq_ans_filtro_w		pls_lote_ans_filtro.nr_sequencia%type;
ds_restricao_w			varchar(32000);
ds_lotes_w			varchar(16000);
ds_contas_w			varchar(16000);
ds_glosas_w			varchar(16000);
qt_filtro_w			integer;


BEGIN
-- Utilizado max pois somente ter um registro por lote

select	coalesce(max(ie_lote),'N'),
	coalesce(max(ie_conta),'N'),
	coalesce(max(ie_glosa),'N'),
	coalesce(max(ie_lote_retorno),'N'),
	coalesce(max(ie_guia),'N'),
	max(nr_sequencia)
into STRICT	ie_lote_w,
	ie_conta_w,
	ie_glosa_w,
	ie_lote_retorno_w,
	ie_guia_w,
	nr_seq_ans_filtro_w
from	pls_lote_ans_filtro
where	nr_seq_lote_monitor = nr_seq_lote_p;

-- Lote

if (ie_lote_w = 'S') then

	select	count(1)
	into STRICT	qt_filtro_w
	from	pls_monit_ans_filtro_lote
	where	nr_seq_ans_filtro = nr_seq_ans_filtro_w;

	if (qt_filtro_w > 0) then

		ds_restricao_w := ds_restricao_w || 	' and a.nr_seq_lote_monitor in(	select	x.nr_seq_lote			' || pls_util_pck.enter_w ||
							'				from	pls_monit_ans_filtro_lote x	' || pls_util_pck.enter_w ||
							'				where	x.nr_seq_ans_filtro = ' || nr_seq_ans_filtro_w || ' ) ' || pls_util_pck.enter_w;
	end if;
end if;
-- Conta

if (ie_conta_w = 'S') then

	select	count(1)
	into STRICT	qt_filtro_w
	from	pls_monit_ans_filtro_conta
	where	nr_seq_ans_filtro = nr_seq_ans_filtro_w;

	if (qt_filtro_w > 0) then

		ds_restricao_w := ds_restricao_w || 	' and a.nr_seq_conta in (	select	x.nr_seq_conta			' || pls_util_pck.enter_w ||
							'				from	pls_monit_ans_filtro_conta x	' || pls_util_pck.enter_w ||
							'				where	x.nr_seq_ans_filtro = ' || nr_seq_ans_filtro_w  || ' ) ' || pls_util_pck.enter_w;
	end if;
end if;
--  Lote retorno

if (ie_lote_retorno_w = 'S') then

	select	count(1)
	into STRICT	qt_filtro_w
	from	pls_monit_ans_filtro_ret
	where	nr_seq_ans_filtro = nr_seq_ans_filtro_w;

	if (qt_filtro_w > 0) then

		ds_restricao_w := ds_restricao_w ||	' and exists (	select	1								' || pls_util_pck.enter_w ||
							'		from	pls_monitor_tiss_guia_ret x,					' || pls_util_pck.enter_w ||
							'			pls_monitor_tiss_lote_ret y,					' || pls_util_pck.enter_w ||
							'			pls_monitor_tiss_guia z						' || pls_util_pck.enter_w ||
							'		where	y.nr_sequencia = x.nr_seq_lote_monitor_ret			' || pls_util_pck.enter_w ||
							'		and	z.nr_sequencia = x.nr_seq_guia_monitor				' || pls_util_pck.enter_w ||
							'		and	z.nr_seq_conta = a.nr_seq_conta					' || pls_util_pck.enter_w ||
							'		and	y.nr_seq_lote_com in (	select	z.nr_seq_lote_com		' || pls_util_pck.enter_w ||
							'						from	pls_monit_ans_filtro_ret z	' || pls_util_pck.enter_w ||
							'						where	z.nr_seq_ans_filtro = ' || nr_seq_ans_filtro_w || ' )) ' || pls_util_pck.enter_w;
	end if;
end if;
-- Guia

if (ie_guia_w = 'S') then

	select	count(1)
	into STRICT	qt_filtro_w
	from	pls_monit_ans_filtro_guia
	where	nr_seq_ans_filtro = nr_seq_ans_filtro_w;

	if (qt_filtro_w > 0) then

		ds_restricao_w := ds_restricao_w ||	' and a.cd_guia_operadora in (	select	cd_guia				' || pls_util_pck.enter_w ||
							'				from	pls_monit_ans_filtro_guia x	' || pls_util_pck.enter_w ||
							'				where	x.nr_seq_ans_filtro = ' || nr_seq_ans_filtro_w || ' ) ' || pls_util_pck.enter_w;
	end if;
end if;

-- Glosa

if (ie_glosa_w = 'S') then

	select	count(1)
	into STRICT	qt_filtro_w
	from	pls_monit_ans_filtro_glosa
	where	nr_seq_ans_filtro = nr_seq_ans_filtro_w;

	if (qt_filtro_w > 0) then

		ds_restricao_w := ds_restricao_w ||	' and exists (	select	1									' || pls_util_pck.enter_w ||
							'		from	pls_monitor_tiss_guia_ret x,						' || pls_util_pck.enter_w ||
							'			pls_monitor_tiss_glosa y,						' || pls_util_pck.enter_w ||
							'			pls_monitor_tiss_guia z							' || pls_util_pck.enter_w ||
							'		where	x.nr_sequencia = y.nr_seq_guia_monitor_ret				' || pls_util_pck.enter_w ||
							'		and	z.nr_sequencia = x.nr_seq_guia_monitor					' || pls_util_pck.enter_w ||
							'		and	a.nr_seq_conta = z.nr_seq_conta						' || pls_util_pck.enter_w ||
							'		and	y.cd_glosa in (	select	cd_glosa_tiss					' || pls_util_pck.enter_w ||
							'					from	pls_monit_ans_filtro_glosa			' || pls_util_pck.enter_w ||
							'					where	nr_seq_ans_filtro = ' || nr_seq_ans_filtro_w || ' ) ' || pls_util_pck.enter_w ||
							'		union all									' || pls_util_pck.enter_w ||
							'		select	1									' || pls_util_pck.enter_w ||
							'		from	pls_monitor_tiss_guia_ret x,						' || pls_util_pck.enter_w ||
							'			pls_monitor_tiss_glosa y,						' || pls_util_pck.enter_w ||
							'			pls_monitor_tiss_proc_ret z,						' || pls_util_pck.enter_w ||
							'			pls_monitor_tiss_guia w							' || pls_util_pck.enter_w ||
							'		where	x.nr_sequencia = z.nr_seq_guia_monitor_ret				' || pls_util_pck.enter_w ||
							'		and	z.nr_sequencia = y.nr_seq_guia_proc_ret					' || pls_util_pck.enter_w ||
							'		and	w.nr_sequencia = x.nr_seq_guia_monitor					' || pls_util_pck.enter_w ||
							'		and	a.nr_seq_conta = w.nr_seq_conta						' || pls_util_pck.enter_w ||
							'		and	y.cd_glosa in (	select	cd_glosa_tiss					' || pls_util_pck.enter_w ||
							'					from	pls_monit_ans_filtro_glosa			' || pls_util_pck.enter_w ||
							'					where	nr_seq_ans_filtro = ' || nr_seq_ans_filtro_w || ' )) ' || pls_util_pck.enter_w;
	end if;
end if;

return ds_restricao_w;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_gerencia_envio_ans_pck.obter_restricao_lote_exclusao (nr_seq_lote_p pls_monitor_tiss_lote.nr_sequencia%type) FROM PUBLIC;
