-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pls_gerencia_envio_ans_pck.obter_valor_coparticipacao ( nr_seq_conta_p pls_conta.nr_sequencia%type, ie_tipo_guia_p pls_conta.ie_tipo_guia%type, ie_tipo_atendimento_p pls_tipo_atendimento.nr_sequencia%type, nr_seq_conta_proc_p pls_conta_mat.nr_sequencia%type, nr_seq_conta_mat_p pls_conta_mat.nr_sequencia%type, ie_total_p text, nr_seq_conta_rec_p pls_monitor_tiss_cta_val.nr_seq_conta_rec%type) RETURNS bigint AS $body$
DECLARE


vl_coparticipacao_w		  pls_conta_coparticipacao.vl_coparticipacao%type := 0;
vl_copart_pacote_w		  pls_conta_coparticipacao.vl_coparticipacao%type := 0;
ie_regime_atendimento_w pls_conta.ie_regime_atendimento%type            := '0';


BEGIN

    select coalesce(ie_regime_atendimento,'0')
	    into STRICT ie_regime_atendimento_w
	    from pls_conta
     where nr_sequencia = nr_seq_conta_p;

if (ie_total_p = 'S') then
	-- Para internao deve ser informado somente o total de coparticipao

	-- e no individual por item, pois no entendimento da ANS

	-- a operadora no gera coparticipao de internao por item

	-- e sim por atendimento

	-- Para guais de HI e SADT internado no deve ter nem individual

	-- nem a nvel de atendimento

	if	((ie_tipo_guia_p = '6') or (ie_tipo_guia_p = '4' and ie_tipo_atendimento_p = '07') or (ie_tipo_guia_p = '4' and ie_regime_atendimento_w = '03')) then

		vl_coparticipacao_w := 0;
	else
		if (coalesce(nr_seq_conta_rec_p::text, '') = '') then
			select	sum(vl_coparticipacao)
			into STRICT	vl_coparticipacao_w
			from	pls_conta_coparticipacao
			where	nr_seq_conta = nr_seq_conta_p
			and	coalesce(nr_seq_conta_rec::text, '') = '';
		else
			select	sum(vl_coparticipacao)
			into STRICT	vl_coparticipacao_w
			from	pls_conta_coparticipacao
			where	nr_seq_conta = nr_seq_conta_p
			and	(nr_seq_conta_rec IS NOT NULL AND nr_seq_conta_rec::text <> '');
		end if;
	end if;
else
	-- Se for superior a verso 3.03.02, no gera coparticipao para HI, SADT internado e Internao

	if	((ie_tipo_guia_p in ('6','5')) or (ie_tipo_guia_p = '4' and ie_tipo_atendimento_p = '07') or (ie_tipo_guia_p = '4' and ie_regime_atendimento_w = '03')) then

		vl_coparticipacao_w := 0;
	else
		if (coalesce(nr_seq_conta_rec_p::text, '') = '') then
			if (nr_seq_conta_proc_p IS NOT NULL AND nr_seq_conta_proc_p::text <> '') then

				select	coalesce(sum(vl_coparticipacao),0)
				into STRICT	vl_coparticipacao_w
				from	pls_conta_coparticipacao
				where	nr_seq_conta = nr_seq_conta_p
				and	nr_seq_conta_proc = nr_seq_conta_proc_p
				and	coalesce(nr_seq_conta_rec::text, '') = '';

				select	coalesce(sum(a.vl_coparticipacao),0)
				into STRICT	vl_copart_pacote_w
				from	pls_conta_coparticipacao a,
					pls_conta_proc b
				where	b.nr_sequencia = a.nr_seq_conta_proc
				and	b.nr_seq_conta = nr_seq_conta_p
				and	b.nr_seq_proc_pct = nr_seq_conta_proc_p
				and	coalesce(a.nr_seq_conta_rec::text, '') = '';

				vl_coparticipacao_w := vl_coparticipacao_w + vl_copart_pacote_w;

			else
				select	sum(vl_coparticipacao)
				into STRICT	vl_coparticipacao_w
				from	pls_conta_coparticipacao
				where	nr_seq_conta = nr_seq_conta_p
				and	nr_seq_conta_mat = nr_seq_conta_mat_p
				and	coalesce(nr_seq_conta_rec::text, '') = '';
			end if;
		else
			if (nr_seq_conta_proc_p IS NOT NULL AND nr_seq_conta_proc_p::text <> '') then

				select	coalesce(sum(vl_coparticipacao),0)
				into STRICT	vl_coparticipacao_w
				from	pls_conta_coparticipacao
				where	nr_seq_conta = nr_seq_conta_p
				and	nr_seq_conta_proc = nr_seq_conta_proc_p
				and	(nr_seq_conta_rec IS NOT NULL AND nr_seq_conta_rec::text <> '');

				select	coalesce(sum(a.vl_coparticipacao),0)
				into STRICT	vl_copart_pacote_w
				from	pls_conta_coparticipacao a,
					pls_conta_proc b
				where	b.nr_sequencia = a.nr_seq_conta_proc
				and	b.nr_seq_conta = nr_seq_conta_p
				and	b.nr_seq_proc_pct = nr_seq_conta_proc_p
				and	(a.nr_seq_conta_rec IS NOT NULL AND a.nr_seq_conta_rec::text <> '');

				vl_coparticipacao_w := vl_coparticipacao_w + vl_copart_pacote_w;

			else
				select	sum(vl_coparticipacao)
				into STRICT	vl_coparticipacao_w
				from	pls_conta_coparticipacao
				where	nr_seq_conta = nr_seq_conta_p
				and	nr_seq_conta_mat = nr_seq_conta_mat_p
				and	(nr_seq_conta_rec IS NOT NULL AND nr_seq_conta_rec::text <> '');
			end if;
		end if;
	end if;
end if;

return coalesce(vl_coparticipacao_w,0);

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pls_gerencia_envio_ans_pck.obter_valor_coparticipacao ( nr_seq_conta_p pls_conta.nr_sequencia%type, ie_tipo_guia_p pls_conta.ie_tipo_guia%type, ie_tipo_atendimento_p pls_tipo_atendimento.nr_sequencia%type, nr_seq_conta_proc_p pls_conta_mat.nr_sequencia%type, nr_seq_conta_mat_p pls_conta_mat.nr_sequencia%type, ie_total_p text, nr_seq_conta_rec_p pls_monitor_tiss_cta_val.nr_seq_conta_rec%type) FROM PUBLIC;
