-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


--Procedure utilizada para gerar as contas que sero enviadas para a ANS e consistir as mesmas, para garantir que todas as informaes existem na gerao do arquivo



CREATE OR REPLACE PROCEDURE pls_gerencia_envio_ans_pck.gerencia_validacao_envio_ans ( nr_seq_lote_p pls_monitor_tiss_lote.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) AS $body$
DECLARE


vl_param_session_w	integer;
nr_seq_processo_exec_w	pls_monitor_tiss_processo.nr_sequencia%type;
ds_erro_w		pls_monitor_tiss_processo.ds_erro%type;
ds_outros_lote_mes_w	varchar(3000);
nr_seq_guia_ret_act_w	pls_mon_tiss_guia_ret_act.nr_sequencia%type;
ie_agrupar_pagtos_mesma_comp_w pls_monitor_tiss_param.ie_agrupar_pagtos_mesma_comp%type;


BEGIN
-- grava o log de processo que sinaliza a ao que foi feita

nr_seq_processo_exec_w := pls_gerencia_envio_ans_pck.grava_processo(	nr_seq_lote_p, 1, nm_usuario_p, null, nr_seq_processo_exec_w);

select	max(nr_sequencia)
into STRICT	nr_seq_guia_ret_act_w
from	pls_mon_tiss_guia_ret_act;

if (coalesce(nr_seq_guia_ret_act_w::text, '') = '') then
	CALL pls_gerencia_envio_ans_pck.pls_alimenta_reg_aceitos_monit(nm_usuario_p);
end if;

--obter ms de competncia do lote

-- grava em variveis globais para ser acessado de qualquer local

select	trunc(dt_mes_competencia, 'month'),
	fim_mes(dt_mes_competencia),
	coalesce(ie_tipo_lote,'0'),
	cd_versao_tiss,
	dt_inicio_ger_lote,
	dt_fim_ger_lote
into STRICT	current_setting('pls_gerencia_envio_ans_pck.dt_mes_competencia_ini_w')::pls_monitor_tiss_lote.dt_mes_competencia%type,
	current_setting('pls_gerencia_envio_ans_pck.dt_mes_competencia_fim_w')::pls_monitor_tiss_lote.dt_mes_competencia%type,
	current_setting('pls_gerencia_envio_ans_pck.ie_tipo_lote_w')::pls_monitor_tiss_lote.ie_tipo_lote%type,
	current_setting('pls_gerencia_envio_ans_pck.cd_versao_tiss_w')::pls_monitor_tiss_lote.cd_versao_tiss%type,
	current_setting('pls_gerencia_envio_ans_pck.dt_inicio_ger_lote_w')::pls_monitor_tiss_lote.dt_inicio_ger_lote%type,
	current_setting('pls_gerencia_envio_ans_pck.dt_fim_ger_lote_w')::pls_monitor_tiss_lote.dt_fim_ger_lote%type
from	pls_monitor_tiss_lote
where	nr_sequencia = nr_seq_lote_p;

select	coalesce(max(ie_monitoramento_ans),'N')
into STRICT	current_setting('pls_gerencia_envio_ans_pck.ie_controla_estab_w')::pls_controle_estab.ie_monitoramento_ans%type
from	pls_controle_estab;

PERFORM set_config('pls_gerencia_envio_ans_pck.ie_utiliza_mat_ops_w', obter_valor_param_usuario(1386, 6, Obter_Perfil_Ativo, nm_usuario_p, cd_estabelecimento_p), false);

-- retorna todos os outros lotes que esto sendo processados no ms em questo e que no foram enviados para a ANS

ds_outros_lote_mes_w := pls_gerencia_envio_ans_pck.obter_outros_lotes_mes(	nr_seq_lote_p, cd_estabelecimento_p);

-- se retornar algum registro significa que este lote no pode ser processado e gera uma mensagem para o usurio

if (ds_outros_lote_mes_w IS NOT NULL AND ds_outros_lote_mes_w::text <> '') then
	-- exibe a mensagem do erro para o usurio

	CALL wheb_mensagem_pck.exibir_mensagem_abort(325457, 'LOTES=' || ds_outros_lote_mes_w);
end if;

select	coalesce(max(ie_utiliza_guia_operadora),'N') ie_utiliza_guia,
	coalesce(max(ie_envia_cta_inter), 'N') ie_envia_cta_inter,
	coalesce(max(ie_origem_regra_conv_tab), 'T') ie_origem_regra_conv_tab,
	coalesce(max(ie_permite_rec_glosa), 'N') ie_permite_rec_glosa,
	coalesce(max(ie_cbo_prest_executor),'N') ie_cbo_prest_executor,
	coalesce(max(ie_cnes_prest_inter),'N') ie_cnes_prest_inter,
	coalesce(max(ie_agrupar_pagtos_mesma_comp),'N') ie_agrupar_pagtos_mesma_comp,
	coalesce(max(ie_conv_pacote_int),'N') ie_conv_pacote_int,
	coalesce(max(ie_converter_cbo),'N') ie_converter_cbo	
into STRICT	current_setting('pls_gerencia_envio_ans_pck.ie_utiliza_guia_w')::pls_monitor_tiss_param.ie_utiliza_guia_operadora%type,
	current_setting('pls_gerencia_envio_ans_pck.ie_envia_cta_inter_w')::pls_monitor_tiss_param.ie_envia_cta_inter%type,
	current_setting('pls_gerencia_envio_ans_pck.ie_origem_regra_conv_tab_w')::pls_monitor_tiss_param.ie_origem_regra_conv_tab%type,
	current_setting('pls_gerencia_envio_ans_pck.ie_permite_rec_glosa_w')::pls_monitor_tiss_param.ie_permite_rec_glosa%type,
	current_setting('pls_gerencia_envio_ans_pck.ie_cbo_prest_executor_w')::pls_monitor_tiss_param.ie_cbo_prest_executor%type,
	current_setting('pls_gerencia_envio_ans_pck.ie_cnes_prest_inter_w')::pls_monitor_tiss_param.ie_cnes_prest_inter%type,
	ie_agrupar_pagtos_mesma_comp_w,
	current_setting('pls_gerencia_envio_ans_pck.ie_conv_pacote_int_w')::pls_monitor_tiss_param.ie_conv_pacote_int%type,
	current_setting('pls_gerencia_envio_ans_pck.ie_converter_cbo_w')::pls_monitor_tiss_param.ie_converter_cbo%type
from 	pls_monitor_tiss_param
where	cd_estabelecimento = cd_estabelecimento_p;

-- Verifica o parametro Oracle db_file_multiblock_read_count. O mesmo deve ter 128 ou mais para execuo desta rotina por conta do

-- select de vrios registros e os diversos inserts\updates que sero feitos.

begin
	EXECUTE	'select to_number(max(value)) ' ||
				'from	v$parameter ' ||
				'where  name = ''db_file_multiblock_read_count'' '
	into STRICT	vl_param_session_w;
exception
when others then
	-- ganha 1000 pra no entrar nos if's e no alterar nada.

	vl_param_session_w := 1000;
end;
-- Se tiver menos que esse valor ento manda para 128 e no fim da rotina ser retornado ao original caso foi alterado.

if (vl_param_session_w < 128) then

	-- Trata a exceo, se no der para alterar deixa como est,

	begin
		EXECUTE 'alter session set db_file_multiblock_read_count=128';
	exception
	when others then
		null;
	end;
end if;

begin

CALL pls_envio_ans_extra_pck.verifica_lote_permissao_exec(nr_seq_lote_p, current_setting('pls_gerencia_envio_ans_pck.dt_inicio_ger_lote_w')::pls_monitor_tiss_lote.dt_inicio_ger_lote%type, current_setting('pls_gerencia_envio_ans_pck.dt_fim_ger_lote_w')::pls_monitor_tiss_lote.dt_fim_ger_lote%type, cd_estabelecimento_p);
CALL pls_envio_ans_extra_pck.marcar_estagio_geracao(nr_seq_lote_p, 'I', cd_estabelecimento_p);

if (current_setting('pls_gerencia_envio_ans_pck.ie_tipo_lote_w')::pls_monitor_tiss_lote.ie_tipo_lote%type = '1') then
	-- controle inicial de atualizao

	CALL pls_gerencia_envio_ans_pck.gerencia_controle_upd(	nr_seq_lote_p, 'I', nm_usuario_p);

	-- alimentao do nr_lote da tabela PLS_MONITOR_TISS_LOTE (vai no arquivo XML)

	CALL pls_gerencia_envio_ans_pck.gerencia_nr_lote(	nr_seq_lote_p, nm_usuario_p, cd_estabelecimento_p);

	-- Gera as contas para excluso

	CALL pls_gerencia_envio_ans_pck.gerar_contas_envio_ans_exc( nr_seq_lote_p, nm_usuario_p, cd_estabelecimento_p);

	-- Gera os procedimentos das contas adicionadas anteriormente.

	CALL pls_gerencia_envio_ans_pck.gerar_procs_envio_ans_exc( nr_seq_lote_p, nm_usuario_p, cd_estabelecimento_p);

	-- Gera os materiais das contas adicionadas anteriormente.

	CALL pls_gerencia_envio_ans_pck.gerar_mats_envio_ans_exc( nr_seq_lote_p, nm_usuario_p, cd_estabelecimento_p);
	
	-- Deleta todas as contas que no possuem nenhum procedimento e nenhum material

	CALL pls_gerencia_envio_ans_pck.del_contas_sem_item( nr_seq_lote_p );

	--controle final de atualizao onde so excludos os registros de contas que no foram atualizadas

	CALL pls_gerencia_envio_ans_pck.gerencia_controle_upd(	nr_seq_lote_p, 'F', nm_usuario_p);

	--Atualiza informaes materiais no localizados

	CALL pls_gerencia_envio_ans_pck.define_cod_mat_nao_localizados(nr_seq_lote_p);

	--Atualizar o status da conta e do lote, para identificar se ficou com inconsistncias

	CALL pls_gerencia_envio_ans_pck.atualizar_status_lote( nr_seq_lote_p, nm_usuario_p);
elsif (current_setting('pls_gerencia_envio_ans_pck.ie_tipo_lote_w')::pls_monitor_tiss_lote.ie_tipo_lote%type = '2') then -- Trata do lote de alterao das informaes a ans
	-- controle inicial de atualizao

	CALL pls_gerencia_envio_ans_pck.gerencia_controle_upd(	nr_seq_lote_p, 'I', nm_usuario_p);

	-- alimentao do nr_lote da tabela PLS_MONITOR_TISS_LOTE (vai no arquivo XML)

	CALL pls_gerencia_envio_ans_pck.gerencia_nr_lote(	nr_seq_lote_p, nm_usuario_p, cd_estabelecimento_p);

	-- Gera as contas para alterao

	CALL pls_gerencia_envio_ans_pck.gerar_contas_envio_ans_alt( nr_seq_lote_p, nm_usuario_p, cd_estabelecimento_p);

	-- Gera os procedimentos das contas adicionadas anteriormente.  utilizada a mesma estrutura do lote de excluses pois no existem trataentos especficos necessrios

	CALL pls_gerencia_envio_ans_pck.gerar_procs_envio_ans_exc( nr_seq_lote_p, nm_usuario_p, cd_estabelecimento_p);

	-- Gera os materiais das contas adicionadas anteriormente. utilizada a mesma estrutura do lote de excluses pois no existem trataentos especficos necessrios

	CALL pls_gerencia_envio_ans_pck.gerar_mats_envio_ans_exc( nr_seq_lote_p, nm_usuario_p, cd_estabelecimento_p);

	-- Deleta todas as contas que no possuem nenhum procedimento e nenhum material

	CALL pls_gerencia_envio_ans_pck.del_contas_sem_item( nr_seq_lote_p );

	--controle final de atualizao onde so excludos os registros de contas que no foram atualizadas

	CALL pls_gerencia_envio_ans_pck.gerencia_controle_upd(	nr_seq_lote_p, 'F', nm_usuario_p);

	--Atualiza informaes materiais no localizados

	CALL pls_gerencia_envio_ans_pck.define_cod_mat_nao_localizados(nr_seq_lote_p);

	--Atualizar o status da conta e do lote, para identificar se ficou com inconsistncias

	CALL pls_gerencia_envio_ans_pck.atualizar_status_lote( nr_seq_lote_p, nm_usuario_p);
else
	-- controle inicial de atualizao

	CALL pls_gerencia_envio_ans_pck.gerencia_controle_upd(	nr_seq_lote_p, 'I', nm_usuario_p);

	-- alimentao do nr_lote da tabela PLS_MONITOR_TISS_LOTE (vai no arquivo XML)

	CALL pls_gerencia_envio_ans_pck.gerencia_nr_lote(	nr_seq_lote_p, nm_usuario_p, cd_estabelecimento_p);

	--gera as contas nas tabelas de validao

	CALL pls_gerencia_envio_ans_pck.gerar_contas_envio_ans(	nr_seq_lote_p, nm_usuario_p, cd_estabelecimento_p);

	-- gera os procedimentos que sero enviados

	CALL pls_gerencia_envio_ans_pck.gerar_procs_envio_ans(	nr_seq_lote_p, nm_usuario_p, cd_estabelecimento_p);

	-- gera os materiais que sero enviados

	CALL pls_gerencia_envio_ans_pck.gerar_mats_envio_ans(	nr_seq_lote_p, nm_usuario_p, cd_estabelecimento_p);
	
	if (current_setting('pls_gerencia_envio_ans_pck.ie_converter_cbo_w')::pls_monitor_tiss_param.ie_converter_cbo%type = 'S') then
	CALL pls_envio_ans_extra_pck.pls_converter_cbo_tiss(nr_seq_lote_p, cd_estabelecimento_p);
	end if;

	--condensa valores de pagamnto de recurso e pagamento de conta que ocorrem na mesma competencia, deixando registros com tipo evento PR com status AG

	if (ie_agrupar_pagtos_mesma_comp_w = 'S') then
		pls_envio_ans_extra_pck.condensa_reg_conta_recurso( nr_seq_lote_p, nm_usuario_p, cd_estabelecimento_p);
	end if;
	
	-- Deleta todas as contas que no possuem nenhum procedimento e nenhum material

	CALL pls_gerencia_envio_ans_pck.del_contas_sem_item( nr_seq_lote_p );

	-- gera registros na tabela pls_monitor_tiss_alt_guia

	CALL pls_gerencia_envio_ans_pck.gerar_vinculo_futuro_retorno(	nr_seq_lote_p, nm_usuario_p);

	-- alimenta a tabela pls_moni_tiss_cta_val_av com os itens e seus respectivos valores

	-- somente para contas que tiveram ao de alterao de valor

	CALL pls_gerencia_envio_ans_pck.gerencia_alt_valor_conta( nr_seq_lote_p, nm_usuario_p, cd_estabelecimento_p);

	-- atualizar os valores totais das contas

	CALL pls_gerencia_envio_ans_pck.atualizar_valores_conta( nr_seq_lote_p, nm_usuario_p);

	--controle final de atualizao onde so excludos os registros de contas que no foram atualizadas

	CALL pls_gerencia_envio_ans_pck.gerencia_controle_upd(	nr_seq_lote_p, 'F', nm_usuario_p);

	--Atualiza informaes materiais no localizados

	CALL pls_gerencia_envio_ans_pck.define_cod_mat_nao_localizados(nr_seq_lote_p);

	--consiste as contas nas tabelas de validao

	CALL pls_gerencia_envio_ans_pck.consistir_envio_ans( nr_seq_lote_p, nm_usuario_p, cd_estabelecimento_p, 'geracao_contas_validacao');

	--Conforme manual de componente organizacional 12/2017 pg 50, em itens A700 os valores de procedimentos e itens assistenciais devem ser preenchidos com zero

	CALL pls_gerencia_envio_ans_pck.atualiza_valores_pre_pagto(	nr_seq_lote_p, nm_usuario_p);
	-- Atualizar os valores totais do lote

	CALL pls_gerencia_envio_ans_pck.atualiza_valores_totais_lote(	nr_seq_lote_p, nm_usuario_p, 'A');
end if;

CALL pls_envio_ans_extra_pck.marcar_estagio_geracao(nr_seq_lote_p, 'F', cd_estabelecimento_p);
commit;

/*exception
when others then
	-- pega o erro

	ds_erro_w := substr(sqlerrm, 0, 4000);

	-- grava o erro que ocorreu

	pls_gerencia_envio_ans_pck.grava_processo(	null, null, nm_usuario_p,
			ds_erro_w, nr_seq_processo_exec_w);

	-- exibe a mensagem do erro para o usurio

	wheb_mensagem_pck.exibir_mensagem_abort(324928, 'ERRO=' || ds_erro_w, -20012);*/

end;

-- se o parametro teve que ser alterado ento volta como tava.

if (vl_param_session_w < 128) then

	-- Trata a exceo, se no der para alterar deixa como est,

	begin
		EXECUTE 'alter session set db_file_multiblock_read_count=' || vl_param_session_w;
	exception
	when others then
		null;
	end;
end if;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerencia_envio_ans_pck.gerencia_validacao_envio_ans ( nr_seq_lote_p pls_monitor_tiss_lote.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) FROM PUBLIC;
