-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


--Procedure utilizada para gerar as contas que sero enviadas para ANS, estas contas sero geradas primeiro para serem ajustadas



CREATE OR REPLACE PROCEDURE pls_gerencia_envio_ans_pck.gerar_contas_envio_ans ( nr_seq_lote_p pls_monitor_tiss_lote.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) AS $body$
DECLARE


nr_seq_processo_w	pls_monitor_tempo_lote.nr_sequencia%type;

BEGIN
nr_seq_processo_w := pls_gerencia_envio_ans_pck.grava_log_tempo_processo(	nr_seq_lote_p, 'Descartando registros de pagamento de contas de rede prpria', 'I', nm_usuario_p, nr_seq_processo_w);
-- Ir descartar os registros que so de pagamento de contas que so de rede prpria

CALL pls_gerencia_envio_ans_pck.descartar_pag_red_propria(nm_usuario_p, cd_estabelecimento_p);
nr_seq_processo_w := pls_gerencia_envio_ans_pck.grava_log_tempo_processo(	null, null, 'F', null, nr_seq_processo_w);

nr_seq_processo_w := pls_gerencia_envio_ans_pck.grava_log_tempo_processo(	nr_seq_lote_p, 'Selecionando contas para o lote', 'I', nm_usuario_p, nr_seq_processo_w);
-- seleciona as contas que sero utilizadas no lote e alimenta as mesmas na tabela pls_monitor_tiss_cta_val

CALL pls_gerencia_envio_ans_pck.selecionar_conta_lote(nr_seq_lote_p, nm_usuario_p, cd_estabelecimento_p);
nr_seq_processo_w := pls_gerencia_envio_ans_pck.grava_log_tempo_processo(	null, null, 'F', null, nr_seq_processo_w);

nr_seq_processo_w := pls_gerencia_envio_ans_pck.grava_log_tempo_processo(	nr_seq_lote_p, 'Populando dados adicionais das contas selecionadas', 'I', nm_usuario_p, nr_seq_processo_w);
-- busca cada conta que foi selecionada e popula os dados adicionais que so necessrios para o envio

CALL pls_gerencia_envio_ans_pck.popula_dados_adic_conta_lote(nr_seq_lote_p, current_setting('pls_gerencia_envio_ans_pck.dt_mes_competencia_ini_w')::pls_monitor_tiss_lote.dt_mes_competencia%type, current_setting('pls_gerencia_envio_ans_pck.dt_mes_competencia_fim_w')::pls_monitor_tiss_lote.dt_mes_competencia%type, nm_usuario_p, cd_estabelecimento_p);
nr_seq_processo_w := pls_gerencia_envio_ans_pck.grava_log_tempo_processo(	null, null, 'F', null, nr_seq_processo_w);

nr_seq_processo_w := pls_gerencia_envio_ans_pck.grava_log_tempo_processo(	nr_seq_lote_p, 'Retirando contas que esto canceladas e nunca foram enviadas', 'I', nm_usuario_p, nr_seq_processo_w);
-- tira fora contas que nunca foram enviadas e esto hoje como canceladas

CALL pls_gerencia_envio_ans_pck.del_conta_cancelada_sem_envio(nr_seq_lote_p);
nr_seq_processo_w := pls_gerencia_envio_ans_pck.grava_log_tempo_processo(	null, null, 'F', null, nr_seq_processo_w);

nr_seq_processo_w := pls_gerencia_envio_ans_pck.grava_log_tempo_processo(	nr_seq_lote_p, 'Retirando contas que esto como alterao e nunca foram enviadas', 'I', nm_usuario_p, nr_seq_processo_w);
-- tira fora contas que esto como alterao de valor e nunca foram enviadas

CALL pls_gerencia_envio_ans_pck.del_conta_alte_sem_envio(nr_seq_lote_p);
nr_seq_processo_w := pls_gerencia_envio_ans_pck.grava_log_tempo_processo(	null, null, 'F', null, nr_seq_processo_w);

nr_seq_processo_w := pls_gerencia_envio_ans_pck.grava_log_tempo_processo(	nr_seq_lote_p, 'Retirando os caracteres especiais dos campos das guias da conta', 'I', nm_usuario_p, nr_seq_processo_w);
-- retira os caracteres especiais e letras dos campos de guias

CALL pls_gerencia_envio_ans_pck.ajustar_codigos_guias_geradas(	nr_seq_lote_p);
nr_seq_processo_w := pls_gerencia_envio_ans_pck.grava_log_tempo_processo(	null, null, 'F', null, nr_seq_processo_w);

nr_seq_processo_w := pls_gerencia_envio_ans_pck.grava_log_tempo_processo(	nr_seq_lote_p, 'Alterando a guia da operadora para contas que estejam em duplicidade', 'I', nm_usuario_p, nr_seq_processo_w);
-- verifica chaves duplicadas comparando o que ser considerado como chave para a ANS e se encontrar algo igual muda a guia

CALL pls_gerencia_envio_ans_pck.atualiza_cta_duplicada(	nr_seq_lote_p, nm_usuario_p);
nr_seq_processo_w := pls_gerencia_envio_ans_pck.grava_log_tempo_processo(	null, null, 'F', null, nr_seq_processo_w);

nr_seq_processo_w := pls_gerencia_envio_ans_pck.grava_log_tempo_processo(	nr_seq_lote_p, 'Alimentando as datas das contas', 'I', nm_usuario_p, nr_seq_processo_w);
-- alimenta as datas das contas na tabela pls_monitor_tiss_cta_val

CALL pls_gerencia_envio_ans_pck.alimenta_data_conta_lote(nr_seq_lote_p, nm_usuario_p);
nr_seq_processo_w := pls_gerencia_envio_ans_pck.grava_log_tempo_processo(	null, null, 'F', null, nr_seq_processo_w);

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerencia_envio_ans_pck.gerar_contas_envio_ans ( nr_seq_lote_p pls_monitor_tiss_lote.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) FROM PUBLIC;
