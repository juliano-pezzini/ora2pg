-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION valores_adep_pck.get_solucao ( nr_seq_cpoe_p cpoe_material.nr_sequencia%type, nr_prescricao_p prescr_medica.nr_prescricao%type, nr_seq_solucao_p prescr_solucao.nr_seq_solucao%type ) RETURNS SETOF T_ITEM AS $body$
DECLARE


c_solucao_w 		t_sol_row;		
qt_dosagem_atual_w  	prescr_solucao.qt_dosagem%type;
ie_tipo_dosagem_w   	prescr_solucao.ie_tipo_dosagem%type;
nr_seq_prim_checagem_w	bigint;
nr_prescricao_auxiliar_w	prescr_medica.nr_prescricao%type;	

 c01 CURSOR FOR
	SELECT
		b.nr_prescricao nr_prescricao_cursor,
		(case when (nr_seq_cpoe_p IS NOT NULL AND nr_seq_cpoe_p::text <> '') then obter_prescricao_solucao_cpoe(nr_seq_cpoe_p) else a.nr_prescricao end) nr_prescricao,
		(case when (nr_seq_cpoe_p IS NOT NULL AND nr_seq_cpoe_p::text <> '') then get_nr_seq_solucao_agrupada(nr_seq_cpoe_p)else a.nr_seq_solucao end) nr_seq_solucao,
		a.ie_acm,
		a.ie_tipo_solucao,
		a.ie_status,
		a.ie_tipo_dosagem ie_tipo_dosagem_original,
		a.qt_dosagem qt_dosagem_original,
		a.ie_via_aplicacao ie_via_aplicacao_origem,
		(case when (nr_seq_cpoe_p IS NOT NULL AND nr_seq_cpoe_p::text <> '') then obter_status_solucao_cpoe(nr_seq_cpoe_p)else SUBSTR(obter_status_solucao_prescr(1, a.nr_prescricao, a.nr_seq_solucao),1,3) end)ie_status_solucao,
		SUBSTR(obter_se_evento_troca_frasco(a.nr_seq_evento),1,1) ie_evento_tf,
		(case when (nr_seq_cpoe_p IS NOT NULL AND nr_seq_cpoe_p::text <> '') and (c.ie_acm = 'S' or c.ie_se_necessario = 'S') then valores_adep_pck.obter_dt_status_sol_agrupada(nr_seq_cpoe_p) else a.dt_status end) dt_status,
		a.qt_solucao_total,
		CASE WHEN coalesce(ie_esquema_alternado,'N')='S' THEN obter_qt_dose_esq_alternado(a.nr_prescricao,a.nr_seq_solucao)  ELSE a.qt_volume_adep END  qt_volume_adep,
		obter_dados_solucao(1, a.nr_prescricao, a.nr_seq_solucao, 'VI') qt_vol_inf_atual,
		a.nr_etapas,
		a.nr_etapas nr_etapas_prescr,
		(obter_etapas_adep_sol(1,a.nr_prescricao,a.nr_seq_solucao) + coalesce(a.nr_etapas_suspensa,0)) nr_etapas_adep,
		(coalesce(a.nr_etapas,0) - (obter_etapas_adep_sol(1,a.nr_prescricao,a.nr_seq_solucao) + coalesce(a.nr_etapas_suspensa,0))) nr_etapas_saldo,
		obter_etapas_adep_sol(1,a.nr_prescricao,a.nr_seq_solucao) nr_etapa_atual,
		obter_etapas_processo_sol(1,a.nr_prescricao,a.nr_seq_solucao) nr_etapas_proc,
		obter_etapas_processo_sol(1,a.nr_prescricao,a.nr_seq_solucao) - (obter_etapas_adep_sol(1,a.nr_prescricao,a.nr_seq_solucao) + coalesce(a.nr_etapas_suspensa,0)) nr_etapas_saldo_proc,
		a.cd_unidade_medida,
		a.ie_tipo_dosagem,
		coalesce(coalesce(obter_dados_solucao(1, a.nr_prescricao, a.nr_seq_solucao, 'VA'),a.qt_dosagem),get_infusion_rate_diff(a.nr_prescricao,a.nr_seq_solucao,CASE WHEN obter_etapas_adep_sol(1,a.nr_prescricao,a.nr_seq_solucao)=0 THEN 1  ELSE obter_etapas_adep_sol(1,a.nr_prescricao,a.nr_seq_solucao) END )) qt_dosagem_atual,
		coalesce(a.ie_esquema_alternado,'N') ie_esquema_alternado,
		obter_volume_parcial_sol(a.nr_prescricao,a.nr_seq_solucao,1) qt_volume_parcial,
		obter_volume_parcial_sol_bi(1,a.nr_prescricao,a.nr_seq_solucao) qt_volume_parcial_bi,
		(case when (nr_seq_cpoe_p IS NOT NULL AND nr_seq_cpoe_p::text <> '') then obter_max_dt_val_prescr_cpoe(nr_seq_cpoe_p, b.nr_atendimento) else obter_data_validade_prescr(a.nr_prescricao) end) dt_validade_prescr,
		(obter_etapas_adep_sol_apraz(1,a.nr_prescricao,a.nr_seq_solucao) + coalesce(a.nr_etapas_suspensa,0)) nr_etapas_adep_ap,
		a.ds_solucao,
		'SOL' ie_tipo_item,
		a.ie_apap,
		a.ie_solucao_pca,
		a.ie_via_aplicacao,
		b.dt_liberacao_farmacia,
		coalesce(a.ie_etapa_especial,'N') ie_etapa_especial,
		coalesce(( 	SELECT COUNT(1)
			FROM 	prescr_mat_hor x,
				prescr_material y
			WHERE 	x.nr_prescricao = y.nr_prescricao
			AND 	x.nr_seq_material = y.nr_sequencia
			AND 	x.nr_prescricao = a.nr_prescricao
			AND 	y.nr_sequencia_solucao = a.nr_seq_solucao
			AND 	x.ie_aprazado = 'S'
			AND 	coalesce(x.dt_suspensao::text, '') = ''
			and 	y.nr_sequencia = ( 	select max(z.nr_sequencia)
							from 	prescr_material z,
								prescr_mat_hor h
							where z.nr_prescricao = a.nr_prescricao
							and coalesce(z.dt_suspensao::text, '') = ''
							and z.ie_agrupador = 4
							and h.nr_prescricao = z.nr_prescricao
							and h.nr_seq_material = z.nr_sequencia
							and h.ie_aprazado = 'S'
							and z.nr_sequencia_solucao = a.nr_seq_solucao
							)
			group by y.nr_prescricao, y.nr_sequencia_solucao
		),0) nr_etapas_apraz,
		coalesce(a.ie_bomba_infusao,'N') ie_bomba_infusao,
		( 	select max(dt_atualizacao)
			from 	prescr_solucao_evento
			where 	nr_prescricao = a.nr_prescricao) ultimo_evento,
				obter_se_prescr_vigente(a.nr_prescricao) vigente,
		c.nr_seq_mat_cpoe
	from 	prescr_solucao a,
		prescr_medica b,
		prescr_material c
	where 	b.nr_prescricao = a.nr_prescricao
	and 	c.nr_sequencia_solucao = a.nr_seq_solucao
	and 	c.nr_prescricao = a.nr_prescricao
	and (a.nr_prescricao = nr_prescricao_p	and a.nr_seq_solucao = nr_seq_solucao_p and coalesce(nr_seq_cpoe_p::text, '') = '')

union all

    SELECT
		b.nr_prescricao nr_prescricao_cursor,
		(case when (nr_seq_cpoe_p IS NOT NULL AND nr_seq_cpoe_p::text <> '') then obter_prescricao_solucao_cpoe(nr_seq_cpoe_p) else a.nr_prescricao end) nr_prescricao,
		(case when (nr_seq_cpoe_p IS NOT NULL AND nr_seq_cpoe_p::text <> '') then get_nr_seq_solucao_agrupada(nr_seq_cpoe_p)else a.nr_seq_solucao end) nr_seq_solucao,
		a.ie_acm,
		a.ie_tipo_solucao,
		a.ie_status,
		a.ie_tipo_dosagem ie_tipo_dosagem_original,
		a.qt_dosagem qt_dosagem_original,
		a.ie_via_aplicacao ie_via_aplicacao_origem,
		(case when (nr_seq_cpoe_p IS NOT NULL AND nr_seq_cpoe_p::text <> '') then obter_status_solucao_cpoe(nr_seq_cpoe_p)else SUBSTR(obter_status_solucao_prescr(1, a.nr_prescricao, a.nr_seq_solucao),1,3) end)ie_status_solucao,
		SUBSTR(obter_se_evento_troca_frasco(a.nr_seq_evento),1,1) ie_evento_tf,
		(case when (nr_seq_cpoe_p IS NOT NULL AND nr_seq_cpoe_p::text <> '') and (c.ie_acm = 'S' or c.ie_se_necessario = 'S') then valores_adep_pck.obter_dt_status_sol_agrupada(nr_seq_cpoe_p) else a.dt_status end) dt_status,
		a.qt_solucao_total,
		CASE WHEN coalesce(ie_esquema_alternado,'N')='S' THEN obter_qt_dose_esq_alternado(a.nr_prescricao,a.nr_seq_solucao)  ELSE a.qt_volume_adep END  qt_volume_adep,
		obter_dados_solucao(1, a.nr_prescricao, a.nr_seq_solucao, 'VI') qt_vol_inf_atual,
		a.nr_etapas,
		a.nr_etapas nr_etapas_prescr,
		(obter_etapas_adep_sol(1,a.nr_prescricao,a.nr_seq_solucao) + coalesce(a.nr_etapas_suspensa,0)) nr_etapas_adep,
		(coalesce(a.nr_etapas,0) - (obter_etapas_adep_sol(1,a.nr_prescricao,a.nr_seq_solucao) + coalesce(a.nr_etapas_suspensa,0))) nr_etapas_saldo,
		obter_etapas_adep_sol(1,a.nr_prescricao,a.nr_seq_solucao) nr_etapa_atual,
		obter_etapas_processo_sol(1,a.nr_prescricao,a.nr_seq_solucao) nr_etapas_proc,
		obter_etapas_processo_sol(1,a.nr_prescricao,a.nr_seq_solucao) - (obter_etapas_adep_sol(1,a.nr_prescricao,a.nr_seq_solucao) + coalesce(a.nr_etapas_suspensa,0)) nr_etapas_saldo_proc,
		a.cd_unidade_medida,
		a.ie_tipo_dosagem,
		coalesce(coalesce(obter_dados_solucao(1, a.nr_prescricao, a.nr_seq_solucao, 'VA'),a.qt_dosagem),get_infusion_rate_diff(a.nr_prescricao,a.nr_seq_solucao,CASE WHEN obter_etapas_adep_sol(1,a.nr_prescricao,a.nr_seq_solucao)=0 THEN 1  ELSE obter_etapas_adep_sol(1,a.nr_prescricao,a.nr_seq_solucao) END )) qt_dosagem_atual,
		coalesce(a.ie_esquema_alternado,'N') ie_esquema_alternado,
		obter_volume_parcial_sol(a.nr_prescricao,a.nr_seq_solucao,1) qt_volume_parcial,
		obter_volume_parcial_sol_bi(1,a.nr_prescricao,a.nr_seq_solucao) qt_volume_parcial_bi,
		(case when (nr_seq_cpoe_p IS NOT NULL AND nr_seq_cpoe_p::text <> '') then obter_max_dt_val_prescr_cpoe(nr_seq_cpoe_p, b.nr_atendimento) else obter_data_validade_prescr(a.nr_prescricao) end) dt_validade_prescr,
		(obter_etapas_adep_sol_apraz(1,a.nr_prescricao,a.nr_seq_solucao) + coalesce(a.nr_etapas_suspensa,0)) nr_etapas_adep_ap,
		a.ds_solucao,
		'SOL' ie_tipo_item,
		a.ie_apap,
		a.ie_solucao_pca,
		a.ie_via_aplicacao,
		b.dt_liberacao_farmacia,
		coalesce(a.ie_etapa_especial,'N') ie_etapa_especial,
		coalesce((SELECT	count(1)
			FROM	prescr_mat_hor x,
					prescr_material y
			WHERE   y.nr_seq_mat_cpoe = c.nr_seq_mat_cpoe
			AND		x.nr_prescricao = y.nr_prescricao
			AND 	x.nr_seq_material = y.nr_sequencia
			AND 	x.ie_aprazado = 'S'
			AND 	coalesce(x.dt_suspensao::text, '') = ''
			AND   	coalesce(x.ie_horario_especial, 'N') <> 'S'
			AND 	y.cd_material = obter_medic_principal_sol(y.nr_prescricao,y.nr_sequencia_solucao)
		),0) nr_etapas_apraz,
		coalesce(a.ie_bomba_infusao,'N') ie_bomba_infusao,
		( 	select max(dt_atualizacao)
			from 	prescr_solucao_evento
			where 	nr_prescricao = a.nr_prescricao) ultimo_evento,
				obter_se_prescr_vigente(a.nr_prescricao) vigente,
		c.nr_seq_mat_cpoe
	from 	prescr_solucao a,
		prescr_medica b,
		prescr_material c
	where 	b.nr_prescricao = a.nr_prescricao
	and 	c.nr_sequencia_solucao = a.nr_seq_solucao
	and 	c.nr_prescricao = a.nr_prescricao
	and 	(c.nr_seq_mat_cpoe = nr_seq_cpoe_p AND nr_seq_cpoe_p IS NOT NULL AND nr_seq_cpoe_p::text <> '');

	
BEGIN

	for c01_r in c01
	loop
	if (coalesce(nr_prescricao_auxiliar_w, 0) <> c01_r.nr_prescricao_cursor) then

		if (nr_seq_cpoe_p IS NOT NULL AND nr_seq_cpoe_p::text <> '') then
		
			ie_tipo_dosagem_w   :=  valores_adep_pck.obter_val_sol_agrupada('ie_tipo_dosagem', '5, 3', nr_seq_cpoe_p);
			qt_dosagem_atual_w  :=  valores_adep_pck.obter_val_sol_agrupada('qt_dosagem', '5, 3', nr_seq_cpoe_p);
		
		end if;
		
		if (c01_r.nr_seq_mat_cpoe IS NOT NULL AND c01_r.nr_seq_mat_cpoe::text <> '') then
		
			select	max(qt_dose_terapeutica),
				max(cd_unid_medic_terap),
				max(si_rapid_infusion),
				max(nr_seq_access),
				max(nr_seq_dispositivo)
			into STRICT	c_solucao_w.qt_dose_terapeutica,
				c_solucao_w.cd_unid_medic_terap,
				c_solucao_w.si_rapid_infusion,
				c_solucao_w.nr_seq_access,
				c_solucao_w.nr_seq_dispositivo
			from	cpoe_material
			where	nr_sequencia = c01_r.nr_seq_mat_cpoe;
			
		end if;
		
		c_solucao_w.ie_tipo_infusao	:=	obter_se_veloc_variavel(c01_r.nr_prescricao, c01_r.nr_seq_solucao);

        ie_tipo_dosagem_w   :=  coalesce(ie_tipo_dosagem_w, c01_r.ie_tipo_dosagem);
        qt_dosagem_atual_w  :=  coalesce(qt_dosagem_atual_w, c01_r.qt_dosagem_atual);

		c_solucao_w.nr_prescricao		:= c01_r.nr_prescricao;
		c_solucao_w.nr_seq_solucao		:= c01_r.nr_seq_solucao;
		c_solucao_w.ie_acm			:= c01_r.ie_acm;
		c_solucao_w.ie_tipo_solucao		:= c01_r.ie_tipo_solucao;
		c_solucao_w.ie_status			:= c01_r.ie_status;
		c_solucao_w.ie_tipo_dosagem_original	:= c01_r.ie_tipo_dosagem_original;
		c_solucao_w.qt_dosagem_original		:= c01_r.qt_dosagem_original;
		c_solucao_w.ie_via_aplicacao_origem	:= c01_r.ie_via_aplicacao_origem;
		c_solucao_w.ie_status_solucao		:= c01_r.ie_status_solucao;
		c_solucao_w.ie_evento_tf		:= c01_r.ie_evento_tf;
		c_solucao_w.dt_status			:= c01_r.dt_status;
		c_solucao_w.qt_solucao_total		:= c01_r.qt_solucao_total;
		c_solucao_w.qt_volume_adep		:= c01_r.qt_volume_adep;
		c_solucao_w.qt_vol_inf_atual		:= c01_r.qt_vol_inf_atual;
		c_solucao_w.nr_etapas			:= c01_r.nr_etapas;
		c_solucao_w.nr_etapas_prescr		:= c01_r.nr_etapas_prescr;
		c_solucao_w.nr_etapas_adep		:= c01_r.nr_etapas_adep;
		c_solucao_w.nr_etapas_saldo		:= c01_r.nr_etapas_saldo;
		c_solucao_w.nr_etapa_atual		:= c01_r.nr_etapa_atual;
		c_solucao_w.nr_etapas_proc		:= c01_r.nr_etapas_proc;
		c_solucao_w.nr_etapas_saldo_proc	:= c01_r.nr_etapas_saldo_proc;
		c_solucao_w.cd_unidade_medida		:= c01_r.cd_unidade_medida;
		c_solucao_w.ie_tipo_dosagem		:= ie_tipo_dosagem_w;
		c_solucao_w.qt_dosagem_atual		:= qt_dosagem_atual_w;
		c_solucao_w.ie_esquema_alternado	:= c01_r.ie_esquema_alternado;
		c_solucao_w.qt_volume_parcial		:= c01_r.qt_volume_parcial;
		c_solucao_w.qt_volume_parcial_bi	:= c01_r.qt_volume_parcial_bi;
		c_solucao_w.dt_validade_prescr		:= c01_r.dt_validade_prescr;
		c_solucao_w.nr_etapas_adep_ap		:= c01_r.nr_etapas_adep_ap;
		c_solucao_w.ds_solucao			:= c01_r.ds_solucao;
		c_solucao_w.ie_tipo_item		:= c01_r.ie_tipo_item;
		c_solucao_w.ie_apap			:= c01_r.ie_apap;
		c_solucao_w.ie_solucao_pca		:= c01_r.ie_solucao_pca;
		c_solucao_w.ie_via_aplicacao		:= c01_r.ie_via_aplicacao;
		c_solucao_w.dt_liberacao_farmacia	:= c01_r.dt_liberacao_farmacia;
		c_solucao_w.ie_etapa_especial		:= c01_r.ie_etapa_especial;
		c_solucao_w.nr_etapas_apraz		:= c01_r.nr_etapas_apraz;
		c_solucao_w.ie_bomba_infusao		:= c01_r.ie_bomba_infusao;
		c_solucao_w.ultimo_evento		:= c01_r.ultimo_evento;
		c_solucao_w.vigente			:= c01_r.vigente;
		c_solucao_w.ie_permite_aprazar_pca	:=	valores_adep_pck.obter_se_permite_aprazar_pca(c01_r.nr_prescricao, c01_r.nr_seq_solucao);
		
		select	max(a.nr_sequencia)
		into STRICT	nr_seq_prim_checagem_w
		from	prescr_solucao_evento a
		where	a.nr_prescricao		= c01_r.nr_prescricao
		and	a.nr_seq_solucao	= c01_r.nr_seq_solucao
		and	coalesce(a.ie_evento_valido,'S') 	= 'S'
		and	a.ie_alteracao	= 37
		and	a.nr_sequencia	= (	SELECT	max(x.nr_sequencia)
						from	prescr_solucao_evento x
						where	x.nr_prescricao 	= a.nr_prescricao
						and	x.nr_seq_solucao	= a.nr_seq_solucao
						and	coalesce(x.ie_evento_valido,'S') 	= 'S'
					   );	
		
		if (nr_seq_prim_checagem_w IS NOT NULL AND nr_seq_prim_checagem_w::text <> '') then
			select	max(a.ds_observacao),
				max(a.qt_dosagem)
			into STRICT	c_solucao_w.ds_observacao_prim_check,
				c_solucao_w.qt_dosagem_prim_check
			from	prescr_solucao_evento a
			where	a.nr_sequencia = nr_seq_prim_checagem_w;
		end if;
		
		
		RETURN NEXT c_solucao_w;
		nr_prescricao_auxiliar_w := c01_r.nr_prescricao_cursor;

	end if;
	end loop;
return;
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION valores_adep_pck.get_solucao ( nr_seq_cpoe_p cpoe_material.nr_sequencia%type, nr_prescricao_p prescr_medica.nr_prescricao%type, nr_seq_solucao_p prescr_solucao.nr_seq_solucao%type ) FROM PUBLIC;
