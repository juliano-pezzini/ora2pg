-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pix_pck.crc16 (ds_string text) RETURNS varchar AS $body$
WITH RECURSIVE cte AS (
DECLARE

    c_bytes CURSOR(pix_string text) FOR
        SELECT trim(both regexp_substr(substr(dump(pix_string), position(':' in dump(pix_string)) + 1), '[^,]+', 1, level)) as bytes

        level <= length(substr(dump(pix_string), 
                     position(':' in dump(pix_string)) + 1)) - length(replace(substr(dump(pix_string), position(':' in dump(pix_string)) + 1), ',', '')) + 1  UNION ALL
DECLARE

    c_bytes CURSOR(pix_string text) FOR
        SELECT trim(both regexp_substr(substr(dump(pix_string), position(':' in dump(pix_string)) + 1), '[^,]+', 1, level)) as bytes
         
        level <= length(substr(dump(pix_string), 
                     position(':' in dump(pix_string)) + 1)) - length(replace(substr(dump(pix_string), position(':' in dump(pix_string)) + 1), ',', '')) + 1 JOIN cte c ON ()

) SELECT * FROM cte;
;

    c bigint;
    j bigint;

    v_answer varchar(4000) := 'FFFF';
    v_polinomio varchar(4) := '1021';

    v_verify bigint;

    v_id_crc16 char(2) := '63';
    v_qtd_crc16 char(2) := '04';

    
BEGIN
        for r_bytes in c_bytes(ds_string||v_id_crc16||v_qtd_crc16)
        loop
          c := r_bytes.bytes;

          if (c_bytes%rowcount = 1) then
            v_answer := to_number(v_answer, 'XXXX');
          end if;

          j := (c * power(2,8));
          v_answer := (j + v_answer) - bitand(j, v_answer) * 2;

          for bitwise in 0..7 loop
            v_answer := v_answer * power(2,1);
            v_verify := bitand(v_answer, to_number('10000', 'XXXXX'));

            if (v_verify <> 0) then
              v_answer := (v_answer + to_number(v_polinomio, 'XXXX')) - bitand(v_answer, to_number(v_polinomio, 'XXXX')) * 2;
            end if;

            v_answer := bitand(v_answer,  to_number('FFFF', 'XXXX'));
          end loop;
        end loop;

        return v_id_crc16||v_qtd_crc16||trim(both to_char(v_answer, 'XXXX'));

    END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pix_pck.crc16 (ds_string text) FROM PUBLIC;
