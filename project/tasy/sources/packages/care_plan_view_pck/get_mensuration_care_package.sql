-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION care_plan_view_pck.get_mensuration_care (nr_seq_prescr_p bigint) RETURNS SETOF T_MENSURATION_CARE_DATA AS $body$
DECLARE


current_setting('care_plan_view_pck.nr_seq_pat_care_plan_w')::patient_care_plan.nr_sequencia%type  patient_care_plan.nr_sequencia%type;
nr_seq_problem_plan_w   patient_cp_problem.nr_sequencia%type;
nr_seq_goal_plan_w      patient_cp_goal.nr_sequencia%type;
row_w                 t_mensuration_care_row;
count_indicator_w       bigint := 0;
nr_seq_prescr_diag_w    pe_prescr_diag.nr_sequencia%type;

current_setting('care_plan_view_pck.ds_espaco_w')::varchar(255)             varchar(255) := chr(38)||'nbsp;'||chr(38)||'nbsp;'||chr(38)||'nbsp;';
ie_nivel_w            bigint;
dt_prescricao_w       timestamp;

        c_params CURSOR FOR
            SELECT  obter_param_funcao_html5(281, 1614) param1614
;

c_care_plan CURSOR FOR
  SELECT  a.nr_sequencia nr_sequencia,
  (SELECT dt_prescricao from pe_prescricao where nr_sequencia = nr_seq_prescr_p) dt_prescricao
    from    care_plan b,
      patient_care_plan a
  where   a.nr_seq_care_plan = b.nr_sequencia
    and     a.nr_seq_prescr = nr_seq_prescr_p;

c_problem_data CURSOR FOR
  SELECT  /*dados do problema*/

      b.nr_sequencia,
      b.nr_seq_cp_problem,
      b.dt_end dt_end, /*data fim do problema*/

      coalesce(c.ds_alternative,c.ds_display_name) ds_indicator
  from    patient_cp_indicator a,
      patient_cp_problem b,
      cp_problem c,
      patient_cp_goal e,
      cp_goal f,
      pe_prescr_indicator g
  where   b.nr_seq_cp_problem = c.nr_sequencia
  and     f.nr_sequencia = e.nr_seq_cp_goal
  and     b.nr_sequencia = e.nr_seq_pat_cp_problem
  and     b.nr_seq_pat_care_plan = current_setting('care_plan_view_pck.nr_seq_pat_care_plan_w')::patient_care_plan.nr_sequencia%type
  and     a.nr_seq_pat_cp_goal = e.nr_sequencia
  and   a.nr_sequencia = g.nr_seq_pat_cp_indicator
  group by  b.nr_sequencia,
        b.nr_seq_cp_problem,
        b.dt_end, /*data fim do problema*/

        coalesce(c.ds_alternative,c.ds_display_name);

c_goals_data CURSOR FOR
  SELECT   /*Dados dos Indicadores*/

      b.nr_sequencia,
      b.nr_seq_cp_goal,
      b.dt_end, /*Data fim da meta*/

      coalesce(c.ds_alternative,c.ds_display_name) ie_meta
  from    patient_cp_goal b,
      cp_goal c,
      patient_cp_indicator a,
      pe_prescr_indicator d
  where   c.nr_sequencia = b.nr_seq_cp_goal
  and   a.nr_seq_pat_cp_goal = b.nr_sequencia
  and   a.nr_sequencia = d.nr_seq_pat_cp_indicator
  and     b.nr_seq_pat_cp_problem = nr_seq_problem_plan_w
  group by  b.nr_sequencia,
        b.nr_seq_cp_goal,
        b.dt_end, /*Data fim da meta*/

        coalesce(c.ds_alternative,c.ds_display_name),
        c.NR_SEQ_ORDER
  order by coalesce(c.NR_SEQ_ORDER,9999);

c_indicators_data CURSOR FOR
  SELECT  a.nr_sequencia nr_sequencia,
      b.nr_sequencia nr_seq_pat_cp_ind,
      c.nr_sequencia nr_seq_cp_indicator,
      b.dt_end, /*Data fim do indicador*/

      coalesce(c.ds_alternative,c.ds_display_name) ds_indicator
  from    pe_prescr_indicator a,
      patient_cp_indicator b,
      cp_indicator c
  where   b.nr_sequencia = a.nr_seq_pat_cp_indicator
  and     b.nr_seq_cp_indicator = c.nr_sequencia
  and     b.nr_seq_pat_cp_goal = nr_seq_goal_plan_w;

        c_prescr_diag_data CURSOR FOR
            SELECT      distinct
                        ppd.nr_sequencia,
                        ppd.dt_end dt_end,
                        pd.ds_diagnostico ds_indicator,
                        ppd.nr_seq_diag,
                        ppd.dt_cancelamento,
                        ppd.nr_seq_prescr,
                        pp.dt_liberacao,
                        ppd.IE_FREE_ITEM
            from        pe_prescr_diag ppd
                        left join   pe_prescricao pp            on (pp.nr_sequencia = ppd.nr_seq_prescr)
                        left join   pe_prescr_indicator ppi     on (ppi.nr_seq_prescr = ppd.nr_seq_prescr)
                        left join   patient_cp_indicator pci    on (pci.nr_sequencia = ppi.nr_seq_pat_cp_indicator)
                        left join   patient_cp_goal pcg         on (pcg.nr_sequencia = pci.nr_seq_pat_cp_goal)
                        left join   cp_goal cg                  on (cg.nr_sequencia = pcg.nr_seq_cp_goal)
                        inner join  pe_diagnostico pd           on (pd.nr_sequencia = ppd.nr_seq_diag)
                        left join   pe_prescr_problem ppp       ON (ppp.nr_seq_prescr = ppd.nr_seq_prescr)
            where       coalesce(ppd.dt_cancelamento::text, '') = ''
            and         ppd.nr_seq_prescr = nr_seq_prescr_p;

        c_prescr_goals_data CURSOR FOR
            SELECT      distinct
                        pcg.nr_sequencia,
                        pcg.nr_seq_cp_goal,
                        pcg.dt_end,
                        pcg.ie_free_item,
                        coalesce(cg.ds_alternative, cg.ds_display_name) ie_meta
            from        pe_prescr_indicator ppi,
                        patient_cp_indicator pci,
                        patient_cp_goal pcg,
                        cp_goal cg
            where       pci.nr_sequencia = ppi.nr_seq_pat_cp_indicator
            and         pcg.nr_sequencia = pci.nr_seq_pat_cp_goal
            and         cg.nr_sequencia = pcg.nr_seq_cp_goal
            and         ppi.nr_seq_prescr = nr_seq_prescr_p
            and         pcg.nr_seq_prescr_diag = nr_seq_prescr_diag_w;

        c_prescr_indicators_data CURSOR FOR
            SELECT  ppi.nr_sequencia nr_sequencia,
                    pci.nr_sequencia nr_seq_pat_cp_ind,
                    ci.nr_sequencia nr_seq_cp_indicator,
                    pci.dt_end, /*Data fim do indicador*/

                    coalesce(ci.ds_alternative, ci.ds_display_name) ds_indicator,
                    pci.ie_free_item
            from    pe_prescr_indicator ppi,
                    patient_cp_indicator pci,
                    cp_indicator ci
            where   pci.nr_sequencia = ppi.nr_seq_pat_cp_indicator
            and     ci.nr_sequencia = pci.nr_seq_cp_indicator
            and     ppi.nr_seq_prescr = nr_seq_prescr_p
            and     pci.nr_seq_pat_cp_goal = current_setting('care_plan_view_pck.nr_seq_pat_cp_goal_w')::patient_cp_goal.nr_sequencia%type;


BEGIN

  ie_nivel_w := 0;

            for r_c_params in c_params loop
                    PERFORM set_config('care_plan_view_pck.param1614_w', r_c_params.param1614, false);
            end loop;
            if (current_setting('care_plan_view_pck.param1614_w')::varchar(1) <> 'N' and (wheb_usuario_pck.get_nm_usuario IS NOT NULL AND wheb_usuario_pck.get_nm_usuario::text <> '') ) then

  for r_c_care_plan in c_care_plan loop
    PERFORM set_config('care_plan_view_pck.nr_seq_pat_care_plan_w', r_c_care_plan.nr_sequencia, false);

    ie_nivel_w := ie_nivel_w + 1;

    for r_c_problem_data in c_problem_data loop
      nr_seq_problem_plan_w   := r_c_problem_data.nr_sequencia;

      row_w.ds_display_name       := '<strong>' || r_c_problem_data.ds_indicator || '</strong>';
      row_w.dt_end            := r_c_problem_data.dt_end;
      row_w.ie_nivel            := ie_nivel_w;
      row_w.nr_seq_pat_care_plan  := current_setting('care_plan_view_pck.nr_seq_pat_care_plan_w')::patient_care_plan.nr_sequencia%type;
      row_w.nr_seq_cp_problem   := r_c_problem_data.nr_seq_cp_problem;
      row_w.dt_prescricao         := dt_prescricao_w;
      row_w.ie_indicador        := 'N';
      row_w.seq_indicator := null;
      row_w.ie_meta           := 'N';

      RETURN NEXT row_w;
      ie_nivel_w  := ie_nivel_w + 1;

      for r_c_goals_data in c_goals_data loop
        nr_seq_goal_plan_w  := r_c_goals_data.nr_sequencia;

        row_w.ds_display_name       := current_setting('care_plan_view_pck.ds_espaco_w')::varchar(255) || current_setting('care_plan_view_pck.ds_espaco_w')::varchar(255) || '<strong>' || r_c_goals_data.ie_meta || '</strong>';
        row_w.dt_end            := r_c_goals_data.dt_end;
        row_w.ie_nivel            := ie_nivel_w;
        row_w.nr_seq_goal         := nr_seq_goal_plan_w;
        row_w.nr_seq_pat_care_plan  := current_setting('care_plan_view_pck.nr_seq_pat_care_plan_w')::patient_care_plan.nr_sequencia%type;
        row_w.nr_seq_cp_problem   := r_c_problem_data.nr_seq_cp_problem;
        row_w.dt_prescricao         := dt_prescricao_w;
        row_w.ie_indicador        := 'N';
        row_w.seq_indicator := null;
        row_w.ie_meta           := 'S';

        RETURN NEXT row_w;
        ie_nivel_w := ie_nivel_w + 1;

        for r_c_indicators_data in c_indicators_data loop

          row_w.ds_display_name       := current_setting('care_plan_view_pck.ds_espaco_w')::varchar(255) || current_setting('care_plan_view_pck.ds_espaco_w')::varchar(255) || current_setting('care_plan_view_pck.ds_espaco_w')::varchar(255) ||  current_setting('care_plan_view_pck.ds_espaco_w')::varchar(255) || r_c_indicators_data.ds_indicator;
          row_w.dt_end            := r_c_indicators_data.dt_end;
          row_w.ie_nivel            := ie_nivel_w;
          row_w.nr_seq_cp_indicator   := r_c_indicators_data.nr_seq_cp_indicator;
          row_w.nr_seq_pat_cp_ind     := r_c_indicators_data.nr_seq_pat_cp_ind;
          row_w.nr_seq_pat_care_plan  := current_setting('care_plan_view_pck.nr_seq_pat_care_plan_w')::patient_care_plan.nr_sequencia%type;
          row_w.nr_seq_cp_problem   := r_c_problem_data.nr_seq_cp_problem;
          row_w.dt_prescricao         := dt_prescricao_w;
          row_w.ie_indicador        := 'S';
          count_indicator_w :=  count_indicator_w + 1;
          row_w.seq_indicator := count_indicator_w;
          row_w.ie_meta           := 'N';

          RETURN NEXT row_w;
          ie_nivel_w := ie_nivel_w + 1;

        end loop;
      end loop;
    end loop;
  end loop;
            else
                for r_c_prescr_diag_data in c_prescr_diag_data loop
                    nr_seq_prescr_diag_w := r_c_prescr_diag_data.nr_sequencia;
                    row_w.ds_display_name       := '<strong>' || r_c_prescr_diag_data.ds_indicator || '</strong>';
                    row_w.dt_end                := r_c_prescr_diag_data.dt_end;
                    row_w.nr_seq_diag           := r_c_prescr_diag_data.nr_seq_diag;
                    row_w.nr_seq_prescr_diag    := r_c_prescr_diag_data.nr_sequencia;
                    row_w.ie_nivel              := ie_nivel_w;
                    row_w.dt_prescricao         := dt_prescricao_w;
                    row_w.dt_cancelamento       := r_c_prescr_diag_data.dt_cancelamento;
                    row_w.ie_indicador          := 'N';
                    row_w.seq_indicator         := null;
                    row_w.ie_meta               := 'N';
                    row_w.dt_lib_presc          := r_c_prescr_diag_data.dt_liberacao;
                    row_w.nr_seq_prescr         := r_c_prescr_diag_data.nr_seq_prescr;
                    row_w.ie_free_item          := r_c_prescr_diag_data.IE_FREE_ITEM;

                    RETURN NEXT row_w;
                    ie_nivel_w  := ie_nivel_w + 1;
                    for r_c_prescr_goals_data in c_prescr_goals_data loop
                        nr_seq_goal_plan_w          := r_c_prescr_goals_data.nr_seq_cp_goal;
                        PERFORM set_config('care_plan_view_pck.nr_seq_pat_cp_goal_w', r_c_prescr_goals_data.nr_sequencia, false);

                        row_w.ds_display_name       := current_setting('care_plan_view_pck.ds_espaco_w')::varchar(255) || current_setting('care_plan_view_pck.ds_espaco_w')::varchar(255) || '<strong>' || r_c_prescr_goals_data.ie_meta || '</strong>';
                        row_w.dt_end                := r_c_prescr_goals_data.dt_end;
                        row_w.ie_nivel              := ie_nivel_w;
                        row_w.nr_seq_goal           := current_setting('care_plan_view_pck.nr_seq_pat_cp_goal_w')::patient_cp_goal.nr_sequencia%type;
                        row_w.dt_prescricao         := dt_prescricao_w;
                        row_w.ie_indicador          := 'N';
                        row_w.seq_indicator := null;
                        row_w.ie_meta               := 'S';
                        row_w.nr_seq_pat_cp_goal    := current_setting('care_plan_view_pck.nr_seq_pat_cp_goal_w')::patient_cp_goal.nr_sequencia%type;
                        row_w.ie_free_item          := r_c_prescr_goals_data.ie_free_item;
                        RETURN NEXT row_w;
                        ie_nivel_w := ie_nivel_w + 1;
                        for r_c_prescr_indicators_data in c_prescr_indicators_data loop
                            row_w.ds_display_name       := current_setting('care_plan_view_pck.ds_espaco_w')::varchar(255) || current_setting('care_plan_view_pck.ds_espaco_w')::varchar(255) || current_setting('care_plan_view_pck.ds_espaco_w')::varchar(255) ||  current_setting('care_plan_view_pck.ds_espaco_w')::varchar(255) || r_c_prescr_indicators_data.ds_indicator;
                            row_w.dt_end                := r_c_prescr_indicators_data.dt_end;
                            row_w.ie_nivel              := ie_nivel_w;
                            row_w.nr_seq_cp_indicator   := r_c_prescr_indicators_data.nr_seq_cp_indicator;
                            row_w.nr_seq_pat_cp_ind     := r_c_prescr_indicators_data.nr_seq_pat_cp_ind;
                            row_w.dt_prescricao         := dt_prescricao_w;
                            row_w.ie_indicador          := 'S';
                            count_indicator_w :=  count_indicator_w + 1;
                            row_w.seq_indicator := count_indicator_w;
                            row_w.ie_meta               := 'N';
                            row_w.ie_free_item          := r_c_prescr_indicators_data.ie_free_item;
                            RETURN NEXT row_w;
                            ie_nivel_w := ie_nivel_w + 1;
                        end loop;
                    end loop;
                end loop;
            end if;

  return;
  END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION care_plan_view_pck.get_mensuration_care (nr_seq_prescr_p bigint) FROM PUBLIC;
