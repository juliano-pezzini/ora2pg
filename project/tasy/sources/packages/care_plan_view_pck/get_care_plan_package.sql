-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



  /*niveis*/


  
  /*seq niveis*/


  
  /*seq f niveis*/


  


CREATE OR REPLACE FUNCTION care_plan_view_pck.get_care_plan (nr_seq_prescr_p bigint) RETURNS SETOF T_CARE_PLAN_DATA AS $body$
DECLARE


    c_care_plan CURSOR FOR
    SELECT  a.*,
            coalesce(b.ds_alternative,b.ds_display_name) ds_display_name
    from    care_plan b,
            patient_care_plan a
    where   a.nr_seq_care_plan = b.nr_sequencia
    and     a.nr_seq_prescr = nr_seq_prescr_p;

    c_problem CURSOR FOR
    SELECT a.*,
           coalesce(b.ds_alternative,b.ds_display_name) ds_display_name
    from   cp_problem b,
           patient_cp_problem a
    where  a.nr_seq_cp_problem = b.nr_sequencia
    and    a.nr_seq_pat_care_plan = current_setting('care_plan_view_pck.nr_seq_pat_care_plan_w')::patient_care_plan.nr_sequencia%type;

    c_goal CURSOR FOR
    SELECT a.*,
           coalesce(c.ds_alternative,c.ds_display_name) ds_display_name
    from   cp_goal c,
           PATIENT_CP_GOAL a
    where  a.nr_seq_cp_goal = c.nr_sequencia
    and    a.nr_seq_pat_cp_problem = current_setting('care_plan_view_pck.nr_seq_pat_cp_problem_w')::patient_cp_problem.nr_sequencia%type;

    c_indicator CURSOR FOR
    SELECT a.*,
           coalesce(b.ds_alternative,b.ds_display_name) ds_display_name
    from   cp_indicator b,
           patient_cp_indicator a
    where  a.nr_seq_cp_indicator = b.nr_sequencia
    and    a.nr_seq_pat_cp_goal = current_setting('care_plan_view_pck.nr_seq_pat_cp_goal_w')::patient_cp_goal.nr_sequencia%type;

    c_interv_plan CURSOR FOR
    SELECT a.*,
           coalesce(b.ds_alternative,b.ds_display_name) ds_display_name
    from   PATIENT_CP_INTERV_PLAN a, 
           cp_interv_plan b
    where  a.nr_seq_interv_plan = b.nr_sequencia
    and    a.nr_seq_pat_care_plan = current_setting('care_plan_view_pck.nr_seq_pat_care_plan_w')::patient_care_plan.nr_sequencia%type
    and    a.nr_seq_pat_cp_problem = current_setting('care_plan_view_pck.nr_seq_pat_cp_problem_w')::patient_cp_problem.nr_sequencia%type;

    c_intervention CURSOR FOR
    SELECT a.nr_sequencia,
            a.si_selected,
            a.dt_start,
            a.dt_end,
           coalesce(e.ds_display_name, coalesce(d.ds_alternative,d.ds_display_name)) ds_display_name
    from   patient_cp_intervention a,
           cp_intervention  d,
           pe_prescr_proc e
    where  a.nr_seq_cp_intervention = d.nr_sequencia
    and    d.nr_seq_pe_procedimento = e.nr_seq_proc
    and    e.nr_seq_prescr = nr_seq_prescr_p
    and    a.nr_seq_pat_cp_interv_plan = current_setting('care_plan_view_pck.nr_seq_pat_cp_interv_plan_w')::patient_cp_interv_plan.nr_sequencia%type;

   /*plano educacional*/

    c_educ_goal CURSOR FOR
    SELECT a.*, 
           coalesce(c.ds_alternative,c.ds_display_name) ds_display_name
    from   cp_goal c,
           PATIENT_CP_GOAL a
    where  a.nr_seq_cp_goal = c.nr_sequencia
    and    a.nr_seq_pat_care_plan = current_setting('care_plan_view_pck.nr_seq_pat_care_plan_w')::patient_care_plan.nr_sequencia%type
  and    coalesce(a.nr_seq_pat_cp_problem::text, '') = ''
  and    c.ie_type_goal = 'E';

/*    cursor c_educ_indicator is
    select a.*,
           b.ds_display_name
    from   cp_indicator b,
           patient_cp_indicator a
    where  a.nr_seq_cp_indicator = b.nr_sequencia
    and    a.nr_seq_pat_cp_goal = nr_seq_pat_cp_educ_goal_w;*/


        c_ds_display CURSOR FOR
            SELECT  distinct(obter_desc_intervencoes(nr_seq_proc)) intervention_name ,ds_display_name
            from    pe_prescr_proc  
            where   nr_seq_prescr = nr_seq_prescr_p;

    /*ds_valor_w pessoa_endereco_item.ds_valor%type;*/


    row_w      t_care_plan_row;


BEGIN
  /* Main table PATIENT_CARE_PLAN*/


  for r_c_care_plan in c_care_plan loop
    PERFORM set_config('care_plan_view_pck.nr_seq_pat_care_plan_w', r_c_care_plan.nr_sequencia, false);

    PERFORM set_config('care_plan_view_pck.cd_seq_nvl', current_setting('care_plan_view_pck.cd_seq_nvl')::integer + 1, false);

    row_w.nr_seq_item     := r_c_care_plan.nr_sequencia;
    row_w.si_selected     := r_c_care_plan.si_selected;
    row_w.ds_item         := current_setting('care_plan_view_pck.ds_espaco_w')::varchar(255) || current_setting('care_plan_view_pck.ds_espaco_w')::varchar(255) || '<strong>' || r_c_care_plan.ds_display_name || '</strong>';
    row_w.nm_tabela       := 'PATIENT_CARE_PLAN';
    row_w.ds_tipo         := obter_desc_expressao(784741, null);
    row_w.dt_start        := r_c_care_plan.dt_start;
    row_w.dt_end          := r_c_care_plan.dt_end;

    row_w.cd_seq_avo      := current_setting('care_plan_view_pck.cd_nvl_1')::smallint;
    row_w.seq_nivel       := current_setting('care_plan_view_pck.cd_seq_nvl')::integer;

    RETURN NEXT row_w;

     /*Children PATIENT_CP_PROBLEM*/


    for r_c_problem in c_problem loop
    PERFORM set_config('care_plan_view_pck.nr_seq_pat_cp_problem_w', r_c_problem.nr_sequencia, false);

    PERFORM set_config('care_plan_view_pck.cd_seq_nvl', current_setting('care_plan_view_pck.cd_seq_nvl')::integer + 1, false);

    row_w.nr_seq_item     := r_c_problem.nr_sequencia;
    row_w.si_selected     := r_c_problem.si_selected;
    row_w.ds_item         := current_setting('care_plan_view_pck.ds_espaco_w')::varchar(255) || current_setting('care_plan_view_pck.ds_espaco_w')::varchar(255) || current_setting('care_plan_view_pck.ds_espaco_w')::varchar(255) || current_setting('care_plan_view_pck.ds_espaco_w')::varchar(255) || r_c_problem.ds_display_name;
    row_w.nm_tabela       := 'PATIENT_CP_PROBLEM';
    row_w.ds_tipo         := obter_desc_expressao(296350, null);
    row_w.dt_start        := r_c_problem.dt_start;
    row_w.dt_end          := r_c_problem.dt_end;

    row_w.cd_seq_avo      := current_setting('care_plan_view_pck.cd_nvl_1')::smallint;
    row_w.cd_seq_pai      := current_setting('care_plan_view_pck.cd_nvl_2')::smallint;
    row_w.seq_nivel       := current_setting('care_plan_view_pck.cd_seq_nvl')::integer;

    RETURN NEXT row_w;

     /*Children PATIENT_CP_GOAL*/


    for r_c_goal in c_goal loop
      PERFORM set_config('care_plan_view_pck.nr_seq_pat_cp_goal_w', r_c_goal.nr_sequencia, false);
      PERFORM set_config('care_plan_view_pck.nr_seq_pat_cp_educ_goal_w', r_c_goal.nr_sequencia, false);

      PERFORM set_config('care_plan_view_pck.cd_seq_nvl', current_setting('care_plan_view_pck.cd_seq_nvl')::integer + 1, false);

      row_w.nr_seq_item     := r_c_goal.nr_sequencia;
      row_w.si_selected     := r_c_goal.si_selected;
      row_w.ds_item         := current_setting('care_plan_view_pck.ds_espaco_w')::varchar(255) || current_setting('care_plan_view_pck.ds_espaco_w')::varchar(255) ||  current_setting('care_plan_view_pck.ds_espaco_w')::varchar(255) || current_setting('care_plan_view_pck.ds_espaco_w')::varchar(255) || current_setting('care_plan_view_pck.ds_espaco_w')::varchar(255) || current_setting('care_plan_view_pck.ds_espaco_w')::varchar(255) || current_setting('care_plan_view_pck.ds_espaco_w')::varchar(255) || current_setting('care_plan_view_pck.ds_espaco_w')::varchar(255) || r_c_goal.ds_display_name;
      row_w.nm_tabela       := 'PATIENT_CP_GOAL';
      row_w.ds_tipo         := obter_desc_expressao(950898, null);
      row_w.dt_start        := r_c_goal.dt_start;
      row_w.dt_end          := r_c_goal.dt_end;

      row_w.cd_seq_avo      := current_setting('care_plan_view_pck.cd_nvl_1')::smallint;
      row_w.cd_seq_pai      := current_setting('care_plan_view_pck.cd_nvl_2')::smallint;
      row_w.cd_seq_filho    := current_setting('care_plan_view_pck.cd_nvl_3')::smallint;
      row_w.seq_nivel       := current_setting('care_plan_view_pck.cd_seq_nvl')::integer;

      RETURN NEXT row_w;

      /* Children PATIENT_CP_INDICATOR */


      for r_c_indicator in c_indicator loop

        PERFORM set_config('care_plan_view_pck.cd_seq_nvl', current_setting('care_plan_view_pck.cd_seq_nvl')::integer + 1, false);

        row_w.nr_seq_item     := r_c_indicator.nr_sequencia;
        row_w.si_selected     := r_c_indicator.si_selected;
        row_w.ds_item         := current_setting('care_plan_view_pck.ds_espaco_w')::varchar(255) || current_setting('care_plan_view_pck.ds_espaco_w')::varchar(255) || current_setting('care_plan_view_pck.ds_espaco_w')::varchar(255) || current_setting('care_plan_view_pck.ds_espaco_w')::varchar(255) || current_setting('care_plan_view_pck.ds_espaco_w')::varchar(255) || current_setting('care_plan_view_pck.ds_espaco_w')::varchar(255) || current_setting('care_plan_view_pck.ds_espaco_w')::varchar(255) || current_setting('care_plan_view_pck.ds_espaco_w')::varchar(255) || current_setting('care_plan_view_pck.ds_espaco_w')::varchar(255) || current_setting('care_plan_view_pck.ds_espaco_w')::varchar(255) || current_setting('care_plan_view_pck.ds_espaco_w')::varchar(255) || current_setting('care_plan_view_pck.ds_espaco_w')::varchar(255) || r_c_indicator.ds_display_name;
        row_w.nm_tabela       := 'PATIENT_CP_INDICATOR';
        row_w.ds_tipo         := obter_desc_expressao(291850, null);
        row_w.dt_start        := r_c_indicator.dt_start;
        row_w.dt_end          := r_c_indicator.dt_end;

        row_w.cd_seq_avo      := current_setting('care_plan_view_pck.cd_nvl_1')::smallint;
        row_w.cd_seq_pai      := current_setting('care_plan_view_pck.cd_nvl_2')::smallint;
        row_w.cd_seq_filho    := current_setting('care_plan_view_pck.cd_nvl_3')::smallint;
        row_w.cd_seq_neto     := current_setting('care_plan_view_pck.cd_nvl_4')::smallint;
        row_w.seq_nivel       := current_setting('care_plan_view_pck.cd_seq_nvl')::integer;

        RETURN NEXT row_w;
      end loop; /* Indicator */

    end loop; /* Goal */



     /*Children PATIENT_CP_INTERV_PLAN*/


    for r_c_interv_plan in c_interv_plan loop
      PERFORM set_config('care_plan_view_pck.nr_seq_pat_cp_interv_plan_w', r_c_interv_plan.nr_sequencia, false);

      PERFORM set_config('care_plan_view_pck.cd_seq_nvl', current_setting('care_plan_view_pck.cd_seq_nvl')::integer + 1, false);

      row_w.nr_seq_item     := r_c_interv_plan.nr_sequencia;
      row_w.si_selected     := r_c_interv_plan.si_selected;
      row_w.ds_item               := current_setting('care_plan_view_pck.ds_espaco_w')::varchar(255) || current_setting('care_plan_view_pck.ds_espaco_w')::varchar(255) ||  current_setting('care_plan_view_pck.ds_espaco_w')::varchar(255) || current_setting('care_plan_view_pck.ds_espaco_w')::varchar(255) || current_setting('care_plan_view_pck.ds_espaco_w')::varchar(255) || current_setting('care_plan_view_pck.ds_espaco_w')::varchar(255) || current_setting('care_plan_view_pck.ds_espaco_w')::varchar(255) || current_setting('care_plan_view_pck.ds_espaco_w')::varchar(255) || r_c_interv_plan.ds_display_name;
      row_w.nm_tabela       := 'PATIENT_CP_INTERV_PLAN';
      row_w.ds_tipo         := obter_desc_expressao(947239, null);
      row_w.dt_start        := r_c_interv_plan.dt_start;
      row_w.dt_end          := r_c_interv_plan.dt_end;

      row_w.cd_seq_avo      := current_setting('care_plan_view_pck.cd_nvl_1')::smallint;
      row_w.cd_seq_pai      := current_setting('care_plan_view_pck.cd_nvl_2')::smallint;
      row_w.cd_seq_filho    := current_setting('care_plan_view_pck.cd_nvl_3')::smallint;
      row_w.seq_nivel       := current_setting('care_plan_view_pck.cd_seq_nvl')::integer;

      RETURN NEXT row_w;

       /*Children PATIENT_CP_INTERVENTION*/


      for r_c_intervention in c_intervention loop
                            PERFORM set_config('care_plan_view_pck.display_name_1', null, false);
                            for r_c_ds_display in c_ds_display loop
                                if (r_c_ds_display.intervention_name = r_c_intervention.ds_display_name) then
                                    PERFORM set_config('care_plan_view_pck.display_name_1', r_c_ds_display.ds_display_name, false);
                                else
                                    PERFORM set_config('care_plan_view_pck.display_name', r_c_intervention.ds_display_name, false);
                                end if;
                            end loop;
                            PERFORM set_config('care_plan_view_pck.display_name', coalesce(current_setting('care_plan_view_pck.display_name_1')::varchar(255),current_setting('care_plan_view_pck.display_name')::varchar(255)), false);
        PERFORM set_config('care_plan_view_pck.cd_seq_nvl', current_setting('care_plan_view_pck.cd_seq_nvl')::integer + 1, false);

        row_w.nr_seq_item     := r_c_intervention.nr_sequencia;
        row_w.si_selected     := r_c_intervention.si_selected;
        row_w.ds_item         := current_setting('care_plan_view_pck.ds_espaco_w')::varchar(255) || current_setting('care_plan_view_pck.ds_espaco_w')::varchar(255) || current_setting('care_plan_view_pck.ds_espaco_w')::varchar(255) || current_setting('care_plan_view_pck.ds_espaco_w')::varchar(255) || current_setting('care_plan_view_pck.ds_espaco_w')::varchar(255) || current_setting('care_plan_view_pck.ds_espaco_w')::varchar(255) || current_setting('care_plan_view_pck.ds_espaco_w')::varchar(255) || current_setting('care_plan_view_pck.ds_espaco_w')::varchar(255) || current_setting('care_plan_view_pck.ds_espaco_w')::varchar(255) || current_setting('care_plan_view_pck.ds_espaco_w')::varchar(255) || current_setting('care_plan_view_pck.ds_espaco_w')::varchar(255) || current_setting('care_plan_view_pck.ds_espaco_w')::varchar(255) || current_setting('care_plan_view_pck.display_name')::varchar(255);
        row_w.nm_tabela       := 'PATIENT_CP_INTERVENTION';
        row_w.ds_tipo         := obter_desc_expressao(292225, null);
        row_w.dt_start        := r_c_intervention.dt_start;
        row_w.dt_end          := r_c_intervention.dt_end;

        row_w.cd_seq_avo      := current_setting('care_plan_view_pck.cd_nvl_1')::smallint;
        row_w.cd_seq_pai      := current_setting('care_plan_view_pck.cd_nvl_2')::smallint;
        row_w.cd_seq_filho    := current_setting('care_plan_view_pck.cd_nvl_3')::smallint;
        row_w.cd_seq_neto     := current_setting('care_plan_view_pck.cd_nvl_4')::smallint;
        row_w.seq_nivel       := current_setting('care_plan_view_pck.cd_seq_nvl')::integer;

        RETURN NEXT row_w;
      end loop;
    end loop; /* Intervention plan */

    end loop;   /* Problem */



    /* Education goal*/


    for r_c_educ_goal in c_educ_goal loop
      PERFORM set_config('care_plan_view_pck.nr_seq_pat_cp_educ_goal_w', r_c_educ_goal.nr_sequencia, false);

      PERFORM set_config('care_plan_view_pck.cd_seq_nvl', current_setting('care_plan_view_pck.cd_seq_nvl')::integer + 1, false);

      row_w.nr_seq_item         := r_c_educ_goal.nr_sequencia;
      row_w.si_selected         := r_c_educ_goal.si_selected;
      row_w.ds_item             := current_setting('care_plan_view_pck.ds_espaco_w')::varchar(255) || current_setting('care_plan_view_pck.ds_espaco_w')::varchar(255) || current_setting('care_plan_view_pck.ds_espaco_w')::varchar(255) || current_setting('care_plan_view_pck.ds_espaco_w')::varchar(255) || r_c_educ_goal.ds_display_name;
      row_w.nm_tabela           := 'PATIENT_CP_GOAL';
      row_w.ds_tipo             := obter_desc_expressao(948697, null);
      row_w.dt_start            := r_c_educ_goal.dt_start;
      row_w.dt_end              := r_c_educ_goal.dt_end;
      row_w.cd_seq_avo          := current_setting('care_plan_view_pck.cd_nvl_1')::smallint;
      row_w.cd_seq_pai          := current_setting('care_plan_view_pck.cd_nvl_2')::smallint;
      row_w.seq_nivel           := current_setting('care_plan_view_pck.cd_seq_nvl')::integer;

      RETURN NEXT row_w;

      /* Education indicator */


/*      for r_c_educ_indicator in c_educ_indicator loop

        row_w.nr_seq_item := r_c_educ_indicator.nr_sequencia;
        row_w.si_selected := r_c_educ_indicator.si_selected;
        row_w.ds_item     := ds_espaco_w || ds_espaco_w ||  ds_espaco_w || ds_espaco_w || ds_espaco_w || ds_espaco_w || ds_espaco_w || ds_espaco_w || '<strong>' || r_c_educ_indicator.ds_display_name || '</strong>';
        row_w.nm_tabela   := 'PATIENT_CP_INDICATOR';
        row_w.ds_tipo     := obter_desc_expressao(291850, null);
        row_w.dt_start    := r_c_educ_indicator.dt_start;
        row_w.dt_end      := r_c_educ_indicator.dt_end;

        pipe row(row_w);
      end loop; \* Indicator *\*/

    end loop; /* Goal */



  end loop; /* Care plan */


    return;

  END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION care_plan_view_pck.get_care_plan (nr_seq_prescr_p bigint) FROM PUBLIC;
