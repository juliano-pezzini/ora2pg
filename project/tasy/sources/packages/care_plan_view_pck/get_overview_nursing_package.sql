-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION care_plan_view_pck.get_overview_nursing (nr_seq_prescr_p bigint) RETURNS SETOF T_CARE_PLAN_DATA AS $body$
DECLARE

        c_diagnoses_overview CURSOR FOR
            SELECT  ppd.*,
                    pd.ds_diagnostico ds_display_name
            from    pe_diagnostico pd,
                    pe_prescr_diag ppd
            where   pd.nr_sequencia = ppd.nr_seq_diag
            and     ppd.nr_seq_prescr = nr_seq_prescr_p;
        c_goal_overview CURSOR FOR
            SELECT  a.*,
                    coalesce(c.ds_alternative,c.ds_display_name) ds_display_name
            from    cp_goal c,
                    patient_cp_goal a
            where   a.nr_seq_cp_goal = c.nr_sequencia
            and     a.nr_seq_prescr_diag = current_setting('care_plan_view_pck.nr_seq_diag_w')::pe_prescr_diag.nr_seq_diag%type;
        c_indicator_overview CURSOR FOR
            SELECT  a.*,
                    coalesce(b.ds_alternative,b.ds_display_name) ds_display_name
            from    cp_indicator b,
                    patient_cp_indicator a
            where   a.nr_seq_cp_indicator = b.nr_sequencia
            and     a.nr_seq_pat_cp_goal = current_setting('care_plan_view_pck.nr_seq_pat_cp_goal_w')::patient_cp_goal.nr_sequencia%type;
        c_interv_plan_overview CURSOR FOR
            SELECT  a.*,
                    b.ds_display_name ds_display_name
            from    patient_cp_interv_plan a, 
                    CP_DIAG_INTERV_PLAN b
            where   a.nr_seq_int_pla_diag = b.nr_sequencia
            and     a.nr_seq_prescr_diag = current_setting('care_plan_view_pck.nr_seq_diag_w')::pe_prescr_diag.nr_seq_diag%type;
        c_intervention_overview CURSOR FOR
            SELECT  a.nr_sequencia,
                    a.si_selected,
                    a.dt_start,
                    a.dt_end,
                    coalesce(e.ds_display_name, coalesce(d.ds_alternative, d.ds_display_name)) ds_display_name,
                    e.nr_sequencia nr_seq_procedimento
            from    patient_cp_intervention a,
                    cp_intervention  d,
                    pe_prescr_proc e,
                    pe_procedimento  f
            where   a.nr_seq_cp_intervention = d.nr_sequencia
            and     f.nr_sequencia = d.nr_seq_pe_procedimento
            and     e.nr_seq_proc = f.nr_sequencia
            and     e.nr_seq_pat_cp_interv = A.nr_sequencia
            and     e.nr_seq_prescr = nr_seq_prescr_p
            and     a.nr_seq_pat_cp_interv_plan = current_setting('care_plan_view_pck.nr_seq_pat_cp_interv_plan_w')::patient_cp_interv_plan.nr_sequencia%type;
        c_proc_overview CURSOR FOR
            SELECT  a.nr_sequencia,
                    a.DT_INICIO,
                    a.DT_FIM,
                    coalesce(a.DS_DISPLAY_NAME, d.DS_PROCEDIMENTO) ds_display_name
            from    pe_prescr_proc a,
                    pe_procedimento  d
            where   a.NR_SEQ_PROC = d.nr_sequencia
            and     a.IE_RELATED_PROBLEM = current_setting('care_plan_view_pck.nr_seq_diag_w')::pe_prescr_diag.nr_seq_diag%type
            and     a.IE_FREE_ITEM = 'S'
			and 	a.DS_ORIGEM = 'U';
        row_w       t_care_plan_row;

BEGIN
            for r_c_diagnoses_overview in c_diagnoses_overview loop
                if (r_c_diagnoses_overview.ie_diag_colab = 'S') then 
                  row_w.ds_tipo        := obter_desc_expressao(1041459, null);
                else
                  row_w.ds_tipo        := obter_desc_expressao(287694, null);
                end if;
                PERFORM set_config('care_plan_view_pck.nr_seq_diag_w', r_c_diagnoses_overview.nr_sequencia, false);
                PERFORM set_config('care_plan_view_pck.cd_seq_nvl', current_setting('care_plan_view_pck.cd_seq_nvl')::integer + 1, false);
                row_w.nr_seq_item       := r_c_diagnoses_overview.nr_sequencia;
                row_w.si_selected       := 'Y';
                row_w.ds_item           := current_setting('care_plan_view_pck.ds_espaco_w')::varchar(255) || current_setting('care_plan_view_pck.ds_espaco_w')::varchar(255) || '<strong>' || r_c_diagnoses_overview.ds_display_name || '</strong>';
                row_w.nm_tabela         := 'PE_PRESCR_DIAG';
                row_w.dt_start          := r_c_diagnoses_overview.dt_start;
                row_w.dt_end            := r_c_diagnoses_overview.dt_end;
                row_w.dt_cancelamento   := r_c_diagnoses_overview.dt_cancelamento;
                row_w.ds_motivo         := r_c_diagnoses_overview.ds_motivo;
                row_w.cd_seq_avo        := current_setting('care_plan_view_pck.cd_nvl_1')::smallint;
                row_w.seq_nivel         := current_setting('care_plan_view_pck.cd_seq_nvl')::integer;
                RETURN NEXT row_w;
                for r_c_goal_overview in c_goal_overview loop
                    PERFORM set_config('care_plan_view_pck.nr_seq_pat_cp_goal_w', r_c_goal_overview.nr_sequencia, false);
                    PERFORM set_config('care_plan_view_pck.cd_seq_nvl', current_setting('care_plan_view_pck.cd_seq_nvl')::integer + 1, false);
                    row_w.nr_seq_item           := r_c_goal_overview.nr_sequencia;
                    row_w.si_selected           := r_c_goal_overview.si_selected;
                    row_w.ds_item               := current_setting('care_plan_view_pck.ds_espaco_w')::varchar(255) || current_setting('care_plan_view_pck.ds_espaco_w')::varchar(255) || current_setting('care_plan_view_pck.ds_espaco_w')::varchar(255) || current_setting('care_plan_view_pck.ds_espaco_w')::varchar(255) || current_setting('care_plan_view_pck.ds_espaco_w')::varchar(255) || current_setting('care_plan_view_pck.ds_espaco_w')::varchar(255) || r_c_goal_overview.ds_display_name;
                    row_w.nm_tabela             := 'PATIENT_CP_GOAL';
                    row_w.ds_tipo               := obter_desc_expressao(950898, null);
                    row_w.dt_start              := r_c_goal_overview.dt_start;
                    row_w.dt_end                := r_c_goal_overview.dt_end;
                    row_w.cd_seq_avo            := current_setting('care_plan_view_pck.cd_nvl_1')::smallint;
                    row_w.cd_seq_pai            := current_setting('care_plan_view_pck.cd_nvl_2')::smallint;
                    row_w.cd_seq_filho          := current_setting('care_plan_view_pck.cd_nvl_3')::smallint;
                    row_w.seq_nivel             := current_setting('care_plan_view_pck.cd_seq_nvl')::integer;
                    RETURN NEXT row_w;
                    for r_c_indicator_overview in c_indicator_overview loop
                        PERFORM set_config('care_plan_view_pck.cd_seq_nvl', current_setting('care_plan_view_pck.cd_seq_nvl')::integer + 1, false);
                        row_w.nr_seq_item       := r_c_indicator_overview.nr_sequencia;
                        row_w.si_selected       := r_c_indicator_overview.si_selected;
                        row_w.ds_item           := current_setting('care_plan_view_pck.ds_espaco_w')::varchar(255) || current_setting('care_plan_view_pck.ds_espaco_w')::varchar(255) || current_setting('care_plan_view_pck.ds_espaco_w')::varchar(255) || current_setting('care_plan_view_pck.ds_espaco_w')::varchar(255) || current_setting('care_plan_view_pck.ds_espaco_w')::varchar(255) || current_setting('care_plan_view_pck.ds_espaco_w')::varchar(255) || current_setting('care_plan_view_pck.ds_espaco_w')::varchar(255) || current_setting('care_plan_view_pck.ds_espaco_w')::varchar(255) || current_setting('care_plan_view_pck.ds_espaco_w')::varchar(255) || current_setting('care_plan_view_pck.ds_espaco_w')::varchar(255) || r_c_indicator_overview.ds_display_name;
                        row_w.nm_tabela         := 'PATIENT_CP_INDICATOR';
                        row_w.ds_tipo           := obter_desc_expressao(291850, null);
                        row_w.dt_start          := r_c_indicator_overview.dt_start;
                        row_w.dt_end            := r_c_indicator_overview.dt_end;
                        row_w.cd_seq_avo        := current_setting('care_plan_view_pck.cd_nvl_1')::smallint;
                        row_w.cd_seq_pai        := current_setting('care_plan_view_pck.cd_nvl_2')::smallint;
                        row_w.cd_seq_filho      := current_setting('care_plan_view_pck.cd_nvl_3')::smallint;
                        row_w.cd_seq_neto       := current_setting('care_plan_view_pck.cd_nvl_4')::smallint;
                        row_w.seq_nivel         := current_setting('care_plan_view_pck.cd_seq_nvl')::integer;
                        RETURN NEXT row_w;
                    end loop;
                end loop;
                for r_c_interv_plan_overview in c_interv_plan_overview loop
                    PERFORM set_config('care_plan_view_pck.nr_seq_pat_cp_interv_plan_w', r_c_interv_plan_overview.nr_sequencia, false);
                    PERFORM set_config('care_plan_view_pck.cd_seq_nvl', current_setting('care_plan_view_pck.cd_seq_nvl')::integer + 1, false);
                    row_w.nr_seq_item           := r_c_interv_plan_overview.nr_sequencia;
                    row_w.si_selected           := r_c_interv_plan_overview.si_selected;
                    row_w.ds_item               := current_setting('care_plan_view_pck.ds_espaco_w')::varchar(255) || current_setting('care_plan_view_pck.ds_espaco_w')::varchar(255) || current_setting('care_plan_view_pck.ds_espaco_w')::varchar(255) || current_setting('care_plan_view_pck.ds_espaco_w')::varchar(255) || current_setting('care_plan_view_pck.ds_espaco_w')::varchar(255) || current_setting('care_plan_view_pck.ds_espaco_w')::varchar(255) || r_c_interv_plan_overview.ds_display_name;
                    row_w.nm_tabela             := 'PATIENT_CP_INTERV_PLAN';
                    row_w.ds_tipo               := obter_desc_expressao(947239, null);
                    row_w.dt_start              := r_c_interv_plan_overview.dt_start;
                    row_w.dt_end                := r_c_interv_plan_overview.dt_end;
                    row_w.cd_seq_avo            := current_setting('care_plan_view_pck.cd_nvl_1')::smallint;
                    row_w.cd_seq_pai            := current_setting('care_plan_view_pck.cd_nvl_2')::smallint;
                    row_w.cd_seq_filho          := current_setting('care_plan_view_pck.cd_nvl_3')::smallint;
                    row_w.seq_nivel             := current_setting('care_plan_view_pck.cd_seq_nvl')::integer;
                    RETURN NEXT row_w;
                    for r_c_intervention_overview in c_intervention_overview loop
                        PERFORM set_config('care_plan_view_pck.display_name', r_c_intervention_overview.ds_display_name, false);
                        PERFORM set_config('care_plan_view_pck.cd_seq_nvl', current_setting('care_plan_view_pck.cd_seq_nvl')::integer + 1, false);
                        row_w.nr_seq_item       := r_c_intervention_overview.nr_sequencia;
                        row_w.si_selected       := r_c_intervention_overview.si_selected;
                        row_w.ds_item           := current_setting('care_plan_view_pck.ds_espaco_w')::varchar(255) || current_setting('care_plan_view_pck.ds_espaco_w')::varchar(255) || current_setting('care_plan_view_pck.ds_espaco_w')::varchar(255) || current_setting('care_plan_view_pck.ds_espaco_w')::varchar(255) || current_setting('care_plan_view_pck.ds_espaco_w')::varchar(255) || current_setting('care_plan_view_pck.ds_espaco_w')::varchar(255) || current_setting('care_plan_view_pck.ds_espaco_w')::varchar(255) || current_setting('care_plan_view_pck.ds_espaco_w')::varchar(255) || current_setting('care_plan_view_pck.ds_espaco_w')::varchar(255) || current_setting('care_plan_view_pck.ds_espaco_w')::varchar(255) || current_setting('care_plan_view_pck.display_name')::varchar(255) || current_setting('care_plan_view_pck.ds_espaco_w')::varchar(255) || obter_observacao_intervencao(r_c_intervention_overview.nr_seq_procedimento);
                        row_w.nm_tabela         := 'PATIENT_CP_INTERVENTION';
                        row_w.ds_tipo           := obter_desc_expressao(292225, null);
                        row_w.dt_start          := r_c_intervention_overview.dt_start;
                        row_w.dt_end            := r_c_intervention_overview.dt_end;
                        row_w.cd_seq_avo        := current_setting('care_plan_view_pck.cd_nvl_1')::smallint;
                        row_w.cd_seq_pai        := current_setting('care_plan_view_pck.cd_nvl_2')::smallint;
                        row_w.cd_seq_filho      := current_setting('care_plan_view_pck.cd_nvl_3')::smallint;
                        row_w.cd_seq_neto       := current_setting('care_plan_view_pck.cd_nvl_4')::smallint;
                        row_w.seq_nivel         := current_setting('care_plan_view_pck.cd_seq_nvl')::integer;
                        RETURN NEXT row_w;
                    end loop;
                end loop;
                for r_c_proc_overview in c_proc_overview loop
                    PERFORM set_config('care_plan_view_pck.cd_seq_nvl', current_setting('care_plan_view_pck.cd_seq_nvl')::integer + 1, false);
                    row_w.nr_seq_item           := r_c_proc_overview.nr_sequencia;
                    row_w.si_selected           := 'Y';
                    row_w.ds_item               := current_setting('care_plan_view_pck.ds_espaco_w')::varchar(255) || current_setting('care_plan_view_pck.ds_espaco_w')::varchar(255) || current_setting('care_plan_view_pck.ds_espaco_w')::varchar(255) || current_setting('care_plan_view_pck.ds_espaco_w')::varchar(255) || current_setting('care_plan_view_pck.ds_espaco_w')::varchar(255) || current_setting('care_plan_view_pck.ds_espaco_w')::varchar(255) || r_c_proc_overview.ds_display_name || current_setting('care_plan_view_pck.ds_espaco_w')::varchar(255) || obter_observacao_intervencao(r_c_proc_overview.nr_sequencia);
                    row_w.nm_tabela             := 'PE_PRESCR_PROC';
                    row_w.ds_tipo               := obter_desc_expressao(292225, null);
                    row_w.dt_start              := r_c_proc_overview.dt_inicio;
                    row_w.dt_end                := r_c_proc_overview.DT_FIM;
                    row_w.cd_seq_avo            := current_setting('care_plan_view_pck.cd_nvl_1')::smallint;
                    row_w.cd_seq_pai            := current_setting('care_plan_view_pck.cd_nvl_2')::smallint;
                    row_w.cd_seq_filho          := current_setting('care_plan_view_pck.cd_nvl_3')::smallint;
                    row_w.seq_nivel             := current_setting('care_plan_view_pck.cd_seq_nvl')::integer;
                    RETURN NEXT row_w;
                end loop;
            end loop;
        return;
    END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION care_plan_view_pck.get_overview_nursing (nr_seq_prescr_p bigint) FROM PUBLIC;
