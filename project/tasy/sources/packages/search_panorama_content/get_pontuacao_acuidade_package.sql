-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION search_panorama_content.get_pontuacao_acuidade (cd_setor_atendimento_p bigint, nr_atendimento_p bigint, ie_escala_acuidade_p text default null, nr_seq_score_flex_p text default null) RETURNS varchar AS $body$
DECLARE

risco_severidade CURSOR FOR
SELECT * from table(SEARCH_PANORAMA_CONTENT.get_severidade_algoritimo_pan(cd_setor_atendimento_p,nr_atendimento_p,ie_escala_acuidade_p,nr_seq_score_flex_p));

nr_pontuacao_w varchar(255);
nr_expressao_w bigint;
BEGIN

  for r1 in risco_severidade loop
    if (coalesce(nr_pontuacao_w::text, '') = '' and r1.nr_pontuacao > 0) then
        case r1.ie_escala_acuidade
          when 'AA' then nr_expressao_w := 1151751;
          when 'EWS' then nr_expressao_w := 1151752;
          when 'PEWS' then nr_expressao_w := 1151753;
          when 'SAPS II' then nr_expressao_w := 1151754;
          when 'APACHE II' then nr_expressao_w := 1176047;
          when 'SOFA' then nr_expressao_w := 1176048;
          when 'SCORE FLEX' then nr_expressao_w := 1176050;
          when 'MEWS' then nr_expressao_w := 1176049;
          when 'SCORE FLEX2' then nr_expressao_w := 1180455;
        else null;
        END CASE;

        if (r1.ie_escala_acuidade = 'SCORE FLEX2') then
            nr_pontuacao_w :='{"NR_PONTUACAO":"'||r1.nr_pontuacao||'","DS_PONTUACAO":"'||r1.ds_exp_scoreflex||'","ESCALA_ACUIDADE":"'||r1.ie_escala_acuidade||'"}';
        else
            nr_pontuacao_w :='{"NR_PONTUACAO":"'||r1.nr_pontuacao||'","DS_PONTUACAO":"'||wheb_mensagem_pck.get_texto(nr_expressao_w)||'","ESCALA_ACUIDADE":"'||r1.ie_escala_acuidade||'"}';
        end if;
    end if;
  end loop;

  return nr_pontuacao_w;
end;


$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION search_panorama_content.get_pontuacao_acuidade (cd_setor_atendimento_p bigint, nr_atendimento_p bigint, ie_escala_acuidade_p text default null, nr_seq_score_flex_p text default null) FROM PUBLIC;
