-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


CREATE TYPE src_organ_icons_w AS (src_organ_icons_w varchar(255)[12]);


CREATE OR REPLACE FUNCTION search_panorama_content.get_icons_body_system_organs (nr_atendimento_w bigint) RETURNS varchar AS $body$
DECLARE


--body_system_setor
    c_algoritmo_icon CURSOR(p_cd_setor_atendimento bigint) FOR
    SELECT
        apc.ie_escala_acuidade
    FROM
        pan_configuracao_setor      t,
        acuidade_panorama_clinico   apc
    WHERE
        t.nr_sequencia = apc.nr_seq_pan_config_setor
        AND t.cd_setor_atendimento = p_cd_setor_atendimento
        AND t.ie_situacao = 'A';

--body_system
c_body_system_AA CURSOR(p_nr_atendimento bigint) FOR
    SELECT
       ac.ie_sistema_organismo,
       ac.nr_pontuacao,
       ac.nr_peso
    FROM automated_acuity aa, automated_acuity_component ac
    WHERE aa.nr_sequencia = ac.cd_automated_acuity
    AND   aa.nr_atendimento = p_nr_atendimento
    AND   (aa.ie_tipo_cuidado IS NOT NULL AND aa.ie_tipo_cuidado::text <> '')
    AND   aa.nr_sequencia = (SELECT MAX(aa_sub.nr_sequencia) FROM automated_acuity aa_sub
                                WHERE aa_sub.nr_atendimento = aa.nr_atendimento)
    order by CASE WHEN ac.ie_sistema_organismo='NEU' THEN 1 WHEN ac.ie_sistema_organismo='CAR' THEN 2 WHEN ac.ie_sistema_organismo='RES' THEN 3 WHEN ac.ie_sistema_organismo='REN' THEN 4 WHEN ac.ie_sistema_organismo='HEM' THEN 5 WHEN ac.ie_sistema_organismo='DOE' THEN 6 END;
c_body_system_EWS CURSOR(p_nr_atendimento bigint) FOR
    SELECT distinct
      ewc.IE_COMPONENTE,
      ewc.NR_VALOR,
      ewc.DS_DETALHE,
      ew.NR_DELTA
    from
      EARLY_WARNING ew 
    join 
      EARLY_WARNING_COMPONENT ewc ON (ew.NR_SEQUENCIA = ewc.CD_EARLY_WARNING) 
    where nr_atendimento = p_nr_atendimento
	and dt_pontuacao = (SELECT max(dt_pontuacao) from EARLY_WARNING where nr_atendimento = p_nr_atendimento)
    order by CASE WHEN ewc.IE_COMPONENTE='BP' THEN 1 WHEN ewc.IE_COMPONENTE='HR' THEN 2 WHEN ewc.IE_COMPONENTE='TEMP' THEN 3 WHEN ewc.IE_COMPONENTE='RR' THEN 4 WHEN ewc.IE_COMPONENTE='O2S' THEN 5 WHEN ewc.IE_COMPONENTE='AGE' THEN 6 END;

c_profile_icons_ocor CURSOR FOR
SELECT	ri.cd_icone_panorama, ri.nr_seq_prioridade, ri.ds_icone_instituicao
  from	regra_perm_panorama r
inner join regra_perm_panorama_icone ri on ri.nr_seq_regra = r.nr_sequencia
 where r.nr_sequencia in (select nr_sequencia from regra_perm_panorama where cd_perfil  = wheb_usuario_pck.get_cd_perfil);

json_html_organ_item_w        PHILIPS_JSON;
json_html_organ_list_w        PHILIPS_JSON_LIST;
icone_organ_w                 varchar(255);
cd_setor_atendimento_w	integer;
icone_body_system_w           varchar(255);
icon_categoria_rod_w          varchar(255);
color_score_w                 varchar(255);
cd_exp_body_system_w          bigint;
pontuacao_organ_w             varchar(2);
nr_pontuacao_body_sys_w       varchar(3);
type tab_organ_icons_w         IS TABLE OF src_organ_icons_w INDEX BY varchar(4);
icons_organ_w tab_organ_icons_w;
red_danger_w varchar(7) := '#DE3835';
yellow_caution_w varchar(7) := '#FFCD05';
green_safety_instruct_w varchar(7) := '#00BD5E';
orange_warning_w varchar(7) := '#FF830F';
blue_notice_w varchar(7) := '#03ABFF';
BEGIN

if (nr_atendimento_w IS NOT NULL AND nr_atendimento_w::text <> '') then
            json_html_organ_item_w:=PHILIPS_JSON();
            json_html_organ_list_w:=PHILIPS_JSON_LIST();
            cd_setor_atendimento_w := obter_setor_atendimento(nr_atendimento_w);

            icons_organ_w('CAR'):= src_organ_icons_w('assets/icons/status-and-feedback/heart.svg','assets/icons/status-and-feedback/heart-yellow.svg','assets/icons/status-and-feedback/heart-red.svg','1140660'); -- icone nao cadastrado
            icons_organ_w('RES'):= src_organ_icons_w('assets/icons/status-and-feedback/lungs.svg','assets/icons/status-and-feedback/lungs-yellow.svg','assets/icons/status-and-feedback/lungs-red.svg','1140661'); -- icone nao cadastrado
            icons_organ_w('HEM'):= src_organ_icons_w('assets/icons/status-and-feedback/transfusion.svg','assets/icons/status-and-feedback/transfusion-yellow.svg','assets/icons/status-and-feedback/transfusion-red.svg','1140754');  -- icone nao cadastrado
            icons_organ_w('REN'):= src_organ_icons_w('assets/icons/status-and-feedback/kidneys.svg','assets/icons/status-and-feedback/kidneys-yellow.svg','assets/icons/status-and-feedback/kidneys-red.svg','1140662'); -- icone nao cadastrado
            icons_organ_w('DOE'):= src_organ_icons_w('assets/icons/status-and-feedback/infectology.svg','assets/icons/status-and-feedback/infectology-yellow.svg','assets/icons/status-and-feedback/infectology-red.svg','1140666'); -- icone nao cadastrado
            icons_organ_w('NEU'):= src_organ_icons_w('assets/icons/status-and-feedback/brain.svg','assets/icons/status-and-feedback/brain-yellow.svg','assets/icons/status-and-feedback/brain-red.svg','1140664'); -- icone nao cadastrado
            icons_organ_w('BP'):= src_organ_icons_w('','','','1190439');
            icons_organ_w('HR'):= src_organ_icons_w('','','','1190440');
            icons_organ_w('TEMP'):= src_organ_icons_w('','','','1190441');
            icons_organ_w('RR'):= src_organ_icons_w('','','','1190442');
            icons_organ_w('O2S'):= src_organ_icons_w('','','','1190443');
            icons_organ_w('AGE'):=src_organ_icons_w('','','','1190444');

            FOR reg_cursor1 IN c_algoritmo_icon(cd_setor_atendimento_w) LOOP

                IF reg_cursor1.ie_escala_acuidade = 'AA' THEN
                    FOR reg_cursor2 IN c_body_system_AA(nr_atendimento_w) LOOP
                        icone_organ_w:=NULL;
                        pontuacao_organ_w:=NULL;
                        cd_exp_body_system_w:=icons_organ_w(reg_cursor2.ie_sistema_organismo)(4);

                        CASE
                        WHEN coalesce(reg_cursor2.nr_pontuacao::text, '') = '' OR reg_cursor2.nr_pontuacao = 0 THEN 
                            pontuacao_organ_w:='N';
                            icone_organ_w:= icons_organ_w(reg_cursor2.ie_sistema_organismo)(1);
                        WHEN reg_cursor2.nr_pontuacao = 1 OR reg_cursor2.nr_pontuacao = 2  THEN
                            pontuacao_organ_w:='M';
                            icone_organ_w:= icons_organ_w(reg_cursor2.ie_sistema_organismo)(2);
                            IF (coalesce(icone_body_system_w::text, '') = '') THEN
                            icone_body_system_w:='assets/icons/status-and-feedback/human-body-minor-warning.svg'; -- icone nao cadastrado
                            END IF;
                        WHEN reg_cursor2.nr_pontuacao > 2 THEN
                            pontuacao_organ_w:='H';
                            icone_organ_w:= icons_organ_w(reg_cursor2.ie_sistema_organismo)(3);
                            icone_body_system_w:='assets/icons/status-and-feedback/human-body-major-warning.svg'; -- icone nao cadastrado
                        ELSE NULL;
                        END CASE;
                        nr_pontuacao_body_sys_w :=TO_CHAR(reg_cursor2.nr_pontuacao);
                        IF (reg_cursor2.nr_peso IS NOT NULL AND reg_cursor2.nr_peso::text <> '') THEN
                            nr_pontuacao_body_sys_w :=TO_CHAR(reg_cursor2.nr_pontuacao * reg_cursor2.nr_peso);
                        END IF;
                        IF coalesce(reg_cursor2.nr_pontuacao::text, '') = '' THEN
                            nr_pontuacao_body_sys_w:='--';
                            pontuacao_organ_w:='N';
                        END IF;
                        IF (icone_organ_w IS NOT NULL AND icone_organ_w::text <> '')THEN
                            json_html_organ_item_w.PUT('ICONE',icone_organ_w);
                            json_html_organ_item_w.PUT('TOTAL',nr_pontuacao_body_sys_w);
                            json_html_organ_item_w.PUT('SCORE',pontuacao_organ_w);
                            json_html_organ_item_w.PUT('CD_EXPRESSAO',cd_exp_body_system_w);
                            json_html_organ_list_w.APPEND(json_html_organ_item_w.to_json_value());
                        END IF;
                    END LOOP;
        				ELSIF (reg_cursor1.ie_escala_acuidade = 'EWS') THEN
                    FOR reg_cursor2 IN c_body_system_EWS(nr_atendimento_w) LOOP
                        icone_organ_w:=NULL;
                        pontuacao_organ_w:=NULL;
                        color_score_w:='#FFFFFF';
                        icon_categoria_rod_w:='';
                        cd_exp_body_system_w:=icons_organ_w(reg_cursor2.IE_COMPONENTE)(4);
                        if (reg_cursor2.IE_COMPONENTE = 'BP') then
                          if (reg_cursor2.NR_VALOR < 80 or reg_cursor2.NR_VALOR > 200) then
                            color_score_w:=red_danger_w;
                          elsif (reg_cursor2.NR_VALOR >= 80 and reg_cursor2.NR_VALOR < 95) then
                            color_score_w:=orange_warning_w;
                          elsif (reg_cursor2.NR_VALOR >= 95 and reg_cursor2.NR_VALOR <= 110) then
                            color_score_w:=yellow_caution_w;
                          elsif (reg_cursor2.NR_VALOR >= 111 and reg_cursor2.NR_VALOR <= 179) then
                            color_score_w:=green_safety_instruct_w;
                          elsif (reg_cursor2.NR_VALOR >= 180 and reg_cursor2.NR_VALOR <= 200) then
                            color_score_w:=orange_warning_w;
                          end if;
                        elsif (reg_cursor2.IE_COMPONENTE = 'HR') then
                          if (reg_cursor2.NR_VALOR < 40 or reg_cursor2.NR_VALOR > 130) then
                            color_score_w:=red_danger_w;
                          elsif (reg_cursor2.NR_VALOR >= 40 and reg_cursor2.NR_VALOR <= 49) then
                            color_score_w:=orange_warning_w;
                          elsif (reg_cursor2.NR_VALOR >= 59 and reg_cursor2.NR_VALOR <= 59) then
                            color_score_w:=green_safety_instruct_w;
                          elsif (reg_cursor2.NR_VALOR >= 91 and reg_cursor2.NR_VALOR <= 110) then
                            color_score_w:=yellow_caution_w;
                          elsif (reg_cursor2.NR_VALOR >= 111 and reg_cursor2.NR_VALOR <= 129) then
                            color_score_w:=orange_warning_w;
                          end if;
                        elsif (reg_cursor2.IE_COMPONENTE = 'RR') then
                          if (reg_cursor2.NR_VALOR < 6) then
                            color_score_w:=red_danger_w;
                          elsif (reg_cursor2.NR_VALOR >= 6 and reg_cursor2.NR_VALOR <= 8) then
                            color_score_w:=orange_warning_w;
                          elsif (reg_cursor2.NR_VALOR >= 9 and reg_cursor2.NR_VALOR <= 10) then
                            color_score_w:=yellow_caution_w;
                          elsif (reg_cursor2.NR_VALOR >= 11 and reg_cursor2.NR_VALOR <= 19) then
                            color_score_w:=green_safety_instruct_w;
                          elsif (reg_cursor2.NR_VALOR >= 20 and reg_cursor2.NR_VALOR <= 30) then
                            color_score_w:=yellow_caution_w;
                          elsif (reg_cursor2.NR_VALOR > 30) then
                            color_score_w:=orange_warning_w;
                          end if;
                        elsif (reg_cursor2.IE_COMPONENTE = 'TEMP') then
                          if (reg_cursor2.NR_VALOR < 35) then
                            color_score_w:=orange_warning_w;
                          elsif (reg_cursor2.NR_VALOR >= 35 and reg_cursor2.NR_VALOR <= 37.9) then
                            color_score_w:=green_safety_instruct_w;
                          elsif (reg_cursor2.NR_VALOR >= 38 and reg_cursor2.NR_VALOR <= 38.4) then
                            color_score_w:=yellow_caution_w;
                          elsif (reg_cursor2.NR_VALOR >= 38.5) then
                            color_score_w:=red_danger_w;
                          end if;
                        elsif (reg_cursor2.IE_COMPONENTE = 'AGE') then
                          if (reg_cursor2.NR_VALOR < 57) then
                            color_score_w:=green_safety_instruct_w;
                          elsif (reg_cursor2.NR_VALOR >= 57) then
                            color_score_w:=yellow_caution_w;
                          end if;
                        elsif (reg_cursor2.IE_COMPONENTE = 'O2S') then
                          if (reg_cursor2.NR_VALOR < 85) then
                            color_score_w:=red_danger_w;
                          elsif (reg_cursor2.NR_VALOR >= 85 and reg_cursor2.NR_VALOR <= 89) then
                            color_score_w:=yellow_caution_w;
                          elsif (reg_cursor2.NR_VALOR >= 90 and reg_cursor2.NR_VALOR <= 100) then
                            color_score_w:=green_safety_instruct_w;
                          end if;
                        end if;
                        if (reg_cursor2.nr_delta IS NOT NULL AND reg_cursor2.nr_delta::text <> '') then
                          if (reg_cursor2.nr_delta >0) then
                              icon_categoria_rod_w :='assets/icons/status-and-feedback/arrow-up-red.svg';
                          else
                              icon_categoria_rod_w :='assets/icons/status-and-feedback/arrow-down-green.svg';
                          end if;
                        end if;
                        IF coalesce(reg_cursor2.NR_VALOR::text, '') = '' THEN
                            nr_pontuacao_body_sys_w:='--';
                        ELSE
                            nr_pontuacao_body_sys_w:=TO_CHAR(reg_cursor2.NR_VALOR);
                        END IF;
                        IF (cd_exp_body_system_w IS NOT NULL AND cd_exp_body_system_w::text <> '')THEN
                            json_html_organ_item_w.PUT('IE_COLOR_SCORE',color_score_w);
                            json_html_organ_item_w.PUT('TOTAL',nr_pontuacao_body_sys_w);
                            json_html_organ_item_w.PUT('SCORE',pontuacao_organ_w);
                            json_html_organ_item_w.PUT('DELTA',icon_categoria_rod_w);
                            json_html_organ_item_w.PUT('CD_EXPRESSAO',cd_exp_body_system_w);
                            json_html_organ_list_w.APPEND(json_html_organ_item_w.to_json_value());
                        END IF;
                    END LOOP;
                END IF;
            END LOOP;
end if;

return json_html_organ_list_w.to_char();

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION search_panorama_content.get_icons_body_system_organs (nr_atendimento_w bigint) FROM PUBLIC;
