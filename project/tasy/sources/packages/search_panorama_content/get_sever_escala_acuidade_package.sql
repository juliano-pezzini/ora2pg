-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION search_panorama_content.get_sever_escala_acuidade (nr_atendimento_p bigint, ie_escala_acuidade_p text default null, nr_seq_score_flex_p text default null) RETURNS T_OBJETO_SEVER_ALG_ROW AS $body$
DECLARE


curso2 CURSOR(p_nr_atendimento bigint) FOR
SELECT ie_tipo_cuidado FROM (
SELECT
    aao.ie_tipo_cuidado,
    aao.dt_atualizacao 
FROM
    automated_acuity_override aao
WHERE
    aao.nr_atendimento = p_nr_atendimento
    AND ie_sobrescrever = 'S'

UNION

    SELECT aa.ie_tipo_cuidado,
        aa.dt_pontuacao 
    FROM
        automated_acuity aa
    WHERE aa.nr_atendimento = p_nr_atendimento
) alias1 ORDER BY dt_atualizacao ASC;

nr_pontuacao_w       				bigint;
nr_delta_w           				bigint;
ie_severidade_w      				varchar(2);
cd_exp_severidade_w  				bigint;
ds_exp_scoreflex_w          varchar(255);
cd_exp_default_w  	 				bigint;
cd_exp_score_name_w  	 			bigint;
nr_baseline_w						bigint;
nr_media_w							bigint;
nr_pontuacao_rod_w					bigint;
dt_pontuacao_w						timestamp;
t_objeto_sever_alg_row_w t_objeto_sever_alg_row;
EXEC_W								varchar(300);

BEGIN

  nr_baseline_w := 0;
  nr_media_w := 0;
  nr_pontuacao_rod_w := 0;

  IF ie_escala_acuidade_p = 'AA' THEN

    cd_exp_default_w := 1198288;
	cd_exp_score_name_w := 1193694;
    BEGIN
		SELECT 	aa.nr_pontuacao,
				aa.nr_delta,
				coalesce(aa.ie_tipo_cuidado,'X'),
				aa.nr_linha_base,
				aa.nr_media,
				aa.dt_pontuacao
		INTO STRICT	nr_pontuacao_w,
				nr_delta_w,
				ie_severidade_w,
				nr_baseline_w,
				nr_media_w,
				dt_pontuacao_w
		FROM	automated_acuity aa
		WHERE	aa.nr_atendimento = nr_atendimento_p
		AND 	aa.nr_sequencia = (
							SELECT	MAX(aa_sub.nr_sequencia)
							FROM	automated_acuity aa_sub
							WHERE	aa_sub.nr_atendimento = aa.nr_atendimento);
	
      BEGIN
        SELECT	rod.nr_pontuacao
        INTO STRICT	nr_pontuacao_rod_w
        FROM	risk_of_death rod
        WHERE	rod.nr_atendimento = nr_atendimento_p
        AND 	rod.nr_sequencia = (
					SELECT	MAX(rod_sub.nr_sequencia)
					FROM	risk_of_death rod_sub
					WHERE	rod_sub.nr_atendimento = rod.nr_atendimento);
      EXCEPTION
          WHEN OTHERS THEN
          nr_pontuacao_rod_w := 0;
      END;

		begin
		  exec_w := 'CALL CLINICAL_PANORAMA_MD_PCK.GET_IE_SEVERIDADE(:1,:2,:3) INTO :result';
		  EXECUTE EXEC_W USING IN ie_escala_acuidade_p,
										 IN nr_pontuacao_w,
										 IN ie_severidade_w,
										 OUT ie_severidade_w;

		exception
		when others then
		  ie_severidade_w := 'X';
		end;

      CASE ie_severidade_w
        WHEN 'H' THEN cd_exp_severidade_w := 1138878;
        WHEN 'M' THEN cd_exp_severidade_w := 1138879;
        WHEN 'L' THEN cd_exp_severidade_w := 1138880;
        ELSE cd_exp_severidade_w := cd_exp_default_w;
      END CASE;

    EXCEPTION
        WHEN OTHERS THEN
        nr_pontuacao_w 		:= 0;
        nr_delta_w 			:= 0;
        ie_severidade_w 	:= '';
        cd_exp_severidade_w := cd_exp_default_w;
        ds_exp_scoreflex_w 	:= '';
		cd_exp_score_name_w := '';
    END;

  ELSIF ie_escala_acuidade_p = 'EWS' THEN

    cd_exp_default_w 	:= 1198291;
	cd_exp_score_name_w := 1193695;
    BEGIN
		SELECT	ew.nr_pontuacao,
				ew.nr_delta,
				coalesce(ew.ie_severidade,'X'),
				ew.nr_linha_base,
				ew.dt_pontuacao
		INTO STRICT	nr_pontuacao_w,
				nr_delta_w,
				ie_severidade_w,
				nr_baseline_w,
				dt_pontuacao_w
		FROM	early_warning ew
		WHERE	ew.nr_atendimento = nr_atendimento_p
		AND 	ew.nr_sequencia = (
						SELECT	MAX(ew_sub.nr_sequencia)
						FROM	early_warning ew_sub
						WHERE	ew_sub.nr_atendimento = ew.nr_atendimento
						);

		begin
		  exec_w := 'CALL CLINICAL_PANORAMA_MD_PCK.GET_IE_SEVERIDADE(:1,:2,:3) INTO :result';
		  EXECUTE EXEC_W USING IN  ie_escala_acuidade_p,
										 IN  nr_pontuacao_w,
										 IN  ie_severidade_w,
										 OUT ie_severidade_w;

		exception
		when others then
		  ie_severidade_w := 'X';
		end;

      CASE ie_severidade_w
        WHEN 'S' THEN cd_exp_severidade_w := 1138881;
        WHEN 'M' THEN cd_exp_severidade_w := 1138882;
        WHEN 'N' THEN cd_exp_severidade_w := 1138883;
        ELSE cd_exp_severidade_w := cd_exp_default_w;
      END CASE;

    EXCEPTION
        WHEN OTHERS THEN
        nr_pontuacao_w := 0;
        nr_delta_w := 0;
        ie_severidade_w := '';
        cd_exp_severidade_w := cd_exp_default_w;
        ds_exp_scoreflex_w := '';
		cd_exp_score_name_w := '';
    END;

  ELSIF ie_escala_acuidade_p = 'SAPS II' THEN

    cd_exp_default_w := 1193697;
	cd_exp_score_name_w := 1193697;
    BEGIN
      SELECT
        sa.qt_saps,
        (select obter_pontuacao_telehealth(nr_atendimento_p, 'escala_saps', 'qt_saps', 'dt_avaliacao', 1) ) -
        (select obter_pontuacao_telehealth(nr_atendimento_p, 'escala_saps', 'qt_saps', 'dt_avaliacao', 2) ) nr_delta_saps,
		sa.dt_avaliacao
      INTO STRICT
        nr_pontuacao_w,
        nr_delta_w,
		dt_pontuacao_w
      FROM
        escala_saps sa
      WHERE
        sa.ie_situacao = 'A'
        AND sa.nr_atendimento = nr_atendimento_p
        AND sa.nr_sequencia =(
          SELECT
              MAX(sa_sub.nr_sequencia)
          FROM
              escala_saps sa_sub
          WHERE
              sa_sub.nr_atendimento = sa.nr_atendimento);

	begin
	  exec_w := 'CALL CLINICAL_PANORAMA_MD_PCK.GET_IE_SEVERIDADE(:1,:2,:3) INTO :result';
	  EXECUTE EXEC_W USING IN  ie_escala_acuidade_p,
									 IN  nr_pontuacao_w,
									 IN  ie_severidade_w,
									 OUT ie_severidade_w;

	exception
	when others then
	  ie_severidade_w := 'X';
	end;

	IF ie_severidade_w = 'H' THEN
		cd_exp_severidade_w := 1138884;
	ELSIF ie_severidade_w = 'L' THEN
		cd_exp_severidade_w := 1138886;
	ELSIF ie_severidade_w = 'M' THEN
		cd_exp_severidade_w := 1138885;
	END IF;

    EXCEPTION
      WHEN OTHERS THEN
      nr_pontuacao_w := 0;
      nr_delta_w := 0;
      ie_severidade_w := '';
      cd_exp_severidade_w := cd_exp_default_w;
      ds_exp_scoreflex_w := '';
	  cd_exp_score_name_w := '';
    END;

  ELSIF ie_escala_acuidade_p = 'PEWS' THEN

    cd_exp_default_w := 1193698;
	cd_exp_score_name_w := 1193698;
    BEGIN
      SELECT  pews.qt_pontuacao,
        (select obter_pontuacao_telehealth(nr_atendimento_p, 'escala_pews', 'qt_pontuacao', 'dt_avaliacao', 1) ) -
        (select obter_pontuacao_telehealth(nr_atendimento_p, 'escala_pews', 'qt_pontuacao', 'dt_avaliacao', 2) ) nr_delta_pews,
		pews.dt_avaliacao
      INTO STRICT
        nr_pontuacao_w,
        nr_delta_w,
		dt_pontuacao_w
      FROM escala_pews pews
      WHERE pews.nr_atendimento = nr_atendimento_p
      AND (pews.dt_liberacao IS NOT NULL AND pews.dt_liberacao::text <> '')
      AND pews.nr_sequencia = (
              SELECT
                  MAX(pews_sub.nr_sequencia)
                  FROM escala_pews pews_sub
                  WHERE pews_sub.nr_atendimento = pews.nr_atendimento
      AND (pews_sub.dt_liberacao IS NOT NULL AND pews_sub.dt_liberacao::text <> ''));

	cd_exp_severidade_w := cd_exp_default_w;
	ie_severidade_w 	:= 'X';

	begin
	  exec_w := 'CALL CLINICAL_PANORAMA_MD_PCK.GET_IE_SEVERIDADE(:1,:2,:3) INTO :result';
	  EXECUTE EXEC_W USING IN  ie_escala_acuidade_p,
									 IN  nr_pontuacao_w,
									 IN  ie_severidade_w,
									 OUT ie_severidade_w;

	exception
	when others then
	  ie_severidade_w := 'X';
	end;

	IF ie_severidade_w = 'L' THEN
		cd_exp_severidade_w := 1138889;
	ELSIF ie_severidade_w = 'M'  THEN
		cd_exp_severidade_w := 1138888;
	ELSIF ie_severidade_w = 'H' THEN
		cd_exp_severidade_w := 1138887;
	END IF;

    EXCEPTION
      WHEN OTHERS THEN
      nr_pontuacao_w := 0;
      nr_delta_w := 0;
      ie_severidade_w := '';
      cd_exp_severidade_w := cd_exp_default_w;
      ds_exp_scoreflex_w := '';
	  cd_exp_score_name_w := '';
    END;
  ELSIF ie_escala_acuidade_p = 'APACHE II' THEN

    cd_exp_default_w := 1180213;
    BEGIN
      SELECT  ap2.QT_APACHE_II,
        (select obter_pontuacao_telehealth(nr_atendimento_p, 'apache', 'qt_apache_ii', 'dt_apache', 1) ) -
        (select obter_pontuacao_telehealth(nr_atendimento_p, 'apache', 'qt_apache_ii', 'dt_apache', 2) ) nr_delta_apache2,
		ap2.dt_apache
      INTO STRICT
        nr_pontuacao_w,
        nr_delta_w,
		dt_pontuacao_w
      FROM APACHE ap2
      WHERE ap2.nr_atendimento = nr_atendimento_p
      AND (ap2.dt_liberacao IS NOT NULL AND ap2.dt_liberacao::text <> '')
      AND ap2.nr_sequencia = (
              SELECT
                  MAX(ap2_sub.nr_sequencia)
                  FROM APACHE ap2_sub
                  WHERE ap2_sub.nr_atendimento = ap2.nr_atendimento
      AND (ap2_sub.dt_liberacao IS NOT NULL AND ap2_sub.dt_liberacao::text <> ''))
      order by ap2.DT_APACHE desc LIMIT 1;

      cd_exp_severidade_w 	:= 1180213;
      ie_severidade_w 		:= 'X';

    EXCEPTION
      WHEN OTHERS THEN
      nr_pontuacao_w := 0;
      nr_delta_w := 0;
      ie_severidade_w := '';
      cd_exp_severidade_w := cd_exp_default_w;
      ds_exp_scoreflex_w := '';
    END;

  ELSIF ie_escala_acuidade_p = 'SOFA' THEN

    cd_exp_default_w := 1180217;
    BEGIN
      SELECT  sofa.QT_PONTUACAO,
        (select obter_pontuacao_telehealth(nr_atendimento_p, 'escala_sofa', 'qt_pontuacao', 'dt_avaliacao', 1) ) -
        (select obter_pontuacao_telehealth(nr_atendimento_p, 'escala_sofa', 'qt_pontuacao', 'dt_avaliacao', 2) ) nr_delta_sofa,
		sofa.dt_avaliacao
      INTO STRICT
        nr_pontuacao_w,
        nr_delta_w,
		dt_pontuacao_w
      FROM ESCALA_SOFA sofa
      WHERE 	sofa.nr_atendimento = nr_atendimento_p
      AND 	(sofa.dt_liberacao IS NOT NULL AND sofa.dt_liberacao::text <> '')
      AND sofa.nr_sequencia = (
              SELECT
                  MAX(sofa_sub.nr_sequencia)
                  FROM ESCALA_SOFA sofa_sub
                  WHERE sofa_sub.nr_atendimento = sofa.nr_atendimento
      AND	(sofa_sub.dt_liberacao IS NOT NULL AND sofa_sub.dt_liberacao::text <> ''))
      order by sofa.DT_AVALIACAO desc LIMIT 1;

      cd_exp_severidade_w 	:= 1180217;
      ie_severidade_w 		:= 'X';

    EXCEPTION
      WHEN OTHERS THEN
      nr_pontuacao_w := 0;
      nr_delta_w := 0;
      ie_severidade_w := '';
      cd_exp_severidade_w := cd_exp_default_w;
      ds_exp_scoreflex_w := '';
    END;
  ELSIF ie_escala_acuidade_p = 'SCORE FLEX' THEN

    cd_exp_default_w := 1069291;
    BEGIN
      if (nr_seq_score_flex_p IS NOT NULL AND nr_seq_score_flex_p::text <> '') then
         SELECT
                eif.ds_escala
         INTO STRICT
                ds_exp_scoreflex_w
         FROM
                eif_escala eif
         WHERE
                eif.nr_sequencia = nr_seq_score_flex_p;
      end if;

      SELECT qt_pontos, nr_delta_score_flex, ds_escala, dt_avaliacao
      INTO STRICT
        nr_pontuacao_w,
        nr_delta_w,
        ds_exp_scoreflex_w,
		dt_pontuacao_w
      FROM
        (SELECT  substr(obter_resultado_escala_eif(eif.nr_sequencia,'T'),1,255) qt_pontos,
          ((select obter_pontuacao_score_flex(nr_atendimento_p, 'escala_eif', 'qt_pontos', nr_seq_score_flex_p, 'dt_avaliacao', 1) ) -
          (select obter_pontuacao_score_flex(nr_atendimento_p, 'escala_eif', 'qt_pontos', nr_seq_score_flex_p, 'dt_avaliacao', 2) ) ) nr_delta_score_flex,
          eie.ds_escala,
		  eif.dt_avaliacao
          FROM ESCALA_EIF eif, eif_escala eie
          WHERE eif.nr_atendimento = nr_atendimento_p
          and eif.nr_seq_escala = eie.nr_sequencia
          AND (eif.dt_liberacao IS NOT NULL AND eif.dt_liberacao::text <> '')
          and nr_seq_escala = nr_seq_score_flex_p
          order by eif.DT_AVALIACAO desc, eif.NR_SEQUENCIA desc) alias8 LIMIT 1;

      cd_exp_severidade_w := 1180215;
      ie_severidade_w 	  := 'X';

    EXCEPTION
      WHEN OTHERS THEN
      nr_pontuacao_w := 0;
      nr_delta_w := 0;
      ie_severidade_w := '';
      cd_exp_severidade_w := cd_exp_default_w;
    END;

  ELSIF ie_escala_acuidade_p = 'MEWS' THEN

    cd_exp_default_w 	:= 1180214;
	cd_exp_score_name_w := 1180214;
    BEGIN
		SELECT	mews.qt_pontuacao,
				(select obter_pontuacao_telehealth(nr_atendimento_p, 'escala_mews', 'qt_pontuacao', 'dt_avaliacao', 1) ) -
				(select obter_pontuacao_telehealth(nr_atendimento_p, 'escala_mews', 'qt_pontuacao', 'dt_avaliacao', 2) ) nr_delta_mews,
				mews.dt_avaliacao
		INTO STRICT	nr_pontuacao_w,
				nr_delta_w,
				dt_pontuacao_w
		FROM 	ESCALA_MEWS mews
		WHERE 	mews.nr_atendimento = nr_atendimento_p
		AND 	(mews.dt_liberacao IS NOT NULL AND mews.dt_liberacao::text <> '')
		AND 	mews.nr_sequencia = (
							SELECT 	MAX(mews_sub.nr_sequencia)
							FROM 	ESCALA_MEWS mews_sub
							WHERE 	mews_sub.nr_atendimento = mews.nr_atendimento
							AND 	(mews_sub.dt_liberacao IS NOT NULL AND mews_sub.dt_liberacao::text <> ''))
		order by mews.DT_AVALIACAO desc LIMIT 1;

        cd_exp_severidade_w := cd_exp_default_w;
        ie_severidade_w 	:= 'X';

		begin
		  exec_w := 'CALL CLINICAL_PANORAMA_MD_PCK.GET_IE_SEVERIDADE(:1,:2,:3) INTO :result';
		  EXECUTE EXEC_W USING IN ie_escala_acuidade_p,
										 IN nr_pontuacao_w,
										 IN ie_severidade_w,
										 OUT ie_severidade_w;

		exception
		when others then
		  ie_severidade_w := 'X';
		end;

		IF ie_severidade_w = 'L' THEN
			cd_exp_severidade_w := 1190138;
		ELSIF ie_severidade_w = 'M'  THEN
			cd_exp_severidade_w := 1190139;
		ELSIF ie_severidade_w = 'H' THEN
			cd_exp_severidade_w := 1190140;
		END IF;

    EXCEPTION
	WHEN OTHERS THEN
		nr_pontuacao_w 		:= 0;
		nr_delta_w 			:= 0;
		ie_severidade_w 	:= '';
		cd_exp_severidade_w := cd_exp_default_w;
		ds_exp_scoreflex_w 	:= '';
		cd_exp_score_name_w := '';
    END;

  ELSIF ie_escala_acuidade_p = 'SCORE FLEX2' THEN

    cd_exp_default_w := 1069676;
    BEGIN
      if (nr_seq_score_flex_p IS NOT NULL AND nr_seq_score_flex_p::text <> '') then
          SELECT
                 eie.ds_escala
          INTO STRICT
                 ds_exp_scoreflex_w
          FROM
                 eif_escala_ii eie
          WHERE
                 eie.nr_sequencia = nr_seq_score_flex_p;
      end if;

      SELECT  eif2.QT_PONTOS,
              (select obter_pontuacao_score_flex(nr_atendimento_p, 'escala_eif_ii', 'qt_pontos', nr_seq_score_flex_p, 'dt_avaliacao', 1) ) -
              (select obter_pontuacao_score_flex(nr_atendimento_p, 'escala_eif_ii', 'qt_pontos', nr_seq_score_flex_p, 'dt_avaliacao', 2) ) nr_delta_score_flex_ii,
              eie.ds_escala,
			  eif2.dt_avaliacao
      INTO STRICT
        nr_pontuacao_w,
        nr_delta_w,
        ds_exp_scoreflex_w,
		dt_pontuacao_w
      FROM ESCALA_EIF_II eif2, eif_escala_ii eie
      WHERE eif2.nr_atendimento = nr_atendimento_p
      and eif2.nr_seq_escala = eie.nr_sequencia
      AND (eif2.dt_liberacao IS NOT NULL AND eif2.dt_liberacao::text <> '')
      AND eif2.ie_situacao = 'A'
      and nr_seq_escala = nr_seq_score_flex_p
      AND eif2.DT_AVALIACAO IN (SELECT MAX(DT_AVALIACAO) FROM escala_eif_ii ESCA
                              WHERE ESCA.nr_atendimento = nr_atendimento_p
                              AND ESCA.nr_seq_escala = nr_seq_score_flex_p
                              and (ESCA.dt_liberacao IS NOT NULL AND ESCA.dt_liberacao::text <> ''))
      order by eif2.DT_AVALIACAO desc, eif2.NR_SEQUENCIA desc LIMIT 1;

      cd_exp_severidade_w 	:= 1180453;
      ie_severidade_w		:= 'X';

    EXCEPTION
      WHEN OTHERS THEN
      nr_pontuacao_w := 0;
      nr_delta_w := 0;
      ie_severidade_w := '';
      cd_exp_severidade_w := cd_exp_default_w;
    END;

  ELSE
    nr_pontuacao_w := 0;
    nr_delta_w := 0;
    ie_severidade_w := '';
    cd_exp_severidade_w := 0;
    ds_exp_scoreflex_w := '';
  END IF;

  t_objeto_sever_alg_row_w.NR_PONTUACAO := nr_pontuacao_w;
  t_objeto_sever_alg_row_w.NR_DELTA := nr_delta_w;
  t_objeto_sever_alg_row_w.IE_SEVERIDADE  := ie_severidade_w;
  t_objeto_sever_alg_row_w.CD_EXP_SEVERIDADE  := cd_exp_severidade_w;
  t_objeto_sever_alg_row_w.IE_ESCALA_ACUIDADE := ie_escala_acuidade_p;
  t_objeto_sever_alg_row_w.DS_EXP_SCOREFLEX := ds_exp_scoreflex_w;
  t_objeto_sever_alg_row_w.NR_BASELINE := nr_baseline_w;
  t_objeto_sever_alg_row_w.NR_MEDIA := nr_media_w;
  t_objeto_sever_alg_row_w.NR_PONTUACAO_ROD := nr_pontuacao_rod_w;
  t_objeto_sever_alg_row_w.CD_EXP_SCORE_NAME := cd_exp_score_name_w;
  t_objeto_sever_alg_row_w.DT_PONTUACAO := dt_pontuacao_w;

  return t_objeto_sever_alg_row_w;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION search_panorama_content.get_sever_escala_acuidade (nr_atendimento_p bigint, ie_escala_acuidade_p text default null, nr_seq_score_flex_p text default null) FROM PUBLIC;
