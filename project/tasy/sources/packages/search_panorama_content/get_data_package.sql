-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION search_panorama_content.get_data ( cd_setor_atendimento_p bigint, cd_unidade_basica_p text, nr_seq_interno_p bigint) RETURNS SETOF T_OBJETO_CONTENT_ROW_DATA AS $body$
DECLARE


t_objeto_content_row_w		t_objeto_content_row;
nr_atendimento_w varchar(20);

c_unity CURSOR FOR
   SELECT * from
   (SELECT	u.cd_setor_atendimento,
					u.cd_unidade_basica,
					u.cd_unidade_compl,
					u.ie_leito_adaptado,
					u.ie_temporario,
					u.ie_leito_retaguarda,
					u.ie_status_unidade,
					u.ie_sexo_paciente,
					u.nr_seq_interno,
					'N' ie_sem_acomodacao,
					u.ds_unidade_atend,
					(select obter_departamento_setor(u.cd_setor_atendimento) ) cd_departamento,
					CASE WHEN(select	count(1)										where	not exists (select	1									from	departamento_setor x									where	x.cd_setor_atendimento	= u.cd_setor_atendimento									and		x.cd_departamento		= obter_departamento_data(u.nr_atendimento,clock_timestamp())									)					and (select obter_departamento_data(u.nr_atendimento,clock_timestamp()) ) is not null					)=0 THEN 'N'  ELSE 'S' END  ie_emprestado,
					u.ie_sexo_fixo,
					substr((select obter_valor_dominio(4,u.ie_sexo_paciente) ),1,80) ds_sexo,
					substr((select obter_se_def_ret_atual(wheb_usuario_pck.get_cd_perfil) ),1,1) ie_permite_def_retaguarda,
					(select AUDIO_VIDEO_PCK.GET_UNIT_STATUS(u.cd_setor_atendimento, u.cd_unidade_basica,u.cd_unidade_compl) ) status_camera
			from	unidade_atendimento u
					left join atendimento_paciente a on a.nr_atendimento = u.nr_atendimento
					left join pessoa_fisica p on p.cd_pessoa_fisica = a.cd_pessoa_fisica,
					setor_atendimento s
			where	s.cd_setor_atendimento = u.cd_setor_atendimento
			and		u.ie_situacao = 'A'
			and (select obter_se_sem_acomodacao(u.cd_tipo_acomodacao) ) = 'N'
			and		u.nr_seq_interno= nr_seq_interno_p
			
union all

			select	distinct
					u.cd_setor_atendimento,
					u.cd_unidade_basica,
					u.cd_unidade_compl,
					u.ie_leito_adaptado,
					u.ie_temporario,
					u.ie_leito_retaguarda,
					u.ie_status_unidade,
					u.ie_sexo_paciente,
					u.nr_seq_interno,
					'S' ie_sem_acomodacao,
					u.ds_unidade_atend,
					(select obter_departamento_setor(u.cd_setor_atendimento) ) cd_departamento,
					'N' ie_emprestado,
					u.ie_sexo_fixo,
					substr((select obter_valor_dominio(4,u.ie_sexo_paciente) ),1,80) ds_sexo,
					substr((select obter_se_def_ret_atual(wheb_usuario_pck.get_cd_perfil) ),1,1) ie_permite_def_retaguarda,
					(select AUDIO_VIDEO_PCK.GET_UNIT_STATUS(u.cd_setor_atendimento, u.cd_unidade_basica,u.cd_unidade_compl) ) status_camera
			from	unidade_atendimento u
			where	u.ie_situacao = 'A'
			and (select obter_se_sem_acomodacao(u.cd_tipo_acomodacao) ) = 'S'
			and		u.nr_seq_interno	= nr_seq_interno_p
			and exists (select 1
						from atend_paciente_unidade c
						where c.cd_setor_atendimento = u.cd_setor_atendimento
						and c.cd_unidade_basica = u.cd_unidade_basica
						and c.cd_unidade_compl = u.cd_unidade_compl
						and coalesce(c.dt_saida_unidade::text, '') = '')
		) alias34;

c_patient CURSOR FOR
SELECT	nr_atendimento,
		cd_pessoa_fisica cd_pessoa_paciente,
		ie_new_patient,
		(select obter_prontuario_paciente(cd_pessoa_fisica) ) as nr_prontuario,
		null ds_cor_risco, --substr(obter_cor_triagem_mapa_html(nr_atendimento),1,20)
		substr(
			CASE WHEN(select obter_valor_param_usuario(338,3,0,wheb_usuario_pck.get_nm_usuario,wheb_usuario_pck.get_cd_estabelecimento) )='N' THEN (select obter_nome_pf(cd_pessoa_fisica) )  ELSE (select Obter_Iniciais_Nome(	null , obter_nome_pf(cd_pessoa_fisica)) ) END
		       ,1,255) nm_paciente,
		cd_medico_resp cd_medico,
		substr((select obter_nome_pf(cd_medico_resp) ),1,200) nm_medico,
		substr(CASE WHEN coalesce(nr_seq_perfil::text, '') = '' THEN 'N'  ELSE 'S' END ,1,1) ie_vip,
		null ie_alergia,
		substr((select obter_sexo_pf(cd_pessoa_fisica, 'C') ),1,3) ie_sexo,
		substr((select obter_desc_perfil_paciente(nr_seq_perfil) ),1,255) ds_vip,
		756080 cd_exp_alergia,
		966277 nr_seq_texto_alergia,
		317326 cd_exp_acao_alergia, /* Prontuario Eletronico Paciente - PEP */
		966278 nr_seq_texto_acao_alergia,
		null ds_alergias,
		CASE WHEN substr((select obter_sexo_pf(cd_pessoa_fisica, 'C') ),1,1)='M' THEN 1135092 WHEN substr((select obter_sexo_pf(cd_pessoa_fisica, 'C') ),1,1)='F' THEN 1135091 WHEN substr((select obter_sexo_pf(cd_pessoa_fisica, 'C') ),1,1)='I' THEN 1135088 WHEN substr((select obter_sexo_pf(cd_pessoa_fisica, 'C') ),1,1)='D' THEN 1135090 END  cd_exp_sexo,
		null ds_classif_risco, --substr(obter_ds_triagem_mapa_html(nr_atendimento),1,200)
		null ds_classif_paciente,
		null ie_exibe_classif,
		null ie_classif_paciente,
		(select obter_departamento_data(nr_atendimento) ) cd_depart_atend,
		(select obter_data_nascto_pac_atend(nr_atendimento) ) dt_nascimento,
		(select obter_idade_pf(cd_pessoa_fisica, clock_timestamp(), 'A') ) ds_idade	,
		967932 nr_seq_texto_nasc,
		--Novos
		null ds_cor_regra_leito, --obter_cor_leito_mapa(2462,'3',nr_atendimento,'S')
		(select obter_desc_expressao(283172) ) icon_legend,
		null as ds_risco_queda,
		null as ie_risco_queda,
		SUBSTR((select obter_nome_departamento_medico(obter_departamento_data(nr_atendimento)) ),1,100) ds_departament,
		substr((select obter_nome_curto_depto_medico(obter_departamento_data(nr_atendimento)) ),1,100) ds_short_departament,
		null nr_case, --SUBSTR(obter_episodio_atend_tela(nr_atendimento),1,50)
		null ie_uso_case, --obter_uso_case(obter_usuario_ativo)
        (select obter_data_entrada_setor(nr_atendimento) ) dt_entrada,
        -- retornando sempre 01/04/2021
		--(select max(z.dt_entrada_unidade) from atend_paciente_unidade z where z.nr_atendimento = nr_atendimento ) dt_entrada,
		null classif_esp_paciente, --obter_classif_esp_pac(nr_atendimento)
		null ie_planejado, -- obter_se_case_atend_planejado(nr_atendimento)
	    null cd_classif_setor, --obter_classif_setor_atend(nr_atendimento)
		null ie_paciente_jejum,
		null ds_paciente_jejum,
		null ie_exame_nao_checado,
		dt_obito has_obito,
		ie_paciente_isolado,
		null nr_encounter_status,
		1137307 nr_seq_texto_age,
		(select obter_tipo_acompanhante(nr_atendimento) ) ie_acompanhante,
		dt_previsto_alta,
		nr_seq_episodio,
		ie_clinica
  from	(select	a.nr_atendimento,
				p.cd_pessoa_fisica,
				(select obter_se_paciente_novo_pan(a.nr_atendimento, u.cd_setor_atendimento) ) ie_new_patient,
				a.cd_medico_resp,
				p.nr_seq_perfil,
				a.ie_paciente_isolado,
				p.dt_obito,
				a.dt_previsto_alta,
				a.nr_seq_episodio,
				a.ie_clinica
		   from	unidade_atendimento u,
				atendimento_paciente a,
				pessoa_fisica p,
				setor_atendimento s
		  where	p.cd_pessoa_fisica = a.cd_pessoa_fisica
			and	a.nr_atendimento = u.nr_atendimento
			and	s.cd_setor_atendimento = u.cd_setor_atendimento
			and	u.ie_situacao = 'A'
			and (select obter_se_sem_acomodacao(u.cd_tipo_acomodacao) ) = 'N'
			and (u.nr_seq_interno	= nr_seq_interno_p or coalesce(nr_seq_interno_p::text, '') = '')
			and u.cd_setor_atendimento = cd_setor_atendimento_p
			and u.cd_unidade_basica = cd_unidade_basica_p
			) alias60;

c_override_aa CURSOR FOR

SELECT count(*) as qtde_override from automated_acuity_override 
where nr_atendimento =  nr_atendimento_w
and ie_sobrescrever != 'N';
BEGIN

for r_unity in c_unity loop

		t_objeto_content_row_w.CD_SETOR_ATENDIMENTO			:= r_unity.CD_SETOR_ATENDIMENTO;
		t_objeto_content_row_w.CD_UNIDADE_BASICA			:= r_unity.CD_UNIDADE_BASICA;
		t_objeto_content_row_w.CD_UNIDADE_COMPL				:= r_unity.CD_UNIDADE_COMPL;
		t_objeto_content_row_w.IE_LEITO_ADAPTADO			:= r_unity.IE_LEITO_ADAPTADO;
		t_objeto_content_row_w.IE_TEMPORARIO				:= r_unity.IE_TEMPORARIO;
		t_objeto_content_row_w.IE_LEITO_RETAGUARDA			:= r_unity.IE_LEITO_RETAGUARDA;
		t_objeto_content_row_w.IE_STATUS_UNIDADE			:= r_unity.IE_STATUS_UNIDADE;
		t_objeto_content_row_w.IE_SEXO_PACIENTE				:= r_unity.IE_SEXO_PACIENTE;
		t_objeto_content_row_w.NR_SEQ_INTERNO				:= r_unity.NR_SEQ_INTERNO;
		t_objeto_content_row_w.DS_UNIDADE_ATEND				:= r_unity.DS_UNIDADE_ATEND;
		t_objeto_content_row_w.IE_SEXO_FIXO					:= r_unity.IE_SEXO_FIXO;
		t_objeto_content_row_w.DS_SEXO						:= r_unity.DS_SEXO;
		t_objeto_content_row_w.IE_SEM_ACOMODACAO			:= r_unity.IE_SEM_ACOMODACAO;
		t_objeto_content_row_w.IE_PERMITE_DEF_RETAGUARDA	:= r_unity.IE_PERMITE_DEF_RETAGUARDA;
		t_objeto_content_row_w.STATUS_CAMERA				:= r_unity.STATUS_CAMERA;
		t_objeto_content_row_w.CD_DEPARTAMENTO				:= r_unity.CD_DEPARTAMENTO;
end loop;

for r_patient in c_patient loop

 nr_atendimento_w := r_patient.NR_ATENDIMENTO;
 for r_override_aa in c_override_aa loop
  t_objeto_content_row_w.QTDE_OVERRIDE			 := r_override_aa.QTDE_OVERRIDE;
 end loop;

	t_objeto_content_row_w.NR_ATENDIMENTO			 := r_patient.NR_ATENDIMENTO;
	t_objeto_content_row_w.CD_PESSOA_PACIENTE		 := r_patient.CD_PESSOA_PACIENTE;
	t_objeto_content_row_w.DS_COR_RISCO				 := r_patient.DS_COR_RISCO;
	t_objeto_content_row_w.NM_PACIENTE				 := r_patient.NM_PACIENTE;
	t_objeto_content_row_w.CD_MEDICO				 := r_patient.CD_MEDICO;
	t_objeto_content_row_w.NM_MEDICO				 := r_patient.NM_MEDICO;
	t_objeto_content_row_w.IE_VIP					 := r_patient.IE_VIP;
	t_objeto_content_row_w.IE_ALERGIA				 := r_patient.IE_ALERGIA;
	t_objeto_content_row_w.IE_SEXO					 := r_patient.IE_SEXO;
	t_objeto_content_row_w.DS_VIP					 := r_patient.DS_VIP;
	t_objeto_content_row_w.CD_EXP_ALERGIA			 := r_patient.CD_EXP_ALERGIA;
	t_objeto_content_row_w.NR_SEQ_TEXTO_ALERGIA		 := r_patient.NR_SEQ_TEXTO_ALERGIA;
	t_objeto_content_row_w.CD_EXP_ACAO_ALERGIA		 := r_patient.CD_EXP_ACAO_ALERGIA;
	t_objeto_content_row_w.NR_SEQ_TEXTO_ACAO_ALERGIA := r_patient.NR_SEQ_TEXTO_ACAO_ALERGIA;
	t_objeto_content_row_w.DS_ALERGIAS				 := r_patient.DS_ALERGIAS;
	t_objeto_content_row_w.CD_EXP_SEXO				 := r_patient.CD_EXP_SEXO;
	t_objeto_content_row_w.DS_CLASSIF_RISCO			 := r_patient.DS_CLASSIF_RISCO;
	t_objeto_content_row_w.DS_CLASSIF_PACIENTE		 := r_patient.DS_CLASSIF_PACIENTE;
	t_objeto_content_row_w.IE_EXIBE_CLASSIF			 := r_patient.IE_EXIBE_CLASSIF;
	t_objeto_content_row_w.IE_CLASSIF_PACIENTE		 := r_patient.IE_CLASSIF_PACIENTE;
	t_objeto_content_row_w.CD_DEPART_ATEND			 := r_patient.CD_DEPART_ATEND;
	t_objeto_content_row_w.DT_NASCIMENTO			 := r_patient.DT_NASCIMENTO;
	t_objeto_content_row_w.DS_IDADE					 := r_patient.DS_IDADE;
	t_objeto_content_row_w.NR_SEQ_TEXTO_NASC		 := r_patient.NR_SEQ_TEXTO_NASC;
	t_objeto_content_row_w.DS_COR_REGRA_LEITO	     := r_patient.DS_COR_REGRA_LEITO;
	t_objeto_content_row_w.ICON_LEGEND			     := r_patient.ICON_LEGEND;
	t_objeto_content_row_w.DS_RISCO_QUEDA		     := r_patient.DS_RISCO_QUEDA;
	t_objeto_content_row_w.IE_RISCO_QUEDA		     := r_patient.IE_RISCO_QUEDA;
	t_objeto_content_row_w.DS_DEPARTAMENT		     := r_patient.DS_DEPARTAMENT;
	t_objeto_content_row_w.DS_SHORT_DEPARTAMENT	     := r_patient.DS_SHORT_DEPARTAMENT;
	t_objeto_content_row_w.NR_CASE				     := r_patient.NR_CASE;
	t_objeto_content_row_w.IE_USO_CASE			     := r_patient.IE_USO_CASE;
	t_objeto_content_row_w.DT_ENTRADA			     := r_patient.DT_ENTRADA;
	t_objeto_content_row_w.CLASSIF_ESP_PACIENTE	     := r_patient.CLASSIF_ESP_PACIENTE;
	t_objeto_content_row_w.IE_PLANEJADO			     := r_patient.IE_PLANEJADO;
	t_objeto_content_row_w.CD_CLASSIF_SETOR		     := r_patient.CD_CLASSIF_SETOR;
	t_objeto_content_row_w.IE_PACIENTE_JEJUM	     := r_patient.IE_PACIENTE_JEJUM;
	t_objeto_content_row_w.DS_PACIENTE_JEJUM	     := r_patient.DS_PACIENTE_JEJUM;
	t_objeto_content_row_w.IE_EXAME_NAO_CHECADO	     := r_patient.IE_EXAME_NAO_CHECADO;
	t_objeto_content_row_w.HAS_OBITO 			     := r_patient.HAS_OBITO;
	t_objeto_content_row_w.IE_PACIENTE_ISOLADO		 := r_patient.IE_PACIENTE_ISOLADO;
	t_objeto_content_row_w.NR_ENCOUNTER_STATUS		 := r_patient.NR_ENCOUNTER_STATUS;
	t_objeto_content_row_w.NR_SEQ_TEXTO_AGE			 := r_patient.NR_SEQ_TEXTO_AGE;
	t_objeto_content_row_w.IE_ACOMPANHANTE			 := r_patient.IE_ACOMPANHANTE;
	t_objeto_content_row_w.DT_PREVISTO_ALTA			 := r_patient.DT_PREVISTO_ALTA;
	t_objeto_content_row_w.NR_SEQ_EPISODIO			 := r_patient.NR_SEQ_EPISODIO;
	t_objeto_content_row_w.IE_CLINICA				 := r_patient.IE_CLINICA;
	t_objeto_content_row_w.IE_NEW_PATIENT		     := r_patient.IE_NEW_PATIENT;
	t_objeto_content_row_w.NR_PRONTUARIO		     := r_patient.NR_PRONTUARIO;


end loop;

RETURN NEXT t_objeto_content_row_w;

return;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION search_panorama_content.get_data ( cd_setor_atendimento_p bigint, cd_unidade_basica_p text, nr_seq_interno_p bigint) FROM PUBLIC;
