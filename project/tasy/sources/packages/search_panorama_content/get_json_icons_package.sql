-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION search_panorama_content.get_json_icons (cd_setor_atendimento_p bigint, cd_unidade_basica_p text, nr_seq_interno_p bigint) RETURNS text AS $body$
DECLARE


icons CURSOR FOR
SELECT * from table(search_panorama_content.get_icons_data(cd_setor_atendimento_p,cd_unidade_basica_p,nr_seq_interno_p));

jsonReturn text;
w_line smallint:=0;
json_aux_list_w PHILIPS_JSON_LIST;
src_aux_w varchar(255);
BEGIN

  jsonReturn := '[';
  for r1 in icons loop


	if (w_line > 0) then
        jsonReturn:= jsonReturn ||',';
    end if;

	if (r1.ie_location_card = 'C' and (r1.ds_tag IS NOT NULL AND r1.ds_tag::text <> '')) then
		jsonReturn := jsonReturn || '{"txt":"'|| r1.ds_tag || '", "color": "'
		|| r1.ds_cor || '", "tooltip":"' ||r1.ds_etapa|| '", "type":"'|| r1.ie_location_card ||'", "ie_campo_panorama":"'||r1.ie_campo_panorama||'" }';
	else
		if (r1.ie_campo_panorama = 80 and (r1.ds_informacao IS NOT NULL AND r1.ds_informacao::text <> '')) then
            json_aux_list_w :=philips_json_parser.parse_list(r1.ds_informacao);
            for I in 1..json_aux_list_w.count loop
                jsonReturn := jsonReturn || '{"src":"'|| PHILIPS_JSON(json_aux_list_w.get(I)).Get['ICONE'].GET_STRING();
                jsonReturn := jsonReturn || '", "tooltip":"';
                jsonReturn := jsonReturn || '( '||PHILIPS_JSON(json_aux_list_w.get(I)).Get['TOTAL'].GET_STRING()||' ) ';
                jsonReturn := jsonReturn || wheb_mensagem_pck.get_texto(PHILIPS_JSON(json_aux_list_w.get(I)).Get['CD_EXPRESSAO'].GET_NUMBER());
                jsonReturn := jsonReturn || '", "type":"BS", "ie_campo_panorama":"'||r1.ie_campo_panorama||'" }';
                if I <> json_aux_list_w.count then
                    jsonReturn:= jsonReturn ||',';
                end if;
            end loop;

        else
           jsonReturn := jsonReturn || '{"src":"'|| r1.ds_imagem_padrao || '", "tooltip":"' ||wheb_mensagem_pck.get_texto(r1.cd_exp_titulo)
		   || '", "type":"'|| r1.ie_location_card ||'" , "ie_campo_panorama":"'||r1.ie_campo_panorama||'", "ds_informacao":"' || r1.ds_informacao || '"}';
        end if;
	end if;
	w_line := w_line +1;
  end loop;
  jsonreturn := jsonreturn || ']';
return jsonReturn;
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION search_panorama_content.get_json_icons (cd_setor_atendimento_p bigint, cd_unidade_basica_p text, nr_seq_interno_p bigint) FROM PUBLIC;
