-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION search_panorama_content.get_if_ventilation_icon (nr_atendimento_p atendimento_paciente.nr_atendimento%type) RETURNS bigint AS $body$
DECLARE

   ie_ventilation_w bigint;

   c_profile_icons_pat CURSOR FOR
      SELECT ri.cd_icone_panorama,
             ri.nr_seq_prioridade,
             ri.ds_icone_instituicao
        from regra_perm_panorama r, regra_panorama_icone_pac ri
       where r.nr_sequencia =
             (SELECT max(nr_sequencia)
                from regra_perm_panorama
               where cd_perfil = wheb_usuario_pck.get_cd_perfil)
         and ri.nr_seq_regra = r.nr_sequencia
         and ri.cd_icone_panorama = 61;

BEGIN
   ie_ventilation_w := 0;
   --Regra 
   for r_profile_icons_pat in c_profile_icons_pat loop
      --
      select 1
        into STRICT ie_ventilation_w
        from (SELECT amr.ie_respiracao     respiracao,
                     amr.ie_canula_traqueo traqueo,
                     amr.ie_integracao     integracao,
                     amr.ie_disp_resp_esp  interface,
                     amr.dt_liberacao      liberacao
                FROM atendimento_monit_resp amr
               WHERE amr.ie_situacao = 'A'
                 AND amr.ie_respiracao <> 'ESPONT'
                 AND coalesce(amr.dt_inativacao::text, '') = ''
                 AND amr.NR_ATENDIMENTO = nr_atendimento_p
                 AND amr.NR_SEQUENCIA IN (SELECT coalesce(MAX(amrt.NR_SEQUENCIA), 0)
                        FROM atendimento_monit_resp amrt
                       WHERE amrt.ie_situacao = 'A'
                         AND coalesce(amrt.dt_inativacao::text, '') = ''
                         AND amrt.NR_ATENDIMENTO = nr_atendimento_p)
               ORDER BY 1) alias5 LIMIT 1;

   end loop;

   return(ie_ventilation_w);
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION search_panorama_content.get_if_ventilation_icon (nr_atendimento_p atendimento_paciente.nr_atendimento%type) FROM PUBLIC;
