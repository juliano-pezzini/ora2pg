-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


/* 
FUNCTION CREATED TO GET ACUITY DATA WITHOUT THE JSON STRUCTURE 
BASED ON THE FUNCTION 'get_pontuacao_acuidade'  
*/
CREATE OR REPLACE FUNCTION search_panorama_content.get_dados_acuidade (ds_tipo_dados_p text, cd_setor_atendimento_p bigint, nr_atendimento_p bigint, ie_escala_acuidade_p text default null, nr_seq_score_flex_p text default null) RETURNS varchar AS $body$
DECLARE


risco_severidade CURSOR FOR
SELECT nr_pontuacao, ds_exp_scoreflex, ie_escala_acuidade
from table(SEARCH_PANORAMA_CONTENT.get_severidade_algoritimo_pan(cd_setor_atendimento_p,nr_atendimento_p,ie_escala_acuidade_p,nr_seq_score_flex_p))
where nr_pontuacao > 0;

ds_dados_acuidade_w varchar(1000);
nr_expressao_w bigint;
BEGIN

  if (ds_tipo_dados_p not in ('NR_PONTUACAO', 'DS_PONTUACAO', 'ESCALA_ACUIDADE')) then
    return ds_dados_acuidade_w;
  end if;

  for r1 in risco_severidade loop
    if (coalesce(ds_dados_acuidade_w::text, '') = '') then

        if (ds_tipo_dados_p = 'NR_PONTUACAO') then
          ds_dados_acuidade_w := r1.nr_pontuacao;

        elsif (ds_tipo_dados_p = 'DS_PONTUACAO') then
          CASE r1.ie_escala_acuidade
            when 'AA' then nr_expressao_w := 1151751;
            when 'EWS' then nr_expressao_w := 1151752;
            when 'PEWS' then nr_expressao_w := 1151753;
            when 'SAPS II' then nr_expressao_w := 1151754;
            when 'APACHE II' then nr_expressao_w := 1176047;
            when 'SOFA' then nr_expressao_w := 1176048;
            when 'SCORE FLEX' then nr_expressao_w := 1176050;
            when 'MEWS' then nr_expressao_w := 1176049;
            when 'SCORE FLEX2' then nr_expressao_w := 1180455;
            else null;
          END CASE;

          if (r1.ie_escala_acuidade = 'SCORE FLEX2') then
              ds_dados_acuidade_w := r1.ds_exp_scoreflex;
          else
              ds_dados_acuidade_w := wheb_mensagem_pck.get_texto(nr_expressao_w);
          end if;

        elsif (ds_tipo_dados_p = 'ESCALA_ACUIDADE') then
          ds_dados_acuidade_w := r1.ie_escala_acuidade;
        end if;

    end if;
  end loop;

  return ds_dados_acuidade_w;
end;

/* 
This functions returns the data in JSON structure.
To get the individual data, without JSON structure, use the function 'get_dados_acuidade' 
*/
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION search_panorama_content.get_dados_acuidade (ds_tipo_dados_p text, cd_setor_atendimento_p bigint, nr_atendimento_p bigint, ie_escala_acuidade_p text default null, nr_seq_score_flex_p text default null) FROM PUBLIC;
