-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION search_panorama_content.get_severidade_algoritimo_pan (cd_setor_atendimento_p bigint, nr_atendimento_p bigint, ie_escala_acuidade_p text default null, nr_seq_score_flex_p text default null) RETURNS SETOF T_OBJETO_SEVERIDADE_ALG_DATA AS $body$
DECLARE

curso1 CURSOR(
    p_cd_setor_atendimento setor_atendimento.cd_setor_atendimento%TYPE
) FOR
SELECT
    coalesce(ie_escala_acuidade_p, apc.ie_escala_acuidade) ie_escala_acuidade,
    coalesce(nr_seq_score_flex_p, apc.nr_seq_score_flex) nr_seq_score_flex,
    ie_escala_acuidade_opcao_2,
    apc.nr_seq_score_flex_opcao_2,
    ie_escala_acuidade_opcao_3,
    apc.nr_seq_score_flex_opcao_3,
    ie_escala_acuidade_opcao_4,
    apc.nr_seq_score_flex_opcao_4
FROM pan_configuracao_setor t, acuidade_panorama_clinico apc
LEFT OUTER JOIN eif_escala_ii eif2 ON (apc.nr_seq_score_flex_opcao_2 = eif2.nr_sequencia)
LEFT OUTER JOIN eif_escala_ii eif3 ON (apc.nr_seq_score_flex_opcao_3 = eif3.nr_sequencia)
LEFT OUTER JOIN eif_escala_ii eif4 ON (apc.nr_seq_score_flex_opcao_4 = eif4.nr_sequencia)
WHERE t.nr_sequencia = apc.nr_seq_pan_config_setor AND t.cd_setor_atendimento = p_cd_setor_atendimento    AND t.ie_situacao = 'A';

curso2 CURSOR(p_nr_atendimento bigint) FOR
SELECT ie_tipo_cuidado FROM (
SELECT
    aao.ie_tipo_cuidado,
    aao.dt_atualizacao 
FROM
    automated_acuity_override aao
WHERE
    aao.nr_atendimento = p_nr_atendimento
    AND ie_sobrescrever = 'S'

UNION

    SELECT aa.ie_tipo_cuidado,
        aa.dt_pontuacao 
    FROM
        automated_acuity aa
    WHERE aa.nr_atendimento = p_nr_atendimento
) alias1 ORDER BY dt_atualizacao ASC;

curso3 CURSOR(p_nr_atendimento bigint) FOR
 SELECT nr_pontuacao
 FROM risk_of_readmission 
 WHERE nr_atendimento=p_nr_atendimento 
 AND dt_pontuacao=(SELECT max(dt_pontuacao) from risk_of_readmission where nr_atendimento=p_nr_atendimento);

nr_pontuacao_w       				bigint;
nr_delta_w           				bigint;
ie_severidade_w      				varchar(2);
ie_severidade_penultimo_w			varchar(2);
nr_pontuacao_rod_w   				bigint;
nr_pontuacao_ror_w   				double precision;
ie_categoria_rod_w   				varchar(1);
cd_exp_severidade_w  				  bigint;
cd_exp_severidade_penultimo_w 		bigint;
qtd_rows            				bigint;
nr_override_w           			bigint;
cd_exp_default_w  	 				bigint;
nr_linha_base_w               bigint;
nr_media_w           bigint;
ds_exp_scoreflex_w            varchar(255);
dt_pontuacao_w            timestamp;

t_objeto_sever_alg_row_w t_objeto_sever_alg_row;
exec_w								varchar(300);

BEGIN
    qtd_rows :=0;

    FOR reg_c1 IN curso1(cd_setor_atendimento_p) LOOP

      nr_pontuacao_w := 0;
      nr_pontuacao_rod_w := 0;
      nr_pontuacao_ror_w :=0;
      ie_categoria_rod_w := 'S';
      cd_exp_severidade_w :=0;
      cd_exp_severidade_penultimo_w :=0;
      cd_exp_default_w := 0;
      qtd_rows := qtd_rows + 1;
      nr_override_w := 0;
      ds_exp_scoreflex_w := '';

      -- get scala op2
      if (reg_c1.ie_escala_acuidade_opcao_2 IS NOT NULL AND reg_c1.ie_escala_acuidade_opcao_2::text <> '') then
        t_objeto_sever_alg_row_w := search_panorama_content.get_sever_escala_acuidade(nr_atendimento_p, reg_c1.ie_escala_acuidade_opcao_2, reg_c1.nr_seq_score_flex_opcao_2);
        CALL search_panorama_content.insert_sever_alg_data_opcao2(
          t_objeto_sever_alg_row_w.nr_pontuacao,
          t_objeto_sever_alg_row_w.nr_delta,
          t_objeto_sever_alg_row_w.ie_severidade,
          t_objeto_sever_alg_row_w.cd_exp_severidade,
          t_objeto_sever_alg_row_w.ie_escala_acuidade,
          t_objeto_sever_alg_row_w.ds_exp_scoreflex,
          t_objeto_sever_alg_row_w.nr_baseline,
          t_objeto_sever_alg_row_w.nr_media,
          t_objeto_sever_alg_row_w.nr_pontuacao_rod,
		  t_objeto_sever_alg_row_w.cd_exp_score_name,
		  t_objeto_sever_alg_row_w.dt_pontuacao
        );
      end if;

      -- get scala op3
      if (reg_c1.ie_escala_acuidade_opcao_3 IS NOT NULL AND reg_c1.ie_escala_acuidade_opcao_3::text <> '') then
        t_objeto_sever_alg_row_w := search_panorama_content.get_sever_escala_acuidade(nr_atendimento_p, reg_c1.ie_escala_acuidade_opcao_3, reg_c1.nr_seq_score_flex_opcao_3);
        CALL search_panorama_content.insert_sever_alg_data_opcao3(
          t_objeto_sever_alg_row_w.nr_pontuacao,
          t_objeto_sever_alg_row_w.nr_delta,
          t_objeto_sever_alg_row_w.ie_severidade,
          t_objeto_sever_alg_row_w.cd_exp_severidade,
          t_objeto_sever_alg_row_w.ie_escala_acuidade,
          t_objeto_sever_alg_row_w.ds_exp_scoreflex,
          t_objeto_sever_alg_row_w.nr_baseline,
          t_objeto_sever_alg_row_w.nr_media,
          t_objeto_sever_alg_row_w.nr_pontuacao_rod,
		  t_objeto_sever_alg_row_w.cd_exp_score_name,
		  t_objeto_sever_alg_row_w.dt_pontuacao
        );
      end if;

      -- get scala op4
      if (reg_c1.ie_escala_acuidade_opcao_4 IS NOT NULL AND reg_c1.ie_escala_acuidade_opcao_4::text <> '') then
        t_objeto_sever_alg_row_w := search_panorama_content.get_sever_escala_acuidade(nr_atendimento_p, reg_c1.ie_escala_acuidade_opcao_4, reg_c1.nr_seq_score_flex_opcao_4);
        CALL search_panorama_content.insert_sever_alg_data_opcao4(
          t_objeto_sever_alg_row_w.nr_pontuacao,
          t_objeto_sever_alg_row_w.nr_delta,
          t_objeto_sever_alg_row_w.ie_severidade,
          t_objeto_sever_alg_row_w.cd_exp_severidade,
          t_objeto_sever_alg_row_w.ie_escala_acuidade,
          t_objeto_sever_alg_row_w.ds_exp_scoreflex,
          t_objeto_sever_alg_row_w.nr_baseline,
          t_objeto_sever_alg_row_w.nr_media,
          t_objeto_sever_alg_row_w.nr_pontuacao_rod,
		  t_objeto_sever_alg_row_w.cd_exp_score_name,
		  t_objeto_sever_alg_row_w.dt_pontuacao
        );
      end if;

      IF reg_c1.ie_escala_acuidade = 'AA' THEN --automated acuity
		ie_severidade_w  := '';
		cd_exp_default_w := 1198288;
        BEGIN

			SELECT  aa.nr_pontuacao,
					aa.nr_delta,
					aa.nr_linha_base,
					aa.nr_media,
					coalesce(aa.ie_tipo_cuidado,'X'),
					aa.dt_pontuacao
			INTO STRICT	nr_pontuacao_w,
					nr_delta_w,
					nr_linha_base_w,
					nr_media_w,
					ie_severidade_w,
					dt_pontuacao_w
			FROM	automated_acuity aa
			WHERE	aa.nr_atendimento = nr_atendimento_p
			AND 	aa.nr_sequencia = (
						SELECT	MAX(aa_sub.nr_sequencia)
						FROM 	automated_acuity aa_sub
						WHERE 	aa_sub.nr_atendimento = aa.nr_atendimento
					);

					BEGIN
						SELECT 	COUNT(*)
						INTO STRICT 	nr_override_w
						FROM 	automated_acuity_override
						WHERE 	nr_atendimento = nr_atendimento_p;

						IF nr_override_w > 0 THEN
							SELECT 	ie_tipo_cuidado
							INTO STRICT 	ie_severidade_penultimo_w
							FROM (SELECT row_number() OVER () AS RN,
									 ie_tipo_cuidado
							   FROM (SELECT ie_tipo_cuidado
								  FROM automated_acuity
								  WHERE nr_atendimento = nr_atendimento_p
								  ORDER BY dt_pontuacao DESC, nr_sequencia DESC) alias0 LIMIT 2) alias1
							WHERE RN = 1;
						END IF;

                    EXCEPTION
                    WHEN OTHERS THEN
						ie_severidade_penultimo_w := 'A';
					END;

				begin
				  exec_w := 'CALL CLINICAL_PANORAMA_MD_PCK.GET_IE_SEVERIDADE(:1,:2,:3) INTO :result';
				  EXECUTE EXEC_W USING IN reg_c1.ie_escala_acuidade,
												 IN nr_pontuacao_w,
												 IN ie_severidade_w,
												 OUT ie_severidade_w;

				exception
				when others then
				  ie_severidade_w := 'X';
				end;

                CASE ie_severidade_w
                WHEN 'H' THEN cd_exp_severidade_w:=1138878;
                WHEN 'M' THEN cd_exp_severidade_w:=1138879;
                WHEN 'L' THEN cd_exp_severidade_w:=1138880;
                ELSE cd_exp_severidade_w := cd_exp_default_w;
                END CASE;

				CASE ie_severidade_penultimo_w
					WHEN 'H' THEN cd_exp_severidade_penultimo_w:=1138878;
					WHEN 'M' THEN cd_exp_severidade_penultimo_w:=1138879;
					WHEN 'L' THEN cd_exp_severidade_penultimo_w:=1138880;
					ELSE cd_exp_severidade_penultimo_w:=0;
				END CASE;

            EXCEPTION
                WHEN OTHERS THEN
               CALL search_panorama_content.insert_severidade_alg_data(0,0,0,0,'X',0,'S',cd_exp_default_w,cd_exp_default_w,reg_c1.ie_escala_acuidade,0, null, null);
               RETURN NEXT  current_setting('search_panorama_content.t_objeto_severidade_alg_row_w'::t_objeto_severidade_alg_row );
               GOTO continue_loop;
            END;

            BEGIN
                SELECT 	rod.nr_pontuacao,
						rod.ie_categoria
                INTO STRICT	nr_pontuacao_rod_w,
						ie_categoria_rod_w
                FROM	risk_of_death rod
                WHERE	rod.nr_atendimento = nr_atendimento_p
                AND 	rod.nr_sequencia = (
							SELECT	MAX(rod_sub.nr_sequencia)
							FROM	risk_of_death rod_sub
							WHERE	rod_sub.nr_atendimento = rod.nr_atendimento
						);

				FOR reg_c3 IN curso3(nr_atendimento_p) LOOP
					nr_pontuacao_ror_w := reg_c3.nr_pontuacao;
				END LOOP;

				begin
				exec_w := 'CALL CLINICAL_PANORAMA_MD_PCK.GET_RISK_OF_DEATH_CATEGORY(:1) INTO :result';
				EXECUTE EXEC_W USING  IN  ie_categoria_rod_w,
												OUT ie_categoria_rod_w;

				exception
				when others then
				ie_categoria_rod_w := 'X';
				end;

            EXCEPTION
			WHEN OTHERS THEN
				CALL search_panorama_content.insert_severidade_alg_data(nr_pontuacao_w,nr_delta_w,nr_linha_base_w,nr_media_w,ie_severidade_w,0,'S',cd_exp_severidade_w,0,reg_c1.ie_escala_acuidade, nr_pontuacao_ror_w, null, null);
				RETURN NEXT  current_setting('search_panorama_content.t_objeto_severidade_alg_row_w'::t_objeto_severidade_alg_row );
				GOTO continue_loop;
            END;

      ELSIF reg_c1.ie_escala_acuidade = 'EWS' THEN
			ie_severidade_w  := '';
  			cd_exp_default_w := 1198291;
            BEGIN
                SELECT
                    ew.nr_pontuacao,
                    ew.nr_delta,
                    ew.nr_linha_base,
                    coalesce(ew.ie_severidade,'X'),
					ew.dt_pontuacao
                INTO STRICT
                    nr_pontuacao_w,
                    nr_delta_w,
                    nr_linha_base_w,
                    ie_severidade_w,
					dt_pontuacao_w
                FROM
                    early_warning ew
                WHERE
                    ew.nr_atendimento = nr_atendimento_p
                    AND ew.nr_sequencia = (
                        SELECT
                            MAX(ew_sub.nr_sequencia)
                        FROM
                            early_warning ew_sub
                        WHERE
                            ew_sub.nr_atendimento = ew.nr_atendimento);

				begin
				  exec_w := 'CALL CLINICAL_PANORAMA_MD_PCK.GET_IE_SEVERIDADE(:1,:2,:3) INTO :result';
				  EXECUTE EXEC_W USING IN reg_c1.ie_escala_acuidade,
												 IN nr_pontuacao_w,
												 IN ie_severidade_w,
												 OUT ie_severidade_w;

				exception
				when others then
				  ie_severidade_w := 'X';
				end;

                CASE ie_severidade_w
                WHEN 'S' THEN cd_exp_severidade_w:=1138881;
                WHEN 'M' THEN cd_exp_severidade_w:=1138882;
                WHEN 'N' THEN cd_exp_severidade_w:=1138883;
                ELSE cd_exp_severidade_w := cd_exp_default_w;
                END CASE;

              EXCEPTION
                WHEN OTHERS THEN
                    CALL search_panorama_content.insert_severidade_alg_data(0,0,0,0,'X',0,'S',cd_exp_default_w,cd_exp_default_w,reg_c1.ie_escala_acuidade,0, null, null);
                    RETURN NEXT current_setting('search_panorama_content.t_objeto_severidade_alg_row_w'::t_objeto_severidade_alg_row );
                    GOTO continue_loop;
            END;
      ELSIF reg_c1.ie_escala_acuidade = 'SAPS II' THEN
			ie_severidade_w  := '';
			cd_exp_default_w := 1193697;
            BEGIN
                SELECT
                    sa.qt_saps,
					(select obter_pontuacao_telehealth(nr_atendimento_p, 'escala_saps', 'qt_saps', 'dt_avaliacao', 1) ) -
					(select obter_pontuacao_telehealth(nr_atendimento_p, 'escala_saps', 'qt_saps', 'dt_avaliacao', 2) ) nr_delta_saps,
					sa.dt_avaliacao
                INTO STRICT
                nr_pontuacao_w,
				nr_delta_w,
				dt_pontuacao_w
                FROM
                escala_saps sa
                WHERE
                sa.ie_situacao = 'A'
                AND sa.nr_atendimento = nr_atendimento_p
                AND sa.nr_sequencia =(
                    SELECT
                        MAX(sa_sub.nr_sequencia)
                    FROM
                        escala_saps sa_sub
                    WHERE
                        sa_sub.nr_atendimento = sa.nr_atendimento);

				begin
					exec_w := 'CALL CLINICAL_PANORAMA_MD_PCK.GET_IE_SEVERIDADE(:1,:2,:3) INTO :result';
					EXECUTE EXEC_W USING IN reg_c1.ie_escala_acuidade,
												 IN nr_pontuacao_w,
												 IN ie_severidade_w,
												 OUT ie_severidade_w;
				exception
				when others then
					ie_severidade_w := 'X';
				end;

				IF ie_severidade_w = 'H' THEN
					cd_exp_severidade_w := 1138884;
				ELSIF ie_severidade_w = 'L' THEN
					cd_exp_severidade_w := 1138886;
				ELSIF ie_severidade_w = 'M' THEN
					cd_exp_severidade_w := 1138885;
				END IF;
				
            EXCEPTION
                WHEN OTHERS THEN
                    CALL search_panorama_content.insert_severidade_alg_data(0,0,0,0,'X',0,'S',cd_exp_default_w,cd_exp_default_w,reg_c1.ie_escala_acuidade,0, null, null);
                    RETURN NEXT  current_setting('search_panorama_content.t_objeto_severidade_alg_row_w'::t_objeto_severidade_alg_row );
                    GOTO continue_loop;
            END;
      ELSIF reg_c1.ie_escala_acuidade = 'PEWS' THEN
			ie_severidade_w  := '';
			cd_exp_default_w := 1193698;
            BEGIN
                SELECT  pews.qt_pontuacao,
						obter_pontuacao_telehealth(nr_atendimento_p, 'escala_pews', 'qt_pontuacao', 'dt_avaliacao', 1) -
						obter_pontuacao_telehealth(nr_atendimento_p, 'escala_pews', 'qt_pontuacao', 'dt_avaliacao', 2) nr_delta_pews,
						pews.dt_avaliacao
                   INTO STRICT
                        nr_pontuacao_w,
						nr_delta_w,
						dt_pontuacao_w
                FROM escala_pews pews
                WHERE pews.nr_atendimento = nr_atendimento_p
				AND (pews.dt_liberacao IS NOT NULL AND pews.dt_liberacao::text <> '')
                AND pews.nr_sequencia = (
                        SELECT
                            MAX(pews_sub.nr_sequencia)
                            FROM escala_pews pews_sub
                            WHERE pews_sub.nr_atendimento = pews.nr_atendimento
							AND (pews_sub.dt_liberacao IS NOT NULL AND pews_sub.dt_liberacao::text <> ''));

				cd_exp_severidade_w := cd_exp_default_w;
				ie_severidade_w		:= 'X';

				begin
					exec_w := 'CALL CLINICAL_PANORAMA_MD_PCK.GET_IE_SEVERIDADE(:1,:2,:3) INTO :result';
					EXECUTE EXEC_W USING 	 IN reg_c1.ie_escala_acuidade,
													 IN nr_pontuacao_w,
													 IN ie_severidade_w,
													 OUT ie_severidade_w;
				exception
				when others then
					ie_severidade_w := 'X';
				end;

				IF ie_severidade_w = 'L' THEN
					cd_exp_severidade_w := 1138889;
				ELSIF ie_severidade_w = 'M'  THEN
					cd_exp_severidade_w := 1138888;
				ELSIF ie_severidade_w = 'H' THEN
					cd_exp_severidade_w := 1138887;
				END IF;
				
            EXCEPTION
               WHEN OTHERS THEN
                    CALL search_panorama_content.insert_severidade_alg_data(0,0,0,0,'X',0,'S',cd_exp_default_w,cd_exp_default_w,reg_c1.ie_escala_acuidade,0, null, null);
                    RETURN NEXT  current_setting('search_panorama_content.t_objeto_severidade_alg_row_w'::t_objeto_severidade_alg_row );
                    GOTO continue_loop;
            END;
      ELSIF reg_c1.ie_escala_acuidade = 'APACHE II' THEN
			ie_severidade_w  := '';
			cd_exp_default_w := 1180213;
            BEGIN
                SELECT  ap2.QT_APACHE_II,
						(select obter_pontuacao_telehealth(nr_atendimento_p, 'apache', 'qt_apache_ii', 'dt_apache', 1) ) -
						(select obter_pontuacao_telehealth(nr_atendimento_p, 'apache', 'qt_apache_ii', 'dt_apache', 2) ) nr_delta_apache2,
						ap2.dt_apache
                   INTO STRICT
                        nr_pontuacao_w,
						nr_delta_w,
						dt_pontuacao_w
                FROM APACHE ap2
                WHERE ap2.nr_atendimento = nr_atendimento_p
				AND (ap2.dt_liberacao IS NOT NULL AND ap2.dt_liberacao::text <> '')
                AND ap2.nr_sequencia = (
                        SELECT
                            MAX(ap2_sub.nr_sequencia)
                            FROM APACHE ap2_sub
                            WHERE ap2_sub.nr_atendimento = ap2.nr_atendimento
							AND (ap2_sub.dt_liberacao IS NOT NULL AND ap2_sub.dt_liberacao::text <> ''))
				order by ap2.DT_APACHE desc LIMIT 1;

				cd_exp_severidade_w := 1180213;
				ie_severidade_w 	:= 'X';

            EXCEPTION
               WHEN OTHERS THEN
                    CALL search_panorama_content.insert_severidade_alg_data(0,0,0,0,'X',0,'S',cd_exp_default_w,cd_exp_default_w,reg_c1.ie_escala_acuidade,0, null, null);
                    RETURN NEXT  current_setting('search_panorama_content.t_objeto_severidade_alg_row_w'::t_objeto_severidade_alg_row );
                    GOTO continue_loop;
            END;
      ELSIF reg_c1.ie_escala_acuidade = 'SOFA' THEN
			ie_severidade_w  := '';
			cd_exp_default_w := 1180217;
            BEGIN
                SELECT  sofa.QT_PONTUACAO,
						(select obter_pontuacao_telehealth(nr_atendimento_p, 'escala_sofa', 'qt_pontuacao', 'dt_avaliacao', 1) ) -
						(select obter_pontuacao_telehealth(nr_atendimento_p, 'escala_sofa', 'qt_pontuacao', 'dt_avaliacao', 2) ) nr_delta_sofa,
						sofa.dt_avaliacao
                   INTO STRICT
                        nr_pontuacao_w,
						nr_delta_w,
						dt_pontuacao_w
                FROM ESCALA_SOFA sofa
                WHERE 	sofa.nr_atendimento = nr_atendimento_p
				AND 	(sofa.dt_liberacao IS NOT NULL AND sofa.dt_liberacao::text <> '')
                AND sofa.nr_sequencia = (
                        SELECT
                            MAX(sofa_sub.nr_sequencia)
                            FROM ESCALA_SOFA sofa_sub
                            WHERE sofa_sub.nr_atendimento = sofa.nr_atendimento
							AND	(sofa_sub.dt_liberacao IS NOT NULL AND sofa_sub.dt_liberacao::text <> ''))
				order by sofa.DT_AVALIACAO desc LIMIT 1;

				cd_exp_severidade_w := 1180217;
				ie_severidade_w 	:= 'X';

            EXCEPTION
               WHEN OTHERS THEN
                    CALL search_panorama_content.insert_severidade_alg_data(0,0,0,0,'X',0,'S',cd_exp_default_w,cd_exp_default_w,reg_c1.ie_escala_acuidade,0, null, null);
                    RETURN NEXT  current_setting('search_panorama_content.t_objeto_severidade_alg_row_w'::t_objeto_severidade_alg_row );
                    GOTO continue_loop;
            END;
      ELSIF reg_c1.ie_escala_acuidade = 'SCORE FLEX' THEN
			ie_severidade_w  := '';
			cd_exp_default_w := 1069291;
            BEGIN
                if (reg_c1.nr_seq_score_flex IS NOT NULL AND reg_c1.nr_seq_score_flex::text <> '') then
                   SELECT
                          eif.ds_escala
                   INTO STRICT
                          ds_exp_scoreflex_w
                   FROM
                          eif_escala eif
                   WHERE
                          eif.nr_sequencia = reg_c1.nr_seq_score_flex;
                end if;

				SELECT qt_pontos, nr_delta_score_flex, ds_escala, dt_avaliacao
				INTO STRICT
				nr_pontuacao_w,
				nr_delta_w,
				ds_exp_scoreflex_w,
				dt_pontuacao_w
				FROM
				(SELECT (select substr(obter_resultado_escala_eif(eif.nr_sequencia,'T'),1,255) ) qt_pontos,
					((select obter_pontuacao_score_flex(nr_atendimento_p, 'escala_eif', 'qt_pontos', reg_c1.nr_seq_score_flex, 'dt_avaliacao', 1) ) -
					(select obter_pontuacao_score_flex(nr_atendimento_p, 'escala_eif', 'qt_pontos', reg_c1.nr_seq_score_flex, 'dt_avaliacao', 2) ) ) nr_delta_score_flex,
						eie.ds_escala,
						eif.dt_avaliacao
					FROM ESCALA_EIF eif, eif_escala eie
					WHERE eif.nr_atendimento = nr_atendimento_p
					and eif.nr_seq_escala = eie.nr_sequencia
					AND (eif.dt_liberacao IS NOT NULL AND eif.dt_liberacao::text <> '')
					and nr_seq_escala = reg_c1.nr_seq_score_flex
					order by eif.DT_AVALIACAO desc, eif.NR_SEQUENCIA desc) alias9 LIMIT 1;

				cd_exp_severidade_w := 1180215;
				ie_severidade_w 	:= 'X';

            EXCEPTION
               WHEN OTHERS THEN
                    CALL search_panorama_content.insert_severidade_alg_data(0,0,0,0,'X',0,'S',cd_exp_default_w,cd_exp_default_w,reg_c1.ie_escala_acuidade,0, ds_exp_scoreflex_w, null);
                    RETURN NEXT  current_setting('search_panorama_content.t_objeto_severidade_alg_row_w'::t_objeto_severidade_alg_row );
                    GOTO continue_loop;
            END;
      ELSIF reg_c1.ie_escala_acuidade = 'MEWS' THEN
			ie_severidade_w  := '';
			cd_exp_default_w := 1180214;
            BEGIN
                SELECT  mews.qt_pontuacao,
						(select obter_pontuacao_telehealth(nr_atendimento_p, 'escala_mews', 'qt_pontuacao', 'dt_avaliacao', 1) ) -
						(select obter_pontuacao_telehealth(nr_atendimento_p, 'escala_mews', 'qt_pontuacao', 'dt_avaliacao', 2) ) nr_delta_mews,
						mews.dt_avaliacao
                   INTO STRICT
                        nr_pontuacao_w,
						nr_delta_w,
						dt_pontuacao_w
                FROM ESCALA_MEWS mews
                WHERE mews.nr_atendimento = nr_atendimento_p
				AND (mews.dt_liberacao IS NOT NULL AND mews.dt_liberacao::text <> '')
                AND mews.nr_sequencia = (
                        SELECT
                            MAX(mews_sub.nr_sequencia)
                            FROM ESCALA_MEWS mews_sub
                            WHERE mews_sub.nr_atendimento = mews.nr_atendimento
							AND (mews_sub.dt_liberacao IS NOT NULL AND mews_sub.dt_liberacao::text <> ''))
				order by mews.DT_AVALIACAO desc LIMIT 1;

				cd_exp_severidade_w := cd_exp_default_w;
				ie_severidade_w 	:= 'X';

				begin
				  exec_w := 'CALL CLINICAL_PANORAMA_MD_PCK.GET_IE_SEVERIDADE(:1,:2,:3) INTO :result';
				  EXECUTE EXEC_W USING IN reg_c1.ie_escala_acuidade,
												 IN nr_pontuacao_w,
												 IN ie_severidade_w,
												 OUT ie_severidade_w;

				exception
				when others then
				  ie_severidade_w := 'X';
				end;

				IF ie_severidade_w = 'L' THEN
					cd_exp_severidade_w := 1190138;
				ELSIF ie_severidade_w = 'M'  THEN
					cd_exp_severidade_w := 1190139;
				ELSIF ie_severidade_w = 'H' THEN
					cd_exp_severidade_w := 1190140;
				END IF;
				
            EXCEPTION
               WHEN OTHERS THEN
                    CALL search_panorama_content.insert_severidade_alg_data(0,0,0,0,'X',0,'S',cd_exp_default_w,cd_exp_default_w,reg_c1.ie_escala_acuidade,0, null, null);
                    RETURN NEXT  current_setting('search_panorama_content.t_objeto_severidade_alg_row_w'::t_objeto_severidade_alg_row );
                    GOTO continue_loop;
            END;
		  ELSIF reg_c1.ie_escala_acuidade = 'SCORE FLEX2' THEN
			ie_severidade_w  := '';
			cd_exp_default_w := 1069676;
            BEGIN
                if (reg_c1.nr_seq_score_flex IS NOT NULL AND reg_c1.nr_seq_score_flex::text <> '') then
                   SELECT
                          eie.ds_escala
                   INTO STRICT
                          ds_exp_scoreflex_w
                   FROM
                          eif_escala_ii eie
                   WHERE
                          eie.nr_sequencia = reg_c1.nr_seq_score_flex;
                end if;

                SELECT  eif2.QT_PONTOS,
						            (select obter_pontuacao_score_flex(nr_atendimento_p, 'escala_eif_ii', 'qt_pontos', reg_c1.nr_seq_score_flex, 'dt_avaliacao', 1) ) -
						            (select obter_pontuacao_score_flex(nr_atendimento_p, 'escala_eif_ii', 'qt_pontos', reg_c1.nr_seq_score_flex, 'dt_avaliacao', 2) ) nr_delta_score_flex_ii,
                        eie.ds_escala,
						eif2.dt_avaliacao
                INTO STRICT	nr_pontuacao_w,
						nr_delta_w,
						ds_exp_scoreflex_w,
						dt_pontuacao_w
                FROM 	ESCALA_EIF_II eif2,
						eif_escala_ii eie
                WHERE 	eif2.nr_atendimento = nr_atendimento_p
                and 	eif2.nr_seq_escala 	= eie.nr_sequencia
                AND 	(eif2.dt_liberacao IS NOT NULL AND eif2.dt_liberacao::text <> '') 
                and 	nr_seq_escala = reg_c1.nr_seq_score_flex
                AND 	eif2.DT_AVALIACAO IN (SELECT MAX(DT_AVALIACAO) FROM escala_eif_ii ESCA
                                        WHERE nr_atendimento = nr_atendimento_p
                                        AND nr_seq_escala = reg_c1.nr_seq_score_flex)
                order by eif2.DT_AVALIACAO desc, eif2.NR_SEQUENCIA desc LIMIT 1;

				cd_exp_severidade_w := 1180453;
				ie_severidade_w 	:= 'X';

            EXCEPTION
               WHEN OTHERS THEN
                    CALL search_panorama_content.insert_severidade_alg_data(0,0,0,0,'X',0,'S',cd_exp_default_w,cd_exp_default_w,reg_c1.ie_escala_acuidade,0, ds_exp_scoreflex_w, null);
                    RETURN NEXT  current_setting('search_panorama_content.t_objeto_severidade_alg_row_w'::t_objeto_severidade_alg_row );
                    GOTO continue_loop;
            END;
      ELSE
            nr_pontuacao_w := 0;
            --nr_delta_w := 0;
            ie_severidade_w := 'S';
            cd_exp_severidade_w:=0;
        END IF;
        CALL search_panorama_content.insert_severidade_alg_data(nr_pontuacao_w,nr_delta_w,nr_linha_base_w,nr_media_w,ie_severidade_w,nr_pontuacao_rod_w,ie_categoria_rod_w,cd_exp_severidade_w,cd_exp_severidade_penultimo_w, reg_c1.ie_escala_acuidade, nr_pontuacao_ror_w, ds_exp_scoreflex_w, dt_pontuacao_w);
        RETURN NEXT  current_setting('search_panorama_content.t_objeto_severidade_alg_row_w'::t_objeto_severidade_alg_row );

      <<continue_loop>>
      NULL;

    END LOOP;

    IF ( qtd_rows = 0 ) THEN
        CALL search_panorama_content.insert_severidade_alg_data(0,0,0,0,'S');
        RETURN NEXT  current_setting('search_panorama_content.t_objeto_severidade_alg_row_w'::t_objeto_severidade_alg_row );
    END IF;
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION search_panorama_content.get_severidade_algoritimo_pan (cd_setor_atendimento_p bigint, nr_atendimento_p bigint, ie_escala_acuidade_p text default null, nr_seq_score_flex_p text default null) FROM PUBLIC;
