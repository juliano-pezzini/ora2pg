-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION patient_billing_tree_pck.get_tree_itens (cd_pessoa_fisica_p pessoa_fisica.cd_pessoa_fisica%type, nr_seq_episodio_p episodio_paciente.nr_sequencia%type, nr_atendimento_p atendimento_paciente.nr_atendimento%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, cd_perfil_p perfil.cd_perfil%type, nm_usuario_p usuario.nm_usuario%type) RETURNS SETOF T_TREE_ITEM AS $body$
DECLARE


	r_tree_item_w		r_tree_item;
	qt_registro_w		bigint;

	c01 CURSOR FOR
	SELECT	vl_dominio cd,
		ds_expressao ds,
		1094964 tree_node,
		5 ie_ordem
	from	valor_dominio_v
	where	cd_dominio		= 8978
	and	vl_dominio	= 'AT'
	
union

	SELECT	vl_dominio cd,
		ds_expressao ds,
		1094745 tree_node,
		10 ie_ordem
	from	valor_dominio_v
	where	cd_dominio		= 8978
	and	vl_dominio	= 'CT'
	
union

	select	vl_dominio cd,
		ds_expressao ds,
		1094749 tree_node,
		15 ie_ordem
	from	valor_dominio_v
	where	cd_dominio		= 8978
	and	vl_dominio	= 'DIAG'
	/*union
	select	vl_dominio cd,
		ds_expressao ds,
		1094745 tree_node,
		20 ie_ordem
	from	valor_dominio_v
	where	cd_dominio		= 8978
	and	vl_dominio	= 'PROC'*/
	
union

	select	vl_dominio cd,
		ds_expressao ds,
		1094748 tree_node,
		30 ie_ordem
	from	valor_dominio_v
	where	cd_dominio		= 8978
	and	ds_valor_dominio	= 'DRG'
	
union

	select	vl_dominio cd,
		ds_expressao ds,
		1094750 tree_node,
		40 ie_ordem
	from	valor_dominio_v
	where	cd_dominio		= 8978
	and	vl_dominio	= 'AAT'
	order by ie_ordem;

	c01_w	c01%rowtype;

	
BEGIN

		if (cd_pessoa_fisica_p IS NOT NULL AND cd_pessoa_fisica_p::text <> '') or (nr_seq_episodio_p IS NOT NULL AND nr_seq_episodio_p::text <> '') or (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') then

			r_tree_item_w.nr_seq_episodio	:= nr_seq_episodio_p;
			r_tree_item_w.nr_atendimento	:= nr_atendimento_p;
			r_tree_item_w.cd_pessoa_fisica	:= cd_pessoa_fisica_p;
			r_tree_item_w.nr_interno_conta	:= 0;

			open C01;
			loop
			fetch C01 into
				c01_w;
			EXIT WHEN NOT FOUND; /* apply on C01 */

				if (patient_billing_tree_pck.obter_se_mostra_item(c01_w.cd, nr_seq_episodio_p, nr_atendimento_p, cd_estabelecimento_p, cd_perfil_p, nm_usuario_p) = 'S') then

					r_tree_item_w.ie_item		:= c01_w.cd;
					r_tree_item_w.ds_item		:= c01_w.ds;
					r_tree_item_w.tree_node		:= c01_w.tree_node;
					r_tree_item_w.ie_ordem		:= c01_w.ie_ordem;

					RETURN NEXT r_tree_item_w;
				end if;
			end loop;
			close C01;

			if (patient_billing_tree_pck.obter_se_itens_excluidos(cd_pessoa_fisica_p, nr_seq_episodio_p, nr_atendimento_p) and (coalesce(nr_seq_episodio_p,0) > 0 and coalesce(nr_atendimento_p,0) > 0)) then

				r_tree_item_w.ie_item		:= 'EXC';
				r_tree_item_w.ds_item		:= obter_desc_expressao(308459);
				r_tree_item_w.tree_node		:= 1096205;
				r_tree_item_w.ie_ordem		:= 13;
				RETURN NEXT r_tree_item_w;
			end if;
		end if;

	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION patient_billing_tree_pck.get_tree_itens (cd_pessoa_fisica_p pessoa_fisica.cd_pessoa_fisica%type, nr_seq_episodio_p episodio_paciente.nr_sequencia%type, nr_atendimento_p atendimento_paciente.nr_atendimento%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, cd_perfil_p perfil.cd_perfil%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;
