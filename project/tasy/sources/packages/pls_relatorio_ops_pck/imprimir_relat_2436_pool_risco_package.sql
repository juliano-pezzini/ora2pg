-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pls_relatorio_ops_pck.imprimir_relat_2436_pool_risco ( ie_tipo_p text, nr_seq_contrato_p pls_contrato.nr_sequencia%type, dt_contratacao_p text ) RETURNS SETOF T_RELAT_2436_POOL_RISCO_DATA AS $body$
DECLARE

	/*
	* ie_tipo_p:
	*	V: Número de vidas
	*	D: Despesa Assistencial
	*	R: Recuperação de co-participação
	*	C: Contraprestação pecuniárias
	*
	*/
	t_relat_2436_pool_risco_row_w	t_relat_2436_pool_risco_row;
	t_limpar_variavel_w		t_relat_2436_pool_risco_row;
	valor_w				double precision;
	nr_seq_contrato_w		pls_contrato.nr_sequencia%type;
	contador_w			integer;
	total_w				double precision;

	C01 CURSOR(	nr_seq_contrato_pc	pls_contrato.nr_sequencia%type) FOR
		SELECT	a.nr_contrato,
			a.nr_sequencia nr_seq_contrato,
			CASE WHEN coalesce(a.cd_cgc_estipulante::text, '') = '' THEN a.cd_pf_estipulante  ELSE a.cd_cgc_estipulante END  cd_estipulante,
			substr(obter_nome_pf_pj(cd_pf_estipulante, cd_cgc_estipulante),1,200) nm_pessoa_fisica
		from 	pls_contrato a
		where	((nr_seq_contrato_pc <> 0 AND a.nr_sequencia = nr_seq_contrato_pc)
		     or ((nr_seq_contrato_pc = 0) and (29 <= (	SELECT	count(1)
								from 	pls_contrato x,
									pls_segurado y
								where 	y.nr_seq_contrato = x.nr_sequencia
								and	trunc(y.dt_contratacao,'month')	<= trunc(to_date('01/'|| dt_contratacao_p),'month')
								and	((coalesce(y.dt_rescisao::text, '') = '') or (trunc(y.dt_rescisao,'month') > trunc(to_date('01/'|| dt_contratacao_p),'month')))))))
		and 	exists (	select 	1
					from	pls_contrato_plano d,
						pls_plano e
					where	a.nr_sequencia = d.nr_seq_contrato
					and	d.nr_seq_plano = e.nr_sequencia
					and	e.ie_tipo_contratacao in ('CA','CE'));

	C02 CURSOR(	dt_contratacao_pc 	mes_v.dt_mes%type) FOR
		SELECT	dt_mes
		from	mes_v
		where	dt_mes >= dt_contratacao_pc  LIMIT 12;
	
BEGIN
	for r_c01_w in C01(nr_seq_contrato_p) loop
		begin
		contador_w := 0;
		total_w := 0;
		t_relat_2436_pool_risco_row_w 				:= t_limpar_variavel_w;
		t_relat_2436_pool_risco_row_w.nr_contrato		:= r_c01_w.nr_contrato;
		t_relat_2436_pool_risco_row_w.cd_cgc_estipulante	:= r_c01_w.cd_estipulante;
		t_relat_2436_pool_risco_row_w.nm_pessoa_fisica		:= r_c01_w.nm_pessoa_fisica;
		for r_c02_w in C02(to_date('01/'||dt_contratacao_p)) loop
			begin
			contador_w := contador_w + 1;
			valor_w := 0;

			if (ie_tipo_p = 'V') then
				select	count(1)
				into STRICT	valor_w
				from	pls_contrato a,
					pls_segurado b
				where	b.nr_seq_contrato = a.nr_sequencia
				and	a.nr_sequencia = r_c01_w.nr_seq_contrato
				and	trunc(b.dt_contratacao,'month')	<= trunc(r_c02_w.dt_mes,'month')
				and	((coalesce(b.dt_rescisao::text, '') = '') or (trunc(b.dt_rescisao,'month') > trunc(r_c02_w.dt_mes,'month')));
			elsif (ie_tipo_p = 'D') then
				select	sum(c.vl_total)
				into STRICT	valor_w
				from	pls_contrato a,
					pls_segurado b,
					pls_conta c,
					pls_protocolo_conta d
				where	b.nr_seq_contrato = a.nr_sequencia
				and	c.nr_seq_segurado = b.nr_sequencia
				and	c.nr_seq_protocolo = d.nr_sequencia
				and	a.nr_sequencia = r_c01_w.nr_seq_contrato
				and	trunc(d.dt_mes_competencia,'month')	= trunc(r_c02_w.dt_mes,'month');
			elsif (ie_tipo_p = 'R') then
				select	sum(d.vl_coparticipacao)
				into STRICT	valor_w
				from	pls_contrato a,
					pls_segurado b,
					pls_conta c,
					pls_conta_coparticipacao d,
					pls_mensalidade_segurado e,
					pls_mensalidade f
				where	b.nr_seq_contrato = a.nr_sequencia
				and	c.nr_seq_segurado = b.nr_sequencia
				and	d.nr_seq_conta = c.nr_sequencia
				and	d.nr_seq_mensalidade_seg = e.nr_sequencia
				and	e.nr_seq_mensalidade = f.nr_sequencia
				and	a.nr_sequencia = r_c01_w.nr_seq_contrato
				and	trunc(f.dt_referencia,'month')	= trunc(r_c02_w.dt_mes,'month');
			elsif (ie_tipo_p = 'C') then
				select	sum(e.vl_item)
				into STRICT	valor_w
				from	pls_contrato a,
					pls_segurado b,
					pls_mensalidade c,
					pls_mensalidade_segurado d,
					pls_mensalidade_seg_item e
				where	b.nr_seq_contrato = a.nr_sequencia
				and	d.nr_seq_segurado = b.nr_sequencia
				and	d.nr_seq_mensalidade = c.nr_sequencia
				and	e.nr_seq_mensalidade_seg = d.nr_sequencia
				and	e.ie_tipo_item <> '3'
				and	a.nr_sequencia = r_c01_w.nr_seq_contrato
				and	trunc(c.dt_referencia,'month')	= trunc(r_c02_w.dt_mes,'month');
			end if;
			if (contador_w = 1) then
				t_relat_2436_pool_risco_row_w.valor1	:= coalesce(valor_w,0);
				t_relat_2436_pool_risco_row_w.mes1 	:= obter_mes_extenso(to_char(trunc(r_c02_w.dt_mes,'month'),'mm'),'A') ||'-'||to_char(trunc(r_c02_w.dt_mes,'year'),'yyyy');
			elsif (contador_w = 2) then
				t_relat_2436_pool_risco_row_w.valor2	:= coalesce(valor_w,0);
				t_relat_2436_pool_risco_row_w.mes2 	:= obter_mes_extenso(to_char(trunc(r_c02_w.dt_mes,'month'),'mm'),'A') ||'-'||to_char(trunc(r_c02_w.dt_mes,'year'),'yyyy');
			elsif (contador_w = 3) then
				t_relat_2436_pool_risco_row_w.valor3	:= coalesce(valor_w,0);
				t_relat_2436_pool_risco_row_w.mes3 	:= obter_mes_extenso(to_char(trunc(r_c02_w.dt_mes,'month'),'mm'),'A') ||'-'||to_char(trunc(r_c02_w.dt_mes,'year'),'yyyy');
			elsif (contador_w = 4) then
				t_relat_2436_pool_risco_row_w.valor4	:= coalesce(valor_w,0);
				t_relat_2436_pool_risco_row_w.mes4 	:= obter_mes_extenso(to_char(trunc(r_c02_w.dt_mes,'month'),'mm'),'A') ||'-'||to_char(trunc(r_c02_w.dt_mes,'year'),'yyyy');
			elsif (contador_w = 5) then
				t_relat_2436_pool_risco_row_w.valor5	:= coalesce(valor_w,0);
				t_relat_2436_pool_risco_row_w.mes5 	:= obter_mes_extenso(to_char(trunc(r_c02_w.dt_mes,'month'),'mm'),'A') ||'-'||to_char(trunc(r_c02_w.dt_mes,'year'),'yyyy');
			elsif (contador_w = 6) then
				t_relat_2436_pool_risco_row_w.valor6	:= coalesce(valor_w,0);
				t_relat_2436_pool_risco_row_w.mes6 	:= obter_mes_extenso(to_char(trunc(r_c02_w.dt_mes,'month'),'mm'),'A') ||'-'||to_char(trunc(r_c02_w.dt_mes,'year'),'yyyy');
			elsif (contador_w = 7) then
				t_relat_2436_pool_risco_row_w.valor7	:= coalesce(valor_w,0);
				t_relat_2436_pool_risco_row_w.mes7 	:= obter_mes_extenso(to_char(trunc(r_c02_w.dt_mes,'month'),'mm'),'A') ||'-'||to_char(trunc(r_c02_w.dt_mes,'year'),'yyyy');
			elsif (contador_w = 8) then
				t_relat_2436_pool_risco_row_w.valor8	:= coalesce(valor_w,0);
				t_relat_2436_pool_risco_row_w.mes8 	:= obter_mes_extenso(to_char(trunc(r_c02_w.dt_mes,'month'),'mm'),'A') ||'-'||to_char(trunc(r_c02_w.dt_mes,'year'),'yyyy');
			elsif (contador_w = 9) then
				t_relat_2436_pool_risco_row_w.valor9	:= coalesce(valor_w,0);
				t_relat_2436_pool_risco_row_w.mes9 	:= obter_mes_extenso(to_char(trunc(r_c02_w.dt_mes,'month'),'mm'),'A') ||'-'||to_char(trunc(r_c02_w.dt_mes,'year'),'yyyy');
			elsif (contador_w = 10) then
				t_relat_2436_pool_risco_row_w.valor10	:= coalesce(valor_w,0);
				t_relat_2436_pool_risco_row_w.mes10 	:= obter_mes_extenso(to_char(trunc(r_c02_w.dt_mes,'month'),'mm'),'A') ||'-'||to_char(trunc(r_c02_w.dt_mes,'year'),'yyyy');
			elsif (contador_w = 11) then
				t_relat_2436_pool_risco_row_w.valor11	:= coalesce(valor_w,0);
				t_relat_2436_pool_risco_row_w.mes11 	:= obter_mes_extenso(to_char(trunc(r_c02_w.dt_mes,'month'),'mm'),'A') ||'-'||to_char(trunc(r_c02_w.dt_mes,'year'),'yyyy');
			elsif (contador_w = 12) then
				t_relat_2436_pool_risco_row_w.valor12	:= coalesce(valor_w,0);
				t_relat_2436_pool_risco_row_w.mes12 	:= obter_mes_extenso(to_char(trunc(r_c02_w.dt_mes,'month'),'mm'),'A') ||'-'||to_char(trunc(r_c02_w.dt_mes,'year'),'yyyy');
			end if;
			total_w := total_w + coalesce(valor_w,0);
			end;
		end loop;
		t_relat_2436_pool_risco_row_w.total := total_w;

		if (ie_tipo_p = 'V') then
			t_relat_2436_pool_risco_row_w.total := total_w / contador_w;
		end if;

		RETURN NEXT t_relat_2436_pool_risco_row_w;
		end;
	end loop;
	return;
	end;


$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_relatorio_ops_pck.imprimir_relat_2436_pool_risco ( ie_tipo_p text, nr_seq_contrato_p pls_contrato.nr_sequencia%type, dt_contratacao_p text ) FROM PUBLIC;
