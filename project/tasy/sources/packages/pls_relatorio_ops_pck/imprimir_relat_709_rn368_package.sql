-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pls_relatorio_ops_pck.imprimir_relat_709_rn368 ( cd_medico_p pls_conta.cd_medico_executor%type, dt_mes_p timestamp, dt_inicial_p timestamp, dt_final_p timestamp, nr_seq_prestador_p pls_prestador.nr_sequencia%type, cd_cnes_p pessoa_juridica.cd_cnes%type ) RETURNS SETOF T_RELAT_709_RN368_DATA AS $body$
DECLARE


	t_relat_709_rn368_row_w	t_relat_709_rn368_row;
	qtde_normal_w		bigint;
	qtde_cesareo_w		bigint;
	ds_consulta_w		varchar(3000);
	ds_comando_w		varchar(3000);
	qt_total_w			bigint;
	pr_parto_w			double precision;
	
BEGIN
	ds_consulta_w	:= 	'select	count(1) qtde '||
				'from	pls_conta_proc_v	a, '||
				'	pls_itens_rn_parto 	b, '||
				'	pls_regra_rn_parto	c '||
				'where	a.cd_procedimento 	= b.cd_procedimento '||
				'and	a.ie_origem_proced 	= b.ie_origem_proced '||
				'and	b.nr_seq_regra 		= c.nr_sequencia '||
				'and	b.ie_situacao 		= '||chr(39)||'A'||chr(39)||' '||
				'and	a.ie_status_conta 	= '||chr(39)||'F'||chr(39)||' '||
				'and	a.ie_tipo_protocolo 	= '||chr(39)||'C'||chr(39)||' '||
				'and	a.ie_status 		<> '||chr(39)||'D'||chr(39)||' ';

	if (coalesce(cd_medico_p,0) > 0) then
		ds_consulta_w	:= 	ds_consulta_w 	|| 	'and exists ( select 1 from pls_proc_participante d where d.nr_seq_conta_proc = a.nr_sequencia '||
											'and d.cd_medico = '||cd_medico_p||') ';
	end if;

	if (dt_mes_p IS NOT NULL AND dt_mes_p::text <> '') then
		ds_consulta_w	:= ds_consulta_w 	|| 	'and a.dt_procedimento_mes = to_date('||chr(39)||to_char(dt_mes_p)||chr(39)||') ';
	elsif   (dt_inicial_p IS NOT NULL AND dt_inicial_p::text <> '' AND dt_final_p IS NOT NULL AND dt_final_p::text <> '') then
		ds_consulta_w	:= ds_consulta_w 	|| 	'and a.dt_procedimento_mes between to_date('||chr(39)||to_char(dt_inicial_p)||chr(39)||') '||
												      'and to_date('||chr(39)||to_char(dt_final_p)||chr(39)||')  ';
	end if;

	if (coalesce(cd_cnes_p,'0') <> '0') then
		ds_consulta_w	:= ds_consulta_w 	||	' and pls_obter_cnes_prestador(nr_seq_prestador_prot) = ' ||cd_cnes_p || ' ';
	end if;

	if (coalesce(nr_seq_prestador_p,0) <> 0) then
		ds_consulta_w	:= ds_consulta_w 	||	' and nr_seq_prestador_prot = ' ||nr_seq_prestador_p || ' ';
	end if;

        ds_comando_w	:= ds_consulta_w || 'and c.ie_tipo_parto = '||chr(39)||'N'||chr(39);
	EXECUTE ds_comando_w
	into STRICT 	qtde_normal_w;

	ds_comando_w	:= ds_consulta_w || 'and c.ie_tipo_parto = '||chr(39)||'C'||chr(39);

	EXECUTE ds_comando_w
	into STRICT 	qtde_cesareo_w;

	qt_total_w	:= qtde_normal_w + qtde_cesareo_w;

	pr_parto_w	:= dividir_sem_round((qtde_normal_w * 100),qt_total_w);
	t_relat_709_rn368_row_w.qtde	:= pr_parto_w;
	RETURN NEXT t_relat_709_rn368_row_w;
	pr_parto_w	:= dividir_sem_round((qtde_cesareo_w * 100),qt_total_w);
	t_relat_709_rn368_row_w.qtde	:= pr_parto_w;
	RETURN NEXT t_relat_709_rn368_row_w;

	t_relat_709_rn368_row_w.qtde	:= qtde_normal_w + qtde_cesareo_w;
	RETURN NEXT t_relat_709_rn368_row_w;
	return;
	end;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_relatorio_ops_pck.imprimir_relat_709_rn368 ( cd_medico_p pls_conta.cd_medico_executor%type, dt_mes_p timestamp, dt_inicial_p timestamp, dt_final_p timestamp, nr_seq_prestador_p pls_prestador.nr_sequencia%type, cd_cnes_p pessoa_juridica.cd_cnes%type ) FROM PUBLIC;
