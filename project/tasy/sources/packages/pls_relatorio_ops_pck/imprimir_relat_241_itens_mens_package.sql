-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pls_relatorio_ops_pck.imprimir_relat_241_itens_mens ( nr_titulo_p titulo_receber.nr_titulo%type, nm_usuario_p usuario.nm_usuario%type) RETURNS SETOF T_RELAT_ITENS_241_TAB_DATA AS $body$
DECLARE


	qt_registros_benef_w			bigint;
	qt_registros_itens_w			bigint;
	index_w					bigint;
	isReajuste_w				varchar(10) := 'B';

	cd_usuario_plano_w			w_pls_relat_boleto.cd_usuario_plano%type;
	nm_beneficiario_w			w_pls_relat_boleto.nm_pessoa%type;
	dt_contratacao_w			w_pls_relat_boleto.dt_contratacao%type;
	ds_plano_w				w_pls_relat_boleto.ds_plano%type;
	nr_protocolo_ans_w			w_pls_relat_boleto.cd_ans%type;
	ie_tipo_contratacao_w			w_pls_relat_boleto.ie_tipo_contratacao%type;
	ie_participacao_w			w_pls_relat_boleto.ie_participacao%type;
	pr_reajuste_w				w_pls_relat_boleto.tx_tributo%type;

	ie_tipo_item_w				w_pls_relat_boleto.ie_tipo_item%type;
	ds_item_w				w_pls_relat_boleto.ds_item%type;
	qt_item_w				w_pls_relat_boleto.qt_item%type;
	vl_item_w				w_pls_relat_boleto.vl_item%type;

	t_relat_itens_mens_241_tab_w		t_relat_itens_mens_241_tab_row;

	ds_oficio_ans_w				w_pls_relat_boleto.ds_oficio_ans%type;

	
BEGIN
	select	count(1)
	into STRICT	qt_registros_benef_w
	from	w_pls_relat_boleto
	where	nr_titulo 	= nr_titulo_p
	and	nm_usuario 	= nm_usuario_p
	and	ie_banda 	= 'R'
	and	qt_segurado > 0;

	isReajuste_w		:= 'R';

	select	count(1)
	into STRICT	qt_registros_itens_w
	from	w_pls_relat_boleto
	where	nr_titulo 	= nr_titulo_p
	and	nm_usuario 	= nm_usuario_p
	and	ie_banda 	= 'D';

	index_w	:= qt_registros_benef_w;

	for i in 1..index_w loop
		begin

		t_relat_itens_mens_241_tab_w.cd_usuario_plano	:= '';
		t_relat_itens_mens_241_tab_w.nm_beneficiario	:= '';
		t_relat_itens_mens_241_tab_w.DT_CONTRATACAO	:= null;
		t_relat_itens_mens_241_tab_w.DS_PLANO		:= '';
		t_relat_itens_mens_241_tab_w.NR_PROTOCOLO_ANS	:= '';
		t_relat_itens_mens_241_tab_w.pr_reajuste	:= null;
		t_relat_itens_mens_241_tab_w.ie_tipo_contratacao := '';
		t_relat_itens_mens_241_tab_w.ie_participacao	:= '';

		t_relat_itens_mens_241_tab_w.ie_tipo_item	:= '';
		t_relat_itens_mens_241_tab_w.ds_item		:= '';
		t_relat_itens_mens_241_tab_w.qt_itens		:= null;
		t_relat_itens_mens_241_tab_w.vl_total		:= null;
		t_relat_itens_mens_241_tab_w.ds_oficio_ans	:= '';

		if (i <= qt_registros_benef_w) then

			select	cd_usuario_plano,
				nm_pessoa,
				DT_CONTRATACAO,
				DS_PLANO,
				cd_ans,
				ie_tipo_contratacao,
				ie_participacao,
				tx_tributo,
				ds_oficio_ans
			into STRICT	cd_usuario_plano_w,
				nm_beneficiario_w,
				DT_CONTRATACAO_w,
				DS_PLANO_w,
				NR_PROTOCOLO_ANS_w,
				ie_tipo_contratacao_w,
				ie_participacao_w,
				pr_reajuste_w,
				ds_oficio_ans_w
			from (	SELECT	cd_usuario_plano,
						nm_pessoa,
						DT_CONTRATACAO,
						DS_PLANO,
						cd_ans,
						tx_tributo,
						ie_tipo_contratacao,
						ie_participacao,
						ds_oficio_ans,
						row_number() OVER () AS linha
					from	w_pls_relat_boleto
					where	nr_titulo 	= nr_titulo_p
					and	nm_usuario 	= nm_usuario_p
					and	ie_banda 	= isReajuste_w
					and	qt_segurado 	> 0) alias1
			where	linha	= i;


			t_relat_itens_mens_241_tab_w.cd_usuario_plano	:= cd_usuario_plano_w;
			t_relat_itens_mens_241_tab_w.nm_beneficiario	:= nm_beneficiario_w;
			t_relat_itens_mens_241_tab_w.DT_CONTRATACAO	:= DT_CONTRATACAO_w;
			t_relat_itens_mens_241_tab_w.DS_PLANO		:= DS_PLANO_w;
			t_relat_itens_mens_241_tab_w.NR_PROTOCOLO_ANS	:= NR_PROTOCOLO_ANS_w;
			t_relat_itens_mens_241_tab_w.ds_oficio_ans	:= ds_oficio_ans_w;
			t_relat_itens_mens_241_tab_w.ie_tipo_contratacao := ie_tipo_contratacao_w;
			t_relat_itens_mens_241_tab_w.ie_participacao	:= ie_participacao_w;
			t_relat_itens_mens_241_tab_w.pr_reajuste	:= pr_reajuste_w;
		end if;


		if (i <= qt_registros_itens_w) then

			select	ie_tipo_item,
				ds_item,
				qt_item,
				vl_item
			into STRICT	ie_tipo_item_w,
				ds_item_w,
				qt_item_w,
				vl_item_w
			from (	SELECT	ie_tipo_item,
						ds_item,
						qt_item,
						vl_item,
						row_number() OVER () AS linha
					from	w_pls_relat_boleto
					where	nr_titulo 	= nr_titulo_p
					and	nm_usuario 	= nm_usuario_p
					and	ie_banda 	= 'D'
					and	qt_segurado > 0) alias1
			where	linha		= i;

			t_relat_itens_mens_241_tab_w.ie_tipo_item	:= ie_tipo_item_w;
			t_relat_itens_mens_241_tab_w.ds_item		:= ds_item_w;
			t_relat_itens_mens_241_tab_w.qt_itens		:= qt_item_w;
			t_relat_itens_mens_241_tab_w.vl_total		:= vl_item_w;

		end if;

		RETURN NEXT t_relat_itens_mens_241_tab_w;
		end;
	end loop;

	return;
	end;


$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_relatorio_ops_pck.imprimir_relat_241_itens_mens ( nr_titulo_p titulo_receber.nr_titulo%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;
