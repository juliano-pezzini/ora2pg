-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pls_relatorio_ops_pck.imprimir_relat_241_relac_user ( nr_titulo_p titulo_receber.nr_titulo%type) RETURNS SETOF T_RELATORIO_241_TAB_DATA AS $body$
DECLARE


	t_relatorio_241_tab_w		t_relatorio_241_tab_row;

	type vetor is table of t_relatorio_241_tab_row index by integer;
	vetor_w				vetor;
	nr_vetor_w			bigint;
	nr_vetor_aux_w			bigint := 0;
	index_w				bigint;
	qt_beneficiarios_w		integer := 0;
	qt_usuarios_w			integer := 0;

	C01 CURSOR(	nr_titulo_pc		titulo_receber.nr_titulo%type) FOR
		SELECT	e.nm_pessoa_fisica,
			d.dt_inclusao_operadora,
			substr(pls_obter_simbolos_sca_benef(d.nr_sequencia),1,50) ds_simbolo,
			to_char(e.dt_nascimento, 'dd/mm/yyyy') dt_nascimento,
			to_char(c.qt_idade) qt_idade,
			to_char(d.dt_contratacao, 'dd/mm/yyyy') dt_contratacao,
			CASE WHEN f.nr_protocolo_ans='999999999' THEN  f.cd_scpa  ELSE f.nr_protocolo_ans END  nr_protocolo_ans,
			substr(g.cd_usuario_plano,9,6) || '-' ||substr(g.cd_usuario_plano,15,2) cd_codigo
		from	pls_segurado_carteira		g,
			pls_plano			f,
			pessoa_fisica			e,
			pls_segurado			d,
			pls_mensalidade_segurado	c,
			pls_mensalidade			b,
			titulo_receber			a
		where	e.cd_pessoa_fisica		= d.cd_pessoa_fisica
		and	c.nr_seq_segurado		= d.nr_sequencia
		and	c.nr_seq_mensalidade		= b.nr_sequencia
		and	a.nr_seq_mensalidade		= b.nr_sequencia
		and	f.nr_sequencia			= pls_obter_produto_benef(d.nr_sequencia,d.dt_contratacao)
		--and	f.nr_sequencia			= d.nr_seq_plano
		and	d.nr_sequencia			= g.nr_seq_segurado
		and	a.nr_titulo			= nr_titulo_pc
		and	exists	(	SELECT 1
					from	pls_sca_vinculo		x
					where	x.nr_seq_segurado	= c.nr_seq_segurado
					and	((coalesce(x.dt_fim_vigencia::text, '') = '') or (x.dt_fim_vigencia > clock_timestamp())))
		order by
			cd_codigo,
			nm_pessoa_fisica;

	
BEGIN
	select	count(1)
	into STRICT	qt_beneficiarios_w
	from	pessoa_fisica			e,
		pls_segurado			d,
		pls_mensalidade_segurado	c,
		pls_mensalidade			b,
		titulo_receber			a
	where	e.cd_pessoa_fisica		= d.cd_pessoa_fisica
	and	c.nr_seq_segurado		= d.nr_sequencia
	and	c.nr_seq_mensalidade		= b.nr_sequencia
	and	a.nr_seq_mensalidade		= b.nr_sequencia
	and	a.nr_titulo			= nr_titulo_p
	and	exists	(	SELECT 1
				from	pls_sca_vinculo		x
				where	x.nr_seq_segurado	= c.nr_seq_segurado
				and	((coalesce(x.dt_fim_vigencia::text, '') = '') or (x.dt_fim_vigencia > clock_timestamp())));

	if (qt_beneficiarios_w <= 72) and (qt_beneficiarios_w > 0) then
		vetor_w[1].cd_codigo_first		:= 'Código';
		vetor_w[1].nm_benef_first		:= 'Nome';
		vetor_w[1].dt_adesao_first		:= 'Inc. Plano';
		vetor_w[1].nr_protocolo_ans_first	:= 'Tipo do plano';
		vetor_w[1].dt_nascimento_first		:= 'Nascim.';
		vetor_w[1].qt_idade_first		:= 'Idade';
		vetor_w[1].cd_codigo_second		:= 'Código';
		vetor_w[1].nm_benef_second		:= 'Nome';
		vetor_w[1].dt_adesao_second		:= 'Inc. Plano';
		vetor_w[1].nr_protocolo_ans_second	:= 'Tipo do plano';
		vetor_w[1].dt_nascimento_second		:= 'Nascim.';
		vetor_w[1].qt_idade_second		:= 'Idade';

		nr_vetor_w 	:= 1;
		qt_usuarios_w 	:= 0;
		for r_c01_w in C01(nr_titulo_p) loop
			begin
			qt_usuarios_w := qt_usuarios_w + 1;
			if (nr_vetor_w + 1 > 21) then
				nr_vetor_aux_w					:= nr_vetor_aux_w + 1;

				if (nr_vetor_aux_w = 1) then
					nr_vetor_aux_w := nr_vetor_aux_w + 1;
				end if;

				if (nr_vetor_aux_w > 21) then
					exit;
				end if;

				vetor_w[nr_vetor_aux_w].cd_codigo_second	:= r_c01_w.cd_codigo;
				vetor_w[nr_vetor_aux_w].nm_benef_second		:= r_c01_w.nm_pessoa_fisica;
				vetor_w[nr_vetor_aux_w].dt_adesao_second	:= r_c01_w.dt_contratacao;
				vetor_w[nr_vetor_aux_w].nr_protocolo_ans_second	:= r_c01_w.nr_protocolo_ans;
				vetor_w[nr_vetor_aux_w].dt_nascimento_second	:= r_c01_w.dt_nascimento;
				vetor_w[nr_vetor_aux_w].qt_idade_second		:= r_c01_w.qt_idade;
			else
				nr_vetor_w					:= nr_vetor_w + 1;
				vetor_w[nr_vetor_w].cd_codigo_first		:= r_c01_w.cd_codigo;
				vetor_w[nr_vetor_w].nm_benef_first		:= r_c01_w.nm_pessoa_fisica;
				vetor_w[nr_vetor_w].dt_adesao_first		:= r_c01_w.dt_contratacao;
				vetor_w[nr_vetor_w].nr_protocolo_ans_first	:= r_c01_w.nr_protocolo_ans;
				vetor_w[nr_vetor_w].dt_nascimento_first		:= r_c01_w.dt_nascimento;
				vetor_w[nr_vetor_w].qt_idade_first		:= r_c01_w.qt_idade;
			end if;


			end;
		end loop;

		vetor_w[vetor_w.count + 1].nm_benef_first		:= 'Total de usuários: ' || to_char(qt_usuarios_w);
	end if;

	for index_w in 1..63 loop
		if (index_w <= vetor_w.count) then
			t_relatorio_241_tab_w.cd_codigo_first		:= vetor_w[index_w].cd_codigo_first;
			t_relatorio_241_tab_w.nm_benef_first		:= vetor_w[index_w].nm_benef_first;
			t_relatorio_241_tab_w.dt_adesao_first		:= vetor_w[index_w].dt_adesao_first;
			t_relatorio_241_tab_w.nr_protocolo_ans_first	:= vetor_w[index_w].nr_protocolo_ans_first;
			t_relatorio_241_tab_w.dt_nascimento_first	:= vetor_w[index_w].dt_nascimento_first;
			t_relatorio_241_tab_w.qt_idade_first		:= vetor_w[index_w].qt_idade_first;

			t_relatorio_241_tab_w.cd_codigo_second		:= vetor_w[index_w].cd_codigo_second;
			t_relatorio_241_tab_w.nm_benef_second		:= vetor_w[index_w].nm_benef_second;
			t_relatorio_241_tab_w.dt_adesao_second		:= vetor_w[index_w].dt_adesao_second;
			t_relatorio_241_tab_w.nr_protocolo_ans_second	:= vetor_w[index_w].nr_protocolo_ans_second;
			t_relatorio_241_tab_w.dt_nascimento_second	:= vetor_w[index_w].dt_nascimento_second;
			t_relatorio_241_tab_w.qt_idade_second		:= vetor_w[index_w].qt_idade_second;
		else
			t_relatorio_241_tab_w := null;
		end if;

		RETURN NEXT t_relatorio_241_tab_w;
	end loop;

	return;
	end;


$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_relatorio_ops_pck.imprimir_relat_241_relac_user ( nr_titulo_p titulo_receber.nr_titulo%type) FROM PUBLIC;
