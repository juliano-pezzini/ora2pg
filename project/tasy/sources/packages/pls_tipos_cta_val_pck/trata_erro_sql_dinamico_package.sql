-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_tipos_cta_val_pck.trata_erro_sql_dinamico ( dados_regra_p pls_tipos_cta_val_pck.dados_regra, ds_select_p text, nr_id_transacao_p bigint, nm_usuario_p text) AS $body$
DECLARE


ds_log_w	pls_oc_cta_log_erro.ds_log%type;
current_setting('pls_tipos_cta_val_pck.enter_w')::pls_util_pck.enter_w%type		varchar(2) := chr(13)||chr(10);
ds_stack_w	varchar(4000);


BEGIN
-- Desfazer qualquer alteracao anterior;

rollback;

-- obter o callstack

ds_stack_w := dbms_utility.format_call_stack;

-- Obter o log a ser gravado

ds_log_w	:= substr('Erro: ' || sqlerrm || current_setting('pls_tipos_cta_val_pck.enter_w')::pls_util_pck.enter_w%type || current_setting('pls_tipos_cta_val_pck.enter_w')::pls_util_pck.enter_w%type ||
			'Valida??o: ' || current_setting('pls_tipos_cta_val_pck.enter_w')::pls_util_pck.enter_w%type ||
			dados_regra_p.nr_seq_validacao || current_setting('pls_tipos_cta_val_pck.enter_w')::pls_util_pck.enter_w%type ||
			'Regra: ' || current_setting('pls_tipos_cta_val_pck.enter_w')::pls_util_pck.enter_w%type ||
			dados_regra_p.nr_seq_regra || current_setting('pls_tipos_cta_val_pck.enter_w')::pls_util_pck.enter_w%type ||
			'SQL: ' || current_setting('pls_tipos_cta_val_pck.enter_w')::pls_util_pck.enter_w%type ||
			ds_select_p ||current_setting('pls_tipos_cta_val_pck.enter_w')::pls_util_pck.enter_w%type|| current_setting('pls_tipos_cta_val_pck.enter_w')::pls_util_pck.enter_w%type ||
			'Stack:'||current_setting('pls_tipos_cta_val_pck.enter_w')::pls_util_pck.enter_w%type||ds_stack_w,1,4000);
insert into pls_oc_cta_log_erro(nr_sequencia,
	nm_usuario,
	dt_atualizacao,
	nr_id_transacao,
	ds_log)
values (nextval('pls_oc_cta_log_erro_seq'),
	nm_usuario_p,
	clock_timestamp(),
	nr_id_transacao_p,
	ds_log_w);
-- Gravar alteracoes

commit;

CALL wheb_mensagem_pck.exibir_mensagem_abort(284127,'REGRA=' || dados_regra_p.nr_seq_regra|| ';ERRO=' || sqlerrm, -20012);

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_tipos_cta_val_pck.trata_erro_sql_dinamico ( dados_regra_p pls_tipos_cta_val_pck.dados_regra, ds_select_p text, nr_id_transacao_p bigint, nm_usuario_p text) FROM PUBLIC;
