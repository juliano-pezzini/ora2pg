-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pls_tipos_cta_val_pck.obter_sequencia_selecao ( nr_seq_conta_p pls_rp_cta_selecao.nr_seq_conta%type, nr_seq_conta_proc_p pls_rp_cta_selecao.nr_seq_conta_proc%type, nr_id_transacao_p pls_rp_cta_selecao.nr_id_transacao%type, nr_seq_filtro_p pls_rp_cta_selecao.nr_seq_rp_cta_filtro%type, ie_filtro_validacao_p text) RETURNS text AS $body$
DECLARE

/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade:	Retornar a sequencia de determinado item na tabela de selecao.
-------------------------------------------------------------------------------------------------------------------

Locais de chamada direta: 
[X]  Objetos do dicionario [ ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatorios [ ] Outros:
-------------------------------------------------------------------------------------------------------------------

Pontos de atencao:

Alteracoes: 
-------------------------------------------------------------------------------------------------------------------

jjung - OS 651768 - 18/10/2013 - Criacao da function.
-------------------------------------------------------------------------------------------------------------------

++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */


var_cur_w		integer;
var_exec_w		integer;
var_retorno_w		integer;

ds_sql_w		varchar(1000);
nr_sequencia_w		text;


BEGIN

-- Montar o select

ds_sql_w :=	'select	sel.nr_sequencia ' ||
		'from	pls_rp_cta_selecao_v sel ' ||
		'where	nr_id_transacao = :nr_id_transacao ';
		
-- se for filtro

if (ie_filtro_validacao_p = 'F') then
	ds_sql_w := ds_sql_w || 'and	sel.nr_seq_rp_cta_filtro = :nr_seq_filtro ';
end if;

-- se a conta for informada busca a conta		

if (nr_seq_conta_p IS NOT NULL AND nr_seq_conta_p::text <> '') then
	ds_sql_w := ds_sql_w || 'and	sel.nr_seq_conta = :nr_seq_conta ';
end if;

-- Se o procedimento for informado busca o procedimento

if (nr_seq_conta_proc_p IS NOT NULL AND nr_seq_conta_proc_p::text <> '') then
	ds_sql_w := ds_sql_w || 'and	sel.nr_seq_conta_proc = :nr_seq_conta_proc ';
end if;

-- Aqui monta o select que ir?  retornar  todas as sequencias dos registros separados por virgula.

ds_sql_w :=	'select	pls_admin_cursor.obter_desc_cursor_gigante( cursor ( ' ||
		ds_sql_w || '), ''' || current_setting('pls_tipos_cta_val_pck.ds_separador_selecao_w')::varchar(1) || '''' || ') '||
		'from dual';

var_cur_w := dbms_sql.open_cursor;
dbms_sql.parse(var_cur_w, ds_sql_w, 1);

-- Sempre tera informacao da transacao

dbms_sql.bind_variable(var_cur_w, ':nr_id_transacao', nr_id_transacao_p);

if (ie_filtro_validacao_p = 'F') then
	dbms_sql.bind_variable(var_cur_w, ':nr_seq_filtro', nr_seq_filtro_p);
end if;

-- se a conta foi informada atualiza o valor do tipo de registro e da conta.

if (nr_seq_conta_p IS NOT NULL AND nr_seq_conta_p::text <> '') then
	dbms_sql.bind_variable(var_cur_w, ':nr_seq_conta', nr_seq_conta_p);
end if;

-- se o procedimento foi informado entao e procedimento

if (nr_seq_conta_proc_p IS NOT NULL AND nr_seq_conta_proc_p::text <> '') then
	dbms_sql.bind_variable(var_cur_w, ':nr_seq_conta_proc', nr_seq_conta_proc_p);
end if;

-- Executar o comando e buscar o resultado

dbms_sql.define_column(var_cur_w, 1, nr_sequencia_w);
var_exec_w := dbms_sql.execute(var_cur_w);

loop
var_retorno_w := dbms_sql.fetch_rows(var_cur_w);
exit when var_retorno_w = 0;
	-- Atualiza a variavel com o resultado do select

	dbms_sql.column_value(var_cur_w, 1, nr_sequencia_w);
end loop;
dbms_sql.close_cursor(var_cur_w);

return nr_sequencia_w;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pls_tipos_cta_val_pck.obter_sequencia_selecao ( nr_seq_conta_p pls_rp_cta_selecao.nr_seq_conta%type, nr_seq_conta_proc_p pls_rp_cta_selecao.nr_seq_conta_proc%type, nr_id_transacao_p pls_rp_cta_selecao.nr_id_transacao%type, nr_seq_filtro_p pls_rp_cta_selecao.nr_seq_rp_cta_filtro%type, ie_filtro_validacao_p text) FROM PUBLIC;
