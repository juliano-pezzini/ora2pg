-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE gpt_utils_pck.gerar_linha (ie_verifica_p text) AS $body$
BEGIN
		ie_exibe_w := 'N';
		
		if (ie_verifica_p = 'N') then
			ie_exibe_w := 'S';
		else
			nr_seq_analise_enf_w := obter_seq_analise_gpt(nr_atendimento_w, 'E', 'N', cd_pessoa_fisica_w, qt_horas_quimio_p);
			nr_seq_analise_farm_w := obter_seq_analise_gpt(nr_atendimento_w, 'F', ie_lib_farm_p, cd_pessoa_fisica_w, qt_horas_quimio_p);
			
			if (ie_tipo_gpt_p = 'E') then
				ie_liberacao_w := to_char(ie_liberacao_enf_p);
			else
				ie_liberacao_w := to_char(ie_liberacao_farm_p);
			end if;
			
			if (obter_se_exibe_atend_gpt(
				nr_atendimento_w,
				cd_pessoa_fisica_w,
				ie_tipo_gpt_p,
				nr_seq_analise_enf_w,
				nr_seq_analise_farm_w,
				ie_status_enf_p,
				ie_status_farm_p,
				cd_setor_atend_p,
				ie_revisado_p,
				ie_vaga_solicitada_p,
				ie_exibe_alta_p,
				ds_itens_p,
				ie_liberacao_w,
                ds_setores_p) = 'S') then
			ie_exibe_w := 'S';
			end if;
		end if;
		
		if (ie_exibe_w = 'S') then
			line_w.nr_atendimento := nr_atendimento_w;
			line_w.cd_pessoa_fisica := cd_pessoa_fisica_w;
			line_w.nm_paciente := obter_nome_pf(cd_pessoa_fisica_w);
			line_w.ie_reconciliacao := substr(obter_se_atend_reconciliacao(nr_atendimento_w),1,1);
			line_w.ds_unidade := substr(obter_unidade_atendimento(nr_atendimento_w,'IAA','U'),1,100);
			line_w.ds_unidade_basica := substr(obter_unidade_atendimento(nr_atendimento_w, 'A', 'UB'),1,40);
			line_w.ds_unidade_comp := substr(obter_unidade_atendimento(nr_atendimento_w, 'A', 'UC'),1,40);
			line_w.dt_alta := obter_dados_atendimento_dt(nr_atendimento_w,'DA');
			line_w.dt_atendimento := obter_dados_atendimento_dt(nr_atendimento_w,'DE');
			line_w.dt_prox_adm := obter_prim_prescr_mat_hor_gpt(nr_atendimento_w, cd_pessoa_fisica_w, nm_usuario_p, cd_estabelecimento_p);
			line_w.dt_alta_medico := obter_dados_atendimento_dt(nr_atendimento_w,'DAM');
			line_w.ie_forma_reconciliacao := substr(obter_reconciliacao_atend(nr_atendimento_w),1,1);
			line_w.nr_prontuario := obter_prontuario_paciente(cd_pessoa_fisica_w);
			line_w.qt_peso := obter_dados_sv_atendimento('V','QT_PESO',nr_atendimento_w);
			line_w.qt_altura := obter_dados_sv_atendimento('V','QT_ALTURA_CM',nr_atendimento_w);
			line_w.ds_setor_atendimento := substr(obter_unidade_atendimento(nr_atendimento_w,'IAA','S'),1,255);
			line_w.ds_setor_atual := substr(obter_desc_setor_atend(obter_setor_atendimento(nr_atendimento_w)),1,255);
			line_w.ie_emergencia := obter_se_atend_prescr_emerg(nr_atendimento_w,dt_inicial_p,dt_final_p);
			line_w.ie_urgente := obter_se_ate_prescr_urgente(nr_atendimento_w,dt_inicial_p,dt_final_p,cd_pessoa_fisica_w);

			line_w.nr_cor_idade := obter_legenda_idade_gpt(cd_pessoa_fisica_w);
			line_w.ie_analise_ativa := obter_se_analise_ativa_gpt(null,null,nm_usuario_p,ie_lib_farm_p,cd_pessoa_fisica_w, qt_horas_quimio_p);
			line_w.ie_analise_item_ativa := obter_se_analise_ativa_gpt(nr_atendimento_w,null,nm_usuario_p,ie_lib_farm_p,cd_pessoa_fisica_w, qt_horas_quimio_p);
			line_w.ie_item_bloqueado := obter_se_analise_ativa_gpt(nr_atendimento_w,ie_param_1_p,nm_usuario_p,ie_lib_farm_p,cd_pessoa_fisica_w, qt_horas_quimio_p);
			
			line_w.dt_inicio_analise_enf := obter_dt_analise_gpt(nr_atendimento_w,dt_inicial_p,dt_final_p,'E','DTI',ie_lib_farm_p, cd_pessoa_fisica_w, nr_seq_analise_enf_w, qt_horas_quimio_p);
			line_w.dt_fim_analise_enf := obter_dt_analise_gpt(nr_atendimento_w,dt_inicial_p,dt_final_p,'E','DTF',ie_lib_farm_p, cd_pessoa_fisica_w, nr_seq_analise_enf_w, qt_horas_quimio_p);
			line_w.nm_compl_resp_analise_enf := obter_resp_analise_gpt(nr_atendimento_w,dt_inicial_p,dt_final_p,'E','NM',ie_lib_farm_p, cd_pessoa_fisica_w, nr_seq_analise_enf_w, qt_horas_quimio_p);
			line_w.nm_resp_analise_enf := obter_resp_analise_gpt(nr_atendimento_w,dt_inicial_p,dt_final_p,'E','U',ie_lib_farm_p, cd_pessoa_fisica_w, nr_seq_analise_enf_w, qt_horas_quimio_p);
			
			line_w.dt_inicio_analise_farm := obter_dt_analise_gpt(nr_atendimento_w,dt_inicial_p,dt_final_p,'F','DTI',ie_lib_farm_p, cd_pessoa_fisica_w, nr_seq_analise_farm_w, qt_horas_quimio_p);
			line_w.dt_fim_analise_farm := obter_dt_analise_gpt(nr_atendimento_w,dt_inicial_p,dt_final_p,'F','DTF',ie_lib_farm_p, cd_pessoa_fisica_w, nr_seq_analise_farm_w, qt_horas_quimio_p);
			line_w.nm_compl_resp_analise_farm := obter_resp_analise_gpt(nr_atendimento_w,dt_inicial_p,dt_final_p,'F','NM',ie_lib_farm_p, cd_pessoa_fisica_w, nr_seq_analise_farm_w, qt_horas_quimio_p);
			line_w.nm_resp_analise_farm := obter_resp_analise_gpt(nr_atendimento_w,dt_inicial_p,dt_final_p,'F','U',ie_lib_farm_p, cd_pessoa_fisica_w,nr_seq_analise_farm_w, qt_horas_quimio_p);
			line_w.ie_status_analise := gpt_utils_pck.get_status_analise(ie_param_1_p, line_w.dt_inicio_analise_enf, line_w.dt_fim_analise_enf, line_w.nm_compl_resp_analise_enf, line_w.dt_inicio_analise_farm, line_w.dt_fim_analise_farm, line_w.nm_compl_resp_analise_farm, 1);
			line_w.ds_status_analise := gpt_utils_pck.get_status_analise(ie_param_1_p, line_w.dt_inicio_analise_enf, line_w.dt_fim_analise_enf, line_w.nm_compl_resp_analise_enf, line_w.dt_inicio_analise_farm, line_w.dt_fim_analise_farm, line_w.nm_compl_resp_analise_farm, 2);
			
			if (ie_tipo_gpt_p = 'E') then
				line_w.dt_inicio_analise := line_w.dt_inicio_analise_enf;
				line_w.dt_fim_analise := line_w.dt_fim_analise_enf;
				line_w.nm_compl_resp_analise := line_w.nm_compl_resp_analise_enf;
				line_w.nm_usuario_analise := line_w.nm_resp_analise_enf;
			else
				line_w.dt_inicio_analise := line_w.dt_inicio_analise_farm;
				line_w.dt_fim_analise := line_w.dt_fim_analise_farm;
				line_w.nm_compl_resp_analise := line_w.nm_compl_resp_analise_farm;
				line_w.nm_usuario_analise := line_w.nm_resp_analise_farm;
			end if;
			
			ds_classif_setor_w := substr(obter_unidade_atendimento(nr_atendimento_w,'IAA','CL'),1,100);
			
			if (ie_tipo_gpt_p = 'E') then
				line_w.nr_seq_cor := obter_legendas_presc_gpt(ie_tipo_gpt_p, nr_atendimento_w, cd_pessoa_fisica_w, dt_inicial_p, dt_final_p, line_w.ie_reconciliacao, ie_param_91_p, line_w.ie_forma_reconciliacao, ie_param_92_p, ds_classif_setor_w, line_w.dt_alta_medico, line_w.dt_alta, ie_lib_farm_p, line_w.dt_inicio_analise_farm, 'XPTO');
			else
				line_w.nr_seq_cor_emergencia := obter_legendas_presc_gpt(ie_tipo_gpt_p, nr_atendimento_w, cd_pessoa_fisica_w, dt_inicial_p, dt_final_p, line_w.ie_reconciliacao, ie_param_91_p, line_w.ie_forma_reconciliacao, ie_param_92_p, ds_classif_setor_w,line_w.dt_alta_medico, line_w.dt_alta, ie_lib_farm_p, line_w.dt_inicio_analise_farm, 'E');

				line_w.nr_seq_cor_revisao := obter_legendas_presc_gpt(ie_tipo_gpt_p, nr_atendimento_w, cd_pessoa_fisica_w, dt_inicial_p, dt_final_p, line_w.ie_reconciliacao, ie_param_91_p, line_w.ie_forma_reconciliacao, ie_param_92_p, ds_classif_setor_w,line_w.dt_alta_medico, line_w.dt_alta, ie_lib_farm_p, line_w.dt_inicio_analise_farm, 'R');

				line_w.nr_seq_cor_reconciliacao1 := obter_legendas_presc_gpt(ie_tipo_gpt_p, nr_atendimento_w, cd_pessoa_fisica_w, dt_inicial_p, dt_final_p, line_w.ie_reconciliacao, ie_param_91_p, line_w.ie_forma_reconciliacao, ie_param_92_p, ds_classif_setor_w, line_w.dt_alta_medico, line_w.dt_alta,ie_lib_farm_p, line_w.dt_inicio_analise_farm, 'R1');

				line_w.nr_seq_cor_reconciliacao2 := obter_legendas_presc_gpt(ie_tipo_gpt_p, nr_atendimento_w, cd_pessoa_fisica_w, dt_inicial_p, dt_final_p, line_w.ie_reconciliacao, ie_param_91_p, line_w.ie_forma_reconciliacao, ie_param_92_p, ds_classif_setor_w, line_w.dt_alta_medico, line_w.dt_alta, ie_lib_farm_p, line_w.dt_inicio_analise_farm, 'R2');
			end if;

			line_w.nr_ultima_prescr := gpt_obter_info_revisao(nr_atendimento_w, cd_pessoa_fisica_w,'P');
			line_w.nm_usuario_anal_enf := gpt_obter_info_revisao(nr_atendimento_w, cd_pessoa_fisica_w,'U');
			line_w.dt_inicio_anal_enf := to_date(gpt_obter_info_revisao(nr_atendimento_w, cd_pessoa_fisica_w,'D'),'dd/mm/yyyy hh24:mi:ss');
			line_w.ie_possui_prescricao := obter_se_iniciar_analise_gpt(nr_atendimento_w,cd_pessoa_fisica_w);
			
			line_w.ds_itens_pendentes := gpt_utils_pck.obter_itens_pendentes(nr_atendimento_w, cd_pessoa_fisica_w, ie_tipo_gpt_p, qt_horas_quimio_p);
		end if;
	end;
	
	begin
		dt_inicial_w := dt_inicial_p;
		dt_final_w	 := dt_final_p;
		
		if (coalesce(nr_prescricao_p,0) > 0) then
			for r_c02_w in c02
			loop
				nr_atendimento_w := r_c02_w.nr_atendimento;
				cd_pessoa_fisica_w := r_c02_w.cd_pessoa_fisica;
				CALL gpt_utils_pck.gerar_linha('N');
				if (ie_exibe_w = 'S') then
					RETURN;
				end if;
			end loop;
		elsif (coalesce(nr_atendimento_p,0) > 0) then
			for r_c03_w in c03
			loop
				nr_atendimento_w := r_c03_w.nr_atendimento;
				cd_pessoa_fisica_w := r_c03_w.cd_pessoa_fisica;
				CALL gpt_utils_pck.gerar_linha('N');
				if (ie_exibe_w = 'S') then
					RETURN;
				end if;
			end loop;
		elsif (cd_pessoa_fisica_p IS NOT NULL AND cd_pessoa_fisica_p::text <> '') then
			for r_c04_w in c04
			loop
				nr_atendimento_w := r_c04_w.nr_atendimento;
				cd_pessoa_fisica_w := r_c04_w.cd_pessoa_fisica;
				CALL gpt_utils_pck.gerar_linha('N');
				if (ie_exibe_w = 'S') then
					RETURN;
				end if;
			end loop;
		else			
			cd_estabelecimento_w	:= wheb_usuario_pck.get_cd_estabelecimento;
			cd_perfil_w				:= obter_perfil_ativo;
			nm_usuario_w			:= wheb_usuario_pck.get_nm_usuario;
			
			obter_param_usuario(252, 62, cd_perfil_w, nm_usuario_w, cd_estabelecimento_w, ie_param_62_w);
			
			if (coalesce(qt_horas_quimio_p,0) > 0) then
				dt_quimio_w := clock_timestamp() + (qt_horas_quimio_p / 24);
			end if;
		
			if (coalesce(ie_vigentes_p,'N') = 'S') then
				dt_inicial_vigentes_w := clock_timestamp() - interval '7 days';
				
				select
					min(dt_inicio_prescr),
					max(dt_inicio_prescr)
				into STRICT
					dt_inicial_w,
					dt_final_w
				from	prescr_medica
				where	clock_timestamp() between dt_inicio_prescr and dt_validade_prescr
				and		dt_inicio_prescr >= dt_inicial_vigentes_w;
			end if;
			
			for r_c01_w in c01
			loop
				if ((coalesce(cd_pessoa_fisica_w::text, '') = '') or (r_c01_w.cd_pessoa_fisica <> cd_pessoa_fisica_w) or (coalesce(r_c01_w.nr_atendimento,0) <> coalesce(nr_atendimento_w,0))) then
					if (obter_se_exibe_prescr_gpt(
							ie_tipo_gpt_p,
							r_c01_w.nr_prescricao,
							cd_estabelecimento_p,
							ie_motivo_prescricao_p,
							ie_liberacao_enf_p,
							ie_liberacao_farm_p,
							ie_status_farm_p,
							nr_seq_classif_transcr_p,
							ie_intervencao_farm_p,
							cd_grupo_material_p,
							cd_subgrupo_material_p,
							cd_classe_material_p,
							cd_material_p,
							ie_nao_padronizado_p,
							ie_quimio_p,
							ie_alto_risco_p,
							ie_medic_alto_custo_p,
							ie_medic_paciente_p,
							ie_dispensacao_p,
							ie_tipo_item_p,
							ie_prescritor_p,
							ie_urgencia_p,
							cd_intervalo_p,
							qt_minutos_agora_p,
							ie_restrito_p,
							ie_item_farm_nao_atend_p,
							ie_itens_p,
							ie_status_enf_p,
							ie_sem_atendimento_p,
							ie_alta_vigilancia_p,
							ie_lib_farm_p,
							ie_param_62_w,
							ie_antibiotico_p,
                            ds_motivos_p,
							ds_matmeds_p) = 'S') then
						
						nr_atendimento_w := r_c01_w.nr_atendimento;
						cd_pessoa_fisica_w := r_c01_w.cd_pessoa_fisica;
						CALL gpt_utils_pck.gerar_linha('S');
						if (ie_exibe_w = 'S') then
							RETURN;
						end if;
						
					end if;
				end if;
			end loop;
		end if;

		return;

	END;
	

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gpt_utils_pck.gerar_linha (ie_verifica_p text) FROM PUBLIC;
