-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


   -----------------------
CREATE OR REPLACE FUNCTION pck_sepsis_bundle_report.get_seps_compl_2_treatment (nr_atendimento_p gqa_protocolo_pac.nr_atendimento%type) RETURNS bigint AS $body$
DECLARE


      is_compliance         bigint := 0;
      dt_inicio_protocolo_w gqa_protocolo_etapa_pac.dt_inicio%type;

      -- 3350 -- ICCA sepsis - Compliance measure 2 treatment
      c_2_treatment CURSOR FOR
         SELECT pma.dt_horario
           from prescr_mat_alteracao pma,
                prescr_material      pm,
                material             m
          where pm.nr_prescricao = pma.nr_prescricao
            and m.cd_material = pm.cd_material
            and (m.cd_medicamento IS NOT NULL AND m.cd_medicamento::text <> '')
            and pma.dt_horario between dt_inicio_protocolo_w and dt_inicio_protocolo_w + (1 / 24)
            and pma.nr_atendimento = nr_atendimento_p
            and (m.cd_classe_material = pkg_report_data.get_class_material(cd_cla_mat_crist_w,m.cd_classe_material)
             or m.cd_classe_material = pkg_report_data.get_class_material(cd_cla_mat_vsp_w,m.cd_classe_material))

union

         SELECT pma.dt_horario
           from prescr_mat_alteracao       pma,
                prescr_material            pm,
                cirurgia_v                 c,
                material                   m,
                evento_cirurgia_paciente   e,
                cirurgia_agente_anestesico caa,
                cirurgia_agente_anest_ocor cao
          where pm.nr_prescricao = pma.nr_prescricao
            and m.cd_material = pm.cd_material
            and e.nr_cirurgia = c.nr_cirurgia
            and caa.nr_cirurgia = c.nr_cirurgia
            and cao.nr_seq_cirur_agente = caa.nr_sequencia
            and caa.cd_material = m.cd_material
            and pma.dt_horario between dt_inicio_protocolo_w and dt_inicio_protocolo_w + (1 / 24)
            and pma.nr_atendimento = nr_atendimento_p
            and (m.cd_classe_material = pkg_report_data.get_class_material(cd_cla_mat_crist_w,m.cd_classe_material)
             or m.cd_classe_material = pkg_report_data.get_class_material(cd_cla_mat_vsp_w,m.cd_classe_material));

      r_2_treatment c_2_treatment%rowtype;


BEGIN

      -- 3353 ICCA sepsis - Compliance measures 2 Treatment
      dt_inicio_protocolo_w := pck_sepsis_bundle_report.get_dt_ini_protocol(nr_atendimento_p, current_setting('pck_sepsis_bundle_report.cd_etp_2_treatment_w')::bigint, dt_inicio_protocolo_w);

      if (dt_inicio_protocolo_w IS NOT NULL AND dt_inicio_protocolo_w::text <> '') then
         open c_2_treatment;
         loop
            fetch c_2_treatment
               into r_2_treatment;
            EXIT WHEN NOT FOUND; /* apply on c_2_treatment */

            is_compliance := 1;

         end loop;
         close c_2_treatment;
      end if;

      return(is_compliance);
   END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pck_sepsis_bundle_report.get_seps_compl_2_treatment (nr_atendimento_p gqa_protocolo_pac.nr_atendimento%type) FROM PUBLIC;
