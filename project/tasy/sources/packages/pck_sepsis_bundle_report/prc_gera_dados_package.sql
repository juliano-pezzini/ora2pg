-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


  -----------------------
CREATE OR REPLACE PROCEDURE pck_sepsis_bundle_report.prc_gera_dados (dt_ini_p timestamp, dt_fim_p timestamp, cd_unidade_p text, ds_age_p text, cd_pessoa_fisica_p text, ie_relatorio_p text) AS $body$
DECLARE


     ie_conforme_w           w_rel_sepsis.ie_conforme%type;
     qt_day_w                w_rel_sepsis.qt_day%type;
     qt_seps_compl_blood_w   w_rel_sepsis.qt_seps_compl_blood%type;
     qt_seps_compl_lactate_w w_rel_sepsis.qt_seps_compl_lactate%type;
     qt_seps_compl_antibio_w w_rel_sepsis.qt_seps_compl_antibiotic%type;
     qt_seps_compl_1_treat_w w_rel_sepsis.qt_seps_compl_1_treatment%type;
     qt_seps_compl_2_treat_w w_rel_sepsis.qt_seps_compl_2_treatment%type;

     c1 CURSOR FOR
        SELECT b.nr_sequencia,
               a.nr_atendimento,
               b.dt_atualizacao,
               b.qt_resultado qt_incidence,
               obter_setor_atendimento(c.nr_atendimento) cd_setor
          from gqa_protocolo_pac       a,
               gqa_protocolo_etapa_pac b,
               atendimento_paciente    c,
               atend_paciente_unidade d
         where a.nr_sequencia = b.nr_seq_prot_pac
           and d.nr_seq_interno = Obter_Atepacu_paciente(a.nr_atendimento, 'A')
           and c.nr_atendimento = a.nr_atendimento
           and b.nr_seq_etapa = pkg_report_data.get_stage(cd_etp_chart_care_w,b.nr_seq_etapa)
           and b.qt_resultado = 1
           and b.dt_atualizacao between dt_ini_p and dt_fim_p
           and ((coalesce(cd_unidade_p::text, '') = '') or (obter_se_contido(d.cd_setor_atendimento, cd_unidade_p) = 'S'))
           and (obter_idade_pf(c.cd_pessoa_fisica, clock_timestamp(), 'A') >= 18 or ds_age_p = 'X')
           and ((coalesce(cd_pessoa_fisica_p::text, '') = '') or (obter_se_contido(c.cd_pessoa_fisica, cd_pessoa_fisica_p) = 'S'));

     r1 c1%rowtype;

BEGIN
     --Limpa tabela W
     delete FROM w_rel_sepsis;

     --Abre cursor principal
     open c1;
     loop
        fetch c1
           into r1;
        EXIT WHEN NOT FOUND; /* apply on c1 */

        ie_conforme_w := pck_sepsis_bundle_report.get_seps_compliance(nr_sequencia_p => r1.nr_sequencia);
        qt_day_w      := pck_sepsis_bundle_report.get_qtd_patient_day(nr_sequencia_p         => r1.nr_sequencia, cd_setor_atendimento_p => null);
        if (ie_relatorio_p = 4543) then
           qt_seps_compl_blood_w   := pck_sepsis_bundle_report.get_seps_compl_blood(nr_atendimento_p => r1.nr_atendimento);
           qt_seps_compl_lactate_w := pck_sepsis_bundle_report.get_seps_compl_lactate(nr_atendimento_p => r1.nr_atendimento);
           qt_seps_compl_antibio_w := pck_sepsis_bundle_report.get_seps_compl_antibiotic(nr_atendimento_p => r1.nr_atendimento);
           qt_seps_compl_1_treat_w := pck_sepsis_bundle_report.get_seps_compl_1_treatment(nr_atendimento_p => r1.nr_atendimento);
           qt_seps_compl_2_treat_w := pck_sepsis_bundle_report.get_seps_compl_2_treatment(nr_atendimento_p => r1.nr_atendimento);

        end if;

        insert into w_rel_sepsis(nr_sequencia,
            nr_atendimento,
            dt_atualizacao,
            qt_incidence,
            cd_setor,
            ie_conforme,
            qt_day,
            qt_seps_compl_blood,
            qt_seps_compl_lactate,
            qt_seps_compl_antibiotic,
            qt_seps_compl_1_treatment,
            qt_seps_compl_2_treatment)
        values (r1.nr_sequencia,
            r1.nr_atendimento,
            r1.dt_atualizacao,
            r1.qt_incidence,
            r1.cd_setor,
            ie_conforme_w,
            qt_day_w,
            qt_seps_compl_blood_w,
            qt_seps_compl_lactate_w,
            qt_seps_compl_antibio_w,
            qt_seps_compl_1_treat_w,
            qt_seps_compl_2_treat_w);
     end loop;
     close c1;

     --
     commit;
  END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pck_sepsis_bundle_report.prc_gera_dados (dt_ini_p timestamp, dt_fim_p timestamp, cd_unidade_p text, ds_age_p text, cd_pessoa_fisica_p text, ie_relatorio_p text) FROM PUBLIC;
