-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


   -----------------------
CREATE OR REPLACE FUNCTION pck_sepsis_bundle_report.get_qtd_patient_day (nr_sequencia_p gqa_protocolo_etapa_pac.nr_sequencia%type, cd_setor_atendimento_p atend_paciente_unidade.cd_setor_atendimento%type) RETURNS bigint AS $body$
DECLARE


      qtd_patient_day_w bigint;

      dt_inicio_sepesis_w gqa_protocolo_etapa_pac.dt_inicio%type;
      dt_fim_sepesis_w    gqa_protocolo_etapa_pac.dt_fim%type;
      nr_atendimento_w    gqa_protocolo_pac.nr_atendimento%type;
      dt_inicio_setor_w   atend_paciente_unidade.dt_entrada_unidade%type;
      dt_fim_setor_w      atend_paciente_unidade.dt_saida_unidade%type;

      c_1 CURSOR FOR
         SELECT a.cd_setor_atendimento,
                a.dt_entrada_unidade,
                a.dt_saida_unidade
           from atend_paciente_unidade a
          where a.nr_atendimento = nr_atendimento_w
            and a.dt_entrada_unidade between dt_inicio_sepesis_w and
                dt_fim_sepesis_w
          order by a.dt_entrada_unidade;

      r_1 c_1%rowtype;


BEGIN
      qtd_patient_day_w := 0;

      select b.dt_inicio, --
             a.nr_atendimento
        into STRICT dt_inicio_sepesis_w, --
             nr_atendimento_w
        from gqa_protocolo_pac       a,
             gqa_protocolo_etapa_pac b
       where a.nr_sequencia = b.nr_seq_prot_pac
         and b.nr_sequencia = nr_sequencia_p;

      -- 3353 ICCA sepsis - Compliance measures 2 Treatment
      select max(b.dt_fim)
        into STRICT dt_fim_sepesis_w
        from gqa_protocolo_pac       a,
             gqa_protocolo_etapa_pac b
       where a.nr_sequencia = b.nr_seq_prot_pac
         and a.nr_atendimento = nr_atendimento_w
         and b.nr_seq_etapa = current_setting('pck_sepsis_bundle_report.cd_etp_2_treatment_w')::bigint
         and b.dt_atualizacao >= dt_inicio_sepesis_w;

      --
      open c_1;
      loop
         fetch c_1
            into r_1;
         EXIT WHEN NOT FOUND; /* apply on c_1 */

         if (r_1.cd_setor_atendimento = cd_setor_atendimento_p or
            coalesce(cd_setor_atendimento_p::text, '') = '') then

            if (coalesce(dt_inicio_setor_w::text, '') = '') then
               dt_inicio_setor_w := r_1.dt_entrada_unidade;
            end if;

            dt_fim_setor_w := r_1.dt_saida_unidade;

         else
            qtd_patient_day_w := qtd_patient_day_w +
                                 round(dt_fim_setor_w - dt_inicio_setor_w);
            dt_inicio_setor_w := null;
            dt_fim_setor_w    := null;
         end if;

      end loop;

      qtd_patient_day_w := qtd_patient_day_w +
                           round(dt_fim_setor_w - dt_inicio_setor_w);

      close c_1;
      return(qtd_patient_day_w);

   END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pck_sepsis_bundle_report.get_qtd_patient_day (nr_sequencia_p gqa_protocolo_etapa_pac.nr_sequencia%type, cd_setor_atendimento_p atend_paciente_unidade.cd_setor_atendimento%type) FROM PUBLIC;
