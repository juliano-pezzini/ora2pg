-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


  -----------------------
CREATE OR REPLACE PROCEDURE pck_sepsis_bundle_report.prc_gera_dados_alta (dt_ini_p timestamp, dt_fim_p timestamp, cd_unidade_p text, ds_age_p text, cd_pessoa_fisica_p text) AS $body$
DECLARE

     c1 CURSOR FOR
        SELECT distinct
        pkg_atend_pac_unid.get_patient_name(c.nr_atendimento) ds_nome,
        to_char(to_date(obter_dados_pf(c.cd_pessoa_fisica,'DN'),'DD/MM/YYYY'),'MM-DD-YYYY') dt_nasc,
        c.cd_pessoa_fisica id_paciente,
        c.nr_atendimento num_protuario,
        obter_nome_setor(obter_setor_atendimento(c.nr_atendimento)) setor,
        to_char((SELECT min(bb.dt_inicio)
          from gqa_protocolo_pac aa, gqa_protocolo_etapa_pac bb
          where aa.nr_sequencia = bb.nr_seq_prot_pac
           and bb.nr_seq_etapa = pkg_report_data.get_stage(cd_etp_chart_care_w,bb.nr_seq_etapa)
           and aa.nr_atendimento = c.nr_atendimento
           and coalesce(bb.nr_seq_etapa_sup::text, '') = ''
           and (bb.dt_inicio IS NOT NULL AND bb.dt_inicio::text <> '')),
        'MM-DD-YYYY HH:MM') dt_presetation,
        a.ds_motivo_alta motivo_alta,
        to_char(obter_data_obito(c.cd_pessoa_fisica),'MM-DD-YYYY  HH:MM') dt_obito
        from  motivo_alta a,
        atendimento_paciente c,
        atend_paciente_unidade d
        where a.cd_motivo_alta = c.cd_motivo_alta
        and c.nr_atendimento  = d.nr_atendimento
        and a.ie_obito = 'S'
        and ((coalesce(cd_pessoa_fisica_p::text, '') = '') or (obter_se_contido(c.cd_pessoa_fisica, cd_pessoa_fisica_p) = 'S'))
        and ((coalesce(cd_unidade_p::text, '') = '') or (obter_se_contido(d.cd_setor_atendimento, cd_unidade_p) = 'S'))
        and (obter_idade_pf(c.cd_pessoa_fisica,clock_timestamp(),'A') >= 18 or ds_age_p = 'X')
        and exists (select aa.nr_atendimento
                from gqa_protocolo_pac aa,
                    gqa_protocolo_etapa_pac bb
              where aa.nr_sequencia = bb.nr_seq_prot_pac
                and bb.nr_seq_etapa = pkg_report_data.get_stage(cd_etp_chart_care_w,bb.nr_seq_etapa)
                and bb.qt_resultado = 1
                and trunc(bb.dt_atualizacao) between dt_ini_p and dt_fim_p
                and aa.nr_atendimento = c.nr_atendimento);

     r1 c1%rowtype;

BEGIN
     --Limpa tabela w_rel_sepsis_alta
     delete FROM w_rel_sepsis_alta;

     --Abre cursor principal
     open c1;
     loop
        fetch c1
           into r1;

        EXIT WHEN NOT FOUND; /* apply on c1 */

        insert into w_rel_sepsis_alta(cd_id_paciente,
            ds_nome,
            dt_nasc,
            nr_protuario,
            ds_setor,
            dt_presetation,
            ds_motivo_alta,
            dt_obito)
        values (
            r1.id_paciente,
            r1.ds_nome,
            r1.dt_nasc,
            r1.num_protuario,
            r1.setor,
            r1.dt_presetation,
            r1.motivo_alta,
            r1.dt_obito);
     end loop;
     close c1;
     --
     commit;
  END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pck_sepsis_bundle_report.prc_gera_dados_alta (dt_ini_p timestamp, dt_fim_p timestamp, cd_unidade_p text, ds_age_p text, cd_pessoa_fisica_p text) FROM PUBLIC;
