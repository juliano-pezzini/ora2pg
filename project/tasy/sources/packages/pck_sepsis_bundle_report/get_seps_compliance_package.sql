-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


   -----------------------
CREATE OR REPLACE FUNCTION pck_sepsis_bundle_report.get_seps_compliance (nr_sequencia_p gqa_protocolo_etapa_pac.nr_sequencia%type) RETURNS bigint AS $body$
DECLARE

      is_compliance   bigint := 0;
      is_compliance_w bigint;

      --
      dt_inicio_sepesis_w   gqa_protocolo_etapa_pac.dt_inicio%type;
      nr_atendimento_w      gqa_protocolo_pac.nr_atendimento%type;


BEGIN

      select b.dt_inicio, --
             a.nr_atendimento
        into STRICT dt_inicio_sepesis_w, --
             nr_atendimento_w
        from gqa_protocolo_pac       a,
             gqa_protocolo_etapa_pac b
       where a.nr_sequencia = b.nr_seq_prot_pac
         and b.nr_sequencia = nr_sequencia_p;

      --
      is_compliance := pck_sepsis_bundle_report.get_seps_compl_blood(nr_atendimento_w);

      -- se conformidade atendida ou protocolo anterior nao aplicavel, testa regra seguinte
      if (is_compliance = 1 ) then

         -- 3654 ICCA Sepsis - Prescription order Lactate
         is_compliance_w := pck_sepsis_bundle_report.get_seps_compl_lactate(nr_atendimento_w);
         if (is_compliance_w IS NOT NULL AND is_compliance_w::text <> '') then
            is_compliance := is_compliance_w;
         end if;
      end if;

      -- se conformidade atendida ou protocolo anterior nao aplicavel, testa regra seguinte
      if (is_compliance = 1 ) then
         -- 3653 ICCA Sepsis - Prescription order Antibiotic
         is_compliance_w := pck_sepsis_bundle_report.get_seps_compl_antibiotic(nr_atendimento_w);
         if (is_compliance_w IS NOT NULL AND is_compliance_w::text <> '') then
            is_compliance := is_compliance_w;

         end if;
      end if;

      -- se conformidade atendida ou protocolo anterior nao aplicavel, testa regra seguinte
      if (is_compliance = 1 ) then
         -- 3350 ICCA sepsis - Compliance measure 1 treatment
         is_compliance_w := pck_sepsis_bundle_report.get_seps_compl_1_treatment(nr_atendimento_w);
         if (is_compliance_w IS NOT NULL AND is_compliance_w::text <> '') then
            is_compliance := is_compliance_w;
         end if;
      end if;

      -- se conformidade atendida ou protocolo anterior nao aplicavel, testa regra seguinte
      if (is_compliance = 1 ) then
         -- 3353 ICCA sepsis - Compliance measures 2 Treatment
         is_compliance_w := pck_sepsis_bundle_report.get_seps_compl_2_treatment(nr_atendimento_w);
         if (is_compliance_w IS NOT NULL AND is_compliance_w::text <> '') then
            is_compliance := is_compliance_w;

         end if;

      end if;
      return(is_compliance);

   END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pck_sepsis_bundle_report.get_seps_compliance (nr_sequencia_p gqa_protocolo_etapa_pac.nr_sequencia%type) FROM PUBLIC;
