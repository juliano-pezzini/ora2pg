-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE ptu_moviment_benef_a100_pck.processar_arquivo ( nr_seq_lote_p bigint, cd_unimed_destino_p ptu_mov_benef_destino.cd_unimed_destino%type, arq_texto_p utl_file.file_type) AS $body$
DECLARE


	ds_conteudo_w			varchar(4000);
	ptu_mov_benef_lote_w		ptu_mov_benef_lote%rowtype;
	ptu_mov_benef_contagem_w	ptu_mov_benef_contagem%rowtype;
	ptu_mov_benef_trailer_w		ptu_mov_benef_trailer%rowtype;
	ds_reservado_w			char(1);
	nr_contrato_w			bigint;
	nr_versao_transacao_w		varchar(10);
	nr_seq_intercabio_w		bigint;
	tp_registro_w			bigint;
	nr_sequencia_w			bigint;
	cd_tipo_registro_w		varchar(3);
	cd_unimed_destino_w		varchar(10);
	cd_unimed_origem_w		varchar(10);
	dt_geracao_w			timestamp;
	ie_tipo_mov_w			varchar(1);
	dt_mov_inicio_w			timestamp;
	dt_mov_fim_w			timestamp;
	cd_filial_w			bigint;
	nm_empr_comp_w			varchar(40);
	nm_empr_abrev_w			varchar(18);
	cd_cgc_cpf_w			varchar(14);
	nr_insc_estadual_w		bigint;
	ds_endereco_w			varchar(40);
	ds_complemento_w		varchar(20);
	ds_bairro_w			varchar(30);
	cd_cep_w			varchar(8);
	nm_cidade_w			varchar(4000);
	sg_uf_w				varchar(2);
	nr_ddd_w			bigint;
	dt_inclusao_w			timestamp;
	dt_exclusao_w			timestamp;
	cd_empresa_origem_w		bigint;
	cd_municipio_ibge_w		varchar(7);
	nr_telefone_w			bigint;
	nr_fax_w			bigint;
	nr_endereco_empresa_w		varchar(6);
	cd_plano_origem_w		varchar(6);
	ds_plano_origem_w		varchar(40);
	cd_plano_intercambio_w		varchar(3);
	dt_inclusao_plano_w		timestamp;
	dt_exclusao_plano_w		timestamp;
	ie_natureza_w			bigint;
	ie_abrangencia_w		bigint;
	nr_ind_reembolso		bigint;
	cd_ope_ans_w			varchar(10);
	cd_prod_ans_w			varchar(20);
	ie_plano_w			varchar(1);
	cd_unimed_w			varchar(10);
	cd_usuario_plano_w		varchar(13);
	cd_familia_w			bigint;
	nm_benef_abreviado_w		varchar(25);
	cd_plano_intercambio_benef_w	varchar(3);
	dt_nascimento_w			timestamp;
	ie_sexo_w			varchar(1);
	cd_cgc_cpf_benef_w		varchar(15);
	nr_rg_w				varchar(15);
	sg_uf_rg_w			varchar(2);
	ie_estado_civil_w		varchar(1);
	dt_inclusao_benef_w		timestamp;
	dt_exclusao_benef_w		timestamp;
	ie_repasse_w			varchar(1);
	cd_dependencia_w		bigint;
	ie_recem_nascido_w		varchar(1);
	nr_matricula_w			varchar(20);
	dt_validade_carteira_w		timestamp;
	cd_local_atendimento_w		bigint;
	cd_lotacao_w			varchar(8);
	ds_lotacao_w			varchar(30);
	dt_repasse_w			timestamp;
	dt_fim_repasse_w		timestamp;
	dt_inclusao_plano_dest_w	timestamp;
	cd_plano_origem_benef_w		varchar(6);
	nr_vigencia_origem_w		bigint;
	cd_titular_plano_w		varchar(13);
	nm_beneficiario_w		varchar(120);
	nr_cartao_nac_sus_w		varchar(20);
	nm_mae_benef_w			varchar(255);
	nr_pis_pasep_w			varchar(11);
	cd_segmentacao_ptu_w		varchar(2);
	cd_tipo_cobertura_w		varchar(3);
	dt_fim_carencia_w		timestamp;
	cd_tipo_produto_w		varchar(2);
	ds_produto_w			varchar(20);
	ds_endereco_benef_w		varchar(40);
	ds_bairro_benef_w		varchar(30);
	cd_cep_benef_w			bigint;
	nm_municipio_w			varchar(30);
	sg_uf_benef_w			varchar(15);
	nr_ddd_benef_w			bigint;
	nr_ramal_w			bigint;
	nr_fone_w			bigint;
	nr_endereco_w			varchar(6);
	cd_cid_w			varchar(4);
	dt_fim_carencia_preex_w		timestamp;
	qt_total_r102_w			varchar(4);
	qt_total_r103_w			varchar(4);
	qt_total_r104_w			varchar(7);
	qt_total_inclusao_w		varchar(7);
	qt_exclusos_benef_w		varchar(7);
	qt_total_alteracoes_w		bigint;
	qt_total_transferencia_w	bigint;
	qt_total_r105_w			varchar(7);
	qt_total_r106_w			varchar(7);
	qt_total_r107_w			varchar(7);
	qt_total_r108_w			varchar(7);
	dt_postagem_w			timestamp;
	nr_protocolo_w			bigint;
	nr_seq_plano_w			bigint;
	nr_seq_segurado_w		bigint;
	nr_seq_empresa_w		bigint;
	nr_seq_benef_w			bigint;
	nr_ind_reembolso_w		bigint;
	ds_hash_w			varchar(32);

	C01 CURSOR FOR
		SELECT  coalesce(nr_seq_intercabio,0),
			coalesce(tp_registro,0),
			coalesce(nr_sequencia,0),
			coalesce(cd_tipo_registro,0),
			coalesce(cd_unimed_destino,0),
			coalesce(cd_unimed_origem,0),
			dt_geracao,
			coalesce(ie_tipo_mov,' '),
			dt_mov_inicio,
			dt_mov_fim,
			coalesce(nr_versao_transacao,0),
			coalesce(cd_filial,0),
			coalesce(nm_empr_comp,' '),
			coalesce(nm_empr_abrev,' '),
			coalesce(ds_reservado,' '),
			coalesce(cd_cgc_cpf,0),
			nr_insc_estadual,
			coalesce(ds_endereco,' '),
			coalesce(ds_complemento,' '),
			coalesce(ds_bairro,' '),
			coalesce(cd_cep,0),
			coalesce(nm_cidade,' '),
			coalesce(sg_uf,' '),
			coalesce(nr_ddd,0),
			dt_inclusao,
			dt_exclusao,
			coalesce(cd_empresa_origem,0),
			coalesce(cd_municipio_ibge,0),
			nr_telefone,
			nr_fax,
			coalesce(nr_endereco_empresa,0),
			coalesce(cd_plano_origem,0),
			coalesce(ds_plano_origem,0),
			coalesce(cd_plano_intercambio,0),
			dt_inclusao_plano,
			dt_exclusao_plano,
			coalesce(ie_natureza,0),
			coalesce(ie_abrangencia,0),
			coalesce(nr_ind_reembolso,0),
			coalesce(cd_ope_ans,0),
			coalesce(cd_prod_ans,0),
			coalesce(ie_plano,' '),
			coalesce(cd_unimed,0),
			coalesce(cd_usuario_plano,0),
			coalesce(cd_familia,0),
			coalesce(nm_benef_abreviado,' '),
			coalesce(cd_plano_intercambio_benef,0),
			dt_nascimento,
			coalesce(ie_sexo,' '),
			coalesce(cd_cgc_cpf_benef,'0'),
			coalesce(nr_rg,' '),
			coalesce(sg_uf_rg,' '),
			coalesce(ie_estado_civil,' '),
			dt_inclusao_benef,
			dt_exclusao_benef,
			coalesce(ie_repasse,' '),
			coalesce(cd_dependencia,0),
			coalesce(ie_recem_nascido,' '),
			coalesce(nr_matricula,0),
			dt_validade_carteira,
			coalesce(cd_local_atendimento,0),
			coalesce(cd_lotacao,0),
			coalesce(ds_lotacao,' '),
			dt_repasse,
			dt_fim_repasse,
			dt_inclusao_plano_dest,
			coalesce(cd_plano_origem_benef,0),
			coalesce(nr_vigencia_origem,0),
			coalesce(cd_titular_plano,0),
			coalesce(nm_beneficiario,' '),
			coalesce(nr_cartao_nac_sus,' '),
			coalesce(nm_mae_benef,' '),
			coalesce(nr_pis_pasep,0),
			coalesce(cd_segmentacao_ptu,0),
			coalesce(cd_tipo_cobertura,0),
			dt_fim_carencia,
			coalesce(cd_tipo_produto,0),
			coalesce(ds_produto,' '),
			coalesce(ds_endereco_benef,' '),
			coalesce(ds_bairro_benef,' '),
			coalesce(cd_cep_benef,0),
			coalesce(nm_municipio,' '),
			coalesce(sg_uf_benef,0),
			coalesce(nr_ddd_benef,0),
			coalesce(nr_ramal,0),
			coalesce(nr_fone,0),
			coalesce(nr_endereco,0),
			coalesce(cd_cid,0),
			dt_fim_carencia_preex,
			coalesce(qt_total_r102,0),
			coalesce(qt_total_r103,0),
			coalesce(qt_total_r104,0),
			coalesce(qt_total_inclusao,0),
			coalesce(qt_exclusos_benef,0),
			coalesce(qt_total_alteracoes,0),
			coalesce(qt_total_transferencia,0),
			coalesce(qt_total_r105,0),
			coalesce(qt_total_r106,0),
			coalesce(qt_total_r107,0),
			coalesce(qt_total_r108,0),
			dt_postagem,
			coalesce(nr_protocolo,0),
			coalesce(nr_seq_plano,0),
			coalesce(nr_seq_segurado,0),
			coalesce(nr_seq_empresa,0),
			coalesce(nr_seq_benef,0)
		from	ptu_intercambio_70_v
		where	nr_seq_intercabio = get_cd_intercambio
		order by  nr_seq_empresa,nr_seq_benef,tp_registro;

	
BEGIN
	PERFORM set_config('ptu_moviment_benef_a100_pck.nr_sequencial_arq_w', 0, false);
	open C01;
	loop
	fetch C01 into
			nr_seq_intercabio_w,
			tp_registro_w,
			nr_sequencia_w,
			cd_tipo_registro_w,
			cd_unimed_destino_w,
			cd_unimed_origem_w,
			dt_geracao_w,
			ie_tipo_mov_w,
			dt_mov_inicio_w,
			dt_mov_fim_w,
			nr_versao_transacao_w,
			cd_filial_w,
			nm_empr_comp_w,
			nm_empr_abrev_w,
			ds_reservado_w,
			cd_cgc_cpf_w,
			nr_insc_estadual_w,
			ds_endereco_w,
			ds_complemento_w,
			ds_bairro_w,
			cd_cep_w,
			nm_cidade_w,
			sg_uf_w,
			nr_ddd_w,
			dt_inclusao_w,
			dt_exclusao_w,
			cd_empresa_origem_w,
			cd_municipio_ibge_w,
			nr_telefone_w,
			nr_fax_w,
			nr_endereco_empresa_w,
			cd_plano_origem_w,
			ds_plano_origem_w,
			cd_plano_intercambio_w,
			dt_inclusao_plano_w,
			dt_exclusao_plano_w,
			ie_natureza_w,
			ie_abrangencia_w,
			nr_ind_reembolso_w,
			cd_ope_ans_w,
			cd_prod_ans_w,
			ie_plano_w,
			cd_unimed_w,
			cd_usuario_plano_w,
			cd_familia_w,
			nm_benef_abreviado_w,
			cd_plano_intercambio_benef_w,
			dt_nascimento_w,
			ie_sexo_w,
			cd_cgc_cpf_benef_w,
			nr_rg_w,
			sg_uf_rg_w,
			ie_estado_civil_w,
			dt_inclusao_benef_w,
			dt_exclusao_benef_w,
			ie_repasse_w,
			cd_dependencia_w,
			ie_recem_nascido_w,
			nr_matricula_w,
			dt_validade_carteira_w,
			cd_local_atendimento_w,
			cd_lotacao_w,
			ds_lotacao_w,
			dt_repasse_w,
			dt_fim_repasse_w,
			dt_inclusao_plano_dest_w,
			cd_plano_origem_benef_w,
			nr_vigencia_origem_w,
			cd_titular_plano_w,
			nm_beneficiario_w,
			nr_cartao_nac_sus_w,
			nm_mae_benef_w,
			nr_pis_pasep_w,
			cd_segmentacao_ptu_w,
			cd_tipo_cobertura_w,
			dt_fim_carencia_w,
			cd_tipo_produto_w,
			ds_produto_w,
			ds_endereco_benef_w,
			ds_bairro_benef_w,
			cd_cep_benef_w,
			nm_municipio_w,
			sg_uf_benef_w,
			nr_ddd_benef_w,
			nr_ramal_w,
			nr_fone_w,
			nr_endereco_w,
			cd_cid_w,
			dt_fim_carencia_preex_w,
			qt_total_r102_w,
			qt_total_r103_w,
			qt_total_r104_w,
			qt_total_inclusao_w,
			qt_exclusos_benef_w,
			qt_total_alteracoes_w,
			qt_total_transferencia_w,
			qt_total_r105_w,
			qt_total_r106_w,
			qt_total_r107_w,
			qt_total_r108_w,
			dt_postagem_w,
			nr_protocolo_w,
			nr_seq_plano_w,
			nr_seq_segurado_w,
			nr_seq_empresa_w,
			nr_seq_benef_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		ds_conteudo_w := '';
		if (tp_registro_w = 1) then
			/*R101 - Header*/

			ds_conteudo_w	:= lpad(cd_unimed_destino_w,4,0) || lpad(cd_unimed_origem_w,4,0) || to_char(dt_geracao_w,'YYYYMMDD') ||
					lpad(ie_tipo_mov_w,1,0) || to_char(dt_mov_inicio_w,'YYYYMMDD') || to_char(dt_mov_fim_w,'YYYYMMDD') ||
					'15';
			CALL CALL CALL CALL CALL CALL ptu_moviment_benef_a100_pck.incluir_linha_arq('101',ds_conteudo_w,arq_texto_p);

		elsif (tp_registro_w = 2) then
			/*R102 - Empresa contratante*/

			ds_conteudo_w	:= lpad(ds_reservado_w,4,' ') || lpad(cd_filial_w,3,0) || rpad(nm_empr_comp_w,40,' ') ||
					rpad(nm_empr_abrev_w,18,' ') || lpad(ds_reservado_w,1,' ') || lpad(cd_cgc_cpf_w,15,'0') ||
					lpad(nr_insc_estadual_w,20,'0') || rpad(ds_endereco_w,40,' ') || rpad(ds_complemento_w,20,' ') ||
					rpad(ds_bairro_w,30,' ') || rpad(cd_cep_w,8,' ') || rpad(nm_cidade_w,30,' ') ||
					rpad(sg_uf_w,2,' ') || lpad(nr_ddd_w,4,0) || lpad(ds_reservado_w,8,' ') ||
					lpad(ds_reservado_w,8,' ') || coalesce(to_char(dt_inclusao_w,'YYYYMMDD'),'        ')|| coalesce(to_char(dt_exclusao_w,'YYYYMMDD'),'        ') ||
					lpad(cd_empresa_origem_w,10,0) || lpad(cd_municipio_ibge_w,7,0) || lpad(nr_telefone_w,9,'0') ||
					lpad(nr_fax_w,9,'0') || lpad(nr_endereco_empresa_w,6,'0');
			CALL CALL CALL CALL CALL CALL ptu_moviment_benef_a100_pck.incluir_linha_arq('102',ds_conteudo_w,arq_texto_p);

		elsif (tp_registro_w = 3) then
			/*R103 - Plano da Empresa Contratante*/

			ds_conteudo_w	:= lpad(cd_plano_origem_w,6,' ') || rpad(ds_plano_origem_w,40,' ') || lpad(ds_reservado_w,2,' ') ||
					coalesce(to_char(dt_inclusao_plano_w,'YYYYMMDD'),'        ') || coalesce(to_char(dt_exclusao_plano_w,'YYYYMMDD'),'        ') || lpad(ie_natureza_w,1,' ') ||
					lpad(ie_abrangencia_w,1,' ') || lpad(nr_ind_reembolso_w,5,0) || lpad(cd_ope_ans_w,10,'0') ||
					lpad(cd_prod_ans_w,20,'0') || lpad(ie_plano_w,1,' ') || rpad(cd_plano_intercambio_w,3,' ');
			CALL CALL CALL CALL CALL CALL ptu_moviment_benef_a100_pck.incluir_linha_arq('103',ds_conteudo_w,arq_texto_p);

		elsif (tp_registro_w = 4) then
			/*R104 - Beneficiário*/

			ds_conteudo_w	:= lpad(cd_unimed_w,4,0) || lpad(ds_reservado_w,3,' ') || lpad(cd_usuario_plano_w,13,' ') ||
					lpad(cd_familia_w,6,0) || rpad(nm_benef_abreviado_w,25,' ') || lpad(ds_reservado_w,2,' ') ||
					to_char(dt_nascimento_w,'YYYYMMDD') || lpad(ie_sexo_w,1,' ') || lpad(cd_cgc_cpf_benef_w,15,'0') ||
					lpad(nr_rg_w,15,'0') || lpad(sg_uf_rg_w,2,' ') || lpad(ie_estado_civil_w,1,' ') ||
					to_char(dt_inclusao_benef_w,'YYYYMMDD') || coalesce(to_char(dt_exclusao_benef_w,'YYYYMMDD'),'        ') || lpad(ie_repasse_w,1,' ') ||
					lpad(cd_dependencia_w,2,0) || lpad(ie_recem_nascido_w,1,' ') || lpad(nr_matricula_w,20,'0') ||
					to_char(dt_validade_carteira_w,'YYYYMMDD') || lpad(cd_local_atendimento_w,4,0) || lpad(cd_lotacao_w,8,'0') ||
					lpad(ds_lotacao_w,30,' ') || lpad(ds_reservado_w,64,' ') || coalesce(to_char(dt_repasse_w,'YYYYMMDD'),'        ') ||
					coalesce(to_char(dt_fim_repasse_w,'YYYYMMDD'),'        ') || coalesce(to_char(dt_inclusao_plano_dest_w,'YYYYMMDD'),'        ') ||
					lpad(ds_reservado_w,2,' ') || lpad(cd_plano_origem_benef_w,6,0) || lpad(nr_vigencia_origem_w,4,0) ||
					lpad(cd_titular_plano_w,13,0) || rpad(nm_beneficiario_w,120,' ') || lpad(nr_cartao_nac_sus_w,15,0) ||
					rpad(nm_mae_benef_w,70,' ') || 	lpad(nr_pis_pasep_w,11,'0') || rpad(cd_plano_intercambio_benef_w,3,' ') || lpad(cd_segmentacao_ptu_w,2,0);
			CALL CALL CALL CALL CALL CALL ptu_moviment_benef_a100_pck.incluir_linha_arq('104',ds_conteudo_w,arq_texto_p);

		elsif (tp_registro_w = 5) then
			/*R105 - Carência do Beneficiário*/

			ds_conteudo_w	:= lpad(cd_tipo_cobertura_w,3,0) || to_char(dt_fim_carencia_w,'YYYYMMDD');
			CALL CALL CALL CALL CALL CALL ptu_moviment_benef_a100_pck.incluir_linha_arq('105',ds_conteudo_w,arq_texto_p);

		elsif (tp_registro_w = 6) then
			/*R106 - Módulos opcionais do Beneficiário*/

			ds_conteudo_w	:= rpad(cd_tipo_produto_w,2,' ') || rpad(ds_produto_w,20,' ');
			CALL CALL CALL CALL CALL CALL ptu_moviment_benef_a100_pck.incluir_linha_arq('106',ds_conteudo_w,arq_texto_p);

		elsif (tp_registro_w = 7) then
			/*R107 - Complemento Cadastral do Beneficiário*/

			ds_conteudo_w	:= rpad(ds_endereco_benef_w,40,' ') || rpad(ds_bairro_benef_w,30,' ') || lpad(cd_cep_benef_w,8,'0') ||
					rpad(nm_municipio_w,30,' ') || rpad(sg_uf_benef_w,2,' ') || lpad(nr_ddd_benef_w,4,0) ||
					lpad(ds_reservado_w,8,' ') || lpad(nr_ramal_w,4,'0') || lpad(nr_fone_w,9,'0') ||
					lpad(nr_endereco_w,6,'0');
			CALL CALL CALL CALL CALL CALL ptu_moviment_benef_a100_pck.incluir_linha_arq('107',ds_conteudo_w,arq_texto_p);

		elsif (tp_registro_w = 8) then
			/*R108 - Preexistência - do Beneficiário*/

			ds_conteudo_w	:= rpad(cd_cid_w,4,' ') || to_char(dt_fim_carencia_preex_w,'YYYYMMDD');

			CALL CALL CALL CALL CALL CALL ptu_moviment_benef_a100_pck.incluir_linha_arq('108',ds_conteudo_w,arq_texto_p);

		elsif (tp_registro_w = 9) then
			/*R109 - Trailer*/

			ds_conteudo_w	:= lpad(qt_total_r102_w,4,0) || lpad(qt_total_r103_w,4,0) || lpad(qt_total_r104_w,7,0) ||
					lpad(qt_total_inclusao_w,7,0) || lpad(qt_exclusos_benef_w,7,0) || lpad(qt_total_alteracoes_w,7,0) ||
					lpad(qt_total_transferencia_w,7,0) || lpad(qt_total_r105_w,7,0) || lpad(qt_total_r106_w,7,0) ||
					lpad(qt_total_r107_w,7,0) || lpad(qt_total_r108_w,7,0);
			CALL CALL CALL CALL CALL CALL ptu_moviment_benef_a100_pck.incluir_linha_arq('109',ds_conteudo_w,arq_texto_p);

		end if;
		end;
	end loop;
	close C01;

	current_setting('ptu_moviment_benef_a100_pck.ds_arquivo_w')::text := pls_hash_ptu_pck.obter_hash_txt(current_setting('ptu_moviment_benef_a100_pck.ds_arquivo_w')::text);
	ds_conteudo_w		:=	lpad(ds_hash_w,32,' ');
	CALL CALL CALL CALL CALL CALL ptu_moviment_benef_a100_pck.incluir_linha_arq('998',ds_conteudo_w,arq_texto_p);

	update 	ptu_intercambio
	set 	ds_hash_a100	= ds_hash_w,
		nm_arquivo 	= get_nome_arquivo
	where 	nr_sequencia 	= ptu_moviment_benef_a100_pck.get_cd_intercambio();
	commit;
	end;


$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ptu_moviment_benef_a100_pck.processar_arquivo ( nr_seq_lote_p bigint, cd_unimed_destino_p ptu_mov_benef_destino.cd_unimed_destino%type, arq_texto_p utl_file.file_type) FROM PUBLIC;
