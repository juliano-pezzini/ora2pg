-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_ar_gerar_resultado_pck.selecionar_reembolsos (nr_seq_lote_p pls_ar_lote.nr_sequencia%type, dt_inicio_p pls_ar_lote.dt_inicio%type, dt_fim_p pls_ar_lote.dt_fim%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) AS $body$
DECLARE

ie_forma_pagamento_w	pls_ar_lote.ie_forma_pagamento%type;


BEGIN
select	coalesce(max(ie_forma_pagamento), 'P')
into STRICT	ie_forma_pagamento_w
from	pls_ar_lote
where	nr_sequencia = nr_seq_lote_p;

	begin
		insert into pls_ar_reembolso(nr_sequencia,
			nr_seq_lote,
			cd_estabelecimento,
			nm_usuario,
			nm_usuario_nrec,
			dt_atualizacao,
			dt_atualizacao_nrec,
			vl_total,
			nr_seq_segurado,
			nr_seq_conta,
			ie_tipo_protocolo,
			nr_seq_plano,
			ie_tipo_segurado,
			ie_tipo_vinculo_operadora,
			nr_seq_contrato,
			nr_seq_pagador,
			nr_seq_intercambio,
			ie_preco,
			ie_regulamentacao,
			ie_tipo_contratacao,
			nr_seq_faixa_etaria,
			ie_situacao_trabalhista,
			nr_seq_congenere_repasse,
			ie_tipo_contrato,
			nr_seq_grupo_intercambio)
		SELECT	nextval('pls_ar_conta_seq'),
			nr_seq_lote_p,
			cd_estabelecimento_p,
			nm_usuario_p,
			nm_usuario_p,
			clock_timestamp(),
			clock_timestamp(),
			coalesce(t.vl_total,0) vl_total,
			t.nr_seq_segurado,
			t.nr_seq_conta,
			t.ie_tipo_protocolo,
			coalesce(t.nr_seq_plano_conta, a.nr_seq_plano) nr_seq_plano,
			coalesce(t.ie_tipo_segurado, coalesce(a.ie_tipo_segurado,'B')) ie_tipo_segurado,
			a.ie_tipo_vinculo_operadora ie_tipo_vinculo_operadora,
			a.nr_seq_contrato nr_seq_contrato,
			a.nr_seq_pagador nr_seq_pagador,
			a.nr_seq_intercambio nr_seq_intercambio,
			b.ie_preco ie_preco,
			b.ie_regulamentacao ie_regulamentacao,
			b.ie_tipo_contratacao ie_tipo_contratacao,
			c.nr_seq_faixa_etaria nr_seq_faixa_etaria,
			a.ie_situacao_trabalhista ie_situacao_trabalhista,
			(	SELECT	x.nr_seq_congenere
				from	pls_segurado_repasse	x
				where	x.nr_seq_segurado	= t.nr_seq_segurado
				and	t.dt_mes_competencia between x.dt_repasse and coalesce(x.dt_fim_repasse, clock_timestamp())
			 LIMIT 1) nr_seq_congenere_repasse,
			case when (a.nr_seq_contrato IS NOT NULL AND a.nr_seq_contrato::text <> '')
					then CASE WHEN coalesce(e.cd_cgc_estipulante::text, '') = '' THEN  'PF'  ELSE 'PJ' END 
				else (case when (a.nr_seq_intercambio IS NOT NULL AND a.nr_seq_intercambio::text <> '')
						then CASE WHEN coalesce(f.cd_cgc::text, '') = '' THEN  'PF'  ELSE 'PJ' END 
					else null
				end)
			end ie_tipo_contrato,
			f.nr_seq_grupo_intercambio nr_seq_grupo_intercambio
		FROM (	select	coalesce(x.vl_liberado, 0) vl_total,
				y.nr_seq_segurado,
				y.nr_sequencia nr_seq_conta,
				z.ie_tipo_protocolo,
				y.nr_seq_plano nr_seq_plano_conta,
				z.dt_mes_competencia,
				y.ie_tipo_segurado
			from	pls_conta_proc		x,
				pls_conta		y,
				pls_protocolo_conta	z
			where	y.nr_sequencia	= x.nr_seq_conta
			and	z.nr_sequencia	= y.nr_seq_protocolo
			and	z.dt_mes_competencia between dt_inicio_p and dt_fim_p
			and	z.ie_tipo_protocolo	= 'R'
			and	z.ie_situacao in ('D', 'T')
			and	y.ie_status = 'F'
			and	ie_forma_pagamento_w = 'C'
			
union all

			select	coalesce(x.vl_liberado, 0) vl_total,
				y.nr_seq_segurado,
				y.nr_sequencia nr_seq_conta,
				z.ie_tipo_protocolo,
				y.nr_seq_plano nr_seq_plano_conta,
				z.dt_mes_competencia,
				y.ie_tipo_segurado
			from	pls_conta_mat		x,
				pls_conta		y,
				pls_protocolo_conta	z
			where	y.nr_sequencia	= x.nr_seq_conta
			and	z.nr_sequencia	= y.nr_seq_protocolo
			and	z.dt_mes_competencia between dt_inicio_p and dt_fim_p
			and	z.ie_tipo_protocolo	= 'R'
			and	z.ie_situacao in ('D', 'T')
			and	y.ie_status = 'F'
			and	ie_forma_pagamento_w = 'C'
			
union all

			select	coalesce(x.vl_liberado, 0) vl_total,
				y.nr_seq_segurado,
				y.nr_sequencia nr_seq_conta,
				z.ie_tipo_protocolo,
				y.nr_seq_plano nr_seq_plano_conta,
				z.dt_mes_competencia,
				y.ie_tipo_segurado
			from	pls_conta_proc		x,
				pls_conta		y,
				pls_protocolo_conta	z
			where	y.nr_sequencia	= x.nr_seq_conta
			and	z.nr_sequencia	= y.nr_seq_protocolo
			and	z.dt_mes_competencia between dt_inicio_p and dt_fim_p
			and	z.ie_tipo_protocolo = 'R'
			and	z.ie_situacao in ('D', 'T')
			and	y.ie_status	<> 'C'
			and	z.ie_status in ('3','6')
			and	ie_forma_pagamento_w = 'P'
			
union all

			select	coalesce(x.vl_liberado, 0) vl_total,
				y.nr_seq_segurado,
				y.nr_sequencia nr_seq_conta,
				z.ie_tipo_protocolo,
				y.nr_seq_plano nr_seq_plano_conta,
				z.dt_mes_competencia,
				y.ie_tipo_segurado
			from	pls_conta_mat		x,
				pls_conta		y,
				pls_protocolo_conta	z
			where	y.nr_sequencia	= x.nr_seq_conta
			and	z.nr_sequencia	= y.nr_seq_protocolo
			and	z.dt_mes_competencia between dt_inicio_p and dt_fim_p
			and	z.ie_tipo_protocolo = 'R'
			and	z.ie_situacao in ('D', 'T')
			and	y.ie_status	<> 'C'
			and	z.ie_status in ('3','6')
			and	ie_forma_pagamento_w = 'P') t, pls_plano b, pls_segurado a
LEFT OUTER JOIN pls_contrato e ON (a.nr_seq_contrato = e.nr_sequencia)
LEFT OUTER JOIN pls_intercambio f ON (a.nr_seq_intercambio = f.nr_sequencia)
LEFT OUTER JOIN pls_tabela_preco c ON (a.nr_seq_tabela = c.nr_sequencia)
WHERE a.nr_sequencia		= t.nr_seq_segurado and a.cd_estabelecimento 	= cd_estabelecimento_p and b.nr_sequencia		= t.nr_seq_plano_conta;
		
		commit;
	exception
		when no_data_found then null;
	end;
	
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_ar_gerar_resultado_pck.selecionar_reembolsos (nr_seq_lote_p pls_ar_lote.nr_sequencia%type, dt_inicio_p pls_ar_lote.dt_inicio%type, dt_fim_p pls_ar_lote.dt_fim%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) FROM PUBLIC;
