-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



-- POPULAR_GRUPOS_CONTRATOS



CREATE OR REPLACE PROCEDURE pls_ar_gerar_resultado_pck.popular_grupos_contratos ( nr_seq_lote_p pls_ar_lote.nr_sequencia%type, nm_tabela_p text, nm_usuario_p usuario.nm_usuario%type) AS $body$
BEGIN

	begin
		insert into pls_ar_grupo_contrato(nr_sequencia,
			nm_usuario,
			nm_usuario_nrec,
			dt_atualizacao,
			dt_atualizacao_nrec,
			nr_seq_grupo_contrato,
			nr_seq_reg_tabela,
			ds_tabela,
			nr_seq_lote)
		SELECT	nextval('pls_ar_grupo_contrato_seq'),
			nm_usuario_p,
			nm_usuario_p,
			clock_timestamp(),
			clock_timestamp(),
			w.nr_seq_grupo_contrato,
			w.nr_seq_reg_tabela,
			w.nm_tabela,
			nr_seq_lote_p
		from (SELECT	nr_seq_grupo_contrato,
				nr_seq_reg_tabela,
				nm_tabela
			from (	select	y.nr_sequencia nr_seq_grupo_contrato,
					t.nr_seq_reg_tabela,
					nm_tabela
				from (	select	nr_sequencia nr_seq_reg_tabela,
						nr_seq_contrato,
						'PLS_AR_MENSALIDADE' nm_tabela
					from	pls_ar_mensalidade
					where	nr_seq_lote = nr_seq_lote_p
					and	(nr_seq_contrato IS NOT NULL AND nr_seq_contrato::text <> '')
					
union all

					select	nr_sequencia nr_seq_reg_tabela,
						nr_seq_contrato,
						'PLS_AR_CONTA' nm_tabela
					from	pls_ar_conta
					where	nr_seq_lote = nr_seq_lote_p
					and	(nr_seq_contrato IS NOT NULL AND nr_seq_contrato::text <> '')
					
union all

					select	nr_sequencia nr_seq_reg_tabela,
						nr_seq_contrato,
						'PLS_AR_REEMBOLSO' nm_tabela
					from	pls_ar_reembolso
					where	nr_seq_lote = nr_seq_lote_p
					and	(nr_seq_contrato IS NOT NULL AND nr_seq_contrato::text <> '')
					
union all

					select	nr_sequencia nr_seq_reg_tabela,
						nr_seq_contrato,
						'PLS_AR_COPARTICIPACAO' nm_tabela
					from	pls_ar_coparticipacao
					where	nr_seq_lote = nr_seq_lote_p
					and	(nr_seq_contrato IS NOT NULL AND nr_seq_contrato::text <> '')
					
union all

					select	nr_sequencia nr_seq_reg_tabela,
						nr_seq_contrato,
						'PLS_AR_COMISSAO' nm_tabela
					from	pls_ar_comissao
					where	nr_seq_lote = nr_seq_lote_p
					and	(nr_seq_contrato IS NOT NULL AND nr_seq_contrato::text <> '')
					
union all

					select	nr_sequencia nr_seq_reg_tabela,
						nr_seq_contrato,
						'PLS_AR_RESS_SUS' nm_tabela
					from	pls_ar_ress_sus
					where	nr_seq_lote = nr_seq_lote_p
					and	(nr_seq_contrato IS NOT NULL AND nr_seq_contrato::text <> '')
					
union all

					select	nr_sequencia nr_seq_reg_tabela,
						nr_seq_contrato,
						'PLS_AR_REC_GLOSA' nm_tabela
					from	pls_ar_rec_glosa
					where	nr_seq_lote = nr_seq_lote_p
					and	(nr_seq_contrato IS NOT NULL AND nr_seq_contrato::text <> '')
					
union all

					select	nr_sequencia nr_seq_reg_tabela,
						nr_seq_contrato,
						'PLS_AR_CONTESTACAO' nm_tabela
					from	pls_ar_contestacao
					where	nr_seq_lote = nr_seq_lote_p
					and	(nr_seq_contrato IS NOT NULL AND nr_seq_contrato::text <> '')
					
union all

					select	nr_sequencia nr_seq_reg_tabela,
						nr_seq_contrato,
						'PLS_AR_FATURAMENTO' nm_tabela
					from	pls_ar_faturamento
					where	nr_seq_lote = nr_seq_lote_p
					and	(nr_seq_contrato IS NOT NULL AND nr_seq_contrato::text <> '')
					)	t,
					
					pls_contrato_grupo	z,
					pls_grupo_contrato	y
				where	z.nr_seq_contrato	= t.nr_seq_contrato
				and	z.nr_seq_grupo		= y.nr_sequencia
				group by	y.nr_sequencia,
						t.nr_seq_reg_tabela,
						nm_tabela)	t
			) w;
		
		commit;
	exception
		when no_data_found then null;
	end;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_ar_gerar_resultado_pck.popular_grupos_contratos ( nr_seq_lote_p pls_ar_lote.nr_sequencia%type, nm_tabela_p text, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;
