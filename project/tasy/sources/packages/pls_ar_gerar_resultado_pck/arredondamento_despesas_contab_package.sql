-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_ar_gerar_resultado_pck.arredondamento_despesas_contab ( nr_seq_desp_contab_p pls_ar_despesa_contab_lote.nr_sequencia%type, vl_despesa_p pls_ar_despesa_contab_lote.vl_despesa%type) AS $body$
DECLARE


tb_nr_seq_desp_cotab_w	pls_util_cta_pck.t_number_table;
tb_vl_despesa_w		pls_util_cta_pck.t_number_table;
nr_indice_w		integer;

vl_despesa_aprop_w	pls_ar_despesa_contabil.vl_despesa%type;

C01 CURSOR(	nr_seq_desp_contab_pc	pls_ar_despesa_contab_lote.nr_sequencia%type) FOR
	SELECT	nr_sequencia,
		vl_despesa
	from	pls_ar_despesa_contabil
	where	nr_seq_desp_contabil	= nr_seq_desp_contab_pc
	order by vl_despesa asc,
		vl_mensalidade desc;

C02 CURSOR(	nr_seq_desp_contab_pc	pls_ar_despesa_contab_lote.nr_sequencia%type) FOR
	SELECT	nr_sequencia,
		vl_despesa
	from	pls_ar_despesa_contabil
	where	nr_seq_desp_contabil	= nr_seq_desp_contab_pc
	order by vl_despesa desc,
		vl_mensalidade asc;

BEGIN

select	sum(vl_despesa)
into STRICT	vl_despesa_aprop_w
from	pls_ar_despesa_contabil
where	nr_seq_desp_contabil = nr_seq_desp_contab_p;

while(vl_despesa_p <> vl_despesa_aprop_w) loop
	begin
	tb_nr_seq_desp_cotab_w.delete;
	tb_vl_despesa_w.delete;
	nr_indice_w	:= 0;
	
	if (vl_despesa_aprop_w < vl_despesa_p) then --Quando o valor rateado e menor que o valor da despesa
		for r_c01_w in C01(nr_seq_desp_contab_p) loop
			begin
			if (vl_despesa_p = vl_despesa_aprop_w) then
				exit;
			else
				vl_despesa_aprop_w	:= vl_despesa_aprop_w + 0.01;
				
				tb_nr_seq_desp_cotab_w(nr_indice_w)	:= r_c01_w.nr_sequencia;
				tb_vl_despesa_w(nr_indice_w)		:= r_c01_w.vl_despesa + 0.01;
				
				if (nr_indice_w > current_setting('pls_ar_gerar_resultado_pck.qt_registro_transacao_w')::integer) then
					forall i in tb_nr_seq_desp_cotab_w.first .. tb_nr_seq_desp_cotab_w.last
						update	pls_ar_despesa_contabil
						set	vl_despesa	= tb_vl_despesa_w(i)
						where	nr_sequencia	= tb_nr_seq_desp_cotab_w(i);
					commit;
					
					tb_nr_seq_desp_cotab_w.delete;
					tb_vl_despesa_w.delete;
					nr_indice_w	:= 0;
				else
					nr_indice_w	:= nr_indice_w + 1;
				end if;
			end if;
			end;
		end loop; --C01
	elsif (vl_despesa_aprop_w > vl_despesa_p) then --Quando o valor rateado e maior que o valor da despesa
		for r_c02_w in C02(nr_seq_desp_contab_p) loop
			begin
			if (vl_despesa_p = vl_despesa_aprop_w) then
				exit;
			else
				vl_despesa_aprop_w	:= vl_despesa_aprop_w - 0.01;
				
				tb_nr_seq_desp_cotab_w(nr_indice_w)	:= r_c02_w.nr_sequencia;
				tb_vl_despesa_w(nr_indice_w)		:= r_c02_w.vl_despesa - 0.01;
				
				if (nr_indice_w > current_setting('pls_ar_gerar_resultado_pck.qt_registro_transacao_w')::integer) then
					forall i in tb_nr_seq_desp_cotab_w.first .. tb_nr_seq_desp_cotab_w.last
						update	pls_ar_despesa_contabil
						set	vl_despesa	= tb_vl_despesa_w(i)
						where	nr_sequencia	= tb_nr_seq_desp_cotab_w(i);
					commit;
					
					tb_nr_seq_desp_cotab_w.delete;
					tb_vl_despesa_w.delete;
					nr_indice_w	:= 0;
				else
					nr_indice_w	:= nr_indice_w + 1;
				end if;
			end if;
			end;
		end loop; --C02
	end if;
	
	if (tb_nr_seq_desp_cotab_w.count > 0) then
		forall i in tb_nr_seq_desp_cotab_w.first .. tb_nr_seq_desp_cotab_w.last
			update	pls_ar_despesa_contabil
			set	vl_despesa	= tb_vl_despesa_w(i)
			where	nr_sequencia	= tb_nr_seq_desp_cotab_w(i);
		commit;
	end if;
	
	end;
end loop;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_ar_gerar_resultado_pck.arredondamento_despesas_contab ( nr_seq_desp_contab_p pls_ar_despesa_contab_lote.nr_sequencia%type, vl_despesa_p pls_ar_despesa_contab_lote.vl_despesa%type) FROM PUBLIC;
