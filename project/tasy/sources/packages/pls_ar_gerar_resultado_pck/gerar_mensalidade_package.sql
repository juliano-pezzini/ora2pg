-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


-- GERAR_MENSALIDADE



CREATE OR REPLACE PROCEDURE pls_ar_gerar_resultado_pck.gerar_mensalidade ( nr_seq_lote_p pls_ar_lote.nr_sequencia%type, dt_inicio_p pls_ar_lote.dt_inicio%type, dt_fim_p pls_ar_lote.dt_fim%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) AS $body$
DECLARE


ie_pro_rata_w	pls_parametros_ar.ie_pro_rata%type;

BEGIN

select	max(ie_pro_rata)
into STRICT	ie_pro_rata_w
from	pls_parametros_ar
where	cd_estabelecimento	= cd_estabelecimento_p  LIMIT 1;
ie_pro_rata_w	:= coalesce(ie_pro_rata_w,'S');

begin
	insert into pls_ar_mensalidade(nr_sequencia,
		nm_usuario,
		nm_usuario_nrec,
		dt_atualizacao,
		dt_atualizacao_nrec,
		cd_estabelecimento,
		nr_seq_lote,
		dt_contabilizacao,
		nr_seq_mens_segurado,
		nr_seq_item_mens,
		nr_seq_segurado,
		vl_item,
		vl_pro_rata,
		vl_coparticipacao,
		vl_antecipacao,
		ie_tipo_registro,
		nr_seq_plano,
		ie_tipo_segurado,
		ie_tipo_vinculo_operadora,
		nr_seq_contrato,
		nr_seq_pagador,
		nr_seq_intercambio,
		ie_preco,
		ie_regulamentacao,
		ie_tipo_contratacao,
		nr_seq_faixa_etaria,
		ie_situacao_trabalhista,
		nr_seq_congenere_repasse,
		ie_tipo_contrato,
		nr_seq_grupo_intercambio)
	SELECT	nextval('pls_ar_mensalidade_seq'),
		nm_usuario_p,
		nm_usuario_p,
		clock_timestamp(),
		clock_timestamp(),
		cd_estabelecimento_p,
		nr_seq_lote_p,
		t.dt_contabilizacao,
		t.nr_seq_mens_segurado,
		t.nr_seq_item_mens,
		t.nr_seq_segurado,
		t.vl_mensalidade,
		0,
		0,
		0,
		'MM',
		coalesce(t.nr_seq_plano, a.nr_seq_plano) nr_seq_plano,
		coalesce(a.ie_tipo_segurado,'B') ie_tipo_segurado,
		a.ie_tipo_vinculo_operadora ie_tipo_vinculo_operadora,
		a.nr_seq_contrato nr_seq_contrato,
		a.nr_seq_pagador nr_seq_pagador,
		a.nr_seq_intercambio nr_seq_intercambio,
		b.ie_preco ie_preco,
		b.ie_regulamentacao ie_regulamentacao,
		b.ie_tipo_contratacao ie_tipo_contratacao,
		c.nr_seq_faixa_etaria nr_seq_faixa_etaria,
		a.ie_situacao_trabalhista ie_situacao_trabalhista,
		(	SELECT	x.nr_seq_congenere
			from	pls_segurado_repasse	x
			where	x.nr_seq_segurado	= t.nr_seq_segurado
			and	t.dt_contabilizacao between x.dt_repasse and coalesce(x.dt_fim_repasse, clock_timestamp())
		 LIMIT 1) nr_seq_congenere_repasse,
		case when (a.nr_seq_contrato IS NOT NULL AND a.nr_seq_contrato::text <> '')
				then CASE WHEN coalesce(e.cd_cgc_estipulante::text, '') = '' THEN  'PF'  ELSE 'PJ' END 
			else (case when (a.nr_seq_intercambio IS NOT NULL AND a.nr_seq_intercambio::text <> '')
					then CASE WHEN coalesce(f.cd_cgc::text, '') = '' THEN  'PF'  ELSE 'PJ' END 
				else null
			end)
		end ie_tipo_contrato,
		f.nr_seq_grupo_intercambio nr_seq_grupo_intercambio
	FROM (
		select 	x.nr_seq_item_mens,
			x.dt_contabilizacao,
			x.nr_seq_mens_segurado,
			x.nr_seq_segurado,
			sum(x.vl_mensalidade) vl_mensalidade,
			x.nr_seq_plano
		from (	--Mensalidades de meses anteriores - Gerada com a opcao "Gerar mensalidades abertas meses anteriores"
			select	d.nr_sequencia nr_seq_item_mens,
				trunc(a.dt_contabilizacao) dt_contabilizacao,
				c.nr_sequencia nr_seq_mens_segurado,
				c.nr_seq_segurado nr_seq_segurado,
				d.vl_item - CASE WHEN d.ie_tipo_item='3' THEN d.vl_item  ELSE (select	coalesce(sum(x.vl_devolucao_mens),0)										from	pls_solic_resc_fin_item x,											pls_solic_rescisao_fin	y										where	d.nr_sequencia = x.nr_seq_item_mensalidade										and	x.nr_seq_solic_resc_fin = y.nr_sequencia										and	y.ie_status <> '7' ) END  vl_mensalidade,
				c.nr_seq_plano
			FROM pls_plano pl, pls_mensalidade_segurado c, pls_mensalidade b, pls_lote_mensalidade a, pls_mensalidade_seg_item d
LEFT OUTER JOIN pls_tipo_lanc_adic e ON (d.nr_seq_tipo_lanc = e.nr_sequencia)
WHERE c.nr_sequencia			= d.nr_seq_mensalidade_seg and b.nr_sequencia			= c.nr_seq_mensalidade and a.nr_sequencia			= b.nr_seq_lote and c.nr_seq_plano			= pl.nr_sequencia  and coalesce(b.ie_cancelamento::text, '') = '' and a.ie_status			= '2' and a.dt_mesano_referencia between dt_inicio_p and dt_fim_p and a.ie_mensalidade_mes_anterior	= 'S' and a.cd_estabelecimento		= cd_estabelecimento_p
			 
union all

			-- Mensalidade normal, sem considerar Pro Rata

			select	d.nr_sequencia nr_seq_item_mens,
				trunc(a.dt_contabilizacao) dt_contabilizacao,
				c.nr_sequencia nr_seq_mens_segurado,
				s.nr_sequencia nr_seq_segurado,
				(d.vl_item - (	select	coalesce(sum(x.vl_devolucao_mens),0)
						from	pls_solic_resc_fin_item x,
							pls_solic_rescisao_fin	y
						where	d.nr_sequencia = x.nr_seq_item_mensalidade
						and	x.nr_seq_solic_resc_fin = y.nr_sequencia
						and	y.ie_status <> '7' )) vl_mensalidade,
				c.nr_seq_plano
			FROM pls_segurado s, pls_plano pl, pls_mensalidade_segurado c, pls_mensalidade b, pls_lote_mensalidade a, pls_mensalidade_seg_item d
LEFT OUTER JOIN pls_tipo_lanc_adic e ON (d.nr_seq_tipo_lanc = e.nr_sequencia)
WHERE c.nr_sequencia			= d.nr_seq_mensalidade_seg and b.nr_sequencia			= c.nr_seq_mensalidade and a.nr_sequencia			= b.nr_seq_lote and s.nr_sequencia			= c.nr_seq_segurado and c.nr_seq_plano			= pl.nr_sequencia  and coalesce(b.ie_cancelamento::text, '') = '' and a.ie_status			= '2' and b.dt_referencia between dt_inicio_p and dt_fim_p and ((d.ie_tipo_item not in ('3','20')) or (d.ie_tipo_item = '20' and e.ie_considera_receita = 'S')) and (a.ie_mensalidade_mes_anterior	= 'N' or coalesce(a.ie_mensalidade_mes_anterior::text, '') = '') and a.cd_estabelecimento		= cd_estabelecimento_p and ie_pro_rata_w		= 'N'
			 
union all

			-- Mensalidade normal, Valor Pro Rata

			select	d.nr_sequencia nr_seq_item_mens,
				trunc(a.dt_contabilizacao) dt_contabilizacao,
				c.nr_sequencia nr_seq_mens_segurado,
				c.nr_seq_segurado nr_seq_segurado,
				(d.vl_pro_rata_dia - (	select	coalesce(sum(x.vl_pro_rata_dia),0)
							from	pls_solic_resc_fin_item x,
								pls_solic_rescisao_fin	y
							where	d.nr_sequencia = x.nr_seq_item_mensalidade
							and	x.nr_seq_solic_resc_fin = y.nr_sequencia
							and	y.ie_status <> '7' )) vl_mensalidade,
				c.nr_seq_plano
			FROM pls_plano pl, pls_mensalidade_segurado c, pls_mensalidade b, pls_lote_mensalidade a, pls_mensalidade_seg_item d
LEFT OUTER JOIN pls_tipo_lanc_adic e ON (d.nr_seq_tipo_lanc = e.nr_sequencia)
WHERE c.nr_sequencia			= d.nr_seq_mensalidade_seg and b.nr_sequencia			= c.nr_seq_mensalidade and a.nr_sequencia			= b.nr_seq_lote and c.nr_seq_plano			= pl.nr_sequencia  and coalesce(b.ie_cancelamento::text, '') = '' and a.ie_status			= '2' and b.dt_referencia between dt_inicio_p and dt_fim_p and ((d.ie_tipo_item not in ('3','20')) or (d.ie_tipo_item = '20' and e.ie_considera_receita = 'S')) and (a.ie_mensalidade_mes_anterior	= 'N' or coalesce(a.ie_mensalidade_mes_anterior::text, '') = '') and a.cd_estabelecimento		= cd_estabelecimento_p and ie_pro_rata_w		= 'S'
			 
union all

			-- Mensalidade normal, Valor Antecipacao

			select	d.nr_sequencia nr_seq_item_mens,
				trunc(a.dt_contabilizacao) dt_contabilizacao,
				c.nr_sequencia nr_seq_mens_segurado,
				c.nr_seq_segurado nr_seq_segurado,
				(d.vl_antecipacao - (	select	coalesce(sum(x.vl_antecipacao),0)
							from	pls_solic_resc_fin_item x,
								pls_solic_rescisao_fin	y
							where	d.nr_sequencia = x.nr_seq_item_mensalidade
							and	x.nr_seq_solic_resc_fin = y.nr_sequencia
							and	y.ie_status <> '7' )) vl_mensalidade,
				c.nr_seq_plano
			FROM pls_plano pl, pls_mensalidade_segurado c, pls_mensalidade b, pls_lote_mensalidade a, pls_mensalidade_seg_item d
LEFT OUTER JOIN pls_tipo_lanc_adic e ON (d.nr_seq_tipo_lanc = e.nr_sequencia)
WHERE c.nr_sequencia			= d.nr_seq_mensalidade_seg and b.nr_sequencia			= c.nr_seq_mensalidade and a.nr_sequencia			= b.nr_seq_lote and c.nr_seq_plano			= pl.nr_sequencia  and coalesce(b.ie_cancelamento::text, '') = '' and a.ie_status			= '2' and d.dt_antecipacao between dt_inicio_p and dt_fim_p and ((d.ie_tipo_item not in ('3','20')) or (d.ie_tipo_item = '20' and e.ie_considera_receita = 'S')) and (a.ie_mensalidade_mes_anterior	= 'N' or coalesce(a.ie_mensalidade_mes_anterior::text, '') = '') and a.cd_estabelecimento		= cd_estabelecimento_p and ie_pro_rata_w		= 'S'
			 ) x
		group by
			x.nr_seq_item_mens,
			x.dt_contabilizacao,
			x.nr_seq_mens_segurado,
			x.nr_seq_segurado,
			x.nr_seq_plano
		) t, pls_plano b, pls_segurado a
LEFT OUTER JOIN pls_contrato e ON (a.nr_seq_contrato = e.nr_sequencia)
LEFT OUTER JOIN pls_intercambio f ON (a.nr_seq_intercambio = f.nr_sequencia)
LEFT OUTER JOIN pls_tabela_preco c ON (a.nr_seq_tabela = c.nr_sequencia)
WHERE a.nr_sequencia		= t.nr_seq_segurado and b.nr_sequencia		= t.nr_seq_plano    and vl_mensalidade <> 0;
	
	commit;
exception
	when no_data_found then null;
end;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_ar_gerar_resultado_pck.gerar_mensalidade ( nr_seq_lote_p pls_ar_lote.nr_sequencia%type, dt_inicio_p pls_ar_lote.dt_inicio%type, dt_fim_p pls_ar_lote.dt_fim%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) FROM PUBLIC;
