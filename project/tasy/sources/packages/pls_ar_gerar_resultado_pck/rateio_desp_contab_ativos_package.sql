-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_ar_gerar_resultado_pck.rateio_desp_contab_ativos ( nr_seq_lote_p pls_ar_lote.nr_sequencia%type, nr_seq_desp_contab_p pls_ar_despesa_contab_lote.nr_sequencia%type, ie_tipo_despesa_p pls_ar_despesa_contab_lote.ie_tipo_despesa%type, vl_despesa_p pls_ar_despesa_contab_lote.vl_despesa%type, qt_beneficiarios_p pls_ar_despesa_contab_lote.qt_beneficiarios%type, qt_regra_p integer, dt_fim_p pls_ar_lote.dt_fim%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) AS $body$
DECLARE

vl_rateio_w	pls_ar_despesa_contabil.vl_despesa%type;
qt_rownum_w	integer;

BEGIN
	vl_rateio_w	:= dividir(vl_despesa_p,qt_beneficiarios_p);
	qt_rownum_w	:= 0;
	
	if (vl_rateio_w = 0) then
		qt_rownum_w	:= vl_despesa_p*100; --Quantidade de beneficiarios considerando rateio de 1 centavo para cada
		if (vl_despesa_p < 0) then
			vl_rateio_w	:= -0.01;
		else
			vl_rateio_w	:= 0.01;
		end if;
	end if;
	
	begin
	insert into pls_ar_despesa_contabil(nr_sequencia,
		nm_usuario,
		nm_usuario_nrec,
		dt_atualizacao,
		dt_atualizacao_nrec,
		cd_estabelecimento,
		nr_seq_lote,
		vl_despesa,
		ie_tipo_despesa,
		nr_seq_segurado,
		nr_seq_desp_contabil,
		nr_seq_plano,
		ie_tipo_segurado,
		ie_tipo_vinculo_operadora,
		nr_seq_contrato,
		nr_seq_pagador,
		nr_seq_intercambio,
		ie_preco,
		ie_regulamentacao,
		ie_tipo_contratacao,
		nr_seq_faixa_etaria,
		ie_situacao_trabalhista,
		nr_seq_congenere_repasse,
		ie_tipo_contrato,
		nr_seq_grupo_intercambio)
	SELECT	nextval('pls_ar_despesa_contabil_seq'),
		nm_usuario_p,
		nm_usuario_p,
		clock_timestamp(),
		clock_timestamp(),
		cd_estabelecimento_p,
		nr_seq_lote_p,
		vl_rateio_w,
		ie_tipo_despesa_p,
		a.nr_sequencia nr_seq_segurado,
		nr_seq_desp_contab_p,
		a.nr_seq_plano,
		coalesce(a.ie_tipo_segurado,'B') ie_tipo_segurado,
		a.ie_tipo_vinculo_operadora ie_tipo_vinculo_operadora,
		a.nr_seq_contrato nr_seq_contrato,
		a.nr_seq_pagador nr_seq_pagador,
		a.nr_seq_intercambio nr_seq_intercambio,
		b.ie_preco ie_preco,
		b.ie_regulamentacao ie_regulamentacao,
		b.ie_tipo_contratacao ie_tipo_contratacao,
		c.nr_seq_faixa_etaria nr_seq_faixa_etaria,
		a.ie_situacao_trabalhista ie_situacao_trabalhista,
		(	SELECT	x.nr_seq_congenere
			from	pls_segurado_repasse	x
			where	x.nr_seq_segurado	= a.nr_sequencia
			and	dt_fim_p between x.dt_repasse and coalesce(x.dt_fim_repasse, clock_timestamp())
		 LIMIT 1) nr_seq_congenere_repasse,
		case when (a.nr_seq_contrato IS NOT NULL AND a.nr_seq_contrato::text <> '')
				then CASE WHEN coalesce(e.cd_cgc_estipulante::text, '') = '' THEN  'PF'  ELSE 'PJ' END 
			else (case when (a.nr_seq_intercambio IS NOT NULL AND a.nr_seq_intercambio::text <> '')
					then CASE WHEN coalesce(f.cd_cgc::text, '') = '' THEN  'PF'  ELSE 'PJ' END 
				else null
			end)
		end ie_tipo_contrato,
		f.nr_seq_grupo_intercambio nr_seq_grupo_intercambio
	FROM pls_plano b, pls_segurado a
LEFT OUTER JOIN pls_contrato e ON (a.nr_seq_contrato = e.nr_sequencia)
LEFT OUTER JOIN pls_intercambio f ON (a.nr_seq_intercambio = f.nr_sequencia)
LEFT OUTER JOIN pls_tabela_preco c ON (a.nr_seq_tabela = c.nr_sequencia)
WHERE b.nr_sequencia		= a.nr_seq_plano    and (a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '') and a.dt_contratacao <= dt_fim_p and ((coalesce(a.dt_rescisao::text, '') = '') or (a.dt_rescisao > dt_fim_p)) and ((qt_regra_p = 0) or (exists (select	1
			from	pls_ar_desp_contab_regra x
			where	x.nr_seq_ar_desp_contab	= nr_seq_desp_contab_p
			and	x.ie_tipo_segurado	= a.ie_tipo_segurado))) and ((qt_rownum_w = 0) or (rownum <= qt_rownum_w));
	commit;
	exception
		when no_data_found then null;
	end;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_ar_gerar_resultado_pck.rateio_desp_contab_ativos ( nr_seq_lote_p pls_ar_lote.nr_sequencia%type, nr_seq_desp_contab_p pls_ar_despesa_contab_lote.nr_sequencia%type, ie_tipo_despesa_p pls_ar_despesa_contab_lote.ie_tipo_despesa%type, vl_despesa_p pls_ar_despesa_contab_lote.vl_despesa%type, qt_beneficiarios_p pls_ar_despesa_contab_lote.qt_beneficiarios%type, qt_regra_p integer, dt_fim_p pls_ar_lote.dt_fim%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) FROM PUBLIC;
