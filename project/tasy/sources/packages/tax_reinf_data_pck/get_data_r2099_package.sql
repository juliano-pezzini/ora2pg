-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION tax_reinf_data_pck.get_data_r2099 (batch_code_p text) RETURNS SETOF R2099_TABLE_W AS $body$
DECLARE

    r2099_data_w    r2099_record_w;

    c_r2099 CURSOR FOR
      SELECT  tax_reinf_data_pck.get_event_id(e.cd_cgc, rownum) identification,
              f.ie_tipo_ambiente  environment_type,
              '1' emission,	
              '1' subscription_type,
              substr(e.cd_cgc, 1, 8)  subscription, 
              to_char(f.dt_geracao, 'rrrr-mm') calculation_period,
              elimina_caractere_especial(substr((SELECT nm_pessoa_fisica from pessoa_fisica where cd_pessoa_fisica = (select em.cd_contabilista cd_contabilista from estabelecimento es, empresa em where es.cd_empresa = em.cd_empresa and cd_estabelecimento = e.cd_estabelecimento)), 1, 70)) accountant_name, 						     
              (select nr_cpf from pessoa_fisica where cd_pessoa_fisica = (select em.cd_contabilista cd_contabilista from estabelecimento es, empresa em where es.cd_empresa = em.cd_empresa and cd_estabelecimento = e.cd_estabelecimento)) accountant_cpf,			  
              substr(somente_numero_char(obter_dados_pf_pj(null, e.cd_cgc, 'DDT') || obter_dados_pf_pj(null, e.cd_cgc, 'T')), 1, 13) accountant_phone,
              substr(obter_dados_pf_pj_estab(e.cd_estabelecimento, null, e.cd_cgc, 'M'), 1, 60) accountant_email,
              coalesce(f.ie_contrat_serv_prev, 'N') has_services_taken,
              coalesce(f.ie_prest_serv_prev, 'N') has_services_provided,       
              'N' has_received,
              coalesce(f.ie_possui_repasse, 'N') has_transfer,
              'N' has_compensation,
              coalesce(f.ie_possui_cprb, 'N') has_cprb,
              'N' has_acquisition
      from    estabelecimento e,
              fis_reinf_r2099 f
      where   e.cd_estabelecimento = f.cd_estabelecimento
      and     f.nr_sequencia = batch_code_p;

BEGIN
      for r2099_row in c_r2099 loop
        begin
        r2099_data_w.identification         := r2099_row.identification;
        r2099_data_w.environment_type       := r2099_row.environment_type;
        r2099_data_w.emission               := r2099_row.emission;
        r2099_data_w.subscription_type      := r2099_row.subscription_type;
        r2099_data_w.subscription           := r2099_row.subscription;
        r2099_data_w.calculation_period     := r2099_row.calculation_period;
        r2099_data_w.accountant_name        := r2099_row.accountant_name;
        r2099_data_w.accountant_cpf         := r2099_row.accountant_cpf;
        r2099_data_w.accountant_phone       := r2099_row.accountant_phone;
        r2099_data_w.accountant_email       := r2099_row.accountant_email;
        r2099_data_w.has_services_taken     := r2099_row.has_services_taken;
        r2099_data_w.has_services_provided  := r2099_row.has_services_provided;
        r2099_data_w.has_received           := r2099_row.has_received;
        r2099_data_w.has_transfer           := r2099_row.has_transfer;
        r2099_data_w.has_compensation       := r2099_row.has_compensation;
        r2099_data_w.has_cprb               := r2099_row.has_cprb;
        r2099_data_w.has_acquisition        := r2099_row.has_acquisition;
        RETURN NEXT r2099_data_w;
        end;
      end loop;
    return;
  END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION tax_reinf_data_pck.get_data_r2099 (batch_code_p text) FROM PUBLIC;
