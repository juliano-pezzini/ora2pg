-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE tax_reinf_data_pck.save_response (establishment_code_p bigint, username_p text, batch_code_p bigint, log_code_p bigint, xml_p text, status_message_p text, event_p bigint, id_p text, error_code_p text default null, error_message_p text default null, registration_type_p bigint DEFAULT NULL, registration_p text DEFAULT NULL, status_p bigint DEFAULT NULL, process_date_p text DEFAULT NULL, hash_p text DEFAULT NULL, receipt_p text default null, provider_registration_p text default null, protocol_p text default null) AS $body$
DECLARE

    process_date_w timestamp;

BEGIN
    if status_p = 0 and event_p in (2010, 2020) then
      CALL tax_reinf_data_pck.update_invoice_status(batch_code_p, event_p, receipt_p, provider_registration_p);
    elsif status_p in (0, 2) and event_p in (2099, 5011) then
      CALL tax_reinf_data_pck.update_batch_closing(batch_code_p, status_p, error_code_p, error_message_p, protocol_p, id_p, hash_p);
    end if;

    if (process_date_p IS NOT NULL AND process_date_p::text <> '') then
      process_date_w := tax_reinf_data_pck.changedatetodefault(process_date_p);
    end if;

    if (process_date_w IS NOT NULL AND process_date_w::text <> '') then
      insert into fis_reinf_logs(	nr_sequencia,
                                  cd_estabelecimento,
                                  dt_atualizacao,
                                  nm_usuario,
                                  dt_atualizacao_nrec,
                                  nm_usuario_nrec,
                                  ie_tipo_inscricao,
                                  nr_inscricao,
                                  ie_tipo_evento,
                                  id_evento,
                                  cd_hash,
                                  ds_retorno,
                                  cd_erro,
                                  ds_erro,
                                  dt_processamento,
                                  ds_xml,
                                  nr_seq_lote,
                                  nr_seq_log) 
                        values (  nextval('fis_reinf_logs_seq'),
                                  establishment_code_p,
                                  clock_timestamp(),
                                  username_p,
                                  clock_timestamp(),
                                  username_p,
                                  registration_type_p,
                                  registration_p,
                                  event_p,
                                  id_p,
                                  hash_p,
                                  status_message_p,
                                  error_code_p,
                                  substr(error_message_p, 1, 255),
                                  process_date_w,
                                  xml_p,
                                  batch_code_p,
                                  log_code_p);
        commit;
    end if;
  END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE tax_reinf_data_pck.save_response (establishment_code_p bigint, username_p text, batch_code_p bigint, log_code_p bigint, xml_p text, status_message_p text, event_p bigint, id_p text, error_code_p text default null, error_message_p text default null, registration_type_p bigint DEFAULT NULL, registration_p text DEFAULT NULL, status_p bigint DEFAULT NULL, process_date_p text DEFAULT NULL, hash_p text DEFAULT NULL, receipt_p text default null, provider_registration_p text default null, protocol_p text default null) FROM PUBLIC;
