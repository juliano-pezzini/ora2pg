-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION tax_reinf_data_pck.get_data_suspension_r2010 (batch_code_p text, supplier_registration_p fis_reinf_notas_r2010.cd_cnpj%type) RETURNS SETOF R2010_SUSPENSION_TABLE_W AS $body$
DECLARE

    r2010_suspension_data_w    r2010_suspension_record_w;

    c_r2010_suspension CURSOR FOR
      SELECT  cd_tipo_processo process_type,
              nr_processo process_number,
              cd_ind_exigibilidade process_indicator,
              sum(vl_n_retencao_inss) value_non_retained
      from    fis_reinf_r1070 a,
              fis_reinf_exib_trib b,
              fis_reinf_notas_r2010 c,
              fis_reinf_r2010 d
      where   a.cd_cnpj = supplier_registration_p
      and     a.nr_sequencia = b.nr_seq_superior
      and     a.cd_cnpj = c.cd_cnpj
      and     c.nr_seq_superior = d.nr_sequencia
      and     d.nr_sequencia = batch_code_p
      and     d.cd_tributo = a.cd_tributo
      and     to_date(d.dt_competencia, 'dd/mm/yyyy') between to_date(a.dt_inicio_validade, 'dd/mm/yyyy') and fim_dia(to_date(coalesce(a.dt_fim_validade, clock_timestamp()), 'dd/mm/yyyy'))
      group by  cd_tipo_processo,
                nr_processo,
                cd_ind_exigibilidade;

BEGIN
    for r2010_suspension_row in c_r2010_suspension loop
      begin
        r2010_suspension_data_w.process_type        :=  r2010_suspension_row.process_type;
        r2010_suspension_data_w.process_number      :=  r2010_suspension_row.process_number;
        r2010_suspension_data_w.process_indicator   :=  r2010_suspension_row.process_indicator;
        r2010_suspension_data_w.value_non_retained  :=  r2010_suspension_row.value_non_retained;
        RETURN NEXT r2010_suspension_data_w;
      end;
    end loop;
    return;
  END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION tax_reinf_data_pck.get_data_suspension_r2010 (batch_code_p text, supplier_registration_p fis_reinf_notas_r2010.cd_cnpj%type) FROM PUBLIC;
