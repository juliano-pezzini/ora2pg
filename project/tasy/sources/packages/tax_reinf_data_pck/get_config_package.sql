-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION tax_reinf_data_pck.get_config (establishment_code_p bigint, username_p text, event_p text, event_type_p text, environment_p text) RETURNS SETOF CONFIG_TABLE_DATA_W AS $body$
DECLARE


    config_data_w     config_record_w;
    layout_version_w  tax_reinf_config.ds_reinf_version%type;
    certificate_w     credenciais_integracao.ds_endereco_certificado%type;

    c_tasy_config CURSOR FOR
      SELECT (SELECT max(cd_versao) cd from aplicacao_tasy_versao) system_version,	
              obter_valor_param_usuario(5500, 62, obter_perfil_ativo, username_p, establishment_code_p) layout_version,
              obter_valor_param_usuario(9041, 11, obter_perfil_ativo, username_p, establishment_code_p) tasy_interface_host
;

    c_reinf_config CURSOR(layout_version_p  tax_reinf_config.ds_reinf_version%type) FOR
      SELECT  CASE WHEN e.ie_send=1 THEN  CASE WHEN environment_p=1 THEN  g.ds_send_production_endp  ELSE g.ds_send_homologation_endp END  WHEN e.ie_send=0 THEN  CASE WHEN environment_p=1 THEN  g.ds_query_production_endp  ELSE g.ds_query_homologation_endp END  END  endpoint,
              e.ds_signature_tag signature_tag,
              e.ds_xmlns event_xmlns,
              e.ds_action event_action,
              e.ie_send sending
      from    tax_reinf_config g,
              tax_reinf_event_config e
      where   g.ds_reinf_version = e.ds_reinf_version
      and     g.ds_reinf_version = layout_version_p
      and     e.nr_event = event_p;

BEGIN
    select  max(ds_endereco_certificado) 
    into STRICT    certificate_w
    from    credenciais_integracao 
    where   ie_sistema = 'SPED_REINF'
    and     cd_estabelecimento = establishment_code_p;

    for tasy_config_row in c_tasy_config loop
      begin
        layout_version_w                    := tax_reinf_data_pck.format_version(tasy_config_row.layout_version);

        for reinf_config_row in c_reinf_config(layout_version_w) loop
          begin
            config_data_w.endpoint          := reinf_config_row.endpoint;
            config_data_w.signature_tag     := reinf_config_row.signature_tag;
            config_data_w.event_xmlns       := reinf_config_row.event_xmlns;
            config_data_w.event_action      := reinf_config_row.event_action;
            config_data_w.sending           := reinf_config_row.sending;
          end;
        end loop;

        config_data_w.layout_version        := layout_version_w;
        config_data_w.system_version        := tasy_config_row.system_version;
        config_data_w.tasy_interface_host   := tax_reinf_data_pck.format_url(tasy_config_row.tasy_interface_host);
        config_data_w.template_name         := tax_reinf_data_pck.get_template_name(event_p, event_type_p);
        config_data_w.certificate           := certificate_w;
        RETURN NEXT config_data_w;
      end;
    end loop;
    return;
  END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION tax_reinf_data_pck.get_config (establishment_code_p bigint, username_p text, event_p text, event_type_p text, environment_p text) FROM PUBLIC;
