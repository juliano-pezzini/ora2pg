-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION tax_reinf_data_pck.get_data_r1070 (batch_code_p text) RETURNS SETOF R1070_TABLE_W AS $body$
DECLARE

    r1070_data_w    r1070_record_w;

    c_r1070 CURSOR FOR
      SELECT  tax_reinf_data_pck.get_event_id(e.cd_cgc, rownum) identification,
              f.ie_ambiente  environment_type,
              '1' emission,	   
              '1' subscription_type,
              substr(e.cd_cgc, 1, 8) subscription, 
              to_char(f.dt_inicio_validade, 'YYYY-MM') initial_date,
              to_char(f.dt_fim_validade, 'YYYY-MM') final_date,
              coalesce(f.cd_tipo_processo, 1) process_type,
              f.nr_processo process_number,
              f.cd_ind_auditoria audit_code,
              substr(obter_uf_ibge(f.cd_municipio), 1, 2) vara_county_state, 
              lpad(substr(f.cd_municipio, 1, 7) || substr(calcula_digito('MODULO10', f.cd_municipio), 1, 1), 7, 0) vara_county_code,  
              substr(f.cd_ident_vara, 1, 2) vara_code
      from    estabelecimento e,
              fis_reinf_r1070 f
      where   e.cd_estabelecimento = f.cd_estabelecimento
      and     f.nr_sequencia = batch_code_p;

BEGIN
    for r1070_row in c_r1070 loop
      begin
        r1070_data_w.identification       := r1070_row.identification;
        r1070_data_w.environment_type     := r1070_row.environment_type;
        r1070_data_w.emission             := r1070_row.emission;
        r1070_data_w.subscription_type    := r1070_row.subscription_type;
        r1070_data_w.subscription         := r1070_row.subscription;
        r1070_data_w.initial_date         := r1070_row.initial_date;
        r1070_data_w.final_date           := r1070_row.final_date;
        r1070_data_w.process_type         := r1070_row.process_type;
        r1070_data_w.process_number       := r1070_row.process_number;
        r1070_data_w.audit_code           := r1070_row.audit_code;
        RETURN NEXT r1070_data_w;
      end;
    end loop;
    return;
  END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION tax_reinf_data_pck.get_data_r1070 (batch_code_p text) FROM PUBLIC;
