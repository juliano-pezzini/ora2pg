-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION tax_reinf_data_pck.get_data_r2040 (batch_code_p text) RETURNS SETOF R2040_TABLE_W AS $body$
DECLARE

    r2040_data_w    r2040_record_w;

    c_2040 CURSOR FOR
      SELECT  tax_reinf_data_pck.get_event_id(e.cd_cgc, rownum) identification,
              '1' emission,	
              '1' subscription_type, 
              substr(e.cd_cgc, 1, 8) subscription, 
              f.ie_tipo_ambiente environment_type,
              f.ie_retificacao rectification,
              f.nr_recibo receipt,
              to_char(f.dt_apuracao, 'rrrr-mm') competence,
              1 estab_subscription_type,
              e.cd_cgc establishment_subscription
      from 	  estabelecimento e,
              fis_reinf_r2040 f
      where	  e.cd_estabelecimento = f.cd_estabelecimento
      and 	  f.nr_sequencia  = batch_code_p;

BEGIN
    for r2040_row in c_2040 loop
      begin
        r2040_data_w.identification                 := r2040_row.identification;
        r2040_data_w.emission                       := r2040_row.emission;
        r2040_data_w.subscription_type              := r2040_row.subscription_type;
        r2040_data_w.subscription                   := r2040_row.subscription;
        r2040_data_w.environment_type               := r2040_row.environment_type;
        r2040_data_w.rectification                  := r2040_row.rectification;
        r2040_data_w.receipt                        := r2040_row.receipt;
        r2040_data_w.competence                     := r2040_row.competence;
        r2040_data_w.estab_subscription_type        := r2040_row.estab_subscription_type;
        r2040_data_w.establishment_subscription     := r2040_row.establishment_subscription;
        RETURN NEXT r2040_data_w;
      end;
    end loop;
    return;
  END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION tax_reinf_data_pck.get_data_r2040 (batch_code_p text) FROM PUBLIC;
