-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION tax_reinf_data_pck.get_data_invoice_r2020 (batch_code_p text, supplier_registration_p fis_reinf_notas_r2020.cd_cnpj%type, national_works_code_p text) RETURNS SETOF R2020_INVOICE_TABLE_W AS $body$
DECLARE

    r2020_invoice_data_w    r2020_invoice_record_w;

    c_r2020_invoice CURSOR FOR
      SELECT  distinct n.cd_serie_nf series,
              n.nr_nota_fiscal code,
              to_char(n.dt_emissao, 'rrrr-mm-dd') issue,
              r.vl_bruto_nf amount,
              coalesce(substr(elimina_caractere_especial(obter_texto_sem_quebras(n.ds_observacao)), 1, 250), 'Sem nenhuma observacao') note,
              n.nr_sequencia invoice_sequence
      from 	  fis_reinf_notas_r2020 r,
              nota_fiscal n
      where   r.nr_seq_nota = n.nr_sequencia
      and 	  r.nr_seq_superior = batch_code_p
      and 	  n.cd_cgc = supplier_registration_p;

BEGIN
    for r2020_invoice_row in c_r2020_invoice loop
      begin
        r2020_invoice_data_w.series           := r2020_invoice_row.series;
        r2020_invoice_data_w.code             := r2020_invoice_row.code;
        r2020_invoice_data_w.issue            := r2020_invoice_row.issue;
        r2020_invoice_data_w.amount           := r2020_invoice_row.amount;
        r2020_invoice_data_w.note             := r2020_invoice_row.note;
        r2020_invoice_data_w.invoice_sequence := r2020_invoice_row.invoice_sequence;
        RETURN NEXT r2020_invoice_data_w;
      end;
    end loop;
    return;
  END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION tax_reinf_data_pck.get_data_invoice_r2020 (batch_code_p text, supplier_registration_p fis_reinf_notas_r2020.cd_cnpj%type, national_works_code_p text) FROM PUBLIC;
