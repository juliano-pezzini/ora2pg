-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION tax_reinf_data_pck.get_data_type_title_r2040 (batch_code_p text, subscription_p titulo_pagar.cd_cgc%type) RETURNS SETOF R2040_TYPE_TITLE_TABLE_W AS $body$
DECLARE

    r2040_type_title_data_w    r2040_type_title_record_w;

    c_2040 CURSOR FOR
      SELECT  f.ie_tipo_repasse type_service,
              sum(coalesce(f.vl_titulo, 0)) total_value,
              sum(coalesce(f.vl_retencao, 0)) total_retained,
              substr(max(ds_observacao), 1, 20) note	     
      from    titulo_pagar t,
              fis_reinf_tit_r2040 f	
      where 	f.nr_titulo = t.nr_titulo
      and 	  f.nr_seq_superior = batch_code_p
      and 	  t.cd_cgc = subscription_p
      group by f.ie_tipo_repasse;

BEGIN
    for r2040_row in c_2040 loop
      begin
        r2040_type_title_data_w.type_service                := r2040_row.type_service;
        r2040_type_title_data_w.total_value                 := r2040_row.total_value;
        r2040_type_title_data_w.total_retained              := r2040_row.total_retained;
        r2040_type_title_data_w.note                        := r2040_row.note;
        RETURN NEXT r2040_type_title_data_w;
      end;
    end loop;
    return;
  END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION tax_reinf_data_pck.get_data_type_title_r2040 (batch_code_p text, subscription_p titulo_pagar.cd_cgc%type) FROM PUBLIC;
