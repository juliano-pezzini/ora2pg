-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION tiss_dashboard_data_pck.obter_possui_guia_grg_retorno (nr_seq_protocolo_p protocolo_convenio.nr_seq_protocolo%type, cd_convenio_p convenio.cd_convenio%Type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) RETURNS varchar AS $body$
DECLARE


ie_possui_w varchar(1);

qt_reg_w bigint;

cd_estabelecimento_w	estabelecimento.cd_estabelecimento%type := cd_estabelecimento_p;
cd_convenio_w		convenio.cd_convenio%type := cd_convenio_p;
dt_envio_recurso_w  timestamp;
dt_envio_grg_w  timestamp;


BEGIN

	ie_possui_w := 'N';
	
	select 	coalesce(count(a.nr_sequencia), 0)
	into STRICT	qt_reg_w
	from	convenio_retorno a,
		convenio_retorno_item b
	where	b.nr_seq_retorno = a.nr_sequencia
	and	a.ie_status_retorno <> 'F'
	and	a.cd_estabelecimento = cd_estabelecimento_w
	and	a.cd_convenio = cd_convenio_w
	and	b.nr_interno_conta in (SELECT x.nr_interno_conta from conta_paciente x where x.nr_seq_protocolo = nr_seq_protocolo_p);
	
	if qt_reg_w > 0 then
		ie_possui_w := 'S';
	else
		select 	coalesce(count(a.nr_sequencia), 0)
		into STRICT	qt_reg_w
		from	lote_auditoria a,
			lote_audit_hist b,
			lote_audit_hist_guia c
		where	c.nr_seq_lote_hist = b.nr_sequencia
		and	b.nr_seq_lote_audit = a.nr_sequencia
		and	a.cd_estabelecimento = cd_estabelecimento_w
		and	a.cd_convenio = cd_convenio_w
		and	coalesce(b.dt_envio::text, '') = ''
		and	coalesce(b.dt_fechamento::text, '') = ''
		and	c.nr_interno_conta in (SELECT x.nr_interno_conta from conta_paciente x where nr_seq_protocolo = nr_seq_protocolo_p);
		
		if qt_reg_w > 0 then
			ie_possui_w := 'S';
		else			
			
			select 	dt_envio_recurso
			into STRICT	dt_envio_recurso_w				
			from	protocolo_faturado
			where	nr_seq_protocolo = nr_seq_protocolo_p;

			select  coalesce(max(a.dt_envio), max(l.dt_lote))
			into STRICT    dt_envio_grg_w
			from    lote_audit_hist a,
				lote_audit_hist_guia b,
				lote_auditoria l,
				conta_paciente cp
			where   a.nr_seq_lote_audit 	= l.nr_sequencia
			and     a.nr_sequencia 		= b.nr_seq_lote_hist
			and     l.cd_convenio 		= cd_convenio_w
			and     l.cd_estabelecimento 	= cd_estabelecimento_w
			and     cp.nr_interno_conta 	= b.nr_interno_conta
			and     cp.nr_seq_protocolo 	= nr_seq_protocolo_p;

			if (dt_envio_grg_w IS NOT NULL AND dt_envio_grg_w::text <> '') and (coalesce(dt_envio_recurso_w,clock_timestamp() + interval '1 days') <> dt_envio_grg_w) then
				ie_possui_w := 'S';
			end if;
			
		end if;
		
	end if;
	
	return ie_possui_w;

end;


$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION tiss_dashboard_data_pck.obter_possui_guia_grg_retorno (nr_seq_protocolo_p protocolo_convenio.nr_seq_protocolo%type, cd_convenio_p convenio.cd_convenio%Type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) FROM PUBLIC;
