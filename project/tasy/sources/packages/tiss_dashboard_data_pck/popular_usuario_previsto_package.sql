-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE tiss_dashboard_data_pck.popular_usuario_previsto (nr_seq_conc_guia_p conciliacao_conta_pac_guia.nr_sequencia%type, nr_interno_conta_p conta_paciente.nr_interno_conta%type, cd_autorizacao_p conta_paciente_guia.cd_autorizacao%type) AS $body$
DECLARE


usuarios CURSOR FOR
SELECT 	distinct a.nm_usuario_previsto nome
from 	lote_audit_hist_item a,
	lote_audit_hist_guia b
where 	a.nr_seq_guia = b.nr_sequencia
and	(a.nm_usuario_previsto IS NOT NULL AND a.nm_usuario_previsto::text <> '')
and	b.nr_interno_conta = nr_interno_conta_p
and	b.cd_autorizacao = cd_autorizacao_p;

qt_analisado_w bigint;
qt_pendente_w bigint;

nr_seq_usu_resp_w	usuario_resp_item_rec.nr_sequencia%type;

BEGIN
	
	for usuario in usuarios loop
		
		select 	count(a.nr_sequencia)
		into STRICT	qt_analisado_w
		from	lote_audit_hist_item a,
			lote_audit_hist_guia b
		where	a.nr_seq_guia 		= b.nr_sequencia
		and	b.nr_interno_conta 	= nr_interno_conta_p
		and	b.cd_autorizacao 	= cd_autorizacao_p
		and	(a.ie_acao_glosa IS NOT NULL AND a.ie_acao_glosa::text <> '')
		and	a.nm_usuario_resp 	= usuario.nome;
		
		select 	count(a.nr_sequencia)
		into STRICT	qt_pendente_w
		from	lote_audit_hist_item a,
			lote_audit_hist_guia b
		where	a.nr_seq_guia 		= b.nr_sequencia
		and	b.nr_interno_conta 	= nr_interno_conta_p
		and	b.cd_autorizacao 	= cd_autorizacao_p
		and	coalesce(a.ie_acao_glosa::text, '') = ''
		and	a.nm_usuario_previsto 	= usuario.nome;
		
		select	nextval('usuario_resp_item_rec_seq')
		into STRICT	nr_seq_usu_resp_w
		;
		
		insert into usuario_resp_item_rec(
			nm_usuario,
			nm_usuario_nrec,
			dt_atualizacao,
			dt_atualizacao_nrec,
			nm_usuario_previsto,
			qt_itens_analisados,
			qt_itens_pendentes,
			nr_sequencia,
			nr_seq_conc_guia
		)
		values (
			current_setting('tiss_dashboard_data_pck.nm_usuario_job_w')::usuario.nm_usuario%type,
			current_setting('tiss_dashboard_data_pck.nm_usuario_job_w')::usuario.nm_usuario%type,
			clock_timestamp(),
			clock_timestamp(),
			usuario.nome,
			coalesce(qt_analisado_w, 0),
			coalesce(qt_pendente_w, 0),			
			nr_seq_usu_resp_w,
			nr_seq_conc_guia_p
		);
		
	end loop;
	
end;


$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE tiss_dashboard_data_pck.popular_usuario_previsto (nr_seq_conc_guia_p conciliacao_conta_pac_guia.nr_sequencia%type, nr_interno_conta_p conta_paciente.nr_interno_conta%type, cd_autorizacao_p conta_paciente_guia.cd_autorizacao%type) FROM PUBLIC;
