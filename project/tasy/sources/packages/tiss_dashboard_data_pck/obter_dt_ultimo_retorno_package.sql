-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION tiss_dashboard_data_pck.obter_dt_ultimo_retorno (nr_interno_conta_p conta_paciente.nr_interno_conta%type, cd_autorizacao_p conta_paciente_guia.cd_autorizacao%type) RETURNS timestamp AS $body$
DECLARE


dt_retorno_w timestamp;

dt_ret_conv_w timestamp;
dt_lote_audit_w timestamp;


BEGIN

	begin
		select	coalesce(a.dt_emissao_demonstrativo, a.dt_pagamento)
		into STRICT	dt_retorno_w
		from	imp_dem_retorno_prot a,
			convenio_retorno b,
			convenio_retorno_item c
		where	a.nr_seq_protocolo 	= (SELECT max(x.nr_seq_protocolo) from conta_paciente x where x.nr_interno_conta = nr_interno_conta_p)
		and	b.nr_sequencia 		= a.nr_seq_retorno_conv
		and	c.nr_seq_retorno 	= b.nr_sequencia
		and	c.nr_interno_conta 	= nr_interno_conta_p
		and	c.cd_autorizacao 	= cd_autorizacao_p
		and	b.ie_status_retorno 	= 'F';
	exception
	when others then
		dt_ret_conv_w := null;
	end;
	
	if coalesce(dt_ret_conv_w::text, '') = '' then
	
		begin
			select 	max(c.dt_emissao)
			into STRICT	dt_ret_conv_w
			from	convenio_retorno a,
				tiss_cabecalho b,
				tiss_demonstrativo c,
				tiss_dem_fatura d,
				tiss_dem_lote e,
				tiss_dem_conta f
			where	f.nr_seq_lote 		= e.nr_sequencia
			and	e.nr_seq_fatura 	= d.nr_sequencia
			and	d.nr_seq_demonstrativo 	= c.nr_sequencia
			and	c.nr_seq_cabecalho 	= b.nr_sequencia
			and	b.nr_seq_retorno 	= a.nr_sequencia
			and	a.ie_status_retorno 	= 'F'
			and	f.nr_interno_conta 	= nr_interno_conta_p
			and	f.nr_guia_operadora 	= cd_autorizacao_p;
		exception
		when others then
			dt_ret_conv_w := null;
		end;

		if coalesce(dt_ret_conv_w::text, '') = '' then
			begin
				select	max(a.dt_retorno)
				into STRICT	dt_ret_conv_w
				from	convenio_retorno a,
					convenio_retorno_item b
				where	b.nr_seq_retorno 	= a.nr_sequencia
				and 	a.ie_status_retorno 	= 'F'
				and	b.nr_interno_conta 	= nr_interno_conta_p
				and	b.cd_autorizacao 	= cd_autorizacao_p;
			exception
			when others then
				dt_ret_conv_w := null;
			end;			
		end if;		

		begin
			select	max(b.dt_fechamento)
			into STRICT	dt_lote_audit_w
			from	lote_auditoria a,
				lote_audit_hist b,
				lote_audit_hist_guia c
			where	c.nr_seq_lote_hist 		= b.nr_sequencia
			and	b.nr_seq_lote_audit 		= a.nr_sequencia
			and	b.nr_analise 			= (SELECT max(x.nr_analise) from lote_audit_hist x where x.nr_seq_lote_audit = a.nr_sequencia)
			and	(b.dt_envio IS NOT NULL AND b.dt_envio::text <> '')
			and	(b.dt_fechamento IS NOT NULL AND b.dt_fechamento::text <> '')		
			and	c.nr_interno_conta 		= nr_interno_conta_p
			and	c.cd_autorizacao 		= cd_autorizacao_p;
		exception
		when others then
			dt_lote_audit_w := null;
		end;
		
		if 	(dt_ret_conv_w IS NOT NULL AND dt_ret_conv_w::text <> '')
			and dt_ret_conv_w > coalesce(dt_lote_audit_w, dt_ret_conv_w - 1) then
			dt_retorno_w := dt_ret_conv_w;
		elsif 	(dt_lote_audit_w IS NOT NULL AND dt_lote_audit_w::text <> '') then
			dt_retorno_w := dt_lote_audit_w;
		end if;
	
	end if;

	return dt_retorno_w;

end;


$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION tiss_dashboard_data_pck.obter_dt_ultimo_retorno (nr_interno_conta_p conta_paciente.nr_interno_conta%type, cd_autorizacao_p conta_paciente_guia.cd_autorizacao%type) FROM PUBLIC;
