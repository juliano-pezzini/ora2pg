-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_execucao_cirurgica_pck.gerar_complemento ( nr_seq_guia_p pls_guia_plano.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nr_seq_requisicao_p INOUT pls_requisicao.nr_sequencia%type) AS $body$
DECLARE


nr_seq_requisicao_w			pls_requisicao.nr_sequencia%type;
ie_tipo_atendimento_w      pls_exec_cirurgica_regras.ie_tipo_atendimento%type;
ie_regime_atendimento_w    pls_requisicao.ie_regime_atendimento%type;

BEGIN

select	nextval('pls_requisicao_seq')
into STRICT	nr_seq_requisicao_w
;

ie_tipo_atendimento_w := '7';
ie_regime_atendimento_w := null;

-- se for da tiss 4.00.01 em diante
if (somente_numero(pls_obter_versao_tiss) >= 40001) then

	ie_regime_atendimento_w := '03';
	ie_tipo_atendimento_w	:= '02';

	select	coalesce(max(ie_tipo_atendimento),'02') -- Pequena Cirurgia
	into STRICT	ie_tipo_atendimento_w
	from	pls_exec_cirurgica_regras
	where	cd_estabelecimento	= cd_estabelecimento_p;

end if;


insert into pls_requisicao(nr_sequencia, nm_usuario, nm_usuario_nrec,
	dt_atualizacao, dt_atualizacao_nrec, cd_estabelecimento,
	nr_seq_segurado, nr_seq_plano, ie_tipo_guia,
	dt_requisicao, ie_estagio, nr_seq_guia_principal,
	cd_guia_principal, ie_recem_nascido, ie_carater_atendimento,
	ie_tipo_processo, ie_tipo_intercambio, ie_origem_solic,
	nr_seq_uni_exec, nr_seq_prestador, cd_medico_solicitante,
	ie_tipo_atendimento, cd_especialidade, nr_seq_prestador_exec,
  ie_saude_ocupacional, ie_regime_atendimento, ie_cobertura_especial)
(SELECT	nr_seq_requisicao_w, nm_usuario_p, nm_usuario_p,
	clock_timestamp(), clock_timestamp(), cd_estabelecimento_p,
	nr_seq_segurado, nr_seq_plano, '2',
	clock_timestamp(), 1, nr_sequencia,
	cd_guia, ie_recem_nascido, ie_carater_internacao,
	ie_tipo_processo, ie_tipo_intercambio, 'P',
	nr_seq_uni_exec, nr_seq_prestador, cd_medico_solicitante,
	ie_tipo_atendimento_w, cd_especialidade, nr_seq_prestador,
	ie_saude_ocupacional, coalesce(ie_regime_atendimento_w,ie_regime_atendimento), ie_cobertura_especial
from	pls_guia_plano
where	nr_sequencia	= nr_seq_guia_p);

nr_seq_requisicao_p	:= nr_seq_requisicao_w;

commit;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_execucao_cirurgica_pck.gerar_complemento ( nr_seq_guia_p pls_guia_plano.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nr_seq_requisicao_p INOUT pls_requisicao.nr_sequencia%type) FROM PUBLIC;
