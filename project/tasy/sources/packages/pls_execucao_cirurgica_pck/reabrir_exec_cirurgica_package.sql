-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_execucao_cirurgica_pck.reabrir_exec_cirurgica ( nr_seq_exec_cirurgica_p pls_execucao_cirurgica.nr_sequencia%type, nr_seq_guia_p pls_guia_plano.nr_sequencia%type, nr_seq_usuario_web_p pls_usuario_web.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) AS $body$
DECLARE


/* ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade: Reabrir a execucao cirurgica para a guia de internacao, gerando a execucao das guias de complemento.
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
cGuiasComplemento CURSOR(nr_seq_guia_pc	pls_guia_plano.nr_sequencia%type) FOR
	SELECT	a.nr_sequencia nr_seq_guia_compl
	from	pls_guia_plano a
	where	a.nr_seq_guia_principal = nr_seq_guia_pc
	and	a.ie_tipo_guia = '2'
	and (a.ie_tipo_atend_tiss = 7 or coalesce(a.ie_regime_atendimento,9) = 3)
	and	a.ie_estagio in (5, 6, 10)
	and	(a.nr_seq_guia_principal IS NOT NULL AND a.nr_seq_guia_principal::text <> '')
	and	not exists (	SELECT	1
				from	pls_exec_cirurgica_guia b
				where	b.nr_seq_guia = a.nr_sequencia)
	and	exists (	select	1
				from	pls_execucao_cirurgica c
				where	c.nr_seq_guia	= a.nr_seq_guia_principal
				and	c.ie_faturado	= 'N');

/*Cursor cReqComplemento (nr_seq_guia_pc	pls_guia_plano.nr_sequencia%type) is
	select	a.nr_sequencia nr_seq_req_compl
	from	pls_requisicao a
	where	a.nr_seq_guia_principal = nr_seq_guia_pc
	and	a.ie_tipo_guia = '2'
	and	a.ie_tipo_atendimento = 7
	and	a.ie_estagio not in (1, 3, 7)
	and	(select	b.ie_tipo_guia 
		from	pls_guia_plano b
		where	b.nr_sequencia = a.nr_seq_guia_principal) = 1
	and	not exists (	select 1
				from	pls_execucao_req_item e
				where	e.nr_seq_requisicao = a.nr_sequencia)
	and	not exists (	select	1
				from	pls_exec_cirurgica_guia b
				where	b.nr_seq_requisicao = a.nr_sequencia)
	and	exists (	select	1
				from	pls_execucao_cirurgica c
				where	c.nr_seq_guia = a.nr_seq_guia_principal
				and	c.ie_faturado	= 'N');*/
BEGIN

for cGuiasComplemento_w in cGuiasComplemento( nr_seq_guia_p ) loop
	CALL pls_execucao_cirurgica_pck.gerar_exec_guia_proc(nr_seq_exec_cirurgica_p, cGuiasComplemento_w.nr_seq_guia_compl, null, null, 'G', nm_usuario_p, cd_estabelecimento_p);
end loop;

/*for cReqComplemento_w in cReqComplemento( nr_seq_guia_p ) loop
	pls_execucao_cirurgica_pck.gerar_exec_guia_proc(nr_seq_exec_cirurgica_p, null, cReqComplemento_w.nr_seq_req_compl, null, 'G', nm_usuario_p, cd_estabelecimento_p);
end loop;*/
update	pls_execucao_cirurgica
set	dt_ult_reabertura	= clock_timestamp(),
	ie_status		= 'E'
where	nr_sequencia		= nr_seq_exec_cirurgica_p;

commit;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_execucao_cirurgica_pck.reabrir_exec_cirurgica ( nr_seq_exec_cirurgica_p pls_execucao_cirurgica.nr_sequencia%type, nr_seq_guia_p pls_guia_plano.nr_sequencia%type, nr_seq_usuario_web_p pls_usuario_web.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) FROM PUBLIC;
