-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pls_execucao_cirurgica_pck.obter_se_medico_partic ( nr_seq_exec_cirurgica_p pls_execucao_cirurgica.nr_sequencia%type, nr_seq_exec_cirurgica_proc_p pls_exec_cirurgica_proc.nr_sequencia%type, cd_medico_p pessoa_fisica.cd_pessoa_fisica%type) RETURNS varchar AS $body$
DECLARE


/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade:
Validar se a especialidade do medico esta de acordo com a participacao. 
Verifica se ha participacoes pendentes de acordo com a especialidade do medico.
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
ds_retorno_w	varchar(1)	:= 'N';


BEGIN
				
begin	
	select	'S'
	into STRICT	ds_retorno_w
	from	pls_execucao_cirurgica b
	where	b.nr_sequencia	= nr_seq_exec_cirurgica_p
	and	b.ie_status			<> 'F'
	and	exists ( 	SELECT	1
				from	pls_exec_cirurgica_proc a,
					pls_exec_cirurgica_guia c,
					pls_exec_cirurg_bio_partic d
				where 	a.nr_seq_execucao_guia 		= c.nr_sequencia
				and	c.nr_seq_exec_cirurgica		= b.nr_sequencia
				and	d.nr_seq_exec_cirurg_proc	= a.nr_sequencia
				and (coalesce(nr_seq_exec_cirurgica_proc_p::text, '') = ''		or a.nr_sequencia	= nr_seq_exec_cirurgica_proc_p)
				and	a.ie_finalizado			= 'N'
				and	a.ie_situacao_item		in ('A', 'G')
				and	coalesce(d.nr_seq_exec_cirurg_bio::text, '') = ''
				and (exists (SELECT	1 from pls_grau_partic_espec_med e where e.nr_seq_grau_partic = d.nr_seq_grau_partic and e.cd_especialidade 
						in (select	e.cd_especialidade from medico_especialidade e where e.cd_pessoa_fisica = cd_medico_p) and e.ie_situacao = 'A')
						or (not exists (select	1 from pls_grau_partic_espec_med f where f.nr_seq_grau_partic = d.nr_seq_grau_partic and f.ie_situacao = 'A')))
				and 	not exists (	select	1 
							from 	pls_exec_cirurg_biometria g,
								pls_exec_cirurg_bio_partic h
							where 	g.nr_sequencia 			= h.nr_seq_exec_cirurg_bio 
							and	h.nr_seq_exec_cirurg_proc	= a.nr_sequencia
							and    	g.ie_situacao            	= 'A'									
							and 	g.cd_medico 			= cd_medico_p));
exception
when others then
	ds_retorno_w	:= 'N';
end;

return	ds_retorno_w;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pls_execucao_cirurgica_pck.obter_se_medico_partic ( nr_seq_exec_cirurgica_p pls_execucao_cirurgica.nr_sequencia%type, nr_seq_exec_cirurgica_proc_p pls_exec_cirurgica_proc.nr_sequencia%type, cd_medico_p pessoa_fisica.cd_pessoa_fisica%type) FROM PUBLIC;
