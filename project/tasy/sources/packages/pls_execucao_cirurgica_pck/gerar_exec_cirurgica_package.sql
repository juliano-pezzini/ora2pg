-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_execucao_cirurgica_pck.gerar_exec_cirurgica ( nr_seq_guia_p pls_guia_plano.nr_sequencia%type, nr_seq_usuario_web_p pls_usuario_web.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nr_seq_exec_cirurgica_p INOUT pls_execucao_cirurgica.nr_sequencia%type) AS $body$
DECLARE


/* ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade: Criar a execucao cirurgica para a guia de internacao.
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
nr_seq_exec_cirurgica_w			pls_execucao_cirurgica.nr_sequencia%type;
nr_seq_prestador_w			pls_execucao_cirurgica.nr_seq_prestador_exec%type;
cd_guia_w				pls_execucao_cirurgica.cd_guia%type;
nr_seq_segurado_w			pls_execucao_cirurgica.nr_seq_segurado%type;

cGuiasComplemento CURSOR(nr_seq_guia_pc	pls_guia_plano.nr_sequencia%type) FOR
	SELECT	a.nr_sequencia nr_seq_guia_compl
	from	pls_guia_plano a
	where	a.nr_seq_guia_principal = nr_seq_guia_pc
	and	a.ie_tipo_guia = '2'
	and (a.ie_tipo_atend_tiss = 7 or coalesce(a.ie_regime_atendimento,9) = 3)
	and	a.ie_estagio in (5, 6, 10)
	and	(a.nr_seq_guia_principal IS NOT NULL AND a.nr_seq_guia_principal::text <> '')
	and	not exists (	SELECT	1
				from	pls_exec_cirurgica_guia b
				where	b.nr_seq_guia = a.nr_sequencia)
	and	exists (	select	1
				from	pls_execucao_cirurgica c
				where	c.nr_seq_guia	= a.nr_seq_guia_principal
				and	c.ie_faturado	= 'N');

BEGIN

select	nr_seq_prestador,
	cd_guia,
	nr_seq_segurado
into STRICT	nr_seq_prestador_w,
	cd_guia_w,
	nr_seq_segurado_w
from	pls_guia_plano
where	nr_sequencia = nr_seq_guia_p;

insert into pls_execucao_cirurgica(nr_sequencia, nm_usuario, nm_usuario_nrec,
	dt_atualizacao, dt_atualizacao_nrec, ie_situacao,
	cd_estabelecimento, ds_observacao, dt_ult_reabertura,
	nr_seq_guia, ie_status, nr_seq_usuario_web,
	ie_faturado, nr_seq_prestador_exec, cd_guia,
	nr_seq_segurado)
values (nextval('pls_execucao_cirurgica_seq'), nm_usuario_p, nm_usuario_p,
	clock_timestamp(), clock_timestamp(), 'A',
	cd_estabelecimento_p, null, null,
	nr_seq_guia_p, 'A', nr_seq_usuario_web_p,
	'N', nr_seq_prestador_w, cd_guia_w,
	nr_seq_segurado_w) returning nr_sequencia into nr_seq_exec_cirurgica_w;

CALL pls_execucao_cirurgica_pck.gerar_exec_guia_proc(nr_seq_exec_cirurgica_w, nr_seq_guia_p, null, null, 'G', nm_usuario_p, cd_estabelecimento_p);

for cGuiasComplemento_w in cGuiasComplemento( nr_seq_guia_p ) loop
	CALL pls_execucao_cirurgica_pck.gerar_exec_guia_proc(nr_seq_exec_cirurgica_w, cGuiasComplemento_w.nr_seq_guia_compl, null, null, 'G', nm_usuario_p, cd_estabelecimento_p);
end loop;

nr_seq_exec_cirurgica_p	:= nr_seq_exec_cirurgica_w;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_execucao_cirurgica_pck.gerar_exec_cirurgica ( nr_seq_guia_p pls_guia_plano.nr_sequencia%type, nr_seq_usuario_web_p pls_usuario_web.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nr_seq_exec_cirurgica_p INOUT pls_execucao_cirurgica.nr_sequencia%type) FROM PUBLIC;
