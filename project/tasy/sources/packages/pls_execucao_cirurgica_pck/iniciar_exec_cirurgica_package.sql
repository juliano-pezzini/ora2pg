-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_execucao_cirurgica_pck.iniciar_exec_cirurgica ( nr_seq_guia_p pls_guia_plano.nr_sequencia%type, nr_seq_usuario_web_p pls_usuario_web.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nr_seq_exec_cirurgica_p INOUT pls_execucao_cirurgica.nr_sequencia%type) AS $body$
DECLARE


/* ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade: Iniciar a execucao cirurgia pelo Portal. A guia de internacao devera ser vinculada como guia principal da execucao. 
Quando for execucao de guia de complemento, a execucao sera reaberta.
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
qt_execucao_cirurgica_w		integer;
ie_iniciar_exec_w		varchar(1);
ie_reabrir_exec_w		varchar(1);
nr_seq_guia_principal_w		pls_guia_plano.nr_sequencia%type;
nr_seq_exec_cirurgica_w		pls_execucao_cirurgica.nr_sequencia%type;
nr_seq_execucao_w		pls_execucao_cirurgica.nr_sequencia%type;


BEGIN

begin
	select	nr_seq_guia_principal,
		ie_iniciar_exec,
		ie_reabrir_exec
	into STRICT	nr_seq_guia_principal_w,
		ie_iniciar_exec_w,
		ie_reabrir_exec_w
	from	table(pls_execucao_cirurgica_pck.obter_se_guia_execucao(nr_seq_guia_p));
exception
when others then
	--Guia invalida ou execucao nao permitida.
	CALL wheb_mensagem_pck.exibir_mensagem_abort(1147352);
end;

if (ie_iniciar_exec_w = 'S') then
	nr_seq_exec_cirurgica_w := pls_execucao_cirurgica_pck.gerar_exec_cirurgica(nr_seq_guia_p, nr_seq_usuario_web_p, nm_usuario_p, cd_estabelecimento_p, nr_seq_exec_cirurgica_w);
elsif (ie_reabrir_exec_w = 'S') then
	select	nr_sequencia
	into STRICT	nr_seq_execucao_w
	from	pls_execucao_cirurgica
	where	nr_seq_guia	= nr_seq_guia_principal_w;

	CALL pls_execucao_cirurgica_pck.reabrir_exec_cirurgica(nr_seq_execucao_w, nr_seq_guia_p, nr_seq_usuario_web_p, nm_usuario_p, cd_estabelecimento_p);
else
	--Guia invalida ou execucao nao permitida.
	CALL wheb_mensagem_pck.exibir_mensagem_abort(1147352);
end if;

nr_seq_exec_cirurgica_p	:= coalesce(nr_seq_exec_cirurgica_w, nr_seq_execucao_w);

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_execucao_cirurgica_pck.iniciar_exec_cirurgica ( nr_seq_guia_p pls_guia_plano.nr_sequencia%type, nr_seq_usuario_web_p pls_usuario_web.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nr_seq_exec_cirurgica_p INOUT pls_execucao_cirurgica.nr_sequencia%type) FROM PUBLIC;
