-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


--fis_obter_nfs_credito
CREATE OR REPLACE PROCEDURE fis_refatoracao_nf_pck.fis_obter_nfs_credito ( nr_seq_nf_origem_p nota_fiscal.nr_sequencia%type, nr_seq_refat_nf_p fis_refatoracao_nf.nr_sequencia%type, nm_usuario_p text) AS $body$
DECLARE

					
					
qt_cursor_nf_cred_w	bigint := 0;
nr_seq_ref_nf_cred_w	fis_refatoracao_nf_cred.nr_sequencia%type;
						
c_nf_credito CURSOR FOR
	SELECT	a.nr_sequencia,
		a.nr_seq_nf_gerada
	from	nf_credito a
	where	a.nr_seq_nf_orig = nr_seq_nf_origem_p;

c_nf_credito_w          c_nf_credito%rowtype;


BEGIN

open c_nf_credito;
loop
fetch c_nf_credito into	
	c_nf_credito_w;
EXIT WHEN NOT FOUND; /* apply on c_nf_credito */
	begin

	/*Incrementa a variavel para o array*/

	qt_cursor_nf_cred_w:=	qt_cursor_nf_cred_w + 1;

	/*Pega a sequencia da taleba fis_sef_edoc_0175 para o insert*/

	select	nextval('fis_refatoracao_nf_cred_seq')
	into STRICT	nr_seq_ref_nf_cred_w
	;
	

	/*Inserindo valores no array para realizacao do forall posteriormente*/
	current_setting('fis_refatoracao_nf_pck.fis_refatoracao_nf_cred_w')::reg_refatoracao_nf_cred[qt_cursor_nf_cred_w].nr_sequencia 		:= nr_seq_ref_nf_cred_w;
	current_setting('fis_refatoracao_nf_pck.fis_refatoracao_nf_cred_w')::reg_refatoracao_nf_cred[qt_cursor_nf_cred_w].nr_seq_refat_nf		:= nr_seq_refat_nf_p;
	current_setting('fis_refatoracao_nf_pck.fis_refatoracao_nf_cred_w')::reg_refatoracao_nf_cred[qt_cursor_nf_cred_w].nr_seq_nota_credito	:= c_nf_credito_w.nr_sequencia;
	current_setting('fis_refatoracao_nf_pck.fis_refatoracao_nf_cred_w')::reg_refatoracao_nf_cred[qt_cursor_nf_cred_w].nr_seq_nf_cred_old	:= c_nf_credito_w.nr_seq_nf_gerada;
	current_setting('fis_refatoracao_nf_pck.fis_refatoracao_nf_cred_w')::reg_refatoracao_nf_cred[qt_cursor_nf_cred_w].nr_seq_nf_cred_new	:= null;
	current_setting('fis_refatoracao_nf_pck.fis_refatoracao_nf_cred_w')::reg_refatoracao_nf_cred[qt_cursor_nf_cred_w].dt_atualizacao		:= clock_timestamp();
	current_setting('fis_refatoracao_nf_pck.fis_refatoracao_nf_cred_w')::reg_refatoracao_nf_cred[qt_cursor_nf_cred_w].dt_atualizacao_nrec	:= clock_timestamp();
	current_setting('fis_refatoracao_nf_pck.fis_refatoracao_nf_cred_w')::reg_refatoracao_nf_cred[qt_cursor_nf_cred_w].nm_usuario		:= nm_usuario_p;
	current_setting('fis_refatoracao_nf_pck.fis_refatoracao_nf_cred_w')::reg_refatoracao_nf_cred[qt_cursor_nf_cred_w].nm_usuario_nrec		:= nm_usuario_p;
	
	
	end;
end loop;
close c_nf_credito;


END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE fis_refatoracao_nf_pck.fis_obter_nfs_credito ( nr_seq_nf_origem_p nota_fiscal.nr_sequencia%type, nr_seq_refat_nf_p fis_refatoracao_nf.nr_sequencia%type, nm_usuario_p text) FROM PUBLIC;
