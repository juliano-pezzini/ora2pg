-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

/*Functions*/

CREATE OR REPLACE FUNCTION fis_refatoracao_nf_pck.obter_nfs_cancelamento ( nr_interno_conta_p conta_paciente.nr_interno_conta%type, nr_seq_protocolo_p protocolo_convenio.nr_seq_protocolo%type, nr_seq_far_venda_p far_venda.nr_sequencia%type, nr_seq_nota_fiscal_p nota_fiscal.nr_sequencia%type) RETURNS SETOF T_ITEM_NF AS $body$
DECLARE


line_w			t_item_nf_row;
nr_seq_refat_nf_w	fis_refatoracao_nf.nr_sequencia%type;
nr_seq_nf_principal_w	nota_fiscal.nr_sequencia%type;

c_nota_fiscal CURSOR FOR
	SELECT	nr_seq_nf_princ_old nr_seq_nota_fiscal
	from	fis_refatoracao_nf
	where	nr_sequencia	=	nr_seq_refat_nf_w
	
union all

	SELECT	nr_seq_nf_adiant_old nr_seq_nota_fiscal
	from	fis_refatoracao_nf_adian
	where	nr_seq_refat_nf	=	nr_seq_refat_nf_w
	
union all

	select	nr_seq_nf_cred_old nr_seq_nota_fiscal
	from	fis_refatoracao_nf_cred
	where	nr_seq_refat_nf	=	nr_seq_refat_nf_w
	
union all

	select	nr_seq_nf_baixa_tit_old nr_seq_nota_fiscal
	from	fis_refatoracao_nf_bai_tit
	where	nr_seq_refat_nf	=	nr_seq_refat_nf_w;

c_nota_fiscal_w          c_nota_fiscal%rowtype;
	

BEGIN

nr_seq_nf_principal_w:=	nr_seq_nota_fiscal_p;

if (coalesce(nr_seq_nota_fiscal_p, 0) = 0) then
	nr_seq_nf_principal_w	:= fis_refatoracao_nf_pck.fis_obter_nf_principal(	nr_interno_conta_p,	
									nr_seq_protocolo_p,
									nr_seq_far_venda_p);	
end if;


begin

select	nr_sequencia
into STRICT	nr_seq_refat_nf_w
from	fis_refatoracao_nf
where 	nr_seq_nf_princ_old = nr_seq_nf_principal_w;

exception
when others then
	nr_seq_refat_nf_w:=	null;
end;

open c_nota_fiscal;
loop
fetch c_nota_fiscal into	
	c_nota_fiscal_w;
EXIT WHEN NOT FOUND; /* apply on c_nota_fiscal */

	begin
	
	line_w.nr_seq_nota_fiscal		:= c_nota_fiscal_w.nr_seq_nota_fiscal;
	RETURN NEXT line_w;
				
	end;
end loop;
close c_nota_fiscal;


return;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION fis_refatoracao_nf_pck.obter_nfs_cancelamento ( nr_interno_conta_p conta_paciente.nr_interno_conta%type, nr_seq_protocolo_p protocolo_convenio.nr_seq_protocolo%type, nr_seq_far_venda_p far_venda.nr_sequencia%type, nr_seq_nota_fiscal_p nota_fiscal.nr_sequencia%type) FROM PUBLIC;
