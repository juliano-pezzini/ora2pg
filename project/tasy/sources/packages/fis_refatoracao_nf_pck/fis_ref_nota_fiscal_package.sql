-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



--fis_refatoracao_nf
CREATE OR REPLACE PROCEDURE fis_refatoracao_nf_pck.fis_ref_nota_fiscal ( nr_interno_conta_p conta_paciente.nr_interno_conta%type, nr_seq_protocolo_p protocolo_convenio.nr_seq_protocolo%type, nr_seq_far_venda_p far_venda.nr_sequencia%type, nr_seq_nota_fiscal_p nota_fiscal.nr_sequencia%type, cd_pessoa_fisica_p pessoa_fisica.cd_pessoa_fisica%type, cd_pessoa_juridica_p pessoa_juridica.cd_cgc%type, cd_condicao_pagamento_p text, cd_uso_cfdi_p text, ie_refatorar_baixa_p text, ie_refatorar_adiant_p text, cd_meio_pagamento_p text, ie_refat_total_p text, nm_usuario_p text) AS $body$
DECLARE

				
nr_seq_nf_principal_w	nota_fiscal.nr_sequencia%type;
nr_seq_refat_nf_w	fis_refatoracao_nf.nr_sequencia%type;


BEGIN



nr_seq_nf_principal_w:=	nr_seq_nota_fiscal_p;

if (coalesce(nr_seq_nota_fiscal_p, 0) = 0) then
	nr_seq_nf_principal_w	:= fis_refatoracao_nf_pck.fis_obter_nf_principal(	nr_interno_conta_p,	
									nr_seq_protocolo_p,
									nr_seq_far_venda_p);	
end if;



/*Grava na tabela fis_refatoracao_nf a nota fiscal principal*/

nr_seq_refat_nf_w := fis_refatoracao_nf_pck.fis_gravar_ref_nf(	nr_seq_nf_principal_w, nr_interno_conta_p, nr_seq_protocolo_p, nr_seq_far_venda_p, cd_pessoa_fisica_p, cd_pessoa_juridica_p, cd_condicao_pagamento_p, cd_uso_cfdi_p, ie_refatorar_baixa_p, ie_refatorar_adiant_p, cd_meio_pagamento_p, nm_usuario_p, nr_seq_refat_nf_w);
			

				
/*Pega as nota fiscais de adiantamento - somente conta paciente tem adiantamento*/

if (coalesce(nr_interno_conta_p,0) <> 0) then
	CALL fis_refatoracao_nf_pck.fis_obter_nfs_adiantamento(	nr_interno_conta_p,
						nr_seq_refat_nf_w,
						nm_usuario_p);
end if;

/*Obtem as sequencias das notas fiscal de credito vinculada a nota fiscal principal*/
			
CALL fis_refatoracao_nf_pck.fis_obter_nfs_credito(	nr_seq_nf_principal_w,
					nr_seq_refat_nf_w,
					nm_usuario_p);

/*Obtem as sequencias das notas fiscais vincuadas as baixas de titulos a receber que esta vinculada a nota fiscal principal*/

CALL fis_refatoracao_nf_pck.fis_obter_nf_bai_titulo(	nr_seq_nf_principal_w,
				nr_seq_refat_nf_w,
				nm_usuario_p);				

				
CALL fis_refatoracao_nf_pck.fis_alt_sit_nf_refat(	nr_seq_nf_principal_w, '4');

/*Grava registros na tabela de fis_refatoracao_nf_adian*/

CALL fis_refatoracao_nf_pck.fis_gravar_nfs_adiantamento(	nr_interno_conta_p,
					nr_seq_nf_principal_w,
					nm_usuario_p);

/*Grava registros na tabela de fis_refatoracao_nf_cred*/

CALL fis_refatoracao_nf_pck.fis_gravar_nfs_credito(	nr_seq_nf_principal_w,
				nm_usuario_p);
			
/*Grava registros na tabela de fis_refatoracao_nf_bai_tit*/

CALL fis_refatoracao_nf_pck.fis_gravar_nf_baixas_titulos(	nr_seq_nf_principal_w,
					nm_usuario_p);
					
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE fis_refatoracao_nf_pck.fis_ref_nota_fiscal ( nr_interno_conta_p conta_paciente.nr_interno_conta%type, nr_seq_protocolo_p protocolo_convenio.nr_seq_protocolo%type, nr_seq_far_venda_p far_venda.nr_sequencia%type, nr_seq_nota_fiscal_p nota_fiscal.nr_sequencia%type, cd_pessoa_fisica_p pessoa_fisica.cd_pessoa_fisica%type, cd_pessoa_juridica_p pessoa_juridica.cd_cgc%type, cd_condicao_pagamento_p text, cd_uso_cfdi_p text, ie_refatorar_baixa_p text, ie_refatorar_adiant_p text, cd_meio_pagamento_p text, ie_refat_total_p text, nm_usuario_p text) FROM PUBLIC;
