-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE fis_refatoracao_nf_pck.fis_duplicar_nf ( nr_seq_nota_fiscal_p nota_fiscal.nr_sequencia%type, nr_seq_nf_new_p INOUT nota_fiscal.nr_sequencia%type, ie_tipo_nota_p INOUT nota_fiscal.ie_tipo_nota%type, nm_usuario_p text) AS $body$
DECLARE



nr_nota_fiscal_w	nota_fiscal.nr_nota_fiscal%type;
cont_w			bigint;
cd_serie_nf_w		nota_fiscal.cd_serie_nf%type;
cd_estabelecimento_w	nota_fiscal.cd_estabelecimento%type;
nr_sequencia_w		nota_fiscal.nr_sequencia%type;
cd_cgc_emitente_w	nota_fiscal.cd_cgc_emitente%type;
nr_sequencia_nf_w	nota_fiscal.nr_sequencia_nf%type;
ie_tipo_nota_w		nota_fiscal.ie_tipo_nota%type;


BEGIN

select	cd_serie_nf,
	cd_estabelecimento,
	cd_cgc_emitente,
	ie_tipo_nota
into STRICT	cd_serie_nf_w,
	cd_estabelecimento_w,
	cd_cgc_emitente_w,
	ie_tipo_nota_w
from	nota_fiscal
where	nr_sequencia = nr_seq_nota_fiscal_p;

select count(*)
into STRICT 	cont_w
from	serie_nota_fiscal
where	cd_serie_nf 		= cd_serie_nf_w
and 	coalesce(cd_estabelecimento,cd_estabelecimento_w) 	= cd_estabelecimento_w;
if (cont_w = 0) then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(173208);
end if;

select	nr_ultima_nf + 1
into STRICT	nr_nota_fiscal_w
from	serie_nota_fiscal
where	cd_serie_nf 		= cd_serie_nf_w
and	cd_estabelecimento 	= cd_estabelecimento_w;

if (nr_nota_fiscal_w IS NOT NULL AND nr_nota_fiscal_w::text <> '') then
	
	update	serie_nota_fiscal
	set	nr_ultima_nf 		= nr_nota_fiscal_w
	where	cd_serie_nf 		= cd_serie_nf_w
	and	cd_estabelecimento 	= cd_estabelecimento_w;
	
end if;

select (max(nr_sequencia_nf)+1)
into STRICT	nr_sequencia_nf_w
from	nota_fiscal
where	cd_estabelecimento = cd_estabelecimento_w
and	nr_sequencia = nr_seq_nota_fiscal_p;


select	nextval('nota_fiscal_seq')
into STRICT	nr_sequencia_w
;

insert into nota_fiscal(
	cd_estabelecimento,
	cd_cgc_emitente,
	cd_serie_nf,
	nr_nota_fiscal,
	nr_sequencia_nf,
	cd_operacao_nf,
	dt_emissao,
	dt_entrada_saida,
	ie_acao_nf,
	ie_emissao_nf,
	ie_tipo_frete,
	vl_mercadoria,
	vl_total_nota,
	qt_peso_bruto,
	qt_peso_liquido,
	dt_atualizacao,
	nm_usuario,
	cd_condicao_pagamento,
	dt_contabil,
	cd_cgc,
	cd_pessoa_fisica,
	vl_ipi,
	vl_descontos,
	vl_frete,
	vl_seguro,
	vl_despesa_acessoria,
	ds_observacao,
	nr_nota_referencia,
	cd_serie_referencia,
	cd_natureza_operacao,
	dt_atualizacao_estoque,
	vl_desconto_rateio,
	ie_situacao,
	nr_ordem_compra,
	nr_lote_contabil,
	nr_sequencia,
	nr_sequencia_ref,
	ie_tipo_nota,
	nr_seq_protocolo,
	nr_interno_conta,
	nm_usuario_calc,
	nr_nfe_imp,
	vl_conv_estrangeiro,
	vl_conv_moeda,
	cd_moeda_estrangeira,
	nr_seq_far_venda)
SELECT	cd_estabelecimento,
	cd_cgc_emitente,
	cd_serie_nf,
	nr_nota_fiscal_w,
	nr_sequencia_nf_w,
	cd_operacao_nf,
	clock_timestamp(),
	clock_timestamp(),
	ie_acao_nf,
	ie_emissao_nf,
	ie_tipo_frete,
	vl_mercadoria,
	vl_total_nota,	
	qt_peso_bruto,
	qt_peso_liquido,
	clock_timestamp(),
	nm_usuario_p,
	cd_condicao_pagamento,
	null,
	cd_cgc,
	cd_pessoa_fisica,
	vl_ipi,
	vl_descontos,
	vl_frete,
	vl_seguro,
	vl_despesa_acessoria,
	ds_observacao,
	nr_nota_referencia,
	cd_serie_referencia,
	cd_natureza_operacao,
	null,
	vl_desconto_rateio,
	1,
	nr_ordem_compra,
	0, -- lote contabil
	nr_sequencia_w,
	nr_sequencia,
	ie_tipo_nota,
	nr_seq_protocolo,
	nr_interno_conta,
	nm_usuario_calc,
	nr_nfe_imp,
	vl_conv_estrangeiro,
	vl_conv_moeda,
	cd_moeda_estrangeira,
	nr_seq_far_venda
from	nota_fiscal
where	nr_sequencia = nr_seq_nota_fiscal_p;

insert into nota_fiscal_item(
	cd_estabelecimento,
	cd_cgc_emitente,
	cd_serie_nf,
	nr_nota_fiscal,
	nr_sequencia_nf,
	nr_item_nf,
	cd_natureza_operacao,
	qt_item_nf,
	vl_unitario_item_nf,
	vl_total_item_nf,
	dt_atualizacao,
	nm_usuario,
	vl_frete,
	vl_desconto,
	vl_despesa_acessoria,
	cd_material,
	cd_procedimento,
	cd_setor_atendimento,
	cd_conta,
	cd_local_estoque,
	ds_observacao,
	qt_peso_bruto,
	qt_peso_liquido,
	cd_unidade_medida_compra,
	qt_item_estoque,
	cd_unidade_medida_estoque,
	cd_lote_fabricacao,
	dt_validade,
	dt_atualizacao_estoque,
	cd_conta_contabil,
	vl_desconto_rateio,
	vl_seguro,
	cd_centro_custo,
	cd_material_estoque,
	ie_origem_proced,
	nr_ordem_compra,
	nr_item_oci,
	nr_sequencia,
	vl_liquido,
	nr_seq_ordem_serv,
	nr_seq_lote_fornec,
	dt_inicio_garantia,
	dt_fim_garantia,
	dt_entrega_ordem,
	nr_seq_conta_financ,
	vl_total_estrangeiro,
	vl_unit_estrangeiro, 
	vl_dif_estrangeiro,
	nr_titulo,
	nr_seq_tit_rec)
SELECT	cd_estabelecimento,
	cd_cgc_emitente,
	cd_serie_nf,
	nr_nota_fiscal_w,
	nr_sequencia_nf_w,
	nr_item_nf,
	cd_natureza_operacao,
	qt_item_nf,
	vl_unitario_item_nf,
	vl_total_item_nf,
	clock_timestamp(),
	nm_usuario_p,
	vl_frete,
	vl_desconto,
	vl_despesa_acessoria,
	cd_material,
	cd_procedimento,
	cd_setor_atendimento,
	cd_conta,
	cd_local_estoque,
	ds_observacao,
	qt_peso_bruto,
	qt_peso_liquido,
	cd_unidade_medida_compra,
	qt_item_estoque,
	cd_unidade_medida_estoque,
	cd_lote_fabricacao,
	dt_validade,
	dt_atualizacao_estoque,
	cd_conta_contabil,
	vl_desconto_rateio,
	vl_seguro,
	cd_centro_custo,
	cd_material_estoque,
	ie_origem_proced,
	nr_ordem_compra,
	nr_item_oci,
	nr_sequencia_w,
	vl_liquido,
	nr_seq_ordem_serv,
	nr_seq_lote_fornec,
	dt_inicio_garantia,
	dt_fim_garantia,
	dt_entrega_ordem,
	nr_seq_conta_financ,
	vl_total_estrangeiro, 
	vl_unit_estrangeiro, 
	vl_dif_estrangeiro,
	nr_titulo,
	nr_seq_tit_rec
from	nota_fiscal_item
where	nr_sequencia = nr_seq_nota_fiscal_p;

insert into nota_fiscal_trib(
	ie_retencao,
	nr_sequencia,
	cd_tributo,
	vl_tributo,
	dt_atualizacao,
	nm_usuario,
	vl_base_calculo,
	tx_tributo,
	vl_reducao_base,
	vl_trib_nao_retido,
	vl_base_nao_retido,
	vl_trib_adic,
	vl_base_adic,
	dt_atualizacao_nrec,
	nm_usuario_nrec,
	nr_seq_interno)
SELECT ie_retencao,	
	nr_sequencia_w,
	cd_tributo,
	vl_tributo,
	dt_atualizacao,
	nm_usuario,
	vl_base_calculo,
	tx_tributo,
	vl_reducao_base,
	vl_trib_nao_retido,
	vl_base_nao_retido,
	vl_trib_adic,
	vl_base_adic,
	clock_timestamp(),
	nm_usuario_p,
	nextval('nota_fiscal_trib_seq')
from	nota_fiscal_trib
where	nr_sequencia = nr_seq_nota_fiscal_p;

insert into fis_rateio_trib_item(
	nr_sequencia,
	cd_estabelecimento,
	dt_atualizacao,
	nm_usuario,
	dt_atualizacao_nrec,
	nm_usuario_nrec,
	cd_centro_custo,
	cd_tributo,
	pr_percentual,
	vl_rateio,
	nr_seq_nota_fiscal,
	nr_item_nf)
SELECT	nextval('fis_rateio_trib_item_seq'),
	cd_estabelecimento,
	dt_atualizacao,
	nm_usuario,
	clock_timestamp(),
	nm_usuario_p,
	cd_centro_custo,
	cd_tributo,
	pr_percentual,
	vl_rateio,
	nr_sequencia_w,
	nr_item_nf
from	fis_rateio_trib_item
where	nr_seq_nota_fiscal = nr_seq_nota_fiscal_p;

insert into nota_fiscal_venc(
	cd_estabelecimento,
	cd_cgc_emitente,
	cd_serie_nf,
	nr_nota_fiscal,
	nr_sequencia_nf,
	dt_vencimento,
	vl_vencimento,
	dt_atualizacao,
	nm_usuario,
	nr_sequencia,
	ie_origem)
SELECT	cd_estabelecimento,
	cd_cgc_emitente,
	cd_serie_nf,
	nr_nota_fiscal,
	nr_sequencia_nf_w,
	clock_timestamp(),
	vl_vencimento,
	clock_timestamp(),
	nm_usuario_p,
	nr_sequencia_w,
	coalesce(ie_origem,'N')
from	nota_fiscal_venc
where	nr_sequencia = nr_seq_nota_fiscal_p;

insert into nota_fiscal_venc_trib(
	nr_sequencia,
	dt_vencimento,
	cd_tributo,
	vl_tributo,
	dt_atualizacao,
	nm_usuario,
	vl_base_calculo,
	tx_tributo,
	vl_trib_nao_retido,
	vl_base_nao_retido,
	vl_trib_adic,
	vl_base_adic,
	vl_reducao,
	vl_desc_base,
	cd_darf,
	ie_origem)
SELECT	nr_sequencia_w,
	clock_timestamp(),
	cd_tributo,
	vl_tributo,
	clock_timestamp(),
	nm_usuario_p,
	vl_base_calculo,
	tx_tributo,
	vl_trib_nao_retido,
	vl_base_nao_retido,
	vl_trib_adic,
	vl_base_adic,
	vl_reducao,
	vl_desc_base,
	cd_darf,
	coalesce(ie_origem,'N')
from	nota_fiscal_venc_trib
where	nr_sequencia = nr_seq_nota_fiscal_p;

insert into nota_fiscal_item_trib(
	cd_estabelecimento,
	cd_cgc_emitente,
	cd_serie_nf,
	nr_nota_fiscal,
	nr_sequencia_nf,
	nr_item_nf,
	cd_tributo,
	vl_tributo,
	dt_atualizacao,
	nm_usuario,
	vl_base_calculo,
	tx_tributo,
	vl_reducao_base,
	nr_sequencia,
	ie_rateio,
	vl_trib_nao_retido,
	vl_base_nao_retido,
	vl_trib_adic,
	vl_base_adic)
SELECT
	cd_estabelecimento,
	cd_cgc_emitente,
	cd_serie_nf,
	nr_nota_fiscal,
	nr_sequencia_nf_w,
	nr_item_nf,
	cd_tributo,
	vl_tributo,
	clock_timestamp(),
	nm_usuario,
	vl_base_calculo,
	tx_tributo,
	vl_reducao_base,
	nr_sequencia_w,
	ie_rateio,
	vl_trib_nao_retido,
	vl_base_nao_retido,
	vl_trib_adic,
	vl_base_adic
from	nota_fiscal_item_trib
where	nr_sequencia = nr_seq_nota_fiscal_p;

insert into Nota_Fiscal_Item_Rateio(
	nr_sequencia,
	nr_seq_nota,
	nr_item_nf,
	nr_seq_criterio,
	dt_atualizacao,
	nm_usuario,
	cd_centro_custo,
	cd_conta_contabil,
	cd_conta_financ,
	vl_rateio,
	vl_frete,
	vl_desconto,
	vl_seguro,
	vl_despesa_acessoria,
	ie_situacao,
	qt_rateio)
SELECT	nextval('nota_fiscal_item_rateio_seq'),
	nr_sequencia_w,
	nr_item_nf,
	nr_seq_criterio,
	clock_timestamp(),
	nm_usuario_p,
	cd_centro_custo,
	cd_conta_contabil,
	cd_conta_financ,
	vl_rateio,
	vl_frete,
	vl_desconto,
	vl_seguro,
	vl_despesa_acessoria,
	ie_situacao,
	qt_rateio
from	Nota_Fiscal_Item_Rateio
where	nr_seq_nota    = nr_seq_nota_fiscal_p;

insert into nota_fiscal_desp_adic(
	nr_sequencia,
	nr_seq_nf,
	nr_documento,
	dt_emissao,
	vl_documento,
	dt_vencimento,
	cd_cgc,
	ds_observacao,
	dt_atualizacao,
	nm_usuario)
SELECT	nextval('nota_fiscal_desp_adic_seq'),
	nr_sequencia_w,
	nr_documento,
	dt_emissao,
	vl_documento,
	dt_vencimento,
	cd_cgc,
	ds_observacao,
	clock_timestamp(),
	nm_usuario_p
from	nota_fiscal_desp_adic
where	nr_seq_nf = nr_seq_nota_fiscal_p;

insert into nota_fiscal_item_lote(
	nr_sequencia,
	dt_atualizacao,
	nm_usuario,
	nr_seq_nota,
	nr_item_nf,
	dt_validade,
	qt_material,
	cd_lote_fabricacao,
	dt_atualizacao_nrec,
	nm_usuario_nrec,
	nr_seq_marca,
	nr_seq_lote_fornec,
	ie_indeterminado)
SELECT	nextval('nota_fiscal_item_lote_seq'),
	clock_timestamp(),
	nm_usuario_p,
	nr_sequencia_w,
	nr_item_nf,
	dt_validade,
	qt_material,
	cd_lote_fabricacao,
	clock_timestamp(),
	nm_usuario_p,
	nr_seq_marca,
	nr_seq_lote_fornec,
	ie_indeterminado
from	nota_fiscal_item_lote
where	nr_seq_nota = nr_seq_nota_fiscal_p;

insert into nota_fiscal_conta(
	nr_sequencia,
	nr_seq_nf,
	dt_atualizacao,
	nm_usuario,
	dt_atualizacao_nrec,
	nm_usuario_nrec,
	cd_conta_contabil,
	vl_contabil)
SELECT	nextval('nota_fiscal_conta_seq'),
	nr_sequencia_w,
	clock_timestamp(),
	nm_usuario_p,
	clock_timestamp(),
	nm_usuario_p,
	cd_conta_contabil,
	vl_contabil
from	nota_fiscal_conta
where	nr_seq_nf = nr_seq_nota_fiscal_p;

nr_seq_nf_new_p:= 	nr_sequencia_w;
ie_tipo_nota_p:=	ie_tipo_nota_w;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE fis_refatoracao_nf_pck.fis_duplicar_nf ( nr_seq_nota_fiscal_p nota_fiscal.nr_sequencia%type, nr_seq_nf_new_p INOUT nota_fiscal.nr_sequencia%type, ie_tipo_nota_p INOUT nota_fiscal.ie_tipo_nota%type, nm_usuario_p text) FROM PUBLIC;
