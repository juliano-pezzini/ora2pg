-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



/*Procedures*/

--fis_obter_nf_adiantamento
CREATE OR REPLACE PROCEDURE fis_refatoracao_nf_pck.fis_obter_nfs_adiantamento ( nr_interno_conta_p conta_paciente.nr_interno_conta%type, nr_seq_refat_nf_p fis_refatoracao_nf.nr_sequencia%type, nm_usuario_p text) AS $body$
DECLARE


qt_cursor_adiant_w	bigint := 0;
nr_seq_ref_nf_adian_w	fis_refatoracao_nf_adian.nr_sequencia%type;

c_adiantamento CURSOR FOR
	SELECT	a.nr_adiantamento,
		a.nr_interno_conta,
		obter_nota_fiscal_adiant(a.nr_adiantamento) nr_seq_nota_fiscal
	from	conta_paciente_adiant	a
	where	a.nr_interno_conta 	= nr_interno_conta_p;

c_adiantamento_w          c_adiantamento%rowtype;


BEGIN

open c_adiantamento;
loop
fetch c_adiantamento into	
	c_adiantamento_w;
EXIT WHEN NOT FOUND; /* apply on c_adiantamento */
	begin
	
	/*Incrementa a variavel para o array*/

	qt_cursor_adiant_w:=	qt_cursor_adiant_w + 1;

	/*Pega a sequencia da taleba fis_refatoracao_nf_adian para o insert*/

	select	nextval('fis_refatoracao_nf_adian_seq')
	into STRICT	nr_seq_ref_nf_adian_w
	;

	/*Inserindo valores no array para realiza??o do forall posteriormente*/
	current_setting('fis_refatoracao_nf_pck.fis_refatoracao_nf_adian_w')::reg_refatoracao_nf_adian[qt_cursor_adiant_w].nr_sequencia 		:= nr_seq_ref_nf_adian_w;
	current_setting('fis_refatoracao_nf_pck.fis_refatoracao_nf_adian_w')::reg_refatoracao_nf_adian[qt_cursor_adiant_w].nr_seq_refat_nf		:= nr_seq_refat_nf_p;
	current_setting('fis_refatoracao_nf_pck.fis_refatoracao_nf_adian_w')::reg_refatoracao_nf_adian[qt_cursor_adiant_w].nr_adiantamento		:= c_adiantamento_w.nr_adiantamento;
	current_setting('fis_refatoracao_nf_pck.fis_refatoracao_nf_adian_w')::reg_refatoracao_nf_adian[qt_cursor_adiant_w].nr_seq_nf_adiant_old	:= c_adiantamento_w.nr_seq_nota_fiscal;
	current_setting('fis_refatoracao_nf_pck.fis_refatoracao_nf_adian_w')::reg_refatoracao_nf_adian[qt_cursor_adiant_w].nr_seq_nf_adiant_new	:= null;
	
	
	end;
end loop;
close c_adiantamento;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE fis_refatoracao_nf_pck.fis_obter_nfs_adiantamento ( nr_interno_conta_p conta_paciente.nr_interno_conta%type, nr_seq_refat_nf_p fis_refatoracao_nf.nr_sequencia%type, nm_usuario_p text) FROM PUBLIC;
