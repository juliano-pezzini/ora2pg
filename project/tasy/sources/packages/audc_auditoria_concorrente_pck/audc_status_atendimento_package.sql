-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION audc_auditoria_concorrente_pck.audc_status_atendimento ( nr_seq_audc_atend_p audc_atendimento.nr_sequencia%type, nm_usuario_exec_p usuario.nm_usuario%type) RETURNS bigint AS $body$
DECLARE


ie_status_w	smallint;
					

C01 CURSOR(	nr_seq_audc_atend_pc	audc_atendimento.nr_sequencia%type,
	 	nm_usuario_exec_pc	usuario.nm_usuario%type) FOR
		
	SELECT  nr_sequencia,
        	dt_fim_analise,
		dt_inicio_analise
	from    audc_atend_grupo_aud
	where   nr_seq_audc_atend = nr_seq_audc_atend_pc
	and     nm_usuario_exec =  nm_usuario_exec_pc
	and (to_date(dt_inicio_analise,'dd/mm/yyyy') = to_date(clock_timestamp(),'dd/mm/yyyy') or coalesce(dt_inicio_analise::text, '') = '')
	order by nr_sequencia asc;

	
BEGIN

ie_status_w := 2;

/*
Status
1 - Avaliacao em andamento 
2 - Aguardando avaliacao
3 - Avaliacao concluida
*/


for c01_w in C01(nr_seq_audc_atend_p, nm_usuario_exec_p) loop
	
	if ( (c01_w.dt_inicio_analise IS NOT NULL AND c01_w.dt_inicio_analise::text <> '') and coalesce(c01_w.dt_fim_analise::text, '') = ''  ) then
	   	ie_status_w := 1;
	elsif (c01_w.dt_fim_analise IS NOT NULL AND c01_w.dt_fim_analise::text <> '') then
	    	ie_status_w := 3;
	end if;
end loop;


return	ie_status_w;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION audc_auditoria_concorrente_pck.audc_status_atendimento ( nr_seq_audc_atend_p audc_atendimento.nr_sequencia%type, nm_usuario_exec_p usuario.nm_usuario%type) FROM PUBLIC;
