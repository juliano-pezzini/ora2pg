-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_reaj_cobranca_retro_pck.insert_lancamentos ( cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE


C01 CURSOR(	nr_seq_regra_apropriacao_pc	pls_regra_apropriacao.nr_sequencia%type,
		nr_seq_preco_pc			pls_plano_preco.nr_sequencia%type,
		nr_seq_mensalidade_seg_pc	pls_mensalidade_segurado.nr_sequencia%type) FOR
	SELECT	a.nr_seq_centro_apropriacao,
		a.vl_apropriacao,
		a.tx_apropriacao
	from	pls_regra_apropriacao_item a
	where	a.nr_seq_apropriacao = nr_seq_regra_apropriacao_pc
	and	((a.ie_permite_reajustar = 'S') or (a.tx_apropriacao IS NOT NULL AND a.tx_apropriacao::text <> ''))
	and	a.nr_seq_preco = nr_seq_preco_pc
	and	exists (SELECT	1
			from	pls_mensalidade_seg_item x,
				pls_mens_seg_item_aprop y
			where	x.nr_sequencia = y.nr_seq_item
			and	y.nr_seq_centro_apropriacao = a.nr_seq_centro_apropriacao
			and	x.nr_seq_mensalidade_seg = nr_seq_mensalidade_seg_pc
			and	x.ie_tipo_item in ('1','5','25','12','31','41'))
	order by
		a.vl_apropriacao desc,
		a.tx_apropriacao desc;
	
BEGIN

if (current_setting('pls_reaj_cobranca_retro_pck.tb_nr_seq_segurado_w')::pls_util_cta_pck.t_number_table.count > 0) then
	forall i in current_setting('pls_reaj_cobranca_retro_pck.tb_nr_seq_segurado_w')::pls_util_cta_pck.t_number_table.first..tb_nr_seq_segurado_w.last
		insert	into	pls_segurado_mensalidade(	nr_sequencia, cd_estabelecimento, dt_atualizacao, nm_usuario,
				dt_atualizacao_nrec, nm_usuario_nrec, nr_seq_segurado,
				nr_seq_pagador, dt_referencia, ie_tipo_item,
				ie_tipo_lanc, ie_acao_desfazer, ie_situacao,
				tx_desconto, vl_item, nr_seq_reaj_retro,
				dt_inicio_cobertura, dt_fim_cobertura, nr_seq_vinculo_sca,
				nr_parcela_sca, ds_observacao, ie_recomposicao)
			values (	nextval('pls_segurado_mensalidade_seq'), cd_estabelecimento_p, clock_timestamp(), nm_usuario_p,
				clock_timestamp(), nm_usuario_p, current_setting('pls_reaj_cobranca_retro_pck.tb_nr_seq_segurado_w')::pls_util_cta_pck.t_number_table(i),
				current_setting('pls_reaj_cobranca_retro_pck.tb_nr_seq_pagador_w')::pls_util_cta_pck.t_number_table(i), current_setting('pls_reaj_cobranca_retro_pck.tb_dt_referencia_w')::pls_util_cta_pck.t_date_table(i), '4',
				'B', 'A', 'A',
				0, current_setting('pls_reaj_cobranca_retro_pck.tb_vl_lancamento_w')::pls_util_cta_pck.t_number_table(i), current_setting('pls_reaj_cobranca_retro_pck.tb_nr_seq_reaj_retro_w')::pls_util_cta_pck.t_number_table(i),
				current_setting('pls_reaj_cobranca_retro_pck.tb_dt_inicio_cobertura_w')::pls_util_cta_pck.t_date_table(i), current_setting('pls_reaj_cobranca_retro_pck.tb_dt_fim_cobertura_w')::pls_util_cta_pck.t_date_table(i), current_setting('pls_reaj_cobranca_retro_pck.tb_nr_seq_vinculo_sca_w')::pls_util_cta_pck.t_number_table(i),
				current_setting('pls_reaj_cobranca_retro_pck.tb_nr_parcela_sca_w')::pls_util_cta_pck.t_number_table(i), current_setting('pls_reaj_cobranca_retro_pck.tb_ds_observacao_w')::pls_util_cta_pck.t_varchar2_table_255(i), current_setting('pls_reaj_cobranca_retro_pck.tb_ie_recomposicao_w')::pls_util_cta_pck.t_varchar2_table_1(i))
		RETURNING 	nr_sequencia, current_setting('pls_reaj_cobranca_retro_pck.tb_nr_seq_segurado_preco_w')::pls_util_cta_pck.t_number_table(i), current_setting('pls_reaj_cobranca_retro_pck.tb_vl_lancamento_w')::pls_util_cta_pck.t_number_table(i), current_setting('pls_reaj_cobranca_retro_pck.tb_nr_seq_mensalidade_seg_w')::pls_util_cta_pck.t_number_table(i), current_setting('pls_reaj_cobranca_retro_pck.tb_qt_valor_apropriacao_w')::pls_util_cta_pck.t_number_table(i)
		BULK COLLECT INTO current_setting('pls_reaj_cobranca_retro_pck.tb_nr_seq_seg_mensalidade_wr')::pls_util_cta_pck.t_number_table, current_setting('pls_reaj_cobranca_retro_pck.tb_nr_seq_segurado_preco_wr')::pls_util_cta_pck.t_number_table, current_setting('pls_reaj_cobranca_retro_pck.tb_vl_lancamento_wr')::pls_util_cta_pck.t_number_table, current_setting('pls_reaj_cobranca_retro_pck.tb_nr_seq_mensalidade_seg_wr')::pls_util_cta_pck.t_number_table, current_setting('pls_reaj_cobranca_retro_pck.tb_qt_valor_apropriacao_wr')::pls_util_cta_pck.t_number_table;
	commit;

	for i in current_setting('pls_reaj_cobranca_retro_pck.tb_nr_seq_seg_mensalidade_wr')::pls_util_cta_pck.t_number_table.first..tb_nr_seq_seg_mensalidade_wr.last loop
		begin
		if (current_setting('pls_reaj_cobranca_retro_pck.tb_nr_seq_segurado_preco_wr')::(pls_util_cta_pck.t_number_table(i) IS NOT NULL AND (pls_util_cta_pck.t_number_table(i))::text <> '')) then
			PERFORM set_config('pls_reaj_cobranca_retro_pck.qt_registro_w', 0, false);
			PERFORM set_config('pls_reaj_cobranca_retro_pck.vl_apropriado_w', 0, false);
			PERFORM set_config('pls_reaj_cobranca_retro_pck.vl_total_apropriado_w', 0, false);
			PERFORM set_config('pls_reaj_cobranca_retro_pck.vl_lancamento_w', current_setting('pls_reaj_cobranca_retro_pck.tb_vl_lancamento_wr')::pls_util_cta_pck.t_number_table(i), false);

			if (current_setting('pls_reaj_cobranca_retro_pck.tb_qt_valor_apropriacao_wr')::pls_util_cta_pck.t_number_table(i) > 0) then
				select	a.nr_seq_tabela,
					a.nr_seq_plano,
					a.nr_seq_classif_dependencia,
					b.dt_reajuste,
					b.nr_seq_regra_apropriacao,
					b.nr_seq_preco
				into STRICT	current_setting('pls_reaj_cobranca_retro_pck.nr_seq_tabela_w')::pls_tabela_preco.nr_sequencia%type,
					current_setting('pls_reaj_cobranca_retro_pck.nr_seq_plano_w')::pls_plano.nr_sequencia%type,
					current_setting('pls_reaj_cobranca_retro_pck.nr_seq_classif_dependencia_w')::pls_segurado.nr_seq_classif_dependencia%type,
					current_setting('pls_reaj_cobranca_retro_pck.dt_reajuste_preco_w')::pls_segurado_preco.dt_reajuste%type,
					current_setting('pls_reaj_cobranca_retro_pck.nr_seq_regra_apropriacao_w')::pls_regra_apropriacao.nr_sequencia%type,
					current_setting('pls_reaj_cobranca_retro_pck.nr_seq_preco_w')::pls_plano_preco.nr_sequencia%type
				from	pls_segurado a,
					pls_segurado_preco b
				where	a.nr_sequencia = b.nr_seq_segurado
				and	b.nr_sequencia = current_setting('pls_reaj_cobranca_retro_pck.tb_nr_seq_segurado_preco_wr')::pls_util_cta_pck.t_number_table(i);
				
				if (current_setting('pls_reaj_cobranca_retro_pck.nr_seq_regra_apropriacao_w')::pls_regra_apropriacao.nr_sequencia%coalesce(type::text, '') = '') then
					select	max(nr_sequencia)
					into STRICT	current_setting('pls_reaj_cobranca_retro_pck.nr_seq_regra_aprop_w')::pls_regra_apropriacao.nr_sequencia%type
					from	pls_regra_apropriacao
					where	nr_seq_plano			= current_setting('pls_reaj_cobranca_retro_pck.nr_seq_plano_w')::pls_plano.nr_sequencia%type
					and	nr_seq_tabela			= current_setting('pls_reaj_cobranca_retro_pck.nr_seq_tabela_w')::pls_tabela_preco.nr_sequencia%type
					and	((nr_seq_classif_dependencia	= current_setting('pls_reaj_cobranca_retro_pck.nr_seq_classif_dependencia_w')::pls_segurado.nr_seq_classif_dependencia%type) or (current_setting('pls_reaj_cobranca_retro_pck.nr_seq_classif_dependencia_w')::pls_segurado.nr_seq_classif_dependencia%coalesce(type::text, '') = ''))
					and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
					and	current_setting('pls_reaj_cobranca_retro_pck.dt_reajuste_preco_w')::pls_segurado_preco.dt_reajuste%type between dt_inicio_vigencia and coalesce(dt_fim_vigencia, current_setting('pls_reaj_cobranca_retro_pck.dt_reajuste_preco_w')::pls_segurado_preco.dt_reajuste%type);
				else
					PERFORM set_config('pls_reaj_cobranca_retro_pck.nr_seq_regra_aprop_w', current_setting('pls_reaj_cobranca_retro_pck.nr_seq_regra_apropriacao_w')::pls_regra_apropriacao.nr_sequencia%type, false);
				end if;

				if (current_setting('pls_reaj_cobranca_retro_pck.nr_seq_regra_aprop_w')::pls_regra_apropriacao.nr_sequencia%(type IS NOT NULL AND type::text <> '')) then
					select	count(1),
						sum(a.tx_apropriacao),
						sum(a.vl_apropriacao)
					into STRICT	current_setting('pls_reaj_cobranca_retro_pck.qt_total_w')::bigint,
						current_setting('pls_reaj_cobranca_retro_pck.tx_apropriacao_w')::double,
						current_setting('pls_reaj_cobranca_retro_pck.vl_apropriacao_total_w')::double
					from	pls_regra_apropriacao_item a
					where	a.nr_seq_apropriacao = current_setting('pls_reaj_cobranca_retro_pck.nr_seq_regra_aprop_w')::pls_regra_apropriacao.nr_sequencia%type
					and	a.nr_seq_preco = current_setting('pls_reaj_cobranca_retro_pck.nr_seq_preco_w')::pls_plano_preco.nr_sequencia%type
					and	exists (SELECT	1
							from	pls_mensalidade_seg_item x,
								pls_mens_seg_item_aprop y
							where	x.nr_sequencia = y.nr_seq_item
							and	y.nr_seq_centro_apropriacao = a.nr_seq_centro_apropriacao
							and	x.nr_seq_mensalidade_seg = current_setting('pls_reaj_cobranca_retro_pck.tb_nr_seq_mensalidade_seg_wr')::pls_util_cta_pck.t_number_table(i)
							and	x.ie_tipo_item in ('1','5','25','12','31','41'));

					for r_c01_w in c01(current_setting('pls_reaj_cobranca_retro_pck.nr_seq_regra_aprop_w')::pls_regra_apropriacao.nr_sequencia%type, current_setting('pls_reaj_cobranca_retro_pck.nr_seq_preco_w')::pls_plano_preco.nr_sequencia%type, current_setting('pls_reaj_cobranca_retro_pck.tb_nr_seq_mensalidade_seg_wr')::pls_util_cta_pck.t_number_table(i)) loop
						begin
						PERFORM set_config('pls_reaj_cobranca_retro_pck.qt_registro_w', current_setting('pls_reaj_cobranca_retro_pck.qt_registro_w')::bigint + 1, false);

						if (r_c01_w.vl_apropriacao IS NOT NULL AND r_c01_w.vl_apropriacao::text <> '') then
							if (current_setting('pls_reaj_cobranca_retro_pck.qt_registro_w')::bigint = current_setting('pls_reaj_cobranca_retro_pck.qt_total_w')::bigint) then
								PERFORM set_config('pls_reaj_cobranca_retro_pck.vl_apropriado_w', current_setting('pls_reaj_cobranca_retro_pck.vl_lancamento_w')::double - current_setting('pls_reaj_cobranca_retro_pck.vl_total_apropriado_w')::double, false);
							else
								PERFORM set_config('pls_reaj_cobranca_retro_pck.vl_apropriado_w', (current_setting('pls_reaj_cobranca_retro_pck.vl_lancamento_w')::double*(r_c01_w.vl_apropriacao/current_setting('pls_reaj_cobranca_retro_pck.vl_apropriacao_total_w')::double)), false);
							end if;
						else
							PERFORM set_config('pls_reaj_cobranca_retro_pck.vl_apropriado_w', current_setting('pls_reaj_cobranca_retro_pck.vl_lancamento_w')::double * dividir_sem_round(r_c01_w.tx_apropriacao, current_setting('pls_reaj_cobranca_retro_pck.tx_apropriacao_w')::double), false);

							if (current_setting('pls_reaj_cobranca_retro_pck.qt_registro_w')::bigint = current_setting('pls_reaj_cobranca_retro_pck.qt_total_w')::bigint) then
								if	((current_setting('pls_reaj_cobranca_retro_pck.vl_apropriado_w')::double + current_setting('pls_reaj_cobranca_retro_pck.vl_total_apropriado_w')::double) <> current_setting('pls_reaj_cobranca_retro_pck.vl_lancamento_w')::double) then
									PERFORM set_config('pls_reaj_cobranca_retro_pck.vl_apropriado_w', current_setting('pls_reaj_cobranca_retro_pck.vl_apropriado_w')::double - ((current_setting('pls_reaj_cobranca_retro_pck.vl_apropriado_w')::double + current_setting('pls_reaj_cobranca_retro_pck.vl_total_apropriado_w')::double) - current_setting('pls_reaj_cobranca_retro_pck.vl_lancamento_w')::double), false);
								end if;
							else
								if	(((current_setting('pls_reaj_cobranca_retro_pck.vl_apropriado_w')::double + current_setting('pls_reaj_cobranca_retro_pck.vl_total_apropriado_w')::double) > current_setting('pls_reaj_cobranca_retro_pck.vl_lancamento_w')::double) and (current_setting('pls_reaj_cobranca_retro_pck.vl_lancamento_w')::double > 0)) or
									(((current_setting('pls_reaj_cobranca_retro_pck.vl_apropriado_w')::double + current_setting('pls_reaj_cobranca_retro_pck.vl_total_apropriado_w')::double) < current_setting('pls_reaj_cobranca_retro_pck.vl_lancamento_w')::double) and (current_setting('pls_reaj_cobranca_retro_pck.vl_lancamento_w')::double < 0)) then
									PERFORM set_config('pls_reaj_cobranca_retro_pck.vl_apropriado_w', current_setting('pls_reaj_cobranca_retro_pck.vl_lancamento_w')::double - current_setting('pls_reaj_cobranca_retro_pck.vl_total_apropriado_w')::double, false);
								end if;
							end if;
						end if;

						insert into pls_lancamento_mens_aprop(	nr_sequencia, dt_atualizacao, nm_usuario,
							dt_atualizacao_nrec, nm_usuario_nrec, vl_apropriacao, 
							nr_seq_centro_apropriacao, nr_seq_lanc_auto)
						values (	nextval('pls_lancamento_mens_aprop_seq'), clock_timestamp(), nm_usuario_p,
							clock_timestamp(), nm_usuario_p, current_setting('pls_reaj_cobranca_retro_pck.vl_apropriado_w')::double,
							r_c01_w.nr_seq_centro_apropriacao, current_setting('pls_reaj_cobranca_retro_pck.tb_nr_seq_seg_mensalidade_wr')::pls_util_cta_pck.t_number_table(i));
							
						PERFORM set_config('pls_reaj_cobranca_retro_pck.vl_total_apropriado_w', current_setting('pls_reaj_cobranca_retro_pck.vl_total_apropriado_w')::double + current_setting('pls_reaj_cobranca_retro_pck.vl_apropriado_w')::double, false);
						end;
					end loop;
				end if;
			end if;
		end if;
		end;
	end loop;
end if;

PERFORM set_config('pls_reaj_cobranca_retro_pck.nr_indice_w', 1, false);
current_setting('pls_reaj_cobranca_retro_pck.tb_nr_seq_segurado_w')::pls_util_cta_pck.t_number_table.delete;
current_setting('pls_reaj_cobranca_retro_pck.tb_nr_seq_pagador_w')::pls_util_cta_pck.t_number_table.delete;
current_setting('pls_reaj_cobranca_retro_pck.tb_dt_referencia_w')::pls_util_cta_pck.t_date_table.delete;
current_setting('pls_reaj_cobranca_retro_pck.tb_vl_lancamento_w')::pls_util_cta_pck.t_number_table.delete;
current_setting('pls_reaj_cobranca_retro_pck.tb_nr_seq_reaj_retro_w')::pls_util_cta_pck.t_number_table.delete;
current_setting('pls_reaj_cobranca_retro_pck.tb_dt_inicio_cobertura_w')::pls_util_cta_pck.t_date_table.delete;
current_setting('pls_reaj_cobranca_retro_pck.tb_dt_fim_cobertura_w')::pls_util_cta_pck.t_date_table.delete;
current_setting('pls_reaj_cobranca_retro_pck.tb_nr_seq_vinculo_sca_w')::pls_util_cta_pck.t_number_table.delete;
current_setting('pls_reaj_cobranca_retro_pck.tb_nr_parcela_sca_w')::pls_util_cta_pck.t_number_table.delete;
current_setting('pls_reaj_cobranca_retro_pck.tb_ds_observacao_w')::pls_util_cta_pck.t_varchar2_table_255.delete;
current_setting('pls_reaj_cobranca_retro_pck.tb_nr_seq_segurado_preco_w')::pls_util_cta_pck.t_number_table.delete;
current_setting('pls_reaj_cobranca_retro_pck.tb_nr_seq_mensalidade_seg_w')::pls_util_cta_pck.t_number_table.delete;
current_setting('pls_reaj_cobranca_retro_pck.tb_ie_recomposicao_w')::pls_util_cta_pck.t_varchar2_table_1.delete;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_reaj_cobranca_retro_pck.insert_lancamentos ( cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;
