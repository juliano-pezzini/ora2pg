-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_reaj_cobranca_retro_pck.gerar_lancamentos_sca ( nr_seq_reajuste_p pls_reajuste.nr_sequencia%type, nr_seq_lote_retro_p pls_reajuste_cobr_retro.nr_sequencia%type, dt_reajuste_p pls_reajuste_cobr_retro.dt_referencia_reajuste%type, dt_mensalidade_p pls_reajuste_cobr_retro.dt_referencia_mensalidade%type, qt_parcela_p bigint, ie_recomposicao_p text, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE


current_setting('pls_reaj_cobranca_retro_pck.vl_lancamento_w')::double			pls_segurado_mensalidade.vl_item%type;
vl_parcela_w			pls_segurado_mensalidade.vl_item%type;
dt_parcela_w			pls_segurado_mensalidade.dt_referencia%type;
ds_mensagem_parcela_w		varchar(255);

--Nao pode restringir o tipo de produto da tabela de preco, pois SCA tambem pode estar cadastrado como produto para o contrato

C01 CURSOR(	ie_tipo_lote_pc		pls_reajuste.ie_tipo_lote%type) FOR
	SELECT	nr_seq_tabela
	from	pls_reajuste_tabela
	where	nr_seq_reajuste	= nr_seq_reajuste_p
	and	tx_reajuste <> 0
	and	ie_tipo_lote_pc <> 'D'
	
union

	SELECT	a.nr_seq_tabela
	from	pls_reajuste_tabela a
	where	a.nr_seq_reajuste = nr_seq_reajuste_p
	and	exists (select	1
			from	pls_reajuste x
			where	x.nr_sequencia = a.nr_seq_reajuste
			and	x.tx_reajuste_correto <> 0)
	and	ie_tipo_lote_pc = 'D';

C02 CURSOR(	nr_seq_tabela_pc		pls_reajuste_tabela.nr_seq_tabela%type,
		dt_referencia_reajuste_pc	pls_reajuste_cobr_retro.dt_referencia_reajuste%type) FOR
	SELECT	x.nr_sequencia nr_seq_vinculo_sca,
		y.nr_parcela nr_parcela_sca,
		b.nr_seq_segurado,
		sum(y.vl_parcela) vl_item,
		a.dt_inicio_cobertura,
		a.dt_fim_cobertura,
		b.dt_mesano_referencia,
		c.nr_seq_pagador,
		(SELECT	max(y.dt_rescisao)
		from	pls_segurado y
		where	y.nr_sequencia = b.nr_seq_segurado) dt_rescisao,
		b.nr_sequencia nr_seq_mensalidade_seg
	from	pls_sca_vinculo x,
		pls_mensalidade_sca y,
		pls_mensalidade_seg_item a,
		pls_mensalidade_segurado b,
		pls_mensalidade c,
		pls_lote_mensalidade d
	where	x.nr_sequencia	= y.nr_seq_vinculo_sca
	and	a.nr_sequencia	= y.nr_seq_item_mens
	and	b.nr_sequencia	= a.nr_seq_mensalidade_seg
	and	c.nr_sequencia	= b.nr_seq_mensalidade
	and	d.nr_sequencia	= c.nr_seq_lote
	and	coalesce(c.ie_cancelamento::text, '') = ''
	and	d.ie_status	= 2
	and	x.nr_seq_tabela	= nr_seq_tabela_pc
	and	b.dt_mesano_referencia	= dt_referencia_reajuste_pc
	and 	a.ie_tipo_item <> '4'
	and	x.ie_lancamento_mensalidade = 'D'
	group by
		x.nr_sequencia,
		y.nr_parcela,
		b.nr_seq_segurado,
		a.dt_inicio_cobertura,
		a.dt_fim_cobertura,
		b.dt_mesano_referencia,
		c.nr_seq_pagador,
		b.nr_sequencia;

BEGIN

--Zerar as varivaveis do vetor e o contador

current_setting('pls_reaj_cobranca_retro_pck.tb_nr_seq_segurado_w')::pls_util_cta_pck.t_number_table.delete;
CALL pls_reaj_cobranca_retro_pck.insert_lancamentos(cd_estabelecimento_p,nm_usuario_p);

for r_c01_w in C01(current_setting('pls_reaj_cobranca_retro_pck.ie_tipo_lote_w')::pls_reajuste.ie_tipo_lote%type) loop
	begin
	for r_c02_w in C02(r_c01_w.nr_seq_tabela, dt_reajuste_p) loop
		begin
		if (pls_reaj_cobranca_retro_pck.verificar_se_gera_cobr_retro(r_c02_w.dt_rescisao, r_c02_w.dt_inicio_cobertura, r_c02_w.nr_seq_mensalidade_seg, r_c02_w.nr_seq_vinculo_sca) = 'S') then
			if (current_setting('pls_reaj_cobranca_retro_pck.ie_truncar_valor_reajuste_w')::pls_parametros.ie_truncar_valor_reajuste%type = 'S') then
				PERFORM set_config('pls_reaj_cobranca_retro_pck.vl_lancamento_w', trunc((r_c02_w.vl_item * current_setting('pls_reaj_cobranca_retro_pck.tx_reajuste_w')::pls_reajuste.tx_reajuste%type) / 100,2), false);
			else
				PERFORM set_config('pls_reaj_cobranca_retro_pck.vl_lancamento_w', (r_c02_w.vl_item * current_setting('pls_reaj_cobranca_retro_pck.tx_reajuste_w')::pls_reajuste.tx_reajuste%type) / 100, false);
			end if;
			
			if (current_setting('pls_reaj_cobranca_retro_pck.vl_lancamento_w')::double <> 0) then
				for i in 1..qt_parcela_p loop
					begin
					dt_parcela_w	:= add_months(dt_mensalidade_p,i-1);
					if (i = qt_parcela_p) then
						vl_parcela_w	:= current_setting('pls_reaj_cobranca_retro_pck.vl_lancamento_w')::double / qt_parcela_p;
						vl_parcela_w	:= vl_parcela_w + (current_setting('pls_reaj_cobranca_retro_pck.vl_lancamento_w')::double - (vl_parcela_w*qt_parcela_p));
					else
						vl_parcela_w	:= current_setting('pls_reaj_cobranca_retro_pck.vl_lancamento_w')::double / qt_parcela_p;
					end if;
					
					if (qt_parcela_p > 1) then
						ds_mensagem_parcela_w	:= '. Parcela ' ||i||'/'||qt_parcela_p||' - Valor total: R$'||campo_mascara_virgula(current_setting('pls_reaj_cobranca_retro_pck.vl_lancamento_w')::double);
					else
						ds_mensagem_parcela_w	:= null;
					end if;
					
					current_setting('pls_reaj_cobranca_retro_pck.tb_nr_seq_segurado_w')::pls_util_cta_pck.t_number_table(current_setting('pls_reaj_cobranca_retro_pck.nr_indice_w')::integer)	:= r_c02_w.nr_seq_segurado;
					current_setting('pls_reaj_cobranca_retro_pck.tb_nr_seq_pagador_w')::pls_util_cta_pck.t_number_table(current_setting('pls_reaj_cobranca_retro_pck.nr_indice_w')::integer)	:= r_c02_w.nr_seq_pagador;
					current_setting('pls_reaj_cobranca_retro_pck.tb_dt_referencia_w')::pls_util_cta_pck.t_date_table(current_setting('pls_reaj_cobranca_retro_pck.nr_indice_w')::integer)		:= dt_parcela_w;
					current_setting('pls_reaj_cobranca_retro_pck.tb_vl_lancamento_w')::pls_util_cta_pck.t_number_table(current_setting('pls_reaj_cobranca_retro_pck.nr_indice_w')::integer)		:= vl_parcela_w;
					current_setting('pls_reaj_cobranca_retro_pck.tb_nr_seq_reaj_retro_w')::pls_util_cta_pck.t_number_table(current_setting('pls_reaj_cobranca_retro_pck.nr_indice_w')::integer)	:= nr_seq_lote_retro_p;
					current_setting('pls_reaj_cobranca_retro_pck.tb_dt_inicio_cobertura_w')::pls_util_cta_pck.t_date_table(current_setting('pls_reaj_cobranca_retro_pck.nr_indice_w')::integer)	:= r_c02_w.dt_inicio_cobertura;
					current_setting('pls_reaj_cobranca_retro_pck.tb_dt_fim_cobertura_w')::pls_util_cta_pck.t_date_table(current_setting('pls_reaj_cobranca_retro_pck.nr_indice_w')::integer)	:= r_c02_w.dt_fim_cobertura;
					current_setting('pls_reaj_cobranca_retro_pck.tb_nr_seq_vinculo_sca_w')::pls_util_cta_pck.t_number_table(current_setting('pls_reaj_cobranca_retro_pck.nr_indice_w')::integer)	:= r_c02_w.nr_seq_vinculo_sca;
					current_setting('pls_reaj_cobranca_retro_pck.tb_nr_parcela_sca_w')::pls_util_cta_pck.t_number_table(current_setting('pls_reaj_cobranca_retro_pck.nr_indice_w')::integer)	:= r_c02_w.nr_parcela_sca;
					current_setting('pls_reaj_cobranca_retro_pck.tb_ds_observacao_w')::pls_util_cta_pck.t_varchar2_table_255(current_setting('pls_reaj_cobranca_retro_pck.nr_indice_w')::integer)		:= wheb_mensagem_pck.get_Texto(1137771) || ' retroativa do ' || wheb_mensagem_pck.get_texto(1137772) || ' ' || to_char(r_c02_w.dt_mesano_referencia,'mm/yyyy') ||
											', referente ao reajuste de ' || current_setting('pls_reaj_cobranca_retro_pck.tx_reajuste_w')::pls_reajuste.tx_reajuste%type || '% de ' || to_char(current_setting('pls_reaj_cobranca_retro_pck.dt_reajuste_w')::pls_reajuste.dt_reajuste%type,'mm/yyyy') || ds_mensagem_parcela_w;
					current_setting('pls_reaj_cobranca_retro_pck.tb_nr_seq_segurado_preco_w')::pls_util_cta_pck.t_number_table(current_setting('pls_reaj_cobranca_retro_pck.nr_indice_w')::integer)	:= null;
					current_setting('pls_reaj_cobranca_retro_pck.tb_nr_seq_mensalidade_seg_w')::pls_util_cta_pck.t_number_table(current_setting('pls_reaj_cobranca_retro_pck.nr_indice_w')::integer) := null;
					current_setting('pls_reaj_cobranca_retro_pck.tb_qt_valor_apropriacao_w')::pls_util_cta_pck.t_number_table(current_setting('pls_reaj_cobranca_retro_pck.nr_indice_w')::integer)	:= 0;
					current_setting('pls_reaj_cobranca_retro_pck.tb_ie_recomposicao_w')::pls_util_cta_pck.t_varchar2_table_1(current_setting('pls_reaj_cobranca_retro_pck.nr_indice_w')::integer)	:= ie_recomposicao_p;
					
					if (current_setting('pls_reaj_cobranca_retro_pck.nr_indice_w')::integer >= pls_util_pck.qt_registro_transacao_w) then
						CALL pls_reaj_cobranca_retro_pck.insert_lancamentos(cd_estabelecimento_p,nm_usuario_p);
					else
						PERFORM set_config('pls_reaj_cobranca_retro_pck.nr_indice_w', current_setting('pls_reaj_cobranca_retro_pck.nr_indice_w')::integer + 1, false);
					end if;
					end;
				end loop;
			end if;
		end if;
		end;
	end loop; --C02
	
	end;
end loop; --C01

CALL pls_reaj_cobranca_retro_pck.insert_lancamentos(cd_estabelecimento_p,nm_usuario_p);

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_reaj_cobranca_retro_pck.gerar_lancamentos_sca ( nr_seq_reajuste_p pls_reajuste.nr_sequencia%type, nr_seq_lote_retro_p pls_reajuste_cobr_retro.nr_sequencia%type, dt_reajuste_p pls_reajuste_cobr_retro.dt_referencia_reajuste%type, dt_mensalidade_p pls_reajuste_cobr_retro.dt_referencia_mensalidade%type, qt_parcela_p bigint, ie_recomposicao_p text, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;
