-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE apap_dinamico_pck.atualiza_destaque (nr_seq_valor_p bigint, nr_atendimento_p bigint, nr_seq_destaque_p bigint, ie_acao_p text) AS $body$
DECLARE

	current_setting('apap_dinamico_pck.nm_usuario_w')::usuario.nm_usuario%type		usuario.nm_usuario%type	:=	wheb_usuario_pck.get_nm_usuario;
	dt_registro_w		timestamp;
	nm_atributo_w		linked_data_atributo.nm_atributo_linked%type;
	nm_tabela_w			linked_data_atributo.nm_tabela%type;
	current_setting('apap_dinamico_pck.nr_seq_documento_w')::documento.nr_sequencia%type	documento.nr_sequencia%type;
	ds_result_desc_w	w_apap_pac_registro.ds_result_desc%type;
	ds_informacao_w		w_apap_pac_informacao.ds_informacao%type;
	
BEGIN
	if (nr_seq_valor_p IS NOT NULL AND nr_seq_valor_p::text <> '') then
		select	max(e.dt_registro),
				max(d.nm_atributo_unico),
				max(d.nm_tabela),
				max(b.nr_seq_documento),
				max(e.ds_result_desc),
				max(d.ds_informacao)
		into STRICT	dt_registro_w,
				nm_atributo_w,
				nm_tabela_w,
				current_setting('apap_dinamico_pck.nr_seq_documento_w')::documento.nr_sequencia%type,
				ds_result_desc_w,
				ds_informacao_w
		from    w_apap_pac b,
				w_apap_pac_grupo c,
				w_apap_pac_informacao d,
				w_apap_pac_registro e
		where	b.nr_sequencia      = c.nr_seq_mod_apap
		and     c.nr_sequencia      = d.nr_seq_apap_grupo
		and     d.nr_sequencia      = e.nr_seq_apap_inf
		and		e.nr_sequencia		= nr_seq_valor_p;	
		if (dt_registro_w IS NOT NULL AND dt_registro_w::text <> '') then
			if (ie_acao_p = 'I') then
				update  w_apap_pac_registro_hist
				set		ie_situacao       	= 'I'
				where  	nr_seq_documento  	= current_setting('apap_dinamico_pck.nr_seq_documento_w')::documento.nr_sequencia%type
				and    	nm_tabela         	= nm_tabela_w
				and    	nm_atributo       	= nm_atributo_w
				and    	dt_apap           	= dt_registro_w
				and		nr_atendimento	  	= nr_atendimento_p
				and		coalesce(ie_tipo,'C')	= 'D';
				
				insert   into  w_apap_pac_registro_hist( nr_sequencia,
														  dt_atualizacao,
														  nm_usuario,
														  dt_atualizacao_nrec,
														  nm_usuario_nrec,
														  nr_seq_documento,
														  nm_atributo,
														  nm_tabela,
														  ds_comentario,
														  dt_apap,
														  ie_situacao,
														  nr_atendimento,
														  ds_result_desc,
														  nr_seq_destaque,
														  ie_tipo)
				values (nextval('w_apap_pac_registro_hist_seq'),
														  clock_timestamp(),
														  current_setting('apap_dinamico_pck.nm_usuario_w')::usuario.nm_usuario%type,
														  clock_timestamp(),
														  current_setting('apap_dinamico_pck.nm_usuario_w')::usuario.nm_usuario%type,
														  current_setting('apap_dinamico_pck.nr_seq_documento_w')::documento.nr_sequencia%type,
														  nm_atributo_w,
														  nm_tabela_w,
														  null,
														  dt_registro_w,
														  'A',
														  nr_atendimento_p,
														  ds_informacao_w||': '||ds_result_desc_w,
														  nr_seq_destaque_p,
														  'D');
			else
				delete   from  w_apap_pac_registro_hist
				where    nr_seq_documento  	= current_setting('apap_dinamico_pck.nr_seq_documento_w')::documento.nr_sequencia%type
				and      nm_tabela         	= nm_tabela_w
				and      nm_atributo       	= nm_atributo_w
				and      dt_apap           	= dt_registro_w
				and      nr_atendimento	   	= nr_atendimento_p
				and		 coalesce(ie_tipo,'C')	= 'D';
			end if;
			commit;
		end if;	
	end if;
	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE apap_dinamico_pck.atualiza_destaque (nr_seq_valor_p bigint, nr_atendimento_p bigint, nr_seq_destaque_p bigint, ie_acao_p text) FROM PUBLIC;
