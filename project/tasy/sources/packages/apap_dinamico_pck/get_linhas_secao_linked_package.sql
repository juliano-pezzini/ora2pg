-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION apap_dinamico_pck.get_linhas_secao_linked (nr_atendimento_p bigint,nm_usuario_p text,nr_seq_documento_p bigint,nr_seq_linked_data_p bigint) RETURNS SETOF LINHAS_PAC_T AS $body$
DECLARE

linhas_pac_r_w 			linhas_pac_r;
ds_valores_w   			tabela_visao_atributo.ds_valores%type;
vl_minima_w    			double precision;
vl_maxima_w    			double precision;
vl_media_w     			double precision;
qt_casas_w				smallint;
cd_estabelecimento_w	estabelecimento.cd_estabelecimento%type	:= wheb_usuario_pck.get_cd_estabelecimento;
cd_perfil_w         	perfil.cd_perfil%type					:= wheb_usuario_pck.get_cd_perfil;
cd_funcao_w				funcao.cd_funcao%type					:= wheb_usuario_pck.get_cd_funcao;
ie_doc_read_only_w		varchar(1);

c_linhas CURSOR FOR
	SELECT  distinct d.nr_seq_linked_data,
		  c.nr_sequencia nr_seq_grupo,
		  a.nr_sequencia nr_seq_modelo,
		  c.ds_grupo_informacao,
		  d.nr_sequencia nr_seq_linha,
		  d.ds_informacao,
		  d.nm_atributo,
		  d.nr_seq_apresentacao,
		  g.ie_componente ie_componente,
		  g.cd_dominio cd_dominio,
		  g.ds_valores ds_valores,
		  d.nr_escala_minima,
		  d.nr_escala_maxima,
		  d.ie_plot_style,
		  d.ie_symbol,
		  d.ds_color,
		  d.nm_tabela,
		  upper(substr(obter_tipo_atributo(g.nr_sequencia,g.nm_atributo),1,15)) ie_tipo_atributo,
		  coalesce(CASE WHEN y.ie_read_only='S' THEN 'S'  ELSE g.ie_readonly END ,'N') ie_readonly,
		  g.ds_mascara,
		  --decode(Obter_Regra_Atributo2(d.nm_tabela,g.nm_atributo,g.nr_sequencia,'VLN',cd_estabelecimento_w,cd_perfil_w,cd_funcao_w,nm_usuario_p),'S',null,
		  --nvl(Obter_Regra_Atributo2(d.nm_tabela,g.nm_atributo,g.nr_sequencia,'VLD',cd_estabelecimento_w,cd_perfil_w,cd_funcao_w,nm_usuario_p),g.vl_padrao)) vl_padrao,
		  apap_dinamico_pck.get_valor_default(d.nm_tabela,g.nm_atributo,g.nr_sequencia,d.ie_aparelho_pa,null,null,g.vl_padrao) vl_padrao,
		  d.nr_seq_apresentacao_sec,
		  coalesce(f.CD_EXP_INFORMACAO,488043) cd_exp_label,
		  g.cd_exp_valores,
		  b.nr_atendimento,
		  d.ds_unid_med,
		  d.nm_atributo_tabela,
		  f.nm_atributo_linked,
		  d.nm_atributo_unico,
		  clock_timestamp() dt_alta,
		  d.nr_seq_superior,
		  d.ie_trend,
		  c.ie_tipo,
		  d.nr_width,
		  e.qt_decimais,
		  e.qt_tamanho,
		  b.cd_pessoa_fisica,
		  d.nr_seq_exame,
		  y.ie_grupo,
		  d.ds_tooltip,
		  null nr_seq_temp_conteudo,
		  c.cd_funcao_add_new,
		  c.nr_seq_item_pront,
		  c.ie_tipo_acesso,
		  d.ds_formato_composto,
		  apap_dinamico_pck.get_if_tree(d.nr_sequencia) ie_tree,
		  d.ds_icone_inter_medic
  from    documento a,
		  w_apap_pac b,
		  w_apap_pac_grupo c,
		  w_apap_pac_informacao d,
		  linked_data_atributo f,
		  tabela_visao_atributo g,
		  tabela_atributo e,
		  linked_data_ativacao y
  where   a.nr_sequencia        	= b.nr_seq_documento
  and     b.nr_sequencia        	= c.nr_seq_mod_apap
  and     c.nr_sequencia        	= d.nr_seq_apap_grupo
  and     d.nr_seq_linked_data  	= f.nr_seq_linked_data
  and     d.nm_atributo_linked  	= f.nm_atributo_linked
  and     d.nr_seq_visao        	= g.nr_sequencia
  and     g.nm_atributo         	= d.nm_atributo_tabela
  and     d.nm_tabela				= e.nm_tabela
  and     d.nm_atributo_tabela	= e.nm_atributo
  and     f.nr_seq_linked_data	= y.nr_seq_linked_data
  and     c.ie_padrao_visivel   	= 'S'
  and     d.ie_visivel          	in ('S','F')
  and     c.nr_seq_linked_data  	= nr_seq_linked_data_p
  and     b.nr_atendimento		= nr_atendimento_p
  and     b.nm_usuario			= nm_usuario_p
  and     a.nr_sequencia			= nr_seq_documento_p

union

  SELECT  distinct d.nr_seq_linked_data,
		  c.nr_sequencia nr_seq_grupo,
		  a.nr_sequencia nr_seq_modelo,
		  c.ds_grupo_informacao,
		  d.nr_sequencia nr_seq_linha,
		  d.ds_informacao,
		  d.nm_atributo,
		  d.nr_seq_apresentacao,
		  'de' ie_componente,
		  null cd_dominio,
		  null ds_valores,
		  d.nr_escala_minima,
		  d.nr_escala_maxima,
		  d.ie_plot_style,
		  d.ie_symbol,
		  d.ds_color,
		  null nm_tabela,
		  'VARCHAR2' ie_tipo_atributo,
		  'S' ie_readonly,
		  null ds_mascara,
		  null vl_padrao,
		  d.nr_seq_apresentacao_sec,
		  coalesce(f.CD_EXP_INFORMACAO,488043) cd_exp_label,
		  null cd_exp_valores,
		  b.nr_atendimento,
		  d.ds_unid_med,
		  d.nm_atributo_tabela,
		  f.nm_atributo_linked,
		  d.nm_atributo_unico,
		  clock_timestamp() dt_alta,
		  d.nr_seq_superior,
		  d.ie_trend,
		  c.ie_tipo,
		  d.nr_width,
		  null qt_decimais,
		  null qt_tamanho,
		  b.cd_pessoa_fisica,
		  d.nr_seq_exame,
		  y.ie_grupo,
		  d.ds_tooltip,
		  null nr_seq_temp_conteudo,
		  c.cd_funcao_add_new,
		  c.nr_seq_item_pront,
		  c.ie_tipo_acesso,
		  d.ds_formato_composto,
		  apap_dinamico_pck.get_if_tree(d.nr_sequencia) ie_tree,
      d.ds_icone_inter_medic
  from    documento a,
		  w_apap_pac b,
		  w_apap_pac_grupo c,
		  w_apap_pac_informacao d,
		  linked_data_atributo f,
		  linked_data_ativacao y
  where   a.nr_sequencia        = b.nr_seq_documento
  and     b.nr_sequencia        = c.nr_seq_mod_apap
  and     c.nr_sequencia        = d.nr_seq_apap_grupo
  and     d.nr_seq_linked_data  = f.nr_seq_linked_data
  and     d.nm_atributo_linked  = f.nm_atributo_linked
  and     f.nr_seq_linked_data  = y.nr_seq_linked_data
  and     coalesce(d.nm_atributo_tabela::text, '') = ''
  and     c.ie_padrao_visivel   = 'S'
  and     d.ie_visivel          in ('S','F')
  and     c.nr_seq_linked_data  	= nr_seq_linked_data_p
  and     b.nr_atendimento		= nr_atendimento_p
  and     b.nm_usuario			= nm_usuario_p
  and     a.nr_sequencia			= nr_seq_documento_p
  
union

  select  distinct d.nr_seq_linked_data,
		  c.nr_sequencia nr_seq_grupo,
		  b.nr_seq_documento nr_seq_modelo,
		  c.ds_grupo_informacao,
		  d.nr_sequencia nr_seq_linha,
		  d.ds_informacao,
		  d.nm_atributo,
		  d.nr_seq_apresentacao,
		  case	g.ds_openehr
					when  'DV_TIME' then 'dtp'
					when  'DV_DATE' then 'dtp'
					when  'DV_DATE_TIME' then 'dtp'
					else	f.ie_componente
		  end 	ie_componente,
		  null cd_dominio,
		  coalesce(e.DS_SQL,f.DS_SQL) ds_valores,
		  d.nr_escala_minima,
		  d.nr_escala_maxima,
		  d.ie_plot_style,
		  d.ie_symbol,
		  d.ds_color,
		  d.nm_tabela,
		  case	upper(g.ds_openehr)
			  when  'DV_TIME' then 'DATE'
			  when  'DV_DATE' then 'DATE'
			  when  'DV_DATE_TIME' then 'DATE'
			  when  'DV_BOOLEAN' then 'VARCHAR2'
			  when  'DV_TEXT' then 'VARCHAR2'
			  when  'DV_COUNT' then 'NUMBER'
			  when  'DV_QUANTITY' then 'NUMBER'
		  end 	ie_tipo_atributo,
		  e.ie_readonly,
		  e.ds_mascara,
		  apap_dinamico_pck.get_valor_default(null,null,null,null,e.nr_seq_template,e.nr_sequencia,e.vl_padrao) vl_padrao,
		  --e.vl_padrao,
		  d.nr_seq_apresentacao_sec,
		  null cd_exp_label,
		  null cd_exp_valores,
		  b.nr_atendimento,
		  d.ds_unid_med,
		  d.nm_atributo_tabela,
		  d.nm_atributo_linked,
		  d.nm_atributo_unico,
		  clock_timestamp() dt_alta,
		  d.nr_seq_superior,
		  d.ie_trend,
		  c.ie_tipo,
		  d.nr_width,
		  case	upper(g.ds_openehr)
			  when  'DV_TIME' then null
			  when  'DV_DATE' then null
			  when  'DV_DATE_TIME' then null
			  when  'DV_BOOLEAN' then 0
			  when  'DV_TEXT' then null
			  when  'DV_COUNT' then 4
			  when  'DV_QUANTITY' then 4
		  end 	qt_decimais,
		  case	upper(g.ds_openehr)
			  when  'DV_TIME' then null
			  when  'DV_DATE' then null
			  when  'DV_DATE_TIME' then null
			  when  'DV_BOOLEAN' then 1
			  when  'DV_TEXT' then 255
			  when  'DV_COUNT' then 15
			  when  'DV_QUANTITY' then 15
		  end qt_tamanho,
		  b.cd_pessoa_fisica,
		  null nr_seq_exame,
		  null ie_grupo,
		  d.ds_tooltip,
		  d.nr_seq_temp_conteudo,
		  c.cd_funcao_add_new,
		  c.nr_seq_item_pront,
		  c.ie_tipo_acesso,
		  d.ds_formato_composto,
		  apap_dinamico_pck.get_if_tree(d.nr_sequencia) ie_tree,
      d.ds_icone_inter_medic
  from    w_apap_pac b,
		  w_apap_pac_grupo c,
		  w_apap_pac_informacao d,
		  ehr_template_conteudo e,
		  ehr_elemento f,
		  ehr_tipo_dado g
  where   b.nr_sequencia = c.nr_seq_mod_apap
  and     c.nr_sequencia = d.nr_seq_apap_grupo
  and     d.nr_seq_temp_conteudo = e.nr_sequencia
  and     e.nr_seq_elemento = f.nr_sequencia
  and     f.nr_seq_tipo_dado = g.nr_sequencia
  and     c.ie_padrao_visivel = 'S'
  and     d.ie_visivel in ('S','F')
  and     c.nr_seq_linked_data = nr_seq_linked_data_p
  and     b.nr_atendimento = nr_atendimento_p
  and     b.nm_usuario = nm_usuario_p
  and     b.nr_seq_documento = nr_seq_documento_p
  and     (d.nr_seq_temp_conteudo IS NOT NULL AND d.nr_seq_temp_conteudo::text <> '')
  
union

  select  distinct d.nr_seq_linked_data,
		  c.nr_sequencia nr_seq_grupo,
		  a.nr_sequencia nr_seq_modelo,
		  c.ds_grupo_informacao,
		  d.nr_sequencia nr_seq_linha,
		  d.ds_informacao,
		  d.nm_atributo,
		  d.nr_seq_apresentacao,
		  'de' ie_componente,
		  null cd_dominio,
		  null ds_valores,
		  d.nr_escala_minima,
		  d.nr_escala_maxima,
		  d.ie_plot_style,
		  d.ie_symbol,
		  d.ds_color,
		  d.nm_tabela,
		  'VARCHAR2' ie_tipo_atributo,
		  e.ie_readonly,
		  e.ds_mascara,
		  e.vl_padrao,
		  d.nr_seq_apresentacao_sec,
		  null cd_exp_label,
		  null cd_exp_valores,
		  b.nr_atendimento,
		  d.ds_unid_med,
		  d.nm_atributo_tabela,
		  d.nm_atributo_linked,
		  d.nm_atributo_unico,
		  clock_timestamp() dt_alta,
		  d.nr_seq_superior,
		  d.ie_trend,
		  c.ie_tipo,
		  d.nr_width,
		  null qt_decimais,
		  null qt_tamanho,
		  b.cd_pessoa_fisica,
		  null nr_seq_exame,
		  null ie_grupo,
		  d.ds_tooltip,
		  d.nr_seq_temp_conteudo,
		  c.cd_funcao_add_new,
		  c.nr_seq_item_pront,
		  c.ie_tipo_acesso,
		  d.ds_formato_composto,
		  apap_dinamico_pck.get_if_tree(d.nr_sequencia) ie_tree,
      d.ds_icone_inter_medic
  from    documento a,
		  w_apap_pac b,
		  w_apap_pac_grupo c,
		  w_apap_pac_informacao d,
		  ehr_template_conteudo e
  where   a.nr_sequencia = b.nr_seq_documento
  and     b.nr_sequencia = c.nr_seq_mod_apap
  and     c.nr_sequencia = d.nr_seq_apap_grupo
  and     d.nr_seq_temp_conteudo = e.nr_sequencia
  and     c.ie_padrao_visivel = 'S'
  and     d.ie_visivel in ('S','F')
  and     c.nr_seq_linked_data = nr_seq_linked_data_p
  and     b.nr_atendimento = nr_atendimento_p
  and     b.nm_usuario = nm_usuario_p
  and     a.nr_sequencia = nr_seq_documento_p
  and     (d.nr_seq_temp_conteudo IS NOT NULL AND d.nr_seq_temp_conteudo::text <> '')
  and	  e.nr_seq_elem_visual = 4;

BEGIN
  <<read_linhas>>
  for r_linhas in c_linhas
  loop
	qt_casas_w := 0;

	if (r_linhas.ie_grupo <> 'ES') and (r_linhas.ie_grupo <> 'BH') and (r_linhas.nr_seq_linked_data not in (399,426)) then
	  begin
		select   round(min(vl_resultado),qt_casas_w)
		into STRICT     vl_minima_w
		from     w_apap_pac_registro
		where    (vl_resultado IS NOT NULL AND vl_resultado::text <> '')
		and      nr_seq_apap_inf = r_linhas.nr_seq_linha
		and      vl_resultado <> 0
		and		 coalesce(ie_situacao,'A') = 'A';
	  exception
		when others then
		  vl_minima_w := 0;
	  end;

	  begin
		select   round(max(vl_resultado),qt_casas_w)
		into STRICT     vl_maxima_w
		from     w_apap_pac_registro
		where    (vl_resultado IS NOT NULL AND vl_resultado::text <> '')
		and      nr_seq_apap_inf = r_linhas.nr_seq_linha
		and      vl_resultado <> 0
		and		 coalesce(ie_situacao,'A') = 'A';
	  exception
		when others then
		  vl_maxima_w := 0;
	  end;

	  begin
		select   round(sum(vl_resultado)/count(nr_seq_apap_inf),qt_casas_w)
		into STRICT     vl_media_w
		from     w_apap_pac_registro
		where    (vl_resultado IS NOT NULL AND vl_resultado::text <> '')
		and      nr_seq_apap_inf = r_linhas.nr_seq_linha
		and      vl_resultado   <> 0
		and		 coalesce(ie_situacao,'A') = 'A';
	  exception
		when others then
		  vl_media_w := 0;
	  end;
	end if;

	ds_valores_w := r_linhas.ds_valores;
	if (upper(r_linhas.ie_componente) = 'LCB') and (coalesce(r_linhas.cd_dominio::text, '') = '') and (coalesce(r_linhas.ds_valores::text, '') = '') then
	  select   max(ds_sql_p)
	  into STRICT     ds_valores_w
	  from     table(Obter_Atributo_Lookup2(r_linhas.nm_tabela,r_linhas.nm_atributo_tabela));
	end if;
	if ((r_linhas.ie_componente = 'lcb') and (position(':NR_ATENDIMENTO' in upper(ds_valores_w)) > 0)) then
	  ds_valores_w := replace(upper(ds_valores_w),':NR_ATENDIMENTO',to_char(r_linhas.nr_atendimento));
	end if;
	if ((r_linhas.ie_componente = 'lcb') and (position(':CD_EMPRESA' in upper(ds_valores_w)) > 0)) then
	  ds_valores_w := replace(upper(ds_valores_w),':CD_EMPRESA','OBTER_EMPRESA_ESTAB(wheb_usuario_pck.get_cd_estabelecimento)');
	end if;
	if ((r_linhas.ie_componente = 'lcb') and (position(':CD_ESCALA_DOR' in upper(ds_valores_w)) > 0)) then
	  ds_valores_w := replace(upper(ds_valores_w),':CD_ESCALA_DOR',Concat('''', 'FLOWSHEET')||Concat('''',''));
	end if;
	if ((r_linhas.ie_componente = 'lcb') and (position(':CD_PACIENTE' in upper(ds_valores_w)) > 0)) then
	ds_valores_w := replace(upper(ds_valores_w),':CD_PACIENTE',r_linhas.cd_pessoa_fisica);
	end if;
	if ((r_linhas.ie_componente = 'lcb') and (position(':NR_SEQ_EXAME' in upper(ds_valores_w)) > 0)) then
	  ds_valores_w := replace(upper(ds_valores_w),':NR_SEQ_EXAME',r_linhas.nr_seq_exame);
	end if;

	linhas_pac_r_w.nr_seq_linha         := r_linhas.nr_seq_linha;
	linhas_pac_r_w.nr_seq_linked_data   := r_linhas.nr_seq_linked_data;
	linhas_pac_r_w.ds_grupo_informacao  := r_linhas.ds_grupo_informacao;
	linhas_pac_r_w.nr_seq_apresentacao  := r_linhas.nr_seq_apresentacao;
	linhas_pac_r_w.ds_informacao        := r_linhas.ds_informacao;
	linhas_pac_r_w.ds_tooltip           := coalesce(r_linhas.ds_tooltip,r_linhas.ds_informacao);																				
	linhas_pac_r_w.nm_atributo          := r_linhas.nm_atributo;
	linhas_pac_r_w.nm_tabela            := r_linhas.nm_tabela;
	linhas_pac_r_w.nm_atributo_tabela   := r_linhas.nm_atributo_tabela;
	linhas_pac_r_w.ie_componente        := r_linhas.ie_componente;
	linhas_pac_r_w.cd_dominio           := r_linhas.cd_dominio;
	linhas_pac_r_w.ds_valores           := ds_valores_w;
	linhas_pac_r_w.nr_escala_minima     := r_linhas.nr_escala_minima;
	linhas_pac_r_w.nr_escala_maxima     := r_linhas.nr_escala_maxima;
	linhas_pac_r_w.ie_plot_style        := r_linhas.ie_plot_style;
	linhas_pac_r_w.ie_symbol            := r_linhas.ie_symbol;
	linhas_pac_r_w.ds_color             := r_linhas.ds_color;
	linhas_pac_r_w.ie_tipo_atributo     := r_linhas.ie_tipo_atributo;
	linhas_pac_r_w.ie_readonly          := coalesce(ie_doc_read_only_w,r_linhas.ie_readonly);
	linhas_pac_r_w.ds_mascara           := r_linhas.ds_mascara;
	linhas_pac_r_w.vl_padrao            := r_linhas.vl_padrao;
	linhas_pac_r_w.vl_minima            := vl_minima_w;
	linhas_pac_r_w.vl_maxima            := vl_maxima_w;
	linhas_pac_r_w.vl_media             := vl_media_w;
	linhas_pac_r_w.nr_ordem_composto    := r_linhas.nr_seq_apresentacao_sec;
	linhas_pac_r_w.cd_exp_label         := r_linhas.cd_exp_label;
	linhas_pac_r_w.cd_exp_valores       := r_linhas.cd_exp_valores;
	linhas_pac_r_w.ds_unid_med          := r_linhas.ds_unid_med;
	linhas_pac_r_w.nr_seq_grupo         := r_linhas.nr_seq_grupo;
	linhas_pac_r_w.nr_seq_modelo        := r_linhas.nr_seq_modelo;
	linhas_pac_r_w.nm_atributo_linked   := r_linhas.nm_atributo_linked;
	linhas_pac_r_w.nm_atributo_unico    := r_linhas.nm_atributo_unico;
	linhas_pac_r_w.dt_alta              := r_linhas.dt_alta;
	linhas_pac_r_w.nr_seq_superior      := r_linhas.nr_seq_superior;
	linhas_pac_r_w.ie_trend      		:= r_linhas.ie_trend;
	linhas_pac_r_w.ie_tipo      		:= r_linhas.ie_tipo;
	linhas_pac_r_w.nr_width      		:= r_linhas.nr_width;
	linhas_pac_r_w.qt_decimais          := r_linhas.qt_decimais;
	linhas_pac_r_w.qt_tamanho           := r_linhas.qt_tamanho;
	linhas_pac_r_w.cd_funcao_add_new	:= r_linhas.cd_funcao_add_new;
	linhas_pac_r_w.nr_seq_item_pront	:= r_linhas.nr_seq_item_pront;
	linhas_pac_r_w.ie_tipo_acesso		:= r_linhas.ie_tipo_acesso;
	linhas_pac_r_w.ds_formato_composto	:= r_linhas.ds_formato_composto;
  linhas_pac_r_w.ds_icone_inter_medic := r_linhas.ds_icone_inter_medic;

	if (r_linhas.ie_componente <> 'de') then
	  linhas_pac_r_w.vl_minima            := null;
	  linhas_pac_r_w.vl_maxima            := null;
	  linhas_pac_r_w.vl_media             := null;
	end if;

	if (r_linhas.ie_tipo_atributo = 'FUNCTION') then
	  linhas_pac_r_w.ds_valores           := null;
	end if;
	if (r_linhas.ie_readonly = 'N') then
	  if (r_linhas.ie_tipo_atributo = 'FUNCTION') or (r_linhas.ie_tree = 'S') then
		linhas_pac_r_w.ie_readonly := 'S';
	  end if;
	end if;

	RETURN NEXT linhas_pac_r_w;
  end loop read_linhas;

  return;
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION apap_dinamico_pck.get_linhas_secao_linked (nr_atendimento_p bigint,nm_usuario_p text,nr_seq_documento_p bigint,nr_seq_linked_data_p bigint) FROM PUBLIC;
