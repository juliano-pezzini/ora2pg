-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE apap_dinamico_pck.executa_transacao () AS $body$
DECLARE

  nr_seq_doc_apap_w     w_apap_pac.nr_sequencia%type;
  nr_seq_apap_grupo_w   w_apap_pac_grupo.nr_sequencia%type;
  nr_seq_apap_linha_w   w_apap_pac_informacao.nr_sequencia%type;
  nr_seq_apap_linha_ww  w_apap_pac_informacao.nr_sequencia%type;
  dt_atualizacao_w      timestamp;
  dt_liberacao_w        timestamp;
  ds_lista_tabela_w		varchar(4000);
  ds_lista_template_w	varchar(4000);

  c_apap CURSOR FOR
	SELECT  cd_pessoa_fisica,
			nr_atendimento,
			nr_seq_documento,
			nr_sequencia
	from    table(get_apap);

  c_grupo_apap CURSOR(nr_sequencia_p   bigint) FOR
	SELECT  nr_sequencia,
			ds_grupo_informacao,
			nr_seq_apresentacao,
			ie_padrao_visivel,
			nr_escala_minima_esq,
			nr_escala_maxima_esq,
			nr_seq_linked_data,
			nr_seq_documento_secao,
			ie_tipo,
			nr_seq_template,
			cd_funcao_add_new,
			nr_seq_item_pront,
			ie_tipo_acesso
	from    table(get_grupo_apap)
	where   nr_seq_mod_apap = nr_sequencia_p;

  c_linha_apap CURSOR(	nr_seq_superior_p	 bigint) FOR
	SELECT  a.ds_informacao,
			b.nr_sequencia nr_seq_apap_grupo,
			a.nm_atributo_apap,
			a.nr_seq_apresentacao,
			coalesce(a.ds_unid_med,a.ds_unid_med_col) ds_unid_med,
			a.nm_tabela,
			a.nm_atributo_tabela,
			a.nm_atributo_linked,
			a.ie_visivel,
			a.nr_escala_minima,
			a.nr_escala_maxima,
			a.ie_plot_style,
			a.ie_symbol,
			a.ds_color,
			a.nr_ordem_composto,
			a.nr_seq_doc_subsecao,
			a.nr_seq_linked_data,
			a.nr_seq_superior,
			a.nr_sequencia nr_seq_linha_v,
			a.nr_seq_visao,
			a.ie_read_only,
			a.ie_trend,
			a.nr_width,
			a.nr_seq_exame,
			a.nr_seq_intervention,
			a.nr_seq_cpoe,
			a.ie_line,
			a.nr_size,
			a.nr_valor_minimo,
			a.nr_valor_maximo,
			a.ds_symbol_color_exceeded,
			a.ie_reference_line,
			a.nr_reference_line,
			a.ie_tipo_informacao,
			(SELECT x.nr_sequencia
			from    w_apap_pac_informacao x
			where   x.nr_seq_apap_grupo = b.nr_sequencia
			and     x.nm_atributo = a.nm_atributo_apap) nr_seq_apap_pac_inf,
			(select coalesce(max('S'), 'N')
			from    w_apap_pac_informacao x
			where   x.nr_seq_apap_grupo = b.nr_sequencia
			and     x.nm_atributo = a.nm_atributo_apap) ie_existe,
			a.nr_seq_atrib_cliente,
			a.nr_seq_temp_conteudo,
			a.ie_aparelho_pa,
			a.ds_tooltip,
			a.nr_seq_cp_indicator,
			a.nr_escala_intervalo,
			a.ie_mark_exceeded_value_chart,
			a.ie_plot_axis,
			a.ie_grafico,
			a.ds_lookup,
			a.ds_formato_composto,
			a.ds_icone_inter_medic,
			a.nm_atributo_unico
	from    table(get_linha_apap) a,
			w_apap_pac_grupo b,
			w_apap_pac c
	where   a.nr_seq_documento_secao = b.nr_seq_documento_secao
	and     b.nr_seq_mod_apap = c.nr_sequencia
	and     c.nr_atendimento = current_setting('apap_dinamico_pck.nr_atendimento_w')::atendimento_paciente.nr_atendimento%type
	and     c.nm_usuario = current_setting('apap_dinamico_pck.nm_usuario_w')::usuario.nm_usuario%type
	and     c.nr_seq_documento = current_setting('apap_dinamico_pck.nr_seq_documento_w')::documento.nr_sequencia%type
	and     coalesce(a.nr_seq_superior,0) = coalesce(nr_seq_superior_p,0);

  c_linha_apap_c CURSOR(	nr_seq_superior_p	 bigint) FOR
	SELECT  a.ds_informacao,
			b.nr_sequencia nr_seq_apap_grupo,
			a.nm_atributo_apap,
			a.nr_seq_apresentacao,
			coalesce(a.ds_unid_med,a.ds_unid_med_col) ds_unid_med,
			a.nm_tabela,
			a.nm_atributo_tabela,
			a.nm_atributo_linked,
			a.ie_visivel,
			a.nr_escala_minima,
			a.nr_escala_maxima,
			a.ie_plot_style,
			a.ie_symbol,
			a.ds_color,
			a.nr_ordem_composto,
			a.nr_seq_doc_subsecao,
			a.nr_seq_linked_data,
			a.nr_seq_superior,
			a.nr_sequencia nr_seq_linha_v,
			a.nr_seq_visao,
			a.ie_read_only,
			a.ie_trend,
			a.nr_width,
			a.nr_seq_exame,
			a.nr_seq_cpoe,
			a.ie_line,
			a.nr_size,
			a.nr_valor_minimo,
			a.nr_valor_maximo,
			a.ds_symbol_color_exceeded,
			a.ie_reference_line,
			a.nr_reference_line,
			a.ie_tipo_informacao,
			a.nr_seq_atrib_cliente,
			a.nr_seq_temp_conteudo,
			a.ie_aparelho_pa,
			a.ds_tooltip,
			a.nr_seq_intervention,
			a.nr_seq_cp_indicator,
			a.nr_escala_intervalo,
			a.ie_mark_exceeded_value_chart,
			a.ie_plot_axis,
			a.ie_grafico,
			a.ds_lookup,
			a.ds_formato_composto,
			a.ds_icone_inter_medic,
			a.nm_atributo_unico
	from    table(get_linha_apap) a,
			w_apap_pac_grupo b,
			w_apap_pac c
	where   a.nr_seq_documento_secao = b.nr_seq_documento_secao
	and     b.nr_seq_mod_apap = c.nr_sequencia
	and     c.nr_atendimento = current_setting('apap_dinamico_pck.nr_atendimento_w')::atendimento_paciente.nr_atendimento%type
	and     c.nm_usuario = current_setting('apap_dinamico_pck.nm_usuario_w')::usuario.nm_usuario%type
	and     c.nr_seq_documento = current_setting('apap_dinamico_pck.nr_seq_documento_w')::documento.nr_sequencia%type
	and     not exists (SELECT  1
						from    w_apap_pac_informacao x
						where   x.nr_seq_apap_grupo = b.nr_sequencia
						and     x.nm_atributo = a.nm_atributo_apap)
	and		coalesce(a.nr_seq_superior,0) = coalesce(nr_seq_superior_p,0);
BEGIN
  begin
	select  max(dt_liberacao)
	into STRICT    dt_liberacao_w
	from    documento
	where   nr_sequencia = current_setting('apap_dinamico_pck.nr_seq_documento_w')::documento.nr_sequencia%type;

	select  coalesce(max(nr_sequencia),0),
			max(dt_atualizacao)
	into STRICT    nr_seq_doc_apap_w,
			dt_atualizacao_w
	from    w_apap_pac
	where   nr_atendimento = current_setting('apap_dinamico_pck.nr_atendimento_w')::atendimento_paciente.nr_atendimento%type
	and     nm_usuario = current_setting('apap_dinamico_pck.nm_usuario_w')::usuario.nm_usuario%type
	and     nr_seq_documento = current_setting('apap_dinamico_pck.nr_seq_documento_w')::documento.nr_sequencia%type;

	if ((dt_atualizacao_w IS NOT NULL AND dt_atualizacao_w::text <> '') and dt_liberacao_w > dt_atualizacao_w) then
	  nr_seq_doc_apap_w := 0;

	  delete 	
	  from    w_apap_pac_registro
	  where   coalesce(nr_seq_apap_inf::text, '') = '';
		
	  delete
	  from    w_apap_pac_registro a
	  where   a.nr_seq_apap_inf in ( SELECT	x.nr_sequencia
	  from    w_apap_pac_informacao x,
			  w_apap_pac_grupo y,
			  w_apap_pac z
	  where   x.nr_seq_apap_grupo = y.nr_sequencia
	  and     y.nr_seq_mod_apap = z.nr_sequencia
	  and     z.nr_atendimento = current_setting('apap_dinamico_pck.nr_atendimento_w')::atendimento_paciente.nr_atendimento%type
	  and     z.nm_usuario = current_setting('apap_dinamico_pck.nm_usuario_w')::usuario.nm_usuario%type
	  and     z.nr_seq_documento = current_setting('apap_dinamico_pck.nr_seq_documento_w')::documento.nr_sequencia%type);

	  delete
	  from    w_apap_pac_informacao a
	  where   a.nr_seq_apap_grupo in (	SELECT  y.nr_sequencia
	  from    w_apap_pac_grupo y,
			  w_apap_pac z
	  where   y.nr_seq_mod_apap = z.nr_sequencia
	  and     z.nr_atendimento = current_setting('apap_dinamico_pck.nr_atendimento_w')::atendimento_paciente.nr_atendimento%type
	  and     z.nm_usuario = current_setting('apap_dinamico_pck.nm_usuario_w')::usuario.nm_usuario%type
	  and     z.nr_seq_documento = current_setting('apap_dinamico_pck.nr_seq_documento_w')::documento.nr_sequencia%type);

	  delete
	  from    w_apap_pac_grupo a
	  where   a.nr_seq_mod_apap in (SELECT  z.nr_sequencia
									from    w_apap_pac z
									where   z.nr_atendimento = current_setting('apap_dinamico_pck.nr_atendimento_w')::atendimento_paciente.nr_atendimento%type
									and     z.nm_usuario = current_setting('apap_dinamico_pck.nm_usuario_w')::usuario.nm_usuario%type
									and     z.nr_seq_documento = current_setting('apap_dinamico_pck.nr_seq_documento_w')::documento.nr_sequencia%type);

	  delete
	  from    w_apap_pac
	  where   nr_atendimento = current_setting('apap_dinamico_pck.nr_atendimento_w')::atendimento_paciente.nr_atendimento%type
	  and     nm_usuario = current_setting('apap_dinamico_pck.nm_usuario_w')::usuario.nm_usuario%type
	  and     nr_seq_documento = current_setting('apap_dinamico_pck.nr_seq_documento_w')::documento.nr_sequencia%type;
	else
	  delete
	  from    w_apap_pac_registro
	  where   coalesce(nr_seq_apap_inf::text, '') = '';

	  delete
	  from    w_apap_pac_registro a
	  where   exists (	SELECT	1
	  from    w_apap_pac_informacao x,
			  w_apap_pac_grupo y,
			  w_apap_pac z
	  where   x.nr_seq_apap_grupo = y.nr_sequencia
	  and     y.nr_seq_mod_apap = z.nr_sequencia
	  and     x.nr_sequencia = a.nr_seq_apap_inf
	  and     z.nr_atendimento = current_setting('apap_dinamico_pck.nr_atendimento_w')::atendimento_paciente.nr_atendimento%type
	  and     z.nm_usuario = current_setting('apap_dinamico_pck.nm_usuario_w')::usuario.nm_usuario%type
	  and     z.nr_seq_documento = current_setting('apap_dinamico_pck.nr_seq_documento_w')::documento.nr_sequencia%type)
	  and     (((nr_seq_origem IS NOT NULL AND nr_seq_origem::text <> '') AND (
				coalesce(IE_STATUS_HOUDINI::text, '') = '' OR IE_STATUS_HOUDINI <> 'L')) or (ie_resumo = 'S'));
	end if;
	commit;

	if (nr_seq_doc_apap_w = 0) then
	  <<read_apap>>
	  for r_apap in c_apap
	  loop
		select  nextval('w_apap_pac_seq')
		into STRICT    nr_seq_doc_apap_w
		;

		insert  into w_apap_pac( nr_sequencia,
				cd_estabelecimento,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				cd_pessoa_fisica,
				nr_atendimento,
				nr_seq_modelo,
				nr_seq_documento)
		values (nr_seq_doc_apap_w,
				current_setting('apap_dinamico_pck.cd_estabelecimento_w')::estabelecimento.cd_estabelecimento%type,
				clock_timestamp(),
				current_setting('apap_dinamico_pck.nm_usuario_w')::usuario.nm_usuario%type,
				clock_timestamp(),
				current_setting('apap_dinamico_pck.nm_usuario_w')::usuario.nm_usuario%type,
				r_apap.cd_pessoa_fisica,
				r_apap.nr_atendimento,
				null,
				r_apap.nr_seq_documento);

		<<read_grupo>>
		for r_grupo_apap in c_grupo_apap(r_apap.nr_sequencia)
		loop
		  select  nextval('w_apap_pac_grupo_seq')
		  into STRICT    nr_seq_apap_grupo_w
		;

		  insert  into w_apap_pac_grupo(	nr_sequencia,
				  dt_atualizacao,
				  nm_usuario,
				  dt_atualizacao_nrec,
				  nm_usuario_nrec,
				  ds_grupo_informacao,
				  nr_seq_mod_apap,
				  nr_seq_apresentacao,
				  ie_padrao_visivel,
				  nr_escala_minima_esq,
				  nr_escala_maxima_esq,
				  nr_seq_documento_secao,
				  nr_seq_linked_data,
				  ie_tipo,
				  nr_seq_template,
				  cd_funcao_add_new,
				  nr_seq_item_pront,
				  ie_tipo_acesso)
		  values (nr_seq_apap_grupo_w,
				  clock_timestamp(),
				  current_setting('apap_dinamico_pck.nm_usuario_w')::usuario.nm_usuario%type,
				  clock_timestamp(),
				  current_setting('apap_dinamico_pck.nm_usuario_w')::usuario.nm_usuario%type,
				  r_grupo_apap.ds_grupo_informacao,
				  nr_seq_doc_apap_w,
				  r_grupo_apap.nr_seq_apresentacao,
				  r_grupo_apap.ie_padrao_visivel,
				  r_grupo_apap.nr_escala_minima_esq,
				  r_grupo_apap.nr_escala_maxima_esq,
				  r_grupo_apap.nr_seq_documento_secao,
				  r_grupo_apap.nr_seq_linked_data,
				  r_grupo_apap.ie_tipo,
				  r_grupo_apap.nr_seq_template,
				  r_grupo_apap.cd_funcao_add_new,
				  r_grupo_apap.nr_seq_item_pront,
				  r_grupo_apap.ie_tipo_acesso);
		end loop read_grupo;
	  end loop read_apap;
	end if;

	select  max(c.dt_atualizacao)
	into STRICT    dt_atualizacao_w
	from    w_apap_pac a,
			w_apap_pac_grupo b,
			w_apap_pac_informacao c
	where   a.nr_sequencia = b.nr_seq_mod_apap
	and     b.nr_sequencia = c.nr_seq_apap_grupo
	and     a.nr_atendimento = current_setting('apap_dinamico_pck.nr_atendimento_w')::atendimento_paciente.nr_atendimento%type
	and     a.nm_usuario = current_setting('apap_dinamico_pck.nm_usuario_w')::usuario.nm_usuario%type
	and     a.nr_seq_documento = current_setting('apap_dinamico_pck.nr_seq_documento_w')::documento.nr_sequencia%type;

	if (dt_atualizacao_w IS NOT NULL AND dt_atualizacao_w::text <> '') then
	  update  w_apap_pac_informacao a
	  set     a.dt_atualizacao = clock_timestamp()
	  where   exists (SELECT 1
					  from    w_apap_pac_grupo x,
							  w_apap_pac y
					  where   x.nr_seq_mod_apap = y.nr_sequencia
					  and     y.nr_atendimento = current_setting('apap_dinamico_pck.nr_atendimento_w')::atendimento_paciente.nr_atendimento%type
					  and     y.nm_usuario = current_setting('apap_dinamico_pck.nm_usuario_w')::usuario.nm_usuario%type
					  and     y.nr_seq_documento = current_setting('apap_dinamico_pck.nr_seq_documento_w')::documento.nr_sequencia%type
					  and     x.nr_sequencia = a.nr_seq_apap_grupo)
					  and     exists (select 1
									  from    table(get_linha_apap) b
									  where   b.nm_atributo_apap = a.nm_atributo);
	end if;

	<<read_linha>>
	for r_linha_apap in c_linha_apap(0)
	loop
	  if (r_linha_apap.ie_existe = 'N') then
		select  nextval('w_apap_pac_informacao_seq')
		into STRICT    nr_seq_apap_linha_w
		;

		insert into w_apap_pac_informacao(	nr_sequencia,
											dt_atualizacao,
											nm_usuario,
											dt_atualizacao_nrec,
											nm_usuario_nrec,
											ds_informacao,
											nr_seq_apap_grupo,
											nm_atributo,
											nr_seq_apresentacao,
											ds_unid_med,
											nm_tabela,
											nm_atributo_tabela,
											nm_atributo_linked,
											ie_visivel,
											nr_escala_minima,
											nr_escala_maxima,
											ie_plot_style,
											ie_symbol,
											ds_color,
											nr_seq_apresentacao_sec,
											nr_seq_doc_subsecao,
											nr_seq_linked_data,
											nr_seq_superior,
											nr_seq_visao,
											ie_read_only,
											ie_trend,
											nr_width,
											nr_seq_exame,
											nr_seq_cpoe,
											ie_line,
											nr_size,
											nr_valor_minimo,
											nr_valor_maximo,
											ds_symbol_color_exceeded,
											ie_reference_line,
											nr_reference_line,
											ie_tipo_informacao,
											nr_seq_atrib_cliente,
											nr_seq_temp_conteudo,
											ie_aparelho_pa,
											ds_tooltip,
											nr_escala_intervalo,
											ie_mark_exceeded_value_chart,
											ie_plot_axis,
											ie_exibe_grafico,
											ds_lookup,
											ds_formato_composto,
											ds_icone_inter_medic,
											nm_atributo_unico)
		values (nr_seq_apap_linha_w,
				clock_timestamp(),
				current_setting('apap_dinamico_pck.nm_usuario_w')::usuario.nm_usuario%type,
				clock_timestamp(),
				current_setting('apap_dinamico_pck.nm_usuario_w')::usuario.nm_usuario%type,
				r_linha_apap.ds_informacao,
				r_linha_apap.nr_seq_apap_grupo,
				r_linha_apap.nm_atributo_apap,
				r_linha_apap.nr_seq_apresentacao,
				r_linha_apap.ds_unid_med,
				r_linha_apap.nm_tabela,
				r_linha_apap.nm_atributo_tabela,
				r_linha_apap.nm_atributo_linked,
				r_linha_apap.ie_visivel,
				r_linha_apap.nr_escala_minima,
				r_linha_apap.nr_escala_maxima,
				r_linha_apap.ie_plot_style,
				r_linha_apap.ie_symbol,
				r_linha_apap.ds_color,
				r_linha_apap.nr_ordem_composto,
				r_linha_apap.nr_seq_doc_subsecao,
				r_linha_apap.nr_seq_linked_data,
				null,
				r_linha_apap.nr_seq_visao,
				r_linha_apap.ie_read_only,
				r_linha_apap.ie_trend,
				r_linha_apap.nr_width,
				r_linha_apap.nr_seq_exame,
				r_linha_apap.nr_seq_cpoe,
				r_linha_apap.ie_line,
				r_linha_apap.nr_size,
				r_linha_apap.nr_valor_minimo,
				r_linha_apap.nr_valor_maximo,
				r_linha_apap.ds_symbol_color_exceeded,
				r_linha_apap.ie_reference_line,
				r_linha_apap.nr_reference_line,
				r_linha_apap.ie_tipo_informacao,
				r_linha_apap.nr_seq_atrib_cliente,
				r_linha_apap.nr_seq_temp_conteudo,
				r_linha_apap.ie_aparelho_pa,
				r_linha_apap.ds_tooltip,
				r_linha_apap.nr_escala_intervalo,
				r_linha_apap.ie_mark_exceeded_value_chart,
				r_linha_apap.ie_plot_axis,
				r_linha_apap.ie_grafico,
				r_linha_apap.ds_lookup,
				r_linha_apap.ds_formato_composto,
				r_linha_apap.ds_icone_inter_medic,
				r_linha_apap.nm_atributo_unico);
	  end if;

	  <<read_linha_composta>>
	  for r_linha_apap_c in c_linha_apap_c(r_linha_apap.nr_seq_linha_v)
	  loop
		if (r_linha_apap.ie_existe = 'S') then
		  --atualiza sequencia do item pai para a que ja existe na tabela
		  nr_seq_apap_linha_w := r_linha_apap.nr_seq_apap_pac_inf;
		end if;

		select  nextval('w_apap_pac_informacao_seq')
		into STRICT    nr_seq_apap_linha_ww
		;

		insert into w_apap_pac_informacao(nr_sequencia,
										  dt_atualizacao,
										  nm_usuario,
										  dt_atualizacao_nrec,
										  nm_usuario_nrec,
										  ds_informacao,
										  nr_seq_apap_grupo,
										  nm_atributo,
										  nr_seq_apresentacao,
										  ds_unid_med,
										  nm_tabela,
										  nm_atributo_tabela,
										  nm_atributo_linked,
										  ie_visivel,
										  nr_escala_minima,
										  nr_escala_maxima,
										  ie_plot_style,
										  ie_symbol,
										  ds_color,
										  nr_seq_apresentacao_sec,
										  nr_seq_doc_subsecao,
										  nr_seq_linked_data,
										  nr_seq_superior,
										  nr_seq_visao,
										  ie_read_only,
										  ie_trend,
										  nr_width,
										  nr_seq_exame,
										  nr_seq_cpoe,
										  ie_line,
										  nr_size,
										  nr_valor_minimo,
										  nr_valor_maximo,
										  ds_symbol_color_exceeded,
										  ie_reference_line,
										  nr_reference_line,
										  ie_tipo_informacao,
										  nr_seq_atrib_cliente,
										  nr_seq_temp_conteudo,
										  ie_aparelho_pa,
										  ds_tooltip,
										  nr_escala_intervalo,
										  ie_mark_exceeded_value_chart,
										  ie_plot_axis,
										  ie_exibe_grafico,
										  ds_lookup,
										  ds_formato_composto,
										  ds_icone_inter_medic,
										  nm_atributo_unico)
		values (nr_seq_apap_linha_ww,
				clock_timestamp(),
				current_setting('apap_dinamico_pck.nm_usuario_w')::usuario.nm_usuario%type,
				clock_timestamp(),
				current_setting('apap_dinamico_pck.nm_usuario_w')::usuario.nm_usuario%type,
				r_linha_apap_c.ds_informacao,
				r_linha_apap_c.nr_seq_apap_grupo,
				r_linha_apap_c.nm_atributo_apap,
				r_linha_apap_c.nr_seq_apresentacao,
				r_linha_apap_c.ds_unid_med,
				r_linha_apap_c.nm_tabela,
				r_linha_apap_c.nm_atributo_tabela,
				r_linha_apap_c.nm_atributo_linked,
				r_linha_apap_c.ie_visivel,
				r_linha_apap_c.nr_escala_minima,
				r_linha_apap_c.nr_escala_maxima,
				r_linha_apap_c.ie_plot_style,
				r_linha_apap_c.ie_symbol,
				r_linha_apap_c.ds_color,
				r_linha_apap_c.nr_ordem_composto,
				r_linha_apap_c.nr_seq_doc_subsecao,
				r_linha_apap_c.nr_seq_linked_data,
				nr_seq_apap_linha_w,
				r_linha_apap_c.nr_seq_visao,
				r_linha_apap_c.ie_read_only,
				r_linha_apap_c.ie_trend,
				r_linha_apap_c.nr_width,
				r_linha_apap_c.nr_seq_exame,
				r_linha_apap_c.nr_seq_cpoe,
				r_linha_apap_c.ie_line,
				r_linha_apap_c.nr_size,
				r_linha_apap_c.nr_valor_minimo,
				r_linha_apap_c.nr_valor_maximo,
				r_linha_apap_c.ds_symbol_color_exceeded,
				r_linha_apap_c.ie_reference_line,
				r_linha_apap_c.nr_reference_line,
				r_linha_apap_c.ie_tipo_informacao,
				r_linha_apap_c.nr_seq_atrib_cliente,
				r_linha_apap_c.nr_seq_temp_conteudo,
				r_linha_apap_c.ie_aparelho_pa,
				r_linha_apap_c.ds_tooltip,
				r_linha_apap_c.nr_escala_intervalo,
				r_linha_apap_c.ie_mark_exceeded_value_chart,
				r_linha_apap_c.ie_plot_axis,
				r_linha_apap_c.ie_grafico,
				r_linha_apap_c.ds_lookup,
				r_linha_apap_c.ds_formato_composto,
				r_linha_apap_c.ds_icone_inter_medic,
				r_linha_apap_c.nm_atributo_unico);
	  end	loop	read_linha_composta;
	end	loop	read_linha;

	if (dt_atualizacao_w IS NOT NULL AND dt_atualizacao_w::text <> '') then
	  delete
	  from    w_apap_pac_informacao a
	  where   a.nr_seq_apap_grupo in (SELECT  y.nr_sequencia
									  from    w_apap_pac_grupo y,
											  w_apap_pac z
									  where   y.nr_seq_mod_apap = z.nr_sequencia
									  and     z.nr_atendimento = current_setting('apap_dinamico_pck.nr_atendimento_w')::atendimento_paciente.nr_atendimento%type
									  and     z.nm_usuario = current_setting('apap_dinamico_pck.nm_usuario_w')::usuario.nm_usuario%type
									  and     z.nr_seq_documento = current_setting('apap_dinamico_pck.nr_seq_documento_w')::documento.nr_sequencia%type)
				and   a.dt_atualizacao <= dt_atualizacao_w;
	end if;
	commit;

		insert into w_apap_pac_registro( nr_sequencia,
									  dt_atualizacao,
									  nm_usuario,
									  dt_atualizacao_nrec,
									  nm_usuario_nrec,
									  nr_seq_origem,
									  dt_resultado,
									  vl_resultado,
									  vl_pad,
									  vl_pas,
									  vl_pam,
									  vl_papd,
									  vl_paps,
									  vl_papm,
									  ds_resultado,
									  nr_seq_apap_inf,
									  dt_medicao,
									  dt_registro,
									  dt_inicio,
									  dt_fim,
									  ds_profissional,
									  ie_alerta,
									  ds_tooltip,
									  vl_grafico,
									  ie_status,
									  qt_dose,
									  ds_result_desc,
									  ie_situacao,
									  ie_integracao,
									  ds_cor,
									  dt_liberacao,
									  ie_status_registro,
									  nr_seq_icone)
			  SELECT  nextval('w_apap_pac_registro_seq'),
					  clock_timestamp(),
					  current_setting('apap_dinamico_pck.nm_usuario_w')::usuario.nm_usuario%type,
					  clock_timestamp(),
					  current_setting('apap_dinamico_pck.nm_usuario_w')::usuario.nm_usuario%type,
					  d.nr_sequencia,
					  d.dt_conteudo,
					  d.vl_conteudo,
					  d.vl_pad,
					  d.vl_pas,
					  d.vl_pam,
					  d.vl_papd,
					  d.vl_paps,
					  d.vl_papm,
					  d.ds_conteudo,
					  (SELECT max(c.nr_sequencia)
					  from    w_apap_pac_informacao c,
							  w_apap_pac_grupo b,
							  w_apap_pac a
					  where   a.nr_sequencia = b.nr_seq_mod_apap
					  and     b.nr_sequencia = c.nr_seq_apap_grupo
					  and     c.nm_atributo = d.nm_atributo
					  and     a.nr_atendimento = current_setting('apap_dinamico_pck.nr_atendimento_w')::atendimento_paciente.nr_atendimento%type
					  and     a.nm_usuario = current_setting('apap_dinamico_pck.nm_usuario_w')::usuario.nm_usuario%type
					  and     a.nr_seq_documento = current_setting('apap_dinamico_pck.nr_seq_documento_w')::documento.nr_sequencia%type),
					  d.dt_medicao,
					  d.dt_registro,
					  d.dt_inicio_continuo,
					  d.dt_fim_continuo,
					  d.ds_profissional,
					  d.ie_alerta,
					  d.ds_tooltip,
					  d.vl_grafico,
					  d.ie_status,
					  d.qt_dose,
					  d.ds_result_desc,
					  d.ie_situacao,
					  coalesce(d.ie_integracao,'N'),
					  d.ds_cor_alerta,
					  d.dt_liberacao,
					  d.ie_status_registro,
					  d.nr_seq_icone
			  from    table(apap_dinamico_pck.get_valores(null)) d;
	commit;
	CALL apap_atualiza_linha_pai(nr_seq_doc_apap_w,0);
	ds_lista_tabela_w	:=	Obter_select_concatenado_bv('select  distinct c.nm_tabela '||
														'from    w_apap_pac a, '||
														'		w_apap_pac_grupo b, '||
														'		w_apap_pac_informacao c, '||
														'		linked_data_ativacao d '||
														'where   a.nr_sequencia      = b.nr_seq_mod_apap '||
														'and     b.nr_sequencia      = c.nr_seq_apap_grupo '||
														'and     c.nr_seq_linked_data= d.nr_seq_linked_data '||
														'and     a.nr_seq_documento  = :nr_seq_documento_p '||
														'and     a.nm_usuario        = :nm_usuario_p '||
														'and     a.nr_atendimento    = :nr_atendimento_p ',
														'nr_atendimento_p='||to_char(current_setting('apap_dinamico_pck.nr_atendimento_w')::atendimento_paciente.nr_atendimento%type)||
														';nm_usuario_p='||current_setting('apap_dinamico_pck.nm_usuario_w')::usuario.nm_usuario%type||
														';nr_seq_documento_p='||to_char(current_setting('apap_dinamico_pck.nr_seq_documento_w')::documento.nr_sequencia%type),',');
														
	ds_lista_template_w	:=	Obter_select_concatenado_bv('select  distinct d.nr_seq_template  '||
														'from    w_apap_pac a, '||
														'		w_apap_pac_grupo b, '||
														'		w_apap_pac_informacao c, '||
														'		ehr_template_conteudo d '||
														'where   a.nr_sequencia      = b.nr_seq_mod_apap '||
														'and     b.nr_sequencia      = c.nr_seq_apap_grupo '||
														'and     c.nr_seq_temp_conteudo  = d.nr_sequencia '||
														'and     a.nr_seq_documento  = :nr_seq_documento_p '||
														'and     a.nm_usuario        = :nm_usuario_p '||
														'and     a.nr_atendimento    = :nr_atendimento_p ',
														'nr_atendimento_p='||to_char(current_setting('apap_dinamico_pck.nr_atendimento_w')::atendimento_paciente.nr_atendimento%type)||
														';nm_usuario_p='||current_setting('apap_dinamico_pck.nm_usuario_w')::usuario.nm_usuario%type||
														';nr_seq_documento_p='||to_char(current_setting('apap_dinamico_pck.nr_seq_documento_w')::documento.nr_sequencia%type),',');
	--luciano
	CALL his_rule_value_default_pck.reset_dados();
	CALL his_rule_value_default_pck.gerar_dados(current_setting('apap_dinamico_pck.nr_atendimento_w')::atendimento_paciente.nr_atendimento%type,current_setting('apap_dinamico_pck.cd_pessoa_fisica_w')::pessoa_fisica.cd_pessoa_fisica%type,ds_lista_tabela_w,ds_lista_template_w);
  exception
	when others then
	  PERFORM set_config('apap_dinamico_pck.sql_errm_w', sqlerrm, false);
	  CALL apap_dinamico_pck.gera_log_apap('executa_transacao: '||current_setting('apap_dinamico_pck.sql_errm_w')::varchar(4000));
  end;
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE apap_dinamico_pck.executa_transacao () FROM PUBLIC;
