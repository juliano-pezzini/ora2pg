-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION apap_dinamico_pck.atualiza_parametro_atributo (nm_atributo_pai_p text,ds_valores_p text) RETURNS varchar AS $body$
DECLARE

		ds_comando_w         varchar(2000);
		pos_w			         bigint;
		contador_w		      bigint 	:= 1;
		nm_param_w		      varchar(50);
		ie_valido_w		      boolean;
		ds_caracter_w	      varchar(1);
		caracteres_validos_w	varchar(255)  :='abcdefghijklmnopqrstuvxywzABCDEFGHIJKLMNOPRQSTUVXYWZ_0123456789';
		nm_atributo_pai_w    varchar(2000) := null;
		nm_atributo_w        varchar(2000);
		ds_resultado_w       varchar(2000);
		
BEGIN
		begin
		if (nm_atributo_pai_p IS NOT NULL AND nm_atributo_pai_p::text <> '') then
			nm_atributo_pai_w := upper(replace(nm_atributo_pai_p,';',','));
		end if;
		ds_comando_w   := upper(ds_valores_p);
		ds_resultado_w := ds_comando_w;
		pos_w := position(':' in ds_comando_w);
		while( pos_w > 0 ) and ( contador_w < 300 ) loop
			ds_comando_w 	:= substr(ds_comando_w,pos_w+1,length(ds_comando_w));
			nm_param_w 	:= '';
			ie_valido_w	:= true;
			pos_w 		:= 1;
			while(ie_valido_w) and (pos_w < length(ds_valores_p)) loop
				ds_caracter_w := substr(ds_comando_w,pos_w,1);
				if ( position(ds_caracter_w in caracteres_validos_w) > 0 ) then
					nm_param_w := nm_param_w || ds_caracter_w;
				else
					ie_valido_w := false;
				end if;
				pos_w := pos_w + 1;
			end loop;
			nm_param_w := upper(':'||nm_param_w);

			select   max(cd_registro)
			into STRICT     nm_atributo_w
			from (	SELECT	row_number() OVER () AS nr_ordem,
								cd_registro
						from    table(lista_pck.obter_lista_char(nm_atributo_pai_w,','))) alias3
						where   nr_ordem = contador_w;
			if (nm_atributo_w IS NOT NULL AND nm_atributo_w::text <> '') and (nm_param_w IS NOT NULL AND nm_param_w::text <> '') then
				ds_resultado_w := replace(ds_resultado_w,nm_param_w,nm_atributo_w);
			end if;
			ds_comando_w 	:= substr(ds_comando_w,pos_w,length(ds_comando_w));
			pos_w 			:= position(':' in ds_comando_w);
			contador_w 		:= contador_w + 1;
		end loop;
		return ds_resultado_w;
	exception
	when others then
		PERFORM set_config('apap_dinamico_pck.sql_errm_w', sqlerrm, false);
		CALL apap_dinamico_pck.gera_log_apap('atualiza_parametro_atributo: '||current_setting('apap_dinamico_pck.sql_errm_w')::varchar(4000));
	end;
	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION apap_dinamico_pck.atualiza_parametro_atributo (nm_atributo_pai_p text,ds_valores_p text) FROM PUBLIC;
