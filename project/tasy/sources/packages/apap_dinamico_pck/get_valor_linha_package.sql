-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION apap_dinamico_pck.get_valor_linha (nr_seq_linha_p bigint, ie_situacao_p text default 'A') RETURNS SETOF VALORES_PAC_T AS $body$
DECLARE

valores_pac_r_w         valores_pac_r;
valores_pac_sup_v_w		valores_pac_t	:= valores_pac_t();
vl_param_regra_destaque_w  varchar(15);
ie_alerta_w                varchar(1);
ie_alerta_max_w            varchar(1);
ie_alerta_min_w            varchar(1);
ie_alerta_med_w            varchar(1);

c_valores CURSOR FOR
   SELECT   distinct c.nr_sequencia nr_seq_grupo,
			c.ds_grupo_informacao,
			d.nr_sequencia nr_seq_linha,
			d.ds_informacao,
			e.nr_sequencia nr_seq_valor,
			d.nm_atributo,
			d.nm_atributo_unico,
			d.nm_tabela,
			e.vl_resultado,
			coalesce(e.vl_pad,e.vl_papd) vl_pad,
			coalesce(e.vl_pas,e.vl_paps) vl_pas,
			coalesce(e.vl_pam,e.vl_papm) vl_pam,
			e.ds_resultado,
			e.dt_resultado,
			e.dt_registro,
			d.nr_seq_linked_data,
			e.dt_inicio,
			e.dt_fim,
			coalesce(e.ds_profissional,obter_pf_usuario(e.nm_usuario,'D')) ds_profissional,
			coalesce(e.ie_alerta,'N') ie_alerta,
			coalesce(apap_dinamico_pck.obter_destaque(b.nr_seq_documento,b.nr_atendimento,d.nm_tabela,d.nm_atributo_unico,e.dt_registro,'C'),e.ds_cor) ds_cor_alerta,
			b.nr_atendimento,
			d.nm_atributo_tabela,
			d.nr_seq_superior,
			d.nr_escala_minima,
			d.nr_escala_maxima,
			d.ie_plot_style, 
			CASE WHEN d.ie_trend='S' THEN  'TREND'  ELSE d.ie_symbol END  ie_symbol,
			d.ie_symbol ie_symbol_trend,
			d.ie_trend,
			d.ds_color,
			d.ds_color ds_main_color,
			b.nr_sequencia nr_seq_modelo,
			d.nm_atributo_linked,
			CASE WHEN coalesce(e.nr_seq_origem::text, '') = '' THEN 'N'  ELSE 'S' END  ie_readonly,
			apap_dinamico_pck.obter_comentario(b.nr_seq_documento,b.nr_atendimento,d.nm_tabela,d.nm_atributo_unico,e.dt_registro) ds_comentario,
			apap_dinamico_pck.obter_destaque(b.nr_seq_documento,b.nr_atendimento,d.nm_tabela,d.nm_atributo_unico,e.dt_registro,'S') nr_seq_destaque,
			apap_dinamico_pck.obter_destaque(b.nr_seq_documento,b.nr_atendimento,d.nm_tabela,d.nm_atributo_unico,e.dt_registro,'D') ds_descricao_destaque,
			e.ds_tooltip,
			(SELECT	max(y.nm_atrib_vl_graf) from linked_data_atributo y where y.nm_atributo_linked = d.nm_atributo_linked and d.nr_seq_linked_data = y.nr_seq_linked_data) nm_atrib_vl_graf,
			e.vl_grafico,
			e.ie_status,
			e.qt_dose,
			d.ds_unid_med,
			(select	max(y.ie_tooltip_complex)
			  from  linked_data_ativacao y
			  where y.nr_seq_linked_data = d.nr_seq_linked_data) ie_tooltip_complex,
			d.ds_symbol_color_exceeded,
			d.ie_mark_exceeded_value_chart,
			e.nr_seq_origem,
			e.ds_result_desc,
			coalesce(e.ie_alerta_max,'N') ie_alerta_max,
			coalesce(e.ie_alerta_min,'N') ie_alerta_min,
			coalesce(e.ie_alerta_med,'N') ie_alerta_med,
			apap_dinamico_pck.get_if_tree(d.nr_sequencia) ie_tree,
			coalesce(e.ie_situacao,'A') ie_situacao,
			b.nr_seq_documento,
			e.ie_resumo,
			coalesce(e.ie_integracao,'N') ie_integracao,
			CASE WHEN e.ie_status_registro='P' THEN 'S'  ELSE 'N' END  ie_novo_registro,
			coalesce(e.ie_editado,apap_dinamico_pck.get_ie_editado(e.nr_seq_apap_inf,e.dt_registro,e.vl_resultado,e.ds_resultado,e.dt_resultado)) ie_editado
   from     documento a,
			w_apap_pac b,
			w_apap_pac_grupo c,
			w_apap_pac_informacao d,
			w_apap_pac_registro e
   where    a.nr_sequencia       	= b.nr_seq_documento
   and      b.nr_sequencia       	= c.nr_seq_mod_apap
   and      c.nr_sequencia       	= d.nr_seq_apap_grupo
   and      d.nr_sequencia       	= e.nr_seq_apap_inf
   and      c.ie_padrao_visivel  	= 'S'
   and      d.ie_visivel         	in ('S','F')
   and		coalesce(e.ie_situacao,'A') 	= coalesce(ie_situacao_p,'A')
   and      d.nr_sequencia       	= nr_seq_linha_p;

BEGIN
  <<read_valores>>
  for r_valores in c_valores
	loop
	valores_pac_r_w.nr_seq_grupo        := r_valores.nr_seq_grupo;
	valores_pac_r_w.ds_grupo_informacao := r_valores.ds_grupo_informacao;
	valores_pac_r_w.nr_seq_linha        := r_valores.nr_seq_linha;
	valores_pac_r_w.ds_informacao       := r_valores.ds_informacao;
	valores_pac_r_w.nr_seq_valor        := r_valores.nr_seq_valor;
	valores_pac_r_w.nm_atributo         := r_valores.nm_atributo;
	valores_pac_r_w.nm_atributo_unico   := r_valores.nm_atributo_unico;
	valores_pac_r_w.nm_tabela           := r_valores.nm_tabela;
	valores_pac_r_w.vl_resultado        := r_valores.vl_resultado;
	valores_pac_r_w.vl_pad              := r_valores.vl_pad;
	valores_pac_r_w.vl_pas              := r_valores.vl_pas;
	valores_pac_r_w.vl_pam              := r_valores.vl_pam;
	valores_pac_r_w.ds_resultado        := r_valores.ds_resultado;
	valores_pac_r_w.dt_resultado        := r_valores.dt_resultado;
	valores_pac_r_w.dt_registro         := r_valores.dt_registro;
	valores_pac_r_w.nr_seq_linked_data  := r_valores.nr_seq_linked_data;
	valores_pac_r_w.dt_inicio           := r_valores.dt_inicio;
	valores_pac_r_w.nr_escala_minima	:= r_valores.nr_escala_minima;
	valores_pac_r_w.nr_escala_maxima	:= r_valores.nr_escala_maxima;
	valores_pac_r_w.ie_plot_style		:= r_valores.ie_plot_style;
	valores_pac_r_w.ie_symbol			:= r_valores.ie_symbol;
	valores_pac_r_w.ie_symbol_trend		:= r_valores.ie_symbol_trend;
	valores_pac_r_w.ie_trend			:= r_valores.ie_trend;
	valores_pac_r_w.ds_color			:= r_valores.ds_color;
	valores_pac_r_w.ds_main_color		:= r_valores.ds_main_color;
	valores_pac_r_w.ds_symbol_color_exceeded		:= r_valores.ds_symbol_color_exceeded;
	valores_pac_r_w.nr_seq_modelo		:= r_valores.nr_seq_modelo;
	valores_pac_r_w.nm_atributo_linked	:= r_valores.nm_atributo_linked;
	valores_pac_r_w.ie_readonly         := r_valores.ie_readonly;
	valores_pac_r_w.ds_comentario       := r_valores.ds_comentario;
	valores_pac_r_w.nr_seq_destaque     := r_valores.nr_seq_destaque;
	valores_pac_r_w.ds_descricao_destaque     := r_valores.ds_descricao_destaque;
	valores_pac_r_w.ds_tooltip       	:= r_valores.ds_tooltip;
	valores_pac_r_w.ie_status       	:= r_valores.ie_status;
	valores_pac_r_w.vl_grafico       	:= r_valores.vl_grafico;
	valores_pac_r_w.qt_dose       	  := r_valores.qt_dose;
	valores_pac_r_w.ds_unid_med         := r_valores.ds_unid_med;
	valores_pac_r_w.ie_tooltip_complex  := r_valores.ie_tooltip_complex;
	valores_pac_r_w.ie_mark_exceeded_value_chart    := r_valores.ie_mark_exceeded_value_chart;
	valores_pac_r_w.nm_atributo_tabela  := r_valores.nm_atributo_tabela;
	valores_pac_r_w.nr_seq_origem       := r_valores.nr_seq_origem;
	valores_pac_r_w.ds_result_desc      := r_valores.ds_result_desc;
	valores_pac_r_w.ie_tree      		:= r_valores.ie_tree;
	valores_pac_r_w.ie_situacao    		:= r_valores.ie_situacao;
	valores_pac_r_w.nr_atendimento 		:= r_valores.nr_atendimento;
	valores_pac_r_w.nr_seq_documento	:= r_valores.nr_seq_documento;
	valores_pac_r_w.ie_resumo			:= r_valores.ie_resumo;
	valores_pac_r_w.ie_integracao		:= r_valores.ie_integracao;
	valores_pac_r_w.ie_novo_registro	:= r_valores.ie_novo_registro;
	valores_pac_r_w.ie_editado			:= r_valores.ie_editado;
	
	
	if (r_valores.ie_tree = 'S') then
		valores_pac_r_w.ie_readonly := 'S';
	end if;	
	if (r_valores.dt_inicio IS NOT NULL AND r_valores.dt_inicio::text <> '') then
	  valores_pac_r_w.dt_fim          := coalesce(r_valores.dt_fim,clock_timestamp());
	else
	  valores_pac_r_w.dt_fim			:= null;
	end if;
	valores_pac_r_w.ds_profissional     := r_valores.ds_profissional;
	valores_pac_r_w.ie_alerta           := r_valores.ie_alerta;
	valores_pac_r_w.ds_cor_alerta		:= r_valores.ds_cor_alerta;
	if (r_valores.ie_alerta = 'S' and (r_valores.ie_mark_exceeded_value_chart = 'S')) then
		valores_pac_r_w.ds_color := r_valores.ds_symbol_color_exceeded;
	end if;
	valores_pac_r_w.ie_alerta_max := r_valores.ie_alerta_max;
	valores_pac_r_w.ie_alerta_min := r_valores.ie_alerta_min;
	valores_pac_r_w.ie_alerta_med := r_valores.ie_alerta_med;
	
	
	RETURN NEXT valores_pac_r_w;
  end loop read_valores;
  return;
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION apap_dinamico_pck.get_valor_linha (nr_seq_linha_p bigint, ie_situacao_p text default 'A') FROM PUBLIC;
