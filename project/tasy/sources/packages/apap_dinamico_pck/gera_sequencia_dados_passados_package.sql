-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE apap_dinamico_pck.gera_sequencia_dados_passados () AS $body$
DECLARE

   c_registros CURSOR FOR
	  SELECT  distinct c.nm_tabela
	  from    table(get_linha_apap) c;

BEGIN
   begin
   <<read_registros>>
   for r_registros in c_registros
	  loop
												   
														 
	   
	  if (r_registros.nm_tabela = 'ATENDIMENTO_PERDA_GANHO') then
		 PERFORM set_config('apap_dinamico_pck.ds_lista_tipo_pg_w', Obter_select_concatenado_bv(  'select  distinct nr_seq_tipo '||
															   'from    atendimento_perda_ganho '||
															   'where   nr_atendimento = :nr_atendimento_p '||
															   'and     dt_medida       between pkg_date_utils.start_of(:dt_inicial_p,''DAY'') and pkg_date_utils.end_of(:dt_final_p,''DAY'') ',
															   'nr_atendimento_p='||to_char(current_setting('apap_dinamico_pck.nr_atendimento_w')::atendimento_paciente.nr_atendimento%type)||
															   ';dt_inicial_p='||to_char(current_setting('apap_dinamico_pck.dt_inicial_w')::timestamp)||
															   ';dt_final_p='||to_char(current_setting('apap_dinamico_pck.dt_final_w')::timestamp),','), false);
		 PERFORM set_config('apap_dinamico_pck.ds_lista_grupo_pg_w', Obter_select_concatenado_bv(  'select  distinct b.nr_seq_grupo '||
															   'from    atendimento_perda_ganho a, '||
															   '        tipo_perda_ganho b '||
															   'where   a.nr_seq_tipo     = b.nr_sequencia '||
															   'and     a.nr_atendimento  = :nr_atendimento_p '||
															   'and     a.dt_medida       between pkg_date_utils.start_of(:dt_inicial_p,''DAY'') and pkg_date_utils.end_of(:dt_final_p,''DAY'') ',
															   'nr_atendimento_p='||to_char(current_setting('apap_dinamico_pck.nr_atendimento_w')::atendimento_paciente.nr_atendimento%type)||
															   ';dt_inicial_p='||to_char(current_setting('apap_dinamico_pck.dt_inicial_w')::timestamp)||
															   ';dt_final_p='||to_char(current_setting('apap_dinamico_pck.dt_final_w')::timestamp),','), false);
	  elsif (r_registros.nm_tabela = 'EXAME_LAB_RESULT_ITEM') then
		 PERFORM set_config('apap_dinamico_pck.ds_lista_ex_w', Obter_select_concatenado_bv(  'select  distinct b.nr_seq_exame '||
														 'from    exame_lab_resultado a, '||
														 '        exame_lab_result_item b '||
														 'where   a.nr_seq_resultado   = b.nr_seq_resultado '||
														 'and     a.nr_atendimento     = :nr_atendimento_p '||
														 'and     a.dt_resultado       between pkg_date_utils.start_of(:dt_inicial_p,''DAY'') and pkg_date_utils.end_of(:dt_final_p,''DAY'') ',
														 'nr_atendimento_p='||to_char(current_setting('apap_dinamico_pck.nr_atendimento_w')::atendimento_paciente.nr_atendimento%type)||
														 ';dt_inicial_p='||to_char(current_setting('apap_dinamico_pck.dt_inicial_w')::timestamp)||
														 ';dt_final_p='||to_char(current_setting('apap_dinamico_pck.dt_final_w')::timestamp),','), false);
	  elsif (r_registros.nm_tabela = 'EVOLUCAO_PACIENTE') then
		 PERFORM set_config('apap_dinamico_pck.ds_lista_ev_w', Obter_select_concatenado_bv(  'select  distinct ie_evolucao_clinica '||
														 'from    evolucao_paciente '||
														 'where   nr_atendimento = :nr_atendimento_p '||
														 'and     dt_evolucao between pkg_date_utils.start_of(:dt_inicial_p,''DAY'') and pkg_date_utils.end_of(:dt_final_p,''DAY'') ',
														 'nr_atendimento_p='||to_char(current_setting('apap_dinamico_pck.nr_atendimento_w')::atendimento_paciente.nr_atendimento%type)||
														 ';dt_inicial_p='||to_char(current_setting('apap_dinamico_pck.dt_inicial_w')::timestamp)||
														 ';dt_final_p='||to_char(current_setting('apap_dinamico_pck.dt_final_w')::timestamp),','), false);

		elsif (r_registros.nm_tabela = 'EHR_REGISTRO') then
		 PERFORM set_config('apap_dinamico_pck.ds_lista_tipo_registro_w', Obter_select_concatenado_bv('select  distinct nr_seq_templ '||
															   'from    ehr_registro '||
															   'where   nr_atendimento = :nr_atendimento_p '||
															   'and     dt_registro between pkg_date_utils.start_of(:dt_inicial_p,''DAY'') and pkg_date_utils.end_of(:dt_final_p,''DAY'') ',
															   'nr_atendimento_p='||to_char(current_setting('apap_dinamico_pck.nr_atendimento_w')::atendimento_paciente.nr_atendimento%type)||
															   ';dt_inicial_p='||to_char(current_setting('apap_dinamico_pck.dt_inicial_w')::timestamp)||
															   ';dt_final_p='||to_char(current_setting('apap_dinamico_pck.dt_final_w')::timestamp),','), false);

	  elsif (r_registros.nm_tabela = 'PE_PRESCR_DIAG') then
		 PERFORM set_config('apap_dinamico_pck.ds_lista_diagnostico_w', Obter_select_concatenado_bv(  'select  distinct ppd.nr_seq_diag '||
														 'from    PE_PRESCR_DIAG ppd, '||
														 '        PE_PRESCRICAO pe '||
														 'where   pe.nr_atendimento = :nr_atendimento_p '||
														 'and     ppd.nr_seq_prescr = pe.nr_sequencia' ||
														 'and     pe.dt_suspensao is null' ||
														 'and     pe.ie_situacao = ''A''' ||                                                       
														 'and     pe.DT_PRESCRICAO  between pkg_date_utils.start_of(:dt_inicial_p,''DAY'') and pkg_date_utils.end_of(:dt_final_p,''DAY'') ',
														 'nr_atendimento_p='||to_char(current_setting('apap_dinamico_pck.nr_atendimento_w')::atendimento_paciente.nr_atendimento%type)||
														 ';dt_inicial_p='||to_char(current_setting('apap_dinamico_pck.dt_inicial_w')::timestamp)||
														 ';dt_final_p='||to_char(current_setting('apap_dinamico_pck.dt_final_w')::timestamp),','), false);

	  elsif (r_registros.nm_tabela = 'ESCALA_EIF_II') then
		 PERFORM set_config('apap_dinamico_pck.ds_lista_score_flex_w', Obter_select_concatenado_bv('select  distinct nr_seq_escala '||
															   'from    escala_eif_ii '||
															   'where   nr_atendimento = :nr_atendimento_p '||
															   'and     dt_avaliacao between pkg_date_utils.start_of(:dt_inicial_p,''DAY'') and pkg_date_utils.end_of(:dt_final_p,''DAY'') ',
															   'nr_atendimento_p='||to_char(current_setting('apap_dinamico_pck.nr_atendimento_w')::atendimento_paciente.nr_atendimento%type)||
															   ';dt_inicial_p='||to_char(current_setting('apap_dinamico_pck.dt_inicial_w')::timestamp)||
															   ';dt_final_p='||to_char(current_setting('apap_dinamico_pck.dt_final_w')::timestamp),','), false);
	  elsif (r_registros.nm_tabela = 'MED_AVALIACAO_PACIENTE') then
		 PERFORM set_config('apap_dinamico_pck.ds_lista_tipo_avaliacao_w', Obter_select_concatenado_bv('select  distinct nr_seq_tipo_avaliacao '||
															   'from    med_avaliacao_paciente '||
															   'where   nr_atendimento = :nr_atendimento_p '||
															   'and     dt_avaliacao between pkg_date_utils.start_of(:dt_inicial_p,''DAY'') and pkg_date_utils.end_of(:dt_final_p,''DAY'') ',
															   'nr_atendimento_p='||to_char(current_setting('apap_dinamico_pck.nr_atendimento_w')::atendimento_paciente.nr_atendimento%type)||
															   ';dt_inicial_p='||to_char(current_setting('apap_dinamico_pck.dt_inicial_w')::timestamp)||
															   ';dt_final_p='||to_char(current_setting('apap_dinamico_pck.dt_final_w')::timestamp),','), false);
	  end if;
	  end loop read_registros;
	  exception
	  when others then
		 PERFORM set_config('apap_dinamico_pck.sql_errm_w', sqlerrm, false);
		 CALL apap_dinamico_pck.gera_log_apap('gera_sequencia_dados_passados: '||current_setting('apap_dinamico_pck.sql_errm_w')::varchar(4000));
	  end;
   END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE apap_dinamico_pck.gera_sequencia_dados_passados () FROM PUBLIC;
