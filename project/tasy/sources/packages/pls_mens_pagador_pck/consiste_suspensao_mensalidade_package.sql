-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_mens_pagador_pck.consiste_suspensao_mensalidade ( nr_seq_contrato_p pls_contrato.nr_sequencia%type, nr_seq_pagador_p pls_contrato_pagador.nr_sequencia%type, dt_referencia_p pls_lote_mensalidade.dt_mesano_referencia%type, ie_tipo_pagador_p pls_contrato_susp_mens.ie_tipo_pagador%type, nr_seq_motivo_susp_p INOUT pls_motivo_susp_cobr_mens.nr_sequencia%type, ie_mensalidade_suspensa_p INOUT text) AS $body$
DECLARE


nr_seq_motivo_susp_w		pls_motivo_susp_cobr_mens.nr_sequencia%type;
qt_item_excecao_w		integer;
ie_mensalidade_suspensa_w	varchar(1);
nr_seq_grupo_contrato_w		pls_contrato_grupo.nr_seq_grupo%type;

BEGIN

ie_mensalidade_suspensa_w	:= 'N';
nr_seq_motivo_susp_w		:= null;

if (nr_seq_pagador_p IS NOT NULL AND nr_seq_pagador_p::text <> '') then
	select	max(nr_seq_motivo_suspensao)
	into STRICT	nr_seq_motivo_susp_w
	from	pls_contrato_susp_mens
	where	coalesce(nr_seq_contrato::text, '') = ''
	and	nr_seq_pagador	= nr_seq_pagador_p
	and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
	and	(((coalesce(dt_fim_suspensao::text, '') = '')
	and (dt_referencia_p >= dt_inicio_suspensao))
	or	((dt_fim_suspensao IS NOT NULL AND dt_fim_suspensao::text <> '') 
	and (dt_referencia_p between dt_inicio_suspensao and dt_fim_suspensao) 
	and (dt_inicio_suspensao <> dt_fim_suspensao)))
	and	((ie_cobrar_periodo_susp = 'S' and coalesce(dt_fim_suspensao::text, '') = '') or (ie_cobrar_periodo_susp <> 'S'))
	and	((ie_tipo_pagador = ie_tipo_pagador_p) or (coalesce(ie_tipo_pagador, 'A') = 'A'));
end if;

if	((nr_seq_contrato_p IS NOT NULL AND nr_seq_contrato_p::text <> '') and (coalesce(nr_seq_motivo_susp_w::text, '') = '')) then
	select	max(nr_seq_motivo_suspensao)
	into STRICT	nr_seq_motivo_susp_w
	from	pls_contrato_susp_mens
	where	nr_seq_contrato		= nr_seq_contrato_p
	and	((nr_seq_pagador	= nr_seq_pagador_p) or (coalesce(nr_seq_pagador::text, '') = ''))
	and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
	and	(((coalesce(dt_fim_suspensao::text, '') = '')
	and (dt_referencia_p >= dt_inicio_suspensao))
	or	((dt_fim_suspensao IS NOT NULL AND dt_fim_suspensao::text <> '') 
	and (dt_referencia_p between dt_inicio_suspensao and dt_fim_suspensao) 
	and (dt_inicio_suspensao <> dt_fim_suspensao)))
	and	((ie_cobrar_periodo_susp = 'S' and coalesce(dt_fim_suspensao::text, '') = '') or (ie_cobrar_periodo_susp <> 'S'))
	and	((ie_tipo_pagador = ie_tipo_pagador_p) or (coalesce(ie_tipo_pagador, 'A') = 'A'));
	
	if (coalesce(nr_seq_motivo_susp_w::text, '') = '') then
		select	max(a.nr_seq_motivo_suspensao)
		into STRICT	nr_seq_motivo_susp_w
		from	pls_contrato_susp_mens  a,
			pls_contrato_grupo	b
		where	a.nr_seq_grupo_contrato	= b.nr_seq_grupo
		and	b.nr_seq_contrato 	= nr_seq_contrato_p
		and	(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
		and	(((coalesce(a.dt_fim_suspensao::text, '') = '')
		and (dt_referencia_p >= a.dt_inicio_suspensao))
		or	((a.dt_fim_suspensao IS NOT NULL AND a.dt_fim_suspensao::text <> '') 
		and (dt_referencia_p between a.dt_inicio_suspensao and a.dt_fim_suspensao) 
		and (a.dt_inicio_suspensao <> a.dt_fim_suspensao)))
		and	((a.ie_cobrar_periodo_susp = 'S' and coalesce(a.dt_fim_suspensao::text, '') = '') or (a.ie_cobrar_periodo_susp <> 'S'))
		and	((a.ie_tipo_pagador = ie_tipo_pagador_p) or (coalesce(ie_tipo_pagador, 'A') = 'A'));
	end if;
end if;

if (nr_seq_motivo_susp_w IS NOT NULL AND nr_seq_motivo_susp_w::text <> '') then
	select	count(1)
	into STRICT	qt_item_excecao_w
	from	pls_susp_cobr_mens_excecao a,
		pls_motivo_susp_cobr_mens b
	where	a.nr_seq_motivo	= b.nr_sequencia
	and	a.nr_seq_motivo	= nr_seq_motivo_susp_w
	and	b.ie_situacao	= 'A';

	if (qt_item_excecao_w = 0) then
		ie_mensalidade_suspensa_w := 'S';
	end if;
end if;

ie_mensalidade_suspensa_p	:= ie_mensalidade_suspensa_w;
nr_seq_motivo_susp_p		:= nr_seq_motivo_susp_w;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_mens_pagador_pck.consiste_suspensao_mensalidade ( nr_seq_contrato_p pls_contrato.nr_sequencia%type, nr_seq_pagador_p pls_contrato_pagador.nr_sequencia%type, dt_referencia_p pls_lote_mensalidade.dt_mesano_referencia%type, ie_tipo_pagador_p pls_contrato_susp_mens.ie_tipo_pagador%type, nr_seq_motivo_susp_p INOUT pls_motivo_susp_cobr_mens.nr_sequencia%type, ie_mensalidade_suspensa_p INOUT text) FROM PUBLIC;
