-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_imp_farmacia_pck.gerar_cta_itens_reemb ( ds_conteudo_p text, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) AS $body$
DECLARE


ds_cd_banco_w  varchar(3);
nr_seq_segurado_w  pls_segurado.nr_sequencia%type;
cd_carteirinha_w  varchar(9);
ie_tipo_transacao_w  bigint;
dt_realizacao_w    varchar(8);
ds_vl_total_w    varchar(13);
qt_item_w      integer;
nr_crm_w      varchar(10);
cd_material_w    varchar(13);
ds_vl_desp_w    varchar(13);
ie_forma_pagto_w  varchar(1);
cd_banco_w      pls_imp_cta.cd_banco%type;
cd_agencia_w    varchar(7);
cd_conta_w      varchar(15);
cd_mat_tiss_w    varchar(18);
ds_item_w      varchar(100);
ds_cnpj_w      varchar(14);
nm_farm_w      varchar(100);
vl_total_w      double precision;
vl_desp_w      double precision;
nr_seq_conta_ger_w  pls_imp_cta.nr_sequencia%type;
cd_conselho_w  varchar(2);
uf_conselho_w  varchar(2);


BEGIN

  cd_carteirinha_w   := substr(ds_conteudo_p, 2, 9);
  ie_tipo_transacao_w  := substr(ds_conteudo_p, 12, 2);
  cd_material_w    := substr(ds_conteudo_p, 68, 13);
  dt_realizacao_w    := substr(ds_conteudo_p, 22, 8);
  ds_vl_desp_w    := substr(ds_conteudo_p, 30, 13);
  ds_vl_total_w    := substr(ds_conteudo_p, 81, 13);
  qt_item_w      := substr(ds_conteudo_p, 51, 5);
  nr_crm_w      := substr(ds_conteudo_p, 56, 10);
  cd_conselho_w  := substr(ds_conteudo_p, 66, 2);
  uf_conselho_w  := substr(ds_conteudo_p, 94, 2);
  ds_cd_banco_w  := substr(ds_conteudo_p, 105, 3);
  ie_forma_pagto_w  := substr(ds_conteudo_p, 104, 1);
  cd_agencia_w    := substr(ds_conteudo_p, 108, 7);
  cd_conta_w      := substr(ds_conteudo_p, 115, 15);
  cd_mat_tiss_w    := substr(ds_conteudo_p, 130, 18);
  ds_item_w      := substr(ds_conteudo_p, 148, 100);
  ds_cnpj_w      := substr(ds_conteudo_p, 248, 14);
  nm_farm_w      := substr(ds_conteudo_p, 262, 100);

  begin
  cd_banco_w      := (ds_cd_banco_w)::numeric;
  exception
  when others then
    cd_banco_w := null;
  end;

  select   (substr(ds_vl_total_w,1,11))::numeric  + ((substr(ds_vl_total_w,12,2)/100)::numeric )
  into STRICT  vl_total_w
;

  select   (substr(ds_vl_desp_w,1,11))::numeric  + ((substr(ds_vl_desp_w,12,2)/100)::numeric )
  into STRICT  vl_desp_w
;

  insert into pls_imp_cta(nr_sequencia, nr_seq_prot_imp, cd_usuario_plano_imp,
          ie_tp_transacao, ie_tp_procedimento, dt_atendimento,
          vl_total_imp, qt_material_imp, nr_crm_exec_imp,
          cd_material_imp, vl_material_imp, ie_forma_pagamento,
          cd_banco, cd_agencia_bancaria, cd_conta,
          ds_material_imp, cd_codigo_mat_tiss, cd_cgc_prestador_imp,
          nm_prestador_imp, dt_atualizacao, dt_atualizacao_nrec,
          nm_usuario, nm_usuario_nrec, uf_crm_prest_exec_imp,
      uf_crm_exec_imp
          )
  values ( nextval('pls_imp_cta_seq'), current_setting('pls_imp_farmacia_pck.nr_seq_prot_reemb_w')::pls_imp_prot_conta.nr_sequencia%type, cd_carteirinha_w,
      ie_tipo_transacao_w, 1, to_date(dt_realizacao_w, 'yyyy/mm/dd'),
      vl_total_w, qt_item_w, nr_crm_w,
      cd_material_w, vl_desp_w, ie_forma_pagto_w,
      cd_banco_w, cd_agencia_w, cd_conta_w,
      ds_item_w, cd_mat_tiss_w,  ds_cnpj_w,
      nm_farm_w, clock_timestamp(), clock_timestamp(),
      nm_usuario_p, nm_usuario_p, cd_conselho_w,
    uf_conselho_w
      );

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_imp_farmacia_pck.gerar_cta_itens_reemb ( ds_conteudo_p text, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) FROM PUBLIC;
