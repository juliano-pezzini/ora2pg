-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_imp_farmacia_pck.gerar_protocolo_arquivo_reemb (ds_conteudo_p text, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) AS $body$
DECLARE


dt_prot_imp_w  timestamp;
ds_prot_imp_w  varchar(15);
vl_total_imp_w   double precision;
ds_vl_total_w    varchar(15);
current_setting('pls_imp_farmacia_pck.cd_codigo_prest_w')::pls_conta.cd_prestador_exec_imp%type    integer;
ds_prest_w        varchar(30);
ds_hr_grav_arquivo_w  varchar(6);
ds_dt_mes_comp_w    varchar(8);
nr_seq_prod_orig_w    bigint;
ds_usu_interno_w    varchar(6);
ie_entidade_congenere_w varchar(1);
ie_tipo_pessoa_w    varchar(1);
ds_identificador_w    varchar(1);
qt_ocorrencias_w    integer;
vl_total_w        double precision;


BEGIN

  ds_identificador_w := substr( ds_conteudo_p,1,1);
  if ( ds_identificador_w = '0') then

    PERFORM set_config('pls_imp_farmacia_pck.cd_codigo_prest_w', substr(ds_conteudo_p,2,5), false);
    ds_prest_w        := substr(ds_conteudo_p,7,30);
    ds_hr_grav_arquivo_w  := substr(ds_conteudo_p,45,6);
    ds_dt_mes_comp_w    := substr(ds_conteudo_p,51,8);
    nr_seq_prod_orig_w    := substr(ds_conteudo_p,59,2);
    ds_usu_interno_w    := substr(ds_conteudo_p,61,6);
    ie_entidade_congenere_w  := substr(ds_conteudo_p,67,1);
    ie_tipo_pessoa_w    := substr(ds_conteudo_p,68,1);

    begin

      ds_prot_imp_w := ds_dt_mes_comp_w||' '||ds_hr_grav_arquivo_w;

      dt_prot_imp_w := to_date(ds_prot_imp_w,'AAAA/MM/DD hh24:ss:mi');
    exception
    when others then
      dt_prot_imp_w := clock_timestamp();
    end;

    insert into pls_imp_prot_conta(nr_sequencia, cd_prestador_imp, ie_congenere,
                    dt_protocolo_imp, dt_recebimento, nm_prestador_imp,
                    ie_tp_prestador, dt_atualizacao, dt_atualizacao_nrec,
                    nm_usuario, nm_usuario_nrec, cd_estabelecimento)
    values (  nextval('pls_imp_prot_conta_seq'), current_setting('pls_imp_farmacia_pck.cd_codigo_prest_w')::pls_conta.cd_prestador_exec_imp%type, ie_entidade_congenere_w,
        dt_prot_imp_w, clock_timestamp(), ds_prest_w,
        ie_tipo_pessoa_w, clock_timestamp(), clock_timestamp(),
        nm_usuario_p, nm_usuario_p, cd_estabelecimento_p)
    returning nr_sequencia into current_setting('pls_imp_farmacia_pck.nr_seq_prot_reemb_w')::pls_imp_prot_conta.nr_sequencia%type;

  elsif ( ds_identificador_w = '9') then

    qt_ocorrencias_w  := substr(ds_conteudo_p,2,5);
    ds_vl_total_w    := substr(ds_conteudo_p,7,15);

    select   (substr(ds_vl_total_w,1,13))::numeric  + ((substr(ds_vl_total_w,14,2)/100)::numeric )
    into STRICT  vl_total_w
;

    update pls_imp_prot_conta
    set    qt_ocorrencias = qt_ocorrencias_w,
        vl_total_imp = vl_total_w
    where   nr_sequencia = current_setting('pls_imp_farmacia_pck.nr_seq_prot_reemb_w')::pls_imp_prot_conta.nr_sequencia%type;

  end if;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_imp_farmacia_pck.gerar_protocolo_arquivo_reemb (ds_conteudo_p text, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) FROM PUBLIC;
