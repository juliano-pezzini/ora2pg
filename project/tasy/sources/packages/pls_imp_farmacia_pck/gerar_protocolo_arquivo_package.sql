-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_imp_farmacia_pck.gerar_protocolo_arquivo ( ds_conteudo_p text, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type ) AS $body$
DECLARE


ds_prest_w        		varchar(30);
ds_dt_grav_arquivo_w  	varchar(8);
ds_hr_grav_arquivo_w  	varchar(6);
ds_dt_mes_comp_w  		varchar(8);
nr_seq_prod_orig_w  	varchar(2);
ds_usu_interno_w  		varchar(6);
ie_entidade_congenere_w varchar(1);
ie_tipo_pessoa_w  		varchar(1);
dt_mes_competencia_w  	timestamp;
nr_seq_lote_w    		pls_lote_Protocolo_conta.nr_sequencia%type;
cd_prestador_imp_aux_w	pls_prestador.cd_prestador%type;


BEGIN

	PERFORM set_config('pls_imp_farmacia_pck.cd_codigo_prest_w', substr(ds_conteudo_p,2,5), false);
	ds_prest_w    		:= substr(ds_conteudo_p,7,30);
	ds_dt_grav_arquivo_w  := substr(ds_conteudo_p,37,8);
	ds_hr_grav_arquivo_w  := substr(ds_conteudo_p,45,6);
	ds_dt_mes_comp_w  	:= substr(ds_conteudo_p,51,8);
	nr_seq_prod_orig_w  	:= substr(ds_conteudo_p,59,2);
	ds_usu_interno_w  	:= substr(ds_conteudo_p,61,6);
	ie_entidade_congenere_w  := substr(ds_conteudo_p,67,1);
	ie_tipo_pessoa_w  	:= substr(ds_conteudo_p,68,1);

	begin
		dt_mes_competencia_w := to_date(ds_dt_mes_comp_w,'YYYY/MM/DD');
	exception
	when others then
		dt_mes_competencia_w := clock_timestamp();
	end;

	select	max(nr_sequencia)
	into STRICT	current_setting('pls_imp_farmacia_pck.nr_seq_prestador_imp_w')::pls_prestador.nr_sequencia%type
	from	pls_prestador
	where	cd_prestador_upper = upper(current_setting('pls_imp_farmacia_pck.cd_codigo_prest_w')::pls_conta.cd_prestador_exec_imp%type)
	and	ie_prestador_matriz = 'S'
	and	ie_situacao = 'A';

	if (coalesce(current_setting('pls_imp_farmacia_pck.nr_seq_prestador_imp_w')::pls_prestador.nr_sequencia%type,0) = 0) then
		cd_prestador_imp_aux_w := elimina_caractere_especial(current_setting('pls_imp_farmacia_pck.cd_codigo_prest_w')::pls_conta.cd_prestador_exec_imp%type);
		
		select	max(nr_sequencia)
		into STRICT	current_setting('pls_imp_farmacia_pck.nr_seq_prestador_imp_w')::pls_prestador.nr_sequencia%type
		from	pls_prestador
		where	cd_prestador_upper_espe = upper(cd_prestador_imp_aux_w)
		and		ie_situacao = 'A'
		and		ie_prestador_matriz = 'S';
	end if;
	
	if (current_setting('pls_imp_farmacia_pck.nr_seq_prestador_imp_w')::pls_prestador.nr_sequencia%coalesce(type::text, '') = '') then
		select	max(nr_sequencia)
		into STRICT	current_setting('pls_imp_farmacia_pck.nr_seq_prestador_imp_w')::pls_prestador.nr_sequencia%type
		from	pls_prestador
		where	cd_prestador_upper = upper(current_setting('pls_imp_farmacia_pck.cd_codigo_prest_w')::pls_conta.cd_prestador_exec_imp%type)
		and		ie_situacao = 'A';

		if (coalesce(current_setting('pls_imp_farmacia_pck.nr_seq_prestador_imp_w')::pls_prestador.nr_sequencia%type,0) = 0) then
			cd_prestador_imp_aux_w := elimina_caractere_especial(current_setting('pls_imp_farmacia_pck.cd_codigo_prest_w')::pls_conta.cd_prestador_exec_imp%type);
			
			select	max(nr_sequencia)
			into STRICT	current_setting('pls_imp_farmacia_pck.nr_seq_prestador_imp_w')::pls_prestador.nr_sequencia%type
			from	pls_prestador
			where	cd_prestador_upper_espe = upper(cd_prestador_imp_aux_w);
		end if;
	end if;
	
	if (current_setting('pls_imp_farmacia_pck.nr_seq_prestador_imp_w')::pls_prestador.nr_sequencia%(type IS NOT NULL AND type::text <> '')) then
		PERFORM set_config('pls_imp_farmacia_pck.nm_prestador_imp_w', substr(pls_obter_dados_prestador(current_setting('pls_imp_farmacia_pck.nr_seq_prestador_imp_w')::pls_prestador.nr_sequencia%type,'N'),1,255), false);
	end if;

	insert into pls_lote_protocolo_conta(nr_sequencia,  cd_estabelecimento, dt_atualizacao,
            dt_atualizacao_nrec, nm_usuario, nm_usuario_nrec,
            ie_status, dt_lote, ie_arquivo_farmacia)
    values (  nextval('pls_lote_protocolo_conta_seq'), cd_estabelecimento_p, clock_timestamp(),
		clock_timestamp(), nm_usuario_p, nm_usuario_p,
		'U', clock_timestamp(), 'S') returning nr_sequencia into current_setting('pls_imp_farmacia_pck.nr_seq_lote_conta_w')::pls_lote_protocolo_conta.nr_sequencia%type;

	insert into pls_protocolo_conta(  nr_sequencia, dt_atualizacao_nrec, dt_atualizacao,
			nm_usuario_nrec, nm_usuario, cd_estabelecimento,
		dt_mes_competencia, ie_situacao, ie_status,
		ie_tipo_protocolo, cd_prestador, ie_tipo_guia,
		nr_seq_lote_conta, dt_recebimento, ie_origem_protocolo,
		cd_prestador_imp, nr_seq_prestador, nr_seq_prestador_imp,
		dt_protocolo, ie_fornec_direto
            )
	values (  nextval('pls_protocolo_conta_seq'), clock_timestamp(), clock_timestamp(),
			nm_usuario_p, nm_usuario_p, cd_estabelecimento_p,
			clock_timestamp(), 'I', 1,
			'C', current_setting('pls_imp_farmacia_pck.cd_codigo_prest_w')::pls_conta.cd_prestador_exec_imp%type, '4',
			current_setting('pls_imp_farmacia_pck.nr_seq_lote_conta_w')::pls_lote_protocolo_conta.nr_sequencia%type, clock_timestamp(), 'F',
			current_setting('pls_imp_farmacia_pck.cd_codigo_prest_w')::pls_conta.cd_prestador_exec_imp%type, current_setting('pls_imp_farmacia_pck.nr_seq_prestador_imp_w')::pls_prestador.nr_sequencia%type, current_setting('pls_imp_farmacia_pck.nr_seq_prestador_imp_w')::pls_prestador.nr_sequencia%type,
			clock_timestamp(), 'S'
      ) returning nr_sequencia into current_setting('pls_imp_farmacia_pck.nr_seq_protocolo_w')::pls_protocolo_conta.nr_sequencia%type;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_imp_farmacia_pck.gerar_protocolo_arquivo ( ds_conteudo_p text, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type ) FROM PUBLIC;
