-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_imp_farmacia_pck.inserir_conta (ds_conteudo_p text, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nr_seq_conta_gerada_p INOUT pls_conta.nr_sequencia%type) AS $body$
DECLARE


cd_carteirinha_w  		varchar(9);
nr_seq_segurado_w  		pls_segurado.nr_sequencia%type;
cd_doenca_w    			pls_diagnostico_conta.cd_doenca%type;
nm_segurado_imp_w		pls_conta.nm_segurado_imp%type;
nr_seq_tipo_atendimento_w	pls_tipo_atendimento.nr_sequencia%type;


BEGIN

  cd_carteirinha_w   := substr(ds_conteudo_p, 2, 9);
  cd_doenca_w      := trim(both substr(ds_conteudo_p, 76, 5));

  select  max(a.nr_sequencia)
  into STRICT  nr_seq_segurado_w
  from  pls_segurado a,
    pls_segurado_carteira b
  where  a.nr_sequencia = b.nr_seq_segurado
  and  b.cd_usuario_plano = trim(both cd_carteirinha_w);

	select max(nr_sequencia)
	into STRICT nr_seq_tipo_atendimento_w
	from pls_tipo_atendimento
	where ie_situacao = 'A'
	and cd_tiss = '30';

	nm_segurado_imp_w	:= substr(pls_obter_dados_segurado(nr_seq_segurado_w,'N'),1,255);

    insert into pls_conta(  nr_sequencia, ie_status, dt_atualizacao,
        nm_usuario, dt_atualizacao_nrec, nm_usuario_nrec,
        cd_estabelecimento, nr_seq_segurado, ie_tipo_guia,
        nr_seq_protocolo, ie_origem_conta, cd_prestador_exec_imp,
		nr_seq_prestador_exec, nr_Seq_prestador_exec_imp, nm_prestador_imp,
		nm_segurado_imp, nr_seq_tipo_atendimento)

    values ( nextval('pls_conta_seq'), 'U', clock_timestamp(),
        nm_usuario_p, clock_timestamp(), nm_usuario_p,
        cd_estabelecimento_p,  nr_seq_segurado_w,'4',
        current_setting('pls_imp_farmacia_pck.nr_seq_protocolo_w')::pls_protocolo_conta.nr_sequencia%type, 'F', current_setting('pls_imp_farmacia_pck.cd_codigo_prest_w')::pls_conta.cd_prestador_exec_imp%type,
		current_setting('pls_imp_farmacia_pck.nr_seq_prestador_imp_w')::pls_prestador.nr_sequencia%type, current_setting('pls_imp_farmacia_pck.nr_seq_prestador_imp_w')::pls_prestador.nr_sequencia%type, current_setting('pls_imp_farmacia_pck.nm_prestador_imp_w')::pls_conta.nm_prestador_imp%type,
		nm_segurado_imp_w, nr_seq_tipo_atendimento_w
        )returning nr_sequencia into nr_seq_conta_gerada_p;

  CALL pls_conta_tiss_pck.criar_registro(  nr_seq_conta_gerada_p,
            cd_estabelecimento_p,
            null,
            null,
            null,
            null,
            null,
            null,
            nm_usuario_p);


    if (cd_doenca_w IS NOT NULL AND cd_doenca_w::text <> '') then
      insert into pls_diagnostico_conta(  nr_sequencia, nr_seq_conta, nm_usuario,
                      nm_usuario_nrec, dt_atualizacao, dt_atualizacao_nrec,
                      cd_doenca, cd_doenca_imp
                      ) values (  nextval('pls_diagnostico_conta_seq'), nr_seq_conta_gerada_p, nm_usuario_p,
                            nm_usuario_p, clock_timestamp(), clock_timestamp(),
                            cd_doenca_w, cd_doenca_w);
    end if;


END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_imp_farmacia_pck.inserir_conta (ds_conteudo_p text, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nr_seq_conta_gerada_p INOUT pls_conta.nr_sequencia%type) FROM PUBLIC;
