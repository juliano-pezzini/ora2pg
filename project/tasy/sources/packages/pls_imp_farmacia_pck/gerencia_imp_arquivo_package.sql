-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_imp_farmacia_pck.gerencia_imp_arquivo ( nm_arquivo_p text, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nr_seq_lote_p INOUT pls_lote_protocolo_conta.nr_sequencia%type) AS $body$
DECLARE


ds_conteudo_w    varchar(4000);
ds_erro_w      varchar(4000);
ie_leitura_w    boolean := true;
nr_seq_protocolo_ret_w pls_protocolo_conta.nr_sequencia%type;
nr_linha_w      bigint;


BEGIN

-- Abre UTL FiLE pra leitura

CALL pls_utl_file_pck.nova_leitura(31, nm_arquivo_p);
nr_linha_w := 0;
while(ie_leitura_w) loop

  -- Ler a linha do arquivo

  SELECT * FROM pls_utl_file_pck.ler( ds_conteudo_w, ie_leitura_w) INTO STRICT  ds_conteudo_w, ie_leitura_w;

  nr_linha_w := nr_linha_w + 1;

  if ( ie_leitura_w ) then

    begin

      CALL pls_imp_farmacia_pck.gerar_insercao_conta( ds_conteudo_w, nm_usuario_p, cd_estabelecimento_p );

    exception
      when others then
        -- Pega a mensagem de erro

        ds_erro_w := substr(sqlerrm || pls_util_pck.enter_w || 'Error Back Trace: ' || dbms_utility.format_error_backtrace, 1, 4000);

        -- Fecha o arquivo antes de sair da rotina

        CALL pls_utl_file_pck.fechar_arquivo();

        -- Devolve a mensagem na tela, e para todo o processamento

        CALL wheb_mensagem_pck.exibir_mensagem_abort(ds_erro_w);
    end;

  end if;

end loop;

  -- Fecha o arquivo antes de sair da rotina

  CALL pls_utl_file_pck.fechar_arquivo();

  CALL pls_imp_farmacia_pck.atualiza_informacoes_contas(current_setting('pls_imp_farmacia_pck.nr_seq_protocolo_w')::pls_protocolo_conta.nr_sequencia%type);

  commit;

  nr_seq_lote_p := current_setting('pls_imp_farmacia_pck.nr_seq_lote_conta_w')::pls_lote_protocolo_conta.nr_sequencia%type;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_imp_farmacia_pck.gerencia_imp_arquivo ( nm_arquivo_p text, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nr_seq_lote_p INOUT pls_lote_protocolo_conta.nr_sequencia%type) FROM PUBLIC;
