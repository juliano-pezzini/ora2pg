-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE telematic_json_pck.carregar_dados_atestado ( nr_sequencia_p ATESTADO_PACIENTE.NR_SEQUENCIA%type ) AS $body$
BEGIN

SELECT	f.DS_CONVENIO 											DS_CONVENIO,
		f.DS_NOME 												PATIENT_NAME,
		f.DS_SOBRENOME 											FAMILY_NAME,
		f.DS_CIDADE 											PATIENT_CITY,
		TO_DATE(f.DT_NASCIMENTO, 'DD.MM.YYYY')					DT_NASCIMENTO,
		f.CD_USUARIO_CONV 										CD_USUARIO_CONV,
		LPAD(coalesce(f.CD_CNES, '0'), '9', '0')						CD_CNES,
		LPAD(COALESCE(OBTER_ASV_TEAM(f.NR_ATENDIMENTO),
				(SELECT MAX(h.NR_BSNR)
				FROM 	MEDICO_ESPEC_BSNR h 
				WHERE 	h.CD_PESSOA_FISICA = d.CD_MEDICO 
				AND 	CD_ESPECIALIDADE = d.NR_RQE), '0'
			), '9', '0') 										CD_ESTAB,
		(SELECT coalesce(MAX(i.NR_RQE), '00')
		FROM    MEDICO_ESPECIALIDADE i
		WHERE   i.CD_ESPECIALIDADE = d.NR_RQE
		AND     i.CD_PESSOA_FISICA = d.CD_MEDICO) 				NR_CRM,
		d.DT_LIBERACAO 											DT_REFERENCIA,
		CASE WHEN d.IE_TIPO_ATESTADO='E' THEN  'ERST' WHEN d.IE_TIPO_ATESTADO='F' THEN  'FOLGE'  ELSE '' END 							IE_TIPO_ATESTADO,
		CASE WHEN d.IE_SEQUELA_ACIDENTE='S' THEN  '2'  ELSE '' END 				IE_SEQUELA,
		CASE WHEN d.IE_ACIDENTE_TRABALHO='S' THEN  'd_arzt'  ELSE '' END  		IE_ACIDENTE,
		d.DT_ATESTADO 											DT_ATESTADO,
		d.DT_AUSENCIA_TRABALHO 									DT_AUSENCIA,
		d.DT_DIAGNOSTICADO 										DT_DIAGNOSTICADO,
		coalesce(GET_PERSONAL_TITLE(c.NR_SEQ_FORMA_TRAT, 'T'), 'Dr.')PRACTITIONERTITLE,
		g.DS_GIVEN_NAME 										PRACTITIONERGIVENNAME,
		g.DS_FAMILY_NAME 										PRACTITIONERLASTNAME,
		coalesce(OBTER_ESPECIALIDADE_MEDICO(c.CD_PESSOA_FISICA, 'D'), GET_MEDIC_SPECIALITY_DEGRESS(c.CD_PESSOA_FISICA)) DS_ESP_MEDICO,
		e.DS_RAZAO_SOCIAL 										DS_RAZAO_SOCIAL,
		e.DS_ENDERECO 											DS_ENDE_EMPR,
		e.DS_MUNICIPIO 											DS_MUNC_EMPR,
		e.NR_TELEFONE 											NR_TELEFONE,
		(SELECT MAX(ab.DS_ENDERECO)
		FROM COMPL_PESSOA_FISICA ab
		WHERE ab.CD_PESSOA_FISICA = b.CD_PESSOA_FISICA) 		PATIENTSTREETNAME,
		(SELECT MAX(ab.NR_ENDERECO)
		FROM COMPL_PESSOA_FISICA ab
		WHERE ab.CD_PESSOA_FISICA = b.CD_PESSOA_FISICA) 		PATIENTNUMBER,
		(SELECT MAX(ab.CD_CEP)
		FROM COMPL_PESSOA_FISICA ab
		WHERE ab.CD_PESSOA_FISICA = b.CD_PESSOA_FISICA) 		PATIENTPOSTALCODE,
		d.DT_ATUALIZACAO										BUNDLELASTUPDATED,
        d.DS_OUTRO                                              DS_OTHER_MEDICAL_CERT
BULK COLLECT INTO STRICT current_setting('telematic_json_pck.tb_atestados_w')::tp_atestados
FROM	ATENDIMENTO_PACIENTE 	a,
		PESSOA_FISICA 			b,
		PESSOA_FISICA 			c,
		ATESTADO_PACIENTE 		d,
		KV_FORM_STAMP_V 		e,
		KV_FORM_HEADER_V 		f,
		PERSON_NAME 			g
WHERE	b.CD_PESSOA_FISICA 		= a.CD_PESSOA_FISICA
AND 	c.CD_PESSOA_FISICA 		= d.CD_MEDICO
AND 	c.NR_SEQ_PERSON_NAME 	= g.NR_SEQUENCIA
AND 	a.NR_ATENDIMENTO 		= d.NR_ATENDIMENTO
AND 	d.NR_ATENDIMENTO 		= f.NR_ATENDIMENTO
AND   	a.NR_ATENDIMENTO 		= f.NR_ATENDIMENTO
AND 	UPPER(g.DS_TYPE)		= 'MAIN'
AND 	d.NR_SEQUENCIA 			= nr_sequencia_p;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE telematic_json_pck.carregar_dados_atestado ( nr_sequencia_p ATESTADO_PACIENTE.NR_SEQUENCIA%type ) FROM PUBLIC;
