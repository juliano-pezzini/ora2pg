-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pls_compare_cred_cnes_pck.validar_estabelecimento ( nr_seq_credenciamento_p pls_creden_prestador.nr_sequencia%type, ie_tipo_validacao_p text) RETURNS SETOF T_COMPARACAO AS $body$
DECLARE

t_comparacao_row_w t_comparacao_row;
nr_contador     integer;

C01 CURSOR FOR
    SELECT  CD_CNES,
            DS_RAZAO_SOCIAL,
            NM_FANTASIA,
            NR_CNPJ,
            DS_COMPLEMENTO,
            DS_BAIRRO,
            CD_CEP,
            CD_MUNICIPIO_IBGE,
            DS_MUNICIPIO,
            SG_ESTADO,
            DS_LATITUDE,
            DS_LONGITUDE,
            NR_SEQ_CNES_API_ESTAB,
            CD_ESTABELECIMENTO,
            NR_SEQUENCIA
    from PLS_CREDEN_PRESTADOR
    where nr_sequencia = nr_seq_credenciamento_p;

C02 CURSOR(p_nr_seq_cnes_api_estab bigint) FOR
SELECT
        CD_CNES,
        DS_RAZAO_SOCIAL,
        NM_FANTASIA,
        NR_CNPJ,
        DS_COMPLEMENTO,
        DS_BAIRRO,
        CD_CEP,
        CD_MUNICIPIO_IBGE,
        DS_MUNICIPIO,
        SG_ESTADO,
        DS_LATITUDE,
        DS_LONGITUDE
from    CNES_API_ESTABELECIMENTO
where   nr_sequencia = p_nr_seq_cnes_api_estab;

-- Leitos
C03 CURSOR( p_nr_seq_credenciamento bigint) FOR
SELECT
        IE_LEITO,
        QT_LEITO,
        QT_LEITO_SUS
from    PLS_CRED_PREST_LEITO
where   NR_SEQ_CREDENCIAMENTO = p_nr_seq_credenciamento;

C04 CURSOR( p_nr_seq_cnes_api_estab bigint,
            p_ie_leito bigint) FOR
SELECT IE_LEITO,
       QT_LEITO,
       QT_LEITO_SUS
  from CNES_API_LEITOS
 where IE_LEITO = p_ie_leito
 and   NR_SEQ_ESTABELECIMENTO = p_nr_seq_cnes_api_estab;

-- Compara leitos do Credenciamento - CNES
C05 CURSOR( p_nr_seq_credenciamento bigint,
            p_nr_seq_cnes_api_estab bigint) FOR
SELECT IE_LEITO
  from PLS_CRED_PREST_LEITO
 where NR_SEQ_CREDENCIAMENTO = p_nr_seq_credenciamento
EXCEPT
select IE_LEITO
  from CNES_API_LEITOS
 where NR_SEQ_ESTABELECIMENTO = p_nr_seq_cnes_api_estab;

-- Compara leitos do CNES - Credenciamento
C06 CURSOR( p_nr_seq_credenciamento bigint,
            p_nr_seq_cnes_api_estab bigint) FOR
SELECT IE_LEITO
  from CNES_API_LEITOS
 where NR_SEQ_ESTABELECIMENTO = p_nr_seq_cnes_api_estab
EXCEPT
select IE_LEITO
  from PLS_CRED_PREST_LEITO
 where NR_SEQ_CREDENCIAMENTO = p_nr_seq_credenciamento;

-- Equipamentos
C07 CURSOR( p_nr_seq_credenciamento bigint) FOR
SELECT
        IE_TIPO_EQUIPAMENTO,
        IE_EQUIPAMENTO,
        QT_EQUIPAMENTO,
        QT_EQUIPAMENTO_USO,
        IE_DISPONIVEL_SUS
from PLS_CRED_PREST_EQUIPAMENTO
where   nr_seq_credenciamento = p_nr_seq_credenciamento;

C08 CURSOR( p_nr_seq_cnes_api_estab bigint,
            p_ie_tipo_equipamento   bigint,
            p_ie_equipamento        bigint) FOR
SELECT
        IE_TIPO_EQUIPAMENTO,
        IE_EQUIPAMENTO,
        QT_EQUIPAMENTO,
        QT_EQUIPAMENTO_USO,
        IE_DISPONIVEL_SUS
from CNES_API_EQUIPAMENTOS
where ie_equipamento = p_ie_equipamento
and   ie_tipo_equipamento = p_ie_tipo_equipamento
and   nr_seq_estabelecimento = p_nr_seq_cnes_api_estab;

-- Compara Equipamentos do Credenciamento - CNES
C09 CURSOR( p_nr_seq_credenciamento bigint,
            p_nr_seq_cnes_api_estab bigint) FOR
SELECT
        IE_TIPO_EQUIPAMENTO,
        IE_EQUIPAMENTO
from PLS_CRED_PREST_EQUIPAMENTO
where   nr_seq_credenciamento = p_nr_seq_credenciamento
EXCEPT
select
        IE_TIPO_EQUIPAMENTO,
        IE_EQUIPAMENTO
from CNES_API_EQUIPAMENTOS
where nr_seq_estabelecimento = p_nr_seq_cnes_api_estab;

-- Compara Equipamentos do CNES - Credenciamento
C10 CURSOR( p_nr_seq_credenciamento bigint,
            p_nr_seq_cnes_api_estab bigint) FOR
SELECT
        IE_TIPO_EQUIPAMENTO,
        IE_EQUIPAMENTO
from CNES_API_EQUIPAMENTOS
where nr_seq_estabelecimento = p_nr_seq_cnes_api_estab
EXCEPT
select
        IE_TIPO_EQUIPAMENTO,
        IE_EQUIPAMENTO
from PLS_CRED_PREST_EQUIPAMENTO
where   nr_seq_credenciamento = p_nr_seq_credenciamento;

-- Profissionais
C11 CURSOR( p_nr_seq_credenciamento bigint) FOR
SELECT  NR_CPF,
        CD_CBO,
        NM_PESSOA
from    PLS_CRED_PREST_MED
where   nr_seq_credenciamento = p_nr_seq_credenciamento;

C12 CURSOR( p_nr_seq_cnes_api_estab bigint,
            p_nr_cpf                text,
            p_cd_cbo                text) FOR
SELECT count(1)
from    CNES_API_PROFISSIONAIS p,
        CNES_API_PROF_CBO c
where   c.nr_seq_profissional = p.nr_sequencia
and     c.cd_cbo = p_cd_cbo
and     p.nr_cpf = p_nr_cpf
and     p.nr_seq_estabelecimento = p_nr_seq_cnes_api_estab;
BEGIN
for c01_w in C01 loop
  if ie_tipo_validacao_p = 'C' then
      for c02_w in C02(c01_w.NR_SEQ_CNES_API_ESTAB) loop
        if c01_w.CD_CNES <> c02_w.CD_CNES then
            begin
            t_comparacao_row_w.ds_campo	:= obter_desc_expressao(326632,c01_w.CD_ESTABELECIMENTO);
            t_comparacao_row_w.ds_vl_creden	:= c01_w.CD_CNES;
            t_comparacao_row_w.ds_vl_cnes := c02_w.CD_CNES;
            RETURN NEXT t_comparacao_row_w;
            end;
        end if;
        if c01_w.DS_RAZAO_SOCIAL <> c02_w.DS_RAZAO_SOCIAL then
            begin
            t_comparacao_row_w.ds_campo	:= obter_desc_expressao(297241,c01_w.CD_ESTABELECIMENTO);
            t_comparacao_row_w.ds_vl_creden	:= c01_w.DS_RAZAO_SOCIAL;
            t_comparacao_row_w.ds_vl_cnes := c02_w.DS_RAZAO_SOCIAL;
            RETURN NEXT t_comparacao_row_w;
            end;
        end if;
        if c01_w.NM_FANTASIA <> c02_w.NM_FANTASIA then
            begin
            t_comparacao_row_w.ds_campo	:= obter_desc_expressao(646424,c01_w.CD_ESTABELECIMENTO);
            t_comparacao_row_w.ds_vl_creden	:= c01_w.NM_FANTASIA;
            t_comparacao_row_w.ds_vl_cnes := c02_w.NM_FANTASIA;
            RETURN NEXT t_comparacao_row_w;
            end;
        end if;
        if c01_w.NR_CNPJ <> c02_w.NR_CNPJ then
            begin
            t_comparacao_row_w.ds_campo	:= obter_desc_expressao(284833,c01_w.CD_ESTABELECIMENTO);
            t_comparacao_row_w.ds_vl_creden	:= c01_w.NR_CNPJ;
            t_comparacao_row_w.ds_vl_cnes := c02_w.NR_CNPJ;
            RETURN NEXT t_comparacao_row_w;
            end;
        end if;
        if c01_w.DS_COMPLEMENTO <> coalesce(c02_w.DS_COMPLEMENTO,'X') then
            begin
            t_comparacao_row_w.ds_campo	:= obter_desc_expressao(645226,c01_w.CD_ESTABELECIMENTO);
            t_comparacao_row_w.ds_vl_creden	:= c01_w.DS_COMPLEMENTO;
            t_comparacao_row_w.ds_vl_cnes := c02_w.DS_COMPLEMENTO;
            RETURN NEXT t_comparacao_row_w;
            end;
        end if;
        if c01_w.DS_BAIRRO <> c02_w.DS_BAIRRO then
            begin
            t_comparacao_row_w.ds_campo	:= obter_desc_expressao(795903,c01_w.CD_ESTABELECIMENTO);
            t_comparacao_row_w.ds_vl_creden	:= c01_w.DS_BAIRRO;
            t_comparacao_row_w.ds_vl_cnes := c02_w.DS_BAIRRO;
            RETURN NEXT t_comparacao_row_w;
            end;
        end if;
        if c01_w.CD_CEP <> c02_w.CD_CEP then
            begin
            t_comparacao_row_w.ds_campo	:= obter_desc_expressao(883399,c01_w.CD_ESTABELECIMENTO);
            t_comparacao_row_w.ds_vl_creden	:= c01_w.CD_CEP;
            t_comparacao_row_w.ds_vl_cnes := c02_w.CD_CEP;
            RETURN NEXT t_comparacao_row_w;
            end;
        end if;
        if c01_w.CD_MUNICIPIO_IBGE <> c02_w.CD_MUNICIPIO_IBGE then
            begin
            t_comparacao_row_w.ds_campo	:= obter_desc_expressao(645227,c01_w.CD_ESTABELECIMENTO);
            t_comparacao_row_w.ds_vl_creden	:= c01_w.CD_MUNICIPIO_IBGE;
            t_comparacao_row_w.ds_vl_cnes := c02_w.CD_MUNICIPIO_IBGE;
            RETURN NEXT t_comparacao_row_w;
            end;
        end if;
        if c01_w.DS_MUNICIPIO <> c02_w.DS_MUNICIPIO then
            begin
            t_comparacao_row_w.ds_campo	:= obter_desc_expressao(293659,c01_w.CD_ESTABELECIMENTO);
            t_comparacao_row_w.ds_vl_creden	:= c01_w.DS_MUNICIPIO;
            t_comparacao_row_w.ds_vl_cnes := c02_w.DS_MUNICIPIO;
            RETURN NEXT t_comparacao_row_w;
            end;
        end if;
        if c01_w.SG_ESTADO <> c02_w.SG_ESTADO then
            begin
            t_comparacao_row_w.ds_campo	:= obter_desc_expressao(642005,c01_w.CD_ESTABELECIMENTO);
            t_comparacao_row_w.ds_vl_creden	:= c01_w.SG_ESTADO;
            t_comparacao_row_w.ds_vl_cnes := c02_w.SG_ESTADO;
            RETURN NEXT t_comparacao_row_w;
            end;
        end if;
        if c01_w.DS_LATITUDE <> c02_w.DS_LATITUDE then
            begin
            t_comparacao_row_w.ds_campo	:= obter_desc_expressao(669724,c01_w.CD_ESTABELECIMENTO);
            t_comparacao_row_w.ds_vl_creden	:= c01_w.DS_LATITUDE;
            t_comparacao_row_w.ds_vl_cnes := c02_w.DS_LATITUDE;
            RETURN NEXT t_comparacao_row_w;
            end;
        end if;
        if c01_w.DS_LONGITUDE <> c02_w.DS_LONGITUDE then
            begin
            t_comparacao_row_w.ds_campo	:= obter_desc_expressao(669725,c01_w.CD_ESTABELECIMENTO);
            t_comparacao_row_w.ds_vl_creden	:= c01_w.DS_LONGITUDE;
            t_comparacao_row_w.ds_vl_cnes := c02_w.DS_LONGITUDE;
            RETURN NEXT t_comparacao_row_w;
            end;
        end if;

      end loop;
  elsif ie_tipo_validacao_p = 'L' then
    for c03_w in C03(c01_w.NR_SEQUENCIA) loop
        for c04_w in C04(   c01_w.NR_SEQ_CNES_API_ESTAB,
                            c03_w.IE_LEITO) loop
            if c03_w.QT_LEITO > c04_w.QT_LEITO then
                begin
                t_comparacao_row_w.ds_campo	:= obter_desc_expressao(1076905,c01_w.CD_ESTABELECIMENTO);
                t_comparacao_row_w.ds_vl_creden	:= c03_w.QT_LEITO;
                t_comparacao_row_w.ds_vl_cnes := c04_w.QT_LEITO;
                t_comparacao_row_w.ds_descricao := Obter_valor_dominio(10603, c03_w.IE_LEITO);
                RETURN NEXT t_comparacao_row_w;
                end;
            end if;
            if c03_w.QT_LEITO_SUS > c04_w.QT_LEITO_SUS then
                begin
                t_comparacao_row_w.ds_campo	:= obter_desc_expressao(1076907,c01_w.CD_ESTABELECIMENTO);
                t_comparacao_row_w.ds_vl_creden	:= c03_w.QT_LEITO_SUS;
                t_comparacao_row_w.ds_vl_cnes := c04_w.QT_LEITO_SUS;
                t_comparacao_row_w.ds_descricao := Obter_valor_dominio(10603, c03_w.IE_LEITO);
                RETURN NEXT t_comparacao_row_w;
                end;
            end if;
        end loop;
    end loop;
    for c05_w in C05(   c01_w.NR_SEQUENCIA,
                        c01_w.NR_SEQ_CNES_API_ESTAB) loop
        begin
        t_comparacao_row_w.ds_campo	:= obter_desc_expressao(1076911,c01_w.CD_ESTABELECIMENTO);
        t_comparacao_row_w.ds_vl_creden	:= null;
        t_comparacao_row_w.ds_vl_cnes := null;
        t_comparacao_row_w.ds_descricao := Obter_valor_dominio(10603, c05_w.IE_LEITO);
        RETURN NEXT t_comparacao_row_w;
        end;
    end loop;
    for c06_w in C06(   c01_w.NR_SEQUENCIA,
                        c01_w.NR_SEQ_CNES_API_ESTAB) loop
        begin
        t_comparacao_row_w.ds_campo	:= obter_desc_expressao(1076909,c01_w.CD_ESTABELECIMENTO);
        t_comparacao_row_w.ds_vl_creden	:= null;
        t_comparacao_row_w.ds_vl_cnes := null;
        t_comparacao_row_w.ds_descricao := Obter_valor_dominio(10603, c06_w.IE_LEITO);
        RETURN NEXT t_comparacao_row_w;
        end;
    end loop;
  elsif ie_tipo_validacao_p = 'E' then
    for c07_w in C07(c01_w.NR_SEQUENCIA) loop
        for c08_w in C08(   c01_w.NR_SEQ_CNES_API_ESTAB,
                            c07_w.IE_TIPO_EQUIPAMENTO,
                            c07_w.IE_EQUIPAMENTO) loop
            if c07_w.QT_EQUIPAMENTO <> c08_w.QT_EQUIPAMENTO then
                begin
                t_comparacao_row_w.ds_campo	:= obter_desc_expressao(1076947,c01_w.CD_ESTABELECIMENTO);
                t_comparacao_row_w.ds_vl_creden	:= c07_w.QT_EQUIPAMENTO;
                t_comparacao_row_w.ds_vl_cnes := c08_w.QT_EQUIPAMENTO;
                t_comparacao_row_w.ds_descricao := Obter_valor_dominio(10605, c07_w.IE_EQUIPAMENTO);
                RETURN NEXT t_comparacao_row_w;
                end;
            end if;
            if c07_w.QT_EQUIPAMENTO_USO <> c08_w.QT_EQUIPAMENTO_USO then
                begin
                t_comparacao_row_w.ds_campo	:= obter_desc_expressao(1076949,c01_w.CD_ESTABELECIMENTO);
                t_comparacao_row_w.ds_vl_creden	:= c07_w.QT_EQUIPAMENTO_USO;
                t_comparacao_row_w.ds_vl_cnes := c08_w.QT_EQUIPAMENTO_USO;
                t_comparacao_row_w.ds_descricao := Obter_valor_dominio(10605, c07_w.IE_EQUIPAMENTO);
                RETURN NEXT t_comparacao_row_w;
                end;
            end if;
            if c07_w.IE_DISPONIVEL_SUS <> c08_w.IE_DISPONIVEL_SUS then
                begin
                t_comparacao_row_w.ds_campo	:= obter_desc_expressao(1076957,c01_w.CD_ESTABELECIMENTO);
                t_comparacao_row_w.ds_vl_creden	:= c07_w.IE_DISPONIVEL_SUS;
                t_comparacao_row_w.ds_vl_cnes := c08_w.IE_DISPONIVEL_SUS;
                t_comparacao_row_w.ds_descricao := Obter_valor_dominio(10605, c08_w.IE_EQUIPAMENTO);
                RETURN NEXT t_comparacao_row_w;
                end;
            end if;
        end loop;
    end loop;
    for c09_w in C09(   c01_w.NR_SEQUENCIA,
                        c01_w.NR_SEQ_CNES_API_ESTAB) loop
        begin
        t_comparacao_row_w.ds_campo	:= obter_desc_expressao(1076953,c01_w.CD_ESTABELECIMENTO);
        t_comparacao_row_w.ds_vl_creden	:= null;
        t_comparacao_row_w.ds_vl_cnes := null;
        t_comparacao_row_w.ds_descricao := Obter_valor_dominio(10605, c09_w.IE_EQUIPAMENTO);
        RETURN NEXT t_comparacao_row_w;
        end;
    end loop;
    for c10_w in C10(   c01_w.NR_SEQUENCIA,
                        c01_w.NR_SEQ_CNES_API_ESTAB) loop
        begin
        t_comparacao_row_w.ds_campo	:= obter_desc_expressao(1076951,c01_w.CD_ESTABELECIMENTO);
        t_comparacao_row_w.ds_vl_creden	:= null;
        t_comparacao_row_w.ds_vl_cnes := null;
        t_comparacao_row_w.ds_descricao := Obter_valor_dominio(10605, c10_w.IE_EQUIPAMENTO);
        RETURN NEXT t_comparacao_row_w;
        end;
    end loop;

  elsif ie_tipo_validacao_p = 'P' then
    for c11_w in C11(c01_w.NR_SEQUENCIA) loop
        open C12(   c01_w.NR_SEQ_CNES_API_ESTAB,
                    c11_w.NR_CPF,
                    c11_w.CD_CBO);
        fetch C12 into nr_contador;
        close C12;
        if coalesce(nr_contador,0) = 0 then
            begin
            t_comparacao_row_w.ds_campo	:= obter_desc_expressao(1076969,c01_w.CD_ESTABELECIMENTO);
            t_comparacao_row_w.ds_vl_creden	:= null;
            t_comparacao_row_w.ds_vl_cnes := null;
            t_comparacao_row_w.ds_descricao := c11_w.NM_PESSOA;
            t_comparacao_row_w.ds_cpf := c11_w.NR_CPF;
            t_comparacao_row_w.ds_cbo := c11_w.CD_CBO;
            RETURN NEXT t_comparacao_row_w;
            end;
        end if;
        nr_contador := 0;
    end loop;
  end if;
end loop;
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_compare_cred_cnes_pck.validar_estabelecimento ( nr_seq_credenciamento_p pls_creden_prestador.nr_sequencia%type, ie_tipo_validacao_p text) FROM PUBLIC;
