-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE sncm_controle_mat_pck.obter_retorno (nr_seq_lote_p controle_mat_lote.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE

				
	nr_seq_arquivo_xml_w	controle_mat_arquivo.nr_sequencia%type;
	ds_arquivo_xml_w	text;
	nr_seq_mat_arq_w	controle_mat_arquivo.nr_sequencia%type;
	qt_tamanho_w		integer;
	qt_retorno_w		integer;
				
	c01 CURSOR(	nr_seq_lote_pc	 controle_mat_lote.nr_sequencia%type ) FOR
		SELECT	nr_sequencia nr_seq_arquivo
		from	controle_mat_arquivo
		where	nr_seq_lote = nr_seq_lote_pc;
		
	c02 CURSOR(	ds_arquivo_xml_pc  xml ) FOR
		SELECT	ds_codigo,
			ds_efeito,
			ds_retorno
		from	xmltable('/retEvtIn/rets/ret' passing ds_arquivo_xml_pc columns
				ds_codigo varchar(255) path 'code',
				ds_efeito varchar(255) path 'effect',
				ds_retorno varchar(255) path 'desc');

	
BEGIN
	
	-- Pegar o retorno
	for c01_w in c01( nr_seq_lote_p ) loop
		select	max(nr_sequencia)
		into STRICT	nr_seq_arquivo_xml_w
		from	controle_mat_arq_xml
		where	nr_seq_arquivo = c01_w.nr_seq_arquivo
		and	ie_tipo_arquivo = 'R';
		
		if (nr_seq_arquivo_xml_w IS NOT NULL AND nr_seq_arquivo_xml_w::text <> '') then
			select	length(ds_arquivo_xml),
				substr(ds_arquivo_xml,1,4000),
				position('<retEvtIn>' in ds_arquivo_xml)
			into STRICT	qt_tamanho_w,
				ds_arquivo_xml_w,
				qt_retorno_w
			from	controle_mat_arq_xml
			where	nr_sequencia = nr_seq_arquivo_xml_w;
			
			-- Falhas tratadas pela ANVISA
			if (qt_tamanho_w <= 4000) and (qt_retorno_w > 0) then
				select	substr(substr(to_char(ds_arquivo_xml),1,position('</retEvtIn>' in to_char(ds_arquivo_xml))+10),
						position('<retEvtIn>' in to_char(ds_arquivo_xml)),length(ds_arquivo_xml))
				into STRICT	ds_arquivo_xml_w
				from	controle_mat_arq_xml
				where	nr_sequencia = nr_seq_arquivo_xml_w;
			
				if (ds_arquivo_xml_w IS NOT NULL AND ds_arquivo_xml_w::text <> '') then
					for c02_w in c02( xmlparse(DOCUMENT, convert_from(, 'utf-8')) ) loop
					
						if (c02_w.ds_codigo IS NOT NULL AND c02_w.ds_codigo::text <> '') then
							CALL sncm_controle_mat_pck.gravar_retorno(	nr_seq_arquivo_p => c01_w.nr_seq_arquivo,
												nm_usuario_p => nm_usuario_p,
												ds_codigo_p => c02_w.ds_codigo,
												ds_efeito_p => c02_w.ds_efeito,
												ds_retorno_p => c02_w.ds_retorno,
												ie_commit_p => 'N');
						end if;
					
					end loop;
				end if;
			-- Falhas de integracao/conexao/comunicacao 
			else
				CALL sncm_controle_mat_pck.gravar_retorno(	nr_seq_arquivo_p => c01_w.nr_seq_arquivo,
									nm_usuario_p => nm_usuario_p,
									ds_codigo_p => obter_desc_expressao(cd_expressao_p => 726446),
									ds_efeito_p => obter_desc_expressao(cd_expressao_p => 726446),
									ds_retorno_p => ds_arquivo_xml_w,
									ie_commit_p => 'N');
			end if;
		end if;
	end loop;
	
	update	controle_mat_arquivo a
	set	a.ie_status	= '2' -- Possui inconsistencias
	where	a.nr_seq_lote	= nr_seq_lote_p
	and	exists (SELECT	1
			from	controle_mat_arquivo_ret r,
				controle_mat_arquivo x
			where	x.nr_sequencia	= r.nr_seq_arquivo
			and	r.ds_efeito	in ('REJ','WNG','ERRO') -- Rejeitado / Advertencia / ERRO
			and	r.nr_seq_arquivo = a.nr_sequencia
			and	x.nr_seq_lote	= nr_seq_lote_p);

	update	controle_mat_arquivo a
	set	a.ie_status	= '3' -- Enviado com sucesso
	where	a.nr_seq_lote	= nr_seq_lote_p
	and	(a.dt_envio IS NOT NULL AND a.dt_envio::text <> '')
	and	exists (SELECT	1
			from	controle_mat_arquivo_ret r,
				controle_mat_arquivo x
			where	x.nr_sequencia	= r.nr_seq_arquivo
			and	r.ds_efeito	= 'SUC' -- Sucesso
			and	r.nr_seq_arquivo = a.nr_sequencia
			and	x.nr_seq_lote	= nr_seq_lote_p);
	
	select	max(a.nr_sequencia)
	into STRICT	nr_seq_mat_arq_w
	from	controle_mat_arquivo a
	where	a.nr_seq_lote = nr_seq_lote_p
	and	a.ie_status in ('1','2');

	update	controle_mat_lote
	set	dt_fim_envio	= clock_timestamp(),
		ie_status	= CASE WHEN nr_seq_mat_arq_w = NULL THEN '10'  ELSE '6' END , -- Arquivos enviados / Falha no envio
		nm_usuario	= nm_usuario_p,
		dt_atualizacao	= clock_timestamp()
	where	nr_sequencia	= nr_seq_lote_p;
	commit;
	
	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE sncm_controle_mat_pck.obter_retorno (nr_seq_lote_p controle_mat_lote.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;
