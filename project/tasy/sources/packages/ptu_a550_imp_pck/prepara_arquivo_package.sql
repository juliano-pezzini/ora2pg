-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE ptu_a550_imp_pck.prepara_arquivo (nr_sequencia_p ptu_aviso_arq_xml.nr_sequencia%type) AS $body$
DECLARE

arq_xml_w             text;
prefixo_w             varchar(10);
ie_tipo_arquivo_w     ptu_aviso_arq_xml.ie_tipo_arquivo%type;
arq_xml_aux_w         text;
ie_cabec_arquiv       varchar(10);
nr_pos_cabec          bigint;
nr_por_fecha          bigint;
cabec_w               varchar(500);
msg_erro_w            varchar(500);


BEGIN
commit;

select	ds_arquivo,
	ie_tipo_arquivo
into STRICT  	arq_xml_w,
	ie_tipo_arquivo_w
from	ptu_aviso_arq_xml
where	nr_sequencia = nr_sequencia_p;

-- identifica o tipo de arquivo

if 	ie_tipo_arquivo_w = 'A550' then
	ie_cabec_arquiv := 'ptuA550';
elsif 	ie_tipo_arquivo_w = 'A560' then
	ie_cabec_arquiv := 'ptuA560';
elsif 	ie_tipo_arquivo_w = 'A500' then
	ie_cabec_arquiv := 'ptuA500';
end if;

prefixo_w := ptu_a550_imp_pck.pls_busca_prefixo(nr_sequencia_p,ie_cabec_arquiv);

if (prefixo_w IS NOT NULL AND prefixo_w::text <> '') then
	-- retira o prefixo do arquivo

	arq_xml_w := ptu_a550_imp_pck.pls_clob_replace(arq_xml_w,':'||prefixo_w,'');
	arq_xml_w := ptu_a550_imp_pck.pls_clob_replace(arq_xml_w,prefixo_w||':','');
end if;

-- atualiza o arquivo sem prefixo

update   ptu_aviso_arq_xml
set   	ds_arquivo = arq_xml_w
where  	nr_sequencia = nr_sequencia_p;
commit;

select  ds_arquivo
into STRICT    arq_xml_w
from  	ptu_aviso_arq_xml
where	nr_sequencia = nr_sequencia_p;

nr_pos_cabec := dbms_lob.position(ie_cabec_arquiv in arq_xml_w);
nr_por_fecha := dbms_lob.instr(arq_xml_w, '>' ,nr_pos_cabec);
arq_xml_aux_w := arq_xml_w;

-- retira o cabecalho

cabec_w      := substr(arq_xml_aux_w,nr_por_fecha-nr_pos_cabec+2,nr_pos_cabec-1);
arq_xml_w    := ptu_a550_imp_pck.pls_clob_replace(arq_xml_w,cabec_w,'<'||ie_cabec_arquiv||'>');

-- atualiza o registro final antes da importacao

update   ptu_aviso_arq_xml
set   	ds_arquivo = arq_xml_w
where  nr_sequencia = nr_sequencia_p;

commit;

select	ds_arquivo
into STRICT  	arq_xml_w
from	ptu_aviso_arq_xml
where  	nr_sequencia = nr_sequencia_p;

arq_xml_w := ptu_a550_imp_pck.pls_clob_replace(arq_xml_w,'><','>'|| chr(13) || '<');

-- atualiza o registro final antes da importacao

update 	ptu_aviso_arq_xml
set 	ds_arquivo = arq_xml_w
where	nr_sequencia = nr_sequencia_p;

commit;

exception
       when others then
          msg_erro_w := sqlerrm;
          CALL wheb_mensagem_pck.exibir_mensagem_abort('prepara_arquivo'|| msg_erro_w);
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ptu_a550_imp_pck.prepara_arquivo (nr_sequencia_p ptu_aviso_arq_xml.nr_sequencia%type) FROM PUBLIC;
