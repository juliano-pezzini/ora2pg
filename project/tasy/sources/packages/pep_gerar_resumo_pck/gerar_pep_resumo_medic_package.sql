-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pep_gerar_resumo_pck.gerar_pep_resumo_medic () AS $body$
DECLARE


	ds_material_w			varchar(400);
	qt_dose_w			double precision;
	ds_intervalo_w			varchar(80);
	ds_unidade_medida_w		varchar(80);
	ds_unid_med_w			varchar(50);
	ds_diluicao_w			varchar(255);
	ie_suspenso_w			varchar(1);
	ds_horarios_w			varchar(2000);
	ds_observacao_w			varchar(255);
	ds_justificativa_w		varchar(255);
	ds_via_adm_w			varchar(255);

	C01 CURSOR FOR
	SELECT	substr(coalesce(c.ds_reduzida, c.ds_material),1,255),
		a.qt_dose,
		substr(obter_desc_unid_med(a.cd_unidade_medida),1,60),
		b.ds_intervalo || CASE WHEN a.ie_se_necessario='S' THEN ' - SN'  ELSE CASE WHEN a.ie_acm='S' THEN ' - ACM' END  END ,
		substr(a.ds_recomendacao,1,255),
		substr(a.ds_justificativa,1,255),
		substr(obter_via_aplicacao(a.ie_via_aplicacao,'D'),1,255)
	FROM material c, protocolo_medic_material a
LEFT OUTER JOIN intervalo_prescricao b ON (a.cd_intervalo = b.cd_intervalo)
WHERE a.cd_material	= c.cd_material and a.cd_protocolo	= cd_protocolo_w and a.nr_sequencia 	= nr_seq_medicacao_w and a.ie_agrupador	= 1;

	
BEGIN
	PERFORM set_config('pep_gerar_resumo_pck.ds_resumo_w', '', false);
	
	open C01;
	loop
	fetch C01 into	
		ds_material_w,
		qt_dose_w,
		ds_unidade_medida_w,
		ds_intervalo_w,
		ds_observacao_w,
		ds_justificativa_w,
		ds_via_adm_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin

		if (current_setting('pep_gerar_resumo_pck.ie_rtf_w')::varchar(1) = 'N') then
			PERFORM set_config('pep_gerar_resumo_pck.ds_resumo_w', substr(current_setting('pep_gerar_resumo_pck.ds_resumo_w')::text ||
					pep_gerar_resumo_pck.get_tr_html(ds_material_w, to_char(qt_dose_w) , ds_unidade_medida_w, ds_via_adm_w, ds_intervalo_w,null,6),1,30000), false);
							
			if (ds_observacao_w IS NOT NULL AND ds_observacao_w::text <> '') then
				PERFORM set_config('pep_gerar_resumo_pck.ds_resumo_w', substr(current_setting('pep_gerar_resumo_pck.ds_resumo_w')::text || pep_gerar_resumo_pck.get_tr_html_obs(ds_observacao_w),1,30000), false);
			end if;
			
			if (ds_justificativa_w IS NOT NULL AND ds_justificativa_w::text <> '') then
				PERFORM set_config('pep_gerar_resumo_pck.ds_resumo_w', substr(current_setting('pep_gerar_resumo_pck.ds_resumo_w')::text || pep_gerar_resumo_pck.get_tr_html_justif(ds_justificativa_w),1,30000), false);
			end if;				
							
		else
			PERFORM set_config('pep_gerar_resumo_pck.ds_resumo_w', substr(current_setting('pep_gerar_resumo_pck.ds_resumo_w')::text ||
					pep_gerar_resumo_pck.get_tr_rtf(ds_material_w, to_char(qt_dose_w) , ds_unidade_medida_w, ds_intervalo_w,null,null,6),1,30000), false);
		end if;
				
		end;
	end loop;
	close C01;
	
	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pep_gerar_resumo_pck.gerar_pep_resumo_medic () FROM PUBLIC;
