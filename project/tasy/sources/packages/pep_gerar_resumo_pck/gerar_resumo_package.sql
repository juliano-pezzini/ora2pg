-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pep_gerar_resumo_pck.gerar_resumo ( cd_protocolo_p bigint, nr_seq_medicacao_p bigint, ie_rtf_html_p text, nm_usuario_p text) AS $body$
DECLARE


	nr_sequencia_w			bigint;
	ds_protocolo_w			varchar(255);
    ds_tipo_protocolo_w		varchar(255);
    ds_medicamento_w		varchar(255);
    ds_solucao_desc_w		varchar(255);
    ds_descricao_w			varchar(255);
    ds_dose_w				varchar(255);
    ds_unidade_w			varchar(255);
    ds_intervalo_desc_w		varchar(255);
    ds_procedimento_desc_w	varchar(255);
    ds_recomendacao_desc_w	varchar(255);
	ds_resumo_desc_w		varchar(255);	
	ds_via_adm_w			varchar(255);
			
	
BEGIN

	PERFORM set_config('pep_gerar_resumo_pck.cd_protocolo_w', cd_protocolo_p, false);
	PERFORM set_config('pep_gerar_resumo_pck.nr_seq_medicacao_w', nr_seq_medicacao_p, false);
	PERFORM set_config('pep_gerar_resumo_pck.nm_usuario_w', nm_usuario_p, false);

	select	a.nm_protocolo,
		b.nm_medicacao
	into STRICT	current_setting('pep_gerar_resumo_pck.nm_protocolo_w')::varchar(255),
		current_setting('pep_gerar_resumo_pck.nm_medicacao_w')::varchar(255)
	from	protocolo a,
		protocolo_medicacao b
	where	a.cd_protocolo = current_setting('pep_gerar_resumo_pck.cd_protocolo_w')::bigint
	and	b.cd_protocolo = a.cd_protocolo
	and	b.nr_sequencia = current_setting('pep_gerar_resumo_pck.nr_seq_medicacao_w')::integer;


	Select substr(obter_desc_expressao(344742,'Descrição do protocolo'),1,255),
		   substr(obter_desc_expressao(695961,'Descrição do subtipo protocolo'),1,255),
		   substr(obter_desc_expressao(710353,'Medicamentos'),1,255),
		   substr(obter_desc_expressao(298694,'Soluções'),1,255),
		   substr(obter_desc_expressao(291705,'Descrição'),1,255),
		   substr(obter_desc_expressao(288220,'Dose'),1,255),
		   substr(obter_desc_expressao(300775,'Unidade de medida'),1,255),
		   substr(obter_desc_expressao(292190,'Intervalo'),1,255),
		   substr(obter_desc_expressao(305831,'Procedimentos / Exames'),1,255),
		   substr(obter_desc_expressao(297348,'Recomendações'),1,255),
		   substr(obter_desc_expressao(328907,'Resumo protocolo'),1,255),
		   substr(obter_desc_expressao(301661,'Via'),1,255)
	into STRICT   ds_protocolo_w,
		   ds_tipo_protocolo_w,
		   ds_medicamento_w,
		   ds_solucao_desc_w,
		   ds_descricao_w,
		   ds_dose_w,
		   ds_unidade_w,
		   ds_intervalo_desc_w,
		   ds_procedimento_desc_w,
		   ds_recomendacao_desc_w,
		   ds_resumo_desc_w,
		   ds_via_adm_w
	;
	


	if (ie_rtf_html_p = 'RTF') or (ie_rtf_html_p = 'HTML5') then
		begin
		PERFORM set_config('pep_gerar_resumo_pck.ie_rtf_w', 'N', false);
		PERFORM set_config('pep_gerar_resumo_pck.nl_w', chr(13) || chr(10), false);
		end;
	else
		begin
		PERFORM set_config('pep_gerar_resumo_pck.ie_rtf_w', 'S', false);
		PERFORM set_config('pep_gerar_resumo_pck.nl_w', '<br>', false);
		end;
	end if;
	PERFORM set_config('pep_gerar_resumo_pck.ds_resumo_ww', '<html>
		
				<head>
					<title>'||current_setting('pep_gerar_resumo_pck.nm_protocolo_w')::varchar(255)||' / '|| current_setting('pep_gerar_resumo_pck.nm_medicacao_w')::varchar(255)||'</title>
					<style>
					body {
						font-family: tahoma, arial, sans-serif;
						margin: 0;
						padding: 28px;
					}
					td {
						font-size: 1.3rem;
						padding: 8px 16px;
						width: auto;
					}
					h1 {
						border-bottom: 1px solid;
						padding-bottom: 16px;
					}
					html {
						font-size: 11px;
					}
					</style>
				</head>
				<body data-gr-c-s-loaded="true">
					<h1> '||ds_resumo_desc_w||' ('||current_setting('pep_gerar_resumo_pck.nm_protocolo_w')::varchar(255)||' / '|| current_setting('pep_gerar_resumo_pck.nm_medicacao_w')::varchar(255)||') </h1> <br>					
					
					<table align="center" border="0" cellpadding="5" cellspacing="0" width="100%" >', false);

	delete	FROM protocolo_medic_resumo
	where	cd_protocolo = current_setting('pep_gerar_resumo_pck.cd_protocolo_w')::bigint
	and	nr_seq_medicacao = current_setting('pep_gerar_resumo_pck.nr_seq_medicacao_w')::integer
	and	nm_usuario	= nm_usuario_p;
	
	CALL pep_gerar_resumo_pck.gerar_pep_desc_protocolo(ie_rtf_html_p);	
	
	
	if (current_setting('pep_gerar_resumo_pck.ds_resumo_w')::(text IS NOT NULL AND text::text <> '')) then
		PERFORM set_config('pep_gerar_resumo_pck.ds_resumo_ww', substr(current_setting('pep_gerar_resumo_pck.ds_resumo_ww')::text ||
			'	<tr>
					<td colspan="6">
						<b>'||ds_protocolo_w||'</b>
					</td>
				</tr>' || current_setting('pep_gerar_resumo_pck.nl_w')::varchar(255) || substr(current_setting('pep_gerar_resumo_pck.ds_resumo_w')::text,1,30000)  || current_setting('pep_gerar_resumo_pck.nl_w')::varchar(255),1,30000), false);
	end if;	
	
	CALL pep_gerar_resumo_pck.gerar_pep_desc_subprotocolo(ie_rtf_html_p);
	
	if (current_setting('pep_gerar_resumo_pck.ds_resumo_w')::(text IS NOT NULL AND text::text <> '')) then
		PERFORM set_config('pep_gerar_resumo_pck.ds_resumo_ww', substr(current_setting('pep_gerar_resumo_pck.ds_resumo_ww')::text ||
			'	<tr>
					<td colspan="6">
						<b>'||ds_tipo_protocolo_w||'</b>
					</td>
				</tr>' || current_setting('pep_gerar_resumo_pck.nl_w')::varchar(255) || substr(current_setting('pep_gerar_resumo_pck.ds_resumo_w')::text,1,30000)  || current_setting('pep_gerar_resumo_pck.nl_w')::varchar(255),1,30000), false);
	end if;
	
	
	CALL pep_gerar_resumo_pck.gerar_pep_resumo_medic();

	if (current_setting('pep_gerar_resumo_pck.ds_resumo_w')::(text IS NOT NULL AND text::text <> '')) then
		PERFORM set_config('pep_gerar_resumo_pck.ds_resumo_ww', substr(current_setting('pep_gerar_resumo_pck.ds_resumo_ww')::text ||
			'	<tr>
					<td colspan="6">
						<b>'||ds_medicamento_w||'</b>
					</td>
				</tr>
				<tr bgcolor="#E6E6E6">
					<td width="35%">
						'||ds_descricao_w||'
					</td>
					<td width="5%">
						'||ds_dose_w||'
					</td>
					<td width="5%">
						'||ds_unidade_w||'
					</td width="5%">
					<td width="5%">
						'||ds_via_adm_w||'
					</td>
					<td>
						'||ds_intervalo_desc_w||'
					</td width="5%">
					<td>					
					</td width="5%">	
				</tr> ' || current_setting('pep_gerar_resumo_pck.nl_w')::varchar(255) || current_setting('pep_gerar_resumo_pck.ds_resumo_w')::text  || current_setting('pep_gerar_resumo_pck.nl_w')::varchar(255),1,30000), false);
	end if;

	CALL pep_gerar_resumo_pck.gerar_pep_resumo_solucao();

	if (current_setting('pep_gerar_resumo_pck.ds_resumo_w')::(text IS NOT NULL AND text::text <> '')) then
		PERFORM set_config('pep_gerar_resumo_pck.ds_resumo_ww', substr(current_setting('pep_gerar_resumo_pck.ds_resumo_ww')::text ||
			'	<tr>
					<td colspan="6">
						<b>'||ds_solucao_desc_w||'</b>
					</td>
				</tr> 
				<tr bgcolor="#E6E6E6">
					<td width="70%" colspan="5">
						'||ds_descricao_w||'
					</td>				
				</tr> ' || current_setting('pep_gerar_resumo_pck.nl_w')::varchar(255) || current_setting('pep_gerar_resumo_pck.ds_resumo_w')::text  || current_setting('pep_gerar_resumo_pck.nl_w')::varchar(255),1,30000), false);
	end if;
	
	CALL pep_gerar_resumo_pck.gerar_pep_resumo_proc();
	
	if (current_setting('pep_gerar_resumo_pck.ds_resumo_w')::(text IS NOT NULL AND text::text <> '')) then
		PERFORM set_config('pep_gerar_resumo_pck.ds_resumo_ww', substr(current_setting('pep_gerar_resumo_pck.ds_resumo_ww')::text ||
			'	<tr>
					<td colspan="6">
						<b>'||ds_procedimento_desc_w||'</b>
					</td>
				</tr>
				<tr bgcolor="#E6E6E6">
					<td width="35%">
						'||ds_descricao_w||'
					</td>
					<td width="5%">
						'|| ds_intervalo_desc_w ||'
					</td>
					<td width="5%">
						'|| '' ||'
					</td width="5%">
					<td width="5%">
						'|| '' ||'
					</td>
					<td>
						'|| '' ||'
					</td width="5%">
					<td>					
					</td width="5%">	
				</tr> ' || current_setting('pep_gerar_resumo_pck.nl_w')::varchar(255) || current_setting('pep_gerar_resumo_pck.ds_resumo_w')::text  || current_setting('pep_gerar_resumo_pck.nl_w')::varchar(255),1,30000), false);
	end if;
	
	CALL pep_gerar_resumo_pck.gerar_pep_resumo_recomend();
	
	if (current_setting('pep_gerar_resumo_pck.ds_resumo_w')::(text IS NOT NULL AND text::text <> '')) then
		PERFORM set_config('pep_gerar_resumo_pck.ds_resumo_ww', substr(current_setting('pep_gerar_resumo_pck.ds_resumo_ww')::text ||
			'	<tr>
					<td colspan="6">
						<b>'||ds_recomendacao_desc_w||'</b>
					</td>
				</tr> 
				<tr bgcolor="#E6E6E6">
					<td width="70%" colspan="5">
						'||ds_descricao_w||'
					</td>					
				</tr> ' || current_setting('pep_gerar_resumo_pck.nl_w')::varchar(255) || current_setting('pep_gerar_resumo_pck.ds_resumo_w')::text  || current_setting('pep_gerar_resumo_pck.nl_w')::varchar(255),1,30000), false);
	end if;	
	
	PERFORM set_config('pep_gerar_resumo_pck.ds_resumo_ww', substr(current_setting('pep_gerar_resumo_pck.ds_resumo_ww')::text ||
		'				</table> '||
		'		</body>'||
		'</html>',1,30000), false);

	if (current_setting('pep_gerar_resumo_pck.ds_resumo_ww')::(text IS NOT NULL AND text::text <> '')) then
		select	nextval('protocolo_medic_resumo_seq')
		into STRICT	nr_sequencia_w
		
		;
		insert into protocolo_medic_resumo(
			nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			cd_protocolo,
			nr_seq_medicacao,
			ds_resumo)
		values (nr_sequencia_w,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			current_setting('pep_gerar_resumo_pck.cd_protocolo_w')::bigint,
			current_setting('pep_gerar_resumo_pck.nr_seq_medicacao_w')::integer,
			current_setting('pep_gerar_resumo_pck.ds_resumo_ww')::text);
	end if;
	
	
	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pep_gerar_resumo_pck.gerar_resumo ( cd_protocolo_p bigint, nr_seq_medicacao_p bigint, ie_rtf_html_p text, nm_usuario_p text) FROM PUBLIC;
