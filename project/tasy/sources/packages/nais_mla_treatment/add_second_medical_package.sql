-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE nais_mla_treatment.add_second_medical ( record_p medtreatmentinforedtyp, nr_seq_gasoterapia_p bigint, message_data INOUT text ) AS $body$
DECLARE

        record_w medtreatmentinforedtyp;
        medical_affair_code NAIS_CONVERSION_MASTER%rowtype;
        gassequencia_w bigint;
        start_date_w timestamp;
        end_date_w timestamp;
        amount_w numeric(20);
        check_diff_w numeric(20);
        dose_w numeric(20);
        dosage_w numeric(20);
        nr_seq_evento_w numeric(20);
        rv_first_w bigint;
        end_date_seq_w bigint;
        ie_evento_max_w varchar(2);
        rv_second_w bigint;
        rv_count_w bigint;
        i_first_w bigint;

BEGIN

--------------------DOSAGE CALCULATION-----------------------------
    begin
    select  max(nr_sequencia)                               
    into STRICT    nr_seq_evento_w                                 
    from    prescr_gasoterapia_evento
    where   nr_seq_gasoterapia = nr_seq_gasoterapia_p;
    exception when no_data_found then
    nr_seq_evento_w := null;
    end;

    begin
    select  ie_evento                                             
    into STRICT    ie_evento_max_w
    from    prescr_gasoterapia_evento 
    where   nr_sequencia = nr_seq_evento_w;
    exception when no_data_found then 
    ie_evento_max_w := null;
    end;

    begin
    select  max(nr_sequencia)
    into STRICT    rv_first_w 
    from    prescr_gasoterapia_evento
    where   ie_evento = 'RV'
    and     nr_seq_gasoterapia = nr_seq_gasoterapia_p;
    exception when no_data_found then 
    rv_first_w := null;
    end;

    begin   
    select  max(nr_sequencia) 
    into STRICT    end_date_seq_w 
    from    prescr_gasoterapia_evento 
    where   ie_evento = 'T'
    and     nr_seq_gasoterapia = nr_seq_gasoterapia_p;
    exception when no_data_found then
    end_date_seq_w := null;
    end;

    begin
    select  dt_evento
    into STRICT    end_date_w 
    from    prescr_gasoterapia_evento 
    where   nr_sequencia = end_date_seq_w;
    exception when no_data_found then 
    end_date_w := null;
    end;

    begin
    select  max(nr_sequencia) 
    into STRICT    rv_second_w 
    from    prescr_gasoterapia_evento                                                                        
    where   ie_evento = 'RV' 
    and     nr_seq_gasoterapia = nr_seq_gasoterapia_p 
    and     nr_sequencia < (SELECT  max(nr_sequencia) 
                            from    prescr_gasoterapia_evento 
                            where   ie_evento = 'RV' 
                            and     nr_seq_gasoterapia = nr_seq_gasoterapia_p);
    exception when no_data_found then
    rv_second_w := null;
    end;

    begin
    select  max(nr_sequencia)
    into STRICT    i_first_w 
    from    prescr_gasoterapia_evento 
    where   ie_evento = 'I'
    and     nr_seq_gasoterapia = nr_seq_gasoterapia_p;
    exception when no_data_found then
    i_first_w := null;
    end;

    select  count(ie_evento)
    into STRICT    rv_count_w 
    from    prescr_gasoterapia_evento
    where   ie_evento = 'RV' 
    and     nr_seq_gasoterapia = nr_seq_gasoterapia_p;

    if (ie_evento_max_w = 'RV' and rv_count_w > 1) then
        if (i_first_w > rv_second_w)then
            select  dt_evento
            into STRICT    start_date_w
            from    prescr_gasoterapia_evento 
            where   ie_evento = 'I' 
            and     nr_sequencia = i_first_w
            and     nr_seq_gasoterapia = nr_seq_gasoterapia_p;
        elsif (i_first_w < rv_second_w and end_date_seq_w > rv_second_w)then
            select  dt_evento
            into STRICT    start_date_w
            from    prescr_gasoterapia_evento
            where   ie_evento = 'RV' 
            and     nr_sequencia = rv_second_w
            and     nr_seq_gasoterapia = nr_seq_gasoterapia_p;
        end if;
    elsif (ie_evento_max_w = 'RV' and rv_count_w <= 1)then
        select  dt_evento
        into STRICT    start_date_w
        from    prescr_gasoterapia_evento
        where   ie_evento = 'I' 
        and     nr_sequencia = i_first_w
        and     nr_seq_gasoterapia = nr_seq_gasoterapia_p;
    end if;

    if (ie_evento_max_w = 'T' and rv_count_w >= 1)then
        if (i_first_w > rv_first_w)then
            select  dt_evento
            into STRICT    start_date_w
            from    prescr_gasoterapia_evento 
            where   ie_evento = 'I' 
            and     nr_sequencia = i_first_w
            and     nr_seq_gasoterapia = nr_seq_gasoterapia_p;
        elsif (i_first_w < rv_first_w)then
            select  dt_evento
            into STRICT    start_date_w
            from    prescr_gasoterapia_evento
            where   ie_evento = 'RV' 
            and     nr_sequencia = rv_first_w
            and     nr_seq_gasoterapia = nr_seq_gasoterapia_p;
        end if;
    elsif (ie_evento_max_w = 'T' and rv_count_w = 0)then
            select  dt_evento
            into STRICT    start_date_w
            from    prescr_gasoterapia_evento
            where   ie_evento = 'I' 
            and     nr_sequencia = i_first_w
            and     nr_seq_gasoterapia = nr_seq_gasoterapia_p;
    end if;

        check_diff_w := PKG_DATE_UTILS.get_DiffDate(start_date_w,end_date_w,'MINUTE');

        begin
        select  qt_gasoterapia
        into STRICT    amount_w
        from    prescr_gasoterapia_evento 
        where   ie_evento = 'I' 
        and     nr_sequencia = i_first_w
        and     nr_seq_gasoterapia = nr_seq_gasoterapia_p;
        exception when no_data_found then
        amount_w:= null;
		end;

        dose_w := check_diff_w * amount_w;

--------------------DOSAGE CALCULATION-----------------------------       
        begin
        select a.nr_seq_gas
        into STRICT gassequencia_w
        from cpoe_gasoterapia a,
        prescr_gasoterapia b 
        where b.nr_seq_gas_cpoe = a.nr_sequencia
        and b.nr_sequencia = nr_seq_gasoterapia_p;
        exception when no_data_found then
        gassequencia_w := null;
		end;

        
        PERFORM set_config('nais_mla_treatment.ds_line_w', null, false);
        record_w := record_p;
        medical_affair_code :=get_medicalaffair_code('PC','GAS','NR_SEQUENCIA',gassequencia_w);
        record_w.internal_code := medical_affair_code.CD_MEDICAL_AFFAIR;
        dosage_w := TRUNC(dose_w);
        record_w.dosage := dosage_w;
        record_w.unit := ' ';
        record_w.free_comments := ' ';
        CALL CALL CALL CALL nais_mla_treatment.common_med_treatment_info(record_w);
        message_data := current_setting('nais_mla_treatment.ds_line_w')::varchar(32767);
    END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE nais_mla_treatment.add_second_medical ( record_p medtreatmentinforedtyp, nr_seq_gasoterapia_p bigint, message_data INOUT text ) FROM PUBLIC;
