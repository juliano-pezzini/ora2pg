-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION cpoe_regular_disp_pck.get_regular_dates ( nr_seq_order_unit_p bigint, nr_seq_cpoe_rp_p bigint, cd_estabelecimento_p bigint, cd_setor_atendimento_p bigint, ie_via_aplicacao_p text, dt_start_p timestamp, dt_end_p timestamp, ie_start_end_p text) RETURNS SETOF T_CPOE_REGULAR_DISP_DATA AS $body$
DECLARE


linha_w		  t_cpoe_regular_disp_row;
dt_reference_w    timestamp := null;
dt_start_w        timestamp	:= null;
dt_end_w          timestamp	:= null;
dt_deadline_w     timestamp	:= null;
dt_start_prev_w	  timestamp;
dt_last_rule_w	timestamp	:= null;
qt_dispensation_days_w	CPOE_WEEK_DISPENS_RULE.qt_dispensation_days%type;


BEGIN

if (dt_start_p IS NOT NULL AND dt_start_p::text <> '' AND dt_end_p IS NOT NULL AND dt_end_p::text <> '') and (dt_end_p >= dt_start_p) then
	select	max(qt_dispensation_days)
	into STRICT	qt_dispensation_days_w
	from	CPOE_WEEK_DISPENS_RULE a;

	dt_reference_w	:= dt_start_p - qt_dispensation_days_w;
	
	while(dt_reference_w <= dt_end_p + qt_dispensation_days_w) loop
		linha_w.dt_start	:= null;
		linha_w.dt_end		:= null;

		cpoe_get_regular_rule(  dt_reference_w,
								cd_estabelecimento_p,
								cd_setor_atendimento_p,            
								ie_via_aplicacao_p,
								nr_seq_order_unit_p,
								nr_seq_cpoe_rp_p,
								dt_start_w,
								dt_end_w,
								dt_deadline_w);
	

		if (ie_start_end_p in ('START','BOTH')) and (dt_start_w > dt_last_rule_w or coalesce(dt_last_rule_w::text, '') = '') and (dt_start_w between dt_start_p and dt_end_p) then
			linha_w.dt_start := dt_start_w;
			
			if (ie_start_end_p = 'BOTH') then
				linha_w.dt_end := dt_end_w;
			end if;
			
			dt_last_rule_w	:= dt_start_w;
			
			RETURN NEXT linha_w;
		elsif (ie_start_end_p = 'END') and (dt_end_w > dt_last_rule_w or coalesce(dt_last_rule_w::text, '') = '') and (dt_end_w between dt_start_p and dt_end_p)then
			linha_w.dt_end := dt_end_w;
			
			dt_last_rule_w	:= dt_end_w;
			
			RETURN NEXT linha_w;
		end if;

		dt_reference_w	:= dt_reference_w + 1;
	end loop;
end if;

return;
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION cpoe_regular_disp_pck.get_regular_dates ( nr_seq_order_unit_p bigint, nr_seq_cpoe_rp_p bigint, cd_estabelecimento_p bigint, cd_setor_atendimento_p bigint, ie_via_aplicacao_p text, dt_start_p timestamp, dt_end_p timestamp, ie_start_end_p text) FROM PUBLIC;
