-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION report_ophthalmology_pck.get_data ( nr_seq_regra_form_p bigint) RETURNS SETOF T_OBJETO_ROW_DATA AS $body$
DECLARE


t_objeto_row_w					t_objeto_row;

report CURSOR FOR
	SELECT 	coalesce(b.nr_seq_apresent, 0) nr_seq_apresent,
				b.nr_sequencia,
				c.cd_classif_relat,
				c.cd_relatorio,
				c.cd_relatorio_wheb,
				b.qt_copia,
				b.ie_logo,
				report_ophthalmology_pck.get_ie_imprimir(nr_seq_regra_form_p,c.cd_relatorio,c.cd_relatorio_wheb) ie_imprimir,
				b.ie_configurar,
				b.ie_outputbin,
				c.ds_titulo,
				c.ie_etiqueta,
				c.nr_sequencia nr_seq_relatorio,
				a.cd_funcao,
				c.ds_sql,
				coalesce(b.ds_impressora, d.ds_impressora_padrao) ds_impressora,
				b.ie_gravar_log,
				b.ie_visualizar,
				b.ie_forma_impressao,
				c.cd_classif_relat_wheb,
				b.ie_apres_mensagem,
				coalesce(ie_frente_verso,'N') ie_frente_verso,
				coalesce(ie_visualiza_qrprinter,'N') ie_visualiza_qrprinter,
				b.ie_impressora_setor,
				c.ds_action_name
	FROM		relatorio c,
				relatorio_perfil b,
				perfil d,
				relatorio_funcao a
	WHERE 	b.nr_seq_relatorio = c.nr_sequencia
		AND	a.nr_seq_relatorio = c.nr_sequencia
		AND	a.cd_funcao = 3010
		AND	b.cd_perfil = wheb_usuario_pck.get_cd_perfil
		AND	d.cd_perfil = b.cd_perfil
		AND	coalesce(b.cd_estab,wheb_usuario_pck.get_cd_estabelecimento) = wheb_usuario_pck.get_cd_estabelecimento
		AND	C.cd_relatorio IN (	SELECT	e.Cd_relatorio
											FROM		RELATORIO e,
														OFT_FORMULARIO_RELATORIO f
											WHERE 	e.cd_relatorio = f.cd_relatorio
											AND		f.nr_seq_regra_form = nr_seq_regra_form_p
											AND		upper(e.cd_classif_relat) = 'WATE'
											AND		e.cd_classif_relat = c.cd_classif_relat
											
UNION

											SELECT 	g.Cd_relatorio
											FROM	RELATORIO e,
													OFT_FORMULARIO_RELATORIO f,
													RELATORIO g
											WHERE 	e.cd_relatorio 	   		  = f.cd_relatorio
											AND		UPPER(e.cd_classif_relat) = 'WATE'
											AND		g.cd_classif_relat  	  = c.cd_classif_relat
											AND		g.cd_relatorio_wheb 	  = e.cd_relatorio
											AND		f.NR_SEQ_REGRA_FORM 	  = nr_seq_regra_form_p)
	
UNION

	SELECT	0 nr_seq_apresent,
				0 nr_sequencia,
				c.cd_classif_relat,
				c.cd_relatorio,
				c.cd_relatorio_wheb,
				a.qt_copia,
				a.ie_logo,
				report_ophthalmology_pck.get_ie_imprimir(nr_seq_regra_form_p,c.cd_relatorio,c.cd_relatorio_wheb) ie_imprimir,
				CASE WHEN u.ie_configurar='S' THEN 'S'  ELSE a.ie_configurar END  ie_configurar,
				0 ie_outputbin,
				c.ds_titulo,
				c.ie_etiqueta,
				c.nr_sequencia nr_seq_relatorio,
				a.cd_funcao,
				c.ds_sql,
				'' ds_impressora,
				'N' ie_gravar_log,
				'N' ie_visualizar,
				'' ie_forma_impressao,
				c.cd_classif_relat_wheb,
				'N' ie_apres_mensagem,
				'N' ie_frente_verso,
				'N' ie_visualiza_qrprinter,
				'N' ie_impressora_setor,
				c.ds_action_name
	FROM		relatorio c,
				usuario_relatorio u,
				relatorio_funcao a
	WHERE 	a.nr_seq_relatorio = c.nr_sequencia
	AND	 	u.nr_seq_relatorio = c.nr_sequencia
	AND	 	a.ie_exige_perfil = 'S'
	AND	 	a.cd_funcao = 3010
	AND		u.nm_usuario_ref = wheb_usuario_pck.get_nm_usuario
	AND		NOT EXISTS (	SELECT 	1
									FROM		relatorio y
									WHERE 	y.cd_relatorio_wheb = c.cd_relatorio
									AND	 	SUBSTR(y.cd_classif_relat,1,2) = 'W')
	AND		C.cd_relatorio IN (	SELECT	e.Cd_relatorio
											FROM		RELATORIO e,
														OFT_FORMULARIO_RELATORIO f
											WHERE 	e.cd_relatorio = f.cd_relatorio
											AND		upper(e.cd_classif_relat) = 'WATE'
											AND		f.NR_SEQ_REGRA_FORM = nr_seq_regra_form_p
											
UNION

											SELECT 	g.Cd_relatorio
											FROM	RELATORIO e,
													OFT_FORMULARIO_RELATORIO f,
													RELATORIO g
											WHERE 	e.cd_relatorio 	   		  = f.cd_relatorio
											AND		UPPER(e.cd_classif_relat) = 'WATE'
											AND		g.cd_classif_relat  	  = c.cd_classif_relat
											AND		g.cd_relatorio_wheb 	  = e.cd_relatorio
											AND		f.NR_SEQ_REGRA_FORM 	  = nr_seq_regra_form_p)
	
UNION

	SELECT	0 nr_seq_apresent,
				0 nr_sequencia,
				c.cd_classif_relat,
				c.cd_relatorio,
				c.cd_relatorio_wheb,
				a.qt_copia,
				a.ie_logo,
				report_ophthalmology_pck.get_ie_imprimir(nr_seq_regra_form_p,c.cd_relatorio,c.cd_relatorio_wheb) ie_imprimir,
				a.ie_configurar,
				0 ie_outputbin,
				c.ds_titulo,
				c.ie_etiqueta,
				c.nr_sequencia nr_seq_relatorio,
				a.cd_funcao,
				c.ds_sql,
				'' ds_impressora,
				'N' ie_gravar_log,
				'N' ie_visualizar,
				'' ie_forma_impressao,
				c.cd_classif_relat_wheb,
				'N' ie_apres_mensagem,
				'N' ie_frente_verso,
				'N' ie_visualiza_qrprinter,
				'N' ie_impressora_setor,
				c.ds_action_name
	FROM		Relatorio c,
				relatorio_funcao a
	WHERE 	a.nr_seq_relatorio = c.nr_sequencia
	AND	a.cd_funcao  = 3010
	AND	a.ie_exige_perfil = 'N'
	AND	NOT EXISTS (	SELECT	1
								FROM		relatorio_perfil b
								WHERE 	b.nr_seq_relatorio = c.nr_sequencia
								AND		b.cd_perfil = wheb_usuario_pck.get_cd_perfil
								AND	 	coalesce(b.cd_estab,wheb_usuario_pck.get_cd_estabelecimento) = wheb_usuario_pck.get_cd_estabelecimento)
								AND		NOT EXISTS (SELECT	1
															FROM		relatorio y
															WHERE 	y.cd_relatorio_wheb = c.cd_relatorio
															AND	 	SUBSTR(y.cd_classif_relat,1,2) = 'W')
	AND	C.cd_relatorio IN (	SELECT	e.Cd_relatorio
										FROM		RELATORIO e,
													OFT_FORMULARIO_RELATORIO f
										WHERE 	e.cd_relatorio = f.cd_relatorio
										AND		upper(e.cd_classif_relat) = 'WATE'
										AND		f.NR_SEQ_REGRA_FORM = nr_seq_regra_form_p
										
UNION

										SELECT 	g.Cd_relatorio
											FROM	RELATORIO e,
													OFT_FORMULARIO_RELATORIO f,
													RELATORIO g
											WHERE 	e.cd_relatorio 	   		  = f.cd_relatorio
											AND		UPPER(e.cd_classif_relat) = 'WATE'
											AND		g.cd_classif_relat  	  = c.cd_classif_relat
											AND		g.cd_relatorio_wheb 	  = e.cd_relatorio
											AND		f.NR_SEQ_REGRA_FORM 	  = nr_seq_regra_form_p)
	ORDER BY 1,ds_titulo;

BEGIN

FOR c_report IN report LOOP
	BEGIN
	t_objeto_row_w.nr_seq_apresent			:=	c_report.nr_seq_apresent;
	t_objeto_row_w.nr_sequencia				:=	c_report.nr_sequencia;
	t_objeto_row_w.cd_classif_relat			:=	c_report.cd_classif_relat;
	t_objeto_row_w.cd_relatorio				:=	c_report.cd_relatorio;
	t_objeto_row_w.cd_relatorio_wheb			:=	c_report.cd_relatorio_wheb;
	t_objeto_row_w.qt_copia						:=	c_report.qt_copia;
	t_objeto_row_w.ie_logo						:=	c_report.ie_logo;
	t_objeto_row_w.ie_imprimir					:=	c_report.ie_imprimir;
	t_objeto_row_w.ie_configurar				:=	c_report.ie_configurar;
	t_objeto_row_w.ie_outputbin				:=	c_report.ie_outputbin;
	t_objeto_row_w.ds_titulo					:=	c_report.ds_titulo;
	t_objeto_row_w.ie_etiqueta					:=	c_report.ie_etiqueta;
	t_objeto_row_w.nr_seq_relatorio			:=	c_report.nr_sequencia;
	t_objeto_row_w.cd_funcao					:=	c_report.cd_funcao;
	t_objeto_row_w.ds_sql						:=	c_report.ds_sql;
	t_objeto_row_w.ds_impressora				:=	c_report.ds_impressora;
	t_objeto_row_w.ie_gravar_log				:=	c_report.ie_gravar_log;
	t_objeto_row_w.ie_visualizar				:=	c_report.ie_visualizar;
	t_objeto_row_w.ie_forma_impressao		:=	c_report.ie_forma_impressao;
	t_objeto_row_w.cd_classif_relat_wheb	:=	c_report.cd_classif_relat_wheb;
	t_objeto_row_w.ie_apres_mensagem			:=	c_report.ie_apres_mensagem;
	t_objeto_row_w.ie_frente_verso			:=	c_report.ie_frente_verso;
	t_objeto_row_w.ie_visualiza_qrprinter	:=	c_report.ie_visualiza_qrprinter;
	t_objeto_row_w.ie_impressora_setor		:=	c_report.ie_impressora_setor;
	t_objeto_row_w.ds_action_name 			:=	c_report.ds_action_name;
	RETURN NEXT t_objeto_row_w;
	END;
end loop;

RETURN;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION report_ophthalmology_pck.get_data ( nr_seq_regra_form_p bigint) FROM PUBLIC;
