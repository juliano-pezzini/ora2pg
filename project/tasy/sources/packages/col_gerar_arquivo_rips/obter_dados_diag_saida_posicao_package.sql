-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION col_gerar_arquivo_rips.obter_dados_diag_saida_posicao ( nr_atendimento_p atendimento_paciente.nr_atendimento%type ) RETURNS SETOF COL_GERAR_ARQUIVO_RIPS.TABLE_DIAG_DOENCA AS $body$
DECLARE

            cd_doenca_sec1_w              diagnostico_doenca.cd_doenca%TYPE;
            cd_doenca_sec2_w              diagnostico_doenca.cd_doenca%TYPE;
            cd_doenca_sec3_w              diagnostico_doenca.cd_doenca%TYPE;
            rips_diag_doenca_type         col_gerar_arquivo_rips.rips_diag_doenca_type;

        
BEGIN
            WITH diagnostico_doenca_secundario AS (
                SELECT      X.cd_doenca, row_number() OVER () AS linha
                    FROM    diagnostico_doenca X
                    WHERE   X.ie_classificacao_doenca = 'S'
                    AND     X.ie_diag_alta = 'S'
                    AND     X.ie_situacao = 'A'
                    AND     X.nr_atendimento = nr_atendimento_p
                    )
             SELECT (SELECT D.cd_doenca FROM diagnostico_doenca_secundario D WHERE D.linha = 1),
                    (SELECT D.cd_doenca FROM diagnostico_doenca_secundario D WHERE D.linha = 2),
                    (SELECT D.cd_doenca FROM diagnostico_doenca_secundario D WHERE D.linha = 3)
             INTO STRICT       cd_doenca_sec1_w,
                        cd_doenca_sec2_w,
                        cd_doenca_sec3_w
;

            rips_diag_doenca_type.cd_doenca_diag_secundario1 := cd_doenca_sec1_w;
            rips_diag_doenca_type.cd_doenca_diag_secundario2 := coalesce(cd_doenca_sec2_w, rips_diag_doenca_type.cd_doenca_diag_secundario1);
            rips_diag_doenca_type.cd_doenca_diag_secundario3 := COALESCE(cd_doenca_sec3_w, rips_diag_doenca_type.cd_doenca_diag_secundario2);

             RETURN NEXT rips_diag_doenca_type;
            RETURN;
    END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION col_gerar_arquivo_rips.obter_dados_diag_saida_posicao ( nr_atendimento_p atendimento_paciente.nr_atendimento%type ) FROM PUBLIC;
