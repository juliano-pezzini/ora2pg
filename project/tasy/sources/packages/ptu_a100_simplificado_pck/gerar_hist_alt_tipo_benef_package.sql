-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE ptu_a100_simplificado_pck.gerar_hist_alt_tipo_benef ( nr_seq_segurado_p pls_segurado.nr_sequencia%type, dt_compartilhamento_p pls_segurado_repasse.dt_repasse%type, ie_tipo_segurado_p pls_segurado.ie_tipo_segurado%type, ie_gerou_historico_p INOUT text) AS $body$
DECLARE

	ie_tipo_segurado_ant_w		pls_segurado.ie_tipo_segurado%type;
	qt_historico_102_benef_w	integer;
	ie_alterou_w			varchar(1);
	
	
BEGIN
	select	count(1)
	into STRICT	qt_historico_102_benef_w
	from	pls_segurado_historico
	where	nr_seq_segurado = nr_seq_segurado_p
	and	ie_tipo_historico = '102'
	and	trunc(dt_ocorrencia_sib, 'dd') = dt_compartilhamento_p
	and	ie_tipo_segurado = ie_tipo_segurado_p
	and	coalesce(ie_situacao_compartilhamento, 'A') = 'A';
	
	ie_alterou_w	:= 'N';
	if (qt_historico_102_benef_w = 0) then
		ie_tipo_segurado_ant_w	:= pls_obter_segurado_data(nr_seq_segurado_p, dt_compartilhamento_p);
		
		insert into pls_segurado_historico(nr_sequencia, dt_atualizacao, nm_usuario,
			dt_atualizacao_nrec, nm_usuario_nrec, nr_seq_segurado,
			dt_historico, ds_historico, ds_observacao,
			ie_tipo_historico, dt_ocorrencia_sib, ie_historico_situacao,
			dt_liberacao_hist, ie_envio_sib, ie_tipo_segurado,
			ie_tipo_segurado_ant, ie_situacao_compartilhamento)
		values (	nextval('pls_segurado_historico_seq'), clock_timestamp(), nm_usuario_p,
			clock_timestamp(), nm_usuario_p, nr_seq_segurado_p,
			clock_timestamp(), wheb_mensagem_pck.get_texto(1109251, 'IE_TIPO_SEGURADO_ANT=' || obter_valor_dominio(2406,ie_tipo_segurado_ant_w)|| ';IE_TIPO_SEGURADO=' ||obter_valor_dominio(2406,ie_tipo_segurado_p)), '',
			'102', dt_compartilhamento_p, 'S',
			clock_timestamp(), 'N', ie_tipo_segurado_p,
			ie_tipo_segurado_ant_w, 'A');
		
		CALL pls_inativar_historico_compart(nr_seq_segurado_p, dt_compartilhamento_p, nm_usuario_p, 'N');
		
		ie_alterou_w	:= 'S';
	end if;
	
	ie_gerou_historico_p	:= ie_alterou_w;
	
	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ptu_a100_simplificado_pck.gerar_hist_alt_tipo_benef ( nr_seq_segurado_p pls_segurado.nr_sequencia%type, dt_compartilhamento_p pls_segurado_repasse.dt_repasse%type, ie_tipo_segurado_p pls_segurado.ie_tipo_segurado%type, ie_gerou_historico_p INOUT text) FROM PUBLIC;
