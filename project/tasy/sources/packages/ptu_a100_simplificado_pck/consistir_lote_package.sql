-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE ptu_a100_simplificado_pck.consistir_lote ( nr_seq_lote_p ptu_intercambio_lote_receb.nr_sequencia%type, cd_estabelecimento_p usuario.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type ) AS $body$
DECLARE

	nr_seq_segurado_w	pls_segurado.nr_sequencia%type;
	nr_seq_contrato_w	pls_segurado.nr_seq_contrato%type;
	
	C01 CURSOR FOR
		SELECT	*
		from	ptu_intercambio_benef_simp
		where	nr_seq_lote_receb = nr_seq_lote_p
		and	coalesce(ie_status,'I') not in ('C','N') --Nao alterar o que esta cancelado ou contratado
		and	ie_proprio_recebido = 'P';
	
	C02 CURSOR FOR
		SELECT	*
		from	ptu_intercambio_benef_simp
		where	nr_seq_lote_receb = nr_seq_lote_p
		and	coalesce(ie_status,'I') not in ('C','N') --Nao alterar o que esta cancelado ou contratado
		and	ie_proprio_recebido = 'R';
	
	
BEGIN
	
	--Beneficiarios proprios

	for r_c01_w in C01 loop
		begin
		select	max(nr_seq_segurado)
		into STRICT	nr_seq_segurado_w
		from	pls_segurado_carteira
		where	cd_usuario_plano = lpad(r_c01_w.cd_unimed,4,'0') || lpad(r_c01_w.cd_beneficiario,13,'0');
		
		if (nr_seq_segurado_w IS NOT NULL AND nr_seq_segurado_w::text <> '') then
			update	ptu_intercambio_benef_simp
			set	nr_seq_segurado	= nr_seq_segurado_w,
				nm_usuario	= nm_usuario_p,
				dt_atualizacao	= clock_timestamp()
			where	nr_sequencia	= r_c01_w.nr_sequencia;
			
			CALL ptu_a100_simplificado_pck.alterar_status_mov(r_c01_w.nr_sequencia, 'A', null, nm_usuario_p);
		else
			CALL ptu_a100_simplificado_pck.alterar_status_mov(r_c01_w.nr_sequencia, 'S', wheb_mensagem_pck.get_texto(1123076), nm_usuario_p);
		end if;
		end;
	end loop; --C01
	
	--Beneficiarios recebidos

	for r_c02_w in C02 loop
		begin
		select	max(nr_seq_segurado)
		into STRICT	nr_seq_segurado_w
		from	pls_segurado_carteira
		where	nr_cartao_intercambio = lpad(r_c02_w.cd_unimed,4,'0') || lpad(r_c02_w.cd_beneficiario,13,'0');
		
		if (coalesce(nr_seq_segurado_w::text, '') = '') then
			select	max(nr_seq_segurado)
			into STRICT	nr_seq_segurado_w
			from	pls_segurado_carteira
			where	cd_usuario_plano = lpad(r_c02_w.cd_unimed,4,'0') || lpad(r_c02_w.cd_beneficiario,13,'0');
		end if;
		
		if (nr_seq_segurado_w IS NOT NULL AND nr_seq_segurado_w::text <> '') then
			select	max(nr_seq_contrato)
			into STRICT	nr_seq_contrato_w
			from	pls_segurado
			where	nr_sequencia = nr_seq_segurado_w;
		
			update	ptu_intercambio_benef_simp
			set	nr_seq_segurado	= nr_seq_segurado_w,
				nm_usuario	= nm_usuario_p,
				dt_atualizacao	= clock_timestamp()
			where	nr_sequencia	= r_c02_w.nr_sequencia;
		end if;
		
		if (nr_seq_contrato_w IS NOT NULL AND nr_seq_contrato_w::text <> '') then
			CALL ptu_a100_simplificado_pck.alterar_status_mov(r_c02_w.nr_sequencia, 'S', wheb_mensagem_pck.get_texto(1109162), nm_usuario_p);
		else
			CALL ptu_a100_simplificado_pck.alterar_status_mov(r_c02_w.nr_sequencia, 'A', null, nm_usuario_p);
		end if;
		end;
	end loop; --C02
	
	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ptu_a100_simplificado_pck.consistir_lote ( nr_seq_lote_p ptu_intercambio_lote_receb.nr_sequencia%type, cd_estabelecimento_p usuario.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type ) FROM PUBLIC;
