-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION audio_video_pck.get_unit_status (CD_SETOR_ATENDIMENTO_P bigint, CD_UNIDADE_BASICA_P text, CD_UNIDADE_COMPL_P text) RETURNS bigint AS $body$
DECLARE

        IS_AV_SERVER_W smallint;
        IS_SESSION_W   smallint;
        IS_PRIVACITY_W smallint;
        NR_RETORNO_W   smallint;

BEGIN
        SELECT CASE
                   WHEN exists (SELECT 0
                               FROM UNIDADE_ATENDIMENTO UA
                                   INNER JOIN VIDEO_SERVER_UNIDADE_ATEND VSUA ON (
                                       UA.CD_SETOR_ATENDIMENTO = VSUA.CD_SETOR_ATENDIMENTO
                                       AND VSUA.CD_UNIDADE_BASICA = UA.CD_UNIDADE_BASICA
                                       AND VSUA.CD_UNIDADE_COMPL = UA.CD_UNIDADE_COMPL
                                   )
                               WHERE UA.CD_SETOR_ATENDIMENTO = CD_SETOR_ATENDIMENTO_P
                                 AND trim(both UA.CD_UNIDADE_BASICA) = CD_UNIDADE_BASICA_P
                                 AND coalesce(trim(both UA.CD_UNIDADE_COMPL), ' ') = coalesce(trim(both CD_UNIDADE_COMPL_P), ' ')
                       )
                       THEN 1
                   ELSE 0
                   END
        INTO STRICT IS_AV_SERVER_W
;

        SELECT CASE
                   WHEN exists (
                           SELECT 0
                           FROM UNIDADE_ATENDIMENTO UA
                               INNER JOIN VIDEO_SESSION VS ON UA.NR_ATENDIMENTO = VS.NR_ATENDIMENTO
                           WHERE coalesce(VS.DT_FIM::text, '') = ''
                             AND UA.CD_SETOR_ATENDIMENTO = CD_SETOR_ATENDIMENTO_P
                             AND trim(both UA.CD_UNIDADE_BASICA) = CD_UNIDADE_BASICA_P
                             AND coalesce(trim(both UA.CD_UNIDADE_COMPL), ' ') = coalesce(trim(both CD_UNIDADE_COMPL_P), ' ')
                       )
                       THEN 1
                   ELSE 0
                   END
        INTO STRICT IS_SESSION_W
;

        SELECT CASE
                   WHEN exists (
                           SELECT 0
                           FROM UNIDADE_ATENDIMENTO UA
                               INNER JOIN ATEND_PACIENTE_ADIC APA ON UA.NR_ATENDIMENTO = APA.NR_ATENDIMENTO
                           WHERE upper(APA.IE_PRIVACIDADE_AV) = 'S'
                             AND UA.CD_SETOR_ATENDIMENTO = CD_SETOR_ATENDIMENTO_P
                             AND trim(both UA.CD_UNIDADE_BASICA) = coalesce(trim(both CD_UNIDADE_BASICA_P), ' ')
                             AND coalesce(trim(both UA.CD_UNIDADE_COMPL), ' ') = coalesce(trim(both CD_UNIDADE_COMPL_P), ' ')
                       )
                       THEN 1
                   ELSE 0
                   END
        INTO STRICT IS_PRIVACITY_W
;

        IF (IS_AV_SERVER_W = 1) THEN
            IF (IS_SESSION_W = 1) THEN
                IF (IS_PRIVACITY_W = 1) THEN NR_RETORNO_W := 3; ELSE NR_RETORNO_W := 2; END IF;
            ELSE
                IF (IS_PRIVACITY_W = 1) THEN NR_RETORNO_W := 4; ELSE NR_RETORNO_W := 1; END IF;
            END IF;
        ELSE
            NR_RETORNO_W := 0;
        END IF;

        RETURN NR_RETORNO_W;
    END;


$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION audio_video_pck.get_unit_status (CD_SETOR_ATENDIMENTO_P bigint, CD_UNIDADE_BASICA_P text, CD_UNIDADE_COMPL_P text) FROM PUBLIC;
