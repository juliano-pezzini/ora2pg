-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION audio_video_pck.get_server_video_status (video_server_unidade_atend_p bigint) RETURNS bigint AS $body$
DECLARE

        is_session_w smallint;
        is_privacity_w smallint;
        nr_atendimento_w integer;
        cd_video_server_w integer;

        nr_retorno_w smallint;

BEGIN

        select ua.nr_atendimento,
				vsua.cd_video_server
		into STRICT nr_atendimento_w, cd_video_server_w
        from unidade_atendimento ua inner join video_server_unidade_atend vsua
				ON (ua.cd_setor_atendimento = vsua.cd_setor_atendimento
                and vsua.cd_unidade_basica = ua.cd_unidade_basica
                and vsua.cd_unidade_compl = ua.cd_unidade_compl
				)
		where vsua.nr_sequencia = video_server_unidade_atend_p;

        select case
                   when exists (
                        select
                            0
                        from video_session vs
						inner join video_server_unidade_atend vsua
						on vs.cd_video_unidade_atend = vsua.nr_sequencia
                        where
                            coalesce(vs.dt_fim::text, '') = '' and vsua.cd_video_server = cd_video_server_w)
                   then 1
                   else 0
               end into STRICT is_session_w
;

        select case
                   when exists (
                      select
                            0
                        from atend_paciente_adic apa
                        where
                            upper(apa.ie_privacidade_av)	=	'S'
							and apa.nr_atendimento 			= nr_atendimento_w )
                   then 1
                   else 0
               end into STRICT is_privacity_w
;

        if (is_session_w = 1) then
              if (is_privacity_w = 1) then
                  nr_retorno_w := 3;
              else
                nr_retorno_w := 2;
              end if;
        else
              if (is_privacity_w = 1) then
                  nr_retorno_w := 4;
              else
                nr_retorno_w := 1;
              end if;
        end if;

        return nr_retorno_w;

    end;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION audio_video_pck.get_server_video_status (video_server_unidade_atend_p bigint) FROM PUBLIC;
