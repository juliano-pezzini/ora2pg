-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE diops_fin_gerar_assist_pck.diops_fin_gerar_assistencial ( nr_seq_periodo_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE


	ds_conta_contabil_w	varchar(20);
	ie_tipo_quadro_w	varchar(2);
	ie_cobertura_w		varchar(5);
	ie_tipo_w		varchar(5);
	ds_plano_w		varchar(255);
	dt_periodo_inicial_w	timestamp;
	dt_periodo_final_w	timestamp;
	ie_tipo_contratacao_w	varchar(2);
	ie_tipo_dado_w		varchar(2);
	ie_status_prov_pagto_w	varchar(2);
	ie_ato_w		varchar(255);
	ie_tipo_outorgante_w	pls_outorgante.ie_tipo_outorgante%type;
	ie_forma_geracao_w	varchar(1);
	ie_data_ref_copartic_w	varchar(2);
	ie_aplica_recalc_w	varchar(1);
        nr_tipo_pre_pagamento_w smallint;

	nr_seq_conta_mat_w		pls_conta_mat.nr_sequencia%type;
	nr_seq_conta_proc_w		pls_conta_proc.nr_sequencia%type;
	nr_seq_conta_w			pls_conta.nr_sequencia%type;
	nr_seq_conta_copartic_w		pls_conta_coparticipacao.nr_sequencia%type;
	ie_cobertura_assistencial_w	pls_parametros.ie_cobertura_assistencial%type;
	nr_seq_trim_1_w			diops_periodo.nr_sequencia%type;
	nr_seq_trim_2_w			diops_periodo.nr_sequencia%type;
	nr_seq_trim_3_w			diops_periodo.nr_sequencia%type;

	ds_internacao_w			varchar(255);

	ie_tipo_relacao_w		pls_prestador.ie_tipo_relacao%type;
	ie_tipo_segurado_w		pls_segurado.ie_tipo_segurado%type;
	ie_tipo_protocolo_w		pls_protocolo_conta.ie_tipo_protocolo%type;
	vl_liberado_w			pls_conta_medica_resumo.vl_liberado%type;
	ds_grupo_diops_w		varchar(255);
  	ie_forma_contab_taxa_pgto_w 	pls_parametro_contabil.ie_forma_contab_taxa_pgto%type;

	c_tipo CURSOR FOR
		SELECT	'H' ie_tipo
		
		
union all

		SELECT	'O' ie_tipo
		
		where	dt_periodo_final_w < to_date('01/01/2016','dd/mm/yyyy');

	c_dominio CURSOR FOR
		SELECT	vl_dominio,
			ie_ato
		from	(SELECT	vl_dominio,
				'0' ie_ato
			from	valor_dominio_v
			where	cd_dominio = 5832
			and (ie_tipo_outorgante_w not('3','4')
			or	ie_forma_geracao_w	= 'S')
			and	(((dt_periodo_final_w < to_date('01/01/2016','dd/mm/yyyy'))
			or (vl_dominio not in (7,8,9,10,11,12,13)))
			or (vl_dominio = 13 and dt_periodo_final_w >= pkg_date_utils.get_dateTime(2019, 01, 01)))
			
union all

			select	vl_dominio,
				'1' ie_ato
			from	valor_dominio_v
			where	cd_dominio = 5832
			and	ie_tipo_outorgante_w in ('3','4')
			and	(((dt_periodo_final_w < to_date('01/01/2016','dd/mm/yyyy'))
			or (vl_dominio not in (7,8,9,10,11,12,13)))
			or (vl_dominio = 13 and dt_periodo_final_w >= pkg_date_utils.get_dateTime(2019, 01, 01)))
			and	ie_forma_geracao_w	= 'A'
			
union all

			select	vl_dominio,
				'2' ie_ato
			from	valor_dominio_v
			where	cd_dominio = 5832
			and	ie_tipo_outorgante_w in ('3','4')
			and	(((dt_periodo_final_w < to_date('01/01/2016','dd/mm/yyyy'))
			or (vl_dominio not in (7,8,9,10,11,12,13)))
			or (vl_dominio = 13 and dt_periodo_final_w >= pkg_date_utils.get_dateTime(2019, 01, 01)))
			and	ie_forma_geracao_w	= 'A'
			
union all

			select	vl_dominio,
				'7' ie_ato
			from	valor_dominio_v
			where	cd_dominio = 5832
			and	ie_tipo_outorgante_w in ('3','4')
			and	(((dt_periodo_final_w < to_date('01/01/2016','dd/mm/yyyy'))
			or (vl_dominio not in (7,8,9,10,11,12,13)))
			or (vl_dominio = 13 and dt_periodo_final_w >= pkg_date_utils.get_dateTime(2019, 01, 01)))
			and	ie_forma_geracao_w	= 'A') alias37
		order by
			ie_ato,
			(vl_dominio)::numeric;

	c_itens CURSOR FOR
		SELECT	sum(pls_obter_valor_prov_resumo(z.nr_seq_conta,z.nr_sequencia,z.vl_apresentado,z.vl_calculado,z.vl_liberado,z.vl_taxa_adm,z.vl_taxa_adm_co,z.vl_taxa_adm_mat,ie_forma_contab_taxa_pgto_w,'L')) vl_liberado,
			CASE WHEN g.ie_tipo_grupo_ans='10' THEN 'Consultas' WHEN g.ie_tipo_grupo_ans='20' THEN 'Exames' WHEN g.ie_tipo_grupo_ans='30' THEN 'Terapias' WHEN g.ie_tipo_grupo_ans='41' THEN ds_internacao_w WHEN g.ie_tipo_grupo_ans='42' THEN ds_internacao_w WHEN g.ie_tipo_grupo_ans='43' THEN ds_internacao_w WHEN g.ie_tipo_grupo_ans='44' THEN ds_internacao_w WHEN g.ie_tipo_grupo_ans='45' THEN ds_internacao_w WHEN g.ie_tipo_grupo_ans='46' THEN ds_internacao_w WHEN g.ie_tipo_grupo_ans='49' THEN ds_internacao_w WHEN g.ie_tipo_grupo_ans='50' THEN 'Outros atendimentos' WHEN g.ie_tipo_grupo_ans='60' THEN 'Demais despesas'  ELSE 'Sem grupo ANS' END  ds_grupo_diops,
			a.nr_sequencia nr_seq_conta_proc,
			null nr_seq_conta_mat,
			null nr_seq_conta_copartic,
			h.ie_tipo_relacao,
			s.ie_tipo_segurado,
			c.nr_sequencia nr_seq_conta,
			p.ie_tipo_protocolo
		FROM pls_conta_medica_resumo z, pls_segurado s, pls_protocolo_conta p, pls_prestador h, pls_plano d, pls_conta c, pls_conta_proc a
LEFT OUTER JOIN ans_grupo_despesa g ON (a.nr_seq_grupo_ans = g.nr_sequencia)
WHERE c.nr_seq_protocolo	= p.nr_sequencia and a.nr_seq_conta		= c.nr_sequencia and s.nr_sequencia		= c.nr_seq_segurado and d.nr_sequencia		= c.nr_seq_plano and h.nr_sequencia		= c.nr_seq_prestador_exec  and z.nr_seq_conta 		= c.nr_sequencia and z.nr_seq_conta_proc 	= a.nr_sequencia and ((c.ie_status = ie_status_prov_pagto_w)
		or	((ie_status_prov_pagto_w <> 'F')
		and (p.ie_status in ('3','4','6')))) and p.dt_mes_competencia between dt_periodo_inicial_w and dt_periodo_final_w and ds_conta_contabil_w  in (	SELECT	substr(replace(e.cd_classificacao_atual,'.',''),1,8)
							from	conta_contabil	e
							where	coalesce(z.cd_conta_prov_deb,z.cd_conta_deb) = e.cd_conta_contabil
							
union

							select	substr(replace(e.cd_classificacao_atual,'.',''),1,8)
							from	conta_contabil e
							where	coalesce(a.cd_conta_provisao_deb,a.cd_conta_deb) = e.cd_conta_contabil
							and 	coalesce(z.cd_conta_prov_deb::text, '') = ''
							and 	coalesce(z.cd_conta_deb::text, '') = '') and (((ie_tipo_quadro_w = '1') and (d.ie_preco = '1') and (d.ie_tipo_contratacao = 'I') and (d.ie_regulamentacao = 'R')) or
			 ((ie_tipo_quadro_w = '2') and (d.ie_preco = '1') and (d.ie_tipo_contratacao = 'I') and (d.ie_regulamentacao <> 'R')) or
			 ((ie_tipo_quadro_w = '3') and (d.ie_preco = '1') and (d.ie_tipo_contratacao = 'CA') and (d.ie_regulamentacao = 'R')) or
			 ((ie_tipo_quadro_w = '4') and (d.ie_preco = '1') and (d.ie_tipo_contratacao = 'CA') and (d.ie_regulamentacao <> 'R')) or
			 ((ie_tipo_quadro_w = '5') and (d.ie_preco = '1') and (d.ie_tipo_contratacao = 'CE') and (d.ie_regulamentacao = 'R')) or
			 ((ie_tipo_quadro_w = '6') and (d.ie_preco = '1') and (d.ie_tipo_contratacao = 'CE') and (d.ie_regulamentacao <> 'R')) or
			 ((ie_tipo_quadro_w = '7') and (d.ie_preco <> '1') and (d.ie_tipo_contratacao = 'I') and (d.ie_regulamentacao = 'R')) or
			 ((ie_tipo_quadro_w = '8') and (d.ie_preco <> '1') and (d.ie_tipo_contratacao = 'I') and (d.ie_regulamentacao <> 'R')) or
			 ((ie_tipo_quadro_w = '9') and (d.ie_preco <> '1') and (d.ie_tipo_contratacao = 'CA') and (d.ie_regulamentacao = 'R')) or
			 ((ie_tipo_quadro_w = '10') and (d.ie_preco <> '1') and (d.ie_tipo_contratacao = 'CA') and (d.ie_regulamentacao <> 'R')) or
			 ((ie_tipo_quadro_w = '11') and (d.ie_preco <> '1') and (d.ie_tipo_contratacao = 'CE') and (d.ie_regulamentacao = 'R')) or
			 ((ie_tipo_quadro_w = '12') and (d.ie_preco <> '1') and (d.ie_tipo_contratacao = 'CE') and (d.ie_regulamentacao <> 'R')) or
			 (ie_tipo_quadro_w = '13' AND d.ie_preco = '1')) and p.ie_tipo_protocolo		= 'C' and coalesce(z.ie_situacao,'A')		= 'A' group by
			a.nr_sequencia,
			h.ie_tipo_relacao,
			s.ie_tipo_segurado,
			c.nr_sequencia,
			p.ie_tipo_protocolo,
			CASE WHEN g.ie_tipo_grupo_ans='10' THEN 'Consultas' WHEN g.ie_tipo_grupo_ans='20' THEN 'Exames' WHEN g.ie_tipo_grupo_ans='30' THEN 'Terapias' WHEN g.ie_tipo_grupo_ans='41' THEN ds_internacao_w WHEN g.ie_tipo_grupo_ans='42' THEN ds_internacao_w WHEN g.ie_tipo_grupo_ans='43' THEN ds_internacao_w WHEN g.ie_tipo_grupo_ans='44' THEN ds_internacao_w WHEN g.ie_tipo_grupo_ans='45' THEN ds_internacao_w WHEN g.ie_tipo_grupo_ans='46' THEN ds_internacao_w WHEN g.ie_tipo_grupo_ans='49' THEN ds_internacao_w WHEN g.ie_tipo_grupo_ans='50' THEN 'Outros atendimentos' WHEN g.ie_tipo_grupo_ans='60' THEN 'Demais despesas'  ELSE 'Sem grupo ANS' END
		
union all

		select	sum(a.vl_liberado) vl_liberado,
			CASE WHEN g.ie_tipo_grupo_ans='10' THEN 'Consultas' WHEN g.ie_tipo_grupo_ans='20' THEN 'Exames' WHEN g.ie_tipo_grupo_ans='30' THEN 'Terapias' WHEN g.ie_tipo_grupo_ans='41' THEN ds_internacao_w WHEN g.ie_tipo_grupo_ans='42' THEN ds_internacao_w WHEN g.ie_tipo_grupo_ans='43' THEN ds_internacao_w WHEN g.ie_tipo_grupo_ans='44' THEN ds_internacao_w WHEN g.ie_tipo_grupo_ans='45' THEN ds_internacao_w WHEN g.ie_tipo_grupo_ans='46' THEN ds_internacao_w WHEN g.ie_tipo_grupo_ans='49' THEN ds_internacao_w WHEN g.ie_tipo_grupo_ans='50' THEN 'Outros atendimentos' WHEN g.ie_tipo_grupo_ans='60' THEN 'Demais despesas'  ELSE 'Sem grupo ANS' END  ds_grupo_diops,
			a.nr_sequencia nr_seq_conta_proc,
			null nr_seq_conta_mat,
			null nr_seq_conta_copartic,
			null ie_tipo_relacao,
			s.ie_tipo_segurado,
			c.nr_sequencia nr_seq_conta,
			p.ie_tipo_protocolo
		FROM pls_segurado s, pls_protocolo_conta p, pls_plano d, pls_conta c, pls_conta_proc a
LEFT OUTER JOIN ans_grupo_despesa g ON (a.nr_seq_grupo_ans = g.nr_sequencia)
WHERE c.nr_seq_protocolo	= p.nr_sequencia and a.nr_seq_conta		= c.nr_sequencia and s.nr_sequencia		= c.nr_seq_segurado and d.nr_sequencia		= c.nr_seq_plano  and ((c.ie_status = ie_status_prov_pagto_w)
		or	((ie_status_prov_pagto_w <> 'F')
		and (p.ie_status in ('3','4','6')))) and p.dt_mes_competencia between dt_periodo_inicial_w and dt_periodo_final_w and ds_conta_contabil_w in (	select	substr(replace(e.cd_classificacao_atual,'.',''),1,8)
							from	conta_contabil e
							where	coalesce(a.cd_conta_provisao_deb,a.cd_conta_deb) = e.cd_conta_contabil) and (((ie_tipo_quadro_w = '1') and (d.ie_preco = '1') and (d.ie_tipo_contratacao = 'I') and (d.ie_regulamentacao = 'R')) or
			 ((ie_tipo_quadro_w = '2') and (d.ie_preco = '1') and (d.ie_tipo_contratacao = 'I') and (d.ie_regulamentacao <> 'R')) or
			 ((ie_tipo_quadro_w = '3') and (d.ie_preco = '1') and (d.ie_tipo_contratacao = 'CA') and (d.ie_regulamentacao = 'R')) or
			 ((ie_tipo_quadro_w = '4') and (d.ie_preco = '1') and (d.ie_tipo_contratacao = 'CA') and (d.ie_regulamentacao <> 'R')) or
			 ((ie_tipo_quadro_w = '5') and (d.ie_preco = '1') and (d.ie_tipo_contratacao = 'CE') and (d.ie_regulamentacao = 'R')) or
			 ((ie_tipo_quadro_w = '6') and (d.ie_preco = '1') and (d.ie_tipo_contratacao = 'CE') and (d.ie_regulamentacao <> 'R')) or
			 ((ie_tipo_quadro_w = '7') and (d.ie_preco <> '1') and (d.ie_tipo_contratacao = 'I') and (d.ie_regulamentacao = 'R')) or
			 ((ie_tipo_quadro_w = '8') and (d.ie_preco <> '1') and (d.ie_tipo_contratacao = 'I') and (d.ie_regulamentacao <> 'R')) or
			 ((ie_tipo_quadro_w = '9') and (d.ie_preco <> '1') and (d.ie_tipo_contratacao = 'CA') and (d.ie_regulamentacao = 'R')) or
			 ((ie_tipo_quadro_w = '10') and (d.ie_preco <> '1') and (d.ie_tipo_contratacao = 'CA') and (d.ie_regulamentacao <> 'R')) or
			 ((ie_tipo_quadro_w = '11') and (d.ie_preco <> '1') and (d.ie_tipo_contratacao = 'CE') and (d.ie_regulamentacao = 'R')) or
			 ((ie_tipo_quadro_w = '12') and (d.ie_preco <> '1') and (d.ie_tipo_contratacao = 'CE') and (d.ie_regulamentacao <> 'R')) or
			 (ie_tipo_quadro_w = '13' AND d.ie_preco = '1')) and p.ie_tipo_protocolo in ('R','I','F') group by
			a.nr_sequencia,
			s.ie_tipo_segurado,
			c.nr_sequencia,
			p.ie_tipo_protocolo,
			CASE WHEN g.ie_tipo_grupo_ans='10' THEN 'Consultas' WHEN g.ie_tipo_grupo_ans='20' THEN 'Exames' WHEN g.ie_tipo_grupo_ans='30' THEN 'Terapias' WHEN g.ie_tipo_grupo_ans='41' THEN ds_internacao_w WHEN g.ie_tipo_grupo_ans='42' THEN ds_internacao_w WHEN g.ie_tipo_grupo_ans='43' THEN ds_internacao_w WHEN g.ie_tipo_grupo_ans='44' THEN ds_internacao_w WHEN g.ie_tipo_grupo_ans='45' THEN ds_internacao_w WHEN g.ie_tipo_grupo_ans='46' THEN ds_internacao_w WHEN g.ie_tipo_grupo_ans='49' THEN ds_internacao_w WHEN g.ie_tipo_grupo_ans='50' THEN 'Outros atendimentos' WHEN g.ie_tipo_grupo_ans='60' THEN 'Demais despesas'  ELSE 'Sem grupo ANS' END 
		
union all

		select	sum(pls_obter_valor_prov_resumo(z.nr_seq_conta,z.nr_sequencia,z.vl_apresentado,z.vl_calculado,z.vl_liberado,z.vl_taxa_adm,z.vl_taxa_adm_co,z.vl_taxa_adm_mat,ie_forma_contab_taxa_pgto_w, 'L')) vl_liberado,
			CASE WHEN g.ie_tipo_grupo_ans='10' THEN 'Consultas' WHEN g.ie_tipo_grupo_ans='20' THEN 'Exames' WHEN g.ie_tipo_grupo_ans='30' THEN 'Terapias' WHEN g.ie_tipo_grupo_ans='41' THEN ds_internacao_w WHEN g.ie_tipo_grupo_ans='42' THEN ds_internacao_w WHEN g.ie_tipo_grupo_ans='43' THEN ds_internacao_w WHEN g.ie_tipo_grupo_ans='44' THEN ds_internacao_w WHEN g.ie_tipo_grupo_ans='45' THEN ds_internacao_w WHEN g.ie_tipo_grupo_ans='46' THEN ds_internacao_w WHEN g.ie_tipo_grupo_ans='49' THEN ds_internacao_w WHEN g.ie_tipo_grupo_ans='50' THEN 'Outros atendimentos' WHEN g.ie_tipo_grupo_ans='60' THEN 'Demais despesas'  ELSE 'Sem grupo ANS' END  ds_grupo_diops,
			null nr_seq_conta_proc,
			a.nr_sequencia nr_seq_conta_mat,
			null nr_seq_conta_copartic,
			h.ie_tipo_relacao,
			s.ie_tipo_segurado,
			c.nr_sequencia nr_seq_conta,
			p.ie_tipo_protocolo
		FROM pls_conta_medica_resumo z, pls_segurado s, pls_protocolo_conta p, pls_prestador h, pls_plano d, pls_conta c, pls_conta_mat a
LEFT OUTER JOIN ans_grupo_despesa g ON (a.nr_seq_grupo_ans = g.nr_sequencia)
WHERE c.nr_seq_protocolo	= p.nr_sequencia and a.nr_seq_conta		= c.nr_sequencia and s.nr_sequencia		= c.nr_seq_segurado and d.nr_sequencia		= c.nr_seq_plano and h.nr_sequencia		= c.nr_seq_prestador_exec  and z.nr_seq_conta 		= c.nr_sequencia and z.nr_seq_conta_mat 	= a.nr_sequencia and ((c.ie_status = ie_status_prov_pagto_w)
		or	((ie_status_prov_pagto_w <> 'F')
		and (p.ie_status in ('3','4','6')))) and p.dt_mes_competencia between dt_periodo_inicial_w and dt_periodo_final_w and ds_conta_contabil_w in (	select	substr(replace(e.cd_classificacao_atual,'.',''),1,8)
							from	conta_contabil	e
							where	coalesce(z.cd_conta_prov_deb,z.cd_conta_deb) = e.cd_conta_contabil
							
union

							select	substr(replace(e.cd_classificacao_atual,'.',''),1,8)
							from	conta_contabil e
							where	coalesce(a.cd_conta_provisao_deb,a.cd_conta_deb) = e.cd_conta_contabil
							and 	coalesce(z.cd_conta_prov_deb::text, '') = ''
							and 	coalesce(z.cd_conta_deb::text, '') = '') and (((ie_tipo_quadro_w = '1') and (d.ie_preco = '1') and (d.ie_tipo_contratacao = 'I') and (d.ie_regulamentacao = 'R')) or
			 ((ie_tipo_quadro_w = '2') and (d.ie_preco = '1') and (d.ie_tipo_contratacao = 'I') and (d.ie_regulamentacao <> 'R')) or
			 ((ie_tipo_quadro_w = '3') and (d.ie_preco = '1') and (d.ie_tipo_contratacao = 'CA') and (d.ie_regulamentacao = 'R')) or
			 ((ie_tipo_quadro_w = '4') and (d.ie_preco = '1') and (d.ie_tipo_contratacao = 'CA') and (d.ie_regulamentacao <> 'R')) or
			 ((ie_tipo_quadro_w = '5') and (d.ie_preco = '1') and (d.ie_tipo_contratacao = 'CE') and (d.ie_regulamentacao = 'R')) or
			 ((ie_tipo_quadro_w = '6') and (d.ie_preco = '1') and (d.ie_tipo_contratacao = 'CE') and (d.ie_regulamentacao <> 'R')) or
			 ((ie_tipo_quadro_w = '7') and (d.ie_preco <> '1') and (d.ie_tipo_contratacao = 'I') and (d.ie_regulamentacao = 'R')) or
			 ((ie_tipo_quadro_w = '8') and (d.ie_preco <> '1') and (d.ie_tipo_contratacao = 'I') and (d.ie_regulamentacao <> 'R')) or
			 ((ie_tipo_quadro_w = '9') and (d.ie_preco <> '1') and (d.ie_tipo_contratacao = 'CA') and (d.ie_regulamentacao = 'R')) or
			 ((ie_tipo_quadro_w = '10') and (d.ie_preco <> '1') and (d.ie_tipo_contratacao = 'CA') and (d.ie_regulamentacao <> 'R')) or
			 ((ie_tipo_quadro_w = '11') and (d.ie_preco <> '1') and (d.ie_tipo_contratacao = 'CE') and (d.ie_regulamentacao = 'R')) or
			 ((ie_tipo_quadro_w = '12') and (d.ie_preco <> '1') and (d.ie_tipo_contratacao = 'CE') and (d.ie_regulamentacao <> 'R')) or
			 (ie_tipo_quadro_w = '13' AND d.ie_preco = '1')) and p.ie_tipo_protocolo		= 'C' and coalesce(z.ie_situacao,'A')		= 'A' group by
			a.nr_sequencia,
			h.ie_tipo_relacao,
			s.ie_tipo_segurado,
			c.nr_sequencia,
			p.ie_tipo_protocolo,
			CASE WHEN g.ie_tipo_grupo_ans='10' THEN 'Consultas' WHEN g.ie_tipo_grupo_ans='20' THEN 'Exames' WHEN g.ie_tipo_grupo_ans='30' THEN 'Terapias' WHEN g.ie_tipo_grupo_ans='41' THEN ds_internacao_w WHEN g.ie_tipo_grupo_ans='42' THEN ds_internacao_w WHEN g.ie_tipo_grupo_ans='43' THEN ds_internacao_w WHEN g.ie_tipo_grupo_ans='44' THEN ds_internacao_w WHEN g.ie_tipo_grupo_ans='45' THEN ds_internacao_w WHEN g.ie_tipo_grupo_ans='46' THEN ds_internacao_w WHEN g.ie_tipo_grupo_ans='49' THEN ds_internacao_w WHEN g.ie_tipo_grupo_ans='50' THEN 'Outros atendimentos' WHEN g.ie_tipo_grupo_ans='60' THEN 'Demais despesas'  ELSE 'Sem grupo ANS' END 
		
union all

		select	sum(a.vl_liberado) vl_liberado,
			CASE WHEN g.ie_tipo_grupo_ans='10' THEN 'Consultas' WHEN g.ie_tipo_grupo_ans='20' THEN 'Exames' WHEN g.ie_tipo_grupo_ans='30' THEN 'Terapias' WHEN g.ie_tipo_grupo_ans='41' THEN ds_internacao_w WHEN g.ie_tipo_grupo_ans='42' THEN ds_internacao_w WHEN g.ie_tipo_grupo_ans='43' THEN ds_internacao_w WHEN g.ie_tipo_grupo_ans='44' THEN ds_internacao_w WHEN g.ie_tipo_grupo_ans='45' THEN ds_internacao_w WHEN g.ie_tipo_grupo_ans='46' THEN ds_internacao_w WHEN g.ie_tipo_grupo_ans='49' THEN ds_internacao_w WHEN g.ie_tipo_grupo_ans='50' THEN 'Outros atendimentos' WHEN g.ie_tipo_grupo_ans='60' THEN 'Demais despesas'  ELSE 'Sem grupo ANS' END  ds_grupo_diops,
			null nr_seq_conta_proc,
			a.nr_sequencia nr_seq_conta_mat,
			null nr_seq_conta_copartic,
			null ie_tipo_relacao,
			s.ie_tipo_segurado,
			c.nr_sequencia nr_seq_conta,
			p.ie_tipo_protocolo
		FROM pls_segurado s, pls_protocolo_conta p, pls_plano d, pls_conta c, pls_conta_mat a
LEFT OUTER JOIN ans_grupo_despesa g ON (a.nr_seq_grupo_ans = g.nr_sequencia)
WHERE c.nr_seq_protocolo	= p.nr_sequencia and a.nr_seq_conta		= c.nr_sequencia and s.nr_sequencia		= c.nr_seq_segurado and d.nr_sequencia		= c.nr_seq_plano  and ((c.ie_status = ie_status_prov_pagto_w)
		or	((ie_status_prov_pagto_w <> 'F')
		and (p.ie_status in ('3','4','6')))) and p.dt_mes_competencia between dt_periodo_inicial_w and dt_periodo_final_w and ds_conta_contabil_w in (	select	substr(replace(e.cd_classificacao_atual,'.',''),1,8)
							from	conta_contabil e
							where	coalesce(a.cd_conta_provisao_deb,a.cd_conta_deb) = e.cd_conta_contabil) and (((ie_tipo_quadro_w = '1') and (d.ie_preco = '1') and (d.ie_tipo_contratacao = 'I') and (d.ie_regulamentacao = 'R')) or
			 ((ie_tipo_quadro_w = '2') and (d.ie_preco = '1') and (d.ie_tipo_contratacao = 'I') and (d.ie_regulamentacao <> 'R')) or
			 ((ie_tipo_quadro_w = '3') and (d.ie_preco = '1') and (d.ie_tipo_contratacao = 'CA') and (d.ie_regulamentacao = 'R')) or
			 ((ie_tipo_quadro_w = '4') and (d.ie_preco = '1') and (d.ie_tipo_contratacao = 'CA') and (d.ie_regulamentacao <> 'R')) or
			 ((ie_tipo_quadro_w = '5') and (d.ie_preco = '1') and (d.ie_tipo_contratacao = 'CE') and (d.ie_regulamentacao = 'R')) or
			 ((ie_tipo_quadro_w = '6') and (d.ie_preco = '1') and (d.ie_tipo_contratacao = 'CE') and (d.ie_regulamentacao <> 'R')) or
			 ((ie_tipo_quadro_w = '7') and (d.ie_preco <> '1') and (d.ie_tipo_contratacao = 'I') and (d.ie_regulamentacao = 'R')) or
			 ((ie_tipo_quadro_w = '8') and (d.ie_preco <> '1') and (d.ie_tipo_contratacao = 'I') and (d.ie_regulamentacao <> 'R')) or
			 ((ie_tipo_quadro_w = '9') and (d.ie_preco <> '1') and (d.ie_tipo_contratacao = 'CA') and (d.ie_regulamentacao = 'R')) or
			 ((ie_tipo_quadro_w = '10') and (d.ie_preco <> '1') and (d.ie_tipo_contratacao = 'CA') and (d.ie_regulamentacao <> 'R')) or
			 ((ie_tipo_quadro_w = '11') and (d.ie_preco <> '1') and (d.ie_tipo_contratacao = 'CE') and (d.ie_regulamentacao = 'R')) or
			 ((ie_tipo_quadro_w = '12') and (d.ie_preco <> '1') and (d.ie_tipo_contratacao = 'CE') and (d.ie_regulamentacao <> 'R')) or
			 (ie_tipo_quadro_w = '13' AND d.ie_preco = '1')) and p.ie_tipo_protocolo in ('R','I','F') group by
			a.nr_sequencia,
			s.ie_tipo_segurado,
			c.nr_sequencia,
			p.ie_tipo_protocolo,
			CASE WHEN g.ie_tipo_grupo_ans='10' THEN 'Consultas' WHEN g.ie_tipo_grupo_ans='20' THEN 'Exames' WHEN g.ie_tipo_grupo_ans='30' THEN 'Terapias' WHEN g.ie_tipo_grupo_ans='41' THEN ds_internacao_w WHEN g.ie_tipo_grupo_ans='42' THEN ds_internacao_w WHEN g.ie_tipo_grupo_ans='43' THEN ds_internacao_w WHEN g.ie_tipo_grupo_ans='44' THEN ds_internacao_w WHEN g.ie_tipo_grupo_ans='45' THEN ds_internacao_w WHEN g.ie_tipo_grupo_ans='46' THEN ds_internacao_w WHEN g.ie_tipo_grupo_ans='49' THEN ds_internacao_w WHEN g.ie_tipo_grupo_ans='50' THEN 'Outros atendimentos' WHEN g.ie_tipo_grupo_ans='60' THEN 'Demais despesas'  ELSE 'Sem grupo ANS' END 
		
union all

		/* Coparticipacao */


		select	sum(d.vl_coparticipacao) vl_liberado,
			CASE WHEN h.ie_tipo_grupo_ans='10' THEN 'Consultas' WHEN h.ie_tipo_grupo_ans='20' THEN 'Exames' WHEN h.ie_tipo_grupo_ans='30' THEN 'Terapias' WHEN h.ie_tipo_grupo_ans='41' THEN ds_internacao_w WHEN h.ie_tipo_grupo_ans='42' THEN ds_internacao_w WHEN h.ie_tipo_grupo_ans='43' THEN ds_internacao_w WHEN h.ie_tipo_grupo_ans='44' THEN ds_internacao_w WHEN h.ie_tipo_grupo_ans='45' THEN ds_internacao_w WHEN h.ie_tipo_grupo_ans='46' THEN ds_internacao_w WHEN h.ie_tipo_grupo_ans='49' THEN ds_internacao_w WHEN h.ie_tipo_grupo_ans='50' THEN 'Outros atendimentos' WHEN h.ie_tipo_grupo_ans='60' THEN 'Demais despesas'  ELSE 'Sem grupo ANS' END  ds_grupo_diops,
			a.nr_sequencia nr_seq_conta_proc,
			null nr_seq_conta_mat,
			b.nr_sequencia nr_seq_conta_copartic,
			j.ie_tipo_relacao,
			e.ie_tipo_segurado,
			c.nr_sequencia nr_seq_conta,
			p.ie_tipo_protocolo
		FROM pls_protocolo_conta p, pls_plano g, pls_segurado e, pls_conta c
LEFT OUTER JOIN pls_prestador j ON (c.nr_seq_prestador_exec = j.nr_sequencia)
, pls_conta_proc a
LEFT OUTER JOIN ans_grupo_despesa h ON (a.nr_seq_grupo_ans = h.nr_sequencia)
, pls_conta_coparticipacao b
LEFT OUTER JOIN pls_conta_copartic_contab d ON (b.nr_sequencia = d.nr_seq_conta_copartic)
WHERE c.nr_seq_protocolo	= p.nr_sequencia and b.nr_seq_conta_proc	= a.nr_sequencia and a.nr_seq_conta		= c.nr_sequencia and b.nr_seq_conta		= c.nr_sequencia --and	b.nr_seq_mensalidade_seg = d.nr_sequencia
  and e.nr_sequencia		= c.nr_seq_segurado --and	d.nr_seq_mensalidade	= f.nr_sequencia
  and g.nr_sequencia		= c.nr_seq_plano   --and	b.cd_conta_cred		= i.cd_conta_contabil(+)
  and ((c.ie_status = ie_status_prov_pagto_w)
		or	((ie_status_prov_pagto_w <> 'F')
		and (p.ie_status in ('3','4','6')))) and p.dt_mes_competencia between dt_periodo_inicial_w and dt_periodo_final_w and ds_conta_contabil_w	 in (	select	substr(replace(i.cd_classificacao_atual,'.',''),1,8)
							from	conta_contabil i
							where	coalesce(d.cd_conta_cred_provisao,b.cd_conta_cred) = i.cd_conta_contabil) --and	substr(replace(i.cd_classificacao_atual,'.',''),1,8) = ds_conta_contabil_w
  and (((ie_tipo_quadro_w = '1') and (g.ie_preco = '1') and (g.ie_tipo_contratacao = 'I') and (g.ie_regulamentacao = 'R')) or
			 ((ie_tipo_quadro_w = '2') and (g.ie_preco = '1') and (g.ie_tipo_contratacao = 'I') and (g.ie_regulamentacao <> 'R')) or
			 ((ie_tipo_quadro_w = '3') and (g.ie_preco = '1') and (g.ie_tipo_contratacao = 'CA') and (g.ie_regulamentacao = 'R')) or
			 ((ie_tipo_quadro_w = '4') and (g.ie_preco = '1') and (g.ie_tipo_contratacao = 'CA') and (g.ie_regulamentacao <> 'R')) or
			 ((ie_tipo_quadro_w = '5') and (g.ie_preco = '1') and (g.ie_tipo_contratacao = 'CE') and (g.ie_regulamentacao = 'R')) or
			 ((ie_tipo_quadro_w = '6') and (g.ie_preco = '1') and (g.ie_tipo_contratacao = 'CE') and (g.ie_regulamentacao <> 'R')) or
			 ((ie_tipo_quadro_w = '7') and (g.ie_preco <> '1') and (g.ie_tipo_contratacao = 'I') and (g.ie_regulamentacao = 'R')) or
			 ((ie_tipo_quadro_w = '8') and (g.ie_preco <> '1') and (g.ie_tipo_contratacao = 'I') and (g.ie_regulamentacao <> 'R')) or
			 ((ie_tipo_quadro_w = '9') and (g.ie_preco <> '1') and (g.ie_tipo_contratacao = 'CA') and (g.ie_regulamentacao = 'R')) or
			 ((ie_tipo_quadro_w = '10') and (g.ie_preco <> '1') and (g.ie_tipo_contratacao = 'CA') and (g.ie_regulamentacao <> 'R')) or
			 ((ie_tipo_quadro_w = '11') and (g.ie_preco <> '1') and (g.ie_tipo_contratacao = 'CE') and (g.ie_regulamentacao = 'R')) or
			 ((ie_tipo_quadro_w = '12') and (g.ie_preco <> '1') and (g.ie_tipo_contratacao = 'CE') and (g.ie_regulamentacao <> 'R')) or
			 (ie_tipo_quadro_w = '13' AND g.ie_preco = '1')) and p.ie_tipo_protocolo		<> 'R' and ie_data_ref_copartic_w		= 'PR' group by
			a.nr_sequencia,
			b.nr_sequencia,
			j.ie_tipo_relacao,
			e.ie_tipo_segurado,
			c.nr_sequencia,
			p.ie_tipo_protocolo,
			CASE WHEN h.ie_tipo_grupo_ans='10' THEN 'Consultas' WHEN h.ie_tipo_grupo_ans='20' THEN 'Exames' WHEN h.ie_tipo_grupo_ans='30' THEN 'Terapias' WHEN h.ie_tipo_grupo_ans='41' THEN ds_internacao_w WHEN h.ie_tipo_grupo_ans='42' THEN ds_internacao_w WHEN h.ie_tipo_grupo_ans='43' THEN ds_internacao_w WHEN h.ie_tipo_grupo_ans='44' THEN ds_internacao_w WHEN h.ie_tipo_grupo_ans='45' THEN ds_internacao_w WHEN h.ie_tipo_grupo_ans='46' THEN ds_internacao_w WHEN h.ie_tipo_grupo_ans='49' THEN ds_internacao_w WHEN h.ie_tipo_grupo_ans='50' THEN 'Outros atendimentos' WHEN h.ie_tipo_grupo_ans='60' THEN 'Demais despesas'  ELSE 'Sem grupo ANS' END 
		
union all

		select	sum(d.vl_coparticipacao) vl_liberado,
			CASE WHEN h.ie_tipo_grupo_ans='10' THEN 'Consultas' WHEN h.ie_tipo_grupo_ans='20' THEN 'Exames' WHEN h.ie_tipo_grupo_ans='30' THEN 'Terapias' WHEN h.ie_tipo_grupo_ans='41' THEN ds_internacao_w WHEN h.ie_tipo_grupo_ans='42' THEN ds_internacao_w WHEN h.ie_tipo_grupo_ans='43' THEN ds_internacao_w WHEN h.ie_tipo_grupo_ans='44' THEN ds_internacao_w WHEN h.ie_tipo_grupo_ans='45' THEN ds_internacao_w WHEN h.ie_tipo_grupo_ans='46' THEN ds_internacao_w WHEN h.ie_tipo_grupo_ans='49' THEN ds_internacao_w WHEN h.ie_tipo_grupo_ans='50' THEN 'Outros atendimentos' WHEN h.ie_tipo_grupo_ans='60' THEN 'Demais despesas'  ELSE 'Sem grupo ANS' END  ds_grupo_diops,
			a.nr_sequencia nr_seq_conta_proc,
			null nr_seq_conta_mat,
			b.nr_sequencia nr_seq_conta_copartic,
			null ie_tipo_relacao,
			e.ie_tipo_segurado,
			c.nr_sequencia nr_seq_conta,
			p.ie_tipo_protocolo
		FROM pls_protocolo_conta p, conta_contabil i, pls_plano g, pls_segurado e, pls_conta_copartic_contab d, pls_conta c, pls_conta_coparticipacao b, pls_conta_proc a
LEFT OUTER JOIN ans_grupo_despesa h ON (a.nr_seq_grupo_ans = h.nr_sequencia)
WHERE c.nr_seq_protocolo	= p.nr_sequencia and b.nr_seq_conta_proc	= a.nr_sequencia and a.nr_seq_conta		= c.nr_sequencia and b.nr_seq_conta		= c.nr_sequencia and b.nr_sequencia 		= d.nr_seq_conta_copartic and e.nr_sequencia		= c.nr_seq_segurado and g.nr_sequencia		= c.nr_seq_plano  and coalesce(d.cd_conta_cred_provisao, a.cd_conta_copartic_deb)	= i.cd_conta_contabil and ((c.ie_status = ie_status_prov_pagto_w)
		or	((ie_status_prov_pagto_w <> 'F')
		and (p.ie_status in ('3','4','6')))) and p.dt_mes_competencia between dt_periodo_inicial_w and dt_periodo_final_w and substr(replace(i.cd_classificacao_atual,'.',''),1,8) = ds_conta_contabil_w and (((ie_tipo_quadro_w = '1') and (g.ie_preco = '1') and (g.ie_tipo_contratacao = 'I') and (g.ie_regulamentacao = 'R')) or
			 ((ie_tipo_quadro_w = '2') and (g.ie_preco = '1') and (g.ie_tipo_contratacao = 'I') and (g.ie_regulamentacao <> 'R')) or
			 ((ie_tipo_quadro_w = '3') and (g.ie_preco = '1') and (g.ie_tipo_contratacao = 'CA') and (g.ie_regulamentacao = 'R')) or
			 ((ie_tipo_quadro_w = '4') and (g.ie_preco = '1') and (g.ie_tipo_contratacao = 'CA') and (g.ie_regulamentacao <> 'R')) or
			 ((ie_tipo_quadro_w = '5') and (g.ie_preco = '1') and (g.ie_tipo_contratacao = 'CE') and (g.ie_regulamentacao = 'R')) or
			 ((ie_tipo_quadro_w = '6') and (g.ie_preco = '1') and (g.ie_tipo_contratacao = 'CE') and (g.ie_regulamentacao <> 'R')) or
			 ((ie_tipo_quadro_w = '7') and (g.ie_preco <> '1') and (g.ie_tipo_contratacao = 'I') and (g.ie_regulamentacao = 'R')) or
			 ((ie_tipo_quadro_w = '8') and (g.ie_preco <> '1') and (g.ie_tipo_contratacao = 'I') and (g.ie_regulamentacao <> 'R')) or
			 ((ie_tipo_quadro_w = '9') and (g.ie_preco <> '1') and (g.ie_tipo_contratacao = 'CA') and (g.ie_regulamentacao = 'R')) or
			 ((ie_tipo_quadro_w = '10') and (g.ie_preco <> '1') and (g.ie_tipo_contratacao = 'CA') and (g.ie_regulamentacao <> 'R')) or
			 ((ie_tipo_quadro_w = '11') and (g.ie_preco <> '1') and (g.ie_tipo_contratacao = 'CE') and (g.ie_regulamentacao = 'R')) or
			 ((ie_tipo_quadro_w = '12') and (g.ie_preco <> '1') and (g.ie_tipo_contratacao = 'CE') and (g.ie_regulamentacao <> 'R')) or
			 (ie_tipo_quadro_w = '13' AND g.ie_preco = '1')) and p.ie_tipo_protocolo		= 'R' and ie_data_ref_copartic_w		= 'PR' group by
			a.nr_sequencia,
			b.nr_sequencia,
			e.ie_tipo_segurado,
			c.nr_sequencia,
			p.ie_tipo_protocolo,
			CASE WHEN h.ie_tipo_grupo_ans='10' THEN 'Consultas' WHEN h.ie_tipo_grupo_ans='20' THEN 'Exames' WHEN h.ie_tipo_grupo_ans='30' THEN 'Terapias' WHEN h.ie_tipo_grupo_ans='41' THEN ds_internacao_w WHEN h.ie_tipo_grupo_ans='42' THEN ds_internacao_w WHEN h.ie_tipo_grupo_ans='43' THEN ds_internacao_w WHEN h.ie_tipo_grupo_ans='44' THEN ds_internacao_w WHEN h.ie_tipo_grupo_ans='45' THEN ds_internacao_w WHEN h.ie_tipo_grupo_ans='46' THEN ds_internacao_w WHEN h.ie_tipo_grupo_ans='49' THEN ds_internacao_w WHEN h.ie_tipo_grupo_ans='50' THEN 'Outros atendimentos' WHEN h.ie_tipo_grupo_ans='60' THEN 'Demais despesas'  ELSE 'Sem grupo ANS' END 
		
union all

		select	sum(d.vl_coparticipacao) vl_liberado,
			CASE WHEN h.ie_tipo_grupo_ans='10' THEN 'Consultas' WHEN h.ie_tipo_grupo_ans='20' THEN 'Exames' WHEN h.ie_tipo_grupo_ans='30' THEN 'Terapias' WHEN h.ie_tipo_grupo_ans='41' THEN ds_internacao_w WHEN h.ie_tipo_grupo_ans='42' THEN ds_internacao_w WHEN h.ie_tipo_grupo_ans='43' THEN ds_internacao_w WHEN h.ie_tipo_grupo_ans='44' THEN ds_internacao_w WHEN h.ie_tipo_grupo_ans='45' THEN ds_internacao_w WHEN h.ie_tipo_grupo_ans='46' THEN ds_internacao_w WHEN h.ie_tipo_grupo_ans='49' THEN ds_internacao_w WHEN h.ie_tipo_grupo_ans='50' THEN 'Outros atendimentos' WHEN h.ie_tipo_grupo_ans='60' THEN 'Demais despesas'  ELSE 'Sem grupo ANS' END  ds_grupo_diops,
			null nr_seq_conta_proc,
			a.nr_sequencia nr_seq_conta_mat,
			b.nr_sequencia nr_seq_conta_copartic,
			j.ie_tipo_relacao,
			e.ie_tipo_segurado,
			c.nr_sequencia nr_seq_conta,
			p.ie_tipo_protocolo
		FROM pls_protocolo_conta p, pls_plano g, pls_segurado e, pls_conta c
LEFT OUTER JOIN pls_prestador j ON (c.nr_seq_prestador_exec = j.nr_sequencia)
, pls_conta_mat a
LEFT OUTER JOIN ans_grupo_despesa h ON (a.nr_seq_grupo_ans = h.nr_sequencia)
, pls_conta_coparticipacao b
LEFT OUTER JOIN pls_conta_copartic_contab d ON (b.nr_sequencia = d.nr_seq_conta_copartic)
WHERE c.nr_seq_protocolo	= p.nr_sequencia and b.nr_seq_conta_mat	= a.nr_sequencia and a.nr_seq_conta		= c.nr_sequencia and b.nr_seq_conta		= c.nr_sequencia --and	b.nr_seq_mensalidade_seg = d.nr_sequencia
  and e.nr_sequencia		= c.nr_seq_segurado --and	d.nr_seq_mensalidade	= f.nr_sequencia
  and g.nr_sequencia		= c.nr_seq_plano   --and	b.cd_conta_cred		= i.cd_conta_contabil(+)
  and ((c.ie_status = ie_status_prov_pagto_w)
		or	((ie_status_prov_pagto_w <> 'F')
		and (p.ie_status in ('3','4','6')))) and p.dt_mes_competencia between dt_periodo_inicial_w and dt_periodo_final_w and ds_conta_contabil_w	 in (	select	substr(replace(i.cd_classificacao_atual,'.',''),1,8)
							from	conta_contabil i
							where	coalesce(d.cd_conta_cred_provisao,b.cd_conta_cred) = i.cd_conta_contabil) --and	substr(replace(i.cd_classificacao_atual,'.',''),1,8) = ds_conta_contabil_w
  and (((ie_tipo_quadro_w = '1') and (g.ie_preco = '1') and (g.ie_tipo_contratacao = 'I') and (g.ie_regulamentacao = 'R')) or
			 ((ie_tipo_quadro_w = '2') and (g.ie_preco = '1') and (g.ie_tipo_contratacao = 'I') and (g.ie_regulamentacao <> 'R')) or
			 ((ie_tipo_quadro_w = '3') and (g.ie_preco = '1') and (g.ie_tipo_contratacao = 'CA') and (g.ie_regulamentacao = 'R')) or
			 ((ie_tipo_quadro_w = '4') and (g.ie_preco = '1') and (g.ie_tipo_contratacao = 'CA') and (g.ie_regulamentacao <> 'R')) or
			 ((ie_tipo_quadro_w = '5') and (g.ie_preco = '1') and (g.ie_tipo_contratacao = 'CE') and (g.ie_regulamentacao = 'R')) or
			 ((ie_tipo_quadro_w = '6') and (g.ie_preco = '1') and (g.ie_tipo_contratacao = 'CE') and (g.ie_regulamentacao <> 'R')) or
			 ((ie_tipo_quadro_w = '7') and (g.ie_preco <> '1') and (g.ie_tipo_contratacao = 'I') and (g.ie_regulamentacao = 'R')) or
			 ((ie_tipo_quadro_w = '8') and (g.ie_preco <> '1') and (g.ie_tipo_contratacao = 'I') and (g.ie_regulamentacao <> 'R')) or
			 ((ie_tipo_quadro_w = '9') and (g.ie_preco <> '1') and (g.ie_tipo_contratacao = 'CA') and (g.ie_regulamentacao = 'R')) or
			 ((ie_tipo_quadro_w = '10') and (g.ie_preco <> '1') and (g.ie_tipo_contratacao = 'CA') and (g.ie_regulamentacao <> 'R')) or
			 ((ie_tipo_quadro_w = '11') and (g.ie_preco <> '1') and (g.ie_tipo_contratacao = 'CE') and (g.ie_regulamentacao = 'R')) or
			 ((ie_tipo_quadro_w = '12') and (g.ie_preco <> '1') and (g.ie_tipo_contratacao = 'CE') and (g.ie_regulamentacao <> 'R')) or
			 (ie_tipo_quadro_w = '13' AND g.ie_preco = '1')) and p.ie_tipo_protocolo		<> 'R' and ie_data_ref_copartic_w		= 'PR' group by
			a.nr_sequencia,
			b.nr_sequencia,
			j.ie_tipo_relacao,
			e.ie_tipo_segurado,
			c.nr_sequencia,
			p.ie_tipo_protocolo,
			CASE WHEN h.ie_tipo_grupo_ans='10' THEN 'Consultas' WHEN h.ie_tipo_grupo_ans='20' THEN 'Exames' WHEN h.ie_tipo_grupo_ans='30' THEN 'Terapias' WHEN h.ie_tipo_grupo_ans='41' THEN ds_internacao_w WHEN h.ie_tipo_grupo_ans='42' THEN ds_internacao_w WHEN h.ie_tipo_grupo_ans='43' THEN ds_internacao_w WHEN h.ie_tipo_grupo_ans='44' THEN ds_internacao_w WHEN h.ie_tipo_grupo_ans='45' THEN ds_internacao_w WHEN h.ie_tipo_grupo_ans='46' THEN ds_internacao_w WHEN h.ie_tipo_grupo_ans='49' THEN ds_internacao_w WHEN h.ie_tipo_grupo_ans='50' THEN 'Outros atendimentos' WHEN h.ie_tipo_grupo_ans='60' THEN 'Demais despesas'  ELSE 'Sem grupo ANS' END;

	c_itens_w c_itens%rowtype;

        /* Existem outras contas, porem conforme alinhado 14/05/2019, inicialmente apenas essas serao consideradas*/


        c_pre_pagamento CURSOR FOR
                SELECT  '1'

                
union all

		SELECT	'2'
		
		
union all

		select	'3'
		
		
union all

		select	'4'
		
		
union all

                select  '5'
                
		
union all

                select  '6'
                
                
union all

                select  '7'
                
		
union all

		select  '9'
		;

	type 		fetch_array is table of c_itens%rowtype;
	s_array 	fetch_array;
	w		integer := 1;
	type vetor_itens is table of fetch_array index by integer;
	vet_itens_w	vetor_itens;

	c_coparticipacao CURSOR FOR
		SELECT	sum(l.vl_coparticipacao) vl_liberado,
			CASE WHEN h.ie_tipo_grupo_ans='10' THEN 'Consultas' WHEN h.ie_tipo_grupo_ans='20' THEN 'Exames' WHEN h.ie_tipo_grupo_ans='30' THEN 'Terapias' WHEN h.ie_tipo_grupo_ans='41' THEN ds_internacao_w WHEN h.ie_tipo_grupo_ans='42' THEN ds_internacao_w WHEN h.ie_tipo_grupo_ans='43' THEN ds_internacao_w WHEN h.ie_tipo_grupo_ans='44' THEN ds_internacao_w WHEN h.ie_tipo_grupo_ans='45' THEN ds_internacao_w WHEN h.ie_tipo_grupo_ans='46' THEN ds_internacao_w WHEN h.ie_tipo_grupo_ans='49' THEN ds_internacao_w WHEN h.ie_tipo_grupo_ans='50' THEN 'Outros atendimentos' WHEN h.ie_tipo_grupo_ans='60' THEN 'Demais despesas'  ELSE 'Sem grupo ANS' END  ds_grupo_diops,
			a.nr_sequencia nr_seq_conta_proc,
			null nr_seq_conta_mat,
			c.nr_sequencia nr_seq_conta,
			b.nr_sequencia nr_seq_conta_copartic,
			k.ie_tipo_protocolo,
			j.ie_tipo_relacao,
			e.ie_tipo_segurado
		FROM pls_conta_copartic_contab l, pls_protocolo_conta k, conta_contabil i, pls_plano g, pls_mensalidade f, pls_segurado e, pls_mensalidade_segurado d, pls_conta_coparticipacao b, pls_conta_proc a
LEFT OUTER JOIN ans_grupo_despesa h ON (a.nr_seq_grupo_ans = h.nr_sequencia)
, pls_conta c
LEFT OUTER JOIN pls_prestador j ON (c.nr_seq_prestador_exec = j.nr_sequencia)
WHERE b.nr_seq_conta_proc	= a.nr_sequencia and a.nr_seq_conta		= c.nr_sequencia and b.nr_seq_conta		= c.nr_sequencia and b.nr_seq_mensalidade_seg = d.nr_sequencia and d.nr_seq_segurado	= e.nr_sequencia and d.nr_seq_mensalidade	= f.nr_sequencia and c.nr_seq_plano		= g.nr_sequencia  and c.nr_seq_protocolo	= k.nr_sequencia  and b.nr_sequencia 		= l.nr_seq_conta_copartic and l.cd_conta_cred_provisao	= i.cd_conta_contabil and ((c.ie_status = ie_status_prov_pagto_w)
		or	((ie_status_prov_pagto_w <> 'F')
		and (k.ie_status in ('3','4','6')))) and f.dt_referencia between dt_periodo_inicial_w and dt_periodo_final_w and substr(replace(i.cd_classificacao_atual,'.',''),1,8) = ds_conta_contabil_w and (((ie_tipo_quadro_w = '1') and (g.ie_preco = '1') and (g.ie_tipo_contratacao = 'I') and (g.ie_regulamentacao = 'R')) or
			 ((ie_tipo_quadro_w = '2') and (g.ie_preco = '1') and (g.ie_tipo_contratacao = 'I') and (g.ie_regulamentacao <> 'R')) or
			 ((ie_tipo_quadro_w = '3') and (g.ie_preco = '1') and (g.ie_tipo_contratacao = 'CA') and (g.ie_regulamentacao = 'R')) or
			 ((ie_tipo_quadro_w = '4') and (g.ie_preco = '1') and (g.ie_tipo_contratacao = 'CA') and (g.ie_regulamentacao <> 'R')) or
			 ((ie_tipo_quadro_w = '5') and (g.ie_preco = '1') and (g.ie_tipo_contratacao = 'CE') and (g.ie_regulamentacao = 'R')) or
			 ((ie_tipo_quadro_w = '6') and (g.ie_preco = '1') and (g.ie_tipo_contratacao = 'CE') and (g.ie_regulamentacao <> 'R')) or
			 ((ie_tipo_quadro_w = '7') and (g.ie_preco <> '1') and (g.ie_tipo_contratacao = 'I') and (g.ie_regulamentacao = 'R')) or
			 ((ie_tipo_quadro_w = '8') and (g.ie_preco <> '1') and (g.ie_tipo_contratacao = 'I') and (g.ie_regulamentacao <> 'R')) or
			 ((ie_tipo_quadro_w = '9') and (g.ie_preco <> '1') and (g.ie_tipo_contratacao = 'CA') and (g.ie_regulamentacao = 'R')) or
			 ((ie_tipo_quadro_w = '10') and (g.ie_preco <> '1') and (g.ie_tipo_contratacao = 'CA') and (g.ie_regulamentacao <> 'R')) or
			 ((ie_tipo_quadro_w = '11') and (g.ie_preco <> '1') and (g.ie_tipo_contratacao = 'CE') and (g.ie_regulamentacao = 'R')) or
			 ((ie_tipo_quadro_w = '12') and (g.ie_preco <> '1') and (g.ie_tipo_contratacao = 'CE') and (g.ie_regulamentacao <> 'R')) or
			(ie_tipo_quadro_w = '13' AND g.ie_preco = '1')) and k.ie_tipo_protocolo	<> 'R' group by
			a.nr_sequencia,
			b.nr_sequencia,
			c.nr_sequencia,
			k.ie_tipo_protocolo,
			j.ie_tipo_relacao,
			e.ie_tipo_segurado,
			CASE WHEN h.ie_tipo_grupo_ans='10' THEN 'Consultas' WHEN h.ie_tipo_grupo_ans='20' THEN 'Exames' WHEN h.ie_tipo_grupo_ans='30' THEN 'Terapias' WHEN h.ie_tipo_grupo_ans='41' THEN ds_internacao_w WHEN h.ie_tipo_grupo_ans='42' THEN ds_internacao_w WHEN h.ie_tipo_grupo_ans='43' THEN ds_internacao_w WHEN h.ie_tipo_grupo_ans='44' THEN ds_internacao_w WHEN h.ie_tipo_grupo_ans='45' THEN ds_internacao_w WHEN h.ie_tipo_grupo_ans='46' THEN ds_internacao_w WHEN h.ie_tipo_grupo_ans='49' THEN ds_internacao_w WHEN h.ie_tipo_grupo_ans='50' THEN 'Outros atendimentos' WHEN h.ie_tipo_grupo_ans='60' THEN 'Demais despesas'  ELSE 'Sem grupo ANS' END
		
union all

		SELECT	sum(l.vl_coparticipacao) vl_liberado,
			CASE WHEN h.ie_tipo_grupo_ans='10' THEN 'Consultas' WHEN h.ie_tipo_grupo_ans='20' THEN 'Exames' WHEN h.ie_tipo_grupo_ans='30' THEN 'Terapias' WHEN h.ie_tipo_grupo_ans='41' THEN ds_internacao_w WHEN h.ie_tipo_grupo_ans='42' THEN ds_internacao_w WHEN h.ie_tipo_grupo_ans='43' THEN ds_internacao_w WHEN h.ie_tipo_grupo_ans='44' THEN ds_internacao_w WHEN h.ie_tipo_grupo_ans='45' THEN ds_internacao_w WHEN h.ie_tipo_grupo_ans='46' THEN ds_internacao_w WHEN h.ie_tipo_grupo_ans='49' THEN ds_internacao_w WHEN h.ie_tipo_grupo_ans='50' THEN 'Outros atendimentos' WHEN h.ie_tipo_grupo_ans='60' THEN 'Demais despesas'  ELSE 'Sem grupo ANS' END  ds_grupo_diops,
			a.nr_sequencia nr_seq_conta_proc,
			null nr_seq_conta_mat,
			c.nr_sequencia nr_seq_conta,
			b.nr_sequencia nr_seq_conta_copartic,
			k.ie_tipo_protocolo,
			null ie_tipo_relacao,
			e.ie_tipo_segurado
		FROM pls_conta_copartic_contab l, pls_protocolo_conta k, conta_contabil i, pls_plano g, pls_segurado e, pls_conta c, pls_conta_coparticipacao b, pls_conta_proc a
LEFT OUTER JOIN ans_grupo_despesa h ON (a.nr_seq_grupo_ans = h.nr_sequencia)
WHERE b.nr_seq_conta_proc	= a.nr_sequencia and a.nr_seq_conta		= c.nr_sequencia and b.nr_seq_conta		= c.nr_sequencia and c.nr_seq_segurado	= e.nr_sequencia and c.nr_seq_plano		= g.nr_sequencia and c.nr_seq_protocolo	= k.nr_sequencia and b.nr_sequencia 		= l.nr_seq_conta_copartic  and coalesce(l.cd_conta_cred_provisao, a.cd_conta_copartic_deb)	= i.cd_conta_contabil and ((c.ie_status = ie_status_prov_pagto_w)
		or	((ie_status_prov_pagto_w <> 'F')
		and (k.ie_status in ('3','4','6')))) and k.dt_mes_competencia between dt_periodo_inicial_w and dt_periodo_final_w and substr(replace(i.cd_classificacao_atual,'.',''),1,8) = ds_conta_contabil_w and (((ie_tipo_quadro_w = '1') and (g.ie_preco = '1') and (g.ie_tipo_contratacao = 'I') and (g.ie_regulamentacao = 'R')) or
			 ((ie_tipo_quadro_w = '2') and (g.ie_preco = '1') and (g.ie_tipo_contratacao = 'I') and (g.ie_regulamentacao <> 'R')) or
			 ((ie_tipo_quadro_w = '3') and (g.ie_preco = '1') and (g.ie_tipo_contratacao = 'CA') and (g.ie_regulamentacao = 'R')) or
			 ((ie_tipo_quadro_w = '4') and (g.ie_preco = '1') and (g.ie_tipo_contratacao = 'CA') and (g.ie_regulamentacao <> 'R')) or
			 ((ie_tipo_quadro_w = '5') and (g.ie_preco = '1') and (g.ie_tipo_contratacao = 'CE') and (g.ie_regulamentacao = 'R')) or
			 ((ie_tipo_quadro_w = '6') and (g.ie_preco = '1') and (g.ie_tipo_contratacao = 'CE') and (g.ie_regulamentacao <> 'R')) or
			 ((ie_tipo_quadro_w = '7') and (g.ie_preco <> '1') and (g.ie_tipo_contratacao = 'I') and (g.ie_regulamentacao = 'R')) or
			 ((ie_tipo_quadro_w = '8') and (g.ie_preco <> '1') and (g.ie_tipo_contratacao = 'I') and (g.ie_regulamentacao <> 'R')) or
			 ((ie_tipo_quadro_w = '9') and (g.ie_preco <> '1') and (g.ie_tipo_contratacao = 'CA') and (g.ie_regulamentacao = 'R')) or
			 ((ie_tipo_quadro_w = '10') and (g.ie_preco <> '1') and (g.ie_tipo_contratacao = 'CA') and (g.ie_regulamentacao <> 'R')) or
			 ((ie_tipo_quadro_w = '11') and (g.ie_preco <> '1') and (g.ie_tipo_contratacao = 'CE') and (g.ie_regulamentacao = 'R')) or
			 ((ie_tipo_quadro_w = '12') and (g.ie_preco <> '1') and (g.ie_tipo_contratacao = 'CE') and (g.ie_regulamentacao <> 'R')) or
			 (ie_tipo_quadro_w = '13' AND g.ie_preco = '1')) and k.ie_tipo_protocolo = 'R' group by
			a.nr_sequencia,
			b.nr_sequencia,
			c.nr_sequencia,
			k.ie_tipo_protocolo,
			e.ie_tipo_segurado,
			CASE WHEN h.ie_tipo_grupo_ans='10' THEN 'Consultas' WHEN h.ie_tipo_grupo_ans='20' THEN 'Exames' WHEN h.ie_tipo_grupo_ans='30' THEN 'Terapias' WHEN h.ie_tipo_grupo_ans='41' THEN ds_internacao_w WHEN h.ie_tipo_grupo_ans='42' THEN ds_internacao_w WHEN h.ie_tipo_grupo_ans='43' THEN ds_internacao_w WHEN h.ie_tipo_grupo_ans='44' THEN ds_internacao_w WHEN h.ie_tipo_grupo_ans='45' THEN ds_internacao_w WHEN h.ie_tipo_grupo_ans='46' THEN ds_internacao_w WHEN h.ie_tipo_grupo_ans='49' THEN ds_internacao_w WHEN h.ie_tipo_grupo_ans='50' THEN 'Outros atendimentos' WHEN h.ie_tipo_grupo_ans='60' THEN 'Demais despesas'  ELSE 'Sem grupo ANS' END 
		
union all

		select	sum(l.vl_coparticipacao) vl_liberado,
			CASE WHEN h.ie_tipo_grupo_ans='10' THEN 'Consultas' WHEN h.ie_tipo_grupo_ans='20' THEN 'Exames' WHEN h.ie_tipo_grupo_ans='30' THEN 'Terapias' WHEN h.ie_tipo_grupo_ans='41' THEN ds_internacao_w WHEN h.ie_tipo_grupo_ans='42' THEN ds_internacao_w WHEN h.ie_tipo_grupo_ans='43' THEN ds_internacao_w WHEN h.ie_tipo_grupo_ans='44' THEN ds_internacao_w WHEN h.ie_tipo_grupo_ans='45' THEN ds_internacao_w WHEN h.ie_tipo_grupo_ans='46' THEN ds_internacao_w WHEN h.ie_tipo_grupo_ans='49' THEN ds_internacao_w WHEN h.ie_tipo_grupo_ans='50' THEN 'Outros atendimentos' WHEN h.ie_tipo_grupo_ans='60' THEN 'Demais despesas'  ELSE 'Sem grupo ANS' END  ds_grupo_diops,
			null nr_seq_conta_proc,
			a.nr_sequencia nr_seq_conta_mat,
			c.nr_sequencia nr_seq_conta,
			b.nr_sequencia nr_seq_conta_copartic,
			k.ie_tipo_protocolo,
			j.ie_tipo_relacao,
			e.ie_tipo_segurado
		FROM pls_conta_copartic_contab l, pls_protocolo_conta k, pls_prestador j, conta_contabil i, pls_plano g, pls_mensalidade f, pls_segurado e, pls_mensalidade_segurado d, pls_conta c, pls_conta_coparticipacao b, pls_conta_mat a
LEFT OUTER JOIN ans_grupo_despesa h ON (a.nr_seq_grupo_ans = h.nr_sequencia)
WHERE b.nr_seq_conta_mat	= a.nr_sequencia and a.nr_seq_conta		= c.nr_sequencia and b.nr_seq_conta		= c.nr_sequencia and b.nr_seq_mensalidade_seg = d.nr_sequencia and d.nr_seq_segurado	= e.nr_sequencia and d.nr_seq_mensalidade	= f.nr_sequencia and c.nr_seq_plano		= g.nr_sequencia and c.nr_seq_prestador_exec	= j.nr_sequencia and b.nr_sequencia 		= l.nr_seq_conta_copartic and c.nr_seq_protocolo	= k.nr_sequencia  and l.cd_conta_cred_provisao		= i.cd_conta_contabil and ((c.ie_status = ie_status_prov_pagto_w)
		or	((ie_status_prov_pagto_w <> 'F')
		and (k.ie_status in ('3','4','6')))) and f.dt_referencia between dt_periodo_inicial_w and dt_periodo_final_w and substr(replace(i.cd_classificacao_atual,'.',''),1,8) = ds_conta_contabil_w and (((ie_tipo_quadro_w = '1') and (g.ie_preco = '1') and (g.ie_tipo_contratacao = 'I') and (g.ie_regulamentacao = 'R')) or
			 ((ie_tipo_quadro_w = '2') and (g.ie_preco = '1') and (g.ie_tipo_contratacao = 'I') and (g.ie_regulamentacao <> 'R')) or
			 ((ie_tipo_quadro_w = '3') and (g.ie_preco = '1') and (g.ie_tipo_contratacao = 'CA') and (g.ie_regulamentacao = 'R')) or
			 ((ie_tipo_quadro_w = '4') and (g.ie_preco = '1') and (g.ie_tipo_contratacao = 'CA') and (g.ie_regulamentacao <> 'R')) or
			 ((ie_tipo_quadro_w = '5') and (g.ie_preco = '1') and (g.ie_tipo_contratacao = 'CE') and (g.ie_regulamentacao = 'R')) or
			 ((ie_tipo_quadro_w = '6') and (g.ie_preco = '1') and (g.ie_tipo_contratacao = 'CE') and (g.ie_regulamentacao <> 'R')) or
			 ((ie_tipo_quadro_w = '7') and (g.ie_preco <> '1') and (g.ie_tipo_contratacao = 'I') and (g.ie_regulamentacao = 'R')) or
			 ((ie_tipo_quadro_w = '8') and (g.ie_preco <> '1') and (g.ie_tipo_contratacao = 'I') and (g.ie_regulamentacao <> 'R')) or
			 ((ie_tipo_quadro_w = '9') and (g.ie_preco <> '1') and (g.ie_tipo_contratacao = 'CA') and (g.ie_regulamentacao = 'R')) or
			 ((ie_tipo_quadro_w = '10') and (g.ie_preco <> '1') and (g.ie_tipo_contratacao = 'CA') and (g.ie_regulamentacao <> 'R')) or
			 ((ie_tipo_quadro_w = '11') and (g.ie_preco <> '1') and (g.ie_tipo_contratacao = 'CE') and (g.ie_regulamentacao = 'R')) or
			 ((ie_tipo_quadro_w = '12') and (g.ie_preco <> '1') and (g.ie_tipo_contratacao = 'CE') and (g.ie_regulamentacao <> 'R')) or
			 (ie_tipo_quadro_w = '13' AND g.ie_preco = '1')) and k.ie_tipo_protocolo	<> 'R' group by
			a.nr_sequencia,
			b.nr_sequencia,
			c.nr_sequencia,
			k.ie_tipo_protocolo,
			j.ie_tipo_relacao,
			e.ie_tipo_segurado,
			CASE WHEN h.ie_tipo_grupo_ans='10' THEN 'Consultas' WHEN h.ie_tipo_grupo_ans='20' THEN 'Exames' WHEN h.ie_tipo_grupo_ans='30' THEN 'Terapias' WHEN h.ie_tipo_grupo_ans='41' THEN ds_internacao_w WHEN h.ie_tipo_grupo_ans='42' THEN ds_internacao_w WHEN h.ie_tipo_grupo_ans='43' THEN ds_internacao_w WHEN h.ie_tipo_grupo_ans='44' THEN ds_internacao_w WHEN h.ie_tipo_grupo_ans='45' THEN ds_internacao_w WHEN h.ie_tipo_grupo_ans='46' THEN ds_internacao_w WHEN h.ie_tipo_grupo_ans='49' THEN ds_internacao_w WHEN h.ie_tipo_grupo_ans='50' THEN 'Outros atendimentos' WHEN h.ie_tipo_grupo_ans='60' THEN 'Demais despesas'  ELSE 'Sem grupo ANS' END;

	c_copartic_w c_coparticipacao%rowtype;

	
BEGIN
	delete	from diops_fin_cob_assist
	where	nr_seq_periodo	= nr_seq_periodo_p;

	commit;

	delete 	from w_diops_fin_cob_assist
	where	nr_seq_periodo	= nr_seq_periodo_p;

	commit;

	ie_forma_geracao_w	:= obter_valor_param_usuario(1227,9,obter_perfil_ativo,nm_usuario_p,cd_estabelecimento_p);
	ie_data_ref_copartic_w	:= coalesce(obter_valor_param_usuario(1227,10,obter_perfil_ativo,nm_usuario_p,cd_estabelecimento_p),'ME');
	ie_aplica_recalc_w	:= obter_valor_param_usuario(1314,3,obter_perfil_ativo,nm_usuario_p,cd_estabelecimento_p);
	pls_obter_pls_parametros(cd_estabelecimento_p,'ie_cobertura_assistencial','G',ie_cobertura_assistencial_w);

	select	case
		    when fim_dia(dt_periodo_final) >= to_date('01/01/2018','dd/mm/yyyy')
			then pkg_date_utils.start_of(dt_periodo_inicial,'MONTH',0) -- inicio do mes
		    else trunc(dt_periodo_inicial,'year') -- inicio do ano
		end,
		fim_dia(dt_periodo_final)
	into STRICT	dt_periodo_inicial_w,
		dt_periodo_final_w
	from	diops_periodo
	where	nr_sequencia	= nr_seq_periodo_p;

	select	max(a.ie_tipo_outorgante)
	into STRICT	ie_tipo_outorgante_w
	from	pls_outorgante	a
	where	a.cd_estabelecimento	= cd_estabelecimento_p;

	select	coalesce(max(ie_status_prov_pagto), 'NC'),
	        coalesce(max(ie_forma_contab_taxa_pgto),'N')
	into STRICT	ie_status_prov_pagto_w,
	      	ie_forma_contab_taxa_pgto_w
	from	pls_parametro_contabil
	where	cd_estabelecimento 	= cd_estabelecimento_p;

	/* Busca os periodos anteriores do mesmo ano, apartir de 2017, para depois buscar as informacoes ja geradas nesses periodos . */


	select	max(x.nr_seq_trim_1),
		max(x.nr_seq_trim_2),
		max(x.nr_seq_trim_3)
	into STRICT	nr_seq_trim_1_w,
		nr_seq_trim_2_w,
		nr_seq_trim_3_w
	from (SELECT	CASE WHEN ceil(to_char(a.dt_periodo_final,'mm') / 3)=1 THEN max(a.nr_sequencia) END  nr_seq_trim_1,
			CASE WHEN ceil(to_char(a.dt_periodo_final,'mm') / 3)=2 THEN max(a.nr_sequencia) END  nr_seq_trim_2,
			CASE WHEN ceil(to_char(a.dt_periodo_final,'mm') / 3)=3 THEN max(a.nr_sequencia) END  nr_seq_trim_3
		from	diops_periodo	a
		where	a.ie_tipo_periodo_diops	in ('T','F')
		and	pkg_date_utils.start_of(a.dt_periodo_final, 'YEAR')	= pkg_date_utils.start_of(dt_periodo_final_w, 'YEAR')
		and	pkg_date_utils.start_of(a.dt_periodo_final, 'MONTH', 0)	<= pkg_date_utils.start_of(dt_periodo_final_w, 'MONTH', 0)
		and	dt_periodo_final_w					>= to_date('01/01/2017','dd/mm/yyyy')
		group by to_char(a.dt_periodo_final,'mm')) x;

	ie_data_ref_copartic_w	:= 'PR';

	open c_tipo;
	loop
	fetch c_tipo into
		ie_tipo_w;
	EXIT WHEN NOT FOUND; /* apply on c_tipo */
		begin

		open c_dominio;
		loop
		fetch c_dominio into
			ie_tipo_quadro_w,
			ie_ato_w;
		EXIT WHEN NOT FOUND; /* apply on c_dominio */
			begin

                        open c_pre_pagamento;
                        loop
                          fetch c_pre_pagamento into
                                nr_tipo_pre_pagamento_w;
                        EXIT WHEN NOT FOUND; /* apply on c_pre_pagamento */
                        begin
                                w	:= 1;

                                SELECT * FROM diops_fin_gerar_assist_pck.diops_fin_gravar_assistencial(	'C',  -- ie_etapa_p
                                                                ie_tipo_w,  -- ie_tipo_p
                                                                ie_tipo_quadro_w,  -- ie_tipo_quadro_p
                                                                ie_ato_w,  -- ie_ato_p
                                                                ie_tipo_dado_w,  -- ie_tipo_dado_p
                                                                '',  -- ds_grupo_diops_p
                                                                0,  -- vl_item_p
                                                                nr_seq_periodo_p,  -- nr_seq_periodo_p
                                                                nm_usuario_p,  -- nm_usuario_p
                                                                null,  -- nr_seq_conta_p
                                                                null,  -- nr_seq_conta_proc_p
                                                                null,  -- nr_seq_conta_mat_p
                                                                null,  --nr_seq_conta_copartic_p
                                                                nr_tipo_pre_pagamento_w,  -- nr_tipo_pre_pagamento_p
                                                                ds_conta_contabil_w,  -- ds_conta_contabil_p
                                                                ie_cobertura_w,  -- ie_cobertura_p
                                                                ds_plano_w) INTO STRICT 
                                                                ds_conta_contabil_w, 
                                                                ie_cobertura_w, 
                                                                ds_plano_w; -- ds_plano_p

                                if (ie_cobertura_assistencial_w in ('G','GI')) then
                                        begin


					select	substr(obter_desc_expressao(825075),1, 255)
					into STRICT	ds_internacao_w
					;

                                        vet_itens_w.delete;

                                        open c_itens;
                                        loop
                                        fetch c_itens bulk collect into s_array limit 1000;
                                                vet_itens_w(w)		:= s_array;
                                                w			:= w + 1;
                                        EXIT WHEN NOT FOUND; /* apply on c_itens */
                                        end loop;
                                        close c_itens;

                                        for i in 1..vet_itens_w.count loop
                                                s_array := vet_itens_w(i);
                                                for y in 1..s_array.count loop
                                                        begin

                                                        ie_tipo_relacao_w	:= s_array[y].ie_tipo_relacao;
                                                        ie_tipo_segurado_w	:= s_array[y].ie_tipo_segurado;
                                                        ie_tipo_protocolo_w	:= s_array[y].ie_tipo_protocolo;
                                                        vl_liberado_w		:= s_array[y].vl_liberado;
                                                        nr_seq_conta_copartic_w	:= s_array[y].nr_seq_conta_copartic;
                                                        nr_seq_conta_w		:= s_array[y].nr_seq_conta;
                                                        nr_seq_conta_proc_w	:= s_array[y].nr_seq_conta_proc;
                                                        nr_seq_conta_mat_w	:= s_array[y].nr_seq_conta_mat;
                                                        ds_grupo_diops_w	:= s_array[y].ds_grupo_diops;

                                                        ie_tipo_dado_w	:= null;

                                                        if (ie_tipo_relacao_w in ('C','P')) and (ie_tipo_protocolo_w <> 'R') then
                                                                ie_tipo_dado_w	:= 'RP';
                                                        end if;

                                                        if (ie_tipo_relacao_w not in ('C','P')) and (ie_tipo_protocolo_w <> 'R') then
                                                                ie_tipo_dado_w	:= 'RC';
                                                        end if;

                                                        if (ie_tipo_segurado_w = 'R' and
                                                                ie_tipo_protocolo_w <> 'R') then
                                                                ie_tipo_dado_w := 'AC';
                                                        end if;

                                                        if (ie_tipo_protocolo_w = 'R') then
                                                                ie_tipo_dado_w	:= 'RE';
                                                        end if;

                                                        if (ie_tipo_protocolo_w in ('I','F')) then
                                                                ie_tipo_dado_w	:= 'IE';
                                                        end if;

                                                        if (coalesce(nr_seq_conta_copartic_w,0) <> 0) then
                                                                vl_liberado_w	:= coalesce(vl_liberado_w,0) * -1;
                                                        end if;

                                                        if (coalesce(ie_tipo_dado_w,'X') <> 'X') then
                                                                SELECT * FROM diops_fin_gerar_assist_pck.diops_fin_gravar_assistencial(	'R',  -- ie_etapa_p
                                                                                                ie_tipo_w,  -- ie_tipo_p
                                                                                                ie_tipo_quadro_w,  -- ie_tipo_quadro_p
                                                                                                ie_ato_w,  -- ie_ato_p
                                                                                                ie_tipo_dado_w,  -- ie_tipo_dado_p
                                                                                                ds_grupo_diops_w,  -- ds_grupo_diops_p
                                                                                                coalesce(vl_liberado_w,0),  -- vl_item_p
                                                                                                nr_seq_periodo_p,  -- nr_seq_periodo_p
                                                                                                nm_usuario_p,  -- nm_usuario_p
                                                                                                nr_seq_conta_w,  -- nr_seq_conta_p
                                                                                                nr_seq_conta_proc_w,  -- nr_seq_conta_proc_p
                                                                                                nr_seq_conta_mat_w,  -- nr_seq_conta_mat_p
                                                                                                nr_seq_conta_copartic_w,  --nr_seq_conta_copartic_p,
                                                                                                nr_tipo_pre_pagamento_w,  -- nr_tipo_pre_pagamento_p
                                                                                                ds_conta_contabil_w,  -- ds_conta_contabil_p
                                                                                                ie_cobertura_w,  -- ie_cobertura_p
                                                                                                ds_plano_w) INTO STRICT 
                                                                                                ds_conta_contabil_w, 
                                                                                                ie_cobertura_w, 
                                                                                                ds_plano_w; -- ds_plano_p
                                                        end if;

                                                        end;
                                                end loop;
                                        end loop;

                                        if (ie_data_ref_copartic_w = 'ME') then

                                                open c_coparticipacao;
                                                loop
                                                fetch c_coparticipacao into
                                                        c_copartic_w;
                                                EXIT WHEN NOT FOUND; /* apply on c_coparticipacao */
                                                        begin
                                                        ie_tipo_dado_w	:= null;

                                                        if (c_copartic_w.ie_tipo_relacao in ('C','P')) and (c_copartic_w.ie_tipo_protocolo <> 'R') then
                                                                ie_tipo_dado_w	:= 'RP';
                                                        end if;

                                                        if (c_copartic_w.ie_tipo_relacao not in ('C','P')) and (c_copartic_w.ie_tipo_protocolo <> 'R') then
                                                                ie_tipo_dado_w	:= 'RC';
                                                        end if;

                                                        if (ie_tipo_segurado_w = 'R' and
                                                                ie_tipo_protocolo_w <> 'R') then
                                                                ie_tipo_dado_w := 'AC';
                                                        end if;

                                                        if (c_copartic_w.ie_tipo_protocolo = 'R') then
                                                                ie_tipo_dado_w	:= 'RE';
                                                        end if;

                                                        if (c_copartic_w.ie_tipo_protocolo in ('I','F')) then
                                                                ie_tipo_dado_w	:= 'IE';
                                                        end if;

                                                        if (coalesce(ie_tipo_dado_w,'X') <> 'X') then
                                                                SELECT * FROM diops_fin_gerar_assist_pck.diops_fin_gravar_assistencial(	'R',  -- ie_etapa_p
                                                                                                ie_tipo_w,  -- ie_tipo_p
                                                                                                ie_tipo_quadro_w,  -- ie_tipo_quadro_p
                                                                                                ie_ato_w,  -- ie_ato_p
                                                                                                ie_tipo_dado_w,  -- ie_tipo_dado_p
                                                                                                c_copartic_w.ds_grupo_diops,  -- ds_grupo_diops_p
                                                                                                coalesce(c_copartic_w.vl_liberado,0) * -1,  -- vl_item_p
                                                                                                nr_seq_periodo_p,  -- nr_seq_periodo_p
                                                                                                nm_usuario_p,  -- nm_usuario_p
                                                                                                c_copartic_w.nr_seq_conta,  -- nr_seq_conta_p
                                                                                                c_copartic_w.nr_seq_conta_proc,  -- nr_seq_conta_proc_p
                                                                                                c_copartic_w.nr_seq_conta_mat,  -- nr_seq_conta_mat_p
                                                                                                c_copartic_w.nr_seq_conta_copartic,  --nr_seq_conta_copartic_p
                                                                                                nr_tipo_pre_pagamento_w,  -- nr_tipo_pre_pagamento_p
                                                                                                ds_conta_contabil_w,  -- ds_conta_contabil_p
                                                                                                ie_cobertura_w,  -- ie_cobertura_p
                                                                                                ds_plano_w) INTO STRICT 
                                                                                                ds_conta_contabil_w, 
                                                                                                ie_cobertura_w, 
                                                                                                ds_plano_w; -- ds_plano_p
                                                        end if;

                                                        end;
                                                end loop;
                                                close c_coparticipacao;
                                        end if;
                                        end;
                                end if;
                        end;
                        end loop;
                        close c_pre_pagamento;
                end;
		end loop;
		close c_dominio;

		end;
	end loop;
	close c_tipo;

	forall i in current_setting('diops_fin_gerar_assist_pck.diops_cob_assist_w')::t_diops_fin_cob_assist.first .. current_setting('diops_fin_gerar_assist_pck.diops_cob_assist_w')::t_diops_fin_cob_assist.last
		insert into w_diops_fin_cob_assist values current_setting('diops_fin_gerar_assist_pck.diops_cob_assist_w')::t_diops_fin_cob_assist(i);
	commit;
	current_setting('diops_fin_gerar_assist_pck.diops_cob_assist_w')::t_diops_fin_cob_assist.delete;

	insert into diops_fin_cob_assist(nr_sequencia,
			nr_seq_periodo,
			ds_conta_contabil,
			ie_tipo_quadro,
			nm_usuario,
			nm_usuario_nrec,
			dt_atualizacao,
			dt_atualizacao_nrec,
			ds_plano,
			ie_cobertura,
			ie_tipo,
			vl_consulta_rp,
			vl_consulta_rc,
			vl_consulta_re,
			vl_consulta_ie,
			vl_consulta_op,
			vl_consulta_corresp,
			vl_exame_rp,
			vl_exame_rc,
			vl_exame_re,
			vl_exame_ie,
			vl_exame_op,
			vl_exame_corresp,
			vl_terapia_rp,
			vl_terapia_rc,
			vl_terapia_re,
			vl_terapia_ie,
			vl_terapia_op,
			vl_terapia_corresp,
			vl_intern_rp,
			vl_intern_rc,
			vl_intern_re,
			vl_intern_ie,
			vl_intern_op,
			vl_intern_corresp,
			vl_atendimento_rp,
			vl_atendimento_rc,
			vl_atendimento_re,
			vl_atendimento_ie,
			vl_atendimento_op,
			vl_atendimento_corresp,
			vl_despesas_rp,
			vl_despesas_rc,
			vl_despesas_re,
			vl_despesas_ie,
			vl_despesas_op,
			vl_despesas_corresp,
			vl_odonto_rp,
			vl_odonto_rc,
			vl_odonto_re,
			vl_odonto_ie)
		SELECT	nextval('diops_fin_cob_assist_seq'),
			nr_seq_periodo_p,
			x.ds_conta_contabil,
			x.ie_tipo_quadro,
			x.nm_usuario,
			x.nm_usuario_nrec,
			x.dt_atualizacao,
			x.dt_atualizacao_nrec,
			x.ds_plano,
			x.ie_cobertura,
			x.ie_tipo,
			x.vl_consulta_rp,
			x.vl_consulta_rc,
			x.vl_consulta_re,
			x.vl_consulta_ie,
			x.vl_consulta_op,
			x.vl_consulta_corresp,
			x.vl_exame_rp,
			x.vl_exame_rc,
			x.vl_exame_re,
			x.vl_exame_ie,
			x.vl_exame_op,
			x.vl_exame_corresp,
			x.vl_terapia_rp,
			x.vl_terapia_rc,
			x.vl_terapia_re,
			x.vl_terapia_ie,
			x.vl_terapia_op,
			x.vl_terapia_corresp,
			x.vl_intern_rp,
			x.vl_intern_rc,
			x.vl_intern_re,
			x.vl_intern_ie,
			x.vl_intern_op,
			x.vl_intern_corresp,
			x.vl_atendimento_rp,
			x.vl_atendimento_rc,
			x.vl_atendimento_re,
			x.vl_atendimento_ie,
			x.vl_atendimento_op,
			x.vl_atendimento_corresp,
			x.vl_despesas_rp,
			x.vl_despesas_rc,
			x.vl_despesas_re,
			x.vl_despesas_ie,
			x.vl_despesas_op,
			x.vl_despesas_corresp,
			x.vl_odonto_rp,
			x.vl_odonto_rc,
			x.vl_odonto_re,
			x.vl_odonto_ie
		from	(SELECT	a.ds_conta_contabil,
				a.ie_tipo_quadro,
				nm_usuario_p nm_usuario,
				nm_usuario_p nm_usuario_nrec,
				clock_timestamp() dt_atualizacao,
				clock_timestamp() dt_atualizacao_nrec,
				a.ds_plano,
				a.ie_cobertura,
				a.ie_tipo,
				sum(a.vl_consulta_rp) vl_consulta_rp,
				sum(a.vl_consulta_rc) vl_consulta_rc,
				sum(a.vl_consulta_re) vl_consulta_re,
				sum(a.vl_consulta_ie) vl_consulta_ie,
				sum(a.vl_consulta_op) vl_consulta_op,
				sum(a.vl_consulta_corresp) vl_consulta_corresp,
				sum(a.vl_exame_rp) vl_exame_rp,
				sum(a.vl_exame_rc) vl_exame_rc,
				sum(a.vl_exame_re) vl_exame_re,
				sum(a.vl_exame_ie) vl_exame_ie,
				sum(a.vl_exame_op) vl_exame_op,
				sum(a.vl_exame_corresp) vl_exame_corresp,
				sum(a.vl_terapia_rp) vl_terapia_rp,
				sum(a.vl_terapia_rc) vl_terapia_rc,
				sum(a.vl_terapia_re) vl_terapia_re,
				sum(a.vl_terapia_ie) vl_terapia_ie,
				sum(a.vl_terapia_op) vl_terapia_op,
				sum(a.vl_terapia_corresp) vl_terapia_corresp,
				sum(a.vl_intern_rp) vl_intern_rp,
				sum(a.vl_intern_rc) vl_intern_rc,
				sum(a.vl_intern_re) vl_intern_re,
				sum(a.vl_intern_ie) vl_intern_ie,
				sum(a.vl_intern_op) vl_intern_op,
				sum(a.vl_intern_corresp) vl_intern_corresp,
				sum(a.vl_atendimento_rp) vl_atendimento_rp,
				sum(a.vl_atendimento_rc) vl_atendimento_rc,
				sum(a.vl_atendimento_re) vl_atendimento_re,
				sum(a.vl_atendimento_ie) vl_atendimento_ie,
				sum(a.vl_atendimento_op) vl_atendimento_op,
				sum(a.vl_atendimento_corresp) vl_atendimento_corresp,
				sum(a.vl_despesas_rp) vl_despesas_rp,
				sum(a.vl_despesas_rc) vl_despesas_rc,
				sum(a.vl_despesas_re) vl_despesas_re,
				sum(a.vl_despesas_ie) vl_despesas_ie,
				sum(a.vl_despesas_op) vl_despesas_op,
				sum(a.vl_despesas_corresp) vl_despesas_corresp,
				sum(a.vl_odonto_rp) vl_odonto_rp,
				sum(a.vl_odonto_rc) vl_odonto_rc,
				sum(a.vl_odonto_re) vl_odonto_re,
				sum(a.vl_odonto_ie) vl_odonto_ie
			from	w_diops_fin_cob_assist a
			where	((ie_cobertura_assistencial_w in ('G','GI')
			and	a.nr_seq_periodo	in (nr_seq_periodo_p, nr_seq_trim_1_w, nr_seq_trim_2_w, nr_seq_trim_3_w))
			or	a.nr_seq_periodo	= nr_seq_periodo_p)
			group by
				a.ds_conta_contabil,
				a.ie_tipo_quadro,
				a.ds_plano,
				a.ie_cobertura,
				a.ie_tipo) x;
	commit;

	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE diops_fin_gerar_assist_pck.diops_fin_gerar_assistencial ( nr_seq_periodo_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;
