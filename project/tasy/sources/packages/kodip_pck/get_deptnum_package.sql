-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION kodip_pck.get_deptnum ( nr_atendimento_p bigint, nr_seq_atepacu_p bigint default null, dt_referencia_p timestamp default null) RETURNS bigint AS $body$
DECLARE


deptnum_w		bigint;
nr_seq_atepacu_w		atend_paciente_unidade.nr_seq_interno%type;
nr_atendimento_w		atendimento_paciente.nr_atendimento%type;
nr_seq_episodio_w		atendimento_paciente.nr_seq_episodio%type;


BEGIN
begin
select	a.nr_seq_interno,
	a.nr_atendimento,
	b.nr_seq_episodio
into STRICT	nr_seq_atepacu_w,
	nr_atendimento_w,
	nr_seq_episodio_w
from	atend_paciente_unidade a,
	atendimento_paciente b
where	a.nr_atendimento = b.nr_atendimento
and	a.nr_seq_interno = nr_seq_atepacu_p;
exception
when others then
	begin
	begin
	select	nr_atendimento,
		nr_seq_episodio
	into STRICT	nr_atendimento_w,
		nr_seq_episodio_w
	from	atendimento_paciente
	where	nr_atendimento = nr_atendimento_p;
	exception
	when others then
		nr_atendimento_w	:=	null;
	end;
	
	if (nr_atendimento_w IS NOT NULL AND nr_atendimento_w::text <> '') then
		if (dt_referencia_p IS NOT NULL AND dt_referencia_p::text <> '') then
			begin
			nr_seq_atepacu_w	:= obter_atepacu_data(nr_atendimento_w, 'A', dt_referencia_p);
			
			select	a.nr_seq_interno
			into STRICT	nr_seq_atepacu_w
			from	atend_paciente_unidade a
			where	a.nr_seq_interno = nr_seq_atepacu_w;
			exception
			when others then
				nr_seq_atepacu_w	:= obter_atepacu_paciente(nr_atendimento_w, 'A');
			end;
		else
			nr_seq_atepacu_w	:= obter_atepacu_paciente(nr_atendimento_w, 'A');
		end if;
	end if;
	end;
end;

begin
select	id
into STRICT	deptnum_w
from	table(kodip_pck.get_department(nr_seq_episodio_w, nr_atendimento_w))
where	nr_seq_interno = nr_seq_atepacu_w;
exception
when others then
	deptnum_w	:=	null;
end;

return deptnum_w;
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION kodip_pck.get_deptnum ( nr_atendimento_p bigint, nr_seq_atepacu_p bigint default null, dt_referencia_p timestamp default null) FROM PUBLIC;
