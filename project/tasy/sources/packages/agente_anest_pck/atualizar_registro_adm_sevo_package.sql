-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE agente_anest_pck.atualizar_registro_adm_sevo ( ie_tipo_agente_p bigint, qt_utilizada_p bigint, nr_cirurgia_p bigint, ie_tipo_Halogenado_p bigint default null) AS $body$
DECLARE

	nr_seq_agente_anest_ww  	bigint;
	nr_sequencia_ww			bigint;
	nr_seq_agente_anest_ocor_w	bigint;
	ie_tipo_Halogenado_w		bigint	:= coalesce(ie_tipo_Halogenado_p,0);
	
	
BEGIN	
	
		
	if (ie_tipo_agente_p = 4) then

		select 	max(nr_sequencia) /*Alterado dia 02/mar/2018 apos ver que o sevo era Oxigenio com Liquido Gas*/
		into STRICT	nr_seq_agente_anest_ww
		from	agente_anestesico
		where	ie_integracao = 'O2'
		and	ie_situacao = 'A'
		and	coalesce(IE_HALOG_TIPO,ie_tipo_Halogenado_w) = ie_tipo_Halogenado_w
		and 	ie_forma_farmaceutica = 'LG';
		
		select 	max(nr_sequencia)
		into STRICT	nr_sequencia_ww
		from	cirurgia_agente_anestesico
		where 	nr_seq_agente 		= nr_seq_agente_anest_ww
		and	nr_cirurgia		= nr_cirurgia_p;
		
		select	max(nr_sequencia)
		into STRICT	nr_seq_agente_anest_ocor_w
		from	cirurgia_agente_anest_ocor
		where	nr_seq_cirur_agente 	= nr_sequencia_ww;
		
		update	cirurgia_agente_anest_ocor
		set	qt_utilizada	= qt_utilizada_p
		where	nr_sequencia 	= nr_seq_agente_anest_ocor_w;	

		commit;
	elsif (ie_tipo_agente_p	= 2) then
	
		select 	max(nr_sequencia)
		into STRICT	nr_seq_agente_anest_ww
		from	agente_anestesico
		where	ie_integracao = 'N2O'
		and	coalesce(IE_HALOG_TIPO,ie_tipo_Halogenado_w) = ie_tipo_Halogenado_w
		and	ie_situacao = 'A';
		
		select 	max(nr_sequencia)
		into STRICT	nr_sequencia_ww
		from	cirurgia_agente_anestesico
		where 	nr_seq_agente 	=	nr_seq_agente_anest_ww
		and		nr_cirurgia		=	nr_cirurgia_p;
		
		
		update	cirurgia_agente_anest_ocor
		set	qt_utilizada		= qt_utilizada_p
		where	nr_seq_cirur_agente 	= nr_sequencia_ww
		and	coalesce(dt_final_adm::text, '') = '';	
		
		commit;
	end if;
	
	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE agente_anest_pck.atualizar_registro_adm_sevo ( ie_tipo_agente_p bigint, qt_utilizada_p bigint, nr_cirurgia_p bigint, ie_tipo_Halogenado_p bigint default null) FROM PUBLIC;
