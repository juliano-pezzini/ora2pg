-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE agente_anest_pck.atualizar_adm_agente_anest ( ie_tipo_agente_p bigint, nr_cirurgia_p bigint, cd_estabelecimento_p bigint, ie_tipo_Halogenado_p bigint default null, dt_fim_adm_p timestamp default null) AS $body$
DECLARE

	nr_seq_agente_anest_w  	bigint;
	nr_sequencia_ww		bigint;
	qt_velocidade_w		bigint;
	
BEGIN
	

	nr_seq_agente_anest_w		:= agente_anest_pck.obter_agente_anestesico(	ie_tipo_agente_p,
									cd_estabelecimento_p,
									ie_tipo_Halogenado_p);
	
	select 	max(nr_sequencia)
	into STRICT	nr_sequencia_ww
	from	cirurgia_agente_anestesico
	where 	nr_seq_agente 		= nr_seq_agente_anest_w
	and	nr_cirurgia		= nr_cirurgia_p;
	
	update 	cirurgia_agente_anest_ocor
	set	dt_final_adm	=	coalesce(dt_fim_adm_p,clock_timestamp()),
		dt_liberacao 	=	coalesce(dt_fim_adm_p,clock_timestamp())
	where	nr_seq_cirur_agente = nr_sequencia_ww
	and	coalesce(dt_final_adm::text, '') = '';	
	
	commit;
	
	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE agente_anest_pck.atualizar_adm_agente_anest ( ie_tipo_agente_p bigint, nr_cirurgia_p bigint, cd_estabelecimento_p bigint, ie_tipo_Halogenado_p bigint default null, dt_fim_adm_p timestamp default null) FROM PUBLIC;
