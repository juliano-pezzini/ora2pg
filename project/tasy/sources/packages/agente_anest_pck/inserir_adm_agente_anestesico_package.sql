-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE agente_anest_pck.inserir_adm_agente_anestesico ( ie_tipo_agente_p bigint, nr_cirurgia_p bigint, qt_vel_p text, qt_utilizada_p text default null, qt_halog_insp_p text default null, cd_estabelecimento_p bigint default null, nm_usuario_p text default null, ie_integracao_p text default 'N', ie_tipo_Halogenado_p bigint default null, dt_inicio_adm_p timestamp default null) AS $body$
DECLARE

	
	nr_seq_agente_anest_w  		bigint;
	nr_sequencia_ww			bigint;
	nr_seq_agent_anest_ocor_w	bigint;
	ie_modo_registro_w		agente_anestesico.ie_modo_registro%type;
	cd_unid_med_w			cirurgia_agente_anest_ocor.cd_unid_med%type;

	
BEGIN
	
	nr_seq_agente_anest_w		:= agente_anest_pck.obter_agente_anestesico(	ie_tipo_agente_p,
									cd_estabelecimento_p,
									ie_tipo_Halogenado_p);
	if (ie_tipo_agente_p = 4) then
		cd_unid_med_w 	:= 'ml';
	end if;

	select	max(ie_modo_registro)
	into STRICT	ie_modo_registro_w
	from	agente_anestesico
	where	nr_sequencia = nr_seq_agente_anest_w
	and	coalesce(cd_estabelecimento, coalesce( cd_estabelecimento_p, 0)) =  coalesce( cd_estabelecimento_p, 0);
	
	select 	max(nr_sequencia)
	into STRICT	nr_sequencia_ww
	from	cirurgia_agente_anestesico
	where 	nr_seq_agente 		= nr_seq_agente_anest_w
	and	nr_cirurgia		= nr_cirurgia_p;
	
	if (nr_sequencia_ww IS NOT NULL AND nr_sequencia_ww::text <> '') then
	
		select  nextval('cirurgia_agente_anest_ocor_seq')
		into STRICT	nr_seq_agent_anest_ocor_w
		;
		
		insert into cirurgia_agente_anest_ocor(	
					nr_sequencia,
					nr_seq_cirur_agente,
					dt_inicio_adm,
					dt_atualizacao,
					nm_usuario,
					dt_liberacao,
					ie_modo_registro,
					ie_aplic_bolus,
					qt_velocidade_inf,
					qt_dose_total,
					qt_halog_ins,
					cd_unid_med,
					ie_situacao,
					ie_integracao)
			values (	nr_seq_agent_anest_ocor_w,
					nr_sequencia_ww,
					clock_timestamp(),
					coalesce(dt_inicio_adm_p,clock_timestamp()),
					nm_usuario_p,
					null,
					ie_modo_registro_w,
					'N',
					CASE WHEN ie_modo_registro_w='V' THEN  campo_numerico(qt_vel_p)  ELSE null END ,
					CASE WHEN ie_modo_registro_w='T' THEN  campo_numerico(qt_vel_p)  ELSE null END ,
					CASE WHEN coalesce(qt_halog_insp_p,'XPTO')='XPTO' THEN CASE WHEN ie_modo_registro_w='M' THEN  campo_numerico(qt_vel_p)  ELSE null END   ELSE campo_numerico(qt_halog_insp_p) END ,
					cd_unid_med_w,
					'A',
          ie_integracao_p);
				
	end if;

	commit;
	
	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE agente_anest_pck.inserir_adm_agente_anestesico ( ie_tipo_agente_p bigint, nr_cirurgia_p bigint, qt_vel_p text, qt_utilizada_p text default null, qt_halog_insp_p text default null, cd_estabelecimento_p bigint default null, nm_usuario_p text default null, ie_integracao_p text default 'N', ie_tipo_Halogenado_p bigint default null, dt_inicio_adm_p timestamp default null) FROM PUBLIC;
