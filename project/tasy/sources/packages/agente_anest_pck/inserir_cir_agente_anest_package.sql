-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE agente_anest_pck.inserir_cir_agente_anest ( ie_tipo_agente_p bigint, nr_cirurgia_p bigint, vl_velocidade_p text, cd_estabelecimento_p bigint, nr_seq_pepo_p bigint, nm_usuario_p text, ie_integracao_p text default 'N', ie_tipo_Halogenado_p bigint default null) AS $body$
DECLARE


	cd_material_w 			bigint;
	nr_seq_agente_anest_w  		bigint;
	cd_unidade_medida_w		varchar(30);
	ie_via_aplicacao_w		varchar(5);
	cd_profissional_w		varchar(10);
	nr_sequencia_w			bigint;
	nr_seq_pepo_ww			cirurgia.nr_seq_pepo%type;
							
	
BEGIN
	cd_profissional_w 		:= substr(obter_pessoa_fisica_usuario(nm_usuario_p,'C'),1,10);
	
	nr_seq_agente_anest_w		:= agente_anest_pck.obter_agente_anestesico(ie_tipo_agente_p,cd_estabelecimento_p,ie_tipo_Halogenado_p);

	
	
	if (nr_seq_agente_anest_w IS NOT NULL AND nr_seq_agente_anest_w::text <> '') then
		select  max(cd_material),
			max(ie_via_aplicacao),
			max(cd_unidade_medida)
		into STRICT	cd_material_w,
			ie_via_aplicacao_w,
			cd_unidade_medida_w
		from	agente_anest_material
		where	nr_seq_agente	=	nr_seq_agente_anest_w;
		
		
		
		nr_seq_pepo_ww := nr_seq_pepo_p;
		
		if (coalesce(nr_seq_pepo_ww,0) = 0) then
			select	max(nr_Seq_pepo)
			into STRICT	nr_seq_pepo_ww
			from	cirurgia
			where	nr_cirurgia = nr_cirurgia_p;
		end if;

		gerar_agentes_medicamentos(	cd_estabelecimento_p,
						nr_seq_agente_anest_w,
						nr_cirurgia_p,
						cd_material_w,
						cd_profissional_w,
						nm_usuario_p,
						nr_sequencia_w,
						ie_via_aplicacao_w,
						cd_unidade_medida_w,
						null,
						nr_seq_pepo_ww,
						'CO',
            null,
            null,
            ie_integracao_p);
	end if;

	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE agente_anest_pck.inserir_cir_agente_anest ( ie_tipo_agente_p bigint, nr_cirurgia_p bigint, vl_velocidade_p text, cd_estabelecimento_p bigint, nr_seq_pepo_p bigint, nm_usuario_p text, ie_integracao_p text default 'N', ie_tipo_Halogenado_p bigint default null) FROM PUBLIC;
