-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE dashboard_html5_pck.gera_overview (dt_referencia_p timestamp, nr_seq_agrupamento_p bigint, nm_usuario_p text, ie_periodo_p text, periodos_p def_tabela) AS $body$
DECLARE


        dt_ini_periodo_w      timestamp;
        dt_fim_periodo_w      timestamp;
        vl_periodo_w          double precision;
        nr_seq_apresentacao_w double precision;

        /* funcoes overview por periodo*/


        c01 CURSOR FOR
            SELECT sum(qt_milestone_prev) qt_milestone_prev,
                   sum(qt_milestone_real) qt_milestone_real,
                   sum(qt_horas_prev) qt_horas_prev,
                   sum(qt_horas_real) qt_horas_real,
                   nr_seq_agrupamento,
                   dt_primeiro_dia_semana,
                   to_char(dt_primeiro_dia_semana, 'iw') nr_semana
              from funcoes_html5_overview
             where nr_seq_agrupamento = nr_seq_agrupamento_p
               and dt_primeiro_dia_semana between dt_ini_periodo_w and dt_fim_periodo_w
             group by nr_seq_agrupamento,
                      dt_primeiro_dia_semana,
                      to_char(dt_primeiro_dia_semana, 'iw')
             order by dt_primeiro_dia_semana;

        /* dominio dimensoes */


        c02 CURSOR FOR
            SELECT vl_dominio
              from valor_dominio
             where cd_dominio = 8138
               and ie_situacao = 'A';

    
BEGIN
    
        --Existe um relacionamento entre a seq_apresentacao e as colunas do WCPanel, os meses iniciam na coluna 57

        nr_seq_apresentacao_w := 0;
        if ie_periodo_p <> 'S' then
            nr_seq_apresentacao_w := 56;
        end if;

        for i in periodos_p.first .. periodos_p.last loop
            nr_seq_apresentacao_w := nr_seq_apresentacao_w + 1;

            --Atribui valores para filtrar o cursor C01

            dt_ini_periodo_w := periodos_p[i].dt_ini_periodo;
            dt_fim_periodo_w := periodos_p[i].dt_fim_periodo;

            --/*

            RAISE NOTICE 'ds_periodo      := % - nr_periodo_ini  := % - nr_periodo_fim  := % - nr_semana_ini_w := % - nr_semana_fim_w := %', periodos_p[i].ds_periodo, periodos_p[i].nr_periodo_ini, periodos_p[i].nr_periodo_fim, dt_ini_periodo_w, dt_fim_periodo_w;
            */
        
            /*Iterar dominios*/


            for c02_w in c02 loop
                /*Iterar overview filtrado por semanas inicio e fim*/


                vl_periodo_w := null;
                for c01_w in c01 loop
                    case
                        when c02_w.vl_dominio = 'HP' then
                            vl_periodo_w := c01_w.qt_horas_prev;
                        when c02_w.vl_dominio = 'HR' then
                            vl_periodo_w := c01_w.qt_horas_real;
                        when c02_w.vl_dominio = 'PP' and c01_w.qt_milestone_prev > 0 then
                            vl_periodo_w := 100;
                        when c02_w.vl_dominio = 'PR' then
                            vl_periodo_w := 100 - (c01_w.qt_milestone_real / c01_w.qt_milestone_prev);
                        when c02_w.vl_dominio = 'RA' then
                            vl_periodo_w := -1;
                    end case;
                end loop;

                CALL dashboard_html5_pck.inserir_overview_semana(nm_usuario_p,
                                        dt_referencia_p,
                                        nr_seq_agrupamento_p,
                                        c02_w.vl_dominio,
                                        periodos_p[i].dt_ini_periodo,
                                        ie_periodo_p,
                                        vl_periodo_w,
                                        nr_seq_apresentacao_w);

            end loop;
        end loop;

        commit;

    end;


$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE dashboard_html5_pck.gera_overview (dt_referencia_p timestamp, nr_seq_agrupamento_p bigint, nm_usuario_p text, ie_periodo_p text, periodos_p def_tabela) FROM PUBLIC;
