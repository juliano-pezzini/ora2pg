-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE dashboard_html5_pck.atualizar_grupo_transicao () AS $body$
DECLARE

        /* ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
        Finalidade:  Atualizar dados do Dashboard do HTML5 - Grupo de Trabalho TRANSICAO
        ---------------------------------------------------------------------------------------------------------------------------------------------

        Locais de chamada direta: 
        [  ]  Objetos do dicionario [ ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatorios [X] Outros: Procedure atualizar_dashboard
         --------------------------------------------------------------------------------------------------------------------------------------------

        Pontos de atencao:
        +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */


        c03 CURSOR FOR
            SELECT a.nr_sequencia,
                   a.cd_funcao,
                   upper(obter_nome_funcao(a.cd_funcao)) nm_funcao,
                   a.ie_status
              from funcoes_html5 a
             where a.nr_seq_agrupamento = 6;

        dt_prev_inicio_prog_w     timestamp;
        dt_real_inicio_prog_w     timestamp;
        dt_prev_fim_prog_w        timestamp;
        dt_real_fim_prog_w        timestamp;
        dt_inicio_real_w          timestamp;
        dt_fim_prev_w             timestamp;
        dt_inicio_prev_w          timestamp;
        qt_horas_cron_prog_w      double precision;
        qt_horas_total_prog_w     double precision;
        qt_horas_cron_pend_prog_w double precision;
        pr_prev_conclus_prog_w    double precision;
        pr_conclusao_prog_w       double precision;
        pr_conclusao_w            double precision;

    
BEGIN
        /* Projeto das funcoes de transicao */


        for c03_w in c03 loop
            select min(b.dt_inicio),
                   min(a.dt_inicio_real),
                   max(a.dt_fim_prev),
                   max(a.dt_fim_real),
                   max(a.qt_hora_prev),
                   max(a.qt_hora_real),
                   max(a.qt_hora_saldo)
              into STRICT dt_prev_inicio_prog_w,
                   dt_real_inicio_prog_w,
                   dt_prev_fim_prog_w,
                   dt_real_fim_prog_w,
                   qt_horas_cron_prog_w,
                   qt_horas_total_prog_w,
                   qt_horas_cron_pend_prog_w
              from proj_cron_etapa a,
                   proj_cronograma b
             where a.nr_seq_cronograma = b.nr_sequencia
               and b.nr_seq_proj = 8285 --Projeto Transicao
               and b.ie_situacao = 'A'
               and substr(a.ds_atividade, position('#' in a.ds_atividade) + 1, length(a.ds_atividade)) = to_char(c03_w.cd_funcao);

            /* Percentual Previsto Transicao*/


            SELECT * FROM dashboard_html5_pck.obter_pr_prev_real_crono(null, 8285, null, null, null, null, pr_prev_conclus_prog_w, pr_conclusao_prog_w) INTO STRICT pr_prev_conclus_prog_w, pr_conclusao_prog_w;

            pr_conclusao_w := pr_conclusao_prog_w;

            update funcoes_html5
               set pr_conclusao_analis     = 100,
                   pr_conclusao            = pr_conclusao_w,
                   pr_prev_conclus_prog    = pr_prev_conclus_prog_w,
                   pr_conclusao_prog       = pr_conclusao_prog_w,
                   dt_prev_inicio_prog     = dt_prev_inicio_prog_w,
                   dt_prev_fim_prog        = dt_prev_fim_prog_w,
                   dt_real_inicio_prog     = dt_real_inicio_prog_w,
                   dt_real_fim_prog        = dt_real_fim_prog_w,
                   qt_horas_cron_prog      = qt_horas_cron_prog_w,
                   qt_horas_total_prog     = qt_horas_total_prog_w,
                   qt_horas_cron_pend_prog = qt_horas_cron_pend_prog_w
             where nr_sequencia = c03_w.nr_sequencia;
        end loop;

        commit;

    END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE dashboard_html5_pck.atualizar_grupo_transicao () FROM PUBLIC;
