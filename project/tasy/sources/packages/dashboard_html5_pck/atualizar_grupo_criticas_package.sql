-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE dashboard_html5_pck.atualizar_grupo_criticas () AS $body$
DECLARE

        /* ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
        Finalidade:  Atualizar dados do Dashboard do HTML5 - Grupo de Trabalho FUNCOES CRITICAS
        ---------------------------------------------------------------------------------------------------------------------------------------------

        Locais de chamada direta: 
        [  ]  Objetos do dicionario [ ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatorios [X] Outros: Procedure atualizar_dashboard
         --------------------------------------------------------------------------------------------------------------------------------------------

        Pontos de atencao:
        +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */

    
        /* funcoes criticas */


        c02 CURSOR FOR
            SELECT a.nr_sequencia,
                   a.nr_seq_proj_prog,
                   a.nr_seq_proj_teste,
                   a.cd_funcao,
                   a.ie_status
              from funcoes_html5 a
             where a.nr_seq_agrupamento = 4;

        dt_prev_inicio_prog_w      timestamp;
        dt_real_inicio_prog_w      timestamp;
        dt_prev_fim_prog_w         timestamp;
        dt_real_fim_prog_w         timestamp;
        dt_inicio_real_w           timestamp;
        dt_fim_prev_w              timestamp;
        dt_inicio_prev_w           timestamp;
        dt_prev_inicio_teste_w     timestamp;
        dt_real_inicio_teste_w     timestamp;
        dt_prev_fim_teste_w        timestamp;
        dt_real_fim_teste_w        timestamp;
        qt_horas_cron_prog_w       double precision;
        qt_horas_total_prog_w      double precision;
        qt_horas_cron_pend_prog_w  double precision;
        qt_horas_cron_teste_w      double precision;
        qt_horas_total_teste_w     double precision;
        qt_horas_cron_pend_teste_w double precision;
        pr_prev_conclus_prog_w     double precision;
        pr_conclusao_prog_w        double precision;
        pr_prev_conclus_teste_w    double precision;
        pr_conclusao_teste_w       double precision;

    
BEGIN
        /* Projeto das criticas */


        for c02_w in c02 loop
            /* Cronograma Desenvolvimento */


            select min(b.dt_inicio),
                   min(a.dt_inicio_real),
                   min(b.dt_fim),
                   max(b.dt_fim_real),
                   max(b.qt_total_horas),
                   max(b.qt_horas_realizado),
                   max(qt_horas_saldo)
              into STRICT dt_prev_inicio_prog_w,
                   dt_real_inicio_prog_w,
                   dt_prev_fim_prog_w,
                   dt_real_fim_prog_w,
                   qt_horas_cron_prog_w,
                   qt_horas_total_prog_w,
                   qt_horas_cron_pend_prog_w
              from proj_cron_etapa a,
                   proj_cronograma b
             where a.nr_seq_cronograma = b.nr_sequencia
               and b.nr_seq_proj = c02_w.nr_seq_proj_prog
               and b.ie_situacao = 'A';

            /* Percentual Previsto do cronograma de programacao criticas */


            SELECT * FROM dashboard_html5_pck.obter_pr_prev_real_crono(null, c02_w.nr_seq_proj_prog, null, null, null, null, pr_prev_conclus_prog_w, pr_conclusao_prog_w) INTO STRICT pr_prev_conclus_prog_w, pr_conclusao_prog_w;

            update funcoes_html5
               set pr_conclusao_analis     = 100,
                   pr_conclusao             = NULL,
                   pr_prev_conclus_prog    = pr_prev_conclus_prog_w,
                   pr_conclusao_prog       = pr_conclusao_prog_w,
                   dt_prev_inicio_prog     = dt_prev_inicio_prog_w,
                   dt_prev_fim_prog        = dt_prev_fim_prog_w,
                   dt_real_inicio_prog     = dt_real_inicio_prog_w,
                   dt_real_fim_prog        = dt_real_fim_prog_w,
                   qt_horas_cron_prog      = qt_horas_cron_prog_w,
                   qt_horas_total_prog     = qt_horas_total_prog_w,
                   qt_horas_cron_pend_prog = qt_horas_cron_pend_prog_w
             where nr_sequencia = c02_w.nr_sequencia;

            /* Cronograma Testes */


            select min(b.dt_inicio),
                   min(a.dt_inicio_real),
                   min(b.dt_fim),
                   max(b.dt_fim_real),
                   max(b.qt_total_horas),
                   max(b.qt_horas_realizado),
                   max(qt_horas_saldo)
              into STRICT dt_prev_inicio_teste_w,
                   dt_real_inicio_teste_w,
                   dt_prev_fim_teste_w,
                   dt_real_fim_teste_w,
                   qt_horas_cron_teste_w,
                   qt_horas_total_teste_w,
                   qt_horas_cron_pend_teste_w
              from proj_cron_etapa a,
                   proj_cronograma b
             where a.nr_seq_cronograma = b.nr_sequencia
               and b.nr_seq_proj = c02_w.nr_seq_proj_teste
               and b.ie_situacao = 'A';

            /* Percentual Previsto do cronograma de teste criticas*/


            SELECT * FROM dashboard_html5_pck.obter_pr_prev_real_crono(null, null, c02_w.nr_seq_proj_teste, null, null, null, pr_prev_conclus_teste_w, pr_conclusao_teste_w) INTO STRICT pr_prev_conclus_teste_w, pr_conclusao_teste_w;

            update funcoes_html5
               set pr_conclusao              = NULL,
                   pr_prev_conclus_teste    = pr_prev_conclus_teste_w,
                   pr_conclusao_teste       = pr_conclusao_teste_w,
                   dt_prev_inicio_teste     = dt_prev_inicio_teste_w,
                   dt_prev_fim_teste        = dt_prev_fim_teste_w,
                   dt_real_inicio_teste     = dt_real_inicio_teste_w,
                   dt_real_fim_teste        = dt_real_fim_teste_w,
                   qt_horas_cron_teste      = qt_horas_cron_teste_w,
                   qt_horas_total_teste     = qt_horas_total_teste_w,
                   qt_horas_cron_pend_teste = qt_horas_cron_pend_teste_w
             where nr_sequencia = c02_w.nr_sequencia;

        end loop;

        commit;

    END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE dashboard_html5_pck.atualizar_grupo_criticas () FROM PUBLIC;
