-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE dashboard_html5_pck.obter_pr_prev_real_crono (nr_seq_proj_analise_p bigint, nr_seq_proj_prog_p bigint, nr_seq_proj_teste_p bigint, ie_papel_executor1_p text, ie_papel_executor2_p text, ie_atividade_p text, pr_prev_crono_p INOUT bigint, pr_real_crono_p INOUT bigint) AS $body$
DECLARE


        dt_inicio_prev_w timestamp;
        dt_inicio_real_w timestamp;
        dt_fim_prev_w    timestamp;

    
BEGIN
        if (coalesce(ie_papel_executor1_p::text, '') = '') and (coalesce(ie_papel_executor2_p::text, '') = '') and (coalesce(ie_atividade_p::text, '') = '') then
            /* Percentual Previsto do cronograma */


            select min(coalesce(e.dt_inicio_real, trunc(clock_timestamp()))),
                   max(e.dt_fim_prev),
                   min(e.dt_inicio_prev)
              into STRICT dt_inicio_real_w,
                   dt_fim_prev_w,
                   dt_inicio_prev_w
              from proj_cronograma p,
                   proj_cron_etapa e
             where e.nr_seq_cronograma = p.nr_sequencia
               and p.nr_seq_proj in (nr_seq_proj_analise_p, nr_seq_proj_prog_p, nr_seq_proj_teste_p)
               and p.ie_situacao = 'A';

            /* Percentual realizado do cronograma */


            select (select dividir(t.per_exec * 100, t.qt_hora_prev) pr_realizado
                      from (select sum(e.qt_hora_prev) qt_hora_prev,
                                   sum(dividir(e.qt_hora_prev * e.pr_etapa, 100)) per_exec
                              from proj_cronograma p,
                                   proj_cron_etapa e
                             where e.nr_seq_cronograma = p.nr_sequencia
                               and p.nr_seq_proj in (nr_seq_proj_analise_p, nr_seq_proj_prog_p, nr_seq_proj_teste_p)
                               and p.ie_situacao = 'A') t) pr_real
              into STRICT pr_real_crono_p
;
        end if;
        if ((ie_papel_executor1_p IS NOT NULL AND ie_papel_executor1_p::text <> '') or (ie_papel_executor2_p IS NOT NULL AND ie_papel_executor2_p::text <> '')) and (coalesce(ie_atividade_p::text, '') = '') then
            /* Percentual Previsto do cronograma de analise */


            select min(coalesce(e.dt_inicio_real, trunc(clock_timestamp()))),
                   max(e.dt_fim_prev),
                   min(e.dt_inicio_prev)
              into STRICT dt_inicio_real_w,
                   dt_fim_prev_w,
                   dt_inicio_prev_w
              from proj_cronograma p,
                   proj_cron_etapa e
             where e.nr_seq_cronograma = p.nr_sequencia
               and p.nr_seq_proj in (nr_seq_proj_analise_p, nr_seq_proj_prog_p, nr_seq_proj_teste_p)
               and p.ie_situacao = 'A'
               and e.ie_papel_executor in (ie_papel_executor1_p, ie_papel_executor2_p);

            /* Percentual realizado do cronograma de analise */


            select (select dividir(t.per_exec * 100, t.qt_hora_prev) pr_realizado
                      from (select sum(e.qt_hora_prev) qt_hora_prev,
                                   sum(dividir(e.qt_hora_prev * e.pr_etapa, 100)) per_exec
                              from proj_cronograma p,
                                   proj_cron_etapa e
                             where e.nr_seq_cronograma = p.nr_sequencia
                               and p.nr_seq_proj in (nr_seq_proj_analise_p, nr_seq_proj_prog_p, nr_seq_proj_teste_p)
                               and p.ie_situacao = 'A'
                               and e.ie_papel_executor in (ie_papel_executor1_p, ie_papel_executor2_p)) t) pr_real
              into STRICT pr_real_crono_p
;
        end if;
        if ((ie_papel_executor1_p IS NOT NULL AND ie_papel_executor1_p::text <> '') or (ie_papel_executor2_p IS NOT NULL AND ie_papel_executor2_p::text <> '')) and (ie_atividade_p IS NOT NULL AND ie_atividade_p::text <> '') then
            /* Percentual Previsto do cronograma de analise */


            select min(coalesce(e.dt_inicio_real, trunc(clock_timestamp()))),
                   max(e.dt_fim_prev),
                   min(e.dt_inicio_prev)
              into STRICT dt_inicio_real_w,
                   dt_fim_prev_w,
                   dt_inicio_prev_w
              from proj_cronograma p,
                   proj_cron_etapa e
             where e.nr_seq_cronograma = p.nr_sequencia
               and p.nr_seq_proj in (nr_seq_proj_analise_p, nr_seq_proj_prog_p, nr_seq_proj_teste_p)
               and p.ie_situacao = 'A'
               and e.ie_papel_executor in (ie_papel_executor1_p, ie_papel_executor2_p)
               and e.ie_atividade = ie_atividade_p;

            /* Percentual realizado do cronograma de analise */


            select (select dividir(t.per_exec * 100, t.qt_hora_prev) pr_realizado
                      from (select sum(e.qt_hora_prev) qt_hora_prev,
                                   sum(dividir(e.qt_hora_prev * e.pr_etapa, 100)) per_exec
                              from proj_cronograma p,
                                   proj_cron_etapa e
                             where e.nr_seq_cronograma = p.nr_sequencia
                               and p.nr_seq_proj in (nr_seq_proj_analise_p, nr_seq_proj_prog_p, nr_seq_proj_teste_p)
                               and p.ie_situacao = 'A'
                               and e.ie_papel_executor in (ie_papel_executor1_p, ie_papel_executor2_p)
                               and e.ie_atividade = ie_atividade_p) t) pr_real
              into STRICT pr_real_crono_p
;
        end if;

        /* Calculo Pecentual Previsto */


        if (trunc(dt_inicio_prev_w) > trunc(clock_timestamp())) or (coalesce(dt_inicio_prev_w::text, '') = '') then
            pr_prev_crono_p := 0;
        else
            pr_prev_crono_p := obter_pr_prev_crono(dt_inicio_real_w, dt_fim_prev_w);
        end if;

    END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE dashboard_html5_pck.obter_pr_prev_real_crono (nr_seq_proj_analise_p bigint, nr_seq_proj_prog_p bigint, nr_seq_proj_teste_p bigint, ie_papel_executor1_p text, ie_papel_executor2_p text, ie_atividade_p text, pr_prev_crono_p INOUT bigint, pr_real_crono_p INOUT bigint) FROM PUBLIC;
