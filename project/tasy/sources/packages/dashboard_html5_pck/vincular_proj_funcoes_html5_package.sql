-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE dashboard_html5_pck.vincular_proj_funcoes_html5 (nr_seq_proj_p bigint) AS $body$
DECLARE

        /* ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
        Finalidade:  Vincula projetos de cronograma a tabela funcoes_html5
        ---------------------------------------------------------------------------------------------------------------------------------------------

        Locais de chamada direta: 
        [  ]  Objetos do dicionario [ ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatorios [X] Outros: Procedure atualizar_dashboard
         --------------------------------------------------------------------------------------------------------------------------------------------

        Pontos de atencao: 
        +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */

        c05 CURSOR FOR
            SELECT c.cd_funcao,
                   b.nr_seq_sub_proj,
                   'A' ie_tipo_proj
              from proj_projeto    c,
                   proj_cron_etapa b,
                   proj_cronograma a
             where a.nr_sequencia = b.nr_seq_cronograma
               and b.nr_seq_sub_proj = c.nr_sequencia
               and a.nr_seq_proj = nr_seq_proj_p
               and trim(both b.ds_atividade) = 'Analysis'
               and (b.nr_seq_sub_proj IS NOT NULL AND b.nr_seq_sub_proj::text <> '')
               and a.ie_situacao = 'A'
               and coalesce(b.ie_situacao, 'A') = 'A'
               and (c.cd_funcao IS NOT NULL AND c.cd_funcao::text <> '')
               and coalesce(c.dt_cancelamento::text, '') = ''

union

            SELECT c.cd_funcao,
                   b.nr_seq_sub_proj,
                   'D' ie_tipo_proj
              from proj_projeto    c,
                   proj_cron_etapa b,
                   proj_cronograma a
             where a.nr_sequencia = b.nr_seq_cronograma
               and b.nr_seq_sub_proj = c.nr_sequencia
               and a.nr_seq_proj = nr_seq_proj_p
               and trim(both b.ds_atividade) = 'Development'
               and (b.nr_seq_sub_proj IS NOT NULL AND b.nr_seq_sub_proj::text <> '')
               and a.ie_situacao = 'A'
               and coalesce(b.ie_situacao, 'A') = 'A'
               and (c.cd_funcao IS NOT NULL AND c.cd_funcao::text <> '')
               and coalesce(c.dt_cancelamento::text, '') = ''
            
union

            select c.cd_funcao,
                   b.nr_seq_sub_proj,
                   'T' ie_tipo_proj
              from proj_projeto    c,
                   proj_cron_etapa b,
                   proj_cronograma a
             where a.nr_sequencia = b.nr_seq_cronograma
               and b.nr_seq_sub_proj = c.nr_sequencia
               and a.nr_seq_proj = nr_seq_proj_p
               and trim(both b.ds_atividade) = 'Verification'
               and (b.nr_seq_sub_proj IS NOT NULL AND b.nr_seq_sub_proj::text <> '')
               and a.ie_situacao = 'A'
               and coalesce(b.ie_situacao, 'A') = 'A'
               and (c.cd_funcao IS NOT NULL AND c.cd_funcao::text <> '')
               and coalesce(c.dt_cancelamento::text, '') = ''
             order by cd_funcao,
                      ie_tipo_proj,
                      nr_seq_sub_proj;

BEGIN
    
        for c05_w in c05 loop
            if (c05_w.ie_tipo_proj = 'A') then
            
                update funcoes_html5
                   set nr_seq_proj_analise = c05_w.nr_seq_sub_proj
                 where cd_funcao = c05_w.cd_funcao
                   and coalesce(nr_seq_proj_analise, 0) <> c05_w.nr_seq_sub_proj;

            elsif (c05_w.ie_tipo_proj = 'D') then
            
                update funcoes_html5
                   set nr_seq_proj_prog = c05_w.nr_seq_sub_proj
                 where cd_funcao = c05_w.cd_funcao
                   and coalesce(nr_seq_proj_prog, 0) <> c05_w.nr_seq_sub_proj;

            elsif (c05_w.ie_tipo_proj = 'T') then
            
                update funcoes_html5
                   set nr_seq_proj_teste = c05_w.nr_seq_sub_proj
                 where cd_funcao = c05_w.cd_funcao
                   and coalesce(nr_seq_proj_teste, 0) <> c05_w.nr_seq_sub_proj;

            end if;

            commit;

        end loop;

    END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE dashboard_html5_pck.vincular_proj_funcoes_html5 (nr_seq_proj_p bigint) FROM PUBLIC;
