-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE dashboard_html5_pck.gera_overview_tela (nr_seq_agrupamento_p bigint, nm_usuario_p text, qt_semanas_p bigint, qt_meses_p bigint, dt_referencia_p timestamp) AS $body$
DECLARE


        /* ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
        Finalidade:  Gerar dados para apresentar a visao de 7 semanas na tele de overview do Dashboard do HTML5
        ---------------------------------------------------------------------------------------------------------------------------------------------

        Locais de chamada direta: 
        [  ]  Objetos do dicionario [ ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatorios [X] Outros: Chamada pela tela Overview no Dashboard HTML5
         --------------------------------------------------------------------------------------------------------------------------------------------

        Pontos de atencao:
        - o parametro qt_semanas_p deve vir sempre preenchido, nao foi tratado pois e pra vir da tela sempre preenchido
        +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */

        nr_periodo_dt_referencia_w integer;
        nr_periodo_ini_w           integer;
        nr_periodo_fim_w           integer;
        dt_periodo_ini_w           timestamp;
        periodos_w                 def_tabela;

    
BEGIN
    
        --apaga solicitacao anterior do usuario

        delete from funcoes_html5_over_semana where nm_usuario = nm_usuario_p;
        commit;

        nr_periodo_dt_referencia_w := to_char(dt_referencia_p, 'iw');
        nr_periodo_ini_w           := nr_periodo_dt_referencia_w - 3;
        dt_periodo_ini_w           := dashboard_html5_pck.obter_data_inicio_periodo(dt_referencia_p, nr_periodo_ini_w);

        --Obtem lista de semanas para inserir (soma 3 no qt_semanas_p porque dt_periodo_ini_w inicia 3 semanas antes)

        periodos_w := dashboard_html5_pck.obter_lista_periodos(dt_periodo_ini_w, 'S', qt_semanas_p + 3, periodos_w);

        CALL dashboard_html5_pck.gera_overview(dt_referencia_p, nr_seq_agrupamento_p, nm_usuario_p, 'S', periodos_w);

        if ((qt_meses_p IS NOT NULL AND qt_meses_p::text <> '') and qt_meses_p > 0) then
            --obtem ultima data da lista de semanas para iniciar a lista de meses a partir dela

            dt_periodo_ini_w := periodos_w[periodos_w.last].dt_ini_periodo;

            --Obtem lista de meses para inserir

            periodos_w := dashboard_html5_pck.obter_lista_periodos(dt_periodo_ini_w, 'M', qt_meses_p, periodos_w);

            CALL dashboard_html5_pck.gera_overview(dt_referencia_p, nr_seq_agrupamento_p, nm_usuario_p, 'M', periodos_w);
        end if;

    end;


$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE dashboard_html5_pck.gera_overview_tela (nr_seq_agrupamento_p bigint, nm_usuario_p text, qt_semanas_p bigint, qt_meses_p bigint, dt_referencia_p timestamp) FROM PUBLIC;
