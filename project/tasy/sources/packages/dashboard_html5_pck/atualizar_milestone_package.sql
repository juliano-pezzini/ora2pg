-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE dashboard_html5_pck.atualizar_milestone (nr_seq_funcao_p bigint, nr_seq_proj_p bigint, ie_tipo_registro_p text) AS $body$
DECLARE

        /* ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
        Finalidade:  Vincula projetos do cronograma do projeto na tabela funcoes_html5
        ---------------------------------------------------------------------------------------------------------------------------------------------

        Locais de chamada direta: 
        [  ]  Objetos do dicionario [ ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatorios [ ] Outros: Somente na procedure atualizar_grupo_todo
         --------------------------------------------------------------------------------------------------------------------------------------------

        Pontos de atencao:
        +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */


        c04 CURSOR FOR
            SELECT *
              from (SELECT c.nr_sequencia,
                           trim(both c.ds_atividade) ds_atividade,
                           c.dt_fim_prev,
                           c.dt_fim_real,
                           c.qt_hora_prev,
                           c.qt_hora_real,
                           c.pr_etapa,
                           c.ie_milestone,
                           (select m.nr_seq_proj_cron_etapa
                              from funcoes_html5_milestone m
                             where m.nr_seq_proj_cron_etapa = c.nr_sequencia) nr_seq_proj_cron_etapa
                      from proj_cronograma b,
                           proj_cron_etapa c
                     where b.nr_sequencia = c.nr_seq_cronograma
                       and b.ie_situacao = 'A'
                       and c.ie_milestone = 'S'
                       and b.nr_seq_proj = nr_seq_proj_p) a;

        ie_tipo_registro_w varchar(1);
        nr_sequencia_rem_w bigint;

    
BEGIN
        /*Prepara tipo registro*/


        case
            when(ie_tipo_registro_p = 'A') then
                ie_tipo_registro_w := '1';
            when(ie_tipo_registro_p = 'D') then
                ie_tipo_registro_w := '2';
            when(ie_tipo_registro_p = 'T') then
                ie_tipo_registro_w := '3';
        end case;

        for c04_w in c04 loop
            if coalesce(c04_w.nr_seq_proj_cron_etapa::text, '') = '' then
                $if $$tasy_local_dict=true $then
                nr_sequencia_rem_w := get_remote_sequence('seq:funcoes_html5_milestone_seq');
                $else
                select nextval('funcoes_html5_milestone_seq') into STRICT nr_sequencia_rem_w;
                $end

                insert into funcoes_html5_milestone(nr_sequencia,
                     nr_seq_funcao,
                     ds_titulo,
                     dt_atualizacao,
                     nm_usuario,
                     dt_atualizacao_nrec,
                     nm_usuario_nrec,
                     ds_milestone,
                     dt_prevista,
                     dt_real,
                     qt_hora_prev,
                     qt_hora_real,
                     ie_tipo_registro,
                     nr_seq_proj_cron_etapa,
                     pr_etapa)
                values (nr_sequencia_rem_w, --funcoes_html5_milestone_seq.nextval,
                     nr_seq_funcao_p,
                     c04_w.ds_atividade,
                     clock_timestamp(),
                     'tasy',
                     clock_timestamp(),
                     'tasy',
                     c04_w.ds_atividade,
                     c04_w.dt_fim_prev,
                     c04_w.dt_fim_real,
                     c04_w.qt_hora_prev,
                     c04_w.qt_hora_real,
                     ie_tipo_registro_w,
                     c04_w.nr_sequencia,
                     c04_w.pr_etapa);
            else
                update funcoes_html5_milestone
                   set dt_atualizacao_nrec = clock_timestamp(),
                       ds_titulo           = c04_w.ds_atividade,
                       ds_milestone        = c04_w.ds_atividade,
                       dt_prevista         = c04_w.dt_fim_prev,
                       dt_real             = c04_w.dt_fim_real,
                       qt_hora_prev        = c04_w.qt_hora_prev,
                       qt_hora_real        = c04_w.qt_hora_real,
                       pr_etapa            = c04_w.pr_etapa
                 where nr_seq_proj_cron_etapa = c04_w.nr_seq_proj_cron_etapa;
            end if;
        end loop;

        /*Apagar milestones que foram desmarcados do cronograma */


        delete from funcoes_html5_milestone fm
         where fm.nr_sequencia in (SELECT m.nr_sequencia
                  from funcoes_html5_milestone m
                 where m.nr_seq_proj_cron_etapa in (select c.nr_sequencia
                                                      from proj_cronograma b,
                                                           proj_cron_etapa c
                                                     where b.nr_sequencia = c.nr_seq_cronograma
                                                       and c.ie_milestone <> 'S'
                                                       and b.ie_situacao = 'A'
                                                       and b.nr_seq_proj = nr_seq_proj_p));

    END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE dashboard_html5_pck.atualizar_milestone (nr_seq_funcao_p bigint, nr_seq_proj_p bigint, ie_tipo_registro_p text) FROM PUBLIC;
