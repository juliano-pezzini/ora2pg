-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION dbpanel_util_pck.get_all_regras_atributo ( nm_tabela_p text, nm_atributo_p text, nr_seq_visao_p integer ) RETURNS SETOF T_FULL_REGRA_ATRIBUTO_ROW_DATA AS $body$
DECLARE


nr_seq_visao_w                  bigint := coalesce(nr_seq_visao_p, 0);
t_regra_atributo_row_w			t_full_regra_atributo_row;
ie_obrigatorio_w				varchar(10);
ie_obrigatorio_visao_w			varchar(10);
ie_obrigatorio_regra_w          varchar(10) := null;
ie_nullable_w					varchar(10);
ie_enable_w						varchar(1);
ie_tabstop_w					varchar(1);
ie_readonly_w					varchar(1);
ie_repetir_valor_w				varchar(10);
ie_padrao_nulo_w				varchar(10);
ds_regra_w						varchar(100);
ie_sequence_w					varchar(100);
vl_default_w					varchar(2000);
qt_seq_inicio_w					bigint;
ie_gerar_log_w					varchar(1);
nr_tabstop_w            		varchar(4);
ie_visible_w            		varchar(4);

C02 CURSOR FOR
	SELECT	nr_sequencia,
            cd_estabelecimento,
            cd_perfil,
            cd_setor_atendimento,
            cd_funcao,
            nr_seq_visao,
            nr_seq_regra_funcao,
            nm_usuario_param,
            hr_inicio,
            hr_fim,
            ie_dia_semana,
            qt_tam_max,
						qt_tam_min,
            coalesce(CASE WHEN ie_obrigatorio_w='S' THEN 'S'  ELSE ie_obrigatorio END , 'N') ie_obrigatorio,
						coalesce(ie_enable, ie_enable_w) ie_enable,
						coalesce(ie_visible, ie_visible_w) ie_visible,
						coalesce(ie_tabstop,ie_tabstop_w) ie_tabstop,
            coalesce(CASE WHEN ie_readonly_w='S' THEN 'S'  ELSE ie_readonly END , 'N') ie_readonly,
						coalesce(ie_repetir_valor, 'N') ie_repetir_valor,
						coalesce(ie_padrao_nulo,'N') ie_padrao_nulo,
						coalesce(vl_default, vl_default_w) vl_default,
						ds_regra,
						ie_gerar_log,
						nr_tabstop,
            ( vl_minimo               || ';' ||
              vl_maximo               || ';' ||
              vl_minimo_permitido     || ';' ||
              vl_maximo_permitido     || ';' ||
              ds_msg_aviso            || ';' ||
              ds_msg_restricao	|| ';' ||
              ie_tipo_calculo		|| ';' ||
              ds_cor_label) ds_atrib_regra,
              ds_script,
            ie_tipo_script
	FROM	tabela_atrib_regra
	WHERE 	nm_tabela 				= nm_tabela_p
	AND		nm_atributo 			= nm_atributo_p
    AND 	coalesce(nr_seq_visao, nr_seq_visao_w)  = nr_seq_visao_w
    ORDER BY 	nm_usuario_param NULLS FIRST,
				cd_perfil NULLS FIRST,
				cd_setor_atendimento  NULLS FIRST,
				cd_estabelecimento  NULLS FIRST,
				cd_funcao  NULLS FIRST,
				nr_seq_visao  NULLS FIRST,
				nr_seq_regra_funcao  NULLS FIRST;

BEGIN

    SELECT  a.nm_atributo,
            b.nm_tabela,
            a.ds_mascara,
            b.qt_seq_inicio,
            coalesce(b.ie_obrigatorio,'N') ie_obrigatorio,
						coalesce(a.ie_obrigatorio, 'N') ie_obrigatorio_visao,
            coalesce(a.ie_tabstop, b.ie_tabstop) ie_tabstop,
            coalesce(a.ie_readonly, b.ie_readonly) ie_readonly,
            a.vl_padrao vl_default
    into STRICT
            t_regra_atributo_row_w.nm_atributo,
            t_regra_atributo_row_w.nm_tabela,
            t_regra_atributo_row_w.ds_mascara,
            t_regra_atributo_row_w.qt_seq_inicio,
            ie_obrigatorio_w,
						ie_obrigatorio_visao_w,
            ie_tabstop_w,
            ie_readonly_w,
            vl_default_w
    FROM	tabela_atributo b,
            tabela_visao_atributo a
    WHERE   b.nm_tabela = nm_tabela_p
      AND	a.nm_atributo = b.nm_atributo
      AND	a.nr_sequencia = nr_seq_visao_p
      and   a.nm_atributo = nm_atributo_p;



    t_regra_atributo_row_w.qt_max_caracteres	:= null;
    t_regra_atributo_row_w.qt_min_caracteres	:= null;
    t_regra_atributo_row_w.ie_visible			:= 'S';

    if (ie_obrigatorio_w	= 'N') then

        SELECT 	coalesce(MAX(nullable),'S')
        INTO STRICT 	ie_nullable_w
        FROM 	user_tab_columns
        WHERE 	table_name 	= nm_tabela_p
        AND 	column_name	 	= t_regra_atributo_row_w.nm_atributo;

        if (ie_nullable_w	= 'N') then
            ie_obrigatorio_w	:= 'S';
        end if;

    end if;

    ie_enable_w			:= 'S';
    ie_visible_w		:= 'S';
    ie_repetir_valor_w	:= 'N';
    ie_padrao_nulo_w	:= 'N';
    ds_regra_w			:= null;
    ie_gerar_log_w		:= 'N';
    nr_tabstop_w		:=	null;
    ie_sequence_w		:= null;
    ie_obrigatorio_regra_w	:= null;

    if (t_regra_atributo_row_w.qt_seq_inicio> 0) then
        ie_sequence_w	:= '@Sequence';
    end if;
		if (t_regra_atributo_row_w.nm_atributo = 'DT_ATUALIZACAO') then
				vl_default_w	:= 'SYSDATE';
		end if;

		if (t_regra_atributo_row_w.nm_atributo = 'NM_USUARIO') then
				vl_default_w	:= '$USERNAME';
		end if;

		t_regra_atributo_row_w.ie_regra	:= dbpanel_util_pck.formarattributerule(
				ie_tabstop_w,
				ie_enable_w,
				case
					when ie_obrigatorio_w = 'S' then 'S'
					else coalesce(ie_obrigatorio_visao_w, 'N')
				end,
				ie_repetir_valor_w,
				ie_padrao_nulo_w,
				ie_readonly_w,
				ds_regra_w,
				vl_default_w,
				ie_sequence_w,
				ie_gerar_log_w,
				nr_tabstop_w,
				ie_visible_w
		);
		RETURN NEXT t_regra_atributo_row_w;
    for r_c02 in c02 loop
    begin


        t_regra_atributo_row_w.nr_sequencia         := r_c02.nr_sequencia;
        t_regra_atributo_row_w.cd_estabelecimento   := r_c02.cd_estabelecimento;
        t_regra_atributo_row_w.cd_perfil            := r_c02.cd_perfil;
        t_regra_atributo_row_w.cd_setor_atendimento := r_c02.cd_setor_atendimento;
        t_regra_atributo_row_w.cd_funcao            := r_c02.cd_funcao;
        t_regra_atributo_row_w.nr_seq_visao         := r_c02.nr_seq_visao;
        t_regra_atributo_row_w.nr_seq_regra_funcao  := r_c02.nr_seq_regra_funcao;
        t_regra_atributo_row_w.nm_usuario_param     := r_c02.nm_usuario_param;
        t_regra_atributo_row_w.hr_inicio            := r_c02.hr_inicio;
        t_regra_atributo_row_w.hr_fim               := r_c02.hr_fim;
        t_regra_atributo_row_w.ie_dia_semana        := r_c02.ie_dia_semana;

        ie_obrigatorio_w        := r_c02.ie_obrigatorio;
        ie_enable_w			   			:= r_c02.ie_enable;
				ie_tabstop_w						:= r_c02.ie_tabstop;
				ie_readonly_w						:= r_c02.ie_readonly;
				ie_padrao_nulo_w				:= r_c02.ie_padrao_nulo;
				ie_repetir_valor_w			:= r_c02.ie_repetir_valor;
				vl_default_w						:= r_c02.vl_default;
				ds_regra_w							:= r_c02.ds_regra;
				ie_gerar_log_w					:= r_c02.ie_gerar_log;
				nr_tabstop_w						:= r_c02.nr_tabstop;
        ie_visible_w            := r_c02.ie_visible;

        if (t_regra_atributo_row_w.nm_atributo = 'DT_ATUALIZACAO') and (coalesce(r_c02.vl_default::text, '') = '') then
            vl_default_w	:= 'SYSDATE';
        end if;

        if (t_regra_atributo_row_w.nm_atributo = 'NM_USUARIO') and (coalesce(r_c02.vl_default::text, '') = '') then
            vl_default_w	:= '$USERNAME';
        end if;

        t_regra_atributo_row_w.ds_atrib_regra       := r_c02.ds_atrib_regra;

        t_regra_atributo_row_w.ie_regra	:= dbpanel_util_pck.formarattributerule(
								ie_tabstop_w,
								ie_enable_w,
								ie_obrigatorio_w,
								ie_repetir_valor_w,
								ie_padrao_nulo_w,
								ie_readonly_w,
								ds_regra_w,
								vl_default_w,
								ie_sequence_w,
								ie_gerar_log_w,
								nr_tabstop_w,
								ie_visible_w
						);
        t_regra_atributo_row_w.ds_atrib_regra           := r_c02.ds_atrib_regra;
        t_regra_atributo_row_w.ds_script                := r_c02.ds_script;
        t_regra_atributo_row_w.ie_tipo_script           := r_c02.ie_tipo_script;
				
				t_regra_atributo_row_w.ie_visible           := ie_visible_w;
				t_regra_atributo_row_w.ie_repetir_valor     := ie_repetir_valor_w;

        t_regra_atributo_row_w.qt_max_caracteres	:= r_c02.qt_tam_max;
				t_regra_atributo_row_w.qt_min_caracteres	:= r_c02.qt_tam_min;

        RETURN NEXT t_regra_atributo_row_w;
    end; --c02
    end loop;
    return;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION dbpanel_util_pck.get_all_regras_atributo ( nm_tabela_p text, nm_atributo_p text, nr_seq_visao_p integer ) FROM PUBLIC;
