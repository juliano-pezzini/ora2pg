-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION dbpanel_util_pck.get_regra_atributo ( nm_tabela_p text, nr_seq_visao_p integer, cd_estabelecimento_p integer, cd_perfil_p integer, cd_funcao_ativa_p integer, cd_setor_atendimento_p integer, nm_usuario_p text, nr_seq_regra_p bigint) RETURNS SETOF T_REGRA_ATRIBUTO_ROW_DATA AS $body$
DECLARE



cd_funcao_w						bigint	:= coalesce(cd_funcao_ativa_p,0);
cd_perfil_w						bigint	:= coalesce(cd_perfil_p,0);
cd_setor_atendimento_w			bigint	:= coalesce(cd_setor_atendimento_p,0);

t_regra_atributo_row_w			t_regra_atributo_row;
ie_obrigatorio_w				varchar(10);
ie_obrigatorio_visao_w			varchar(10);
ie_obrigatorio_regra_w          varchar(10) := null;
ie_nullable_w					varchar(10);
ie_enable_w						varchar(1);
ie_tabstop_w					varchar(1);
ie_readonly_w					varchar(1);
ie_repetir_valor_w				varchar(10);
ie_padrao_nulo_w				varchar(10);
ds_regra_w						varchar(100);
ie_sequence_w					varchar(100);
vl_default_w					varchar(2000);
qt_seq_inicio_w					bigint;
ie_gerar_log_w					varchar(1);
nr_tabstop_w            		varchar(4);
ie_visible_w            		varchar(4);

C01 CURSOR FOR
	SELECT a.nm_atributo,
		  a.ds_mascara,
		  b.qt_seq_inicio,
		  coalesce(b.ie_obrigatorio,'N') ie_obrigatorio,
          coalesce(a.ie_obrigatorio, 'N') ie_obrigatorio_visao,
		  coalesce(a.ie_tabstop, b.ie_tabstop) ie_tabstop,
		  coalesce(a.ie_readonly, b.ie_readonly) ie_readonly,
		  a.vl_padrao vl_default
	FROM	tabela_atributo b,
		 tabela_visao_atributo a
	WHERE  b.nm_tabela = nm_tabela_p
		AND	 a.nm_atributo = b.nm_atributo
		AND	 a.nr_sequencia = nr_seq_visao_p
	ORDER BY b.nr_seq_apresent,
			b.nr_sequencia_criacao;


C02 CURSOR FOR
	SELECT	qt_tam_max,
			qt_tam_min,
			coalesce(CASE WHEN ie_obrigatorio_w='S' THEN 'S'  ELSE ie_obrigatorio END , 'N') ie_obrigatorio,
			coalesce(ie_enable, ie_enable_w) ie_enable,
			coalesce(ie_visible, ie_visible_w) ie_visible,
			coalesce(ie_tabstop,ie_tabstop_w) ie_tabstop,
            coalesce(CASE WHEN ie_readonly_w='S' THEN 'S'  ELSE ie_readonly END , 'N') ie_readonly,
			coalesce(ie_repetir_valor, 'N') ie_repetir_valor,
			coalesce(ie_padrao_nulo,'N') ie_padrao_nulo,
			coalesce(vl_default, vl_default_w) vl_default,
			ds_regra,
			ie_gerar_log,
			nr_tabstop
	FROM	tabela_atrib_regra
	WHERE 	nm_tabela 				= nm_tabela_p
	AND		nm_atributo 			= t_regra_atributo_row_w.nm_atributo
	AND   	coalesce(cd_estabelecimento,cd_estabelecimento_p)		= cd_estabelecimento_p
	AND		coalesce(cd_perfil, 			cd_perfil_w)		= cd_perfil_w
	AND 	coalesce(cd_setor_atendimento, 	cd_setor_atendimento_w)	= cd_setor_atendimento_w
	AND 	coalesce(cd_funcao, cd_funcao_w)	= cd_funcao_w
	AND 	coalesce(nr_seq_visao,nr_seq_visao_p)  = nr_seq_visao_p
	AND 	coalesce(nr_seq_regra_funcao, nr_seq_regra_p)  = nr_seq_regra_p
	AND 	coalesce(nm_usuario_param, nm_usuario_p) 	= nm_usuario_p
	AND		consiste_hor_regra_atrib(hr_inicio,hr_fim,ie_dia_semana) = 'S'
	ORDER BY 	coalesce(nm_usuario_param,'AAAAAAAA'),
				coalesce(cd_perfil,0),
				coalesce(cd_setor_atendimento,0),
				coalesce(cd_estabelecimento,0),
				coalesce(cd_funcao,0),
				coalesce(nr_seq_visao,0),
				coalesce(nr_seq_regra_funcao,0);

BEGIN

for r_c01 in c01 loop
	begin

	t_regra_atributo_row_w.nm_atributo			:= r_c01.nm_atributo;
	t_regra_atributo_row_w.ds_mascara			:= r_c01.ds_mascara;
	t_regra_atributo_row_w.qt_seq_inicio		:= r_c01.qt_seq_inicio;


	t_regra_atributo_row_w.qt_max_caracteres	:= null;
	t_regra_atributo_row_w.qt_min_caracteres	:= null;
	t_regra_atributo_row_w.ie_visible			:= 'S';
	ie_obrigatorio_w							:= r_c01.ie_obrigatorio;
    ie_obrigatorio_visao_w                      := r_c01.ie_obrigatorio_visao;
	ie_tabstop_w								:= r_c01.ie_tabstop;
	ie_readonly_w								:= r_c01.ie_readonly;
    vl_default_w								:= r_c01.vl_default;

	if (ie_obrigatorio_w = 'N') then

		SELECT 	coalesce(MAX(nullable),'S')
		INTO STRICT 	ie_nullable_w
		FROM 	user_tab_columns
		WHERE 	table_name 	= nm_tabela_p
		AND 	column_name	 	= r_c01.nm_atributo;

		if (ie_nullable_w	= 'N') then
			ie_obrigatorio_w	:= 'S';
		end if;

	end if;

	ie_enable_w			:= 'S';
	ie_visible_w		:= 'S';
	ie_repetir_valor_w	:= 'N';
	ie_padrao_nulo_w	:= 'N';
	ds_regra_w			:= null;
	ie_gerar_log_w		:= 'N';
	nr_tabstop_w		:=	null;
	ie_sequence_w		:= null;
	ie_obrigatorio_regra_w	:= null;

	if (r_c01.qt_seq_inicio> 0) then
		ie_sequence_w	:= '@Sequence';
	end if;

	for r_c02 in c02 loop
		begin
		t_regra_atributo_row_w.qt_max_caracteres	:= r_c02.qt_tam_max;
		t_regra_atributo_row_w.qt_min_caracteres	:= r_c02.qt_tam_min;
		t_regra_atributo_row_w.ie_visible			:= r_c02.ie_visible;
		ie_obrigatorio_regra_w						:= r_c02.ie_obrigatorio;
		ie_enable_w									:= r_c02.ie_enable;
		ie_visible_w								:= r_c02.ie_visible;
		ie_tabstop_w								:= r_c02.ie_tabstop;
		ie_readonly_w								:= r_c02.ie_readonly;
		ie_padrao_nulo_w							:= r_c02.ie_padrao_nulo;
		ie_repetir_valor_w							:= r_c02.ie_repetir_valor;
		ds_regra_w									:= r_c02.ds_regra;
		vl_default_w								:= r_c02.vl_default;
		ie_gerar_log_w								:= r_c02.ie_gerar_log;
		nr_tabstop_w								:= r_c02.nr_tabstop;
		end;
	end loop;

    if (ie_obrigatorio_regra_w IS NOT NULL AND ie_obrigatorio_regra_w::text <> '') then
        ie_obrigatorio_w := ie_obrigatorio_regra_w;
    elsif (ie_obrigatorio_w = 'N') then
        ie_obrigatorio_w := coalesce(ie_obrigatorio_visao_w, 'N');
    end if;

	if (r_c01.nm_atributo = 'DT_ATUALIZACAO') and (coalesce(vl_default_w::text, '') = '') then
		vl_default_w	:= 'SYSDATE';
	end if;
	if (r_c01.nm_atributo = 'NM_USUARIO') and (coalesce(vl_default_w::text, '') = '') then
		vl_default_w	:= nm_usuario_p;
	end if;

	t_regra_atributo_row_w.ie_regra					:= substr(	ie_tabstop_w || '|?&' ||
																ie_enable_w || '|?&' ||
																ie_obrigatorio_w || '|?&' ||
																coalesce(ie_repetir_valor_w,'N') || '|?&' ||
																coalesce(ie_padrao_nulo_w,'N') || '|?&' ||
																ie_readonly_w ||'|?&'||
																coalesce(ds_regra_w,' ') || '|?&' ||
																coalesce(vl_default_w || ie_sequence_w,'null') || '|?&' ||
																coalesce(ie_gerar_log_w, 'N') || '|?&' ||
																coalesce(nr_tabstop_w,'null'), 1, 4000) || '|?&' ||
																coalesce(ie_visible_w, 'S');


	RETURN NEXT t_regra_atributo_row_w;
	end;
end loop;



return;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION dbpanel_util_pck.get_regra_atributo ( nm_tabela_p text, nr_seq_visao_p integer, cd_estabelecimento_p integer, cd_perfil_p integer, cd_funcao_ativa_p integer, cd_setor_atendimento_p integer, nm_usuario_p text, nr_seq_regra_p bigint) FROM PUBLIC;
