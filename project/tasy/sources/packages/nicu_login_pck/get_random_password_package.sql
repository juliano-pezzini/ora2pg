-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION nicu_login_pck.get_random_password (id_visit_number_p text) RETURNS varchar AS $body$
DECLARE


ds_pass_template_w	nicu_settings.ds_password_template%type;
ds_password_w		varchar(10);


BEGIN

	select	coalesce(max(ds_password_template), 'R')
	into STRICT	ds_pass_template_w
	from	nicu_settings;
	
	if (ds_pass_template_w = 'R') then
		
		select	dbms_random.string('P',6)
		into STRICT	ds_password_w
		;

	elsif (ds_pass_template_w = 'M') then
		
		select  pn.ds_given_name
		into STRICT	ds_password_w
		from    person_name pn,
				nicu_parent np,
				nicu_parent_patient npp,
				nicu_encounter ne
		where   pn.nr_sequencia = np.nr_seq_person_name
		and     np.nr_sequencia = npp.nr_seq_parent
		and     npp.nr_seq_patient = ne.nr_seq_patient
		and     ne.id_visit_number = id_visit_number_p
		and     np.ie_relationship = 'MTH';
		
	else
		ds_password_w := id_visit_number_p;
	end if;

	return ds_password_w;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION nicu_login_pck.get_random_password (id_visit_number_p text) FROM PUBLIC;
