-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION nicu_login_pck.get_activators ( nm_usuario_p text, nm_computador_p text) RETURNS SETOF T_LOGIN_ACTIVATORS_TABLE AS $body$
DECLARE


r_login_activators_field_w  r_login_activators_field;
nr_seq_encouter_w nicu_encounter.nr_seq_patient%type;
ie_nicu_user_profile_w varchar(50);
ie_match_baby_bed_w varchar(1);
type t_baby_beds_match is table of nicu_encounter.nr_sequencia%type;
bulk_baby_beds_match_w t_baby_beds_match;


BEGIN
	select	CASE WHEN count(*)=0 THEN 'CLINICAL'  ELSE 'PARENT' END
	into STRICT	ie_nicu_user_profile_w
	from	usuario
	WHERE	nm_usuario = nm_usuario_p
	AND		(id_visit_number IS NOT NULL AND id_visit_number::text <> '');
	
    select  coalesce(max(enc.nr_sequencia), 0) as nr_encounter
    into STRICT    nr_seq_encouter_w
    FROM usuario u
LEFT OUTER JOIN nicu_encounter enc ON (u.id_visit_number = enc.id_visit_number)
WHERE (coalesce(enc.dt_discharge::text, '') = '' or enc.dt_discharge >= clock_timestamp())  and u.nm_usuario = nm_usuario_p;

    select  enc.nr_sequencia
    bulk collect into STRICT bulk_baby_beds_match_w
    from    computador comp,
            unidade_atendimento unid,
            nicu_encounter enc,
            usuario u
    where (coalesce(enc.dt_discharge::text, '') = '' or enc.dt_discharge >= clock_timestamp())
    and     comp.nr_seq_interno = unid.nr_seq_interno
    and     comp.cd_setor_atendimento = unid.cd_setor_atendimento
    and     comp.cd_standard_bed = unid.cd_unidade_compl
    and     enc.id_visit_number = u.id_visit_number
    and     enc.nr_sequencia = nr_seq_encouter_w;

    r_login_activators_field_w.nr_encounter := nr_seq_encouter_w;
    r_login_activators_field_w.ie_nicu_user_profile := ie_nicu_user_profile_w;
    if (bulk_baby_beds_match_w.count > 0) then
        r_login_activators_field_w.ie_match_baby_bed := 'S';
    else
        r_login_activators_field_w.ie_match_baby_bed := 'N';
    end if;
    RETURN NEXT r_login_activators_field_w;
    return;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION nicu_login_pck.get_activators ( nm_usuario_p text, nm_computador_p text) FROM PUBLIC;
