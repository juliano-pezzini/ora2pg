-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_sip_pck.valida_pode_alterar_sip ( nr_seq_lote_p pls_lote_sip.nr_sequencia%type, cd_estabelecimento_p pls_outorgante.cd_estabelecimento%type, ie_opcao text default 'tudo') AS $body$
DECLARE


--	ie_opcao ->	'somente_estabelecimento' - valida so o estabelecimento

--		'tudo' - valida tudo


cd_estabelecimento_w		pls_outorgante.cd_estabelecimento%type;
nm_usuario_envio_w		pls_lote_sip.nm_usuario_envio%type;
dt_envio_w			pls_lote_sip.dt_envio%type;


BEGIN
	begin
	select	cd_estabelecimento,
		nm_usuario_envio,
		dt_envio
	into STRICT	cd_estabelecimento_w,
		nm_usuario_envio_w,
		dt_envio_w
	from	pls_lote_sip
	where	nr_sequencia	= nr_seq_lote_p;
	exception
		when others then
		-- Lote do SIP nao existe

		CALL wheb_mensagem_pck.exibir_mensagem_abort(200283,'NR_SEQ_LOTE_SIP_P='||nr_seq_lote_p);
	end;
	
	-- verificacao de seguranca para o caso do estabelecimento do usuario seja diferente do estabelecimento do SIP

	if (cd_estabelecimento_p <> cd_estabelecimento_w)	then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(227151);
	end if;
	
	if (ie_opcao = 'tudo') then
		-- verificacao de seguranca para o caso do SIP ja ter sido confirmado

		if ((nm_usuario_envio_w IS NOT NULL AND nm_usuario_envio_w::text <> '') or (dt_envio_w IS NOT NULL AND dt_envio_w::text <> '')) then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(231265);
		end if;
	end if;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_sip_pck.valida_pode_alterar_sip ( nr_seq_lote_p pls_lote_sip.nr_sequencia%type, cd_estabelecimento_p pls_outorgante.cd_estabelecimento%type, ie_opcao text default 'tudo') FROM PUBLIC;
