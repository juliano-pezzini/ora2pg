-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



-- retorna se o atendimento foi completamente glosado



CREATE OR REPLACE FUNCTION pls_sip_pck.obter_se_atendimento_glosado ( nr_seq_conta_p sip_nv_dados.nr_seq_conta%type) RETURNS varchar AS $body$
DECLARE



cd_guia_referencia_w	sip_nv_dados.cd_guia_referencia%type;
nr_seq_segurado_w	sip_nv_dados.nr_seq_segurado%type;

ds_retorno_w	varchar(1);


-- busca as contas do atendimento, e feito desta forma para aproveitar a rotina que ja valida se a conta esta glosada.

c01 CURSOR(	cd_guia_referencia_pc	sip_nv_dados.cd_guia_referencia%type,
		nr_seq_segurado_pc	sip_nv_dados.nr_seq_segurado%type) FOR
	SELECT	pls_obter_se_conta_glosada(a.nr_sequencia) ie_conta_glosada
	from	pls_conta	a
	where	a.cd_guia_ok		= cd_guia_referencia_pc
	and	a.nr_seq_segurado	= nr_seq_segurado_pc;

BEGIN

-- padrao esta glosada

ds_retorno_w := 'S';

-- carrega as inf do atendimento

select	a.cd_guia_ok,
	a.nr_seq_segurado
into STRICT	cd_guia_referencia_w,
	nr_seq_segurado_w
from	pls_conta	a
where	a.nr_sequencia	= nr_seq_conta_p;

-- carrega o atendimento

for r_C01_w in c01(cd_guia_referencia_w, nr_seq_segurado_w) loop

	-- se encontrou uma conta nao glosada, marca como 'N'

	if (r_C01_w.ie_conta_glosada = 'N') then
	
		ds_retorno_w := 'N';
	end if;
end loop;

return ds_retorno_w;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pls_sip_pck.obter_se_atendimento_glosado ( nr_seq_conta_p sip_nv_dados.nr_seq_conta%type) FROM PUBLIC;
