-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_sip_pck.executa_soma_itens_sem_regra ( nr_seq_lote_p pls_lote_sip.nr_sequencia%type, nm_usuario_p text) AS $body$
DECLARE

					
nr_seq_item_assist_w	sip_lote_item_assistencial.nr_sequencia%type;

c_item CURSOR FOR
	SELECT	nr_sequencia, nr_seq_apres
	from  	sip_item_assistencial
	where  	ie_permite_regra = 'N'
	order by nr_seq_apres desc;
	
c_todo_filho CURSOR(	nr_seq_lote_p 		pls_lote_sip.nr_sequencia%type,
			nr_seq_item_p		sip_item_assistencial.nr_sequencia%type) FOR
	SELECT	ie_tipo_contratacao,
		ie_segmentacao_sip,
		dt_ocorrencia,
		sg_uf,
		sum(qt_evento) qt_evento,
		sum(vl_despesa) vl_despesa
	from	sip_lote_item_assistencial
	where	nr_seq_lote = nr_seq_lote_p
	-- busca somente os filhos do tipo de internacao

	and	nr_seq_item_sip in (WITH RECURSIVE cte AS (
	SELECT 	nr_sequencia,1 as level
					from  	sip_item_assistencial WHERE nr_sequencia =  nr_seq_item_p
  UNION ALL
	SELECT 	nr_sequencia,(c.level+1)
					from  	sip_item_assistencial JOIN cte c ON (c.prior nr_sequencia = nr_seq_superior)

) SELECT * FROM cte WHERE level = 2;
)
	group by ie_tipo_contratacao, ie_segmentacao_sip, dt_ocorrencia, sg_uf;
	
c_filho_esp CURSOR(	nr_seq_lote_p 		pls_lote_sip.nr_sequencia%type,
			nr_seq_item_p		sip_item_assistencial.nr_sequencia%type) FOR
	SELECT	ie_tipo_contratacao,
		ie_segmentacao_sip,
		dt_ocorrencia,
		sg_uf,
		sum(qt_evento) qt_evento,
		sum(vl_despesa) vl_despesa
	from	sip_lote_item_assistencial
	where	nr_seq_lote = nr_seq_lote_p
	-- busca somente o tipo de internacao

	and	nr_seq_item_sip = nr_seq_item_p
	group by ie_tipo_contratacao, ie_segmentacao_sip, dt_ocorrencia, sg_uf;
					
BEGIN

-- faz os devidos somatorios nos itens que sao resultado de soma

for r_c_item_w in c_item loop
	
	-- quando for internacao

	if (r_c_item_w.nr_sequencia = 64) then
		-- soma tudo o que sera armazenado em tipo de internacao

		-- coloca somente o tipo de internacao porque se colocar o regime de internacao junto vai duplicar

		for r_c_filho_esp_w in c_filho_esp(nr_seq_lote_p, 65) loop
			nr_seq_item_assist_w := pls_sip_pck.sip_nv_insere_lote(	r_c_item_w.nr_sequencia, nr_seq_lote_p, r_c_filho_esp_w.sg_uf, r_c_filho_esp_w.ie_tipo_contratacao, r_c_filho_esp_w.ie_segmentacao_sip, r_c_filho_esp_w.dt_ocorrencia, r_c_filho_esp_w.qt_evento, r_c_filho_esp_w.vl_despesa, nm_usuario_p, nr_seq_item_assist_w);
		end loop;
	else
		for r_c_todo_filho_w in c_todo_filho(nr_seq_lote_p, r_c_item_w.nr_sequencia) loop
			nr_seq_item_assist_w := pls_sip_pck.sip_nv_insere_lote(	r_c_item_w.nr_sequencia, nr_seq_lote_p, r_c_todo_filho_w.sg_uf, r_c_todo_filho_w.ie_tipo_contratacao, r_c_todo_filho_w.ie_segmentacao_sip, r_c_todo_filho_w.dt_ocorrencia, r_c_todo_filho_w.qt_evento, r_c_todo_filho_w.vl_despesa, nm_usuario_p, nr_seq_item_assist_w);
		end loop;
	end if;
end loop;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_sip_pck.executa_soma_itens_sem_regra ( nr_seq_lote_p pls_lote_sip.nr_sequencia%type, nm_usuario_p text) FROM PUBLIC;
