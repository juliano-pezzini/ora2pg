-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_sip_pck.gera_indice_exp_res ( nr_seq_lote_sip_p pls_lote_sip.nr_sequencia%type, dt_periodo_inicial_p pls_lote_sip.dt_periodo_inicial%type, dt_periodo_final_p pls_lote_sip.dt_periodo_final%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE

/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade:	Rotina responsavel por gerar o indice de exposicao relacionado a contratacao ou rescisao do contrato

	Este indice, diferente dos demais, e calculado quando o beneficiario contrata o plano
	durante o lote SIP, ou entao acaba rescindindo ele.
		
-------------------------------------------------------------------------------------------------------------------

Locais de chamada direta: 
[X]  Objetos do dicionario [ ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatorios [ ] Outros:
-------------------------------------------------------------------------------------------------------------------

Pontos de atencao:

Alteracoes:
-------------------------------------------------------------------------------------------------------------------

++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
	

-- Variaveis para bucar o indice

ds_sql_cur_w			varchar(32000) := '';
dados_bind_w			sql_pck.t_dado_bind;
cur_indice_exp_w		sql_pck.t_cursor;

tb_indice_exp_w			t_exposicao_benef;
tb_indice_exp_filtrado_w	t_exposicao_benef;

BEGIN

-- Carrega os itens assistencias que precisa ter o calculo do exposto realizado

for r_c01_w in current_setting('pls_sip_pck.c_item_assist_exp')::CURSOR(nr_seq_lote_p(nr_seq_lote_sip_p) loop

	-- Limpa os registros

	dados_bind_w.delete;
	
	-- se o cursor estiver aberto, fecha

	if (cur_indice_exp_w%isopen) then
	
		close cur_indice_exp_w;
	end if;
	
	dados_bind_w := pls_sip_pck.gera_sql_indice_exp_res(	r_c01_w.ie_tipo_contratacao_in_sip, r_c01_w.cd_classificacao, nr_seq_lote_sip_p, r_c01_w.nr_seq_item_assist, dt_periodo_inicial_p, dt_periodo_final_p, dados_bind_w);
	
	dados_bind_w := sql_pck.executa_sql_cursor(ds_sql_cur_w, dados_bind_w);
	
	loop
	fetch cur_indice_exp_w bulk collect into	tb_indice_exp_w.nr_seq_segurado,
							tb_indice_exp_w.nr_seq_tipo_carencia,
							tb_indice_exp_w.dt_inicio_vig_carencia,
							tb_indice_exp_w.qt_dias_conf_car,
							tb_indice_exp_w.qt_dias_fora_abrang_ant,
							tb_indice_exp_w.dt_contratacao,
							tb_indice_exp_w.dt_rescisao,
							tb_indice_exp_w.dt_inicio_lote_sip,
							tb_indice_exp_w.dt_fim_lote_sip,
							tb_indice_exp_w.qt_dias_exposicao,
							tb_indice_exp_w.qt_exposicao,
							tb_indice_exp_w.qt_dias_carencia_lote,
							tb_indice_exp_w.ie_envio_sip,
							tb_indice_exp_w.nr_seq_lote,
							tb_indice_exp_w.nr_seq_item_assist,
							tb_indice_exp_w.ie_origem_exposicao,
							tb_indice_exp_w.qt_benef_exp_item,
							tb_indice_exp_w.nr_seq_carencia,
							tb_indice_exp_w.dt_ini_contratacao limit current_setting('pls_sip_pck.qt_registro_transacao_w')::integer;
	exit when tb_indice_exp_w.nr_seq_segurado.count = 0;
	
		-- aplica os IF Extra

		tb_indice_exp_filtrado_w := pls_sip_pck.if_extra_idx_exp_geral(tb_indice_exp_w, tb_indice_exp_filtrado_w);
		
		-- Chama a rotina que gerencia o indice, calculando ele e gravando.

		tb_indice_exp_filtrado_w := pls_sip_pck.gerencia_indice_exposto(tb_indice_exp_filtrado_w, nm_usuario_p);
		tb_indice_exp_filtrado_w := pls_sip_pck.limpar_tb_exposicao(tb_indice_exp_filtrado_w);
		
	end loop; -- fim indice expostos da carencia
	-- se o cursor estiver aberto, fecha. e importante ficar aqui tambem, para evitar sair do loop principal e deixar este curso aberto

	if (cur_indice_exp_w%isopen) then
	
		close cur_indice_exp_w;
	end if;
	

end loop;


END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_sip_pck.gera_indice_exp_res ( nr_seq_lote_sip_p pls_lote_sip.nr_sequencia%type, dt_periodo_inicial_p pls_lote_sip.dt_periodo_inicial%type, dt_periodo_final_p pls_lote_sip.dt_periodo_final%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;
