-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pls_sip_pck.obter_segmentacao_sip ( ie_item_hosp_p sip_item_assistencial.ie_hospitalar%type, ie_item_hosp_obs_p sip_item_assistencial.ie_hospitalar_obs%type, ie_item_amb_p sip_item_assistencial.ie_ambulatorial%type, ie_item_odonto_p sip_item_assistencial.ie_odontologico%type, ie_segmentacao_benef_p text) RETURNS varchar AS $body$
DECLARE


-- IE_SEGMENTACAO = Dominio 1665

-- 1               Ambulatorial

-- 2               Hospitalar com Obstetricia

-- 3               Hospitalar sem Obstetricia

-- 4               Odontologico

-- 5               Referencia (Amb + Hosp com Obstetricia padrao enfermaria)

-- 6               Ambulatorial + Hospitalar com Obstetricia

-- 7               Ambulatorial + Hospitalar sem Obstetricia

-- 8               Ambulatorial + Odontologico

-- 9               Hospitalar com Obstetricia + Odontologico

-- 10              Hospitalar sem Obstetricia + Odontologico

-- 11              Amb + Hosp com Obstetricia + Odontologico

-- 12              Amb + Hosp sem Obstetricia + Odontologico

				
ds_retorno_w			varchar(2);


BEGIN

-- Verificar se a classificacao possui os 2 itens hospitalares checados

/*
--Atendendo ao manual do XML do SIP versao 1.02c,

"- Operadoras com cobertura hospitalar e obstetrica deverao enviar as informacoes sobre os itens
hospitalares no quadro hospitalarObstetricia. Dentro de uma mesma forma de contratacao nao
podem ser declaradas as segmentacao hospitalar e hospitalarObstetricia juntas. Quando existir
uma, a outra nao pode existir. " 
Nesse caso,  se estivermos verificando um item assistencial com segmentacao no SIP Hospitalar e tambem 
for hospitalar com obstetricia, entao sera considerado Hospitalar com obstetricia. Se o item tambem tiver 
a segmentacao ambulatorial, entao sera verificado se produto do beneficiario for ambulatorial(sem ser hospitalar
e hospitalar com obstetricia), entao sera considerada a segmentacao ambulatorial, caso contrario, tambem sera
hospitalar com obstetricia.
*/

if (ie_item_hosp_p = 'S') and (ie_item_hosp_obs_p = 'S') then
	
	ds_retorno_w	:= '3';
	if (ie_item_amb_p = 'S') then
	
		if (ie_segmentacao_benef_p in ('1','8')) then
				
			ds_retorno_w	:= '1';
			
		end if;
	end if;
	--Antigamente

	--if	(ie_segmentacao_benef_p in ('3','7','10','12')) then

	--	ds_retorno_w	:= '2';

	/*elsif	(ie_segmentacao_benef_p in ('2','5','6','9','11')) then
		ds_retorno_w	:= '3';
	elsif	(ie_segmentacao_benef_p = '4') then
		ds_retorno_w	:= '1';
	elsif	(ie_segmentacao_benef_p in ('1','8')) then
		ds_retorno_w	:= '1';*/

	--end if;

	
elsif (ie_item_amb_p = 'S') then

	ds_retorno_w	:= '1';
	
	/*if	(ie_segmentacao_benef_p in ('1','5','6','7','8','11','12')) then
		ds_retorno_w	:= '1';
	elsif	(ie_segmentacao_benef_p in ('3','10')) then
		ds_retorno_w	:= '3'; --'2'
	elsif	(ie_segmentacao_benef_p in ('2','9')) then
		ds_retorno_w	:= '3';
	elsif	(ie_segmentacao_benef_p = '4') then
		ds_retorno_w	:= '1';
	end if;*/

	
elsif (ie_item_hosp_p = 'S') then

	ds_retorno_w	:= '2';

	/*if	(ie_segmentacao_benef_p in ('1','8')) then
		ds_retorno_w	:= '1';
	elsif	(ie_segmentacao_benef_p in ('3','7','10','12')) then
		ds_retorno_w	:= '3';--'2'
	elsif	(ie_segmentacao_benef_p in ('2','5','6','9','11')) then
		ds_retorno_w	:= '3';
	elsif	(ie_segmentacao_benef_p = '4') then
		ds_retorno_w	:= '1';
	end if;*/

	
elsif (ie_item_hosp_obs_p = 'S') then

	ds_retorno_w	:= '3';

	/*if	(ie_segmentacao_benef_p in ('1','8')) then
		ds_retorno_w	:= '1';
	elsif	(ie_segmentacao_benef_p in ('3','7','10','12')) then
		ds_retorno_w	:= '3'; --'2'
	elsif	(ie_segmentacao_benef_p in ('2','5','6','9','11')) then
		ds_retorno_w	:= '3';
	elsif	(ie_segmentacao_benef_p = '4') then
		ds_retorno_w	:= '1';
	end if;*/

	
elsif (ie_item_odonto_p = 'S') then
	if (ie_segmentacao_benef_p in ('4','8','9','10','11','12')) then
		ds_retorno_w	:= '4';
	end if;
end if;

return	ds_retorno_w;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 IMMUTABLE;
-- REVOKE ALL ON FUNCTION pls_sip_pck.obter_segmentacao_sip ( ie_item_hosp_p sip_item_assistencial.ie_hospitalar%type, ie_item_hosp_obs_p sip_item_assistencial.ie_hospitalar_obs%type, ie_item_amb_p sip_item_assistencial.ie_ambulatorial%type, ie_item_odonto_p sip_item_assistencial.ie_odontologico%type, ie_segmentacao_benef_p text) FROM PUBLIC;
