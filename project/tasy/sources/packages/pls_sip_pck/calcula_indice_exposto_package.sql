-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_sip_pck.calcula_indice_exposto ( tb_exposicao_p INOUT t_exposicao_benef) AS $body$
DECLARE

/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade:	Rotina que calcula o indice de exposicao.
	
	Para calcular o indice, e necessario considerar as carencias que o beneficiario possua, que incidem
	dentro do lote do SIP, e tambem e considerado a data de contratacao e rescisao.
	
	A contratacao e importante considerar, pois um beneficiario que efetuar a contratacao, por exemplo,
	no segundo mes do lote SIP, o seu calculo de exposicao deve desconsiderar os dias anteriores,
	entendendo que o beneficiario so ficaria exposto apos contratar a operadora.
	
	Isso influencia tambem o calculo com a carencia, pois o periodo de carencia vai ser aplicado no periodo
	do SIP, desde que o beneficiario tenha a contratacao anterior ao periodo do SIP. Se a contratacao for
	durante o periodo do SIP, a carencia devera compreender um numero menor de dias no calculo.
	
	Em termos praticos, para calcular o indice, alem do que e obtido em tabelas, e preciso apurar os seguintes dados:
	
		1) A DATA INICIAL DO BENEFICIARIO em relacao ao lote SIP, onde ao constatar que a contratacao e superior 
		ao inicio do lote do SIP,  sera utilizado a contratacao, senao e utilizado a data inical do lote em si
		
		2) A DATA FINAL DO BENEFICIARIO em relacao ao lote, se o beneficiario rescindiu o contrato
		antes do final do lote (mas ainda dentro do periodo do lote como um todo), devera ser utilizado
		a data de rescisao, indicando que o beneficiario so estaria exposto aos servicos ate a rescisao.
		se a rescicao nao for informada ou possuir data superior ao final do lote, sera utilizado a
		data fim do lote
	
	Como calcular a quantidade de dias em carencia:
		Para calcular a quantidade de dias em carencia, primeiro se levanta a data final da carencia
		que e a data inicial da vigencia da carencia, somada a quantidade de dias em carencia e a quantidade
		de dias de carencia anteriores.
		
		Se a data final de carencia for superior a data final do beneficiario, sera considerado a 
		subtracao entre elas, ficando (data final do beneficiario) - (data inicio de carencia) . Ainda 
		neste caso, se a data de inicio de vigencia da carencia, for inferior a data inicial do beneficiario,
		no calculo sera utilizado a data inicial do beneficiario, ficando (data final do beneficiario) - (data inicial do beneficiario)
		
		Se a data final de carencia for inferior a data final do beneficiario, sera utilizada a soma
		entre quantidade de dias de carencia e a quantidade de dias de carencia anterior.
		
		Se nao possuir a data de inicio da carencia, o resultado sera zero.
		Se nao possuir o numero de quantidade de dias da carencia (a nivel de query) o resultado sera zero
		Se a data de incio da carencia for superior a data final do beneficiario, o resultado sera zero.
		
	Como calcular a quantidade de dias em exposicao
		Para este calculo, e necessario levantar a quantidade de dias em carencia primeiro.
		
		A quantidade de dias de exposicao e a subtracao entre a quantidade de dias entre a 
		data inicial do beneficiario e a data final do beneficiario, com a quantidade de dias em carencia
		ficando a seguinte formula:
		((data final do beneficiario + 1) - data inicial do beneficiario) - (quantidade de dias em carencia)
		
		Note que a data final do beneficiario recebe +1, isto e por causa do calculo, para considerar a propria
		data (como a hora dela e truncada, isso se faz necessario)
		
	Como calcular o indice de exposicao
		Para este calculo, e necessario a quantidade de dias em exposicao.
		
		Esse indice e o percentual entre a quantidade de dias em exposicao, no periodo em que
		se encontra a data inicial do lote SIP e a data final do SIP.
		
		Apos levantar o percentual, ele deve ser dividido por 100, pois para a ANS, neste 
		indice o numero 1 quer dizer que o beneficiario esta totalmente exposto no periodo, 
		zero representa que o beneficiario nao esta exposto a nenhum dia do periodo, e a 
		fracao representa a proporcionalidade de exposicao dentro do periodo.
		
	
-------------------------------------------------------------------------------------------------------------------

Locais de chamada direta: 
[X]  Objetos do dicionario [ ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatorios [ ] Outros:
-------------------------------------------------------------------------------------------------------------------

Pontos de atencao:

Alteracoes:
-------------------------------------------------------------------------------------------------------------------

++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */


dt_inicial_benef_w	timestamp;
dt_final_benef_w	timestamp;

BEGIN

-- se existir informacao a ser calculada

if (tb_exposicao_p.nr_seq_segurado.count > 0) then

	-- Percorre os expostos informados

	for i in tb_exposicao_p.nr_seq_segurado.first..tb_exposicao_p.nr_seq_segurado.last loop

		-- Primeiro e levantado as datas iniciais e finais do beneficiario atual

		-- Zera as variaveis locais pertinentes

		dt_inicial_benef_w	:= null;
		dt_final_benef_w 	:= null;
		
		-- Se a data de contratacao for superior ao inicio do lote sip, e utilizada a contratacao

		if (tb_exposicao_p.dt_inicio_lote_sip(i) < tb_exposicao_p.dt_contratacao(i)) then
		
			dt_inicial_benef_w := trunc(tb_exposicao_p.dt_contratacao(i), 'dd');
		else
		
			dt_inicial_benef_w := trunc(tb_exposicao_p.dt_inicio_lote_sip(i), 'dd');
		end if;
		
		
		-- A data final deve ser a data fim do lote, cas a data de rescisao nao seja informada, ou seja superior ao final do lote

		-- senao devera utilizar a data de rescisao

		if	((tb_exposicao_p.dt_fim_lote_sip(i) < tb_exposicao_p.dt_rescisao(i)) or (coalesce(tb_exposicao_p.dt_rescisao(i)::text, '') = '')) then
		
			dt_final_benef_w := trunc(tb_exposicao_p.dt_fim_lote_sip(i),'dd');
		else
		
			dt_final_benef_w := trunc(tb_exposicao_p.dt_rescisao(i),'dd');
		end if;
		
		
		-- Calcula a quantidade de dias em carencia

		if	(((tb_exposicao_p.dt_inicio_vig_carencia(i) IS NOT NULL AND (tb_exposicao_p.dt_inicio_vig_carencia(i))::text <> '')) and (coalesce(tb_exposicao_p.qt_dias_conf_car(i),0) > 0) and (to_date(tb_exposicao_p.dt_inicio_vig_carencia(i)) <= to_date(dt_final_benef_w))) then
		
			--Se a data final de carencia for superior a data final do beneficiario, sera considerado a subtracao entre elas, ficando (data final do beneficiario) - (data inicio de carencia) 

			if	(trunc((tb_exposicao_p.dt_inicio_vig_carencia(i) + coalesce(tb_exposicao_p.qt_dias_fora_abrang_ant(i), tb_exposicao_p.qt_dias_conf_car(i))),'dd') +1 > dt_final_benef_w) then
			
				-- Se a data de vigencia da carencia for inferior ao inicio do beneficiario, sera calculado como base o inicio do beneficiario

				if (tb_exposicao_p.dt_inicio_vig_carencia(i) < dt_inicial_benef_w) then
				
					tb_exposicao_p.qt_dias_carencia_lote(i) :=  (dt_final_benef_w +1) - dt_inicial_benef_w;
				else
				
					tb_exposicao_p.qt_dias_carencia_lote(i) :=  (dt_final_benef_w +1) - tb_exposicao_p.dt_inicio_vig_carencia(i);
				end if;
			else
				
				-- Considerando que a carencia termina no meio do periodo do sip.

				-- se a data de inicio da carencia for inferior a data inicial do beneficiario, sera calculado com base o inicio do beneficiario

				if (tb_exposicao_p.dt_inicio_vig_carencia(i) < dt_inicial_benef_w) then
				
					-- Pega a data limite em que a carencia atinge o lote, e subtrai com o inicio do benef, pegando apenas os dias em carencia pertinente ao lote (ou contratacao)

					tb_exposicao_p.qt_dias_carencia_lote(i)	:=  trunc(tb_exposicao_p.dt_inicio_vig_carencia(i) + coalesce(tb_exposicao_p.qt_dias_fora_abrang_ant(i), tb_exposicao_p.qt_dias_conf_car(i)) +1, 'dd') - dt_inicial_benef_w;
				else
				
					tb_exposicao_p.qt_dias_carencia_lote(i) := coalesce(tb_exposicao_p.qt_dias_fora_abrang_ant(i), tb_exposicao_p.qt_dias_conf_car(i));
				end if;
				
			end if;
		else

			tb_exposicao_p.qt_dias_carencia_lote(i) := 0;
		end if;
		
		
		-- Calcula a quantidade de dia em exposicao

		tb_exposicao_p.qt_dias_exposicao(i) := ((trunc(dt_final_benef_w, 'dd') + 1) - dt_inicial_benef_w) - tb_exposicao_p.qt_dias_carencia_lote(i);
		
		--Calcula o indice de exposicao

		tb_exposicao_p.qt_exposicao(i) := round(((tb_exposicao_p.qt_dias_exposicao(i) * 100) / ((trunc(tb_exposicao_p.dt_fim_lote_sip(i),'dd') + 1) - tb_exposicao_p.dt_inicio_lote_sip(i))) / 100, 4);
		

	end loop; -- Fim percorreu os expostos

end if; -- fim se existir inf a ser calculada

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_sip_pck.calcula_indice_exposto ( tb_exposicao_p INOUT t_exposicao_benef) FROM PUBLIC;
