-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pls_sip_pck.gera_sql_indice_exp_res ( ie_tipo_contratacao_in_sip_p pls_plano.ie_tipo_contratacao%type, cd_classificacao_p sip_item_assistencial.cd_classificacao%type, nr_seq_lote_p pls_lote_sip.nr_sequencia%type, nr_seq_item_assist_p sip_item_assistencial.nr_sequencia%type, dt_periodo_inicial_p pls_lote_sip.dt_periodo_inicial%type, dt_periodo_final_p pls_lote_sip.dt_periodo_final%type, dados_bind_p INOUT sql_pck.t_dado_bind) AS $body$
DECLARE


/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade:	Rotina responsavel por gerar o indice de exposicao do beneficiario com base 
	na sua contratacao ou rescisao dentro do periodo do lote SIP
	
	E montado um sql dinamico, que vai buscar as informacoes necessarias para o calculo do indice.
	
	O Calculo do indice nao deve ser feito diretamente no sql dinamico, embora isto seja possivel,
	essa pratica foi desconsiderada para poder centralizar o calculo em apenas uma rotina, evitando
	a duplicacao de codigo, e como sera em PL SQL, ficara mais legivel para os desenvolvedores.

-------------------------------------------------------------------------------------------------------------------

Locais de chamada direta: 
[X]  Objetos do dicionario [ ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatorios [ ] Outros:
-------------------------------------------------------------------------------------------------------------------

Pontos de atencao:

Alteracoes:
-------------------------------------------------------------------------------------------------------------------

++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */


ds_retorno_w		varchar(32000) := '';
ds_sql_base_benef_w	varchar(32000) := '';


BEGIN

-- Levanta o sql base que carrega os beneficiarios do lote SIP, conforme o item assitencial

dados_bind_p := pls_sip_pck.gera_sql_benef_exp_item(	ie_tipo_contratacao_in_sip_p, cd_classificacao_p, dados_bind_p);
							
ds_retorno_w	:=	'select	a.nr_seq_segurado, ' || pls_util_pck.enter_w ||
			'	null nr_seq_tipo_carencia, ' || pls_util_pck.enter_w ||
			'	null dt_inicio_vig_carencia, ' || pls_util_pck.enter_w ||
			'	null qt_dias_carencia, ' || pls_util_pck.enter_w ||
			'	null qt_dias_fora_abrang_ant, ' || pls_util_pck.enter_w ||
			'	a.dt_contratacao, ' || pls_util_pck.enter_w ||
			'	a.dt_rescisao, ' || pls_util_pck.enter_w ||
			'	:dt_inicio_periodo_p dt_inicio_lote_sip, ' || pls_util_pck.enter_w ||
			'	:dt_fim_periodo_p dt_fim_lote_sip, ' || pls_util_pck.enter_w ||
			'	0 qt_dias_exposicao, ' || pls_util_pck.enter_w ||
			'	0 qt_exposicao, ' || pls_util_pck.enter_w ||
			'	0 qt_dias_carencia_lote, ' || pls_util_pck.enter_w ||
			'	''N'' ie_envio_sip, ' || pls_util_pck.enter_w ||
			'	:nr_seq_lote_p nr_seq_lote, ' || pls_util_pck.enter_w ||
			'	:nr_seq_item_assist_p nr_seq_item_assist, ' || pls_util_pck.enter_w ||
			'	''CT'' ie_origem_exposicao, ' || pls_util_pck.enter_w ||
			'	0 qt_benef_exp_item, ' || pls_util_pck.enter_w ||
			'	null nr_seq_carencia, ' || pls_util_pck.enter_w ||
			'	null dt_ini_contratacao ' || pls_util_pck.enter_w ||
			'from (	' || ds_sql_base_benef_w  || pls_util_pck.enter_w ||
			-- Filtros adicionais na query base, para buscar apenas quem tem contratacao dentro do periodo sip

			'and	z.dt_contratacao between to_date(:dt_inicio_periodo_p) and to_date(:dt_fim_periodo_p) ' || pls_util_pck.enter_w ||
			-- Union all para buscar tambem os beneficiarios que tiveram rescisao no periodo sip

			'union all ' || pls_util_pck.enter_w ||
			ds_sql_base_benef_w || pls_util_pck.enter_w ||
			'and	z.dt_rescisao between to_date(:dt_inicio_periodo_p) and to_date(:dt_fim_periodo_p) ' || pls_util_pck.enter_w ||
			'	) a ' || pls_util_pck.enter_w ||
			'group by a.nr_seq_segurado, a.dt_contratacao, a.dt_rescisao ' || pls_util_pck.enter_w;
			
dados_bind_p := sql_pck.bind_variable(':nr_seq_lote_p', nr_seq_lote_p, dados_bind_p);
dados_bind_p := sql_pck.bind_variable(':nr_seq_item_assist_p', nr_seq_item_assist_p, dados_bind_p);
dados_bind_p := sql_pck.bind_variable(':dt_inicio_periodo_p', dt_periodo_inicial_p, dados_bind_p);
dados_bind_p := sql_pck.bind_variable(':dt_fim_periodo_p', dt_periodo_final_p, dados_bind_p);


return;


END;						

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pls_sip_pck.gera_sql_indice_exp_res ( ie_tipo_contratacao_in_sip_p pls_plano.ie_tipo_contratacao%type, cd_classificacao_p sip_item_assistencial.cd_classificacao%type, nr_seq_lote_p pls_lote_sip.nr_sequencia%type, nr_seq_item_assist_p sip_item_assistencial.nr_sequencia%type, dt_periodo_inicial_p pls_lote_sip.dt_periodo_inicial%type, dt_periodo_final_p pls_lote_sip.dt_periodo_final%type, dados_bind_p INOUT sql_pck.t_dado_bind) FROM PUBLIC;
