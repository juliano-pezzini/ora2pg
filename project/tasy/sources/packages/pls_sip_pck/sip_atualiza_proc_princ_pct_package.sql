-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_sip_pck.sip_atualiza_proc_princ_pct ( nr_seq_lote_p pls_lote_sip.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE

/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade:	Levanta e grava o procedimento considerado principal para o pacote

	Essa informacao e importante para a aplicacao das regras de itens assistenciais,
	onde o pacote devera ser direcionado corretamente.
	
	Essa rotina e dividida em duas etapas, a primeira por regra, e a segunta pela composicao
	
	Pela regra, e verificado os pacotes que tem a regra de procedimento principal do pacote,
	neste caso sera verificado se a conta que possui o pacote em questao, tem algum procedimento
	que seja condizente com a regra, se tiver, esse procedimento sera o procedimento principal.
	
	A forma pela composicao, e para os casos onde nao existe regra. Estes sera aberto a composicao,
	e o procedimento de maior quantidade sera eleito o principal
	
	E importante obedecer essa ordem, pois ambas as formas buscam apenas os pacotes fechados
	que ainda nao foram avaliados, portanto se executar a forma de composicao primeiro, pode
	existir pacotes com regra que ficarao com outra informacao.
	
-------------------------------------------------------------------------------------------------------------------

Locais de chamada direta: 
[X]  Objetos do dicionario [ ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatorios [ ] Outros:
-------------------------------------------------------------------------------------------------------------------

Pontos de atencao:

Alteracoes:
-------------------------------------------------------------------------------------------------------------------

++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */


BEGIN
-- Primeiro desfaz tudo, pois na alimenta nv dados nao e alterado nada do pacote

CALL pls_sip_pck.sip_desfaz_proc_princ_pct(nr_seq_lote_p);

-- Atualiza primeiro os pacotes que possuem regra.

CALL pls_sip_pck.sip_atz_proc_princ_regra_pct(nr_seq_lote_p, nm_usuario_p);

-- Atualiza agora os pacotes que ainda nao tem o procedimento principal informado, conforme a sua composicao

CALL pls_sip_pck.sip_atz_proc_princ_comp_pct(nr_seq_lote_p);


END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_sip_pck.sip_atualiza_proc_princ_pct ( nr_seq_lote_p pls_lote_sip.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;
