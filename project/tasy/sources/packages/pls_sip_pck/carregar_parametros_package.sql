-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


-- Carrega os dados dos parametros necessarios para geracao do lote.



CREATE OR REPLACE PROCEDURE pls_sip_pck.carregar_parametros ( nr_seq_lote_p pls_lote_sip.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, dt_periodo_inicial_p INOUT pls_lote_sip.dt_periodo_inicial%type, dt_periodo_final_p INOUT pls_lote_sip.dt_periodo_final%type, ie_validar_zerados_p INOUT pls_lote_sip.ie_gerar_itens_zerados%type, ie_tipo_geracao_lote_p INOUT text) AS $body$
DECLARE


cd_cgc_outorgante_w	pls_outorgante.cd_cgc_outorgante%type;

cs_params CURSOR(	cd_estabelecimento_pc	estabelecimento.cd_estabelecimento%type) FOR
	SELECT	ie_sip_contagem_evento,
		ie_vinc_internacao,
		(	SELECT	coalesce(max(ie_novo_sip),'N')
			from	pls_visible_false
			where	cd_estabelecimento = cd_estabelecimento_pc ) ie_novo_sip
	from	table(pls_parametros_pck.f_retorna_param(cd_estabelecimento_pc));

BEGIN

open cs_params(cd_estabelecimento_p);
fetch cs_params into current_setting('pls_sip_pck.param_w')::param;
close cs_params;

select	max(cd_cgc_outorgante)
into STRICT	cd_cgc_outorgante_w
from 	pls_outorgante;

-- verificacao para tratamentos especiais para a Unimed Rio Preto.

-- Isso deve sumir com o tempo, apenas serve para tratar a situacao do recurso de glosas 

-- que foi feito pelo motivo que nao tinhamos o recurso de glosa funcionando quando eles precisavam

if (cd_cgc_outorgante_w = '45100138000109') then
	PERFORM set_config('pls_sip_pck.ie_rio_preto_w', 'S', false);
else
	PERFORM set_config('pls_sip_pck.ie_rio_preto_w', 'N', false);
end if;

select	dt_periodo_inicial,
	coalesce(dt_periodo_final, clock_timestamp()),
	ie_gerar_itens_zerados,
	pls_sip_pck.obter_tipo_geracao_lote(nr_sequencia, qt_vidas_operadora)
into STRICT	dt_periodo_inicial_p,
	dt_periodo_final_p,
	ie_validar_zerados_p,
	ie_tipo_geracao_lote_p
from	pls_lote_sip
where	nr_sequencia	= nr_seq_lote_p;

-- Verifica em 'OPS - Cadastro de Regras > OPS - Rede credenciada > Controle de estabelecimento' se a geracao do SIP deve ser restringida pelo estaelecimento

PERFORM set_config('pls_sip_pck.ie_sip_w', pls_obter_se_controle_estab('SIP'), false);

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_sip_pck.carregar_parametros ( nr_seq_lote_p pls_lote_sip.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, dt_periodo_inicial_p INOUT pls_lote_sip.dt_periodo_inicial%type, dt_periodo_final_p INOUT pls_lote_sip.dt_periodo_final%type, ie_validar_zerados_p INOUT pls_lote_sip.ie_gerar_itens_zerados%type, ie_tipo_geracao_lote_p INOUT text) FROM PUBLIC;
