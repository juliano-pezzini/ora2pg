-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_sip_pck.valida_arvore_exposto ( nr_seq_lote_p pls_lote_sip.nr_sequencia%type) AS $body$
DECLARE

/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade:	Valida e ajusta a montagem da arvore de itens assistenciais, no que se diz respeito aos expostos

		Existem alguns casos em que a montagem nao pode ser apenas a somatoria, mas e necessario alguma regra
		em particular, esta rotina faz este processo.

		
-------------------------------------------------------------------------------------------------------------------

Locais de chamada direta: 
[X]  Objetos do dicionario [ ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatorios [ ] Outros:
-------------------------------------------------------------------------------------------------------------------

Pontos de atencao:	
		
		Como esta rotina altera a quantidade de indice de exposicao da arvore, ela deve ser chamada apenas 
		quando for gerado todos os valores do exposto, para sempre ser aplicada em cima de dados recem gerados
	
Alteracoes:
-------------------------------------------------------------------------------------------------------------------

++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */


-- carrega os itens ambulatoriais que o A for maior que algum dos filhos

c01 CURSOR(	nr_seq_lote_pc	pls_lote_sip.nr_sequencia%type) FOR
	SELECT	a.nr_sequencia,
		a.qt_beneficiario,
		(	SELECT	min(x.qt_beneficiario)
			from	sip_lote_item_assistencial	x
			where	x.nr_seq_lote			= a.nr_seq_lote
			and	x.nr_seq_superior		= a.nr_seq_item_sip
			and	x.ie_tipo_contratacao		= a.ie_tipo_contratacao
			and	x.ie_segmentacao_sip		= a.ie_segmentacao_sip
			and 	x.sg_uf				= a.sg_uf
			and	x.dt_ocorrencia			= a.dt_ocorrencia) qt_benef_filho
	from	sip_lote_item_assistencial	a
	where	a.nr_seq_lote			= nr_seq_lote_pc
	and	a.cd_classificacao_sip		= 'A';
BEGIN

-- Valida os atendimento ambulatoriais

for r_c01_w in c01(nr_seq_lote_p) loop

	-- usado IF por questoes de performance

	-- se a quantidade de exposicao do A for maior que algum dos filhos, tem que alterar

	if (r_c01_w.qt_beneficiario > r_c01_w.qt_benef_filho) then
	
		-- atualiza o indice

		update	sip_lote_item_assistencial
		set	qt_beneficiario = r_c01_w.qt_benef_filho
		where	nr_sequencia	= r_c01_w.nr_sequencia;
	end if;
	commit;
end loop;


END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_sip_pck.valida_arvore_exposto ( nr_seq_lote_p pls_lote_sip.nr_sequencia%type) FROM PUBLIC;
