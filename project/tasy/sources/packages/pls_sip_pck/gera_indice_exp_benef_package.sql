-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_sip_pck.gera_indice_exp_benef ( nr_seq_lote_sip_p pls_lote_sip.nr_sequencia%type, dt_periodo_inicial_p pls_lote_sip.dt_periodo_inicial%type, dt_periodo_final_p pls_lote_sip.dt_periodo_final%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE

/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade:	Rotina responsavel por gerar o indice de exposicao do beneficiario.

	O indice de exposicao retrata o quanto tempo o beneficiario ficou "exposto" a cobertura do plano,
	dentro do lote do SIP.
	
	Por motivos de regra de negocio relacionada a carencia, sera feito o seu levantamento em partes, 
	onde sera priorizado inicialmente as carencias por beneficiarios, apos sera verificado as carencias
	por contrato, caso nao exista por beneficiario, e ao final as carencias por produtos, caso nao tenha
	nenhuma das duas carencias anteriores.
	
	Ao final, sera ainda verificado a exposicao dos beneficiarios por contratacao e rescicao.
	Onde pode acontecer de um beneficiario rescindir o seu contrato dentro do periodo do sip,
	deixando de ficar exposto.
		
-------------------------------------------------------------------------------------------------------------------

Locais de chamada direta: 
[X]  Objetos do dicionario [ ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatorios [ ] Outros:
-------------------------------------------------------------------------------------------------------------------

Pontos de atencao:

		IMPORTANTE, a ordem de execucao da geracao dos indices deve ser:
		
		1) gera_indice_exp_car_benef - Gera os indices por beneficiarios
		2) gera_indice_exp_car_cont - Gera os indices por contrato, para os beneficiarios
			que nao possuem carencia direta
		3) gera_indice_exp_car_prod - Gera os indices por produto, para os beneficiarios e contratos
			que nao possuem carencia direta
			
		4) gera_indice_exp_res - Gera o indice por contratacao e rescisao.
		
		Qualquer alteracao na ordenacao da geracao dos indices por carencia pode gerar
		em erro de negocio.
Alteracoes:
-------------------------------------------------------------------------------------------------------------------

++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
	

BEGIN

-- Gera o indice conforme a carencia por beneficiario

CALL pls_sip_pck.gera_indice_exp_car_benef(	nr_seq_lote_sip_p,
				dt_periodo_inicial_p,
				dt_periodo_final_p,
				nm_usuario_p);
				
-- Gera o indice conforme a carencia por contrato

CALL pls_sip_pck.gera_indice_exp_car_cont(	nr_seq_lote_sip_p,
				dt_periodo_inicial_p,
				dt_periodo_final_p,
				nm_usuario_p);
				
-- Gera o indice conforme o produto

CALL pls_sip_pck.gera_indice_exp_car_prod(	nr_seq_lote_sip_p,
				dt_periodo_inicial_p,
				dt_periodo_final_p,
				nm_usuario_p);

-- Gera o indice por contratacao

CALL pls_sip_pck.gera_indice_exp_res(	nr_seq_lote_sip_p,
			dt_periodo_inicial_p,
			dt_periodo_final_p,
			nm_usuario_p);


END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_sip_pck.gera_indice_exp_benef ( nr_seq_lote_sip_p pls_lote_sip.nr_sequencia%type, dt_periodo_inicial_p pls_lote_sip.dt_periodo_inicial%type, dt_periodo_final_p pls_lote_sip.dt_periodo_final%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;
