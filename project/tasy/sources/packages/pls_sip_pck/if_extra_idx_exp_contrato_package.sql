-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_sip_pck.if_extra_idx_exp_contrato ( tb_indice_exp_origem_w t_exposicao_benef, tb_indice_exp_filtrado_w INOUT t_exposicao_benef) AS $body$
DECLARE

/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade:	Aplica as restricoes gerais nos indices levantadas a nivel de contrato

		Por questoes de performance, nem todos os filtros podem ser aplicados diretamente no where
		da query principal, entao estas inf sao filtradas atravez de IF logicos no proprio PL
		
		Esta rotina vai aplicar os filtros que forem considerados de "Contrato", contemplando apenas 
		as carencias baseadas em contrato
		
		Ao final do processo, sera devolvido um vetor com as informacoes filtradas e concatenadas 
-------------------------------------------------------------------------------------------------------------------

Locais de chamada direta: 
[X]  Objetos do dicionario [ ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatorios [ ] Outros:
-------------------------------------------------------------------------------------------------------------------

Pontos de atencao:
		
			Aqui devem ficar apenas as regras pertinentes a contratos, as demais regras, como restricao
			de CPT, devem ficar na rotina que realiza os "IF EXTRA GERAL".
	
Alteracoes:
-------------------------------------------------------------------------------------------------------------------

++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */


i		integer;
idx_w		integer;
ie_atualiza_w	varchar(1);

BEGIN

idx_w := 0;

-- navega pelos registros e plica os if

for	i in tb_indice_exp_origem_w.nr_seq_segurado.first..tb_indice_exp_origem_w.nr_seq_segurado.last loop

	-- como podem existir varios IF que podem ou nao 

	ie_atualiza_w := 'S';
	
	-- valida se a data de inicio de contrato COMPUTADA conforme parametro (pode ser no mes posterior) e compativel com a data de inicio do periodo

	if	((ie_atualiza_w = 'S') and (tb_indice_exp_origem_w.dt_ini_contratacao(i) >= tb_indice_exp_origem_w.dt_inicio_lote_sip(i))) then
	
		ie_atualiza_w := 'S';
	else
		-- importante manter a negativa do teste, para que os proximos testes possam ser executados somente

		-- se o anterior foi aprovado

		ie_atualiza_w := 'N';
	end if;
	

	
	-- se encaixou em algum filtro, replica

	if (ie_atualiza_w = 'S') then
	
		tb_indice_exp_filtrado_w := pls_sip_pck.replica_indice_exp(tb_indice_exp_origem_w, i, tb_indice_exp_filtrado_w, idx_w);
	
		idx_w := idx_w + 1;
	end if;
	
end loop;


end;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_sip_pck.if_extra_idx_exp_contrato ( tb_indice_exp_origem_w t_exposicao_benef, tb_indice_exp_filtrado_w INOUT t_exposicao_benef) FROM PUBLIC;
