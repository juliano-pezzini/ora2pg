-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_sip_pck.sip_nv_totaliza_dados_regra ( nr_seq_item_assist sip_item_assistencial.nr_sequencia%type, ie_tipo_geracao_p text, nr_seq_lote_p pls_lote_sip.nr_sequencia%type, nm_usuario_p text) AS $body$
DECLARE


sql_regra_w 			varchar(4000);
filtro_regra_sql_w 		varchar(2000);

nr_sequencia_w			dbms_sql.number_table;
qt_registro_filho_w		dbms_sql.number_table;

BEGIN

	if (nr_seq_item_assist IS NOT NULL AND nr_seq_item_assist::text <> '') then
	
		filtro_regra_sql_w := ' and a.nr_seq_superior = :nr_seq_superior ';
	else
		filtro_regra_sql_w := ' and a.nr_seq_superior is null ';
	end if;
	
	sql_regra_w :=	' select a.nr_sequencia, ' ||
			'	(select	count(1) ' ||
			'	from 	sip_item_assistencial x' ||
			'	where	x.nr_seq_superior = a.nr_sequencia) qt_filhos' ||
			' from sip_item_assistencial a ' ||
			' where 1 = 1 ' || 
			filtro_regra_sql_w || 
			' order by a.nr_seq_apres';
	
	if (nr_seq_item_assist IS NOT NULL AND nr_seq_item_assist::text <> '') then
	
		EXECUTE sql_regra_w
		bulk collect into STRICT nr_sequencia_w, qt_registro_filho_w
		using nr_seq_item_assist;
	else
		EXECUTE sql_regra_w
		bulk collect into STRICT nr_sequencia_w, qt_registro_filho_w;
	end if;

	if (nr_sequencia_w.count > 0) then
	
		for i in nr_sequencia_w.first .. nr_sequencia_w.last loop
		
			-- conta e grava efetivamente os valores

			CALL pls_sip_pck.sip_nv_totaliza_regra(nr_sequencia_w(i), ie_tipo_geracao_p, nr_seq_lote_p, nm_usuario_p);
		
			-- se tem filhos, vali atras dos filhos

			if (qt_registro_filho_w(i) > 0) then
			
				CALL pls_sip_pck.sip_nv_totaliza_dados_regra(nr_sequencia_w(i), ie_tipo_geracao_p, nr_seq_lote_p, nm_usuario_p);
			end if;
		end loop;
	end if;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_sip_pck.sip_nv_totaliza_dados_regra ( nr_seq_item_assist sip_item_assistencial.nr_sequencia%type, ie_tipo_geracao_p text, nr_seq_lote_p pls_lote_sip.nr_sequencia%type, nm_usuario_p text) FROM PUBLIC;
