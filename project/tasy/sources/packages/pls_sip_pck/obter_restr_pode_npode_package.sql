-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pls_sip_pck.obter_restr_pode_npode ( dados_regra_p pls_sip_pck.c_regra_item, ie_busca_guia_ref_p boolean, bind_sql_p INOUT sql_pck.t_dado_bind, ds_alias_p text default 'a') AS $body$
DECLARE

					
ds_filtro_retorno_w	varchar(1000);
nr_seq_item_ini_w	sip_item_assistencial.nr_sequencia%type;
nr_seq_item_fim_w	sip_item_assistencial.nr_sequencia%type;


BEGIN

ds_filtro_retorno_w := null;

-- Verificar se e para buscar a guia de referencia. Se for para buscar monta as restricoes de acordo com a regra de negocio envolvida.

if (ie_busca_guia_ref_p) then
	
	-- se for nascido vivo

	if (dados_regra_p.sequ_item = 108) then
		-- o mesmo so pode selecionar valores que fizeram parte do tipo de internacao obstetrica

		-- e tudo o que se encontra entre o 76 e 77

		-- obstetrica nao pode entrar, somente o que foi classificado nos seus filhos

		-- o motivo e que se vincular algo de obstetrica e nao tiver o tipo de parto da erro dizendo que nao tem

		-- o parto informado

		ds_filtro_retorno_w :=	ds_filtro_retorno_w || pls_util_pck.enter_w ||
					' and exists (	select	1 ' || pls_util_pck.enter_w ||
					'	from	sip_nv_regra_vinc_it v ' || pls_util_pck.enter_w ||
					'	where	v.nr_seq_sip_nv_dados = ' || ds_alias_p || '.nr_sequencia ' || pls_util_pck.enter_w ||
					'	and	v.nr_seq_item_assist in (76, 77) ' || pls_util_pck.enter_w ||
					') ';
	
	else
		-- o mesmo so pode selecionar valores que fizeram parte de tipo de internacao

		-- verifica se esta no tipo de internacao

		-- e tudo o que se encontra entre o 65 e 82

		ds_filtro_retorno_w :=	ds_filtro_retorno_w || pls_util_pck.enter_w ||
					' and exists (	select	1 ' || pls_util_pck.enter_w ||
					'	from	sip_nv_regra_vinc_it v ' || pls_util_pck.enter_w ||
					'	where	v.nr_seq_sip_nv_dados = ' || ds_alias_p || '.nr_sequencia ' || pls_util_pck.enter_w ||
					'	and	v.nr_seq_item_assist between 65 and 82 ' || pls_util_pck.enter_w ||
					') ';
	end if;
	
	-- obtem os intervalos dos vinculos para internacao			

	SELECT * FROM pls_sip_pck.obter_intervalo_inter(	dados_regra_p, nr_seq_item_ini_w, nr_seq_item_fim_w) INTO STRICT nr_seq_item_ini_w, nr_seq_item_fim_w;
	
	-- Tanto item "a" quanto item "b" nao podem estar vinculados diretamente a uma regra no mesmo item assistencial para serem considerados, podendo estar vinculado a outro assistencial 

	-- que seja filho do EX.

	-- Item a.

	ds_filtro_retorno_w :=	ds_filtro_retorno_w || pls_util_pck.enter_w ||
				' and	not exists (select 1 ' || pls_util_pck.enter_w ||
				'	 from	sip_nv_regra_vinc_it u ' || pls_util_pck.enter_w ||
				'	 where	u.nr_seq_item_assist between :nr_seq_item_assist_ini and :nr_seq_item_assist_fim ' || pls_util_pck.enter_w ||
				'	 and	u.nr_seq_sip_nv_dados = ' || ds_alias_p || '.nr_sequencia) ';
						
	bind_sql_p := sql_pck.bind_variable(':nr_seq_item_assist_ini', nr_seq_item_ini_w, bind_sql_p);
	bind_sql_p := sql_pck.bind_variable(':nr_seq_item_assist_fim', nr_seq_item_fim_w, bind_sql_p);
else
	-- um mesmo item nao pode se repetir

	ds_filtro_retorno_w :=	ds_filtro_retorno_w || pls_util_pck.enter_w ||
				' and	not exists (select	1 ' || pls_util_pck.enter_w ||
				'	 from	sip_nv_regra_vinc_it u ' || pls_util_pck.enter_w ||
				'	 where	u.nr_seq_sip_nv_dados = ' || ds_alias_p || '.nr_sequencia) ';
end if;

return;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pls_sip_pck.obter_restr_pode_npode ( dados_regra_p pls_sip_pck.c_regra_item, ie_busca_guia_ref_p boolean, bind_sql_p INOUT sql_pck.t_dado_bind, ds_alias_p text default 'a') FROM PUBLIC;
