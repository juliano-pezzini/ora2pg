-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_sip_pck.ajusta_cd_guia_ok_intercambio ( nr_seq_lote_p pls_lote_sip.nr_sequencia%type) AS $body$
DECLARE

/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade:	Ajusta a guia de internacao para as contas de intercambio.

		Em algum casos a conta de intercambio pode vir com a guia de resumo de internacao errada.
		Para estes casos e verificado os itens de origem 'CI'. Os que possuirem para o mesmo beneficiario e nr_seq_guia (autorizacao)
		mais de um cd_guia_ok, sera buscado o cd_guia_ok dentro da nr_seq_guia que seja de uma guia de resumo de internacao, 
		e sera atribuido como guia de referencia na sip_nv_dados.cd_guia_referencia
		
	
-------------------------------------------------------------------------------------------------------------------

Locais de chamada direta: 
[X]  Objetos do dicionario [ ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatorios [ ] Outros:
-------------------------------------------------------------------------------------------------------------------

Pontos de atencao:

Alteracoes:
-------------------------------------------------------------------------------------------------------------------

++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */


tb_cd_guia_ok_w		dbms_sql.varchar2_table;
tb_nr_seq_guia_w	dbms_sql.number_table;
tb_nr_seq_segurado_w	dbms_sql.number_table;

i			integer;
j			integer;

-- itens de intercambio

c01 CURSOR(	nr_seq_lote_pc	 pls_lote_sip.nr_sequencia%type) FOR
	SELECT	count( distinct a.cd_guia_referencia) qt_guia_ref,
		count(distinct coalesce(b.nr_seq_guia,-1)) qt_guia_aut,
		b.nr_seq_segurado,
		max(b.nr_seq_guia) nr_seq_guia,
		(	SELECT	max(x.cd_guia_ok)
			from	pls_conta	x
			where	x.nr_seq_guia	= b.nr_seq_guia
			and	x.ie_tipo_guia	= 5) cd_guia_ok_internacao
	from	sip_nv_dados		a,
		pls_conta		b
	where 	b.nr_sequencia		= a.nr_seq_conta
	and	a.ie_origem_info	= 'CI'
	and	a.nr_seq_lote_sip	= nr_seq_lote_pc
	group by b.nr_seq_segurado, b.nr_seq_guia;
BEGIN

j := 0;
-- abre os itens de intercambio

for r_c01_w in c01(nr_seq_lote_p) loop


	-- se tiver quantidade de cd_guia_ok diferente, para o mesmo benef e nr_seq_guia, e ainda possuir cd_guia_ok_internacao, entao marca para atualizar

	if (r_c01_w.qt_guia_ref > 1) and (r_c01_w.qt_guia_aut = 1) and (r_C01_w.cd_guia_ok_internacao IS NOT NULL AND r_C01_w.cd_guia_ok_internacao::text <> '') then
		
		tb_cd_guia_ok_w(j)	:= r_C01_w.cd_guia_ok_internacao;
		tb_nr_seq_guia_w(j)	:= r_C01_w.nr_seq_guia;
		tb_nr_seq_segurado_w(j)	:= r_C01_w.nr_seq_segurado;
		
		j := j+1;
	end if;
	
	if (j >= current_setting('pls_sip_pck.qt_registro_transacao_w')::integer) then
	
		forall i in tb_cd_guia_ok_w.first..tb_cd_guia_ok_w.last
			update	sip_nv_dados	x
			set	x.cd_guia_referencia	= tb_cd_guia_ok_w(i)
			where	x.nr_seq_lote_sip	= nr_seq_lote_p
			and	x.ie_origem_info	= 'CI'
			and	x.nr_seq_conta		in (	SELECT	a.nr_sequencia
								from	pls_conta	a
								where	a.nr_seq_segurado	= tb_nr_seq_segurado_w(i)
								and	a.nr_seq_guia		= tb_nr_seq_guia_w(i));
		tb_cd_guia_ok_w.delete;
		tb_nr_seq_guia_w.delete;
		tb_nr_seq_segurado_w.delete;
		
	end if;

end loop;

-- se ainda tem alguma coisa, manda pro banco

if (tb_cd_guia_ok_w.count > 0) then
	
	forall i in tb_cd_guia_ok_w.first..tb_cd_guia_ok_w.last
		update	sip_nv_dados	x
		set	x.cd_guia_referencia	= tb_cd_guia_ok_w(i)
		where	x.nr_seq_lote_sip	= nr_seq_lote_p
		and	x.ie_origem_info	= 'CI'
		and	x.nr_seq_conta		in (	SELECT	a.nr_sequencia
							from	pls_conta	a
							where	a.nr_seq_segurado	= tb_nr_seq_segurado_w(i)
							and	a.nr_seq_guia		= tb_nr_seq_guia_w(i));
	tb_cd_guia_ok_w.delete;
	tb_nr_seq_guia_w.delete;
	tb_nr_seq_segurado_w.delete;
	
end if;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_sip_pck.ajusta_cd_guia_ok_intercambio ( nr_seq_lote_p pls_lote_sip.nr_sequencia%type) FROM PUBLIC;
