-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE ger_pres_mat_s_dt_lib_md_pck.obter_disp_dose_ds_horario_md (nr_param_controll_p bigint, ds_dose_diferenciada_p text, ie_dose_diferenciada_p bigint, ie_dose_diferenciada_existe_p text, qt_dose_diferenciada_p bigint, ie_gerar_disp_p text, ie_regra_disp_p text, cd_unid_med_dose_p text, cd_unidade_medida_p text, cd_unid_med_cons_p text, qt_conversao_und_ori_p bigint, qt_conversao_und_dest_p bigint, qt_total_dispensar_p bigint, nr_ocorrencia_p bigint, ie_gerar_dispensacao_p INOUT text, qt_dispensar_hor_p INOUT bigint, qt_dose_p INOUT bigint, ds_horarios_padr_p INOUT text, qt_dispensar_hor_dif_p INOUT bigint ) AS $body$
DECLARE


      EXEC_W varchar(200);

BEGIN
    if nr_param_controll_p = 0 then
        ie_gerar_dispensacao_p := 'S';
        if (ds_dose_diferenciada_p IS NOT NULL AND ds_dose_diferenciada_p::text <> '') and (ie_dose_diferenciada_p IS NOT NULL AND ie_dose_diferenciada_p::text <> '') and (ie_dose_diferenciada_p > 0) and (ie_dose_diferenciada_existe_p = 'S') and (qt_dose_diferenciada_p IS NOT NULL AND qt_dose_diferenciada_p::text <> '') then

          qt_dose_p	:= qt_dose_diferenciada_p;

          if ie_gerar_disp_p = 'S' then
            ie_gerar_dispensacao_p := 'N';
          end if;
        end if;
    end if;

    if (ds_dose_diferenciada_p IS NOT NULL AND ds_dose_diferenciada_p::text <> '') and (ie_dose_diferenciada_p IS NOT NULL AND ie_dose_diferenciada_p::text <> '') and (ie_dose_diferenciada_p > 0) and (ie_dose_diferenciada_existe_p = 'S') and (qt_dose_diferenciada_p = 0) then
      qt_dispensar_hor_p := 0;
      qt_dose_p := 0;
      qt_dispensar_hor_dif_p := 0;
      ds_horarios_padr_p := ds_horarios_padr_p;

    elsif (ds_dose_diferenciada_p IS NOT NULL AND ds_dose_diferenciada_p::text <> '') and (ie_dose_diferenciada_p IS NOT NULL AND ie_dose_diferenciada_p::text <> '') and (ie_dose_diferenciada_p > 0) and (ie_dose_diferenciada_existe_p = 'S') and (qt_dose_diferenciada_p >= 0) then
      qt_dose_p := qt_dose_diferenciada_p;

      if (ie_regra_disp_p = 'S') then
        begin
          EXEC_W := 'CALL OBTER_DOSE_CONVERTIDA_MD(:1,:2,:3,:4,:5,:6) INTO :RESULT';

          EXECUTE EXEC_W USING IN qt_dose_p,
                                         IN cd_unid_med_dose_p,
                                         IN cd_unidade_medida_p,
                                         IN cd_unid_med_cons_p,
                                         IN qt_conversao_und_ori_p,
                                         IN qt_conversao_und_dest_p,
                                         OUT qt_dispensar_hor_p;
        exception
          when others then
            qt_dispensar_hor_p := null;
        end;

        qt_dispensar_hor_p := ceil(qt_dispensar_hor_p);
      else
        begin
          EXEC_W := 'CALL OBTER_DOSE_CONVERTIDA_MD(:1,:2,:3,:4,:5,:6) INTO :RESULT';

          EXECUTE EXEC_W USING IN qt_dose_p,
                                         IN cd_unid_med_dose_p,
                                         IN cd_unidade_medida_p,
                                         IN cd_unid_med_cons_p,
                                         IN qt_conversao_und_ori_p,
                                         IN qt_conversao_und_dest_p,
                                         OUT qt_dispensar_hor_p;
        exception
          when others then
            qt_dispensar_hor_p := null;
        end;
      end if;

      if nr_param_controll_p = 0 then
        qt_dispensar_hor_dif_p := qt_dispensar_hor_p;
      end if;

    elsif (ie_regra_disp_p = 'S') then
      qt_dispensar_hor_p := ceil(dividir_md(qt_total_dispensar_p,nr_ocorrencia_p));
    else
      qt_dispensar_hor_p := dividir_md(qt_total_dispensar_p,nr_ocorrencia_p);
    end if;
  end;


$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ger_pres_mat_s_dt_lib_md_pck.obter_disp_dose_ds_horario_md (nr_param_controll_p bigint, ds_dose_diferenciada_p text, ie_dose_diferenciada_p bigint, ie_dose_diferenciada_existe_p text, qt_dose_diferenciada_p bigint, ie_gerar_disp_p text, ie_regra_disp_p text, cd_unid_med_dose_p text, cd_unidade_medida_p text, cd_unid_med_cons_p text, qt_conversao_und_ori_p bigint, qt_conversao_und_dest_p bigint, qt_total_dispensar_p bigint, nr_ocorrencia_p bigint, ie_gerar_dispensacao_p INOUT text, qt_dispensar_hor_p INOUT bigint, qt_dose_p INOUT bigint, ds_horarios_padr_p INOUT text, qt_dispensar_hor_dif_p INOUT bigint ) FROM PUBLIC;
