-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


-- retorna os dados da regra que ira decidir se a conta precisa ser aberta
CREATE OR REPLACE FUNCTION pls_cta_gera_hono_cirurgia_pck.obter_regra_abertura_conta ( ie_tipo_guia_p pls_conta.ie_tipo_guia%type, ie_origem_conta_p pls_conta.ie_origem_conta%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, cd_procedimento_p pls_conta_proc.cd_procedimento%type, ie_origem_proced_p pls_conta_proc.ie_origem_proced%type, nr_seq_prestador_p pls_proc_participante.nr_seq_prestador%type) RETURNS DADOS_REGRA_ABERTURA_CONTA AS $body$
DECLARE


dados_regra_w 	dados_regra_abertura_conta;
ie_valido_w	varchar(1) := 'S';

-- cursor feito para retornar o ultimo registro (pega a regra mais restritiva, pois o order by tem desc)
C01 CURSOR(		ie_tipo_guia_pc		pls_conta.ie_tipo_guia%type,
			ie_origem_conta_pc		pls_conta.ie_origem_conta%type, 
			cd_estabelecimento_pc	estabelecimento.cd_estabelecimento%type,
			nr_seq_prestador_pc		pls_proc_participante.nr_seq_prestador%type) is
	with query_tmp as (
			SELECT	a.nr_sequencia,
				coalesce(a.ie_prestador_partic, 'N') ie_prestador_partic,
				coalesce(a.ie_guia_informada,'N') ie_guia_informada,
				coalesce(a.ie_tipo_guia,' ') ie_tipo_guia_order,
				coalesce(a.ie_origem_protocolo,' ') ie_origem_protocolo_order,
				a.nr_seq_grupo_servico,
				coalesce(a.ie_gerar_participante,'N') ie_gerar_participante,
				(	SELECT 	count(1)
					from	pls_exc_regra_conta_auto b
					where 	b.nr_seq_regra = a.nr_sequencia
					and 	b.nr_seq_prestador = nr_seq_prestador_pc) qt_excecao
			from	pls_regra_conta_autom	a
			where	a.cd_estabelecimento 	= cd_estabelecimento_pc
			and 	a.ie_exec_cirurgica	= 'S' --apenas as regras marcadas como execucao cirurgica devem ser consideradas
			-- tipo de guia eh obrigatorio
			and	a.ie_tipo_guia		= ie_tipo_guia_pc
			-- origem da conta eh opcional
			and	((a.ie_origem_protocolo   = ie_origem_conta_pc) or (coalesce(a.ie_origem_protocolo::text, '') = ''))
			and	a.ie_situacao		= 'A'
			and	a.ie_gerar_conta	= 'S'
			order by
				ie_tipo_guia_order desc,
				ie_origem_protocolo_order desc,
				ie_prestador_partic desc,
				ie_guia_informada desc,
				nr_seq_grupo_servico
			)
	select	nr_sequencia,
		ie_prestador_partic,
		ie_guia_informada,
		nr_seq_grupo_servico,
		ie_gerar_participante,
		qt_excecao
	from	query_tmp LIMIT 1;
	
BEGIN

	for r_C01_w in C01( ie_tipo_guia_p, ie_origem_conta_p, cd_estabelecimento_p, nr_seq_prestador_p) loop
			
		if (r_C01_w.qt_excecao = 0) then
			ie_valido_w := 'S';				
			if (r_C01_w.nr_seq_grupo_servico IS NOT NULL AND r_C01_w.nr_seq_grupo_servico::text <> '') then
				ie_valido_w := pls_se_grupo_preco_servico(r_C01_w.nr_seq_grupo_servico, cd_procedimento_p, ie_origem_proced_p);
			end if;
			
			if (ie_valido_w = 'S') then
			
				--Para abertura de procedimentos, eh preciso verificar ainda se tem alguma regra de excecao			
				dados_regra_w.nr_sequencia := r_C01_w.nr_sequencia;
				dados_regra_w.ie_prestador_partic := r_C01_w.ie_prestador_partic;
				dados_regra_w.ie_guia_informada := r_C01_w.ie_guia_informada;
				dados_regra_w.ie_gerar_participante := r_C01_w.ie_gerar_participante;
			end if;
		end if;
			
	end loop;
	
return dados_regra_w;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pls_cta_gera_hono_cirurgia_pck.obter_regra_abertura_conta ( ie_tipo_guia_p pls_conta.ie_tipo_guia%type, ie_origem_conta_p pls_conta.ie_origem_conta%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, cd_procedimento_p pls_conta_proc.cd_procedimento%type, ie_origem_proced_p pls_conta_proc.ie_origem_proced%type, nr_seq_prestador_p pls_proc_participante.nr_seq_prestador%type) FROM PUBLIC;
