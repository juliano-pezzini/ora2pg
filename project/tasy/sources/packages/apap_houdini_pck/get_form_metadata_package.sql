-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


   /*
    * GET ALL ATTRIBUTE's FORM 
    */
	


CREATE OR REPLACE FUNCTION apap_houdini_pck.get_form_metadata (SECTION_ID_P w_apap_pac_grupo.nr_sequencia%TYPE ) RETURNS SETOF T_FORM_METADATA_TABLE AS $body$
DECLARE


        row_metadata_w               t_form_metadata_row;
        w_cursor_form_w CURSOR FOR
			SELECT	'DT_HOUDINI_REGISTER' nm_atributo,
					'DT_HOUDINI_REGISTER' nm_atributo_tabela,
					'DT_HOUDINI_REGISTER' nm_atributo_linked,
					null nm_tabela,
					'dtp' ie_componente,
					null ie_tipo_atributo,
					'date(short)' ds_mascara,
					null qt_decimais,
					null qt_tamanho,
					'N' ie_readonly,
					'sysdate' vl_padrao,
					obter_desc_expressao(coalesce(null,'287188')) ds_informacao,
					NULL cd_dominio,
					NULL ds_valores,
					null nr_seq_linked_data,
					-1 nr_seq_apresentacao,
					null nr_ordem_composto,
					1 nr_seq_superior,
					null nr_seq_linha,
					null nr_seq_grupo,
					null nr_seq_modelo,
					'S'  ie_mandatory,
					NULL ds_unid_med,
					'DT_HOUDINI_REGISTER' nm_atributo_unico
			
			
union

			SELECT	nm_atributo,
					nm_atributo_tabela,
					nm_atributo_linked,
					nm_tabela,
					ie_componente,
					ie_tipo_atributo,
					ds_mascara,
					qt_decimais,
					qt_tamanho,
					ie_readonly,
					vl_padrao,
					ds_informacao,
					cd_dominio,
					ds_valores,
					nr_seq_linked_data,
					nr_seq_apresentacao,
					nr_ordem_composto,
					coalesce(nr_seq_superior,nr_seq_linha) nr_seq_superior,
					nr_seq_linha,
					nr_seq_grupo,
					nr_seq_modelo,
					ie_mandatory,
					ds_unid_med,
					nm_atributo_unico
			from (		
					select (select	coalesce(max('S'),'N') from w_apap_pac_informacao b where b.nr_seq_superior = a.nr_seq_linha) ie_linha_superior,
							a.nm_atributo,
							a.nm_atributo_tabela,
							a.nm_atributo_linked,
							a.nm_tabela,
							a.ie_componente,
							a.ie_tipo_atributo,
							a.ds_mascara,
							a.qt_decimais,
							a.qt_tamanho,
							a.ie_readonly,
							a.vl_padrao,
							a.ds_informacao,
							a.cd_dominio,
							a.ds_valores,
							a.nr_seq_linked_data,
							nr_seq_apresentacao,
							a.nr_ordem_composto,
							nr_seq_superior,
							a.nr_seq_linha,
							a.nr_seq_grupo,
							a.nr_seq_modelo,
							'N'  ie_mandatory,
							a.ds_unid_med,
							a.nm_atributo_unico
					from	TABLE(apap_dinamico_pck.get_linhas_secao_pac(SECTION_ID_P)) a) alias8
			where	ie_linha_superior = 'N'		
			ORDER BY nr_seq_apresentacao, nr_ordem_composto, ds_informacao;

BEGIN 

        FOR w_cursor_row in w_cursor_form_w LOOP

            row_metadata_w.nm_atributo              := w_cursor_row.nm_atributo;
            row_metadata_w.nm_atributo_tabela       := w_cursor_row.nm_atributo_tabela;
            row_metadata_w.nm_atributo_linked       := w_cursor_row.nm_atributo_linked;
			row_metadata_w.nm_atributo_unico        := w_cursor_row.nm_atributo_unico;
            row_metadata_w.nm_tabela                := w_cursor_row.nm_tabela;
            row_metadata_w.ie_componente            := w_cursor_row.ie_componente;
            row_metadata_w.ie_tipo_atributo         := w_cursor_row.ie_tipo_atributo;
            row_metadata_w.ds_mascara               := w_cursor_row.ds_mascara;
            row_metadata_w.qt_decimais              := w_cursor_row.qt_decimais;
            row_metadata_w.qt_tamanho               := w_cursor_row.qt_tamanho;
            row_metadata_w.ie_readonly              := w_cursor_row.ie_readonly;
            row_metadata_w.vl_padrao                := w_cursor_row.vl_padrao;
            row_metadata_w.ds_informacao            := w_cursor_row.ds_informacao;
            row_metadata_w.cd_dominio               := w_cursor_row.cd_dominio;
            row_metadata_w.ds_valores               := w_cursor_row.ds_valores;
            row_metadata_w.nr_seq_linked_data       := w_cursor_row.nr_seq_linked_data;
            row_metadata_w.nr_seq_apresentacao      := w_cursor_row.nr_seq_apresentacao;
            row_metadata_w.nr_ordem_composto 	   	:= w_cursor_row.nr_ordem_composto;
            row_metadata_w.nr_seq_superior          := w_cursor_row.nr_seq_superior;
            row_metadata_w.nr_seq_linha             := w_cursor_row.nr_seq_linha;
            row_metadata_w.nr_seq_grupo			    := w_cursor_row.nr_seq_grupo;
            row_metadata_w.nr_seq_modelo			:= w_cursor_row.nr_seq_modelo;
            row_metadata_w.ie_mandatory			    := w_cursor_row.ie_mandatory;

            IF (w_cursor_row.ds_unid_med IS NOT NULL AND w_cursor_row.ds_unid_med::text <> '') THEN
                row_metadata_w.ds_informacao := row_metadata_w.ds_informacao || ' (' || w_cursor_row.ds_unid_med || ')';
            END IF;

            RETURN NEXT row_metadata_w;
        END LOOP;
        RETURN;
    END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION apap_houdini_pck.get_form_metadata (SECTION_ID_P w_apap_pac_grupo.nr_sequencia%TYPE ) FROM PUBLIC;
