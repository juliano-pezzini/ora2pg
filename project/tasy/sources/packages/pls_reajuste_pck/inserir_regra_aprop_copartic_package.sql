-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_reajuste_pck.inserir_regra_aprop_copartic () AS $body$
DECLARE


vl_apropriacao_reajustado_w	pls_regra_copartic_aprop.vl_apropriacao%type;

current_setting('pls_reajuste_pck.c01')::CURSOR( CURSOR(	nr_seq_regra_copartic_pc	pls_regra_copartic.nr_sequencia%type) FOR
	SELECT	nr_sequencia nr_seq_regra_copartic_aprop,
		vl_apropriacao
	from	pls_regra_copartic_aprop
	where	nr_seq_regra	= nr_seq_regra_copartic_pc
	and	vl_apropriacao	> 0;

BEGIN
if (tb_nr_seq_regra_copartic_w.count > 0) then
	for i in tb_nr_seq_regra_copartic_w.first..tb_nr_seq_regra_copartic_w.last loop
		begin
		select	nextval('pls_regra_copartic_seq')
		into STRICT	nr_seq_regra_copartic_w
		;
		
		insert	into	pls_regra_copartic(	nr_sequencia, nr_seq_tipo_coparticipacao, dt_atualizacao,
				nm_usuario, dt_atualizacao_nrec, nm_usuario_nrec,
				nr_seq_contrato, dt_inicio_vigencia, ie_tipo_atendimento,
				vl_maximo_copartic, ie_beneficiario, ie_prestador,
				ie_conta_medica, ie_utilizacao, ie_guia,
				ie_internacao, nr_seq_lote_reaj_copartic, dt_liberacao,
				nm_usuario_liberacao, ie_forma_cobr_internacao, nr_ordem_prioridade,
				dt_fim_vigencia, nr_seq_intercambio)
			(SELECT	nr_seq_regra_copartic_w, nr_seq_tipo_coparticipacao, clock_timestamp(),
				nm_usuario_p, clock_timestamp(), nm_usuario_p,
				tb_nr_seq_contrato_copartic_w(i), dt_reajuste_p, ie_tipo_atendimento,
				tb_vl_copart_max_copartic_w(i), ie_beneficiario, ie_prestador,
				ie_conta_medica, ie_utilizacao, ie_guia,
				ie_internacao, tb_nr_seq_lt_reaj_copartic_w(i), clock_timestamp(),
				nm_usuario_p, coalesce(ie_forma_cobr_internacao,'I'), nr_ordem_prioridade,
				dt_fim_vigencia, tb_nr_seq_interc_copartic_w(i)
			from	pls_regra_copartic
			where	nr_sequencia	= tb_nr_seq_regra_copartic_w(i));
		
		if (tb_ie_origem_copartic_w(i) = 'C') then
			update	pls_regra_copartic
			set	dt_fim_vigencia		= fim_dia(dt_reajuste_p - 1),
				nr_seq_regra_reajustada	= nr_seq_regra_copartic_w
			where	nr_sequencia		= tb_nr_seq_regra_copartic_w(i);
		end if;
		
		update	pls_reajuste_copartic
		set	nr_seq_copartic_reajustada	= nr_seq_regra_copartic_w
		where	nr_sequencia			= tb_nr_seq_reaj_copartic_w(i);
		
		CALL pls_copiar_itens_regra_copart(tb_nr_seq_regra_copartic_w(i), nr_seq_regra_copartic_w, nm_usuario_p, 'N');
		
		for r_c01_w in current_setting('pls_reajuste_pck.c01')::CURSOR( (nr_seq_regra_copartic_w) loop
			begin
			
			vl_apropriacao_reajustado_w	:= r_c01_w.vl_apropriacao + dividir_sem_round((r_c01_w.vl_apropriacao * tb_tx_reaj_regra_copartic_w(i))::numeric,100);
			
			update	pls_regra_copartic_aprop
			set	vl_apropriacao	= vl_apropriacao_reajustado_w
			where	nr_sequencia	= r_c01_w.nr_seq_regra_copartic_aprop;
			end;
		end loop;
		end;
	end loop;
end if;

CALL CALL pls_reajuste_pck.limpar_vetor_regra_copartic();

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_reajuste_pck.inserir_regra_aprop_copartic () FROM PUBLIC;
