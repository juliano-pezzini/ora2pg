-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_reajuste_pck.aplicar_reajuste_benef (nr_seq_reajuste_p pls_reajuste.nr_sequencia%type, dt_reajuste_p pls_reajuste.dt_reajuste%type, ie_reajustar_benef_cancelado_p pls_parametros.ie_reajustar_benef_cancelado%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) AS $body$
DECLARE


current_setting('pls_reajuste_pck.c01')::CURSOR( CURSOR(	nr_seq_reajuste_pc		pls_reajuste.nr_sequencia%type) FOR
	SELECT	a.nr_sequencia nr_seq_segurado,
		a.dt_rescisao,
		a.nr_seq_titular,
		(	SELECT	coalesce(max(x.ie_geracao_valores),'B')
			from	pls_contrato x
			where	x.nr_sequencia = a.nr_seq_contrato) ie_geracao_valores,
		a.nr_seq_contrato,
		a.nr_seq_intercambio
	from	pls_segurado a,
		pls_tabela_preco b,
		pls_reajuste_tabela c
	where	b.nr_sequencia	= a.nr_seq_tabela
	and	b.nr_sequencia	= c.nr_seq_tabela
	and	c.nr_seq_reajuste = nr_seq_reajuste_pc
	and	(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
	and	coalesce(a.dt_cancelamento::text, '') = '';

BEGIN

for r_c01_w in current_setting('pls_reajuste_pck.c01')::CURSOR( (nr_seq_reajuste_p) loop
	begin
	if	(((coalesce(r_c01_w.dt_rescisao::text, '') = '') or (r_c01_w.dt_rescisao > dt_reajuste_p)) or
		((r_c01_w.dt_rescisao IS NOT NULL AND r_c01_w.dt_rescisao::text <> '') and (ie_reajustar_benef_cancelado_p in ('T', 'I')))) then
		
		if	((r_c01_w.ie_geracao_valores = 'T' and coalesce(r_c01_w.nr_seq_titular::text, '') = '') or (r_c01_w.ie_geracao_valores = 'D' and (r_c01_w.nr_seq_titular IS NOT NULL AND r_c01_w.nr_seq_titular::text <> '')) or (r_c01_w.ie_geracao_valores = 'B')) then
			if (r_c01_w.nr_seq_contrato IS NOT NULL AND r_c01_w.nr_seq_contrato::text <> '') then
				CALL pls_preco_beneficiario_pck.atualizar_reajuste_benef(	r_c01_w.nr_seq_segurado, dt_reajuste_p, nr_seq_reajuste_p,
											null, 'S', nm_usuario_p, cd_estabelecimento_p);
			elsif (r_c01_w.nr_seq_intercambio IS NOT NULL AND r_c01_w.nr_seq_intercambio::text <> '') then
				atualizar_preco_benef_interc(	r_c01_w.nr_seq_segurado, r_c01_w.nr_seq_intercambio, nr_seq_reajuste_p,
								dt_reajuste_p, nm_usuario_p, cd_estabelecimento_p);
			end if;
		end if;
	end if;
	end;
end loop; --C01

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_reajuste_pck.aplicar_reajuste_benef (nr_seq_reajuste_p pls_reajuste.nr_sequencia%type, dt_reajuste_p pls_reajuste.dt_reajuste%type, ie_reajustar_benef_cancelado_p pls_parametros.ie_reajustar_benef_cancelado%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) FROM PUBLIC;
