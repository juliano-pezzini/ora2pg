-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE ish_pat_case_pck.reproc_get_transfer ( nr_seq_fila_p bigint, nr_seq_interno_p atend_paciente_unidade.nr_seq_interno%type, nr_atendimento_p atend_paciente_unidade.nr_atendimento%type, cd_setor_atendimento_p atend_paciente_unidade.cd_setor_atendimento%type, cd_unidade_basica_p atend_paciente_unidade.cd_unidade_basica%type, cd_unidade_compl_p atend_paciente_unidade.cd_unidade_compl%type, qt_exec_p bigint) AS $body$
DECLARE

		
jobno				bigint;
ie_disponivel_w			varchar(1);
unidade_atendimento_w		unidade_atendimento%rowtype;
atend_paciente_unidade_w		atend_paciente_unidade%rowtype;
nr_seq_interno_w			atend_paciente_unidade.nr_seq_interno%type;
intpd_eventos_regra_auto_w		intpd_eventos_regra_auto%rowtype;


BEGIN
begin
select	*
into STRICT	atend_paciente_unidade_w
from	atend_paciente_unidade
where	nr_seq_interno		= nr_seq_interno_p
and	nr_atendimento 		= nr_atendimento_p;
exception
when others then
	atend_paciente_unidade_w.nr_seq_interno	:=	null;
end;

begin
select	*
into STRICT	unidade_atendimento_w
from	unidade_atendimento
where	cd_setor_atendimento	= cd_setor_atendimento_p
and	cd_unidade_basica		= cd_unidade_basica_p
and	cd_unidade_compl		= cd_unidade_compl_p;
exception
when others then
	unidade_atendimento_w.cd_setor_atendimento	:=	null;
end;

if (unidade_atendimento_w.cd_setor_atendimento IS NOT NULL AND unidade_atendimento_w.cd_setor_atendimento::text <> '') then
	begin
	if (unidade_atendimento_w.ie_status_unidade = 'L') or (unidade_atendimento_w.nr_atendimento = atend_paciente_unidade_w.nr_atendimento) then
		ie_disponivel_w := 'S';
	else
		ie_disponivel_w := 'N';
	end if;
	
	if (ie_disponivel_w = 'S') and (atend_paciente_unidade_w.nr_seq_interno IS NOT NULL AND atend_paciente_unidade_w.nr_seq_interno::text <> '') then
		begin
		nr_seq_interno_w	:=	atend_paciente_unidade_w.nr_seq_interno;
		
		atend_paciente_unidade_w.cd_setor_atendimento	:=	unidade_atendimento_w.cd_setor_atendimento;
		atend_paciente_unidade_w.cd_unidade_basica		:=	unidade_atendimento_w.cd_unidade_basica;
		atend_paciente_unidade_w.cd_unidade_compl		:=	unidade_atendimento_w.cd_unidade_compl;
		
		select	nextval('atend_paciente_unidade_seq')
		into STRICT	atend_paciente_unidade_w.nr_seq_interno
		;
		
		--insert into atend_paciente_unidade values atend_paciente_unidade_w;		
		atend_paciente_unidade_w := ish_pat_case_pck.registrar_movto('I', atend_paciente_unidade_w);
		
		update	material_atend_paciente
		set	nr_seq_atepacu = atend_paciente_unidade_w.nr_seq_interno
		where 	nr_seq_atepacu = nr_seq_interno_w;
		
		update	procedimento_paciente
		set	nr_seq_atepacu = atend_paciente_unidade_w.nr_seq_interno
		where 	nr_seq_atepacu = nr_seq_interno_w;
		
		delete	FROM atend_paciente_unidade
		where	nr_seq_interno = nr_seq_interno_w;
		
		update	conversao_meio_externo
		set	cd_interno = to_char(atend_paciente_unidade_w.nr_seq_interno)
		where	nm_tabela = 'ATEND_PACIENTE_UNIDADE'
		and	cd_interno = to_char(nr_seq_interno_w);
		exception
		when others then
			ie_disponivel_w := 'N';
		end;
	end if;
	
	if (ie_disponivel_w = 'N') then
		begin
		begin
		select	c.*
		into STRICT	intpd_eventos_regra_auto_w
		from	intpd_fila_transmissao a,
			intpd_eventos_sistema b,
			intpd_eventos_regra_auto c
		where	a.nr_seq_evento_sistema = b.nr_sequencia
		and	b.nr_sequencia = c.nr_seq_evento_sistema
		and	a.nr_sequencia = nr_seq_fila_p  LIMIT 1;
		exception
		when others then
			intpd_eventos_regra_auto_w	:=	null;
		end;
		
		if (intpd_eventos_regra_auto_w.qt_tentativas > 0) and (intpd_eventos_regra_auto_w.qt_min_retransmissao > 0) and (intpd_eventos_regra_auto_w.qt_tentativas > qt_exec_p)  then		
			dbms_job.submit(jobno,
				'ish_pat_case_pck.reproc_get_transfer(' ||
					nr_seq_fila_p || ', ' ||
					nr_seq_interno_p || ', ' ||
					nr_atendimento_p || ', ' ||
					cd_setor_atendimento_p || ', ' ||
					'''' || cd_unidade_basica_p || ''', ' || 
					'''' || cd_unidade_compl_p	|| ''', ' ||
					to_char(qt_exec_p + 1) || ');', clock_timestamp() + intpd_eventos_regra_auto_w.qt_min_retransmissao/60/24);
		end if;
		end;
	end if;
	end;
end if;
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ish_pat_case_pck.reproc_get_transfer ( nr_seq_fila_p bigint, nr_seq_interno_p atend_paciente_unidade.nr_seq_interno%type, nr_atendimento_p atend_paciente_unidade.nr_atendimento%type, cd_setor_atendimento_p atend_paciente_unidade.cd_setor_atendimento%type, cd_unidade_basica_p atend_paciente_unidade.cd_unidade_basica%type, cd_unidade_compl_p atend_paciente_unidade.cd_unidade_compl%type, qt_exec_p bigint) FROM PUBLIC;
