-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION ish_pat_case_pck.get_inpat_admiss_data_change ( nr_seq_fila_p bigint) RETURNS SETOF T_INPAT_ADMISS_DATA_CHANGE AS $body$
DECLARE


r_inpat_admiss_data_change_w	r_inpat_admiss_data_change;

nr_seq_documento_w	intpd_fila_transmissao.nr_seq_documento%type;
ie_conversao_w		intpd_eventos_sistema.ie_conversao%type;
nr_seq_regra_w		intpd_eventos_sistema.nr_seq_regra_conv%type;

nr_atendimento_w	atendimento_paciente.nr_atendimento%type;
nr_seq_atepacu_w	atend_paciente_unidade.nr_seq_interno%type;

nr_seq_classif_w	classif_pessoa.nr_sequencia%type;
nm_fantasia_w		pessoa_juridica.nm_fantasia%type;

agenda_lista_espera_inpat_w agenda_lista_espera%rowtype;
pessoa_fisica_inpat_w pessoa_fisica%rowtype;

reg_integracao_w		gerar_int_padrao.reg_integracao_conv;
dt_geral_w			varchar(255);
ie_tipo_atendimento_ret_w	atendimento_paciente.ie_tipo_atendimento%type;
cd_setor_externo_w		setor_atendimento.cd_setor_externo%type;
nm_leito_integracao_w		unidade_atendimento.nm_leito_integracao%type;

famphys_medic_w			pf_medico_externo.nr_seq_tipo_medico%type;
famrefphys_medic_w			pf_medico_externo.nr_seq_tipo_medico%type;
movemnttype_w			varchar(255);
nm_localidade_w			varchar(255);	
cd_cep_w			varchar(255);
qt_peso_w			varchar(7);
cd_medico_resp_w		varchar(100);
dt_atualizacao_nrec_w		pep_pac_ci.dt_atualizacao_nrec%type;
ie_controla_alta_w		pep_pac_ci.ie_controla_alta%type;
nr_seq_posicao_w		posicao_sap.nr_sequencia%type;
cd_cgc_indicacao_w		atendimento_paciente.cd_cgc_indicacao%type;

c01 CURSOR FOR
SELECT	nr_sequencia,
	nr_episodio,
	nr_seq_tipo_episodio,
	nr_seq_subtipo_episodio,
	cd_pessoa_fisica,
	ie_status,
	dt_episodio,
	dt_fim_episodio,
	coalesce(dt_atualizacao_nrec, clock_timestamp()) dt_atualizacao_nrec,
	coalesce(nm_usuario_nrec, nm_usuario) nm_usuario_nrec,	
	substr(ds_observacao,1,30) ds_observacao
from	episodio_paciente
where	nr_sequencia = nr_seq_documento_w;

c01_w	c01%rowtype;

c02 CURSOR FOR
SELECT	cd_estabelecimento,
	ie_tipo_atendimento,
	nr_dias_prev_alta,
	cd_cgc_indicacao,
	nr_seq_tipo_acidente,
	dt_ocorrencia,
	cd_municipio_ocorrencia,
	nr_seq_forma_chegada,	
	cd_medico_resp,
	dt_ultima_menstruacao,
	qt_ig_semana,
	nr_seq_queixa,
	nr_seq_tipo_admissao_fat,
	nr_seq_classificacao,
	dt_chegada_paciente,
	dt_entrada,
	cd_procedencia,
	ie_inform_incompletas
from	atendimento_paciente
where	nr_atendimento = nr_atendimento_w;

c02_w	c02%rowtype;

c03 CURSOR FOR
SELECT	nr_seq_interno,
	nr_seq_motivo_int,
	dt_entrada_unidade,
	dt_saida_unidade,
	cd_tipo_acomodacao,
	cd_setor_atendimento,
	cd_unidade_basica,
	cd_unidade_compl,
	cd_departamento,
	substr(obter_dados_atepacu(a.nr_seq_interno, 3),1,10) nr_seq_classif_esp
from	atend_paciente_unidade a
where	nr_seq_interno = nr_seq_atepacu_w;

c03_w	c03%rowtype;

c04 CURSOR FOR
SELECT	qt_peso,
	qt_altura_cm,
	b.cd_medico,
	b.nr_seq_tipo_medico
FROM pessoa_fisica a
LEFT OUTER JOIN pf_medico_externo b ON (a.cd_pessoa_fisica = b.cd_pessoa_fisica)
WHERE a.cd_pessoa_fisica = c01_w.cd_pessoa_fisica and (coalesce(b.dt_fim_vigencia::text, '') = '' or (trunc(b.dt_fim_vigencia) > trunc(clock_timestamp()))) order by b.dt_atualizacao desc;

c04_w	c04%rowtype;

c05 CURSOR FOR
SELECT	a.*
from	atendimento_paciente_inf a
where	a.nr_atendimento in (select	x.nr_atendimento
	from	atendimento_paciente x
	where	x.nr_seq_episodio = c01_w.nr_sequencia)  LIMIT 1;
	
c05_w	c05%rowtype;


BEGIN
select	a.nr_seq_documento,
	coalesce(b.ie_conversao,'I'),
	b.nr_seq_regra_conv
into STRICT	nr_seq_documento_w,
	ie_conversao_w,	
	nr_seq_regra_w
from	intpd_fila_transmissao a,
	intpd_eventos_sistema b
where	a.nr_seq_evento_sistema = b.nr_sequencia
and	a.nr_sequencia = nr_seq_fila_p;

intpd_reg_integracao_inicio(nr_seq_fila_p, 'E', reg_integracao_w);
reg_integracao_w.ie_somente_alterados		:= 'S';

open c01;
loop
fetch c01 into	
	c01_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin
	
	reg_integracao_w.nm_tabela 			:= 'EPISODIO_PACIENTE';
	reg_integracao_w.nm_elemento			:= 'InpatAdmissData';
	intpd_processar_atrib_envio(reg_integracao_w, 'NR_SEQ_TIPO_EPISODIO', 'casetypeext', 'N', c01_w.nr_seq_tipo_episodio, 'S', r_inpat_admiss_data_change_w.casetypeext);
	intpd_processar_atrib_envio(reg_integracao_w, 'NR_SEQ_TIPO_EPISODIO', 'casetypeextx', 'S', c01_w.nr_seq_tipo_episodio, 'N', r_inpat_admiss_data_change_w.casetypeextx);
	intpd_processar_atrib_envio(reg_integracao_w, 'NR_SEQ_SUBTIPO_EPISODIO', 'casecategory', 'N', c01_w.nr_seq_subtipo_episodio, 'S', r_inpat_admiss_data_change_w.casecategory);
	intpd_processar_atrib_envio(reg_integracao_w, 'NR_SEQ_SUBTIPO_EPISODIO', 'casecategoryx', 'S', c01_w.nr_seq_subtipo_episodio, 'N', r_inpat_admiss_data_change_w.casecategoryx);
	intpd_processar_atrib_envio(reg_integracao_w, 'DT_EPISODIO', 'startdate', 'N', c01_w.dt_episodio, 'N', dt_geral_w);
	r_inpat_admiss_data_change_w.startdate		:= to_char(to_date(dt_geral_w),'YYYY-MM-DD');
	intpd_processar_atrib_envio(reg_integracao_w, 'DT_EPISODIO', 'startdatex', 'S', c01_w.dt_episodio, 'N', r_inpat_admiss_data_change_w.startdatex);
	dt_geral_w	:= null;
	intpd_processar_atrib_envio(reg_integracao_w, 'DT_FIM_EPISODIO', 'enddate', 'N', c01_w.dt_fim_episodio, 'N', dt_geral_w);
	r_inpat_admiss_data_change_w.enddate		:= to_char(to_date(dt_geral_w),'YYYY-MM-DD');
	intpd_processar_atrib_envio(reg_integracao_w, 'DT_FIM_EPISODIO', 'enddatex', 'S', c01_w.dt_fim_episodio, 'N', r_inpat_admiss_data_change_w.enddatex);
	dt_geral_w	:= null;
	intpd_processar_atrib_envio(reg_integracao_w, 'DT_ATUALIZACAO_NREC', 'updatedate', 'N', c01_w.dt_atualizacao_nrec, 'N', dt_geral_w);
	r_inpat_admiss_data_change_w.updatedate		:= to_char(to_date(dt_geral_w),'YYYY-MM-DD');
	intpd_processar_atrib_envio(reg_integracao_w, 'DT_ATUALIZACAO_NREC', 'updatedatex', 'S', c01_w.dt_atualizacao_nrec, 'N', r_inpat_admiss_data_change_w.updatedatex);
	intpd_processar_atrib_envio(reg_integracao_w, 'NM_USUARIO', 'updateuser', 'N', ish_param_pck.get_nm_usuario, 'N', r_inpat_admiss_data_change_w.updateuser);
	r_inpat_admiss_data_change_w.updateuserx	:= 'X';

	intpd_processar_atrib_envio(reg_integracao_w, 'DS_OBSERVACAO', 'casecomment', 'N', c01_w.ds_observacao, 'N', r_inpat_admiss_data_change_w.casecomment);
	intpd_processar_atrib_envio(reg_integracao_w, 'DS_OBSERVACAO', 'casecommentx', 'S', c01_w.ds_observacao, 'N', r_inpat_admiss_data_change_w.casecommentx);
	
	begin
	select	*
	into STRICT	agenda_lista_espera_inpat_w
	from	agenda_lista_espera
	where	cd_pessoa_fisica = c01_w.cd_pessoa_fisica;
	exception
	when others then
		null;
	end;	
	/*21/08/2019 - Segundo Daniel, cliente nao utiliza o processo de waiting list no ISH
	/*reg_integracao_w.nm_tabela 			:= 'AGENDA_LISTA_ESPERA';
	intpd_processar_atrib_envio(reg_integracao_w, 'IE_URGENTE', 'waitlistprio', 'N', agenda_lista_espera_inpat_w.ie_urgente, 'N', r_inpat_admiss_data_change_w.waitlistprio);
	if	(r_inpat_admiss_data_change_w.waitlistprio = 'S') then
		r_inpat_admiss_data_change_w.waitlistprio := 'X';
	else
		r_inpat_admiss_data_change_w.waitlistprio	:= null;
	end if;
	intpd_processar_atrib_envio(reg_integracao_w, 'IE_URGENTE', 'waitlistpriox', 'S', agenda_lista_espera_inpat_w.ie_urgente, 'N', r_inpat_admiss_data_change_w.waitlistpriox);
	intpd_processar_atrib_envio(reg_integracao_w, 'IE_STATUS_ESPERA', 'waitliststatus', 'N', agenda_lista_espera_inpat_w.ie_status_espera, 'N', r_inpat_admiss_data_change_w.waitliststatus);
	intpd_processar_atrib_envio(reg_integracao_w, 'IE_STATUS_ESPERA', 'waitliststatusx', 'S', agenda_lista_espera_inpat_w.ie_status_espera, 'N', r_inpat_admiss_data_change_w.waitliststatusx);
	intpd_processar_atrib_envio(reg_integracao_w, 'CD_AGENDA', 'waitlisthosp', 'N', agenda_lista_espera_inpat_w.cd_agenda, 'N', r_inpat_admiss_data_change_w.waitlisthosp);
	intpd_processar_atrib_envio(reg_integracao_w, 'CD_AGENDA', 'waitlisthospx', 'S', agenda_lista_espera_inpat_w.cd_agenda, 'N', r_inpat_admiss_data_change_w.waitlisthospx);
	dt_geral_w	:= null;
	intpd_processar_atrib_envio(reg_integracao_w, 'DT_AGENDAMENTO', 'waitlistdeldat', 'N', agenda_lista_espera_inpat_w.dt_agendamento, 'N', dt_geral_w);
	r_inpat_admiss_data_change_w.waitlistdeldat	:= to_char(to_date(dt_geral_w),'yyyy-mm-dd');
	intpd_processar_atrib_envio(reg_integracao_w, 'DT_AGENDAMENTO', 'waitlistdeldatx', 'S', agenda_lista_espera_inpat_w.dt_agendamento, 'N', r_inpat_admiss_data_change_w.waitlistdeldatx);
	*/
	begin
	select	*
	into STRICT	pessoa_fisica_inpat_w
	from	pessoa_fisica
	where	cd_pessoa_fisica = c01_w.cd_pessoa_fisica;
	exception
	when others then
		null;
	end;
	
	reg_integracao_w.nm_tabela 	:= 'PESSOA_FISICA';
	intpd_processar_atrib_envio(reg_integracao_w, 'CD_SISTEMA_ANT', 'plsno', 'N', pessoa_fisica_inpat_w.cd_sistema_ant, 'N', r_inpat_admiss_data_change_w.plsno);
	intpd_processar_atrib_envio(reg_integracao_w, 'CD_SISTEMA_ANT', 'plsnox', 'S', pessoa_fisica_inpat_w.cd_sistema_ant, 'N', r_inpat_admiss_data_change_w.plsnox);
	
	begin
	select	nm_fantasia
	into STRICT	nm_fantasia_w
	from	pessoa_juridica
	where	cd_cgc = c02_w.cd_cgc_indicacao;
	exception
	when others then
		nm_fantasia_w	:=	null;
	end;	

	reg_integracao_w.nm_tabela 	:= 'PESSOA_JURIDICA';
	intpd_processar_atrib_envio(reg_integracao_w, 'NM_FANTASIA', 'refhospitalname2', 'N', nm_fantasia_w, 'N', r_inpat_admiss_data_change_w.refhospitalname2);
	intpd_processar_atrib_envio(reg_integracao_w, 'NM_FANTASIA', 'refhospitalname2x', 'S', nm_fantasia_w, 'N', r_inpat_admiss_data_change_w.refhospitalname2x);
	intpd_processar_atrib_envio(reg_integracao_w, 'NM_FANTASIA', 'refhospitalname3', 'N', nm_fantasia_w, 'N', r_inpat_admiss_data_change_w.refhospitalname3);
	intpd_processar_atrib_envio(reg_integracao_w, 'NM_FANTASIA', 'refhospitalname3x', 'S', nm_fantasia_w, 'N', r_inpat_admiss_data_change_w.refhospitalname3x);
	
--	r_inpat_admiss_data_change_w.specialtyadmission	:=
--	r_inpat_admiss_data_change_w.specialtyadmissionx	:=	'X';
--	r_inpat_admiss_data_change_w.extmovementid	:=
--	r_inpat_admiss_data_change_w.extmovementidx		:=	'X';
--	r_inpat_admiss_data_change_w.attphys		:=
--	r_inpat_admiss_data_change_w.attphysx		:=	'X';
--	r_inpat_admiss_data_change_w.plsno		:=
--	r_inpat_admiss_data_change_w.plsnox		:=	'X';	
--	r_inpat_admiss_data_change_w.refphysbsnr	:=
--	r_inpat_admiss_data_change_w.refphyslanr	:=
--	r_inpat_admiss_data_change_w.occdisease	:=
--	r_inpat_admiss_data_change_w.occdiseasex		:=	'X';
	
	dt_geral_w	:= null;
	begin
	select	dt_alta_curativo
	into STRICT	dt_geral_w
	from	cur_ferida
	where	cd_pessoa_fisica = c01_w.cd_pessoa_fisica  LIMIT 1;
	exception
	when others then
		dt_geral_w	:= null;
	end;
	
	reg_integracao_w.nm_tabela 	:= 'CUR_FERIDA';
	intpd_processar_atrib_envio(reg_integracao_w, 'DT_ALTA_CURATIVO', 'healeddate', 'N', dt_geral_w, 'N', dt_geral_w);
	r_inpat_admiss_data_change_w.healeddate	:=	to_char(to_date(dt_geral_w),'yyyy-mm-dd');
	intpd_processar_atrib_envio(reg_integracao_w, 'DT_ALTA_CURATIVO', 'healeddatex', 'S', dt_geral_w, 'N', r_inpat_admiss_data_change_w.healeddatex);	
	
	nr_atendimento_w := ish_get_encounter_case(coalesce(c01_w.nr_episodio, c01_w.nr_sequencia), 'INPAT');
	
	open c02;
	loop
	fetch c02 into	
		c02_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */
		begin

		reg_integracao_w.nm_tabela 	:= 'ATENDIMENTO_PACIENTE';
		intpd_processar_atrib_envio(reg_integracao_w, 'IE_TIPO_ATENDIMENTO', 'emergadm', 'N', c02_w.ie_tipo_atendimento, 'N', ie_tipo_atendimento_ret_w);
		if (ie_tipo_atendimento_ret_w = 3) then
			r_inpat_admiss_data_change_w.emergadm	:=	'X';
		end if;
		
		intpd_processar_atrib_envio(reg_integracao_w, 'REFPSTTRTTYPE', 'refpsttrttype', 'N', c02_w.cd_procedencia, 'S', r_inpat_admiss_data_change_w.refpsttrttype);
		intpd_processar_atrib_envio(reg_integracao_w, 'CD_PROCEDENCIA', 'refpsttrttypex', 'S', c02_w.cd_procedencia, 'N', r_inpat_admiss_data_change_w.refpsttrttypex);
		
		dt_geral_w	:= null;
		intpd_processar_atrib_envio(reg_integracao_w, 'DT_ENTRADA', 'movemntdate', 'N', c02_w.dt_entrada, 'N', dt_geral_w);
		r_inpat_admiss_data_change_w.movemntdate	:= to_char(to_date(dt_geral_w),'YYYY-MM-DD');
		intpd_processar_atrib_envio(reg_integracao_w, 'DT_ENTRADA', 'movemntdatex', 'S', c02_w.dt_entrada, 'N', r_inpat_admiss_data_change_w.movemntdatex);
		dt_geral_w	:= null;
		intpd_processar_atrib_envio(reg_integracao_w, 'DT_ENTRADA', 'movemnttime', 'N', c02_w.dt_entrada, 'N', dt_geral_w);
		r_inpat_admiss_data_change_w.movemnttime	:=	to_char(to_date(dt_geral_w),'HH24:MI:SS');
		intpd_processar_atrib_envio(reg_integracao_w, 'DT_ENTRADA', 'movemnttimex', 'S', c02_w.dt_entrada, 'N', r_inpat_admiss_data_change_w.movemnttimex);
	
		
		if (coalesce(r_inpat_admiss_data_change_w.movemntdate::text, '') = '') then
			reg_integracao_w.nm_tabela 	:= 'EPISODIO_PACIENTE';
			dt_geral_w	:= null;
			intpd_processar_atrib_envio(reg_integracao_w, 'DT_EPISODIO', 'movemntdate', 'N', c02_w.dt_entrada, 'N', dt_geral_w);
			r_inpat_admiss_data_change_w.movemntdate	:= to_char(to_date(dt_geral_w),'YYYY-MM-DD');
			intpd_processar_atrib_envio(reg_integracao_w, 'DT_EPISODIO', 'movemntdatex', 'S', c02_w.dt_entrada, 'N', r_inpat_admiss_data_change_w.movemntdatex);
			dt_geral_w	:= null;
			intpd_processar_atrib_envio(reg_integracao_w, 'DT_EPISODIO', 'movemnttime', 'N', c02_w.dt_entrada, 'N', dt_geral_w);
			r_inpat_admiss_data_change_w.movemnttime	:=	to_char(to_date(dt_geral_w),'HH24:MI:SS');
			intpd_processar_atrib_envio(reg_integracao_w, 'DT_EPISODIO', 'movemnttimex', 'S', c02_w.dt_entrada, 'N', r_inpat_admiss_data_change_w.movemnttimex);
			reg_integracao_w.nm_tabela 	:= 'ATENDIMENTO_PACIENTE';
		end if;		
		
		intpd_processar_atrib_envio(reg_integracao_w, 'DT_CHEGADA_PACIENTE', 'statusindx', 'S', c02_w.dt_chegada_paciente, 'N', r_inpat_admiss_data_change_w.statusindx);		
		
		intpd_processar_atrib_envio(reg_integracao_w, 'IE_TIPO_ATENDIMENTO', 'emergadmx', 'S', c02_w.ie_tipo_atendimento, 'N', r_inpat_admiss_data_change_w.emergadmx);
		
		r_inpat_admiss_data_change_w.lengthofstay	:=	ish_pat_case_pck.obter_lenght_of_stay(nr_atendimento_w);
		r_inpat_admiss_data_change_w.lengthofstayx	:=	'X';
		
		cd_cgc_indicacao_w := c02_w.cd_cgc_indicacao;

		if (coalesce(cd_cgc_indicacao_w, 'NULL') = 'NULL') then
			begin
				select	api.cd_cgc_indicacao
				into STRICT	cd_cgc_indicacao_w
				from	atendimento_paciente_inf api
				where	api.nr_sequencia = (SELECT	max(aux.nr_sequencia)
											from	atendimento_paciente_inf aux
											where	aux.nr_atendimento = nr_atendimento_w);
			exception when no_data_found then
				cd_cgc_indicacao_w := null;
			end;
		end if;

		if (coalesce(cd_cgc_indicacao_w, 'NULL') <> 'NULL') then
			intpd_processar_atrib_envio(reg_integracao_w, 'CD_CGC_INDICACAO', 'refhospital', 'N', lpad(somente_numero(cd_cgc_indicacao_w), 10, 0), 'N', r_inpat_admiss_data_change_w.refhospital);
			intpd_processar_atrib_envio(reg_integracao_w, 'CD_CGC_INDICACAO', 'refhospitalx', 'S', lpad(somente_numero(cd_cgc_indicacao_w), 10, 0), 'N', r_inpat_admiss_data_change_w.refhospitalx);
		else
			intpd_processar_atrib_envio(reg_integracao_w, 'CD_CGC_INDICACAO', 'refhospital', 'N', null, 'N', r_inpat_admiss_data_change_w.refhospital);
			intpd_processar_atrib_envio(reg_integracao_w, 'CD_CGC_INDICACAO', 'refhospitalx', 'S', null, 'N', r_inpat_admiss_data_change_w.refhospitalx);
		end if;
		--Alterei para buscar do c01, episodio_paciente.cd_medico_referido, pois e gravado neste campo quando recebemos do ISH
		--r_inpat_admiss_data_change_w.refphys			:=	intpd_conv('PESSOA_FISICA','CD_PESSOA_FISICA', c02_w.cd_medico_referido, nr_seq_regra_w, ie_conversao_w, 'E');
		--r_inpat_admiss_data_change_w.refphysx		:=	'X';
		--intpd_processar_atrib_envio(reg_integracao_w, 'CD_MEDICO_RESP', 'admphys', 'N', c02_w.cd_medico_resp, 'S', r_inpat_admiss_data_change_w.admphys);
		--intpd_processar_atrib_envio(reg_integracao_w, 'CD_MEDICO_RESP', 'admphysx', 'S', c02_w.cd_medico_resp, 'N', r_inpat_admiss_data_change_w.admphysx);
		dt_geral_w	:= null;
		intpd_processar_atrib_envio(reg_integracao_w, 'DT_ULTIMA_MENSTRUACAO', 'lastmenstrualperiod', 'N', c02_w.dt_ultima_menstruacao, 'N', dt_geral_w);
		r_inpat_admiss_data_change_w.lastmenstrualperiod	:= to_char(to_date(dt_geral_w),'YYYY-MM-DD');
		intpd_processar_atrib_envio(reg_integracao_w, 'DT_ULTIMA_MENSTRUACAO', 'lastmenstrualperiodx', 'S', c02_w.dt_ultima_menstruacao, 'N', r_inpat_admiss_data_change_w.lastmenstrualperiodx);
		
		select	max(a.ds_valor)
		into STRICT	cd_medico_resp_w
		from	intpd_eventos_valores a,
			intpd_fila_transmissao b
		where	a.nm_elemento	= 'ATENDIMENTO_PACIENTE'
		and	a.nm_atributo	= 'CD_MEDICO_RESP'
		and	a.ie_situacao	= 'A'
		and	a.nr_seq_evento_sistema = b.nr_seq_evento_sistema
		and	b.nr_sequencia = nr_seq_fila_p;
		
		if (c02_w.cd_medico_resp = cd_medico_resp_w) then
			r_inpat_admiss_data_change_w.attphys	:= null;
			r_inpat_admiss_data_change_w.attphysx	:= null;
		else
			intpd_processar_atrib_envio(reg_integracao_w, 'CD_MEDICO_RESP', 'attphys', 'N', c02_w.cd_medico_resp, 'ISHMED', r_inpat_admiss_data_change_w.attphys);
			intpd_processar_atrib_envio(reg_integracao_w, 'CD_MEDICO_RESP', 'attphysx', 'S', c02_w.cd_medico_resp, 'N', r_inpat_admiss_data_change_w.attphysx);
		end if;		
		
		intpd_processar_atrib_envio(reg_integracao_w, 'NR_SEQ_CLASSIFICACAO', 'movemntreas1', 'N', c02_w.nr_seq_classificacao, 'S', r_inpat_admiss_data_change_w.movemntreas1);
		intpd_processar_atrib_envio(reg_integracao_w, 'NR_SEQ_CLASSIFICACAO', 'movemntreas1x', 'S', c02_w.nr_seq_classificacao, 'N', r_inpat_admiss_data_change_w.movemntreas1x);
		intpd_processar_atrib_envio(reg_integracao_w, 'NR_SEQ_QUEIXA', 'movemntreas2', 'N', c02_w.nr_seq_queixa, 'S', r_inpat_admiss_data_change_w.movemntreas2);
		intpd_processar_atrib_envio(reg_integracao_w, 'NR_SEQ_QUEIXA', 'movemntreas2x', 'S', c02_w.nr_seq_queixa, 'N', r_inpat_admiss_data_change_w.movemntreas2x);
				
		intpd_processar_atrib_envio(reg_integracao_w, 'NR_SEQ_TIPO_ADMISSAO_FAT', 'movemnttype', 'N', c02_w.nr_seq_tipo_admissao_fat, 'S', movemnttype_w);
		if (ish_param_pck.get_conv_tipo_adm_fat = 'CTMCMT') then
			r_inpat_admiss_data_change_w.movemnttype	:=	substr(obter_valor_campo_separador(movemnttype_w, 3, current_setting('ish_pat_case_pck.ds_separador_w')::varchar(10)), 1, 255);
		else
			r_inpat_admiss_data_change_w.movemnttype	:=	substr(obter_valor_campo_separador(movemnttype_w, 2, current_setting('ish_pat_case_pck.ds_separador_w')::varchar(10)), 1, 255);
		end if;

		intpd_processar_atrib_envio(reg_integracao_w, 'NR_SEQ_TIPO_ADMISSAO_FAT', 'movemnttypex', 'S', c02_w.nr_seq_tipo_admissao_fat, 'N', r_inpat_admiss_data_change_w.movemnttypex);

		reg_integracao_w.ie_somente_alterados := 'N';
    if (coalesce(c02_w.ie_inform_incompletas, 'N') = 'S') then
			intpd_processar_atrib_envio(reg_integracao_w, 'IE_INFORM_INCOMPLETAS', 'quickadm', 'N', 'X', 'N', r_inpat_admiss_data_change_w.quickadm);
		else
			intpd_processar_atrib_envio(reg_integracao_w, 'IE_INFORM_INCOMPLETAS', 'quickadm', 'N', '', 'N', r_inpat_admiss_data_change_w.quickadm);
		end if;
    reg_integracao_w.ie_somente_alterados := 'S';

		exit;
		end;
	end loop;
	close c02;
	
	intpd_processar_atrib_envio(reg_integracao_w, 'IE_TIPO_ATENDIMENTO', 'emergcase', 'N', c02_w.ie_tipo_atendimento, 'N', ie_tipo_atendimento_ret_w);
	if (ie_tipo_atendimento_ret_w = 3) then
		r_inpat_admiss_data_change_w.emergcase	:=	'X';
	end if;	
	
	/*'P = Primeira Unidade'*/

	nr_seq_atepacu_w	:=	obter_atepacu_paciente(nr_atendimento_w,'P');

	open C05;
	loop
	fetch C05 into
		c05_w;
	EXIT WHEN NOT FOUND; /* apply on C05 */
		reg_integracao_w.nm_tabela	:= 'ATENDIMENTO_PACIENTE_INF';
		intpd_processar_atrib_envio(reg_integracao_w, 'NR_SEQ_TIPO_ACIDENTE', 'accident', 'N', c05_w.nr_seq_tipo_acidente, 'S', r_inpat_admiss_data_change_w.accident);
		intpd_processar_atrib_envio(reg_integracao_w, 'NR_SEQ_TIPO_ACIDENTE', 'accidentx', 'S', c05_w.nr_seq_tipo_acidente, 'N', r_inpat_admiss_data_change_w.accidentx);
		intpd_processar_atrib_envio(reg_integracao_w, 'NR_SEQ_FORMA_CHEGADA', 'arrivalmode', 'N', c05_w.nr_seq_forma_chegada, 'S', r_inpat_admiss_data_change_w.arrivalmode);
		intpd_processar_atrib_envio(reg_integracao_w, 'NR_SEQ_FORMA_CHEGADA', 'arrivalmodex', 'S', c05_w.nr_seq_forma_chegada, 'N', r_inpat_admiss_data_change_w.arrivalmodex);
		intpd_processar_atrib_envio(reg_integracao_w, 'NR_ACIDENTE', 'accidentno', 'N', c05_w.nr_acidente, 'N', r_inpat_admiss_data_change_w.accidentno);
		intpd_processar_atrib_envio(reg_integracao_w, 'NR_ACIDENTE', 'accidentnox', 'S', c05_w.nr_acidente, 'N', r_inpat_admiss_data_change_w.accidentnox);
		intpd_processar_atrib_envio(reg_integracao_w, 'DS_ACIDENTE', 'accidentloc', 'N', c05_w.ds_acidente, 'N', r_inpat_admiss_data_change_w.accidentloc);
		intpd_processar_atrib_envio(reg_integracao_w, 'DS_ACIDENTE', 'accidentlocx', 'S', c05_w.ds_acidente, 'N', r_inpat_admiss_data_change_w.accidentlocx);	
		intpd_processar_atrib_envio(reg_integracao_w, 'CD_MEDICO', 'refphys', 'N', c05_w.cd_medico, 'S', r_inpat_admiss_data_change_w.refphys);
		intpd_processar_atrib_envio(reg_integracao_w, 'CD_MEDICO', 'refphysx', 'S', c05_w.cd_medico, 'N', r_inpat_admiss_data_change_w.refphysx);
		intpd_processar_atrib_envio(reg_integracao_w, 'NR_BSNR', 'refphysbsnr', 'N', c05_w.nr_bsnr, 'N', r_inpat_admiss_data_change_w.refphysbsnr);
		intpd_processar_atrib_envio(reg_integracao_w, 'NR_BSNR', 'refphysbsnrx', 'S', c05_w.nr_bsnr, 'N', r_inpat_admiss_data_change_w.refphysbsnrx);
		intpd_processar_atrib_envio(reg_integracao_w, 'NR_RQE', 'refphyslanr', 'N', c05_w.nr_rqe, 'N', r_inpat_admiss_data_change_w.refphyslanr);
		intpd_processar_atrib_envio(reg_integracao_w, 'NR_RQE', 'refphyslanrx', 'S', c05_w.nr_rqe, 'N', r_inpat_admiss_data_change_w.refphyslanrx);		
		
		intpd_processar_atrib_envio(reg_integracao_w, 'DT_OCORRENCIA', 'accidentdate', 'N', c05_w.dt_ocorrencia, 'N', dt_geral_w);
		r_inpat_admiss_data_change_w.accidentdate	:= to_char(to_date(dt_geral_w),'YYYY-MM-DD');
		intpd_processar_atrib_envio(reg_integracao_w, 'DT_OCORRENCIA', 'accidentdatex', 'S', c05_w.dt_ocorrencia, 'N', r_inpat_admiss_data_change_w.accidentdatex);
		dt_geral_w	:= null;
		intpd_processar_atrib_envio(reg_integracao_w, 'DT_OCORRENCIA', 'accidenttime', 'N', c05_w.dt_ocorrencia, 'N', dt_geral_w);
		r_inpat_admiss_data_change_w.accidenttime	:= to_char(to_date(dt_geral_w),'HH24:MI:SS');
		intpd_processar_atrib_envio(reg_integracao_w, 'DT_OCORRENCIA', 'accidenttimex', 'S', c05_w.dt_ocorrencia, 'N', r_inpat_admiss_data_change_w.accidenttimex);
		
		if (c05_w.dt_validade IS NOT NULL AND c05_w.dt_validade::text <> '') then
			intpd_processar_atrib_envio(reg_integracao_w, 'DT_INICIO_VALIDADE', 'startdate', 'N', c05_w.dt_inicio_validade, 'N', dt_geral_w);			
			r_inpat_admiss_data_change_w.startdate		:=	to_char(to_date(dt_geral_w),'YYYY-MM-DD');
			intpd_processar_atrib_envio(reg_integracao_w, 'DT_INICIO_VALIDADE', 'startdatex', 'S', c05_w.dt_inicio_validade, 'N', r_inpat_admiss_data_change_w.startdatex);
			dt_geral_w	:= null;			
			intpd_processar_atrib_envio(reg_integracao_w, 'DT_VALIDADE', 'enddate', 'N', c05_w.dt_validade, 'N', dt_geral_w);			
			r_inpat_admiss_data_change_w.enddate		:=	to_char(to_date(dt_geral_w),'YYYY-MM-DD');
			intpd_processar_atrib_envio(reg_integracao_w, 'DT_VALIDADE', 'enddatex', 'S', c05_w.dt_validade, 'N', r_inpat_admiss_data_change_w.enddatex);
			dt_geral_w	:= null;
		end if;
	end loop;
	close C05;
	
	open c03;
	loop
	fetch c03 into	
		c03_w;
	EXIT WHEN NOT FOUND; /* apply on c03 */
		begin
		reg_integracao_w.nm_tabela 	:= 'ATEND_PACIENTE_UNIDADE';		
		intpd_processar_atrib_envio(reg_integracao_w, 'NR_SEQ_CLASSIF_ESP', 'treatmcategory', 'N', c03_w.nr_seq_classif_esp, 'S', r_inpat_admiss_data_change_w.treatmcategory);
		intpd_processar_atrib_envio(reg_integracao_w, 'NR_SEQ_CLASSIF_ESP', 'treatmcategoryx', 'S', c03_w.nr_seq_classif_esp, 'N', r_inpat_admiss_data_change_w.treatmcategoryx);				
		intpd_processar_atrib_envio(reg_integracao_w, 'CD_DEPARTAMENTO', 'department', 'N', c03_w.cd_departamento, 'S', r_inpat_admiss_data_change_w.department);
		intpd_processar_atrib_envio(reg_integracao_w, 'CD_DEPARTAMENTO', 'departmentx', 'S', c03_w.cd_departamento, 'N', r_inpat_admiss_data_change_w.departmentx);
		
		begin
		select	cd_setor_externo
		into STRICT	r_inpat_admiss_data_change_w.nurstreatou
		from	setor_atendimento
		where	cd_setor_atendimento = c03_w.cd_setor_atendimento
		and	(cd_setor_externo IS NOT NULL AND cd_setor_externo::text <> '')  LIMIT 1;
		exception
		when others then
			intpd_processar_atrib_envio(reg_integracao_w, 'CD_SETOR_ATENDIMENTO', 'nurstreatou', 'N', c03_w.cd_setor_atendimento, 'S', r_inpat_admiss_data_change_w.nurstreatou);
		end;
				
		intpd_processar_atrib_envio(reg_integracao_w, 'CD_SETOR_ATENDIMENTO', 'nurstreatoux', 'S', c03_w.cd_setor_atendimento, 'N', r_inpat_admiss_data_change_w.nurstreatoux);		
		
		reg_integracao_w.nm_tabela 	:= 'UNIDADE_ATENDIMENTO';
		begin
		select	nm_leito_integracao
		into STRICT	nm_leito_integracao_w
		from	unidade_atendimento
		where	cd_setor_atendimento = c03_w.cd_setor_atendimento
		and	cd_unidade_basica = c03_w.cd_unidade_basica
		and	cd_unidade_compl = c03_w.cd_unidade_compl
		and	(nm_leito_integracao IS NOT NULL AND nm_leito_integracao::text <> '');
		exception
		when others then
			begin
			--Se a unidade for uma unidade virtual no Tasy, nao enecessario enviar para o ISH.
			if (ish_pat_case_pck.obter_se_sem_acomod(c03_w.cd_setor_atendimento,c03_w.cd_unidade_basica, c03_w.cd_unidade_compl) = 'N') then
				reg_integracao_w.nm_tabela 	:= 'ATEND_PACIENTE_UNIDADE';
				intpd_processar_atrib_envio(reg_integracao_w, 'CD_UNIDADE_BASICA', 'room', 'N', c03_w.cd_unidade_basica, 'S', r_inpat_admiss_data_change_w.room);
				intpd_processar_atrib_envio(reg_integracao_w, 'CD_UNIDADE_BASICA', 'roomx', 'S', c03_w.cd_unidade_basica, 'N', r_inpat_admiss_data_change_w.roomx);
				intpd_processar_atrib_envio(reg_integracao_w, 'CD_UNIDADE_COMPL', 'bed', 'N', c03_w.cd_unidade_compl, 'S', r_inpat_admiss_data_change_w.bed);
				intpd_processar_atrib_envio(reg_integracao_w, 'CD_UNIDADE_COMPL', 'bedx', 'S', c03_w.cd_unidade_compl, 'N', r_inpat_admiss_data_change_w.bedx);
			end if;
			nm_leito_integracao_w	:=	null;
			end;
		end;
		
		if (position(current_setting('ish_pat_case_pck.ds_separador_w')::varchar(10) in nm_leito_integracao_w) > 0) then
			intpd_processar_atrib_envio(reg_integracao_w, 'NM_LEITO_INTEGRACAO', 'bed', 'N', obter_valor_campo_separador(nm_leito_integracao_w,2,current_setting('ish_pat_case_pck.ds_separador_w')::varchar(10)), 'N', r_inpat_admiss_data_change_w.bed);
		else				
			intpd_processar_atrib_envio(reg_integracao_w, 'NM_LEITO_INTEGRACAO', 'bed', 'N', nm_leito_integracao_w, 'N', r_inpat_admiss_data_change_w.bed);
		end if;
		intpd_processar_atrib_envio(reg_integracao_w, 'NM_LEITO_INTEGRACAO', 'bedx', 'S', nm_leito_integracao_w, 'N', r_inpat_admiss_data_change_w.bedx);
		
		if (position(current_setting('ish_pat_case_pck.ds_separador_w')::varchar(10) in nm_leito_integracao_w) > 0) then
		
			r_inpat_admiss_data_change_w.room	:= obter_valor_campo_separador(nm_leito_integracao_w,1,current_setting('ish_pat_case_pck.ds_separador_w')::varchar(10));				
			intpd_processar_atrib_envio(reg_integracao_w, 'NM_LEITO_INTEGRACAO', 'roomx', 'S', nm_leito_integracao_w, 'N', r_inpat_admiss_data_change_w.roomx);
		
		elsif (somente_numero(r_inpat_admiss_data_change_w.bed) > 0) then
			
			r_inpat_admiss_data_change_w.room	:= ish_pat_case_pck.get_room_code(r_inpat_admiss_data_change_w.bed);					
			--r_inpat_admiss_data_change_w.room	:=	'Z' || somente_numero(r_inpat_admiss_data_change_w.bed);
			intpd_processar_atrib_envio(reg_integracao_w, 'NM_LEITO_INTEGRACAO', 'roomx', 'S', nm_leito_integracao_w, 'N', r_inpat_admiss_data_change_w.roomx);
		end if;

		if (r_inpat_admiss_data_change_w.statusindx = 'X') then
			begin			
			if	((trunc(c03_w.dt_entrada_unidade) > trunc(clock_timestamp())) and (coalesce(c02_w.dt_chegada_paciente::text, '') = '')) or (obter_se_atendimento_futuro(nr_atendimento_w) = 'S') then
				r_inpat_admiss_data_change_w.StatusInd	:=	'P';
			else	
				r_inpat_admiss_data_change_w.StatusInd	:=	null;
			end if;
			end;
		end if;
		
		exit;
		end;
		
	end loop;
	close c03;

	reg_integracao_w.nm_tabela	:= 'ATENDIMENTO_PACIENTE_AUX';

	intpd_processar_atrib_envio(reg_integracao_w, 'NR_SEQ_POSICAO', 'admittdept', 'N', null, 'N', nr_seq_posicao_w);

	if (nr_seq_posicao_w IS NOT NULL AND nr_seq_posicao_w::text <> '') then
		begin
			select	posicao_sap.cd_external_code
			into STRICT	r_inpat_admiss_data_change_w.admittdept
			from	posicao_sap
			where	posicao_sap.nr_sequencia = nr_seq_posicao_w;
		exception
		when others then
			r_inpat_admiss_data_change_w.admittdept := null;
		end;

		intpd_processar_atrib_envio(reg_integracao_w, 'NR_SEQ_POSICAO', 'admittdeptx', 'S', null, 'N', r_inpat_admiss_data_change_w.admittdeptx);
	end if;

	reg_integracao_w.nm_tabela	:= 'EPISODIO_PACIENTE';
	

	r_inpat_admiss_data_change_w.specialty		:= null;
	r_inpat_admiss_data_change_w.specialtyx	 	:= 'X';
		
	open c04;
	loop
	fetch c04 into
		c04_w;
	EXIT WHEN NOT FOUND; /* apply on c04 */
		begin
		reg_integracao_w.nm_tabela	:= 'PESSOA_FISICA';
		intpd_processar_atrib_envio(reg_integracao_w, 'QT_PESO', 'patweight', 'N', c04_w.qt_peso, 'N', qt_peso_w);
		r_inpat_admiss_data_change_w.patweight	:=	replace(qt_peso_w,',','.');
		intpd_processar_atrib_envio(reg_integracao_w, 'QT_PESO', 'patweightx', 'S', c04_w.qt_peso, 'N', r_inpat_admiss_data_change_w.patweightx);
		--r_inpat_admiss_data_change_w.weightunit		:= 'kg';
		r_inpat_admiss_data_change_w.weightunitiso	:= 'KGM'; --OS 1956899
		r_inpat_admiss_data_change_w.weightunitx	:= 'X';
		intpd_processar_atrib_envio(reg_integracao_w, 'QT_ALTURA_CM', 'patheight', 'N', c04_w.qt_altura_cm, 'N', r_inpat_admiss_data_change_w.patheight);
		intpd_processar_atrib_envio(reg_integracao_w, 'QT_ALTURA_CM', 'patheightx', 'S', c04_w.qt_altura_cm, 'N', r_inpat_admiss_data_change_w.patheightx);
		--r_inpat_admiss_data_change_w.heightunit		:= 'cm';
		r_inpat_admiss_data_change_w.heightunitiso	:= 'CMT';  --OS 1956899
		r_inpat_admiss_data_change_w.heightunitx	:= 'X';
		
		
		reg_integracao_w.nm_tabela	:= 'PF_MEDICO_EXTERNO';
		reg_integracao_w.ie_somente_alterados	:=	'N';
		
		famphys_medic_w := somente_numero(intpd_conv('TIPO_MEDICO_EXTERNO', 'NR_SEQUENCIA', 'FAMPHYS', nr_seq_regra_w, ie_conversao_w, 'I'));
		famrefphys_medic_w := somente_numero(intpd_conv('TIPO_MEDICO_EXTERNO', 'NR_SEQUENCIA', 'FAMREFPHYS', nr_seq_regra_w, ie_conversao_w, 'I'));
		
		if (c04_w.nr_seq_tipo_medico = famphys_medic_w) or (c04_w.nr_seq_tipo_medico = famrefphys_medic_w) then
			intpd_processar_atrib_envio(reg_integracao_w, 'CD_MEDICO', 'famphys', 'N', c04_w.cd_medico, 'S', r_inpat_admiss_data_change_w.famphys);
			intpd_processar_atrib_envio(reg_integracao_w, 'CD_MEDICO', 'famphysx', 'N', 'X', 'N', r_inpat_admiss_data_change_w.famphysx);
			exit;
		end if;		
				
		reg_integracao_w.ie_somente_alterados	:=	'S';		
		end;
	end loop;
	close c04;
	
	nr_seq_classif_w := intpd_conv('CLASSIF_PESSOA', 'NR_SEQUENCIA', 'RESTRICTED', nr_seq_regra_w, ie_conversao_w, 'I');		
	begin
	select	'X'
	into STRICT	r_inpat_admiss_data_change_w.restricted
	from	pessoa_classif
	where	cd_pessoa_fisica = c01_w.cd_pessoa_fisica
	and	nr_seq_classif = nr_seq_classif_w
	and	coalesce(dt_final_vigencia::text, '') = ''
	and	dt_inicio_vigencia < clock_timestamp()
	and	coalesce(dt_inativacao::text, '') = ''  LIMIT 1;		
	exception
	when others then
		r_inpat_admiss_data_change_w.restricted	:=	null;
	end;
	
	r_inpat_admiss_data_change_w.restrictedx		:=	'X';
	
	
	begin
	select  'X'
	into STRICT	r_inpat_admiss_data_change_w.pirconsent
	from  	atendimento_paciente a,
		atend_categoria_convenio b,
		convenio c
	where	a.nr_atendimento	= b.nr_atendimento
	and	b.cd_convenio		= c.cd_convenio
	/*and	c.ie_tipo_convenio	= 2	--SO 2157727 We should not have the restriction for public or private. When checked, we should send it*/

	and	a.nr_seq_episodio	= c01_w.nr_sequencia
	and	b.ie_autoriza_envio_convenio = 'S'  LIMIT 1;
	exception
	when others then
		r_inpat_admiss_data_change_w.pirconsent	:= null;
	end;
	
	r_inpat_admiss_data_change_w.pirconsentx	:=	'X';
	
	end;

	reg_integracao_w.nm_tabela	:= 'PEP_PAC_CI';

	begin
	select  dt_atualizacao_nrec,
		ie_controla_alta
	into STRICT    dt_atualizacao_nrec_w,
		ie_controla_alta_w
	from (SELECT   *
		from      pep_pac_ci
		where     nr_atendimento = nr_atendimento_w
		order by  nr_sequencia desc) alias0 LIMIT 1;
	exception
	when others then
		dt_atualizacao_nrec_w := null;
		ie_controla_alta_w := null;
	end;

	intpd_processar_atrib_envio(reg_integracao_w, 'DT_ATUALIZACAO_NREC', 'disconsdat', 'N', dt_atualizacao_nrec_w, 'N', dt_geral_w);
	r_inpat_admiss_data_change_w.disconsdat  := to_char(to_date(dt_geral_w),'YYYY-MM-DD');
	dt_geral_w	:= null;
	intpd_processar_atrib_envio(reg_integracao_w, 'DT_ATUALIZACAO_NREC', 'disconsdatx', 'S', dt_atualizacao_nrec_w, 'N', r_inpat_admiss_data_change_w.disconsdatx);
	intpd_processar_atrib_envio(reg_integracao_w, 'IE_CONTROLA_ALTA', 'disconsent', 'N', ie_controla_alta_w, 'N', r_inpat_admiss_data_change_w.disconsent);

	if (coalesce(r_inpat_admiss_data_change_w.disconsent,'NULL') = 'S') then
	r_inpat_admiss_data_change_w.disconsent := 'X';
	else
	r_inpat_admiss_data_change_w.disconsent := null;
	end if;
	
	intpd_processar_atrib_envio(reg_integracao_w, 'IE_CONTROLA_ALTA', 'disconsentx', 'S', ie_controla_alta_w, 'N', r_inpat_admiss_data_change_w.disconsentx);

end loop;
close c01;

RETURN NEXT r_inpat_admiss_data_change_w;
CALL intpd_gravar_log_fila(reg_integracao_w);
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION ish_pat_case_pck.get_inpat_admiss_data_change ( nr_seq_fila_p bigint) FROM PUBLIC;
