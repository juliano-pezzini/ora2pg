-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION ish_pat_case_pck.get_add_transfer_data ( nr_seq_fila_p bigint) RETURNS SETOF T_ADD_TRANSFER_DATA AS $body$
DECLARE


r_add_transfer_data_w	r_add_transfer_data;

nr_seq_documento_w	intpd_fila_transmissao.nr_seq_documento%type;
ie_conversao_w		intpd_eventos_sistema.ie_conversao%type;
nr_seq_regra_w		intpd_eventos_sistema.nr_seq_regra_conv%type;

nr_atendimento_w		atendimento_paciente.nr_atendimento%type;
nr_seq_atepacu_w		atend_paciente_unidade.nr_seq_interno%type;

nr_seq_classif_w		classif_pessoa.nr_sequencia%type;
atepacu_ant_w			atend_paciente_unidade%rowtype;

nr_seq_agrupamento_w		setor_atendimento.nr_seq_agrupamento%type;
nr_seq_agrup_ant_w		setor_atendimento.nr_seq_agrupamento%type;
reg_integracao_w		gerar_int_padrao.reg_integracao_conv;
dt_geral_w			varchar(255);
cd_setor_externo_w		setor_atendimento.cd_setor_externo%type;
cd_departamento_w		varchar(255);
nm_leito_integracao_w		unidade_atendimento.nm_leito_integracao%type;

c03 CURSOR FOR
SELECT	a.nr_seq_interno,
	a.nr_seq_motivo_int,
	a.dt_entrada_unidade,
	a.dt_saida_unidade,
	a.cd_tipo_acomodacao,
	a.cd_setor_atendimento,
	a.cd_unidade_basica,
	a.cd_unidade_compl,
	a.ds_observacao,
	a.nr_seq_unid_ant,	
	a.cd_departamento,
	substr(obter_dados_atepacu(a.nr_seq_interno, 3),1,10) nr_seq_classif_esp,
	b.nr_seq_episodio,
	a.nr_atendimento
from	atend_paciente_unidade a,
	atendimento_paciente b
where	a.nr_atendimento = b.nr_atendimento
and	a.nr_seq_interno = nr_seq_documento_w;

c03_w	c03%rowtype;


BEGIN
select	a.nr_seq_documento,
	coalesce(b.ie_conversao,'I'),
	b.nr_seq_regra_conv
into STRICT	nr_seq_documento_w,
	ie_conversao_w,	
	nr_seq_regra_w
from	intpd_fila_transmissao a,
	intpd_eventos_sistema b
where	a.nr_seq_evento_sistema = b.nr_sequencia
and	a.nr_sequencia = nr_seq_fila_p;

intpd_reg_integracao_inicio(nr_seq_fila_p, 'E', reg_integracao_w);


open c03;
loop
fetch c03 into	
	c03_w;
EXIT WHEN NOT FOUND; /* apply on c03 */
	begin
	begin
	select	max(nr_seq_interno)
	into STRICT	nr_seq_atepacu_w
	from	atend_paciente_unidade
	where	nr_atendimento = c03_w.nr_atendimento
	and	nr_seq_interno < c03_w.nr_seq_interno;
	
	select	*
	into STRICT	atepacu_ant_w
	from	atend_paciente_unidade
	where	nr_seq_interno = nr_seq_atepacu_w;
	
	select	a.nr_seq_agrupamento		
	into STRICT	nr_seq_agrup_ant_w		
	from	setor_atendimento a		
	where	a.cd_setor_atendimento = atepacu_ant_w.cd_setor_atendimento;
	
	exception
	when others then
		atepacu_ant_w.nr_seq_interno	:=	null;
	end;
	
	reg_integracao_w.nm_elemento	:= 'InpatTransferData';
	reg_integracao_w.nm_tabela 	:= 'ATEND_PACIENTE_UNIDADE';
	intpd_processar_atrib_envio(reg_integracao_w, 'DT_ENTRADA_UNIDADE', 'movemntdate', 'N', c03_w.dt_entrada_unidade, 'N', dt_geral_w);
	r_add_transfer_data_w.movemntdate	:=	to_char(to_date(dt_geral_w),'YYYY-MM-DD');
	dt_geral_w	:= null;
	intpd_processar_atrib_envio(reg_integracao_w, 'DT_ENTRADA_UNIDADE', 'movemnttime', 'N', c03_w.dt_entrada_unidade, 'N', dt_geral_w);
	r_add_transfer_data_w.movemnttime	:=	to_char(to_date(dt_geral_w),'HH24:MI:SS');		
	intpd_processar_atrib_envio(reg_integracao_w, 'NR_SEQ_CLASSIF_ESP', 'treatmcategory', 'N', c03_w.nr_seq_classif_esp, 'S', r_add_transfer_data_w.treatmcategory);
	
	begin
	select	a.cd_setor_externo,
		a.nr_seq_agrupamento
		--b.ds_agrupamento
	into STRICT	cd_setor_externo_w,
		nr_seq_agrupamento_w
		--r_add_transfer_data_w.department
	FROM setor_atendimento a
LEFT OUTER JOIN agrupamento_setor b ON (a.nr_seq_agrupamento = b.nr_sequencia)
WHERE a.cd_setor_atendimento = c03_w.cd_setor_atendimento and (a.cd_setor_externo IS NOT NULL AND a.cd_setor_externo::text <> '')   LIMIT 1;
	
	intpd_processar_atrib_envio(reg_integracao_w, 'CD_SETOR_ATENDIMENTO', 'nurstreatou', 'N', cd_setor_externo_w, 'N', r_add_transfer_data_w.nurstreatou);
	exception
	when others then	
		intpd_processar_atrib_envio(reg_integracao_w, 'CD_SETOR_ATENDIMENTO', 'nurstreatou', 'N', c03_w.cd_setor_atendimento, '', r_add_transfer_data_w.nurstreatou);
	end;
	
	intpd_processar_atrib_envio(reg_integracao_w, 'CD_DEPARTAMENTO', 'department', 'N', c03_w.cd_departamento, 'S', cd_departamento_w);
	if (coalesce(cd_departamento_w,'NULL') <> 'NULL') then
		r_add_transfer_data_w.department	:= cd_departamento_w;
	end if;
	
	reg_integracao_w.nm_tabela 	:= 'UNIDADE_ATENDIMENTO';
	
	begin
	select	nm_leito_integracao
	into STRICT	nm_leito_integracao_w
	from	unidade_atendimento
	where	cd_setor_atendimento = c03_w.cd_setor_atendimento
	and	cd_unidade_basica = c03_w.cd_unidade_basica
	and	cd_unidade_compl = c03_w.cd_unidade_compl
	and	(nm_leito_integracao IS NOT NULL AND nm_leito_integracao::text <> '');
	exception
	when others then
		begin
		--Se a unidade for uma unidade virtual no Tasy, nao enecessario enviar para o ISH.
		if (ish_pat_case_pck.obter_se_sem_acomod(c03_w.cd_setor_atendimento,c03_w.cd_unidade_basica, c03_w.cd_unidade_compl) = 'N') then
			reg_integracao_w.nm_tabela	:= 'ATEND_PACIENTE_UNIDADE';
			intpd_processar_atrib_envio(reg_integracao_w, 'CD_UNIDADE_BASICA', 'room', 'N', c03_w.cd_unidade_basica, 'S', r_add_transfer_data_w.room);
			intpd_processar_atrib_envio(reg_integracao_w, 'CD_UNIDADE_COMPL', 'bed', 'N', c03_w.cd_unidade_compl, 'S', r_add_transfer_data_w.bed);
		end if;
		nm_leito_integracao_w	:=	null;
		end;
	end;
	
	if (position(current_setting('ish_pat_case_pck.ds_separador_w')::varchar(10) in nm_leito_integracao_w) > 0) then
		intpd_processar_atrib_envio(reg_integracao_w, 'NM_LEITO_INTEGRACAO', 'room', 'N', obter_valor_campo_separador(nm_leito_integracao_w,1,current_setting('ish_pat_case_pck.ds_separador_w')::varchar(10)), 'N', r_add_transfer_data_w.room);
		intpd_processar_atrib_envio(reg_integracao_w, 'NM_LEITO_INTEGRACAO', 'bed', 'N', obter_valor_campo_separador(nm_leito_integracao_w,2,current_setting('ish_pat_case_pck.ds_separador_w')::varchar(10)), 'N', r_add_transfer_data_w.bed);
	else		
		intpd_processar_atrib_envio(reg_integracao_w, 'NM_LEITO_INTEGRACAO', 'bed', 'N', nm_leito_integracao_w, 'N', r_add_transfer_data_w.bed);
	end if;
		
	reg_integracao_w.nm_tabela 	:= 'ATEND_PACIENTE_UNIDADE';
	intpd_processar_atrib_envio(reg_integracao_w, 'NR_SEQ_INTERNO', 'extmovementid', 'N', c03_w.nr_seq_interno, 'N', r_add_transfer_data_w.extmovementid);
	
	if (atepacu_ant_w.nr_seq_interno IS NOT NULL AND atepacu_ant_w.nr_seq_interno::text <> '') then
		begin
		if (coalesce(c03_w.cd_departamento, 0) <> coalesce(atepacu_ant_w.cd_departamento, 0)) then
			r_add_transfer_data_w.movemnttype	:=	'F';
		elsif (c03_w.cd_setor_atendimento <> atepacu_ant_w.cd_setor_atendimento) then
			r_add_transfer_data_w.movemnttype	:=	'S';
		elsif	((c03_w.cd_unidade_basica <> atepacu_ant_w.cd_unidade_basica) or (c03_w.cd_unidade_compl <> atepacu_ant_w.cd_unidade_compl)) then
			r_add_transfer_data_w.movemnttype	:=	'I';
		elsif (c03_w.nr_seq_classif_esp <> atepacu_ant_w.nr_seq_classif_esp) then
			r_add_transfer_data_w.movemnttype	:=	'W';
		end if;
		end;
	end if;
	r_add_transfer_data_w.respiration	:= ISH_OBTER_TEMPO_RESPIRACAO(c03_w.nr_seq_episodio);
	r_add_transfer_data_w.respirationx	:= 'X';
	exit;
	end;
end loop;
close c03;

RETURN NEXT r_add_transfer_data_w;
CALL intpd_gravar_log_fila(reg_integracao_w);
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION ish_pat_case_pck.get_add_transfer_data ( nr_seq_fila_p bigint) FROM PUBLIC;
