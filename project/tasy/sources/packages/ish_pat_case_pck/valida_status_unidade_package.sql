-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


--
-- dblink wrapper to call function ish_pat_case_pck.valida_status_unidade() as an autonomous transaction
--
CREATE EXTENSION IF NOT EXISTS dblink;

CREATE OR REPLACE PROCEDURE ish_pat_case_pck.valida_status_unidade ( nr_seq_fila_p intpd_fila_transmissao.nr_sequencia%type, reg_integracao_p INOUT gerar_int_padrao.reg_integracao_conv, atend_paciente_unidade_p INOUT atend_paciente_unidade, movemntenddate_p text, movemntendtime_p text, ie_disponivel_p INOUT text) AS $body$
DECLARE
	-- Change this to reflect the dblink connection string
	v_conn_str  text := format('port=%s dbname=%s user=%s', current_setting('port'), current_database(), current_user);
	v_query     text;

BEGIN
	v_query := 'SELECT * FROM ish_pat_case_pck.valida_status_unidade_atx ( ' || quote_nullable(nr_seq_fila_p) || ',' || quote_nullable(reg_integracao_p) || ',' || quote_nullable(atend_paciente_unidade_p) || ',' || quote_nullable(movemntenddate_p) || ',' || quote_nullable(movemntendtime_p) || ',' || quote_nullable(ie_disponivel_p) || ' )';
	SELECT * FROM dblink(v_conn_str, v_query) AS p (v_ret0 gerar_int_padrao.reg_integracao_conv, v_ret1 atend_paciente_unidade, v_ret2 text) INTO reg_integracao_p, atend_paciente_unidade_p, ie_disponivel_p;

END;
$body$ LANGUAGE plpgsql SECURITY DEFINER;




CREATE OR REPLACE PROCEDURE ish_pat_case_pck.valida_status_unidade_atx ( nr_seq_fila_p intpd_fila_transmissao.nr_sequencia%type, reg_integracao_p INOUT gerar_int_padrao.reg_integracao_conv, atend_paciente_unidade_p INOUT atend_paciente_unidade, movemntenddate_p text, movemntendtime_p text, ie_disponivel_p INOUT text) AS $body$
DECLARE


cd_tipo_acomodacao_w	unidade_atendimento.cd_tipo_acomodacao%type;
nr_seq_interno_w	unidade_atendimento.nr_seq_interno%type;
ie_disponivel_w		varchar(1);
dt_saida_unidade_w	timestamp;
unidade_atendimento_w	unidade_atendimento%rowtype;
ie_transf_w		varchar(1);
BEGIN

begin
dt_saida_unidade_w :=	to_date(movemntenddate_p || movemntendtime_p,'yyyy-mm-ddhh24:mi:ss');
exception
when others then
	dt_saida_unidade_w := null;
end;

if (dt_saida_unidade_w > clock_timestamp()) then
	dt_saida_unidade_w	:= null;
end if;

begin
select	'S'
into STRICT	ie_transf_w
from	intpd_fila_transmissao a,
	intpd_eventos_sistema b
where	a.nr_Seq_evento_sistema = b.nr_Sequencia
and	a.nr_sequencia = nr_Seq_fila_p
and	b.ds_action in ('PatcaseGettransfer', 'PatcaseGetinpatadmiss');
exception
when others then
	ie_transf_w	:=	'N';
end;

ie_disponivel_w	:= 'S';

if (coalesce(dt_saida_unidade_w::text, '') = '') then

	select	max(cd_tipo_acomodacao)
	into STRICT	cd_tipo_acomodacao_w
	from	unidade_atendimento
	where	cd_setor_atendimento	= atend_paciente_unidade_p.cd_setor_atendimento
	and	cd_unidade_basica	= atend_paciente_unidade_p.cd_unidade_basica
	and	cd_unidade_compl	= atend_paciente_unidade_p.cd_unidade_compl;

	if (obter_se_sem_acomodacao(cd_tipo_acomodacao_w) <> 'S') then
		begin
		select	'S'
		into STRICT	ie_disponivel_w
		from	unidade_atendimento
		where	cd_setor_atendimento	= atend_paciente_unidade_p.cd_setor_atendimento
		and	cd_unidade_basica	= atend_paciente_unidade_p.cd_unidade_basica
		and	cd_unidade_compl	= atend_paciente_unidade_p.cd_unidade_compl
		and	ie_status_unidade	= 'L'  LIMIT 1;
		exception
		when others then
			begin
			select	'S'
			into STRICT	ie_disponivel_w
			from	unidade_atendimento
			where	cd_setor_atendimento	= atend_paciente_unidade_p.cd_setor_atendimento
			and	cd_unidade_basica	= atend_paciente_unidade_p.cd_unidade_basica
			and	cd_unidade_compl	= atend_paciente_unidade_p.cd_unidade_compl
			and	nr_atendimento		= atend_paciente_unidade_p.nr_atendimento  LIMIT 1;
			exception
			when others then
				ie_disponivel_w := 'N';
			end;	
		end;
	end if;

	if (ie_disponivel_w = 'N') then
		begin
		ie_disponivel_w		:=	'X';
		
		intpd_gravar_log_recebimento(nr_seq_fila_p, obter_desc_expressao(490198), current_setting('ish_pat_case_pck.usernametasy')::varchar(15), null, 'T');
		
		if (ie_transf_w = 'S') then
			begin
			select	*
			into STRICT	unidade_atendimento_w
			from	unidade_atendimento
			where	cd_setor_atendimento = atend_paciente_unidade_p.cd_setor_atendimento
			and	obter_se_sem_acomodacao(cd_tipo_acomodacao) = 'S'
			and	ie_situacao = 'A'  LIMIT 1;
				
			atend_paciente_unidade_p.cd_unidade_basica	:=	unidade_atendimento_w.cd_unidade_basica;
			atend_paciente_unidade_p.cd_unidade_compl	:=	unidade_atendimento_w.cd_unidade_compl;
			
			ie_disponivel_w	:=	'N';
			exception
			when others then
				ie_disponivel_w		:=	'X';
			end;
		end if;
		
		if (ie_disponivel_w = 'X') then
		
			reg_integracao_p.qt_reg_log	:= reg_integracao_p.qt_reg_log + 1;

			update	intpd_fila_transmissao
			set	ie_tipo_erro = 'T'
			where	nr_sequencia = nr_seq_fila_p;
		 end if;
		end;
	end if;
end if;

ie_disponivel_p	:=	ie_disponivel_w;
	
commit;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ish_pat_case_pck.valida_status_unidade ( nr_seq_fila_p intpd_fila_transmissao.nr_sequencia%type, reg_integracao_p INOUT gerar_int_padrao.reg_integracao_conv, atend_paciente_unidade_p INOUT atend_paciente_unidade, movemntenddate_p text, movemntendtime_p text, ie_disponivel_p INOUT text) FROM PUBLIC; -- REVOKE ALL ON PROCEDURE ish_pat_case_pck.valida_status_unidade_atx ( nr_seq_fila_p intpd_fila_transmissao.nr_sequencia%type, reg_integracao_p INOUT gerar_int_padrao.reg_integracao_conv, atend_paciente_unidade_p INOUT atend_paciente_unidade, movemntenddate_p text, movemntendtime_p text, ie_disponivel_p INOUT text) FROM PUBLIC;
