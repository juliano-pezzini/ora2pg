-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION ish_pat_case_pck.get_change_transfer_data ( nr_seq_fila_p bigint) RETURNS SETOF T_CHANGE_TRANSFER_DATA AS $body$
DECLARE

		
r_change_transfer_data_w	r_change_transfer_data;

nr_seq_documento_w	intpd_fila_transmissao.nr_seq_documento%type;
ie_conversao_w		intpd_eventos_sistema.ie_conversao%type;
nr_seq_regra_w		intpd_eventos_sistema.nr_seq_regra_conv%type;

nr_atendimento_w		atendimento_paciente.nr_atendimento%type;
nr_seq_atepacu_w		atend_paciente_unidade.nr_seq_interno%type;

nr_seq_classif_w		classif_pessoa.nr_sequencia%type;
atepacu_ant_w			atend_paciente_unidade%rowtype;
nr_seq_agrup_ant_w		setor_atendimento.nr_seq_agrupamento%type;
nr_seq_agrupamento_w		setor_atendimento.nr_seq_agrupamento%type;
reg_integracao_w		gerar_int_padrao.reg_integracao_conv;

cd_setor_w				varchar(255);
nm_leito_integracao_w	varchar(255);
cd_setor_atendimento_w	varchar(255);

c03 CURSOR FOR
SELECT	a.nr_seq_interno,
	a.nr_seq_motivo_int,
	a.dt_entrada_unidade,
	a.dt_saida_unidade,
	a.cd_tipo_acomodacao,
	a.cd_setor_atendimento,
	a.cd_unidade_basica,
	a.cd_unidade_compl,
	a.nr_seq_unid_ant,	
	a.cd_departamento,
	substr(obter_dados_atepacu(a.nr_seq_interno, 3),1,10) nr_seq_classif_esp
from	atend_paciente_unidade a,
	atendimento_paciente b
where	a.nr_atendimento = b.nr_atendimento
and	a.nr_seq_interno = nr_seq_documento_w;

c03_w	c03%rowtype;


BEGIN
select	a.nr_seq_documento,
	coalesce(b.ie_conversao,'I'),
	b.nr_seq_regra_conv
into STRICT	nr_seq_documento_w,
	ie_conversao_w,	
	nr_seq_regra_w
from	intpd_fila_transmissao a,
	intpd_eventos_sistema b
where	a.nr_seq_evento_sistema = b.nr_sequencia
and	a.nr_sequencia = nr_seq_fila_p;

intpd_reg_integracao_inicio(nr_seq_fila_p, 'E', reg_integracao_w);
reg_integracao_w.ie_somente_alterados		:=	'S';


open c03;
loop
fetch c03 into	
	c03_w;
EXIT WHEN NOT FOUND; /* apply on c03 */
	begin
	reg_integracao_w.nm_tabela 			:=	'ATEND_PACIENTE_UNIDADE';
	reg_integracao_w.nm_elemento			:=	'InpatTransferData';

	begin
	select	*
	into STRICT	atepacu_ant_w
	from	atend_paciente_unidade
	where	nr_seq_interno = c03_w.nr_seq_unid_ant;
	
	select	a.nr_seq_agrupamento		
	into STRICT	nr_seq_agrup_ant_w		
	from	setor_atendimento a		
	where	a.cd_setor_atendimento = atepacu_ant_w.cd_setor_atendimento;
	
	exception
	when others then
		atepacu_ant_w.nr_seq_interno	:=	null;
	end;
	
	intpd_processar_atrib_envio(reg_integracao_w, 'DT_ENTRADA_UNIDADE','movemntdate', 'N', to_char(c03_w.dt_entrada_unidade,'YYYY-MM-DD'), 'N', r_change_transfer_data_w.movemntdate);
	intpd_processar_atrib_envio(reg_integracao_w, 'DT_ENTRADA_UNIDADE','movemnttimex', 'S', to_char(c03_w.dt_entrada_unidade,'YYYY-MM-DD'), 'N', r_change_transfer_data_w.movemnttimex);	
	intpd_processar_atrib_envio(reg_integracao_w, 'NR_SEQ_CLASSIF_ESP','treatmcategory', 'N', c03_w.nr_seq_classif_esp, 'S', r_change_transfer_data_w.treatmcategory);
	intpd_processar_atrib_envio(reg_integracao_w, 'NR_SEQ_CLASSIF_ESP','treatmcategoryx', 'S', c03_w.nr_seq_classif_esp, 'N', r_change_transfer_data_w.treatmcategoryx);	
	
	begin
	intpd_processar_atrib_envio(reg_integracao_w, 'CD_SETOR_ATENDIMENTO','nurstreatou', 'N', c03_w.cd_setor_atendimento, 'N', cd_setor_w);
	
	if (cd_setor_w IS NOT NULL AND cd_setor_w::text <> '') then
		select	a.cd_setor_externo,
			a.nr_seq_agrupamento
			--b.ds_agrupamento
		into STRICT	cd_setor_w,
			nr_seq_agrupamento_w
			--r_change_transfer_data_w.department
		FROM setor_atendimento a
LEFT OUTER JOIN agrupamento_setor b ON (a.nr_seq_agrupamento = b.nr_sequencia)
WHERE a.cd_setor_atendimento = cd_setor_w   LIMIT 1;
		
		r_change_transfer_data_w.nurstreatou	:=	cd_setor_w;
	end if;
	exception
	when others then
		intpd_processar_atrib_envio(reg_integracao_w, 'CD_SETOR_ATENDIMENTO','nurstreatou', 'N',  c03_w.cd_setor_atendimento, 'S', r_change_transfer_data_w.nurstreatou);		
	end;
	
	intpd_processar_atrib_envio(reg_integracao_w, 'CD_SETOR_ATENDIMENTO','nurstreatoux', 'S', c03_w.cd_setor_atendimento, 'N', r_change_transfer_data_w.nurstreatoux);
	
	if (c03_w.cd_departamento IS NOT NULL AND c03_w.cd_departamento::text <> '') then
		intpd_processar_atrib_envio(reg_integracao_w, 'CD_DEPARTAMENTO','department', 'N', c03_w.cd_departamento, 'S', r_change_transfer_data_w.department);
		intpd_processar_atrib_envio(reg_integracao_w, 'CD_DEPARTAMENTO','departmentx', 'S', c03_w.cd_departamento, 'N', r_change_transfer_data_w.departmentx);
	end if;
	
	reg_integracao_w.nm_tabela 	:= 'UNIDADE_ATENDIMENTO';
	
	begin
	select	nm_leito_integracao
	into STRICT	nm_leito_integracao_w
	from	unidade_atendimento
	where	cd_setor_atendimento = c03_w.cd_setor_atendimento
	and	cd_unidade_basica = c03_w.cd_unidade_basica
	and	cd_unidade_compl = c03_w.cd_unidade_compl;
	exception
	when others then
		begin
		intpd_processar_atrib_envio(reg_integracao_w, 'CD_UNIDADE_BASICA','bed', 'N', c03_w.cd_unidade_basica, 'S', r_change_transfer_data_w.bed);			
		intpd_processar_atrib_envio(reg_integracao_w, 'CD_UNIDADE_BASICA','room', 'N', c03_w.cd_unidade_basica, 'S', r_change_transfer_data_w.room);
		end;
		nm_leito_integracao_w	:=	null;
	end;
	
	if (position(current_setting('ish_pat_case_pck.ds_separador_w')::varchar(10) in nm_leito_integracao_w) > 0) then
		intpd_processar_atrib_envio(reg_integracao_w, 'CD_UNIDADE_BASICA','room', 'N', obter_valor_campo_separador(nm_leito_integracao_w,1,current_setting('ish_pat_case_pck.ds_separador_w')::varchar(10)), 'N', r_change_transfer_data_w.room);
		intpd_processar_atrib_envio(reg_integracao_w, 'CD_UNIDADE_BASICA','bed', 'N', obter_valor_campo_separador(nm_leito_integracao_w,2,current_setting('ish_pat_case_pck.ds_separador_w')::varchar(10)), 'N', r_change_transfer_data_w.bed);
	else	
		intpd_processar_atrib_envio(reg_integracao_w, 'CD_UNIDADE_BASICA','bed', 'N', nm_leito_integracao_w, 'N', r_change_transfer_data_w.bed);
	end if;
		
	intpd_processar_atrib_envio(reg_integracao_w, 'CD_UNIDADE_BASICA','bedx', 'S', c03_w.cd_unidade_basica, 'N', r_change_transfer_data_w.bedx);
	intpd_processar_atrib_envio(reg_integracao_w, 'CD_UNIDADE_BASICA','roomx', 'S', c03_w.cd_unidade_basica, 'N', r_change_transfer_data_w.roomx);
	
	reg_integracao_w.nm_tabela 			:=	'ATEND_PACIENTE_UNIDADE';
	
	r_change_transfer_data_w.movemnttype	:=	'X';
	r_change_transfer_data_w.movemnttypex	:=	null;
	
	if (r_change_transfer_data_w.departmentx = 'X') then
		r_change_transfer_data_w.movemnttype	:=	'F';
	elsif (r_change_transfer_data_w.treatmcategoryx = 'X') then
		r_change_transfer_data_w.movemnttype	:=	'W';	
	end if;
	
	if (r_change_transfer_data_w.movemnttype = 'X') then
		r_change_transfer_data_w.movemnttype	:=	null;
	else
		r_change_transfer_data_w.movemnttypex	:=	'X';
	end if;
	
	intpd_processar_atrib_envio(reg_integracao_w, 'NR_SEQ_INTERNO','extmovementid', 'N', c03_w.nr_seq_interno, 'N', r_change_transfer_data_w.extmovementid);
	intpd_processar_atrib_envio(reg_integracao_w, 'NR_SEQ_INTERNO','extmovementidx', 'S', c03_w.nr_seq_interno, 'N', r_change_transfer_data_w.extmovementidx);
	exit;
	end;
end loop;
close c03;

RETURN NEXT r_change_transfer_data_w;
CALL intpd_gravar_log_fila(reg_integracao_w);
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION ish_pat_case_pck.get_change_transfer_data ( nr_seq_fila_p bigint) FROM PUBLIC;
