-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION ish_pat_case_pck.obter_lanr_medic_depto (cd_pessoa_fisica_p text, cd_departamento_p bigint) RETURNS varchar AS $body$
DECLARE

nr_lanr_w	medico_especialidade.nr_rqe%type;

BEGIN

begin --Primeiro busca o codigo refphyslanr do medico com base na especialidade do primeiro departamento do paciente.
select	a.nr_rqe
into STRICT	nr_lanr_w	
from	medico_especialidade a,			
	departamento_medico c,
	departamento_espec d
where	a.cd_pessoa_fisica	= cd_pessoa_fisica_p
and	c.cd_departamento	= cd_departamento_p
and	d.cd_departamento	= c.cd_departamento
and	a.cd_especialidade	= d.cd_especialidade  LIMIT 1;
exception
when others then
	begin --Se nao existe pela especialidade do case, busca o primeiro
	select	a.nr_rqe				
	into STRICT	nr_lanr_w			
	from	medico_especialidade a				
	where	a.cd_pessoa_fisica	= cd_pessoa_fisica_p  LIMIT 1;
	exception
	when others then				
		nr_lanr_w	:= null;
	end;
end;

return nr_lanr_w;
		
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION ish_pat_case_pck.obter_lanr_medic_depto (cd_pessoa_fisica_p text, cd_departamento_p bigint) FROM PUBLIC;
