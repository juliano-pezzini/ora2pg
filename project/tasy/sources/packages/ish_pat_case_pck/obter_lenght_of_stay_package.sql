-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION ish_pat_case_pck.obter_lenght_of_stay (nr_atendimento_p bigint) RETURNS bigint AS $body$
DECLARE


nr_dias_prev_alta_w	atend_previsao_alta.nr_dias_prev_alta%type;
dt_previsto_alta_w	timestamp;
dt_entrada_w		timestamp;

BEGIN

select	max(dt_entrada)
into STRICT	dt_entrada_w
from	atendimento_paciente
where	nr_atendimento	= nr_atendimento_p;

begin
select	a.dt_previsto_alta
into STRICT	dt_previsto_alta_w
from	atend_previsao_alta a
where	a.nr_atendimento	= nr_atendimento_p
and	(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
and	coalesce(a.dt_inativacao::text, '') = ''
and	a.dt_previsto_alta	= 
	(SELECT	max(x.dt_previsto_alta)
	from	atend_previsao_alta x
	where	x.nr_atendimento	= nr_atendimento_p
	and	(x.dt_liberacao IS NOT NULL AND x.dt_liberacao::text <> '')
	and	coalesce(x.dt_inativacao::text, '') = '')  LIMIT 1;
exception
when others then
	dt_previsto_alta_w	:= null;
end;

nr_dias_prev_alta_w	:= trunc(dt_previsto_alta_w) - trunc(dt_entrada_w);

if (nr_dias_prev_alta_w < 0) then
	nr_dias_prev_alta_w	:= null;
end if;

return nr_dias_prev_alta_w;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION ish_pat_case_pck.obter_lenght_of_stay (nr_atendimento_p bigint) FROM PUBLIC;
