-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION ish_pat_case_pck.get_patcase_change_discharge ( nr_seq_fila_p bigint) RETURNS SETOF T_PATCASE_CHANGE_DISCHARGE AS $body$
DECLARE

		
r_patcase_change_discharge_w	r_patcase_change_discharge;

ie_evento_w		intpd_fila_transmissao.ie_evento%type;
ie_conversao_w		intpd_eventos_sistema.ie_conversao%type;
nr_seq_regra_w		intpd_eventos_sistema.nr_seq_regra_conv%type;
nr_atendimento_w	atendimento_paciente.nr_atendimento%type;
cd_estabelecimento_w	estabelecimento.cd_estabelecimento%type;
cd_empresa_w		empresa.cd_empresa%type;
cd_pessoa_fisica_w	pessoa_fisica.cd_pessoa_fisica%type;
nr_submotivo_alta_w	atendimento_paciente.nr_submotivo_alta%type;
reg_integracao_w	gerar_int_padrao.reg_integracao_conv;

dt_geral_w		varchar(255);
cd_motivo_alta_w	varchar(100);

nr_seq_episodio_w   atendimento_paciente.nr_seq_episodio%type;
cd_cgc_indicacao_w	atendimento_paciente.cd_cgc_indicacao%type;
nr_submotivo_param_w	atendimento_paciente.nr_submotivo_alta%type;
ds_observacao_w		atendimento_paciente.ds_observacao%type;
ie_tipo_atendimento_w	atendimento_paciente.ie_tipo_atendimento%type;
ie_tipo_atend_ret_w	atendimento_paciente.ie_tipo_atendimento%type;
dt_atualizacao_w	timestamp;
dt_episodio_w		timestamp;
nr_sequencia_w		bigint;
dt_alta_curativo_w	timestamp;
cd_medico_dest_w	varchar(255);
qt_peso_w		bigint;
qt_altura_w		bigint;
cd_cgc_w		varchar(50);
qt_peso_str_w		varchar(7);
nr_seq_submotivo_w	submotivo_alta.nr_seq_submotivo%type;

c01 CURSOR FOR
SELECT	nr_atendimento,
	cd_motivo_alta,
	(select	max(x.dt_saida_unidade)
	from	atend_paciente_unidade x 
	where	x.nr_atendimento = a.nr_atendimento
	and	x.nr_seq_interno = obter_atepacu_paciente(x.nr_atendimento, 'A')) dt_saida_unidade,
	obter_atepacu_paciente(a.nr_atendimento, 'A') nr_seq_interno,
	nm_usuario_alta_medica,
	cd_pessoa_fisica
from	atendimento_paciente a
where	nr_atendimento = nr_atendimento_w;

c01_w	c01%rowtype;

c02 CURSOR FOR
SELECT	*
from	atend_previsao_alta a
where	a.nr_atendimento	= nr_atendimento_w
and	a.nr_sequencia	=
	(select max(x.nr_sequencia)
	from	 atend_previsao_alta x
	where	 x.nr_atendimento	= a.nr_atendimento
	and	 x.ie_situacao	= 'A'
	and	 (x.dt_liberacao IS NOT NULL AND x.dt_liberacao::text <> ''));
	
c02_w	c02%rowtype;


BEGIN
select	somente_numero(a.nr_seq_documento),
	coalesce(b.ie_conversao,'I'),
	b.nr_seq_regra_conv,
	a.ie_evento
into STRICT	nr_atendimento_w,
	ie_conversao_w,	
	nr_seq_regra_w,	
	ie_evento_w
from	intpd_fila_transmissao a,
	intpd_eventos_sistema b
where	a.nr_seq_evento_sistema = b.nr_sequencia
and	a.nr_sequencia = nr_seq_fila_p;

intpd_reg_integracao_inicio(nr_seq_fila_p, 'E', reg_integracao_w);
reg_integracao_w.ie_somente_alterados		:= 'S';

if (ie_evento_w = '402') then

	open c02;
	loop
	fetch c02 into	
		c02_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */
		begin
		
		reg_integracao_w.nm_tabela 		:= 'ATEND_PREVISAO_ALTA';
		reg_integracao_w.nm_elemento	:= 'InpatDischargeData';
		
		--intpd_processar_atrib_envio(reg_integracao_w, 'CD_MOTIVO_ALTA', 'movemnttype', 'N', 'PLANNED', 'S', r_inpat_discharge_data_w.movemnttype); --OS 1751858
		r_patcase_change_discharge_w.movemntdate	:=	to_char(to_date(c02_w.DT_PREVISTO_ALTA),'yyyy-mm-dd');
		r_patcase_change_discharge_w.movemntdatex	:= 	'X';
		r_patcase_change_discharge_w.movemnttime	:=	to_char(to_date(c02_w.DT_PREVISTO_ALTA),'hh24:mi:ss');
		r_patcase_change_discharge_w.movemnttimex	:= 	'X';
			
		r_patcase_change_discharge_w.statusind	:=	'P'; /*"p" plan or "blank" real*/
		r_patcase_change_discharge_w.statusindx	:=	'X';
				
		r_patcase_change_discharge_w.updatedate	:= 	to_char(to_date(c02_w.dt_atualizacao),'yyyy-mm-dd');
		r_patcase_change_discharge_w.updatedatex	:= 	'X';	

		--intpd_processar_atrib_envio(reg_integracao_w, 'CD_PROFISSIONAL','disphys', 'N', c02_w.CD_PROFISSIONAL, 'S', r_patcase_change_discharge_w.disphys);
		--intpd_processar_atrib_envio(reg_integracao_w, 'CD_PROFISSIONAL','disphysx', 'S', c02_w.CD_PROFISSIONAL, 'N', r_patcase_change_discharge_w.disphysx);		
		
		select	max(nr_sequencia)
		into STRICT	nr_sequencia_w
		from	episodio_paciente
		where	nr_sequencia in (SELECT x.nr_seq_episodio from atendimento_paciente x where x.nr_atendimento = c02_w.nr_atendimento);
		
		r_patcase_change_discharge_w.extmovementid	:= c02_w.nr_sequencia;
		
		reg_integracao_w.nm_tabela 	:= 'EPISODIO_PACIENTE';
		intpd_processar_atrib_envio(reg_integracao_w, 'NR_SEQUENCIA', 'extcaseid', 'N', nr_sequencia_w, 'N', r_patcase_change_discharge_w.extcaseid);						
		
		RETURN NEXT r_patcase_change_discharge_w;	
		end;
	end loop;
	close c02;	

else
	open c01;
	loop
	fetch c01 into	
		c01_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin
		reg_integracao_w.nm_tabela 			:= 'ATENDIMENTO_PACIENTE';
		reg_integracao_w.nm_elemento		:= 'InpatDischargeData';

		select	max(nr_submotivo_alta)
		into STRICT	nr_submotivo_alta_w 
		from	atendimento_paciente 
		where	nr_atendimento = c01_w.nr_atendimento;
		
		cd_motivo_alta_w	:= c01_w.cd_motivo_alta||current_setting('ish_pat_case_pck.ds_separador_w')::varchar(10);
		intpd_processar_atrib_envio(reg_integracao_w, 'CD_MOTIVO_ALTA','movemnttypex', 'S', cd_motivo_alta_w, 'N', r_patcase_change_discharge_w.movemnttypex);		
		if (r_patcase_change_discharge_w.movemnttypex = 'X') then	--Se houve alteracao do motivo de alta, entao busca a conversao.	
			
			reg_integracao_w.ie_somente_alterados := 'N';
			intpd_processar_atrib_envio(reg_integracao_w, 'CD_MOTIVO_ALTA', 'movemnttype', 'N',
				intpd_conv('DISCHARGE_DATA', 'MOVEMNTTYPE', cd_motivo_alta_w, reg_integracao_w.nr_seq_regra_conversao, reg_integracao_w.ie_conversao, 'E'), 'N', r_patcase_change_discharge_w.movemnttype); --OS 1751858
			reg_integracao_w.ie_somente_alterados := 'S';
			
		end if;	
		
		intpd_processar_atrib_envio(reg_integracao_w, 'DT_ALTA','movemntdatex', 'S', c01_w.dt_saida_unidade, 'N', r_patcase_change_discharge_w.movemntdatex);
		if (r_patcase_change_discharge_w.movemntdatex = 'X') then
			dt_geral_w	:= null;
			intpd_processar_atrib_envio(reg_integracao_w, 'DT_ALTA','movemntdate', 'N', c01_w.dt_saida_unidade, 'N', dt_geral_w);
			r_patcase_change_discharge_w.movemntdate	:= to_char(to_date(dt_geral_w),'yyyy-mm-dd');
			intpd_processar_atrib_envio(reg_integracao_w, 'DT_ALTA','movemntdatex', 'S', c01_w.dt_saida_unidade, 'N', r_patcase_change_discharge_w.movemntdatex);
			dt_geral_w	:= null;
			intpd_processar_atrib_envio(reg_integracao_w, 'DT_ALTA','movemnttime', 'N', c01_w.dt_saida_unidade, 'N', dt_geral_w);
			r_patcase_change_discharge_w.movemnttime	:= to_char(to_date(dt_geral_w),'hh24:mi:ss');		
			intpd_processar_atrib_envio(reg_integracao_w, 'DT_ALTA','movemnttimex', 'S', c01_w.dt_saida_unidade, 'N', r_patcase_change_discharge_w.movemnttimex);
		else
			dt_geral_w	:= null;
			intpd_processar_atrib_envio(reg_integracao_w, 'DT_SAIDA_UNIDADE','movemntdate', 'N', c01_w.dt_saida_unidade, 'N', dt_geral_w);
			r_patcase_change_discharge_w.movemntdate	:= to_char(to_date(dt_geral_w),'yyyy-mm-dd');
			intpd_processar_atrib_envio(reg_integracao_w, 'DT_SAIDA_UNIDADE','movemntdatex', 'S', c01_w.dt_saida_unidade, 'N', r_patcase_change_discharge_w.movemntdatex);
			dt_geral_w	:= null;
			intpd_processar_atrib_envio(reg_integracao_w, 'DT_SAIDA_UNIDADE','movemnttime', 'N', c01_w.dt_saida_unidade, 'N', dt_geral_w);
			r_patcase_change_discharge_w.movemnttime	:= to_char(to_date(dt_geral_w),'hh24:mi:ss');		
			intpd_processar_atrib_envio(reg_integracao_w, 'DT_SAIDA_UNIDADE','movemnttimex', 'S', c01_w.dt_saida_unidade, 'N', r_patcase_change_discharge_w.movemnttimex);
		end if;	
		
		intpd_processar_atrib_envio(reg_integracao_w, 'CD_MOTIVO_ALTA','movemntreas1', 'N', c01_w.cd_motivo_alta, 'S', r_patcase_change_discharge_w.movemntreas1);
		intpd_processar_atrib_envio(reg_integracao_w, 'CD_MOTIVO_ALTA','movemntreas1x', 'S', c01_w.cd_motivo_alta, 'N', r_patcase_change_discharge_w.movemntreas1x);
		
		reg_integracao_w.nm_tabela 	:= 'SUBMOTIVO_ALTA';
		begin
		select	max(a.nr_seq_submotivo)
		into STRICT	nr_seq_submotivo_w
		from	submotivo_alta a
		where	a.nr_sequencia = nr_submotivo_alta_w;
		exception
		when others then
			nr_seq_submotivo_w	:= null;
		end;
		
		intpd_processar_atrib_envio(reg_integracao_w, 'NR_SEQ_SUBMOTIVO','movemntreas2', 'N', nr_seq_submotivo_w, 'S', r_patcase_change_discharge_w.movemntreas2);
		intpd_processar_atrib_envio(reg_integracao_w, 'NR_SEQ_SUBMOTIVO','movemntreas2x', 'S', nr_seq_submotivo_w, 'N', r_patcase_change_discharge_w.movemntreas2x);
		
		reg_integracao_w.nm_tabela 	:= 'ATENDIMENTO_PACIENTE';
		r_patcase_change_discharge_w.statusind	:=	null; /*"p" plan or "blank" real*/
		r_patcase_change_discharge_w.statusindx	:=	'X';
		
		select	cd_cgc_indicacao,
			nr_submotivo_alta,
			ie_tipo_atendimento,
			dt_atualizacao,
			nr_seq_episodio
		into STRICT	cd_cgc_indicacao_w,
			nr_submotivo_param_w,
			ie_tipo_atendimento_w,
			dt_atualizacao_w,
			nr_seq_episodio_w
		from	atendimento_paciente
		where	nr_atendimento = c01_w.nr_atendimento;
		
		select	to_char(coalesce(max(dt_episodio),clock_timestamp()),'yyyy-mm-dd'),
			max(nr_sequencia),
			substr(max(ds_observacao),1,30)
		into STRICT	dt_episodio_w,
			nr_sequencia_w,
			ds_observacao_w
		from	episodio_paciente
		where	nr_sequencia in (SELECT x.nr_seq_episodio from atendimento_paciente x where x.nr_atendimento = c01_w.nr_atendimento);
		
		select	max(dt_alta_curativo)
		into STRICT	dt_alta_curativo_w
		from	cur_ferida
		where	nr_atendimento = c01_w.nr_atendimento
		and	(dt_alta_curativo IS NOT NULL AND dt_alta_curativo::text <> '');
		
		reg_integracao_w.nm_tabela	:=	'ATENDIMENTO_PACIENTE';
		--intpd_processar_atrib_envio(reg_integracao_w, 'NR_SUBMOTIVO_ALTA','dischrgdisp', 'N', nr_submotivo_param_w, 'S', r_patcase_change_discharge_w.dischrgdisp);
		--intpd_processar_atrib_envio(reg_integracao_w, 'NR_SUBMOTIVO_ALTA','dischrgdispx', 'S', nr_submotivo_param_w, 'N', r_patcase_change_discharge_w.dischrgdispx);	
		
		intpd_processar_atrib_envio(reg_integracao_w, 'IE_TIPO_ATENDIMENTO','emergadm', 'N', ie_tipo_atendimento_w, 'N', ie_tipo_atend_ret_w);
		if (ie_tipo_atend_ret_w = 3) then
			r_patcase_change_discharge_w.emergadm	:= 'X';
			intpd_processar_atrib_envio(reg_integracao_w, 'IE_TIPO_ATENDIMENTO','emergadmx', 'S', ie_tipo_atend_ret_w, 'N', r_patcase_change_discharge_w.emergadmx);	
		end if;
		
		dt_geral_w	:= null;
		intpd_processar_atrib_envio(reg_integracao_w, 'DT_ATUALIZACAO','updatedate', 'N', dt_atualizacao_w, 'N', dt_geral_w);
		r_patcase_change_discharge_w.updatedate	:= to_char(to_date(dt_geral_w),'yyyy-mm-dd');
		intpd_processar_atrib_envio(reg_integracao_w, 'DT_ATUALIZACAO','updatedatex', 'S', dt_atualizacao_w, 'N', r_patcase_change_discharge_w.updatedatex);
		
		reg_integracao_w.nm_tabela 	:= 'ATENDIMENTO_TRANSF';
		
		intpd_processar_atrib_envio(reg_integracao_w, 'CD_CGC', 'refhospital', 'N', null, 'N', cd_cgc_w);
		if (coalesce(cd_cgc_w,'NULL') <> 'NULL') then
			r_patcase_change_discharge_w.refhospital	:= lpad(ltrim(cd_cgc_w,'0'),10,'0');
		end if;
		intpd_processar_atrib_envio(reg_integracao_w, 'CD_CGC','refhospitalx', 'S', null, 'N', r_patcase_change_discharge_w.refhospitalx);
		
		reg_integracao_w.nm_tabela	:=	'EPISODIO_PACIENTE';
		intpd_processar_atrib_envio(reg_integracao_w, 'DT_EPISODIO','startdate', 'N', dt_episodio_w, 'N', r_patcase_change_discharge_w.startdate);
		intpd_processar_atrib_envio(reg_integracao_w, 'DT_EPISODIO','startdatex', 'S', dt_episodio_w, 'N', r_patcase_change_discharge_w.startdatex);
		intpd_processar_atrib_envio(reg_integracao_w, 'NR_SEQUENCIA','extcaseid', 'N', nr_sequencia_w, 'N', r_patcase_change_discharge_w.extcaseid);
		intpd_processar_atrib_envio(reg_integracao_w, 'NR_SEQUENCIA','extcaseidx', 'S', nr_sequencia_w, 'N', r_patcase_change_discharge_w.extcaseidx);
		intpd_processar_atrib_envio(reg_integracao_w, 'DS_OBSERVACAO','casecomment', 'N', ds_observacao_w, 'N', r_patcase_change_discharge_w.casecomment);
		intpd_processar_atrib_envio(reg_integracao_w, 'DS_OBSERVACAO','casecommentx', 'S', ds_observacao_w, 'N', r_patcase_change_discharge_w.casecommentx);
		
		reg_integracao_w.nm_tabela	:=	'CUR_FERIDA';
		intpd_processar_atrib_envio(reg_integracao_w, 'DT_ALTA_CURATIVO','healeddate', 'N', dt_alta_curativo_w, 'N', dt_geral_w);
		r_patcase_change_discharge_w.healeddate	:=	to_char(to_date(dt_geral_w),'yyyy-mm-dd');
		intpd_processar_atrib_envio(reg_integracao_w, 'DT_ALTA_CURATIVO','healeddatex', 'S', dt_alta_curativo_w, 'N', r_patcase_change_discharge_w.healeddatex);
		intpd_processar_atrib_envio(reg_integracao_w, 'NM_USUARIO', 'updateuser', 'N', ish_param_pck.get_nm_usuario, 'N', r_patcase_change_discharge_w.updateuser);
		r_patcase_change_discharge_w.updateuserx	:= 'X';
		
	--	r_patcase_change_discharge_w.refpsttrttype	:=	intpd_conv('CLASSIFICACAO_ATENDIMENTO','NR_SEQUENCIA', c01_w.nr_seq_classificacao, nr_seq_regra_w, ie_conversao_w, 'E'); /*only need to outpatient process. 116 billing regulation. it is a catalog. treatment type.*/
	--	r_patcase_change_discharge_w.refpsttrttypex	:=	'X';
	--	r_patcase_change_discharge_w.emergadmx		:= 	'X';
	--	r_patcase_change_discharge_w.workincapacity	:=	
	--	r_patcase_change_discharge_w.workincapacityx	:=	'X';
	--	r_patcase_change_discharge_w.movemntreas2	:=	
	--	r_patcase_change_discharge_w.movemntreas2x	:=	'X';
	--	r_patcase_change_discharge_w.respiration	:=	null;
	--	r_patcase_change_discharge_w.respirationx	:=	'X';	
		reg_integracao_w.nm_tabela	:=	'ATEND_PACIENTE_UNIDADE';
		intpd_processar_atrib_envio(reg_integracao_w, 'NR_SEQ_INTERNO','extmovementid', 'N', c01_w.nr_seq_interno, 'N', r_patcase_change_discharge_w.extmovementid);
		intpd_processar_atrib_envio(reg_integracao_w, 'NR_SEQ_INTERNO','extmovementidx', 'S', c01_w.nr_seq_interno, 'N', r_patcase_change_discharge_w.extmovementidx);
		
		select	max(a.cd_medico_dest)
		into STRICT	cd_medico_dest_w
		from	atendimento_alta a, parametro_medico p
		where	nr_atendimento = c01_w.nr_atendimento
		and     p.cd_estabelecimento = obter_estabelecimento_ativo
		and 	((a.ie_tipo_orientacao <> 'P')
		or (coalesce(p.ie_liberar_desfecho,'N')  = 'N')
		or  	((a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '') and (coalesce(a.dt_inativacao::text, '') = '')));
		
		reg_integracao_w.nm_tabela	:=	'ATENDIMENTO_ALTA';
		intpd_processar_atrib_envio(reg_integracao_w, 'CD_MEDICO_DEST','postdisphys', 'N', cd_medico_dest_w, 'ISH', r_patcase_change_discharge_w.postdisphys);
		intpd_processar_atrib_envio(reg_integracao_w, 'CD_MEDICO_DEST','postdisphysx', 'S', cd_medico_dest_w, 'N', r_patcase_change_discharge_w.postdisphysx);
		
		reg_integracao_w.nm_tabela	:=	'ATENDIMENTO_PACIENTE';
		--intpd_processar_atrib_envio(reg_integracao_w, 'NM_USUARIO_ALTA_MEDICA','disphys', 'N', c01_w.nm_usuario_alta_medica, 'S', r_patcase_change_discharge_w.disphys);
		--intpd_processar_atrib_envio(reg_integracao_w, 'NM_USUARIO_ALTA_MEDICA','disphysx', 'S', c01_w.nm_usuario_alta_medica, 'N', r_patcase_change_discharge_w.disphysx);
		
		select	max(qt_peso),
			max(qt_altura_cm)
		into STRICT	qt_peso_w,
			qt_altura_w
		from	pessoa_fisica
		where	cd_pessoa_fisica = c01_w.cd_pessoa_fisica;
		
		intpd_processar_atrib_envio(reg_integracao_w, 'QT_PESO','patweight', 'N', qt_peso_w, 'N', qt_peso_str_w);
		r_patcase_change_discharge_w.patweight	:=	replace(qt_peso_str_w,',','.');
		intpd_processar_atrib_envio(reg_integracao_w, 'QT_PESO','patweightx', 'S', qt_peso_w, 'N', r_patcase_change_discharge_w.patweightx);
		intpd_processar_atrib_envio(reg_integracao_w, 'QT_ALTURA','patheight', 'N', qt_altura_w, 'S', r_patcase_change_discharge_w.patheight);
		intpd_processar_atrib_envio(reg_integracao_w, 'QT_ALTURA','patheightx', 'S', qt_altura_w, 'N', r_patcase_change_discharge_w.patheightx);
		--r_patcase_change_discharge_w.weightunit		:= 'kg';
		r_patcase_change_discharge_w.weightunitiso	:= 'KGM'; --OS 1956899
		r_patcase_change_discharge_w.weightunitx		:= 'X';
		--r_patcase_change_discharge_w.heightunit		:= 'cm';
		r_patcase_change_discharge_w.heightunitiso	:= 'CMT'; --OS 1956899
		r_patcase_change_discharge_w.heightunitx		:= 'X';
	
		r_patcase_change_discharge_w.respiration		:=	ish_obter_tempo_respiracao(nr_seq_episodio_w);
		r_patcase_change_discharge_w.respirationx		:=	'X';
		
		RETURN NEXT r_patcase_change_discharge_w;	
		end;
	end loop;
	close c01;
end if;
CALL intpd_gravar_log_fila(reg_integracao_w);
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION ish_pat_case_pck.get_patcase_change_discharge ( nr_seq_fila_p bigint) FROM PUBLIC;
