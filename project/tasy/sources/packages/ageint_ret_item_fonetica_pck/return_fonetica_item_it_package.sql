-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION ageint_ret_item_fonetica_pck.return_fonetica_item_it (NR_SEQ_GRUPO_P bigint ,DS_ITEM_P text ,IE_UTILIZA_DESC_PACOTE_P text ,IE_PACOTE_P text ,CD_CONVENIO_P bigint ,CD_ESTABELECIMENTO_P bigint ,IE_SADT_P text ,CD_CATEGORIA_P text ,CD_PLANO_P text) RETURNS SETOF LS_ITEM_GRUPO_TABLE_IT AS $body$
DECLARE


	TABLE_ITEM_IT ITEM_GRUPO_TYPE_IT;
	qt_local_v bigint;
	EXIBE_ITEM_V varchar(1) := 'S';
	DS_ITEM_FONETICA_V varchar(2000) := gera_fonetica(DS_ITEM_P,'S');
	
	C02_FONETICA_IT CURSOR FOR
	SELECT 	a.nr_sequencia cd,
		substr(coalesce(coalesce(a.nm_curto,(coalesce(b.ds_proc_exame,coalesce(SUBSTR(obter_nome_pf(a.cd_medico),1,255),coalesce(c.ds_especialidade,e.ds_grupo_proc))))),' '),1,255) ds,
		'N' ie_pacote,
		a.ds_observacao ds_observacao,
		a.nr_seq_grupo,
		a.nr_seq_apres,
		a.cd_medico cd_medico,
		a.nr_seq_proc_interno,
		a.ie_localiza_prof,
		a.cd_especialidade,
		a.nr_seq_topografia
	FROM agenda_int_grupo_item a
LEFT OUTER JOIN proc_interno b ON (a.nr_seq_proc_interno = b.nr_sequencia)
LEFT OUTER JOIN especialidade_medica c ON (a.cd_especialidade = c.cd_especialidade)
LEFT OUTER JOIN ageint_grupo_proc e ON (a.nr_seq_grupo_proc = e.nr_sequencia)
WHERE a.nr_seq_grupo = NR_SEQ_GRUPO_P
	
union

	SELECT	distinct a.nr_seq_pacote cd,
		substr(CASE WHEN IE_UTILIZA_DESC_PACOTE_P='S' THEN Obter_Desc_Pacote_Acomod(a.nr_seq_pacote)  ELSE c.ds_procedimento END ,1,254) ds,
		'S' ie_pacote,
		a.ds_observacao ds_observacao,
		999 nr_seq_grupo,
		999 nr_seq_apres,
		null cd_medico,
		null nr_seq_proc_interno,
		null ie_localiza_prof,
		null cd_especialidade,
		null nr_seq_topografia
	from	pacote a, 
		pacote_tipo_acomodacao b, 
		procedimento c 
	where	a.nr_seq_pacote = b.nr_seq_pacote 
	and	a.cd_proced_pacote = c.cd_procedimento 
	and	a.ie_origem_proced = c.ie_origem_proced 
	and	IE_PACOTE_P	= 'S'
	and	NR_SEQ_GRUPO_P	= 0
	and	a.cd_convenio     = CD_CONVENIO_P
	and	a.ie_situacao     = 'A' 
	and     a.cd_estabelecimento = CD_ESTABELECIMENTO_P
	and	exists (select 1 FROM tipo_acomodacao x
LEFT OUTER JOIN ageint_tipo_acomod_padrao y ON (x.cd_tipo_acomodacao = y.cd_tipo_acomodacao)
WHERE x.ie_classificacao = b.ie_tipo_acomod ) 
	and     (((exists (select 1 from proc_interno w where w.nr_sequencia = b.nr_seq_proc_interno and w.ie_tipo_util = 'E'))  and (IE_SADT_P = 'S')) or (IE_SADT_P = 'N')) 
	and 	   coalesce(b.dt_vigencia,clock_timestamp()) = (select 	max(coalesce(c.dt_vigencia, clock_timestamp())) 
							   from 	pacote_tipo_acomodacao c 
							   where    	c.nr_seq_pacote = a.nr_seq_pacote 
							   and        c.ie_tipo_acomod	= b.ie_tipo_acomod) 
	 and ((coalesce(cd_categoria, CD_CATEGORIA_P) = CD_CATEGORIA_P) or (coalesce(CD_CATEGORIA_P::text, '') = ''))
	 and ((coalesce(cd_plano, CD_PLANO_P) = CD_PLANO_P) or (coalesce(CD_PLANO_P::text, '') = ''))
	order by nr_seq_grupo, nr_seq_apres, ds;

	
BEGIN
		open C02_FONETICA_IT;
			loop
			  fetch C02_FONETICA_IT into
				TABLE_ITEM_IT.CD 						,
				TABLE_ITEM_IT.DS 						,
				TABLE_ITEM_IT.IE_PACOTE 				,
				TABLE_ITEM_IT.DS_OBSERVACAO 			,
				TABLE_ITEM_IT.NR_SEQ_GRUPO 			,
				TABLE_ITEM_IT.NR_SEQ_APRES 			,
				TABLE_ITEM_IT.CD_MEDICO 				,
				TABLE_ITEM_IT.NR_SEQ_PROC_INTERNO 	,
				TABLE_ITEM_IT.IE_LOCALIZA_PROF 		,
				TABLE_ITEM_IT.CD_ESPECIALIDADE 		,
				TABLE_ITEM_IT.NR_SEQ_TOPOGRAFIA 		;
				EXIT WHEN NOT FOUND; /* apply on C02_FONETICA_IT */
				BEGIN	
					EXIBE_ITEM_V := ageint_ret_item_fonetica_pck.valida_exibicao_item(DS_ITEM_P, TABLE_ITEM_IT.DS, TABLE_ITEM_IT.NR_SEQ_PROC_INTERNO, DS_ITEM_FONETICA_V);
				
					IF (EXIBE_ITEM_V = 'S') THEN
						RETURN NEXT TABLE_ITEM_IT;
					END IF;
				END;
			END LOOP;
		CLOSE C02_FONETICA_IT;

		RETURN;

	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION ageint_ret_item_fonetica_pck.return_fonetica_item_it (NR_SEQ_GRUPO_P bigint ,DS_ITEM_P text ,IE_UTILIZA_DESC_PACOTE_P text ,IE_PACOTE_P text ,CD_CONVENIO_P bigint ,CD_ESTABELECIMENTO_P bigint ,IE_SADT_P text ,CD_CATEGORIA_P text ,CD_PLANO_P text) FROM PUBLIC;
