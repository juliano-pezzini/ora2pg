-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION ageint_ret_item_fonetica_pck.return_fonetica_item_section (NR_SEQ_AREA_P bigint ,DS_GRUPO_P text ,CD_PERFIL_P bigint ,CD_PESSOA_FISICA_P text ,CD_SETOR_ATENDIMENTO_P bigint ,CD_ESTABELECIMENTO_P bigint ,DS_ITEM_P text ,IE_PACOTE_P text) RETURNS SETOF LS_ITEM_GRUPO_TABLE_SEC AS $body$
DECLARE


	TABLE_FON_IT_SEC ITEM_GRUPO_TYPE_SEC;
	qt_local_v bigint;
	EXIBE_ITEM_V varchar(1) := 'S';
	DS_ITEM_FONETICA_V varchar(2000) := gera_fonetica(DS_ITEM_P,'S');
	
	C01_FONETICA_SEC CURSOR FOR
	SELECT 	a.nr_sequencia nr_seq_grupo,
		coalesce(a.nm_curto, a.ds_grupo) ds_grupo,
		a.nr_seq_apres,
		'N' ie_pacote,
	  coalesce(ie_collapsed,'N') ie_collapsed
	from 	agenda_int_grupo a
	where 	coalesce(Ageint_Obter_Se_Grupo_Perm(a.nr_sequencia, CD_PERFIL_P, CD_PESSOA_FISICA_P, CD_SETOR_ATENDIMENTO_P, CD_ESTABELECIMENTO_P),'S') = 'S'
	and 	a.nr_seq_area = NR_SEQ_AREA_P
	and 	coalesce(a.ie_pacote, 'N') = 'N'
	and 	exists (SELECT 1 from agenda_int_grupo_item b where a.nr_sequencia = b.nr_seq_grupo)
	and 	coalesce(a.ie_situacao,'A') = 'A'
	AND (coalesce(DS_GRUPO_P::text, '') = '' OR UPPER(coalesce(a.nm_curto, a.ds_grupo)) LIKE UPPER('%'||DS_GRUPO_P||'%'))
	
union

	select	0 nr_seq_grupo,
		wheb_mensagem_pck.get_texto(82844) ds_grupo,
		999 nr_seq_apres,
		'S' ie_pacote,
	  coalesce('S','N') ie_collapsed
	
	where	IE_PACOTE_P = 'S'
	order by nr_seq_apres;

	
BEGIN
	
		qt_local_v := ageint_ret_item_fonetica_pck.return_cad_local();
	
			open C01_FONETICA_SEC;
			  loop
			  fetch C01_FONETICA_SEC into
				TABLE_FON_IT_SEC.NR_SEQ_GRUPO,
				TABLE_FON_IT_SEC.DS_GRUPO,
				TABLE_FON_IT_SEC.NR_SEQ_APRES,
				TABLE_FON_IT_SEC.IE_PACOTE,
				TABLE_FON_IT_SEC.IE_COLLAPSED;
				EXIT WHEN NOT FOUND; /* apply on C01_FONETICA_SEC */
				BEGIN
        RAISE NOTICE 'DS_ITEM_P: % DS_ITEM_FONETICA_V: % grupo: % area: %', DS_ITEM_P, DS_ITEM_FONETICA_V, TABLE_FON_IT_SEC.NR_SEQ_GRUPO, NR_SEQ_AREA_P;
					EXIBE_ITEM_V := ageint_ret_item_fonetica_pck.valida_exibicao_item_section(DS_ITEM_P, DS_ITEM_FONETICA_V, TABLE_FON_IT_SEC.NR_SEQ_GRUPO, NR_SEQ_AREA_P);
				
					IF (EXIBE_ITEM_V = 'S' or TABLE_FON_IT_SEC.IE_PACOTE = 'S') THEN
						RETURN NEXT TABLE_FON_IT_SEC;
					END IF;
				END;
			END LOOP;
		RETURN;

	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION ageint_ret_item_fonetica_pck.return_fonetica_item_section (NR_SEQ_AREA_P bigint ,DS_GRUPO_P text ,CD_PERFIL_P bigint ,CD_PESSOA_FISICA_P text ,CD_SETOR_ATENDIMENTO_P bigint ,CD_ESTABELECIMENTO_P bigint ,DS_ITEM_P text ,IE_PACOTE_P text) FROM PUBLIC;
