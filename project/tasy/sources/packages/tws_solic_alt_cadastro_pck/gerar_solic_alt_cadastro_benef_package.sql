-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE tws_solic_alt_cadastro_pck.gerar_solic_alt_cadastro_benef ( nr_seq_segurado_p pls_segurado.nr_sequencia%type, ds_valor_old_p tasy_solic_alt_campo.ds_valor_old%type, ds_valor_new_p tasy_solic_alt_campo.ds_valor_new%type, nm_atributo_p tasy_solic_alt_campo.nm_atributo%type, nm_tabela_p tabela_sistema.nm_tabela%type, ie_tipo_login_solic_p tasy_solic_alt_campo.ie_tipo_login_solic%type, ie_tipo_complemento_p compl_pessoa_fisica.ie_tipo_complemento%type, nm_usuario_p text, ie_commit_p text) AS $body$
DECLARE


/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade:
Gerar a solicitacao de alteracao cadastral do beneficiario.
-------------------------------------------------------------------------------------------------------------------
Locais de chamada direta: 
[  ]  Objetos do dicionario [ ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatorios [ x] Outros: TWS
 ------------------------------------------------------------------------------------------------------------------
Pontos de atencao:
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
nr_seq_solicitacao_w		tasy_solic_alteracao.nr_sequencia%type;
nr_seq_solic_alt_campo_w	tasy_solic_alt_campo.nr_sequencia%type;
cd_pessoa_fisica_w		pessoa_fisica.cd_pessoa_fisica%type;
cd_estabelecimento_w		estabelecimento.cd_estabelecimento%type;
nr_seq_contrato_w		pls_contrato.nr_sequencia%type;
ds_chave_simples_w		tasy_solic_alt_campo.ds_chave_simples%type;
ds_chave_composta_w		tasy_solic_alt_campo.ds_chave_composta%type;
qt_alteracoes_w			integer;


BEGIN

select	cd_pessoa_fisica,
	cd_estabelecimento,
	nr_seq_contrato
into STRICT	cd_pessoa_fisica_w,
	cd_estabelecimento_w,
	nr_seq_contrato_w
from	pls_segurado
where	nr_sequencia	= nr_seq_segurado_p;

select	max(a.nr_sequencia)
into STRICT	nr_seq_solicitacao_w
from	tasy_solic_alteracao a,
	tasy_solic_alt_campo b
where	a.nr_sequencia 	= b.nr_seq_solicitacao
and	nm_tabela	= nm_tabela_p
and	nm_atributo	= nm_atributo_p
and	ds_valor_old	= ds_valor_old_p
and	ds_valor_new	= ds_valor_new_p
and	coalesce(dt_analise::text, '') = ''
and (b.ds_chave_simples = cd_pessoa_fisica_w
or (substr(b.ds_chave_composta, 1, CASE WHEN(position('#@#@' in b.ds_chave_composta)-1)=-1 THEN  length(b.ds_chave_composta)  ELSE (position('#@#@' in b.ds_chave_composta)-1) END ) =
	'CD_PESSOA_FISICA='||cd_pessoa_fisica_w));

if (coalesce(nr_seq_solicitacao_w::text, '') = '') then	
	select	max(a.nr_sequencia)
	into STRICT	nr_seq_solicitacao_w
	from	tasy_solic_alteracao a,
		tasy_solic_alt_campo b
	where	coalesce(a.dt_analise::text, '') = ''
	and	a.nr_sequencia = b.nr_seq_solicitacao
	and	b.nm_tabela in ('PESSOA_FISICA', 'COMPL_PESSOA_FISICA')
	and (b.ds_chave_simples = cd_pessoa_fisica_w
	or (substr(b.ds_chave_composta, 1, CASE WHEN(position('#@#@' in b.ds_chave_composta)-1)=-1 THEN  length(b.ds_chave_composta)  ELSE (position('#@#@' in b.ds_chave_composta)-1) END ) =
		'CD_PESSOA_FISICA='||cd_pessoa_fisica_w) );

	if (coalesce(nr_seq_solicitacao_w::text, '') = '') then		
		insert into tasy_solic_alteracao(	nr_sequencia, dt_atualizacao, nm_usuario,
							dt_atualizacao_nrec, nm_usuario_nrec, ie_processo,
							ie_tipo_solicitacao, nr_seq_contrato, ie_status,
							nm_usuario_solic_web, cd_estabelecimento, cd_funcao)
					values (	nextval('tasy_solic_alteracao_seq'), clock_timestamp(), nm_usuario_p,
							clock_timestamp(), nm_usuario_p, 'W',
							'B', nr_seq_contrato_w, 'A',
							nm_usuario_p, cd_estabelecimento_w, 1248) returning nr_sequencia into nr_seq_solicitacao_w;
	end if;

	SELECT * FROM tws_solic_alt_cadastro_pck.obter_chaves_tabelas_pf(nm_tabela_p, cd_pessoa_fisica_w, ie_tipo_complemento_p, ds_chave_simples_w, ds_chave_composta_w) INTO STRICT ds_chave_simples_w, ds_chave_composta_w;

	insert into tasy_solic_alt_campo(	nr_sequencia, nm_tabela, nm_atributo,
						ds_chave_simples, ds_chave_composta, nr_seq_solicitacao,
						ie_status, ds_valor_old, ds_valor_new,
						dt_atualizacao, nm_usuario, dt_atualizacao_nrec, 
						nm_usuario_nrec, ie_tipo_login_solic)
				values (	nextval('tasy_solic_alt_campo_seq'), upper(nm_tabela_p), upper(nm_atributo_p),
						ds_chave_simples_w, ds_chave_composta_w, nr_seq_solicitacao_w,
						'P', ds_valor_old_p, ds_valor_new_p,
						clock_timestamp(), nm_usuario_p, clock_timestamp(),
						nm_usuario_p, ie_tipo_login_solic_p) returning nr_sequencia into nr_seq_solic_alt_campo_w;
		
	if (ie_commit_p = 'S') then
		update	pessoa_fisica
		set	ie_revisar		= 'N',
			nm_usuario		= nm_usuario_p,
			dt_atualizacao		= clock_timestamp()
		where	cd_pessoa_fisica 	= cd_pessoa_fisica_w;
		
		CALL pls_gerar_ci_solic_portal_web(4,null,null,null,cd_pessoa_fisica_w,null,nm_usuario_p);
		
		commit;
	end if;
end if;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE tws_solic_alt_cadastro_pck.gerar_solic_alt_cadastro_benef ( nr_seq_segurado_p pls_segurado.nr_sequencia%type, ds_valor_old_p tasy_solic_alt_campo.ds_valor_old%type, ds_valor_new_p tasy_solic_alt_campo.ds_valor_new%type, nm_atributo_p tasy_solic_alt_campo.nm_atributo%type, nm_tabela_p tabela_sistema.nm_tabela%type, ie_tipo_login_solic_p tasy_solic_alt_campo.ie_tipo_login_solic%type, ie_tipo_complemento_p compl_pessoa_fisica.ie_tipo_complemento%type, nm_usuario_p text, ie_commit_p text) FROM PUBLIC;
