-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


/*registro 0175 - endereço do participante*/

CREATE OR REPLACE PROCEDURE fis_sef_edoc_reg_geral_pck.fis_gerar_reg_0175_edoc ( cd_part_p text, nr_seq_superior_p bigint, ie_tipo_pessoa_p text) AS $body$
DECLARE


nr_seq_fis_sef_edoc_0175_w	fis_sef_edoc_0175.nr_sequencia%type;

c_reg_0175 CURSOR FOR
	SELECT	elimina_caracteres_especiais(a.cd_cep)			cd_cep,
		a.ds_endereco						ds_end,
		a.nr_endereco						nr_num_fisica,
		null							nr_num_juridica,
		a.ds_complemento					ds_compl,
		a.ds_bairro						ds_bairro,
		null							cd_cep_cp,
		null							cd_cp,
		substr(elimina_caracteres_telefone(a.nr_ddi_telefone || a.nr_ddd_telefone || a.nr_telefone),1,10) 	nr_fone,
		substr(elimina_caracteres_telefone(a.nr_ddi_fax || a.nr_ddd_fax || a.ds_fax),1,10)			nr_fax
	from	compl_pessoa_fisica a
	where	a.cd_pessoa_fisica	= cd_part_p
	and 	a.ie_tipo_complemento	= 1
	and 	ie_tipo_pessoa_p	= 'F'
	
union all

	SELECT	elimina_caracteres_especiais(a.cd_cep)			cd_cep,
		a.ds_endereco						ds_end,
		null							nr_num_fisica,
		a.nr_endereco						nr_num_juridica,
		a.ds_complemento					ds_compl,
		a.ds_bairro						ds_bairro,
		null							cd_cep_cp,
		null							cd_cp,
		substr(elimina_caracteres_telefone(a.nr_ddi_telefone || a.nr_ddd_telefone || a.nr_telefone),1,10) 	nr_fone,
		substr(elimina_caracteres_telefone(a.nr_ddi_fax || a.nr_ddd_fax || a.nr_fax),1,10)			nr_fax
	from	pessoa_juridica a
	where	a.cd_cgc		= cd_part_p
	and 	ie_tipo_pessoa_p	= 'J';

/*Criação do array com o tipo sendo do cursor eespecificado - c_reg_0175*/

type reg_c_reg_0175 is table of c_reg_0175%RowType;
vetreg0175 reg_c_reg_0175;

BEGIN

open c_reg_0175;
loop
fetch c_reg_0175 bulk collect into vetreg0175 limit 1000;
	for i in 1 .. vetreg0175.Count loop
		begin

		/*Incrementa a variavel para o array*/

		PERFORM set_config('fis_sef_edoc_reg_geral_pck.qt_cursor_0175_w', current_setting('fis_sef_edoc_reg_geral_pck.qt_cursor_0175_w')::bigint + 1, false);

		/*Pega a sequencia da taleba fis_sef_edoc_0175 para o insert*/

		select	nextval('fis_sef_edoc_0175_seq')
		into STRICT	nr_seq_fis_sef_edoc_0175_w
		;

		/*Inserindo valores no array para realização do forall posteriormente*/

		current_setting('fis_sef_edoc_reg_geral_pck.fis_registros_0175_w')::registro_0175(current_setting('fis_sef_edoc_reg_geral_pck.qt_cursor_0175_w')::bigint).nr_sequencia 		:= nr_seq_fis_sef_edoc_0175_w;
		current_setting('fis_sef_edoc_reg_geral_pck.fis_registros_0175_w')::registro_0175(current_setting('fis_sef_edoc_reg_geral_pck.qt_cursor_0175_w')::bigint).dt_atualizacao 		:= clock_timestamp();
		current_setting('fis_sef_edoc_reg_geral_pck.fis_registros_0175_w')::registro_0175(current_setting('fis_sef_edoc_reg_geral_pck.qt_cursor_0175_w')::bigint).nm_usuario 		:= current_setting('fis_sef_edoc_reg_geral_pck.nm_usuario_w')::usuario.nm_usuario%type;
		current_setting('fis_sef_edoc_reg_geral_pck.fis_registros_0175_w')::registro_0175(current_setting('fis_sef_edoc_reg_geral_pck.qt_cursor_0175_w')::bigint).dt_atualizacao_nrec	:= clock_timestamp();
		current_setting('fis_sef_edoc_reg_geral_pck.fis_registros_0175_w')::registro_0175(current_setting('fis_sef_edoc_reg_geral_pck.qt_cursor_0175_w')::bigint).nm_usuario_nrec 		:= current_setting('fis_sef_edoc_reg_geral_pck.nm_usuario_w')::usuario.nm_usuario%type;
		current_setting('fis_sef_edoc_reg_geral_pck.fis_registros_0175_w')::registro_0175(current_setting('fis_sef_edoc_reg_geral_pck.qt_cursor_0175_w')::bigint).cd_reg 			:= '0175';
		current_setting('fis_sef_edoc_reg_geral_pck.fis_registros_0175_w')::registro_0175(current_setting('fis_sef_edoc_reg_geral_pck.qt_cursor_0175_w')::bigint).cd_cep			:= substr(vetreg0175[i].cd_cep,1,8);
		current_setting('fis_sef_edoc_reg_geral_pck.fis_registros_0175_w')::registro_0175(current_setting('fis_sef_edoc_reg_geral_pck.qt_cursor_0175_w')::bigint).ds_end			:= substr(vetreg0175[i].ds_end,1,60);
		current_setting('fis_sef_edoc_reg_geral_pck.fis_registros_0175_w')::registro_0175(current_setting('fis_sef_edoc_reg_geral_pck.qt_cursor_0175_w')::bigint).nr_num			:= coalesce(vetreg0175[i].nr_num_fisica, vetreg0175[i].nr_num_juridica);
		current_setting('fis_sef_edoc_reg_geral_pck.fis_registros_0175_w')::registro_0175(current_setting('fis_sef_edoc_reg_geral_pck.qt_cursor_0175_w')::bigint).ds_compl			:= substr(vetreg0175[i].ds_compl,1,50);
		current_setting('fis_sef_edoc_reg_geral_pck.fis_registros_0175_w')::registro_0175(current_setting('fis_sef_edoc_reg_geral_pck.qt_cursor_0175_w')::bigint).ds_bairro		:= substr(vetreg0175[i].ds_bairro,1,20);
		current_setting('fis_sef_edoc_reg_geral_pck.fis_registros_0175_w')::registro_0175(current_setting('fis_sef_edoc_reg_geral_pck.qt_cursor_0175_w')::bigint).cd_cep_cp		:= vetreg0175[i].cd_cep_cp;
		current_setting('fis_sef_edoc_reg_geral_pck.fis_registros_0175_w')::registro_0175(current_setting('fis_sef_edoc_reg_geral_pck.qt_cursor_0175_w')::bigint).cd_cp			:= vetreg0175[i].cd_cp;
		current_setting('fis_sef_edoc_reg_geral_pck.fis_registros_0175_w')::registro_0175(current_setting('fis_sef_edoc_reg_geral_pck.qt_cursor_0175_w')::bigint).nr_fone			:= vetreg0175[i].nr_fone;
		current_setting('fis_sef_edoc_reg_geral_pck.fis_registros_0175_w')::registro_0175(current_setting('fis_sef_edoc_reg_geral_pck.qt_cursor_0175_w')::bigint).nr_fax			:= vetreg0175[i].nr_fax;
		current_setting('fis_sef_edoc_reg_geral_pck.fis_registros_0175_w')::registro_0175(current_setting('fis_sef_edoc_reg_geral_pck.qt_cursor_0175_w')::bigint).nr_seq_superior		:= nr_seq_superior_p;
		current_setting('fis_sef_edoc_reg_geral_pck.fis_registros_0175_w')::registro_0175(current_setting('fis_sef_edoc_reg_geral_pck.qt_cursor_0175_w')::bigint).nr_seq_controle 		:= current_setting('fis_sef_edoc_reg_geral_pck.nr_seq_controle_w')::fis_sef_edoc_controle.nr_sequencia%type;

		end;
	end loop;
EXIT WHEN NOT FOUND; /* apply on c_reg_0175 */
end loop;
close c_reg_0175;

/*Libera memoria*/

dbms_session.free_unused_user_memory;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE fis_sef_edoc_reg_geral_pck.fis_gerar_reg_0175_edoc ( cd_part_p text, nr_seq_superior_p bigint, ie_tipo_pessoa_p text) FROM PUBLIC;
