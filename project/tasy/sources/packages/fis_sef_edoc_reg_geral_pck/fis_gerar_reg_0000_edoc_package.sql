-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


/*Registro 0000: abertura do arquivo digital e identificação do contribuinte*/

CREATE OR REPLACE PROCEDURE fis_sef_edoc_reg_geral_pck.fis_gerar_reg_0000_edoc () AS $body$
DECLARE


nr_seq_fis_sef_edoc_0000_w	fis_sef_edoc_0000.nr_sequencia%type;


BEGIN

/*Pega a sequencia da taleba fis_sef_edoc_0000 para o insert*/

select	nextval('fis_sef_edoc_0000_seq')
into STRICT	nr_seq_fis_sef_edoc_0000_w
;

insert into fis_sef_edoc_0000(	nr_sequencia,
					dt_atualizacao,
					dt_atualizacao_nrec,
					nm_usuario,
					nm_usuario_nrec,
					cd_reg,
					ds_lfpd,
					dt_ini,
					dt_fin,
					ds_nome,
					cd_cnpj,
					sg_uf,
					nr_ie,
					cd_mun,
					ds_im,
					ds_suframa,
					cd_ver,
					cd_fin,
					cd_cpf,
					ds_fantasia,
					nr_nire,
					cd_ctd,
					ds_pais,
					nr_seq_controle
					)
					SELECT	nr_seq_fis_sef_edoc_0000_w			nr_sequencia,
						clock_timestamp()						dt_atualizacao,
						clock_timestamp()						dt_atualizacao_nrec,
						current_setting('fis_sef_edoc_reg_geral_pck.nm_usuario_w')::usuario.nm_usuario%type					nm_usuario,
						current_setting('fis_sef_edoc_reg_geral_pck.nm_usuario_w')::usuario.nm_usuario%type					nm_usuario_nrec,
						'0000'						cd_reg,
						'LFPD'						ds_lfpd,
						current_setting('fis_sef_edoc_reg_geral_pck.dt_inicio_apuracao_w')::fis_sef_edoc_controle.dt_inicio_apuracao%type				dt_ini,
						current_setting('fis_sef_edoc_reg_geral_pck.dt_fim_apuracao_w')::fis_sef_edoc_controle.dt_fim_apuracao%type				dt_fin,
						substr(c.ds_razao_social, 1, 60)		ds_nome,
						elimina_caracteres_especiais(b.cd_cgc)		cd_cnpj,
						c.sg_estado					sg_uf,
						substr(CASE WHEN upper(c.nr_inscricao_estadual)='ISENTA' THEN  '' WHEN upper(c.nr_inscricao_estadual)='ISENTO' THEN  ''  ELSE elimina_caractere_especial(c.nr_inscricao_estadual) END , 1, 14)	nr_ie,
						elimina_caracteres_especiais(substr(c.cd_municipio_ibge || substr(calcula_digito('MODULO10', c.cd_municipio_ibge),1,1),1,7))		cd_mun,
						b.cd_inscricao_municipal			ds_im,
						null						ds_suframa,
						current_setting('fis_sef_edoc_reg_geral_pck.cd_ver_w')::fis_sef_edoc_controle.cd_ver%type					cd_ver,
						CASE WHEN current_setting('fis_sef_edoc_reg_geral_pck.ie_retificadora_w')::fis_sef_edoc_controle.ie_retificadora%type='N' THEN  0 WHEN current_setting('fis_sef_edoc_reg_geral_pck.ie_retificadora_w')::fis_sef_edoc_controle.ie_retificadora%type='S' THEN 1 END 		cd_fin,
						null						cd_cpf,
						c.nm_fantasia					ds_fantasia,
						b.nr_reg_junta_comercial			nr_nire,
						current_setting('fis_sef_edoc_reg_geral_pck.cd_ctd_w')::fis_sef_edoc_controle.cd_ctd%type					cd_ctd,
						obter_desc_expressao(773486, null)		ds_pais,
						current_setting('fis_sef_edoc_reg_geral_pck.nr_seq_controle_w')::fis_sef_edoc_controle.nr_sequencia%type				nr_seq_controle
					from	estabelecimento b,
						pessoa_juridica c
					where	b.cd_cgc 		= c.cd_cgc
					and	b.cd_estabelecimento 	= current_setting('fis_sef_edoc_reg_geral_pck.cd_estabelecimento_w')::fis_sef_edoc_controle.cd_estabelecimento%type;

commit;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE fis_sef_edoc_reg_geral_pck.fis_gerar_reg_0000_edoc () FROM PUBLIC;
