-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pls_prop_online_agenda_pck.obter_horarios ( dt_entrada_p timestamp, cd_estabelecimento_p pls_solic_prop_on_agenda.cd_estabelecimento%type) RETURNS SETOF T_ITEM AS $body$
DECLARE

					
	line_w				t_item_row;
	qt_agendas_w			pls_solic_prop_on_agenda.qt_agendas%type;
	qt_dias_intervalo_w		pls_solic_prop_on_agenda.qt_dias_intervalo%type;
	nr_dia_semana_w			pls_solic_prop_on_ag_dia.nr_dia_semana%type;
	ds_periodo_w			pls_solic_prop_on_ag_dia.ds_periodo%type;
	nr_seq_solic_prop_on_ag_w	pls_solic_prop_on_ag_dia.nr_seq_solic_prop_on_ag%type;
	qt_retorno_w			bigint;
	dt_agenda_w			timestamp;
	
	
BEGIN
	qt_retorno_w := 0;
	
	select	nr_sequencia,
		qt_agendas,
		coalesce(qt_dias_intervalo,0)
	into STRICT	nr_seq_solic_prop_on_ag_w,
		qt_agendas_w,
		qt_dias_intervalo_w
	from	pls_solic_prop_on_agenda
	where	cd_estabelecimento = cd_estabelecimento_p
	and	dt_entrada_p between dt_inicio_vigencia and coalesce(dt_fim_vigencia, dt_entrada_p);
	
	dt_agenda_w	:= trunc(dt_entrada_p + qt_dias_intervalo_w,'dd');
	
	while(qt_retorno_w < qt_agendas_w) loop
		begin
		if (pls_prop_online_agenda_pck.obter_se_feriado(dt_agenda_w, cd_estabelecimento_p) = 'N') then
			nr_dia_semana_w	:= to_char(dt_agenda_w,'D');
		end if;
		
		select	max(ds_periodo)
		into STRICT	ds_periodo_w
		from	pls_solic_prop_on_ag_dia
		where	nr_seq_solic_prop_on_ag = nr_seq_solic_prop_on_ag_w
		and	nr_dia_semana 		= nr_dia_semana_w;
		
		if (ds_periodo_w IS NOT NULL AND ds_periodo_w::text <> '') then
			line_w.dt_agenda	:= dt_agenda_w;
			line_w.ds_periodo	:= ds_periodo_w;
			RETURN NEXT line_w;
			qt_retorno_w := qt_retorno_w + 1;
		end if;
		
		dt_agenda_w	:= dt_agenda_w + 1;
		end;
	end loop;
	
	return;
	
	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pls_prop_online_agenda_pck.obter_horarios ( dt_entrada_p timestamp, cd_estabelecimento_p pls_solic_prop_on_agenda.cd_estabelecimento%type) FROM PUBLIC;
