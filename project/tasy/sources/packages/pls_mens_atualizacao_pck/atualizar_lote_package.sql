-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_mens_atualizacao_pck.atualizar_lote (nr_seq_lote_p pls_lote_mensalidade.nr_sequencia%type) AS $body$
DECLARE


qt_beneficiarios_w		integer;
vl_mensalidades_w		double precision	:= 0;
vl_pre_estabelecido_w		double precision	:= 0;
vl_pos_estabelecido_w		double precision	:= 0;
vl_coparticipacao_w		double precision	:= 0;
vl_outros_w			double precision	:= 0;
vl_adicionais_w			double precision	:= 0;
vl_cancelado_w			double precision	:= 0;
vl_pro_rata_dia_w		double precision;
vl_antecipacao_w		double precision;


BEGIN

select	sum(vl_pro_rata_dia),
	sum(vl_antecipacao),
	sum(qt_beneficiarios),
	sum(vl_mensalidade),
	sum(vl_pre_estabelecido),
	sum(vl_pos_estabelecido),
	sum(vl_coparticipacao),
	sum(vl_outros),
	sum(vl_adicionais)
into STRICT	vl_pro_rata_dia_w,
	vl_antecipacao_w,
	qt_beneficiarios_w,
	vl_mensalidades_w,
	vl_pre_estabelecido_w,
	vl_pos_estabelecido_w,
	vl_coparticipacao_w,
	vl_outros_w,
	vl_adicionais_w
from	pls_mensalidade
where	nr_seq_lote = nr_seq_lote_p
and	coalesce(ie_cancelamento::text, '') = '';

update	pls_lote_mensalidade
set	vl_lote			= coalesce(vl_mensalidades_w,0),
	vl_pre_estabelecido	= coalesce(vl_pre_estabelecido_w,0),
	vl_pos_estabelecido	= coalesce(vl_pos_estabelecido_w,0),
	vl_coparticipacao	= coalesce(vl_coparticipacao_w,0),
	vl_pro_rata_dia		= coalesce(vl_pro_rata_dia_w,0),
	qt_beneficiario_lote	= qt_beneficiarios_w,
	qt_pagadores_lote	= current_setting('pls_mens_atualizacao_pck.qt_pagadores_total_lote_w')::integer,
	vl_antecipacao		= coalesce(vl_antecipacao_w,0),
	vl_outros		= coalesce(vl_outros_w,0),
	vl_adicionais		= coalesce(vl_adicionais_w,0),
	vl_cancelado		= coalesce(vl_cancelado_w,0)
where	nr_sequencia		= nr_seq_lote_p;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_mens_atualizacao_pck.atualizar_lote (nr_seq_lote_p pls_lote_mensalidade.nr_sequencia%type) FROM PUBLIC;
