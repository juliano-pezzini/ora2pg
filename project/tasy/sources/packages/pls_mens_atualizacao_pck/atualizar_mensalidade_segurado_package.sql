-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_mens_atualizacao_pck.atualizar_mensalidade_segurado () AS $body$
DECLARE

_ora2pg_r RECORD;
qt_itens_w			integer;

--Variaveis para controlar o delete

nr_indice_del_w			integer;
tb_delete_mensalidade_seg_w	pls_util_cta_pck.t_number_table;

--Variaveis para controlar o update

nr_indice_w			integer;
tb_nr_seq_mensalidade_seg_w	pls_util_cta_pck.t_number_table;
tb_vl_mensalidade_w		pls_util_cta_pck.t_number_table;
tb_vl_pre_estabelecido_w	pls_util_cta_pck.t_number_table;
tb_vl_pro_rata_dia_w		pls_util_cta_pck.t_number_table;
tb_vl_antecipacao_w		pls_util_cta_pck.t_number_table;
tb_vl_coparticipacao_w		pls_util_cta_pck.t_number_table;
tb_vl_adicional_w		pls_util_cta_pck.t_number_table;
tb_vl_pos_estabelecido_w	pls_util_cta_pck.t_number_table;

C01 CURSOR FOR
	SELECT	nr_seq_mensalidade_seg
	from	pls_mensalidade_seg_tmp;

BEGIN

nr_indice_w	:= 0;
nr_indice_del_w	:= 0;
tb_delete_mensalidade_seg_w.delete;
tb_nr_seq_mensalidade_seg_w.delete;
SELECT * FROM pls_mens_atualizacao_pck.update_mensalidade_seg(	tb_nr_seq_mensalidade_seg_w, tb_vl_mensalidade_w, tb_vl_pre_estabelecido_w, tb_vl_pro_rata_dia_w, tb_vl_antecipacao_w, tb_vl_coparticipacao_w, tb_vl_adicional_w, tb_vl_pos_estabelecido_w) INTO STRICT _ora2pg_r;
 	tb_nr_seq_mensalidade_seg_w := _ora2pg_r.tb_nr_seq_mensalidade_seg_p; tb_vl_mensalidade_w := _ora2pg_r.tb_vl_mensalidade_p; tb_vl_pre_estabelecido_w := _ora2pg_r.tb_vl_pre_estabelecido_p; tb_vl_pro_rata_dia_w := _ora2pg_r.tb_vl_pro_rata_dia_p; tb_vl_antecipacao_w := _ora2pg_r.tb_vl_antecipacao_p; tb_vl_coparticipacao_w := _ora2pg_r.tb_vl_coparticipacao_p; tb_vl_adicional_w := _ora2pg_r.tb_vl_adicional_p; tb_vl_pos_estabelecido_w := _ora2pg_r.tb_vl_pos_estabelecido_p;

for r_c01_w in C01 loop
	begin
	
	select	count(1)
	into STRICT	qt_itens_w
	from	pls_mensalidade_seg_item
	where	nr_seq_mensalidade_seg	= r_c01_w.nr_seq_mensalidade_seg;
	
	if (qt_itens_w > 0) then
		tb_nr_seq_mensalidade_seg_w(nr_indice_w)	:= r_c01_w.nr_seq_mensalidade_seg;
		
		select	sum(vl_mensalidade),
			sum(vl_pro_rata_dia),
			sum(vl_antecipacao),
			sum(vl_adicional),
			sum(vl_pre_estabelecido),
			sum(vl_coparticipacao),
			sum(vl_pos_estabelecido)
		into STRICT	tb_vl_mensalidade_w(nr_indice_w),
			tb_vl_pro_rata_dia_w(nr_indice_w),
			tb_vl_antecipacao_w(nr_indice_w),
			tb_vl_adicional_w(nr_indice_w),
			tb_vl_pre_estabelecido_w(nr_indice_w),
			tb_vl_coparticipacao_w(nr_indice_w),
			tb_vl_pos_estabelecido_w(nr_indice_w)
		from (
			SELECT	CASE WHEN ie_tipo_mensalidade='P' THEN 0  ELSE sum(vl_item) END  vl_mensalidade,
				CASE WHEN ie_tipo_mensalidade='P' THEN 0  ELSE sum(vl_pro_rata_dia) END  vl_pro_rata_dia,
				CASE WHEN ie_tipo_mensalidade='P' THEN 0  ELSE sum(vl_antecipacao) END  vl_antecipacao,
				CASE WHEN ie_tipo_mensalidade='A' THEN sum(vl_item)  ELSE 0 END  vl_adicional,
				CASE WHEN ie_tipo_item='1' THEN sum(vl_item)  ELSE CASE WHEN ie_tipo_item='5' THEN sum(vl_item)  ELSE CASE WHEN ie_tipo_item='25' THEN sum(vl_item)  ELSE CASE WHEN ie_tipo_item='12' THEN sum(vl_item)  ELSE CASE WHEN ie_tipo_item='41' THEN sum(vl_item)  ELSE CASE WHEN ie_tipo_item='31' THEN sum(vl_item)  ELSE 0 END  END  END  END  END  END  vl_pre_estabelecido,
				CASE WHEN ie_tipo_item='3' THEN sum(vl_item)  ELSE 0 END  vl_coparticipacao,
				CASE WHEN ie_tipo_item='6' THEN sum(vl_item)  ELSE CASE WHEN ie_tipo_item='7' THEN sum(vl_item)  ELSE CASE WHEN ie_tipo_item='8' THEN sum(vl_item)  ELSE 0 END  END  END  vl_pos_estabelecido
			from	pls_mensalidade_seg_item
			where	nr_seq_mensalidade_seg	= r_c01_w.nr_seq_mensalidade_seg
			group by ie_tipo_mensalidade, ie_tipo_item) alias28;
		
		if (coalesce(tb_vl_pre_estabelecido_w(nr_indice_w)::text, '') = '') then
			tb_vl_pre_estabelecido_w(nr_indice_w) := 0;
		end if;
		if (coalesce(tb_vl_pro_rata_dia_w(nr_indice_w)::text, '') = '') then
			tb_vl_pro_rata_dia_w(nr_indice_w) := 0;
		end if;
		if (coalesce(tb_vl_antecipacao_w(nr_indice_w)::text, '') = '') then
			tb_vl_antecipacao_w(nr_indice_w) := 0;
		end if;
		if (coalesce(tb_vl_coparticipacao_w(nr_indice_w)::text, '') = '') then
			tb_vl_coparticipacao_w(nr_indice_w) := 0;
		end if;
		if (coalesce(tb_vl_adicional_w(nr_indice_w)::text, '') = '') then
			tb_vl_adicional_w(nr_indice_w) := 0;
		end if;
		if (coalesce(tb_vl_pos_estabelecido_w(nr_indice_w)::text, '') = '') then
			tb_vl_pos_estabelecido_w(nr_indice_w) := 0;
		end if;
		
		if (nr_indice_w >= pls_util_pck.qt_registro_transacao_w) then
			SELECT * FROM pls_mens_atualizacao_pck.update_mensalidade_seg(	tb_nr_seq_mensalidade_seg_w, tb_vl_mensalidade_w, tb_vl_pre_estabelecido_w, tb_vl_pro_rata_dia_w, tb_vl_antecipacao_w, tb_vl_coparticipacao_w, tb_vl_adicional_w, tb_vl_pos_estabelecido_w) INTO STRICT _ora2pg_r;
 	tb_nr_seq_mensalidade_seg_w := _ora2pg_r.tb_nr_seq_mensalidade_seg_p; tb_vl_mensalidade_w := _ora2pg_r.tb_vl_mensalidade_p; tb_vl_pre_estabelecido_w := _ora2pg_r.tb_vl_pre_estabelecido_p; tb_vl_pro_rata_dia_w := _ora2pg_r.tb_vl_pro_rata_dia_p; tb_vl_antecipacao_w := _ora2pg_r.tb_vl_antecipacao_p; tb_vl_coparticipacao_w := _ora2pg_r.tb_vl_coparticipacao_p; tb_vl_adicional_w := _ora2pg_r.tb_vl_adicional_p; tb_vl_pos_estabelecido_w := _ora2pg_r.tb_vl_pos_estabelecido_p;
		else
			nr_indice_w	:= nr_indice_w + 1;
		end if;
	else
		tb_delete_mensalidade_seg_w(nr_indice_del_w) := r_c01_w.nr_seq_mensalidade_seg;
		
		if (nr_indice_del_w >= current_setting('pls_mens_atualizacao_pck.qt_registro_del_mens_w')::integer) then
			tb_delete_mensalidade_seg_w := pls_mens_atualizacao_pck.deletar_mensalidade_seg(tb_delete_mensalidade_seg_w);
			nr_indice_del_w	:= 0;
		else
			nr_indice_del_w	:= nr_indice_del_w + 1;
		end if;
	end if;
	end;
end loop;

-- se sobrou alguma coisa manda para o banco

tb_delete_mensalidade_seg_w := pls_mens_atualizacao_pck.deletar_mensalidade_seg(tb_delete_mensalidade_seg_w);
SELECT * FROM pls_mens_atualizacao_pck.update_mensalidade_seg(	tb_nr_seq_mensalidade_seg_w, tb_vl_mensalidade_w, tb_vl_pre_estabelecido_w, tb_vl_pro_rata_dia_w, tb_vl_antecipacao_w, tb_vl_coparticipacao_w, tb_vl_adicional_w, tb_vl_pos_estabelecido_w) INTO STRICT _ora2pg_r;
 	tb_nr_seq_mensalidade_seg_w := _ora2pg_r.tb_nr_seq_mensalidade_seg_p; tb_vl_mensalidade_w := _ora2pg_r.tb_vl_mensalidade_p; tb_vl_pre_estabelecido_w := _ora2pg_r.tb_vl_pre_estabelecido_p; tb_vl_pro_rata_dia_w := _ora2pg_r.tb_vl_pro_rata_dia_p; tb_vl_antecipacao_w := _ora2pg_r.tb_vl_antecipacao_p; tb_vl_coparticipacao_w := _ora2pg_r.tb_vl_coparticipacao_p; tb_vl_adicional_w := _ora2pg_r.tb_vl_adicional_p; tb_vl_pos_estabelecido_w := _ora2pg_r.tb_vl_pos_estabelecido_p;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_mens_atualizacao_pck.atualizar_mensalidade_segurado () FROM PUBLIC;
