-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE philips_patrimonio_pck.ratear_depreciacao ( nr_seq_valor_p bigint, nr_seq_crit_rateio_p bigint, ie_rateio_deprec_transf_p text, dt_referencia_p timestamp, nr_seq_bem_p bigint, nm_usuario_p text) AS $body$
DECLARE


cd_conta_contabil_w			varchar(20);
vl_deprec_mes_w				double precision;
vl_diferenca_w				double precision;
vl_rateio_total_w			double precision := 0;
vl_rateio_deprec_w			double precision;
vl_bx_bem_w				double precision;
vl_rateio_bx_bem_w			double precision;
vl_tot_rateio_bx_bem_w			double precision;
vl_dif_baixa_w				double precision;
vl_bx_deprec_bem_w			double precision;
vl_rateio_bx_deprec_w			double precision;
vl_tot_rateio_bx_deprec_w		double precision;
vl_dif_baixa_deprec_w			double precision;
pr_rateio_w				double precision;
nr_sequencia_w				bigint;
cd_centro_custo_w			bigint;
qt_hist_transf_w			bigint;
cd_centro_custo_atual_w			integer;
cd_centro_custo_bem_w			integer;
qt_dias_transf_w			integer;
dt_inicial_w				timestamp;
dt_final_w				timestamp;
dt_historico_ant_w			timestamp;
dt_historico_inicial_w			timestamp;
dt_historico_final_w			timestamp;
qt_dias_mes_w				smallint;
nr_seq_hist_orig_w			pat_historico_bem.nr_sequencia%type;

c01 CURSOR FOR
	SELECT	a.cd_centro_custo,
		coalesce(a.cd_conta_contabil, cd_conta_contabil_w),
		a.pr_rateio
	from	ctb_criterio_rateio_item a
	where	a.nr_seq_criterio = nr_seq_crit_rateio_p;

c02 CURSOR FOR
	SELECT	a.nr_sequencia nr_seq_historico,
		a.dt_historico,
		coalesce(a.cd_centro_custo_ant, cd_centro_custo_bem_w) cd_centro_custo_ant,
		coalesce(a.cd_centro_custo_atual, cd_centro_custo_bem_w) cd_centro_custo_atual
	from	pat_historico_bem	a,
		pat_tipo_historico	b
	where	a.nr_seq_bem		= nr_seq_bem_p
	and	b.nr_sequencia		= a.nr_seq_tipo
	and	b.ie_transferencia	= 'S'
	and	a.dt_historico between dt_inicial_w and dt_final_w
	order by
		a.dt_historico;

c02_w		c02%rowtype;


BEGIN
vl_bx_bem_w			:= 0;
vl_rateio_bx_bem_w		:= 0;
vl_tot_rateio_bx_bem_w		:= 0;
vl_dif_baixa_w			:= 0;
vl_bx_deprec_bem_w		:= 0;
vl_rateio_bx_deprec_w		:= 0;
vl_tot_rateio_bx_deprec_w	:= 0;
vl_dif_baixa_deprec_w		:= 0;

dt_inicial_w		:= trunc(dt_referencia_p, 'mm');
dt_final_w		:= fim_dia(last_day(dt_referencia_p));

select	coalesce(max(a.vl_deprec_mes), 0),
	max(a.cd_centro_custo),
	max(vl_baixa_bem),
	max(vl_baixa_deprec)
into STRICT	vl_deprec_mes_w,
	cd_centro_custo_bem_w,
	vl_bx_bem_w,
	vl_bx_deprec_bem_w
from	pat_valor_bem a
where	nr_sequencia	= nr_seq_valor_p;

select	count(1)
into STRICT	qt_hist_transf_w
from	pat_historico_bem	a,
	pat_tipo_historico	b
where	nr_seq_bem		= nr_seq_bem_p
and	b.nr_sequencia		= a.nr_seq_tipo
and	b.ie_transferencia	= 'S'
and	dt_historico between dt_inicial_w and dt_final_w;

select	cd_conta_deprec_res
-- into	cd_conta_deprec_res_w

into STRICT	cd_conta_contabil_w
from	pat_bem a,
	pat_conta_contabil b
where	b.nr_sequencia = a.nr_seq_regra_conta
and	a.nr_sequencia = nr_seq_bem_p;

if	((nr_seq_crit_rateio_p IS NOT NULL AND nr_seq_crit_rateio_p::text <> '') and
	((qt_hist_transf_w = 0) or
	ie_rateio_deprec_transf_p = 'N'))  then
	open c01;
	loop
	fetch c01 into
		cd_centro_custo_w,
		cd_conta_contabil_w,
		pr_rateio_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin
		if (cd_centro_custo_w IS NOT NULL AND cd_centro_custo_w::text <> '') and (cd_conta_contabil_w IS NOT NULL AND cd_conta_contabil_w::text <> '') then
			begin
			vl_rateio_deprec_w	:= dividir((vl_deprec_mes_w * pr_rateio_w),100);
			vl_rateio_total_w	:= vl_rateio_total_w + vl_rateio_deprec_w;

			vl_rateio_bx_bem_w		:= dividir((vl_bx_bem_w * pr_rateio_w),100);
			vl_tot_rateio_bx_bem_w		:= vl_tot_rateio_bx_bem_w + vl_rateio_bx_bem_w;

			vl_rateio_bx_deprec_w		:= dividir((vl_bx_deprec_bem_w * pr_rateio_w),100);
			vl_tot_rateio_bx_deprec_w	:= vl_tot_rateio_bx_deprec_w + vl_rateio_bx_deprec_w;

			select	nextval('pat_valor_bem_rateio_seq')
			into STRICT	nr_sequencia_w
			;


			insert into pat_valor_bem_rateio(nr_sequencia,
				nr_seq_valor,
				nr_seq_crit_rateio,
				cd_centro_custo,
				cd_conta_contabil,
				vl_rateio_deprec,
				pr_rateio,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				vl_rateio_baixa_bem,
				vl_rateio_baixa_deprec)
			values (nr_sequencia_w,
				nr_seq_valor_p,
				nr_seq_crit_rateio_p,
				cd_centro_custo_w,
				cd_conta_contabil_w,
				vl_rateio_deprec_w,
				pr_rateio_w,
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				vl_rateio_bx_bem_w,
				vl_rateio_bx_deprec_w);

			/* ****************************************************************************
			Movimento de rateio de depreciacao
			***************************************************************************** */

			if (current_setting('philips_patrimonio_pck.ie_gravar_movimento_w')::boolean) then
				begin
				PERFORM set_config('philips_patrimonio_pck.pat_bem_movto_rateio_w', null, false);
				current_setting('philips_patrimonio_pck.pat_bem_movto_rateio_w')::pat_bem_movto_rateio%rowtype.nr_seq_crit_rateio	:= nr_seq_crit_rateio_p;
				current_setting('philips_patrimonio_pck.pat_bem_movto_rateio_w')::pat_bem_movto_rateio%rowtype.cd_centro_custo		:= cd_centro_custo_w;
				current_setting('philips_patrimonio_pck.pat_bem_movto_rateio_w')::pat_bem_movto_rateio%rowtype.vl_rateio		:= vl_rateio_deprec_w;
				current_setting('philips_patrimonio_pck.pat_bem_movto_rateio_w')::pat_bem_movto_rateio%rowtype.pr_rateio		:= pr_rateio_w;

				current_setting('philips_patrimonio_pck.pat_bem_movto_rateio_w')::pat_bem_movto_rateio%rowtype := philips_patrimonio_pck.gerar_movto_bem_rateio('N', nm_usuario_p, current_setting('philips_patrimonio_pck.pat_bem_movto_rateio_w')::pat_bem_movto_rateio%rowtype);
				end;
			end if;
			end;
		end if;
		end;
	end loop;
	close c01;
end if;

if (ie_rateio_deprec_transf_p = 'S') then
	begin
	dt_historico_ant_w := null;
	qt_dias_mes_w := (to_char(last_day(dt_referencia_p),'dd'))::numeric;

	dt_historico_ant_w := trunc(dt_referencia_p,'mm')-1;
	nr_seq_hist_orig_w := null;
	open c02;
	loop
	fetch c02 into
		c02_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */
		begin
		-- if	(dt_historico_ant_w is null) then

			-- dt_historico_inicial_w	:= trunc(c02_w.dt_historico, 'month');

		-- else

			-- dt_historico_inicial_w	:= dt_historico_ant_w;

		-- end if;

		dt_historico_inicial_w := dt_historico_ant_w;

		begin
		qt_dias_transf_w := obter_dias_entre_datas(dt_historico_inicial_w, trunc(c02_w.dt_historico));
		exception
		when others then
			qt_dias_transf_w := 0;
		end;

		vl_rateio_deprec_w	:= (vl_deprec_mes_w / qt_dias_mes_w) * qt_dias_transf_w;
		vl_rateio_total_w	:= vl_rateio_total_w + vl_rateio_deprec_w;

		vl_rateio_bx_bem_w		:= 0;
		vl_tot_rateio_bx_bem_w		:= 0;

		vl_rateio_bx_deprec_w		:= 0;
		vl_tot_rateio_bx_deprec_w	:= 0;

		select	nextval('pat_valor_bem_rateio_seq')
		into STRICT	nr_sequencia_w
		;

		insert into pat_valor_bem_rateio(nr_sequencia,
			nr_seq_valor,
			nr_seq_crit_rateio,
			cd_centro_custo,
			cd_conta_contabil,
			vl_rateio_deprec,
			pr_rateio,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			vl_rateio_baixa_bem,
			vl_rateio_baixa_deprec,
			nr_seq_hist_orig,
			nr_seq_hist_dest
			)
		values (nr_sequencia_w,
			nr_seq_valor_p,
			nr_seq_crit_rateio_p,
			c02_w.cd_centro_custo_ant,
			cd_conta_contabil_w,
			vl_rateio_deprec_w,
			pr_rateio_w,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			vl_rateio_bx_bem_w,
			vl_rateio_bx_deprec_w,
			nr_seq_hist_orig_w,
			c02_w.nr_seq_historico
			);

			/* ****************************************************************************
			Movimento de rateio de depreciacao
			***************************************************************************** */

			if (current_setting('philips_patrimonio_pck.ie_gravar_movimento_w')::boolean) then
				begin
				PERFORM set_config('philips_patrimonio_pck.pat_bem_movto_rateio_w', null, false);
				current_setting('philips_patrimonio_pck.pat_bem_movto_rateio_w')::pat_bem_movto_rateio%rowtype.nr_seq_crit_rateio	:= nr_seq_crit_rateio_p;
				current_setting('philips_patrimonio_pck.pat_bem_movto_rateio_w')::pat_bem_movto_rateio%rowtype.cd_centro_custo		:= coalesce(c02_w.cd_centro_custo_ant,cd_centro_custo_bem_w);
				current_setting('philips_patrimonio_pck.pat_bem_movto_rateio_w')::pat_bem_movto_rateio%rowtype.vl_rateio		:= vl_rateio_deprec_w;
				current_setting('philips_patrimonio_pck.pat_bem_movto_rateio_w')::pat_bem_movto_rateio%rowtype.pr_rateio		:= pr_rateio_w;

				current_setting('philips_patrimonio_pck.pat_bem_movto_rateio_w')::pat_bem_movto_rateio%rowtype := philips_patrimonio_pck.gerar_movto_bem_rateio('N', nm_usuario_p, current_setting('philips_patrimonio_pck.pat_bem_movto_rateio_w')::pat_bem_movto_rateio%rowtype);
				end;
			end if;

		dt_historico_ant_w	:= c02_w.dt_historico;
		cd_centro_custo_atual_w	:= c02_w.cd_centro_custo_atual;
		nr_seq_hist_orig_w := c02_w.nr_seq_historico;
		end;
	end loop;
	close c02;

	if (cd_centro_custo_bem_w IS NOT NULL AND cd_centro_custo_bem_w::text <> '') then
		begin
		if (coalesce(cd_centro_custo_atual_w::text, '') = '') then
			begin
			cd_centro_custo_atual_w := cd_centro_custo_bem_w;
			qt_dias_transf_w := qt_dias_mes_w;
			end;
		else
			begin
			dt_historico_final_w := last_day(dt_historico_ant_w);
			begin
				qt_dias_transf_w := obter_dias_entre_datas(dt_historico_ant_w, dt_historico_final_w);
			exception
			when others then
				qt_dias_transf_w := 0;
			end;
			end;
		end if;

		vl_rateio_deprec_w	:= (vl_deprec_mes_w / qt_dias_mes_w) * qt_dias_transf_w;
		vl_rateio_total_w	:= vl_rateio_total_w + vl_rateio_deprec_w;

		vl_rateio_bx_bem_w		:= vl_bx_bem_w;
		vl_tot_rateio_bx_bem_w		:= vl_bx_bem_w;

		vl_rateio_bx_deprec_w		:= vl_bx_deprec_bem_w;
		vl_tot_rateio_bx_deprec_w	:= vl_bx_deprec_bem_w;

		select	nextval('pat_valor_bem_rateio_seq')
		into STRICT	nr_sequencia_w
		;

		insert into pat_valor_bem_rateio(nr_sequencia,
			nr_seq_valor,
			nr_seq_crit_rateio,
			cd_centro_custo,
			cd_conta_contabil,
			vl_rateio_deprec,
			pr_rateio,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			vl_rateio_baixa_bem,
			vl_rateio_baixa_deprec,
			nr_seq_hist_orig,
			nr_seq_hist_dest)
		values (nr_sequencia_w,
			nr_seq_valor_p,
			nr_seq_crit_rateio_p,
			cd_centro_custo_atual_w,
			cd_conta_contabil_w,
			vl_rateio_deprec_w,
			pr_rateio_w,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			vl_rateio_bx_bem_w,
			vl_rateio_bx_deprec_w,
			nr_seq_hist_orig_w,
			null);

			/* ****************************************************************************
			Movimento de rateio de depreciacao
			***************************************************************************** */

			if (current_setting('philips_patrimonio_pck.ie_gravar_movimento_w')::boolean) then
				begin
				PERFORM set_config('philips_patrimonio_pck.pat_bem_movto_rateio_w', null, false);
				current_setting('philips_patrimonio_pck.pat_bem_movto_rateio_w')::pat_bem_movto_rateio%rowtype.nr_seq_crit_rateio	:= nr_seq_crit_rateio_p;
				current_setting('philips_patrimonio_pck.pat_bem_movto_rateio_w')::pat_bem_movto_rateio%rowtype.cd_centro_custo		:= cd_centro_custo_atual_w;
				current_setting('philips_patrimonio_pck.pat_bem_movto_rateio_w')::pat_bem_movto_rateio%rowtype.vl_rateio		:= vl_rateio_deprec_w;
				current_setting('philips_patrimonio_pck.pat_bem_movto_rateio_w')::pat_bem_movto_rateio%rowtype.pr_rateio		:= pr_rateio_w;

				current_setting('philips_patrimonio_pck.pat_bem_movto_rateio_w')::pat_bem_movto_rateio%rowtype := philips_patrimonio_pck.gerar_movto_bem_rateio('N', nm_usuario_p, current_setting('philips_patrimonio_pck.pat_bem_movto_rateio_w')::pat_bem_movto_rateio%rowtype);

				end;
			end if;
		end;
	end if;
	end;
end if;

vl_diferenca_w		:= vl_rateio_total_w - vl_deprec_mes_w;
vl_dif_baixa_w		:= vl_tot_rateio_bx_bem_w - vl_bx_bem_w;
vl_dif_baixa_deprec_w	:= vl_tot_rateio_bx_deprec_w - vl_bx_deprec_bem_w;

if (vl_diferenca_w > 0) then
	update	pat_valor_bem_rateio
	set	vl_rateio_deprec	= vl_rateio_deprec - vl_diferenca_w,
		vl_rateio_baixa_bem	= vl_rateio_baixa_bem - vl_dif_baixa_w,
		vl_rateio_baixa_deprec	= vl_rateio_baixa_deprec - vl_dif_baixa_deprec_w
	where	nr_sequencia		= nr_sequencia_w;
elsif (vl_diferenca_w < 0) then
	update	pat_valor_bem_rateio
	set	vl_rateio_deprec	= vl_rateio_deprec + abs(vl_diferenca_w),
		vl_rateio_baixa_bem	= vl_rateio_baixa_bem + abs(vl_dif_baixa_w),
		vl_rateio_baixa_deprec	= vl_rateio_baixa_deprec + abs(vl_dif_baixa_deprec_w)
	where	nr_sequencia		= nr_sequencia_w;
end if;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE philips_patrimonio_pck.ratear_depreciacao ( nr_seq_valor_p bigint, nr_seq_crit_rateio_p bigint, ie_rateio_deprec_transf_p text, dt_referencia_p timestamp, nr_seq_bem_p bigint, nm_usuario_p text) FROM PUBLIC;
