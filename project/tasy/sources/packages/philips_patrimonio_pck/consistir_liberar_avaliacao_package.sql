-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE philips_patrimonio_pck.consistir_liberar_avaliacao ( nm_usuario_p text, nr_seq_avaliacao_p pat_bem_avaliacao.nr_sequencia%type) AS $body$
DECLARE


nr_seq_regra_conta_w			pat_bem_avaliacao.nr_seq_regra_conta%type;
nr_seq_tipo_aval_w			pat_bem_avaliacao.nr_seq_tipo_aval%type;
dt_vigencia_regra_conta_w		pat_conta_contabil.dt_vigencia%type;
ie_situacao_conta_w			pat_conta_contabil.ie_situacao%type;
dt_avaliacao_w				pat_bem_avaliacao.dt_avaliacao%type;
dt_liberacao_w				pat_bem_avaliacao.dt_liberacao%type;
nr_seq_bem_w				pat_bem_avaliacao.nr_seq_bem%type;
dt_ultima_depreciacao_w			pat_valor_bem.dt_valor%type;
ie_situacao_bem_w			pat_bem.ie_situacao%type;


BEGIN

select	a.nr_seq_bem,
	a.nr_seq_regra_conta,
	a.nr_seq_tipo_aval,
	a.dt_avaliacao,
	a.dt_liberacao
into STRICT	nr_seq_bem_w,
	nr_seq_regra_conta_w,
	nr_seq_tipo_aval_w,
	dt_avaliacao_w,
	dt_liberacao_w
from	pat_bem_avaliacao a
where	a.nr_sequencia = nr_seq_avaliacao_p;

if (dt_liberacao_w IS NOT NULL AND dt_liberacao_w::text <> '') then
	begin
	/* A avaliacao ja foi liberada por outro usuario */


	CALL wheb_mensagem_pck.exibir_mensagem_abort(876840);
	end;
end if;

/* Consistir se o bem esta ativo */


select	a.ie_situacao
into STRICT	ie_situacao_bem_w
from	pat_bem a
where	a.nr_sequencia = nr_seq_bem_w;
if (ie_situacao_bem_w <> 'A') then
	begin
	/* O bem avaliado nao esta ativo */


	CALL wheb_mensagem_pck.exibir_mensagem_abort(857457);
	end;
end if;

/* Consistir se a regra conta esta ativa */


select	a.ie_situacao,
	a.dt_vigencia
into STRICT	ie_situacao_conta_w,
	dt_vigencia_regra_conta_w
from	pat_conta_contabil a
where	a.nr_sequencia = nr_seq_regra_conta_w;
if (ie_situacao_conta_w <> 'A') then
	begin
	/* A regra de conta contabil informada nao esta ativa */


	CALL wheb_mensagem_pck.exibir_mensagem_abort(857459);
	end;
end if;

/* Consistir se a regra conta esta vigente */


if (dt_vigencia_regra_conta_w > dt_avaliacao_w) then
	begin
	/* A regra de conta contabil informada nao esta vigente no periodo desta avaliacao */


	CALL wheb_mensagem_pck.exibir_mensagem_abort(857461);
	end;
end if;

/* Consistir se o bem possui depreciacao calculada */


select	max(a.dt_valor) dt_valor
into STRICT	dt_ultima_depreciacao_w
from	pat_valor_bem a
where	a.nr_seq_bem = nr_seq_bem_w;

if (coalesce(dt_ultima_depreciacao_w::text, '') = '') then
	begin
	/* O bem avaliado nao possui depreciacoes */


	CALL wheb_mensagem_pck.exibir_mensagem_abort(857462);
	end;
end if;

/* Consistir se a depreciacao nao foi calculada para a data de avaliacao */


if (dt_ultima_depreciacao_w >= pkg_date_utils.start_of(dt_avaliacao_w, 'MONTH', 0)) then
	begin
	/* A avaliacao deve ser em um mes superior ao mes da ultima depreciacao */


	CALL wheb_mensagem_pck.exibir_mensagem_abort(857463);
	end;
end if;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE philips_patrimonio_pck.consistir_liberar_avaliacao ( nm_usuario_p text, nr_seq_avaliacao_p pat_bem_avaliacao.nr_sequencia%type) FROM PUBLIC;
