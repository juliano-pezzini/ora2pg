-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION philips_patrimonio_pck.obter_taxa_depreciacao ( nr_sequencia_p bigint, dt_referencia_p timestamp, vl_default_p bigint, ie_tipo_taxa_p text) RETURNS bigint AS $body$
DECLARE


tx_deprec_contabil_w		double precision;
tx_deprec_fiscal_w		double precision;
ie_tipo_taxa_w			varchar(1);


BEGIN
/* ****************************************************************************
OBTER TAXA DE DEPRECIACAO DA REGRA
Taxa fiscal caso nao informada utiliza o valor default
***************************************************************************** */

ie_tipo_taxa_w		:= coalesce(ie_tipo_taxa_p,'C');
tx_deprec_contabil_w	:= coalesce(vl_default_p,0);
tx_deprec_fiscal_w	:= coalesce(vl_default_p,0);

begin
	/* ****************************************************************************
	Busca a regra com a maior data de (inicio de) vigencia da regra
	que seja menor ou igual a data de referencia (data de calculo da depreciacao)
	***************************************************************************** */

	select	pr_depreciacao,
		pr_deprec_fiscal
	into STRICT	tx_deprec_contabil_w,
		tx_deprec_fiscal_w
	from (SELECT	a.pr_depreciacao,
			coalesce(a.pr_deprec_fiscal,tx_deprec_fiscal_w) pr_deprec_fiscal
		from 	pat_bem_taxa a
		where	a.nr_seq_bem = nr_sequencia_p
		and	a.dt_vigencia <= dt_referencia_p
		order by a.dt_vigencia desc) alias1 LIMIT 1;
exception
when others then
	tx_deprec_contabil_w := tx_deprec_contabil_w;
	tx_deprec_fiscal_w := tx_deprec_fiscal_w;
end;

if (ie_tipo_taxa_w = 'C') then
	begin
	/* Taxa de depreciacao CONTABIL */


	return tx_deprec_contabil_w;
	end;
elsif (ie_tipo_taxa_w = 'F') then
	begin
	/* Taxa de depreciacao FISCAL */


	return tx_deprec_fiscal_w;
	end;
else
	begin
	return coalesce(vl_default_p,0);
	end;
end if;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION philips_patrimonio_pck.obter_taxa_depreciacao ( nr_sequencia_p bigint, dt_referencia_p timestamp, vl_default_p bigint, ie_tipo_taxa_p text) FROM PUBLIC;
