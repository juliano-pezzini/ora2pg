-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE philips_patrimonio_pck.gerar_baixa_bem ( nr_seq_bem_p bigint, nr_seq_tipo_p bigint, dt_baixa_venda_p timestamp, vl_baixa_p bigint, vl_historico_p bigint, qt_percentual_p bigint, ds_observacao_p text, nm_usuario_p text, vl_percent_debito_fiscal_p PAT_VALOR_BEM.VL_PERCENT_DEBITO_FISCAL%type default 0, vl_debito_fiscal_p PAT_VALOR_BEM.VL_DEBITO_FISCAL%type default 0) AS $body$
DECLARE



ie_baixar_vinculado_w           varchar(1);
nr_seq_hist_w                   bigint;
dt_ref_deprec_ant_w             timestamp;
dt_baixa_venda_w                timestamp;
nr_seq_regra_conta_w            pat_conta_contabil.nr_sequencia%type;
qt_percentual_w                 pat_historico_bem.qt_percentual%type;
vl_baixa_bem_w                  pat_historico_bem.vl_baixa_bem%type;
vl_baixa_mes_w                  pat_historico_bem.vl_baixa_bem%type;

vl_base_deprec_w                pat_valor_bem.vl_base_deprec%type;
vl_residual_w                   pat_valor_bem.vl_residual%type;

cd_estabelecimento_w            pat_bem.cd_estabelecimento%type;
nr_seq_local_w                  pat_local.nr_sequencia%type;

cd_centro_custo_w               centro_custo.cd_centro_custo%type;

/* ****************************************************************************
Caso o parametro [67] estiver habilitado,
Buscar bens vinculados ao bem que foi realizada a baixa
e realizar a mesma transacao, realizando a baixa com base no percentual baixado no
bem principal
***************************************************************************** */

c01 CURSOR FOR
	SELECT	a.nr_sequencia nr_seq_bem,
		a.vl_original,
		philips_patrimonio_pck.obter_vl_residual(a.nr_sequencia, dt_baixa_venda_w, a.vl_residual) vl_residual,
		nr_seq_local,
		cd_centro_custo,
		nr_seq_regra_conta,
		cd_estabelecimento
	from	pat_bem a
	where	a.nr_seq_princ	= nr_seq_bem_p
	and	a.ie_situacao	= 'A';

c01_w		c01%rowtype;


BEGIN
/* ****************************************************************************
Truncar valores e arredondar
***************************************************************************** */

dt_baixa_venda_w	:= pkg_date_utils.start_of(dt_baixa_venda_p,'DD', 0);
qt_percentual_w		:= round((qt_percentual_p)::numeric,4);

/* ****************************************************************************
Estabelecimento logado para buscar os parametros
***************************************************************************** */

cd_estabelecimento_w := wheb_usuario_pck.get_cd_estabelecimento();

/* ****************************************************************************
Parametros da funcao
ie_baixar_vinculado_w		= Baixar bens vinculados ao bem original
***************************************************************************** */

ie_baixar_vinculado_w	:= substr(coalesce(Obter_Valor_Param_Usuario(937, 67, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w),'S'),1,1);

/* ****************************************************************************
BAIXAR BENS VINCULADOS
***************************************************************************** */

if (ie_baixar_vinculado_w = 'S') then
	begin
	open c01;
	loop
	fetch c01 into
		c01_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin

		/* ****************************************************************************
		Buscar base da ultima depreciacao
		Descontar as baixas realizadas no mes caso existir
		Calcular valor da baixa com base no percentual de baixa do bem principal
		***************************************************************************** */

		dt_ref_deprec_ant_w := pkg_date_utils.add_month(dt_baixa_venda_w,-1, 0);
		begin
			select	a.vl_base_deprec,
				a.vl_residual
			into STRICT	vl_base_deprec_w,
				vl_residual_w
			from	pat_valor_bem a
			where	nr_seq_bem = c01_w.nr_seq_bem
			and	dt_valor = dt_ref_deprec_ant_w;
		exception
		when others then
			vl_base_deprec_w := c01_w.vl_original;
			vl_residual_w := 0;
		end;

		select	sum(a.vl_baixa_bem) vl_baixa_bem
		into STRICT	vl_baixa_mes_w
		from	pat_historico_bem a
		where	a.nr_seq_bem = c01_w.nr_seq_bem
		and	pkg_date_utils.start_of(a.dt_historico, 'MONTH', 0) = pkg_date_utils.start_of(dt_baixa_venda_w, 'MONTH', 0);

		vl_baixa_mes_w := coalesce(vl_baixa_mes_w,0);

		vl_base_deprec_w := vl_base_deprec_w - vl_baixa_mes_w;

		vl_baixa_bem_w := round(((vl_base_deprec_w * qt_percentual_w) / 100),2);

		select	nextval('pat_historico_bem_seq')
		into STRICT	nr_seq_hist_w
		;

		insert	into pat_historico_bem(
			nr_sequencia,
			nr_seq_bem,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			dt_atualizacao,
			nm_usuario,
			dt_historico,
			nr_seq_tipo,
			nr_seq_local_ant,
			nr_seq_local_atual,
			vl_historico,
			qt_percentual,
			ds_observacao,
			vl_baixa_bem)
		values (	nr_seq_hist_w,
			c01_w.nr_seq_bem,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			dt_baixa_venda_p,
			nr_seq_tipo_p,
			null,
			null,
			0,
			coalesce(qt_percentual_p,0),
			substr(ds_observacao_p,1,255),
			vl_baixa_bem_w);

		if (current_setting('philips_patrimonio_pck.ie_gravar_movimento_w')::boolean) then
			begin
			/* Movimento de baixa de um bem */


			PERFORM set_config('philips_patrimonio_pck.pat_bem_movimento_w', null, false);
			current_setting('philips_patrimonio_pck.pat_bem_movimento_w')::pat_bem_movimento%rowtype.cd_centro_custo		:= c01_w.cd_centro_custo;
			current_setting('philips_patrimonio_pck.pat_bem_movimento_w')::pat_bem_movimento%rowtype.cd_centro_custo_dest	:= null;
			current_setting('philips_patrimonio_pck.pat_bem_movimento_w')::pat_bem_movimento%rowtype.cd_estabelecimento		:= c01_w.cd_estabelecimento;
			current_setting('philips_patrimonio_pck.pat_bem_movimento_w')::pat_bem_movimento%rowtype.cd_estab_dest		:= null;
			current_setting('philips_patrimonio_pck.pat_bem_movimento_w')::pat_bem_movimento%rowtype.dt_movimento		:= dt_baixa_venda_p;
			current_setting('philips_patrimonio_pck.pat_bem_movimento_w')::pat_bem_movimento%rowtype.ie_acao			:= 'I'; /* Inclusao */

			current_setting('philips_patrimonio_pck.pat_bem_movimento_w')::pat_bem_movimento%rowtype.ie_tipo_movimento		:= 0; /* Valor default  */

			current_setting('philips_patrimonio_pck.pat_bem_movimento_w')::pat_bem_movimento%rowtype.nr_seq_bem			:= c01_w.nr_seq_bem;
			current_setting('philips_patrimonio_pck.pat_bem_movimento_w')::pat_bem_movimento%rowtype.nr_seq_local		:= c01_w.nr_seq_local;
			current_setting('philips_patrimonio_pck.pat_bem_movimento_w')::pat_bem_movimento%rowtype.nr_seq_local_dest		:= null;
			current_setting('philips_patrimonio_pck.pat_bem_movimento_w')::pat_bem_movimento%rowtype.nr_seq_operacao		:= current_setting('philips_patrimonio_pck.oper_patrimonial')::r_pat_operacao.baixa_de_bem;
			current_setting('philips_patrimonio_pck.pat_bem_movimento_w')::pat_bem_movimento%rowtype.nr_seq_regra_conta		:= c01_w.nr_seq_regra_conta;
			current_setting('philips_patrimonio_pck.pat_bem_movimento_w')::pat_bem_movimento%rowtype.nr_seq_regra_conta_dest	:= null;
			current_setting('philips_patrimonio_pck.pat_bem_movimento_w')::pat_bem_movimento%rowtype.vl_movimento		:= vl_baixa_bem_w;

			current_setting('philips_patrimonio_pck.pat_bem_movimento_w')::pat_bem_movimento%rowtype := philips_patrimonio_pck.gerar_movimento_bem('N', nm_usuario_p, current_setting('philips_patrimonio_pck.pat_bem_movimento_w')::pat_bem_movimento%rowtype);
			end;
		end if;
		end;
	end loop;
	close c01;
	end;
end if;

/* ****************************************************************************
BAIXAR BEM ORIGINAL
***************************************************************************** */

select	nextval('pat_historico_bem_seq'),
	cd_estabelecimento,
	nr_seq_regra_conta,
	nr_seq_local,
	cd_centro_custo
into STRICT	nr_seq_hist_w,
	cd_estabelecimento_w,
	nr_seq_regra_conta_w,
	nr_seq_local_w,
	cd_centro_custo_w
from	pat_bem a
where	a.nr_sequencia = nr_seq_bem_p;

insert	into pat_historico_bem(
	nr_sequencia,
	nr_seq_bem,
	dt_atualizacao_nrec,
	nm_usuario_nrec,
	dt_atualizacao,
	nm_usuario,
	dt_historico,
	nr_seq_tipo,
	nr_seq_local_ant,
	nr_seq_local_atual,
	vl_historico,
	qt_percentual,
	ds_observacao,
	vl_baixa_bem)
values (	nr_seq_hist_w,
	nr_seq_bem_p,
	clock_timestamp(),
	nm_usuario_p,
	clock_timestamp(),
	nm_usuario_p,
	dt_baixa_venda_p,
	nr_seq_tipo_p,
	null,
	null,
	vl_historico_p,
	coalesce(qt_percentual_p,0),
	substr(ds_observacao_p,1,255),
	vl_baixa_p);

if (current_setting('philips_patrimonio_pck.ie_gravar_movimento_w')::boolean) then
	begin
	/* Movimento de baixa de um bem */


	PERFORM set_config('philips_patrimonio_pck.pat_bem_movimento_w', null, false);
	current_setting('philips_patrimonio_pck.pat_bem_movimento_w')::pat_bem_movimento%rowtype.cd_centro_custo		:= cd_centro_custo_w;
	current_setting('philips_patrimonio_pck.pat_bem_movimento_w')::pat_bem_movimento%rowtype.cd_centro_custo_dest	:= null;
	current_setting('philips_patrimonio_pck.pat_bem_movimento_w')::pat_bem_movimento%rowtype.cd_estabelecimento		:= cd_estabelecimento_w;
	current_setting('philips_patrimonio_pck.pat_bem_movimento_w')::pat_bem_movimento%rowtype.cd_estab_dest		:= null;
	current_setting('philips_patrimonio_pck.pat_bem_movimento_w')::pat_bem_movimento%rowtype.dt_movimento		:= dt_baixa_venda_p;
	current_setting('philips_patrimonio_pck.pat_bem_movimento_w')::pat_bem_movimento%rowtype.ie_acao			:= 'I'; /* Inclusao */

	current_setting('philips_patrimonio_pck.pat_bem_movimento_w')::pat_bem_movimento%rowtype.ie_tipo_movimento		:= 0; /* Valor default  */

	current_setting('philips_patrimonio_pck.pat_bem_movimento_w')::pat_bem_movimento%rowtype.nr_seq_bem			:= nr_seq_bem_p;
	current_setting('philips_patrimonio_pck.pat_bem_movimento_w')::pat_bem_movimento%rowtype.nr_seq_local		:= nr_seq_local_w;
	current_setting('philips_patrimonio_pck.pat_bem_movimento_w')::pat_bem_movimento%rowtype.nr_seq_local_dest		:= null;
	current_setting('philips_patrimonio_pck.pat_bem_movimento_w')::pat_bem_movimento%rowtype.nr_seq_operacao		:= current_setting('philips_patrimonio_pck.oper_patrimonial')::r_pat_operacao.baixa_de_bem;
	current_setting('philips_patrimonio_pck.pat_bem_movimento_w')::pat_bem_movimento%rowtype.nr_seq_regra_conta		:= nr_seq_regra_conta_w;
	current_setting('philips_patrimonio_pck.pat_bem_movimento_w')::pat_bem_movimento%rowtype.nr_seq_regra_conta_dest	:= null;
	current_setting('philips_patrimonio_pck.pat_bem_movimento_w')::pat_bem_movimento%rowtype.vl_movimento		:= vl_baixa_p;

	current_setting('philips_patrimonio_pck.pat_bem_movimento_w')::pat_bem_movimento%rowtype := philips_patrimonio_pck.gerar_movimento_bem('N', nm_usuario_p, current_setting('philips_patrimonio_pck.pat_bem_movimento_w')::pat_bem_movimento%rowtype);

	end;
end if;

UPDATE  PAT_VALOR_BEM
SET     VL_PERCENT_DEBITO_FISCAL = vl_percent_debito_fiscal_p,
        VL_DEBITO_FISCAL = vl_debito_fiscal_p
WHERE   NR_SEQ_BEM = nr_seq_bem_p;

commit;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE philips_patrimonio_pck.gerar_baixa_bem ( nr_seq_bem_p bigint, nr_seq_tipo_p bigint, dt_baixa_venda_p timestamp, vl_baixa_p bigint, vl_historico_p bigint, qt_percentual_p bigint, ds_observacao_p text, nm_usuario_p text, vl_percent_debito_fiscal_p PAT_VALOR_BEM.VL_PERCENT_DEBITO_FISCAL%type default 0, vl_debito_fiscal_p PAT_VALOR_BEM.VL_DEBITO_FISCAL%type default 0) FROM PUBLIC;
