-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE philips_patrimonio_pck.gerar_bem_avaliacao ( ie_commit_p text, nm_usuario_p text, nr_seq_avaliacao_p pat_bem_avaliacao.nr_sequencia%type, nr_seq_bem_avaliacao_p INOUT pat_bem.nr_sequencia%type) AS $body$
DECLARE


nr_seq_regra_conta_w		pat_bem_avaliacao.nr_seq_regra_conta%type;
cd_conta_contabil_w		pat_conta_contabil.cd_conta_contabil%type;
tx_deprec_fiscal_w		pat_bem_avaliacao.tx_deprec_fiscal%type;
tx_depreciacao_w		pat_bem_avaliacao.tx_depreciacao%type;
nr_seq_bem_avaliado_w		pat_bem_avaliacao.nr_seq_bem%type;
vl_ajuste_w			pat_bem_avaliacao.vl_ajuste%type;
dt_avaliacao_w			timestamp;


BEGIN

select	nr_seq_bem,
	trunc(dt_avaliacao) dt_avaliacao,
	vl_ajuste,
	tx_depreciacao,
	tx_deprec_fiscal,
	nr_seq_regra_conta
into STRICT	nr_seq_bem_avaliado_w,
	dt_avaliacao_w,
	vl_ajuste_w,
	tx_depreciacao_w,
	tx_deprec_fiscal_w,
	nr_seq_regra_conta_w
from	pat_bem_avaliacao a
where	a.nr_sequencia = nr_seq_avaliacao_p;

/* Pegar uma copia do bem original para gerar o bem avaliado com valor adicional */


select	*
into STRICT	current_setting('philips_patrimonio_pck.pat_bem_w')::pat_bem%rowtype
from	pat_bem
where	nr_sequencia = nr_seq_bem_avaliado_w;

current_setting('philips_patrimonio_pck.pat_bem_w')::pat_bem%rowtype.nr_seq_princ		:= nr_seq_bem_avaliado_w;
current_setting('philips_patrimonio_pck.pat_bem_w')::pat_bem%rowtype.ie_tipo_valor		:= 'C'; /* C - Custo atribuido | A - Adicao | L - Reavaliacao */


/* Verificar se necessario */


select	coalesce(max(a.nr_seq_adicao),0) + 1
into STRICT	current_setting('philips_patrimonio_pck.pat_bem_w')::pat_bem%rowtype.nr_seq_adicao
from	pat_bem a
where	a.nr_seq_princ = nr_seq_bem_avaliado_w;

current_setting('philips_patrimonio_pck.pat_bem_w')::pat_bem%rowtype.cd_bem		:= substr(current_setting('philips_patrimonio_pck.pat_bem_w')::pat_bem%rowtype.cd_bem || '.' || current_setting('philips_patrimonio_pck.pat_bem_w')::pat_bem%rowtype.nr_seq_adicao,1,20);
current_setting('philips_patrimonio_pck.pat_bem_w')::pat_bem%rowtype.ds_bem		:= substr(current_setting('philips_patrimonio_pck.pat_bem_w')::pat_bem%rowtype.ds_bem || ' - ' || wheb_mensagem_pck.get_texto(763355),1,255); /* Avaliacao */


current_setting('philips_patrimonio_pck.pat_bem_w')::pat_bem%rowtype.dt_aquisicao		:= dt_avaliacao_w;
current_setting('philips_patrimonio_pck.pat_bem_w')::pat_bem%rowtype.dt_inicio_uso		:= dt_avaliacao_w;

current_setting('philips_patrimonio_pck.pat_bem_w')::pat_bem%rowtype.vl_original		:= vl_ajuste_w;
current_setting('philips_patrimonio_pck.pat_bem_w')::pat_bem%rowtype.vl_residual		:= 0;
current_setting('philips_patrimonio_pck.pat_bem_w')::pat_bem%rowtype.tx_deprec		:= coalesce(tx_depreciacao_w,current_setting('philips_patrimonio_pck.pat_bem_w')::pat_bem%rowtype.tx_deprec);
current_setting('philips_patrimonio_pck.pat_bem_w')::pat_bem%rowtype.tx_fiscal		:= coalesce(tx_deprec_fiscal_w,current_setting('philips_patrimonio_pck.pat_bem_w')::pat_bem%rowtype.tx_fiscal);

if (coalesce(nr_seq_regra_conta_w,0) <> 0) then
	begin
	select	cd_conta_contabil
	into STRICT	cd_conta_contabil_w
	from	pat_conta_contabil a
	where	a.nr_sequencia = nr_seq_regra_conta_w;

	current_setting('philips_patrimonio_pck.pat_bem_w')::pat_bem%rowtype.nr_seq_regra_conta	:= nr_seq_regra_conta_w;
	end;
end if;
current_setting('philips_patrimonio_pck.pat_bem_w')::pat_bem%rowtype.nr_sequencia := null;
current_setting('philips_patrimonio_pck.pat_bem_w')::pat_bem%rowtype := philips_patrimonio_pck.gerar_pat_bem('N', nm_usuario_p, current_setting('philips_patrimonio_pck.pat_bem_w')::pat_bem%rowtype);
nr_seq_bem_avaliacao_p := current_setting('philips_patrimonio_pck.pat_bem_w')::pat_bem%rowtype.nr_sequencia;

if (ie_commit_p = 'S') then
	begin
	commit;
	end;
end if;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE philips_patrimonio_pck.gerar_bem_avaliacao ( ie_commit_p text, nm_usuario_p text, nr_seq_avaliacao_p pat_bem_avaliacao.nr_sequencia%type, nr_seq_bem_avaliacao_p INOUT pat_bem.nr_sequencia%type) FROM PUBLIC;
