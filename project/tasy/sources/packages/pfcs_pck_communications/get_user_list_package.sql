-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

/*=========================================== Cursor ===========================================*/

    
/*=========================================== Functions ===========================================*/

CREATE OR REPLACE FUNCTION pfcs_pck_communications.get_user_list (nr_seq_rule_p bigint, nr_startrow_p bigint, nr_lastrow_p bigint, ie_communication_type_p text) RETURNS varchar AS $body$
DECLARE

        ds_user_list_w      varchar(4000);

BEGIN
		select	rtrim(xmlagg(XMLELEMENT(name e, intermidate_value, pfcs_pck_constants.DS_SEMICOLON)).extract['//text()'].getclobval(), pfcs_pck_constants.DS_SEMICOLON)
		  into STRICT	ds_user_list_w
		  from	(SELECT row_number() OVER () AS row_number,
						case
							when ie_communication_type_p = pfcs_pck_constants.IE_SMS_SEND then to_char(pct.nr_celular)
							when ie_communication_type_p = pfcs_pck_constants.IE_EMAIL_SEND then pct.ds_destination_email
							else pct.ds_destination_user end
							as intermidate_value
				   from	pfcs_communication_target pct
				  where	pct.nr_seq_rule = nr_seq_rule_p
					and (((ie_communication_type_p = pfcs_pck_constants.IE_SMS_SEND) and (pct.ie_communication_sms = pfcs_pck_constants.IE_YES_BR) and (pct.nr_celular IS NOT NULL AND pct.nr_celular::text <> ''))
					 or	((ie_communication_type_p = pfcs_pck_constants.IE_EMAIL_SEND) and (pct.ie_communication_email = pfcs_pck_constants.IE_YES_BR) and (pct.ds_destination_email IS NOT NULL AND pct.ds_destination_email::text <> ''))
					 or	((ie_communication_type_p = pfcs_pck_constants.IE_COMMUNICATION_INTERNAL) and (pct.ie_communication_internal = pfcs_pck_constants.IE_YES_BR) and (pct.ds_destination_user IS NOT NULL AND pct.ds_destination_user::text <> '')))) alias18
		 where	row_number >= nr_startrow_p
		   and	row_number <= nr_lastrow_p;

		return ds_user_list_w;
    END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pfcs_pck_communications.get_user_list (nr_seq_rule_p bigint, nr_startrow_p bigint, nr_lastrow_p bigint, ie_communication_type_p text) FROM PUBLIC;
