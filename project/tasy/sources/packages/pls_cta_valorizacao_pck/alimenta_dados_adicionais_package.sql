-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_cta_valorizacao_pck.alimenta_dados_adicionais ( nr_seq_lote_p pls_lote_protocolo_conta.nr_sequencia%type, nr_seq_protocolo_p pls_protocolo_conta.nr_sequencia%type, nr_seq_lote_processo_p pls_cta_lote_processo.nr_sequencia%type, nr_seq_conta_p pls_conta.nr_sequencia%type, nr_seq_proc_p pls_conta_proc.nr_sequencia%type, nr_seq_mat_p pls_conta_mat.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) AS $body$
DECLARE


ie_evento_w			varchar(5);
nr_seq_evento_w			pls_evento.nr_sequencia%type;
nr_seq_evento_prod_w		pls_evento_regra_producao.nr_sequencia%type;
nr_seq_grupo_ans_w		ans_grupo_desp_regra.nr_seq_grupo_ans%type;
ie_atualiza_apresentado_w	pls_parametros.ie_atualizar_valor_apresent%type;
ie_gerar_grupo_ans_w		pls_parametro_contabil.ie_consitencia_grupo_ans%type;
nr_seq_conselho_w		pessoa_fisica.nr_seq_conselho%type;
nr_indice_mat_p			integer;
nr_indice_proc_p		integer;
tb_seq_proc_p			dbms_sql.number_table;
tb_seq_mat_p			dbms_sql.number_table;
tb_evento_proc_p		dbms_sql.number_table;
tb_evento_mat_p			dbms_sql.number_table;
tb_evento_prod_proc_p		dbms_sql.number_table;
tb_evento_prod_mat_p		dbms_sql.number_table;
tb_grupo_ans_p			dbms_sql.number_table;
					
-- procedimentos nao cancelados de contas nao fechadas

c_procedimentos CURSOR(	nr_seq_conta_pc		pls_conta.nr_sequencia%type,
			nr_seq_conta_proc_pc	pls_conta_proc.nr_sequencia%type) FOR
	SELECT	nr_sequencia nr_seq_conta_proc,
		ie_origem_proced,
		cd_procedimento,
		ie_tipo_despesa,
		ie_status,
		nr_seq_preco_pacote
	from	pls_conta_proc_v
	where	nr_sequencia = nr_seq_conta_proc_pc
	and	ie_status <> 'D'
	and	ie_status_conta <> 'F'
	
union all

	SELECT	nr_sequencia nr_seq_conta_proc,
		ie_origem_proced,
		cd_procedimento,
		ie_tipo_despesa,
		ie_status,
		nr_seq_preco_pacote
	from	pls_conta_proc_v
	where	nr_seq_conta = nr_seq_conta_pc
	and	coalesce(nr_seq_conta_proc_pc::text, '') = ''
	and	ie_status <> 'D'
	and	ie_status_conta <> 'F';

-- materiais nao cancelados de contas nao fechadas

c_materiais CURSOR(	nr_seq_conta_pc		pls_conta.nr_sequencia%type,
			nr_seq_conta_mat_pc	pls_conta_mat.nr_sequencia%type) FOR
	SELECT	nr_sequencia nr_seq_conta_mat,
		ie_tipo_despesa,
		nr_seq_conta
	from	pls_conta_mat_v
	where	nr_sequencia = nr_seq_conta_mat_pc
	and	ie_status <> 'D'
	and	ie_status_conta <> 'F'
	
union all

	SELECT	nr_sequencia nr_seq_conta_mat,
		ie_tipo_despesa,
		nr_seq_conta
	from	pls_conta_mat_v
	where	nr_seq_conta = nr_seq_conta_pc
	and	coalesce(nr_seq_conta_mat_pc::text, '') = ''
	and	ie_status <> 'D'
	and	ie_status_conta <> 'F';
	
BEGIN

-- busca parametro para saber se e para liberar ou alimentar os valores calculados nos valores apresentados

select	ie_atualizar_valor_apresent
into STRICT	ie_atualiza_apresentado_w
from	table(pls_parametros_pck.f_retorna_param(cd_estabelecimento_p));

select	coalesce(max(ie_consitencia_grupo_ans), 'S')
into STRICT	ie_gerar_grupo_ans_w
from	pls_parametro_contabil
where	cd_estabelecimento	= cd_estabelecimento_p;

nr_indice_proc_p	:= 0;
nr_indice_mat_p		:= 0;
tb_seq_proc_p.delete;
tb_seq_mat_p.delete;
tb_evento_proc_p.delete;
tb_evento_mat_p.delete;
tb_evento_prod_proc_p.delete;
tb_evento_prod_mat_p.delete;
tb_grupo_ans_p.delete;

for r_contas_w in pls_cta_consistir_pck.c_contas(	nr_seq_lote_p, nr_seq_protocolo_p, nr_seq_lote_processo_p, nr_seq_conta_p) loop

	if (r_contas_w.ie_tipo_conta = 'I') then
		ie_evento_w := 'I5';
	else
		ie_evento_w := null;
	end if;
	
	CALL pls_obter_regra_valor_conta(	r_contas_w.nr_seq_conta, null, null,
					ie_evento_w, nm_usuario_p);
					
	-- busca os procedimentos				

	for r_c_procedimentos_w in c_procedimentos(r_contas_w.nr_seq_conta, nr_seq_proc_p) loop
		--Nao pode estar  "Em analise" , "Liberado pelo usuario" ou "Cancelado"

		if (r_c_procedimentos_w.ie_status not in ('A','D','L')) then
			
			--Obtem valores para evento e evento_prod que serao posteriormente atualizados na pls_conta_proc

			pls_obter_evento_item(	r_c_procedimentos_w.cd_procedimento, r_c_procedimentos_w.ie_origem_proced, null,
						cd_estabelecimento_p, r_contas_w.ie_tipo_guia,
						r_contas_w.ie_origem_conta, r_contas_w.nr_seq_tipo_atendimento, 
						r_c_procedimentos_w.ie_tipo_despesa, r_contas_w.nr_seq_segurado, 
						r_contas_w.nr_seq_conta, 'N', null, nr_seq_evento_w, 
						nr_seq_evento_prod_w, 'C', r_contas_w.ie_regime_atendimento,
						r_contas_w.ie_saude_ocupacional);
			
			--Indice de controle das listas de procedimentos

			nr_indice_proc_p := nr_indice_proc_p + 1;
			tb_seq_proc_p(nr_indice_proc_p)	 := r_c_procedimentos_w.nr_seq_conta_proc;
			tb_evento_prod_proc_p(nr_indice_proc_p)	:= nr_seq_evento_w;
			tb_evento_proc_p(nr_indice_proc_p)	:= nr_seq_evento_prod_w;
			
			--Se quantidade de registros atingir numero predefinido,  faz update

			--Esta mandando a tb_grupo_ans_p ao atualizar procedimentos, porem nada e feito, apenas e passada pois a 

			--rotina e utilizada para mat e proc

			if (nr_indice_proc_p = pls_util_cta_pck.qt_registro_transacao_w) then
				CALL pls_cta_valorizacao_pck.atualiza_informacoes_item(tb_seq_proc_p, tb_evento_proc_p, tb_evento_prod_proc_p,
							  tb_grupo_ans_p, 'P');
				nr_indice_proc_p := 0;
				tb_evento_proc_p.delete;
				tb_evento_prod_proc_p.delete;
				tb_seq_proc_p.delete;
			end if;

		end if;
	end loop;
	
	-- busca os materiais				

	for r_c_materiais_w in c_materiais(r_contas_w.nr_seq_conta, nr_seq_mat_p) loop
		--Obtem valores para evento e evento_prod que serao posteriormente atualizados na pls_conta_mat

		pls_obter_evento_item(	null, null, r_c_materiais_w.nr_seq_conta_mat,
					cd_estabelecimento_p, r_contas_w.ie_tipo_guia,
					r_contas_w.ie_origem_conta, r_contas_w.nr_seq_tipo_atendimento, 
					r_c_materiais_w.ie_tipo_despesa, r_contas_w.nr_seq_segurado,
					r_contas_w.nr_seq_conta, 'N', null, nr_seq_evento_w, nr_seq_evento_prod_w, 'C', 
					r_contas_w.ie_regime_atendimento, r_contas_w.ie_saude_ocupacional);
					
					
		if (ie_gerar_grupo_ans_w = 'S') then	
			select	max(nr_seq_conselho)
			into STRICT	nr_seq_conselho_w
			from	pessoa_fisica
			where	cd_pessoa_fisica	= r_contas_w.cd_medico_executor;
			
			--Busca a sequencia do grupo ANS. Essa informacao sera atualizada na pls_conta_mat posteriormente

			nr_seq_grupo_ans_w	:= pls_obter_grupo_ans(	null,null, nr_seq_conselho_w,
									r_contas_w.nr_seq_tipo_atendimento, r_contas_w.ie_tipo_guia, 
									r_contas_w.ie_regime_internacao, r_c_materiais_w.ie_tipo_despesa,
									'G',cd_estabelecimento_p, r_c_materiais_w.nr_seq_conta);
		end if;
		
		--Indice de controle das listas de materiais

		nr_indice_mat_p := nr_indice_mat_p + 1;
		tb_seq_mat_p(nr_indice_mat_p)	 	:= r_c_materiais_w.nr_seq_conta_mat;
		tb_evento_prod_mat_p(nr_indice_mat_p)	:= nr_seq_evento_w;
		tb_evento_mat_p(nr_indice_mat_p)	:= nr_seq_evento_prod_w;
		tb_grupo_ans_p(nr_indice_mat_p)		:= nr_seq_grupo_ans_w;
	
		--Faz update dos registros que se referem a materiais

		if (nr_indice_mat_p = pls_util_cta_pck.qt_registro_transacao_w) then
				CALL pls_cta_valorizacao_pck.atualiza_informacoes_item(tb_seq_mat_p, tb_evento_mat_p, tb_evento_prod_mat_p,
							  tb_grupo_ans_p, 'M');
				nr_indice_mat_p := 0;
				tb_evento_mat_p.delete;
				tb_evento_prod_mat_p.delete;
				tb_seq_mat_p.delete;
				tb_grupo_ans_p.delete;
		end if;

	end loop;

end loop;

--Para fazer update nos registros remanescentes nas listas

CALL pls_cta_valorizacao_pck.atualiza_informacoes_item(tb_seq_proc_p, tb_evento_proc_p, tb_evento_prod_proc_p,
							  tb_grupo_ans_p, 'P');
							
CALL pls_cta_valorizacao_pck.atualiza_informacoes_item(tb_seq_mat_p, tb_evento_mat_p, tb_evento_prod_mat_p,
							  tb_grupo_ans_p, 'M');							
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_cta_valorizacao_pck.alimenta_dados_adicionais ( nr_seq_lote_p pls_lote_protocolo_conta.nr_sequencia%type, nr_seq_protocolo_p pls_protocolo_conta.nr_sequencia%type, nr_seq_lote_processo_p pls_cta_lote_processo.nr_sequencia%type, nr_seq_conta_p pls_conta.nr_sequencia%type, nr_seq_proc_p pls_conta_proc.nr_sequencia%type, nr_seq_mat_p pls_conta_mat.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) FROM PUBLIC;
