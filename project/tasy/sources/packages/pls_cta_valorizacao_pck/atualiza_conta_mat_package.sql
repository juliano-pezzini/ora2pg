-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


--Realiza os update da regra de preco na pls_atualiza_valor_mat




CREATE OR REPLACE PROCEDURE pls_cta_valorizacao_pck.atualiza_conta_mat ( tb_dados_conta_mat_p table_dados_conta_mat, tb_seq_conta_mat_insert_p dbms_sql.number_table, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) AS $body$
BEGIN
--Se realmente tiver registros

if (tb_seq_conta_mat_insert_p.count > 0) then

	--Atualiza referencia  a analise nas contas

	forall i in tb_seq_conta_mat_insert_p.first..tb_seq_conta_mat_insert_p.last
		update	pls_conta_mat
		set	vl_material			= tb_dados_conta_mat_p.vl_material(i),
			vl_glosa			= CASE WHEN ie_status='L' THEN vl_glosa WHEN ie_status='S' THEN vl_glosa  ELSE 0 END ,
			vl_saldo			= CASE WHEN ie_status='L' THEN vl_saldo  ELSE 0 END ,
			vl_beneficiario			= CASE WHEN ie_status='L' THEN vl_beneficiario  ELSE 0 END ,
			nr_seq_regra			= tb_dados_conta_mat_p.nr_seq_regra(i),
			ie_status			= tb_dados_conta_mat_p.ie_status(i),
			nr_seq_regra_pos_estab		= tb_dados_conta_mat_p.nr_seq_regra_pos_estab(i),
			dt_inicio_atend			= tb_dados_conta_mat_p.dt_inicio_atend(i),
			dt_fim_atend			= tb_dados_conta_mat_p.dt_fim_atend(i),
			vl_mat_copartic			= tb_dados_conta_mat_p.vl_mat_copartic(i),
			nr_seq_regra_copartic		= tb_dados_conta_mat_p.nr_seq_regra_copartic(i),
			ie_ato_cooperado		= tb_dados_conta_mat_p.ie_ato_cooperado(i),
			nr_seq_regra_cooperado		= tb_dados_conta_mat_p.nr_seq_regra_cooperado(i),
			vl_material_ptu			= tb_dados_conta_mat_p.vl_material_ptu(i),
			nr_seq_regra_int		= tb_dados_conta_mat_p.nr_seq_regra_int(i),
			ie_vl_apresentado_sistema 	= tb_dados_conta_mat_p.ie_vl_apresentado_sistema(i),
			tx_intercambio			= tb_dados_conta_mat_p.tx_intercambio(i),
			vl_taxa_material		= tb_dados_conta_mat_p.vl_taxa_material(i),
			vl_calculado_ant		= tb_dados_conta_mat_p.vl_calculado_ant(i),
			nr_seq_regra_tx_inter		= tb_dados_conta_mat_p.nr_seq_regra_tx_inter(i),
			ie_cobranca_prevista		= CASE WHEN tb_dados_conta_mat_p.ie_cobranca_prevista_inf(i) = NULL THEN  tb_dados_conta_mat_p.ie_cobranca_prevista(i)  ELSE tb_dados_conta_mat_p.ie_cobranca_prevista_mat(i) END ,
			tx_prestador_item		= tb_dados_conta_mat_p.tx_prestador_item(i),
			vl_mat_cobranca_prev		= tb_dados_conta_mat_p.vl_mat_cobranca_prev(i),
			nr_seq_regra_cobr_prev		= tb_dados_conta_mat_p.nr_seq_regra_cobr_prev(i)
		where	nr_sequencia			= tb_seq_conta_mat_insert_p(i);		
	commit;
	
	forall i in tb_seq_conta_mat_insert_p.first..tb_seq_conta_mat_insert_p.last
		update	pls_conta_mat_regra
		set	dt_valorizacao = clock_timestamp()
		where 	nr_sequencia = tb_seq_conta_mat_insert_p(i);
	commit;
end if;
	
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_cta_valorizacao_pck.atualiza_conta_mat ( tb_dados_conta_mat_p table_dados_conta_mat, tb_seq_conta_mat_insert_p dbms_sql.number_table, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) FROM PUBLIC;
