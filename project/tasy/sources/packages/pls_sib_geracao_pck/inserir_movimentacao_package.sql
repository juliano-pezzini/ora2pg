-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_sib_geracao_pck.inserir_movimentacao ( ie_final_p text) AS $body$
DECLARE

tb_nr_seq_movimento_wr	pls_util_cta_pck.t_number_table;
tb_nr_seq_movimento_wrr	pls_util_cta_pck.t_number_table;
BEGIN
if (current_setting('pls_sib_geracao_pck.indice_w')::bigint = pls_util_pck.qt_registro_transacao_w) or (ie_final_p = 'S') then
	if (current_setting('pls_sib_geracao_pck.tb_nr_seq_segurado_w')::pls_util_cta_pck.t_number_table.count > 0) then
		--///////////////////////////////////////////////////OBSERVACAO\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\

		--Sempre que adicionado um novo campo, precisa alterar tambem a procedure ATUALIZAR_MOVIMENTO

		--Tambem eh necessario alimentar o insert logo abaixo, na tabela PLS_SIB_MOVIMENTO_ANT

		forall i in current_setting('pls_sib_geracao_pck.tb_nr_seq_segurado_w')::pls_util_cta_pck.t_number_table.first..tb_nr_seq_segurado_w.last
			insert	into	pls_sib_movimento(	nr_sequencia, nr_seq_lote, nr_seq_segurado, ie_tipo_movimento,
				dt_atualizacao, dt_atualizacao_nrec, nm_usuario, nm_usuario_nrec,
				cd_cco, nm_beneficiario, dt_cancelamento, nr_seq_motivo_cancelamento,
				cd_motivo_cancelamento, dt_reativacao, dt_nascimento, cd_sexo,
				nr_cpf, nr_pis_pasep, nm_mae, nr_dn,
				nr_cns, cd_beneficiario, cd_beneficiario_titular, dt_contratacao,
				nr_seq_plano, nr_plano_ans, nr_plano_operadora, nr_plano_portabilidade,
				ie_cpt, ie_itens_excluidos_cobertura, nr_cnpj, nr_cei, cd_caepf,
				nr_seq_parentesco, cd_relacao_dependencia, ie_tipo_endereco, ds_logradouro,
				nr_logradouro, ds_complemento, ds_bairro, cd_municipio_ibge,
				cd_cep, ie_reside_exterior, cd_municipio_ibge_resid,
				nr_seq_reenvio, nr_seq_status_inclusao, nr_seq_status_exclusao,
				ie_retificacao_null)
			values (	nextval('pls_sib_movimento_seq'), current_setting('pls_sib_geracao_pck.pls_sib_lote_w')::pls_sib_lote%rowtype.nr_sequencia , current_setting('pls_sib_geracao_pck.tb_nr_seq_segurado_w')::pls_util_cta_pck.t_number_table(i), current_setting('pls_sib_geracao_pck.tb_ie_tipo_movimento_w')::pls_util_cta_pck.t_number_table(i),
				clock_timestamp(), clock_timestamp(), current_setting('pls_sib_geracao_pck.nm_usuario_w')::usuario.nm_usuario%type, current_setting('pls_sib_geracao_pck.nm_usuario_w')::usuario.nm_usuario%type,
				current_setting('pls_sib_geracao_pck.tb_cd_cco_w')::pls_util_cta_pck.t_varchar2_table_15(i), current_setting('pls_sib_geracao_pck.tb_nm_beneficiario_w')::pls_util_cta_pck.t_varchar2_table_255(i), current_setting('pls_sib_geracao_pck.tb_dt_rescisao_w')::pls_util_cta_pck.t_date_table(i), current_setting('pls_sib_geracao_pck.tb_nr_seq_motivo_cancel_w')::pls_util_cta_pck.t_number_table(i),
				current_setting('pls_sib_geracao_pck.tb_cd_motivo_cancelamento_w')::pls_util_cta_pck.t_varchar2_table_5(i), current_setting('pls_sib_geracao_pck.tb_dt_reativacao_w')::pls_util_cta_pck.t_date_table(i), current_setting('pls_sib_geracao_pck.tb_dt_nascimento_w')::pls_util_cta_pck.t_date_table(i), current_setting('pls_sib_geracao_pck.tb_cd_sexo_w')::pls_util_cta_pck.t_number_table(i),
				current_setting('pls_sib_geracao_pck.tb_nr_cpf_w')::pls_util_cta_pck.t_varchar2_table_15(i), current_setting('pls_sib_geracao_pck.tb_nr_pis_pasep_w')::pls_util_cta_pck.t_varchar2_table_15(i), current_setting('pls_sib_geracao_pck.tb_nm_mae_w')::pls_util_cta_pck.t_varchar2_table_255(i), current_setting('pls_sib_geracao_pck.tb_nr_dn_w')::pls_util_cta_pck.t_varchar2_table_15(i),
				current_setting('pls_sib_geracao_pck.tb_nr_cns_w')::pls_util_cta_pck.t_number_table(i), current_setting('pls_sib_geracao_pck.tb_cd_beneficiario_w')::pls_util_cta_pck.t_varchar2_table_50(i), current_setting('pls_sib_geracao_pck.tb_cd_beneficiario_titular_w')::pls_util_cta_pck.t_varchar2_table_50(i), current_setting('pls_sib_geracao_pck.tb_dt_contratacao_w')::pls_util_cta_pck.t_date_table(i),
				current_setting('pls_sib_geracao_pck.tb_nr_seq_plano_w')::pls_util_cta_pck.t_number_table(i), current_setting('pls_sib_geracao_pck.tb_nr_plano_ans_w')::pls_util_cta_pck.t_varchar2_table_50(i), current_setting('pls_sib_geracao_pck.tb_nr_plano_operadora_w')::pls_util_cta_pck.t_varchar2_table_50(i), current_setting('pls_sib_geracao_pck.tb_nr_plano_portabilidade_w')::pls_util_cta_pck.t_varchar2_table_50(i),
				current_setting('pls_sib_geracao_pck.tb_ie_cpt_w')::pls_util_cta_pck.t_number_table(i), current_setting('pls_sib_geracao_pck.tb_ie_itens_excluidos_cober_w')::pls_util_cta_pck.t_number_table(i), current_setting('pls_sib_geracao_pck.tb_nr_cnpj_w')::pls_util_cta_pck.t_varchar2_table_15(i), current_setting('pls_sib_geracao_pck.tb_nr_cei_w')::pls_util_cta_pck.t_varchar2_table_50(i), current_setting('pls_sib_geracao_pck.tb_cd_caepf_w')::pls_util_cta_pck.t_varchar2_table_15(i),
				current_setting('pls_sib_geracao_pck.tb_nr_seq_parentesco_w')::pls_util_cta_pck.t_number_table(i), current_setting('pls_sib_geracao_pck.tb_cd_relacao_dependencia_w')::pls_util_cta_pck.t_number_table(i), current_setting('pls_sib_geracao_pck.tb_ie_tipo_endereco_w')::pls_util_cta_pck.t_varchar2_table_5(i), current_setting('pls_sib_geracao_pck.tb_ds_logradouro_w')::pls_util_cta_pck.t_varchar2_table_255(i),
				current_setting('pls_sib_geracao_pck.tb_nr_logradouro_w')::pls_util_cta_pck.t_varchar2_table_5(i), current_setting('pls_sib_geracao_pck.tb_ds_complemento_w')::pls_util_cta_pck.t_varchar2_table_255(i), current_setting('pls_sib_geracao_pck.tb_ds_bairro_w')::pls_util_cta_pck.t_varchar2_table_255(i), current_setting('pls_sib_geracao_pck.tb_cd_municipio_ibge_w')::pls_util_cta_pck.t_varchar2_table_15(i),
				current_setting('pls_sib_geracao_pck.tb_cd_cep_w')::pls_util_cta_pck.t_varchar2_table_15(i), current_setting('pls_sib_geracao_pck.tb_ie_reside_exterior_w')::pls_util_cta_pck.t_varchar2_table_5(i), current_setting('pls_sib_geracao_pck.tb_cd_municipio_ibge_resid_w')::pls_util_cta_pck.t_varchar2_table_15(i),
				current_setting('pls_sib_geracao_pck.tb_nr_seq_reenvio_w')::pls_util_cta_pck.t_number_table(i), current_setting('pls_sib_geracao_pck.tb_nr_seq_status_inclusao_w')::pls_util_cta_pck.t_number_table(i), current_setting('pls_sib_geracao_pck.tb_nr_seq_status_exclusao_w')::pls_util_cta_pck.t_number_table(i),
				current_setting('pls_sib_geracao_pck.tb_ie_retificacao_null_w')::pls_util_cta_pck.t_varchar2_table_5(i))
			RETURNING nr_sequencia
			bulk collect into tb_nr_seq_movimento_wrr;
		commit;

		--Necessario percorrer o vetor do RETURNING para reposicionar, pois o RETURNIN comeca no indice 1 ao inves de 0 - Necessario para o FORALL abaixo

		for i in tb_nr_seq_movimento_wrr.first..tb_nr_seq_movimento_wrr.last loop
			tb_nr_seq_movimento_wr(i-1)	:= tb_nr_seq_movimento_wrr(i);
		end loop;

		forall i in tb_nr_seq_movimento_wr.first..tb_nr_seq_movimento_wr.last
			insert	into	pls_sib_movimento_ant(	nr_sequencia, nr_seq_movimento, dt_atualizacao, nm_usuario, dt_atualizacao_nrec, nm_usuario_nrec,
				nm_beneficiario, nm_mae, dt_nascimento, nr_cpf,
				nr_cns, nr_pis_pasep, nr_dn, cd_sexo,
				dt_cancelamento, cd_motivo_cancelamento, dt_reativacao, cd_beneficiario,
				cd_beneficiario_titular, dt_contratacao, nr_plano_ans, nr_plano_operadora,
				nr_plano_portabilidade, ie_cpt, ie_itens_excluidos_cobertura, nr_cnpj,
				nr_cei, cd_caepf, cd_relacao_dependencia, ie_tipo_endereco, ds_logradouro,
				nr_logradouro, ds_complemento, ds_bairro, cd_municipio_ibge,
				cd_cep, ie_reside_exterior, cd_municipio_ibge_resid)
			values (	nextval('pls_sib_movimento_ant_seq'), tb_nr_seq_movimento_wr(i), clock_timestamp(), 'rlepinski', clock_timestamp(), 'rlepinski',
				current_setting('pls_sib_geracao_pck.tb_nm_beneficiario_ant_w')::pls_util_cta_pck.t_varchar2_table_255(i), current_setting('pls_sib_geracao_pck.tb_nm_mae_ant_w')::pls_util_cta_pck.t_varchar2_table_255(i), current_setting('pls_sib_geracao_pck.tb_dt_nascimento_ant_w')::pls_util_cta_pck.t_date_table(i), current_setting('pls_sib_geracao_pck.tb_nr_cpf_ant_w')::pls_util_cta_pck.t_varchar2_table_15(i),
				current_setting('pls_sib_geracao_pck.tb_nr_cns_ant_w')::pls_util_cta_pck.t_number_table(i), current_setting('pls_sib_geracao_pck.tb_nr_pis_pasep_ant_w')::pls_util_cta_pck.t_varchar2_table_15(i), current_setting('pls_sib_geracao_pck.tb_nr_dn_ant_w')::pls_util_cta_pck.t_varchar2_table_15(i), current_setting('pls_sib_geracao_pck.tb_cd_sexo_ant_w')::pls_util_cta_pck.t_number_table(i),
				current_setting('pls_sib_geracao_pck.tb_dt_rescisao_ant_w')::pls_util_cta_pck.t_date_table(i), current_setting('pls_sib_geracao_pck.tb_cd_motivo_cancel_ant_w')::pls_util_cta_pck.t_varchar2_table_5(i), current_setting('pls_sib_geracao_pck.tb_dt_reativacao_ant_w')::pls_util_cta_pck.t_date_table(i), current_setting('pls_sib_geracao_pck.tb_cd_beneficiario_ant_w')::pls_util_cta_pck.t_varchar2_table_50(i),
				current_setting('pls_sib_geracao_pck.tb_cd_beneficiario_tit_ant_w')::pls_util_cta_pck.t_varchar2_table_50(i), current_setting('pls_sib_geracao_pck.tb_dt_contratacao_ant_w')::pls_util_cta_pck.t_date_table(i), current_setting('pls_sib_geracao_pck.tb_nr_plano_ans_ant_w')::pls_util_cta_pck.t_varchar2_table_50(i), current_setting('pls_sib_geracao_pck.tb_nr_plano_operadora_ant_w')::pls_util_cta_pck.t_varchar2_table_50(i),
				current_setting('pls_sib_geracao_pck.tb_nr_plano_portab_ant_w')::pls_util_cta_pck.t_varchar2_table_50(i), current_setting('pls_sib_geracao_pck.tb_ie_cpt_ant_w')::pls_util_cta_pck.t_number_table(i), current_setting('pls_sib_geracao_pck.tb_ie_itens_excluidos_ant_w')::pls_util_cta_pck.t_number_table(i), current_setting('pls_sib_geracao_pck.tb_nr_cnpj_ant_w')::pls_util_cta_pck.t_varchar2_table_15(i),
				current_setting('pls_sib_geracao_pck.tb_nr_cei_ant_w')::pls_util_cta_pck.t_varchar2_table_50(i), current_setting('pls_sib_geracao_pck.tb_cd_caepf_ant_w')::pls_util_cta_pck.t_varchar2_table_15(i), current_setting('pls_sib_geracao_pck.tb_cd_relacao_depend_ant_w')::pls_util_cta_pck.t_number_table(i), current_setting('pls_sib_geracao_pck.tb_ie_tipo_endereco_ant_w')::pls_util_cta_pck.t_varchar2_table_5(i), current_setting('pls_sib_geracao_pck.tb_ds_logradouro_ant_w')::pls_util_cta_pck.t_varchar2_table_255(i),
				current_setting('pls_sib_geracao_pck.tb_nr_logradouro_ant_w')::pls_util_cta_pck.t_varchar2_table_5(i), current_setting('pls_sib_geracao_pck.tb_ds_complemento_ant_w')::pls_util_cta_pck.t_varchar2_table_255(i), current_setting('pls_sib_geracao_pck.tb_ds_bairro_ant_w')::pls_util_cta_pck.t_varchar2_table_255(i), current_setting('pls_sib_geracao_pck.tb_cd_municipio_ibge_ant_w')::pls_util_cta_pck.t_varchar2_table_15(i),
				current_setting('pls_sib_geracao_pck.tb_cd_cep_ant_w')::pls_util_cta_pck.t_varchar2_table_15(i), current_setting('pls_sib_geracao_pck.tb_ie_reside_exterior_ant_w')::pls_util_cta_pck.t_varchar2_table_5(i), current_setting('pls_sib_geracao_pck.tb_cd_municipio_ibge_res_ant_w')::pls_util_cta_pck.t_varchar2_table_15(i)
				);
		commit;

		CALL CALL CALL CALL pls_sib_geracao_pck.limpar_vetor();
	end if;
else
	PERFORM set_config('pls_sib_geracao_pck.indice_w', current_setting('pls_sib_geracao_pck.indice_w')::bigint + 1, false);
end if;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_sib_geracao_pck.inserir_movimentacao ( ie_final_p text) FROM PUBLIC;
