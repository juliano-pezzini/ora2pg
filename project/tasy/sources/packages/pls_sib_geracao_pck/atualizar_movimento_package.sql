-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_sib_geracao_pck.atualizar_movimento ( nr_seq_movimento_p pls_sib_movimento.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p pls_parametros.cd_estabelecimento%type) AS $body$
DECLARE


nr_seq_segurado_w		pls_sib_movimento.nr_seq_segurado%type;
ie_tipo_movimento_w		pls_sib_movimento.ie_tipo_movimento%type;
dt_contratacao_w		pls_sib_movimento.dt_contratacao%type;
dt_rescisao_w			pls_segurado_status.dt_final%type;
nr_seq_motivo_cancel_w		pls_segurado_status.nr_seq_motivo_cancelamento%type;
dt_reativacao_w			pls_sib_movimento.dt_reativacao%type;
nr_seq_lote_w			pls_sib_movimento.nr_seq_lote%type;
nr_seq_arquivo_w		pls_sib_movimento.nr_seq_arquivo%type;
nr_seq_reenvio_w		pls_sib_movimento.nr_seq_reenvio%type;
nr_seq_status_inclusao_w	pls_sib_movimento.nr_seq_status_inclusao%type;
nr_seq_status_exclusao_w	pls_sib_movimento.nr_seq_status_exclusao%type;
ie_gerou_inclusao_w		varchar(1);


BEGIN
CALL CALL CALL CALL pls_sib_geracao_pck.limpar_vetor();
if (nr_seq_movimento_p IS NOT NULL AND nr_seq_movimento_p::text <> '') then
	select	nr_seq_segurado,
		ie_tipo_movimento,
		dt_contratacao,
		dt_cancelamento,
		nr_seq_motivo_cancelamento,
		dt_reativacao,
		nr_seq_lote,
		nr_seq_arquivo,
		nr_seq_reenvio,
		nr_seq_status_inclusao,
		nr_seq_status_exclusao
	into STRICT	nr_seq_segurado_w,
		ie_tipo_movimento_w,
		dt_contratacao_w,
		dt_rescisao_w,
		nr_seq_motivo_cancel_w,
		dt_reativacao_w,
		nr_seq_lote_w,
		nr_seq_arquivo_w,
		nr_seq_reenvio_w,
		nr_seq_status_inclusao_w,
		nr_seq_status_exclusao_w
	from	pls_sib_movimento
	where	nr_sequencia = nr_seq_movimento_p;

	CALL pls_sib_dados_benef_pck.carregar_dados(nr_seq_segurado_w, cd_estabelecimento_p);

	--Os metodos abaixo sao utilizados aqui devido a verificacao de regra dos campos a serem apresentados ja existente nela.

	if (ie_tipo_movimento_w = 1) then
		ie_gerou_inclusao_w := pls_sib_geracao_pck.gerar_inclusao(nr_seq_segurado_w, dt_contratacao_w, nr_seq_reenvio_w, coalesce(nr_seq_status_inclusao_w, nr_seq_status_exclusao_w), ie_gerou_inclusao_w);
	elsif (ie_tipo_movimento_w = 2) then
		gerar_retificacao(nr_seq_segurado_w, 'N', 'N', 'N', nr_seq_reenvio_w);
	elsif (ie_tipo_movimento_w = 3) then
		CALL pls_sib_geracao_pck.gerar_mudanca_contratual(nr_seq_segurado_w, dt_contratacao_w, nr_seq_reenvio_w, coalesce(nr_seq_status_inclusao_w, nr_seq_status_exclusao_w));
	elsif (ie_tipo_movimento_w = 4) then
		gerar_cancelamento(nr_seq_segurado_w, dt_rescisao_w, nr_seq_motivo_cancel_w, nr_seq_reenvio_w, coalesce(nr_seq_status_inclusao_w, nr_seq_status_exclusao_w));
	elsif (ie_tipo_movimento_w = 5) then
		CALL pls_sib_geracao_pck.gerar_reinclusao(nr_seq_segurado_w, dt_reativacao_w, nr_seq_reenvio_w, coalesce(nr_seq_status_inclusao_w, nr_seq_status_exclusao_w));
	end if;

	if (current_setting('pls_sib_geracao_pck.tb_nr_seq_segurado_w')::pls_util_cta_pck.t_number_table.count > 0) then
		update	pls_sib_movimento
		set	cd_cco				= current_setting('pls_sib_geracao_pck.tb_cd_cco_w')::pls_util_cta_pck.t_varchar2_table_15(0),
			nm_beneficiario			= current_setting('pls_sib_geracao_pck.tb_nm_beneficiario_w')::pls_util_cta_pck.t_varchar2_table_255(0),
			dt_cancelamento			= current_setting('pls_sib_geracao_pck.tb_dt_rescisao_w')::pls_util_cta_pck.t_date_table(0),
			nr_seq_motivo_cancelamento	= current_setting('pls_sib_geracao_pck.tb_nr_seq_motivo_cancel_w')::pls_util_cta_pck.t_number_table(0),
			cd_motivo_cancelamento		= current_setting('pls_sib_geracao_pck.tb_cd_motivo_cancelamento_w')::pls_util_cta_pck.t_varchar2_table_5(0),
			dt_reativacao			= current_setting('pls_sib_geracao_pck.tb_dt_reativacao_w')::pls_util_cta_pck.t_date_table(0),
			dt_nascimento			= current_setting('pls_sib_geracao_pck.tb_dt_nascimento_w')::pls_util_cta_pck.t_date_table(0),
			cd_sexo				= current_setting('pls_sib_geracao_pck.tb_cd_sexo_w')::pls_util_cta_pck.t_number_table(0),
			nr_cpf				= current_setting('pls_sib_geracao_pck.tb_nr_cpf_w')::pls_util_cta_pck.t_varchar2_table_15(0),
			nr_pis_pasep			= current_setting('pls_sib_geracao_pck.tb_nr_pis_pasep_w')::pls_util_cta_pck.t_varchar2_table_15(0),
			nm_mae				= current_setting('pls_sib_geracao_pck.tb_nm_mae_w')::pls_util_cta_pck.t_varchar2_table_255(0),
			nr_dn				= current_setting('pls_sib_geracao_pck.tb_nr_dn_w')::pls_util_cta_pck.t_varchar2_table_15(0),
			nr_cns				= current_setting('pls_sib_geracao_pck.tb_nr_cns_w')::pls_util_cta_pck.t_number_table(0),
			cd_beneficiario			= current_setting('pls_sib_geracao_pck.tb_cd_beneficiario_w')::pls_util_cta_pck.t_varchar2_table_50(0),
			cd_beneficiario_titular		= current_setting('pls_sib_geracao_pck.tb_cd_beneficiario_titular_w')::pls_util_cta_pck.t_varchar2_table_50(0),
			dt_contratacao			= current_setting('pls_sib_geracao_pck.tb_dt_contratacao_w')::pls_util_cta_pck.t_date_table(0),
			nr_seq_plano			= current_setting('pls_sib_geracao_pck.tb_nr_seq_plano_w')::pls_util_cta_pck.t_number_table(0),
			nr_plano_ans			= current_setting('pls_sib_geracao_pck.tb_nr_plano_ans_w')::pls_util_cta_pck.t_varchar2_table_50(0),
			nr_plano_operadora		= current_setting('pls_sib_geracao_pck.tb_nr_plano_operadora_w')::pls_util_cta_pck.t_varchar2_table_50(0),
			nr_plano_portabilidade		= current_setting('pls_sib_geracao_pck.tb_nr_plano_portabilidade_w')::pls_util_cta_pck.t_varchar2_table_50(0),
			ie_cpt				= current_setting('pls_sib_geracao_pck.tb_ie_cpt_w')::pls_util_cta_pck.t_number_table(0),
			ie_itens_excluidos_cobertura	= current_setting('pls_sib_geracao_pck.tb_ie_itens_excluidos_cober_w')::pls_util_cta_pck.t_number_table(0),
			nr_cnpj				= current_setting('pls_sib_geracao_pck.tb_nr_cnpj_w')::pls_util_cta_pck.t_varchar2_table_15(0),
			nr_cei				= current_setting('pls_sib_geracao_pck.tb_nr_cei_w')::pls_util_cta_pck.t_varchar2_table_50(0),
			cd_caepf			= current_setting('pls_sib_geracao_pck.tb_cd_caepf_w')::pls_util_cta_pck.t_varchar2_table_15(0),
			nr_seq_parentesco		= current_setting('pls_sib_geracao_pck.tb_nr_seq_parentesco_w')::pls_util_cta_pck.t_number_table(0),
			cd_relacao_dependencia		= current_setting('pls_sib_geracao_pck.tb_cd_relacao_dependencia_w')::pls_util_cta_pck.t_number_table(0),
			ie_tipo_endereco		= current_setting('pls_sib_geracao_pck.tb_ie_tipo_endereco_w')::pls_util_cta_pck.t_varchar2_table_5(0),
			ds_logradouro			= current_setting('pls_sib_geracao_pck.tb_ds_logradouro_w')::pls_util_cta_pck.t_varchar2_table_255(0),
			nr_logradouro			= current_setting('pls_sib_geracao_pck.tb_nr_logradouro_w')::pls_util_cta_pck.t_varchar2_table_5(0),
			ds_complemento			= current_setting('pls_sib_geracao_pck.tb_ds_complemento_w')::pls_util_cta_pck.t_varchar2_table_255(0),
			ds_bairro			= current_setting('pls_sib_geracao_pck.tb_ds_bairro_w')::pls_util_cta_pck.t_varchar2_table_255(0),
			cd_cep				= current_setting('pls_sib_geracao_pck.tb_cd_cep_w')::pls_util_cta_pck.t_varchar2_table_15(0),
			ie_reside_exterior		= current_setting('pls_sib_geracao_pck.tb_ie_reside_exterior_w')::pls_util_cta_pck.t_varchar2_table_5(0),
			cd_municipio_ibge		= current_setting('pls_sib_geracao_pck.tb_cd_municipio_ibge_w')::pls_util_cta_pck.t_varchar2_table_15(0),
			cd_municipio_ibge_resid		= current_setting('pls_sib_geracao_pck.tb_cd_municipio_ibge_resid_w')::pls_util_cta_pck.t_varchar2_table_15(0)
		where	nr_sequencia		= nr_seq_movimento_p;
		
		update	pls_sib_movimento_ant
		set	nm_beneficiario		= current_setting('pls_sib_geracao_pck.tb_nm_beneficiario_ant_w')::pls_util_cta_pck.t_varchar2_table_255(0),
			dt_nascimento		= current_setting('pls_sib_geracao_pck.tb_dt_nascimento_ant_w')::pls_util_cta_pck.t_date_table(0),
			nm_mae			= current_setting('pls_sib_geracao_pck.tb_nm_mae_ant_w')::pls_util_cta_pck.t_varchar2_table_255(0),
			nr_cpf			= current_setting('pls_sib_geracao_pck.tb_nr_cpf_ant_w')::pls_util_cta_pck.t_varchar2_table_15(0),
			nr_cns			= current_setting('pls_sib_geracao_pck.tb_nr_cns_ant_w')::pls_util_cta_pck.t_number_table(0),
			nr_pis_pasep		= current_setting('pls_sib_geracao_pck.tb_nr_pis_pasep_ant_w')::pls_util_cta_pck.t_varchar2_table_15(0),
			nr_dn			= current_setting('pls_sib_geracao_pck.tb_nr_dn_ant_w')::pls_util_cta_pck.t_varchar2_table_15(0),
			cd_sexo			= current_setting('pls_sib_geracao_pck.tb_cd_sexo_ant_w')::pls_util_cta_pck.t_number_table(0),
			dt_cancelamento		= current_setting('pls_sib_geracao_pck.tb_dt_rescisao_ant_w')::pls_util_cta_pck.t_date_table(0),
			cd_motivo_cancelamento	= current_setting('pls_sib_geracao_pck.tb_cd_motivo_cancel_ant_w')::pls_util_cta_pck.t_varchar2_table_5(0),
			dt_reativacao		= current_setting('pls_sib_geracao_pck.tb_dt_reativacao_ant_w')::pls_util_cta_pck.t_date_table(0),
			cd_beneficiario		= current_setting('pls_sib_geracao_pck.tb_cd_beneficiario_ant_w')::pls_util_cta_pck.t_varchar2_table_50(0),
			cd_beneficiario_titular	= current_setting('pls_sib_geracao_pck.tb_cd_beneficiario_tit_ant_w')::pls_util_cta_pck.t_varchar2_table_50(0),
			dt_contratacao		= current_setting('pls_sib_geracao_pck.tb_dt_contratacao_ant_w')::pls_util_cta_pck.t_date_table(0),
			nr_plano_ans		= current_setting('pls_sib_geracao_pck.tb_nr_plano_ans_ant_w')::pls_util_cta_pck.t_varchar2_table_50(0),
			nr_plano_operadora	= current_setting('pls_sib_geracao_pck.tb_nr_plano_operadora_ant_w')::pls_util_cta_pck.t_varchar2_table_50(0),
			nr_plano_portabilidade	= current_setting('pls_sib_geracao_pck.tb_nr_plano_portab_ant_w')::pls_util_cta_pck.t_varchar2_table_50(0),
			ie_cpt			= current_setting('pls_sib_geracao_pck.tb_ie_cpt_ant_w')::pls_util_cta_pck.t_number_table(0),
			ie_itens_excluidos_cobertura	= current_setting('pls_sib_geracao_pck.tb_ie_itens_excluidos_ant_w')::pls_util_cta_pck.t_number_table(0),
			nr_cnpj			= current_setting('pls_sib_geracao_pck.tb_nr_cnpj_ant_w')::pls_util_cta_pck.t_varchar2_table_15(0),
			nr_cei			= current_setting('pls_sib_geracao_pck.tb_nr_cei_ant_w')::pls_util_cta_pck.t_varchar2_table_50(0),
			cd_caepf		= current_setting('pls_sib_geracao_pck.tb_cd_caepf_ant_w')::pls_util_cta_pck.t_varchar2_table_15(0),
			cd_relacao_dependencia	= current_setting('pls_sib_geracao_pck.tb_cd_relacao_depend_ant_w')::pls_util_cta_pck.t_number_table(0),
			ie_tipo_endereco	= current_setting('pls_sib_geracao_pck.tb_ie_tipo_endereco_ant_w')::pls_util_cta_pck.t_varchar2_table_5(0),
			ds_logradouro		= current_setting('pls_sib_geracao_pck.tb_ds_logradouro_ant_w')::pls_util_cta_pck.t_varchar2_table_255(0),
			nr_logradouro		= current_setting('pls_sib_geracao_pck.tb_nr_logradouro_ant_w')::pls_util_cta_pck.t_varchar2_table_5(0),
			ds_complemento		= current_setting('pls_sib_geracao_pck.tb_ds_complemento_ant_w')::pls_util_cta_pck.t_varchar2_table_255(0),
			ds_bairro		= current_setting('pls_sib_geracao_pck.tb_ds_bairro_ant_w')::pls_util_cta_pck.t_varchar2_table_255(0),
			cd_cep			= current_setting('pls_sib_geracao_pck.tb_cd_cep_ant_w')::pls_util_cta_pck.t_varchar2_table_15(0),
			ie_reside_exterior	= current_setting('pls_sib_geracao_pck.tb_ie_reside_exterior_ant_w')::pls_util_cta_pck.t_varchar2_table_5(0),
			cd_municipio_ibge	= current_setting('pls_sib_geracao_pck.tb_cd_municipio_ibge_ant_w')::pls_util_cta_pck.t_varchar2_table_15(0),
			cd_municipio_ibge_resid	= current_setting('pls_sib_geracao_pck.tb_cd_municipio_ibge_res_ant_w')::pls_util_cta_pck.t_varchar2_table_15(0)
		where	nr_seq_movimento	= nr_seq_movimento_p;
	elsif (ie_tipo_movimento_w = 2) then --Quando atualizar um registro de retificacao e nao for mais identificada nenhuma alteracao, deleta o registro pois nao ha o que retificar para a ANS
		delete	from	pls_sib_movimento
		where	nr_sequencia	= nr_seq_movimento_p;
		
		update	pls_sib_arquivo
		set	qt_movimentacao	= qt_movimentacao-1
		where	nr_sequencia	= nr_seq_arquivo_w
		and	nr_seq_lote	= nr_seq_lote_w;
		
		update	pls_sib_lote
		set	qt_retificacao	= qt_retificacao-1,
			qt_movimentacao	= qt_movimentacao-1
		where	nr_sequencia	= nr_seq_lote_w;
	end if;
	CALL pls_sib_geracao_pck.consistir_sib( nr_seq_lote_w, nr_seq_movimento_p, nm_usuario_p, cd_estabelecimento_p);
	commit;
end if;
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_sib_geracao_pck.atualizar_movimento ( nr_seq_movimento_p pls_sib_movimento.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p pls_parametros.cd_estabelecimento%type) FROM PUBLIC;
