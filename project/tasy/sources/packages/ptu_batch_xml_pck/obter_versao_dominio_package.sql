-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION ptu_batch_xml_pck.obter_versao_dominio ( cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nr_seq_congenere_p pls_congenere.nr_sequencia%type, cd_cooperativa_p pls_congenere.cd_cooperativa%type, dt_referencia_p timestamp, ie_tipo_ptu_p text ) RETURNS varchar AS $body$
DECLARE


ds_retorno_w		varchar(255);
nr_seq_congenere_w	pls_congenere.nr_sequencia%type := nr_seq_congenere_p;

C01 CURSOR(	cd_estabelecimento_pc		estabelecimento.cd_estabelecimento%type,
		nr_seq_congenere_pc		pls_congenere.nr_sequencia%type,
		dt_referencia_pc		timestamp,
		ie_tipo_ptu_pc			text )FOR
	SELECT	cd_versao_ptu_xml
	from	ptu_regra_interface
	where	((nr_seq_congenere = nr_seq_congenere_pc) or (coalesce(nr_seq_congenere::text, '') = ''))
	and	cd_estabelecimento = cd_estabelecimento_pc
	and	dt_inicio_vigencia <= dt_referencia_pc
	and	ie_tipo_ptu = ie_tipo_ptu_pc
	order by dt_inicio_vigencia,
		coalesce(nr_seq_congenere,0);

BEGIN
if (coalesce(nr_seq_congenere_w::text, '') = '') and (cd_cooperativa_p IS NOT NULL AND cd_cooperativa_p::text <> '') then
	nr_seq_congenere_w := somente_numero(substr(pls_obter_seq_cod_cooperativa(lpad(cd_cooperativa_p,4,0),null),1,255));
end if;

for r_c01_w in c01( cd_estabelecimento_p, nr_seq_congenere_w, trunc(dt_referencia_p), ie_tipo_ptu_p ) loop
	ds_retorno_w := r_c01_w.cd_versao_ptu_xml;
end loop;

return	ds_retorno_w;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION ptu_batch_xml_pck.obter_versao_dominio ( cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nr_seq_congenere_p pls_congenere.nr_sequencia%type, cd_cooperativa_p pls_congenere.cd_cooperativa%type, dt_referencia_p timestamp, ie_tipo_ptu_p text ) FROM PUBLIC;
