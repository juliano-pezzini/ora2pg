-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION cf_relatives_pck.get_all_relatives ( CD_PESSOA_FISICA_P pessoa_fisica.cd_pessoa_fisica%TYPE, show_default_p pessoa_fisica.IE_SEXO%TYPE default 'S') RETURNS SETOF T_RELATIVES_TABLE AS $body$
DECLARE

        RELATIVES_ROW_W T_RELATIVES_ROW;
        ie_possui_pai_mae char(1) := 'N';
        C_RELATIVES CURSOR FOR SELECT
                               F.nr_sequencia cd_id,
                               coalesce((substr(obter_nome_pf(F.cd_pessoa_familia),1,300)), F.ds_given_name || ' ' || F.ds_family_name) ds_name,
                               G.ie_grau_parentesco ie_member_type,
                               F.ie_gender ie_gender,
                               obter_valor_dominio(4, F.ie_gender) ds_gender,
                               CASE WHEN F.si_blood_type='N' THEN  ''  ELSE F.si_blood_type END  || CASE WHEN F.si_rh_factor='N' THEN  ''  ELSE F.si_rh_factor END  ds_blood_type,
                               G.ds_parentesco ds_member,
                               F.nr_seq_member_sup cd_relative_member,
                               CASE WHEN F.si_familiarity=1 THEN  'S'  ELSE 'N' END  ie_living_together,
                               CASE WHEN F.si_situation='2' THEN  'S'  ELSE 'N' END  ie_deceased,
                               CASE WHEN F.si_inlaw='0' THEN  'N'  ELSE 'S' END  ie_in_law,
                               CASE WHEN F.si_key_person='0' THEN  'N'  ELSE 'S' END  ie_key_person,
                               qt_age qt_age
                            FROM pf_familia F, 
                                 grau_parentesco G 
                            WHERE F.cd_pessoa_fisica = cd_pessoa_fisica_p
                                 AND F.nr_seq_grau_parentesco = G.nr_sequencia
                                 AND G.ie_grau_parentesco IN (3,5,6,7,9,12,13, 14, 15)
                            ORDER BY
                               ie_member_type,
                               CASE F.ie_gender WHEN 'M' THEN 1 WHEN 'F' THEN 2 ELSE 3 END;

BEGIN 

        /*   ie_grau_parentesco = 6 : FATHER
         *   ie_grau_parentesco = 5 : MOTHER
         */
        SELECT 
            coalesce(MAX('S'),'N')
        INTO STRICT ie_possui_pai_mae
        FROM pf_familia F 
        INNER JOIN grau_parentesco G ON
            F.nr_seq_grau_parentesco = G.nr_sequencia 
        WHERE 
            F.cd_pessoa_fisica = cd_pessoa_fisica_p AND
            G.ie_grau_parentesco IN (5,6);

        FOR C_ROW IN C_RELATIVES LOOP

            RELATIVES_ROW_W.cd_id               := C_ROW.cd_id;
            RELATIVES_ROW_W.ds_name             := C_ROW.ds_name;
            RELATIVES_ROW_W.ie_member_type      := C_ROW.ie_member_type;
            RELATIVES_ROW_W.ie_gender           := C_ROW.ie_gender;
            RELATIVES_ROW_W.ds_gender           := C_ROW.ds_gender;
            RELATIVES_ROW_W.ds_blood_type       := C_ROW.ds_blood_type;
            RELATIVES_ROW_W.ds_member           := C_ROW.ds_member;
            RELATIVES_ROW_W.cd_relative_member  := C_ROW.cd_relative_member;
            RELATIVES_ROW_W.ie_living_together  := C_ROW.ie_living_together;
            RELATIVES_ROW_W.ie_deceased         := C_ROW.ie_deceased;
            RELATIVES_ROW_W.ie_in_law           := C_ROW.ie_in_law;
            RELATIVES_ROW_W.ie_key_person       := C_ROW.ie_key_person;
            RELATIVES_ROW_W.qt_age              := C_ROW.qt_age;

            RETURN NEXT RELATIVES_ROW_W;
        END LOOP;

        IF ( ie_possui_pai_mae = 'N' and show_default_p ='S'  ) THEN
            RELATIVES_ROW_W.cd_id               := null;
            RELATIVES_ROW_W.ds_name             := null;
            RELATIVES_ROW_W.ie_member_type      := 5;
            RELATIVES_ROW_W.ie_gender           := 'I';
            RELATIVES_ROW_W.ds_gender           := obter_valor_dominio(4, 'I');
            RELATIVES_ROW_W.ds_blood_type       := null;
            RELATIVES_ROW_W.ds_member           := obter_desc_expressao(305554,'Pais');
            RELATIVES_ROW_W.cd_relative_member  := null;
            RELATIVES_ROW_W.ie_living_together  := null;
            RELATIVES_ROW_W.ie_deceased         := null;
            RELATIVES_ROW_W.ie_in_law           := null;
            RELATIVES_ROW_W.ie_key_person       := null;
            RELATIVES_ROW_W.qt_age              := null;

            RETURN NEXT RELATIVES_ROW_W;
        END IF;

    END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION cf_relatives_pck.get_all_relatives ( CD_PESSOA_FISICA_P pessoa_fisica.cd_pessoa_fisica%TYPE, show_default_p pessoa_fisica.IE_SEXO%TYPE default 'S') FROM PUBLIC;
