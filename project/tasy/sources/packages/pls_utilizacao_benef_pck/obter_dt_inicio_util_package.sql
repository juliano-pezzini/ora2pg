-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pls_utilizacao_benef_pck.obter_dt_inicio_util ( param_util_p param_utilizacao_benef, dt_inicio_p timestamp, nr_seq_segurado_p pls_segurado.nr_sequencia%type) RETURNS timestamp AS $body$
DECLARE

				
/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade:	Determina a data de inicio da utilizacao a ser pesquisada.
-------------------------------------------------------------------------------------------------------------------
Locais de chamada direta: 
[X]  Objetos do dicionario [ ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatorios [ ] Outros:
-------------------------------------------------------------------------------------------------------------------
Pontos de atencao:
	A data de inicio de utilizacao e passada por parametro, mas existem situacoes
	onde a operadora quer determinar uma "data  minima" que o beneficiario podera
	pesquisar, idenpendente do inicio do contrato ou nao.
	
	Nestes casos e utilizada o parametro da operadora.
Alteracoes:
-------------------------------------------------------------------------------------------------------------------
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
dt_retorno_w	timestamp;

BEGIN

-- Se nao tiver data informada por parametro, busca a data de contratualizacao do beneficiario
-- Verifica a data de inicio, se nao for informada no parametro, sera considerada a data de inicio do contrato do beneficiario conforme a RN
dt_retorno_w	:= trunc(coalesce(dt_inicio_p, to_date(pls_obter_dados_segurado(nr_seq_segurado_p, 'D'), 'dd/mm/yyyy')),'dd');

-- verifica se a data do parametro (ou contrato) e inferior a data minima determinada pela operadora, se for, prevalecera a data da operadora
if (param_util_p.dt_inicio_apresent IS NOT NULL AND param_util_p.dt_inicio_apresent::text <> '') or (coalesce(dt_retorno_w::text, '') = '') then
	
	--  Se nao achou a data de inicio, ou a data e inferior a data parametrizada, usa por padrao a data parametrizada
	if (trunc(param_util_p.dt_inicio_apresent, 'dd') > dt_retorno_w) or (coalesce(dt_retorno_w::text, '') = '') then
	
		dt_retorno_w := trunc(param_util_p.dt_inicio_apresent, 'dd');
	end if;
end if;

-- se nao conseguiu achar nenhuma data, aborta a operacao
if (coalesce(dt_retorno_w::text, '') = '') then

	CALL wheb_mensagem_pck.exibir_mensagem_abort(784749);
end if;

return dt_retorno_w;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pls_utilizacao_benef_pck.obter_dt_inicio_util ( param_util_p param_utilizacao_benef, dt_inicio_p timestamp, nr_seq_segurado_p pls_segurado.nr_sequencia%type) FROM PUBLIC;
