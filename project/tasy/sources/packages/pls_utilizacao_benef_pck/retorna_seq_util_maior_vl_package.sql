-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pls_utilizacao_benef_pck.retorna_seq_util_maior_vl ( nr_id_transacao_p w_pls_utilizacao_benef.nr_id_transacao%type, cd_guia_ok_p pls_conta.cd_guia_ok%type, nr_seq_segurado_p pls_conta.nr_seq_segurado%type) RETURNS bigint AS $body$
DECLARE

/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade:	Retorna o atendimento da guia  e segurado
-------------------------------------------------------------------------------------------------------------------
Locais de chamada direta: 
[X]  Objetos do dicionario [ ] Tasy (Delphi/Java) [ ] Portal [  ]  Relatorios [ ] Outros:
-------------------------------------------------------------------------------------------------------------------
Pontos de atencao:

	Retorna o sequencial do atendimento com maior valor de item, dentro do conjunto
	de transacao, cd_guia_ok e nr_se_segurado.
	
	Caso o conjunto (transacao, cd_guia_ok e nr_se_segurado) possuir uma internacao 
	e tambem outros tipos, sera priorizado a internacao neste caso.
	
	Se acabar varrendo os itens e nao encontrar nenhum com itens, busca o atendimento de maior 
	valor compreendido no conjunto (transacao, cd_guia_ok e nr_se_segurado)  sem olhar os itens.
	Isso e necessario para os casos de atendimentos que terao apenas materiais, ou seja, os procedimentos
	sao inexistentes, e portanto naquele momento o atendimento nao tem nenhum item ainda.
	
Alteracoes:
-------------------------------------------------------------------------------------------------------------------
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
ds_retorno_w	bigint;

-- Pega o sequencial do atendimento em ordem ascendente do item e grupo ANS, priorizando a internacao
c01 CURSOR(	nr_id_transacao_pc	w_pls_utilizacao_benef.nr_id_transacao%type,
		cd_guia_ok_pc		pls_conta.cd_guia_ok%type,
		nr_seq_segurado_pc	pls_conta.nr_seq_segurado%type) FOR
	SELECT	a.nr_sequencia
	from	w_pls_utilizacao_benef	a,
		w_pls_util_benef_item	b
	where	b.nr_seq_util_benef	= a.nr_sequencia
	and	a.cd_guia_ok		= cd_guia_ok_pc
	and	a.nr_seq_segurado	= nr_seq_segurado_pc
	and	a.nr_id_transacao	= nr_id_transacao_pc
	order by CASE WHEN a.ie_grupo_ans='I' THEN  99  ELSE 0 END  asc, b.vl_item asc;
	
-- Pega o sequencial do atendimento em ordem ascendente do valor do atendimento, desprezando a existencia de itens
c02 CURSOR(	nr_id_transacao_pc	w_pls_utilizacao_benef.nr_id_transacao%type,
		cd_guia_ok_pc		pls_conta.cd_guia_ok%type,
		nr_seq_segurado_pc	pls_conta.nr_seq_segurado%type) FOR
	SELECT	a.nr_sequencia
	from	w_pls_utilizacao_benef	a
	where	a.cd_guia_ok		= cd_guia_ok_pc
	and	a.nr_seq_segurado	= nr_seq_segurado_pc
	and	a.nr_id_transacao	= nr_id_transacao_pc
	order by CASE WHEN a.ie_grupo_ans='I' THEN  99  ELSE 0 END  asc, a.vl_utilizacao asc;
BEGIN

-- percorre o cursor e deixa registrado o ultimo sequencial, sendo este considerado o de maior valor
for r_c01_w in c01(nr_id_transacao_p, cd_guia_ok_p, nr_seq_segurado_p) loop

	ds_retorno_w := r_c01_w.nr_sequencia;
end loop;

-- Se nao encontrou nenhum com item, procura nos atendimentos apenas
if (coalesce(ds_retorno_w::text, '') = '') then

	for r_c02_w in c02(nr_id_transacao_p, cd_guia_ok_p, nr_seq_segurado_p) loop
	
		ds_retorno_w := r_c02_w.nr_sequencia;
	end loop;
end if;

return ds_retorno_w;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pls_utilizacao_benef_pck.retorna_seq_util_maior_vl ( nr_id_transacao_p w_pls_utilizacao_benef.nr_id_transacao%type, cd_guia_ok_p pls_conta.cd_guia_ok%type, nr_seq_segurado_p pls_conta.nr_seq_segurado%type) FROM PUBLIC;
