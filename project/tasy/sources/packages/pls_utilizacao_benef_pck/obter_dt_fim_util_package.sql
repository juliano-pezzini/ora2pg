-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pls_utilizacao_benef_pck.obter_dt_fim_util ( param_util_p param_utilizacao_benef, dt_fim_p timestamp) RETURNS timestamp AS $body$
DECLARE

				
/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade:	Determina a data de fim da utilizacao a ser pesquisada.
-------------------------------------------------------------------------------------------------------------------
Locais de chamada direta: 
[X]  Objetos do dicionario [ ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatorios [ ] Outros:
-------------------------------------------------------------------------------------------------------------------
Pontos de atencao:
	A data de fim de utilizacao e passada por parametro, mas existem situacoes
	onde a operadora quer determinar uma "data  minima" que o beneficiario podera
	pesquisar. Nestes casos e utilizada o parametro da operadora.
Alteracoes:
-------------------------------------------------------------------------------------------------------------------
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
dt_retorno_w	timestamp;

BEGIN

-- Tenta utilizar por padrao o valor informado por parametro
dt_retorno_w	:= fim_dia(dt_fim_p);


-- verifica se a data do parametro e superior a data maxima determinada pela operadora, se for ou se a data de parametro nao foi informada, prevalecera a data da operadora
if (param_util_p.dt_fim_apresent IS NOT NULL AND param_util_p.dt_fim_apresent::text <> '') or (coalesce(dt_retorno_w::text, '') = '') then
	
	--  Se nao tem a data da operadora E a data passada por parametro, usa a data atual
	if (coalesce(param_util_p.dt_fim_apresent::text, '') = '') and (coalesce(dt_retorno_w::text, '') = '') then
	
		dt_retorno_w := fim_dia(clock_timestamp());
	
	-- se tem as datas informadas, faz a comparacao
	elsif (trunc(param_util_p.dt_fim_apresent, 'dd') < dt_retorno_w) or (coalesce(dt_retorno_w::text, '') = '') then
	
		dt_retorno_w := trunc(param_util_p.dt_fim_apresent, 'dd');
	end if;
end if;

-- se nao conseguiu achar nenhuma data, aborta a operacao
if (coalesce(dt_retorno_w::text, '') = '') then

	CALL wheb_mensagem_pck.exibir_mensagem_abort(784750);
end if;

return fim_dia(dt_retorno_w);

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pls_utilizacao_benef_pck.obter_dt_fim_util ( param_util_p param_utilizacao_benef, dt_fim_p timestamp) FROM PUBLIC;
