-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_utilizacao_benef_pck.gera_prest_princ_util_benef ( param_util_p INOUT param_utilizacao_benef, regra_util_p INOUT regra_utilizacao_benef) AS $body$
DECLARE

_ora2pg_r RECORD;
/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade:	Levanta o prestador e medico principal do atendimento
-------------------------------------------------------------------------------------------------------------------
Locais de chamada direta: 
[X]  Objetos do dicionario [ ] Tasy (Delphi/Java) [ ] Portal [  ]  Relatorios [ ] Outros:
-------------------------------------------------------------------------------------------------------------------
Pontos de atencao:

	O prestador principal e levantado com base nos itens que compoem o atendimento
	em si, e tambem e influenciado pelo tipo de atendimento, e um parametro que determina 
	quais tipos de prestadores no atendimento serao elegiveis,  de seguindo a ordem abaixo:
	
	1 - Se o atendimento for do tipo "Internacao", o prestador do protocolo e utilizado,
		considerando que o modelo TISS permite varios protocolos com prestadores do atendimento
		diferentes na mesma internacao, para o caso de mover o segurado de recinto, 
		e considerado inicialmente o prestador do protocolo que contem o resumo de internacao
	2 - Se o item principal possuir um participante com prestador informado, e o 
		participante tem o grau de participacao '00' (cirurgiao)
	3 - Se a conta possuir informado o prestador executor
	4 - se ainda nao encontrou, utiliza o prestador do protocolo
	
	Quando o parametro "Tipo prestador" possuir o valor "[E] - Prestador executor", os prestadores
	que sao participantes nao sao considerados. Esse parametro NaO INTERFERE quando o atendimento for uma INTERNAcaO
	
	Ainda e levantado o medico principal, seguindo a ordem:
	1 - Medico participante, se for internacao sera cosniderado apenas o grau de participacao '00' (cirurgiao), 
		senao sera considerado o menor grau de participacao
	2 - Medico executor da conta
	
	No caso de conta de origem de intercambio, as tabelas de prestador sao difentes, bem como
	a coluna que e armazenada essa informacao, por isso que ela e considerada a parte.
	
	Essas regras devem ser executadas em PL e nao direto na query, por questoes de performance,
	
	Aqui nao deve ser feito nenhum DML direto, apenas levantar os dados e delegar a 
	atualiza para a rotina propria
	
	Com a atualizacao do medico / prestador, algumas informacoes relacionadas a eles sao atualizadas
	juntamente com os codigos, uma em particular e o CBO, que pode nao ser informado. Nestes casos
	ao final desta rotina e chamada a rotina que vai atribuir o valor 999999 (CBO desconhecido ou nao informado pelo solicitante)
	nos registros sem CBO
	
Alteracoes:
-------------------------------------------------------------------------------------------------------------------
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
-- tabelas virtuais
nr_seq_util_benef_w		pls_util_cta_pck.t_number_table;
ie_grupo_ans_w			pls_util_cta_pck.t_varchar2_table_10;
ie_origem_conta_w		pls_util_cta_pck.t_varchar2_table_10;
nr_seq_prest_part_w		pls_util_cta_pck.t_number_table;
nr_seq_prestador_exec_w		pls_util_cta_pck.t_number_table;
nr_seq_prest_prot_w		pls_util_cta_pck.t_number_table;
nr_seq_prest_prot_interna_w	pls_util_cta_pck.t_number_table;
nr_seq_prest_exec_inter_w	pls_util_cta_pck.t_number_table;
nr_seq_prest_part_inter_w	pls_util_cta_pck.t_number_table;
cd_medico_conta_exec_w		pls_util_cta_pck.t_varchar2_table_10;
cd_medico_particip_w		pls_util_cta_pck.t_varchar2_table_10;

nr_seq_prest_princ_w		pls_util_cta_pck.t_number_table;
nr_seq_prest_princ_inter_w	pls_util_cta_pck.t_number_table;
cd_medico_princ_w		pls_util_cta_pck.t_varchar2_table_10;

ie_tipo_protocolo_w		pls_util_cta_pck.t_varchar2_table_3;
cd_pessoa_fisica_reembolso_w	pls_util_cta_pck.t_varchar2_table_10;
cd_cnpj_reembolso_w		pls_util_cta_pck.t_varchar2_table_15;
nr_seq_cbo_reembolso_w		pls_util_cta_pck.t_number_table;
nr_seq_cbo_conta_w		pls_util_cta_pck.t_number_table;

i	integer;

-- Cursor que carrega os prestadores
c01 CURSOR(	nr_id_transacao_pc	w_pls_utilizacao_benef.nr_id_transacao%type) FOR
	SELECT	distinct a.nr_sequencia,
		a.ie_grupo_ans,
		d.ie_origem_conta,
		-- Quando for do grupo de internacao, o prestador participante deve ser obrigatoriamente cirurgiao para ser considerado.
		case	when a.ie_grupo_ans = 'I'
			then (	SELECT	max(p.nr_seq_prestador) nr_seq_prestador
					from	pls_proc_participante	p,
						pls_grau_participacao	g
					where	p.nr_seq_conta_proc	= b.nr_seq_conta_proc
					and	g.nr_sequencia		= p.nr_seq_grau_partic
					and	g.cd_tiss		= '00')
			-- Se nao for o grupo de internacao, pega o maior codigo de prestador, com o menor grau de participacao (indicando maior "importancia")
			else	(	select	max(p.nr_seq_prestador) nr_seq_prestador
					from	pls_proc_participante	p,
						pls_grau_participacao	g
					where	p.nr_seq_conta_proc	= b.nr_seq_conta_proc
					and	g.nr_sequencia		= p.nr_seq_grau_partic
					and	g.cd_tiss		= (	select	min(z.cd_tiss)
										from	pls_proc_participante	y,
											pls_grau_participacao	z
										where	z.nr_sequencia		= y.nr_seq_grau_partic
										and	y.nr_seq_conta_proc	= p.nr_seq_conta_proc))
		end nr_seq_prest_part,
		d.nr_seq_prestador_exec,
		e.nr_seq_prestador nr_seq_prest_prot,
		-- Prestador do protocolo que contem o resumo de internacao
		(	select	max(y.nr_seq_prestador) nr_seq_prest_prot_internacao
			from	pls_conta		x,
				pls_protocolo_conta	y
			where	y.nr_sequencia		= x.nr_seq_protocolo
			and	x.cd_guia_ok		= a.cd_guia_ok
			and	x.nr_seq_segurado	= a.nr_seq_segurado
			and	x.ie_tipo_guia		= '5') nr_seq_prest_prot_internacao,
		d.nr_seq_prest_inter nr_seq_prest_exec_inter,
		-- Quando for do grupo de internacao, o prestador participante deve ser obrigatoriamente cirurgiao para ser considerado.
		case	when a.ie_grupo_ans = 'I' 
			then (	select	max(p.nr_seq_prest_inter) nr_seq_prestador
					from	pls_proc_participante	p,
						pls_grau_participacao	g
					where	p.nr_seq_conta_proc	= b.nr_seq_conta_proc
					and	g.nr_sequencia		= p.nr_seq_grau_partic
					and	g.cd_tiss		= '00')
			-- Se nao for o grupo de internacao, pega o maior codigo de prestador, com o menor grau de participacao (indicando maior "importancia")
			else	(	select	max(p.nr_seq_prest_inter) nr_seq_prestador
					from	pls_proc_participante	p,
						pls_grau_participacao	g
					where	p.nr_seq_conta_proc	= b.nr_seq_conta_proc
					and	g.nr_sequencia		= p.nr_seq_grau_partic
					and	g.cd_tiss		= (	select	min(z.cd_tiss)
										from	pls_proc_participante	y,
											pls_grau_participacao	z
										where	z.nr_sequencia		= y.nr_seq_grau_partic
										and	y.nr_seq_conta_proc	= p.nr_seq_conta_proc))
		end nr_seq_prest_part_inter,
		d.cd_medico_executor,
		-- Quando for do grupo de internacao, o medico participante deve ser obrigatoriamente cirurgiao para ser considerado.
		case	when a.ie_grupo_ans = 'I' 
			then (	select	max(p.cd_medico) cd_medico
					from	pls_proc_participante	p,
						pls_grau_participacao	g
					where	p.nr_seq_conta_proc	= b.nr_seq_conta_proc
					and	g.nr_sequencia		= p.nr_seq_grau_partic
					and	g.cd_tiss		= '00') 
			-- Se nao for o grupo de internacao, pega o maior codigo de medico, com o menor grau de participacao (indicando maior "importancia")
			else	(	select	max(p.cd_medico) cd_medico
					from	pls_proc_participante	p,
						pls_grau_participacao	g
					where	p.nr_seq_conta_proc	= b.nr_seq_conta_proc
					and	g.nr_sequencia		= p.nr_seq_grau_partic
					and	g.cd_tiss		= (	select	min(z.cd_tiss)
										from	pls_proc_participante	y,
											pls_grau_participacao	z
										where	z.nr_sequencia		= y.nr_seq_grau_partic
										and	y.nr_seq_conta_proc	= p.nr_seq_conta_proc))
		end cd_medico_participante,
		-- Ainda e necessario um tratamento especial para reembolso, pois o prestador da conta pode nao estar cadastrado na pls_prestrador.
		e.ie_tipo_protocolo,
		CASE WHEN e.ie_tipo_protocolo='R' THEN  d.cd_pessoa_fisica  ELSE null END  cd_pessoa_fisica_reembolso,
		CASE WHEN e.ie_tipo_protocolo='R' THEN  d.cd_cgc  ELSE null END  cd_cnpj_reembolso,
		d.nr_seq_cbo_saude nr_seq_cbo_reembolso,
		(select	max(w.nr_seq_cbo_saude)
		from	pls_guia_plano	w
		where	w.nr_sequencia	= d.nr_seq_guia) nr_seq_cbo_conta
	from	w_pls_utilizacao_benef	a,
		w_pls_util_benef_item	b,
		pls_conta_proc		c,
		pls_conta		d,
		pls_protocolo_conta	e
	where	b.nr_seq_util_benef	= a.nr_sequencia
	and	c.nr_sequencia		= b.nr_seq_conta_proc
	and	c.cd_procedimento	= a.cd_procedimento
	and	c.ie_origem_proced	= a.ie_origem_proced
	and	d.nr_sequencia		= c.nr_seq_conta
	and	e.nr_sequencia		= d.nr_seq_protocolo
	and	a.nr_id_transacao	= nr_id_transacao_pc	
	
union all

	select	distinct a.nr_sequencia,
		a.ie_grupo_ans,
		d.ie_origem_conta,
		-- Quando for do grupo de internacao, o prestador participante deve ser obrigatoriamente cirurgiao para ser considerado.
		case	when a.ie_grupo_ans = 'I' 
			then (	select	max(p.nr_seq_prestador) nr_seq_prestador
				from	pls_proc_participante  p,
					pls_grau_participacao  g
				where	p.nr_seq_conta_proc	= b.nr_seq_conta_proc
				and	g.nr_sequencia		= p.nr_seq_grau_partic
				and	g.cd_tiss		= '00')
			-- Se nao for o grupo de internacao, pega o maior codigo de prestador, com o menor grau de participacao (indicando maior "importancia")
			else  (	select	max(p.nr_seq_prestador) nr_seq_prestador
				from	pls_proc_participante  p,
					pls_grau_participacao  g
				where	p.nr_seq_conta_proc	= b.nr_seq_conta_proc
				and	g.nr_sequencia		= p.nr_seq_grau_partic
				and	g.cd_tiss		= (	select  min(z.cd_tiss)
									from	pls_proc_participante  y,
										pls_grau_participacao  z
									where	z.nr_sequencia		= y.nr_seq_grau_partic
									and	y.nr_seq_conta_proc	= p.nr_seq_conta_proc))
		end nr_seq_prest_part,
		d.nr_seq_prestador_exec,
		e.nr_seq_prestador nr_seq_prest_prot,
		-- Prestador do protocolo que contem o resumo de internacao
		(	select	max(y.nr_seq_prestador) nr_seq_prest_prot_internacao
			from	pls_conta		x,
				pls_protocolo_conta	y
			where	y.nr_sequencia		= x.nr_seq_protocolo
			and	x.cd_guia_ok		= a.cd_guia_ok
			and	x.nr_seq_segurado	= a.nr_seq_segurado
			and	x.ie_tipo_guia		= '5') nr_seq_prest_prot_internacao,
		d.nr_seq_prest_inter nr_seq_prest_exec_inter,
		-- Quando for do grupo de internacao, o prestador participante deve ser obrigatoriamente cirurgiao para ser considerado.
		case	when a.ie_grupo_ans = 'I' 
			then (	select  max(p.nr_seq_prest_inter) nr_seq_prestador
				from	pls_proc_participante  p,
					pls_grau_participacao  g
				where	p.nr_seq_conta_proc	= b.nr_seq_conta_proc
				and	g.nr_sequencia		= p.nr_seq_grau_partic
				and	g.cd_tiss		= '00')
			-- Se nao for o grupo de internacao, pega o maior codigo de prestador, com o menor grau de participacao (indicando maior "importancia")
			else  (	select  max(p.nr_seq_prest_inter) nr_seq_prestador
				from	pls_proc_participante  p,
					pls_grau_participacao  g
				where	p.nr_seq_conta_proc	= b.nr_seq_conta_proc
				and	g.nr_sequencia   	= p.nr_seq_grau_partic
				and	g.cd_tiss		= (	select  min(z.cd_tiss)
									from	pls_proc_participante  y,
										pls_grau_participacao  z
									where	z.nr_sequencia		= y.nr_seq_grau_partic
									and	y.nr_seq_conta_proc	= p.nr_seq_conta_proc))
		end nr_seq_prest_part_inter,
		d.cd_medico_executor,
		-- Quando for do grupo de internacao, o medico participante deve ser obrigatoriamente cirurgiao para ser considerado.
		case	when a.ie_grupo_ans = 'I' 
			then (  select	max(p.cd_medico) cd_medico
				from	pls_proc_participante  p,
					pls_grau_participacao  g
				where	p.nr_seq_conta_proc	= b.nr_seq_conta_proc
				and	g.nr_sequencia		= p.nr_seq_grau_partic
				and	g.cd_tiss		= '00') 
			-- Se nao for o grupo de internacao, pega o maior codigo de medico, com o menor grau de participacao (indicando maior "importancia")
			else  (	select	max(p.cd_medico) cd_medico
				from	pls_proc_participante  p,
					pls_grau_participacao  g
				where  p.nr_seq_conta_proc	= b.nr_seq_conta_proc
				and  g.nr_sequencia		= p.nr_seq_grau_partic
				and  g.cd_tiss			= (	select  min(z.cd_tiss)
									from	pls_proc_participante  y,
										pls_grau_participacao  z
									where  z.nr_sequencia    = y.nr_seq_grau_partic
									and  y.nr_seq_conta_proc  = p.nr_seq_conta_proc))
		end cd_medico_participante,
		-- Ainda e necessario um tratamento especial para reembolso, pois o prestador da conta pode nao estar cadastrado na pls_prestrador.
		e.ie_tipo_protocolo,
		CASE WHEN e.ie_tipo_protocolo='R' THEN  d.cd_pessoa_fisica  ELSE null END  cd_pessoa_fisica_reembolso,
		CASE WHEN e.ie_tipo_protocolo='R' THEN  d.cd_cgc  ELSE null END  cd_cnpj_reembolso,
		d.nr_seq_cbo_saude nr_seq_cbo_reembolso,
		(select	max(w.nr_seq_cbo_saude)
		from	pls_guia_plano	w
		where	w.nr_sequencia	= d.nr_seq_guia) nr_seq_cbo_conta
	from	w_pls_utilizacao_benef  a,
		w_pls_util_benef_item  b,
		pls_conta_mat    m,
		pls_conta    d,
		pls_protocolo_conta  e
	where	b.nr_seq_util_benef	= a.nr_sequencia
	and	m.nr_sequencia		= b.nr_seq_conta_mat
	and	m.nr_seq_material	= a.nr_seq_material
	and	d.nr_sequencia		= m.nr_seq_conta
	and	e.nr_sequencia		= d.nr_seq_protocolo
	and	a.nr_id_transacao	= nr_id_transacao_pc;


BEGIN

begin

	open c01(regra_util_p.nr_id_transacao);
	loop
	fetch c01 bulk collect into	nr_seq_util_benef_w,
					ie_grupo_ans_w,
					ie_origem_conta_w,
					nr_seq_prest_part_w,
					nr_seq_prestador_exec_w,
					nr_seq_prest_prot_w,
					nr_seq_prest_prot_interna_w,
					nr_seq_prest_exec_inter_w,
					nr_seq_prest_part_inter_w,
					cd_medico_conta_exec_w,
					cd_medico_particip_w,
					ie_tipo_protocolo_w,
					cd_pessoa_fisica_reembolso_w,
					cd_cnpj_reembolso_w,
					nr_seq_cbo_reembolso_w,
					nr_seq_cbo_conta_w limit pls_util_pck.qt_registro_transacao_w;
	exit when nr_seq_util_benef_w.count = 0;
	
	-- navega pelos registros, para levantar o prestador e medico principal
	for i in nr_seq_util_benef_w.first..nr_seq_util_benef_w.last loop
		
		-- Se for internacao, e utilizado o prestador do protocolo, no caso, ainda e priorizado o protocolo que conter resumo de internacao
		if (ie_grupo_ans_w(i) = 'I') then
		
			nr_seq_prest_princ_w(i) := coalesce(nr_seq_prest_prot_interna_w(i), nr_seq_prest_prot_w(i));
		else
			
			-- Verifica o parametro de prioridade de apresentacao do prestador
			-- Prestador Participante
			if (param_util_p.ie_tipo_prest_apres = 'P') then
				
				-- Prioriza o cirurgiao, depois o prestador executor da conta, e em ultima instancia o prestador do protocolo
				nr_seq_prest_princ_w(i) := coalesce(nr_seq_prest_part_w(i), coalesce(nr_seq_prestador_exec_w(i), nr_seq_prest_prot_w(i)));
			else
				nr_seq_prest_princ_w(i) := coalesce(nr_seq_prestador_exec_w(i), nr_seq_prest_prot_w(i));
			end if;
			
		end if;
		
		-- Prioriza o cirurgiao, depois o medico executor da conta
		cd_medico_princ_w(i)		:= coalesce(cd_medico_particip_w(i), cd_medico_conta_exec_w(i));
		
		-- Verifica o parametro de prioridade de apresentacao do prestador
		-- Prestador Participante
		if (param_util_p.ie_tipo_prest_apres = 'P') then
	
			-- No prestador de intercambio, prioriza o prestador participante cirurgiao
			nr_seq_prest_princ_inter_w(i)	:= coalesce(nr_seq_prest_part_inter_w(i), nr_seq_prest_exec_inter_w(i));
		else
		
			nr_seq_prest_princ_inter_w(i)	:= nr_seq_prest_exec_inter_w(i);
		end if;
	end loop;
	
	-- Joga para o banco
	SELECT * FROM pls_utilizacao_benef_pck.grava_prest_princ_util_benef(	nr_seq_util_benef_w, nr_seq_prest_princ_w, nr_seq_prest_princ_inter_w, cd_medico_princ_w, ie_origem_conta_w, ie_tipo_protocolo_w, cd_pessoa_fisica_reembolso_w, cd_cnpj_reembolso_w, nr_seq_cbo_reembolso_w, nr_seq_cbo_conta_w, 'S', 'S') INTO STRICT _ora2pg_r;
 	nr_seq_util_benef_w := _ora2pg_r.nr_seq_util_benef_p; nr_seq_prest_princ_w := _ora2pg_r.nr_seq_prest_princ_p; nr_seq_prest_princ_inter_w := _ora2pg_r.nr_seq_prest_princ_inter_p; cd_medico_princ_w := _ora2pg_r.cd_medico_princ_p; ie_origem_conta_w := _ora2pg_r.ie_origem_conta_p; ie_tipo_protocolo_w := _ora2pg_r.ie_tipo_protocolo_p; cd_pessoa_fisica_reembolso_w := _ora2pg_r.cd_pessoa_fisica_reembolso_p; cd_cnpj_reembolso_w := _ora2pg_r.cd_cnpj_reembolso_p; nr_seq_cbo_reembolso_w := _ora2pg_r.nr_seq_cbo_reembolso_p; nr_seq_cbo_conta_w := _ora2pg_r.nr_seq_cbo_conta_p;
					
	end loop;
	close c01;
	--  Atualiza os CBO nao informadoos
	--pls_utilizacao_benef_pck.grava_cbo_nao_informado(regra_util_p, 'S');
exception
	when others then
	
		-- fecha o cursor se ainda estiver aberto
		if (c01%isopen) then
		
			close c01;
		end if;
		
		CALL CALL pls_utilizacao_benef_pck.exibe_msg_erro_padrao();
end;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_utilizacao_benef_pck.gera_prest_princ_util_benef ( param_util_p INOUT param_utilizacao_benef, regra_util_p INOUT regra_utilizacao_benef) FROM PUBLIC;
