-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pls_utilizacao_benef_pck.retornar_sql_mat_util ( param_util_p INOUT param_utilizacao_benef, regra_util_p INOUT regra_utilizacao_benef, dado_bind_p INOUT sql_pck.t_dado_bind, ie_incidencia_proc_atend_p text) AS $body$
DECLARE

/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade:	Cria o sql que ira gerar os materiais da utilizacao em si
-------------------------------------------------------------------------------------------------------------------
Locais de chamada direta: 
[X]  Objetos do dicionario [ ] Tasy (Delphi/Java) [ ] Portal [  ]  Relatorios [ ] Outros:
-------------------------------------------------------------------------------------------------------------------
Pontos de atencao:

	Os materiais devem ser atribuidos aos procedimentos de maior valor, no caso como
	em atendimentos diferentes de internacao, que sao separados por procedimentos.

	Para os atendimentos de internacao deve-se atribuido os materiais ao procedimento
	principal.
	
	Como todo atendimento tem um procedimento informado, pode-se fazer a ligacao entre
	atendimento e item, e fazer a insercao para todos os atendimentos.
	
	A Incidencia de procedimentos no atendimento serve para filtrar os atendimentos
	que possuiem somente materiais. Estes sao casos especiais, que sao tratados de forma 
	diferenciada pela rotina:
	
	ie_incidencia_proc_atend_p:
		SM - Trazer somente os materiais que estao contidos em atendimentos 
			(cd_guia_ok e benef) que nao possuam procedimentos
		PM - Trazer somente os materiais que estao contidos em atendimentos
			(cd_guia_ok e benef) que Possuam procedimentos

Alteracoes:
-------------------------------------------------------------------------------------------------------------------
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
ds_retorno_w		varchar(32000) := '';
ds_sql_base_itens_w	varchar(32000) := '';
ds_exists_proc_atend_w	varchar(2000) := '';


BEGIN

ds_sql_base_itens_w := retorna_sql_base_itens(param_util_p, regra_util_p, dado_bind_p, 'M');

-- Levanta o exists, para ver se existe algum procedimento no atendimento
ds_exists_proc_atend_w	:= pls_utilizacao_benef_pck.retorna_exists_proc_atend('y.cd_guia_ok', 'y.nr_seq_segurado');

ds_retorno_w	:= ds_retorno_w ||	'select	w_pls_util_benef_item_seq.nextval nr_sequencia, ' || pls_util_pck.enter_w ||
					'	t.nr_seq_util_benef, ' || pls_util_pck.enter_w ||
					'	t.nr_seq_conta, ' || pls_util_pck.enter_w ||
					'	t.nr_seq_conta_proc, ' || pls_util_pck.enter_w ||
					'	t.nr_seq_conta_mat, ' || pls_util_pck.enter_w ||
					'	t.qt_item, ' || pls_util_pck.enter_w ||
					'	t.vl_item, ' || pls_util_pck.enter_w ||
					'	t.nr_seq_grupo_ans, ' || pls_util_pck.enter_w ||
					'	t.nr_seq_conta_rec, ' || pls_util_pck.enter_w ||
					'	t.nr_seq_conta_proc_rec, ' || pls_util_pck.enter_w ||
					'	t.nr_seq_conta_mat_rec ' || pls_util_pck.enter_w ||
					'from (	 ' || pls_util_pck.enter_w;
					-- Se a incidencia for para materiais apenas, entao e buscado o atendimento para o cd_guia_ok e beneficiario que contenha o
					-- nr_seq_material do item que esta sendo avaliado
					if (ie_incidencia_proc_atend_p = 'SM') then
						
						ds_retorno_w	:= ds_retorno_w ||	'	select	(	select	max(a.nr_sequencia) ' || pls_util_pck.enter_w ||
											'			from	w_pls_utilizacao_benef	a ' || pls_util_pck.enter_w ||
											'			where	a.cd_guia_ok		= y.cd_guia_ok ' || pls_util_pck.enter_w ||
											'			and	a.nr_seq_segurado	= y.nr_seq_segurado ' || pls_util_pck.enter_w ||
											'			and	a.nr_seq_material	= y.nr_seq_material ) nr_seq_util_benef, ' || pls_util_pck.enter_w;
											
					else
					
						ds_retorno_w	:= ds_retorno_w ||	'select	pls_utilizacao_benef_pck.retorna_seq_util_maior_vl(:nr_id_transacao, y.cd_guia_ok, y.nr_seq_segurado) nr_seq_util_benef, ' || pls_util_pck.enter_w;
					end if;
					
ds_retorno_w	:= ds_retorno_w ||	'		y.nr_seq_conta, ' || pls_util_pck.enter_w ||
					'		y.nr_seq_conta_proc, ' || pls_util_pck.enter_w ||
					'		y.nr_seq_conta_mat, ' || pls_util_pck.enter_w ||
					'		y.qt_material qt_item, ' || pls_util_pck.enter_w ||
					'		y.vl_item_mat vl_item, ' || pls_util_pck.enter_w ||
					'		y.nr_seq_grupo_ans, ' || pls_util_pck.enter_w ||
					'		y.nr_seq_conta_rec, ' || pls_util_pck.enter_w ||
					'		y.nr_seq_conta_proc_rec, ' || pls_util_pck.enter_w ||
					'		y.nr_seq_conta_mat_rec ' || pls_util_pck.enter_w ||
					'	from (	' || ds_sql_base_itens_w ||
					'		)	y  ' || pls_util_pck.enter_w ||
					-- Apenas para garantir a existencia de um "where"
					'where	1 = 1 ' || pls_util_pck.enter_w;
					
				-- Carregar apenas materiais que nao possuam nenhum procedimento no atendimento
				if (ie_incidencia_proc_atend_p = 'SM') then
					
					ds_retorno_w := ds_retorno_w ||	'and	not exists (	'|| ds_exists_proc_atend_w|| ' ) ' || pls_util_pck.enter_w;
					-- Somente os materiais que possuirem procedimentos no atendimento
				elsif (ie_incidencia_proc_atend_p = 'PM') then
				
					ds_retorno_w := ds_retorno_w ||	'and	exists (	'|| ds_exists_proc_atend_w|| ' ) ' || pls_util_pck.enter_w;
				end if;
ds_retorno_w	:= ds_retorno_w ||	'	)	t ' || pls_util_pck.enter_w ||
					'where	t.nr_seq_util_benef is not null ' || pls_util_pck.enter_w;

-- Atribui os bindings
dado_bind_p := sql_pck.bind_variable(':nr_id_transacao', regra_util_p.nr_id_transacao, dado_bind_p);


return;	

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pls_utilizacao_benef_pck.retornar_sql_mat_util ( param_util_p INOUT param_utilizacao_benef, regra_util_p INOUT regra_utilizacao_benef, dado_bind_p INOUT sql_pck.t_dado_bind, ie_incidencia_proc_atend_p text) FROM PUBLIC;
