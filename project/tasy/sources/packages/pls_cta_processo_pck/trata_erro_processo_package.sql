-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_cta_processo_pck.trata_erro_processo ( nr_seq_log_exec_p pls_cta_log_exec.nr_sequencia%type, cd_processo_p pls_cta_processo.cd_processo%type, nm_processo_p pls_cta_processo.nm_processo%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE


ds_log_w	pls_oc_cta_log_erro.ds_log%type;
ds_stack_w	varchar(4000);
ds_err_stack_w	varchar(4000);


BEGIN

-- obter o callstack
ds_stack_w := dbms_utility.format_call_stack;
ds_err_stack_w := dbms_utility.format_error_backtrace;

-- Obter o log a ser gravado
ds_log_w	:= substr(
			'Log de execução: ' || nr_seq_log_exec_p || pls_util_pck.enter_w ||
			'. Processo: ' || cd_processo_p || ' - ' || nm_processo_p || pls_util_pck.enter_w ||
			'Erro: ' || sqlerrm || pls_util_pck.enter_w || pls_util_pck.enter_w ||
			'Stack:' || pls_util_pck.enter_w ||
			ds_stack_w || pls_util_pck.enter_w ||
			'Error Back Trace: ' || pls_util_pck.enter_w ||
			ds_err_stack_w, 1, 4000);

insert into pls_cta_log_erro(nr_sequencia,
	nm_usuario,
	dt_atualizacao,
	nm_usuario_nrec,
	dt_atualizacao_nrec,
	nr_seq_log_exec,
	ds_log)
values (nextval('pls_cta_log_erro_seq'),
	nm_usuario_p,
	clock_timestamp(),
	nm_usuario_p,
	clock_timestamp(),
	nr_seq_log_exec_p,
	ds_log_w);

-- Gravar alterações
commit;

CALL wheb_mensagem_pck.exibir_mensagem_abort(281903,'ERRO=' || sqlerrm);

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_cta_processo_pck.trata_erro_processo ( nr_seq_log_exec_p pls_cta_log_exec.nr_sequencia%type, cd_processo_p pls_cta_processo.cd_processo%type, nm_processo_p pls_cta_processo.nm_processo%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;
