-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION ageint_cons_quimio_vinc.get_reg_pac_atendimento (nr_seq_pend_quimio_p bigint, ie_agendar_cons_quimio_p text) RETURNS SETOF PACIENTE_ATEND_REC_TABLE AS $body$
DECLARE


  contador_w bigint := 1;
  dt_real_temp_w timestamp;

  c01 CURSOR FOR
    SELECT dt_prevista,
            dt_real
    from paciente_atendimento
    where nr_seq_pend_agenda  = nr_seq_pend_quimio_p
    order by dt_real, dt_prevista;

BEGIN

  for c_01 in c01 loop

    if ie_agendar_cons_quimio_p = 'T' then

      current_setting('ageint_cons_quimio_vinc.paciente_atendimento_w')::paciente_atendimento_table[contador_w].dt_prevista := c_01.dt_prevista;
      current_setting('ageint_cons_quimio_vinc.paciente_atendimento_w')::paciente_atendimento_table[contador_w].dt_real := c_01.dt_real;
      RETURN NEXT current_setting('ageint_cons_quimio_vinc.paciente_atendimento_w'::paciente_atendimento_table(contador_w));

    elsif ie_agendar_cons_quimio_p = 'S' then

      if coalesce(dt_real_temp_w::text, '') = '' or coalesce(c_01.dt_real::text, '') = '' or trunc(dt_real_temp_w + 1) <> trunc(c_01.dt_real) then
        dt_real_temp_w := c_01.dt_real;
        current_setting('ageint_cons_quimio_vinc.paciente_atendimento_w')::paciente_atendimento_table[contador_w].dt_prevista := c_01.dt_prevista;
        current_setting('ageint_cons_quimio_vinc.paciente_atendimento_w')::paciente_atendimento_table[contador_w].dt_real := c_01.dt_real;
        RETURN NEXT current_setting('ageint_cons_quimio_vinc.paciente_atendimento_w'::paciente_atendimento_table(contador_w));
      end if;

    end if;

    contador_w := contador_w + 1;

  end loop;
  return;
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION ageint_cons_quimio_vinc.get_reg_pac_atendimento (nr_seq_pend_quimio_p bigint, ie_agendar_cons_quimio_p text) FROM PUBLIC;
