-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION ageint_cons_quimio_vinc.get_registros_consulta (cd_agenda_p bigint, dt_agenda_p timestamp, nr_seq_ageint_p bigint, cd_estab_filtro_p bigint, nr_seq_prof_p bigint) RETURNS SETOF AGENDA_CONSULTA_REC_TABLE AS $body$
DECLARE



dt_quimio_w timestamp;
contador_w bigint := 1;
hora_local_quimio_w varchar(255);
ds_local varchar(255);
dt_mais_duracao_w timestamp;
nr_seq_pend_agenda_w bigint;
nr_seq_local_w bigint;
nm_usuario_w varchar(255);
nr_locais_w varchar(4000);

cd_pessoa_fisica_w agenda_integrada.cd_pessoa_fisica%type;
nr_seq_ageint_item_w agenda_integrada_item.nr_sequencia%type;

c01 CURSOR FOR
  SELECT dt_agenda,
       obter_descricao_dominio(83,ie_status_agenda) status,
       nr_minuto_duracao,
       nr_sequencia
  from agenda_consulta
  where cd_agenda = cd_agenda_p
  and dt_agenda between trunc(dt_agenda_p) and fim_dia(dt_agenda_p)
  and (ie_status_agenda in ('L', 'LF')
  or (ie_status_agenda = 'N' and nm_usuario_acesso = nm_usuario_w))
  order by dt_agenda;

c02 CURSOR FOR
  SELECT c.nr_Sequencia
  FROM    agenda_integrada_item a,
          qt_item_agenda b,
          qt_local c
  WHERE   a.nr_seq_Agenda_int     = nr_seq_ageint_p
  and     a.ie_tipo_agendamento   = 'Q'
  and     a.ie_tipo_pend_agenda   = 'Q'
  and     a.ie_tipo_pend_Agenda   = b.cd_item
  and     ((PKG_DATE_UTILS.START_OF(coalesce(a.dt_prev_transf_quimio,dt_prevista_quimio), 'dd') = PKG_DATE_UTILS.START_OF(dt_agenda_p, 'dd')) OR (coalesce(a.dt_prevista_quimio::text, '') = ''))
  and	    Qt_Obter_Se_Local_Lib(a.nr_sequencia, c.nr_sequencia)	= 'S'
  and	    C.IE_SITUACAO						 = 'A'
  and     EXISTS (SELECT 1 FROM qt_local_turno x WHERE x.nr_seq_local = c.nr_sequencia)
  and	    QT_OBTER_SE_LOCAL_LIB(a.NR_SEQUENCIA, C.NR_SEQUENCIA)	= 'S'
  and (coalesce(cd_estab_filtro_p::text, '') = '' or c.cd_estabelecimento = cd_estab_filtro_p)
  and (coalesce(nr_seq_prof_p::text, '') = '' or Qt_Obter_Se_Hor_Prof(c.nr_sequencia,cd_pessoa_fisica_w,NULL,cd_estab_filtro_p,nm_usuario_w,nr_seq_prof_p) = 'S');
BEGIN
	
  nm_usuario_w := obter_usuario_ativo;
  select max(a.cd_pessoa_fisica),
        max(b.nr_sequencia)
  into STRICT cd_pessoa_fisica_w,
        nr_seq_ageint_item_w
  from agenda_integrada a,
    agenda_integrada_item b
  where b.ie_tipo_agendamento = 'Q'
  and b.nr_seq_agenda_int = a.nr_sequencia
  and a.nr_sequencia = nr_seq_ageint_p;

  for c_02 in c02 loop
    nr_locais_w := nr_locais_w || c_02.nr_Sequencia ||',';
  end loop;

  for c_01 in c01 loop

    dt_mais_duracao_w := c_01.dt_agenda + (1/1440*coalesce(c_01.nr_minuto_duracao, 0));

    select max(dt_horario),
          max(obter_desc_local_qt(nr_seq_local, 'C')),
          max(nr_seq_pend_agenda),
          max(nr_seq_local)
    into STRICT dt_quimio_w,
        ds_local,
        nr_seq_pend_agenda_w,
        nr_seq_local_w
    from w_agenda_quimio
    where nr_seq_ageint_item = nr_seq_ageint_item_w
    and dt_horario between dt_mais_duracao_w and dt_mais_duracao_w+(1/1440*30)
    and nr_Seq_local in (WITH RECURSIVE cte AS (
SELECT regexp_substr(nr_locais_w,'[^,]+', 1, level)  (regexp_substr(nr_locais_w, '[^,]+', 1, level) IS NOT NULL AND (regexp_substr(nr_locais_w, '[^,]+', 1, level))::text <> '')  UNION ALL
SELECT regexp_substr(nr_locais_w,'[^,]+', 1, level) JOIN cte c ON ()

) SELECT * FROM cte;
)
    order by 1 desc LIMIT 1;

    if (dt_quimio_w IS NOT NULL AND dt_quimio_w::text <> '') then
      hora_local_quimio_w := pkg_date_formaters.to_varchar(dt_quimio_w,'shortTime', wheb_usuario_pck.get_cd_estabelecimento, nm_usuario_w) || ' ' || ds_local;
    else
      hora_local_quimio_w := null;
    end if;
    current_setting('ageint_cons_quimio_vinc.agenda_consulta_w')::agenda_consulta_table[contador_w].dt_agenda := c_01.dt_agenda;
    current_setting('ageint_cons_quimio_vinc.agenda_consulta_w')::agenda_consulta_table[contador_w].status := c_01.status;
    current_setting('ageint_cons_quimio_vinc.agenda_consulta_w')::agenda_consulta_table[contador_w].nr_minuto_duracao := c_01.nr_minuto_duracao;
    current_setting('ageint_cons_quimio_vinc.agenda_consulta_w')::agenda_consulta_table[contador_w].hora_local_quimio := hora_local_quimio_w;
    current_setting('ageint_cons_quimio_vinc.agenda_consulta_w')::agenda_consulta_table[contador_w].nr_sequencia := c_01.nr_sequencia;
    current_setting('ageint_cons_quimio_vinc.agenda_consulta_w')::agenda_consulta_table[contador_w].nr_seq_pend_agenda := nr_seq_pend_agenda_w;
    current_setting('ageint_cons_quimio_vinc.agenda_consulta_w')::agenda_consulta_table[contador_w].nr_seq_local := nr_seq_local_w;
    current_setting('ageint_cons_quimio_vinc.agenda_consulta_w')::agenda_consulta_table[contador_w].dt_quimio_selecionado := dt_quimio_w;
    current_setting('ageint_cons_quimio_vinc.agenda_consulta_w')::agenda_consulta_table[contador_w].nr_seq_agein_item := nr_seq_ageint_item_w;
	current_setting('ageint_cons_quimio_vinc.agenda_consulta_w')::agenda_consulta_table[contador_w].dt_agenda_str := pkg_date_formaters.to_varchar(c_01.dt_agenda,'shortTime', wheb_usuario_pck.get_cd_estabelecimento, nm_usuario_w);

    RETURN NEXT current_setting('ageint_cons_quimio_vinc.agenda_consulta_w'::agenda_consulta_table(contador_w));

    contador_w := contador_w +1;
  end loop;
  return;
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION ageint_cons_quimio_vinc.get_registros_consulta (cd_agenda_p bigint, dt_agenda_p timestamp, nr_seq_ageint_p bigint, cd_estab_filtro_p bigint, nr_seq_prof_p bigint) FROM PUBLIC;
