-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE ageint_cons_quimio_vinc.confirmar_consulta_reservada (ds_lista_seq_p text, nr_seq_ageint_p bigint) AS $body$
DECLARE


cd_pessoa_fisica_w        agenda_integrada.cd_pessoa_fisica%type;
nr_telefone_w             agenda_integrada.nr_telefone%type;
cd_convenio_ageint_w      agenda_integrada.cd_convenio%type;
cd_Categoria_ageint_w     agenda_integrada.cd_Categoria%type;
cd_plano_ageint_w         agenda_integrada.cd_plano%type;
nr_doc_convenio_w         agenda_integrada.nr_doc_convenio%type;
cd_usuario_convenio_w     agenda_integrada.cd_usuario_convenio%type;
dt_validade_carteira_w    agenda_integrada.dt_validade_carteira%type;
nm_paciente_w             agenda_integrada.nm_paciente%type;
dt_nascimento_w           agenda_integrada.dt_nascimento%type;
nm_medico_externo_w       agenda_integrada.nm_medico_externo%type;
crm_medico_externo_w      agenda_integrada.crm_medico_externo%type;
cd_procedencia_w          agenda_integrada.cd_procedencia%type;
nr_controle_sus_w         agenda_integrada.nr_controle_sus%type;
cd_regulacao_sus_w        agenda_integrada.cd_regulacao_sus%type;
cd_chave_regulacao_sus_w  agenda_integrada.cd_chave_regulacao_sus%type;
nr_seq_opm_w              agenda_integrada.nr_seq_opm%type;
cd_tipo_acomodacao_w      agenda_integrada.cd_tipo_acomodacao%type;

qt_idade_w		            smallint;

c01 CURSOR FOR
  SELECT nr_Sequencia
  from (WITH RECURSIVE cte AS (
SELECT regexp_substr(ds_lista_seq_p,'[^,]+', 1, level) nr_sequencia  (regexp_substr(ds_lista_seq_p, '[^,]+', 1, level) IS NOT NULL AND (regexp_substr(ds_lista_seq_p, '[^,]+', 1, level))::text <> '')  UNION ALL
SELECT regexp_substr(ds_lista_seq_p,'[^,]+', 1, level) nr_sequencia  (regexp_substr(ds_lista_seq_p, '[^,]+', 1, level) IS NOT NULL AND (regexp_substr(ds_lista_seq_p, '[^,]+', 1, level))::text <> '') JOIN cte c ON ()

) SELECT * FROM cte;
) alias5;

BEGIN

select	cd_pessoa_fisica,
	nr_telefone,
	cd_convenio,
	cd_Categoria,
	cd_plano,
	nr_doc_convenio,
	cd_usuario_convenio,
	dt_validade_carteira,
	nm_paciente,
	dt_nascimento,
	nm_medico_externo,
	crm_medico_externo,
	cd_procedencia,
	nr_controle_sus,
	cd_regulacao_sus,
	cd_chave_regulacao_sus,
	nr_seq_opm,
	cd_tipo_acomodacao
into STRICT	cd_pessoa_fisica_w,
	nr_telefone_w,
	cd_convenio_ageint_w,
	cd_Categoria_ageint_w,
	cd_plano_ageint_w,
	nr_doc_convenio_w,
	cd_usuario_convenio_w,
	dt_validade_carteira_w,
	nm_paciente_w,
	dt_nascimento_w,  
	nm_medico_externo_w,      
	crm_medico_externo_w,
	cd_procedencia_w,
	nr_controle_sus_w,
	cd_regulacao_sus_w,
	cd_chave_regulacao_sus_w,
	nr_seq_opm_w,
	cd_tipo_acomodacao_w
from	agenda_integrada
where	nr_sequencia	= nr_seq_Ageint_p;

qt_idade_w	:= obter_idade(dt_nascimento_w, clock_timestamp(), 'A');

for c_01 in c01 loop
  --quase mesmo update da procedure Confirmar_Horarios_Ageint, tirei alguns campos
  update	agenda_consulta
  set	cd_pessoa_fisica		= cd_pessoa_fisica_w,				
    ie_status_agenda		= 'N',
    nr_Telefone			= nr_telefone_w,
    cd_convenio			= cd_convenio_ageint_w,
    cd_Categoria			= cd_Categoria_ageint_w,
    cd_plano			= cd_plano_ageint_w,
    nr_doc_convenio			= nr_doc_convenio_w,
    cd_usuario_convenio		= cd_usuario_convenio_w,
    dt_validade_carteira		= dt_validade_carteira_w,
    nm_usuario_acesso		 = NULL,
    nm_paciente			= nm_paciente_w,
    dt_nascimento_pac		= dt_nascimento_w,
    nm_medico_externo		= nm_medico_externo_w,
    crm_medico_externo		= crm_medico_externo_w,
    qt_idade_pac			= qt_idade_w,
    cd_procedencia			= cd_procedencia_w,
    nr_controle_sus         	= nr_controle_sus_w,
    cd_regulacao_sus       	  	= cd_regulacao_sus_w,
    cd_chave_regulacao_sus  	= cd_chave_regulacao_sus_w,
    nr_seq_opm				= nr_seq_opm_w,
    cd_tipo_acomodacao 		= cd_tipo_acomodacao_w
  where	nr_sequencia			= c_01.nr_Sequencia;
end loop;

commit;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ageint_cons_quimio_vinc.confirmar_consulta_reservada (ds_lista_seq_p text, nr_seq_ageint_p bigint) FROM PUBLIC;
