-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_mens_selecao_benef_pck.add_filtros_pagador (ie_tipo_pagador_p text) AS $body$
DECLARE


sql_where_pagador_w	varchar(32000) := null;
ie_tabela_fin_w		varchar(1) := 'N';


BEGIN

if (current_setting('pls_mens_selecao_benef_pck.pls_lote_mensalidade_w')::pls_lote_mensalidade%(rowtype.nr_seq_pagador IS NOT NULL AND rowtype.nr_seq_pagador::text <> '')) then
	if (ie_tipo_pagador_p = 'B') then
		sql_where_pagador_w := sql_where_pagador_w || '	and d.nr_sequencia = :nr_seq_pagador_pc';
	elsif (ie_tipo_pagador_p = 'C') then
		sql_where_pagador_w := sql_where_pagador_w || '	and h.nr_seq_pagador_item = :nr_seq_pagador_pc';
	elsif (ie_tipo_pagador_p = 'S') then
		sql_where_pagador_w := sql_where_pagador_w || '	and i.nr_seq_pagador = :nr_seq_pagador_pc';
	end if;
	current_setting('pls_mens_selecao_benef_pck.valor_bind_w')::sql_pck.t_dado_bind := sql_pck.bind_variable(':nr_seq_pagador_pc', current_setting('pls_mens_selecao_benef_pck.pls_lote_mensalidade_w')::pls_lote_mensalidade%rowtype.nr_seq_pagador, current_setting('pls_mens_selecao_benef_pck.valor_bind_w')::sql_pck.t_dado_bind);
end if;

if (current_setting('pls_mens_selecao_benef_pck.pls_lote_mensalidade_w')::pls_lote_mensalidade%(rowtype.nr_dia_inicial_venc IS NOT NULL AND rowtype.nr_dia_inicial_venc::text <> '')) then
	sql_where_pagador_w := sql_where_pagador_w || ' and e.dt_dia_vencimento >= :nr_dia_inicial_venc_pc';
	current_setting('pls_mens_selecao_benef_pck.valor_bind_w')::sql_pck.t_dado_bind := sql_pck.bind_variable(':nr_dia_inicial_venc_pc', current_setting('pls_mens_selecao_benef_pck.pls_lote_mensalidade_w')::pls_lote_mensalidade%rowtype.nr_dia_inicial_venc, current_setting('pls_mens_selecao_benef_pck.valor_bind_w')::sql_pck.t_dado_bind);
	ie_tabela_fin_w := 'S';
end if;

if (current_setting('pls_mens_selecao_benef_pck.pls_lote_mensalidade_w')::pls_lote_mensalidade%(rowtype.nr_dia_final_venc IS NOT NULL AND rowtype.nr_dia_final_venc::text <> '')) then
	sql_where_pagador_w := sql_where_pagador_w || ' and e.dt_dia_vencimento <= :nr_dia_final_venc_pc';
	current_setting('pls_mens_selecao_benef_pck.valor_bind_w')::sql_pck.t_dado_bind := sql_pck.bind_variable(':nr_dia_final_venc_pc', current_setting('pls_mens_selecao_benef_pck.pls_lote_mensalidade_w')::pls_lote_mensalidade%rowtype.nr_dia_final_venc, current_setting('pls_mens_selecao_benef_pck.valor_bind_w')::sql_pck.t_dado_bind);
	ie_tabela_fin_w := 'S';
end if;

if (current_setting('pls_mens_selecao_benef_pck.pls_lote_mensalidade_w')::pls_lote_mensalidade%(rowtype.nr_seq_forma_cobranca IS NOT NULL AND rowtype.nr_seq_forma_cobranca::text <> '')) then
	sql_where_pagador_w := sql_where_pagador_w || ' and e.nr_seq_forma_cobranca = :nr_seq_forma_cobranca_pc';
	current_setting('pls_mens_selecao_benef_pck.valor_bind_w')::sql_pck.t_dado_bind := sql_pck.bind_variable(':nr_seq_forma_cobranca_pc', current_setting('pls_mens_selecao_benef_pck.pls_lote_mensalidade_w')::pls_lote_mensalidade%rowtype.nr_seq_forma_cobranca, current_setting('pls_mens_selecao_benef_pck.valor_bind_w')::sql_pck.t_dado_bind);
	ie_tabela_fin_w := 'S';
end if;

if (current_setting('pls_mens_selecao_benef_pck.pls_lote_mensalidade_w')::pls_lote_mensalidade%(rowtype.nr_seq_classif_itens IS NOT NULL AND rowtype.nr_seq_classif_itens::text <> '')) or (current_setting('pls_mens_selecao_benef_pck.nr_seq_classif_itens_serie_w')::pls_regra_serie_nf_compl.nr_seq_classif_itens%(type IS NOT NULL AND type::text <> '')) then
	if (ie_tipo_pagador_p = 'C') then
		sql_where_pagador_w := sql_where_pagador_w || ' and ((d.nr_seq_classif_itens = :nr_seq_classif_itens_pc) or (exists(select 1 from pls_contrato_pagador y where y.nr_sequencia = h.nr_seq_pagador_item and nvl(:nr_seq_classif_itens_pc,y.nr_seq_classif_itens) = y.nr_seq_classif_itens)))';
		sql_where_pagador_w := sql_where_pagador_w || ' and exists (select 1 from pls_contrato_pagador x where x.nr_sequencia = h.nr_seq_pagador_item and nvl(:nr_seq_classif_itens_pc,x.nr_seq_classif_itens) = x.nr_seq_classif_itens) ';
	else
		sql_where_pagador_w := sql_where_pagador_w || ' and d.nr_seq_classif_itens = :nr_seq_classif_itens_pc';
	end if;
	current_setting('pls_mens_selecao_benef_pck.valor_bind_w')::sql_pck.t_dado_bind := sql_pck.bind_variable(':nr_seq_classif_itens_pc', coalesce(current_setting('pls_mens_selecao_benef_pck.pls_lote_mensalidade_w')::pls_lote_mensalidade%rowtype.nr_seq_classif_itens,current_setting('pls_mens_selecao_benef_pck.nr_seq_classif_itens_serie_w')::pls_regra_serie_nf_compl.nr_seq_classif_itens%type), current_setting('pls_mens_selecao_benef_pck.valor_bind_w')::sql_pck.t_dado_bind);
end if;

if (current_setting('pls_mens_selecao_benef_pck.pls_lote_mensalidade_w')::pls_lote_mensalidade%(rowtype.cd_tipo_portador IS NOT NULL AND rowtype.cd_tipo_portador::text <> '')) then
	sql_where_pagador_w := sql_where_pagador_w || ' and e.cd_tipo_portador = :cd_tipo_portador_pc';
	current_setting('pls_mens_selecao_benef_pck.valor_bind_w')::sql_pck.t_dado_bind := sql_pck.bind_variable(':cd_tipo_portador_pc', current_setting('pls_mens_selecao_benef_pck.pls_lote_mensalidade_w')::pls_lote_mensalidade%rowtype.cd_tipo_portador, current_setting('pls_mens_selecao_benef_pck.valor_bind_w')::sql_pck.t_dado_bind);
	ie_tabela_fin_w := 'S';
end if;

if (current_setting('pls_mens_selecao_benef_pck.pls_lote_mensalidade_w')::pls_lote_mensalidade%(rowtype.cd_portador IS NOT NULL AND rowtype.cd_portador::text <> '')) then
	sql_where_pagador_w := sql_where_pagador_w || ' and e.cd_portador = :cd_portador_pc';
	current_setting('pls_mens_selecao_benef_pck.valor_bind_w')::sql_pck.t_dado_bind := sql_pck.bind_variable(':cd_portador_pc', current_setting('pls_mens_selecao_benef_pck.pls_lote_mensalidade_w')::pls_lote_mensalidade%rowtype.cd_portador, current_setting('pls_mens_selecao_benef_pck.valor_bind_w')::sql_pck.t_dado_bind);
	ie_tabela_fin_w := 'S';
end if;

if (current_setting('pls_mens_selecao_benef_pck.pls_lote_mensalidade_w')::pls_lote_mensalidade%(rowtype.cd_banco IS NOT NULL AND rowtype.cd_banco::text <> '')) then
	sql_where_pagador_w := sql_where_pagador_w || ' and e.cd_banco = :cd_banco_pc';
	current_setting('pls_mens_selecao_benef_pck.valor_bind_w')::sql_pck.t_dado_bind := sql_pck.bind_variable(':cd_banco_pc', current_setting('pls_mens_selecao_benef_pck.pls_lote_mensalidade_w')::pls_lote_mensalidade%rowtype.cd_banco, current_setting('pls_mens_selecao_benef_pck.valor_bind_w')::sql_pck.t_dado_bind);
	ie_tabela_fin_w := 'S';
end if;

if (current_setting('pls_mens_selecao_benef_pck.pls_lote_mensalidade_w')::pls_lote_mensalidade%(rowtype.ie_endereco_boleto IS NOT NULL AND rowtype.ie_endereco_boleto::text <> '')) then
	sql_where_pagador_w := sql_where_pagador_w || ' and d.ie_endereco_boleto = :ie_endereco_boleto_pc';
	current_setting('pls_mens_selecao_benef_pck.valor_bind_w')::sql_pck.t_dado_bind := sql_pck.bind_variable(':ie_endereco_boleto_pc', current_setting('pls_mens_selecao_benef_pck.pls_lote_mensalidade_w')::pls_lote_mensalidade%rowtype.ie_endereco_boleto, current_setting('pls_mens_selecao_benef_pck.valor_bind_w')::sql_pck.t_dado_bind);
end if;

if (current_setting('pls_mens_selecao_benef_pck.pls_lote_mensalidade_w')::pls_lote_mensalidade%(rowtype.nr_seq_empresa IS NOT NULL AND rowtype.nr_seq_empresa::text <> '')) then
	PERFORM set_config('pls_mens_selecao_benef_pck.sql_tabelas_w', current_setting('pls_mens_selecao_benef_pck.sql_tabelas_w')::varchar(32000) || ', pls_desc_empresa f', false);
	sql_where_pagador_w := sql_where_pagador_w || 	' and	e.nr_seq_empresa	= f.nr_sequencia(+)' ||
							' and 	(f.nr_seq_empresa_superior = :nr_seq_empresa_pc or f.nr_sequencia = :nr_seq_empresa_pc)';
	current_setting('pls_mens_selecao_benef_pck.valor_bind_w')::sql_pck.t_dado_bind := sql_pck.bind_variable(':nr_seq_empresa_pc', current_setting('pls_mens_selecao_benef_pck.pls_lote_mensalidade_w')::pls_lote_mensalidade%rowtype.nr_seq_empresa, current_setting('pls_mens_selecao_benef_pck.valor_bind_w')::sql_pck.t_dado_bind);
	ie_tabela_fin_w := 'S';
end if;

if (current_setting('pls_mens_selecao_benef_pck.pls_lote_mensalidade_w')::pls_lote_mensalidade%rowtype.ie_pagador_beneficio_obito = 'S') then
	sql_where_pagador_w := sql_where_pagador_w || ' and d.nr_seq_regra_obito is not null';
end if;

if (current_setting('pls_mens_selecao_benef_pck.pls_lote_mensalidade_w')::pls_lote_mensalidade%rowtype.ie_geracao_nota_titulo <> 'A') then
	sql_where_pagador_w := sql_where_pagador_w || ' and e.ie_geracao_nota_titulo = :ie_geracao_nota_titulo_pc';
	current_setting('pls_mens_selecao_benef_pck.valor_bind_w')::sql_pck.t_dado_bind := sql_pck.bind_variable(':ie_geracao_nota_titulo_pc', current_setting('pls_mens_selecao_benef_pck.pls_lote_mensalidade_w')::pls_lote_mensalidade%rowtype.ie_geracao_nota_titulo, current_setting('pls_mens_selecao_benef_pck.valor_bind_w')::sql_pck.t_dado_bind);
	ie_tabela_fin_w := 'S';
end if;

if (current_setting('pls_mens_selecao_benef_pck.pls_lote_mensalidade_w')::pls_lote_mensalidade%rowtype.ie_tipo_pessoa_pagador = 'PF') then
	sql_where_pagador_w := sql_where_pagador_w || ' and d.cd_pessoa_fisica is not null ';
elsif (current_setting('pls_mens_selecao_benef_pck.pls_lote_mensalidade_w')::pls_lote_mensalidade%rowtype.ie_tipo_pessoa_pagador = 'PJ') then
	sql_where_pagador_w := sql_where_pagador_w || ' and d.cd_cgc is not null ';
end if;

if (current_setting('pls_mens_selecao_benef_pck.pls_lote_mensalidade_w')::pls_lote_mensalidade%(rowtype.ie_envia_cobranca IS NOT NULL AND rowtype.ie_envia_cobranca::text <> '')) then
	sql_where_pagador_w := sql_where_pagador_w || ' and (d.ie_envia_cobranca = :ie_envia_cobranca_pc or d.ie_envia_cobranca = ''A'') ';
	current_setting('pls_mens_selecao_benef_pck.valor_bind_w')::sql_pck.t_dado_bind := sql_pck.bind_variable(':ie_envia_cobranca_pc', current_setting('pls_mens_selecao_benef_pck.pls_lote_mensalidade_w')::pls_lote_mensalidade%rowtype.ie_envia_cobranca, current_setting('pls_mens_selecao_benef_pck.valor_bind_w')::sql_pck.t_dado_bind);
end if;

if (current_setting('pls_mens_selecao_benef_pck.ie_situacao_trabalhist_serie_w')::pls_regra_serie_nf_compl.ie_situacao_trabalhista%(type IS NOT NULL AND type::text <> '')) then
	sql_where_pagador_w := sql_where_pagador_w || ' and (d.ie_situacao_trabalhista = :ie_situacao_trabalhista_pc) ';
	current_setting('pls_mens_selecao_benef_pck.valor_bind_w')::sql_pck.t_dado_bind := sql_pck.bind_variable(':ie_situacao_trabalhista_pc', current_setting('pls_mens_selecao_benef_pck.ie_situacao_trabalhist_serie_w')::pls_regra_serie_nf_compl.ie_situacao_trabalhista%type, current_setting('pls_mens_selecao_benef_pck.valor_bind_w')::sql_pck.t_dado_bind);
end if;
if (sql_where_pagador_w IS NOT NULL AND sql_where_pagador_w::text <> '') then	
	if (ie_tabela_fin_w = 'S') then
		PERFORM set_config('pls_mens_selecao_benef_pck.sql_tabelas_w', current_setting('pls_mens_selecao_benef_pck.sql_tabelas_w')::varchar(32000) || ', pls_contrato_pagador_fin e', false);
		PERFORM set_config('pls_mens_selecao_benef_pck.sql_where_w', current_setting('pls_mens_selecao_benef_pck.sql_where_w')::varchar(32000) || ' and d.nr_sequencia = e.nr_seq_pagador ', false);
		if (current_setting('pls_mens_selecao_benef_pck.pls_lote_mensalidade_w')::pls_lote_mensalidade%rowtype.ie_mensalidade_mes_anterior = 'S') and (current_setting('pls_mens_selecao_benef_pck.pls_lote_mensalidade_w')::pls_lote_mensalidade%rowtype.ie_mens_ant_agrupar = 'S') then
			PERFORM set_config('pls_mens_selecao_benef_pck.sql_where_w', current_setting('pls_mens_selecao_benef_pck.sql_where_w')::varchar(32000) || ' and e.dt_inicio_vigencia <= :dt_mesano_lote ', false);
			PERFORM set_config('pls_mens_selecao_benef_pck.sql_where_w', current_setting('pls_mens_selecao_benef_pck.sql_where_w')::varchar(32000) || ' and	((e.dt_fim_vigencia >= :dt_mesano_lote) or (e.dt_fim_vigencia is null)) ', false);
		end if;
		current_setting('pls_mens_selecao_benef_pck.valor_bind_w')::sql_pck.t_dado_bind := sql_pck.bind_variable(':dt_mesano_lote', trunc(current_setting('pls_mens_selecao_benef_pck.pls_lote_mensalidade_w')::pls_lote_mensalidade%rowtype.dt_mesano_referencia,'month'), current_setting('pls_mens_selecao_benef_pck.valor_bind_w')::sql_pck.t_dado_bind);
	end if;
	
	PERFORM set_config('pls_mens_selecao_benef_pck.sql_where_w', current_setting('pls_mens_selecao_benef_pck.sql_where_w')::varchar(32000) || sql_where_pagador_w, false);
end if;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_mens_selecao_benef_pck.add_filtros_pagador (ie_tipo_pagador_p text) FROM PUBLIC;
