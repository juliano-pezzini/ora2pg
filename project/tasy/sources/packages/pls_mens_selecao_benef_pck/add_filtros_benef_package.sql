-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_mens_selecao_benef_pck.add_filtros_benef () AS $body$
BEGIN

PERFORM set_config('pls_mens_selecao_benef_pck.sql_where_w', current_setting('pls_mens_selecao_benef_pck.sql_where_w')::varchar(32000) || ' and a.dt_cancelamento is null ', false);

if (current_setting('pls_mens_selecao_benef_pck.pls_lote_mensalidade_w')::pls_lote_mensalidade%(rowtype.nr_seq_segurado IS NOT NULL AND rowtype.nr_seq_segurado::text <> '')) then
	PERFORM set_config('pls_mens_selecao_benef_pck.sql_where_w', current_setting('pls_mens_selecao_benef_pck.sql_where_w')::varchar(32000) || ' and a.nr_sequencia = :nr_seq_segurado_pc', false);
	current_setting('pls_mens_selecao_benef_pck.valor_bind_w')::sql_pck.t_dado_bind := sql_pck.bind_variable(':nr_seq_segurado_pc', current_setting('pls_mens_selecao_benef_pck.pls_lote_mensalidade_w')::pls_lote_mensalidade%rowtype.nr_seq_segurado, current_setting('pls_mens_selecao_benef_pck.valor_bind_w')::sql_pck.t_dado_bind);
end if;

if (current_setting('pls_mens_selecao_benef_pck.pls_lote_mensalidade_w')::pls_lote_mensalidade%(rowtype.dt_inicio_adesao IS NOT NULL AND rowtype.dt_inicio_adesao::text <> '')) then
	PERFORM set_config('pls_mens_selecao_benef_pck.sql_where_w', current_setting('pls_mens_selecao_benef_pck.sql_where_w')::varchar(32000) || ' and a.dt_contratacao >= :dt_inicio_adesao_pc', false);
	current_setting('pls_mens_selecao_benef_pck.valor_bind_w')::sql_pck.t_dado_bind := sql_pck.bind_variable(':dt_inicio_adesao_pc', current_setting('pls_mens_selecao_benef_pck.pls_lote_mensalidade_w')::pls_lote_mensalidade%rowtype.dt_inicio_adesao, current_setting('pls_mens_selecao_benef_pck.valor_bind_w')::sql_pck.t_dado_bind);
end if;

if (current_setting('pls_mens_selecao_benef_pck.pls_lote_mensalidade_w')::pls_lote_mensalidade%(rowtype.dt_fim_adesao IS NOT NULL AND rowtype.dt_fim_adesao::text <> '')) then
	PERFORM set_config('pls_mens_selecao_benef_pck.sql_where_w', current_setting('pls_mens_selecao_benef_pck.sql_where_w')::varchar(32000) || ' and a.dt_contratacao <= :dt_fim_adesao_pc', false);
	current_setting('pls_mens_selecao_benef_pck.valor_bind_w')::sql_pck.t_dado_bind := sql_pck.bind_variable(':dt_fim_adesao_pc', current_setting('pls_mens_selecao_benef_pck.pls_lote_mensalidade_w')::pls_lote_mensalidade%rowtype.dt_fim_adesao, current_setting('pls_mens_selecao_benef_pck.valor_bind_w')::sql_pck.t_dado_bind);
end if;

if (current_setting('pls_mens_selecao_benef_pck.pls_lote_mensalidade_w')::pls_lote_mensalidade%(rowtype.nr_seq_classif_benef IS NOT NULL AND rowtype.nr_seq_classif_benef::text <> '')) then
	PERFORM set_config('pls_mens_selecao_benef_pck.sql_where_w', current_setting('pls_mens_selecao_benef_pck.sql_where_w')::varchar(32000) || ' and a.nr_seq_classificacao = :nr_seq_classif_benef_pc', false);
	current_setting('pls_mens_selecao_benef_pck.valor_bind_w')::sql_pck.t_dado_bind := sql_pck.bind_variable(':nr_seq_classif_benef_pc', current_setting('pls_mens_selecao_benef_pck.pls_lote_mensalidade_w')::pls_lote_mensalidade%rowtype.nr_seq_classif_benef, current_setting('pls_mens_selecao_benef_pck.valor_bind_w')::sql_pck.t_dado_bind);
end if;

if (current_setting('pls_mens_selecao_benef_pck.pls_lote_mensalidade_w')::pls_lote_mensalidade%(rowtype.nr_seq_solic_resc_fin IS NOT NULL AND rowtype.nr_seq_solic_resc_fin::text <> '')) then
	PERFORM set_config('pls_mens_selecao_benef_pck.sql_where_w', current_setting('pls_mens_selecao_benef_pck.sql_where_w')::varchar(32000) ||	' and exists(	select	1						' ||
					'		from	pls_solic_rescisao_benef x,			' ||
					'			pls_solicitacao_rescisao y,			' ||
					'			pls_solic_rescisao_fin z			' ||
					'		where	y.nr_sequencia = x.nr_seq_solicitacao		' ||
					'		and	y.nr_sequencia = z.nr_seq_solicitacao		' ||
					'		and	a.nr_sequencia = x.nr_seq_segurado		' ||
					'		and	z.nr_sequencia = :nr_seq_solic_resc_fin_pc)	', false);
	current_setting('pls_mens_selecao_benef_pck.valor_bind_w')::sql_pck.t_dado_bind := sql_pck.bind_variable(':nr_seq_solic_resc_fin_pc', current_setting('pls_mens_selecao_benef_pck.pls_lote_mensalidade_w')::pls_lote_mensalidade%rowtype.nr_seq_solic_resc_fin, current_setting('pls_mens_selecao_benef_pck.valor_bind_w')::sql_pck.t_dado_bind);
elsif (pls_mensalidade_util_pck.get_ie_susp_mens_solic_resc in ('S','T')) then --Suspender geracao de mensalidade para beneficiario com solicitacao de rescisao liberada e ainda nao efetivada
	PERFORM set_config('pls_mens_selecao_benef_pck.sql_where_w', current_setting('pls_mens_selecao_benef_pck.sql_where_w')::varchar(32000) ||	' and not exists(select 1 						' ||
					'		from	pls_solic_rescisao_benef x, 			' ||
					'			pls_solicitacao_rescisao y, 			' ||
					'			pls_motivo_cancelamento z 			' ||
					'		where	y.nr_sequencia = x.nr_seq_solicitacao 		' ||
					'		and	z.nr_sequencia = x.nr_seq_motivo_rescisao 	' ||
					'		and	x.nr_seq_segurado = a.nr_sequencia 		', false);
					
	if (pls_mensalidade_util_pck.get_ie_susp_mens_solic_resc = 'S') then
		PERFORM set_config('pls_mens_selecao_benef_pck.sql_where_w', current_setting('pls_mens_selecao_benef_pck.sql_where_w')::varchar(32000) || '		and	z.ie_iniciativa_beneficiario = ''S'' ', false);
	end if;
	
	PERFORM set_config('pls_mens_selecao_benef_pck.sql_where_w', current_setting('pls_mens_selecao_benef_pck.sql_where_w')::varchar(32000) ||	'		and	y.ie_status = 2) ', false);
end if;

--Restricao para buscar somente beneficiarios liberados

PERFORM set_config('pls_mens_selecao_benef_pck.sql_where_w', current_setting('pls_mens_selecao_benef_pck.sql_where_w')::varchar(32000) || ' and a.dt_liberacao is not null ', false);

--Restricao para desconsiderar os beneficiarios rescindidos a X meses. OPS - Gestao de Operadoras / Parametros da OPS / Mensalidade / "Quantidade de meses visibilidade de beneficiario rescindido"

PERFORM set_config('pls_mens_selecao_benef_pck.sql_where_w', current_setting('pls_mens_selecao_benef_pck.sql_where_w')::varchar(32000) || ' and ((a.dt_rescisao is null) or (a.dt_rescisao >= :dt_rescisao_param_pc))', false);
current_setting('pls_mens_selecao_benef_pck.valor_bind_w')::sql_pck.t_dado_bind := sql_pck.bind_variable(':dt_rescisao_param_pc', add_months(trunc(current_setting('pls_mens_selecao_benef_pck.pls_lote_mensalidade_w')::pls_lote_mensalidade%rowtype.dt_mesano_referencia,'month'),-pls_mensalidade_util_pck.get_qt_meses_benef_rescindido), current_setting('pls_mens_selecao_benef_pck.valor_bind_w')::sql_pck.t_dado_bind);

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_mens_selecao_benef_pck.add_filtros_benef () FROM PUBLIC;
