-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION sus_tipo_atendimento_pck.get_ie_tipo_atend_sus () RETURNS varchar AS $body$
BEGIN
        
        if (coalesce(current_setting('sus_tipo_atendimento_pck.ie_tipo_atend_sus')::varchar(1),'X') = 'X') then
                begin
                if (current_setting('sus_tipo_atendimento_pck.ie_tipo_atendimento')::atendimento_paciente.ie_tipo_atendimento%type = 1) then
                        begin
                        PERFORM set_config('sus_tipo_atendimento_pck.ie_tipo_atend_sus', 'A', false);
                        end;
                else
                        begin
                        select	count(1)
                        into STRICT	current_setting('sus_tipo_atendimento_pck.qt_reg_apac_w')::bigint
                        from	sus_apac_unif a
                        where	a.nr_interno_conta = current_setting('sus_tipo_atendimento_pck.nr_interno_conta_w')::conta_paciente.nr_interno_conta%type
                        and	a.nr_atendimento = current_setting('sus_tipo_atendimento_pck.nr_atendimento_w')::atendimento_paciente.nr_atendimento%type;

                        if (coalesce(current_setting('sus_tipo_atendimento_pck.qt_reg_apac_w')::bigint,0) > 0) then
                                PERFORM set_config('sus_tipo_atendimento_pck.ie_tipo_atend_sus', 'P', false);
                        else
                                begin
                                select	count(1)
                                into STRICT	current_setting('sus_tipo_atendimento_pck.qt_reg_bpa_w')::bigint
                                from	sus_bpa_unif a
                                where	a.nr_interno_conta = current_setting('sus_tipo_atendimento_pck.nr_interno_conta_w')::conta_paciente.nr_interno_conta%type
                                and	a.nr_atendimento = current_setting('sus_tipo_atendimento_pck.nr_atendimento_w')::atendimento_paciente.nr_atendimento%type;

                                if (coalesce(current_setting('sus_tipo_atendimento_pck.qt_reg_bpa_w')::bigint,0) > 0) then
                                        PERFORM set_config('sus_tipo_atendimento_pck.ie_tipo_atend_sus', 'B', false);
                                else
                                        begin
                                        select count(1)
                                        into STRICT current_setting('sus_tipo_atendimento_pck.qt_reg_apac_w')::bigint
                                        from sus_laudo_paciente a
                                        where a.nr_atendimento = current_setting('sus_tipo_atendimento_pck.nr_atendimento_w')::atendimento_paciente.nr_atendimento%type
                                        and a.ie_classificacao in (11,12,13,14)
                                        and (a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '');

                                        if (coalesce(current_setting('sus_tipo_atendimento_pck.qt_reg_apac_w')::bigint,0) > 0) then
                                                PERFORM set_config('sus_tipo_atendimento_pck.ie_tipo_atend_sus', 'P', false);
                                        else
                                                PERFORM set_config('sus_tipo_atendimento_pck.ie_tipo_atend_sus', 'B', false);
                                        end if;
                                        end;
                                end if;
                                end;
                        end if;
                        end;
                end if;
                end;
        end if;

	return current_setting('sus_tipo_atendimento_pck.ie_tipo_atend_sus')::varchar(1);
	end;


$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION sus_tipo_atendimento_pck.get_ie_tipo_atend_sus () FROM PUBLIC;
