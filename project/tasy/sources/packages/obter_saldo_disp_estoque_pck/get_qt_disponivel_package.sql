-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION obter_saldo_disp_estoque_pck.get_qt_disponivel ( cd_estabelecimento_p bigint, cd_material_p bigint, cd_local_estoque_p bigint, dt_mesano_referencia_p timestamp, nr_seq_lote_p bigint default null) RETURNS bigint AS $body$
DECLARE


	qt_saldo_contabil_w		double precision	:=	0;
	qt_cirurgia_w			double precision	:=	0;
	qt_esp_cirurgia_w		double precision	:=	0;
	qt_emergencia_w			double precision	:=	0;
	qt_agenda_cirurgia_w		double precision	:=	0;
	qt_material_gedipa_w		double precision	:=	0;
	qt_emprestimo_w			double precision	:=	0;
	qt_quimioterapia_w		double precision	:=	0;
	qt_requisicao_w			double precision	:=	0;
	qt_req_transf_estab_w		double precision	:=	0;
	qt_mat_ap_lote_w		double precision	:=	0;
	qt_kit_w			double precision	:=	0;
	qt_reg_kit_w			double precision	:=	0;
	qt_disp_estoque_w		double precision	:=	0;


	
BEGIN
	CALL CALL obter_saldo_disp_estoque_pck.set_dt_mesano_referencia(dt_mesano_referencia_p);
	CALL CALL CALL CALL CALL CALL CALL CALL CALL obter_saldo_disp_estoque_pck.set_cd_estabelecimento(cd_estabelecimento_p);
	CALL obter_saldo_disp_estoque_pck.set_nr_seq_lote(nr_seq_lote_p);
	CALL obter_saldo_disp_estoque_pck.set_cd_material(cd_material_p);

	qt_saldo_contabil_w	:=	obter_saldo_disp_estoque_pck.get_qt_saldo_contabil(cd_estabelecimento_p, cd_material_p, cd_local_estoque_p, get_dt_mesano_referencia);

	if (obter_saldo_disp_estoque_pck.get_ie_baixa_disp(cd_local_estoque_p) = 'S') then
		qt_cirurgia_w		:=	obter_saldo_disp_estoque_pck.get_qt_cirurgia(cd_estabelecimento_p, cd_material_p, cd_local_estoque_p, nr_seq_lote_p);
		qt_esp_cirurgia_w	:=	obter_saldo_disp_estoque_pck.get_qt_esp_cirurgia(cd_estabelecimento_p, cd_material_p, cd_local_estoque_p, nr_seq_lote_p);
		qt_emergencia_w		:=	obter_saldo_disp_estoque_pck.get_qt_prescr_eme(cd_estabelecimento_p, cd_material_p, cd_local_estoque_p, nr_seq_lote_p);
		qt_agenda_cirurgia_w	:=	obter_saldo_disp_estoque_pck.get_qt_ag_cirur(cd_estabelecimento_p, cd_material_p, cd_local_estoque_p, nr_seq_lote_p);
	end if;

	qt_material_gedipa_w	:=	obter_saldo_disp_estoque_pck.get_qt_sep_gedipa(cd_estabelecimento_p, cd_material_p, cd_local_estoque_p, nr_seq_lote_p);
	qt_emprestimo_w		:=	obter_saldo_disp_estoque_pck.get_qt_emprestimo(cd_estabelecimento_p, cd_material_p, cd_local_estoque_p, nr_seq_lote_p);
	qt_quimioterapia_w	:=	obter_saldo_disp_estoque_pck.get_qt_quimioterapia(cd_estabelecimento_p, cd_material_p, cd_local_estoque_p, nr_seq_lote_p);
	qt_requisicao_w		:=	obter_saldo_disp_estoque_pck.get_qt_req_trans(cd_estabelecimento_p, cd_material_p, cd_local_estoque_p, nr_seq_lote_p);
	qt_req_transf_estab_w	:=	obter_saldo_disp_estoque_pck.get_qt_req_trans_estab(cd_estabelecimento_p, cd_material_p, cd_local_estoque_p, nr_seq_lote_p);
	qt_mat_ap_lote_w	:=	obter_saldo_disp_estoque_pck.get_qt_ap_lote(cd_estabelecimento_p, cd_material_p, cd_local_estoque_p, nr_seq_lote_p);
	qt_kit_w		:=	obter_saldo_disp_estoque_pck.get_qt_comp_kit_estoque(cd_estabelecimento_p, cd_material_p, cd_local_estoque_p, nr_seq_lote_p);
	qt_reg_kit_w		:=	obter_saldo_disp_estoque_pck.get_qt_reg_kit_estoque(cd_estabelecimento_p, cd_material_p, cd_local_estoque_p, nr_seq_lote_p);

	qt_disp_estoque_w	:=	qt_saldo_contabil_w
					- qt_cirurgia_w
					- qt_esp_cirurgia_w
					- qt_emergencia_w
					- qt_agenda_cirurgia_w
					- qt_material_gedipa_w
					+ qt_emprestimo_w
					- qt_quimioterapia_w
					- qt_requisicao_w
					- qt_req_transf_estab_w
					- qt_mat_ap_lote_w
					- qt_kit_w
					- qt_reg_kit_w;


	/*R.aise_application_error(-20011,
		'#get_cd_estabelecimento='||get_cd_estabelecimento||
		'#get_cd_material_estoque='||get_cd_material_estoque||
		'#cd_local_estoque_p='||cd_local_estoque_p||
		'#get_dt_mesano_referencia='||get_dt_mesano_referencia||
		'#qt_saldo_contabil_w='||qt_saldo_contabil_w);*/
	return qt_disp_estoque_w;
	end;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_saldo_disp_estoque_pck.get_qt_disponivel ( cd_estabelecimento_p bigint, cd_material_p bigint, cd_local_estoque_p bigint, dt_mesano_referencia_p timestamp, nr_seq_lote_p bigint default null) FROM PUBLIC;
