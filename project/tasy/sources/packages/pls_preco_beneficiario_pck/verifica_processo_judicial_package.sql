-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pls_preco_beneficiario_pck.verifica_processo_judicial (nr_seq_segurado_p pls_segurado.nr_sequencia%type, nr_seq_contrato_p pls_contrato.nr_sequencia%type, nr_seq_titular_p pls_segurado.nr_seq_titular%type, cd_pessoa_fisica_p pessoa_fisica.cd_pessoa_fisica%type, dt_preco_p pls_segurado_preco.dt_reajuste%type, ie_acao_p text) RETURNS bigint AS $body$
DECLARE


nr_seq_processo_w	processo_judicial_liminar.nr_sequencia%type;
nr_seq_titular_w	pls_segurado.nr_seq_titular%type;


BEGIN

nr_seq_titular_w	:= coalesce(nr_seq_titular_p, nr_seq_segurado_p);

--1 Procura processo cadastrado para o beneficiario

select	max(b.nr_sequencia)
into STRICT	nr_seq_processo_w
from	pls_processo_judicial_reaj	a,
	processo_judicial_liminar	b
where	a.nr_seq_processo	= b.nr_sequencia
and	b.nr_seq_segurado	= nr_seq_segurado_p
and	b.ie_estagio		= 2
and	b.ie_impacto_reajuste	= 'S'
and	(((a.ie_impedir_reaj_fx_etaria	= 'S') and (ie_acao_p in ('E','R'))) or
	(a.ie_impedir_reaj_indice = 'S' AND ie_acao_p = 'I'))
and	dt_preco_p	>= coalesce(b.dt_inicio_validade,dt_preco_p)
and	dt_preco_p	<= coalesce(b.dt_fim_validade,dt_preco_p)
and	dt_preco_p	>= coalesce(a.dt_inicio_vigencia,dt_preco_p)
and	dt_preco_p	<= coalesce(a.dt_fim_vigencia,dt_preco_p);

--2 Procura processo cadastrado para a pessoa fisica do beneficiario

if ((cd_pessoa_fisica_p IS NOT NULL AND cd_pessoa_fisica_p::text <> '') and coalesce(nr_seq_processo_w::text, '') = '') then
	select	max(b.nr_sequencia)
	into STRICT	nr_seq_processo_w
	from	pls_processo_judicial_reaj	a,
		processo_judicial_liminar	b
	where	a.nr_seq_processo	= b.nr_sequencia
	and	b.nr_seq_segurado	in (	SELECT	x.nr_sequencia
						from	pls_segurado x
						where	x.cd_pessoa_fisica = cd_pessoa_fisica_p)
	and	b.ie_estagio		= 2
	and	b.ie_considera_codigo_pf = 'S'
	and	b.ie_impacto_reajuste	= 'S'
	and	(((a.ie_impedir_reaj_fx_etaria	= 'S') and (ie_acao_p in ('E','R'))) or
		(a.ie_impedir_reaj_indice = 'S' AND ie_acao_p = 'I'))
	and	dt_preco_p	>= coalesce(b.dt_inicio_validade,dt_preco_p)
	and	dt_preco_p	<= coalesce(b.dt_fim_validade,dt_preco_p)
	and	dt_preco_p	>= coalesce(a.dt_inicio_vigencia,dt_preco_p)
	and	dt_preco_p	<= coalesce(a.dt_fim_vigencia,dt_preco_p);
end if;

--3 Procura processo cadastrado para o titular do beneficiario

if ((nr_seq_titular_w IS NOT NULL AND nr_seq_titular_w::text <> '') and coalesce(nr_seq_processo_w::text, '') = '') then
	select	max(b.nr_sequencia)
	into STRICT	nr_seq_processo_w
	from	pls_processo_judicial_reaj	a,
		processo_judicial_liminar	b
	where	a.nr_seq_processo	= b.nr_sequencia
	and	(b.nr_seq_segurado in (	SELECT	x.nr_sequencia
					from	pls_segurado x
					where	((x.nr_seq_titular = nr_seq_titular_w) or (x.nr_sequencia = nr_seq_titular_w))))
	and	b.ie_estagio		= 2
	and	b.ie_impacto_reajuste	= 'S'
	and	a.ie_considerar_dependente = 'S'
	and	(((a.ie_impedir_reaj_fx_etaria	= 'S') and (ie_acao_p in ('E','R'))) or
		(a.ie_impedir_reaj_indice = 'S' AND ie_acao_p = 'I'))
	and	dt_preco_p	>= coalesce(b.dt_inicio_validade,dt_preco_p)
	and	dt_preco_p	<= coalesce(b.dt_fim_validade,dt_preco_p)
	and	dt_preco_p	>= coalesce(a.dt_inicio_vigencia,dt_preco_p)
	and	dt_preco_p	<= coalesce(a.dt_fim_vigencia,dt_preco_p);
end if;

--4 Procura processo cadastrado para o contrato do beneficiario

if (coalesce(nr_seq_processo_w::text, '') = '' and (nr_seq_contrato_p IS NOT NULL AND nr_seq_contrato_p::text <> '')) then
	select	max(b.nr_sequencia)
	into STRICT	nr_seq_processo_w
	from	pls_processo_judicial_reaj	a,
		processo_judicial_liminar	b
	where	a.nr_seq_processo	= b.nr_sequencia
	and	b.nr_seq_contrato	= nr_seq_contrato_p 
	and	b.ie_estagio		= 2
	and	b.ie_impacto_reajuste	= 'S'
	and	(((a.ie_impedir_reaj_fx_etaria	= 'S') and (ie_acao_p in ('E','R'))) or
		(a.ie_impedir_reaj_indice = 'S' AND ie_acao_p = 'I'))
	and	dt_preco_p	>= coalesce(b.dt_inicio_validade,dt_preco_p)
	and	dt_preco_p	<= coalesce(b.dt_fim_validade,dt_preco_p)
	and	dt_preco_p	>= coalesce(a.dt_inicio_vigencia,dt_preco_p)
	and	dt_preco_p	<= coalesce(a.dt_fim_vigencia,dt_preco_p);
end if;

return nr_seq_processo_w;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pls_preco_beneficiario_pck.verifica_processo_judicial (nr_seq_segurado_p pls_segurado.nr_sequencia%type, nr_seq_contrato_p pls_contrato.nr_sequencia%type, nr_seq_titular_p pls_segurado.nr_seq_titular%type, cd_pessoa_fisica_p pessoa_fisica.cd_pessoa_fisica%type, dt_preco_p pls_segurado_preco.dt_reajuste%type, ie_acao_p text) FROM PUBLIC;
