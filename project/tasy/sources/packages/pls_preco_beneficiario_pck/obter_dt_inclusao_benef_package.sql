-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pls_preco_beneficiario_pck.obter_dt_inclusao_benef ( ie_regulamentacao_p pls_plano.ie_regulamentacao%type, ie_data_ref_reaj_adaptado_p text, dt_inclusao_operadora_p pls_segurado.dt_inclusao_operadora%type, nr_seq_segurado_p pls_segurado.nr_sequencia%type, dt_contratacao_p pls_segurado.dt_contratacao%type) RETURNS timestamp AS $body$
DECLARE


nr_seq_mtvo_alteracao_w		pls_motivo_alteracao_plano.nr_sequencia%type;
dt_adaptacao_w			pls_segurado_alt_plano.dt_alteracao%type;


BEGIN

if (ie_regulamentacao_p in ('A','P')) then
	if (ie_data_ref_reaj_adaptado_p = 'A') then
		return dt_contratacao_p;
	elsif (ie_data_ref_reaj_adaptado_p = 'D') then
		select	max(nr_sequencia)
		into STRICT	nr_seq_mtvo_alteracao_w
		from	pls_motivo_alteracao_plano
		where	cd_ans	= '12';
		
		select	max(dt_alteracao)
		into STRICT	dt_adaptacao_w
		from	pls_segurado_alt_plano
		where	nr_seq_segurado		= nr_seq_segurado_p
		and	ie_situacao 		= 'A'
		and	nr_seq_motivo_alt	= nr_seq_mtvo_alteracao_w;
		
		if (dt_adaptacao_w IS NOT NULL AND dt_adaptacao_w::text <> '') then
			return dt_adaptacao_w;
		else
			return dt_inclusao_operadora_p;
		end if;
	else
		return dt_inclusao_operadora_p;
	end if;
else
	return dt_inclusao_operadora_p;
end if;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pls_preco_beneficiario_pck.obter_dt_inclusao_benef ( ie_regulamentacao_p pls_plano.ie_regulamentacao%type, ie_data_ref_reaj_adaptado_p text, dt_inclusao_operadora_p pls_segurado.dt_inclusao_operadora%type, nr_seq_segurado_p pls_segurado.nr_sequencia%type, dt_contratacao_p pls_segurado.dt_contratacao%type) FROM PUBLIC;
