-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_preco_beneficiario_pck.obter_valor_anterior ( nr_seq_segurado_p pls_segurado.nr_sequencia%type, dt_preco_p pls_segurado_preco.dt_reajuste%type, ie_acao_p text, nr_seq_tabela_p pls_tabela_preco.nr_sequencia%type, qt_reajuste_indice_futuro_p bigint, nr_seq_reaj_preco_atual_p pls_reajuste_preco.nr_sequencia%type, nr_seq_regra_susp_reaj_fx_p pls_susp_reaj_fx_etaria.nr_sequencia%type, nr_seq_regra_desc_p INOUT pls_regra_desconto.nr_sequencia%type, vl_preco_ant_p INOUT pls_segurado_preco.vl_preco_ant%type, nr_seq_plano_preco_p INOUT pls_segurado_preco.qt_vidas_tabela%type, nr_seq_reaj_preco_p INOUT pls_reajuste_preco.nr_sequencia%type, nr_seq_seg_preco_ant_p INOUT pls_segurado_preco.nr_sequencia%type, nr_seq_regra_aprop_p INOUT pls_regra_apropriacao.nr_sequencia%type, nr_seq_tabela_ant_p INOUT pls_tabela_preco.nr_sequencia%type, qt_idade_p INOUT bigint, vl_desconto_p INOUT pls_segurado_preco.vl_desconto%type, vl_preco_nao_subsid_ant_p INOUT pls_segurado_preco.vl_preco_nao_subsid_desc_ant%type) AS $body$
DECLARE


nr_seq_seg_preco_ant_w		pls_segurado_preco.nr_sequencia%type;
nr_seq_regra_desc_w		pls_regra_desconto.nr_sequencia%type;
vl_preco_ant_w			pls_segurado_preco.vl_preco_atual%type;
nr_seq_plano_preco_w		pls_plano_preco.nr_sequencia%type;
nr_seq_reaj_preco_w		pls_reajuste_preco.nr_sequencia%type;
nr_seq_regra_aprop_w		pls_regra_apropriacao.nr_sequencia%type;
nr_seq_tabela_w			pls_tabela_preco.nr_sequencia%type;
qt_idade_w			bigint;
vl_desconto_w			pls_segurado_preco.vl_desconto%type;
cd_motivo_reajuste_w		pls_segurado_preco.cd_motivo_reajuste%type;
vl_preco_ant_ww			pls_segurado_preco.vl_preco_atual%type;
nr_seq_regra_susp_reaj_fx_w	pls_segurado_preco.nr_seq_regra_susp_reaj_fx%type;
vl_preco_nao_subsid_ant_w	pls_segurado_preco.vl_preco_nao_subsid_desc_ant%type;


BEGIN
nr_seq_seg_preco_ant_w	:= null;
nr_seq_regra_desc_w	:= null;
vl_preco_ant_w		:= 0;
vl_preco_ant_ww		:= 0;
nr_seq_plano_preco_w	:= null;
nr_seq_reaj_preco_w	:= null;
nr_seq_regra_aprop_w	:= null;
nr_seq_tabela_w		:= null;
qt_idade_w		:= null;
vl_desconto_w		:= 0;
vl_preco_nao_subsid_ant_w := 0;

if (ie_acao_p = 'E') then
	select	max(nr_sequencia)
	into STRICT	nr_seq_seg_preco_ant_w
	from	pls_segurado_preco
	where	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
	and	nr_seq_segurado	= nr_seq_segurado_p
	and	ie_situacao	= 'A'
	and	dt_reajuste	= trunc(add_months(dt_preco_p,1),'mm')
	and	cd_motivo_reajuste = 'SF';
end if;

if (coalesce(nr_seq_seg_preco_ant_w::text, '') = '') then
	select	max(nr_sequencia)
	into STRICT	nr_seq_seg_preco_ant_w
	from	pls_segurado_preco
	where	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
	and	nr_seq_segurado	= nr_seq_segurado_p
	and	ie_situacao	= 'A'
	and	dt_reajuste	<= dt_preco_p;
end if;

if (nr_seq_seg_preco_ant_w IS NOT NULL AND nr_seq_seg_preco_ant_w::text <> '') then
	select	nr_seq_regra,
		coalesce(vl_preco_atual,0) - coalesce(vl_desconto,0),
		nr_seq_preco,
		nr_seq_reajuste,
		nr_seq_regra_apropriacao,
		nr_seq_tabela,
		qt_idade,
		vl_desconto,
		cd_motivo_reajuste,
		coalesce(vl_preco_ant,0),
		nr_seq_regra_susp_reaj_fx,
		vl_preco_nao_subsid_desc
	into STRICT	nr_seq_regra_desc_w,
		vl_preco_ant_w,
		nr_seq_plano_preco_w,
		nr_seq_reaj_preco_w,
		nr_seq_regra_aprop_w,
		nr_seq_tabela_w,
		qt_idade_w,
		vl_desconto_w,
		cd_motivo_reajuste_w,
		vl_preco_ant_ww,
		nr_seq_regra_susp_reaj_fx_w,
		vl_preco_nao_subsid_ant_w
	from	pls_segurado_preco
	where	nr_sequencia = nr_seq_seg_preco_ant_w;

	if (qt_reajuste_indice_futuro_p > 0) then
		if	((cd_motivo_reajuste_w = 'E') and (ie_acao_p = 'I') and (nr_seq_regra_susp_reaj_fx_w IS NOT NULL AND nr_seq_regra_susp_reaj_fx_w::text <> '')) then
			select	max(vl_base)
			into STRICT	vl_preco_ant_w
			from	pls_reajuste_preco	a
			where	nr_sequencia = nr_seq_reaj_preco_atual_p;
		elsif (cd_motivo_reajuste_w = 'E') and (ie_acao_p = 'E') and (nr_seq_regra_susp_reaj_fx_p IS NOT NULL AND nr_seq_regra_susp_reaj_fx_p::text <> '') then
			select	max(a.vl_preco_atual)
			into STRICT	vl_preco_ant_w
			from	pls_plano_preco	a
			where	a.nr_seq_tabela	= nr_seq_tabela_p
			and	a.nr_sequencia = (	SELECT	max(x.nr_sequencia)
							from	pls_plano_preco x
							where	x.nr_seq_tabela = a.nr_seq_tabela
							and	x.nr_sequencia < nr_seq_plano_preco_w);
		elsif (nr_seq_regra_susp_reaj_fx_p IS NOT NULL AND nr_seq_regra_susp_reaj_fx_p::text <> '') then
			select	max(a.vl_reajustado)
			into STRICT	vl_preco_ant_w
			from	pls_reajuste_preco	a
			where	a.nr_sequencia = (	SELECT	min(x.nr_sequencia)
							from	pls_reajuste_preco x
							where	x.nr_seq_preco	= nr_seq_plano_preco_w
							and	x.dt_reajuste	> dt_preco_p
							and	(x.dt_liberacao IS NOT NULL AND x.dt_liberacao::text <> ''));
		end if;
	elsif	((ie_acao_p = 'E') and (cd_motivo_reajuste_w = 'E') and (nr_seq_regra_susp_reaj_fx_w IS NOT NULL AND nr_seq_regra_susp_reaj_fx_w::text <> '')) then
		vl_preco_ant_w	:= vl_preco_ant_ww;
	end if;
end if;

nr_seq_regra_desc_p	:= nr_seq_regra_desc_w;
vl_preco_ant_p		:= vl_preco_ant_w;
nr_seq_plano_preco_p	:= nr_seq_plano_preco_w;
nr_seq_reaj_preco_p	:= nr_seq_reaj_preco_w;
nr_seq_seg_preco_ant_p	:= nr_seq_seg_preco_ant_w;
nr_seq_regra_aprop_p	:= nr_seq_regra_aprop_w;
nr_seq_tabela_ant_p	:= nr_seq_tabela_w;
qt_idade_p		:= qt_idade_w;
vl_desconto_p		:= vl_desconto_w;
vl_preco_nao_subsid_ant_p := vl_preco_nao_subsid_ant_w;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_preco_beneficiario_pck.obter_valor_anterior ( nr_seq_segurado_p pls_segurado.nr_sequencia%type, dt_preco_p pls_segurado_preco.dt_reajuste%type, ie_acao_p text, nr_seq_tabela_p pls_tabela_preco.nr_sequencia%type, qt_reajuste_indice_futuro_p bigint, nr_seq_reaj_preco_atual_p pls_reajuste_preco.nr_sequencia%type, nr_seq_regra_susp_reaj_fx_p pls_susp_reaj_fx_etaria.nr_sequencia%type, nr_seq_regra_desc_p INOUT pls_regra_desconto.nr_sequencia%type, vl_preco_ant_p INOUT pls_segurado_preco.vl_preco_ant%type, nr_seq_plano_preco_p INOUT pls_segurado_preco.qt_vidas_tabela%type, nr_seq_reaj_preco_p INOUT pls_reajuste_preco.nr_sequencia%type, nr_seq_seg_preco_ant_p INOUT pls_segurado_preco.nr_sequencia%type, nr_seq_regra_aprop_p INOUT pls_regra_apropriacao.nr_sequencia%type, nr_seq_tabela_ant_p INOUT pls_tabela_preco.nr_sequencia%type, qt_idade_p INOUT bigint, vl_desconto_p INOUT pls_segurado_preco.vl_desconto%type, vl_preco_nao_subsid_ant_p INOUT pls_segurado_preco.vl_preco_nao_subsid_desc_ant%type) FROM PUBLIC;
