-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


-- PLS_MONTAR_TELA



CREATE OR REPLACE PROCEDURE pls_ar_montar_resultado_pck.pls_montar_tela ( ds_filtros_p text, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) AS $body$
DECLARE


dados_filtro_w		tb_filtros_analise_resultado;


BEGIN

delete	FROM w_pls_ar_dimensao where nm_usuario = nm_usuario_p; --Deletar todos registros para o usuario
delete	FROM w_pls_ar_dimensao where dt_atualizacao <= fim_dia(clock_timestamp() - interval '2 days'); --Deletar os registros antigos

commit;

-- Busca os dados da string passada por parametro e alimenta nas variaveis correspondentes

dados_filtro_w 	:= pls_ar_montar_resultado_pck.obter_filtro_busca_analise(ds_filtros_p);

-- Gera os dados da analise.

CALL pls_ar_montar_resultado_pck.executa_sql_analise(dados_filtro_w,nm_usuario_p);

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_ar_montar_resultado_pck.pls_montar_tela ( ds_filtros_p text, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) FROM PUBLIC;
