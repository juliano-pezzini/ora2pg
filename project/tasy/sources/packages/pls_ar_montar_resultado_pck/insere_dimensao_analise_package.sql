-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


-- INSERE_DIMENSAO_ANALISE



CREATE OR REPLACE PROCEDURE pls_ar_montar_resultado_pck.insere_dimensao_analise ( ie_dimensao_p text, ds_tipo_dimensao_p text, ds_dimensao_p text, ds_dimensao_sup_p text, dados_restricao_p text, dados_filtro_p tb_filtros_analise_resultado, valor_bind_p sql_pck.t_dado_bind, nm_usuario_p text) AS $body$
DECLARE


sql_base_w			varchar(32000);
ds_campo_estipulante_w		varchar(255);
ds_valor_dimensao_w		varchar(255);
cursor_w			sql_pck.t_cursor;
tb_vl_total_w			pls_util_cta_pck.t_number_table;
tb_ie_valor_w			pls_util_cta_pck.t_varchar2_table_2;
tb_nr_seq_contrato_w		pls_util_cta_pck.t_number_table;
tb_nr_seq_segurado_w		pls_util_cta_pck.t_number_table;
tb_nr_seq_pagador_w		pls_util_cta_pck.t_number_table;
tb_nr_seq_plano_w		pls_util_cta_pck.t_number_table;
tb_ds_estipulante_w		pls_util_cta_pck.t_varchar2_table_255;
tb_ds_dimensao_w		pls_util_cta_pck.t_varchar2_table_255;
tb_ds_dimensao_sup_w		pls_util_cta_pck.t_varchar2_table_255;
tb_ds_valor_dimensao_w		pls_util_cta_pck.t_varchar2_table_255;
tb_ie_tipo_valor_w		pls_util_cta_pck.t_varchar2_table_2;
valor_bind_w			sql_pck.t_dado_bind;
tb_ie_tipo_segurado_w		pls_util_cta_pck.t_varchar2_table_2;


retorno_valores_analise_w REFCURSOR;


BEGIN
if (ds_tipo_dimensao_p = 'C') then
	ds_campo_estipulante_w := '	substr(decode(a.nr_seq_contrato, null, pls_obter_dados_contrato_inter(a.nr_seq_intercambio, null, ''E''), pls_obter_estipulante_contrato(a.nr_seq_contrato)),1,255) ds_estipulante_contr, ';
else
	ds_campo_estipulante_w := 'null, ';
end if;

ds_valor_dimensao_w	:= pls_ar_montar_resultado_pck.obter_valor_dimensao(ds_tipo_dimensao_p) || ',';

valor_bind_w		:= valor_bind_p;

sql_base_w	:= 	-- Mensalidade
			'select	nvl(sum(a.vl_item),0) vl_total, ' || pls_util_pck.enter_w ||
			'	''M'' ie_valor, ' || pls_util_pck.enter_w ||
			'	nvl(a.nr_seq_contrato, a.nr_seq_intercambio) nr_seq_contrato, ' || pls_util_pck.enter_w ||
			'	a.nr_seq_segurado, ' || pls_util_pck.enter_w ||
			'	a.ie_tipo_segurado, '|| pls_util_pck.enter_w ||
			'	a.nr_seq_pagador, ' || pls_util_pck.enter_w ||
			'	a.nr_seq_plano, ' || pls_util_pck.enter_w ||
			'	null ie_tipo_valor, ' || pls_util_pck.enter_w ||
			ds_valor_dimensao_w || pls_util_pck.enter_w ||
			ds_campo_estipulante_w || pls_util_pck.enter_w ||
			'	' || ds_dimensao_p || ',' || pls_util_pck.enter_w ||
			'	' || ds_dimensao_sup_p || pls_util_pck.enter_w ||
			'from	pls_ar_lote		lote, ' || pls_util_pck.enter_w ||
			'	pls_ar_mensalidade 	a, ' || pls_util_pck.enter_w ||
			'	pls_segurado 		s ' || pls_util_pck.enter_w ||
			'where	a.nr_seq_lote	= lote.nr_sequencia ' || pls_util_pck.enter_w ||
			'and	s.nr_sequencia	= a.nr_seq_segurado ' || pls_util_pck.enter_w ||
			valor_bind_w := pls_ar_montar_resultado_pck.obter_sql_restricao(dados_filtro_p, 'A', 'PLS_AR_MENSALIDADE', valor_bind_w) || pls_util_pck.enter_w ||
			'group by a.nr_seq_contrato, a.nr_seq_intercambio, a.nr_seq_segurado, a.ie_tipo_segurado, a.nr_seq_pagador, a.nr_seq_plano, ' || ds_valor_dimensao_w || ds_dimensao_sup_p || pls_util_pck.enter_w ||
			'union all ' || pls_util_pck.enter_w ||
			-- Contas medicas

			'select	nvl(sum(a.vl_total),0) vl_total, ' || pls_util_pck.enter_w ||
			'	''CM'' ie_valor, ' || pls_util_pck.enter_w ||
			'	nvl(a.nr_seq_contrato, a.nr_seq_intercambio) nr_seq_contrato, ' || pls_util_pck.enter_w ||
			'	a.nr_seq_segurado, ' || pls_util_pck.enter_w ||
			'	a.ie_tipo_segurado, '|| pls_util_pck.enter_w ||
			'	a.nr_seq_pagador, ' || pls_util_pck.enter_w ||
			'	a.nr_seq_plano, ' || pls_util_pck.enter_w ||
			'	nvl(a.ie_tipo_valor, ''C'') ie_tipo_valor, ' || pls_util_pck.enter_w ||
			ds_valor_dimensao_w || pls_util_pck.enter_w ||
			ds_campo_estipulante_w || pls_util_pck.enter_w ||
			'	' || ds_dimensao_p || ',' || pls_util_pck.enter_w ||
			'	' || ds_dimensao_sup_p || pls_util_pck.enter_w ||
			'from	pls_ar_lote		lote, ' || pls_util_pck.enter_w ||
			'	pls_ar_conta 		a, ' || pls_util_pck.enter_w ||
			'	pls_segurado 		s ' || pls_util_pck.enter_w ||
			'where	a.nr_seq_lote = lote.nr_sequencia ' || pls_util_pck.enter_w ||
			'and	s.nr_sequencia	= a.nr_seq_segurado ' || pls_util_pck.enter_w ||
			valor_bind_w := pls_ar_montar_resultado_pck.obter_sql_restricao(dados_filtro_p, 'A', 'PLS_AR_CONTA', valor_bind_w) || pls_util_pck.enter_w || pls_util_pck.enter_w ||
			'group by a.nr_seq_contrato, a.nr_seq_intercambio, a.nr_seq_segurado, a.ie_tipo_segurado, a.nr_seq_pagador, a.nr_seq_plano, nvl(a.ie_tipo_valor, ''C''), ' || ds_valor_dimensao_w || ds_dimensao_sup_p || pls_util_pck.enter_w ||
			'union all ' || pls_util_pck.enter_w ||
			-- Reembolso

			'select	nvl(sum(a.vl_total),0) vl_total, ' || pls_util_pck.enter_w ||
			'	''RB'' ie_valor, ' || pls_util_pck.enter_w ||
			'	nvl(a.nr_seq_contrato, a.nr_seq_intercambio) nr_seq_contrato, ' || pls_util_pck.enter_w ||
			'	a.nr_seq_segurado, ' || pls_util_pck.enter_w ||
			'	a.ie_tipo_segurado, '|| pls_util_pck.enter_w ||
			'	a.nr_seq_pagador, ' || pls_util_pck.enter_w ||
			'	a.nr_seq_plano, ' || pls_util_pck.enter_w ||
			'	null ie_tipo_valor, ' || pls_util_pck.enter_w ||
			ds_valor_dimensao_w || pls_util_pck.enter_w ||
			ds_campo_estipulante_w || pls_util_pck.enter_w ||
			'	' || ds_dimensao_p || ',' || pls_util_pck.enter_w ||
			'	' || ds_dimensao_sup_p || pls_util_pck.enter_w ||
			'from	pls_ar_lote		lote, ' || pls_util_pck.enter_w ||
			'	pls_ar_reembolso 	a, ' || pls_util_pck.enter_w ||
			'	pls_segurado 		s ' || pls_util_pck.enter_w ||
			'where	a.nr_seq_lote = lote.nr_sequencia ' || pls_util_pck.enter_w ||
			'and	s.nr_sequencia	= a.nr_seq_segurado ' || pls_util_pck.enter_w ||
			valor_bind_w := pls_ar_montar_resultado_pck.obter_sql_restricao(dados_filtro_p, 'A', 'PLS_AR_REEMBOLSO', valor_bind_w) || pls_util_pck.enter_w || pls_util_pck.enter_w ||
			'group by a.nr_seq_contrato, a.nr_seq_intercambio, a.nr_seq_segurado, a.ie_tipo_segurado, a.nr_seq_pagador, a.nr_seq_plano, ' || ds_valor_dimensao_w || ds_dimensao_sup_p || pls_util_pck.enter_w ||
			'union all ' || pls_util_pck.enter_w ||
			-- Coparticipacao

			'select	nvl(sum(a.vl_coparticipacao),0) vl_total, ' || pls_util_pck.enter_w ||
			'	''C'' ie_valor, ' || pls_util_pck.enter_w ||
			'	nvl(a.nr_seq_contrato, a.nr_seq_intercambio) nr_seq_contrato, ' || pls_util_pck.enter_w ||
			'	a.nr_seq_segurado, ' || pls_util_pck.enter_w ||
			'	a.ie_tipo_segurado, '|| pls_util_pck.enter_w ||
			'	a.nr_seq_pagador, ' || pls_util_pck.enter_w ||
			'	a.nr_seq_plano, ' || pls_util_pck.enter_w ||
			'	null ie_tipo_valor, ' || pls_util_pck.enter_w ||
			ds_valor_dimensao_w || pls_util_pck.enter_w ||
			ds_campo_estipulante_w || pls_util_pck.enter_w ||
			'	' || ds_dimensao_p || ',' || pls_util_pck.enter_w ||
			'	' || ds_dimensao_sup_p || pls_util_pck.enter_w ||
			'from	pls_ar_lote		lote, ' || pls_util_pck.enter_w ||
			'	pls_ar_coparticipacao 	a, ' || pls_util_pck.enter_w ||
			'	pls_segurado 		s ' || pls_util_pck.enter_w ||
			'where	a.nr_seq_lote = lote.nr_sequencia ' || pls_util_pck.enter_w ||
			'and	s.nr_sequencia	= a.nr_seq_segurado ' || pls_util_pck.enter_w ||
			valor_bind_w := pls_ar_montar_resultado_pck.obter_sql_restricao(dados_filtro_p, 'A', 'PLS_AR_COPARTICIPACAO', valor_bind_w) || pls_util_pck.enter_w ||
			'group by a.nr_seq_contrato, a.nr_seq_intercambio, a.nr_seq_segurado, a.ie_tipo_segurado, a.nr_seq_pagador, a.nr_seq_plano, ' || ds_valor_dimensao_w || ds_dimensao_sup_p || pls_util_pck.enter_w ||
			'union all ' || pls_util_pck.enter_w ||
			-- Comissao

			'select	nvl(sum(a.vl_comissao),0) vl_total, ' || pls_util_pck.enter_w ||
			'	''CO'' ie_valor, ' || pls_util_pck.enter_w ||
			'	nvl(a.nr_seq_contrato, a.nr_seq_intercambio) nr_seq_contrato, ' || pls_util_pck.enter_w ||
			'	a.nr_seq_segurado, ' || pls_util_pck.enter_w ||
			'	a.ie_tipo_segurado, '|| pls_util_pck.enter_w ||
			'	a.nr_seq_pagador, ' || pls_util_pck.enter_w ||
			'	a.nr_seq_plano, ' || pls_util_pck.enter_w ||
			'	null ie_tipo_valor, ' || pls_util_pck.enter_w ||
			ds_valor_dimensao_w || pls_util_pck.enter_w ||
			ds_campo_estipulante_w || pls_util_pck.enter_w ||
			'	' || ds_dimensao_p || ',' || pls_util_pck.enter_w ||
			'	' || ds_dimensao_sup_p || pls_util_pck.enter_w ||
			'from	pls_ar_lote		lote, ' || pls_util_pck.enter_w ||
			'	pls_ar_comissao 	a, ' || pls_util_pck.enter_w ||
			'	pls_segurado 		s ' || pls_util_pck.enter_w ||
			'where	a.nr_seq_lote = lote.nr_sequencia ' || pls_util_pck.enter_w ||
			'and	s.nr_sequencia	= a.nr_seq_segurado ' || pls_util_pck.enter_w ||
			valor_bind_w := pls_ar_montar_resultado_pck.obter_sql_restricao(dados_filtro_p, 'A', 'PLS_AR_COMISSAO', valor_bind_w) || pls_util_pck.enter_w || pls_util_pck.enter_w ||
			'group by a.nr_seq_contrato, a.nr_seq_intercambio, a.nr_seq_segurado, a.ie_tipo_segurado, a.nr_seq_pagador, a.nr_seq_plano, ' || ds_valor_dimensao_w || ds_dimensao_sup_p || pls_util_pck.enter_w ||
			'union all ' || pls_util_pck.enter_w ||
			-- Ressarcimento SUS

			'select	nvl(sum(a.vl_ressarcir),0) vl_total, ' || pls_util_pck.enter_w ||
			'	''RS'' ie_valor, ' || pls_util_pck.enter_w ||
			'	nvl(a.nr_seq_contrato, a.nr_seq_intercambio) nr_seq_contrato, ' || pls_util_pck.enter_w ||
			'	a.nr_seq_segurado, ' || pls_util_pck.enter_w ||
			'	a.ie_tipo_segurado, '|| pls_util_pck.enter_w ||
			'	a.nr_seq_pagador, ' || pls_util_pck.enter_w ||
			'	a.nr_seq_plano, ' || pls_util_pck.enter_w ||
			'	null ie_tipo_valor, ' || pls_util_pck.enter_w ||
			ds_valor_dimensao_w || pls_util_pck.enter_w ||
			ds_campo_estipulante_w || pls_util_pck.enter_w ||
			'	' || ds_dimensao_p || ',' || pls_util_pck.enter_w ||
			'	' || ds_dimensao_sup_p || pls_util_pck.enter_w ||
			'from	pls_ar_lote		lote, ' || pls_util_pck.enter_w ||
			'	pls_ar_ress_sus 	a, ' || pls_util_pck.enter_w ||
			'	pls_segurado 		s ' || pls_util_pck.enter_w ||
			'where	a.nr_seq_lote = lote.nr_sequencia ' || pls_util_pck.enter_w ||
			'and	s.nr_sequencia	= a.nr_seq_segurado ' || pls_util_pck.enter_w ||
			valor_bind_w := pls_ar_montar_resultado_pck.obter_sql_restricao(dados_filtro_p, 'A', 'PLS_AR_RESS_SUS', valor_bind_w) || pls_util_pck.enter_w ||
			'group by a.nr_seq_contrato, a.nr_seq_intercambio, a.nr_seq_segurado, a.ie_tipo_segurado, a.nr_seq_pagador, a.nr_seq_plano, ' || ds_valor_dimensao_w || ds_dimensao_sup_p || pls_util_pck.enter_w ||
			'union all ' || pls_util_pck.enter_w ||
			-- Recurso de glosa

			'select	nvl(sum(a.vl_recurso),0) vl_total, ' || pls_util_pck.enter_w ||
			'	''RG'' ie_valor, ' || pls_util_pck.enter_w ||
			'	nvl(a.nr_seq_contrato, a.nr_seq_intercambio) nr_seq_contrato, ' || pls_util_pck.enter_w ||
			'	a.nr_seq_segurado, ' || pls_util_pck.enter_w ||
			'	a.ie_tipo_segurado, '|| pls_util_pck.enter_w ||
			'	a.nr_seq_pagador, ' || pls_util_pck.enter_w ||
			'	a.nr_seq_plano, ' || pls_util_pck.enter_w ||
			'	null ie_tipo_valor, ' || pls_util_pck.enter_w ||
			ds_valor_dimensao_w || pls_util_pck.enter_w ||
			ds_campo_estipulante_w || pls_util_pck.enter_w ||
			'	' || ds_dimensao_p || ',' || pls_util_pck.enter_w ||
			'	' || ds_dimensao_sup_p || pls_util_pck.enter_w ||
			'from	pls_ar_lote		lote, ' || pls_util_pck.enter_w ||
			'	pls_ar_rec_glosa 	a, ' || pls_util_pck.enter_w ||
			'	pls_segurado 		s ' || pls_util_pck.enter_w ||
			'where	a.nr_seq_lote = lote.nr_sequencia ' || pls_util_pck.enter_w ||
			'and	s.nr_sequencia	= a.nr_seq_segurado ' || pls_util_pck.enter_w ||
			valor_bind_w := pls_ar_montar_resultado_pck.obter_sql_restricao(dados_filtro_p, 'A', 'PLS_AR_REC_GLOSA', valor_bind_w) || pls_util_pck.enter_w ||
			'group by a.nr_seq_contrato, a.nr_seq_intercambio, a.nr_seq_segurado, a.ie_tipo_segurado, a.nr_seq_pagador, a.nr_seq_plano, ' || ds_valor_dimensao_w || ds_dimensao_sup_p || pls_util_pck.enter_w ||
			'union all ' || pls_util_pck.enter_w ||
			-- Contestacao - Exibe na mesma coluna do recurso de glosa

			'select	nvl(sum(a.vl_contestacao),0) vl_total, ' || pls_util_pck.enter_w ||
			'	''RG'' ie_valor, ' || pls_util_pck.enter_w ||
			'	nvl(a.nr_seq_contrato, a.nr_seq_intercambio) nr_seq_contrato, ' || pls_util_pck.enter_w ||
			'	a.nr_seq_segurado, ' || pls_util_pck.enter_w ||
			'	a.ie_tipo_segurado, '|| pls_util_pck.enter_w ||
			'	a.nr_seq_pagador, ' || pls_util_pck.enter_w ||
			'	a.nr_seq_plano, ' || pls_util_pck.enter_w ||
			'	null ie_tipo_valor, ' || pls_util_pck.enter_w ||
			ds_valor_dimensao_w || pls_util_pck.enter_w ||
			ds_campo_estipulante_w || pls_util_pck.enter_w ||
			'	' || ds_dimensao_p || ',' || pls_util_pck.enter_w ||
			'	' || ds_dimensao_sup_p || pls_util_pck.enter_w ||
			'from	pls_ar_lote		lote, ' || pls_util_pck.enter_w ||
			'	pls_ar_contestacao 	a, ' || pls_util_pck.enter_w ||
			'	pls_segurado 		s ' || pls_util_pck.enter_w ||
			'where	a.nr_seq_lote = lote.nr_sequencia ' || pls_util_pck.enter_w ||
			'and	s.nr_sequencia	= a.nr_seq_segurado ' || pls_util_pck.enter_w ||
			valor_bind_w := pls_ar_montar_resultado_pck.obter_sql_restricao(dados_filtro_p, 'A', 'PLS_AR_CONTESTACAO', valor_bind_w) || pls_util_pck.enter_w ||
			'group by a.nr_seq_contrato, a.nr_seq_intercambio, a.nr_seq_segurado, a.ie_tipo_segurado, a.nr_seq_pagador, a.nr_seq_plano, ' || ds_valor_dimensao_w || ds_dimensao_sup_p || pls_util_pck.enter_w ||
			'union all ' || pls_util_pck.enter_w ||
			-- Faturamento

			'select	nvl(sum(a.vl_faturado),0) vl_total, ' || pls_util_pck.enter_w ||
			'	''F'' ie_valor, ' || pls_util_pck.enter_w ||
			'	nvl(a.nr_seq_contrato, a.nr_seq_intercambio) nr_seq_contrato, ' || pls_util_pck.enter_w ||
			'	a.nr_seq_segurado, ' || pls_util_pck.enter_w ||
			'	a.ie_tipo_segurado, '|| pls_util_pck.enter_w ||
			'	a.nr_seq_pagador, ' || pls_util_pck.enter_w ||
			'	a.nr_seq_plano, ' || pls_util_pck.enter_w ||
			'	null ie_tipo_valor, ' || pls_util_pck.enter_w ||
			ds_valor_dimensao_w || pls_util_pck.enter_w ||
			ds_campo_estipulante_w || pls_util_pck.enter_w ||
			'	' || ds_dimensao_p || ',' || pls_util_pck.enter_w ||
			'	' || ds_dimensao_sup_p || pls_util_pck.enter_w ||
			'from	pls_ar_lote		lote, ' || pls_util_pck.enter_w ||
			'	pls_ar_faturamento 	a, ' || pls_util_pck.enter_w ||
			'	pls_segurado 		s ' || pls_util_pck.enter_w ||
			'where	a.nr_seq_lote = lote.nr_sequencia ' || pls_util_pck.enter_w ||
			'and	s.nr_sequencia	= a.nr_seq_segurado ' || pls_util_pck.enter_w ||
			valor_bind_w := pls_ar_montar_resultado_pck.obter_sql_restricao(dados_filtro_p, 'A', 'PLS_AR_FATURAMENTO', valor_bind_w) || pls_util_pck.enter_w ||
			'group by a.nr_seq_contrato, a.nr_seq_intercambio, a.nr_seq_segurado, a.ie_tipo_segurado, a.nr_seq_pagador, a.nr_seq_plano, ' || ds_valor_dimensao_w || ds_dimensao_sup_p || pls_util_pck.enter_w ||
			'union all ' || pls_util_pck.enter_w ||
			-- Taxa de intercambio

			'select	nvl(sum(a.vl_taxa),0) vl_total, ' || pls_util_pck.enter_w ||
			'	''TI'' ie_valor, ' || pls_util_pck.enter_w ||
			'	nvl(a.nr_seq_contrato, a.nr_seq_intercambio) nr_seq_contrato, ' || pls_util_pck.enter_w ||
			'	a.nr_seq_segurado, ' || pls_util_pck.enter_w ||
			'	a.ie_tipo_segurado, '|| pls_util_pck.enter_w ||
			'	a.nr_seq_pagador, ' || pls_util_pck.enter_w ||
			'	a.nr_seq_plano, ' || pls_util_pck.enter_w ||
			'	null ie_tipo_valor, ' || pls_util_pck.enter_w ||
			ds_valor_dimensao_w || pls_util_pck.enter_w ||
			ds_campo_estipulante_w || pls_util_pck.enter_w ||
			'	' || ds_dimensao_p || ',' || pls_util_pck.enter_w ||
			'	' || ds_dimensao_sup_p || pls_util_pck.enter_w ||
			'from	pls_ar_lote		lote, ' || pls_util_pck.enter_w ||
			'	pls_ar_faturamento 	a, ' || pls_util_pck.enter_w ||
			'	pls_segurado 		s ' || pls_util_pck.enter_w ||
			'where	a.nr_seq_lote = lote.nr_sequencia ' || pls_util_pck.enter_w ||
			'and	s.nr_sequencia	= a.nr_seq_segurado ' || pls_util_pck.enter_w ||
			valor_bind_w := pls_ar_montar_resultado_pck.obter_sql_restricao(dados_filtro_p, 'A', 'PLS_AR_FATURAMENTO', valor_bind_w) || pls_util_pck.enter_w ||
			'group by a.nr_seq_contrato, a.nr_seq_intercambio, a.nr_seq_segurado, a.ie_tipo_segurado, a.nr_seq_pagador, a.nr_seq_plano, ' || ds_valor_dimensao_w || ds_dimensao_sup_p || pls_util_pck.enter_w ||
			'union all ' || pls_util_pck.enter_w ||
			'select	nvl(sum(a.vl_despesa),0) vl_total, ' || pls_util_pck.enter_w ||
			'	''DN'' ie_valor, ' || pls_util_pck.enter_w ||
			'	nvl(a.nr_seq_contrato, a.nr_seq_intercambio) nr_seq_contrato, ' || pls_util_pck.enter_w ||
			'	a.nr_seq_segurado, ' || pls_util_pck.enter_w ||
			'	a.ie_tipo_segurado, '|| pls_util_pck.enter_w ||
			'	a.nr_seq_pagador, ' || pls_util_pck.enter_w ||
			'	a.nr_seq_plano, ' || pls_util_pck.enter_w ||
			'	null ie_tipo_valor, ' || pls_util_pck.enter_w ||
			ds_valor_dimensao_w || pls_util_pck.enter_w ||
			ds_campo_estipulante_w || pls_util_pck.enter_w ||
			'	' || ds_dimensao_p || ',' || pls_util_pck.enter_w ||
			'	' || ds_dimensao_sup_p || pls_util_pck.enter_w ||
			'from	pls_ar_lote		lote, ' || pls_util_pck.enter_w ||
			'	pls_ar_despesa_contabil	a, ' || pls_util_pck.enter_w ||
			'	pls_segurado 		s ' || pls_util_pck.enter_w ||
			'where	a.nr_seq_lote = lote.nr_sequencia ' || pls_util_pck.enter_w ||
			'and	s.nr_sequencia	= a.nr_seq_segurado ' || pls_util_pck.enter_w ||
			'and	a.ie_tipo_despesa = ''1'' ' || pls_util_pck.enter_w ||
			valor_bind_w := pls_ar_montar_resultado_pck.obter_sql_restricao(dados_filtro_p, 'A', 'PLS_AR_DESPESA_CONTABIL', valor_bind_w) || pls_util_pck.enter_w ||
			'group by a.nr_seq_contrato, a.nr_seq_intercambio, a.nr_seq_segurado, a.ie_tipo_segurado, a.nr_seq_pagador, a.nr_seq_plano, ' || ds_valor_dimensao_w || ds_dimensao_sup_p || pls_util_pck.enter_w ||
			'union all ' || pls_util_pck.enter_w ||
			'select	nvl(sum(a.vl_despesa),0) vl_total, ' || pls_util_pck.enter_w ||
			'	''EN'' ie_valor, ' || pls_util_pck.enter_w ||
			'	nvl(a.nr_seq_contrato, a.nr_seq_intercambio) nr_seq_contrato, ' || pls_util_pck.enter_w ||
			'	a.nr_seq_segurado, ' || pls_util_pck.enter_w ||
			'	a.ie_tipo_segurado, '|| pls_util_pck.enter_w ||
			'	a.nr_seq_pagador, ' || pls_util_pck.enter_w ||
			'	a.nr_seq_plano, ' || pls_util_pck.enter_w ||
			'	null ie_tipo_valor, ' || pls_util_pck.enter_w ||
			ds_valor_dimensao_w || pls_util_pck.enter_w ||
			ds_campo_estipulante_w || pls_util_pck.enter_w ||
			'	' || ds_dimensao_p || ',' || pls_util_pck.enter_w ||
			'	' || ds_dimensao_sup_p || pls_util_pck.enter_w ||
			'from	pls_ar_lote		lote, ' || pls_util_pck.enter_w ||
			'	pls_ar_despesa_contabil	a, ' || pls_util_pck.enter_w ||
			'	pls_segurado 		s ' || pls_util_pck.enter_w ||
			'where	a.nr_seq_lote = lote.nr_sequencia ' || pls_util_pck.enter_w ||
			'and	s.nr_sequencia	= a.nr_seq_segurado ' || pls_util_pck.enter_w ||
			'and	a.ie_tipo_despesa = ''2'' ' || pls_util_pck.enter_w ||
			valor_bind_w := pls_ar_montar_resultado_pck.obter_sql_restricao(dados_filtro_p, 'A', 'PLS_AR_DESPESA_CONTABIL', valor_bind_w) || pls_util_pck.enter_w ||
			'group by a.nr_seq_contrato, a.nr_seq_intercambio, a.nr_seq_segurado, a.ie_tipo_segurado, a.nr_seq_pagador, a.nr_seq_plano, ' || ds_valor_dimensao_w || ds_dimensao_sup_p || pls_util_pck.enter_w ||
			'union all ' || pls_util_pck.enter_w ||
			'select	nvl(sum(a.vl_despesa),0) vl_total, ' || pls_util_pck.enter_w ||
			'	''PV'' ie_valor, ' || pls_util_pck.enter_w ||
			'	nvl(a.nr_seq_contrato, a.nr_seq_intercambio) nr_seq_contrato, ' || pls_util_pck.enter_w ||
			'	a.nr_seq_segurado, ' || pls_util_pck.enter_w ||
			'	a.ie_tipo_segurado, '|| pls_util_pck.enter_w ||
			'	a.nr_seq_pagador, ' || pls_util_pck.enter_w ||
			'	a.nr_seq_plano, ' || pls_util_pck.enter_w ||
			'	null ie_tipo_valor, ' || pls_util_pck.enter_w ||
			ds_valor_dimensao_w || pls_util_pck.enter_w ||
			ds_campo_estipulante_w || pls_util_pck.enter_w ||
			'	' || ds_dimensao_p || ',' || pls_util_pck.enter_w ||
			'	' || ds_dimensao_sup_p || pls_util_pck.enter_w ||
			'from	pls_ar_lote		lote, ' || pls_util_pck.enter_w ||
			'	pls_ar_despesa_contabil	a, ' || pls_util_pck.enter_w ||
			'	pls_segurado 		s ' || pls_util_pck.enter_w ||
			'where	a.nr_seq_lote = lote.nr_sequencia ' || pls_util_pck.enter_w ||
			'and	s.nr_sequencia	= a.nr_seq_segurado ' || pls_util_pck.enter_w ||
			'and	a.ie_tipo_despesa = ''3'' ' || pls_util_pck.enter_w ||
			valor_bind_w := pls_ar_montar_resultado_pck.obter_sql_restricao(dados_filtro_p, 'A', 'PLS_AR_DESPESA_CONTABIL', valor_bind_w) || pls_util_pck.enter_w ||
			'group by a.nr_seq_contrato, a.nr_seq_intercambio, a.nr_seq_segurado, a.ie_tipo_segurado, a.nr_seq_pagador, a.nr_seq_plano, ' || ds_valor_dimensao_w || ds_dimensao_sup_p;

open retorno_valores_analise_w for EXECUTE sql_base_w;
loop
	tb_vl_total_w.delete;
	tb_ie_valor_w.delete;
	tb_nr_seq_contrato_w.delete;
	tb_nr_seq_segurado_w.delete;
	tb_ie_tipo_segurado_w.delete;
	tb_nr_seq_pagador_w.delete;
	tb_nr_seq_plano_w.delete;
	tb_ds_valor_dimensao_w.delete;
	tb_ds_estipulante_w.delete;
	tb_ie_tipo_valor_w.delete;
	tb_ds_dimensao_w.delete;
	tb_ds_dimensao_sup_w.delete;
	fetch retorno_valores_analise_w bulk collect into
		tb_vl_total_w, tb_ie_valor_w, tb_nr_seq_contrato_w, tb_nr_seq_segurado_w, tb_ie_tipo_segurado_w,
		tb_nr_seq_pagador_w, tb_nr_seq_plano_w, tb_ie_tipo_valor_w, tb_ds_valor_dimensao_w, tb_ds_estipulante_w,
		tb_ds_dimensao_w, tb_ds_dimensao_sup_w
		limit pls_util_cta_pck.qt_registro_transacao_w;
	exit when tb_vl_total_w.count = 0;
		forall i in tb_vl_total_w.first..tb_vl_total_w.last
			insert into w_pls_ar_dimensao(ie_dimensao,
				ds_dimensao,
				ds_dimensao_superior,
				nr_seq_contrato,
				nr_seq_segurado,
				nr_seq_pagador,
				nr_seq_plano,
				ds_valor_dimensao,
				ds_estipulante,
				vl_mensalidade,
				vl_contas,
				vl_contas_receita,
				vl_reembolso,
				vl_coparticipacao,
				vl_comissao,
				vl_ressarcimento_sus,
				vl_recurso_glosa,
				vl_faturamento,
				vl_taxa_intercambio,
				vl_despesa_nao_assist,
				vl_encargos,
				vl_provisoes,
				vl_resultado,
				pr_resultado,
				pr_sinistralidade,
				nm_usuario,
				dt_atualizacao)
			values (ie_dimensao_p,
				tb_ds_dimensao_w(i),
				tb_ds_dimensao_sup_w(i),
				tb_nr_seq_contrato_w(i),
				tb_nr_seq_segurado_w(i),
				tb_nr_seq_pagador_w(i),
				tb_nr_seq_plano_w(i),
				tb_ds_valor_dimensao_w(i),
				CASE WHEN ds_tipo_dimensao_p='C' THEN					CASE WHEN tb_ie_tipo_segurado_w(i)='I' THEN  						CASE WHEN 	coalesce(tb_nr_seq_contrato_w(i)::text, '') = '' THEN  							CASE WHEN 	coalesce(tb_nr_seq_segurado_w(i)::text, '') = '' THEN  wheb_mensagem_pck.get_texto(1186532)  ELSE wheb_mensagem_pck.get_texto(1186531) END   ELSE tb_ds_estipulante_w(i) END   ELSE tb_ds_estipulante_w(i) END   ELSE null END ,		
				CASE WHEN tb_ie_valor_w(i)='M' THEN  tb_vl_total_w(i)  ELSE 0 END ,
				CASE WHEN tb_ie_valor_w(i)='CM' THEN  CASE WHEN tb_ie_tipo_valor_w(i)='C' THEN  tb_vl_total_w(i)  ELSE 0 END   ELSE 0 END ,
				CASE WHEN tb_ie_valor_w(i)='CM' THEN  CASE WHEN tb_ie_tipo_valor_w(i)='RR' THEN  tb_vl_total_w(i)  ELSE 0 END   ELSE 0 END ,
				CASE WHEN tb_ie_valor_w(i)='RB' THEN  tb_vl_total_w(i)  ELSE 0 END ,
				CASE WHEN tb_ie_valor_w(i)='C' THEN  tb_vl_total_w(i)  ELSE 0 END ,
				CASE WHEN tb_ie_valor_w(i)='CO' THEN  tb_vl_total_w(i)  ELSE 0 END ,
				CASE WHEN tb_ie_valor_w(i)='RS' THEN  tb_vl_total_w(i)  ELSE 0 END ,
				CASE WHEN tb_ie_valor_w(i)='RG' THEN  tb_vl_total_w(i)  ELSE 0 END ,
				CASE WHEN tb_ie_valor_w(i)='F' THEN  tb_vl_total_w(i)  ELSE 0 END ,
				CASE WHEN tb_ie_valor_w(i)='TI' THEN  tb_vl_total_w(i)  ELSE 0 END ,
				CASE WHEN tb_ie_valor_w(i)='DN' THEN  tb_vl_total_w(i)  ELSE 0 END ,
				CASE WHEN tb_ie_valor_w(i)='EN' THEN  tb_vl_total_w(i)  ELSE 0 END ,
				CASE WHEN tb_ie_valor_w(i)='PV' THEN  tb_vl_total_w(i)  ELSE 0 END ,
				tb_vl_total_w(i),
				0,
				0,
				nm_usuario_p,
				clock_timestamp());
		commit;
end loop;
close retorno_valores_analise_w;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_ar_montar_resultado_pck.insere_dimensao_analise ( ie_dimensao_p text, ds_tipo_dimensao_p text, ds_dimensao_p text, ds_dimensao_sup_p text, dados_restricao_p text, dados_filtro_p tb_filtros_analise_resultado, valor_bind_p sql_pck.t_dado_bind, nm_usuario_p text) FROM PUBLIC;
