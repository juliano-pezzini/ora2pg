-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

--------------- INSERE OS MEDICAMENTOS DE CADA BENIFICIÁRIO.
CREATE OR REPLACE PROCEDURE pls_repasse_sca_pck.inserir_sca_benef_med () AS $body$
DECLARE


C01 CURSOR FOR
	SELECT	e.nr_sequencia nr_seq_sca_vinculo_med,
		c.nr_sequencia nr_seq_repasse_sca_benef
	from	pls_repasse_sca_fornecedor a,
		pls_repasse_sca_plano b,
		pls_repasse_sca_benef c,
		pls_repasse_sca_temp d,
		pls_sca_vinculo_med e
	where	a.nr_seq_lote		= pls_repasse_sca_lote_w.nr_sequencia
	and	a.nr_sequencia		= b.nr_seq_repasse_fornecedor
	and	b.nr_sequencia		= c.nr_seq_repasse_plano
	and	d.nr_seq_segurado	= c.nr_seq_segurado
	and	d.nr_seq_sca		= b.nr_seq_sca
	and	d.nr_seq_vinculo_sca	= e.nr_seq_sca_vinculo
	and	d.nr_seq_prestador	= a.nr_seq_prestador
	group by
		e.nr_sequencia,
		c.nr_sequencia;

tb_seq_sca_vinculo_med_w	pls_util_cta_pck.t_number_table;
tb_seq_repasse_sca_benef_w	pls_util_cta_pck.t_number_table;


BEGIN

open C01;
fetch C01 bulk collect into	tb_seq_sca_vinculo_med_w,
				tb_seq_repasse_sca_benef_w
limit pls_util_pck.qt_registro_transacao_w;
if (tb_seq_sca_vinculo_med_w.count > 0) then
	forall i in tb_seq_sca_vinculo_med_w.first .. tb_seq_sca_vinculo_med_w.last
		insert into	pls_repasse_sca_benef_med(	nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				nr_seq_vinculo_med,
				nr_seq_repasse_benef)
			values (nextval('pls_repasse_sca_benef_med_seq'),
				clock_timestamp(),
				current_setting('pls_repasse_sca_pck.nm_usuario_w')::usuario.nm_usuario%type,
				clock_timestamp(),
				current_setting('pls_repasse_sca_pck.nm_usuario_w')::usuario.nm_usuario%type,
				tb_seq_sca_vinculo_med_w(i),
				tb_seq_repasse_sca_benef_w(i));
	commit;
end if;

close C01;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_repasse_sca_pck.inserir_sca_benef_med () FROM PUBLIC;
