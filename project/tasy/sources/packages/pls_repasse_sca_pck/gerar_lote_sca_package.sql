-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


----------------INICIO DO PROCESSO----------------------
CREATE OR REPLACE PROCEDURE pls_repasse_sca_pck.gerar_lote_sca ( nr_seq_lote_p pls_repasse_sca_lote.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE

qt_registros_w	integer;

BEGIN
CALL exec_sql_dinamico(nm_usuario_p, 'truncate table pls_repasse_sca_temp');

select	*
into STRICT	current_setting('pls_repasse_sca_pck.pls_repasse_sca_lote_w')::pls_repasse_sca_lote%rowtype
from	pls_repasse_sca_lote
where	nr_sequencia = nr_seq_lote_p;

select	*
into STRICT	current_setting('pls_repasse_sca_pck.pls_regra_repasse_sca_w')::pls_regra_repasse_sca%rowtype
from	pls_regra_repasse_sca
where	nr_sequencia	= current_setting('pls_repasse_sca_pck.pls_repasse_sca_lote_w')::pls_repasse_sca_lote%rowtype.nr_seq_regra;

PERFORM set_config('pls_repasse_sca_pck.nm_usuario_w', nm_usuario_p, false);

CALL CALL pls_repasse_sca_pck.gerar_dados_temp();

select	count(*)
into STRICT	qt_registros_w
from	pls_repasse_sca_temp;

if (qt_registros_w > 0) then
	inserir_sca_fornecedor;
	inserir_sca_planos;
	inserir_sca_benef;
	
	if (current_setting('pls_repasse_sca_pck.pls_regra_repasse_sca_w')::pls_regra_repasse_sca%rowtype.ie_tipo_movimentacao = 2) then
		CALL pls_repasse_sca_pck.inserir_sca_benef_med();
	end if;
	
	update	pls_repasse_sca_lote
	set	dt_geracao_lote = clock_timestamp(),
		dt_atualizacao	= clock_timestamp(),
		nm_usuario	= nm_usuario_p
	where	nr_sequencia = nr_seq_lote_p;
else
	CALL wheb_mensagem_pck.exibir_mensagem_abort(1059843); -- 'Não existem informações para gerar o lote.';
end if;

commit;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_repasse_sca_pck.gerar_lote_sca ( nr_seq_lote_p pls_repasse_sca_lote.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;
