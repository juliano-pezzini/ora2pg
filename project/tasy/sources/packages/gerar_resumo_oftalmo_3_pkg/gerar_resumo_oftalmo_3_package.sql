-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE gerar_resumo_oftalmo_3_pkg.gerar_resumo_oftalmo_3 ( cd_pessoa_fisica_p text, nm_usuario_p text, ds_fundoscopia_p text) AS $body$
DECLARE

 
  nm_medico_w        varchar(60);
  cd_medico_w        varchar(10);
  ie_dinamica_w      varchar(1);
  ie_estatica_w      varchar(1);
  ie_receita_w      varchar(1);
  ie_adicao_w        varchar(1);
  vl_de_rd_od_w      varchar(10);
  vl_dc_rd_od_w      varchar(10);
  vl_eixo_rd_od_w      varchar(10);
  ds_visao_rd_od_w    varchar(40);
  vl_de_rd_oe_w      varchar(10);
  vl_dc_rd_oe_w      varchar(10);
  vl_eixo_rd_oe_w      varchar(10);
  ds_visao_rd_oe_w    varchar(40);
  vl_de_re_od_w      varchar(10);
  vl_dc_re_od_w      varchar(10);
  vl_eixo_re_od_w      varchar(10);
  ds_visao_re_od_w    varchar(40);
  vl_de_re_oe_w      varchar(10);
  vl_dc_re_oe_w      varchar(10);
  vl_eixo_re_oe_w      varchar(10);
  ds_visao_re_oe_w    varchar(40);
  vl_de_receita_od_w    varchar(10);
  vl_dc_receita_od_w    varchar(10);
  vl_eixo_receita_od_w  varchar(10);
  ds_visao_receita_od_w  varchar(40);
  vl_de_receita_oe_w    varchar(10);
  vl_dc_receita_oe_w    varchar(10);
  vl_eixo_receita_oe_w  varchar(10);
  ds_visao_receita_oe_w  varchar(40);
  vl_adicao_od_w      varchar(10);
  vl_adicao_oe_w      varchar(10);
  vl_soma_de_rd_od_w    varchar(10);
  vl_soma_de_rd_oe_w    varchar(10);
  dt_consulta_w      varchar(30);
  ds_queixa_paciente_w  varchar(4000);
  ds_fundoscopia_w    varchar(4000);
  ds_biomicroscopia_w    varchar(4000);
  ds_outros_exames_w    varchar(4000);
  ds_hip_diag_w      varchar(4000);
  ds_conduta_w      varchar(4000);
  ds_diagnostico_w    varchar(300);
  nr_seq_laudo_w      bigint;
  ds_consulta_w      varchar(32000);
  ds_diagnostico_long_w  varchar(32000);
  vl_pressao_od_w      varchar(40);
  vl_pressao_oe_w      varchar(40);
  hr_pressao_w      varchar(10);
  ds_procedimento_w    procedimento.ds_procedimento%TYPE;
  ds_cirurgia_long_w    text;
  ds_exames_long_w    text;
  ie_tipo_fundoscopia_w  varchar(1);
  ds_av_sc_od_w      varchar(40);
  ds_av_cc_od_w      varchar(40);
  ds_av_sc_oe_w      varchar(40);
  ds_av_cc_oe_w      varchar(40);
  ds_meo_w        varchar(60);
  vl_visao_rd_od_w    varchar(3);
  vl_visao_rd_oe_w    varchar(3);
  vl_visao_re_od_w    varchar(3);
  vl_visao_re_oe_w    varchar(3);
  vl_visao_receita_od_w  varchar(3);
  vl_visao_receita_oe_w  varchar(3);
  ds_olho_diag_w      varchar(10);
  ds_olho_cirurgia_w    varchar(10);
  ds_doenca_w        varchar(5);
  ds_observacao_olho_w  varchar(255);
  ds_elemento_w      varchar(240);
  ds_complemento_w    varchar(4000);
  ds_alergia_w      varchar(32000);
  ds_exame_w        varchar(255);
  ds_classif_atend_w    varchar(4000);
  dt_nascimento_w      timestamp;
  ds_idade_w        varchar(60);
  ds_convenio_w      varchar(255);
  nm_medico_atend_w    varchar(60);
  ds_titulo_laudo_w    varchar(255);
  ie_tem_laudo_w      varchar(1);
  ds_obs_receita_w    varchar(255);
  nr_seq_cons_med_w    bigint;
  ds_impressao1_w      varchar(10);
  ds_impressao2_w      varchar(10);
  nm_usuario2_w      varchar(15);
  ds_tipo_w        varchar(30);
  ds_enter_w        varchar(10)  := chr(13) || chr(10);
  ds_quebra_w        varchar(255)  := chr(13) || chr(10);
  dt_procedimento_w    timestamp;
  ds_proced_agenda_w    varchar(240);
  dt_agenda_w        timestamp;
  nm_lente_w        varchar(255);
  qt_curva_base_w      double precision;
  qt_curva_base_um_w    double precision;
  qt_curva_base_dois_w  double precision;
  qt_grau_w        double precision;
  qt_grau_esferico_w    double precision;
  qt_grau_cilindrico_w  double precision;
  qt_grau_longe_w      double precision;
  qt_diametro_w      double precision;
  qt_eixo_w        double precision;
  qt_adicao_w        double precision;
  qt_dk_w          double precision;
  qt_h2o_w        double precision;
  ds_marca_w        varchar(255);
  ds_cor_w        varchar(255);
  ds_material_w      varchar(255);
  ds_modelo_w        varchar(255);
  ds_tipo_lente_w      varchar(255);
  ie_lado_w        varchar(15);
  ds_lentes_w        varchar(5000);
  ds_lente_linha_w    varchar(100);
  cd_medico_executor_w  varchar(10);
  ds_observacao_w      varchar(255);
  nr_seq_lente_w      varchar(255);
  insere_cabecalho_w    boolean;
  dt_registro_ant_w    varchar(30);
  pos_w          bigint := 0;
  nm_medico_resp_w    varchar(255);
  dt_liberacao_lado_w    varchar(1);
  nr_seq_aval_w      bigint;
  nr_atendimento_hosp_w	bigint;
  dt_receita_w		timestamp;
  ds_receita_w		text;
  ds_resumo_aval_aux_w  varchar(5000);
  ds_resumo_aval_w    varchar(32000);
  nr_receita_w 	double precision;
  nr_atend_cirurgia_w	bigint;
  nr_seq_cirurgia_w	bigint;
  nm_medico_cirurgiao_w	varchar(255);
  nm_medico_anestesista_w	varchar(255);
  ds_proc_principal_w		varchar(255);
  dt_desc_cirurgica_w		timestamp;
  nm_resp_desc_cirurgica_w	varchar(255);
  cd_doenca_cid_cirurgia_w	varchar(10);
  nr_seq_desc_cirurgica_w	bigint;
  ds_desc_cirurgica_w		text;
	ds_desc_cir_w		text;
	ds_desc_cir_geral_w text;
  nr_cirurgia_w		bigint;
  nr_seq_receita_w		double precision;
 	ds_exame_long_w			text;
	cd_procedimento_w		bigint;

  C01 CURSOR FOR 
  SELECT  ds_tipo, 
    nr_atendimento, 
    dt_entrada, 
    ds_classificacao, 
    ds_idade, 
    ds_convenio, 
    ds_medico_resp, 
    nm_usuario 
  from ( 
    SELECT  wheb_mensagem_pck.get_texto(307144) ds_tipo, -- Atendimento 
      nr_atendimento nr_atendimento, 
      dt_entrada dt_entrada, 
      substr(obter_descricao_padrao('CLASSIFICACAO_ATENDIMENTO','DS_CLASSIFICACAO',NR_SEQ_CLASSIFICACAO),1,254) ds_classificacao, 
      substr(obter_idade(dt_nascimento_w,dt_entrada,'S'),1,60) ds_idade, 
      substr(obter_nome_convenio(obter_convenio_atendimento(nr_atendimento)),1,100) ds_convenio, 
      substr(obter_nome_pf(cd_medico_resp),1,60) ds_medico_resp, 
      nm_usuario 
    from  atendimento_paciente 
    where  cd_pessoa_fisica  = cd_pessoa_fisica_p 
    
union all
 
    select  wheb_mensagem_pck.get_texto(307145) ds_tipo, -- Complemento 
      null nr_atendimento, 
      a.dt_complemento dt_entrada, 
      a.ds_complemento ds_classificacao, 
      '' ds_idade, 
      '' ds_convenio, 
      '' ds_medico_resp, 
      a.nm_usuario_nrec nm_usuario 
    from  oft_consulta_complemento a, 
        oft_consulta_medica b 
    where  a.cd_pessoa_fisica  = cd_pessoa_fisica_p 
    and    b.nr_sequencia = a.nr_seq_cons_med 
    and    b.ie_situacao <> 'I' 
    ) alias11         
  order by 
    dt_entrada desc;

  C02 CURSOR FOR 
  SELECT  to_char(dt_consulta,'dd/mm/yyyy hh24:mi:ss'), 
    substr(obter_nome_pf(cd_profissional),1,60), 
    nr_atendimento, 
    ie_dinamica, 
    ie_estatica, 
    ie_receita, 
    ie_adicao, 
    vl_de_rd_od, 
    campo_mascara_virgula(abs(vl_dc_rd_od)), 
    to_char(abs(vl_eixo_rd_od)), 
    ds_visao_rd_od, 
    vl_de_rd_oe, 
    campo_mascara_virgula(abs(vl_dc_rd_oe)), 
    to_char(abs(vl_eixo_rd_oe)), 
    ds_visao_rd_oe, 
    vl_de_re_od, 
    campo_mascara_virgula(abs(vl_dc_re_od)), 
    to_char(abs(vl_eixo_re_od)), 
    ds_visao_re_od, 
    vl_de_re_oe, 
    campo_mascara_virgula(abs(vl_dc_re_oe)), 
    to_char(abs(vl_eixo_re_oe)), 
    ds_visao_re_oe, 
    vl_de_receita_od, 
    campo_mascara_virgula(abs(vl_dc_receita_od)), 
    to_char(abs(vl_eixo_receita_od)), 
    ds_visao_receita_od, 
    vl_de_receita_oe, 
    campo_mascara_virgula(abs(vl_dc_receita_oe)), 
    to_char(abs(vl_eixo_receita_oe)), 
    ds_visao_receita_oe, 
    campo_mascara_virgula(abs(vl_adicao_od)), 
    campo_mascara_virgula(abs(vl_adicao_oe)), 
    ds_queixa_paciente, 
    ds_fundoscopia,     
    ds_biomicroscopia, 
    ds_outros_exames, 
    ds_conduta, 
    vl_pressao_od, 
    vl_pressao_oe, 
    to_char(hr_pressao,'hh24:mi'), 
    ie_tipo_fundoscopia, 
    ds_av_sc_od, 
    ds_av_cc_od, 
    ds_av_sc_oe, 
    ds_av_cc_oe, 
    ds_meo, 
    to_char(vl_visao_rd_od), 
    to_char(vl_visao_rd_oe), 
    to_char(vl_visao_re_od), 
    to_char(vl_visao_re_oe), 
    to_char(vl_visao_receita_od), 
    to_char(vl_visao_receita_oe), 
    ds_obs_receita, 
    nr_sequencia, 
    ds_hip_diag 
  from  oft_consulta_medica 
  where  nr_atendimento  = current_setting('gerar_resumo_oftalmo_3_pkg.nr_atendimento_w')::bigint 
  and    ie_situacao    <> 'I';

  C03 CURSOR FOR 
  SELECT  cd_doenca, 
    substr(obter_desc_cid(cd_doenca),1,240), 
    ie_lado 
  from  diagnostico_doenca 
  where  nr_atendimento  = current_setting('gerar_resumo_oftalmo_3_pkg.nr_atendimento_w')::bigint;

  C04 CURSOR FOR 
  SELECT  nr_sequencia, 
    ds_titulo_laudo, 
    substr(obter_nome_pf(cd_medico_resp),1,255) 
  from  laudo_paciente 
  where  nr_atendimento  = current_setting('gerar_resumo_oftalmo_3_pkg.nr_atendimento_w')::bigint 
  and  ((dt_liberacao_lado_w = 'N' and (dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')) or (dt_liberacao_lado_w = 'S'));

  C05 CURSOR FOR 
  SELECT  a.ds_procedimento, 
    b.ie_lado, 
    a.dt_procedimento, 
    a.ds_observacao 
  from   procedimento_paciente_v a, 
    cirurgia b 
  where  a.nr_cirurgia    = b.nr_cirurgia 
  and  b.nr_atendimento  = current_setting('gerar_resumo_oftalmo_3_pkg.nr_atendimento_w')::bigint 
  and   b.ie_status_cirurgia  = '2' 
  and  coalesce(a.cd_motivo_exc_conta::text, '') = '' 
  and  coalesce(a.nr_seq_proc_pacote,0)  <> a.nr_sequencia;

  C06 CURSOR FOR 
  SELECT  ds_elemento, 
    ds_complemento 
  from  historico_saude_v 
  where  cd_pessoa_fisica  = cd_pessoa_fisica_p 
  and  ie_historico    = 30;

  C07 CURSOR FOR 
  SELECT	distinct a.cd_procedimento, 
			substr(obter_descricao_procedimento(a.cd_procedimento,a.ie_origem_proced),1,255) 
  from  procedimento_paciente a 
  where  a.nr_atendimento  = current_setting('gerar_resumo_oftalmo_3_pkg.nr_atendimento_w')::bigint 
  and  coalesce(a.cd_motivo_exc_conta::text, '') = '' 
  and  coalesce(a.nr_laudo::text, '') = '';

  C08 CURSOR FOR 
    SELECT  hr_inicio, 
      substr(obter_desc_prescr_proc(a.cd_procedimento, a.ie_origem_proced, a.nr_seq_proc_interno),1,240) ||CASE WHEN coalesce(a.ie_lado::text, '') = '' THEN ''  ELSE ' - Olho '||substr(obter_valor_dominio(1372,ie_lado),1,80) END  
    from  agenda_paciente a, 
      agenda b 
    where  a.cd_agenda    = b.cd_agenda 
    and  b.cd_tipo_agenda  = 2 
    and  a.nr_atendimento  = current_setting('gerar_resumo_oftalmo_3_pkg.nr_atendimento_w')::bigint 
    order by 1;

  C09 CURSOR FOR 
    SELECT  b.nm_lente, 
        b.qt_curva_base, 
        b.qt_curva_base_um, 
        b.qt_curva_base_dois, 
        b.qt_grau, 
        b.qt_grau_esferico, 
        b.qt_grau_cilindrico, 
        b.qt_grau_longe, 
        b.qt_diametro, 
        b.qt_eixo, 
        b.qt_adicao, 
        b.qt_dk, 
        b.qt_h2o, 
        substr(c.ds_marca,1,255), 
        substr(d.ds_cor,1,255), 
        substr(e.ds_material,1,255), 
        substr(f.ds_modelo, 1,255), 
        substr(g.ds_tipo_lente,1,255), 
        a.ie_lado, 
        to_char(a.dt_registro,'dd/mm/yyyy'), 
        a.ds_observacao, 
        substr(obter_desc_lente_contato(a.nr_seq_lente),1,255) 
    FROM oft_consulta_medica h, oft_consulta_lente a, oft_lente_contato b
LEFT OUTER JOIN oft_marca_lente_contato c ON (b.nr_seq_marca = c.nr_sequencia)
LEFT OUTER JOIN oft_cor_lente_contato d ON (b.nr_seq_cor_lente = d.nr_sequencia)
LEFT OUTER JOIN oft_material_lente_contato e ON (b.nr_seq_material = e.nr_sequencia)
LEFT OUTER JOIN oft_modelo_lente_contato f ON (b.nr_seq_modelo = f.nr_sequencia)
LEFT OUTER JOIN oft_tipo_lente_contato g ON (b.nr_seq_tipo = g.nr_sequencia)
WHERE a.nr_seq_lente = b.nr_sequencia and a.nr_seq_cons_med = h.nr_sequencia and h.nr_atendimento = current_setting('gerar_resumo_oftalmo_3_pkg.nr_atendimento_w')::bigint      order by a.dt_registro desc;

  C10 CURSOR FOR 
    SELECT  cd_medico_cirurgiao 
    from  cirurgia 
    where  nr_atendimento  = current_setting('gerar_resumo_oftalmo_3_pkg.nr_atendimento_w')::bigint;

  C11 CURSOR FOR 
    SELECT  a.nr_sequencia 
    from  med_avaliacao_paciente a, 
        med_tipo_avaliacao b 
    where  b.nr_sequencia = a.nr_seq_tipo_avaliacao 
    and    a.nr_atendimento = current_setting('gerar_resumo_oftalmo_3_pkg.nr_atendimento_w')::bigint     
    and    b.ie_resumo_oftalmo = 'S' 
		and			a.ie_situacao = 'A';
	
  C12 CURSOR FOR 
	SELECT		a.nr_atendimento_hosp, 
			a.dt_receita, 
			a.nr_sequencia 
	from		med_receita a 
	where		a.cd_pessoa_fisica = cd_pessoa_fisica_p 
	order by	a.dt_receita desc;
	
  C13 CURSOR FOR 
	SELECT		distinct a.nr_atendimento 
	from		cirurgia a 
	where		a.cd_pessoa_fisica = cd_pessoa_fisica_p 
	order by	a.nr_atendimento desc;
	
  C14 CURSOR FOR 
	SELECT		substr(obter_nome_medico(a.cd_medico_cirurgiao,'N'),1,200) nm_medico_cirurgiao, 
			substr(obter_nome_medico(a.cd_medico_anestesista,'N'),1,200) nm_medico_anestesista, 
			substr(obter_exame_agenda(a.cd_procedimento_princ,a.ie_origem_proced,a.nr_seq_proc_interno),1,240) ds_proc_principal, 
			a.nr_cirurgia 
	from		cirurgia a 
	where		a.nr_atendimento = current_setting('gerar_resumo_oftalmo_3_pkg.nr_atendimento_w')::bigint 
	order by	a.dt_inicio_real desc;
	
  C15 CURSOR FOR 
	SELECT		a.dt_registro, 
			substr(obter_nome_pf(a.cd_responsavel),1,255) nm_resp_desc_cirurgica, 
			a.cd_doenca_cid, 
			a.nr_sequencia 
	from		cirurgia_descricao a 
	where		a.nr_cirurgia = nr_seq_cirurgia_w 
	order by	a.dt_registro;

  
BEGIN 
  PERFORM set_config('gerar_resumo_oftalmo_3_pkg.cd_pessoa_fisica_w', cd_pessoa_fisica_p, false);
  PERFORM set_config('gerar_resumo_oftalmo_3_pkg.nm_usuario_w', nm_usuario_p, false);
  obter_param_usuario(281, 68, Obter_perfil_Ativo, nm_usuario_p, 0, dt_liberacao_lado_w);
 
  select  coalesce(max(dt_nascimento),clock_timestamp()) 
  into STRICT  dt_nascimento_w 
  from  pessoa_fisica 
  where  cd_pessoa_fisica  = current_setting('gerar_resumo_oftalmo_3_pkg.cd_pessoa_fisica_w')::varchar(10);
 
  delete  from w_oft_resumo_consulta 
  where  nm_usuario    = nm_usuario_p;
 
  commit;
 
  open C06;
  loop 
    fetch C06 into 
      ds_elemento_w, 
      ds_complemento_w;
    EXIT WHEN NOT FOUND; /* apply on C06 */
    begin 
    ds_alergia_w  := ds_alergia_w ||LPAD(' ',5,' ')||ds_elemento_w ||ds_quebra_w ||ds_complemento_w ||ds_quebra_w;
    end;
  end loop;
  close C06;
 
  /*if  (ds_alergia_w is not null) then 
    gerar_resumo_oftalmo_3_pkg.addresumo('ALERGIAS' ||ds_quebra_w); 
    gerar_resumo_oftalmo_3_pkg.addresumo(ds_alergia_w ||ds_quebra_w); 
    ds_alergia_w := null; 
  end if;*/
 
 
  open C01;
  loop 
    fetch C01 into   
      ds_tipo_w, 
      current_setting('gerar_resumo_oftalmo_3_pkg.nr_atendimento_w')::bigint, 
      current_setting('gerar_resumo_oftalmo_3_pkg.dt_entrada_w')::timestamp, 
      ds_classif_atend_w, 
      ds_idade_w, 
      ds_convenio_w, 
      nm_medico_atend_w, 
      nm_usuario2_w;
    EXIT WHEN NOT FOUND; /* apply on C01 */
    begin 
    insere_cabecalho_w  := True;
    dt_registro_ant_w  := '01/01/1900';
    open C09;
    loop 
      fetch C09 into 
        nm_lente_w, 
        qt_curva_base_w, 
        qt_curva_base_um_w, 
        qt_curva_base_dois_w, 
        qt_grau_w, 
        qt_grau_esferico_w, 
        qt_grau_cilindrico_w, 
        qt_grau_longe_w, 
        qt_diametro_w, 
        qt_eixo_w, 
        qt_adicao_w, 
        qt_dk_w, 
        qt_h2o_w, 
        ds_marca_w, 
        ds_cor_w, 
        ds_material_w, 
        ds_modelo_w, 
        ds_tipo_lente_w, 
        ie_lado_w, 
        dt_consulta_w, 
        ds_observacao_w, 
        nr_seq_lente_w;
      EXIT WHEN NOT FOUND; /* apply on C09 */
      begin 
         
      if (insere_cabecalho_w) then 
        ds_consulta_w    := ds_consulta_w ||'*************************************************************'||ds_quebra_w;
        ds_consulta_w    := ds_consulta_w ||LPAD(upper(wheb_mensagem_pck.get_texto(307499)),20,' ')||ds_quebra_w;
        insere_cabecalho_w  := False;
      end if;
       
      if (dt_registro_ant_w <> dt_consulta_w) then 
        ds_consulta_w    := ds_consulta_w ||LPAD(upper(wheb_mensagem_pck.get_texto(307501)) || ': ',20,' ')||dt_consulta_w||ds_quebra_w;
        dt_registro_ant_w  := dt_consulta_w;
      end if;
       
      if (ds_observacao_w IS NOT NULL AND ds_observacao_w::text <> '') then 
        ds_consulta_w  := ds_consulta_w ||LPAD(upper(wheb_mensagem_pck.get_texto(307502)) || ': ',20,' ')||ds_observacao_w||ds_quebra_w;
      end if;
       
      ds_lentes_w  :=  'LC';
      if (ie_lado_w IS NOT NULL AND ie_lado_w::text <> '') then 
        if (ie_lado_w = 'A') then 
          ds_lentes_w  :=  ds_lentes_w ||' '|| ie_lado_w;
        else 
          ds_lentes_w  :=  ds_lentes_w || ' ' || wheb_mensagem_pck.get_texto(308972) || ie_lado_w;
        end if;
      end if;
      ds_lentes_w  := ds_lentes_w || ': '||nr_seq_lente_w;
       
      if (nm_lente_w IS NOT NULL AND nm_lente_w::text <> '') then 
        if (length(ds_lentes_w || nm_lente_w) > 67) then 
          ds_consulta_w  :=  ds_consulta_w || trim(both ds_lentes_w) || ds_quebra_w;
          ds_lentes_w    :=  null;
        end if;
        ds_lentes_w  :=  ds_lentes_w || nm_lente_w;
      end if;
      if (qt_curva_base_w IS NOT NULL AND qt_curva_base_w::text <> '') then 
        if (length(ds_lentes_w || ' ' || wheb_mensagem_pck.get_texto(308823) || '=' || qt_curva_base_w) > 67) then 
          ds_consulta_w  :=  ds_consulta_w || trim(both ds_lentes_w) || ds_quebra_w;
          ds_lentes_w    :=  null;
        end if;
        ds_lentes_w  :=  ds_lentes_w || ' ' || wheb_mensagem_pck.get_texto(308823) || '=' || qt_curva_base_w;
      end if;
      if (qt_curva_base_um_w IS NOT NULL AND qt_curva_base_um_w::text <> '') then 
        if (length(ds_lentes_w || ' ' || wheb_mensagem_pck.get_texto(308823) || ' 1=' || qt_curva_base_um_w) > 67) then 
          ds_consulta_w  :=  ds_consulta_w || trim(both ds_lentes_w) || ds_quebra_w;
          ds_lentes_w    :=  null;
        end if;
        ds_lentes_w  :=  ds_lentes_w || ' ' || wheb_mensagem_pck.get_texto(308823) || ' 1=' || qt_curva_base_um_w;
      end if;
      if (qt_curva_base_dois_w IS NOT NULL AND qt_curva_base_dois_w::text <> '') then 
        if (length(ds_lentes_w || ' ' || wheb_mensagem_pck.get_texto(308823) || ' 2=' || qt_curva_base_dois_w) > 67) then 
          ds_consulta_w  :=  ds_consulta_w || trim(both ds_lentes_w) || ds_quebra_w;
          ds_lentes_w    :=  null;
        end if;
        ds_lentes_w  :=  ds_lentes_w || ' ' || wheb_mensagem_pck.get_texto(308823) || ' 2=' || qt_curva_base_dois_w;
      end if;
      if (qt_grau_w IS NOT NULL AND qt_grau_w::text <> '') then 
        if (length(ds_lentes_w || ' ' || wheb_mensagem_pck.get_texto(307504) || '=' || qt_grau_w) > 67) then 
          ds_consulta_w  :=  ds_consulta_w || trim(both ds_lentes_w) || ds_quebra_w;
          ds_lentes_w    :=  null;
        end if;
        ds_lentes_w  :=  ds_lentes_w || ' ' || wheb_mensagem_pck.get_texto(307504) || '=' || qt_grau_w;
      end if;
      if (qt_grau_esferico_w IS NOT NULL AND qt_grau_esferico_w::text <> '') then 
        if (length(ds_lentes_w || ' ' || wheb_mensagem_pck.get_texto(307507) || '=' || qt_grau_esferico_w) > 67) then 
          ds_consulta_w  :=  ds_consulta_w || trim(both ds_lentes_w) || ds_quebra_w;
          ds_lentes_w    :=  null;
        end if;
        if (position(',' in qt_grau_esferico_w) = 0) then 
          ds_lentes_w  :=  ds_lentes_w || ' ' || wheb_mensagem_pck.get_texto(307507) || '=' || qt_grau_esferico_w||',00';
        else 
          ds_lentes_w  :=  ds_lentes_w || ' ' || wheb_mensagem_pck.get_texto(307507) || '=' || qt_grau_esferico_w;
        end if;
      end if;
      if (qt_grau_cilindrico_w IS NOT NULL AND qt_grau_cilindrico_w::text <> '') then 
        if (length(ds_lentes_w || ' ' || wheb_mensagem_pck.get_texto(307512) || '=' || qt_grau_cilindrico_w) > 67) then 
          ds_consulta_w  :=  ds_consulta_w || trim(both ds_lentes_w) || ds_quebra_w;
          ds_lentes_w    :=  null;
        end if;
        ds_lentes_w  :=  ds_lentes_w || ' ' || wheb_mensagem_pck.get_texto(307512) || '=' || qt_grau_cilindrico_w;
      end if;
      if (qt_grau_longe_w IS NOT NULL AND qt_grau_longe_w::text <> '') then 
        if (length(ds_lentes_w || ' ' || wheb_mensagem_pck.get_texto(307521) || '=' || qt_grau_longe_w) > 67) then 
          ds_consulta_w  :=  ds_consulta_w || trim(both ds_lentes_w) || ds_quebra_w;
          ds_lentes_w    :=  null;
        end if;
        ds_lentes_w  :=  ds_lentes_w || ' ' || wheb_mensagem_pck.get_texto(307521) || '=' || qt_grau_longe_w;
      end if;
      if (qt_diametro_w IS NOT NULL AND qt_diametro_w::text <> '') then 
        if (length(ds_lentes_w || ' ' || wheb_mensagem_pck.get_texto(307522) || '=' || qt_diametro_w) > 67) then 
          ds_consulta_w  :=  ds_consulta_w || trim(both ds_lentes_w) || ds_quebra_w;
          ds_lentes_w    :=  null;
        end if;
        ds_lentes_w  :=  ds_lentes_w || ' ' || wheb_mensagem_pck.get_texto(307522) || '=' || qt_diametro_w;
      end if;
      if (qt_eixo_w IS NOT NULL AND qt_eixo_w::text <> '') then 
        if (length(ds_lentes_w || ' ' || wheb_mensagem_pck.get_texto(307523) || '=' || qt_eixo_w) > 67) then 
          ds_consulta_w  :=  ds_consulta_w || trim(both ds_lentes_w) || ds_quebra_w;
          ds_lentes_w    :=  null;
        end if;
        ds_lentes_w  :=  ds_lentes_w || ' ' || wheb_mensagem_pck.get_texto(307523) || '=' || qt_eixo_w;
      end if;
      if (qt_adicao_w IS NOT NULL AND qt_adicao_w::text <> '') then 
        if (length(ds_lentes_w || ' ' || wheb_mensagem_pck.get_texto(307185) || '=' || qt_adicao_w) > 67) then 
          ds_consulta_w  :=  ds_consulta_w || trim(both ds_lentes_w) || ds_quebra_w;
          ds_lentes_w    :=  null;
        end if;
        ds_lentes_w  :=  ds_lentes_w || ' ' || wheb_mensagem_pck.get_texto(307185) || '=' || qt_adicao_w;
      end if;
      if (qt_dk_w IS NOT NULL AND qt_dk_w::text <> '') then 
        if (length(ds_lentes_w || ' ' || wheb_mensagem_pck.get_texto(308827) || '=' || qt_dk_w) > 67) then 
          ds_consulta_w  :=  ds_consulta_w || trim(both ds_lentes_w) || ds_quebra_w;
          ds_lentes_w    :=  null;
        end if;
        ds_lentes_w  :=  ds_lentes_w || ' ' || wheb_mensagem_pck.get_texto(308827) || '=' || qt_dk_w;
      end if;
      if (qt_h2o_w IS NOT NULL AND qt_h2o_w::text <> '') then 
        if (length(ds_lentes_w || ' H2O=' || qt_h2o_w) > 67) then 
          ds_consulta_w  :=  ds_consulta_w || trim(both ds_lentes_w) || ds_quebra_w;
          ds_lentes_w    :=  null;
        end if;
        ds_lentes_w  :=  ds_lentes_w || ' H2O=' || qt_h2o_w;
      end if;
      if (ds_marca_w IS NOT NULL AND ds_marca_w::text <> '') then 
        if (length(ds_lentes_w || ' ' || ds_marca_w) > 67) then 
          ds_consulta_w  :=  ds_consulta_w || trim(both ds_lentes_w) || ds_quebra_w;
          ds_lentes_w    :=  null;
        end if;
        ds_lentes_w  :=  ds_lentes_w || ' ' || ds_marca_w;
      end if;
      if (ds_cor_w IS NOT NULL AND ds_cor_w::text <> '') then 
        if (length(ds_lentes_w || ' ' || ds_cor_w) > 67) then 
          ds_consulta_w  :=  ds_consulta_w || trim(both ds_lentes_w) || ds_quebra_w;
          ds_lentes_w    :=  null;
        end if;
        ds_lentes_w  :=  ds_lentes_w || ' ' || ds_cor_w;
      end if;
      if (ds_material_w IS NOT NULL AND ds_material_w::text <> '') then 
        if (length(ds_lentes_w || ' ' || ds_material_w) > 67) then 
          ds_consulta_w  :=  ds_consulta_w || trim(both ds_lentes_w) || ds_quebra_w;
          ds_lentes_w    :=  null;
        end if;
        ds_lentes_w  :=  ds_lentes_w || ' ' || ds_material_w;
      end if;
      if (ds_modelo_w IS NOT NULL AND ds_modelo_w::text <> '') then 
        if (length(ds_lentes_w || ' ' || ds_modelo_w) > 67) then 
          ds_consulta_w  :=  ds_consulta_w || trim(both ds_lentes_w) || ds_quebra_w;
          ds_lentes_w    :=  null;
        end if;
        ds_lentes_w  :=  ds_lentes_w || ' ' || ds_modelo_w;
      end if;
      if (ds_tipo_lente_w IS NOT NULL AND ds_tipo_lente_w::text <> '') then 
        if (length(ds_lentes_w || ' ' || ds_tipo_lente_w) > 67) then 
          ds_consulta_w  :=  ds_consulta_w || trim(both ds_lentes_w) || ds_quebra_w;
          ds_lentes_w    :=  null;
        end if;
        ds_lentes_w  :=  ds_lentes_w || ' ' || ds_tipo_lente_w;
      end if;
      if (ds_lentes_w IS NOT NULL AND ds_lentes_w::text <> '') then 
        ds_consulta_w  :=  ds_consulta_w || trim(both ds_lentes_w) || ds_quebra_w;
      end if;
      ds_consulta_w  :=  ds_consulta_w || ds_quebra_w;
      end;
      CALL CALL CALL CALL gerar_resumo_oftalmo_3_pkg.addresumo(ds_consulta_w);
      ds_consulta_w := '';
       
    end loop;
    close C09;
   
        CALL CALL CALL CALL gerar_resumo_oftalmo_3_pkg.addresumo('*************************************************************'||ds_quebra_w);
     
    if (ds_tipo_w = wheb_mensagem_pck.get_texto(307144)) then -- Atendimento 
      begin 
     
      /*- Versão com o médico do atendimento */
 
       
      if (to_char(current_setting('gerar_resumo_oftalmo_3_pkg.dt_entrada_w')::timestamp,'dd/mm/yyyy') = '01/01/1998') then 
        CALL CALL CALL CALL gerar_resumo_oftalmo_3_pkg.addresumo(' || ' || wheb_mensagem_pck.get_texto(307152) || ': '||ds_idade_w ||' || ' ||RPAD(nm_medico_atend_w,40,' ') || ds_quebra_w);
      else 
        CALL CALL CALL CALL gerar_resumo_oftalmo_3_pkg.addresumo(wheb_mensagem_pck.get_texto(307155) || ': '|| to_char(current_setting('gerar_resumo_oftalmo_3_pkg.dt_entrada_w')::timestamp,'dd/mm/yyyy') || ' || ' || wheb_mensagem_pck.get_texto(307152) || ': '||ds_idade_w ||' || ' ||RPAD(nm_medico_atend_w,40,' ') || 
ds_quebra_w);
      end if;
 
      /* Versão sem o médico do atendimento */
 
      /*if  (to_char(dt_entrada_w,'dd/mm/yyyy') = '01/01/1998') then 
        gerar_resumo_oftalmo_3_pkg.addresumo('IDADE: '||ds_idade_w || ds_quebra_w); 
      else 
        gerar_resumo_oftalmo_3_pkg.addresumo('DATA: '|| to_char(dt_entrada_w,'dd/mm/yyyy') || ' IDADE: '||ds_idade_w || ds_quebra_w); 
      end if;*/
 
       
      CALL CALL CALL CALL gerar_resumo_oftalmo_3_pkg.addresumo('- '||RPAD(coalesce(ds_classif_atend_w,' '),8,' ')||'.'||ds_quebra_w||ds_quebra_w);
      open C10;
      loop 
      fetch C10 into   
        cd_medico_executor_w;
      EXIT WHEN NOT FOUND; /* apply on C10 */
        begin 
        CALL CALL CALL CALL gerar_resumo_oftalmo_3_pkg.addresumo(wheb_mensagem_pck.get_texto(307525) || ': '||substr(obter_nome_pf(cd_medico_executor_w),1,80) || ds_quebra_w);
        end;
      end loop;
      close C10;
       
      ds_consulta_w  := null;
   
      open C02;
      loop 
        fetch C02 into 
          dt_consulta_w,   
          nm_medico_w, 
          current_setting('gerar_resumo_oftalmo_3_pkg.nr_atendimento_w')::bigint, 
          ie_dinamica_w, 
          ie_estatica_w, 
          ie_receita_w, 
          ie_adicao_w, 
          vl_de_rd_od_w, 
          vl_dc_rd_od_w, 
          vl_eixo_rd_od_w, 
          ds_visao_rd_od_w, 
          vl_de_rd_oe_w, 
          vl_dc_rd_oe_w, 
          vl_eixo_rd_oe_w, 
          ds_visao_rd_oe_w, 
          vl_de_re_od_w, 
          vl_dc_re_od_w, 
          vl_eixo_re_od_w, 
          ds_visao_re_od_w, 
          vl_de_re_oe_w, 
          vl_dc_re_oe_w, 
          vl_eixo_re_oe_w, 
          ds_visao_re_oe_w, 
          vl_de_receita_od_w, 
          vl_dc_receita_od_w, 
          vl_eixo_receita_od_w, 
          ds_visao_receita_od_w, 
          vl_de_receita_oe_w, 
          vl_dc_receita_oe_w, 
          vl_eixo_receita_oe_w, 
          ds_visao_receita_oe_w, 
          vl_adicao_od_w, 
          vl_adicao_oe_w, 
          ds_queixa_paciente_w, 
          ds_fundoscopia_w,     
          ds_biomicroscopia_w, 
          ds_outros_exames_w, 
          ds_conduta_w, 
          vl_pressao_od_w, 
          vl_pressao_oe_w, 
          hr_pressao_w, 
          ie_tipo_fundoscopia_w, 
          ds_av_sc_od_w, 
          ds_av_cc_od_w, 
          ds_av_sc_oe_w, 
          ds_av_cc_oe_w, 
          ds_meo_w, 
          vl_visao_rd_od_w, 
          vl_visao_rd_oe_w, 
          vl_visao_re_od_w, 
          vl_visao_re_oe_w, 
          vl_visao_receita_od_w, 
          vl_visao_receita_oe_w, 
          ds_obs_receita_w, 
          nr_seq_cons_med_w, 
          ds_hip_diag_w;
        EXIT WHEN NOT FOUND; /* apply on C02 */
        begin 
     
        /*ds_consulta_w  := ds_consulta_w ||LPAD('MÉDICO(A): ',20,' ') ||nm_medico_w ||ds_quebra_w ;*/
 
        ds_consulta_w  := ds_consulta_w ||LPAD(wheb_mensagem_pck.get_texto(307164) || ': ',18,' ')  ||ds_queixa_paciente_w  ||ds_quebra_w;
       
        if (ds_av_sc_od_w IS NOT NULL AND ds_av_sc_od_w::text <> '') or (ds_av_sc_oe_w IS NOT NULL AND ds_av_sc_oe_w::text <> '') then 
          ds_consulta_w  := ds_consulta_w ||LPAD(wheb_mensagem_pck.get_texto(307166) || ' ' || wheb_mensagem_pck.get_texto(307169) || ': ',20,' ')||ds_av_sc_od_w ||ds_quebra_w;
          ds_consulta_w  := ds_consulta_w ||LPAD(wheb_mensagem_pck.get_texto(307171) || ': ',20,' ')||ds_av_sc_oe_w ||ds_quebra_w;
        end if;
     
        if (ds_av_cc_od_w IS NOT NULL AND ds_av_cc_od_w::text <> '') or (ds_av_cc_oe_w IS NOT NULL AND ds_av_cc_oe_w::text <> '') then 
          ds_consulta_w  := ds_consulta_w ||LPAD(wheb_mensagem_pck.get_texto(307172) || ' ' || wheb_mensagem_pck.get_texto(307169) || ': ',20,' ')||ds_av_cc_od_w ||ds_quebra_w;
          ds_consulta_w  := ds_consulta_w ||LPAD(wheb_mensagem_pck.get_texto(307171) || ': ',20,' ')||ds_av_cc_oe_w ||ds_quebra_w;
        end if;
   
        if (ds_meo_w IS NOT NULL AND ds_meo_w::text <> '') then 
          ds_consulta_w  := ds_consulta_w ||LPAD(wheb_mensagem_pck.get_texto(307173) || ': ',20,' ') ||ds_meo_w ||ds_quebra_w;
        end if;
   
        if (vl_de_rd_od_w IS NOT NULL AND vl_de_rd_od_w::text <> '') or (vl_dc_rd_od_w IS NOT NULL AND vl_dc_rd_od_w::text <> '') or (vl_eixo_rd_od_w IS NOT NULL AND vl_eixo_rd_od_w::text <> '') or (vl_visao_rd_od_w IS NOT NULL AND vl_visao_rd_od_w::text <> '') or (ds_visao_rd_od_w IS NOT NULL AND ds_visao_rd_od_w::text <> '') or (vl_de_rd_oe_w IS NOT NULL AND vl_de_rd_oe_w::text <> '') or (vl_dc_rd_oe_w IS NOT NULL AND vl_dc_rd_oe_w::text <> '') or (vl_eixo_rd_oe_w IS NOT NULL AND vl_eixo_rd_oe_w::text <> '') or (vl_visao_rd_oe_w IS NOT NULL AND vl_visao_rd_oe_w::text <> '') or (ds_visao_rd_oe_w IS NOT NULL AND ds_visao_rd_oe_w::text <> '') or (vl_de_re_od_w IS NOT NULL AND vl_de_re_od_w::text <> '') or (vl_dc_re_od_w IS NOT NULL AND vl_dc_re_od_w::text <> '') or (vl_eixo_re_od_w IS NOT NULL AND vl_eixo_re_od_w::text <> '') or (vl_visao_re_od_w IS NOT NULL AND vl_visao_re_od_w::text <> '') or (ds_visao_re_od_w IS NOT NULL AND ds_visao_re_od_w::text <> '') or (vl_de_re_oe_w IS NOT NULL AND vl_de_re_oe_w::text <> '') or (vl_dc_re_oe_w IS NOT NULL AND vl_dc_re_oe_w::text <> '') or (vl_eixo_re_oe_w IS NOT NULL AND vl_eixo_re_oe_w::text <> '') or (vl_visao_re_oe_w IS NOT NULL AND vl_visao_re_oe_w::text <> '') or (ds_visao_re_oe_w IS NOT NULL AND ds_visao_re_oe_w::text <> '') or (vl_dc_receita_od_w IS NOT NULL AND vl_dc_receita_od_w::text <> '') or (vl_de_receita_od_w IS NOT NULL AND vl_de_receita_od_w::text <> '') or (vl_eixo_receita_od_w IS NOT NULL AND vl_eixo_receita_od_w::text <> '') or (vl_visao_receita_od_w is not 
 
null) or (ds_visao_receita_od_w IS NOT NULL AND ds_visao_receita_od_w::text <> '') or (vl_dc_receita_oe_w IS NOT NULL AND vl_dc_receita_oe_w::text <> '') or (vl_de_receita_oe_w IS NOT NULL AND vl_de_receita_oe_w::text <> '') or (vl_eixo_receita_oe_w IS NOT NULL AND vl_eixo_receita_oe_w::text <> '') or (vl_visao_receita_oe_w is not 
 
null) or (ds_visao_receita_oe_w IS NOT NULL AND ds_visao_receita_oe_w::text <> '') or (vl_adicao_od_w IS NOT NULL AND vl_adicao_od_w::text <> '') or (vl_adicao_oe_w IS NOT NULL AND vl_adicao_oe_w::text <> '') then 
          ds_consulta_w  := ds_consulta_w ||LPAD(wheb_mensagem_pck.get_texto(307528) || ': ',20,' ')||ds_quebra_w;
        end if;
   
        if (vl_de_rd_od_w IS NOT NULL AND vl_de_rd_od_w::text <> '') or (vl_dc_rd_od_w IS NOT NULL AND vl_dc_rd_od_w::text <> '') or (vl_eixo_rd_od_w IS NOT NULL AND vl_eixo_rd_od_w::text <> '') or (vl_visao_rd_od_w IS NOT NULL AND vl_visao_rd_od_w::text <> '') or (ds_visao_rd_od_w IS NOT NULL AND ds_visao_rd_od_w::text <> '') or (vl_de_rd_oe_w IS NOT NULL AND vl_de_rd_oe_w::text <> '') or (vl_dc_rd_oe_w IS NOT NULL AND vl_dc_rd_oe_w::text <> '') or (vl_eixo_rd_oe_w IS NOT NULL AND vl_eixo_rd_oe_w::text <> '') or (vl_visao_rd_oe_w IS NOT NULL AND vl_visao_rd_oe_w::text <> '') or (ds_visao_rd_oe_w IS NOT NULL AND ds_visao_rd_oe_w::text <> '') then         
           
          if (vl_de_rd_od_w IS NOT NULL AND vl_de_rd_od_w::text <> '') then 
            select  CASE WHEN obter_se_negativo(vl_de_rd_od_w)='S' THEN  LPAD(campo_mascara_virgula(vl_de_rd_od_w),7,' ')  ELSE LPAD('+'||campo_mascara_virgula(vl_de_rd_od_w),7,' ') END  
            into STRICT  ds_impressao1_w 
;
          else 
            ds_impressao1_w  := LPAD(' ',7,' ');
          end if;
           
          if (vl_de_rd_oe_w IS NOT NULL AND vl_de_rd_oe_w::text <> '') then 
            select  CASE WHEN obter_se_negativo(vl_de_rd_oe_w)='S' THEN  LPAD(campo_mascara_virgula(vl_de_rd_oe_w),7,' ')  ELSE LPAD('+'||campo_mascara_virgula(vl_de_rd_oe_w),7,' ') END  
            into STRICT  ds_impressao2_w 
;
          else 
            ds_impressao2_w  := LPAD(' ',7,' ');
          end if;
           
          ds_consulta_w  := ds_consulta_w ||LPAD(upper(wheb_mensagem_pck.get_texto(307175)) ||' ' || wheb_mensagem_pck.get_texto(307169) || ':',20,' ') || ds_impressao1_w ||' / '||LPAD('-'||vl_dc_rd_od_w,7,' ') ||' / '||LPAD(vl_eixo_rd_od_w,3,' ') ||'   20/'||vl_visao_rd_od_w ||' '||ds_visao_rd_od_w ||ds_quebra_w;
          ds_consulta_w  := ds_consulta_w ||LPAD(wheb_mensagem_pck.get_texto(307171) || ':',20,' ')|| ds_impressao2_w ||' / '||LPAD('-'||vl_dc_rd_oe_w,7,' ') ||' / '||LPAD(vl_eixo_rd_oe_w,3,' ') ||'   20/'||vl_visao_rd_oe_w||' '||ds_visao_rd_oe_w ||ds_quebra_w;
   
        end if;
             
        if (vl_de_re_od_w IS NOT NULL AND vl_de_re_od_w::text <> '') or (vl_dc_re_od_w IS NOT NULL AND vl_dc_re_od_w::text <> '') or (vl_eixo_re_od_w IS NOT NULL AND vl_eixo_re_od_w::text <> '') or (vl_visao_re_od_w IS NOT NULL AND vl_visao_re_od_w::text <> '') or (ds_visao_re_od_w IS NOT NULL AND ds_visao_re_od_w::text <> '') or (vl_de_re_oe_w IS NOT NULL AND vl_de_re_oe_w::text <> '') or (vl_dc_re_oe_w IS NOT NULL AND vl_dc_re_oe_w::text <> '') or (vl_eixo_re_oe_w IS NOT NULL AND vl_eixo_re_oe_w::text <> '') or (vl_visao_re_oe_w IS NOT NULL AND vl_visao_re_oe_w::text <> '') or (ds_visao_re_oe_w IS NOT NULL AND ds_visao_re_oe_w::text <> '') then         
           
          if (vl_de_re_od_w IS NOT NULL AND vl_de_re_od_w::text <> '') then 
            select  CASE WHEN obter_se_negativo(vl_de_re_od_w)='S' THEN  LPAD(campo_mascara_virgula(vl_de_re_od_w),7,' ')  ELSE LPAD('+'||campo_mascara_virgula(vl_de_re_od_w),7,' ') END  
            into STRICT  ds_impressao1_w 
;
          else 
            ds_impressao1_w  := LPAD(' ',7,' ');
          end if;
           
          if (vl_de_re_oe_w IS NOT NULL AND vl_de_re_oe_w::text <> '') then 
            select  CASE WHEN obter_se_negativo(vl_de_re_oe_w)='S' THEN  LPAD(campo_mascara_virgula(vl_de_re_oe_w),7,' ')  ELSE LPAD('+'||campo_mascara_virgula(vl_de_re_oe_w),7,' ') END  
            into STRICT  ds_impressao2_w 
;
          else 
            ds_impressao2_w  := LPAD(' ',7,' ');
          end if;
           
          ds_consulta_w  := ds_consulta_w ||LPAD(upper(wheb_mensagem_pck.get_texto(307177)) || ' ' || wheb_mensagem_pck.get_texto(307169) || ':',20,' ')|| ds_impressao1_w ||' / '||LPAD('-'||vl_dc_re_od_w,7,' ') ||' / '||LPAD(vl_eixo_re_od_w,3,' ') ||'   20/'||vl_visao_re_od_w||' '||ds_visao_re_od_w ||ds_quebra_w;
          ds_consulta_w  := ds_consulta_w ||LPAD(wheb_mensagem_pck.get_texto(307171) || ':',20,' ')|| ds_impressao2_w ||' / '||LPAD('-'||vl_dc_re_oe_w,7,' ') ||' / '||LPAD(vl_eixo_re_oe_w,3,' ') ||'   20/'||vl_visao_re_oe_w||' '||ds_visao_re_oe_w ||ds_quebra_w;
   
        end if;
   
        if (vl_dc_receita_od_w IS NOT NULL AND vl_dc_receita_od_w::text <> '') or (vl_de_receita_od_w IS NOT NULL AND vl_de_receita_od_w::text <> '') or (vl_eixo_receita_od_w IS NOT NULL AND vl_eixo_receita_od_w::text <> '') or (vl_visao_receita_od_w is not 
 
null) or (ds_visao_receita_od_w IS NOT NULL AND ds_visao_receita_od_w::text <> '') or (vl_dc_receita_oe_w IS NOT NULL AND vl_dc_receita_oe_w::text <> '') or (vl_de_receita_oe_w IS NOT NULL AND vl_de_receita_oe_w::text <> '') or (vl_eixo_receita_oe_w IS NOT NULL AND vl_eixo_receita_oe_w::text <> '') or (vl_visao_receita_oe_w is not 
 
null) or (ds_visao_receita_oe_w IS NOT NULL AND ds_visao_receita_oe_w::text <> '') then         
           
          if (vl_de_receita_od_w IS NOT NULL AND vl_de_receita_od_w::text <> '') then 
            select  CASE WHEN obter_se_negativo(vl_de_receita_od_w)='S' THEN  LPAD(campo_mascara_virgula(vl_de_receita_od_w),7,' ')  ELSE LPAD('+'||campo_mascara_virgula(vl_de_receita_od_w),7,' ') END  
            into STRICT  ds_impressao1_w 
;
          else 
            ds_impressao1_w  := LPAD(' ',7,' ');
          end if;
           
          if (vl_de_receita_oe_w IS NOT NULL AND vl_de_receita_oe_w::text <> '') then 
            select  CASE WHEN obter_se_negativo(vl_de_receita_oe_w)='S' THEN  LPAD(campo_mascara_virgula(vl_de_receita_oe_w),7,' ')  ELSE LPAD('+'||campo_mascara_virgula(vl_de_receita_oe_w),7,' ') END  
            into STRICT  ds_impressao2_w 
;
          else 
            ds_impressao2_w  := LPAD(' ',7,' ');
          end if;
           
          ds_consulta_w  := ds_consulta_w ||LPAD(upper(wheb_mensagem_pck.get_texto(307182)) || ' ' || wheb_mensagem_pck.get_texto(307169) || ':',20,' ')|| ds_impressao1_w ||' / '||LPAD('-'||vl_dc_receita_od_w,7,' ') ||' / '||LPAD(vl_eixo_receita_od_w,3,' ') ||'   20/'||vl_visao_receita_od_w||' '||ds_visao_receita_od_w ||ds_quebra_w;
          ds_consulta_w  := ds_consulta_w ||LPAD(wheb_mensagem_pck.get_texto(307171) || ':',20,' ')|| ds_impressao2_w ||' / '||LPAD('-'||vl_dc_receita_oe_w,7,' ') ||' / '||LPAD(vl_eixo_receita_oe_w,3,' ') ||'   20/'||vl_visao_receita_oe_w||' '||ds_visao_receita_oe_w ||ds_quebra_w;
        end if;
   
        if (vl_adicao_od_w IS NOT NULL AND vl_adicao_od_w::text <> '') or (vl_adicao_oe_w IS NOT NULL AND vl_adicao_oe_w::text <> '') then 
          ds_consulta_w  := ds_consulta_w ||LPAD(upper(wheb_mensagem_pck.get_texto(307185)) || ' ' || wheb_mensagem_pck.get_texto(307169) || ':',20,' ')||LPAD('+'||vl_adicao_od_w,7,' ') ||ds_quebra_w;
          ds_consulta_w  := ds_consulta_w ||LPAD(wheb_mensagem_pck.get_texto(307171) || ':',20,' ')||LPAD('+'||vl_adicao_oe_w,7,' ') ||ds_quebra_w;
        end if;
         
        if (ds_obs_receita_w IS NOT NULL AND ds_obs_receita_w::text <> '') then 
          ds_consulta_w  := ds_consulta_w ||LPAD(wheb_mensagem_pck.get_texto(307532) || ': ',20,' ')|| ds_obs_receita_w || ds_quebra_w;
        end if;
         
        if (vl_pressao_od_w IS NOT NULL AND vl_pressao_od_w::text <> '') or (vl_pressao_oe_w IS NOT NULL AND vl_pressao_oe_w::text <> '') then 
          ds_consulta_w  := ds_consulta_w ||LPAD(wheb_mensagem_pck.get_texto(307187) || ': ',20,' ')||LPAD(wheb_mensagem_pck.get_texto(307169) || ': ',4,' ')||vl_pressao_od_w ||'  ' || wheb_mensagem_pck.get_texto(307171) || ': '||vl_pressao_oe_w||' ' || wheb_mensagem_pck.get_texto(307189) || ': '||hr_pressao_w ||ds_quebra_w;        end if;
     
     
        if (ds_biomicroscopia_w IS NOT NULL AND ds_biomicroscopia_w::text <> '') then 
          ds_consulta_w  := ds_consulta_w ||ds_quebra_w||LPAD(wheb_mensagem_pck.get_texto(307202) || ': ',20,' ')||ds_biomicroscopia_w||ds_quebra_w;
        end if;
       
     
        if (ds_fundoscopia_w IS NOT NULL AND ds_fundoscopia_w::text <> '') then 
          begin 
          ds_consulta_w  := ds_consulta_w ||ds_quebra_w||LPAD(coalesce(ds_fundoscopia_p,wheb_mensagem_pck.get_texto(307201))||': ',20,' ')||ds_fundoscopia_w  ||ds_quebra_w;
          end;
        end if;
       
         
        if (ds_outros_exames_w IS NOT NULL AND ds_outros_exames_w::text <> '') then 
          ds_consulta_w  := ds_consulta_w ||ds_quebra_w||LPAD(upper(wheb_mensagem_pck.get_texto(307203)) || ': ',20,' ')||ds_outros_exames_w||ds_quebra_w;
        end if;
   
        if (ds_hip_diag_w IS NOT NULL AND ds_hip_diag_w::text <> '') then 
          ds_consulta_w  := ds_consulta_w ||ds_quebra_w||LPAD(upper(wheb_mensagem_pck.get_texto(307534)) || ': ',20,' ')||ds_hip_diag_w||ds_quebra_w;
        end if;
   
        if (ds_conduta_w IS NOT NULL AND ds_conduta_w::text <> '') then 
          ds_consulta_w  := ds_consulta_w ||ds_quebra_w||LPAD(upper(wheb_mensagem_pck.get_texto(307204)) || ': ',20,' ')||ds_conduta_w||ds_quebra_w;
        end if;
         
        ds_consulta_w  := ds_consulta_w ||ds_quebra_w;
         
        end;
      end loop;
      close C02;
     
      ds_diagnostico_long_w  := '';
   
      open C03;
      loop 
        fetch C03 into 
          ds_doenca_w, 
          ds_diagnostico_w, 
          ds_olho_diag_w;
        EXIT WHEN NOT FOUND; /* apply on C03 */
        begin 
   
        if (ds_olho_diag_w = 'A') then 
          ds_olho_diag_w  := wheb_mensagem_pck.get_texto(308949) || ': ';
        elsif (ds_olho_diag_w IS NOT NULL AND ds_olho_diag_w::text <> '') then 
          ds_olho_diag_w  := wheb_mensagem_pck.get_texto(308972)||ds_olho_diag_w ||': ';
        end if;
     
        ds_diagnostico_long_w  := ds_diagnostico_long_w || LPAD(' ',5,' ') || RPAD(ds_olho_diag_w,5,' ') || RPAD(ds_doenca_w,5,' ') 
 
||ds_diagnostico_w||ds_quebra_w;
   
        end;
      end loop;
      close C03;
   
      ie_tem_laudo_w  := 'N';
      open C04;
      loop 
        fetch C04 into 
          nr_seq_laudo_w, 
          ds_titulo_laudo_w, 
          nm_medico_resp_w;
        EXIT WHEN NOT FOUND; /* apply on C04 */
        begin 
        if (ie_tem_laudo_w = 'N') then 
          ie_tem_laudo_w  := 'S';
          CALL CALL CALL CALL gerar_resumo_oftalmo_3_pkg.addresumo(wheb_mensagem_pck.get_texto(307537) ||ds_quebra_w);
        end if;
        CALL CALL CALL CALL gerar_resumo_oftalmo_3_pkg.addresumo(' ' || wheb_mensagem_pck.get_texto(307539) || ': '||nm_medico_resp_w||ds_quebra_w);
        CALL CALL CALL CALL gerar_resumo_oftalmo_3_pkg.addresumo(ds_titulo_laudo_w ||ds_quebra_w);
        /* Grava o conteúdo atual do resumo */
 
        CALL CALL CALL CALL gerar_resumo_oftalmo_3_pkg.gravar_resumo_banco(null);
        /* Grava um novo registro referênciando o Laudo (LAUDO_PACIENTE) */
 
        CALL CALL CALL CALL gerar_resumo_oftalmo_3_pkg.gravar_resumo_banco(nr_seq_laudo_w);
   
        end;
      end loop;
      close C04;
       
      if (ie_tem_laudo_w = 'S') then 
        CALL CALL CALL CALL gerar_resumo_oftalmo_3_pkg.addresumo(ds_quebra_w);
      end if;
         
      ds_cirurgia_long_w  := '';
   
      open C05;
      loop 
        fetch C05 into 
          ds_procedimento_w, 
          ds_olho_cirurgia_w, 
          dt_procedimento_w, 
          ds_observacao_olho_w;
        EXIT WHEN NOT FOUND; /* apply on C05 */
        begin 
     
        if (ds_olho_cirurgia_w = 'A') then 
          ds_olho_cirurgia_w  := wheb_mensagem_pck.get_texto(308949) || ': ';
        elsif (ds_olho_cirurgia_w IS NOT NULL AND ds_olho_cirurgia_w::text <> '') then 
          ds_olho_cirurgia_w  := wheb_mensagem_pck.get_texto(308972)||ds_olho_cirurgia_w ||' - ';
        end if;
       
        ds_cirurgia_long_w  := ds_cirurgia_long_w ||LPAD(' ',5,' ')||to_char(dt_procedimento_w,'dd/mm/yyyy hh24:mi:ss')||' - '||ds_olho_cirurgia_w || 
 
ds_procedimento_w || ds_quebra_w;
         
        if (ds_observacao_olho_w IS NOT NULL AND ds_observacao_olho_w::text <> '') then 
          ds_cirurgia_long_w  := ds_cirurgia_long_w  ||LPAD(' ',5,' ')||ds_observacao_olho_w;
        end if;
         
        end;
      end loop;
      close C05;
			 
			ds_desc_cir_w := '';	
			ds_desc_cir_geral_w := '';
			open C14;
			loop 
			fetch C14 into 
				nm_medico_cirurgiao_w, 
				nm_medico_anestesista_w, 
				ds_proc_principal_w, 
				nr_seq_cirurgia_w;
			EXIT WHEN NOT FOUND; /* apply on c14 */
				begin 
				open C15;
					loop 
					fetch C15 into 
						dt_desc_cirurgica_w, 
						nm_resp_desc_cirurgica_w, 
						cd_doenca_cid_cirurgia_w, 
						nr_seq_desc_cirurgica_w;
					EXIT WHEN NOT FOUND; /* apply on C15 */
						begin 
						converte_rtf_string('select ds_cirurgia from cirurgia_descricao where nr_sequencia = :nr_seq', 
						nr_seq_desc_cirurgica_w,nm_usuario_p, nr_cirurgia_w);
		 
						select	ds_texto 
						into STRICT	ds_desc_cir_w 
						from	tasy_conversao_rtf 
						where	nr_sequencia = nr_cirurgia_w;
						 
						ds_desc_cir_geral_w  := ds_desc_cir_geral_w ||ds_desc_cir_w ||ds_quebra_w;
						 
						end;
					end loop;
				close C15;
				end;
			end loop;
			close C14;
			 
			ds_exame_long_w		:= '';
 
			open C07;
			loop 
				fetch C07 into 
					cd_procedimento_w, 
					ds_exame_w;
				EXIT WHEN NOT FOUND; /* apply on C07 */
				begin 
			 
				ds_exame_long_w	:= ds_exame_long_w ||LPAD(' ',5,' ') || ds_exame_w ||chr(13);
			 
				end;
			end loop;
			close C07;
			 
      ds_exames_long_w  := '';
       
      open C11;
      loop 
      fetch C11 into   
        nr_seq_aval_w;
      EXIT WHEN NOT FOUND; /* apply on C11 */
        begin 
        gerar_resumo_avaliacao_oft(nr_seq_aval_w,nm_usuario_p,ds_resumo_aval_aux_w);
        ds_resumo_aval_w  := ds_resumo_aval_w ||ds_resumo_aval_aux_w ||ds_quebra_w;
				end;
      end loop;
      close C11;
       
       
      if (ds_resumo_aval_w IS NOT NULL AND ds_resumo_aval_w::text <> '') then 
        CALL CALL CALL CALL gerar_resumo_oftalmo_3_pkg.addresumo(ds_resumo_aval_w || ds_quebra_w);
      end if;
       
      ds_resumo_aval_w := null;
       
      open C08;
      loop 
        fetch C08 into 
          dt_agenda_w, 
          ds_proced_agenda_w;
        EXIT WHEN NOT FOUND; /* apply on C08 */
        begin 
  --      ds_exames_long_w  := ds_exames_long_w || LPAD(' ',5,' ')||to_char(dt_agenda_w,'dd/mm/yyyy hh24:mi:ss')||' - 
--'||ds_proced_agenda_w||ds_quebra_w;                                                                ---O.S. 487586 _ABMACIEL 
      ds_exames_long_w  := ds_exames_long_w || LPAD(' ',5,' ')||' - '||ds_proced_agenda_w||ds_quebra_w;
        end;
      end loop;
      close C08;
 
      if (ds_consulta_w IS NOT NULL AND ds_consulta_w::text <> '') then   
        begin 
        /*gerar_resumo_oftalmo_3_pkg.addresumo('CONSULTA'||ds_quebra_w);*/
 
        CALL CALL CALL CALL gerar_resumo_oftalmo_3_pkg.addresumo(ds_consulta_w || ds_quebra_w);
        ds_consulta_w  := null;
        end;
      end if;
       
      if (ds_diagnostico_long_w IS NOT NULL AND ds_diagnostico_long_w::text <> '') then   
        begin 
        CALL CALL CALL CALL gerar_resumo_oftalmo_3_pkg.addresumo(wheb_mensagem_pck.get_texto(307206)||ds_quebra_w);
        CALL CALL CALL CALL gerar_resumo_oftalmo_3_pkg.addresumo(ds_diagnostico_long_w || ds_quebra_w);
        end;
      end if;
   
      if (ds_cirurgia_long_w IS NOT NULL AND ds_cirurgia_long_w::text <> '') then   
        begin 
        CALL CALL CALL CALL gerar_resumo_oftalmo_3_pkg.addresumo(wheb_mensagem_pck.get_texto(307207)||ds_quebra_w);
        CALL CALL CALL CALL gerar_resumo_oftalmo_3_pkg.addresumo(ds_cirurgia_long_w || ds_quebra_w);
        end;
      end if;
			 
			if (ds_desc_cir_geral_w IS NOT NULL AND ds_desc_cir_geral_w::text <> '') then   
        begin 
        CALL CALL CALL CALL gerar_resumo_oftalmo_3_pkg.addresumo(ds_desc_cir_geral_w || ds_quebra_w);
        end;
      end if;
       
      if (ds_exames_long_w IS NOT NULL AND ds_exames_long_w::text <> '') then 
        --gerar_resumo_oftalmo_3_pkg.addresumo('EXAMES'||ds_quebra_w);                       --O.S. 487586 _ABMACIEL 
        CALL CALL CALL CALL gerar_resumo_oftalmo_3_pkg.addresumo(ds_exames_long_w || ds_quebra_w);
      end if;
			 
			if (ds_exame_long_w IS NOT NULL AND ds_exame_long_w::text <> '') then	 
				begin 
				CALL CALL CALL CALL gerar_resumo_oftalmo_3_pkg.addresumo(wheb_mensagem_pck.get_texto(325391)||ds_quebra_w);
				CALL CALL CALL CALL gerar_resumo_oftalmo_3_pkg.addresumo(ds_exame_long_w || ds_quebra_w);
				end;
			end if;
       
      end;
    elsif (ds_tipo_w = wheb_mensagem_pck.get_texto(307145)) then 
 
      ds_consulta_w  := LPAD(wheb_mensagem_pck.get_texto(307542) || ': ',20,' ') || to_char(current_setting('gerar_resumo_oftalmo_3_pkg.dt_entrada_w')::timestamp,'dd/mm/yyyy') ||ds_quebra_w;
      ds_consulta_w  := ds_consulta_w ||LPAD(upper(wheb_mensagem_pck.get_texto(307145)) || ': ',20,' ')  ||ds_classif_atend_w ||ds_quebra_w;
      ds_consulta_w  := ds_consulta_w ||LPAD(upper(wheb_mensagem_pck.get_texto(307209)) || ': ',20,' ') || nm_usuario2_w || ds_quebra_w;
      CALL CALL CALL CALL gerar_resumo_oftalmo_3_pkg.addresumo(ds_consulta_w);
      ds_consulta_w  := '';
    end if;
    end;
  end loop;
  close C01;
   
  CALL CALL CALL CALL gerar_resumo_oftalmo_3_pkg.addresumo(ds_quebra_w||'*************************************************************'||ds_quebra_w);
  CALL CALL CALL CALL gerar_resumo_oftalmo_3_pkg.addresumo('- '|| upper(wheb_mensagem_pck.get_texto(307545)) || ds_quebra_w); -- RECEITAS 
  open C12;
      loop 
      fetch C12 into   
        nr_atendimento_hosp_w, 
		dt_receita_w, 
		nr_seq_receita_w;
      EXIT WHEN NOT FOUND; /* apply on C12 */
        begin 
        CALL CALL CALL CALL gerar_resumo_oftalmo_3_pkg.addresumo(ds_quebra_w ||wheb_mensagem_pck.get_texto(307144) ||': ' || nr_atendimento_hosp_w || ds_quebra_w);
		CALL CALL CALL CALL gerar_resumo_oftalmo_3_pkg.addresumo(wheb_mensagem_pck.get_texto(307155) || ': ' || to_char(dt_receita_w,'dd/mm/yyyy hh24:mi:ss') || ds_quebra_w || ds_quebra_w);
		 
		converte_rtf_string('select ds_receita from med_receita where nr_sequencia = :nr_seq', 
					nr_seq_receita_w,nm_usuario_p, nr_receita_w);
		 
		select	ds_texto 
		into STRICT	ds_receita_w 
		from	tasy_conversao_rtf 
		where	nr_sequencia = nr_receita_w;
 
		CALL CALL CALL CALL gerar_resumo_oftalmo_3_pkg.addresumo(ds_receita_w);
		ds_receita_w := '';
		 
        end;
      end loop;
  close C12;
   
	/* 
  gerar_resumo_oftalmo_3_pkg.addresumo(ds_quebra_w||'*************************************************************'||ds_quebra_w); 
  gerar_resumo_oftalmo_3_pkg.addresumo('- CIRURGIAS' || ds_quebra_w); 
   
	 
  open C13; 
      loop 
      fetch C13 into   
        nr_atend_cirurgia_w; 
      exit when C13%notfound; 
        begin 
        gerar_resumo_oftalmo_3_pkg.addresumo(ds_quebra_w || 'Atendimento: ' || nr_atend_cirurgia_w || ds_quebra_w); 
		 
		open C14; 
			loop 
			fetch C14 into 
				nm_medico_cirurgiao_w, 
				nm_medico_anestesista_w, 
				ds_proc_principal_w, 
				nr_seq_cirurgia_w; 
			exit when c14%notfound; 
				begin 
				gerar_resumo_oftalmo_3_pkg.addresumo(ds_quebra_w||'- Médico cirurgião: ' || nm_medico_cirurgiao_w || ' || ' || 'Médico anestesista: ' || nm_medico_anestesista_w || ds_quebra_w); 
				gerar_resumo_oftalmo_3_pkg.addresumo('- Procedimento principal: ' || ds_proc_principal_w || ds_quebra_w); 
				 
				open C15; 
					loop 
					fetch C15 into 
						dt_desc_cirurgica_w, 
						nm_resp_desc_cirurgica_w, 
						cd_doenca_cid_cirurgia_w, 
						nr_seq_desc_cirurgica_w; 
					exit when C15%notfound; 
						begin 
						gerar_resumo_oftalmo_3_pkg.addresumo('- Data: ' || to_char(dt_desc_cirurgica_w,'dd/mm/yyyy hh24:mi:ss') || ' || ' || nm_resp_desc_cirurgica_w || ' || ' || cd_doenca_cid_cirurgia_w || ds_quebra_w); 
						 
						converte_rtf_string('select ds_cirurgia from cirurgia_descricao where nr_sequencia = :nr_seq', 
						nr_seq_desc_cirurgica_w,nm_usuario_p, nr_cirurgia_w); 
		 
						select	ds_texto 
						into	ds_desc_cirurgica_w 
						from	tasy_conversao_rtf 
						where	nr_sequencia = nr_cirurgia_w; 
 
						gerar_resumo_oftalmo_3_pkg.addresumo(ds_quebra_w||ds_desc_cirurgica_w); 
						ds_desc_cirurgica_w := ''; 
						end; 
					end loop; 
				close C15; 
				end; 
			end loop; 
		close C14; 
        end; 
      end loop; 
  close C13; 
	*/
  
	CALL CALL CALL CALL gerar_resumo_oftalmo_3_pkg.addresumo(ds_quebra_w||'*************************************************************'||ds_quebra_w);
	 
  CALL CALL CALL CALL gerar_resumo_oftalmo_3_pkg.gravar_resumo_banco(null);
  PERFORM set_config('gerar_resumo_oftalmo_3_pkg.ds_resumo_w', null, false);
  END;

$body$
LANGUAGE PLPGSQL
;
-- REVOKE ALL ON PROCEDURE gerar_resumo_oftalmo_3_pkg.gerar_resumo_oftalmo_3 ( cd_pessoa_fisica_p text, nm_usuario_p text, ds_fundoscopia_p text) FROM PUBLIC;
