-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_mens_criticas_pck.criticar_faixa_etaria (nr_seq_mensalidade_seg_p pls_mensalidade_segurado.nr_sequencia%type, nr_seq_segurado_p pls_mensalidade_segurado.nr_seq_segurado%type, nr_seq_segurado_preco_p pls_mensalidade_segurado.nr_seq_segurado_preco%type, qt_idade_p pls_mensalidade_segurado.qt_idade%type, dt_referencia_p pls_mensalidade_segurado.dt_mesano_referencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) AS $body$
DECLARE

qt_idade_inicial_w		pls_plano_preco.qt_idade_inicial%type;
qt_idade_final_w		pls_plano_preco.qt_idade_final%type;
qt_idade_proxima_faixa_w	pls_plano_preco.qt_idade_final%type;

qt_idade_limite_w		bigint;
qt_tempo_limite_w		bigint;
qt_idade_operadora_w		bigint;
dt_aniversario_proxima_faixa_w	timestamp;
ie_consistir_w			varchar(1);

BEGIN

ie_consistir_w	:= 'S';

begin
select	b.qt_idade_inicial,
	b.qt_idade_final
into STRICT	qt_idade_inicial_w,
	qt_idade_final_w
from	pls_segurado_preco a,
	pls_plano_preco b
where	b.nr_sequencia	= a.nr_seq_preco
and	a.nr_sequencia	= nr_seq_segurado_preco_p;
exception
when others then
	ie_consistir_w	:= 'N';
end;

if (ie_consistir_w = 'S') and (not qt_idade_p between qt_idade_inicial_w and qt_idade_final_w) then
	pls_obter_limite_reajuste_fx(nr_seq_segurado_p, cd_estabelecimento_p, qt_idade_limite_w, qt_tempo_limite_w);

	qt_idade_proxima_faixa_w	:= qt_idade_final_w+1;

	if (qt_idade_proxima_faixa_w >= qt_idade_limite_w) then --Se o beneficiario tem idade maior que a regra para isencao de reajuste
		dt_aniversario_proxima_faixa_w	:= add_months(pls_obter_dados_segurado(nr_seq_segurado_p,'NAS'),(qt_idade_proxima_faixa_w*12)); --Calcular a data em que o beneficiario fez aniversario onde deveria ter reajustado a faixa etaria
		qt_idade_operadora_w	:= pls_obter_idade_benef_ops(nr_seq_segurado_p, dt_aniversario_proxima_faixa_w, cd_estabelecimento_p);

		if (qt_idade_operadora_w < qt_tempo_limite_w) then
			CALL pls_mens_criticas_pck.add_critica(nr_seq_mensalidade_seg_p, 3);
		end if;
	else
		CALL pls_mens_criticas_pck.add_critica(nr_seq_mensalidade_seg_p, 3);
	end if;
end if;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_mens_criticas_pck.criticar_faixa_etaria (nr_seq_mensalidade_seg_p pls_mensalidade_segurado.nr_sequencia%type, nr_seq_segurado_p pls_mensalidade_segurado.nr_seq_segurado%type, nr_seq_segurado_preco_p pls_mensalidade_segurado.nr_seq_segurado_preco%type, qt_idade_p pls_mensalidade_segurado.qt_idade%type, dt_referencia_p pls_mensalidade_segurado.dt_mesano_referencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) FROM PUBLIC;
