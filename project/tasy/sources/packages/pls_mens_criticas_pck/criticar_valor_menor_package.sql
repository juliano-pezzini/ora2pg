-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_mens_criticas_pck.criticar_valor_menor ( nr_seq_mensalidade_seg_p pls_mensalidade_segurado.nr_sequencia%type, vl_pre_estabelecido_p pls_mensalidade_segurado.vl_pre_estabelecido%type, vl_pre_estabelecido_ant_p pls_mensalidade_segurado.vl_pre_estabelecido%type, nr_parcela_p pls_mensalidade_segurado.nr_parcela%type, ie_rescisao_proporcional_p pls_mensalidade_segurado.ie_rescisao_proporcional%type) AS $body$
DECLARE


dt_referencia_w		pls_mensalidade_segurado.dt_mesano_referencia%type;
qt_preco_pre_w		integer;

BEGIN
if (ie_rescisao_proporcional_p = 'N') and (nr_parcela_p > 1) then --Se a mensalidade for de rescisao proporcional, o valor vai ser menor entao nao faz sentido gerar a critica
	if (vl_pre_estabelecido_p = 0) then
		select	count(1)
		into STRICT	qt_preco_pre_w
		from	pls_mensalidade_seg_item
		where	nr_seq_mensalidade_seg	= nr_seq_mensalidade_seg_p
		and	ie_tipo_item = '1';
	else
		qt_preco_pre_w	:= 1;
	end if;
	
	if (qt_preco_pre_w > 0) and (vl_pre_estabelecido_p < vl_pre_estabelecido_ant_p) then
		CALL pls_mens_criticas_pck.add_critica(nr_seq_mensalidade_seg_p, 1);
	end if;
end if;
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_mens_criticas_pck.criticar_valor_menor ( nr_seq_mensalidade_seg_p pls_mensalidade_segurado.nr_sequencia%type, vl_pre_estabelecido_p pls_mensalidade_segurado.vl_pre_estabelecido%type, vl_pre_estabelecido_ant_p pls_mensalidade_segurado.vl_pre_estabelecido%type, nr_parcela_p pls_mensalidade_segurado.nr_parcela%type, ie_rescisao_proporcional_p pls_mensalidade_segurado.ie_rescisao_proporcional%type) FROM PUBLIC;
