-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_mens_criticas_pck.critica_sca_nao_gerado ( nr_seq_mensalidade_seg_p pls_mensalidade_segurado.nr_sequencia%type) AS $body$
DECLARE


nr_parcela_w		bigint;
qt_sca_mens_w		bigint;
ie_gerar_critica_w	varchar(1);
	
C01 CURSOR FOR
	SELECT	y.nr_parcela,
		y.nr_seq_vinculo_sca
	from	pls_mensalidade_seg_item x,
		pls_mensalidade_sca y
	where	x.nr_sequencia = y.nr_seq_item_mens
	and	x.nr_seq_mensalidade_seg = nr_seq_mensalidade_seg_p
	and	x.ie_tipo_item = '15'
	and	y.nr_parcela < 6;
	
BEGIN
ie_gerar_critica_w	:= 'N';

for r_c01_w in c01 loop
	begin

	nr_parcela_w		:= (r_c01_w.nr_parcela-1);
	
	if (ie_gerar_critica_w = 'N') then
		while(nr_parcela_w > 0) loop
			begin

			select	count(1)
			into STRICT	qt_sca_mens_w
			from	pls_mensalidade_sca a,
				pls_mensalidade_seg_item b,
				pls_mensalidade_segurado c,
				pls_mensalidade d
			where	d.nr_sequencia 	= c.nr_seq_mensalidade
			and	c.nr_sequencia 	= b.nr_seq_mensalidade_seg
			and	b.nr_sequencia 	= a.nr_seq_item_mens
			and	a.nr_parcela 	= nr_parcela_w
			and	a.nr_seq_vinculo_sca = r_c01_w.nr_seq_vinculo_sca
			and	coalesce(d.ie_cancelamento::text, '') = '';

			if (qt_sca_mens_w = 0) then
				ie_gerar_critica_w	:= 'S';
				nr_parcela_w		:= 0;
			else
				nr_parcela_w 		:= nr_parcela_w - 1;
			end if;
			
			end;
		end loop;
	end if;
	end;
end loop;

if (ie_gerar_critica_w = 'S') then
	CALL pls_mens_criticas_pck.add_critica(nr_seq_mensalidade_seg_p, 8);
end if;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_mens_criticas_pck.critica_sca_nao_gerado ( nr_seq_mensalidade_seg_p pls_mensalidade_segurado.nr_sequencia%type) FROM PUBLIC;
