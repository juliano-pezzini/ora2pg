-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE tws_user_health_prof_pck.generate_user_results_portal ( cd_pessoa_fisica_p pessoa_fisica.cd_pessoa_fisica%type, ds_email_p compl_pessoa_fisica.ds_email%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, cd_convenio_p convenio.cd_convenio%type, cd_categoria_p categoria_convenio.cd_categoria%type, cd_procedencia_p procedencia.cd_procedencia%type, nm_usuario_web_p wsuite_usuario.nm_usuario_web%type, ie_origem_usuario_p lab_usuario_tipo_login_web.ie_origem_usuario%type, ie_gerencia_usuario_p text, nm_usuario_p usuario.nm_usuario%type, nr_seq_wsuite_usuario_p INOUT wsuite_usuario.nr_sequencia%type) AS $body$
DECLARE


							
C01 CURSOR FOR
 	SELECT	a.id id_application,
			(SELECT d.id from datasource d where  d.nm_datasource = 'WTASY' and d.id_application = a.id) id_data_source,
			(select c.id from client c where  c.nm_client = 'resultsportal' and c.id_application = a.id) id_client,
			(select r.id from role r where  r.nm_role = 'resultsportal' and r.id_application = a.id) id_role,
			psa_uuid_generator id_sub_datasource,
			psa_uuid_generator id_subject_client
	from	application a
	where   	nm_application = 'websuite';
	

ie_tipo_login_w			lab_usuario_tipo_login_web.ie_tipo_login %type := 2;
nr_seq_usuario_lab_w		lab_usuario_tipo_login_web.nr_sequencia%type;
ds_login_w				wsuite_usuario.ds_login%type;
id_subject_w				wsuite_usuario.id_subject%type;
application_w				application.id%type;
ds_hash_w				wsuite_usuario.ds_hash_ativacao%type;
nm_pessoa_fisica_w		pessoa_fisica.nm_pessoa_fisica%type;
nm_usuario_web_w		wsuite_usuario.nm_usuario_web%type;

BEGIN

select	count(1)
into STRICT		application_w			
from	application a
where   	nm_application = 'websuite';


if (application_w = 0 ) then
	/* Application not found */

	CALL wheb_mensagem_pck.exibir_mensagem_abort(1133810);
end if;


if (cd_procedencia_p IS NOT NULL AND cd_procedencia_p::text <> '') then
	ie_tipo_login_w  := 4;	
elsif (cd_categoria_p IS NOT NULL AND cd_categoria_p::text <> '') then
	ie_tipo_login_w  := 3;
end if;



if (  (nm_usuario_web_p IS NOT NULL AND nm_usuario_web_p::text <> '') and (cd_pessoa_fisica_p IS NOT NULL AND cd_pessoa_fisica_p::text <> '') and (ds_email_p IS NOT NULL AND ds_email_p::text <> '') and ( (cd_convenio_p IS NOT NULL AND cd_convenio_p::text <> '') or (cd_procedencia_p IS NOT NULL AND cd_procedencia_p::text <> '') ) ) then

	nm_usuario_web_w := upper(replace(nm_usuario_web_p, ' ', ''));
	
	
	insert into lab_usuario_tipo_login_web(
		     cd_categoria,   cd_convenio,   cd_procedencia,   
		     dt_atualizacao,   dt_atualizacao_nrec,   
		     ie_situacao,   nm_usuario,   nm_usuario_nrec,   
		     ie_tipo_login,  ie_origem_usuario , nr_sequencia  	     
         ) values (   
		    cd_categoria_p,  cd_convenio_p,   cd_procedencia_p,   
		    clock_timestamp(),   clock_timestamp(),   
		     'A',   nm_usuario_p,   nm_usuario_p,   
		      ie_tipo_login_w, ie_origem_usuario_p, nextval('lab_usuario_tipo_login_web_seq') ) returning nr_sequencia into nr_seq_usuario_lab_w;
		
	select 	'TWS-' || SUBSTR('00000000000' || to_char(nextval('tws_dslogin_sequence')),-11,11)  ds_login ,
			psa_uuid_generator,
			(select nm_pessoa_fisica from pessoa_fisica where cd_pessoa_fisica = cd_pessoa_fisica_p)
	into STRICT 		ds_login_w,
			id_subject_w,
			nm_pessoa_fisica_w
	;
		
	ds_hash_w := wsuite_login_pck.wsuite_generate_hash;
		
	 insert into subject(id,  ds_alternative_login,   ds_email, 
                     ds_login,  ds_password,   ds_replacement_login, 
                     ds_salt,   dt_creation,    dt_modification, 
                     dt_password_modification,   nm_subject,   vl_auth_type,   vl_password_style) 
        values ( id_subject_w,    ds_login_w,   ds_email_p, 
                     ds_login_w,  psa_uuid_generator,   nm_usuario_web_w, 
                     null,   clock_timestamp(),   clock_timestamp(), 
                     clock_timestamp(),   nm_pessoa_fisica_w,   0,  1 );
		     
		     
	insert into wsuite_usuario(nr_sequencia,   ie_situacao,  cd_estabelecimento, 
			nm_usuario_web,   cd_pessoa_fisica,  dt_atualizacao, 
			nm_usuario,  dt_atualizacao_nrec,   nm_usuario_nrec, 
			id_subject,  ds_login,  ds_hash_ativacao, 
			dt_criacao,  ds_alternative_login, nr_seq_lab_usuario_web,
			ds_email) 
        values ( 	nextval('wsuite_usuario_seq'),  'I',  cd_estabelecimento_p,
                        nm_usuario_web_w,  cd_pessoa_fisica_p,  clock_timestamp(), 
			nm_usuario_p, clock_timestamp(),  nm_usuario_p, 
                        id_subject_w,  ds_login_w,  ds_hash_w, 
                        clock_timestamp(),  ds_login_w, nr_seq_usuario_lab_w,
			ds_email_p)  returning nr_sequencia into nr_seq_wsuite_usuario_p;
	
	
	if ( ie_gerencia_usuario_p = 'S' ) then
		
		insert into	wsuite_param_usuario(
					nr_sequencia, dt_atualizacao, dt_atualizacao_nrec,
					nm_usuario, nm_usuario_nrec, cd_funcao,
					nr_seq_funcao_param, vl_parametro, nr_seq_usuario_wsuite,
					ie_tipo_login, cd_estabelecimento, ds_login)
			values ( 	nextval('wsuite_param_usuario_seq'), clock_timestamp(), clock_timestamp(),
					nm_usuario_p, nm_usuario_p, 9125,
					5, 'S', nr_seq_wsuite_usuario_p,
					'7', cd_estabelecimento_p, ds_login_w);
	end if;
	
	for c01_w in C01 loop
		
		insert into subject_datasource(dt_creation,  dt_modification,    id,
				id_datasource,   id_subject,   vl_activation_status, 
				vl_attempts_so_far) 
		values ( 	clock_timestamp(), clock_timestamp(),  c01_w.id_sub_datasource, 
				c01_w.id_data_source,  id_subject_w,  0, 
				0 );
				
		insert into application_subject(id_application,  id_subject) 
		values ( 	c01_w.id_application, id_subject_w );
				
		 insert into subject_client(id, id_subject,  id_client, 
				dt_creation,  dt_modification,  vl_activation_status, 
				vl_attempts_so_far) 
		values ( 	c01_w.id_subject_client, id_subject_w, c01_w.id_client, 
				clock_timestamp(),  clock_timestamp(),  0, 
				0 );
		
		insert into subject_role(id_subject,  id_role,   dt_creation,
				dt_modification) 
		values ( 	id_subject_w, c01_w.id_role,  clock_timestamp(), 
				clock_timestamp() );
		
		commit;
		
	end loop;
end if;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE tws_user_health_prof_pck.generate_user_results_portal ( cd_pessoa_fisica_p pessoa_fisica.cd_pessoa_fisica%type, ds_email_p compl_pessoa_fisica.ds_email%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, cd_convenio_p convenio.cd_convenio%type, cd_categoria_p categoria_convenio.cd_categoria%type, cd_procedencia_p procedencia.cd_procedencia%type, nm_usuario_web_p wsuite_usuario.nm_usuario_web%type, ie_origem_usuario_p lab_usuario_tipo_login_web.ie_origem_usuario%type, ie_gerencia_usuario_p text, nm_usuario_p usuario.nm_usuario%type, nr_seq_wsuite_usuario_p INOUT wsuite_usuario.nr_sequencia%type) FROM PUBLIC;
