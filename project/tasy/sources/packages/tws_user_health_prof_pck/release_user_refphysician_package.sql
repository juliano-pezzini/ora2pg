-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE tws_user_health_prof_pck.release_user_refphysician ( nr_seq_solic_inclusao_p wsuite_solic_inclusao_pf.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, ie_medico_liberado_p INOUT text) AS $body$
DECLARE

					
cd_pessoa_medico_w	pessoa_fisica.cd_pessoa_fisica%type;
cd_espec_medico_w	medico_especialidade.cd_especialidade%type;
nr_crm_w		medico.nr_crm%type;
uf_crm_w		medico.uf_crm%type;
cd_especialidade_w	medico_especialidade.cd_especialidade%type;
nm_pessoa_fisica_w	pessoa_fisica.nm_pessoa_fisica%type;
cd_pessoa_fisica_w	medico.cd_pessoa_fisica%type;
nr_seq_wsuite_usuario_w	wsuite_usuario.nr_sequencia%type;



BEGIN
	if (nr_seq_solic_inclusao_p IS NOT NULL AND nr_seq_solic_inclusao_p::text <> '') then
		select 	a.nr_crm,
			a.uf_crm,
			a.cd_especialidade,
			obter_nome_pf(a.cd_pessoa_fisica),
			a.cd_pessoa_fisica,
			b.nr_sequencia
		into STRICT	nr_crm_w,		
			uf_crm_w,		
			cd_especialidade_w,	
			nm_pessoa_fisica_w,
			cd_pessoa_fisica_w,
			nr_seq_wsuite_usuario_w			
		from	wsuite_solic_inclusao_pf a,
			wsuite_usuario b
		where	b.nr_seq_inclusao_pf = a.nr_sequencia
		and	a.nr_sequencia = nr_seq_solic_inclusao_p;
	end if;

	if (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '' AND nr_crm_w IS NOT NULL AND nr_crm_w::text <> '') then		
		select	max(cd_pessoa_fisica)
		into STRICT	cd_pessoa_medico_w
		from	medico
		where	cd_pessoa_fisica = cd_pessoa_fisica_w;		
	
		if ( coalesce(cd_pessoa_medico_w::text, '') = '' ) then

			/* If not exists a physician with the same person code, insert it */

			insert into medico(
				cd_pessoa_fisica,nr_crm,uf_crm,
				nm_guerra, ie_vinculo_medico, ie_corpo_assist,
				ie_corpo_clinico, dt_atualizacao,   nm_usuario,
				dt_atualizacao_nrec, nm_usuario_nrec,ie_situacao)
			values (	cd_pessoa_fisica_w, nr_crm_w, uf_crm_w,
				nm_pessoa_fisica_w, 14, 'N',
				'N', clock_timestamp(),nm_usuario_p,
				clock_timestamp(), nm_usuario_p,'A');
		
		end if;
		
		if (cd_especialidade_w IS NOT NULL AND cd_especialidade_w::text <> '') then
			
			select	max(cd_especialidade)
			into STRICT	cd_espec_medico_w
			from	medico_especialidade
			where	cd_pessoa_fisica = cd_pessoa_fisica_w
			and 	cd_especialidade = cd_especialidade_w;
					
			if ( coalesce(cd_espec_medico_w::text, '') = '' ) then
				
				/* Inserting the new speciality on an existing physician, if it's not yet in his list */

				insert into medico_especialidade(
					cd_pessoa_fisica,cd_especialidade,dt_atualizacao,
					nm_usuario,nr_seq_prioridade)
				values (cd_pessoa_fisica_w,cd_especialidade_w,	clock_timestamp(),
					nm_usuario_p,100);													
			end if;
		end if;			
		
		update	wsuite_usuario
		set	cd_pessoa_fisica = cd_pessoa_fisica_w,
			dt_ativacao = clock_timestamp(),
			ie_situacao = 'A',
			nm_usuario = nm_usuario_p,
			dt_atualizacao = clock_timestamp()
		where	nr_sequencia = nr_seq_wsuite_usuario_w;
				
		update    wsuite_solic_inclusao_pf
		set		ie_status = 2,
				dt_atualizacao = clock_timestamp(),
				nm_usuario = nm_usuario_p
		where	nr_sequencia = nr_seq_solic_inclusao_p;
		
		ie_medico_liberado_p := 'S';		
		
		commit;
	end if;	
	
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE tws_user_health_prof_pck.release_user_refphysician ( nr_seq_solic_inclusao_p wsuite_solic_inclusao_pf.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, ie_medico_liberado_p INOUT text) FROM PUBLIC;
