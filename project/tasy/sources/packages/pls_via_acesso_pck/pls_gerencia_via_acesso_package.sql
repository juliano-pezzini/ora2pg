-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_via_acesso_pck.pls_gerencia_via_acesso ( nr_seq_conta_p pls_conta.nr_sequencia%type, nr_seq_conta_proc_p pls_conta_proc.nr_sequencia%type, cd_acao_analise_p pls_acao_analise.cd_acao%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) AS $body$
DECLARE


dados_conta_w			pls_via_acesso_pck.dados_conta;
dados_conta_proc_w		pls_via_acesso_pck.dados_conta_proc;
nr_seq_regra_via_w		pls_regra_via_acesso.nr_sequencia%type;
ie_via_obrigatoria_w		pls_conta_proc.ie_via_obrigatoria%type;
ie_recalcula_valorizacao_w	varchar(1);
qt_regra_via_acesso_obr_w	integer;

--Irá buscar os procedimentos vínculados
C01 CURSOR(	cd_guia_referencia_pc	pls_conta.cd_guia_referencia%type,
		nr_seq_segurado_pc	pls_segurado.nr_sequencia%type)FOR
	SELECT	a.nr_sequencia,
		a.cd_procedimento,
		a.ie_origem_proced,
		a.ie_tipo_despesa,
		a.ie_via_acesso,
		a.qt_procedimento_imp,
		a.hr_inicio_proc,
		a.hr_fim_proc,
		a.dt_procedimento_trunc,
		a.cd_especialidade,
		a.cd_area_procedimento,
		a.cd_grupo_proc,
		a.nr_seq_participante_hi,
		a.ie_tipo_guia,
		a.nr_seq_conta,
		a.cd_medico_executor,
		a.nr_seq_grau_partic,
		a.nr_seq_prestador_prot
	from	pls_conta_proc_v	a
	where	a.cd_guia_referencia 	= cd_guia_referencia_pc
	and	a.nr_seq_segurado	= nr_seq_segurado_pc;
	
--Irá buscar a conta no caso da consistência ou todas as contas vínculadas no caso de atualização
C02 CURSOR(	cd_guia_referencia_pc		pls_conta.cd_guia_referencia%type,
		nr_seq_segurado_pc		pls_segurado.nr_sequencia%type,
		nr_seq_conta_pc			pls_conta_v.nr_sequencia%type,
		ie_recalcula_valorizacao_pc	text)FOR
	SELECT	nr_sequencia
	from	pls_conta_v
	where	cd_guia_referencia 	= cd_guia_referencia_pc
	and	nr_seq_segurado	= nr_seq_segurado_pc
	and	ie_recalcula_valorizacao_pc	= 'S'
	
union

	SELECT	nr_sequencia
	from	pls_conta
	where	nr_sequencia = nr_seq_conta_pc
	order by nr_sequencia;
BEGIN
-- isso existe aqui pelo único motivo que foi decidido que a via de acesso precisaria ser calculada no momento destas ações
--segundo relatos, inclusive a pedido do Adriano Geyer
-- são ações que acontecem dentro da análise de contas médicas
if (cd_acao_analise_p in (1, 2, 3, 4, 5)) then
	ie_recalcula_valorizacao_w := 'S';
else
	ie_recalcula_valorizacao_w := 'N';
end if;

--Busca apenas os dados genéricos da conta que serão comuns para todas as contas do atendimento
select	a.cd_guia_referencia,
	a.cd_guia,
	a.nr_seq_segurado,
	a.ie_origem_conta,
	a.nr_seq_analise,
	a.nr_sequencia
into STRICT	dados_conta_w.cd_guia_referencia,
	dados_conta_w.cd_guia,
	dados_conta_w.nr_seq_segurado,
	dados_conta_w.ie_origem_conta,
	dados_conta_w.nr_seq_analise,
	dados_conta_w.nr_seq_conta
from	pls_conta_v		a
where	a.nr_sequencia	= nr_seq_conta_p;

-- faz a atualização das taxas
CALL pls_via_acesso_pck.pls_atualiza_tx_via_acesso( 	dados_conta_w, nr_seq_conta_proc_p, cd_estabelecimento_p,nm_usuario_p);

select	count(1)
into STRICT	qt_regra_via_acesso_obr_w
from	pls_regra_via_acesso
where	ie_situacao	= 'A';

--Irá atualizar o procedimento de referência do atendimento e após este processo irá verificar a obrigatoriedade da via de acesso para o procedimento
for r_C01_w in C01(dados_conta_w.cd_guia_referencia, dados_conta_w.nr_seq_segurado) loop
	begin
	dados_conta_proc_w.cd_procedimento	:= r_C01_w.cd_procedimento;
	dados_conta_proc_w.ie_origem_proced 	:= r_C01_w.ie_origem_proced;
	dados_conta_proc_w.nr_seq_conta_proc	:= r_C01_w.nr_sequencia;
	dados_conta_proc_w.ie_tipo_despesa	:= r_C01_w.ie_tipo_despesa;
	dados_conta_proc_w.ie_via_acesso	:= r_C01_w.ie_via_acesso;
	dados_conta_proc_w.qt_procedimento	:= r_C01_w.qt_procedimento_imp;
	dados_conta_proc_w.dt_procedimento	:= r_C01_w.dt_procedimento_trunc;
	dados_conta_proc_w.hr_inicio_proc	:= r_C01_w.hr_inicio_proc;
	dados_conta_proc_w.hr_fim_proc		:= r_C01_w.hr_fim_proc;
	dados_conta_proc_w.cd_especialidade	:= r_C01_w.cd_especialidade;
	dados_conta_proc_w.cd_area_procedimento	:= r_C01_w.cd_area_procedimento;
	dados_conta_proc_w.cd_grupo_proc	:= r_C01_w.cd_grupo_proc;
	dados_conta_proc_w.cd_guia_referencia	:= dados_conta_w.cd_guia_referencia;
	dados_conta_proc_w.nr_seq_segurado	:= dados_conta_w.nr_seq_segurado;
	dados_conta_proc_w.cd_guia		:= dados_conta_w.cd_guia;
	dados_conta_proc_w.nr_seq_participante_hi := r_C01_w.nr_seq_participante_hi;
	dados_conta_proc_w.ie_tipo_guia		:= r_C01_w.ie_tipo_guia;
	dados_conta_proc_w.nr_seq_conta		:= r_C01_w.nr_seq_conta;
	dados_conta_w.ie_tipo_guia		:= r_C01_w.ie_tipo_guia;
	dados_conta_w.cd_medico_executor	:= r_C01_w.cd_medico_executor;
	dados_conta_w.nr_seq_grau_partic	:= r_C01_w.nr_seq_grau_partic;
	dados_conta_w.nr_seq_prestador_prot	:= r_C01_w.nr_seq_prestador_prot;
	dados_conta_w.nr_seq_conta		:= r_C01_w.nr_seq_conta;
	-- Atualiza o procedimento referência
	pls_atualiza_proc_referencia(dados_conta_proc_w,  cd_estabelecimento_p, nm_usuario_p );
	-- Verifica a obrigatoriedade da via de acesso para o procedimento
	if (qt_regra_via_acesso_obr_w > 0) then
		CALL pls_via_acesso_pck.pls_verifica_obrig_via_acesso(	dados_conta_w, dados_conta_proc_w, nm_usuario_p,
						cd_estabelecimento_p);
	end if;
	end;
end loop;
--Irá aplicar a via de acesso caso exista regra para a mesma em OPS - Cadastro de Regras > Contas médicas > Via acesso > Procediento X Via acesso
--Conforme o parametro ie_recalcula_valorizacao_w o cursor 2 será executado sobre a conta quando da consistência da mesma ou se a atualziação irá ocorrer sobre toda a análise
if (qt_regra_via_acesso_obr_w > 0) then
	for r_C02_w in C02(	dados_conta_w.cd_guia_referencia, dados_conta_w.nr_seq_segurado,
				nr_seq_conta_p, ie_recalcula_valorizacao_w) loop
		begin
		dados_conta_w.cd_medico_executor	:= null;
		dados_conta_w.nr_seq_grau_partic	:= null;
		dados_conta_w.nr_seq_conta		:= r_C02_w.nr_sequencia;
		CALL pls_via_acesso_pck.pls_aplicar_via_acesso_conta(dados_conta_w, nm_usuario_p, cd_estabelecimento_P);
		-- se for para recalcular a valorização
		if (ie_recalcula_valorizacao_w = 'S') then
			CALL pls_recalcular_conta( r_C02_w.nr_sequencia, nm_usuario_p, 'G', 'S', 'N', null, null);
			CALL pls_atualiza_lib_conta(r_C02_w.nr_sequencia,'A',nm_usuario_p);
		end if;
		end;
	end loop;
end if;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_via_acesso_pck.pls_gerencia_via_acesso ( nr_seq_conta_p pls_conta.nr_sequencia%type, nr_seq_conta_proc_p pls_conta_proc.nr_sequencia%type, cd_acao_analise_p pls_acao_analise.cd_acao%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) FROM PUBLIC;
