-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pls_via_acesso_pck.pls_obter_restricao_via ( ie_opcao_p text, dados_regra_p pls_via_acesso_pck.dados_regra, cursor_p integer, dados_conta_proc_p pls_via_acesso_pck.dados_conta_proc, dados_conta_p pls_via_acesso_pck.dados_conta, ie_tipo_item_p text) RETURNS varchar AS $body$
DECLARE

/*ie_tipo_item_p
CP - conta proc
P - Participante*/
ds_restricao_w		varchar(4000);

BEGIN

if (dados_conta_proc_p.hr_inicio_proc IS NOT NULL AND dados_conta_proc_p.hr_inicio_proc::text <> '') then
	if (ie_opcao_p = 'RESTRICAO') then
		if (ie_tipo_item_p	= 'CP') then
			ds_restricao_w	:= ds_restricao_w||' and	cp.hr_inicio_proc	= :hr_inicio_proc_p '  || pls_tipos_ocor_pck.enter_w;
		else
			ds_restricao_w := ds_restricao_w||' and	ccp.hr_inicio_proc	= :hr_inicio_proc_p '  || pls_tipos_ocor_pck.enter_w;
		end if;
	else
		dbms_sql.bind_variable(cursor_p, ':hr_inicio_proc_p', dados_conta_proc_p.hr_inicio_proc);
	end if;
else
	if (ie_tipo_item_p	= 'CP') then
		ds_restricao_w	:= ds_restricao_w||' and	cp.hr_inicio_proc	is null '  || pls_tipos_ocor_pck.enter_w;
	else
		ds_restricao_w	:= ds_restricao_w||' and	ccp.hr_inicio_proc	is null '  || pls_tipos_ocor_pck.enter_w;
	end if;
end if;

if (dados_conta_proc_p.hr_fim_proc IS NOT NULL AND dados_conta_proc_p.hr_fim_proc::text <> '') then
		
	if (ie_opcao_p = 'RESTRICAO') then
		if (ie_tipo_item_p	= 'CP') then
			ds_restricao_w	:= ds_restricao_w||' and	cp.hr_fim_proc		= :hr_fim_proc_p '  || pls_tipos_ocor_pck.enter_w;
		else
			ds_restricao_w := ds_restricao_w||' and	ccp.hr_fim_proc	= :hr_fim_proc_p  '  || pls_tipos_ocor_pck.enter_w;
		end if;
	else
		dbms_sql.bind_variable(cursor_p, ':hr_fim_proc_p', dados_conta_proc_p.hr_fim_proc);
	end if;
else
	if (ie_tipo_item_p	= 'CP') then
		ds_restricao_w	:= ds_restricao_w||' and	cp.hr_fim_proc		is null '  || pls_tipos_ocor_pck.enter_w;
	else
		ds_restricao_w	:= ds_restricao_w||' and	ccp.hr_fim_proc		is null '  || pls_tipos_ocor_pck.enter_w;
	end if;
end if;

if (dados_regra_p.nr_seq_grupo_servico IS NOT NULL AND dados_regra_p.nr_seq_grupo_servico::text <> '') then
	if (ie_opcao_p	= 'RESTRICAO') then	
		if (ie_tipo_item_p	= 'CP') then
			ds_restricao_w := ds_restricao_w ||
				' and exists (	select	1						      '	|| pls_tipos_ocor_pck.enter_w ||
				'		from	pls_proc_grup_serv_v 	grupo                         ' || pls_tipos_ocor_pck.enter_w ||	
				'		where	grupo.nr_seq_grupo 	= :nr_seq_grupo_p             '	|| pls_tipos_ocor_pck.enter_w ||
				'		and	grupo.ie_origem_proced 	= cp.ie_origem_proced         ' || pls_tipos_ocor_pck.enter_w ||
				'		and	grupo.cd_procedimento 	= cp.cd_procedimento ) 	      ' || pls_tipos_ocor_pck.enter_w;	
		else
			ds_restricao_w := ds_restricao_w ||
				' and exists (	select	1						      '	|| pls_tipos_ocor_pck.enter_w ||
				'		from	pls_proc_grup_serv_v 	grupo                         ' || pls_tipos_ocor_pck.enter_w ||	
				'		where	grupo.nr_seq_grupo 	= :nr_seq_grupo_p             '	|| pls_tipos_ocor_pck.enter_w ||
				'		and	grupo.ie_origem_proced 	= ccp.ie_origem_proced        ' || pls_tipos_ocor_pck.enter_w ||
				'		and	grupo.cd_procedimento 	= ccp.cd_procedimento )       ' || pls_tipos_ocor_pck.enter_w;	
		end if;
	else
		dbms_sql.bind_variable(cursor_p, ':nr_seq_grupo_p', dados_regra_p.nr_seq_grupo_servico);
	end if;	
end if;	

if (dados_regra_p.cd_grupo_proc IS NOT NULL AND dados_regra_p.cd_grupo_proc::text <> '') then
	if (ie_opcao_p = 'RESTRICAO') then
		if (ie_tipo_item_p	= 'CP') then
			ds_restricao_w	:= ds_restricao_w||'and cp.cd_grupo_proc	= :cd_grupo_proc_p '|| pls_tipos_ocor_pck.enter_w;
		else
			ds_restricao_w := ds_restricao_w||'and ccp.cd_grupo_proc	= :cd_grupo_proc_p '|| pls_tipos_ocor_pck.enter_w;
		end if;
	else
		dbms_sql.bind_variable(cursor_p, ':cd_grupo_proc_p',dados_regra_p.cd_grupo_proc);
	end if;
end if;

if (dados_regra_p.cd_especialidade IS NOT NULL AND dados_regra_p.cd_especialidade::text <> '') then
	if (ie_opcao_p = 'RESTRICAO') then	
		if (ie_tipo_item_p	= 'CP') then
			ds_restricao_w	:= ds_restricao_w||'and cp.cd_especialidade	= :cd_especialidade_p '|| pls_tipos_ocor_pck.enter_w;
		else
			ds_restricao_w := ds_restricao_w||'and ccp.cd_especialidade = :cd_especialidade_p '|| pls_tipos_ocor_pck.enter_w;
		end if;
	else
		dbms_sql.bind_variable(cursor_p, ':cd_especialidade_p',dados_regra_p.cd_especialidade);
	end if;
end if;

if (dados_regra_p.cd_area_procedimento IS NOT NULL AND dados_regra_p.cd_area_procedimento::text <> '') then
	if (ie_opcao_p = 'RESTRICAO') then		
		if (ie_tipo_item_p	= 'CP') then
			ds_restricao_w	:= ds_restricao_w||'and cp.cd_area_procedimento	= :cd_area_procedimento_p '|| pls_tipos_ocor_pck.enter_w;
		else
			ds_restricao_w := ds_restricao_w||'and ccp.cd_area_procedimento	= :cd_area_procedimento_p '|| pls_tipos_ocor_pck.enter_w;
		end if;
	else
		dbms_sql.bind_variable(cursor_p, ':cd_area_procedimento_p',dados_regra_p.cd_area_procedimento);
	end if;
end if;

if (dados_regra_p.cd_procedimento IS NOT NULL AND dados_regra_p.cd_procedimento::text <> '') then
	if (ie_opcao_p = 'RESTRICAO') then
		if (ie_tipo_item_p	= 'CP') then
			ds_restricao_w	:= ds_restricao_w||'and (cp.cd_procedimento	= :cd_procedimento_p and cp.ie_origem_proced = :ie_origem_proced_p ) '|| pls_tipos_ocor_pck.enter_w;
		else
			ds_restricao_w := ds_restricao_w||'and (ccp.cd_procedimento	= :cd_procedimento_p and ccp.ie_origem_proced = :ie_origem_proced_p ) '|| pls_tipos_ocor_pck.enter_w;
		end if;
	else
		dbms_sql.bind_variable(cursor_p, ':cd_procedimento_p',dados_regra_p.cd_procedimento);
		dbms_sql.bind_variable(cursor_p, ':ie_origem_proced_p',dados_regra_p.ie_origem_proced);
	end if;
end if;

if (dados_regra_p.nr_seq_prestador IS NOT NULL AND dados_regra_p.nr_seq_prestador::text <> '') then
	if (ie_opcao_p = 'RESTRICAO') then	
		if (ie_tipo_item_p	= 'CP') then
			ds_restricao_w	:= ds_restricao_w||'and cp.nr_seq_prestador_prot	= :nr_seq_prestador_p '|| pls_tipos_ocor_pck.enter_w;
		else
			ds_restricao_w := ds_restricao_w||'and ccp.nr_seq_prestador_prot	= :nr_seq_prestador_p '|| pls_tipos_ocor_pck.enter_w;
		end if;
	else
		dbms_sql.bind_variable(cursor_p, ':nr_seq_prestador_p',dados_regra_p.nr_seq_prestador);
	end if;
end if;

if (dados_regra_p.ie_regra	= 'M') then
	if (ie_opcao_p = 'RESTRICAO') then	
		ds_restricao_w	:= ds_restricao_w||' and	cp.cd_medico_executor	= :cd_medico_executor_p '  || pls_tipos_ocor_pck.enter_w;
	else
		dbms_sql.bind_variable(cursor_p, ':cd_medico_executor_p', dados_conta_p.cd_medico_executor);
	end if;
elsif (dados_regra_p.ie_regra	= 'MP') then
	if (ie_opcao_p = 'RESTRICAO') then		
		ds_restricao_w	:= ds_restricao_w||' and	cp.cd_medico_executor	= :cd_medico_executor_p and cp.nr_seq_grau_partic	= :nr_seq_grau_partic_p'  || pls_tipos_ocor_pck.enter_w;
	else
		dbms_sql.bind_variable(cursor_p, ':cd_medico_executor_p', dados_conta_p.cd_medico_executor);
		dbms_sql.bind_variable(cursor_p, ':nr_seq_grau_partic_p', dados_conta_p.nr_seq_grau_partic);
	end if;
elsif (dados_regra_p.ie_regra	= 'MG') then
	if (ie_opcao_p = 'RESTRICAO') then	
		ds_restricao_w	:= ds_restricao_w||' and	(cp.ie_tipo_guia	in (''5'',''6'') or cp.ie_tipo_guia = :ie_tipo_guia_p) '  || pls_tipos_ocor_pck.enter_w;
	else
		dbms_sql.bind_variable(cursor_p, ':ie_tipo_guia_p', dados_conta_p.ie_tipo_guia);
	end if;
end if;

return	ds_restricao_w;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pls_via_acesso_pck.pls_obter_restricao_via ( ie_opcao_p text, dados_regra_p pls_via_acesso_pck.dados_regra, cursor_p integer, dados_conta_proc_p pls_via_acesso_pck.dados_conta_proc, dados_conta_p pls_via_acesso_pck.dados_conta, ie_tipo_item_p text) FROM PUBLIC;
