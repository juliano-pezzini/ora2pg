-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pls_coparticipacao_pck.obter_se_mat_tipo_copartic ( nr_seq_tipo_coparticipacao_p pls_tipo_coparticipacao.nr_sequencia%type, nr_seq_material_p pls_material.nr_sequencia%type) RETURNS varchar AS $body$
DECLARE

 
		ie_liberado_w			varchar(1) := 'N';
		ie_estrut_mat_w			varchar(1);
		ie_tipo_despesa_w		pls_material.ie_tipo_despesa%type;
		
		coparticipacoes_material CURSOR FOR 
			SELECT	b.nr_seq_estrut_mat, 
				b.ie_liberado 
			from	pls_tipo_coparticipacao		a, 
				pls_coparticipacao_mat		b 
			where	a.nr_sequencia						= b.nr_seq_tipo_coparticipacao 
			and	a.nr_sequencia						= nr_seq_tipo_coparticipacao_p 
			and	coalesce(b.nr_seq_material, nr_seq_material_p)		= nr_seq_material_p 
			and	((coalesce(b.ie_tipo_despesa, ie_tipo_despesa_w)		= ie_tipo_despesa_w) or (coalesce(b.ie_tipo_despesa::text, '') = '' and coalesce(ie_tipo_despesa_w::text, '') = '')) 
			and	a.ie_situacao	= 'A';
	
BEGIN
		select	max(ie_tipo_despesa) 
		into STRICT	ie_tipo_despesa_w 
		from	pls_material 
		where	nr_sequencia = nr_seq_material_p;
		 
		for coparticipacoes_material_w in coparticipacoes_material loop 
			 
			ie_estrut_mat_w	:= 'S';
			 
			if (coparticipacoes_material_w.nr_seq_estrut_mat IS NOT NULL AND coparticipacoes_material_w.nr_seq_estrut_mat::text <> '') then 
				ie_estrut_mat_w := pls_obter_se_mat_estrutura(nr_seq_material_p, coparticipacoes_material_w.nr_seq_estrut_mat);
			end if;
			 
			if (ie_estrut_mat_w = 'S') then 
				ie_liberado_w	:= coparticipacoes_material_w.ie_liberado;
				if (ie_liberado_w = 'S') then 
					exit;
				end if;
			end if;
			 
		end loop;
		 
		return ie_liberado_w;
	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pls_coparticipacao_pck.obter_se_mat_tipo_copartic ( nr_seq_tipo_coparticipacao_p pls_tipo_coparticipacao.nr_sequencia%type, nr_seq_material_p pls_material.nr_sequencia%type) FROM PUBLIC;
