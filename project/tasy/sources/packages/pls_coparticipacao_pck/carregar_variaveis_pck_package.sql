-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

 
	 
	/*PLS_LIBERAR_REGRA_COPARTIC 
	Procedure externa não incluida nesta package devido a sua chamada ser feita pelo Delphi e Java e não por uma outra rotina. 
	Sempre que for feita uma alteração na estrutura das tabelas envolvidas com a regra de coparticipação deve ser verificada a "PLS_LIBERAR_REGRA_COPARTIC", 
	para que seja feita adição de novas consistências ou alterar as existentes caso necessário.*/
 
	 


CREATE OR REPLACE PROCEDURE pls_coparticipacao_pck.carregar_variaveis_pck (nr_seq_conta_p pls_conta.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
BEGIN
		PERFORM set_config('pls_coparticipacao_pck.nm_usuario_w', nm_usuario_p, false);
	 
		select	* 
		into STRICT	current_setting('pls_coparticipacao_pck.pls_conta_w')::pls_conta%rowtype 
		from	pls_conta 
		where	nr_sequencia = nr_seq_conta_p;
		 
		select	* 
		into STRICT	current_setting('pls_coparticipacao_pck.pls_protocolo_conta_w')::pls_protocolo_conta%rowtype 
		from	pls_protocolo_conta 
		where	nr_sequencia = current_setting('pls_coparticipacao_pck.pls_conta_w')::pls_conta%rowtype.nr_seq_protocolo;
		 
		if (current_setting('pls_coparticipacao_pck.pls_conta_w')::pls_conta%coalesce(rowtype.nr_seq_segurado::text, '') = '') then 
			CALL wheb_mensagem_pck.exibir_mensagem_abort(306392,'NR_SEQ_CONTA=' || current_setting('pls_coparticipacao_pck.pls_conta_w')::pls_conta%rowtype.nr_sequencia);
		else 
			select	* 
			into STRICT	current_setting('pls_coparticipacao_pck.pls_segurado_w')::pls_segurado%rowtype 
			from	pls_segurado 
			where	nr_sequencia = current_setting('pls_coparticipacao_pck.pls_conta_w')::pls_conta%rowtype.nr_seq_segurado;
		end if;
		 
		select	* 
		into STRICT	current_setting('pls_coparticipacao_pck.pls_parametros_w')::pls_parametros%rowtype 
		from	pls_parametros 
		where	cd_estabelecimento = current_setting('pls_coparticipacao_pck.pls_conta_w')::pls_conta%rowtype.cd_estabelecimento;
		 
		if (current_setting('pls_coparticipacao_pck.pls_segurado_w')::pls_segurado%(rowtype.nr_seq_contrato IS NOT NULL AND rowtype.nr_seq_contrato::text <> '')) then 
			select	* 
			into STRICT	current_setting('pls_coparticipacao_pck.pls_contrato_w')::pls_contrato%rowtype 
			from	pls_contrato 
			where	nr_sequencia = current_setting('pls_coparticipacao_pck.pls_segurado_w')::pls_segurado%rowtype.nr_seq_contrato;
		elsif (current_setting('pls_coparticipacao_pck.pls_segurado_w')::pls_segurado%(rowtype.nr_seq_intercambio IS NOT NULL AND rowtype.nr_seq_intercambio::text <> '')) then 
			select	* 
			into STRICT	current_setting('pls_coparticipacao_pck.pls_intercambio_w')::pls_intercambio%rowtype 
			from	pls_intercambio 
			where	nr_sequencia = current_setting('pls_coparticipacao_pck.pls_segurado_w')::pls_segurado%rowtype.nr_seq_intercambio;
		end if;
	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_coparticipacao_pck.carregar_variaveis_pck (nr_seq_conta_p pls_conta.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;
