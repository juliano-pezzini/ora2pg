-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_int_xml_cta_pck.pls_consistir_lote ( nr_seq_lote_protocolo_p pls_lote_protocolo_conta.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE


-- protocolos do lote

c01 CURSOR(	nr_seq_lote_protocolo_pc	pls_lote_protocolo_conta.nr_sequencia%type) FOR
	SELECT	a.nr_sequencia nr_seq_protocolo
	from	pls_protocolo_conta_imp	a
	where	a.nr_seq_lote_protocolo	= nr_seq_lote_protocolo_pc;

BEGIN

-- remove todas as ocorencias geradas para o lote

CALL pls_ocor_imp_pck.limpar_ocorrencias(nr_seq_lote_protocolo_p, null, null);

-- gera as ocorrencias combinadas

CALL pls_oc_cta_gerar_combinada_imp(	nr_seq_lote_protocolo_p, null, null,
				null, null, null,
				null, null, null,
				null, cd_estabelecimento_p, nm_usuario_p);

-- Navega pelos protocolos gerando o resumo e atualizando o status


for r_c01_w in c01(nr_seq_lote_protocolo_p) loop

	--gera o resumo de ocorr_ncias e contas do protocolo				

	CALL pls_conv_xml_cta_pck.pls_gerar_resumo_prot_imp(r_c01_w.nr_seq_protocolo,nm_usuario_p);
	
	--atualiza o status do protocolo para ACEITO

	CALL pls_int_xml_cta_pck.pls_atualiza_lote_prot_aceito(r_c01_w.nr_seq_protocolo, nm_usuario_p);
	
	-- verifica as ocorrencias ativas no protocolo

	CALL pls_int_xml_cta_pck.verifica_ocor_ativa_prot(r_c01_w.nr_seq_protocolo, nm_usuario_p);
	
	
end loop;

commit;
						
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_int_xml_cta_pck.pls_consistir_lote ( nr_seq_lote_protocolo_p pls_lote_protocolo_conta.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;
