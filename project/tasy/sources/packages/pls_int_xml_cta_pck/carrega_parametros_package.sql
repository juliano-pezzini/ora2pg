-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

-- controle para decidir quando o select para obten__o dos valores dos par_metros deve ser executado novamente



-- vari_veis que armazenam os valores dos par_metros




CREATE OR REPLACE PROCEDURE pls_int_xml_cta_pck.carrega_parametros ( cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) AS $body$
BEGIN
-- se a data da _ltima solicita__o n_o estiver registrada ou 

-- se j_ se passou 67 segundos deste a _ltima solicita__o ou

-- se a origem for diferente da _ltima solicitada ou

-- se o estabelecimento anterior for diferente do _ltimo solicitado

-- executa o comando para preencher os valores dos par_metros

if	((current_setting('pls_int_xml_cta_pck.dt_solicitacao_ult_w')::coalesce(timestamp::text, '') = '') or
	(current_setting('pls_int_xml_cta_pck.dt_solicitacao_ult_w')::timestamp <= (clock_timestamp() - interval '67 seconds')) or (coalesce(current_setting('pls_int_xml_cta_pck.cd_estabelecimento_ult_w')::estabelecimento.cd_estabelecimento%type, -1) != coalesce(cd_estabelecimento_p, -2))) then
	
	/*Leitura do par_metro [10] OPSW - Contas m_dicas - Ao confirmar a integra__o do protocolo, gravar a quantidade de contas no mesmo*/


	PERFORM set_config('pls_int_xml_cta_pck.ie_gravar_quantidade_w', pls_obter_param_padrao_funcao(10, 1249), false);
	
	--Obter se deve ou n_o permitir  que os protocolos sejam encaminhados automaticamente para a an_lise.

	select	coalesce(max(ie_analise_conta), 'N'),
		max(nr_sequencia)
	into STRICT	current_setting('pls_int_xml_cta_pck.ie_analise_conta_w')::pls_param_importacao_conta.ie_analise_conta%type,
		current_setting('pls_int_xml_cta_pck.nr_seq_param_analise_w')::pls_param_importacao_conta.nr_sequencia%type
	from	pls_param_importacao_conta
	where	cd_estabelecimento	= cd_estabelecimento_p;
	
	if (current_setting('pls_int_xml_cta_pck.ie_analise_conta_w')::pls_param_importacao_conta.ie_analise_conta%type = 'S') then
		select	count(1)
		into STRICT	current_setting('pls_int_xml_cta_pck.qt_regra_lib_analise_w')::bigint
		from	pls_regra_analise_imp_cta
		where	nr_seq_param_imp_conta	= current_setting('pls_int_xml_cta_pck.nr_seq_param_analise_w')::pls_param_importacao_conta.nr_sequencia%type
		and	trunc(clock_timestamp()) between trunc(dt_inicio_vigencia) and fim_dia(coalesce(dt_fim_vigencia,clock_timestamp()));
	end if;
	
	PERFORM set_config('pls_int_xml_cta_pck.cd_estabelecimento_ult_w', cd_estabelecimento_p, false);
	PERFORM set_config('pls_int_xml_cta_pck.dt_solicitacao_ult_w', clock_timestamp(), false);
end if;
	
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_int_xml_cta_pck.carrega_parametros ( cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) FROM PUBLIC;
