-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION vent_bundle_report_pck.get_ie_vte_rx (nr_atendimento_p bigint) RETURNS varchar AS $body$
DECLARE


	cd_cla_mat_w		bigint := 36;
	cd_cla_vte_dte_w	bigint := 36;
	nm_exame_w		exame_laboratorio.nm_exame%type := 'TRIGLICERIDEOS';
	pr_minimo_w		bigint := 40;
	pr_maximo_w		bigint := 160;
	ds_proc_ivc_filter_w	varchar(15) := 'FILT';
	ds_proc_compr_dev_w	varchar(15) := 'COMPRES';

	ds_retorno_w		varchar(15) := 'N';
	qt_reg_w		bigint;

	
BEGIN

	begin

		select  count(1)
		into STRICT	qt_reg_w
		from    atendimento_paciente a,
			prescr_medica b,
			prescr_procedimento c,
			exame_laboratorio e,
			exame_lab_result_item d
		where   a.nr_atendimento = b.nr_atendimento
		and     b.nr_prescricao = c.nr_prescricao
		and     c.nr_seq_exame = e.nr_seq_exame
		and     d.nr_seq_exame = e.nr_seq_exame
		and     a.nr_atendimento = nr_atendimento_p
		and     upper(e.nm_exame) like upper(nm_exame_w)
		and     ((d.pr_resultado < pr_minimo_w) or (d.pr_resultado > pr_maximo_w));
	exception
	when no_data_found then
		qt_reg_w := 0;
	end;

	if (qt_reg_w = 0) then

		begin

			select  count(1)
			into STRICT	qt_reg_w
			from    atendimento_paciente a,
				prescr_medica b,
				pe_prescricao c
			where   a.nr_atendimento = b.nr_atendimento
			and     b.nr_prescricao = c.nr_prescricao
			and     c.ie_tipo = 'SAE'
			and     a.nr_atendimento = nr_atendimento_p;

		exception
		when no_data_found then
			qt_reg_w := 0;
		end;

	end if;

	if (qt_reg_w > 0) then
		begin
		ds_retorno_w := 'NI';
		end;
	end if;

	if (ds_retorno_w = 'N') then

		begin
		
			select	count(1)
			into STRICT	qt_reg_w
			from	prescr_mat_alteracao pma,
				prescr_material pm,
				material m
			where	pm.nr_prescricao = pma.nr_prescricao
			and	m.cd_material = pm.cd_material
			and	(m.cd_medicamento IS NOT NULL AND m.cd_medicamento::text <> '')
			and	pma.nr_atendimento = nr_atendimento_p
			and	m.cd_classe_material in (cd_cla_mat_w);
		
		exception
		when no_data_found then
			qt_reg_w := 0;
		end;
		
		if (qt_reg_w > 0) then
			begin
			ds_retorno_w := 'NR';
			end;
		end if;

	end if;

	if (ds_retorno_w = 'N') then
		
		begin
			select	count(1)
			into STRICT	qt_reg_w
			from	prescr_mat_alteracao pma,
				prescr_material pm,
				material m
			where	pm.nr_prescricao = pma.nr_prescricao
			and	m.cd_material = pm.cd_material
			and	(m.cd_medicamento IS NOT NULL AND m.cd_medicamento::text <> '')
			and	pma.nr_atendimento = nr_atendimento_p
			and	m.cd_classe_material in (cd_cla_vte_dte_w);
		exception
		when no_data_found then
			qt_reg_w := 0;
		end;
		
		if (qt_reg_w = 0) then
			begin
			
			select	count(1)
			into STRICT	qt_reg_w
			from    atendimento_paciente a,
				prescr_medica b,
				prescr_procedimento c
			where   a.nr_atendimento = b.nr_atendimento
			and     b.nr_prescricao = c.nr_prescricao
			and (upper(obter_desc_procedimento(c.cd_procedimento, c.ie_origem_proced)) like upper('%'||ds_proc_ivc_filter_w||'%')
			or	upper(obter_desc_procedimento(c.cd_procedimento, c.ie_origem_proced)) like upper('%'||ds_proc_compr_dev_w||'%'))
			and     a.nr_atendimento = nr_atendimento_p;
			
			exception
			when no_data_found then
				qt_reg_w := 0;
			end;
		end if;
		
		if (qt_reg_w > 0) then
			begin
			ds_retorno_w := 'Y';
			end;
		end if;
		
	end if;

	return	ds_retorno_w;

	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION vent_bundle_report_pck.get_ie_vte_rx (nr_atendimento_p bigint) FROM PUBLIC;
