-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION localizar_medico_pck.obter_table_locmed_13156 ( NR_CRM_PX bigint DEFAULT NULL, DS_FONETICA_CNS_PX text DEFAULT NULL, CD_ESPECIALIDADE_PX text DEFAULT NULL, NM_PESSOA_FISICA_PX text DEFAULT NULL) RETURNS SETOF LOCALIZAR_PESSOA_MEDT AS $body$
DECLARE

  linha_w			localizar_pessoa_med;
  C02 CURSOR(NR_CRM_P           bigint := NULL,
              DS_FONETICA_CNS_P  text := NULL,
              CD_ESPECIALIDADE_P text := NULL,
              NM_PESSOA_FISICA_P text := NULL) FOR
    SELECT D.CD_PESSOA_FISICA,
          D.NM_PESSOA_FISICA,
          Y.DS_FONETICA,
          Y.DS_FONETICA_CNS,
          Y.NR_CRM,
          Y.NM_GUERRA,
          SUBSTR(OBTER_DESC_CAMPO_GRID(336203, coalesce(Y.IE_CORPO_CLINICO, 'N')), 1, 255) DS_CORPO_CLINICO,
          SUBSTR(OBTER_DESC_CAMPO_GRID(336203, coalesce(Y.IE_CORPO_ASSIST, 'N')), 1, 255 ) DS_CORPO_ASSIST,
          SUBSTR(obter_nome_pf(d.cd_pessoa_fisica), 1, 60) nm_pessoa_p,
          Y.NM_USUARIO,
          Y.DT_ATUALIZACAO,
          SUBSTR(OBTER_ESPECIALIDADES_MEDICO(D.CD_PESSOA_FISICA), 1, 255) CD_ESPECIALIDADE,
          SUBSTR(OBTER_VALOR_DOMINIO(3, Y.IE_VINCULO_MEDICO), 1, 120) DS_VINCULO,
          Y.IE_VINCULO_MEDICO,
          Y.NR_CPF,
          SUBSTR(OBTER_DESC_CATEG_MEDICO(Y.NR_SEQ_CATEGORIA), 1, 80) DS_CATEGORIA_MEDICO,
          Y.NR_SEQ_CATEGORIA,
          Y.NR_SEQ_CONSELHO,
          SUBSTR( coalesce( Y.UF_CRM, OBTER_COMPL_PF(Y.CD_PESSOA_FISICA, 1, 'UF')), 1, 2 ) UF_CRM,
          SUBSTR(OBTER_CONSELHO_PROFISSIONAL(Y.NR_SEQ_CONSELHO, 'S'), 1, 255) DS_CONSELHO,
          Y.NM_PESSOA_FISICA_SEM_ACENTO,
          Y.IE_CORPO_CLINICO
        FROM
          (SELECT A.CD_PESSOA_FISICA,
            A.DS_FONETICA,
            A.DS_FONETICA_CNS,
            B.NR_CRM,
            B.NM_GUERRA,
            B.IE_CORPO_CLINICO DS_CORPO_CLINICO,
            B.IE_CORPO_ASSIST,
            A.NM_USUARIO,
            A.DT_ATUALIZACAO,
            B.IE_VINCULO_MEDICO,
            A.NR_CPF,
            B.NR_SEQ_CATEGORIA,
            A.NR_SEQ_CONSELHO,
            B.UF_CRM,
            A.NM_PESSOA_FISICA_SEM_ACENTO,
            B.IE_CORPO_CLINICO
          FROM PESSOA_FISICA A,
            MEDICO B
          WHERE 1                     = 1
          AND A.CD_PESSOA_FISICA      = B.CD_PESSOA_FISICA
          AND coalesce(B.IE_SITUACAO, 'A') = 'A'
          AND B.IE_CORPO_CLINICO     <> 'X'
          AND B.IE_CORPO_ASSIST      <> 'X'
          AND ( (SELECT OBTER_SE_MEDICO_ESTAB3( A.CD_PESSOA_FISICA, WHEB_USUARIO_PCK.GET_CD_ESTABELECIMENTO)
             )                  = 'S' )
          AND coalesce(CD_ESPECIALIDADE_P, 0) = 0
          AND ( (coalesce(NM_PESSOA_FISICA_P::text, '') = '')
          OR ((( OBTER_SE_NOME_SOCIAL   IN ('S', 'T'))
          AND UPPER(coalesce(NM_SOCIAL, NM_PESSOA_FISICA)) LIKE UPPER('%'
            || NM_PESSOA_FISICA_P
            || '%') )
          OR ((coalesce(
            ( SELECT OBTER_SE_NOME_SOCIAL
            ),'N' ) = 'N')
          AND UPPER(NM_PESSOA_FISICA) LIKE UPPER('%'
            || NM_PESSOA_FISICA_P
            || '%') ) ) )
          AND ( B.NR_CRM LIKE NR_CRM_P
          OR coalesce(trim(both NR_CRM_P)::text, '') = '' )
          AND ( (coalesce(DS_FONETICA_CNS_P::text, '') = '')
          OR ( UPPER(A.DS_FONETICA_CNS) LIKE UPPER('%'
            || DS_FONETICA_CNS_P
            || '%') ) )
          
UNION

          SELECT A.CD_PESSOA_FISICA,
            A.DS_FONETICA,
            A.DS_FONETICA_CNS,
            B.NR_CRM,
            B.NM_GUERRA,
            SUBSTR(OBTER_DESC_CAMPO_GRID(336203, coalesce(B.IE_CORPO_CLINICO, 'N')), 1, 255) DS_CORPO_CLINICO,
            SUBSTR(OBTER_DESC_CAMPO_GRID(336203, coalesce(B.IE_CORPO_ASSIST, 'N')), 1, 255) DS_CORPO_ASSIST,
            A.NM_USUARIO,
            A.DT_ATUALIZACAO,
            B.IE_VINCULO_MEDICO,
            A.NR_CPF,
            B.NR_SEQ_CATEGORIA,
            A.NR_SEQ_CONSELHO,
            B.UF_CRM,
            A.NM_PESSOA_FISICA_SEM_ACENTO,
            B.IE_CORPO_CLINICO
          FROM PESSOA_FISICA A,
            MEDICO B,
            MEDICO_ESPECIALIDADE E
          WHERE 1                     = 1
          AND A.CD_PESSOA_FISICA      = B.CD_PESSOA_FISICA
          AND coalesce(B.IE_SITUACAO, 'A') = 'A'
          AND B.IE_CORPO_CLINICO     <> 'X'
          AND B.IE_CORPO_ASSIST      <> 'X'
          AND ( (SELECT OBTER_SE_MEDICO_ESTAB3( A.CD_PESSOA_FISICA, WHEB_USUARIO_PCK.GET_CD_ESTABELECIMENTO )
             )                 = 'S' )
          AND A.CD_PESSOA_FISICA        = E.CD_PESSOA_FISICA
          AND E.CD_ESPECIALIDADE        = coalesce(CD_ESPECIALIDADE_P, 0)
          AND ( (coalesce(NM_PESSOA_FISICA_P::text, '') = '')
          OR ( ( (OBTER_SE_NOME_SOCIAL IN ('S', 'T'))
          AND UPPER(coalesce(NM_SOCIAL, NM_PESSOA_FISICA)) LIKE UPPER('%'
            || NM_PESSOA_FISICA_P
            || '%') )
          OR ( (coalesce(
            (SELECT OBTER_SE_NOME_SOCIAL 
            ),'N') = 'N')
          AND UPPER(NM_PESSOA_FISICA) LIKE UPPER('%'
            || NM_PESSOA_FISICA_P
            || '%') ) ) )
          AND ( B.NR_CRM LIKE NR_CRM_P
          OR coalesce(trim(both NR_CRM_P)::text, '') = '' )
          AND ( (coalesce(DS_FONETICA_CNS_P::text, '') = '')
          OR ( UPPER(A.DS_FONETICA_CNS) LIKE UPPER('%'
            || DS_FONETICA_CNS_P
            || '%') ) )
          ) Y,
          PESSOA_FISICA D
        WHERE Y.CD_PESSOA_FISICA = D.CD_PESSOA_FISICA
        AND 0                    = 0
        AND IE_CORPO_CLINICO    <> 'X'
        AND IE_CORPO_ASSIST     <> 'X'
        AND upper( COALESCE( Y.NM_PESSOA_FISICA_SEM_ACENTO, TRANSLATE( SUBSTR(nm_pessoa_fisica, 0, 4000), obter_caracter_especial, 'AaAaAaAaAaAaEeEeEeEeIiIiIiIiOoOoOoOoOoUuUuUuUuCcNnYy' ) ) ) LIKE upper( '%'
          || TRANSLATE( SUBSTR( CASE WHEN NM_PESSOA_FISICA_P='0' THEN  NULL  ELSE NM_PESSOA_FISICA_P END , 0, 4000 ), obter_caracter_especial, 'AaAaAaAaAaAaEeEeEeEeIiIiIiIiOoOoOoOoOoUuUuUuUuCcNnYy' )
          || '%' )
        ORDER BY D.NM_PESSOA_FISICA;

BEGIN
      for r_C02 in C02(NR_CRM_PX,
                        DS_FONETICA_CNS_PX,
                        CD_ESPECIALIDADE_PX,
                        NM_PESSOA_FISICA_PX) loop
      linha_w.CD_PESSOA_FISICA:=r_c02.CD_PESSOA_FISICA;
      linha_w.NM_PESSOA_FISICA:=r_c02.NM_PESSOA_FISICA;
      linha_w.DS_FONETICA:=r_c02.DS_FONETICA;
      linha_w.DS_FONETICA_CNS:=r_c02.DS_FONETICA_CNS;
      linha_w.NR_CRM:=r_c02.NR_CRM;
      linha_w.NM_GUERRA:=r_c02.NM_GUERRA;
      linha_w.DS_CORPO_CLINICO:=r_c02.DS_CORPO_CLINICO;
      linha_w.DS_CORPO_ASSIST:=r_c02.DS_CORPO_ASSIST;
      linha_w.nm_pessoa_p:=r_c02.nm_pessoa_p;
      linha_w.NM_USUARIO:=r_c02.NM_USUARIO;
      linha_w.DT_ATUALIZACAO:=r_c02.DT_ATUALIZACAO;
      linha_w.CD_ESPECIALIDADE:=r_c02.CD_ESPECIALIDADE;
      linha_w.DS_VINCULO:=r_c02.DS_VINCULO;
      linha_w.IE_VINCULO_MEDICO:=r_c02.IE_VINCULO_MEDICO;
      linha_w.NR_CPF:=r_c02.NR_CPF;
      linha_w.DS_CATEGORIA_MEDICO:=r_c02.DS_CATEGORIA_MEDICO;
      linha_w.NR_SEQ_CATEGORIA:=r_c02.NR_SEQ_CATEGORIA;
      linha_w.NR_SEQ_CONSELHO:=r_c02.NR_SEQ_CONSELHO;
      linha_w.UF_CRM:=r_c02.UF_CRM;
      linha_w.DS_CONSELHO:=r_c02.DS_CONSELHO;
      linha_w.NM_PESSOA_FISICA_SEM_ACENTO:=r_c02.NM_PESSOA_FISICA_SEM_ACENTO;
      linha_w.IE_CORPO_CLINICO:=r_c02.IE_CORPO_CLINICO;
      RETURN NEXT linha_w;
      end loop;
      return;
    END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION localizar_medico_pck.obter_table_locmed_13156 ( NR_CRM_PX bigint DEFAULT NULL, DS_FONETICA_CNS_PX text DEFAULT NULL, CD_ESPECIALIDADE_PX text DEFAULT NULL, NM_PESSOA_FISICA_PX text DEFAULT NULL) FROM PUBLIC;
