-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE nais_mla_surgery_pck.send_surgery_data ( nr_prescricao_p bigint, ds_file_output_p INOUT text ) AS $body$
DECLARE

		
		
    json_output_w           philips_json;
    json_output_list_w      philips_json_list;
    nr_order_unit_w         cpoe_order_unit.nr_order_unit%type;

		
BEGIN
		json_output_w := philips_json();
		json_output_list_w := philips_json_list();
		select distinct cu.nr_order_unit order_unit
        into STRICT    nr_order_unit_w
		from
				cpoe_procedimento     cp,
				prescr_procedimento   p,
				cirurgia              c,
				bft_encounter_v       b,
				cpoe_order_unit       cu
        where
				cp.nr_sequencia = p.nr_seq_proc_cpoe
				and p.nr_prescricao = c.nr_prescricao
				and c.nr_atendimento = b.encounter_id
				and b.encounter_id = cp.nr_atendimento
				and cp.nr_seq_cpoe_order_unit = cu.nr_sequencia
				and c.nr_prescricao = nr_prescricao_p;
	
		CALL nais_mla_surgery_pck.packagebody(nr_order_unit_w,nr_prescricao_p);
		json_output_w := nais_mla_surgery_pck.add_json_value(json_output_w, 'message', current_setting('nais_mla_surgery_pck.ds_line_w')::varchar(32767));
		json_output_list_w.append(json_output_w.to_json_value());
		dbms_lob.createtemporary( ds_file_output_p, true);
		json_output_list_w.(ds_file_output_p);  	
    END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE nais_mla_surgery_pck.send_surgery_data ( nr_prescricao_p bigint, ds_file_output_p INOUT text ) FROM PUBLIC;
