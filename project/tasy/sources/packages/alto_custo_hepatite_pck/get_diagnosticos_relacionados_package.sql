-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION alto_custo_hepatite_pck.get_diagnosticos_relacionados ( nr_atendimento_p bigint, ie_tipo_doenca_p regra_alto_custo.ie_tipo_doenca%type) RETURNS varchar AS $body$
DECLARE

    c_doencas CURSOR FOR
    SELECT DISTINCT(cd_doenca)
      FROM diagnostico_doenca
      WHERE nr_atendimento = nr_atendimento_p
      AND (dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
      AND coalesce(dt_inativacao::text, '') = ''
      AND alto_custo_pck.is_alto_custo(cd_doenca, ie_tipo_doenca_p) = 'N'

UNION

    SELECT DISTINCT(cd_doenca)
    FROM paciente_antec_clinico
    WHERE nr_atendimento = nr_atendimento_p
    AND (dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
    AND coalesce(dt_inativacao::text, '') = ''
    AND alto_custo_pck.is_alto_custo(cd_doenca, ie_tipo_doenca_p) = 'N';

    r_doencas c_doencas%rowtype;
    ds_retorno_w varchar(255);

BEGIN
    BEGIN
      FOR r_doencas IN c_doencas
      LOOP
        ds_retorno_w := ds_retorno_w || r_doencas.cd_doenca || '/';
      END LOOP;

      SELECT SUBSTR(ds_retorno_w, 0, LENGTH(ds_retorno_w) - 1)
      INTO STRICT ds_retorno_w
;

    EXCEPTION
    WHEN OTHERS THEN
      ds_retorno_w := '';
    END;

    RETURN ds_retorno_w;
  END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION alto_custo_hepatite_pck.get_diagnosticos_relacionados ( nr_atendimento_p bigint, ie_tipo_doenca_p regra_alto_custo.ie_tipo_doenca%type) FROM PUBLIC;
