-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION alto_custo_hepatite_pck.get_cirrosis ( nr_atendimento_p bigint) RETURNS varchar AS $body$
DECLARE

    ds_retorno_w varchar(1) := '3';
  c_cirrosis CURSOR FOR
    SELECT *
    FROM (SELECT 1 AS priority,
        a.dt_atualizacao,
        CASE WHEN a.ie_tipo_doenca='A' THEN  'AGUDA' WHEN a.ie_tipo_doenca='C' THEN  'CRONICA'  ELSE NULL END  tipo_doenca,
        CASE WHEN a.ie_status_problema='2' THEN  'DESCOMPENSADA' WHEN a.ie_status_problema='3' THEN  'COMPENSADA'  ELSE NULL END  ie_status
      FROM diagnostico_doenca a,
        cid_doenca b
      WHERE b.cd_doenca_cid      = a.cd_doenca
      AND a.nr_atendimento       = nr_atendimento_p
      AND b.ie_doenca_cronica_mx = 'CIRRO'

UNION

    SELECT 2 AS priority,
      a.dt_atualizacao,
      NULL,
      CASE WHEN upper(a.ie_status)='A' THEN  'DESCOMPENSADA' WHEN upper(a.ie_status)='C' THEN  'COMPENSADA'  ELSE NULL END 
    FROM paciente_antec_clinico a,
      cid_doenca b
    WHERE b.cd_doenca_cid      = a.cd_doenca
    AND a.nr_atendimento       = nr_atendimento_p
    AND b.ie_doenca_cronica_mx = 'CIRRO'
    ORDER BY priority,
      dt_atualizacao DESC
      ) alias2 LIMIT 1;

BEGIN
    FOR r_cirrosis IN c_cirrosis
    LOOP
      CASE
      WHEN (r_cirrosis.ie_status IS NOT NULL AND r_cirrosis.ie_status::text <> '') OR r_cirrosis.tipo_doenca = 'AGUDA' THEN
        CASE
        WHEN r_cirrosis.tipo_doenca = 'AGUDA' THEN
          ds_retorno_w             := '2';
        WHEN r_cirrosis.tipo_doenca = 'CRONICA' OR coalesce(r_cirrosis.tipo_doenca::text, '') = '' THEN
          CASE
          WHEN r_cirrosis.ie_status = 'COMPENSADA' THEN
            ds_retorno_w           := '1';
          WHEN r_cirrosis.ie_status = 'DESCOMPENSADA' THEN
            ds_retorno_w           := '2';
          ELSE
            ds_retorno_w := NULL;
          END CASE;
        ELSE
          ds_retorno_w := NULL;
        END CASE;
      ELSE
        ds_retorno_w := NULL;
      END CASE;
    END LOOP;
    RETURN ds_retorno_w;
  END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION alto_custo_hepatite_pck.get_cirrosis ( nr_atendimento_p bigint) FROM PUBLIC;
