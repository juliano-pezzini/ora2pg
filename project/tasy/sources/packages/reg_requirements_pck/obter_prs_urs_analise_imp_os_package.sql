-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION reg_requirements_pck.obter_prs_urs_analise_imp_os ( nr_seq_ordem_serv_p man_ordem_serv_impacto.nr_seq_ordem_serv%type, dt_fim_versao_p man_ordem_serv_impacto.dt_aprovacao%type, nr_seq_intencao_uso_p reg_area_customer.nr_seq_intencao_uso%type default 2) RETURNS SETOF T_REG_DATA AS $body$
DECLARE
 t_reg_row_w t_reg_row;

nr_seq_projeto_w		man_ordem_servico.nr_seq_projeto%type;
max_nr_seq_analise_imp_w	man_ordem_serv_impacto.nr_sequencia%type;

  item RECORD;

BEGIN

	select	max(a1.nr_sequencia)
	into STRICT	max_nr_seq_analise_imp_w
	from	man_ordem_serv_impacto a1
	where	(a1.dt_aprovacao IS NOT NULL AND a1.dt_aprovacao::text <> '')
	and	trunc(a1.dt_aprovacao) < (dt_fim_versao_p + 1)
	and	a1.nr_seq_ordem_serv = nr_seq_ordem_serv_p;

	for item in (
		SELECT	c1.cd_prs_id,
			d1.cd_crs_id
		from	man_ordem_serv_impacto a1,
			man_ordem_serv_imp_pr b1,
			reg_product_requirement c1,
			reg_customer_requirement d1,
			reg_features_customer fea,
			reg_area_customer area
		where	a1.nr_sequencia = b1.nr_seq_impacto
		and	b1.nr_product_requirement = c1.nr_sequencia
		and	c1.nr_customer_requirement = d1.nr_sequencia
		and	d1.nr_seq_features = fea.nr_sequencia
		and	fea.nr_seq_area_customer = area.nr_sequencia
		and	area.nr_seq_intencao_uso = nr_seq_intencao_uso_p
		and	a1.nr_sequencia = max_nr_seq_analise_imp_w
		order by c1.cd_prs_id
	) loop
                t_reg_row_w.cd_prs_id := item.cd_prs_id;
                t_reg_row_w.cd_urs_id := item.cd_crs_id;
		
                RETURN NEXT t_reg_row_w;
	end loop;
	
	
	if (coalesce(t_reg_row_w.cd_prs_id::text, '') = '') or (coalesce(t_reg_row_w.cd_urs_id::text, '') = '')then

		select	coalesce(proj_obter_projeto_ordem_serv(nr_seq_ordem_serv_p),0) nr_seq_projeto
		into STRICT	nr_seq_projeto_w
		;

		if (nr_seq_projeto_w > 0) then

			for item in (
				SELECT	c1.cd_prs_id,
					d1.cd_crs_id
				from	man_ordem_serv_impacto a1,
					man_ordem_serv_imp_pr b1,
					reg_product_requirement c1,
					reg_customer_requirement d1,
					reg_features_customer fea,
					reg_area_customer area
				where	a1.nr_sequencia = b1.nr_seq_impacto
				and	b1.nr_product_requirement = c1.nr_sequencia
				and	c1.nr_customer_requirement = d1.nr_sequencia
				and	d1.nr_seq_features = fea.nr_sequencia
				and	fea.nr_seq_area_customer = area.nr_sequencia
				and	area.nr_seq_intencao_uso = nr_seq_intencao_uso_p
				and	(a1.dt_aprovacao IS NOT NULL AND a1.dt_aprovacao::text <> '')
				and	trunc(a1.dt_aprovacao) < dt_fim_versao_p + 1
				and	a1.nr_seq_ordem_serv =  (
									SELECT	a.nr_seq_ordem_serv
									from	proj_projeto a
									where	a.nr_sequencia = nr_seq_projeto_w)
				order by c1.cd_prs_id
			) loop
                                t_reg_row_w.cd_prs_id := item.cd_prs_id;
                                t_reg_row_w.cd_urs_id := item.cd_crs_id;

                                RETURN NEXT t_reg_row_w;
			end loop;
		end if;
	end if;

return;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 IMMUTABLE;
-- REVOKE ALL ON FUNCTION reg_requirements_pck.obter_prs_urs_analise_imp_os ( nr_seq_ordem_serv_p man_ordem_serv_impacto.nr_seq_ordem_serv%type, dt_fim_versao_p man_ordem_serv_impacto.dt_aprovacao%type, nr_seq_intencao_uso_p reg_area_customer.nr_seq_intencao_uso%type default 2) FROM PUBLIC;
