-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------



CREATE OR REPLACE PROCEDURE ptu_env_pck.ptu_cons_benef_tiss ( nr_seq_guia_p pls_guia_plano.nr_sequencia%type, ie_novo_p INOUT text) AS $body$
DECLARE


dt_nascimento_w		pessoa_fisica.dt_nascimento%type;
ie_sexo_w		pessoa_fisica.ie_sexo%type;
dt_nrec_w		pessoa_fisica.dt_atualizacao_nrec%type;
nr_seq_segurado_w	pls_segurado.nr_sequencia%type;

ie_funcao_autorizador_w	pls_param_atend_geral.ie_funcao_autorizador%type;

ie_execucao_posterior_w		pls_param_importacao_guia.ie_execucao_posterior%type;


BEGIN

ie_funcao_autorizador_w	:= pls_obter_param_atend_geral('FA');

select	coalesce(max(ie_execucao_posterior),'N')
into STRICT	ie_execucao_posterior_w
from	pls_param_importacao_guia;

-- Tratamento feito devido a uso da regra 'Disponibilizar requisicao para execucao futura' em OPS - Gestao de Operadoras > Parametros da OPS > Importacao XML guia,

-- caso use a regra, tenta identificar primeiro se existe uma requisicao com a sequencia antes de verificar as guias.

if (ie_funcao_autorizador_w = '2') and (ie_execucao_posterior_w = 'S') then
	begin
		select	nr_seq_segurado
		into STRICT	nr_seq_segurado_w
		from	pls_requisicao
		where	nr_sequencia	= nr_seq_guia_p
		and	ie_origem_solic	= 'W';
	exception
	when others then
		begin
			select	nr_seq_segurado
			into STRICT	nr_seq_segurado_w
			from	pls_guia_plano
			where	nr_sequencia	= nr_seq_guia_p;
		exception
		when others then
			nr_seq_segurado_w := null;
		end;
	end;
else
	begin
		select	nr_seq_segurado
		into STRICT	nr_seq_segurado_w
		from	pls_guia_plano
		where	nr_sequencia	= nr_seq_guia_p;
	exception
	when others then
		nr_seq_segurado_w := null;
	end;
end if;

begin
	select	dt_nascimento,
		ie_sexo,
		trunc(dt_atualizacao_nrec)
	into STRICT	dt_nascimento_w,
		ie_sexo_w,
		dt_nrec_w
	from	pessoa_fisica
	where	cd_pessoa_fisica = (	SELECT	max(cd_pessoa_fisica)
					from	pls_segurado
					where	nr_sequencia = nr_seq_segurado_w);
exception
when others then
	dt_nascimento_w	:= null;
	ie_sexo_w	:= null;
	dt_nrec_w	:= null;
end;


if (coalesce(dt_nascimento_w::text, '') = '') and (coalesce(ie_sexo_w::text, '') = '') and (dt_nrec_w = trunc(clock_timestamp())) then
	ie_novo_p := 'S';
else
	ie_novo_p := 'N';
end if;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ptu_env_pck.ptu_cons_benef_tiss ( nr_seq_guia_p pls_guia_plano.nr_sequencia%type, ie_novo_p INOUT text) FROM PUBLIC;
