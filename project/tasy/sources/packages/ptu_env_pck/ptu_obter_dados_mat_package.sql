-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE ptu_env_pck.ptu_obter_dados_mat ( nr_seq_material_p pls_material.nr_sequencia%type, cd_material_ptu_p text, ie_codificacao_p INOUT text, ie_tipo_despesa_p INOUT text) AS $body$
DECLARE


dt_referencia_w		timestamp;
nr_seq_mat_conversao_w	pls_material.nr_sequencia%type;
nr_seq_mat_unimed_w	pls_material.nr_seq_material_unimed%type;


BEGIN

dt_referencia_w := trunc(clock_timestamp());

select	max(a.nr_seq_material_unimed)
into STRICT	nr_seq_mat_unimed_w
from	pls_material_a900 a
where	a.nr_seq_material	= nr_seq_material_p
and	dt_referencia_w between a.dt_inicio_vigencia and fim_dia(coalesce(a.dt_fim_vigencia,dt_referencia_w));

select	coalesce(nr_seq_mat_unimed_w, nr_seq_material_unimed),
	ie_tipo_despesa
into STRICT	nr_seq_mat_unimed_w,
	ie_tipo_despesa_p
from	pls_material
where	nr_sequencia	= nr_seq_material_p;


if (coalesce(nr_seq_mat_unimed_w::text, '') = '') then
	nr_seq_mat_conversao_w := pls_obter_seq_codigo_material(null, cd_material_ptu_p);

	if (nr_seq_mat_conversao_w IS NOT NULL AND nr_seq_mat_conversao_w::text <> '') then
		select	max(a.nr_seq_material_unimed)
		into STRICT		nr_seq_mat_unimed_w
		from	pls_material_a900 a
		where	a.nr_seq_material	= nr_seq_mat_conversao_w
		and		dt_referencia_w between a.dt_inicio_vigencia and fim_dia(coalesce(a.dt_fim_vigencia,dt_referencia_w));

		select	coalesce(nr_seq_mat_unimed_w, nr_seq_material_unimed),
			coalesce(ie_tipo_despesa_p, ie_tipo_despesa)
		into STRICT		nr_seq_mat_unimed_w,
				ie_tipo_despesa_p
		from	pls_material
		where	nr_sequencia	= nr_seq_mat_conversao_w;
	end if;
end if;

select	coalesce(max(ie_codificacao), '1')
into STRICT	ie_codificacao_p
from	pls_material_unimed
where	nr_sequencia = nr_seq_mat_unimed_w;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ptu_env_pck.ptu_obter_dados_mat ( nr_seq_material_p pls_material.nr_sequencia%type, cd_material_ptu_p text, ie_codificacao_p INOUT text, ie_tipo_despesa_p INOUT text) FROM PUBLIC;
