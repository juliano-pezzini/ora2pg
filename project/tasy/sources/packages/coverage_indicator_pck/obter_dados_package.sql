-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION coverage_indicator_pck.obter_dados (dt_inicial_p timestamp, dt_final_p timestamp, ie_backoffice_p text) RETURNS SETOF T_OBJETO_ROW_DATA AS $body$
DECLARE


	c01 CURSOR FOR
	SELECT 	a.cd_funcao,
		obter_nome_funcao(a.cd_funcao) ds_funcao,
		CASE WHEN ie_status='L' THEN 'Validation' WHEN ie_status='A' THEN 'Accepted (RFLD)' WHEN ie_status='F' THEN 'RFVD' WHEN ie_status='D' THEN 'Done' END  ie_status_html,
		obter_descricao_gerencia(obter_gerencia_funcao(a.cd_funcao)) ds_gerencia,
		'' ds_diretoria,
		coalesce(obter_escore_gerencia(cd_funcao),0) score_gerencia,
		ie_status
	from 	funcoes_html5 a
	where 	a.ie_quarter_entrega not in ('PLS','PRC7')
	and 	ie_status in ('L','A','F','D')
	order by 1;

	
BEGIN

	for r_c01w in c01 loop

		current_setting('coverage_indicator_pck.t_objeto_row_w')::t_objeto_row.cd_funcao := r_c01w.cd_funcao;
		current_setting('coverage_indicator_pck.t_objeto_row_w')::t_objeto_row.ds_funcao := r_c01w.ds_funcao;
		current_setting('coverage_indicator_pck.t_objeto_row_w')::t_objeto_row.ie_status_html := r_c01w.ie_status_html;
		current_setting('coverage_indicator_pck.t_objeto_row_w')::t_objeto_row.ds_gerencia := r_c01w.ds_gerencia;
		current_setting('coverage_indicator_pck.t_objeto_row_w')::t_objeto_row.ds_diretoria := r_c01w.ds_diretoria;

		--- inicialização
		current_setting('coverage_indicator_pck.t_objeto_row_w')::t_objeto_row.qt_solic_interna := 0;
		current_setting('coverage_indicator_pck.t_objeto_row_w')::t_objeto_row.qt_solic_externa := 0;
		current_setting('coverage_indicator_pck.t_objeto_row_w')::t_objeto_row.qt_def_interna := 0;
		current_setting('coverage_indicator_pck.t_objeto_row_w')::t_objeto_row.qt_def_externa := 0;
		current_setting('coverage_indicator_pck.t_objeto_row_w')::t_objeto_row.qt_solic_projeto := 0;
		current_setting('coverage_indicator_pck.t_objeto_row_w')::t_objeto_row.qt_def_projeto := 0;
		current_setting('coverage_indicator_pck.t_objeto_row_w')::t_objeto_row.qt_cliente_os := 0;
		current_setting('coverage_indicator_pck.t_objeto_row_w')::t_objeto_row.qt_def_cliente := 0;
		current_setting('coverage_indicator_pck.t_objeto_row_w')::t_objeto_row.qt_solic_cliente := 0;
		current_setting('coverage_indicator_pck.t_objeto_row_w')::t_objeto_row.qt_duv_cliente := 0;
		current_setting('coverage_indicator_pck.t_objeto_row_w')::t_objeto_row.qt_sug_cliente := 0;
		current_setting('coverage_indicator_pck.t_objeto_row_w')::t_objeto_row.qt_cliente_abertura := 0;
		current_setting('coverage_indicator_pck.t_objeto_row_w')::t_objeto_row.qt_estagio_cliente := 0;
		current_setting('coverage_indicator_pck.t_objeto_row_w')::t_objeto_row.qt_estagio_philips := 0;
		current_setting('coverage_indicator_pck.t_objeto_row_w')::t_objeto_row.qt_passos_verif := 0;
		current_setting('coverage_indicator_pck.t_objeto_row_w')::t_objeto_row.qt_falhou_verif := 0;
		current_setting('coverage_indicator_pck.t_objeto_row_w')::t_objeto_row.qt_passou_verif := 0;
		current_setting('coverage_indicator_pck.t_objeto_row_w')::t_objeto_row.qt_bloqueio_verif := 0;

		--Solicitações internas geral
		--Solicitações externas geral
		--Defeitos internos geral
		--Defeitos externos geral
		--Solictações projeto geral
		--Defeito projeto geral
		select 	sum(case when(a.nr_seq_localizacao in (942,62,41,6635,4604,6687,1272,52) and a.ie_classificacao = 'S') then 1 else 0 end),
			sum(case when(a.nr_seq_localizacao not in (942,62,41,6635,4604,6687,1272,52) and a.ie_classificacao = 'S') then 1 else 0 end),
			sum(case when(a.nr_seq_localizacao in (942,62,41,6635,4604,6687,1272,52) and a.ie_classificacao = 'E') then 1 else 0 end),
			sum(case when(a.nr_seq_localizacao not in (942,62,41,6635,4604,6687,1272,52) and a.ie_classificacao = 'E') then 1 else 0 end),
			sum(case when(a.ie_classificacao = 'S' and (a.nr_seq_proj_cron_etapa IS NOT NULL AND a.nr_seq_proj_cron_etapa::text <> '')) then 1 else 0 end),
			sum(case when(a.ie_classificacao = 'E' and (a.nr_seq_proj_cron_etapa IS NOT NULL AND a.nr_seq_proj_cron_etapa::text <> '')) then 1 else 0 end),
			sum(case when (a.NR_SEQ_WHEB IS NOT NULL AND a.NR_SEQ_WHEB::text <> '') then 1 else 0 end),
			sum(case when((a.NR_SEQ_WHEB IS NOT NULL AND a.NR_SEQ_WHEB::text <> '') and a.ie_classificacao = 'E') then 1 else 0 end),
			sum(case when((a.NR_SEQ_WHEB IS NOT NULL AND a.NR_SEQ_WHEB::text <> '') and a.ie_classificacao = 'S') then 1 else 0 end),
			sum(case when((a.NR_SEQ_WHEB IS NOT NULL AND a.NR_SEQ_WHEB::text <> '') and a.ie_classificacao = 'D') then 1 else 0 end),
			sum(case when((a.NR_SEQ_WHEB IS NOT NULL AND a.NR_SEQ_WHEB::text <> '') and a.ie_classificacao = 'T') then 1 else 0 end)
		into STRICT	current_setting('coverage_indicator_pck.t_objeto_row_w')::t_objeto_row.qt_solic_interna,
			current_setting('coverage_indicator_pck.t_objeto_row_w')::t_objeto_row.qt_solic_externa,
			current_setting('coverage_indicator_pck.t_objeto_row_w')::t_objeto_row.qt_def_interna,
			current_setting('coverage_indicator_pck.t_objeto_row_w')::t_objeto_row.qt_def_externa,
			current_setting('coverage_indicator_pck.t_objeto_row_w')::t_objeto_row.qt_solic_projeto,
			current_setting('coverage_indicator_pck.t_objeto_row_w')::t_objeto_row.qt_def_projeto,
			current_setting('coverage_indicator_pck.t_objeto_row_w')::t_objeto_row.qt_cliente_os,
			current_setting('coverage_indicator_pck.t_objeto_row_w')::t_objeto_row.qt_def_cliente,
			current_setting('coverage_indicator_pck.t_objeto_row_w')::t_objeto_row.qt_solic_cliente,
			current_setting('coverage_indicator_pck.t_objeto_row_w')::t_objeto_row.qt_duv_cliente,
			current_setting('coverage_indicator_pck.t_objeto_row_w')::t_objeto_row.qt_sug_cliente
		from    man_ordem_servico_v a
		where   a.ie_plataforma = 'H'
		and     a.dt_ordem_servico between dt_inicial_p and fim_dia(dt_final_p)
		and	((ie_backoffice_p = 'S' and nr_seq_gerencia_des in (4,60,175)) or (ie_backoffice_p <> 'S'))
		and	exists ( SELECT 1
				from	man_estagio_processo e,
					man_ordem_serv_estagio d
				where	e.nr_sequencia = d.nr_seq_estagio
				and	d.nr_seq_ordem = a.nr_sequencia
				and	((e.ie_desenv = 'S') or (e.ie_tecnologia = 'S')))
		and     a.cd_funcao = r_c01w.cd_funcao;

		--Quantidade de clientes abriram OS
		select count(*)
		into STRICT current_setting('coverage_indicator_pck.t_objeto_row_w')::t_objeto_row.qt_cliente_abertura
		from (
		SELECT DISTINCT OBTER_DESC_MAN_LOCALIZACAO(y.nr_Seq_localizacao)
		FROM 	man_ordem_Servico_v y
		WHERE	y.ie_plataforma = 'H'
		AND     y.dt_ordem_servico BETWEEN dt_inicial_p AND fim_dia(dt_final_p)
		AND     y.nr_seq_localizacao NOT IN (942,62,41,6635,4604,6687,1272,52)
		and     y.cd_funcao = r_c01w.cd_funcao
		and	((ie_backoffice_p = 'S' and nr_seq_gerencia_des in (4,60,175)) or (ie_backoffice_p <> 'S'))
		AND EXISTS ( SELECT 1
			      FROM man_estagio_processo e,
				   man_ordem_serv_estagio d
		WHERE 	e.nr_sequencia = d.nr_seq_estagio
		AND 	d.nr_seq_ordem = y.nr_sequencia
		AND 	((e.ie_desenv = 'S') OR (e.ie_tecnologia = 'S')))) alias13;

		--Função em uso no cliente
		 if (current_setting('coverage_indicator_pck.t_objeto_row_w')::t_objeto_row.qt_cliente_abertura > 0) then
			current_setting('coverage_indicator_pck.t_objeto_row_w')::t_objeto_row.ie_uso_cliente := 'S';
		else
			current_setting('coverage_indicator_pck.t_objeto_row_w')::t_objeto_row.ie_uso_cliente := 'N';
		end if;

		--Foi aplicado o projeto Eleven na função
		current_setting('coverage_indicator_pck.t_objeto_row_w')::t_objeto_row.ie_partic_eleven := 'N';

		--Quantidade de OS's abertas no Eleven
		current_setting('coverage_indicator_pck.t_objeto_row_w')::t_objeto_row.pr_execucao_eleven := 0;

		--Quantidade OS's pendentes (Philips/Cliente)
		select 	qt_estagio_cliente,
			qt_estagio_philips
		into STRICT	current_setting('coverage_indicator_pck.t_objeto_row_w')::t_objeto_row.qt_estagio_cliente,
			current_setting('coverage_indicator_pck.t_objeto_row_w')::t_objeto_row.qt_estagio_philips
		from (
		SELECT  sum(CASE WHEN a.nr_seq_estagio=9 THEN 1 WHEN a.nr_seq_estagio=511 THEN 1  ELSE 0 END ) qt_estagio_cliente,
			sum(CASE WHEN a.nr_seq_estagio=9 THEN 0 WHEN a.nr_seq_estagio=511 THEN 0  ELSE 1 END ) qt_estagio_philips
		FROM	man_ordem_servico_v a
		WHERE	a.ie_plataforma = 'H'
		and	a.dt_ordem_servico between dt_inicial_p and fim_dia(dt_final_p)
		and  	exists ( SELECT 1
				from 	man_estagio_processo e,
					man_ordem_serv_estagio d
				where 	e.nr_sequencia = d.nr_seq_estagio
				and 	d.nr_seq_ordem = a.nr_sequencia
				and	((e.ie_desenv = 'S') or (e.ie_tecnologia = 'S')))
		and	a.cd_funcao = r_c01w.cd_funcao
		and	coalesce(a.nr_seq_proj_cron_etapa::text, '') = '') alias10;

		--Percentual de OS's pendentes com a Philips
		current_setting('coverage_indicator_pck.t_objeto_row_w')::t_objeto_row.pr_estagio_philips := current_setting('coverage_indicator_pck.t_objeto_row_w')::t_objeto_row.qt_estagio_philips * 100 / (current_setting('coverage_indicator_pck.t_objeto_row_w')::t_objeto_row.qt_estagio_philips + current_setting('coverage_indicator_pck.t_objeto_row_w')::t_objeto_row.qt_estagio_cliente);

		--Score sobre o percentual de OS's com a Philips
		if (current_setting('coverage_indicator_pck.t_objeto_row_w')::t_objeto_row.pr_estagio_philips < 11) then
			current_setting('coverage_indicator_pck.t_objeto_row_w')::t_objeto_row.qt_score_estagio := 1;
		elsif (current_setting('coverage_indicator_pck.t_objeto_row_w')::t_objeto_row.pr_estagio_philips > 10 and current_setting('coverage_indicator_pck.t_objeto_row_w')::t_objeto_row.pr_estagio_philips < 21) then
			current_setting('coverage_indicator_pck.t_objeto_row_w')::t_objeto_row.qt_score_estagio := 0.5;
		else	current_setting('coverage_indicator_pck.t_objeto_row_w')::t_objeto_row.qt_score_estagio := 0;
		end if;

		--Score verificação
		SELECT	sum(qt_passos) qt_passos,
			sum(qt_falhou) qt_falhou,
			sum(qt_passou) qt_passou,
			sum(qt_bloqueado) qt_bloqueado
		into STRICT	current_setting('coverage_indicator_pck.t_objeto_row_w')::t_objeto_row.qt_passos_verif,
			current_setting('coverage_indicator_pck.t_objeto_row_w')::t_objeto_row.qt_falhou_verif,
			current_setting('coverage_indicator_pck.t_objeto_row_w')::t_objeto_row.qt_passou_verif,
			current_setting('coverage_indicator_pck.t_objeto_row_w')::t_objeto_row.qt_bloqueio_verif
		FROM (SELECT	p.nr_seq_pr,
				p.cd_funcao,
				count(pp.nr_sequencia) qt_passos,
				CASE WHEN pp.ie_result='F' THEN count(pp.nr_sequencia)  ELSE 0 END  qt_falhou,
				CASE WHEN pp.ie_result='P' THEN count(pp.nr_sequencia)  ELSE 0 END  qt_passou,
				CASE WHEN pp.ie_result='B' THEN count(pp.nr_sequencia)  ELSE 0 END  qt_bloqueado
		FROM reg_tc_pendencies p, reg_tc_evidence_item pp
LEFT OUTER JOIN reg_tc_so_pendencies o ON (pp.nr_sequencia = o.nr_seq_ev_item)
WHERE p.nr_sequencia = pp.nr_seq_ect  and p.ds_version = '3.01.1713' and p.cd_funcao = r_c01w.cd_funcao group by p.cd_funcao,
			cd_funcao,
			p.nr_seq_pr,
			pp.ie_result )t,
			reg_product_requirement r
		where   r.nr_sequencia = t.nr_seq_pr
		order by 2;

		if (current_setting('coverage_indicator_pck.t_objeto_row_w')::t_objeto_row.qt_bloqueio_verif > 0) then
			current_setting('coverage_indicator_pck.t_objeto_row_w')::t_objeto_row.qt_score_verif := 0.5;
		elsif (current_setting('coverage_indicator_pck.t_objeto_row_w')::t_objeto_row.qt_bloqueio_verif = 0 and current_setting('coverage_indicator_pck.t_objeto_row_w')::t_objeto_row.qt_passou_verif > 0) then
			current_setting('coverage_indicator_pck.t_objeto_row_w')::t_objeto_row.qt_score_verif := 1;
		else	current_setting('coverage_indicator_pck.t_objeto_row_w')::t_objeto_row.qt_score_verif := 0;
		end if;

		--Score validação
		current_setting('coverage_indicator_pck.t_objeto_row_w')::t_objeto_row.qt_score_valid := 0;

		--Score cliente
		if (current_setting('coverage_indicator_pck.t_objeto_row_w')::t_objeto_row.ie_uso_cliente = 'S') then
			current_setting('coverage_indicator_pck.t_objeto_row_w')::t_objeto_row.qt_score_cliente := 1;
		else	current_setting('coverage_indicator_pck.t_objeto_row_w')::t_objeto_row.qt_score_cliente := 0;
		end if;

		--Score estágio da função
		if (r_c01w.ie_status in ('A','F','D')) then
			current_setting('coverage_indicator_pck.t_objeto_row_w')::t_objeto_row.qt_score_funcao := 1;
		else	current_setting('coverage_indicator_pck.t_objeto_row_w')::t_objeto_row.qt_score_funcao := 0;
		end if;

		--Somatório do Score de critérios total
		current_setting('coverage_indicator_pck.t_objeto_row_w')::t_objeto_row.qt_score_total := current_setting('coverage_indicator_pck.t_objeto_row_w')::t_objeto_row.qt_score_estagio + current_setting('coverage_indicator_pck.t_objeto_row_w')::t_objeto_row.qt_score_verif + current_setting('coverage_indicator_pck.t_objeto_row_w')::t_objeto_row.qt_score_valid + current_setting('coverage_indicator_pck.t_objeto_row_w')::t_objeto_row.qt_score_cliente + current_setting('coverage_indicator_pck.t_objeto_row_w')::t_objeto_row.qt_score_funcao;

		--Score definido pela gerência
		if (r_c01w.score_gerencia <> 0) then
			current_setting('coverage_indicator_pck.t_objeto_row_w')::t_objeto_row.qt_score_gerencia := r_c01w.score_gerencia;
		else 	current_setting('coverage_indicator_pck.t_objeto_row_w')::t_objeto_row.qt_score_gerencia := current_setting('coverage_indicator_pck.t_objeto_row_w')::t_objeto_row.qt_score_total;
		end if;

		RETURN NEXT current_setting('coverage_indicator_pck.t_objeto_row_w'::t_objeto_row);

	end loop;
	return;

	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION coverage_indicator_pck.obter_dados (dt_inicial_p timestamp, dt_final_p timestamp, ie_backoffice_p text) FROM PUBLIC;
