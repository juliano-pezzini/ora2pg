-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE ctb_contab_mexico_pck.gerar_arquivo_d ( nm_usuario_p estabelecimento.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nr_seq_regra_p w_ctb_contab_mexico.nr_seq_regra%type, ds_nome_arquivo_p text, ds_diretorio_rede_p INOUT text ) AS $body$
DECLARE


    ds_diretorio_utl_file_w     varchar(255);
    ds_diretorio_rede_w         varchar(255);
    ds_nome_arquivo_w           varchar(100);
    arquivo_xml_w               xml;


BEGIN
    /*
    Cadastro diretorio servidor e diretorio rede:
    Funcao:
        Cadastros gerais(Shift+F11)
    Aba:
        Sistema\Usuario\Eventos gravacao/leitura de arquivos (UTL_FILE)

    dir_servidor    /oraprd03/utlfile/
    dir_rede        \\192.168.0.230\utlfile

    Padrao nome arquivo:
        RFC + Ejercicio + Periodo + Clave + Extension
        BBB010101AB1 + 2015 + 01  + BC + .zip
        BBB010101AB1201501XC.zip

    exemplo mexico:
        HSJ930517HN4201503PL.xml
        que fica dentro do arquivo:
            HSJ930517HN4201503PL.zip

    Site para validacao do arquivo:
    https://ceportalvalidacionprod.clouda.sat.gob.mx/
    */


    ds_nome_arquivo_w := coalesce(substr(ds_nome_arquivo_p,1,100),'ctb.xml');

    begin
    /*
    Evento [28] - Geracao da Contabilidade eletronica do Mexico
    Funcao [923] - Contabilidade
    Tipo [G] - Gravacao
    */

    select  ds_local,
            ds_local_rede
    into STRICT    ds_diretorio_utl_file_w,
            ds_diretorio_rede_w
    from (
        SELECT  ds_local,
                ds_local_rede
        from    evento_tasy_utl_file a
        where   a.cd_evento = 28
        and     coalesce(a.cd_funcao,923) = 923
        and     a.ie_tipo = 'G'
        and     a.cd_estabelecimento = cd_estabelecimento_p
        order by nr_sequencia desc) x LIMIT 1;
    exception
        when no_data_found then
            /* Nao localizado o cadastro de "Eventos gravacao/leitura de arquivos (UTL_FILE)" para o evento [28] - Geracao da Contabilidade eletronica do Mexico */


            CALL wheb_mensagem_pck.exibir_mensagem_abort(839395);
        when others then
            /* Nao localizado o cadastro de "Eventos gravacao/leitura de arquivos (UTL_FILE)" para o evento [28] - Geracao da Contabilidade eletronica do Mexico */


            CALL wheb_mensagem_pck.exibir_mensagem_abort(839395);
    end;

    CALL ctb_contab_mexico_pck.gerar_registro_d(nr_seq_regra_p,nm_usuario_p);
    /* UTILIZAR APENAS PARA TESTE
    Atualizar o UUID para passar na validacao com valor fixo valido
    UTILIZAR APENAS PARA TESTE */

    /*
    update  w_ctb_contab_mexico a
    set a.ds_uuid_cfdi = 'aaaaaaaa-bbbb-cccc-dddd-eeeeeeeeeeee'
    where   a.nr_seq_regra = nr_seq_regra_p
    and a.ie_tipo_atributo = 4;
    */


    /* Atualizar os registros que NaO possuem o RFC (que e gravado no campo CD_CPF_CGC) com o valor generico -> XAXX010101000 */


    update  w_ctb_contab_mexico a
    set     a.cd_cpf_cgc = 'XAXX010101000' /*set   cd_cpf_cgc = 'AAA001939AAA'*/
    where   a.nr_seq_regra = nr_seq_regra_p
    and     a.ie_tipo_atributo in (4,5,6,7,8)
    and     coalesce(a.cd_cpf_cgc::text, '') = '';

    commit;

    arquivo_xml_w := ctb_contab_mexico_pck.get_arquivo_d_xml(nr_seq_regra_p);

    begin


            ds_nome_arquivo_w := ctb_contab_mexico_pck.gerar_arquivo_xml(
            ds_nome_arquivo_w, ds_diretorio_utl_file_w, arquivo_xml_w);

    exception
        when no_data_found then
            /* Ocorreu um erro ao gravar o arquivo, verifique se as permissoes de leitura e escrita estao configuradas para o diretorio de arquivos do banco.
            Diretorio do servidor: DS_DIRETORIO_UTL_FILE
            Diretorio de rede: DS_DIRETORIO_REDE */

            CALL wheb_mensagem_pck.exibir_mensagem_abort(839396,
                'DS_DIRETORIO_UTL_FILE='||ds_diretorio_utl_file_w||';DS_DIRETORIO_REDE='||ds_diretorio_rede_w);
        when others then
            /* Ocorreu um erro ao gravar o arquivo, verifique se as permissoes de leitura e escrita estao configuradas para o diretorio de arquivos do banco.
            Diretorio do servidor: DS_DIRETORIO_UTL_FILE
            Diretorio de rede: DS_DIRETORIO_REDE */

            CALL wheb_mensagem_pck.exibir_mensagem_abort(839396,
                'DS_DIRETORIO_UTL_FILE='||ds_diretorio_utl_file_w||';DS_DIRETORIO_REDE='||ds_diretorio_rede_w);
    end;

    ds_diretorio_rede_p := ds_diretorio_rede_w;

    END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ctb_contab_mexico_pck.gerar_arquivo_d ( nm_usuario_p estabelecimento.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nr_seq_regra_p w_ctb_contab_mexico.nr_seq_regra%type, ds_nome_arquivo_p text, ds_diretorio_rede_p INOUT text ) FROM PUBLIC;
