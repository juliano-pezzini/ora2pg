-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE ctb_contab_mexico_pck.gerar_registro_d ( nr_seq_regra_p ctb_regra_arquivo_mex.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE


    c01 CURSOR FOR
        SELECT  a.cd_versao, /*Version*/

                upper(substr(obter_dados_pf_pj(null, b.cd_cgc,'RFC'),1,13)) cd_cpf_cgc, /*RFC*/

                to_char(a.dt_inicial, 'mm') ds_mes, /*Mes*/

                to_char(a.dt_inicial, 'yyyy') ds_ano, /*Anio*/

                a.ie_tipo_solicitacao, /*TipoSolicitud*/

                CASE WHEN a.ie_tipo_solicitacao='AF' THEN  a.nr_ordem WHEN a.ie_tipo_solicitacao='FC' THEN  a.nr_ordem  ELSE null END  nr_ordem, /*NumOrden*/

                CASE WHEN a.ie_tipo_solicitacao='DE' THEN  a.nr_ordem WHEN a.ie_tipo_solicitacao='CO' THEN  a.nr_ordem  ELSE null END  nr_tramite, /*NumTramite*/

                --null cd_selo, /*Sello*/

                a.nr_certificado_sat nr_certificado_sat, /*Certificado*/

                --null nr_nocertificado_sat, /*noCertificado*/

                b.cd_estabelecimento,
                trunc(a.dt_inicial) dt_inicial,
                fim_dia(a.dt_final) dt_final,
                a.ie_tipo_periodo
        from    ctb_regra_arquivo_mex a,
                estabelecimento b
        where   b.cd_empresa        = a.cd_empresa
        and     b.cd_estabelecimento    = coalesce(a.cd_estabelecimento, b.cd_estabelecimento)
        and     a.nr_sequencia      = nr_seq_regra_p
        and     substr(obter_dados_pf_pj(null,b.cd_cgc,'RFC'),1,255) is not null
        and exists (
            SELECT  1
            from    ctb_balancete_v x
            where   x.cd_estabelecimento = b.cd_estabelecimento
            and     x.dt_referencia between trunc(a.dt_inicial) and fim_dia(a.dt_final)
            )
        order by b.cd_estabelecimento;

    c01_w       c01%rowtype;

    c02 CURSOR FOR
        SELECT  b.cd_conta_contabil,
                substr(ctb_obter_classif_conta(b.cd_conta_contabil, b.cd_classificacao, c01_w.dt_inicial),1,40) cd_classificacao, /*NumCta*/

                substr(b.ds_conta_contabil, 1, 100) ds_conta_contabil, /*DesCta*/

                substr(rps_substituir_caractere(c.ds_historico || ' ' || a.ds_compl_historico),1,200) ds_historico, /*Concepto*/

                a.vl_movimento vl_debito, /*Debe*/

                0 vl_credito, /*Haber*/

                a.nr_sequencia nr_sequencia_ctb_movto,
                to_char(d.nr_lote_contabil) nr_lote_contabil, /*NumUnIdenPol*/

                to_char(d.dt_referencia, 'yyyy-mm-dd') dt_referencia, /*Fecha*/

                ctb_contab_mexico_pck.get_ds_tipo_lote(d.cd_tipo_lote_contabil) ds_tipo_lote_contabil, /*Concepto*/

                a.nr_seq_agrupamento nr_seq_agrupamento
        from    lote_contabil d,
                historico_padrao c,
                conta_contabil b,
                ctb_movimento a
        where   a.cd_conta_debito   = b.cd_conta_contabil
        and     a.cd_historico      = c.cd_historico
        and     a.nr_lote_contabil  = d.nr_lote_contabil
        and (c01_w.ie_tipo_periodo = 'S' or (c01_w.ie_tipo_periodo = 'N' and philips_contabil_pck.obter_tipo_grupo_conta(b.cd_conta_contabil) <> 'O'))
        and     d.dt_referencia between c01_w.dt_inicial and c01_w.dt_final
        and     d.cd_estabelecimento    = c01_w.cd_estabelecimento

union all

        SELECT  b.cd_conta_contabil,
                substr(ctb_obter_classif_conta(b.cd_conta_contabil, b.cd_classificacao, c01_w.dt_inicial),1,40) cd_classificacao, /*NumCta*/

                substr(b.ds_conta_contabil, 1, 100) ds_conta_contabil, /*DescCta*/

                substr(rps_substituir_caractere(c.ds_historico || ' ' || a.ds_compl_historico),1,200) ds_historico, /*Concepto*/

                0 vl_debito, /*Debe*/

                a.vl_movimento vl_credito, /*Haber*/

                a.nr_sequencia nr_sequencia_ctb_movto,
                to_char(d.nr_lote_contabil) nr_lote_contabil, /*NumUnIdenPol*/

                to_char(d.dt_referencia, 'yyyy-mm-dd') dt_referencia, /*Fecha*/

                ctb_contab_mexico_pck.get_ds_tipo_lote(d.cd_tipo_lote_contabil) ds_tipo_lote_contabil, /*Concepto*/

                a.nr_seq_agrupamento nr_seq_agrupamento
        from    lote_contabil d,
                historico_padrao c,
                conta_contabil b,
                ctb_movimento a
        where   a.cd_conta_credito  = b.cd_conta_contabil
        and     a.cd_historico      = c.cd_historico
        and     a.nr_lote_contabil  = d.nr_lote_contabil
        and (c01_w.ie_tipo_periodo = 'S' or (c01_w.ie_tipo_periodo = 'N' and philips_contabil_pck.obter_tipo_grupo_conta(b.cd_conta_contabil) <> 'O'))
        and     d.dt_referencia between c01_w.dt_inicial and c01_w.dt_final
        and     d.cd_estabelecimento    = c01_w.cd_estabelecimento
        order by nr_lote_contabil, nr_seq_agrupamento;

    type c02_type is table of c02%rowtype;
    c02_regs_w c02_type;
    c02_w       c02%rowtype;

    c03 CURSOR FOR
        SELECT (   SELECT  z.nr_uuid
                    from    nf_imp_arquivo z
                    where   z.nr_uuid = e.nr_documento
                    and     (z.nr_uuid IS NOT NULL AND z.nr_uuid::text <> '')  LIMIT 1) ds_uuid_cfdi, /*UUID_CFDI*/

                (   select  z.nr_ident_emissor
                    from    nf_imp_arquivo z
                    where   z.nr_uuid = e.nr_documento
                    and     (z.nr_uuid IS NOT NULL AND z.nr_uuid::text <> '')  LIMIT 1) cd_cpf_cgc, /*RFC*/

                trim(both to_char(nf.vl_total_nota,'999999999999999.99')) vl_transacao, /*MontoTotal*/

                substr(upper(obter_dados_moeda(nf.cd_moeda_estrangeira,1)),1,15) cd_moeda_estrangeira, /*Moneda*/

                trim(both to_char(nf.vl_conv_estrangeiro,'999999999999999.99')) vl_conv_estrangeiro, /*TipCamb*/

                e.nr_sequencia nr_sequencia_ctb_movto
        from    operacao_nota o,
                nota_fiscal nf,
                lote_contabil d,
                movimento_contabil_doc c,
                ctb_movimento e,
                movimento_contabil f
        where   c.nr_lote_contabil = f.nr_lote_contabil
        and     c.nr_seq_movimento = f.nr_sequencia
        and     e.nr_sequencia = f.nr_seq_ctb_movto
        and     d.nr_lote_contabil = e.nr_lote_contabil
        and     d.dt_referencia between c01_w.dt_inicial and c01_w.dt_final
        and     d.cd_estabelecimento = c01_w.cd_estabelecimento
        and     nf.nr_sequencia = c.nr_documento
        and     nf.cd_operacao_nf = o.cd_operacao_nf
        and     o.ie_operacao_fiscal = 'E'
        and     obter_se_cpf_cgc_estrangeiro(nf.cd_pessoa_fisica, nf.cd_cgc_emitente, nf.cd_estabelecimento) = 'N'
        and     c.nr_seq_info = 1 --nota fiscal entrada
union

        select  substr(coalesce(null, nf.nr_nfe_imp,(
                                    select  a.nr_nfe_imp
                                    from    nota_fiscal a
                                    where   a.nr_sequencia = nf.nr_sequencia_ref)), 1, 36) ds_uuid_cfdi, /*UUID_CFDI*/

                (   select  a.cd_cno
                    from    nota_fiscal a
                    where   a.nr_nota_fiscal = nf.nr_nota_fiscal
                    and     a.nr_sequencia = nf.nr_sequencia  LIMIT 1) cd_cpf_cgc, /*RFC*/

                trim(both to_char(nf.vl_total_nota,'999999999999999.99')) vl_transacao, /*MontoTotal*/

                substr(upper(obter_dados_moeda(nf.cd_moeda_estrangeira,1)),1,15) cd_moeda_estrangeira, /*Moneda*/

                trim(both to_char(nf.vl_conv_estrangeiro,'999999999999999.99')) vl_conv_estrangeiro, /*TipCamb*/

                e.nr_sequencia nr_sequencia_ctb_movto
        from    operacao_nota o,
                nota_fiscal nf,
                lote_contabil d,
                movimento_contabil_doc c,
                ctb_movimento e,
                movimento_contabil f
        where   c.nr_lote_contabil = f.nr_lote_contabil
        and     c.nr_seq_movimento = f.nr_sequencia
        and     e.nr_sequencia = f.nr_seq_ctb_movto
        and     d.nr_lote_contabil = e.nr_lote_contabil
        and     d.dt_referencia between c01_w.dt_inicial and c01_w.dt_final
        and     d.cd_estabelecimento = c01_w.cd_estabelecimento
        and     nf.nr_sequencia = c.nr_documento
        and     nf.cd_operacao_nf = o.cd_operacao_nf
        and     o.ie_operacao_fiscal = 'S'
        and     obter_se_cpf_cgc_estrangeiro(nf.cd_pessoa_fisica, nf.cd_cgc_emitente, nf.cd_estabelecimento) = 'N'
        and     c.nr_seq_info = 1 --nota fiscal saida
        
union

        select  substr(coalesce(null, nff.nr_nfe_imp,(
                                    select  a.nr_nfe_imp
                                    from    nota_fiscal a
                                    where   a.nr_sequencia = nff.nr_sequencia_ref)), 1, 36) ds_uuid_cfdi, /*UUID_CFDI*/

                (   select  a.cd_cno
                    from    nota_fiscal a
                    where   a.nr_nota_fiscal = nff.nr_nota_fiscal
                    and     a.nr_sequencia = nff.nr_sequencia  LIMIT 1) cd_cpf_cgc, /*RFC*/

                trim(both to_char(nff.vl_total_nota,'999999999999999.99')) vl_transacao, /*MontoTotal*/

                substr(upper(obter_dados_moeda(nff.cd_moeda_estrangeira,1)),1 ,15) cd_moeda_estrangeira, /*Moneda*/

                trim(both to_char(nff.vl_conv_estrangeiro,'999999999999999.99')) vl_conv_estrangeiro, /*TipCamb*/

                w.nr_sequencia_ctb_movto
        from (
                select  nf.nr_sequencia,
                        e.nr_sequencia  nr_sequencia_ctb_movto
                from    nota_fiscal nf,
                        lote_contabil d,
                        movimento_contabil_doc c,
                        ctb_movimento e,
                        movimento_contabil f
                where   c.nr_lote_contabil = f.nr_lote_contabil
                and     c.nr_seq_movimento = f.nr_sequencia
                and     e.nr_sequencia = f.nr_seq_ctb_movto
                and     d.nr_lote_contabil = e.nr_lote_contabil
                and     d.dt_referencia between c01_w.dt_inicial and c01_w.dt_final
                and     d.cd_estabelecimento = c01_w.cd_estabelecimento
                and     nf.nr_interno_conta = c.nr_seq_doc_compl
                and     c.nr_seq_info in (6,7)
                
union all

                select  nf.nr_sequencia,
                        e.nr_sequencia nr_sequencia_ctb_movto
                from    conta_paciente cp,
                        nota_fiscal nf,
                        lote_contabil d,
                        movimento_contabil_doc c,
                        ctb_movimento e,
                        movimento_contabil f
                where   c.nr_lote_contabil = f.nr_lote_contabil
                and     c.nr_seq_movimento = f.nr_sequencia
                and     e.nr_sequencia = f.nr_seq_ctb_movto
                and     d.nr_lote_contabil = e.nr_lote_contabil
                and     d.dt_referencia between c01_w.dt_inicial and c01_w.dt_final
                and     d.cd_estabelecimento = c01_w.cd_estabelecimento
                and     cp.nr_seq_protocolo = nf.nr_seq_protocolo
                and     cp.nr_interno_conta = c.nr_seq_doc_compl
                and     c.nr_seq_info in (6,7)
                ) w,
                nota_fiscal nff
        where   nff.nr_sequencia       = w.nr_sequencia
        and     nff.ie_situacao    = '1' --Receitas

        
union

        select  coalesce(   c.nr_nfe_imp,
                            obter_uuid_cfdi(    e.nr_sequencia,
                                                e.nr_lote_contabil,
                                                coalesce(e.cd_estabelecimento,d.cd_estabelecimento)),
                            e.nr_documento) cd_cpf_cgc, /*UUID_CFDI*/

                (   select  n.cd_cno
                    from    nota_fiscal n
                    where   n.nr_sequencia = t.nr_seq_nf_saida  LIMIT 1) cd_cpf_cgc, /*RFC*/

                trim(both to_char(nf.VL_RECEBIDO,'999999999999999.99')) vl_transacao, /*MontoTotal*/

                substr(upper(obter_dados_moeda(nf.CD_MOEDA,1)),1,15) cd_moeda_estrangeira, /*Moneda*/

                trim(both to_char(nf.VL_RECEBIDO_ESTRANG,'999999999999999.99')) vl_conv_estrangeiro, /*TipCamb*/

                e.nr_sequencia nr_sequencia_ctb_movto
        from    titulo_receber_liq nf,
                titulo_receber t,
                lote_contabil d,
                movimento_contabil_doc c,
                ctb_movimento e,
                movimento_contabil f
        where   c.nr_lote_contabil = f.nr_lote_contabil
        and     c.nr_seq_movimento = f.nr_sequencia
        and     t.nr_titulo = c.nr_documento
        and     nf.nr_titulo = t.nr_titulo
        and     e.nr_sequencia = f.nr_seq_ctb_movto
        and     d.nr_lote_contabil = e.nr_lote_contabil
        and     d.dt_referencia between c01_w.dt_inicial and c01_w.dt_final
        and     d.cd_estabelecimento = c01_w.cd_estabelecimento
        and     c.nr_seq_doc_compl = nf.nr_sequencia
        and     nf.nr_titulo = c.nr_documento
        and     c.nr_seq_info = 14 --contas a receber
        
union

        select  coalesce(   c.nr_nfe_imp,
                            obter_uuid_cfdi(    e.nr_sequencia,
                                                e.nr_lote_contabil,
                                                coalesce(e.cd_estabelecimento,d.cd_estabelecimento)),
                            e.nr_documento) cd_cpf_cgc, /*UUID_CFDI*/

                (   select  z.nr_ident_emissor
                    from    nf_imp_arquivo z
                    where   z.nr_uuid = e.nr_documento
                    and     (z.nr_uuid IS NOT NULL AND z.nr_uuid::text <> '')  LIMIT 1) cd_cpf_cgc, /*RFC*/

                trim(both to_char(nf.VL_BAIXA,'999999999999999.99')) vl_transacao, /*MontoTotal*/

                substr(upper(obter_dados_moeda(nf.CD_MOEDA,1)),1,15) cd_moeda_estrangeira, /*Moneda*/

                trim(both to_char(nf.VL_BAIXA_ESTRANG,'999999999999999.99')) vl_conv_estrangeiro, /*TipCamb*/

                e.nr_sequencia nr_sequencia_ctb_movto
        from    titulo_pagar_baixa nf,
                titulo_pagar t,
                lote_contabil d,
                movimento_contabil_doc c,
                ctb_movimento e,
                movimento_contabil f
        where   c.nr_lote_contabil = f.nr_lote_contabil
        and     c.nr_seq_movimento = f.nr_sequencia
        and     t.nr_titulo = c.nr_documento
        and     nf.nr_titulo = t.nr_titulo
        and     d.nr_lote_contabil = c.nr_lote_contabil
        and     e.nr_sequencia = f.nr_seq_ctb_movto
        and     d.nr_lote_contabil = e.nr_lote_contabil
        and     d.dt_referencia between c01_w.dt_inicial and c01_w.dt_final
        and     d.cd_estabelecimento = c01_w.cd_estabelecimento
        and     c.nr_seq_doc_compl = nf.nr_sequencia
        and     nf.nr_titulo = c.nr_documento
        and     c.nr_seq_info = 13 --contas a pagar
        
union

        select  e.nr_documento cd_cpf_cgc, /*UUID_CFDI*/

                ctb_obter_rfc(e.nr_sequencia, e.nr_lote_contabil, d.cd_estabelecimento) cd_cpf_cgc, /*RFC*/

                trim(both to_char(e.vl_movimento,'999999999999999.99')) vl_transacao, /*MontoTotal*/

                substr(upper(obter_dados_moeda(null,1)),1,15) cd_moeda_estrangeira, /*Moneda*/

                trim(both to_char(null,'999999999999999.99')) vl_conv_estrangeiro, /*TipCamb*/

                e.nr_sequencia nr_sequencia_ctb_movto
        from    lote_contabil d,
                ctb_movimento e
        where   d.nr_lote_contabil = e.nr_lote_contabil
        and     d.dt_referencia between c01_w.dt_inicial and c01_w.dt_final
        and     d.cd_estabelecimento = c01_w.cd_estabelecimento
        and     d.cd_tipo_lote_contabil = 12 --Lote de digitacao
        and     d.ie_status_origem = 'TIE'; --Apenas integracao

    type c03_type is table of c03%rowtype;
    c03_regs_w c03_type;

    c04 CURSOR FOR
        SELECT  d.nr_nota_fiscal, /*NumFactExt*/

                upper(substr(coalesce(obter_cpf_pessoa_fisica(d.cd_pessoa_fisica), d.cd_cgc_emitente),1,200)) cd_cpf_cgc, /*TaxID*/

                trim(both to_char(d.vl_total_nota,'999999999999999.99')) vl_transacao, /*MontoTotal*/

                coalesce(substr(upper(obter_dados_moeda(d.cd_moeda_estrangeira,1)),1 , 15), 'MXN') cd_moeda_estrangeira, /*Moneda*/

                trim(both to_char(d.vl_conv_estrangeiro,'999999999999999.99')) vl_conv_estrangeiro, /*TipCamb*/

                e.nr_sequencia nr_sequencia_ctb_movto
        from    nota_fiscal d,
                lote_contabil lc,
                movimento_contabil_doc c,
                ctb_movimento e,
                movimento_contabil f
        where   d.nr_sequencia = c.nr_documento
        and     c.nr_lote_contabil = f.nr_lote_contabil
        and     c.nr_seq_movimento = f.nr_sequencia
        and     e.nr_sequencia = f.nr_seq_ctb_movto
        and     lc.nr_lote_contabil = e.nr_lote_contabil
        and     lc.dt_referencia between c01_w.dt_inicial and c01_w.dt_final
        and     lc.cd_estabelecimento = c01_w.cd_estabelecimento
        and     c.nr_seq_info = 1
        and     obter_se_cpf_cgc_estrangeiro(null, d.cd_cgc_emitente, d.cd_estabelecimento) = 'S';

    type c04_type is table of c04%rowtype;
    c04_regs_w c04_type;

    c05 CURSOR FOR
        SELECT  distinct i.nr_cheque, /*Num*/

                substr(obter_dados_banco_conta(i.nr_seq_conta_banco, 'CDB'), 1, 60) cd_banco, /*BanEmisNal*/

                -- null banemisext, /* BanEmisExt*/

                obter_dados_banco_conta(i.nr_seq_conta_banco, 'CDCD') cd_conta_digito, /*CtaOri*/

                to_char(i.dt_emissao, 'yyyy-mm-dd') dt_referencia, /*Fecha*/

                substr(rps_substituir_caractere(obter_nome_pf_pj(d.cd_pessoa_fisica, d.cd_cgc)),1,200) ds_nome_pf_pj, /*Benef*/

                upper(substr(obter_dados_pf_pj(d.cd_pessoa_fisica, d.cd_cgc,'RFC'),1,200)) cd_cpf_cgc, /*RFC*/

                trim(both to_char(i.vl_cheque,'999999999999999.99')) vl_transacao, /*Monto*/

                coalesce(substr(upper(obter_dados_moeda(i.cd_moeda,1)),1 , 15), 'MXN') cd_moeda_estrangeira, /*Moneda*/

                trim(both to_char(i.vl_cotacao,'999999999999999.99')) vl_conv_estrangeiro, /*TipCamb*/

                e.nr_sequencia nr_sequencia_ctb_movto
        from    titulo_pagar_baixa_contab_v a,
                titulo_pagar_baixa_cc b,
                titulo_pagar d,
                tipo_baixa_cpa g,
                cheque_bordero_titulo h,
                cheque i,
                lote_contabil lc,
                movimento_contabil_doc c,
                ctb_movimento e,
                movimento_contabil f
        where   b.nr_titulo      = a.nr_titulo
        and     c.nr_lote_contabil = f.nr_lote_contabil
        and     c.nr_seq_movimento = f.nr_sequencia
        and     e.nr_sequencia = f.nr_seq_ctb_movto
        and     lc.nr_lote_contabil = e.nr_lote_contabil
        and     lc.dt_referencia between c01_w.dt_inicial and c01_w.dt_final
        and     d.cd_estabelecimento = c01_w.cd_estabelecimento
        and     b.nr_seq_baixa     = a.nr_seq_baixa
        and     d.nr_titulo        = a.nr_titulo
        and     a.cd_tipo_baixa    = g.cd_tipo_baixa
        and     a.nr_titulo = h.nr_titulo
        and     h.nr_seq_cheque = i.nr_sequencia
        and     g.cd_integracao_externa = '02'
        and     coalesce(i.dt_cancelamento::text, '') = ''
        and     c.nm_atributo = a.ds_atributo
        and     c.nr_documento = d.nr_titulo
        and     c.nr_seq_doc_compl = b.nr_seq_baixa;

    type c05_type is table of c05%rowtype;
    c05_regs_w c05_type;

    c06 CURSOR FOR
        SELECT  substr(obter_dados_banco_conta(a.nr_seq_conta_banco, 'CDCD'),1,50) cd_conta_digito, /*CtaOri*/

                substr(obter_dados_banco_conta(a.nr_seq_conta_banco, 'CDB'),1,200) cd_banco, /*BancoOriNal*/

                -- null banco_ori_ext, /*BancoOriExt*/

                h.nr_conta cd_conta_dest, /*CtaDest*/

                substr(obter_dados_banco_conta(h.cd_banco, 'CDB'),1,200) cd_banco_dest, /*BancoDestNal*/

                -- null banco_des_ext, /*BancoDestExt*/

                to_char(e.dt_movimento, 'yyyy-mm-dd') dt_referencia, /*Fecha*/

                substr(obter_nome_pf_pj(d.cd_pessoa_fisica, d.cd_cgc),1,200) ds_nome_pf_pj, /*Benef*/

                upper(substr(obter_dados_pf_pj(d.cd_pessoa_fisica, d.cd_cgc,'RFC'),1,200)) cd_cpf_cgc, /*RFC*/

                trim(both to_char(a.vl_transacao,'999999999999999.99')) vl_transacao, /*Monto*/

                substr(obter_dados_banco_conta(a.nr_seq_conta_banco, 'CDME'), 1, 15) cd_moeda_estrangeira, /*Moneda*/

                -- null tipo_camb, /*TipoCamb*/

                e.nr_sequencia nr_sequencia_ctb_movto
        from    titulo_pagar_baixa_contab_v a,
                titulo_pagar_baixa_cc b,
                titulo_pagar d,
                tipo_baixa_cpa g,
                titulo_pagar_favorecido h,
                lote_contabil lc,
                movimento_contabil_doc c,
                ctb_movimento e,
                movimento_contabil f
        where   b.nr_titulo      = a.nr_titulo
        and     c.nr_lote_contabil = f.nr_lote_contabil
        and     c.nr_seq_movimento = f.nr_sequencia
        and     e.nr_sequencia = f.nr_seq_ctb_movto
        and     lc.nr_lote_contabil = e.nr_lote_contabil
        and     b.nr_seq_baixa     = a.nr_seq_baixa
        and     d.nr_titulo        = a.nr_titulo
        and     a.cd_tipo_baixa    = g.cd_tipo_baixa
        and     a.nr_titulo = h.nr_titulo
        and     c.nm_atributo = a.ds_atributo
        and     c.nr_documento = d.nr_titulo
        and     c.nr_seq_doc_compl = b.nr_seq_baixa
        and     lc.dt_referencia between c01_w.dt_inicial and c01_w.dt_final
        and     lc.cd_estabelecimento = c01_w.cd_estabelecimento
        and     g.cd_integracao_externa = '03';

    type c06_type is table of c06%rowtype;
    c06_regs_w c06_type;

    c07 CURSOR FOR
        SELECT  g.cd_integracao_externa, /*MetPagoPol*/

                to_char(a.dt_baixa, 'yyyy-mm-dd') dt_referencia, /*Fecha*/

                substr(rps_substituir_caractere(obter_nome_pf_pj(d.cd_pessoa_fisica, d.cd_cgc)),1,200) ds_nome_pf_pj, /*Benef*/

                upper(substr(obter_dados_pf_pj(d.cd_pessoa_fisica, d.cd_cgc,'RFC'),1,200)) cd_cpf_cgc, /*RFC*/

                trim(both to_char(coalesce(b.vl_baixa, a.vl_transacao),'999999999999999.99')) vl_transacao, /*Monto*/

                substr(upper(obter_dados_moeda(null,1)),1 , 15) cd_moeda_estrangeira, /*Moneda*/

                -- null tipcamb, /*TipCamb*/

                e.nr_sequencia nr_sequencia_ctb_movto
        from    titulo_pagar_baixa_contab_v a,
                titulo_pagar_baixa_cc b,
                titulo_pagar d,
                tipo_baixa_cpa g,
                lote_contabil lc,
                movimento_contabil_doc c,
                ctb_movimento e,
                movimento_contabil f
        where   b.nr_titulo      = a.nr_titulo
        and     c.nr_lote_contabil = f.nr_lote_contabil
        and     c.nr_seq_movimento = f.nr_sequencia
        and     e.nr_sequencia = f.nr_seq_ctb_movto
        and     lc.nr_lote_contabil = e.nr_lote_contabil
        and     lc.dt_referencia between c01_w.dt_inicial and c01_w.dt_final
        and     lc.cd_estabelecimento = c01_w.cd_estabelecimento
        and     b.nr_seq_baixa     = a.nr_seq_baixa
        and     d.nr_titulo        = a.nr_titulo
        and     a.cd_tipo_baixa    = g.cd_tipo_baixa
        and     g.cd_integracao_externa not in ('03','02')
        and     c.nr_documento     = d.nr_titulo
        and     c.nr_seq_doc_compl = b.nr_seq_baixa
        and     c.nm_atributo      = a.ds_atributo;

    type c07_type is table of c07%rowtype;
    c07_regs_w c07_type;

    qt_registro_w   bigint;


BEGIN

    delete
    from    w_ctb_contab_mexico a
    where   a.nr_seq_regra = nr_seq_regra_p;
    commit;

    open c01;
    loop
    fetch c01 into
        c01_w;
    EXIT WHEN NOT FOUND; /* apply on c01 */
        begin
        PERFORM set_config('ctb_contab_mexico_pck.ctb_contab_mexico_w', null, false);
        PERFORM set_config('ctb_contab_mexico_pck.nr_sequencia_w', current_setting('ctb_contab_mexico_pck.nr_sequencia_w')::integer+1, false);
        current_setting('ctb_contab_mexico_pck.ctb_contab_mexico_w')::w_ctb_contab_mexico%rowtype.nr_sequencia        := current_setting('ctb_contab_mexico_pck.nr_sequencia_w')::integer;
        current_setting('ctb_contab_mexico_pck.ctb_contab_mexico_w')::w_ctb_contab_mexico%rowtype.nr_seq_superior     := 0;
        current_setting('ctb_contab_mexico_pck.ctb_contab_mexico_w')::w_ctb_contab_mexico%rowtype.ie_tipo_atributo    := current_setting('ctb_contab_mexico_pck.tipo_registro')::r_tipo_registro.polizas_del_periodo;
        current_setting('ctb_contab_mexico_pck.ctb_contab_mexico_w')::w_ctb_contab_mexico%rowtype.nr_seq_regra        := nr_seq_regra_p;
        current_setting('ctb_contab_mexico_pck.ctb_contab_mexico_w')::w_ctb_contab_mexico%rowtype.nm_usuario          := nm_usuario_p;
        current_setting('ctb_contab_mexico_pck.ctb_contab_mexico_w')::w_ctb_contab_mexico%rowtype.dt_atualizacao      := clock_timestamp();
        current_setting('ctb_contab_mexico_pck.ctb_contab_mexico_w')::w_ctb_contab_mexico%rowtype.cd_versao           := c01_w.cd_versao;
        current_setting('ctb_contab_mexico_pck.ctb_contab_mexico_w')::w_ctb_contab_mexico%rowtype.cd_cpf_cgc          := c01_w.cd_cpf_cgc;
        current_setting('ctb_contab_mexico_pck.ctb_contab_mexico_w')::w_ctb_contab_mexico%rowtype.ds_mes              := c01_w.ds_mes;
        current_setting('ctb_contab_mexico_pck.ctb_contab_mexico_w')::w_ctb_contab_mexico%rowtype.ds_ano              := c01_w.ds_ano;
        current_setting('ctb_contab_mexico_pck.ctb_contab_mexico_w')::w_ctb_contab_mexico%rowtype.ie_tipo_solicitacao := c01_w.ie_tipo_solicitacao;
        current_setting('ctb_contab_mexico_pck.ctb_contab_mexico_w')::w_ctb_contab_mexico%rowtype.nr_ordem            := c01_w.nr_ordem;
        current_setting('ctb_contab_mexico_pck.ctb_contab_mexico_w')::w_ctb_contab_mexico%rowtype.nr_tramite          := c01_w.nr_tramite;
        current_setting('ctb_contab_mexico_pck.ctb_contab_mexico_w')::w_ctb_contab_mexico%rowtype.nr_certificado_sat  := c01_w.nr_certificado_sat;
        current_setting('ctb_contab_mexico_pck.ctb_contab_mexico_w')::w_ctb_contab_mexico%rowtype.cd_estabelecimento  := c01_w.cd_estabelecimento;

        current_setting('ctb_contab_mexico_pck.lista_ctb_contab_mexico_w')::t_lista_ctb_contab_mexico(current_setting('ctb_contab_mexico_pck.lista_ctb_contab_mexico_w')::t_lista_ctb_contab_mexico.count) := current_setting('ctb_contab_mexico_pck.ctb_contab_mexico_w')::w_ctb_contab_mexico%rowtype;

        if (current_setting('ctb_contab_mexico_pck.lista_ctb_contab_mexico_w')::t_lista_ctb_contab_mexico.count > 100) then
            current_setting('ctb_contab_mexico_pck.lista_ctb_contab_mexico_w')::t_lista_ctb_contab_mexico := ctb_contab_mexico_pck.inserir_ctb_contab_mexico(current_setting('ctb_contab_mexico_pck.lista_ctb_contab_mexico_w')::t_lista_ctb_contab_mexico);
        end if;

        current_setting('ctb_contab_mexico_pck.ctb_contab_mexico_w')::w_ctb_contab_mexico%rowtype.nr_lote_contabil := 0;
        PERFORM set_config('ctb_contab_mexico_pck.nr_seq_sup_c01_w', current_setting('ctb_contab_mexico_pck.nr_sequencia_w')::integer, false);

        commit;
        open c02;
        loop
        fetch c02 bulk collect into c02_regs_w limit 100;
            for ic02 in 1..c02_regs_w.count loop
                begin
                c02_w := c02_regs_w(ic02);
                if (current_setting('ctb_contab_mexico_pck.ctb_contab_mexico_w')::w_ctb_contab_mexico%rowtype.nr_lote_contabil <> c02_w.nr_lote_contabil) then
                    PERFORM set_config('ctb_contab_mexico_pck.nr_sequencia_w', current_setting('ctb_contab_mexico_pck.nr_sequencia_w')::integer+1, false);
                    current_setting('ctb_contab_mexico_pck.ctb_contab_mexico_w')::w_ctb_contab_mexico%rowtype.nr_sequencia            := current_setting('ctb_contab_mexico_pck.nr_sequencia_w')::integer;
                    current_setting('ctb_contab_mexico_pck.ctb_contab_mexico_w')::w_ctb_contab_mexico%rowtype.nr_seq_superior         := current_setting('ctb_contab_mexico_pck.nr_seq_sup_c01_w')::integer;
                    current_setting('ctb_contab_mexico_pck.ctb_contab_mexico_w')::w_ctb_contab_mexico%rowtype.ie_tipo_atributo        := current_setting('ctb_contab_mexico_pck.tipo_registro')::r_tipo_registro.poliza;
                    current_setting('ctb_contab_mexico_pck.ctb_contab_mexico_w')::w_ctb_contab_mexico%rowtype.nr_lote_contabil        := c02_w.nr_lote_contabil;
                    current_setting('ctb_contab_mexico_pck.ctb_contab_mexico_w')::w_ctb_contab_mexico%rowtype.dt_referencia           := c02_w.dt_referencia;
                    current_setting('ctb_contab_mexico_pck.ctb_contab_mexico_w')::w_ctb_contab_mexico%rowtype.ds_tipo_lote_contabil   := c02_w.ds_tipo_lote_contabil;
                    current_setting('ctb_contab_mexico_pck.ctb_contab_mexico_w')::w_ctb_contab_mexico%rowtype.cd_conta_contabil       := null;
                    current_setting('ctb_contab_mexico_pck.ctb_contab_mexico_w')::w_ctb_contab_mexico%rowtype.ds_conta_contabil       := null;
                    current_setting('ctb_contab_mexico_pck.ctb_contab_mexico_w')::w_ctb_contab_mexico%rowtype.ds_historico            := null;
                    current_setting('ctb_contab_mexico_pck.ctb_contab_mexico_w')::w_ctb_contab_mexico%rowtype.vl_debito               := null;
                    current_setting('ctb_contab_mexico_pck.ctb_contab_mexico_w')::w_ctb_contab_mexico%rowtype.vl_credito              := null;
                    current_setting('ctb_contab_mexico_pck.ctb_contab_mexico_w')::w_ctb_contab_mexico%rowtype.nr_sequencia_ctb_movto  := null;

                    current_setting('ctb_contab_mexico_pck.lista_ctb_contab_mexico_w')::t_lista_ctb_contab_mexico(current_setting('ctb_contab_mexico_pck.lista_ctb_contab_mexico_w')::t_lista_ctb_contab_mexico.count) := current_setting('ctb_contab_mexico_pck.ctb_contab_mexico_w')::w_ctb_contab_mexico%rowtype;
                    current_setting('ctb_contab_mexico_pck.ctb_contab_mexico_w')::w_ctb_contab_mexico%rowtype.nr_seq_superior     := current_setting('ctb_contab_mexico_pck.nr_sequencia_w')::integer;
                end if;

                PERFORM set_config('ctb_contab_mexico_pck.nr_sequencia_w', current_setting('ctb_contab_mexico_pck.nr_sequencia_w')::integer+1, false);
                current_setting('ctb_contab_mexico_pck.ctb_contab_mexico_w')::w_ctb_contab_mexico%rowtype.nr_sequencia            := current_setting('ctb_contab_mexico_pck.nr_sequencia_w')::integer;
                current_setting('ctb_contab_mexico_pck.ctb_contab_mexico_w')::w_ctb_contab_mexico%rowtype.ie_tipo_atributo        := current_setting('ctb_contab_mexico_pck.tipo_registro')::r_tipo_registro.transaccion;
                current_setting('ctb_contab_mexico_pck.ctb_contab_mexico_w')::w_ctb_contab_mexico%rowtype.cd_conta_contabil       := c02_w.cd_conta_contabil;
                current_setting('ctb_contab_mexico_pck.ctb_contab_mexico_w')::w_ctb_contab_mexico%rowtype.cd_classificacao        := c02_w.cd_classificacao;
                current_setting('ctb_contab_mexico_pck.ctb_contab_mexico_w')::w_ctb_contab_mexico%rowtype.ds_conta_contabil       := c02_w.ds_conta_contabil;
                current_setting('ctb_contab_mexico_pck.ctb_contab_mexico_w')::w_ctb_contab_mexico%rowtype.ds_historico            := c02_w.ds_historico;
                current_setting('ctb_contab_mexico_pck.ctb_contab_mexico_w')::w_ctb_contab_mexico%rowtype.vl_debito               := c02_w.vl_debito;
                current_setting('ctb_contab_mexico_pck.ctb_contab_mexico_w')::w_ctb_contab_mexico%rowtype.vl_credito              := c02_w.vl_credito;
                current_setting('ctb_contab_mexico_pck.ctb_contab_mexico_w')::w_ctb_contab_mexico%rowtype.nr_sequencia_ctb_movto  := c02_w.nr_sequencia_ctb_movto;

                current_setting('ctb_contab_mexico_pck.lista_ctb_contab_mexico_w')::t_lista_ctb_contab_mexico(current_setting('ctb_contab_mexico_pck.lista_ctb_contab_mexico_w')::t_lista_ctb_contab_mexico.count) := current_setting('ctb_contab_mexico_pck.ctb_contab_mexico_w')::w_ctb_contab_mexico%rowtype;
                if (current_setting('ctb_contab_mexico_pck.lista_ctb_contab_mexico_w')::t_lista_ctb_contab_mexico.count > 100) then
                    current_setting('ctb_contab_mexico_pck.lista_ctb_contab_mexico_w')::t_lista_ctb_contab_mexico := ctb_contab_mexico_pck.inserir_ctb_contab_mexico(current_setting('ctb_contab_mexico_pck.lista_ctb_contab_mexico_w')::t_lista_ctb_contab_mexico);
                end if;

                end;
            end loop;
        EXIT WHEN NOT FOUND; /* apply on c02 */
        end loop;
        close c02;
        commit;
        current_setting('ctb_contab_mexico_pck.ctb_contab_mexico_w')::w_ctb_contab_mexico%rowtype.nr_sequencia            := null;
        current_setting('ctb_contab_mexico_pck.ctb_contab_mexico_w')::w_ctb_contab_mexico%rowtype.nr_seq_superior         := null;
        current_setting('ctb_contab_mexico_pck.ctb_contab_mexico_w')::w_ctb_contab_mexico%rowtype.ie_tipo_atributo        := null;
        current_setting('ctb_contab_mexico_pck.ctb_contab_mexico_w')::w_ctb_contab_mexico%rowtype.nr_lote_contabil        := null;
        current_setting('ctb_contab_mexico_pck.ctb_contab_mexico_w')::w_ctb_contab_mexico%rowtype.dt_referencia           := null;
        current_setting('ctb_contab_mexico_pck.ctb_contab_mexico_w')::w_ctb_contab_mexico%rowtype.ds_tipo_lote_contabil   := null;
        current_setting('ctb_contab_mexico_pck.ctb_contab_mexico_w')::w_ctb_contab_mexico%rowtype.cd_conta_contabil       := null;
        current_setting('ctb_contab_mexico_pck.ctb_contab_mexico_w')::w_ctb_contab_mexico%rowtype.ds_conta_contabil       := null;
        current_setting('ctb_contab_mexico_pck.ctb_contab_mexico_w')::w_ctb_contab_mexico%rowtype.ds_historico            := null;
        current_setting('ctb_contab_mexico_pck.ctb_contab_mexico_w')::w_ctb_contab_mexico%rowtype.vl_debito               := null;
        current_setting('ctb_contab_mexico_pck.ctb_contab_mexico_w')::w_ctb_contab_mexico%rowtype.vl_credito              := null;
        current_setting('ctb_contab_mexico_pck.ctb_contab_mexico_w')::w_ctb_contab_mexico%rowtype.nr_sequencia_ctb_movto  := null;
        open c03;
        loop
        fetch c03 bulk collect into c03_regs_w limit 100;
            for ic03 in 1..c03_regs_w.count loop
                begin

                PERFORM set_config('ctb_contab_mexico_pck.nr_sequencia_w', current_setting('ctb_contab_mexico_pck.nr_sequencia_w')::integer+1, false);
                current_setting('ctb_contab_mexico_pck.ctb_contab_mexico_w')::w_ctb_contab_mexico%rowtype.nr_sequencia            := current_setting('ctb_contab_mexico_pck.nr_sequencia_w')::integer;
                current_setting('ctb_contab_mexico_pck.ctb_contab_mexico_w')::w_ctb_contab_mexico%rowtype.ie_tipo_atributo        := current_setting('ctb_contab_mexico_pck.tipo_registro')::r_tipo_registro.comp_nal;
                current_setting('ctb_contab_mexico_pck.ctb_contab_mexico_w')::w_ctb_contab_mexico%rowtype.ds_uuid_cfdi            := c03_regs_w[ic03].ds_uuid_cfdi;
                current_setting('ctb_contab_mexico_pck.ctb_contab_mexico_w')::w_ctb_contab_mexico%rowtype.cd_cpf_cgc              := c03_regs_w[ic03].cd_cpf_cgc;
                current_setting('ctb_contab_mexico_pck.ctb_contab_mexico_w')::w_ctb_contab_mexico%rowtype.vl_transacao            := c03_regs_w[ic03].vl_transacao;
                current_setting('ctb_contab_mexico_pck.ctb_contab_mexico_w')::w_ctb_contab_mexico%rowtype.cd_moeda_estrangeira    := c03_regs_w[ic03].cd_moeda_estrangeira;
                current_setting('ctb_contab_mexico_pck.ctb_contab_mexico_w')::w_ctb_contab_mexico%rowtype.vl_conv_estrangeiro     := c03_regs_w[ic03].vl_conv_estrangeiro;
                current_setting('ctb_contab_mexico_pck.ctb_contab_mexico_w')::w_ctb_contab_mexico%rowtype.nr_sequencia_ctb_movto  := c03_regs_w[ic03].nr_sequencia_ctb_movto;
                current_setting('ctb_contab_mexico_pck.ctb_contab_mexico_w')::w_ctb_contab_mexico%rowtype.nr_seq_superior         := c03_regs_w[ic03].nr_sequencia_ctb_movto;

                current_setting('ctb_contab_mexico_pck.lista_ctb_contab_mexico_w')::t_lista_ctb_contab_mexico(current_setting('ctb_contab_mexico_pck.lista_ctb_contab_mexico_w')::t_lista_ctb_contab_mexico.count) := current_setting('ctb_contab_mexico_pck.ctb_contab_mexico_w')::w_ctb_contab_mexico%rowtype;
                if (current_setting('ctb_contab_mexico_pck.lista_ctb_contab_mexico_w')::t_lista_ctb_contab_mexico.count > 100) then
                    current_setting('ctb_contab_mexico_pck.lista_ctb_contab_mexico_w')::t_lista_ctb_contab_mexico := ctb_contab_mexico_pck.inserir_ctb_contab_mexico(current_setting('ctb_contab_mexico_pck.lista_ctb_contab_mexico_w')::t_lista_ctb_contab_mexico);
                end if;

                end;
            end loop;
        EXIT WHEN NOT FOUND; /* apply on c03 */
        end loop;
        close c03;
        commit;
        open c04;
        loop
        fetch c04 bulk collect into c04_regs_w limit 100;
            for ic04 in 1..c04_regs_w.count loop
                begin

                PERFORM set_config('ctb_contab_mexico_pck.nr_sequencia_w', current_setting('ctb_contab_mexico_pck.nr_sequencia_w')::integer+1, false);
                current_setting('ctb_contab_mexico_pck.ctb_contab_mexico_w')::w_ctb_contab_mexico%rowtype.nr_sequencia            := current_setting('ctb_contab_mexico_pck.nr_sequencia_w')::integer;
                current_setting('ctb_contab_mexico_pck.ctb_contab_mexico_w')::w_ctb_contab_mexico%rowtype.ie_tipo_atributo        := current_setting('ctb_contab_mexico_pck.tipo_registro')::r_tipo_registro.comp_ext;
                current_setting('ctb_contab_mexico_pck.ctb_contab_mexico_w')::w_ctb_contab_mexico%rowtype.nr_nota_fiscal          := c04_regs_w[ic04].nr_nota_fiscal;
                current_setting('ctb_contab_mexico_pck.ctb_contab_mexico_w')::w_ctb_contab_mexico%rowtype.cd_cpf_cgc              := c04_regs_w[ic04].cd_cpf_cgc;
                current_setting('ctb_contab_mexico_pck.ctb_contab_mexico_w')::w_ctb_contab_mexico%rowtype.vl_transacao            := c04_regs_w[ic04].vl_transacao;
                current_setting('ctb_contab_mexico_pck.ctb_contab_mexico_w')::w_ctb_contab_mexico%rowtype.cd_moeda_estrangeira    := c04_regs_w[ic04].cd_moeda_estrangeira;
                current_setting('ctb_contab_mexico_pck.ctb_contab_mexico_w')::w_ctb_contab_mexico%rowtype.vl_conv_estrangeiro     := c04_regs_w[ic04].vl_conv_estrangeiro;
                current_setting('ctb_contab_mexico_pck.ctb_contab_mexico_w')::w_ctb_contab_mexico%rowtype.nr_sequencia_ctb_movto  := c04_regs_w[ic04].nr_sequencia_ctb_movto;
                current_setting('ctb_contab_mexico_pck.ctb_contab_mexico_w')::w_ctb_contab_mexico%rowtype.nr_seq_superior         := c04_regs_w[ic04].nr_sequencia_ctb_movto;

                current_setting('ctb_contab_mexico_pck.lista_ctb_contab_mexico_w')::t_lista_ctb_contab_mexico(current_setting('ctb_contab_mexico_pck.lista_ctb_contab_mexico_w')::t_lista_ctb_contab_mexico.count) := current_setting('ctb_contab_mexico_pck.ctb_contab_mexico_w')::w_ctb_contab_mexico%rowtype;
                if (current_setting('ctb_contab_mexico_pck.lista_ctb_contab_mexico_w')::t_lista_ctb_contab_mexico.count > 100) then
                    current_setting('ctb_contab_mexico_pck.lista_ctb_contab_mexico_w')::t_lista_ctb_contab_mexico := ctb_contab_mexico_pck.inserir_ctb_contab_mexico(current_setting('ctb_contab_mexico_pck.lista_ctb_contab_mexico_w')::t_lista_ctb_contab_mexico);
                end if;

                end;
            end loop;
        EXIT WHEN NOT FOUND; /* apply on c04 */
        end loop;
        close c04;

        commit;
        open c05;
        loop
        fetch c05 bulk collect into c05_regs_w limit 100;
            for ic05 in 1..c05_regs_w.count loop
                begin
                PERFORM set_config('ctb_contab_mexico_pck.nr_sequencia_w', current_setting('ctb_contab_mexico_pck.nr_sequencia_w')::integer+1, false);
                current_setting('ctb_contab_mexico_pck.ctb_contab_mexico_w')::w_ctb_contab_mexico%rowtype.nr_sequencia            := current_setting('ctb_contab_mexico_pck.nr_sequencia_w')::integer;
                current_setting('ctb_contab_mexico_pck.ctb_contab_mexico_w')::w_ctb_contab_mexico%rowtype.ie_tipo_atributo        := current_setting('ctb_contab_mexico_pck.tipo_registro')::r_tipo_registro.cheque;
                current_setting('ctb_contab_mexico_pck.ctb_contab_mexico_w')::w_ctb_contab_mexico%rowtype.nr_cheque               := c05_regs_w[ic05].nr_cheque;
                current_setting('ctb_contab_mexico_pck.ctb_contab_mexico_w')::w_ctb_contab_mexico%rowtype.cd_banco                := c05_regs_w[ic05].cd_banco;
                current_setting('ctb_contab_mexico_pck.ctb_contab_mexico_w')::w_ctb_contab_mexico%rowtype.cd_conta_digito         := c05_regs_w[ic05].cd_conta_digito;
                current_setting('ctb_contab_mexico_pck.ctb_contab_mexico_w')::w_ctb_contab_mexico%rowtype.dt_referencia           := c05_regs_w[ic05].dt_referencia;
                current_setting('ctb_contab_mexico_pck.ctb_contab_mexico_w')::w_ctb_contab_mexico%rowtype.ds_nome_pf_pj           := c05_regs_w[ic05].ds_nome_pf_pj;
                current_setting('ctb_contab_mexico_pck.ctb_contab_mexico_w')::w_ctb_contab_mexico%rowtype.cd_cpf_cgc              := c05_regs_w[ic05].cd_cpf_cgc;
                current_setting('ctb_contab_mexico_pck.ctb_contab_mexico_w')::w_ctb_contab_mexico%rowtype.vl_transacao            := c05_regs_w[ic05].vl_transacao;
                current_setting('ctb_contab_mexico_pck.ctb_contab_mexico_w')::w_ctb_contab_mexico%rowtype.cd_moeda_estrangeira    := c05_regs_w[ic05].cd_moeda_estrangeira;
                current_setting('ctb_contab_mexico_pck.ctb_contab_mexico_w')::w_ctb_contab_mexico%rowtype.vl_conv_estrangeiro     := c05_regs_w[ic05].vl_conv_estrangeiro;
                current_setting('ctb_contab_mexico_pck.ctb_contab_mexico_w')::w_ctb_contab_mexico%rowtype.nr_sequencia_ctb_movto  := c05_regs_w[ic05].nr_sequencia_ctb_movto;
                current_setting('ctb_contab_mexico_pck.ctb_contab_mexico_w')::w_ctb_contab_mexico%rowtype.nr_seq_superior         := c05_regs_w[ic05].nr_sequencia_ctb_movto;

                current_setting('ctb_contab_mexico_pck.lista_ctb_contab_mexico_w')::t_lista_ctb_contab_mexico(current_setting('ctb_contab_mexico_pck.lista_ctb_contab_mexico_w')::t_lista_ctb_contab_mexico.count) := current_setting('ctb_contab_mexico_pck.ctb_contab_mexico_w')::w_ctb_contab_mexico%rowtype;
                if (current_setting('ctb_contab_mexico_pck.lista_ctb_contab_mexico_w')::t_lista_ctb_contab_mexico.count > 100) then
                    current_setting('ctb_contab_mexico_pck.lista_ctb_contab_mexico_w')::t_lista_ctb_contab_mexico := ctb_contab_mexico_pck.inserir_ctb_contab_mexico(current_setting('ctb_contab_mexico_pck.lista_ctb_contab_mexico_w')::t_lista_ctb_contab_mexico);
                end if;
                end;
            end loop;
        EXIT WHEN NOT FOUND; /* apply on c05 */
        end loop;
        close c05;
        commit;

        select  sign(count(*))
        into STRICT    qt_registro_w
        from    titulo_pagar_baixa_contab_v a,
                titulo_pagar_baixa_cc b,
                titulo_pagar d,
                tipo_baixa_cpa g,
                titulo_pagar_favorecido h,
                lote_contabil lc,
                movimento_contabil_doc c,
                ctb_movimento e,
                movimento_contabil f
        where   b.nr_titulo      = a.nr_titulo
        and     c.nr_lote_contabil = f.nr_lote_contabil
        and     c.nr_seq_movimento = f.nr_sequencia
        and     e.nr_sequencia = f.nr_seq_ctb_movto
        and     lc.nr_lote_contabil = e.nr_lote_contabil
        and     b.nr_seq_baixa     = a.nr_seq_baixa
        and     d.nr_titulo        = a.nr_titulo
        and     a.cd_tipo_baixa    = g.cd_tipo_baixa
        and     a.nr_titulo = h.nr_titulo
        and     c.nm_atributo = a.ds_atributo
        and     c.nr_documento = d.nr_titulo
        and     c.nr_seq_doc_compl = b.nr_seq_baixa
        and     lc.dt_referencia between c01_w.dt_inicial and c01_w.dt_final
        and     lc.cd_estabelecimento = c01_w.cd_estabelecimento
        and     g.cd_integracao_externa = '03';

        if (qt_registro_w > 0) then
            begin
            open c06;
            loop
            fetch c06 bulk collect into c06_regs_w limit 100;
                for ic06 in 1..c06_regs_w.count loop
                    begin
                    PERFORM set_config('ctb_contab_mexico_pck.nr_sequencia_w', current_setting('ctb_contab_mexico_pck.nr_sequencia_w')::integer+1, false);
                    current_setting('ctb_contab_mexico_pck.ctb_contab_mexico_w')::w_ctb_contab_mexico%rowtype.nr_sequencia            := current_setting('ctb_contab_mexico_pck.nr_sequencia_w')::integer;
                    current_setting('ctb_contab_mexico_pck.ctb_contab_mexico_w')::w_ctb_contab_mexico%rowtype.ie_tipo_atributo        := current_setting('ctb_contab_mexico_pck.tipo_registro')::r_tipo_registro.transferencia;
                    current_setting('ctb_contab_mexico_pck.ctb_contab_mexico_w')::w_ctb_contab_mexico%rowtype.cd_conta_digito         := c06_regs_w[ic06].cd_conta_digito;
                    current_setting('ctb_contab_mexico_pck.ctb_contab_mexico_w')::w_ctb_contab_mexico%rowtype.cd_banco                := c06_regs_w[ic06].cd_banco;
                    current_setting('ctb_contab_mexico_pck.ctb_contab_mexico_w')::w_ctb_contab_mexico%rowtype.cd_conta_dest           := c06_regs_w[ic06].cd_conta_dest;
                    current_setting('ctb_contab_mexico_pck.ctb_contab_mexico_w')::w_ctb_contab_mexico%rowtype.cd_banco_dest           := c06_regs_w[ic06].cd_banco_dest;
                    current_setting('ctb_contab_mexico_pck.ctb_contab_mexico_w')::w_ctb_contab_mexico%rowtype.dt_referencia           := c06_regs_w[ic06].dt_referencia;
                    current_setting('ctb_contab_mexico_pck.ctb_contab_mexico_w')::w_ctb_contab_mexico%rowtype.ds_nome_pf_pj           := c06_regs_w[ic06].ds_nome_pf_pj;
                    current_setting('ctb_contab_mexico_pck.ctb_contab_mexico_w')::w_ctb_contab_mexico%rowtype.cd_cpf_cgc              := c06_regs_w[ic06].cd_cpf_cgc;
                    current_setting('ctb_contab_mexico_pck.ctb_contab_mexico_w')::w_ctb_contab_mexico%rowtype.vl_transacao            := c06_regs_w[ic06].vl_transacao;
                    current_setting('ctb_contab_mexico_pck.ctb_contab_mexico_w')::w_ctb_contab_mexico%rowtype.cd_moeda_estrangeira    := c06_regs_w[ic06].cd_moeda_estrangeira;
                    current_setting('ctb_contab_mexico_pck.ctb_contab_mexico_w')::w_ctb_contab_mexico%rowtype.nr_sequencia_ctb_movto  := c06_regs_w[ic06].nr_sequencia_ctb_movto;
                    current_setting('ctb_contab_mexico_pck.ctb_contab_mexico_w')::w_ctb_contab_mexico%rowtype.nr_seq_superior         := c06_regs_w[ic06].nr_sequencia_ctb_movto;

                    current_setting('ctb_contab_mexico_pck.lista_ctb_contab_mexico_w')::t_lista_ctb_contab_mexico(current_setting('ctb_contab_mexico_pck.lista_ctb_contab_mexico_w')::t_lista_ctb_contab_mexico.count) := current_setting('ctb_contab_mexico_pck.ctb_contab_mexico_w')::w_ctb_contab_mexico%rowtype;
                    if (current_setting('ctb_contab_mexico_pck.lista_ctb_contab_mexico_w')::t_lista_ctb_contab_mexico.count > 100) then
                        current_setting('ctb_contab_mexico_pck.lista_ctb_contab_mexico_w')::t_lista_ctb_contab_mexico := ctb_contab_mexico_pck.inserir_ctb_contab_mexico(current_setting('ctb_contab_mexico_pck.lista_ctb_contab_mexico_w')::t_lista_ctb_contab_mexico);
                    end if;
                    end;
                end loop;
            EXIT WHEN NOT FOUND; /* apply on c06 */
            end loop;
            close c06;
            end;
        end if;
        commit;
        open c07;
        loop
        fetch c07 bulk collect into c07_regs_w limit 100;
            for ic07 in 1..c07_regs_w.count loop
                begin
                PERFORM set_config('ctb_contab_mexico_pck.nr_sequencia_w', current_setting('ctb_contab_mexico_pck.nr_sequencia_w')::integer+1, false);
                ctb_contab_mexico_w.nr_sequencia            := current_setting('ctb_contab_mexico_pck.nr_sequencia_w')::integer;
                ctb_contab_mexico_w.ie_tipo_atributo        := current_setting('ctb_contab_mexico_pck.tipo_registro')::r_tipo_registro.otr_metodo_pago;
                ctb_contab_mexico_w.cd_integracao_externa   := c07_regs_w[ic07].cd_integracao_externa;
                ctb_contab_mexico_w.dt_referencia           := c07_regs_w[ic07].dt_referencia;
                ctb_contab_mexico_w.ds_nome_pf_pj           := c07_regs_w[ic07].ds_nome_pf_pj;
                ctb_contab_mexico_w.cd_cpf_cgc              := c07_regs_w[ic07].cd_cpf_cgc;
                ctb_contab_mexico_w.vl_transacao            := c07_regs_w[ic07].vl_transacao;
                ctb_contab_mexico_w.cd_moeda_estrangeira    := c07_regs_w[ic07].cd_moeda_estrangeira;
                ctb_contab_mexico_w.nr_sequencia_ctb_movto  := c07_regs_w[ic07].nr_sequencia_ctb_movto;
                ctb_contab_mexico_w.nr_seq_superior         := c07_regs_w[ic07].nr_sequencia_ctb_movto;

                current_setting('ctb_contab_mexico_pck.lista_ctb_contab_mexico_w')::t_lista_ctb_contab_mexico(current_setting('ctb_contab_mexico_pck.lista_ctb_contab_mexico_w')::t_lista_ctb_contab_mexico.count) := ctb_contab_mexico_w;
                if (current_setting('ctb_contab_mexico_pck.lista_ctb_contab_mexico_w')::t_lista_ctb_contab_mexico.count > 100) then
                    current_setting('ctb_contab_mexico_pck.lista_ctb_contab_mexico_w')::t_lista_ctb_contab_mexico := ctb_contab_mexico_pck.inserir_ctb_contab_mexico(current_setting('ctb_contab_mexico_pck.lista_ctb_contab_mexico_w')::t_lista_ctb_contab_mexico);
                end if;
                end;
            end loop;
        EXIT WHEN NOT FOUND; /* apply on c07 */
        end loop;
        close c07;
        commit;
        end;
    end loop;
    close c01;
    current_setting('ctb_contab_mexico_pck.lista_ctb_contab_mexico_w')::t_lista_ctb_contab_mexico := ctb_contab_mexico_pck.inserir_ctb_contab_mexico(current_setting('ctb_contab_mexico_pck.lista_ctb_contab_mexico_w')::t_lista_ctb_contab_mexico);

    commit;

    END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ctb_contab_mexico_pck.gerar_registro_d ( nr_seq_regra_p ctb_regra_arquivo_mex.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;
