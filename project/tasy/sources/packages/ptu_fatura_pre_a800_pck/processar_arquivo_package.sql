-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE ptu_fatura_pre_a800_pck.processar_arquivo ( nr_seq_fatura_p bigint, cd_unimed_destino_p ptu_mov_benef_destino.cd_unimed_destino%type, arq_texto_p utl_file.file_type) AS $body$
DECLARE

	 
	ds_conteudo_w			varchar(4000);
	ptu_mov_benef_lote_w		ptu_mov_benef_lote%rowtype;
	ptu_mov_benef_contagem_w	ptu_mov_benef_contagem%rowtype;
	ptu_mov_benef_trailer_w		ptu_mov_benef_trailer%rowtype;
	ds_hash_w			varchar(32);
	
	--R801 - HEADER 
	C01 CURSOR(	nr_seq_fatura_pc	bigint)FOR 
		SELECT	'801'									cd_registro, 
			lpad(cd_unimed_destino,4,'0')						cd_unimed_destino, 
			lpad(cd_unimed_origem,4,'0')						cd_unimed_origem, 
			'1'									tp_documento, 
			dt_geracao								dt_geracao, 
			dt_competencia								dt_competencia, 
			clock_timestamp()									dt_cobranca_inicial, 
			clock_timestamp()									dt_cobranca_final, 
			' '									reservado_1, 
			' '									reservado_2, 
			to_char(nr_documento)							nr_documento, 
			to_char(nr_documento)							nr_doc_fiscal, 
			dt_vencimento								dt_ven_doc, 
			clock_timestamp()									dt_emi_doc, 
			coalesce((replace(replace(campo_mascara(vl_total,2),',',''),'.',''))::numeric ,0)		vl_tot_doc, 
			coalesce((replace(replace(campo_mascara(vl_total_liq,2),',',''),'.',''))::numeric ,0)		vl_tot_doc_liq, 
			coalesce((replace(replace(campo_mascara(vl_ajuste,2),',',''),'.',''))::numeric ,0)		vl_ajuste_doc, 
			lpad(nr_versao_transacao,2,'0')						nr_versao_transacao, 
			replace(replace(campo_mascara(vl_ir,2),',',''),'.','')			vl_ir 
		from	ptu_fatura_pre 
		where	nr_sequencia = nr_seq_fatura_pc;
	
	--R802 - COBRANÇA BENEFICIÁRIO 
	C02 CURSOR(nr_seq_fatura_pc	bigint) FOR 
		SELECT	'802'								cd_registro, 
			'0000'								reservado_1, 
			b.cd_unimed							cd_unimed, 
			lpad(b.id_beneficiario,13,'0')					id_beneficiario, 
			b.cd_filial							cd_filial, 
			b.cd_familia							cd_familia, 
			b.cd_dependencia						cd_dependencia, 
			substr(b.nm_beneficiario,1,25)					nm_beneficiario, 
			b.dt_nascimento							dt_nascimento, 
			b.cd_plano_intercambio						cd_plano_intercambio, 
			coalesce(replace(replace(campo_mascara(b.vl_mensalidade_original,2),',',''),'.',''),0)	vl_mensalidade_original, 
			coalesce(replace(replace(campo_mascara(b.vl_inscricao_original,2),',',''),'.',''),0)		vl_inscricao_original, 
			coalesce(replace(replace(campo_mascara(b.vl_mensalidade_cobrado,2),',',''),'.',''),0)	vl_mensalidade_cobrado, 
			coalesce(replace(replace(campo_mascara(b.vl_inscricao_cobrado,2),',',''),'.',''),0)		vl_inscricao_cobrado, 
			coalesce(replace(replace(campo_mascara(b.vl_ajuste_cobrado,2),',',''),'.',''),0)		vl_ajuste_cobrado, 
			b.cd_empresa_origem									cd_empresa_origem 
		from	ptu_fatura_pre_cobranca	b 
		where	b.nr_seq_fatura		= nr_seq_fatura_pc;
	
	--R809 - TRAILER 
	C03 CURSOR(nr_seq_fatura_pc	bigint) FOR 
		SELECT	'809'											cd_registro, 
			b.qt_total_r802										qt_total_r802, 
			coalesce((replace(replace(campo_mascara(b.vl_tot_mens_original,2),',',''),'.',''))::numeric ,0)	vl_tot_mens_original, 
			coalesce((replace(replace(campo_mascara(b.vl_tot_insc_original,2),',',''),'.',''))::numeric ,0)	vl_tot_insc_original, 
			coalesce((replace(replace(campo_mascara(b.vl_total_mensalidade,2),',',''),'.',''))::numeric ,0)	vl_total_mensalidade, 
			coalesce((replace(replace(campo_mascara(b.vl_total_inscricao,2),',',''),'.',''))::numeric ,0)		vl_total_inscricao, 
			coalesce((replace(replace(campo_mascara(b.vl_total_ajuste,2),',',''),'.',''))::numeric ,0)		vl_total_ajuste 
		from	ptu_fatura_pre_total	b 
		where	b.nr_seq_fatura		= nr_seq_fatura_pc;
	
	
BEGIN 
	PERFORM set_config('ptu_fatura_pre_a800_pck.nr_sequencial_arq_w', 0, false);
	 
	ds_conteudo_w := '';
	--R801 - HEADER 
	for r_C01_w in C01(nr_seq_fatura_p) loop 
		ds_conteudo_w	:=	lpad(r_C01_w.cd_unimed_destino,4,0) || lpad(r_C01_w.cd_unimed_origem,4,0) || to_char(r_C01_w.dt_geracao,'YYYYMMDD') || 
					to_char(r_C01_w.dt_competencia,'YYMM') || to_char(r_C01_w.dt_cobranca_inicial,'YYYYMMDD') || to_char(r_C01_w.dt_cobranca_final,'YYYYMMDD') || 
					r_C01_w.reservado_1 || rpad(r_C01_w.reservado_2,11) || to_char(r_C01_w.dt_ven_doc,'YYYYMMDD') || 
					to_char(r_C01_w.dt_emi_doc,'YYYYMMDD') || lpad(to_char(r_C01_w.vl_tot_doc),14,0) || lpad(to_char(r_C01_w.vl_tot_doc_liq),14,0) || 
					lpad(to_char(r_C01_w.vl_ajuste_doc),14,0) || lpad(r_C01_w.nr_versao_transacao,2,0) || lpad(to_char(r_C01_w.vl_ir),14,0) || 
					lpad(r_C01_w.nr_documento,20,0) || lpad(r_C01_w.nr_doc_fiscal,20,0) || r_C01_w.tp_documento;
		 
		CALL CALL CALL CALL CALL CALL ptu_fatura_pre_a800_pck.incluir_linha_arq(r_C01_w.cd_registro,ds_conteudo_w,arq_texto_p);
	end loop;
	ds_conteudo_w := '';
	--R802 - COBRANÇA BENEFICIÁRIO 
	for r_C02_w in C02(nr_seq_fatura_p) loop 
		ds_conteudo_w	:=	lpad(r_C02_w.cd_unimed,4,0) || r_c02_w.id_beneficiario || r_C02_w.reservado_1 || 
					lpad(r_C02_w.cd_filial,3,0) || lpad(r_C02_w.cd_familia,6,0) || lpad(r_C02_w.cd_dependencia,2,0) || 
					rpad(r_C02_w.nm_beneficiario,25,' ') || to_char(r_C02_w.dt_nascimento,'YYYYMMDD') || '00' || 
					lpad(r_C02_w.vl_mensalidade_original,14,0) || lpad(r_C02_w.vl_inscricao_original,14,0) || lpad(r_C02_w.vl_mensalidade_cobrado,14,0) || 
					lpad(r_C02_w.vl_inscricao_cobrado,14,0) || lpad(r_C02_w.vl_ajuste_cobrado,14,0) || lpad(r_C02_w.cd_empresa_origem,10,0) || rpad(r_C02_w.cd_plano_intercambio,3,' ');
		 
		CALL CALL CALL CALL CALL CALL ptu_fatura_pre_a800_pck.incluir_linha_arq(r_C02_w.cd_registro,ds_conteudo_w,arq_texto_p);
	end loop;
	ds_conteudo_w := '';
	--R809 - TRAILER 
	for r_C03_w in C03(nr_seq_fatura_p) loop 
		ds_conteudo_w	:=	lpad(r_C03_w.qt_total_r802,5,0) || lpad(r_C03_w.vl_tot_mens_original,14,0) || lpad(r_C03_w.vl_tot_insc_original,14,0) || 
					lpad(r_C03_w.vl_total_mensalidade,14,0) || lpad(r_C03_w.vl_total_inscricao,14,0) || lpad(r_C03_w.vl_total_ajuste,14,0);
		 
		CALL CALL CALL CALL CALL CALL ptu_fatura_pre_a800_pck.incluir_linha_arq(r_C03_w.cd_registro,ds_conteudo_w,arq_texto_p);
	end loop;
	--Geração do HASH 
	current_setting('ptu_fatura_pre_a800_pck.ds_arquivo_w')::text := pls_hash_ptu_pck.obter_hash_txt(current_setting('ptu_fatura_pre_a800_pck.ds_arquivo_w')::text);
	ds_conteudo_w		:=	lpad(ds_hash_w,32,' ');
	CALL CALL CALL CALL CALL CALL ptu_fatura_pre_a800_pck.incluir_linha_arq('998',ds_conteudo_w,arq_texto_p);
	 
	--Salva o Hash e arquivo 
	update	ptu_fatura_pre 
	set	nm_arquivo		= get_nome_arquivo, 
		ds_hash_a800		= ds_hash_w, 
		dt_geracao_arquivo	= clock_timestamp(), 
		dt_atualizacao		= clock_timestamp(), 
		nm_usuario		= get_nm_usuario 
	where	nr_sequencia		= nr_seq_fatura_p;
	commit;
	end;
	

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ptu_fatura_pre_a800_pck.processar_arquivo ( nr_seq_fatura_p bigint, cd_unimed_destino_p ptu_mov_benef_destino.cd_unimed_destino%type, arq_texto_p utl_file.file_type) FROM PUBLIC;
