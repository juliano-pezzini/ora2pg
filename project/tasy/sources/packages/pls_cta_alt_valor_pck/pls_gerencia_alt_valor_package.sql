-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_cta_alt_valor_pck.pls_gerencia_alt_valor ( cd_acao_analise_p pls_acao_analise.cd_acao%type, nr_seq_analise_p pls_analise_conta.nr_sequencia%type, nr_seq_conta_p pls_conta_v.nr_sequencia%type, nr_seq_conta_proc_p pls_conta_proc_v.nr_sequencia%type, nr_seq_conta_mat_p pls_conta_mat_v.nr_sequencia%type, nr_seq_proc_partic_p pls_proc_participante_v.nr_sequencia%type, nr_seq_ocorrencia_p pls_ocorrencia.nr_sequencia%type, nr_seq_motivo_glosa_p tiss_motivo_glosa.nr_sequencia%type, ds_observacao_p pls_conta_glosa.ds_observacao%type, qt_liberada_p pls_conta_proc_v.qt_procedimento%type, vl_liberado_p pls_conta_proc_v.vl_liberado%type, vl_unitario_p pls_conta_proc_v.vl_unitario%type, vl_liberado_hi_p pls_conta_proc_v.vl_liberado_hi%type, vl_liberado_mat_p pls_conta_proc_v.vl_liberado_material%type, vl_liberado_co_p pls_conta_proc_v.vl_liberado_co%type, vl_lib_taxa_hi_p pls_conta_proc_v.vl_lib_taxa_servico%type, vl_lib_taxa_mat_p pls_conta_proc_v.vl_lib_taxa_material%type, vl_lib_taxa_co_p pls_conta_proc_v.vl_taxa_co%type, pr_taxa_servico_p bigint, pr_taxa_material_p bigint, pr_taxa_co_p bigint, pr_taxa_exc_material_p bigint, ie_apres_calc_p text, nr_seq_grupo_atual_p pls_auditoria_conta_grupo.nr_sequencia%type, ie_manter_glosas_p text, nr_id_transacao_p bigint, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type, ie_multiplos_itens_p text default null) AS $body$
DECLARE


ie_atualiza_via_acesso_w  pls_parametros.ie_atualiza_via_acesso%type;
ie_status_pagamento_w    pls_conta_proc_v.ie_status_pagamento%type;
ie_tipo_inter_ocor_w    pls_analise_fluxo_item.ie_tipo_glosa%type;
nr_seq_fluxo_w      pls_analise_fluxo_item.nr_sequencia%type;
ie_tipo_item_w      varchar(2);
ie_origem_acao_w    varchar(5);
ds_mensagem_w      varchar(500)  := null;
nr_seq_glosa_conta_w    pls_conta_glosa.nr_sequencia%type;
ie_permite_liberar_w    varchar(1);
nr_seq_log_w      bigint;
ie_glosa_w			pls_conta_proc.ie_glosa%type;
vl_item_apres_w		pls_conta_proc.vl_procedimento_imp%type;

-- ? feito union no comando abaixo para tratar tanto se for selecionado v?rios itens, quanto se for clicado somente com o bot?o direito do mouse
C02 CURSOR(  nr_seq_analise_p    pls_analise_conta.nr_sequencia%type,
    nr_seq_conta_p      pls_conta_v.nr_sequencia%type,
    nm_usuario_p      usuario.nm_usuario%type) FOR
  SELECT  distinct b.nr_seq_conta,
    c.ie_tipo_conta,
    c.ie_tipo_protocolo,
    c.nr_seq_protocolo,
    c.nr_seq_fatura
  from  w_pls_analise_selecao_item a,
    w_pls_analise_item b,
    pls_conta_v c
  where  a.nr_seq_analise  = nr_seq_analise_p
  and  a.nm_usuario    = nm_usuario_p
  and  b.nr_sequencia    = a.nr_seq_w_item
  and  c.nr_sequencia    = b.nr_seq_conta
  and  b.nr_id_transacao   = nr_id_transacao_p

union

  SELECT  nr_seq_conta_p,
    d.ie_tipo_conta,
    d.ie_tipo_protocolo,
    d.nr_seq_protocolo,
    d.nr_seq_fatura
  from  pls_conta_v d
  where  d.nr_sequencia    = nr_seq_conta_p;

-- ? feito union no comando abaixo para tratar tanto se for selecionado v?rios itens, quanto se for clicado somente com o bot?o direito do mouse
C03 CURSOR(  nr_seq_analise_p    pls_analise_conta.nr_sequencia%type,
    nr_seq_conta_p      pls_conta_v.nr_sequencia%type,
    nm_usuario_p      usuario.nm_usuario%type) FOR
  SELECT  distinct c.nr_seq_protocolo
  from  w_pls_analise_selecao_item a,
    w_pls_analise_item b,
    pls_conta_v c
  where  a.nr_seq_analise  = nr_seq_analise_p
  and  a.nm_usuario    = nm_usuario_p
  and  b.nr_id_transacao = nr_id_transacao_p
  and  b.nr_sequencia    = a.nr_seq_w_item
  and  c.nr_sequencia    = b.nr_seq_conta

union

  SELECT  d.nr_seq_protocolo
  from  pls_conta_v d
  where  d.nr_sequencia    = nr_seq_conta_p;
BEGIN
/*Buscar pela a??o da an?lise que foi enviada, qual o processo que o sistema est? realizando
A??es:
1  - Ajustar o valor do item
2 - Alterar valor Tx interc?mbio
3 - Aceitar valor calculado
4 - Aceitar valor apresentado
5 - Aceitar melhor valor
*/
-- Tratamento de mensagem para as a??es de aceitar valor
if (cd_acao_analise_p in (3, 4, 5))  then
  /*A function pls_obter_se_ac_valor ir? retornar se o valor que est? sendo aceito no momento esta v?lido,
  ou seja para ser v?lido o mesmo ter? que ser maior que zero .
  Se os valores aceitos estiverem zerados o sistema ir? apresentar a seguinte mensagem

  " N?o foi poss?vel aceitar o valor, verifique se o valor n?o esta zerado nos itens:
    Sequencia do item    + Descri??o do item

  Dentro da v?riavel ds_mensagem_w ser? retornado os itens que estiverem zerados,
  no momento em que a a??o for realizada.
  */
  ds_mensagem_w  := pls_cta_alt_valor_pck.pls_valida_se_alt_valor(  nr_seq_analise_p, nr_seq_conta_p, nr_seq_conta_proc_p,
              nr_seq_conta_mat_p,cd_acao_analise_p,nm_usuario_p, nr_id_transacao_p);
  if (ds_mensagem_w IS NOT NULL AND ds_mensagem_w::text <> '')  then
    CALL wheb_mensagem_pck.exibir_mensagem_abort(255397,'DS_MENSAGEM='||pls_util_pck.enter_w||ds_mensagem_w);
  end if;
end if;

-- busca par?metro para decidir se vai ou n?o executar a via de acesso
select  ie_atualiza_via_acesso
into STRICT  ie_atualiza_via_acesso_w
from  table(pls_parametros_pck.f_retorna_param(cd_estabelecimento_p));

-- varre tudo o que foi selecionado para altera??o
for r_C_itens_analise_w in current_setting('pls_cta_alt_valor_pck.c_itens_analise')::CURSOR((nr_seq_analise_p, nr_seq_conta_p, nr_seq_conta_proc_p, nr_seq_conta_mat_p, nm_usuario_p, nr_id_transacao_p) loop



  -- busca o tipo do item
  ie_tipo_item_w  := pls_util_cta_pck.pls_obter_tipo_item_atend(  r_C_itens_analise_w.nr_seq_conta, r_C_itens_analise_w.nr_seq_conta_proc,
                  r_C_itens_analise_w.nr_seq_conta_mat, null);

	if (coalesce(ie_multiplos_itens_p::text, '') = '' or ie_multiplos_itens_p = 'N') then
				
	  CALL pls_gerencia_dados_ocor_pck.pls_atualiza_ie_glosa(  r_C_itens_analise_w.nr_seq_conta, r_C_itens_analise_w.nr_seq_conta_proc,
					r_C_itens_analise_w.nr_seq_conta_mat, null, 'N',
					'S', nm_usuario_p);
	else
	
		ie_glosa_w := 'N';
		if (qt_liberada_p = 0) then
			ie_glosa_w := 'S';
		end if;
	
		CALL pls_gerencia_dados_ocor_pck.pls_atualiza_ie_glosa(  r_C_itens_analise_w.nr_seq_conta, r_C_itens_analise_w.nr_seq_conta_proc,
					r_C_itens_analise_w.nr_seq_conta_mat, null, ie_glosa_w,
					'S', nm_usuario_p);
	
	end if;
					
  -- rotina de valida??o da via de acesso (s? faz se par?metro for S, sen?o resolve na consist?ncia da conta)
  if (ie_atualiza_via_acesso_w = 'S') then
    CALL pls_util_cta_pck.pls_gerencia_via_acesso(   null, null, null,
						r_C_itens_analise_w.nr_seq_conta, r_C_itens_analise_w.nr_seq_conta_proc, nr_seq_analise_p,
						cd_acao_analise_p, nm_usuario_p, cd_estabelecimento_p );
  end if;

  ie_permite_liberar_w  := pls_cta_alt_valor_pck.pls_verifica_se_grupo_aud(  nr_seq_analise_p, nr_seq_conta_p, nr_seq_conta_proc_p,
                nr_seq_conta_mat_p, nr_seq_grupo_atual_p, cd_estabelecimento_p,
                nm_usuario_p);
  if (ie_permite_liberar_w  = 'N') then
    CALL wheb_mensagem_pck.exibir_mensagem_abort(350729);
  end if;

  -- S? continuar? a gerar se n?o houver nenhum proc ou mat inv?lido
  case cd_acao_analise_p
    -- Ajustar valor do item
    -- quando for esta op??o, somente ? permitido alterar um item por vez, por isso que nos par?metros abaixo s?o passados os que vem direto da chamada da package
    -- para garantir que n?o altere mais itens do que se deve (vai que tem algum lixo na tabela w_pls_analise_selecao_item!)
    when 1 then
      pls_cta_alt_valor_pck.pls_gerencia_ajustar_valor(  nr_seq_conta_p, nr_seq_conta_proc_p, nr_seq_conta_mat_p,
              nr_seq_ocorrencia_p, qt_liberada_p, vl_liberado_p,
              vl_unitario_p, vl_liberado_hi_p, vl_liberado_mat_p,
              vl_liberado_co_p, vl_lib_taxa_hi_p, vl_lib_taxa_mat_p,
              vl_lib_taxa_co_p, nm_usuario_p);

    -- Alterar valor Tx interc?mbio
    when 2 then
      pls_cta_alt_valor_pck.pls_alt_valor_tx_selec(  nr_seq_analise_p, r_C_itens_analise_w.nr_seq_conta,r_C_itens_analise_w.nr_seq_conta_proc,
            r_C_itens_analise_w.nr_seq_conta_mat, nr_seq_ocorrencia_p,
            pr_taxa_servico_p, pr_taxa_material_p, pr_taxa_co_p,
                                                pr_taxa_exc_material_p, ie_apres_calc_p, nm_usuario_p, nr_id_transacao_p);
    -- Aceitar valor calculado
    when 3 then
      pls_cta_alt_valor_pck.pls_gerencia_aceitar_vl_calc(  r_C_itens_analise_w.nr_seq_conta, r_C_itens_analise_w.nr_seq_conta_proc,
              r_C_itens_analise_w.nr_seq_conta_mat, cd_acao_analise_p, nm_usuario_p);
    -- Aceitar valor apresentado
    when 4 then
      pls_cta_alt_valor_pck.pls_gerencia_aceitar_vl_apres(  r_C_itens_analise_w.nr_seq_conta, r_C_itens_analise_w.nr_seq_conta_proc,
              r_C_itens_analise_w.nr_seq_conta_mat, cd_acao_analise_p, nm_usuario_p);
    -- Aceitar melhor valor
    when 5 then
      pls_cta_alt_valor_pck.pls_gerencia_aceitar_melhor_vl(  r_C_itens_analise_w.nr_seq_conta, r_C_itens_analise_w.nr_seq_conta_proc,
              r_C_itens_analise_w.nr_seq_conta_mat, cd_acao_analise_p, nm_usuario_p);
  end case;
  /* TRATAMENTO PARA AS GLOSAS.
    Temos uma previs?o de que no futuro n?o ir? mais ser trabalhado com as glosas, tudo dever? ser migrado para valida??es nas ocorr?ncias combinadas.
    Sendo assim, as glosas que podem ter influ?ncia neste processo s?o a 1705, 1706, 1707 e 9919. Elas foram migradas para as ocorr?ncias combinadas e o cliente tem a op??o de
    escolher qual delas deseja revalidar quando ocorrer determinada a??o. Esse tratamento ? feito na rotina pls_gerencia_dados_ocor_pck.pls_reconsistir_ocor. Abaixo segue as valida??es
    que tratam as glosas mencionadas:

    Glosa 1705 - Valor apresentado a maior -> Valida??o 28 - Validar valor apresentado a maior.
    Glosa 1706 - Valor apresentado a menor -> Valida??o 29 - Validar valor apresentado a menor.
    Glosa 1707 - N?o existe informa??o sobre a tabela que ser? utilizada na Valora??o . Verifique o Contrato do Prestador ->
        Valida??o 31 - Validar se existe informa??o sobre a tabela que ser? utilizada na valora??o
    Glosa 9919 - N?o foi poss?vel a valoriza??o do item apresentado -> Valida??o 24 - Validar valoriza??o do item apresentado.

    Para resumir bem tudo o que foi apresentado acima: glosas nesta nova estrutura - N?O CONSIDERAR ESTA POSSIBILIDADE!
    Talvez seja necess?rio apenas inativar as glosas existentes, para fins de compatibilidade para as glosas que j? foram geradas, mas isso os testes v?o nos dizer se ? necess?rio.
  */
  -- tratamento para as revalida??o de ocorr?ncias combinadas
  if (coalesce(ie_manter_glosas_p,'N') = 'N') then
  CALL pls_gerencia_dados_ocor_pck.pls_reconsistir_ocor(   r_C_itens_analise_w.nr_seq_conta, r_C_itens_analise_w.nr_seq_conta_proc,
                r_C_itens_analise_w.nr_seq_conta_mat, null,
                cd_acao_analise_p, cd_estabelecimento_p, nm_usuario_p);
  end if;

  --Necess?rio efetuar a a??o ap?s a gera??o das ocorr?ncias combinadas devido ao fato de que se for antes as mesmas ir?o ficar inativas
  -- faz os tratamentos para glosas e ocorr?ncias
  if (coalesce(ie_manter_glosas_p,'N') = 'N') then
  CALL pls_gerencia_dados_ocor_pck.pls_gerencia_glo_ocor_alt_vl( nr_seq_analise_p, r_C_itens_analise_w.nr_seq_conta, r_C_itens_analise_w.nr_seq_conta_proc,
                  r_C_itens_analise_w.nr_seq_conta_mat,nr_seq_ocorrencia_p, nr_seq_motivo_glosa_p,
                  cd_acao_analise_p, qt_liberada_p, cd_estabelecimento_p,
                  nm_usuario_p);
  end if;

  --Para as chamadas da Gest?o de contas m?dicas/Ajustar valor item.
  if (coalesce(nr_seq_analise_p::text, '') = '') then

    CALL pls_gravar_glosa_item_conta(nr_seq_motivo_glosa_p, nr_seq_ocorrencia_p, nr_seq_conta_p, nr_seq_conta_proc_p,
              nr_seq_conta_mat_p, ds_observacao_p, nm_usuario_p, cd_estabelecimento_p);

  end if;

  if (coalesce(ie_manter_glosas_p,'N') = 'S') then
    -- insere ocorr?ncia ou glosa selecionada na tabela w_pls_analise_glosa_ocor
    CALL pls_inserir_w_glosa_ocor(  nr_seq_analise_p, nr_seq_ocorrencia_p, nr_seq_motivo_glosa_p,
            null, nm_usuario_p, ie_multiplos_itens_p);
    -- insere ocorr?ncia ou glosa de acordo com o que foi gravado na tabela w_pls_analise_glosa_ocor
    pls_analise_inserir_glosa_item( nr_seq_analise_p, r_C_itens_analise_w.nr_seq_conta, r_C_itens_analise_w.nr_seq_conta_proc, r_C_itens_analise_w.nr_seq_conta_mat,
            null, nr_seq_ocorrencia_p, nr_seq_motivo_glosa_p, 'N', cd_estabelecimento_p,
            nm_usuario_p, 'N', nr_seq_glosa_conta_w);
  end if;

  -- realimenta a tabela tempor?ria w_pls_analise_glosa_ocor
  if (nr_seq_analise_p IS NOT NULL AND nr_seq_analise_p::text <> '') then
    CALL pls_gerar_w_analise_glosa_ocor(  nr_seq_analise_p, r_C_itens_analise_w.nr_seq_conta, nr_seq_grupo_atual_p,
            r_C_itens_analise_w.nr_seq_conta_proc,r_C_itens_analise_w.nr_seq_conta_mat, null,
            'N', nm_usuario_p);
  end if;

  -- obt?m o status do pagamento do item
  ie_status_pagamento_w := pls_util_cta_pck.pls_obter_stat_pag_item_calc(  r_C_itens_analise_w.nr_seq_conta_proc,
                    r_C_itens_analise_w.nr_seq_conta_mat, null);
  -- obt?m o tipo da interfer?ncia
  ie_tipo_inter_ocor_w := pls_gerencia_dados_ocor_pck.pls_obter_interferencia_ocor(  nr_seq_ocorrencia_p);

  -- esse campo vai sumir porque caiu no ostracismo.
  -- no lugar dele, ser? utilizada a a??o da an?lise (pls_acao_analise->cd_acao).
  -- mas por enquanto existe um de-para para fins de compatibilidade
  ie_origem_acao_w := pls_util_cta_pck.pls_depara_acao_analise_origem(  cd_acao_analise_p);

  -- tratamento na tabela pls_analise_fluxo_item (n?vel de item)  .
  -- o parecer ? sempre dado a n?vel de item
  pls_gravar_fluxo_analise_item(  nr_seq_analise_p, r_C_itens_analise_w.nr_seq_conta, r_C_itens_analise_w.nr_seq_conta_proc,
          r_C_itens_analise_w.nr_seq_conta_mat,null, null, nr_seq_grupo_atual_p, ie_status_pagamento_w,
          null, ds_observacao_p,  'N', 'N', nm_usuario_p, 'N', ie_tipo_inter_ocor_w, ie_origem_acao_w,
          nr_seq_fluxo_w, cd_acao_analise_p);

  -- tratamento na tabela pls_analise_glo_ocor_grupo - (manuten??o das ocorr?ncias do grupo)
  if (nr_seq_analise_p IS NOT NULL AND nr_seq_analise_p::text <> '') then
    CALL pls_analise_cta_pck.pls_gerencia_glo_ocor_grupo(  nr_seq_analise_p, nr_seq_grupo_atual_p, r_C_itens_analise_w.nr_seq_conta_proc,
                  r_C_itens_analise_w.nr_seq_conta_mat, cd_estabelecimento_p, nm_usuario_p,
                  nr_seq_fluxo_w);
  end if;

  -- atualizar pls_conta_medica_resumo (pagamento dos prestadores) e faturamento (cobrar as despesas que foram geradas pelo atendimento)
  if (ie_tipo_item_w = 'P') then
    -- pls_conta_medica_resumo
    CALL pls_atualiza_conta_resumo_item(  r_C_itens_analise_w.nr_seq_conta_proc, ie_tipo_item_w, nm_usuario_p, 'N');
    -- faturamento
    CALL pls_atualiza_conta_proc_fat(  r_C_itens_analise_w.nr_seq_conta_proc, nm_usuario_p, cd_estabelecimento_p, 'N');

  elsif (ie_tipo_item_w = 'M') then
    -- pls_conta_medica_resumo
    CALL pls_atualiza_conta_resumo_item(  r_C_itens_analise_w.nr_seq_conta_mat, ie_tipo_item_w, nm_usuario_p, 'N');
    -- faturamento
    CALL pls_atualiza_conta_mat_fat(  r_C_itens_analise_w.nr_seq_conta_mat, nm_usuario_p, cd_estabelecimento_p, 'N');
  end if;
end loop;
-- Se houver algum proc / mat que n?o poderia aceitar o valor lan?a a mensagem
-- aqui chama os procedimentos que ser?o executados no final e se referem a atualiza??o da conta
for r_C02_w in C02(nr_seq_analise_p, nr_seq_conta_p, nm_usuario_p) loop

  CALL pls_cta_consistir_pck.gerar_resumo_conta(null, null, null, r_C02_w.nr_seq_conta, nm_usuario_p, cd_estabelecimento_p);
  CALL pls_fechar_conta(r_C02_w.nr_seq_conta, 'N', 'S', 'N', cd_estabelecimento_p, nm_usuario_p, null, null);

  if (r_C02_w.ie_tipo_conta  = 'I')   and (r_C02_w.ie_tipo_protocolo != 'R')   then
    CALL pls_atualizar_status_int_a500(r_C02_w.nr_seq_protocolo, r_C02_w.nr_seq_fatura, nm_usuario_p);
  end if;

end loop;

-- aqui chama os procedimentos que ser?o executados no final e se referem a atualiza??o do protocolo
for r_C03_w in C03(nr_seq_analise_p, nr_seq_conta_p, nm_usuario_p) loop
  CALL pls_altera_status_protocolo(r_C03_w.nr_seq_protocolo, 'L', 'N', cd_estabelecimento_p, nm_usuario_p);


end loop;

commit;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_cta_alt_valor_pck.pls_gerencia_alt_valor ( cd_acao_analise_p pls_acao_analise.cd_acao%type, nr_seq_analise_p pls_analise_conta.nr_sequencia%type, nr_seq_conta_p pls_conta_v.nr_sequencia%type, nr_seq_conta_proc_p pls_conta_proc_v.nr_sequencia%type, nr_seq_conta_mat_p pls_conta_mat_v.nr_sequencia%type, nr_seq_proc_partic_p pls_proc_participante_v.nr_sequencia%type, nr_seq_ocorrencia_p pls_ocorrencia.nr_sequencia%type, nr_seq_motivo_glosa_p tiss_motivo_glosa.nr_sequencia%type, ds_observacao_p pls_conta_glosa.ds_observacao%type, qt_liberada_p pls_conta_proc_v.qt_procedimento%type, vl_liberado_p pls_conta_proc_v.vl_liberado%type, vl_unitario_p pls_conta_proc_v.vl_unitario%type, vl_liberado_hi_p pls_conta_proc_v.vl_liberado_hi%type, vl_liberado_mat_p pls_conta_proc_v.vl_liberado_material%type, vl_liberado_co_p pls_conta_proc_v.vl_liberado_co%type, vl_lib_taxa_hi_p pls_conta_proc_v.vl_lib_taxa_servico%type, vl_lib_taxa_mat_p pls_conta_proc_v.vl_lib_taxa_material%type, vl_lib_taxa_co_p pls_conta_proc_v.vl_taxa_co%type, pr_taxa_servico_p bigint, pr_taxa_material_p bigint, pr_taxa_co_p bigint, pr_taxa_exc_material_p bigint, ie_apres_calc_p text, nr_seq_grupo_atual_p pls_auditoria_conta_grupo.nr_sequencia%type, ie_manter_glosas_p text, nr_id_transacao_p bigint, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type, ie_multiplos_itens_p text default null) FROM PUBLIC;
