-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_cta_alt_valor_pck.pls_calcula_valores_materiais ( qt_liberada_p pls_conta_proc_v.qt_procedimento%type, vl_unitario_p pls_conta_proc_v.vl_unitario%type, vl_liberado_p pls_conta_proc_v.vl_liberado%type, vl_liberado_material_p pls_conta_proc_v.vl_liberado_material%type, vl_lib_taxa_material_p pls_conta_proc_v.vl_lib_taxa_material%type, tx_intercambio_imp_p pls_conta_proc_v.tx_intercambio_imp%type, nr_seq_material_p pls_conta_proc_v.nr_sequencia%type, ie_opcao_p text, ie_intercambio_p text, vl_unitario_out_p INOUT pls_conta_proc_v.vl_unitario%type, vl_liberado_out_p INOUT pls_conta_proc_v.vl_liberado%type, vl_liberado_material_out_p INOUT pls_conta_proc_v.vl_liberado_material%type, vl_lib_taxa_material_out_p INOUT pls_conta_proc_v.vl_lib_taxa_material%type) AS $body$
DECLARE


qt_liberada_item_w      pls_conta_mat_v.qt_material%type    := 0;
vl_liberado_item_w      pls_conta_mat_v.vl_liberado%type    := 0;
vl_taxa_material_w            pls_conta_proc_v.vl_taxa_material%type    := 0;
vl_taxa_material_imp_w          pls_conta_proc_v.vl_taxa_material_imp%type  := 0;
qt_liberada_w        pls_conta_proc_v.qt_procedimento%type    := 0;
qt_apresentada_w      pls_conta_proc_v.qt_procedimento%type    := 0;
vl_unitario_w        pls_conta_proc_v.vl_unitario%type    := 0;
vl_liberado_w        pls_conta_proc_v.vl_liberado%type    := 0;
vl_liberado_material_w      pls_conta_proc_v.vl_liberado_material%type  := 0;
vl_lib_taxa_material_w      double precision  := 0;


BEGIN

qt_liberada_w    := coalesce(qt_liberada_p,0);
-- feito um round de 2 pelo motivo que pelo Delphi ? passado um n?mero com uma precis?o maior (o componente faz isso)
vl_unitario_w    := coalesce(vl_unitario_p,0);
vl_liberado_w    := round((coalesce(vl_liberado_p,0))::numeric,2);
vl_lib_taxa_material_w  := round((coalesce(vl_lib_taxa_material_p,0))::numeric,2);
vl_liberado_material_w  := round((coalesce(vl_liberado_material_p,0))::numeric,2);

select  qt_material_imp,
  qt_material,
  vl_liberado,
  vl_taxa_material_imp,
  vl_taxa_material
into STRICT  qt_apresentada_w,
  qt_liberada_item_w,
  vl_liberado_item_w,
  vl_taxa_material_imp_w,
  vl_taxa_material_w
from  pls_conta_mat_v  a
where  nr_sequencia  = nr_seq_material_p;

CALL CALL pls_cta_alt_valor_pck.pls_valida_alteracao_valores(  null, qt_apresentada_w, qt_liberada_p,
        null, null, null);

/*Calculo quando da sa?da do campo quantidade*/

if (ie_opcao_p  = '1') then

  if (qt_liberada_w  = 0) then
    vl_unitario_w  := 0;
  end if;

  vl_liberado_w  := pls_cta_alt_valor_pck.pls_obter_val_liberado(qt_liberada_w,vl_unitario_w );

  if (ie_intercambio_p  = 'S') then

    vl_lib_taxa_material_w  := pls_cta_alt_valor_pck.pls_obter_val_taxa_mat(tx_intercambio_imp_p, vl_liberado_w);
    vl_liberado_material_w  := pls_cta_alt_valor_pck.pls_obter_val_lib_mat(vl_lib_taxa_material_w , vl_liberado_w);
  end if;
/*Calculo quando da sa?da do campo valor total liberado */

elsif (ie_opcao_p  = '2') then
  vl_unitario_w  := dividir_sem_round(vl_liberado_w,qt_liberada_w);

elsif (ie_opcao_p  = '5') then
  CALL CALL pls_cta_alt_valor_pck.pls_valida_alteracao_valores(  ie_opcao_p, qt_liberada_p, qt_liberada_p,
          vl_liberado_material_w, vl_liberado_material_w, vl_liberado_material_w);

  vl_lib_taxa_material_w  := dividir((vl_liberado_material_w * tx_intercambio_imp_p),100);
  vl_liberado_w  := vl_lib_taxa_material_w + vl_liberado_material_w;
elsif (ie_opcao_p  = '8') then

  CALL CALL pls_cta_alt_valor_pck.pls_valida_alteracao_valores(  ie_opcao_p, qt_apresentada_w, qt_liberada_p,
          vl_lib_taxa_material_w, vl_taxa_material_imp_w, vl_taxa_material_w);

  vl_liberado_w  := vl_lib_taxa_material_w + vl_liberado_material_w;
end if;

vl_unitario_out_p    := coalesce(vl_unitario_w,0);
vl_liberado_out_p    := coalesce(vl_liberado_w,0);
vl_liberado_material_out_p  := coalesce(vl_liberado_material_w,0);
vl_lib_taxa_material_out_p  := coalesce(vl_lib_taxa_material_w,0);

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_cta_alt_valor_pck.pls_calcula_valores_materiais ( qt_liberada_p pls_conta_proc_v.qt_procedimento%type, vl_unitario_p pls_conta_proc_v.vl_unitario%type, vl_liberado_p pls_conta_proc_v.vl_liberado%type, vl_liberado_material_p pls_conta_proc_v.vl_liberado_material%type, vl_lib_taxa_material_p pls_conta_proc_v.vl_lib_taxa_material%type, tx_intercambio_imp_p pls_conta_proc_v.tx_intercambio_imp%type, nr_seq_material_p pls_conta_proc_v.nr_sequencia%type, ie_opcao_p text, ie_intercambio_p text, vl_unitario_out_p INOUT pls_conta_proc_v.vl_unitario%type, vl_liberado_out_p INOUT pls_conta_proc_v.vl_liberado%type, vl_liberado_material_out_p INOUT pls_conta_proc_v.vl_liberado_material%type, vl_lib_taxa_material_out_p INOUT pls_conta_proc_v.vl_lib_taxa_material%type) FROM PUBLIC;
