-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_cta_alt_valor_pck.pls_gerencia_aceitar_melhor_vl ( nr_seq_conta_p pls_conta_v.nr_sequencia%type, nr_seq_conta_proc_p pls_conta_proc_v.nr_sequencia%type, nr_seq_conta_mat_p pls_conta_mat_v.nr_sequencia%type, cd_acao_analise_p pls_acao_analise.cd_acao%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE

ie_tipo_item_w    varchar(1);
vl_apresentado_w  pls_conta_proc_v.vl_procedimento_imp%type;
vl_calculado_w    pls_conta_proc_v.vl_procedimento%type;

BEGIN

ie_tipo_item_w  := pls_util_cta_pck.pls_obter_tipo_item_atend(nr_seq_conta_p, nr_seq_conta_proc_p, nr_seq_conta_mat_p, null);

case ie_tipo_item_w
  -- conta
  when 'C' then
    -- n?o implementado
    wheb_mensagem_pck.exibir_mensagem_abort(251677);
  -- procedimento
  when 'P' then

    select   a.vl_procedimento_imp,
      a.vl_procedimento
    into STRICT  vl_apresentado_w,
      vl_calculado_w
    from  pls_conta_proc_v a
    where  a.nr_sequencia  = nr_seq_conta_proc_p;

  -- material
  when 'M' then

    select   a.vl_material_imp,
      a.vl_material
    into STRICT  vl_apresentado_w,
      vl_calculado_w
    from  pls_conta_mat_v a
    where  a.nr_sequencia  = nr_seq_conta_mat_p;

  -- participante
  when 'R' then
    -- n?o implementado
    wheb_mensagem_pck.exibir_mensagem_abort(251678);
end case;

-- se o valor apresentado for menor, utiliza ele.
-- caso contr?rio, utiliza o calculado
if (vl_apresentado_w <= vl_calculado_w) then
  CALL pls_cta_alt_valor_pck.pls_gerencia_aceitar_vl_apres(  nr_seq_conta_p, nr_seq_conta_proc_p, nr_seq_conta_mat_p,
          cd_acao_analise_p, nm_usuario_p);
else
  CALL pls_cta_alt_valor_pck.pls_gerencia_aceitar_vl_calc(  nr_seq_conta_p, nr_seq_conta_proc_p, nr_seq_conta_mat_p, cd_acao_analise_p,
          nm_usuario_p);
end if;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_cta_alt_valor_pck.pls_gerencia_aceitar_melhor_vl ( nr_seq_conta_p pls_conta_v.nr_sequencia%type, nr_seq_conta_proc_p pls_conta_proc_v.nr_sequencia%type, nr_seq_conta_mat_p pls_conta_mat_v.nr_sequencia%type, cd_acao_analise_p pls_acao_analise.cd_acao%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;
