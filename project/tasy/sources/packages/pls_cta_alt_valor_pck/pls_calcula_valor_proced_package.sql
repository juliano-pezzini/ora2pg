-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_cta_alt_valor_pck.pls_calcula_valor_proced ( qt_liberada_p pls_conta_proc_v.qt_procedimento%type, vl_unitario_p pls_conta_proc_v.vl_unitario%type, vl_liberado_p pls_conta_proc_v.vl_liberado%type, vl_liberado_co_p pls_conta_proc_v.vl_liberado_co%type, vl_liberado_hi_p pls_conta_proc_v.vl_liberado_hi%type, vl_liberado_material_p pls_conta_proc_v.vl_liberado_material%type, vl_lib_taxa_co_p pls_conta_proc_v.vl_lib_taxa_co%type, vl_lib_taxa_material_p pls_conta_proc_v.vl_lib_taxa_material%type, vl_lib_taxa_servico_p pls_conta_proc_v.vl_lib_taxa_servico%type, tx_intercambio_imp_p pls_conta_proc_v.tx_intercambio_imp%type, nr_seq_procedimento_p pls_conta_proc_v.nr_sequencia%type, ie_opcao_p text, ie_intercambio_p text, vl_unitario_out_p INOUT pls_conta_proc_v.vl_unitario%type, vl_liberado_out_p INOUT pls_conta_proc_v.vl_liberado%type, vl_liberado_co_out_p INOUT pls_conta_proc_v.vl_liberado_co%type, vl_liberado_hi_out_p INOUT pls_conta_proc_v.vl_liberado_hi%type, vl_liberado_material_out_p INOUT pls_conta_proc_v.vl_liberado_material%type, vl_lib_taxa_co_out_p INOUT pls_conta_proc_v.vl_lib_taxa_co%type, vl_lib_taxa_material_out_p INOUT pls_conta_proc_v.vl_lib_taxa_material%type, vl_lib_taxa_servico_out_p INOUT pls_conta_proc_v.vl_lib_taxa_servico%type) AS $body$
DECLARE


vl_liberado_co_item_w        pls_conta_proc_v.vl_liberado_co%type    := 0;
vl_liberado_hi_item_w            pls_conta_proc_v.vl_liberado_hi%type    := 0;
vl_liberado_material_item_w    pls_conta_proc_v.vl_liberado_material%type  := 0;
vl_taxa_co_w                  pls_conta_proc_v.vl_taxa_co%type    := 0;
vl_taxa_co_imp_w              pls_conta_proc_v.vl_taxa_co_imp%type    := 0;
vl_taxa_material_w            pls_conta_proc_v.vl_taxa_material%type    := 0;
vl_taxa_material_imp_w          pls_conta_proc_v.vl_taxa_material_imp%type  := 0;
vl_taxa_servico_w             pls_conta_proc_v.vl_taxa_servico%type    := 0;
vl_taxa_servico_imp_w         pls_conta_proc_v.vl_taxa_servico_imp%type  := 0;
vl_material_ptu_imp_w      pls_conta_proc_v.vl_material_ptu_imp%type  := 0;
vl_procedimento_ptu_imp_w    pls_conta_proc_v.vl_procedimento_ptu_imp%type  := 0;
vl_co_ptu_imp_w        pls_conta_proc_v.vl_co_ptu_imp%type    := 0;
vl_menor_co_w            pls_conta_proc_v.vl_liberado_co%type    := 0;
vl_menor_hi_w              pls_conta_proc_v.vl_liberado_hi%type    := 0;
vl_menor_material_w      pls_conta_proc_v.vl_liberado_material%type  := 0;
qt_liberada_w        pls_conta_proc_v.qt_procedimento%type    := 0;
qt_apresentada_w      pls_conta_proc_v.qt_procedimento%type    := 0;
vl_unitario_item_w      pls_conta_proc_v.vl_unitario%type    := 0;
vl_unitario_w        pls_conta_proc_v.vl_unitario%type    := 0;
vl_liberado_w        pls_conta_proc_v.vl_liberado%type    := 0;
vl_liberado_co_w            pls_conta_proc_v.vl_liberado_co%type    := 0;
vl_liberado_hi_w            pls_conta_proc_v.vl_liberado_hi%type    := 0;
vl_liberado_material_w      pls_conta_proc_v.vl_liberado_material%type  := 0;
vl_lib_taxa_co_w           pls_conta_proc_v.vl_lib_taxa_co%type    := 0;
vl_lib_taxa_material_w      pls_conta_proc_v.vl_lib_taxa_material%type  := 0;
vl_lib_taxa_servico_w       pls_conta_proc_v.vl_lib_taxa_servico%type  := 0;
nr_seq_analise_w            pls_conta_proc_v.nr_seq_analise%type  := 0;
cd_procedimento_w           pls_conta_proc_v.cd_procedimento%type  := 0;


BEGIN

qt_liberada_w    := coalesce(qt_liberada_p,0);
vl_unitario_w    := coalesce(vl_unitario_p,0);
vl_liberado_w    := coalesce(vl_liberado_p,0);
vl_lib_taxa_co_w       := coalesce(vl_lib_taxa_co_p,0);
vl_lib_taxa_material_w  := coalesce(vl_lib_taxa_material_p,0);
vl_lib_taxa_servico_w   := coalesce(vl_lib_taxa_servico_p,0);
vl_liberado_material_w  := coalesce(vl_liberado_material_p,0);
vl_liberado_co_w        := coalesce(vl_liberado_co_p,0);
vl_liberado_hi_w        := coalesce(vl_liberado_hi_p,0);

select  qt_procedimento_imp,
  vl_liberado_hi,
  vl_liberado_material,
  vl_liberado_co,
  obter_valor_menor(a.vl_co_ptu_imp, a.vl_calc_co_util) vl_menor_co,
  obter_valor_menor(a.vl_procedimento_ptu_imp, a.vl_calc_hi_util) vl_menor_hi,
  obter_valor_menor(a.vl_material_ptu_imp, a.vl_calc_mat_util) vl_menor_mat,
  vl_unitario,
  vl_material_ptu_imp,
  vl_procedimento_ptu_imp,
  vl_co_ptu_imp,
  vl_taxa_co,
  vl_taxa_co_imp,
  vl_taxa_material,
  vl_taxa_material_imp,
  vl_taxa_servico,
  vl_taxa_servico_imp,
  nr_seq_analise,
  cd_procedimento
into STRICT  qt_apresentada_w,
  vl_liberado_hi_item_w,
  vl_liberado_material_item_w,
  vl_liberado_co_item_w,
  vl_menor_co_w,
  vl_menor_hi_w,
  vl_menor_material_w,
  vl_unitario_item_w,
  vl_material_ptu_imp_w,
  vl_procedimento_ptu_imp_w,
  vl_co_ptu_imp_w,
  vl_taxa_co_w,
  vl_taxa_co_imp_w,
  vl_taxa_material_w,
  vl_taxa_material_imp_w,
  vl_taxa_servico_w,
  vl_taxa_servico_imp_w,
  nr_seq_analise_w,
  cd_procedimento_w
from  pls_conta_proc_v  a
where  nr_sequencia  = nr_seq_procedimento_p;

CALL CALL pls_cta_alt_valor_pck.pls_valida_alteracao_valores(  null, qt_apresentada_w, qt_liberada_p,
        vl_liberado_hi_w, vl_procedimento_ptu_imp_w, null);
/*Calculo quando da sa?da do campo quantidade*/

if (ie_opcao_p  = '1') then

  vl_liberado_material_w  := vl_liberado_material_item_w;
  vl_liberado_co_w        := vl_liberado_co_item_w;
  vl_liberado_hi_w        := vl_liberado_hi_item_w;

  vl_liberado_w  := pls_cta_alt_valor_pck.pls_obter_val_liberado(qt_liberada_w,vl_unitario_w );

  if (ie_intercambio_p  = 'S') then
    if (vl_liberado_hi_w = 0) then
      vl_liberado_hi_w  := vl_menor_hi_w;
    end if;

    if (vl_liberado_material_w = 0) then
      vl_liberado_material_w  := vl_menor_material_w;
    end if;

    if (vl_liberado_co_w = 0) then
      vl_liberado_co_w  := vl_menor_co_w;
    end if;

    vl_lib_taxa_co_w       := pls_cta_alt_valor_pck.pls_obter_val_taxa(tx_intercambio_imp_p,vl_liberado_co_w,qt_liberada_w );

    if (vl_lib_taxa_co_w > coalesce(vl_taxa_co_imp_w,0)) then
      vl_lib_taxa_co_w := coalesce(vl_taxa_co_imp_w,0);
    end if;

    vl_lib_taxa_material_w  := pls_cta_alt_valor_pck.pls_obter_val_taxa(tx_intercambio_imp_p,vl_liberado_material_w,qt_liberada_w );

    if (vl_lib_taxa_material_w > coalesce(vl_taxa_material_imp_w,0)) then
      vl_lib_taxa_material_w := coalesce(vl_taxa_material_imp_w,0);
    end if;

    vl_lib_taxa_servico_w   := pls_cta_alt_valor_pck.pls_obter_val_taxa(tx_intercambio_imp_p,vl_liberado_hi_w,qt_liberada_w );

    if (vl_lib_taxa_servico_w > coalesce(vl_taxa_servico_imp_w,0)) then
      vl_lib_taxa_servico_w := coalesce(vl_taxa_servico_imp_w,0);
    end if;
    if (qt_liberada_w  != qt_apresentada_w) then

      vl_liberado_hi_w  := dividir(vl_liberado_hi_w,qt_apresentada_w) *qt_liberada_w;

      vl_liberado_material_w  := dividir(vl_liberado_material_w,qt_apresentada_w) *qt_liberada_w;

      vl_liberado_co_w  := dividir(vl_liberado_co_w,qt_apresentada_w) *qt_liberada_w;

      vl_lib_taxa_co_w       := dividir(vl_lib_taxa_co_w,qt_apresentada_w) *qt_liberada_w;

      vl_lib_taxa_material_w  := dividir(vl_lib_taxa_material_w,qt_apresentada_w) *qt_liberada_w;

      vl_lib_taxa_servico_w   := dividir(vl_lib_taxa_servico_w,qt_apresentada_w) *qt_liberada_w;

      vl_unitario_item_w  := dividir((vl_liberado_hi_w + vl_liberado_material_w + vl_liberado_co_w + vl_lib_taxa_co_w + vl_lib_taxa_material_w + vl_lib_taxa_servico_w), qt_liberada_w);
    end if;

    vl_unitario_w  := vl_unitario_item_w;
    vl_liberado_w  := pls_cta_alt_valor_pck.pls_obter_val_liberado(qt_liberada_w,vl_unitario_item_w );
  end if;

  if (qt_liberada_w  = 0) then
    vl_unitario_w  := 0;
  end if;
--Calculo quando da sa?da do campo valor total liberado
elsif (ie_opcao_p  = '2') then
  vl_unitario_w  := pls_cta_alt_valor_pck.pls_obter_val_liberado_uni(qt_liberada_w,vl_liberado_w );
--Calculo quando da sa?da do campo valor liberado proc
elsif (ie_opcao_p  = '3') then
  CALL CALL pls_cta_alt_valor_pck.pls_valida_alteracao_valores(  ie_opcao_p, qt_apresentada_w, qt_liberada_p,
          vl_liberado_hi_w, vl_procedimento_ptu_imp_w, null);
  vl_lib_taxa_servico_w   := pls_cta_alt_valor_pck.pls_obter_val_taxa(tx_intercambio_imp_p,vl_liberado_hi_w,qt_liberada_w );
  if (vl_lib_taxa_servico_w > coalesce(vl_taxa_servico_imp_w,0)) then
    vl_lib_taxa_servico_w := coalesce(vl_taxa_servico_imp_w,0);
  end if;
--Calculo quando da sa?da do campo valor liberado co
elsif (ie_opcao_p  = '4') then
  CALL CALL pls_cta_alt_valor_pck.pls_valida_alteracao_valores(  ie_opcao_p, qt_apresentada_w, qt_liberada_p,
          vl_liberado_co_w, vl_co_ptu_imp_w, null);
  vl_lib_taxa_co_w       := pls_cta_alt_valor_pck.pls_obter_val_taxa(tx_intercambio_imp_p,vl_liberado_co_w,qt_liberada_w );

  if (vl_lib_taxa_co_w > coalesce(vl_taxa_co_imp_w,0)) then
    vl_lib_taxa_co_w := coalesce(vl_taxa_co_imp_w,0);
  end if;

--Calculo quando da sa?da do campo valor liberado mat
elsif (ie_opcao_p  = '5') then
  CALL CALL pls_cta_alt_valor_pck.pls_valida_alteracao_valores(  ie_opcao_p, qt_apresentada_w, qt_liberada_p,
          vl_liberado_material_w, vl_material_ptu_imp_w, null);
  vl_lib_taxa_material_w  := pls_cta_alt_valor_pck.pls_obter_val_taxa(tx_intercambio_imp_p,vl_liberado_material_w,qt_liberada_w );
  if (vl_lib_taxa_material_w > coalesce(vl_taxa_material_imp_w,0)) then
    vl_lib_taxa_material_w := coalesce(vl_taxa_material_imp_w,0);
  end if;
--Calculo quando da sa?da do campo valor liberado taxa servico
elsif (ie_opcao_p  = '6') then
  CALL CALL pls_cta_alt_valor_pck.pls_valida_alteracao_valores(  ie_opcao_p, qt_apresentada_w, qt_liberada_p,
          vl_lib_taxa_servico_w, vl_taxa_servico_imp_w,vl_taxa_servico_w);
--Calculo quando da sa?da do campo valor liberado taxa co
elsif (ie_opcao_p  = '7') then
  CALL CALL pls_cta_alt_valor_pck.pls_valida_alteracao_valores(  ie_opcao_p, qt_apresentada_w, qt_liberada_p,
          vl_lib_taxa_co_w, vl_taxa_co_imp_w, vl_taxa_co_w);
--Calculo quando da sa?da do campo valor liberado taxa material
elsif (ie_opcao_p  = '8') then
  CALL CALL pls_cta_alt_valor_pck.pls_valida_alteracao_valores(  ie_opcao_p, qt_apresentada_w, qt_liberada_p,
          vl_lib_taxa_material_w, vl_taxa_material_imp_w, vl_taxa_material_w);
end if;

if (ie_opcao_p  in ('3','4','5','6','7','8','9')) then

  vl_liberado_w  :=   vl_lib_taxa_servico_w + vl_lib_taxa_co_w + vl_lib_taxa_material_w +
        vl_liberado_hi_w + vl_liberado_co_w + vl_liberado_material_w;
  if (qt_liberada_w  = 0 ) and (vl_liberado_w  > 0) then
    vl_liberado_w  := 0;
  end if;
end if;

vl_unitario_out_p    := coalesce(vl_unitario_w,0);
vl_liberado_out_p    := coalesce(vl_liberado_w,0);
vl_liberado_co_out_p        := coalesce(vl_liberado_co_w,0);
vl_liberado_hi_out_p          := coalesce(vl_liberado_hi_w,0);
vl_liberado_material_out_p  := coalesce(vl_liberado_material_w,0);
vl_lib_taxa_co_out_p       := coalesce(vl_lib_taxa_co_w,0);
vl_lib_taxa_material_out_p  := coalesce(vl_lib_taxa_material_w,0);
vl_lib_taxa_servico_out_p     := coalesce(vl_lib_taxa_servico_w,0);

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_cta_alt_valor_pck.pls_calcula_valor_proced ( qt_liberada_p pls_conta_proc_v.qt_procedimento%type, vl_unitario_p pls_conta_proc_v.vl_unitario%type, vl_liberado_p pls_conta_proc_v.vl_liberado%type, vl_liberado_co_p pls_conta_proc_v.vl_liberado_co%type, vl_liberado_hi_p pls_conta_proc_v.vl_liberado_hi%type, vl_liberado_material_p pls_conta_proc_v.vl_liberado_material%type, vl_lib_taxa_co_p pls_conta_proc_v.vl_lib_taxa_co%type, vl_lib_taxa_material_p pls_conta_proc_v.vl_lib_taxa_material%type, vl_lib_taxa_servico_p pls_conta_proc_v.vl_lib_taxa_servico%type, tx_intercambio_imp_p pls_conta_proc_v.tx_intercambio_imp%type, nr_seq_procedimento_p pls_conta_proc_v.nr_sequencia%type, ie_opcao_p text, ie_intercambio_p text, vl_unitario_out_p INOUT pls_conta_proc_v.vl_unitario%type, vl_liberado_out_p INOUT pls_conta_proc_v.vl_liberado%type, vl_liberado_co_out_p INOUT pls_conta_proc_v.vl_liberado_co%type, vl_liberado_hi_out_p INOUT pls_conta_proc_v.vl_liberado_hi%type, vl_liberado_material_out_p INOUT pls_conta_proc_v.vl_liberado_material%type, vl_lib_taxa_co_out_p INOUT pls_conta_proc_v.vl_lib_taxa_co%type, vl_lib_taxa_material_out_p INOUT pls_conta_proc_v.vl_lib_taxa_material%type, vl_lib_taxa_servico_out_p INOUT pls_conta_proc_v.vl_lib_taxa_servico%type) FROM PUBLIC;
