-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_cta_alt_valor_pck.pls_ajustar_valor_partic ( nr_seq_proc_p pls_conta_proc.nr_sequencia%type, vl_proc_liberado_p pls_conta_proc.vl_liberado%type) AS $body$
DECLARE


vl_tot_partic_w    pls_proc_participante.vl_participante%type;
vl_dif_partic_w    pls_proc_participante.vl_participante%type;
vl_partic_w    pls_proc_participante.vl_participante%type;


BEGIN

--Ajustar valor participante para tratar quest?o do arredondamento de valores.
select   coalesce(sum(vl_participante),0)
into STRICT  vl_tot_partic_w
from  pls_proc_participante
where  nr_seq_conta_proc    = nr_seq_proc_p
and  ((coalesce(ie_status::text, '') = '') or (ie_status != 'C'))
and  ((coalesce(ie_gerada_cta_honorario::text, '') = '') or (ie_gerada_cta_honorario <> 'S'));

--No processo, o a soma do valor dos participantes pode tanto aumentar quanto diminuir, em rela??o ao valor liberado do procedimento.
if (vl_tot_partic_w <> vl_proc_liberado_p ) then
  vl_dif_partic_w  := vl_tot_partic_w - vl_proc_liberado_p;

  update  pls_proc_participante  a
  set  a.vl_participante  = a.vl_participante - vl_dif_partic_w
  where  a.nr_sequencia  = (  SELECT  max(x.nr_sequencia)
          from  pls_proc_participante  x
          where  x.nr_seq_conta_proc    = nr_seq_proc_p
          and  ((coalesce(x.ie_status::text, '') = '') or (x.ie_status != 'C'))
          and  ((coalesce(x.ie_gerada_cta_honorario::text, '') = '') or (x.ie_gerada_cta_honorario <> 'S'))
          and  x.vl_participante >= vl_dif_partic_w);

end if;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_cta_alt_valor_pck.pls_ajustar_valor_partic ( nr_seq_proc_p pls_conta_proc.nr_sequencia%type, vl_proc_liberado_p pls_conta_proc.vl_liberado%type) FROM PUBLIC;
