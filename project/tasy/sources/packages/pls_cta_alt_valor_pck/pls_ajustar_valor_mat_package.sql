-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_cta_alt_valor_pck.pls_ajustar_valor_mat ( nr_seq_conta_p pls_conta_v.nr_sequencia%type, nr_seq_conta_mat_p pls_conta_mat_v.nr_sequencia%type, qt_liberada_p pls_conta_proc_v.qt_procedimento%type, vl_liberado_p pls_conta_proc_v.vl_liberado%type, vl_unitario_p pls_conta_proc_v.vl_unitario%type, vl_lib_taxa_mat_p pls_conta_proc_v.vl_lib_taxa_material%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE


ie_tipo_conta_w   pls_conta_v.ie_tipo_conta%type;
vl_glosa_w     pls_conta_mat_v.vl_glosa%type;
vl_glosa_taxa_w   pls_conta_mat_v.vl_glosa_taxa_material%type;
ie_tipo_liberacao_w  pls_conta_proc_v.ie_tipo_liberacao%type;
C01 CURSOR(nr_seq_conta_mat_p    pls_conta_mat_v.nr_sequencia%type) FOR
  SELECT  a.nr_sequencia,
    round((a.vl_material_imp)::numeric,2) vl_material_imp,
    a.vl_taxa_material_imp
  from  pls_conta_mat_v a
  where  a.nr_sequencia  = nr_seq_conta_mat_p;

BEGIN
-- obt?m o tipo de conta
ie_tipo_conta_w := pls_util_cta_pck.pls_obter_tipo_conta(nr_seq_conta_p);
ie_tipo_liberacao_w := 'AV';
for r_C01_w in C01(nr_seq_conta_mat_p) loop

  vl_glosa_w := pls_util_cta_pck.pls_obter_vl_glosa(round((vl_liberado_p)::numeric,2), r_C01_w.vl_material_imp);

  -- se for interc?mbio
  if (ie_tipo_conta_w = 'I') then

    vl_glosa_taxa_w := pls_util_cta_pck.pls_obter_vl_glosa(vl_lib_taxa_mat_p, r_C01_w.vl_taxa_material_imp);

    -- Somar o valor de glosa da taxa ao valor de glosa do item
    -- OS 606930.
    update   pls_conta_mat set
      vl_liberado     = vl_liberado_p,
      qt_material    = qt_liberada_p,
      vl_unitario    = vl_unitario_p,
      vl_glosa    = vl_glosa_w,
      vl_lib_taxa_material  = vl_lib_taxa_mat_p,
      vl_glosa_taxa_material  = vl_glosa_taxa_w,
      ie_status_pagamento  = pls_obter_stat_pag_item(ie_glosa, vl_liberado_p, vl_glosa_w),
      nm_usuario    = nm_usuario_p,
      ie_tipo_liberacao  = ie_tipo_liberacao_w,
      dt_atualizacao    = clock_timestamp(),
      ie_status    = 'L'
    where  nr_sequencia    = r_C01_w.nr_sequencia;
  else
    update   pls_conta_mat set
      vl_liberado     = vl_liberado_p,
      qt_material    = qt_liberada_p,
      vl_unitario    = vl_unitario_p,
      vl_glosa    = vl_glosa_w,
      ie_status_pagamento  = pls_obter_stat_pag_item(ie_glosa, vl_liberado_p, vl_glosa_w),
      nm_usuario    = nm_usuario_p,
      ie_tipo_liberacao   = ie_tipo_liberacao_w,
      dt_atualizacao    = clock_timestamp(),
      -- campos abaixo s?o zerados por seguran?a
      vl_lib_taxa_material  = 0,
      vl_glosa_taxa_material  = 0,
      ie_status    = 'L'
    where  nr_sequencia    = r_C01_w.nr_sequencia;
  end if;
end loop;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_cta_alt_valor_pck.pls_ajustar_valor_mat ( nr_seq_conta_p pls_conta_v.nr_sequencia%type, nr_seq_conta_mat_p pls_conta_mat_v.nr_sequencia%type, qt_liberada_p pls_conta_proc_v.qt_procedimento%type, vl_liberado_p pls_conta_proc_v.vl_liberado%type, vl_unitario_p pls_conta_proc_v.vl_unitario%type, vl_lib_taxa_mat_p pls_conta_proc_v.vl_lib_taxa_material%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;
