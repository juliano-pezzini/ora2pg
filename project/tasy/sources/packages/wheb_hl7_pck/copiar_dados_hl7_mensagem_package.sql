-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE wheb_hl7_pck.copiar_dados_hl7_mensagem (nr_seq_mensagem_p bigint, nr_seq_mensagem_new_p bigint) AS $body$
DECLARE

        c01 CURSOR(seq_mensagem bigint) FOR
            SELECT nr_sequencia,
                   nm_segmento
              from hl7_segmento a
             where nr_seq_mensagem = seq_mensagem
               and ie_tipo in ('GRU', 'SEG')
               and not exists (SELECT 1
                      from hl7_atributo z,
                           hl7_segmento x
                     where x.nr_sequencia = z.nr_seq_segmento
                       and x.nr_seq_mensagem = a.nr_seq_mensagem
                       and z.nr_seq_atrib_segm = a.nr_sequencia
                       and (z.nr_seq_atrib_segm IS NOT NULL AND z.nr_seq_atrib_segm::text <> ''))
             order by a.nr_seq_apresentacao;

        hl7_segmento_w c01%rowtype;
        type ttype is table of c01%rowtype;
        hl7_segmento2_w ttype;

    
BEGIN
        open c01(nr_seq_mensagem_new_p);
        fetch c01 bulk collect
            into hl7_segmento2_w;
        close c01;

        open c01(nr_seq_mensagem_p);
        loop
            fetch c01
                into hl7_segmento_w;
            EXIT WHEN NOT FOUND; /* apply on c01 */
            begin
                for i in 1 .. hl7_segmento2_w.count loop
                    if (hl7_segmento2_w[i].nm_segmento = hl7_segmento_w.nm_segmento) then
                        CALL wheb_hl7_pck.copiar_dados_hl7_segmento(hl7_segmento_w.nr_sequencia, hl7_segmento2_w[i].nr_sequencia);
                    end if;
                end loop;
            end;
        end loop;
        close c01;
    end;


$body$
LANGUAGE PLPGSQL
;
-- REVOKE ALL ON PROCEDURE wheb_hl7_pck.copiar_dados_hl7_mensagem (nr_seq_mensagem_p bigint, nr_seq_mensagem_new_p bigint) FROM PUBLIC;
