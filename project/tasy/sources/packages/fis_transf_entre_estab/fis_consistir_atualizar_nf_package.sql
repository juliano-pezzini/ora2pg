-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE fis_transf_entre_estab.fis_consistir_atualizar_nf ( nr_seq_nota_p bigint, ie_devolucao_p text default 'N', nm_usuario_p text DEFAULT NULL, qt_inconsistencia_nota_p INOUT bigint DEFAULT NULL) AS $body$
DECLARE


qt_inconsistencia_nota_w	bigint:=  0;
ie_devolucao_w			operacao_nota.ie_devolucao%type;
ie_tipo_nota_w			nota_fiscal.ie_tipo_nota%type;


BEGIN

	begin

		CALL atualiza_total_nota_fiscal(nr_seq_nota_p, nm_usuario_p);

		consiste_nota_integra(nr_seq_nota_p, nm_usuario_p, qt_inconsistencia_nota_w, ie_devolucao_w);

		select  ie_tipo_nota
		into STRICT  	ie_tipo_nota_w
		from    nota_fiscal
		where  	nr_sequencia = nr_seq_nota_p;

		if ( qt_inconsistencia_nota_w > 0) then
			begin
				qt_inconsistencia_nota_p:=qt_inconsistencia_nota_w;
			end;
		else
			CALL gerar_lote_fornec_nf(nr_seq_nota_p,'N',nm_usuario_p,'N','N');

			if (ie_tipo_nota_w = 'SF') then  
				CALL atualizar_nota_fiscal(nr_seq_nota_p,'I',nm_usuario_p,4);
			elsif (ie_tipo_nota_w in ('SE','SD')) then
				CALL atualizar_nota_fiscal(nr_seq_nota_p,'I',nm_usuario_p,3);
			else
				CALL atualizar_nota_fiscal(nr_seq_nota_p,'I',nm_usuario_p,0);
			end if;
		end if;
	end;



END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE fis_transf_entre_estab.fis_consistir_atualizar_nf ( nr_seq_nota_p bigint, ie_devolucao_p text default 'N', nm_usuario_p text DEFAULT NULL, qt_inconsistencia_nota_p INOUT bigint DEFAULT NULL) FROM PUBLIC;
