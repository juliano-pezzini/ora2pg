-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION fis_transf_entre_estab.fis_gerar_registro_nota_item ( nr_seq_nota_original_p bigint, nota_fiscal_transf_item_p registro_nf_transf_item, ie_entrada_saida_p text, nr_seq_nota_fiscal_transf_p nota_fiscal.nr_sequencia%type, cd_serie_nf_p nota_fiscal_item.cd_serie_nf%type, cd_estabelecimento_p nota_fiscal_item.cd_estabelecimento%type, cd_operacao_nf_p nota_fiscal.cd_operacao_nf%type) RETURNS REGISTRO_NOTA_FISCAL_ITEM AS $body$
DECLARE


ds_retorno_w	registro_nota_fiscal_item;

cd_unidade_medida_compra_w 	nota_fiscal_item.cd_unidade_medida_compra%type;
cd_unidade_medida_estoque_w	nota_fiscal_item.cd_unidade_medida_estoque%type;
cd_moeda_w			nota_fiscal.cd_moeda%type;
nr_seq_proj_rec_w		nota_fiscal_item.nr_seq_proj_rec%type;
cd_cgc_w			nota_fiscal.cd_cgc%type;
cd_pessoa_fisica_w		nota_fiscal.cd_pessoa_fisica%type;
ie_tipo_pessoa_w		varchar(2);
nr_seq_conta_financ_w		nota_fiscal_item.nr_seq_conta_financ%type;
ie_entrada_saida_w		varchar(1);
cd_centro_custo_w		nota_fiscal_item.cd_centro_custo%type;
cd_local_estoque_w		nota_fiscal_item.cd_local_estoque%type;

BEGIN

select	cd_cgc,
	cd_pessoa_fisica,
	cd_moeda
into STRICT	cd_cgc_w,
	cd_pessoa_fisica_w,
	cd_moeda_w
from 	nota_fiscal
where nr_sequencia = nr_seq_nota_original_p;

if (coalesce(cd_pessoa_fisica_w::text, '') = '') then
	ie_tipo_pessoa_w := 'PJ';
else
	ie_tipo_pessoa_w := 'PF';
end if;

for i in 1..nota_fiscal_transf_item_p.count  loop
	begin
	
	select 	cd_unidade_medida_compra,
		cd_unidade_medida_estoque,
		nr_seq_proj_rec
	into STRICT	cd_unidade_medida_compra_w,
		cd_unidade_medida_estoque_w,
		nr_seq_proj_rec_w
	from	nota_fiscal_item
	where 	nr_sequencia = nr_seq_nota_original_p
	and	cd_material = nota_fiscal_transf_item_p[i].cd_material;
	
	ds_retorno_w[i].nr_sequencia			:= nr_seq_nota_fiscal_transf_p;
	ds_retorno_w[i].nr_item_nf			:= i;
	ds_retorno_w[i].cd_procedimento			:= nota_fiscal_transf_item_p[i].cd_procedimento;
	ds_retorno_w[i].cd_material			:= nota_fiscal_transf_item_p[i].cd_material;
	ds_retorno_w[i].ie_origem_proced		:= nota_fiscal_transf_item_p[i].ie_origem_proced;
	ds_retorno_w[i].nm_usuario			:= nota_fiscal_transf_item_p[i].nm_usuario;
	ds_retorno_w[i].pr_desconto			:= nota_fiscal_transf_item_p[i].pr_desconto;
	ds_retorno_w[i].vl_desconto			:= nota_fiscal_transf_item_p[i].vl_desconto;
	ds_retorno_w[i].qt_item_nf			:= nota_fiscal_transf_item_p[i].qt_item_trans;
	ds_retorno_w[i].vl_liquido			:= nota_fiscal_transf_item_p[i].vl_liquido;
	ds_retorno_w[i].vl_total_item_nf		:= nota_fiscal_transf_item_p[i].vl_total_item_nf;
	ds_retorno_w[i].vl_unitario_item_nf		:= nota_fiscal_transf_item_p[i].vl_unitario_item_nf;
	ds_retorno_w[i].dt_atualizacao			:= clock_timestamp();
	ds_retorno_w[i].vl_seguro			:= 0;
	ds_retorno_w[i].vl_frete			:= 0;
	ds_retorno_w[i].vl_desconto_rateio		:= 0;
	ds_retorno_w[i].vl_despesa_acessoria		:= 0;
	ds_retorno_w[i].qt_item_estoque			:= nota_fiscal_transf_item_p[i].qt_item_trans;
	ds_retorno_w[i].nr_sequencia_nf			:= 1;
	ds_retorno_w[i].cd_serie_nf			:= cd_serie_nf_p;	
	ds_retorno_w[i].cd_estabelecimento		:= cd_estabelecimento_p;
	ds_retorno_w[i].cd_unidade_medida_compra	:= cd_unidade_medida_compra_w;
	ds_retorno_w[i].cd_unidade_medida_estoque	:= cd_unidade_medida_estoque_w;
	
	if (ie_entrada_saida_p = 'E') then
		ie_entrada_saida_w 			:= 'S';
		cd_centro_custo_w			:= nota_fiscal_transf_item_p[i].cd_centro_custo_e;
		cd_local_estoque_w			:= nota_fiscal_transf_item_p[i].cd_local_estoque_e;
		ds_retorno_w[i].cd_centro_custo		:= cd_centro_custo_w;
		ds_retorno_w[i].cd_conta_contabil	:= nota_fiscal_transf_item_p[i].cd_conta_contabil_e;
		ds_retorno_w[i].cd_local_estoque	:= nota_fiscal_transf_item_p[i].cd_local_estoque_e;
		ds_retorno_w[i].cd_natureza_operacao	:= nota_fiscal_transf_item_p[i].cd_natureza_operacao_e;
	elsif (ie_entrada_saida_p = 'S') then
		ie_entrada_saida_w 			:= 'E';
		cd_centro_custo_w			:= nota_fiscal_transf_item_p[i].cd_centro_custo_s;
		cd_local_estoque_w			:= nota_fiscal_transf_item_p[i].cd_local_estoque_s;
		ds_retorno_w[i].cd_centro_custo		:= cd_centro_custo_w;
		ds_retorno_w[i].cd_conta_contabil	:= nota_fiscal_transf_item_p[i].cd_conta_contabil_s;
		ds_retorno_w[i].cd_local_estoque	:= nota_fiscal_transf_item_p[i].cd_local_estoque_s;
		ds_retorno_w[i].cd_natureza_operacao	:= nota_fiscal_transf_item_p[i].cd_natureza_operacao_s;
	end if;
	
	obter_conta_financeira( ie_entrada_saida_w,
				cd_estabelecimento_p,
				nota_fiscal_transf_item_p[i].cd_material,
				nota_fiscal_transf_item_p[i].cd_procedimento,
				nota_fiscal_transf_item_p[i].ie_origem_proced,
				null,
				null,
				cd_cgc_w,
				cd_centro_custo_w,
				nr_seq_conta_financ_w,
				null,
				cd_operacao_nf_p,
				ie_tipo_pessoa_w,
				null,
				null,
				nr_seq_proj_rec_w,
				null,
				cd_pessoa_fisica_w,
				null,
				null,
				null,
				null,
				cd_local_estoque_w,
				null,
				null,
				null,
				null,
				null,
				cd_moeda_w);
						
	if (nr_seq_conta_financ_w <> 0) then
		ds_retorno_w[i].nr_seq_conta_financ := nr_seq_conta_financ_w;
	end if;
	
	
	end;
end loop;

return	ds_retorno_w;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION fis_transf_entre_estab.fis_gerar_registro_nota_item ( nr_seq_nota_original_p bigint, nota_fiscal_transf_item_p registro_nf_transf_item, ie_entrada_saida_p text, nr_seq_nota_fiscal_transf_p nota_fiscal.nr_sequencia%type, cd_serie_nf_p nota_fiscal_item.cd_serie_nf%type, cd_estabelecimento_p nota_fiscal_item.cd_estabelecimento%type, cd_operacao_nf_p nota_fiscal.cd_operacao_nf%type) FROM PUBLIC;
