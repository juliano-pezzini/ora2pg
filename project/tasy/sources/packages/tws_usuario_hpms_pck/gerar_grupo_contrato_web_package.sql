-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE tws_usuario_hpms_pck.gerar_grupo_contrato_web ( nr_seq_grupo_contrato_p pls_grupo_contrato.nr_sequencia%type, cd_pessoa_fisica_p pessoa_fisica.cd_pessoa_fisica%type, nm_usuario_web_p pls_grupo_contrato_web.nm_usuario_web%type, nr_seq_contrato_p pls_contrato.nr_sequencia%type, nr_seq_intercambio_p pls_intercambio.nr_sequencia%type, ds_seqs_cont_grupo_p text, nr_seq_subestipulante_p pls_sub_estipulante.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nr_seq_grupo_contrato_web_p INOUT pls_grupo_contrato_web.nr_sequencia%type) AS $body$
DECLARE

			

ie_origem_grupo_web_w		pls_grupo_contrato_web.ie_origem_grupo_web%type;
nr_seq_grupo_contrato_web_w	pls_grupo_contrato_web.nr_sequencia%type;
ds_seqs_cont_grupo_w		varchar(4000);
nr_seq_contrato_w		pls_contrato.nr_sequencia%type;
nr_seq_intercambio_w		pls_intercambio.nr_sequencia%type;
nr_seq_contrato_grupo_w		pls_contrato_grupo.nr_sequencia%type;


BEGIN
	if (nr_seq_grupo_contrato_p IS NOT NULL AND nr_seq_grupo_contrato_p::text <> '') then
		select	CASE WHEN ie_tipo_grupo='C' THEN 3  ELSE 4 END
		into STRICT	ie_origem_grupo_web_w
		from	pls_grupo_contrato
		where	nr_sequencia	= nr_seq_grupo_contrato_p;
		
	elsif (nr_seq_contrato_p IS NOT NULL AND nr_seq_contrato_p::text <> '') then
		ie_origem_grupo_web_w	:= 1;
		
	elsif (nr_seq_intercambio_p IS NOT NULL AND nr_seq_intercambio_p::text <> '') then
		ie_origem_grupo_web_w	:= 2;
	end if;
		
	insert into pls_grupo_contrato_web(	nr_sequencia, nm_usuario_web, ds_senha,
						ie_situacao, dt_atualizacao, nm_usuario,                     
						dt_atualizacao_nrec, nm_usuario_nrec, nr_seq_grupo_contrato,          
						cd_estabelecimento, cd_pessoa_fisica, ie_origem_grupo_web,              
						ds_email, ds_tec)  

				values (	nextval('pls_grupo_contrato_web_seq'), nm_usuario_web_p, null,
						'A', clock_timestamp(), nm_usuario_p,
						clock_timestamp(), nm_usuario_p, nr_seq_grupo_contrato_p,
						cd_estabelecimento_p, cd_pessoa_fisica_p, ie_origem_grupo_web_w,																
						null, null) returning nr_sequencia INTO nr_seq_grupo_contrato_web_w;
	
	if (ds_seqs_cont_grupo_p IS NOT NULL AND ds_seqs_cont_grupo_p::text <> '') then
		ds_seqs_cont_grupo_w	:= ds_seqs_cont_grupo_p;
		
		while(position(',' in ds_seqs_cont_grupo_w) <> 0) loop
			begin
				nr_seq_contrato_grupo_w		:= substr(ds_seqs_cont_grupo_w,1,position(',' in ds_seqs_cont_grupo_w) - 1);
				ds_seqs_cont_grupo_w		:= substr(ds_seqs_cont_grupo_w,position(',' in ds_seqs_cont_grupo_w) + 1,255);
	
				begin
					select	nr_seq_contrato,
						nr_seq_intercambio
					into STRICT	nr_seq_contrato_w,
						nr_seq_intercambio_w
					from	pls_contrato_grupo
					where	nr_sequencia	= nr_seq_contrato_grupo_w;
				exception
				when others then
					nr_seq_contrato_w	:= null;
					nr_seq_intercambio_w	:= null;
				end;
				
				CALL tws_usuario_hpms_pck.inserir_contrato_web(	nr_seq_grupo_contrato_web_w, nr_seq_contrato_w, nr_seq_intercambio_w,
							nr_seq_subestipulante_p, nm_usuario_p, cd_estabelecimento_p);
			end;
		end loop;
	else
		CALL tws_usuario_hpms_pck.inserir_contrato_web(	nr_seq_grupo_contrato_web_w, nr_seq_contrato_p, nr_seq_intercambio_p,
					nr_seq_subestipulante_p, nm_usuario_p, cd_estabelecimento_p);
	end if;

	nr_seq_grupo_contrato_web_p	:= nr_seq_grupo_contrato_web_w;
	
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE tws_usuario_hpms_pck.gerar_grupo_contrato_web ( nr_seq_grupo_contrato_p pls_grupo_contrato.nr_sequencia%type, cd_pessoa_fisica_p pessoa_fisica.cd_pessoa_fisica%type, nm_usuario_web_p pls_grupo_contrato_web.nm_usuario_web%type, nr_seq_contrato_p pls_contrato.nr_sequencia%type, nr_seq_intercambio_p pls_intercambio.nr_sequencia%type, ds_seqs_cont_grupo_p text, nr_seq_subestipulante_p pls_sub_estipulante.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nr_seq_grupo_contrato_web_p INOUT pls_grupo_contrato_web.nr_sequencia%type) FROM PUBLIC;
