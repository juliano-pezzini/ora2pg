-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE ctb_lote_distrib_custos.val_lote_distrib_custos ( nm_usuario_p usuario.nm_usuario%type, nr_seq_mes_ref_p lote_contabil.nr_seq_mes_ref%type, cd_estab_tabela_p tabela_custo.cd_estabelecimento%type ) AS $body$
DECLARE


qt_reg_w                        integer;
ds_centro_controle_w            varchar(300);
cd_estabelecimento_w            centro_controle.cd_estabelecimento%type;
ds_natureza_gasto_w             varchar(300);
cd_empresa_w                    natureza_gasto.cd_empresa%type;
ds_lista_centro_controle_w      varchar(4000);
ds_lista_natureza_gasto_w       varchar(4000);

c01 CURSOR FOR
        /*verificar se existe um centro de custo para cada centro de controle*/

        SELECT  a.cd_centro_controle||' - '||a.ds_centro_controle ds_centro_controle,
                a.cd_estabelecimento
        from    centro_controle a
        where   not exists (SELECT       1
                        from    centro_custo b
                        where   a.cd_centro_controle = b.cd_centro_custo
                        and     a.cd_estabelecimento = b.cd_estabelecimento);
c01_w           c01%rowtype;

c02 CURSOR FOR
        /*valida a natureza  apenas 10*/

        SELECT  a.cd_natureza_gasto||' - '||a.ds_natureza_gasto ds_natureza_gasto,
                a.cd_empresa,
                a.cd_estabelecimento
        from    natureza_gasto a
        where   not exists (     SELECT  1
                                from    conta_contabil b
                                where   coalesce(a.cd_conta_contabil_dist,a.cd_conta_contabil) = b.cd_conta_contabil
                                and     a.cd_empresa = b.cd_empresa);
c02_w           c02%rowtype;


BEGIN

begin
select  1
into STRICT    qt_reg_w
from    lote_contabil a
where   a.nr_seq_mes_ref = nr_seq_mes_ref_p
and     a.cd_tipo_lote_contabil = current_setting('ctb_lote_distrib_custos.cd_tipo_lote_contabil_w')::tipo_lote_contabil.cd_tipo_lote_contabil%type
and     ((coalesce(cd_estab_tabela_p::text, '') = '') or (a.cd_estabelecimento = cd_estab_tabela_p))  LIMIT 1;
exception
when too_many_rows then raise;
when no_data_found then
        qt_reg_w := 0;
end;

if (qt_reg_w > 0) then
        qt_reg_w := qt_reg_w;
        /* Ja existe um lote de distribuicao de custos gerado neste mes */

      CALL wheb_mensagem_pck.exibir_mensagem_abort(current_setting('ctb_lote_distrib_custos.batch_already_exists')::dic_objeto.nr_sequencia%type);
end if;

open c01;
loop
fetch c01 into
        ds_centro_controle_w,
        cd_estabelecimento_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
        begin
        ds_lista_centro_controle_w := substr(ds_lista_centro_controle_w||ds_centro_controle_w||','||CHR(10),1,4000);
        end;
end loop;
close c01;

if (ds_lista_centro_controle_w IS NOT NULL AND ds_lista_centro_controle_w::text <> '') then
    CALL wheb_mensagem_pck.exibir_mensagem_abort(current_setting('ctb_lote_distrib_custos.control_centers_not_registered')::dic_objeto.nr_sequencia%type,'DS_CENTRO_CUSTO='||ds_lista_centro_controle_w);
end if;

open c02;
loop
fetch c02 into
        ds_natureza_gasto_w,
        cd_empresa_w,
        cd_estabelecimento_w;
EXIT WHEN NOT FOUND; /* apply on c02 */
        begin
        ds_lista_natureza_gasto_w := substr(ds_lista_natureza_gasto_w||ds_natureza_gasto_w||','||CHR(10),1,4000);
        end;
end loop;
close c02;

if (ds_lista_natureza_gasto_w IS NOT NULL AND ds_lista_natureza_gasto_w::text <> '') then
    CALL wheb_mensagem_pck.exibir_mensagem_abort(current_setting('ctb_lote_distrib_custos.spending_natures_not_linked')::dic_objeto.nr_sequencia%type,'DS_NATUREZA_GASTO='||ds_lista_natureza_gasto_w);
end if;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ctb_lote_distrib_custos.val_lote_distrib_custos ( nm_usuario_p usuario.nm_usuario%type, nr_seq_mes_ref_p lote_contabil.nr_seq_mes_ref%type, cd_estab_tabela_p tabela_custo.cd_estabelecimento%type ) FROM PUBLIC;
