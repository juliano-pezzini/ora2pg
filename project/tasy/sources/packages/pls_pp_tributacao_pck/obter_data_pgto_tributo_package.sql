-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pls_pp_tributacao_pck.obter_data_pgto_tributo ( cd_condicao_pgto_p tributo_conta_pagar.cd_cond_pagto%type, ie_vencimento_p tributo.ie_vencimento%type, ie_venc_pls_pag_prod_p tributo.ie_venc_pls_pag_prod%type, dt_competencia_p timestamp, dt_venc_titulo_p timestamp, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nr_seq_prestador_p pls_prestador.nr_sequencia%type, cd_tributo_p tributo.cd_tributo%type ) RETURNS timestamp AS $body$
DECLARE


ds_vencimentos_w	varchar(2000);
qt_vencimentos_w	integer;
dt_pgto_tributo_w	timestamp;


BEGIN
-- vai conforme a ordem de 'prioridade' das regras, pode ser ajustada a data do tributo no proprio tributo

-- via 2 campos e na regra de calculo

if (ie_vencimento_p in ('V', 'C')) then

	dt_pgto_tributo_w := dt_venc_titulo_p;
else
	dt_pgto_tributo_w := dt_competencia_p;
end if;

if (ie_venc_pls_pag_prod_p = 'C') then

	dt_pgto_tributo_w := dt_competencia_p;

elsif (ie_venc_pls_pag_prod_p = 'V') then

	dt_pgto_tributo_w := dt_venc_titulo_p;
end if;

-- porem caso exista alguma condicao cadastrada na regra de calculo tributo entao esta e a mais restrita e deve ser a ultima a ser processada

-- se tem alguma condicao de pagamento informada na regra entao precisamos verificar a data de pagamento do tributo

-- se nao entao assumimos que a data do pagamento e a data de competencia

if (cd_condicao_pgto_p IS NOT NULL AND cd_condicao_pgto_p::text <> '') then

	-- calcula o vencimento e devolve todos eles concatenados na ds_vencimentos_w, depois e feito alguns tratamentos para pegar a data correta

	calcular_vencimento(	cd_estabelecimento_p, cd_condicao_pgto_p, dt_competencia_p,
				qt_vencimentos_w, ds_vencimentos_w);

	-- caso a condicao de pegamento tenha mais de uma parcela, entao e descartada e permanece a data que foi definida anteriormente

	if (qt_vencimentos_w = 1) then
	
		-- tenta converter em date caso algo de errado retorna como padrao a data de referencia

		dt_pgto_tributo_w := pls_util_pck.string_to_date(substr(ds_vencimentos_w,1,10), 'dd/mm/yyyy', dt_competencia_p);
	end if;
end if;

-- tratamento para garantir que o tributo nao seja gerado ja vencido

--if	(dt_pgto_tributo_w < sysdate) then Removido conforme conversa com Helo da UB para que o tributo tenha a data exata

--	while	(dt_pgto_tributo_w < sysdate) loop

--		dt_pgto_tributo_w := add_months(dt_pgto_tributo_w, 1);

--	end loop;

--end if;


return dt_pgto_tributo_w;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pls_pp_tributacao_pck.obter_data_pgto_tributo ( cd_condicao_pgto_p tributo_conta_pagar.cd_cond_pagto%type, ie_vencimento_p tributo.ie_vencimento%type, ie_venc_pls_pag_prod_p tributo.ie_venc_pls_pag_prod%type, dt_competencia_p timestamp, dt_venc_titulo_p timestamp, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nr_seq_prestador_p pls_prestador.nr_sequencia%type, cd_tributo_p tributo.cd_tributo%type ) FROM PUBLIC;
