-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pls_pp_tributacao_pck.calcula_vl_trib_irpf ( ie_acumulativo_p tributo_conta_pagar.ie_acumulativo%type, cd_tributo_p tributo.cd_tributo%type, vl_teto_base_p tributo_conta_pagar.vl_teto_base_calculo%type, vl_minimo_base_p tributo_conta_pagar.vl_minimo%type, vl_minimo_tributo_p tributo_conta_pagar.vl_minimo_tributo%type, vl_tributo_pago_p pls_pp_valor_trib_pessoa.vl_tributo_pago%type, vl_base_acumulada_p pls_pp_valor_trib_pessoa.vl_base_acumulada%type, vl_trib_inss_p pls_pp_valor_trib_pessoa.vl_tributo%type, dt_competencia_p timestamp, qt_dependente_p pessoa_fisica.qt_dependente%type, pr_aliquota_p INOUT tributo_conta_pagar.pr_aliquota%type, vl_base_calculo_p INOUT pls_pp_valor_trib_pessoa.vl_base_calculo%type, vl_desc_dependente_p INOUT tributo_conta_pagar.vl_desc_dependente%type, vl_trib_nao_retido_p INOUT pls_pp_valor_trib_pessoa.vl_nao_retido%type, vl_trib_adic_p INOUT pls_pp_valor_trib_pessoa.vl_trib_adic%type, vl_base_nao_retido_p INOUT pls_pp_valor_trib_pessoa.vl_base_nao_retido%type, vl_base_adic_p INOUT pls_pp_valor_trib_pessoa.vl_base_adic%type, vl_base_total_out_p out pls_pp_valor_trib_pessoa.vl_base_total%type, vl_base_acum_out_p out pls_pp_valor_trib_pessoa.vl_base_acumulada%type, vl_reducao_p out regra_calculo_irpf.vl_reducao%type, nr_seq_regra_irpf_p out regra_calculo_irpf.nr_sequencia%type, cd_pessoa_fisica_p pessoa_fisica.cd_pessoa_fisica%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, dt_tributo_p timestamp) AS $body$
DECLARE


/* vl_base_acumulada_p = foi decidido que iremos passar no vl_base_anterior_p a soma dos valores retidos em outra empresa e o valor acumulado
			pois caso passamos no vl_base_retido_outro_p esta base e retornada na base utilizada para o calculo do tributo mesmo que
			nao tenha sido utilizada */


vl_minimo_tributo_w	tributo_conta_pagar.vl_minimo_tributo%type;
vl_tributo_w		pls_pp_valor_trib_pessoa.vl_tributo%type;
vl_base_calculo_w	pls_pp_valor_trib_pessoa.vl_base_calculo%type;
nr_seq_regra_irpf_w	regra_calculo_irpf.nr_sequencia%type;
vl_trib_nao_retido_w	pls_pp_valor_trib_pessoa.vl_nao_retido%type;
vl_trib_adic_w		pls_pp_valor_trib_pessoa.vl_trib_adic%type;
vl_base_nao_retido_w	pls_pp_valor_trib_pessoa.vl_base_nao_retido%type;
vl_base_adic_w		pls_pp_valor_trib_pessoa.vl_base_adic%type;
vl_base_atual_w		pls_pp_valor_trib_pessoa.vl_base_atual%type := vl_base_calculo_p;


BEGIN
-- existem tratamentos na obter_valores_tributo que so sao verificados quando o valor minimo do tributo e maior que zero

-- por este motivo foi feito este tratamento para garantir que nao seja enviado zero para a rotina e deixe de verificar 

-- alguns tratamentos que sao obrigatorios

if (coalesce(vl_minimo_tributo_p, 0) = 0) then

	vl_minimo_tributo_w := 0.01;
else
	vl_minimo_tributo_w := vl_minimo_tributo_p;
end if;

-- reduzir o valor pago de INSS neste lote de pagamento do valor base do IRPF

vl_base_calculo_w := vl_base_calculo_p - coalesce(vl_trib_inss_p, 0);

-- esse valor quando IRPF deve estar zerado pois nao faz sentido somar um valor que nao foi pago

-- no IRPF pois sempre e calculado sobre a base total

vl_trib_adic_p := 0;

obter_valores_tributo(	ie_acumulativo_p, -- vem do cadastro do tributo indicando se o mesmo e acumulativo
			pr_aliquota_p, -- in out entra a aliquota atual sai a nova (utilizado para o IRPF quando troca de aliquota por algum motivo)
			vl_minimo_base_p,
			vl_minimo_tributo_w, -- tratado para que seja no minimo 0.01 pois existe tratamento dentro da rotina
			vl_trib_nao_retido_p, -- vl_soma_trib_nao_retido_p tributos nao retido da base acumulada
			vl_trib_adic_p, -- vl_soma_trib_adic_p tributos adicionais da base acumulada
			vl_base_nao_retido_p, -- vl_soma_base_nao_retido_p base nao retida da base acumulada
			vl_base_adic_p, -- vl_soma_base_adic_p base adicional da base acumulada
			vl_base_calculo_w, -- in out entra o valor de base atual e sai o valor que foi utilizado para chegar no valor do tributo
			vl_tributo_w, -- valor do tributo calculado
			vl_trib_nao_retido_w, -- vl_trib_nao_retido_p retorna o tributo que nao foi retido por algum motivo
			vl_trib_adic_w, -- vl_trib_adic_p retorna os tributos adicionais
			vl_base_nao_retido_w, -- vl_base_nao_retido_p retorna a base que nao tenha sido retida por algum motivo
			vl_base_adic_w, -- vl_base_adic_p base adicional
			vl_teto_base_p, -- vl teto do tributo
			vl_tributo_pago_p, -- tributo pago no sistema para a competencia ate o momento
			'S', -- ie_irpf_p, como estamos calculando IRPF entao e passado fixo
			vl_base_acumulada_p, -- ver comentario no inicio desta funcao
			vl_reducao_p, -- retorna o valor de reducao utilizado no calculo
			vl_desc_dependente_p, -- vl_desc_dependente_p entra o valor de desconto por dependente cadastrado na regra, sai o valor utilizado no calculo
			qt_dependente_p, -- quantidade de dependentes, caso exista desconto por dependente entao sera aplicado o mesmo
			0, -- vl_base_pago_p nos testes feitos nao encontrei utilidade para
			0, -- vl_base_pago_adic_base_p nos testes feitos nao encontrei utilidade para
			0, -- vl_base_retido_outro_p decidido que os valores retido em outro de IRPF serao passados como base acumulado
			obter_outras_reducoes_irpf(cd_pessoa_fisica_p, cd_estabelecimento_p, dt_tributo_p),
			dt_competencia_p,
			nr_seq_regra_irpf_w, -- out sequencia da regra de IRPF
			cd_tributo_p);
			
-- alimenta os parametros out com as variaveis

vl_trib_nao_retido_p := vl_trib_nao_retido_w;
vl_trib_adic_p := vl_trib_adic_w;
vl_base_nao_retido_p := vl_base_nao_retido_w;
vl_base_adic_p := vl_base_adic_w;
nr_seq_regra_irpf_p := nr_seq_regra_irpf_w;
vl_base_calculo_p := vl_base_calculo_w;

-- estes parametros foram criados pois existe diferenca nos valores salvos para estes campos de acordo com o tipo de tributo

-- para base acumulada e sempre o valor da base anterior ja na base total e a soma do anterior mais o atual

vl_base_acum_out_p := vl_base_adic_w;
vl_base_total_out_p := vl_base_calculo_w;

-- O tributo de IR nao pode ser gerado com valor negativo, impacta direto no INSS

-- Desta forma zera o valor e joga pro proximo pagamento

if (vl_tributo_w < 0) then
	vl_tributo_w := 0;
end if;

-- Se a base de calculo for menor que zero, nao gera dados de tributo, por que vai gerar evento negativo de apropriacao

if (vl_base_atual_w < 0) then
	vl_trib_nao_retido_p	:= 0;
	vl_trib_adic_p		:= 0;
	vl_base_nao_retido_p	:= 0;
	vl_base_adic_p		:= 0;
	vl_base_calculo_p	:= 0;
	vl_base_acum_out_p	:= 0;
	vl_base_total_out_p	:= 0;
	vl_tributo_w		:= 0;
	nr_seq_regra_irpf_p	:= nr_seq_regra_irpf_w;
end if;

return;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pls_pp_tributacao_pck.calcula_vl_trib_irpf ( ie_acumulativo_p tributo_conta_pagar.ie_acumulativo%type, cd_tributo_p tributo.cd_tributo%type, vl_teto_base_p tributo_conta_pagar.vl_teto_base_calculo%type, vl_minimo_base_p tributo_conta_pagar.vl_minimo%type, vl_minimo_tributo_p tributo_conta_pagar.vl_minimo_tributo%type, vl_tributo_pago_p pls_pp_valor_trib_pessoa.vl_tributo_pago%type, vl_base_acumulada_p pls_pp_valor_trib_pessoa.vl_base_acumulada%type, vl_trib_inss_p pls_pp_valor_trib_pessoa.vl_tributo%type, dt_competencia_p timestamp, qt_dependente_p pessoa_fisica.qt_dependente%type, pr_aliquota_p INOUT tributo_conta_pagar.pr_aliquota%type, vl_base_calculo_p INOUT pls_pp_valor_trib_pessoa.vl_base_calculo%type, vl_desc_dependente_p INOUT tributo_conta_pagar.vl_desc_dependente%type, vl_trib_nao_retido_p INOUT pls_pp_valor_trib_pessoa.vl_nao_retido%type, vl_trib_adic_p INOUT pls_pp_valor_trib_pessoa.vl_trib_adic%type, vl_base_nao_retido_p INOUT pls_pp_valor_trib_pessoa.vl_base_nao_retido%type, vl_base_adic_p INOUT pls_pp_valor_trib_pessoa.vl_base_adic%type, vl_base_total_out_p out pls_pp_valor_trib_pessoa.vl_base_total%type, vl_base_acum_out_p out pls_pp_valor_trib_pessoa.vl_base_acumulada%type, vl_reducao_p out regra_calculo_irpf.vl_reducao%type, nr_seq_regra_irpf_p out regra_calculo_irpf.nr_sequencia%type, cd_pessoa_fisica_p pessoa_fisica.cd_pessoa_fisica%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, dt_tributo_p timestamp) FROM PUBLIC;
