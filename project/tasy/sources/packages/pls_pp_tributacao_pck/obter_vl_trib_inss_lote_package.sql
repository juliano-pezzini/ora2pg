-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_pp_tributacao_pck.obter_vl_trib_inss_lote ( nr_seq_lote_p pls_pp_lote.nr_sequencia%type, nr_seq_prestador_p pls_prestador.nr_sequencia%type, nr_seq_vl_trib_pessoa_ir_p pls_pp_valor_trib_pessoa.nr_sequencia%type, dt_competencia_p timestamp, vl_inss_trib_lote_p INOUT bigint) AS $body$
DECLARE


c01 CURSOR(	nr_seq_lote_pc 		pls_pp_lote.nr_sequencia%type,
		nr_seq_prestador_pc	pls_prestador.nr_sequencia%type,
		dt_competencia_pc	timestamp) FOR
	SELECT	a.nr_sequencia,
		coalesce(a.vl_tributo, 0) vl_tributo
	from	tributo b,
		pls_pp_valor_trib_pessoa a
	where	b.ie_tipo_tributo = 'INSS'
	and	a.nr_seq_lote = nr_seq_lote_pc
	and	a.nr_seq_prestador = nr_seq_prestador_pc
	--and	a.dt_competencia = dt_competencia_pc (Nao considerar data de competencia, porque pode ter datas diferentes dentro do mesmo lote de pagamento)

	and	a.cd_tributo = b.cd_tributo
	and	coalesce(a.nr_seq_vl_deduzir_ir::text, '') = '';
BEGIN

vl_inss_trib_lote_p := 0;

-- busca todos os registros de INSS que serao utilizados como deducao no calculo do IR

for r_c01_w in c01(nr_seq_lote_p, nr_seq_prestador_p, dt_competencia_p) loop
	-- armazena o valor total

	vl_inss_trib_lote_p := vl_inss_trib_lote_p + r_c01_w.vl_tributo;
	-- atualiza a referencia

	update	pls_pp_valor_trib_pessoa set
		nr_seq_vl_deduzir_ir = nr_seq_vl_trib_pessoa_ir_p
	where	nr_sequencia = r_c01_w.nr_sequencia;
end loop;

commit;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_pp_tributacao_pck.obter_vl_trib_inss_lote ( nr_seq_lote_p pls_pp_lote.nr_sequencia%type, nr_seq_prestador_p pls_prestador.nr_sequencia%type, nr_seq_vl_trib_pessoa_ir_p pls_pp_valor_trib_pessoa.nr_sequencia%type, dt_competencia_p timestamp, vl_inss_trib_lote_p INOUT bigint) FROM PUBLIC;
