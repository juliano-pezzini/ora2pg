-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_pp_tributacao_pck.alimenta_pp_trib_pessoa ( nr_cont_p INOUT integer, vl_base_atual_p INOUT pls_pp_valor_trib_pessoa.vl_base_atual%type, tb_nr_seq_base_atual_p INOUT pls_util_cta_pck.t_number_table, cd_pessoa_fisica_p pessoa_fisica.cd_pessoa_fisica%type, nr_seq_prestador_p pls_prestador.nr_sequencia%type, cd_cgc_p pessoa_juridica.cd_cgc%type, cd_tributo_p tributo.cd_tributo%type, ie_tipo_contrat_p text, nr_seq_tipo_prest_p pls_tipo_prestador.nr_sequencia%type, ie_tipo_prest_p text, dt_comp_base_p timestamp, ie_tipo_tributo_p tributo.ie_tipo_tributo%type, nr_seq_lote_p pls_pp_lote.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, dt_mes_lote_pgto_orig_p pls_pp_lote.dt_mes_competencia%type) AS $body$
DECLARE

					
nr_seq_trib_pessoa_w	pls_pp_valor_trib_pessoa.nr_sequencia%type;


BEGIN
if (tb_nr_seq_base_atual_p.count > 0) then

	-- insere o registro com o somatorio no tributo pessoa

	insert into pls_pp_valor_trib_pessoa(
		nr_sequencia, dt_atualizacao, dt_atualizacao_nrec,
		nm_usuario, nm_usuario_nrec, pr_aliquota,
		vl_base_acumulada, vl_base_calculo, vl_base_total,
		vl_reducao, vl_tributo, vl_tributo_pago,
		cd_pessoa_fisica, cd_cgc, cd_tributo,
		vl_base_atual, ie_tipo_contratacao, dt_competencia,
		nr_seq_lote, ie_tipo_prestador, ie_tipo_tributo,
		nr_seq_tipo_prestador, vl_base_adic, vl_base_nao_retido,
		vl_nao_retido, vl_trib_adic, qt_dependente,
		vl_desc_dependente, nr_seq_prestador, ie_cancelado,
		dt_mes_lote_pgto_orig
	) values (
		nextval('pls_pp_valor_trib_pessoa_seq'), clock_timestamp(), clock_timestamp(),
		nm_usuario_p, nm_usuario_p, 0,
		0, 0, vl_base_atual_p,
		0, 0, 0,
		cd_pessoa_fisica_p, cd_cgc_p, cd_tributo_p,
		vl_base_atual_p, ie_tipo_contrat_p, dt_comp_base_p,
		nr_seq_lote_p, ie_tipo_prest_p, ie_tipo_tributo_p,
		nr_seq_tipo_prest_p, 0, 0,
		0, 0, 0,
		0, nr_seq_prestador_p, 'N',
		dt_mes_lote_pgto_orig_p
	) returning nr_sequencia into nr_seq_trib_pessoa_w;
	commit;

	-- faz o devido vinculo do tributo da pessoa (agrupador) com os seus agrupados

	forall i in tb_nr_seq_base_atual_p.first..tb_nr_seq_base_atual_p.last
		update	pls_pp_base_atual_trib set
			nr_seq_trib_pessoa = nr_seq_trib_pessoa_w
		where	nr_sequencia = tb_nr_seq_base_atual_p(i);
	commit;
end if;

-- reinicializa as variaveis

nr_cont_p := 0;
vl_base_atual_p := 0;
tb_nr_seq_base_atual_p.delete;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_pp_tributacao_pck.alimenta_pp_trib_pessoa ( nr_cont_p INOUT integer, vl_base_atual_p INOUT pls_pp_valor_trib_pessoa.vl_base_atual%type, tb_nr_seq_base_atual_p INOUT pls_util_cta_pck.t_number_table, cd_pessoa_fisica_p pessoa_fisica.cd_pessoa_fisica%type, nr_seq_prestador_p pls_prestador.nr_sequencia%type, cd_cgc_p pessoa_juridica.cd_cgc%type, cd_tributo_p tributo.cd_tributo%type, ie_tipo_contrat_p text, nr_seq_tipo_prest_p pls_tipo_prestador.nr_sequencia%type, ie_tipo_prest_p text, dt_comp_base_p timestamp, ie_tipo_tributo_p tributo.ie_tipo_tributo%type, nr_seq_lote_p pls_pp_lote.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, dt_mes_lote_pgto_orig_p pls_pp_lote.dt_mes_competencia%type) FROM PUBLIC;
