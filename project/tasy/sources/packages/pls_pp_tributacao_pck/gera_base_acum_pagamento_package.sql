-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


-- pega tudo o que estiver no lote como base atual e jogar para base acumulada



CREATE OR REPLACE PROCEDURE pls_pp_tributacao_pck.gera_base_acum_pagamento ( nr_seq_lote_p pls_pp_lote.nr_sequencia%type, nr_seq_prestador_p pls_prestador.nr_sequencia%type, cd_tributo_p tributo.cd_tributo%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE


tb_nr_seq_item_atual_w		pls_util_cta_pck.t_number_table;
tb_nr_seq_evento_w		pls_util_cta_pck.t_number_table;
tb_dt_comp_base_w		pls_util_cta_pck.t_date_table;
tb_cd_pf_w			pls_util_cta_pck.t_varchar2_table_50;
tb_vl_item_w			pls_util_cta_pck.t_number_table;
tb_vl_tributo_w			pls_util_cta_pck.t_number_table;
tb_vl_base_w			pls_util_cta_pck.t_number_table;
tb_ie_tipo_contrat_w		pls_util_cta_pck.t_varchar2_table_5;
tb_vl_nao_retido_w		pls_util_cta_pck.t_number_table;
tb_vl_base_nao_ret_w		pls_util_cta_pck.t_number_table;
tb_vl_trib_adic_w		pls_util_cta_pck.t_number_table;
tb_vl_base_adic_w		pls_util_cta_pck.t_number_table;
tb_nr_seq_tipo_prest_w		pls_util_cta_pck.t_number_table;
tb_ie_tipo_tributo_w		pls_util_cta_pck.t_varchar2_table_20;
tb_nr_seq_prestador_w		pls_util_cta_pck.t_number_table;
tb_dt_lote_pagto_orig_w		pls_util_cta_pck.t_date_table;
tb_dt_mes_lote_pgto_orig_w	pls_util_cta_pck.t_date_table;

c01 CURSOR(	cd_tributo_pc		tributo.cd_tributo%type,
		nr_seq_prestador_pc	pls_prestador.nr_sequencia%type,
		nr_seq_lote_pc		pls_pp_lote.nr_sequencia%type) FOR
	SELECT	a.nr_sequencia,
		a.nr_seq_evento,
		a.dt_comp_base_calc,
		b.cd_pessoa_fisica,
		a.vl_item,
		a.vl_tributo,
		a.vl_base,
		a.ie_tipo_contratacao,
		coalesce(a.vl_nao_retido, 0) vl_nao_retido,
		coalesce(a.vl_base_nao_retido, 0) vl_base_nao_retido,
		coalesce(a.vl_trib_adic, 0) vl_trib_adic,
		coalesce(a.vl_base_adic, 0) vl_base_adic,
		b.nr_seq_tipo_prestador,
		c.ie_tipo_tributo,
		b.nr_seq_prestador,
		(SELECT	trunc(max(l.dt_mes_competencia),'month')
		from	pls_pp_lote l
		where	l.nr_sequencia	= a.nr_seq_lote) dt_mes_lote_pgto_orig
	from	pls_pp_base_atual_trib a,
		pls_pp_prestador_tmp b,
		tributo c
	where	a.nr_seq_lote = nr_seq_lote_pc
	and	a.nr_seq_prestador = nr_seq_prestador_pc
	and	a.cd_tributo = cd_tributo_pc
	and	b.nr_seq_prestador = a.nr_seq_prestador
	and	b.ie_tipo_prestador = 'PF'
	and	c.cd_tributo = a.cd_tributo
	and	not exists (	select	1
				from	pls_pp_base_acum_trib x
				where	x.nr_seq_item_base_atual = a.nr_sequencia);


BEGIN

open c01( cd_tributo_p, nr_seq_prestador_p, nr_seq_lote_p);
loop
	fetch c01 bulk collect into	tb_nr_seq_item_atual_w, tb_nr_seq_evento_w, tb_dt_comp_base_w,
					tb_cd_pf_w, tb_vl_item_w, tb_vl_tributo_w, 
					tb_vl_base_w, tb_ie_tipo_contrat_w, tb_vl_nao_retido_w,
					tb_vl_base_nao_ret_w, tb_vl_trib_adic_w, tb_vl_base_adic_w,
					tb_nr_seq_tipo_prest_w, tb_ie_tipo_tributo_w, tb_nr_seq_prestador_w,
					tb_dt_mes_lote_pgto_orig_w
	limit pls_util_pck.qt_registro_transacao_w;
	exit when tb_nr_seq_item_atual_w.count = 0;
	
	forall i in tb_nr_seq_item_atual_w.first..tb_nr_seq_item_atual_w.last
		insert into pls_pp_base_acum_trib(
			nr_sequencia, dt_atualizacao_nrec, dt_atualizacao,
			nm_usuario_nrec, nm_usuario, nr_seq_item_base_atual,
			nr_seq_evento, ie_origem, cd_pessoa_fisica,
			vl_base, vl_item, vl_tributo,
			dt_competencia, ie_tipo_contratacao, cd_tributo,
			vl_nao_retido, vl_base_nao_retido, vl_trib_adic,
			vl_base_adic, nr_seq_tipo_prestador, ie_tipo_tributo,
			nr_seq_prestador, nr_seq_lote_pgto_orig, dt_mes_lote_pgto_orig
		) values (
			nextval('pls_pp_base_acum_trib_seq'), clock_timestamp(), clock_timestamp(),
			nm_usuario_p, nm_usuario_p, tb_nr_seq_item_atual_w(i),
			tb_nr_seq_evento_w(i), 'NP', tb_cd_pf_w(i),
			tb_vl_base_w(i), tb_vl_item_w(i), tb_vl_tributo_w(i),
			tb_dt_comp_base_w(i), tb_ie_tipo_contrat_w(i), cd_tributo_p,
			tb_vl_nao_retido_w(i), tb_vl_base_nao_ret_w(i), tb_vl_trib_adic_w(i),
			tb_vl_base_adic_w(i), tb_nr_seq_tipo_prest_w(i), tb_ie_tipo_tributo_w(i),
			tb_nr_seq_prestador_w(i), nr_seq_lote_p, tb_dt_mes_lote_pgto_orig_w(i)
		);
	commit;
end loop;
close c01;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_pp_tributacao_pck.gera_base_acum_pagamento ( nr_seq_lote_p pls_pp_lote.nr_sequencia%type, nr_seq_prestador_p pls_prestador.nr_sequencia%type, cd_tributo_p tributo.cd_tributo%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;
