-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_pp_tributacao_pck.gerar_valores_tributos ( nr_seq_lote_p pls_pp_lote.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE


c01 CURSOR(	nr_seq_lote_pc	pls_pp_lote.nr_sequencia%type) FOR
	SELECT	a.cd_tributo,
		a.ie_tipo_tributo,
		a.ie_vencimento,
		a.ie_pf_pj
	from   	pls_tributo_v a
	where	a.ie_situacao = 'A'
	and exists (	SELECT	1
			from	pls_pp_valor_trib_pessoa x
			where	x.nr_seq_lote = nr_seq_lote_pc
			and	x.cd_tributo = a.cd_tributo)
	order by nr_ordem;

BEGIN
-- alimenta a tabela pls_pp_valor_trib_pessoa com os valores de base

-- retorna todos os registros de base atual agrupados por pessoa, prestador, tributo, tipo de contratacao, tipo de prestador e competencia

-- para inserir na pls_pp_valor_trib_pessoa que sera a tabela utilizada para realizar o calculo dos tributos, depois este valor

-- de tributo sera 'rateado' entre os registros que os geraram

CALL pls_pp_tributacao_pck.gera_valor_trib_pessoa(	nr_seq_lote_p, nm_usuario_p);

-- abre um cursor com todos os tributos que podem ser gerados

for r_c01_w in c01(nr_seq_lote_p) loop

	-- se for imposto de PF ou ambos entao processa a parte de PF aqui

	if (r_c01_w.ie_pf_pj in ('PF', 'A')) then
	
		-- esta rotina e responsavel por encontrar as regras do tributo e realizar o calculo

		CALL pls_pp_tributacao_pck.gerencia_tributos_pf(	r_c01_w.cd_tributo, r_c01_w.ie_tipo_tributo,
					nr_seq_lote_p, cd_estabelecimento_p,
					nm_usuario_p);
	end if;

	-- se for imposto de PJ ou ambos entao processa a parte de PJ aqui

	if (r_c01_w.ie_pf_pj in ('PJ', 'A')) then

		CALL pls_pp_tributacao_pck.gerencia_tributos_pj(	r_c01_w.cd_tributo, nr_seq_lote_p,
					cd_estabelecimento_p, nm_usuario_p);
	end if;
end loop;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_pp_tributacao_pck.gerar_valores_tributos ( nr_seq_lote_p pls_pp_lote.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;
