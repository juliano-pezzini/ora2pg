-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

 
	/* 
	* Rotina de aprovação de exames integrados 
	*/
 


CREATE OR REPLACE PROCEDURE shift_integracao_pck.aprovar_exames (nr_prescricao_p bigint, nr_seq_prescr_p bigint, ds_erro_p INOUT text) AS $body$
DECLARE

 
	nr_seq_resultado_w exame_lab_resultado.nr_seq_resultado%type;
	
BEGIN
 
	if (nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '') and (nr_seq_prescr_p IS NOT NULL AND nr_seq_prescr_p::text <> '') then 
 
		update	prescr_procedimento 
		set		ie_status_atend = 35 
		where	nr_prescricao = nr_prescricao_p 
		and		nr_sequencia = nr_seq_prescr_p 
		and		ie_status_atend < 35;
 
		begin 
 
			select	nr_seq_resultado 
			into STRICT	nr_seq_resultado_w 
			from	exame_lab_resultado 
			where	nr_prescricao = nr_prescricao_p;
 
		exception 
			when no_data_found then 
			ds_erro_p := wheb_mensagem_pck.get_texto(318856,'NR_PRESCRICAO='||nr_prescricao_p);
			return;
 
			when others then 
			ds_erro_p := substr(wheb_mensagem_pck.get_texto(317525)||' - '||SQLERRM,1,255);
			return;
		end;
 
		if (nr_seq_resultado_w > 0) then 
 
			update	exame_lab_result_item 
			set		dt_aprovacao =	clock_timestamp() 
			where	nr_seq_resultado = nr_seq_resultado_w 
			and		nr_seq_prescr = nr_seq_prescr_p 
			and		(nr_seq_material IS NOT NULL AND nr_seq_material::text <> '');
 
		end if;
	end if;
 
	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE shift_integracao_pck.aprovar_exames (nr_prescricao_p bigint, nr_seq_prescr_p bigint, ds_erro_p INOUT text) FROM PUBLIC;
