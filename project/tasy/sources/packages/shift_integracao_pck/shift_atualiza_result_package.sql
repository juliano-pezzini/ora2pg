-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

 
	/* 
	* Atualizar resultados dos exames integrados 
	*/
 


CREATE OR REPLACE PROCEDURE shift_integracao_pck.shift_atualiza_result (nr_prescricao_p bigint, cd_exame_p text, cd_exame_analito_p text, ds_unidade_medida_p text, ds_valor_p text, ds_referencia_p text, ds_erro_p INOUT text) AS $body$
DECLARE

 
	nr_seq_exame_w			exame_laboratorio.nr_seq_exame%type;
	nr_sequencia_w			prescr_procedimento.nr_sequencia%type;
	cd_material_exame_w		prescr_procedimento.cd_material_exame%type;
	nr_seq_mat_exame_w		material_exame_lab.nr_sequencia%type;
	nr_seq_result_w			exame_lab_resultado.nr_seq_resultado%type;
	cd_analito_w			exame_laboratorio.cd_exame%type;
	ie_exige_formato_w 		varchar(1);
	cd_estab_w 				integer;
	qt_idade_w				bigint;
	ds_sexo_w				varchar(10);
	ie_formato_resultado_w	varchar(255);
	qt_resultado_w			double precision;
	pr_resultado_w			double precision;
	ds_resultado_w			exame_lab_result_item.ds_resultado%type;
	dt_coleta_w				timestamp;
	dt_resultado_w			timestamp;
	qt_registro_ant_w		smallint;

	
BEGIN 
		 
	begin 
 
		select	substr(obter_dados_pf(cd_pessoa_fisica , 'I') , 1 , 10), 
				substr(obter_dados_pf(cd_pessoa_fisica , 'SE') , 1 , 10) 
		into STRICT	qt_idade_w, 
				ds_sexo_w 
		from	prescr_medica 
		where	nr_prescricao = nr_prescricao_p;
 
	exception 
		when no_data_found then 
		ds_erro_p := wheb_mensagem_pck.get_texto(186035);
		return;
 
		when others then 
		ds_erro_p := substr(wheb_mensagem_pck.get_texto(317525)||' - '||SQLERRM,1,255);
		return;
 
	end;
 
	begin 
 
		select 	nr_seq_exame 
		into STRICT	nr_seq_exame_w 
		from	lab_exame_equip a, 
				equipamento_lab b 
		where	a.cd_exame_equip = cd_exame_p 
		and		a.cd_equipamento = b.cd_equipamento 
		and		b.ds_sigla = 'SHIFTWS' 
		and		a.nr_seq_exame in (SELECT nr_seq_exame from prescr_procedimento where nr_prescricao = nr_prescricao_p);
 
	exception 
		when no_data_found then 
		ds_erro_p := wheb_mensagem_pck.get_texto(318850);
		return;
 
		when others then 
		ds_erro_p := substr(wheb_mensagem_pck.get_texto(317525)||' - '||SQLERRM,1,255);
		return;
	end;
 
	begin 
 
		select	nr_sequencia , 
				cd_material_exame, 
				dt_coleta, 
				dt_resultado 
		into STRICT	nr_sequencia_w , 
				cd_material_exame_w, 
				dt_coleta_w, 
				dt_resultado_w 
		from	prescr_procedimento 
		where	nr_prescricao = nr_prescricao_p 
		and		nr_seq_exame = nr_seq_exame_w;
 
	exception 
		when no_data_found then 
		ds_erro_p := wheb_mensagem_pck.get_texto(318852,'NR_SEQ_EXAME='||nr_seq_exame_w||';NR_PRESCRICAO='||nr_prescricao_p);
		return;
 
		when too_many_rows then 
		ds_erro_p := wheb_mensagem_pck.get_texto(318854,'NR_SEQ_EXAME='||nr_seq_exame_w||';NR_PRESCRICAO='||nr_prescricao_p);
		return;
 
		when others then 
		ds_erro_p := substr(wheb_mensagem_pck.get_texto(317525)||' - '||SQLERRM,1,255);
		return;
	end;
	 
	begin 
		select	nr_sequencia 
		into STRICT	nr_seq_mat_exame_w 
		from	material_exame_lab 
		where	cd_material_exame = cd_material_exame_w;
 
	exception 
		when no_data_found then 
		ds_erro_p := wheb_mensagem_pck.get_texto(318855,'CD_MATERIAL_INTEGRACAO='||cd_material_exame_w);
		return;
 
		when others then 
		ds_erro_p := substr(wheb_mensagem_pck.get_texto(317525)||' - '||SQLERRM,1,255);
		return;
	end;
	 
	select	cd_estabelecimento 
	into STRICT 	cd_estab_w 
	from	prescr_medica 
	where 	nr_prescricao = nr_prescricao_p;
	 
	select 	ie_exige_formato 
	into STRICT	ie_exige_formato_w 
	from 	lab_parametro 
	where 	cd_estabelecimento = cd_estab_w;
	 
	if (ie_exige_formato_w = 'S') then 
		CALL gera_exame_result_lab(nr_prescricao_p, nr_sequencia_w, 'N', 'N', 'N', 'TASYLAB');
 
		begin 
			select	nr_seq_resultado 
			into STRICT	nr_seq_result_w 
			from	exame_lab_resultado 
			where	nr_prescricao = nr_prescricao_p;
 
		exception 
			when no_data_found then 
			ds_erro_p := wheb_mensagem_pck.get_texto(318856,'NR_PRESCRICAO='||nr_prescricao_p);
			return;
 
			when others then 
			ds_erro_p := substr(wheb_mensagem_pck.get_texto(317525)||' - '||SQLERRM,1,255);
			return;
		end;
 
		CALL gera_resultado_lab(	nr_seq_result_w , 
							nr_prescricao_p , 
							nr_sequencia_w , 
							nr_seq_exame_w , 
							nr_seq_mat_exame_w , 
							qt_idade_w , 
							ds_sexo_w , 
							'TASYLAB' , 
							null);
	end if;
 
	 
	--analito 
	 
	select	max(coalesce(e.cd_exame_integracao, e.cd_exame)), 
			max(substr(ie_formato_resultado , 1 , 1)) 
	into STRICT	cd_analito_w, 
			ie_formato_resultado_w 
	from	exame_laboratorio e 
	where	e.nr_seq_exame = (SELECT 	nr_seq_exame 
							 from 		equipamento_lab b, 
										lab_exame_equip a 
							 WHERE		a.cd_equipamento = b.cd_equipamento 
							 AND		a.cd_exame_equip = cd_exame_analito_p 
							 AND		upper(b.ds_sigla) = 'SHIFTWS' 
							 AND		a.nr_seq_exame = nr_seq_exame_w);WITH RECURSIVE cte AS (

				  
				  
	if (coalesce(cd_analito_w::text, '') = '') then 
		begin 
			select	max(coalesce(e.cd_exame_integracao, e.cd_exame)),max(substr(ie_formato_resultado , 1 , 1)) 
			into STRICT	cd_analito_w,ie_formato_resultado_w 
			from	exame_laboratorio e WHERE nr_seq_superior = nr_seq_exame_w
  UNION ALL
 
				  
				  
	if (coalesce(cd_analito_w::text, '') = '') then 
		begin 
			select	max(coalesce(e.cd_exame_integracao, e.cd_exame)),max(substr(ie_formato_resultado , 1 , 1)) 
			into STRICT	cd_analito_w,ie_formato_resultado_w 
			from	exame_laboratorio e JOIN cte c ON (c.prior nr_seq_exame = e.nr_seq_superior)

) SELECT * FROM cte WHERE nr_seq_exame = (	SELECT 	nr_seq_exame 
										from 	equipamento_lab b, 
												lab_exame_equip a 
										WHERE	a.cd_equipamento = b.cd_equipamento 
										AND		a.cd_exame_equip = cd_exame_analito_p 
										AND		upper(b.ds_sigla) = 'SHIFTWS' 
										AND		a.nr_seq_exame = e.nr_seq_exame);
;
		exception 
			when no_data_found then 
			ds_erro_p := wheb_mensagem_pck.get_texto(318858,'NR_SEQ_EXAME='||nr_seq_exame_w);
			return;
 
			when others then 
			ds_erro_p := substr(wheb_mensagem_pck.get_texto(317525)||' - '||SQLERRM,1,255);
			return;
		end;
	end if;
	 
	begin 
 
		if (ie_formato_resultado_w = 'P')	then 
			qt_resultado_w := null;
			pr_resultado_w := (replace(ds_valor_p , '.' , ','))::numeric;
			ds_resultado_w := null;
		elsif (ie_formato_resultado_w = 'V')	then 
			qt_resultado_w := (replace(ds_valor_p , '.' , ','))::numeric;
			pr_resultado_w := null;
			ds_resultado_w := null;
		else 
			qt_resultado_w := null;
			pr_resultado_w := null;
			ds_resultado_w := ds_valor_p;
		end if;
 
	exception 
 
		when others then 
		ds_erro_p := wheb_mensagem_pck.get_texto(318025);
		return;
 
	end;
 
	select	count(1) 
	into STRICT	qt_registro_ant_w 
	from	exame_lab_result_item a, 
			exame_lab_resultado b 
	where	b.nr_seq_resultado = a.nr_seq_resultado 
	and 	a.nr_seq_prescr	= nr_sequencia_w 
	and		b.nr_prescricao = nr_prescricao_p;
 
	if (qt_registro_ant_w > 0) then 
		CALL desfazer_lab_aprovacao(nr_prescricao_p, nr_sequencia_w, 'TASYLAB', 'S', 'N');
	end if;
 
	if (cd_analito_w IS NOT NULL AND cd_analito_w::text <> '') then 
		 
		atualizar_lab_result_item(nr_prescricao_p, 
									nr_sequencia_w, 
									cd_analito_w, 
									qt_resultado_w, 
									pr_resultado_w, 
									ds_resultado_w, 
									null, 
									cd_material_exame_w, 
									'S', 
									'TASYLAB', 
									dt_coleta_w, 
									ds_referencia_p, 
									substr(ds_unidade_medida_p, 1, 40), 
									null, 
									dt_resultado_w, 
									ds_erro_p);
 
 
	else 
		atualizar_lab_result_item(nr_prescricao_p, 
									nr_sequencia_w, 
									cd_exame_analito_p, 
									qt_resultado_w, 
									pr_resultado_w, 
									ds_resultado_w, 
									null, 
									cd_material_exame_w, 
									'S', 
									'TASYLAB', 
									dt_coleta_w, 
									ds_referencia_p, 
									substr(ds_unidade_medida_p, 1, 40), 
									null, 
									dt_resultado_w, 
									ds_erro_p);
	end if;
 
	ds_erro_p := shift_integracao_pck.aprovar_exames(nr_prescricao_p, nr_sequencia_w, ds_erro_p);
 
	commit;
 
	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE shift_integracao_pck.shift_atualiza_result (nr_prescricao_p bigint, cd_exame_p text, cd_exame_analito_p text, ds_unidade_medida_p text, ds_valor_p text, ds_referencia_p text, ds_erro_p INOUT text) FROM PUBLIC;
