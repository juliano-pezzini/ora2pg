-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

 
	/* 
	* Atualização dos datas na prescr_procedimento 
	*/
 


CREATE OR REPLACE PROCEDURE shift_integracao_pck.shift_atualiza_prescr (dt_solic_p text, hr_solic_p text, dt_coleta_p text, hr_coleta_p text, dt_resultado_p text, hr_resultado_p text, nr_prescricao_p bigint, cd_exame_p text, has_pdf_p text, ds_erro_p INOUT text, nr_seq_result_pdf_p INOUT bigint) AS $body$
DECLARE

 
	dt_solic_w 		timestamp;
	dt_coleta_w		timestamp;
	dt_resultado_w	timestamp;

	nr_seq_exame_w			exame_laboratorio.nr_seq_exame%type;
	nr_sequencia_w			prescr_procedimento.nr_sequencia%type;
	cd_material_exame_w		prescr_procedimento.cd_material_exame%type;
	nr_seq_mat_exame_w		material_exame_lab.nr_sequencia%type;
	nr_seq_result_w			exame_lab_resultado.nr_seq_resultado%type;
	ie_exige_formato_w 		varchar(1);
	cd_estab_w 				integer;
	qt_idade_w				bigint;
	ds_sexo_w				varchar(10);
	nr_seq_result_pdf_w		bigint;

	
BEGIN 
	 
	begin 
 
		select	substr(obter_dados_pf(cd_pessoa_fisica , 'I') , 1 , 10) , 
				substr(obter_dados_pf(cd_pessoa_fisica , 'SE') , 1 , 10) 
		into STRICT	qt_idade_w , 
				ds_sexo_w 
		from	prescr_medica 
		where	nr_prescricao = nr_prescricao_p;
 
	exception 
		when no_data_found then 
		ds_erro_p := wheb_mensagem_pck.get_texto(186035);
		return;
 
		when others then 
		ds_erro_p := substr(wheb_mensagem_pck.get_texto(317525)||' - '||SQLERRM,1,255);
		return;
	end;
 
	begin 
 
		select 	nr_seq_exame 
		into STRICT	nr_seq_exame_w 
		from	lab_exame_equip a, 
				equipamento_lab b 
		where	a.cd_exame_equip = cd_exame_p 
		and		a.cd_equipamento = b.cd_equipamento 
		and		b.ds_sigla = 'SHIFTWS' 
		and		a.nr_seq_exame in (SELECT nr_seq_exame from prescr_procedimento where nr_prescricao = nr_prescricao_p);
 
	exception 
		when no_data_found then 
		ds_erro_p := wheb_mensagem_pck.get_texto(318850);
		return;
 
		when others then 
		ds_erro_p := substr(wheb_mensagem_pck.get_texto(317525)||' - '||SQLERRM,1,255);
		return;
	end;
	 
	begin 
 
		select	nr_sequencia , 
				cd_material_exame 
		into STRICT	nr_sequencia_w , 
				cd_material_exame_w 
		from	prescr_procedimento 
		where	nr_prescricao = nr_prescricao_p 
		and		nr_seq_exame = nr_seq_exame_w;
 
	exception 
		when no_data_found then 
		ds_erro_p := wheb_mensagem_pck.get_texto(318852,'NR_SEQ_EXAME='||nr_seq_exame_w||';NR_PRESCRICAO='||nr_prescricao_p);
		return;
 
		when too_many_rows then 
		ds_erro_p := wheb_mensagem_pck.get_texto(318854,'NR_SEQ_EXAME='||nr_seq_exame_w||';NR_PRESCRICAO='||nr_prescricao_p);
		return;
 
		when others then 
		ds_erro_p := substr(wheb_mensagem_pck.get_texto(317525)||' - '||SQLERRM,1,255);
		return;
	end;
	 
	begin 
		dt_solic_w := to_date(dt_solic_p||' '||hr_solic_p||':00' , 'yyyy-mm-dd hh24:mi:ss');
		dt_coleta_w := to_date(dt_coleta_p||' '||hr_coleta_p||':00' , 'yyyy-mm-dd hh24:mi:ss');
		dt_resultado_w := to_date(dt_resultado_p||' '||hr_resultado_p||':00' , 'yyyy-mm-dd hh24:mi:ss');
	exception 
		when others then 
		ds_erro_p := substr(wheb_mensagem_pck.get_texto(318027)||' - '||SQLERRM,1,255);
		return;
	end;
 
	update	prescr_procedimento 
	set		dt_ciencia_laboratorio = dt_solic_w , 
			dt_coleta = dt_coleta_w , 
			dt_resultado = dt_resultado_w 
	where	nr_prescricao = nr_prescricao_p 
	and		nr_sequencia = 	nr_sequencia_w;
 
	begin 
 
		select	nr_sequencia 
		into STRICT	nr_seq_mat_exame_w 
		from	material_exame_lab 
		where	cd_material_exame = cd_material_exame_w;
 
	exception 
		when no_data_found then 
		ds_erro_p := wheb_mensagem_pck.get_texto(318855,'CD_MATERIAL_INTEGRACAO='||cd_material_exame_w);
		return;
 
		when others then 
		ds_erro_p := substr(wheb_mensagem_pck.get_texto(317525)||' - '||SQLERRM,1,255);
		return;
	end;
 
	select	cd_estabelecimento 
	into STRICT 	cd_estab_w 
	from	prescr_medica 
	where 	nr_prescricao = nr_prescricao_p;
	 
	select 	ie_exige_formato 
	into STRICT	ie_exige_formato_w 
	from 	lab_parametro 
	where 	cd_estabelecimento = cd_estab_w;
	 
	if (ie_exige_formato_w = 'S') then 
		CALL gera_exame_result_lab(nr_prescricao_p, nr_sequencia_w, 'N', 'N', 'N', 'TASYLAB');
 
		begin 
			select	nr_seq_resultado 
			into STRICT	nr_seq_result_w 
			from	exame_lab_resultado 
			where	nr_prescricao = nr_prescricao_p;
		exception 
			when no_data_found then 
			ds_erro_p := wheb_mensagem_pck.get_texto(318856,'NR_PRESCRICAO='||nr_prescricao_p);
			return;
 
			when others then 
			ds_erro_p := substr(wheb_mensagem_pck.get_texto(317525)||' - '||SQLERRM,1,255);
			return;
		end;
 
		CALL gera_resultado_lab(	nr_seq_result_w, 
							nr_prescricao_p, 
							nr_sequencia_w, 
							nr_seq_exame_w, 
							nr_seq_mat_exame_w, 
							qt_idade_w, 
							ds_sexo_w, 
							'TASYLAB', 
							null);
	end if;
	if (has_pdf_p = 'S') then 
	 
		lab_insere_result_lab_pdf(	nr_prescricao_p, 
									nr_sequencia_w, 
									' ', 
									'TASYLAB', 
									ds_erro_p, 
									nr_seq_result_pdf_w);
									 
		nr_seq_result_pdf_p := nr_seq_result_pdf_w;
	end if;
 
	commit;
 
	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE shift_integracao_pck.shift_atualiza_prescr (dt_solic_p text, hr_solic_p text, dt_coleta_p text, hr_coleta_p text, dt_resultado_p text, hr_resultado_p text, nr_prescricao_p bigint, cd_exame_p text, has_pdf_p text, ds_erro_p INOUT text, nr_seq_result_pdf_p INOUT bigint) FROM PUBLIC;
