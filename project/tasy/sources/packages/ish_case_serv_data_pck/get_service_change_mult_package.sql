-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


/*-------------------
caseservicechangemult - request
*/
CREATE OR REPLACE FUNCTION ish_case_serv_data_pck.get_service_change_mult (nr_seq_fila_p bigint) RETURNS SETOF T_SERVICE_CHANGE_MULT AS $body$
DECLARE


nr_sequencia_w			procedimento_paciente.nr_sequencia%type;
cd_empresa_w			estabelecimento.cd_empresa%type;
current_setting('ish_case_serv_data_pck.cd_estabelecimento_w')::estabelecimento.cd_estabelecimento%type		estabelecimento.cd_estabelecimento%type;
procedimento_paciente_w		procedimento_paciente%rowtype;
ds_versao_catalogo_w		varchar(2);
nr_seq_episodio_w		atendimento_paciente.nr_seq_episodio%type;
nr_episodio_w			episodio_paciente.nr_episodio%type;
movemntseqno_w			varchar(100);
serviceseqno_w			varchar(100);
cd_setor_externo_w		setor_atendimento.cd_setor_externo%type;
dt_geral_w			varchar(255);
ds_observacao_w		varchar(4000);

r_service_change_mult_w		r_service_change_mult;
reg_integracao_w		gerar_int_padrao.reg_integracao_conv;


BEGIN

--o agrupador considerado para amazenar o numero do atendimento do procedimento
--entao precisamos buscar todos os itens deste mesmo agrupador que estao na fila de integracao
select	max(nr_seq_documento)
into STRICT	nr_sequencia_w
from	intpd_fila_transmissao
where	nr_sequencia	= nr_seq_fila_p;

intpd_reg_integracao_inicio(nr_seq_fila_p, 'E', reg_integracao_w);
reg_integracao_w.ie_somente_alterados		:= 'S';

begin
select	*
into STRICT	procedimento_paciente_w
from	procedimento_paciente
where	nr_sequencia	= nr_sequencia_w;
exception
when others then
	procedimento_paciente_w	:=	null;
end;

if (procedimento_paciente_w.nr_sequencia IS NOT NULL AND procedimento_paciente_w.nr_sequencia::text <> '') then
	select	max(a.cd_empresa),
		max(a.cd_estabelecimento),
		max(b.nr_seq_episodio)
	into STRICT	cd_empresa_w,
		current_setting('ish_case_serv_data_pck.cd_estabelecimento_w')::estabelecimento.cd_estabelecimento%type,
		nr_seq_episodio_w
	from	estabelecimento a,
		atendimento_paciente b
	where	a.cd_estabelecimento	= b.cd_estabelecimento
	and	b.nr_atendimento	= procedimento_paciente_w.nr_atendimento;

	select	max(nr_episodio)
	into STRICT	nr_episodio_w
	from	episodio_paciente
	where	nr_sequencia		= nr_seq_episodio_w;
	
	reg_integracao_w.nm_tabela 	:= 'ESTABELECIMENTO';
	reg_integracao_w.nm_elemento	:= 'urn:CaseserviceChangemult';
	intpd_processar_atrib_envio(reg_integracao_w, 'CD_EMPRESA', 'client', 'N', cd_empresa_w, 'S', r_service_change_mult_w.client);
	intpd_processar_atrib_envio(reg_integracao_w, 'CD_ESTABELECIMENTO', 'institution', 'N', current_setting('ish_case_serv_data_pck.cd_estabelecimento_w')::estabelecimento.cd_estabelecimento%type, 'S', r_service_change_mult_w.institution);
	reg_integracao_w.nm_tabela 	:= 'EPISODIO_PACIENTE';
	intpd_processar_atrib_envio(reg_integracao_w, 'NR_EPISODIO', 'patcaseid', 'N', nr_episodio_w, 'N', r_service_change_mult_w.patcaseid);
	
	reg_integracao_w.nm_tabela 	:= 'PROCEDIMENTO_PACIENTE';
	reg_integracao_w.nm_elemento	:= 'CaseserviceCdata';		
	intpd_processar_atrib_envio(reg_integracao_w, 'NR_SEQUENCIA', 'serviceseqno', 'N', procedimento_paciente_w.nr_sequencia, 'S', serviceseqno_w);
	r_service_change_mult_w.serviceseqno	:= obter_valor_campo_separador(serviceseqno_w,2,current_setting('ish_case_serv_data_pck.ds_separador_w')::varchar(10));
	
	r_service_change_mult_w.action		:=	'U';
	r_service_change_mult_w.ruletype	:=	coalesce(intpd_conv('CaseserviceCdata', 'RULETYPE', 'RULETYPE', reg_integracao_w.nr_seq_regra_conversao, reg_integracao_w.ie_conversao, 'E'), 'NLEI');
	
	--r_service_change_mult_w.ASSIGNTYPE	:=	'G01';
	--r_service_change_mult_w.ASSIGNTYPEx	:=	'X';		
	
	/*
	select	nvl(max(cd_procedimento_loc),procedimento_paciente_w.cd_procedimento)
	into	r_service_change_mult_w.serviceid
	from	procedimento
	where	cd_procedimento		= procedimento_paciente_w.cd_procedimento
	and	ie_origem_proced	= procedimento_paciente_w.ie_origem_proced;
	*/
	
	--r_service_change_mult_w.srvshorttext	:= substr(procedimento_paciente_w.ds_observacao,1,120);		
	
	intpd_processar_atrib_envio(reg_integracao_w, 'CD_SETOR_ATENDIMENTO','performou', 'N', procedimento_paciente_w.cd_setor_atendimento, 'N', procedimento_paciente_w.cd_setor_atendimento);
	
	begin
	select	cd_setor_externo
	into STRICT	r_service_change_mult_w.performou
	from	setor_atendimento
	where	cd_setor_atendimento = procedimento_paciente_w.cd_setor_atendimento;
	exception
	when others then
		r_service_change_mult_w.performou	:=	null;
	end;		
	
	intpd_processar_atrib_envio(reg_integracao_w, 'CD_SETOR_ATENDIMENTO', 'performoux', 'S', procedimento_paciente_w.cd_setor_atendimento, 'N', r_service_change_mult_w.performoux);
			
	intpd_processar_atrib_envio(reg_integracao_w, 'DT_PROCEDIMENTO','srvstartdate', 'N', procedimento_paciente_w.dt_procedimento, 'N', dt_geral_w);
	r_service_change_mult_w.srvstartdate	:= to_char(to_date(dt_geral_w),'yyyy-mm-dd');
	intpd_processar_atrib_envio(reg_integracao_w, 'DT_PROCEDIMENTO','srvstartdatex', 'S', procedimento_paciente_w.dt_procedimento, 'N', r_service_change_mult_w.srvstartdatex);
	
	if (coalesce(procedimento_paciente_w.dt_final_procedimento::text, '') = '') then
		dt_geral_w	:= null;
		intpd_processar_atrib_envio(reg_integracao_w, 'DT_PROCEDIMENTO','srvenddate', 'N', procedimento_paciente_w.dt_procedimento, 'N', dt_geral_w);
		r_service_change_mult_w.srvenddate	:= to_char(to_date(dt_geral_w),'yyyy-mm-dd');
		intpd_processar_atrib_envio(reg_integracao_w, 'DT_PROCEDIMENTO','srvenddatex', 'S', procedimento_paciente_w.dt_procedimento, 'N', r_service_change_mult_w.srvenddatex);
		
		dt_geral_w	:= null;
		intpd_processar_atrib_envio(reg_integracao_w, 'DT_PROCEDIMENTO','srvendtime', 'N', procedimento_paciente_w.dt_procedimento, 'N', dt_geral_w);
		r_service_change_mult_w.srvendtime	:= to_char(to_date(dt_geral_w),'hh24:mi:ss');
		intpd_processar_atrib_envio(reg_integracao_w, 'DT_PROCEDIMENTO','srvendtimex', 'S', procedimento_paciente_w.dt_procedimento, 'N', r_service_change_mult_w.srvendtimex);
	else
		dt_geral_w	:= null;
		intpd_processar_atrib_envio(reg_integracao_w, 'DT_FINAL_PROCEDIMENTO','srvenddate', 'N', procedimento_paciente_w.dt_final_procedimento, 'N', dt_geral_w);
		r_service_change_mult_w.srvenddate	:= to_char(to_date(dt_geral_w),'yyyy-mm-dd');
		intpd_processar_atrib_envio(reg_integracao_w, 'DT_FINAL_PROCEDIMENTO','srvenddatex', 'S', procedimento_paciente_w.dt_final_procedimento, 'N', r_service_change_mult_w.srvenddatex);
		
		dt_geral_w	:= null;
		intpd_processar_atrib_envio(reg_integracao_w, 'DT_FINAL_PROCEDIMENTO','srvendtime', 'N', procedimento_paciente_w.dt_final_procedimento, 'N', dt_geral_w);
		r_service_change_mult_w.srvendtime	:= to_char(to_date(dt_geral_w),'hh24:mi:ss');
		intpd_processar_atrib_envio(reg_integracao_w, 'DT_FINAL_PROCEDIMENTO','srvendtimex', 'S', procedimento_paciente_w.dt_final_procedimento, 'N', r_service_change_mult_w.srvendtimex);		
	end if;
	
	intpd_processar_atrib_envio(reg_integracao_w, 'QT_PROCEDIMENTO','srvquantity', 'N', procedimento_paciente_w.qt_procedimento, 'N', r_service_change_mult_w.srvquantity);
	intpd_processar_atrib_envio(reg_integracao_w, 'QT_PROCEDIMENTO','srvquantityx', 'S', procedimento_paciente_w.qt_procedimento, 'N', r_service_change_mult_w.srvquantityx);
	intpd_processar_atrib_envio(reg_integracao_w, 'VL_PROCEDIMENTO','diffprice', 'N', procedimento_paciente_w.vl_procedimento, 'N', r_service_change_mult_w.diffprice);
	intpd_processar_atrib_envio(reg_integracao_w, 'VL_PROCEDIMENTO','diffpricex', 'S', procedimento_paciente_w.vl_procedimento, 'N', r_service_change_mult_w.diffpricex);
	
	dt_geral_w	:= null;
	intpd_processar_atrib_envio(reg_integracao_w, 'DT_ATUALIZACAO','creationdate', 'N', procedimento_paciente_w.dt_atualizacao, 'N', dt_geral_w);
	r_service_change_mult_w.creationdate	:= to_char(to_date(dt_geral_w),'yyyy-mm-dd');
	intpd_processar_atrib_envio(reg_integracao_w, 'DT_ATUALIZACAO','creationdatex', 'S', procedimento_paciente_w.dt_atualizacao, 'N', r_service_change_mult_w.creationdatex);
	
	r_service_change_mult_w.creationuser	:=	current_setting('ish_case_serv_data_pck.usernameish')::varchar(15);
	r_service_change_mult_w.creationuserx		:=	'X';
	
	if (procedimento_paciente_w.ie_valor_informado = 'S') then
		intpd_processar_atrib_envio(reg_integracao_w, 'VL_PROCEDIMENTO','userprice', 'N', procedimento_paciente_w.vl_procedimento, 'N', r_service_change_mult_w.userprice);
		intpd_processar_atrib_envio(reg_integracao_w, 'VL_PROCEDIMENTO','userpricex', 'S', procedimento_paciente_w.vl_procedimento, 'N', r_service_change_mult_w.userpricex);
	end if;		

	if (procedimento_paciente_w.dt_procedimento > clock_timestamp()) then
		intpd_processar_atrib_envio(reg_integracao_w, 'DT_PROCEDIMENTO','statusind', 'N', procedimento_paciente_w.dt_procedimento, 'N', dt_geral_w);
		r_service_change_mult_w.statusind	:= 'X';			
	end if;

	intpd_processar_atrib_envio(reg_integracao_w, 'DS_JUST_VALOR_INF','reasonfactor', 'N', procedimento_paciente_w.ds_just_valor_inf, 'N', r_service_change_mult_w.reasonfactor);
	intpd_processar_atrib_envio(reg_integracao_w, 'DS_JUST_VALOR_INF','reasonfactorx', 'S', procedimento_paciente_w.ds_just_valor_inf, 'N', r_service_change_mult_w.reasonfactorx);
	intpd_processar_atrib_envio(reg_integracao_w, 'DS_JUST_VALOR_INF','rsnltextind', 'N', procedimento_paciente_w.ds_just_valor_inf, 'N', r_service_change_mult_w.rsnltextind);
	intpd_processar_atrib_envio(reg_integracao_w, 'DS_JUST_VALOR_INF','rsnltextindx', 'S', procedimento_paciente_w.ds_just_valor_inf, 'N', r_service_change_mult_w.rsnltextindx);
	intpd_processar_atrib_envio(reg_integracao_w, 'DS_OBSERVACAO','srvremark', 'N', procedimento_paciente_w.ds_observacao, 'N', ds_observacao_w);
	r_service_change_mult_w.srvremark	:= substr(ds_observacao_w,1,40);
	intpd_processar_atrib_envio(reg_integracao_w, 'DS_OBSERVACAO','srvremarkx', 'S', procedimento_paciente_w.ds_observacao, 'N', r_service_change_mult_w.srvremarkx);
	intpd_processar_atrib_envio(reg_integracao_w, 'IE_LADO','localis', 'N', procedimento_paciente_w.ie_lado, 'S', r_service_change_mult_w.localis);
	intpd_processar_atrib_envio(reg_integracao_w, 'IE_LADO','localisx', 'S', procedimento_paciente_w.ie_lado, 'N', r_service_change_mult_w.localisx);
	intpd_processar_atrib_envio(reg_integracao_w, 'NR_SEQUENCIA','srvinputseqno', 'N', procedimento_paciente_w.nr_sequencia, 'N', r_service_change_mult_w.srvinputseqno);
	intpd_processar_atrib_envio(reg_integracao_w, 'NR_SEQUENCIA','srvinputseqnox', 'S', procedimento_paciente_w.nr_sequencia, 'N', r_service_change_mult_w.srvinputseqnox);
			
	RETURN NEXT r_service_change_mult_w;		
end if;

CALL intpd_gravar_log_fila(reg_integracao_w);
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION ish_case_serv_data_pck.get_service_change_mult (nr_seq_fila_p bigint) FROM PUBLIC;
