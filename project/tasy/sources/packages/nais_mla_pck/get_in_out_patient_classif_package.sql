-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION nais_mla_pck.get_in_out_patient_classif ( patient_code_p text, transaction_time_p timestamp ) RETURNS varchar AS $body$
DECLARE


    bed_request_seq_w       bigint;
    bed_request_status_w    varchar(2);

    c05 CURSOR FOR
    SELECT  nr_sequencia bed_request_seq
    from    gestao_vaga
    where   cd_pessoa_fisica = patient_code_p;


BEGIN

        open c05;
        loop
            fetch c05 into bed_request_seq_w;
            EXIT WHEN NOT FOUND; /* apply on c05 */

            begin
                select    coalesce(ie_status, '-')
                into STRICT      bed_request_status_w
                from      gestao_vaga_hist_status
                where     nr_seq_gestao_vaga = bed_request_seq_w
                and       dt_atualizacao <= transaction_time_p
                order by    dt_atualizacao desc  LIMIT 1;

            exception
                when no_data_found then
                    bed_request_status_w := '-';
            end;

            if (bed_request_status_w = 'F') then
                return 'I';  -- Inpatient
            end if;

        end loop;

        return 'O';  -- Outpatient
    END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION nais_mla_pck.get_in_out_patient_classif ( patient_code_p text, transaction_time_p timestamp ) FROM PUBLIC;
