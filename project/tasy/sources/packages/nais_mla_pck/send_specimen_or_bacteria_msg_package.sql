-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE nais_mla_pck.send_specimen_or_bacteria_msg ( nr_prescricao_p bigint, cd_classif_p text, file_output_p INOUT text ) AS $body$
DECLARE

      c_order_unit varchar(100);
      c05 CURSOR FOR
      SELECT distinct a.nr_order_unit   order_unit
        from cpoe_procedimento c,
             prescr_procedimento p ,
             cpoe_order_unit a,
             cpoe_tipo_pedido b,						
             prescr_medica m,
             exame_laboratorio e,
             proc_interno pi,
             bft_encounter_v v
        where   c.nr_sequencia=p.nr_seq_proc_cpoe 
                and p.nr_prescricao=m.nr_prescricao
                and m.nr_prescricao=nr_prescricao_p 
                and p.nr_seq_exame = e.nr_seq_exame
                and a.nr_seq_cpoe_tipo_pedido   = b.nr_sequencia
                and a.nr_sequencia              = c.nr_seq_cpoe_order_unit
                and coalesce(e.ie_controla_pendente,'S') = 'S' 
                and c.nr_atendimento =  v.encounter_id
                and pi.nr_sequencia	= c.nr_seq_proc_interno
                 and (case 
                        when(cd_classif_p = 'nais.mla.specimen.execution') and  b.nr_seq_sub_grp  = 'L' and  obter_conversao_externa_int(null,'PROC_INTERNO_CLASSIF','NR_SEQUENCIA', pi.nr_seq_classif, 'NAIS' ) = 'E0' THEN (1)
                          when(cd_classif_p = 'nais.mla.bacteria') and  b.nr_seq_sub_grp  = 'B' and  obter_conversao_externa_int(null,'PROC_INTERNO_CLASSIF','NR_SEQUENCIA', pi.nr_seq_classif, 'NAIS' ) = 'E8' THEN (1)
                          else 0
                     end) = 1;




BEGIN

        open c05;
          loop
                fetch c05 into c_order_unit;
                EXIT WHEN NOT FOUND; /* apply on c05 */
                file_output_p := nais_mla_pck.send_specimen_or_bacteria_data(nr_prescricao_p, cd_classif_p, c_order_unit);
           end loop;

        close c05;


      END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE nais_mla_pck.send_specimen_or_bacteria_msg ( nr_prescricao_p bigint, cd_classif_p text, file_output_p INOUT text ) FROM PUBLIC;
