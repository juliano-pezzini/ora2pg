-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE nais_mla_pck.get_action_code ( cd_internal_code_p bigint, cd_actioncode_p INOUT text ) AS $body$
DECLARE


        actioncode_w   varchar(10);
        si_type_of_prescription_w   cpoe_order_unit.si_type_of_prescription%type;
        si_temporary_admin_w    cpoe_rp.si_temporary_admin%type;
        cd_interval_w   bigint;


BEGIN

		begin

			select  c.si_type_of_prescription,
					d.si_temporary_admin,
					(coalesce(substr(d.cd_intervalo,1,2), 0))::numeric 
			into STRICT	si_type_of_prescription_w,
					si_temporary_admin_w,
					cd_interval_w
			from    cpoe_material           a,
					prescr_material         b,
					cpoe_order_unit         c,
					cpoe_rp                 d
			where   a.nr_sequencia = b.nr_seq_mat_cpoe
			and 	a.nr_seq_cpoe_order_unit = c.nr_sequencia
			and 	a.nr_seq_cpoe_rp = d.nr_sequencia
			and 	b.nr_seq_interno = cd_internal_code_p;

		exception
        when others then
            PERFORM set_config('nais_mla_pck.ds_error_w', current_setting('nais_mla_pck.ds_error_w')::varchar(4000)||' An error occured while retriving the type of medicine '||sqlerrm, false);
        end;

         case
            when( si_type_of_prescription_w = 'OPIHO' ) then --Outpatient in-hosptal
                case
                     when(cd_interval_w = 10) then -- Internal medicine
                        case
                            when( si_temporary_admin_w = 'Y' ) then
                                cd_actioncode_p := rpad('.2110', 6, ' ');
                            when( si_temporary_admin_w = 'N' ) then
                                cd_actioncode_p := rpad('.2100', 6, ' ');
                        end case;
                     when(cd_interval_w = 20) then --PRN
                        case
                            when( si_temporary_admin_w = 'Y' ) then
                                cd_actioncode_p := rpad('.2210', 6, ' ');
                            when( si_temporary_admin_w = 'N' ) then
                                cd_actioncode_p := rpad('.2200', 6, ' ');
                        end case;
                     when(cd_interval_w between 30 and 59) then --Typical medicine
                        case
                            when( si_temporary_admin_w = 'Y' ) then
                                cd_actioncode_p := rpad('.2310', 6, ' ');
                            when( si_temporary_admin_w = 'N' ) then
                                cd_actioncode_p := rpad('.2300', 6, ' ');
                        end case;
                     when(cd_interval_w = 60) then --Self-injection
						cd_actioncode_p := rpad('.1450', 6, ' ');
                     else --default
                        case
                            when( si_temporary_admin_w = 'Y' ) then
                                cd_actioncode_p := rpad('.2110', 6, ' ');
                            when( si_temporary_admin_w = 'N' ) then
                                cd_actioncode_p := rpad('.2100', 6, ' ');
                        end case;
                end case;
            when( si_type_of_prescription_w = 'OPOOH' ) then --Outpatient external
                case
                     when(cd_interval_w = 10) then -- Internal medicine
                        case
                            when( si_temporary_admin_w = 'Y' ) then
                                cd_actioncode_p := rpad('.8610', 6, ' ');
                            when( si_temporary_admin_w = 'N' ) then
                                cd_actioncode_p := rpad('.8600', 6, ' ');
                        end case;
                     when(cd_interval_w = 20) then --PRN
                        case
                            when( si_temporary_admin_w = 'Y' ) then
                                cd_actioncode_p := rpad('.8710', 6, ' ');
                            when( si_temporary_admin_w = 'N' ) then
                                cd_actioncode_p := rpad('.8700', 6, ' ');
                        end case;
                     when(cd_interval_w between 30 and 59) then --Typical medicine
                        case
                            when( si_temporary_admin_w = 'Y' ) then
                                cd_actioncode_p := rpad('.8810', 6, ' ');
                            when( si_temporary_admin_w = 'N' ) then
                                cd_actioncode_p := rpad('.8800', 6, ' ');
                        end case;
                     when(cd_interval_w = 60) then --Self-injection
                         cd_actioncode_p := rpad('.8800', 6, ' ');
                     else    -- default
                        case
                            when( si_temporary_admin_w = 'Y' ) then
                                cd_actioncode_p := rpad('.8610', 6, ' ');
                            when( si_temporary_admin_w = 'N' ) then
                                cd_actioncode_p := rpad('.8600', 6, ' ');
                        end case;
                end case;
        end case;

    END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE nais_mla_pck.get_action_code ( cd_internal_code_p bigint, cd_actioncode_p INOUT text ) FROM PUBLIC;
