-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE nais_mla_pck.send_injection_message ( nr_seq_register_p bigint, ie_tipo_file_p text, ds_file_output_p INOUT text ) AS $body$
DECLARE


        nr_order_unit_w cpoe_order_unit.nr_order_unit%type;
        ds_file_output_p1             text;
        nr_seq_int_call_log_w integration_message_log.nr_seq_int_call_log%type := 0;

        c01 CURSOR FOR
        SELECT  distinct a.nr_order_unit
        from    cpoe_order_unit a,
                cpoe_tipo_pedido b,
                cpoe_material c,
                prescr_material d,
                prescr_solucao_evento e,
                prescr_medica f
        where   b.nr_sequencia = a.nr_seq_cpoe_tipo_pedido
        and     a.nr_sequencia = c.nr_seq_cpoe_order_unit
        and     c.nr_sequencia = d.nr_seq_mat_cpoe
        and     d.nr_seq_mat_cpoe = e.nr_seq_cpoe
        and     d.nr_prescricao = f.nr_prescricao
        and 	e.nr_sequencia = nr_seq_register_p
        and     b.nr_seq_sub_grp = 'I'
        and     ie_tipo_file_p = 'mlaInjection'
        and     (a.nr_order_unit IS NOT NULL AND a.nr_order_unit::text <> '')
        
union all

        SELECT 	distinct a.nr_order_unit
        from    cpoe_order_unit a,
                cpoe_tipo_pedido b,
                cpoe_material c,
                prescr_material d,
                prescr_medica f
        where   b.nr_sequencia = a.nr_seq_cpoe_tipo_pedido
        and     a.nr_sequencia = c.nr_seq_cpoe_order_unit    
        and     c.nr_sequencia = d.nr_seq_mat_cpoe
        and     d.nr_prescricao = f.nr_prescricao
        and     b.nr_seq_sub_grp = 'I'
        and     f.nr_prescricao = nr_seq_register_p
        and     ie_tipo_file_p = 'mlaCpoeInjection'
        and     (a.nr_order_unit IS NOT NULL AND a.nr_order_unit::text <> '');


BEGIN
        PERFORM set_config('nais_mla_pck.json_output_list_w', philips_json_list(), false);
        PERFORM set_config('nais_mla_pck.ds_error_w', null, false);

        begin
            open c01;
                loop
                    fetch c01 into nr_order_unit_w;
                    EXIT WHEN NOT FOUND; /* apply on c01 */
                        CALL nais_mla_pck.send_injection_data(nr_seq_register_p, ie_tipo_file_p, nr_order_unit_w);
                end loop;
            close c01;
        exception
        when others then
            PERFORM set_config('nais_mla_pck.ds_error_w', current_setting('nais_mla_pck.ds_error_w')::varchar(4000)||' An error occured while retriving the order unit for sequence of Injection '||nr_seq_register_p||' '||sqlerrm, false);
        end;

        dbms_lob.createtemporary(ds_file_output_p, true);
        current_setting('nais_mla_pck.json_output_list_w')::philips_json_list.(ds_file_output_p);

        if (coalesce(nr_order_unit_w::text, '') = '') then
            PERFORM set_config('nais_mla_pck.ds_error_w', 'Order unit not found for this sequence of Injection  '||nr_seq_register_p, false);
        end if;
        if current_setting('nais_mla_pck.ds_error_w')::varchar(4000) is not  null then
            record_integration_call_log('NAIS', 'NAIS', clock_timestamp(), '260', ie_tipo_file_p ,
            'E', 'E', null, 'KK', ds_file_output_p,substr(current_setting('nais_mla_pck.ds_error_w')::varchar(4000),1,499), ie_tipo_file_p,nr_seq_int_call_log_w, nr_seq_register_p, 944,'E', ie_interface_type_p => '261',ie_tipo_error_p => 'MB',ds_conversion_log_p=>null,ie_message_code_p =>'KK');
        end if;
    END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE nais_mla_pck.send_injection_message ( nr_seq_register_p bigint, ie_tipo_file_p text, ds_file_output_p INOUT text ) FROM PUBLIC;
