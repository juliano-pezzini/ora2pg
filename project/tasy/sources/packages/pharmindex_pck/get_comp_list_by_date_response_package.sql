-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pharmindex_pck.get_comp_list_by_date_response ( nr_sequencia_p bigint) AS $body$
DECLARE


reg_integracao_w		gerar_int_padrao.reg_integracao_conv;
nr_seq_doc_origem_w		intpd_fila_transmissao.nr_seq_documento%type;
ie_status_w			intpd_fila_transmissao.ie_status%type;
ie_tipo_erro_w			intpd_fila_transmissao.ie_tipo_erro%type;
ds_xml_w			text;
xml_w				xml;

getCompanyListByDateResult_w	xml;

ds_erro_w			varchar(2000);
nr_seq_documento_w		varchar(80);
pharmindex_empresa_w		pharmindex_empresa%rowtype;


c01 CURSOR FOR
	SELECT	*
	from	xmltable('/getCompanyListByDateResult/item' passing getCompanyListByDateResult_w columns
			drug_prod_id	varchar(10)		path		'DrugProdId',
			drug_prod_name	varchar(255)		path		'DrugProdName',
			company_name	varchar(255)		path		'CompanyName',
			company_street	varchar(255)		path		'CompanyStreet',
			company_zip	varchar(20)		path		'CompanyZip',
			company_city	varchar(255)		path		'CompanyCity',
			company_tel	varchar(255)		path		'CompanyTel',
			company_fax	varchar(255)		path		'CompanyFax',
			company_email	varchar(255)		path		'CompanyEmail',
			company_www	varchar(255)		path		'CompanyWww',
			modified	varchar(20)		path		'Modified',
			status		varchar(15)		path		'Status');

c01_w	c01%rowtype;


BEGIN
CALL intpd_inicializacao(nr_sequencia_p);

delete	FROM intpd_log_recebimento
where	nr_seq_fila = nr_sequencia_p;

begin
select	a.nr_seq_documento,
	a.ds_xml_retorno
into STRICT	nr_seq_doc_origem_w,
	ds_xml_w
from	intpd_fila_transmissao a,
	intpd_eventos_sistema b
where	a.nr_seq_evento_sistema = b.nr_sequencia
and	a.nr_sequencia = nr_sequencia_p;
exception
when others then
	null;
end;

ish_converter_response(nr_sequencia_p, ds_xml_w, ie_status_w, ie_tipo_erro_w, xml_w);

if (ie_status_w = 'E') then
	update	intpd_fila_transmissao
	set	ie_status = ie_status_w,
		ie_tipo_erro = ie_tipo_erro_w,
		ie_response_procedure = 'S'
	where	nr_sequencia = nr_sequencia_p;
else
	begin
	intpd_reg_integracao_inicio(nr_sequencia_p, 'R', reg_integracao_w);

	select	a.getCompanyListByDateResult
	into STRICT	getCompanyListByDateResult_w
	from	xmltable(
			xmlnamespaces(
			'http://ws.pharmindex.pl/demo/' as "ns1",
			'http://schemas.xmlsoap.org/soap/envelope/' as "SOAP-ENV"),
			'SOAP-ENV:Envelope/SOAP-ENV:Body/ns1:getCompanyListByDateResponse' passing xml_w columns
		getCompanyListByDateResult xmltype path 'getCompanyListByDateResult') a;

	open c01;
	loop
	fetch c01 into
		c01_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin
		reg_integracao_w.nm_tabela		:= 'PHARMINDEX_EMPRESA';
		reg_integracao_w.nm_elemento		:= 'getCompanyListByDateResult';

		pharmindex_empresa_w.company_city	:=	c01_w.company_city;
		pharmindex_empresa_w.company_email	:=	c01_w.company_email;
		pharmindex_empresa_w.company_fax	:=	c01_w.company_fax;
		pharmindex_empresa_w.company_name	:=	c01_w.company_name;
		pharmindex_empresa_w.company_street	:=	c01_w.company_street;
		pharmindex_empresa_w.company_tel	:=	c01_w.company_tel;
		pharmindex_empresa_w.company_www	:=	c01_w.company_www;
		pharmindex_empresa_w.company_zip	:=	c01_w.company_zip;
		pharmindex_empresa_w.drug_prod_id	:=	c01_w.drug_prod_id;
		pharmindex_empresa_w.drug_prod_name	:=	c01_w.drug_prod_name;
		pharmindex_empresa_w.modified		:=	c01_w.modified;
		pharmindex_empresa_w.status		:=	c01_w.status;

		pharmindex_empresa_w.nr_seq_processo	:=	somente_numero(nr_seq_doc_origem_w);

		select	nextval('pharmindex_empresa_seq')
		into STRICT		pharmindex_empresa_w.nr_sequencia
		;

		insert into pharmindex_empresa values (pharmindex_empresa_w.*);
		end;

	end loop;
	close c01;

	if (reg_integracao_w.qt_reg_log > 0) then
		begin
		rollback;

		update	intpd_fila_transmissao
		set	ie_status = 'E',
			ie_response_procedure = 'S',
			ds_log = ds_erro_w
		where	nr_sequencia = nr_sequencia_p;
		end;
	else
		update	intpd_fila_transmissao
		set	ie_status = 'S',
			ie_response_procedure = 'S',
			ds_log  = NULL
		where	nr_sequencia = nr_sequencia_p;
	end if;

	reg_integracao_w := gerar_int_padrao.gravar_log(reg_integracao_w);
	exception
	when others then
		begin
		ds_erro_w	:=	substr(dbms_utility.format_error_backtrace || chr(13) || chr(10) || sqlerrm,1,4000);
			update	intpd_fila_transmissao
		set	ie_status = 'E',
			ds_log = ds_erro_w,
			ie_response_procedure = 'S'
		where	nr_sequencia = nr_sequencia_p;
		end;
	end;
end if;

commit;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pharmindex_pck.get_comp_list_by_date_response ( nr_sequencia_p bigint) FROM PUBLIC;
