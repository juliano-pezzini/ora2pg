-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pharmindex_pck.gerar_sup_int_material ( nr_seq_processo_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE


sup_int_material_w		sup_int_material%rowtype;
cd_classe_material_w	classe_material.cd_classe_material%type;
cd_interno_w			conversao_meio_externo.cd_interno%type;

C01 CURSOR FOR
SELECT	*
from	PHARMINDEX_FORM_MEDIC a
where	a.nr_seq_processo = nr_seq_processo_p
and		a.ie_importar = 'S';

c01_w	c01%rowtype;

C02 CURSOR FOR
SELECT	*
from	PHARMINDEX_MEDIC a
where	A.nr_seq_processo = nr_seq_processo_p
and		A.DRUG_ID = c01_w.DRUG_ID
and		not exists (select	1
				from	sup_int_material x
				where	x.cd_material = c01_w.Package_Id
				and		x.nr_seq_tab_origem = nr_seq_processo_p
				and		x.cd_sistema_externo = 'PHA'
				and		x.ie_forma_integracao = 'R'
				and		coalesce(x.dt_confirma_integracao::text, '') = '');

c02_w	c02%rowtype;



BEGIN
/*delete ish_log;
commit;*/
/* Removes any register that was updated to not import, if in some time, the information was already generated in SUP_INT_MATERIAL */

delete
from	SUP_INT_MATERIAL a
where	a.nr_seq_tab_origem = nr_seq_processo_p
and		a.cd_sistema_externo = 'PHA'
and		coalesce(a.dt_confirma_integracao::text, '') = ''
and		exists (SELECT	1
				from	PHARMINDEX_FORM_MEDIC x
				where	x.nr_seq_processo = a.nr_seq_tab_origem
				and		x.nr_sequencia = a.nr_seq_item_tab_origem
				and		x.ie_importar <> 'S');

/* Check if there is a default value for CD_CLASSE_MATERIAL */
				
select	coalesce(max(a.cd_interno),0)
into STRICT	cd_interno_w
from	REGRA_CONV_MEIO_EXT b,
		CONVERSAO_MEIO_EXTERNO a
where	a.nr_seq_regra = b.nr_sequencia
and		b.ie_situacao = 'A'
and		a.IE_SISTEMA_EXTERNO = 'PHA'
and		a.NM_TABELA = 'CLASSE_MATERIAL'
and		a.NM_ATRIBUTO = 'CD_CLASSE_MATERIAL'
and		a.CD_EXTERNO = '0';

if (cd_interno_w <> 0) then
	begin
	select	cd_classe_material
	into STRICT	cd_classe_material_w
	from	classe_material
	where	cd_classe_material = somente_numero(cd_interno_w)
	and		ie_situacao = 'A';	
	
	exception when others then
		cd_classe_material_w	:= null;
	end;
end if;

/* Start to send information from PHARMINDEX tables to SUP_INT_MATERIAL */
		
open C01;
loop
fetch C01 into
	c01_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	open C02;
	loop
	fetch C02 into
		c02_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin
		sup_int_material_w	:=	null;

		select	nextval('sup_int_material_seq')
		into STRICT	sup_int_material_w.NR_SEQUENCIA
		;

		sup_int_material_w.CD_ESTABELECIMENTO	:= 	cd_estabelecimento_p;
		sup_int_material_w.CD_FABRICANTE	:= c02_w.Drug_Prod_ID;
		sup_int_material_w.CD_MATERIAL	:= c01_w.Package_Id;
		sup_int_material_w.CD_MATERIAL_CONTA	:= c01_w.Package_Id;
		sup_int_material_w.CD_MATERIAL_ESTOQUE	:= c01_w.Package_Id;
		sup_int_material_w.CD_MATERIAL_GENERICO	:= c01_w.Package_Id;

		begin
		select	cd_unidade_medida
		into STRICT	sup_int_material_w.CD_UNIDADE_MEDIDA_COMPRA
		from	unidade_medida
		where	lower(cd_unidade_medida) like 'un'
		and	ie_situacao = 'A'  LIMIT 1;
		exception
		when others then
			sup_int_material_w.CD_UNIDADE_MEDIDA_COMPRA	:=	null;
		end;

		sup_int_material_w.CD_UNIDADE_MEDIDA_CONSUMO	:= sup_int_material_w.CD_UNIDADE_MEDIDA_COMPRA;
		sup_int_material_w.CD_UNIDADE_MEDIDA_ESTOQUE	:= sup_int_material_w.CD_UNIDADE_MEDIDA_COMPRA;
		sup_int_material_w.CD_UNIDADE_MEDIDA_SOLIC	:= sup_int_material_w.CD_UNIDADE_MEDIDA_COMPRA;

		sup_int_material_w.DS_MATERIAL	:= c01_w.Drug_Short_Name;
		sup_int_material_w.DS_REDUZIDA	:= c01_w.Drug_full_Name;
		sup_int_material_w.DT_ATUALIZACAO	:= clock_timestamp();
		sup_int_material_w.DT_ATUALIZACAO_NREC	:= clock_timestamp();

		sup_int_material_w.IE_BAIXA_ESTOQ_PAC	:= 'S';
		sup_int_material_w.IE_CATALOGO	:= 'S';

		if (c01_w.Is_Reimbursed = '1') then
			sup_int_material_w.IE_COBRA_PACIENTE	:= 'S';
		else
			sup_int_material_w.IE_COBRA_PACIENTE	:= 'N';
		end if;

		sup_int_material_w.IE_CONSIGNADO	:= '0';
		sup_int_material_w.IE_CURVA_XYZ	:= 'S';
		sup_int_material_w.IE_DISPONIVEL_MERCADO	:= 'S';
		sup_int_material_w.IE_FORMA_INTEGRACAO	:= 'R';
		sup_int_material_w.IE_INF_ULTIMA_COMPRA	:= 'S';
		sup_int_material_w.IE_MATERIAL_ESTOQUE	:= 'N';
		sup_int_material_w.IE_OBRIG_VIA_APLICACAO	:= 'N';
		sup_int_material_w.IE_PACTUADO	:= 'N';
		sup_int_material_w.IE_PADRONIZADO	:= 'N';
		sup_int_material_w.IE_PRECO_COMPRA	:= 'S';
		sup_int_material_w.IE_PRESCRICAO	:= 'N';

		if (c01_w.Is_Reimbursed = '1') then
			sup_int_material_w.IE_COBRA_PACIENTE	:= 'S';
		else
			sup_int_material_w.IE_COBRA_PACIENTE	:= 'N';
		end if;

		if (c01_w.Is_Reimbursed = '1') then
			sup_int_material_w.IE_RECEITA	:= 'S';
		else
			sup_int_material_w.IE_RECEITA	:= 'N';
		end if;

		if (c01_w.status = 'active') then
			sup_int_material_w.IE_SITUACAO	:= 'A';
		else
			sup_int_material_w.IE_SITUACAO	:= 'I';
		end if;

		sup_int_material_w.IE_TIPO_MATERIAL	:= '2';
		sup_int_material_w.NM_USUARIO		:= nm_usuario_p;
		sup_int_material_w.NM_USUARIO_NREC	:= nm_usuario_p;
		sup_int_material_w.QT_CONV_COMPRA_ESTOQUE	:= 1;
		sup_int_material_w.QT_CONV_ESTOQUE_CONSUMO	:= 1;
		sup_int_material_w.QT_MINIMO_MULTIPLO_SOLIC	:= 1;

		sup_int_material_w.QT_DIA_INTERV_RESSUP		:= 15;
		sup_int_material_w.QT_DIA_RESSUP_FORN		:= 7;
		sup_int_material_w.QT_DIA_ESTOQUE_MINIMO	:= 3;
		
		if (cd_classe_material_w IS NOT NULL AND cd_classe_material_w::text <> '') then
			sup_int_material_w.cd_classe_material	:= cd_classe_material_w;
		end if;
		
		sup_int_material_w.DS_ESPEC_TECNICA	:= pharmindex_pck.get_espec_tecnica(sup_int_material_w.DS_ESPEC_TECNICA, 'Composition', c02_w.Drug_Desc_Composition);
		sup_int_material_w.DS_ESPEC_TECNICA	:= pharmindex_pck.get_espec_tecnica(sup_int_material_w.DS_ESPEC_TECNICA, 'Activity', c02_w.Drug_Desc_activity);
		sup_int_material_w.DS_ESPEC_TECNICA	:= pharmindex_pck.get_espec_tecnica(sup_int_material_w.DS_ESPEC_TECNICA, 'Indication', c02_w.Drug_Desc_Indication);
		sup_int_material_w.DS_ESPEC_TECNICA	:= pharmindex_pck.get_espec_tecnica(sup_int_material_w.DS_ESPEC_TECNICA, 'Contr Indication', c02_w.DRUG_DESC_CONTR_IND);
		sup_int_material_w.DS_ESPEC_TECNICA	:= pharmindex_pck.get_espec_tecnica(sup_int_material_w.DS_ESPEC_TECNICA, 'Warning', c02_w.DRUG_DESC_WARNING);
		sup_int_material_w.DS_ESPEC_TECNICA	:= pharmindex_pck.get_espec_tecnica(sup_int_material_w.DS_ESPEC_TECNICA, 'Pregnant', c02_w.DRUG_DESC_PREGN);
		sup_int_material_w.DS_ESPEC_TECNICA	:= pharmindex_pck.get_espec_tecnica(sup_int_material_w.DS_ESPEC_TECNICA, 'Side effect', c02_w.DRUG_DESC_SIDE_EFF);
		sup_int_material_w.DS_ESPEC_TECNICA	:= pharmindex_pck.get_espec_tecnica(sup_int_material_w.DS_ESPEC_TECNICA, 'Interaction', c02_w.DRUG_DESC_INTER);
		sup_int_material_w.DS_ESPEC_TECNICA	:= pharmindex_pck.get_espec_tecnica(sup_int_material_w.DS_ESPEC_TECNICA, 'Dosage', c02_w.DRUG_DESC_DOSAGE);
		sup_int_material_w.DS_ESPEC_TECNICA	:= pharmindex_pck.get_espec_tecnica(sup_int_material_w.DS_ESPEC_TECNICA, 'Notes', c02_w.DRUG_DESC_NOTES);

		sup_int_material_w.NR_SEQ_TAB_ORIGEM		:= nr_seq_processo_p;
		sup_int_material_w.NR_SEQ_ITEM_TAB_ORIGEM	:= c01_w.nr_sequencia;
		sup_int_material_w.CD_SISTEMA_EXTERNO		:= 'PHA';
		
		insert into sup_int_material values (sup_int_material_w.*);

		end;
	end loop;
	close C02;
	end;
end loop;
close C01;
commit;
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pharmindex_pck.gerar_sup_int_material ( nr_seq_processo_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;
