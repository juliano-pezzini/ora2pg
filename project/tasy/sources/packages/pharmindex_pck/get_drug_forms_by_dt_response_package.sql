-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pharmindex_pck.get_drug_forms_by_dt_response ( nr_sequencia_p bigint) AS $body$
DECLARE


reg_integracao_w		gerar_int_padrao.reg_integracao_conv;
nr_seq_doc_origem_w		intpd_fila_transmissao.nr_seq_documento%type;
ie_status_w			intpd_fila_transmissao.ie_status%type;
ie_tipo_erro_w			intpd_fila_transmissao.ie_tipo_erro%type;
ds_xml_w			text;
xml_w				xml;
get_drugs_form_result_w 	xml;
ds_erro_w			varchar(2000);
nr_seq_documento_w		varchar(80);
pharmindex_form_medic_w		pharmindex_form_medic%rowtype;

c01 CURSOR FOR
	SELECT	*
	from	xmltable('/getDrugFormsByDateResult/item' passing get_drugs_form_result_w columns
		drug_id			varchar(10)		path		'DrugId',
		drug_full_name		varchar(255)		path		'DrugFullName',
		drug_short_name		varchar(255)		path		'DrugShortName',
		drug_dosage		varchar(255)		path		'DrugDosage',
		drug_form		varchar(255)		path		'DrugForm',
		drug_package		varchar(255)		path		'DrugPackage',
		prescription_type_id	varchar(10)		path		'PrescriptionTypeId',
		is_reimbursed		varchar(15)		path		'IsReimbursed',
		is_narc_psych		varchar(15)		path		'IsNarcPsych',
		drug_reg_nr		varchar(255)		path		'DrugRegNr',
		price			varchar(15)		path		'Price',
		price_limit		varchar(15)		path		'PriceLimit',
		package_id		varchar(10)		path		'PackageId',
		drug_ean		varchar(255)		path		'DrugEan',
		sort_form		varchar(15)		path		'SortForm',
		sort_package		varchar(15)		path		'SortPackage',
		bloz7			varchar(15)		path		'Bloz7',
		modified		varchar(20)		path		'Modified',
		status			varchar(15)		path		'Status');

c01_w	c01%rowtype;


BEGIN
CALL intpd_inicializacao(nr_sequencia_p);

delete	FROM intpd_log_recebimento
where	nr_seq_fila = nr_sequencia_p;

begin
select	a.nr_seq_documento,
	a.ds_xml_retorno
into STRICT	nr_seq_doc_origem_w,
	ds_xml_w
from	intpd_fila_transmissao a,
	intpd_eventos_sistema b
where	a.nr_seq_evento_sistema = b.nr_sequencia
and	a.nr_sequencia = nr_sequencia_p;
exception
when others then
	null;
end;

ish_converter_response(nr_sequencia_p, ds_xml_w, ie_status_w, ie_tipo_erro_w, xml_w);

if (ie_status_w = 'E') then
	update	intpd_fila_transmissao
	set	ie_status = ie_status_w,
		ie_tipo_erro = ie_tipo_erro_w,
		ie_response_procedure = 'S'
	where	nr_sequencia = nr_sequencia_p;
else
	begin
	intpd_reg_integracao_inicio(nr_sequencia_p, 'R', reg_integracao_w);

	select	a.getDrugFormsByDateResult
	into STRICT	get_drugs_form_result_w
	from	xmltable(
			xmlnamespaces(
			'http://ws.pharmindex.pl/demo/' as "ns1",
			'http://schemas.xmlsoap.org/soap/envelope/' as "SOAP-ENV"),
			'SOAP-ENV:Envelope/SOAP-ENV:Body/ns1:getDrugFormsByDateResponse' passing xml_w columns
		getDrugFormsByDateResult xmltype path 'getDrugFormsByDateResult') a;

	open c01;
	loop
	fetch c01 into
		c01_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin
		reg_integracao_w.nm_tabela		:= 'PHARMINDEX_FORM_MEDIC';
		reg_integracao_w.nm_elemento		:= 'getDrugFormsByDateResult';

		pharmindex_form_medic_w.drug_id			:=	c01_w.drug_id;
		pharmindex_form_medic_w.drug_full_name		:=	c01_w.drug_full_name;
		pharmindex_form_medic_w.drug_short_name		:=	c01_w.drug_short_name;
		pharmindex_form_medic_w.drug_dosage		:=	c01_w.drug_dosage;
		pharmindex_form_medic_w.drug_form		:=	c01_w.drug_form;
		pharmindex_form_medic_w.drug_package		:=	c01_w.drug_package;
		pharmindex_form_medic_w.prescription_type_id	:=	c01_w.prescription_type_id;
		pharmindex_form_medic_w.is_reimbursed		:=	c01_w.is_reimbursed;
		pharmindex_form_medic_w.is_narc_psych		:=	c01_w.is_narc_psych;
		pharmindex_form_medic_w.drug_reg_nr		:=	c01_w.drug_reg_nr;
		pharmindex_form_medic_w.price			:=	c01_w.price;
		pharmindex_form_medic_w.price_limit		:=	c01_w.price_limit;
		pharmindex_form_medic_w.package_id		:=	c01_w.package_id;
		pharmindex_form_medic_w.drug_ean		:=	c01_w.drug_ean;
		pharmindex_form_medic_w.sort_form		:=	c01_w.sort_form;
		pharmindex_form_medic_w.sort_package		:=	c01_w.sort_package;
		pharmindex_form_medic_w.bloz7			:=	c01_w.bloz7;
		pharmindex_form_medic_w.modified		:=	c01_w.modified;
		pharmindex_form_medic_w.status			:=	c01_w.status;

		pharmindex_form_medic_w.nr_seq_processo		:=	somente_numero(nr_seq_doc_origem_w);

		select	nextval('pharmindex_form_medic_seq')
		into STRICT	pharmindex_form_medic_w.nr_sequencia
		;

		insert into pharmindex_form_medic values (pharmindex_form_medic_w.*);
		end;
	end loop;
	close c01;

	if (reg_integracao_w.qt_reg_log > 0) then
		begin
		rollback;

		update	intpd_fila_transmissao
		set	ie_status = 'E',
			ie_response_procedure = 'S',
			ds_log = ds_erro_w
		where	nr_sequencia = nr_sequencia_p;
		end;
	else
		update	intpd_fila_transmissao
		set	ie_status = 'S',
			ie_response_procedure = 'S',
			ds_log  = NULL
		where	nr_sequencia = nr_sequencia_p;
	end if;

	reg_integracao_w := gerar_int_padrao.gravar_log(reg_integracao_w);
	exception
	when others then
		begin
		ds_erro_w := substr(dbms_utility.format_error_backtrace || chr(13) || chr(10) || sqlerrm,1,4000);

		rollback;

		update	intpd_fila_transmissao
		set	ie_status = 'E',
			ds_log = ds_erro_w,
			ie_response_procedure = 'S'
		where	nr_sequencia = nr_sequencia_p;
		end;
	end;
end if;

commit;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pharmindex_pck.get_drug_forms_by_dt_response ( nr_sequencia_p bigint) FROM PUBLIC;
