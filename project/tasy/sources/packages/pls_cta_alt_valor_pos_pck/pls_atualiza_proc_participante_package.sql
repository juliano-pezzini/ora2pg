-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

-- é feito union no comando abaixo para tratar tanto se for selecionado vários itens, quanto se for clicado somente com o botão direito do mouse
CREATE OR REPLACE PROCEDURE pls_cta_alt_valor_pos_pck.pls_atualiza_proc_participante ( nr_seq_conta_proc_p pls_conta_proc_v.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE


vl_liberado_partic_w	pls_proc_participante_v.vl_participante%type;
vl_glosa_w		pls_proc_participante_v.vl_glosa%type;

C01 CURSOR(nr_seq_conta_proc_p		pls_conta_proc_v.nr_sequencia%type) FOR
	SELECT	a.vl_liberado,
		a.vl_procedimento,
		a.qt_procedimento,
		b.nr_sequencia nr_seq_proc_partic,
		b.vl_calculado
	from	pls_conta_proc_v a,
		pls_proc_participante_v b
	where	a.nr_sequencia 		= nr_seq_conta_proc_p
	and	b.nr_seq_conta_proc 	= a.nr_sequencia
	and	b.ie_status		<> 'C';
BEGIN

for r_C01_w in C01(nr_seq_conta_proc_p) loop

	vl_liberado_partic_w := dividir((r_C01_w.vl_liberado * r_C01_w.vl_calculado), r_C01_w.vl_procedimento);
	vl_glosa_w := 0;

	update	pls_proc_participante		
	set	vl_participante		= vl_liberado_partic_w,
		-- o campo vl_glosa está sendo descontinuado, apenas zeramos para não gerar mais confusão
		vl_glosa		= vl_glosa_w,
		-- o campo qt_liberada está sendo descontinuado, apenas zeramos para não gerar mais confusão
		qt_liberada		= 0,
		ie_status		= 'L',
		ie_status_pagamento	= pls_obter_stat_pag_item(ie_glosa, vl_liberado_partic_w, vl_glosa_w),
		nm_usuario		= nm_usuario_p,
		dt_atualizacao		= clock_timestamp()
	where	nr_sequencia		= r_C01_w.nr_seq_proc_partic;
	
end loop;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_cta_alt_valor_pos_pck.pls_atualiza_proc_participante ( nr_seq_conta_proc_p pls_conta_proc_v.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;
