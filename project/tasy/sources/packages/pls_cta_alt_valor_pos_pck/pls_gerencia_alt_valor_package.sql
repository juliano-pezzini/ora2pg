-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_cta_alt_valor_pos_pck.pls_gerencia_alt_valor ( cd_acao_analise_p pls_acao_analise.cd_acao%type, nr_seq_analise_p pls_analise_conta.nr_sequencia%type, nr_seq_conta_p pls_conta_v.nr_sequencia%type, nr_seq_conta_pos_estab_p pls_conta_pos_estabelecido.nr_sequencia%type, nr_seq_conta_proc_p pls_conta_proc_v.nr_sequencia%type, nr_seq_conta_mat_p pls_conta_mat_v.nr_sequencia%type, nr_seq_proc_partic_p pls_proc_participante_v.nr_sequencia%type, nr_seq_ocorrencia_p pls_ocorrencia.nr_sequencia%type, nr_seq_motivo_glosa_p tiss_motivo_glosa.nr_sequencia%type, ds_observacao_p pls_conta_glosa.ds_observacao%type, qt_liberada_p pls_conta_proc_v.qt_procedimento%type, vl_liberado_p pls_conta_proc_v.vl_liberado%type, vl_unitario_p pls_conta_proc_v.vl_unitario%type, vl_liberado_hi_p pls_conta_proc_v.vl_liberado_hi%type, vl_liberado_mat_p pls_conta_proc_v.vl_liberado_material%type, vl_liberado_co_p pls_conta_proc_v.vl_liberado_co%type, vl_lib_taxa_hi_p pls_conta_proc_v.vl_lib_taxa_servico%type, vl_lib_taxa_mat_p pls_conta_proc_v.vl_lib_taxa_material%type, vl_lib_taxa_co_p pls_conta_proc_v.vl_taxa_co%type, nr_seq_grupo_atual_p pls_auditoria_conta_grupo.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE

					
ie_atualiza_via_acesso_w	pls_parametros.ie_atualiza_via_acesso%type;
ie_status_pagamento_w		pls_conta_proc_v.ie_status_pagamento%type;
ie_tipo_inter_ocor_w		pls_analise_fluxo_item.ie_tipo_glosa%type;
nr_seq_fluxo_w			pls_analise_fluxo_item.nr_sequencia%type;
ie_origem_acao_w		varchar(5);
ds_mensagem_w			varchar(500)	:= null;
nr_seq_ocor_benef_w		pls_ocorrencia_benef.nr_sequencia%type;
nr_seq_segurado_w		pls_conta.nr_seq_segurado%type;
ie_novo_pos_estab_w		pls_visible_false.ie_novo_pos_estab%type;
ie_tipo_item_w			varchar(1);


BEGIN

--Verifica se está sendo utilizada nova geração de pós-estabelecido
select 	coalesce(max(ie_novo_pos_estab),'N')
into STRICT	ie_novo_pos_estab_w
from	pls_visible_false;

if (nr_seq_conta_proc_p IS NOT NULL AND nr_seq_conta_proc_p::text <> '') then
	ie_tipo_item_w := 'P';

elsif (nr_seq_conta_mat_p IS NOT NULL AND nr_seq_conta_mat_p::text <> '') then
	ie_tipo_item_w := 'M';
end if;

--Buscar pela ação da análise que foi enviada, qual o processo que o sistema está realizando
--Ações:
--1  - Ajustar o valor do item
	
-- varre tudo o que foi selecionado para alteração
if (ie_novo_pos_estab_w = 'N') then
	select	max(conta.nr_seq_segurado)
	into STRICT	nr_seq_segurado_w
	from	pls_conta_pos_estabelecido	pos,
		pls_conta			conta
	where	conta.nr_sequencia	= pos.nr_seq_conta
	and	pos.nr_sequencia	= nr_seq_conta_pos_estab_p;

	-- Só continuará a gerar se não houver nenhum proc ou mat inválido
	if (cd_acao_analise_p	= 1) then
			CALL CALL pls_cta_alt_valor_pos_pck.pls_gerencia_ajustar_valor(	nr_seq_conta_p, nr_seq_conta_pos_estab_p,nr_seq_conta_proc_p,
							nr_seq_conta_mat_p, nr_seq_ocorrencia_p, qt_liberada_p, 
							vl_liberado_p,	vl_unitario_p, vl_liberado_hi_p, 
							vl_liberado_mat_p, vl_liberado_co_p, vl_lib_taxa_hi_p, 
							vl_lib_taxa_mat_p,vl_lib_taxa_co_p, nm_usuario_p,
							'N');
	end if;	
	if (nr_seq_ocorrencia_p IS NOT NULL AND nr_seq_ocorrencia_p::text <> '') then
		pls_inserir_ocorrencia(	nr_seq_segurado_w, nr_seq_ocorrencia_p, null,
					null, null, null,
					null, null, nm_usuario_p, 
					'Ocorrência inserida pelo auditor '||obter_nome_usuario(nm_usuario_p), null, 0, 
					cd_estabelecimento_p, 'N' ,null,
					nr_seq_ocor_benef_w, nr_seq_conta_pos_estab_p,
					null, 'S', null,
					null, null, null);
	end if;
	CALL pls_gerar_contab_val_adic(	nr_seq_conta_p , null,null,
					null,null,null,
					null,'P','N',
					nm_usuario_p);
					
	if (nr_seq_grupo_atual_p IS NOT NULL AND nr_seq_grupo_atual_p::text <> '') then
		/* Gravar fluxo de análise */

		CALL pls_analise_atual_fluxo_audit(nr_seq_analise_p,
					nr_seq_conta_p,
					nr_seq_conta_proc_p,
					nr_seq_conta_mat_p,
					null,
					nr_seq_conta_pos_estab_p,
					nr_seq_grupo_atual_p,
					null,
					null,
					'N',
					'N',
					nm_usuario_p,
					'N',
					null);
	end if;
else

	select	max(nr_seq_segurado)
	into STRICT	nr_seq_segurado_w
	from (	SELECT 	conta.nr_seq_segurado	nr_seq_segurado
		from	pls_conta_pos_proc	pos,
			pls_conta		conta
		where	conta.nr_sequencia	= pos.nr_seq_conta
		and	pos.nr_sequencia	= nr_seq_conta_pos_estab_p
		
union all

		SELECT 	conta.nr_seq_segurado	nr_seq_segurado
		from	pls_conta_pos_mat	pos,
			pls_conta		conta
		where	conta.nr_sequencia	= pos.nr_seq_conta
		and	pos.nr_sequencia	= nr_seq_conta_pos_estab_p
	) alias1;

	-- Só continuará a gerar se não houver nenhum proc ou mat inválido
	if (cd_acao_analise_p	= 1) then
			CALL CALL pls_cta_alt_valor_pos_pck.pls_gerencia_ajustar_valor(	nr_seq_conta_p, nr_seq_conta_pos_estab_p,nr_seq_conta_proc_p,
							nr_seq_conta_mat_p, nr_seq_ocorrencia_p, qt_liberada_p, 
							vl_liberado_p,	vl_unitario_p, vl_liberado_hi_p, 
							vl_liberado_mat_p, vl_liberado_co_p, vl_lib_taxa_hi_p, 
							vl_lib_taxa_mat_p,vl_lib_taxa_co_p, nm_usuario_p,
							'S');
	end if;	
	if (nr_seq_ocorrencia_p IS NOT NULL AND nr_seq_ocorrencia_p::text <> '') then
		pls_inserir_ocorrencia(	nr_seq_segurado_w, nr_seq_ocorrencia_p, null,
					null, null, null,
					null, null, nm_usuario_p, 
					'Ocorrência inserida pelo auditor '||obter_nome_usuario(nm_usuario_p), null, 0, 
					cd_estabelecimento_p, 'N' ,null,
					nr_seq_ocor_benef_w, nr_seq_conta_pos_estab_p,
					null, 'S', null,
					null, null, ie_tipo_item_w);
	end if;

	--Atualização de valores contábeis considerando utilização de nova geração de pós-estabelecido					
	CALL pls_pos_estabelecido_pck.gerar_valores_adicionais( 	null, null, null,
								null, nr_seq_conta_p, null,
								null, 'N', nm_usuario_p,
								cd_estabelecimento_p);
					
					
	if (nr_seq_grupo_atual_p IS NOT NULL AND nr_seq_grupo_atual_p::text <> '') then
		/* Gravar fluxo de análise */

		CALL pls_analise_atual_fluxo_audit(	nr_seq_analise_p, nr_seq_conta_p, nr_seq_conta_proc_p,
						nr_seq_conta_mat_p, null, nr_seq_conta_pos_estab_p,
						nr_seq_grupo_atual_p, null, null,
						'N', 'N', nm_usuario_p,
						'N', null);
	end if;

end if;
	
commit;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_cta_alt_valor_pos_pck.pls_gerencia_alt_valor ( cd_acao_analise_p pls_acao_analise.cd_acao%type, nr_seq_analise_p pls_analise_conta.nr_sequencia%type, nr_seq_conta_p pls_conta_v.nr_sequencia%type, nr_seq_conta_pos_estab_p pls_conta_pos_estabelecido.nr_sequencia%type, nr_seq_conta_proc_p pls_conta_proc_v.nr_sequencia%type, nr_seq_conta_mat_p pls_conta_mat_v.nr_sequencia%type, nr_seq_proc_partic_p pls_proc_participante_v.nr_sequencia%type, nr_seq_ocorrencia_p pls_ocorrencia.nr_sequencia%type, nr_seq_motivo_glosa_p tiss_motivo_glosa.nr_sequencia%type, ds_observacao_p pls_conta_glosa.ds_observacao%type, qt_liberada_p pls_conta_proc_v.qt_procedimento%type, vl_liberado_p pls_conta_proc_v.vl_liberado%type, vl_unitario_p pls_conta_proc_v.vl_unitario%type, vl_liberado_hi_p pls_conta_proc_v.vl_liberado_hi%type, vl_liberado_mat_p pls_conta_proc_v.vl_liberado_material%type, vl_liberado_co_p pls_conta_proc_v.vl_liberado_co%type, vl_lib_taxa_hi_p pls_conta_proc_v.vl_lib_taxa_servico%type, vl_lib_taxa_mat_p pls_conta_proc_v.vl_lib_taxa_material%type, vl_lib_taxa_co_p pls_conta_proc_v.vl_taxa_co%type, nr_seq_grupo_atual_p pls_auditoria_conta_grupo.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;
