-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_cta_alt_valor_pos_pck.pls_calcula_valores_materiais ( qt_liberada_p pls_conta_proc_v.qt_procedimento%type, vl_unitario_p pls_conta_proc_v.vl_unitario%type, vl_liberado_p pls_conta_proc_v.vl_liberado%type, vl_liberado_material_p pls_conta_proc_v.vl_liberado_material%type, vl_lib_taxa_material_p pls_conta_proc_v.vl_lib_taxa_material%type, tx_intercambio_imp_p pls_conta_proc_v.tx_intercambio_imp%type, nr_seq_material_p pls_conta_proc_v.nr_sequencia%type, nr_seq_conta_pos_estab_p pls_conta_pos_estabelecido.nr_sequencia%type, ie_opcao_p text, ie_intercambio_p text, ie_novo_pos_estab_p text, vl_unitario_out_p INOUT pls_conta_proc_v.vl_unitario%type, vl_liberado_out_p INOUT pls_conta_proc_v.vl_liberado%type, vl_liberado_material_out_p INOUT pls_conta_proc_v.vl_liberado_material%type, vl_lib_taxa_material_out_p INOUT pls_conta_proc_v.vl_lib_taxa_material%type) AS $body$
DECLARE


qt_liberada_item_w			pls_conta_mat_v.qt_material%type		:= 0;
vl_liberado_item_w			pls_conta_mat_v.vl_liberado%type		:= 0;
vl_taxa_material_w        		pls_conta_proc_v.vl_taxa_material%type		:= 0;
vl_taxa_material_imp_w      		pls_conta_proc_v.vl_taxa_material_imp%type	:= 0;
qt_liberada_w				pls_conta_proc_v.qt_procedimento%type		:= 0;
qt_apresentada_w			pls_conta_proc_v.qt_procedimento%type		:= 0;
vl_unitario_w				pls_conta_proc_v.vl_unitario%type		:= 0;
vl_liberado_w				pls_conta_proc_v.vl_liberado%type		:= 0;
vl_liberado_material_w			pls_conta_proc_v.vl_liberado_material%type	:= 0;
vl_lib_taxa_material_w			double precision	:= 0;	
vl_liberado_material_fat_w        	pls_conta_pos_estabelecido.vl_liberado_material_fat%type:= 0;
vl_lib_taxa_material_fat_w            	pls_conta_pos_estabelecido.vl_lib_taxa_material%type	:= 0;
vl_materiais_calc_w			pls_conta_pos_estabelecido.vl_materiais_calc%type	:= 0;
vl_taxa_material_fat_w        		pls_conta_pos_estabelecido.vl_taxa_material%type	:= 0;

BEGIN

qt_liberada_w		:= coalesce(qt_liberada_p,0);
-- feito um round de 2 pelo motivo que pelo Delphi é passado um número com uma precisão maior (o componente faz isso)
vl_unitario_w		:= round((coalesce(vl_unitario_p,0))::numeric,2);
vl_liberado_w		:= round((coalesce(vl_liberado_p,0))::numeric,2);
vl_lib_taxa_material_w	:= round((coalesce(vl_lib_taxa_material_p,0))::numeric,2);
vl_liberado_material_w	:= round((coalesce(vl_liberado_material_p,0))::numeric,2);

select	qt_material_imp,
	qt_material,
	vl_liberado,
	vl_taxa_material_imp,
	vl_taxa_material
into STRICT	qt_apresentada_w,
	qt_liberada_item_w,
	vl_liberado_item_w,
	vl_taxa_material_imp_w,
	vl_taxa_material_w
from	pls_conta_mat_v	a
where	nr_sequencia	= nr_seq_material_p;

if (ie_novo_pos_estab_p = 'N') then
	select	coalesce(vl_liberado_material_fat,0),
		coalesce(vl_lib_taxa_material,0), 
		coalesce(vl_materiais_calc,0),
		coalesce(vl_taxa_material,0)        	
	into STRICT	vl_liberado_material_fat_w,                  
		vl_lib_taxa_material_fat_w,
		vl_materiais_calc_w,
		vl_taxa_material_fat_w
	from	pls_conta_pos_estabelecido
	where	nr_sequencia	= nr_seq_conta_pos_estab_p;	
else
	select	coalesce(vl_liberado_material_fat,0),
		coalesce(vl_lib_taxa_material,0), 
		coalesce(vl_materiais_calc,0),
		coalesce(vl_taxa_material,0)        	
	into STRICT	vl_liberado_material_fat_w,                  
		vl_lib_taxa_material_fat_w,
		vl_materiais_calc_w,
		vl_taxa_material_fat_w
	from	pls_conta_pos_mat_v
	where	nr_sequencia	= nr_seq_conta_pos_estab_p;
end if;
		
--Calculo quando da saída do campo quantidade
if (ie_opcao_p	= '1') then
	
	if (qt_liberada_w	= 0) then
		vl_unitario_w	:= 0;
	elsif (vl_liberado_w 	> 0 ) and (vl_unitario_w	= 0)then
		vl_unitario_w	:= dividir(vl_liberado_w,qt_liberada_w );
	end if;
	
	vl_liberado_w	:= pls_cta_alt_valor_pos_pck.pls_obter_val_liberado(qt_liberada_w,vl_unitario_w );
	
	vl_lib_taxa_material_w	:= pls_cta_alt_valor_pos_pck.pls_obter_val_taxa_mat(tx_intercambio_imp_p, vl_liberado_w);
	vl_liberado_material_w	:= pls_cta_alt_valor_pos_pck.pls_obter_val_lib_mat(vl_lib_taxa_material_w , vl_liberado_w);

--Calculo quando da saída do campo valor total liberado 
elsif (ie_opcao_p	= '2') then
	vl_unitario_w	:= dividir_sem_round(vl_liberado_w,qt_liberada_w);
	vl_lib_taxa_material_w	:= pls_cta_alt_valor_pos_pck.pls_obter_val_taxa_mat(tx_intercambio_imp_p, vl_liberado_w);
	vl_liberado_material_w	:= pls_cta_alt_valor_pos_pck.pls_obter_val_lib_mat(vl_lib_taxa_material_w , vl_liberado_w);

elsif (ie_opcao_p	= '5') then

	vl_lib_taxa_material_w	:= dividir((vl_liberado_material_w * tx_intercambio_imp_p),100);
	vl_liberado_w	:= vl_lib_taxa_material_w + vl_liberado_material_w;
elsif (ie_opcao_p	= '8') then
			
	vl_liberado_w	:= vl_lib_taxa_material_w + vl_liberado_material_w;	
end if;

vl_unitario_out_p		:= coalesce(vl_unitario_w,0);
vl_liberado_out_p		:= coalesce(vl_liberado_w,0);
vl_liberado_material_out_p	:= coalesce(vl_liberado_material_w,0);
vl_lib_taxa_material_out_p	:= coalesce(vl_lib_taxa_material_w,0);

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_cta_alt_valor_pos_pck.pls_calcula_valores_materiais ( qt_liberada_p pls_conta_proc_v.qt_procedimento%type, vl_unitario_p pls_conta_proc_v.vl_unitario%type, vl_liberado_p pls_conta_proc_v.vl_liberado%type, vl_liberado_material_p pls_conta_proc_v.vl_liberado_material%type, vl_lib_taxa_material_p pls_conta_proc_v.vl_lib_taxa_material%type, tx_intercambio_imp_p pls_conta_proc_v.tx_intercambio_imp%type, nr_seq_material_p pls_conta_proc_v.nr_sequencia%type, nr_seq_conta_pos_estab_p pls_conta_pos_estabelecido.nr_sequencia%type, ie_opcao_p text, ie_intercambio_p text, ie_novo_pos_estab_p text, vl_unitario_out_p INOUT pls_conta_proc_v.vl_unitario%type, vl_liberado_out_p INOUT pls_conta_proc_v.vl_liberado%type, vl_liberado_material_out_p INOUT pls_conta_proc_v.vl_liberado_material%type, vl_lib_taxa_material_out_p INOUT pls_conta_proc_v.vl_lib_taxa_material%type) FROM PUBLIC;
