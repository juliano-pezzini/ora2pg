-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_cta_alt_valor_pos_pck.pls_calcula_ajuste_valor ( qt_liberada_p pls_conta_proc_v.qt_procedimento%type, vl_unitario_p pls_conta_proc_v.vl_unitario%type, vl_liberado_p pls_conta_proc_v.vl_liberado%type, vl_liberado_co_p pls_conta_proc_v.vl_liberado_co%type, vl_liberado_hi_p pls_conta_proc_v.vl_liberado_hi%type, vl_liberado_material_p pls_conta_proc_v.vl_liberado_material%type, vl_lib_taxa_co_p pls_conta_proc_v.vl_lib_taxa_co%type, vl_lib_taxa_material_p pls_conta_proc_v.vl_lib_taxa_material%type, vl_lib_taxa_servico_p pls_conta_proc_v.vl_lib_taxa_servico%type, tx_intercambio_imp_p pls_conta_proc_v.tx_intercambio_imp%type, nr_seq_item_p pls_conta_proc_v.nr_sequencia%type, nr_seq_pos_estab_p pls_conta_pos_estabelecido.nr_sequencia%type, ie_tipo_item_p text, ie_opcao_p text, ie_intercambio_p text, nm_usuario_p usuario.nm_usuario%type, vl_unitario_out_p INOUT pls_conta_proc_v.vl_unitario%type, vl_liberado_out_p INOUT pls_conta_proc_v.vl_liberado%type, vl_liberado_co_out_p INOUT pls_conta_proc_v.vl_liberado_co%type, vl_liberado_hi_out_p INOUT pls_conta_proc_v.vl_liberado_hi%type, vl_liberado_material_out_p INOUT pls_conta_proc_v.vl_liberado_material%type, vl_lib_taxa_co_out_p INOUT pls_conta_proc_v.vl_lib_taxa_co%type, vl_lib_taxa_material_out_p INOUT pls_conta_proc_v.vl_lib_taxa_material%type, vl_lib_taxa_servico_out_p INOUT pls_conta_proc_v.vl_lib_taxa_servico%type) AS $body$
DECLARE


/*ie_opcao_p
1 - Saída quantidade
2 - Saída valor liberado
3 - Saída Valores liberados proc
4 - Saída valores liberados Co
5 - Saída valores liberados mat
6 - Saída valores taxa hi
7 - Saída valores taxa Co
8 - Saída valores taxa mat

ie_tipo_item_p

P  - Procedimento
M - Material*/
qt_liberada_w				pls_conta_proc_v.qt_procedimento%type		:= 0;
vl_unitario_w				pls_conta_proc_v.vl_unitario%type		:= 0;

vl_liberado_w				pls_conta_proc_v.vl_liberado%type		:= 0;
vl_liberado_co_w      			pls_conta_proc_v.vl_liberado_co%type		:= 0;
vl_liberado_hi_w        		pls_conta_proc_v.vl_liberado_hi%type		:= 0;
vl_liberado_material_w			pls_conta_proc_v.vl_liberado_material%type	:= 0;
vl_lib_taxa_co_w     			pls_conta_proc_v.vl_lib_taxa_co%type		:= 0;
vl_lib_taxa_material_w			pls_conta_proc_v.vl_lib_taxa_material%type	:= 0;
vl_lib_taxa_servico_w   		pls_conta_proc_v.vl_lib_taxa_servico%type	:= 0;
ie_novo_pos_estab_w			pls_visible_false.ie_novo_pos_estab%type;


BEGIN

qt_liberada_w		:= coalesce(qt_liberada_p,0);
vl_unitario_w		:= coalesce(vl_unitario_p,0);
vl_liberado_w		:= coalesce(vl_liberado_p,0);
vl_lib_taxa_co_w     	:= coalesce(vl_lib_taxa_co_p,0);
vl_lib_taxa_material_w	:= coalesce(vl_lib_taxa_material_p,0);
vl_lib_taxa_servico_w   := coalesce(vl_lib_taxa_servico_p,0);
vl_liberado_material_w	:= coalesce(vl_liberado_material_p,0);
vl_liberado_co_w      	:= coalesce(vl_liberado_co_p,0);
vl_liberado_hi_w        := coalesce(vl_liberado_hi_p,0);

--Verifica se está sendo utilizada nova geração de pós-estabelecido
select 	coalesce(max(ie_novo_pos_estab),'N')
into STRICT	ie_novo_pos_estab_w
from	pls_visible_false;

if (ie_tipo_item_p	= 'P') then
	SELECT * FROM pls_cta_alt_valor_pos_pck.pls_calcula_valor_proced(	qt_liberada_w, vl_unitario_w, vl_liberado_w, vl_liberado_co_w, vl_liberado_hi_w, vl_liberado_material_w, vl_lib_taxa_co_w, vl_lib_taxa_material_w, vl_lib_taxa_servico_w, tx_intercambio_imp_p, nr_seq_item_p, nr_seq_pos_estab_p, ie_opcao_p, ie_intercambio_p, ie_novo_pos_estab_w, vl_unitario_w, vl_liberado_w, vl_liberado_co_w, vl_liberado_hi_w, vl_liberado_material_w, vl_lib_taxa_co_w, vl_lib_taxa_material_w, vl_lib_taxa_servico_w) INTO STRICT vl_unitario_w, vl_liberado_w, vl_liberado_co_w, vl_liberado_hi_w, vl_liberado_material_w, vl_lib_taxa_co_w, vl_lib_taxa_material_w, vl_lib_taxa_servico_w;
					
elsif (ie_tipo_item_p	= 'M') then
	SELECT * FROM pls_cta_alt_valor_pos_pck.pls_calcula_valores_materiais(	qt_liberada_w, vl_unitario_w, vl_liberado_w, vl_liberado_material_w, vl_lib_taxa_material_w, tx_intercambio_imp_p, nr_seq_item_p, nr_seq_pos_estab_p, ie_opcao_p, ie_intercambio_p, ie_novo_pos_estab_w, vl_unitario_w, vl_liberado_w, vl_liberado_material_w, vl_lib_taxa_material_w) INTO STRICT vl_unitario_w, vl_liberado_w, vl_liberado_material_w, vl_lib_taxa_material_w;
end if;

if (vl_liberado_w < 0) then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(256950);
end if;

vl_unitario_out_p		:= coalesce(vl_unitario_w,0);
vl_liberado_out_p		:= coalesce(vl_liberado_w,0);
vl_liberado_co_out_p      	:= coalesce(vl_liberado_co_w,0);
vl_liberado_hi_out_p        	:= coalesce(vl_liberado_hi_w,0);
vl_liberado_material_out_p	:= coalesce(vl_liberado_material_w,0);
vl_lib_taxa_co_out_p     	:= coalesce(vl_lib_taxa_co_w,0);
vl_lib_taxa_material_out_p	:= coalesce(vl_lib_taxa_material_w,0);
vl_lib_taxa_servico_out_p   	:= coalesce(vl_lib_taxa_servico_w,0);
					
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_cta_alt_valor_pos_pck.pls_calcula_ajuste_valor ( qt_liberada_p pls_conta_proc_v.qt_procedimento%type, vl_unitario_p pls_conta_proc_v.vl_unitario%type, vl_liberado_p pls_conta_proc_v.vl_liberado%type, vl_liberado_co_p pls_conta_proc_v.vl_liberado_co%type, vl_liberado_hi_p pls_conta_proc_v.vl_liberado_hi%type, vl_liberado_material_p pls_conta_proc_v.vl_liberado_material%type, vl_lib_taxa_co_p pls_conta_proc_v.vl_lib_taxa_co%type, vl_lib_taxa_material_p pls_conta_proc_v.vl_lib_taxa_material%type, vl_lib_taxa_servico_p pls_conta_proc_v.vl_lib_taxa_servico%type, tx_intercambio_imp_p pls_conta_proc_v.tx_intercambio_imp%type, nr_seq_item_p pls_conta_proc_v.nr_sequencia%type, nr_seq_pos_estab_p pls_conta_pos_estabelecido.nr_sequencia%type, ie_tipo_item_p text, ie_opcao_p text, ie_intercambio_p text, nm_usuario_p usuario.nm_usuario%type, vl_unitario_out_p INOUT pls_conta_proc_v.vl_unitario%type, vl_liberado_out_p INOUT pls_conta_proc_v.vl_liberado%type, vl_liberado_co_out_p INOUT pls_conta_proc_v.vl_liberado_co%type, vl_liberado_hi_out_p INOUT pls_conta_proc_v.vl_liberado_hi%type, vl_liberado_material_out_p INOUT pls_conta_proc_v.vl_liberado_material%type, vl_lib_taxa_co_out_p INOUT pls_conta_proc_v.vl_lib_taxa_co%type, vl_lib_taxa_material_out_p INOUT pls_conta_proc_v.vl_lib_taxa_material%type, vl_lib_taxa_servico_out_p INOUT pls_conta_proc_v.vl_lib_taxa_servico%type) FROM PUBLIC;
