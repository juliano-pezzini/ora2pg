-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE mprev_base_cubo_prest_pck.atualizar_pessoas ( dt_inicio_w timestamp, dt_fim_w timestamp, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE


c_pessoas CURSOR(dt_inicio_p timestamp,
					dt_fim_p timestamp) FOR
SELECT distinct
		pessoa.cd_pessoa_fisica,
		pessoa.dt_nascimento dt_nascimento,
		pessoa.ie_sexo ie_sexo,
		pessoa.nm_pessoa_fisica nm_pessoa_fisica
from	pessoa_fisica		pessoa,
		compl_pessoa_fisica		compl
where	pessoa.cd_pessoa_fisica = compl.cd_pessoa_fisica
and		compl.ie_tipo_complemento = 1
and		(pessoa.dt_nascimento IS NOT NULL AND pessoa.dt_nascimento::text <> '')
and		pessoa.dt_atualizacao between dt_inicio_p and dt_fim_p;

				
ds_select_completo_w	varchar(4000);	

cursor_benef_w		sql_pck.t_cursor;
table_pessoa_w		mprev_base_cubo_prest_pck.table_pessoa;
ie_origem_dados_w	mprev_config_geral.ie_origem_dados%type;
valor_bind_w	sql_pck.t_dado_bind;


BEGIN

open c_pessoas(dt_inicio_w,dt_fim_w);
	loop
		fetch c_pessoas bulk collect
		into	table_pessoa_w.cd_pessoa_fisica, table_pessoa_w.dt_nascimento,
		table_pessoa_w.ie_sexo, table_pessoa_w.nm_pessoa_fisica
	limit current_setting('mprev_base_cubo_prest_pck.qt_reg_commit_w')::integer;
	
	exit when table_pessoa_w.cd_pessoa_fisica.count = 0;
	-- Criar pessoas dos beneficiarios
	forall i in table_pessoa_w.cd_pessoa_fisica.first .. table_pessoa_w.cd_pessoa_fisica.last
		insert into mprev_pessoa_cubo_ops(nr_sequencia, nm_usuario, dt_atualizacao,
			cd_pessoa_fisica, nm_pessoa_fisica, dt_nascimento,
			ie_sexo)
		values (nextval('mprev_pessoa_cubo_ops_seq'), nm_usuario_p, clock_timestamp(), 
			table_pessoa_w.cd_pessoa_fisica(i), table_pessoa_w.nm_pessoa_fisica(i), 
			table_pessoa_w.dt_nascimento(i), table_pessoa_w.ie_sexo(i));
	commit;
end loop;
close c_pessoas;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE mprev_base_cubo_prest_pck.atualizar_pessoas ( dt_inicio_w timestamp, dt_fim_w timestamp, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;
