-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

   
 ----------------------------------------------------    
CREATE OR REPLACE PROCEDURE pbs_restrictions_pck.get_pbs_restriction_text ( pbs_restriction_reference text, nr_pbs_version_p bigint, desc_com_ttmt_p INOUT text, desc_pbs_text INOUT text ) AS $body$
DECLARE



    c02 CURSOR FOR
    SELECT c.desc_component nam_component,
               c.desc_component_subtype nam_component_subtype,
               c.component_ordering component_order
    FROM pbsload_reslinkcom rc, pbsload_restrictions r, pbsload_components c
LEFT OUTER JOIN pbsload_subcomponent sc ON (c.cd_com_xml_id = sc.cd_com_xml_id)
WHERE r.cd_res_xml_id=rc.cd_res_xml_id and c.cd_com_xml_id=rc.cd_com_xml_id and r.nr_pbs_version=c.nr_pbs_version  and r.nr_pbs_version= nr_pbs_version_p and r.cd_res_xml_id =pbs_restriction_reference group by c.desc_component,c.desc_component_subtype,c.component_ordering
    order by   c.component_ordering;


   r_c02  c02%rowtype;
  desc_prescription_text_w  text;
  restriction_header_w text;
  desc_ttmt_criteria_w  text;
  cd_restriction_code_w pbsload_benf_restrictions.cd_restriction_ref_code%TYPE;
  cd_treatment_of_w   pbsload_restrictions.cd_treatment_of%TYPE;
  desc_url_w   pbsload_benf_types.ds_benf_type_rdf_desc%TYPE;
  desciption_w   pbs_config_types_def.ds%TYPE;

BEGIN

  ---------for benefit type header------
  begin
    select distinct  
            br.cd_restriction_ref_code,
            bt.ds_benf_type_rdf_desc,
            pd.ds
    into STRICT
           cd_restriction_code_w,
           desc_url_w,
           desciption_w
    from   pbsload_benf_restrictions br,
           pbsload_benf_types bt,
           pbs_config_types_def pd

    where
       br.nr_benf_type_ref=bt.nr_sequencia
    and bt.ds_benf_type_rdf_desc=pd.rdf_desc
    and br.cd_restriction_xml_ref='#'|| pbs_restriction_reference
    and br.nr_pbs_version= nr_pbs_version_p;
  exception
     when no_data_found then
       cd_restriction_code_w:=0;
       desc_url_w:=null;
       desciption_w:='exception';
       when too_many_rows then raise;
   end;
      begin
        select pr.cd_treatment_of
        into STRICT cd_treatment_of_w 
        from pbsload_restrictions pr 
        where pr.cd_res_xml_id=  pbs_restriction_reference;
        exception when no_data_found then
		   cd_treatment_of_w := 0;
           when too_many_rows then raise;
		end;
        if (desciption_w IS NOT NULL AND desciption_w::text <> '') then
         restriction_header_w:=  '<B><u>'||desciption_w || '</B></u>'||   '<BR><BR>';
       end if;
      if (desciption_w='Authority required (STREAMLINED)' and (cd_treatment_of_w IS NOT NULL AND cd_treatment_of_w::text <> '')) then
           restriction_header_w:=restriction_header_w||cd_treatment_of_w||'<BR>';
        end if;
       ---------for benefit type header------
       for r_c02 in c02 loop
           SELECT * FROM pbs_restrictions_pck.get_component_prescrition(r_c02.nam_component, r_c02.nam_component_subtype, pbs_restriction_reference, nr_pbs_version_p, desc_ttmt_criteria_w, desc_prescription_text_w) INTO STRICT desc_ttmt_criteria_w, desc_prescription_text_w;
           if (r_c02.nam_component_subtype='Treatment') then
              desc_com_ttmt_p:=desc_ttmt_criteria_w;
           end if;
          PERFORM set_config('pbs_restrictions_pck.ds_line_w', current_setting('pbs_restrictions_pck.ds_line_w')::text||desc_prescription_text_w, false);
       end loop;
       desc_pbs_text:=restriction_header_w ||'<BR>'|| current_setting('pbs_restrictions_pck.ds_line_w')::text;
       PERFORM set_config('pbs_restrictions_pck.ds_line_w', null, false);
  END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pbs_restrictions_pck.get_pbs_restriction_text ( pbs_restriction_reference text, nr_pbs_version_p bigint, desc_com_ttmt_p INOUT text, desc_pbs_text INOUT text ) FROM PUBLIC;
