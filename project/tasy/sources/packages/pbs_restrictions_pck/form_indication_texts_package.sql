-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

    ------------------------------------------
CREATE OR REPLACE PROCEDURE pbs_restrictions_pck.form_indication_texts (nam_component_p text, nam_com_subtype_p text, cd_res_xml_id_p text, nr_pbs_version_p bigint, desc_presc_text_p INOUT text) AS $body$
DECLARE


        c01 CURSOR FOR
            SELECT r.cd_res_xml_id restriction_xml_id, 
                  c.cd_com_xml_id component_xml_id,
                  sc.cd_subcom_xml_id subcomponent_xml_id,
                  c.desc_component name_component,
                  c.desc_component_subtype nam_component_subtype,
                  c.desc_com_note_parameter component_param,
                  c.desc_com_pref_term component_pref_term,
                  sc.desc_subcomponent nam_subcomponent,
                  sc.desc_subcomponent_type nam_subcomponent_subtype, 
                  sc.desc_subcom_pref_term subcomponent_pref_term,
                  sc.desc_subcom_note_param subcomponent_param,
                  sc.subcom_operator  sc_operator,
                  count(*) over () tot_rows
            FROM pbsload_reslinkcom rc, pbsload_restrictions r, pbsload_components c
LEFT OUTER JOIN pbsload_subcomponent sc ON (c.cd_com_xml_id = sc.cd_com_xml_id)
WHERE r.cd_res_xml_id=rc.cd_res_xml_id and c.cd_com_xml_id=rc.cd_com_xml_id  and r.cd_res_xml_id =cd_res_xml_id_p and r.nr_pbs_version=nr_pbs_version_p and (case
                    when(c.desc_component = nam_component_p and coalesce(c.desc_component_subtype::text, '') = '')  then (1)
                    when(c.desc_component = nam_component_p and c.desc_component_subtype = nam_com_subtype_p) then (1)
                    else 0
                end) = 1;
       r_c01  c01%rowtype;
      desc_com_text_w text;
      desc_com_text_temp_w text;
      note_adm_adv_w varchar(100);
      counter  bigint:=0;

BEGIN
       for r_c01 in c01 loop
          counter:=counter+1;
          desc_com_text_w:=null;
              ----with subcomponents-----
                if (r_c01.nam_subcomponent IS NOT NULL AND r_c01.nam_subcomponent::text <> '') then
                      desc_com_text_w:=desc_com_text_w||r_c01.subcomponent_pref_term || ' '|| r_c01.subcomponent_param;
                           if (r_c01.name_component <> 'indication' and r_c01.name_component<>'criteria') then
                             desc_com_text_w:=desc_com_text_w|| '<BR><BR>';
                           end if;
                         ------------------this is for creating crtieria component with bullets , AND OR opeartors as per rendering START -----  
                        if (r_c01.name_component='criteria') then
                                if (counter <> r_c01.tot_rows) then
                                         if (r_c01.sc_operator='all' ) then
                                                desc_com_text_w:='<li>'||desc_com_text_w || ';<BR><BR><B>AND</B><BR><BR>';
                                         end if;
                                         if (r_c01.sc_operator='any') then
                                                desc_com_text_w:='<li>'||desc_com_text_w || ';OR<BR><BR>';
                                        end if;
                                         if (counter = r_c01.tot_rows) then
                                            desc_com_text_w:='<li>'||desc_com_text_w||'.';
                                        end if;
                                else
                                    desc_com_text_w:='<li>'||desc_com_text_w|| '<BR><BR>';
                             end if;
                        end if;
                        ------------------this is for creating crtieria component with bullets , AND OR opeartors as per rendering END -----
                end if;
                ---with only components-----
               if (coalesce(r_c01.subcomponent_xml_id::text, '') = '' )then
                         desc_com_text_w:=note_adm_adv_w||desc_com_text_w||r_c01.component_param||r_c01.component_pref_term||'<BR><BR>';
               end if;
             desc_com_text_temp_w:=desc_com_text_temp_w||desc_com_text_w;
        end loop;
        desc_presc_text_p:=desc_com_text_temp_w;
     END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pbs_restrictions_pck.form_indication_texts (nam_component_p text, nam_com_subtype_p text, cd_res_xml_id_p text, nr_pbs_version_p bigint, desc_presc_text_p INOUT text) FROM PUBLIC;
